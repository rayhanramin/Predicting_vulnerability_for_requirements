<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 27455:8d3544b6352837c58cc4984fdd0412800f863e7c</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 8d3544b6352837c58cc4984fdd0412800f863e7c" />
<meta property="og:url" content="/comm-central/rev/8d3544b6352837c58cc4984fdd0412800f863e7c" />
<meta property="og:description" content="Bug 1577835 - Reformat editor/ code with eslint and Prettier. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 8d3544b6352837c58cc4984fdd0412800f863e7c 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/8d3544b6352837c58cc4984fdd0412800f863e7c">shortlog</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/8d3544b6352837c58cc4984fdd0412800f863e7c">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c">files</a> |
changeset |
<a href="/comm-central/raw-rev/8d3544b6352837c58cc4984fdd0412800f863e7c">raw</a>  | <a href="/comm-central/archive/8d3544b6352837c58cc4984fdd0412800f863e7c.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1577835">Bug 1577835</a> - Reformat editor/ code with eslint and Prettier. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#97;&#117;&#108;&#32;&#77;&#111;&#114;&#114;&#105;&#115;&#32;&#60;&#112;&#97;&#117;&#108;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 30 Aug 2019 15:45:11 -0400</td></tr>

<tr>
 <td>changeset 27455</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/8d3544b6352837c58cc4984fdd0412800f863e7c">8d3544b6352837c58cc4984fdd0412800f863e7c</a></td>
</tr>



<tr>
<td>parent 27454</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ab9b63f9d2266b4607b926ba227d89ae117bb3f9">ab9b63f9d2266b4607b926ba227d89ae117bb3f9</a>
</td>
</tr>

<tr>
<td>child 27456</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b1283c57f051e5aa44ce65a8635978abbd0d7115">b1283c57f051e5aa44ce65a8635978abbd0d7115</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=8d3544b6352837c58cc4984fdd0412800f863e7c">16348</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Sun, 01 Sep 2019 21:02:53 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@8177b85d18db [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=8177b85d18db77c4787461cd6db9575ef9935aea">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=8177b85d18db77c4787461cd6db9575ef9935aea&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8177b85d18db77c4787461cd6db9575ef9935aea&newProject=comm-central&newRevision=fda41b757b2e6b5288b439aa9227b869ae320aa2&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8177b85d18db77c4787461cd6db9575ef9935aea&newProject=comm-central&newRevision=fda41b757b2e6b5288b439aa9227b869ae320aa2&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8177b85d18db77c4787461cd6db9575ef9935aea&newProject=comm-central&newRevision=fda41b757b2e6b5288b439aa9227b869ae320aa2&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1577835">1577835</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1577835">Bug 1577835</a> - Reformat editor/ code with eslint and Prettier. r=mkmelin
# ignore-this-changeset

These changes were achieved by:

1. Using eslint to add curly brackets to control
statements that did not have them (if, else, etc.),
thanks to the eslint rule: &quot;curly&quot;: [&quot;error&quot;, &quot;all&quot;]

Done by running |mach eslint editor/ --fix|

2. Reformatting the code using Prettier.

Done by deleting the editor/ line from
the .prettierignore file and running:
|mach eslint editor/ --fix|</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/.prettierignore">.prettierignore</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/.prettierignore">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/.prettierignore">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/.prettierignore">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/.prettierignore">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/.prettierignore">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/composer/content/ComposerCommands.js">editor/ui/composer/content/ComposerCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/composer/content/ComposerCommands.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/composer/content/ComposerCommands.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/composer/content/ComposerCommands.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/composer/content/ComposerCommands.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/composer/content/ComposerCommands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/composer/content/editor.js">editor/ui/composer/content/editor.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/composer/content/editor.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/composer/content/editor.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/composer/content/editor.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/composer/content/editor.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/composer/content/editor.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/composer/content/editorUtilities.js">editor/ui/composer/content/editorUtilities.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/composer/content/editorUtilities.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/composer/content/editorUtilities.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/composer/content/editorUtilities.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/composer/content/editorUtilities.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/composer/content/editorUtilities.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdAEAttributes.js">editor/ui/dialogs/content/EdAEAttributes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdAEAttributes.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdAEAttributes.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdAEAttributes.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdAEAttributes.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdAEAttributes.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdAECSSAttributes.js">editor/ui/dialogs/content/EdAECSSAttributes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdAECSSAttributes.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdAECSSAttributes.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdAECSSAttributes.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdAECSSAttributes.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdAECSSAttributes.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdAEHTMLAttributes.js">editor/ui/dialogs/content/EdAEHTMLAttributes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdAEHTMLAttributes.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdAEHTMLAttributes.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdAEHTMLAttributes.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdAEHTMLAttributes.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdAEHTMLAttributes.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdAEJSEAttributes.js">editor/ui/dialogs/content/EdAEJSEAttributes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdAEJSEAttributes.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdAEJSEAttributes.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdAEJSEAttributes.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdAEJSEAttributes.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdAEJSEAttributes.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdAdvancedEdit.js">editor/ui/dialogs/content/EdAdvancedEdit.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdAdvancedEdit.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdAdvancedEdit.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdAdvancedEdit.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdAdvancedEdit.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdAdvancedEdit.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdButtonProps.js">editor/ui/dialogs/content/EdButtonProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdButtonProps.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdButtonProps.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdButtonProps.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdButtonProps.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdButtonProps.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdColorPicker.js">editor/ui/dialogs/content/EdColorPicker.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdColorPicker.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdColorPicker.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdColorPicker.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdColorPicker.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdColorPicker.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdColorProps.js">editor/ui/dialogs/content/EdColorProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdColorProps.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdColorProps.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdColorProps.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdColorProps.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdColorProps.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdConvertToTable.js">editor/ui/dialogs/content/EdConvertToTable.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdConvertToTable.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdConvertToTable.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdConvertToTable.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdConvertToTable.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdConvertToTable.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdDialogCommon.js">editor/ui/dialogs/content/EdDialogCommon.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdDialogCommon.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdDialogCommon.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdDialogCommon.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdDialogCommon.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdDialogCommon.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdDictionary.js">editor/ui/dialogs/content/EdDictionary.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdDictionary.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdDictionary.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdDictionary.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdDictionary.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdDictionary.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdFieldSetProps.js">editor/ui/dialogs/content/EdFieldSetProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdFieldSetProps.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdFieldSetProps.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdFieldSetProps.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdFieldSetProps.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdFieldSetProps.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdFormProps.js">editor/ui/dialogs/content/EdFormProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdFormProps.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdFormProps.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdFormProps.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdFormProps.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdFormProps.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdHLineProps.js">editor/ui/dialogs/content/EdHLineProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdHLineProps.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdHLineProps.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdHLineProps.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdHLineProps.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdHLineProps.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdImageDialog.js">editor/ui/dialogs/content/EdImageDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdImageDialog.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdImageDialog.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdImageDialog.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdImageDialog.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdImageDialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdImageLinkLoader.js">editor/ui/dialogs/content/EdImageLinkLoader.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdImageLinkLoader.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdImageLinkLoader.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdImageLinkLoader.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdImageLinkLoader.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdImageLinkLoader.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdImageProps.js">editor/ui/dialogs/content/EdImageProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdImageProps.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdImageProps.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdImageProps.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdImageProps.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdImageProps.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInputImage.js">editor/ui/dialogs/content/EdInputImage.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInputImage.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInputImage.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInputImage.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInputImage.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInputImage.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInputProps.js">editor/ui/dialogs/content/EdInputProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInputProps.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInputProps.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInputProps.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInputProps.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInputProps.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInsSrc.js">editor/ui/dialogs/content/EdInsSrc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInsSrc.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInsSrc.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInsSrc.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInsSrc.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInsSrc.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInsertChars.js">editor/ui/dialogs/content/EdInsertChars.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInsertChars.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInsertChars.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInsertChars.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInsertChars.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInsertChars.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInsertMath.js">editor/ui/dialogs/content/EdInsertMath.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInsertMath.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInsertMath.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInsertMath.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInsertMath.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInsertMath.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInsertTOC.js">editor/ui/dialogs/content/EdInsertTOC.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInsertTOC.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInsertTOC.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInsertTOC.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInsertTOC.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInsertTOC.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInsertTable.js">editor/ui/dialogs/content/EdInsertTable.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInsertTable.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInsertTable.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInsertTable.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInsertTable.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdInsertTable.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdLabelProps.js">editor/ui/dialogs/content/EdLabelProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdLabelProps.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdLabelProps.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdLabelProps.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdLabelProps.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdLabelProps.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdLinkProps.js">editor/ui/dialogs/content/EdLinkProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdLinkProps.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdLinkProps.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdLinkProps.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdLinkProps.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdLinkProps.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdListProps.js">editor/ui/dialogs/content/EdListProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdListProps.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdListProps.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdListProps.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdListProps.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdListProps.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdNamedAnchorProps.js">editor/ui/dialogs/content/EdNamedAnchorProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdNamedAnchorProps.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdNamedAnchorProps.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdNamedAnchorProps.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdNamedAnchorProps.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdNamedAnchorProps.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdPageProps.js">editor/ui/dialogs/content/EdPageProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdPageProps.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdPageProps.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdPageProps.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdPageProps.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdPageProps.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdReplace.js">editor/ui/dialogs/content/EdReplace.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdReplace.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdReplace.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdReplace.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdReplace.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdReplace.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdSelectProps.js">editor/ui/dialogs/content/EdSelectProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdSelectProps.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdSelectProps.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdSelectProps.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdSelectProps.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdSelectProps.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdSpellCheck.js">editor/ui/dialogs/content/EdSpellCheck.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdSpellCheck.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdSpellCheck.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdSpellCheck.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdSpellCheck.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdSpellCheck.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdTableProps.js">editor/ui/dialogs/content/EdTableProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdTableProps.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdTableProps.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdTableProps.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdTableProps.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdTableProps.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdTextAreaProps.js">editor/ui/dialogs/content/EdTextAreaProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdTextAreaProps.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdTextAreaProps.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdTextAreaProps.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdTextAreaProps.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/dialogs/content/EdTextAreaProps.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/nsComposerCmdLineHandler.js">editor/ui/nsComposerCmdLineHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/nsComposerCmdLineHandler.js">file</a> |
<a href="/comm-central/annotate/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/nsComposerCmdLineHandler.js">annotate</a> |
<a href="/comm-central/diff/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/nsComposerCmdLineHandler.js">diff</a> |
<a href="/comm-central/comparison/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/nsComposerCmdLineHandler.js">comparison</a> |
<a href="/comm-central/log/8d3544b6352837c58cc4984fdd0412800f863e7c/editor/ui/nsComposerCmdLineHandler.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/.prettierignore</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/.prettierignore</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -6,12 +6,11 @@</span>
<a href="#l1.4"></a><span id="l1.4"> *.xhtml</span>
<a href="#l1.5"></a><span id="l1.5"> *.xul</span>
<a href="#l1.6"></a><span id="l1.6"> *.xml</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> # Ignore .eslintrc.js for now.</span>
<a href="#l1.9"></a><span id="l1.9"> .eslintrc.js</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> # Ignore all top-level directories that contain JS files (for now).</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-editor/**</span>
<a href="#l1.13"></a><span id="l1.13"> mail/**</span>
<a href="#l1.14"></a><span id="l1.14"> mailnews/**</span>
<a href="#l1.15"></a><span id="l1.15"> suite/**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/editor/ui/composer/content/ComposerCommands.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/editor/ui/composer/content/ComposerCommands.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -10,145 +10,202 @@</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> /* import-globals-from editor.js */</span>
<a href="#l2.6"></a><span id="l2.6"> /* import-globals-from editorUtilities.js */</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> var gComposerJSCommandControllerID = 0;</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> function SetupHTMLEditorCommands() {</span>
<a href="#l2.11"></a><span id="l2.11">   var commandTable = GetComposerCommandTable();</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  if (!commandTable)</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  if (!commandTable) {</span>
<a href="#l2.14"></a><span id="l2.14">     return;</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+  }</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17">   // Include everything a text editor does</span>
<a href="#l2.18"></a><span id="l2.18">   SetupTextEditorCommands();</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20">   // dump(&quot;Registering HTML editor commands\n&quot;);</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22">   commandTable.registerCommand(&quot;cmd_renderedHTMLEnabler&quot;, nsDummyHTMLCommand);</span>
<a href="#l2.23"></a><span id="l2.23"> </span>
<a href="#l2.24"></a><span id="l2.24">   commandTable.registerCommand(&quot;cmd_grid&quot;, nsGridCommand);</span>
<a href="#l2.25"></a><span id="l2.25"> </span>
<a href="#l2.26"></a><span id="l2.26">   commandTable.registerCommand(&quot;cmd_listProperties&quot;, nsListPropertiesCommand);</span>
<a href="#l2.27"></a><span id="l2.27">   commandTable.registerCommand(&quot;cmd_pageProperties&quot;, nsPagePropertiesCommand);</span>
<a href="#l2.28"></a><span id="l2.28">   commandTable.registerCommand(&quot;cmd_colorProperties&quot;, nsColorPropertiesCommand);</span>
<a href="#l2.29"></a><span id="l2.29">   commandTable.registerCommand(&quot;cmd_increaseFontStep&quot;, nsIncreaseFontCommand);</span>
<a href="#l2.30"></a><span id="l2.30">   commandTable.registerCommand(&quot;cmd_decreaseFontStep&quot;, nsDecreaseFontCommand);</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_advancedProperties&quot;, nsAdvancedPropertiesCommand);</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_objectProperties&quot;, nsObjectPropertiesCommand);</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_removeNamedAnchors&quot;, nsRemoveNamedAnchorsCommand);</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+  commandTable.registerCommand(</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+    &quot;cmd_advancedProperties&quot;,</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+    nsAdvancedPropertiesCommand</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+  );</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+  commandTable.registerCommand(</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+    &quot;cmd_objectProperties&quot;,</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+    nsObjectPropertiesCommand</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+  );</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+  commandTable.registerCommand(</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+    &quot;cmd_removeNamedAnchors&quot;,</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+    nsRemoveNamedAnchorsCommand</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+  );</span>
<a href="#l2.46"></a><span id="l2.46">   commandTable.registerCommand(&quot;cmd_editLink&quot;, nsEditLinkCommand);</span>
<a href="#l2.47"></a><span id="l2.47"> </span>
<a href="#l2.48"></a><span id="l2.48">   commandTable.registerCommand(&quot;cmd_form&quot;, nsFormCommand);</span>
<a href="#l2.49"></a><span id="l2.49">   commandTable.registerCommand(&quot;cmd_inputtag&quot;, nsInputTagCommand);</span>
<a href="#l2.50"></a><span id="l2.50">   commandTable.registerCommand(&quot;cmd_inputimage&quot;, nsInputImageCommand);</span>
<a href="#l2.51"></a><span id="l2.51">   commandTable.registerCommand(&quot;cmd_textarea&quot;, nsTextAreaCommand);</span>
<a href="#l2.52"></a><span id="l2.52">   commandTable.registerCommand(&quot;cmd_select&quot;, nsSelectCommand);</span>
<a href="#l2.53"></a><span id="l2.53">   commandTable.registerCommand(&quot;cmd_button&quot;, nsButtonCommand);</span>
<a href="#l2.54"></a><span id="l2.54">   commandTable.registerCommand(&quot;cmd_label&quot;, nsLabelCommand);</span>
<a href="#l2.55"></a><span id="l2.55">   commandTable.registerCommand(&quot;cmd_fieldset&quot;, nsFieldSetCommand);</span>
<a href="#l2.56"></a><span id="l2.56">   commandTable.registerCommand(&quot;cmd_isindex&quot;, nsIsIndexCommand);</span>
<a href="#l2.57"></a><span id="l2.57">   commandTable.registerCommand(&quot;cmd_image&quot;, nsImageCommand);</span>
<a href="#l2.58"></a><span id="l2.58">   commandTable.registerCommand(&quot;cmd_hline&quot;, nsHLineCommand);</span>
<a href="#l2.59"></a><span id="l2.59">   commandTable.registerCommand(&quot;cmd_link&quot;, nsLinkCommand);</span>
<a href="#l2.60"></a><span id="l2.60">   commandTable.registerCommand(&quot;cmd_anchor&quot;, nsAnchorCommand);</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_insertHTMLWithDialog&quot;, nsInsertHTMLWithDialogCommand);</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_insertMathWithDialog&quot;, nsInsertMathWithDialogCommand);</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+  commandTable.registerCommand(</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+    &quot;cmd_insertHTMLWithDialog&quot;,</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+    nsInsertHTMLWithDialogCommand</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+  );</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+  commandTable.registerCommand(</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+    &quot;cmd_insertMathWithDialog&quot;,</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+    nsInsertMathWithDialogCommand</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+  );</span>
<a href="#l2.71"></a><span id="l2.71">   commandTable.registerCommand(&quot;cmd_insertBreak&quot;, nsInsertBreakCommand);</span>
<a href="#l2.72"></a><span id="l2.72">   commandTable.registerCommand(&quot;cmd_insertBreakAll&quot;, nsInsertBreakAllCommand);</span>
<a href="#l2.73"></a><span id="l2.73"> </span>
<a href="#l2.74"></a><span id="l2.74">   commandTable.registerCommand(&quot;cmd_table&quot;, nsInsertOrEditTableCommand);</span>
<a href="#l2.75"></a><span id="l2.75">   commandTable.registerCommand(&quot;cmd_editTable&quot;, nsEditTableCommand);</span>
<a href="#l2.76"></a><span id="l2.76">   commandTable.registerCommand(&quot;cmd_SelectTable&quot;, nsSelectTableCommand);</span>
<a href="#l2.77"></a><span id="l2.77">   commandTable.registerCommand(&quot;cmd_SelectRow&quot;, nsSelectTableRowCommand);</span>
<a href="#l2.78"></a><span id="l2.78">   commandTable.registerCommand(&quot;cmd_SelectColumn&quot;, nsSelectTableColumnCommand);</span>
<a href="#l2.79"></a><span id="l2.79">   commandTable.registerCommand(&quot;cmd_SelectCell&quot;, nsSelectTableCellCommand);</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_SelectAllCells&quot;, nsSelectAllTableCellsCommand);</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+  commandTable.registerCommand(</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+    &quot;cmd_SelectAllCells&quot;,</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+    nsSelectAllTableCellsCommand</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+  );</span>
<a href="#l2.85"></a><span id="l2.85">   commandTable.registerCommand(&quot;cmd_InsertTable&quot;, nsInsertTableCommand);</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_InsertRowAbove&quot;, nsInsertTableRowAboveCommand);</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_InsertRowBelow&quot;, nsInsertTableRowBelowCommand);</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_InsertColumnBefore&quot;, nsInsertTableColumnBeforeCommand);</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_InsertColumnAfter&quot;, nsInsertTableColumnAfterCommand);</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_InsertCellBefore&quot;, nsInsertTableCellBeforeCommand);</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_InsertCellAfter&quot;, nsInsertTableCellAfterCommand);</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+  commandTable.registerCommand(</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+    &quot;cmd_InsertRowAbove&quot;,</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+    nsInsertTableRowAboveCommand</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+  );</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+  commandTable.registerCommand(</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+    &quot;cmd_InsertRowBelow&quot;,</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+    nsInsertTableRowBelowCommand</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+  );</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+  commandTable.registerCommand(</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineplus">+    &quot;cmd_InsertColumnBefore&quot;,</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+    nsInsertTableColumnBeforeCommand</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+  );</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+  commandTable.registerCommand(</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+    &quot;cmd_InsertColumnAfter&quot;,</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+    nsInsertTableColumnAfterCommand</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineplus">+  );</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+  commandTable.registerCommand(</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+    &quot;cmd_InsertCellBefore&quot;,</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+    nsInsertTableCellBeforeCommand</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+  );</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+  commandTable.registerCommand(</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+    &quot;cmd_InsertCellAfter&quot;,</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+    nsInsertTableCellAfterCommand</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+  );</span>
<a href="#l2.116"></a><span id="l2.116">   commandTable.registerCommand(&quot;cmd_DeleteTable&quot;, nsDeleteTableCommand);</span>
<a href="#l2.117"></a><span id="l2.117">   commandTable.registerCommand(&quot;cmd_DeleteRow&quot;, nsDeleteTableRowCommand);</span>
<a href="#l2.118"></a><span id="l2.118">   commandTable.registerCommand(&quot;cmd_DeleteColumn&quot;, nsDeleteTableColumnCommand);</span>
<a href="#l2.119"></a><span id="l2.119">   commandTable.registerCommand(&quot;cmd_DeleteCell&quot;, nsDeleteTableCellCommand);</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_DeleteCellContents&quot;, nsDeleteTableCellContentsCommand);</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+  commandTable.registerCommand(</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+    &quot;cmd_DeleteCellContents&quot;,</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineplus">+    nsDeleteTableCellContentsCommand</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+  );</span>
<a href="#l2.125"></a><span id="l2.125">   commandTable.registerCommand(&quot;cmd_JoinTableCells&quot;, nsJoinTableCellsCommand);</span>
<a href="#l2.126"></a><span id="l2.126">   commandTable.registerCommand(&quot;cmd_SplitTableCell&quot;, nsSplitTableCellCommand);</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_TableOrCellColor&quot;, nsTableOrCellColorCommand);</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+  commandTable.registerCommand(</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+    &quot;cmd_TableOrCellColor&quot;,</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+    nsTableOrCellColorCommand</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineplus">+  );</span>
<a href="#l2.132"></a><span id="l2.132">   commandTable.registerCommand(&quot;cmd_NormalizeTable&quot;, nsNormalizeTableCommand);</span>
<a href="#l2.133"></a><span id="l2.133">   commandTable.registerCommand(&quot;cmd_smiley&quot;, nsSetSmiley);</span>
<a href="#l2.134"></a><span id="l2.134">   commandTable.registerCommand(&quot;cmd_ConvertToTable&quot;, nsConvertToTable);</span>
<a href="#l2.135"></a><span id="l2.135"> }</span>
<a href="#l2.136"></a><span id="l2.136"> </span>
<a href="#l2.137"></a><span id="l2.137"> function SetupTextEditorCommands() {</span>
<a href="#l2.138"></a><span id="l2.138">   var commandTable = GetComposerCommandTable();</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineminus">-  if (!commandTable)</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineplus">+  if (!commandTable) {</span>
<a href="#l2.141"></a><span id="l2.141">     return;</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineplus">+  }</span>
<a href="#l2.143"></a><span id="l2.143"> </span>
<a href="#l2.144"></a><span id="l2.144">   // dump(&quot;Registering plain text editor commands\n&quot;);</span>
<a href="#l2.145"></a><span id="l2.145"> </span>
<a href="#l2.146"></a><span id="l2.146">   commandTable.registerCommand(&quot;cmd_findReplace&quot;, nsFindReplaceCommand);</span>
<a href="#l2.147"></a><span id="l2.147">   commandTable.registerCommand(&quot;cmd_find&quot;, nsFindCommand);</span>
<a href="#l2.148"></a><span id="l2.148">   commandTable.registerCommand(&quot;cmd_findNext&quot;, nsFindAgainCommand);</span>
<a href="#l2.149"></a><span id="l2.149">   commandTable.registerCommand(&quot;cmd_findPrev&quot;, nsFindAgainCommand);</span>
<a href="#l2.150"></a><span id="l2.150">   commandTable.registerCommand(&quot;cmd_rewrap&quot;, nsRewrapCommand);</span>
<a href="#l2.151"></a><span id="l2.151">   commandTable.registerCommand(&quot;cmd_spelling&quot;, nsSpellingCommand);</span>
<a href="#l2.152"></a><span id="l2.152">   commandTable.registerCommand(&quot;cmd_validate&quot;, nsValidateCommand);</span>
<a href="#l2.153"></a><span id="l2.153">   commandTable.registerCommand(&quot;cmd_insertChars&quot;, nsInsertCharsCommand);</span>
<a href="#l2.154"></a><span id="l2.154"> }</span>
<a href="#l2.155"></a><span id="l2.155"> </span>
<a href="#l2.156"></a><span id="l2.156"> function SetupComposerWindowCommands() {</span>
<a href="#l2.157"></a><span id="l2.157">   // Don't need to do this if already done</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineminus">-  if (gComposerWindowControllerID)</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineplus">+  if (gComposerWindowControllerID) {</span>
<a href="#l2.160"></a><span id="l2.160">     return;</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+  }</span>
<a href="#l2.162"></a><span id="l2.162"> </span>
<a href="#l2.163"></a><span id="l2.163">   // Create a command controller and register commands</span>
<a href="#l2.164"></a><span id="l2.164">   //   specific to Web Composer window (file-related commands, HTML Source...)</span>
<a href="#l2.165"></a><span id="l2.165">   //   We can't use the composer controller created on the content window else</span>
<a href="#l2.166"></a><span id="l2.166">   //     we can't process commands when in HTMLSource editor</span>
<a href="#l2.167"></a><span id="l2.167">   // IMPORTANT: For each of these commands, the doCommand method</span>
<a href="#l2.168"></a><span id="l2.168">   //            must first call SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l2.169"></a><span id="l2.169">   //            to go from HTML Source mode to any other edit mode</span>
<a href="#l2.170"></a><span id="l2.170"> </span>
<a href="#l2.171"></a><span id="l2.171">   var windowControllers = window.controllers;</span>
<a href="#l2.172"></a><span id="l2.172"> </span>
<a href="#l2.173"></a><span id="l2.173" class="difflineminus">-  if (!windowControllers) return;</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+  if (!windowControllers) {</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+    return;</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineplus">+  }</span>
<a href="#l2.177"></a><span id="l2.177"> </span>
<a href="#l2.178"></a><span id="l2.178">   var commandTable;</span>
<a href="#l2.179"></a><span id="l2.179">   var composerController;</span>
<a href="#l2.180"></a><span id="l2.180">   var editorController;</span>
<a href="#l2.181"></a><span id="l2.181">   try {</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineminus">-    composerController = Cc[&quot;@mozilla.org/embedcomp/base-command-controller;1&quot;].createInstance();</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineminus">-</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineminus">-    editorController = composerController.QueryInterface(Ci.nsIControllerContext);</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineplus">+    composerController = Cc[</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineplus">+      &quot;@mozilla.org/embedcomp/base-command-controller;1&quot;</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineplus">+    ].createInstance();</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineplus">+</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineplus">+    editorController = composerController.QueryInterface(</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineplus">+      Ci.nsIControllerContext</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineplus">+    );</span>
<a href="#l2.192"></a><span id="l2.192"> </span>
<a href="#l2.193"></a><span id="l2.193">     // Get the nsIControllerCommandTable interface we need to register commands</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineminus">-    var interfaceRequestor = composerController.QueryInterface(Ci.nsIInterfaceRequestor);</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineminus">-    commandTable = interfaceRequestor.getInterface(Ci.nsIControllerCommandTable);</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineplus">+    var interfaceRequestor = composerController.QueryInterface(</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineplus">+      Ci.nsIInterfaceRequestor</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineplus">+    );</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineplus">+    commandTable = interfaceRequestor.getInterface(</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineplus">+      Ci.nsIControllerCommandTable</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineplus">+    );</span>
<a href="#l2.202"></a><span id="l2.202">   } catch (e) {</span>
<a href="#l2.203"></a><span id="l2.203">     dump(&quot;Failed to create composerController\n&quot;);</span>
<a href="#l2.204"></a><span id="l2.204">     return;</span>
<a href="#l2.205"></a><span id="l2.205">   }</span>
<a href="#l2.206"></a><span id="l2.206"> </span>
<a href="#l2.207"></a><span id="l2.207" class="difflineminus">-</span>
<a href="#l2.208"></a><span id="l2.208">   if (!commandTable) {</span>
<a href="#l2.209"></a><span id="l2.209">     dump(&quot;Failed to get interface for nsIControllerCommandManager\n&quot;);</span>
<a href="#l2.210"></a><span id="l2.210">     return;</span>
<a href="#l2.211"></a><span id="l2.211">   }</span>
<a href="#l2.212"></a><span id="l2.212"> </span>
<a href="#l2.213"></a><span id="l2.213">   // File-related commands</span>
<a href="#l2.214"></a><span id="l2.214">   commandTable.registerCommand(&quot;cmd_open&quot;, nsOpenCommand);</span>
<a href="#l2.215"></a><span id="l2.215">   commandTable.registerCommand(&quot;cmd_save&quot;, nsSaveCommand);</span>
<a href="#l2.216"></a><span id="l2.216">   commandTable.registerCommand(&quot;cmd_saveAs&quot;, nsSaveAsCommand);</span>
<a href="#l2.217"></a><span id="l2.217">   commandTable.registerCommand(&quot;cmd_exportToText&quot;, nsExportToTextCommand);</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_saveAndChangeEncoding&quot;, nsSaveAndChangeEncodingCommand);</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineplus">+  commandTable.registerCommand(</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineplus">+    &quot;cmd_saveAndChangeEncoding&quot;,</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineplus">+    nsSaveAndChangeEncodingCommand</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineplus">+  );</span>
<a href="#l2.223"></a><span id="l2.223">   commandTable.registerCommand(&quot;cmd_publish&quot;, nsPublishCommand);</span>
<a href="#l2.224"></a><span id="l2.224">   commandTable.registerCommand(&quot;cmd_publishAs&quot;, nsPublishAsCommand);</span>
<a href="#l2.225"></a><span id="l2.225">   commandTable.registerCommand(&quot;cmd_publishSettings&quot;, nsPublishSettingsCommand);</span>
<a href="#l2.226"></a><span id="l2.226">   commandTable.registerCommand(&quot;cmd_revert&quot;, nsRevertCommand);</span>
<a href="#l2.227"></a><span id="l2.227">   commandTable.registerCommand(&quot;cmd_openRemote&quot;, nsOpenRemoteCommand);</span>
<a href="#l2.228"></a><span id="l2.228">   commandTable.registerCommand(&quot;cmd_preview&quot;, nsPreviewCommand);</span>
<a href="#l2.229"></a><span id="l2.229">   commandTable.registerCommand(&quot;cmd_editSendPage&quot;, nsSendPageCommand);</span>
<a href="#l2.230"></a><span id="l2.230">   commandTable.registerCommand(&quot;cmd_print&quot;, nsPrintCommand);</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineat">@@ -160,60 +217,78 @@ function SetupComposerWindowCommands() {</span>
<a href="#l2.232"></a><span id="l2.232">   // Edit Mode commands</span>
<a href="#l2.233"></a><span id="l2.233">   if (GetCurrentEditorType() == &quot;html&quot;) {</span>
<a href="#l2.234"></a><span id="l2.234">     commandTable.registerCommand(&quot;cmd_NormalMode&quot;, nsNormalModeCommand);</span>
<a href="#l2.235"></a><span id="l2.235">     commandTable.registerCommand(&quot;cmd_AllTagsMode&quot;, nsAllTagsModeCommand);</span>
<a href="#l2.236"></a><span id="l2.236">     commandTable.registerCommand(&quot;cmd_HTMLSourceMode&quot;, nsHTMLSourceModeCommand);</span>
<a href="#l2.237"></a><span id="l2.237">     commandTable.registerCommand(&quot;cmd_PreviewMode&quot;, nsPreviewModeCommand);</span>
<a href="#l2.238"></a><span id="l2.238">     commandTable.registerCommand(&quot;cmd_FinishHTMLSource&quot;, nsFinishHTMLSource);</span>
<a href="#l2.239"></a><span id="l2.239">     commandTable.registerCommand(&quot;cmd_CancelHTMLSource&quot;, nsCancelHTMLSource);</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineminus">-    commandTable.registerCommand(&quot;cmd_updateStructToolbar&quot;, nsUpdateStructToolbarCommand);</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineplus">+    commandTable.registerCommand(</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+      &quot;cmd_updateStructToolbar&quot;,</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineplus">+      nsUpdateStructToolbarCommand</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineplus">+    );</span>
<a href="#l2.245"></a><span id="l2.245">   }</span>
<a href="#l2.246"></a><span id="l2.246"> </span>
<a href="#l2.247"></a><span id="l2.247">   windowControllers.insertControllerAt(0, editorController);</span>
<a href="#l2.248"></a><span id="l2.248"> </span>
<a href="#l2.249"></a><span id="l2.249">   // Store the controller ID so we can be sure to get the right one later</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineminus">-  gComposerWindowControllerID = windowControllers.getControllerId(editorController);</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineplus">+  gComposerWindowControllerID = windowControllers.getControllerId(</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineplus">+    editorController</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineplus">+  );</span>
<a href="#l2.254"></a><span id="l2.254"> }</span>
<a href="#l2.255"></a><span id="l2.255"> </span>
<a href="#l2.256"></a><span id="l2.256"> function GetComposerCommandTable() {</span>
<a href="#l2.257"></a><span id="l2.257">   var controller;</span>
<a href="#l2.258"></a><span id="l2.258">   if (gComposerJSCommandControllerID) {</span>
<a href="#l2.259"></a><span id="l2.259">     try {</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineminus">-      controller = window.content.controllers.getControllerById(gComposerJSCommandControllerID);</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineplus">+      controller = window.content.controllers.getControllerById(</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineplus">+        gComposerJSCommandControllerID</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineplus">+      );</span>
<a href="#l2.264"></a><span id="l2.264">     } catch (e) {}</span>
<a href="#l2.265"></a><span id="l2.265">   }</span>
<a href="#l2.266"></a><span id="l2.266">   if (!controller) {</span>
<a href="#l2.267"></a><span id="l2.267">     // create it</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineminus">-    controller = Cc[&quot;@mozilla.org/embedcomp/base-command-controller;1&quot;].createInstance();</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineplus">+    controller = Cc[</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineplus">+      &quot;@mozilla.org/embedcomp/base-command-controller;1&quot;</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineplus">+    ].createInstance();</span>
<a href="#l2.272"></a><span id="l2.272"> </span>
<a href="#l2.273"></a><span id="l2.273">     var editorController = controller.QueryInterface(Ci.nsIControllerContext);</span>
<a href="#l2.274"></a><span id="l2.274">     editorController.setCommandContext(GetCurrentEditorElement());</span>
<a href="#l2.275"></a><span id="l2.275">     window.content.controllers.insertControllerAt(0, controller);</span>
<a href="#l2.276"></a><span id="l2.276"> </span>
<a href="#l2.277"></a><span id="l2.277">     // Store the controller ID so we can be sure to get the right one later</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineminus">-    gComposerJSCommandControllerID = window.content.controllers.getControllerId(controller);</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineplus">+    gComposerJSCommandControllerID = window.content.controllers.getControllerId(</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineplus">+      controller</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineplus">+    );</span>
<a href="#l2.282"></a><span id="l2.282">   }</span>
<a href="#l2.283"></a><span id="l2.283"> </span>
<a href="#l2.284"></a><span id="l2.284">   if (controller) {</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineminus">-    var interfaceRequestor = controller.QueryInterface(Ci.nsIInterfaceRequestor);</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineplus">+    var interfaceRequestor = controller.QueryInterface(</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineplus">+      Ci.nsIInterfaceRequestor</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineplus">+    );</span>
<a href="#l2.289"></a><span id="l2.289">     return interfaceRequestor.getInterface(Ci.nsIControllerCommandTable);</span>
<a href="#l2.290"></a><span id="l2.290">   }</span>
<a href="#l2.291"></a><span id="l2.291">   return null;</span>
<a href="#l2.292"></a><span id="l2.292"> }</span>
<a href="#l2.293"></a><span id="l2.293"> </span>
<a href="#l2.294"></a><span id="l2.294"> /* eslint-disable complexity */</span>
<a href="#l2.295"></a><span id="l2.295"> function goUpdateCommandState(command) {</span>
<a href="#l2.296"></a><span id="l2.296">   try {</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineminus">-    var controller = top.document.commandDispatcher.getControllerForCommand(command);</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineminus">-    if (!(controller instanceof Ci.nsICommandController))</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineplus">+    var controller = top.document.commandDispatcher.getControllerForCommand(</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineplus">+      command</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineplus">+    );</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineplus">+    if (!(controller instanceof Ci.nsICommandController)) {</span>
<a href="#l2.303"></a><span id="l2.303">       return;</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineplus">+    }</span>
<a href="#l2.305"></a><span id="l2.305"> </span>
<a href="#l2.306"></a><span id="l2.306">     var params = newCommandParams();</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineminus">-    if (!params) return;</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineplus">+    if (!params) {</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineplus">+      return;</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineplus">+    }</span>
<a href="#l2.311"></a><span id="l2.311"> </span>
<a href="#l2.312"></a><span id="l2.312">     controller.getCommandStateWithParams(command, params);</span>
<a href="#l2.313"></a><span id="l2.313"> </span>
<a href="#l2.314"></a><span id="l2.314">     switch (command) {</span>
<a href="#l2.315"></a><span id="l2.315">       case &quot;cmd_bold&quot;:</span>
<a href="#l2.316"></a><span id="l2.316">       case &quot;cmd_italic&quot;:</span>
<a href="#l2.317"></a><span id="l2.317">       case &quot;cmd_underline&quot;:</span>
<a href="#l2.318"></a><span id="l2.318">       case &quot;cmd_var&quot;:</span>
<a href="#l2.319"></a><span id="l2.319" class="difflineat">@@ -252,79 +327,88 @@ function goUpdateCommandState(command) {</span>
<a href="#l2.320"></a><span id="l2.320">       case &quot;cmd_increaseFont&quot;:</span>
<a href="#l2.321"></a><span id="l2.321">       case &quot;cmd_decreaseFont&quot;:</span>
<a href="#l2.322"></a><span id="l2.322">       case &quot;cmd_increaseFontStep&quot;:</span>
<a href="#l2.323"></a><span id="l2.323">       case &quot;cmd_decreaseFontStep&quot;:</span>
<a href="#l2.324"></a><span id="l2.324">       case &quot;cmd_removeStyles&quot;:</span>
<a href="#l2.325"></a><span id="l2.325">       case &quot;cmd_smiley&quot;:</span>
<a href="#l2.326"></a><span id="l2.326">         break;</span>
<a href="#l2.327"></a><span id="l2.327"> </span>
<a href="#l2.328"></a><span id="l2.328" class="difflineminus">-      default: dump(&quot;no update for command: &quot; + command + &quot;\n&quot;);</span>
<a href="#l2.329"></a><span id="l2.329" class="difflineplus">+      default:</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineplus">+        dump(&quot;no update for command: &quot; + command + &quot;\n&quot;);</span>
<a href="#l2.331"></a><span id="l2.331">     }</span>
<a href="#l2.332"></a><span id="l2.332">   } catch (e) {</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineminus">-    dump(&quot;An error occurred updating the &quot; + command + &quot; command: \n&quot; + e + &quot;\n&quot;);</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineplus">+    dump(</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineplus">+      &quot;An error occurred updating the &quot; + command + &quot; command: \n&quot; + e + &quot;\n&quot;</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineplus">+    );</span>
<a href="#l2.337"></a><span id="l2.337">   }</span>
<a href="#l2.338"></a><span id="l2.338"> }</span>
<a href="#l2.339"></a><span id="l2.339"> /* eslint-enable complexity */</span>
<a href="#l2.340"></a><span id="l2.340"> </span>
<a href="#l2.341"></a><span id="l2.341"> function goUpdateComposerMenuItems(commandset) {</span>
<a href="#l2.342"></a><span id="l2.342">   // dump(&quot;Updating commands for &quot; + commandset.id + &quot;\n&quot;);</span>
<a href="#l2.343"></a><span id="l2.343"> </span>
<a href="#l2.344"></a><span id="l2.344">   for (var i = 0; i &lt; commandset.childNodes.length; i++) {</span>
<a href="#l2.345"></a><span id="l2.345">     var commandNode = commandset.childNodes[i];</span>
<a href="#l2.346"></a><span id="l2.346">     var commandID = commandNode.id;</span>
<a href="#l2.347"></a><span id="l2.347">     if (commandID) {</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineminus">-      goUpdateCommand(commandID);  // enable or disable</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineminus">-      if (commandNode.hasAttribute(&quot;state&quot;))</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineplus">+      goUpdateCommand(commandID); // enable or disable</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineplus">+      if (commandNode.hasAttribute(&quot;state&quot;)) {</span>
<a href="#l2.352"></a><span id="l2.352">         goUpdateCommandState(commandID);</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineplus">+      }</span>
<a href="#l2.354"></a><span id="l2.354">     }</span>
<a href="#l2.355"></a><span id="l2.355">   }</span>
<a href="#l2.356"></a><span id="l2.356"> }</span>
<a href="#l2.357"></a><span id="l2.357"> </span>
<a href="#l2.358"></a><span id="l2.358"> function goDoCommandParams(command, params) {</span>
<a href="#l2.359"></a><span id="l2.359">   try {</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineminus">-    var controller = top.document.commandDispatcher.getControllerForCommand(command);</span>
<a href="#l2.361"></a><span id="l2.361" class="difflineplus">+    var controller = top.document.commandDispatcher.getControllerForCommand(</span>
<a href="#l2.362"></a><span id="l2.362" class="difflineplus">+      command</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineplus">+    );</span>
<a href="#l2.364"></a><span id="l2.364">     if (controller &amp;&amp; controller.isCommandEnabled(command)) {</span>
<a href="#l2.365"></a><span id="l2.365">       if (controller instanceof Ci.nsICommandController) {</span>
<a href="#l2.366"></a><span id="l2.366">         controller.doCommandWithParams(command, params);</span>
<a href="#l2.367"></a><span id="l2.367"> </span>
<a href="#l2.368"></a><span id="l2.368">         // the following two lines should be removed when we implement observers</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineminus">-        if (params)</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineplus">+        if (params) {</span>
<a href="#l2.371"></a><span id="l2.371">           controller.getCommandStateWithParams(command, params);</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineplus">+        }</span>
<a href="#l2.373"></a><span id="l2.373">       } else {</span>
<a href="#l2.374"></a><span id="l2.374">         controller.doCommand(command);</span>
<a href="#l2.375"></a><span id="l2.375">       }</span>
<a href="#l2.376"></a><span id="l2.376">       ResetStructToolbar();</span>
<a href="#l2.377"></a><span id="l2.377">     }</span>
<a href="#l2.378"></a><span id="l2.378">   } catch (e) {</span>
<a href="#l2.379"></a><span id="l2.379">     dump(&quot;An error occurred executing the &quot; + command + &quot; command\n&quot;);</span>
<a href="#l2.380"></a><span id="l2.380">   }</span>
<a href="#l2.381"></a><span id="l2.381"> }</span>
<a href="#l2.382"></a><span id="l2.382"> </span>
<a href="#l2.383"></a><span id="l2.383"> function pokeStyleUI(uiID, aDesiredState) {</span>
<a href="#l2.384"></a><span id="l2.384">   try {</span>
<a href="#l2.385"></a><span id="l2.385">     var commandNode = top.document.getElementById(uiID);</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineminus">-    if (!commandNode)</span>
<a href="#l2.387"></a><span id="l2.387" class="difflineplus">+    if (!commandNode) {</span>
<a href="#l2.388"></a><span id="l2.388">       return;</span>
<a href="#l2.389"></a><span id="l2.389" class="difflineminus">-</span>
<a href="#l2.390"></a><span id="l2.390" class="difflineminus">-    var uiState = (&quot;true&quot; == commandNode.getAttribute(&quot;state&quot;));</span>
<a href="#l2.391"></a><span id="l2.391" class="difflineplus">+    }</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineplus">+</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineplus">+    var uiState = &quot;true&quot; == commandNode.getAttribute(&quot;state&quot;);</span>
<a href="#l2.394"></a><span id="l2.394">     if (aDesiredState != uiState) {</span>
<a href="#l2.395"></a><span id="l2.395">       commandNode.setAttribute(&quot;state&quot;, aDesiredState ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l2.396"></a><span id="l2.396">     }</span>
<a href="#l2.397"></a><span id="l2.397">   } catch (e) {</span>
<a href="#l2.398"></a><span id="l2.398">     dump(&quot;poking UI for &quot; + uiID + &quot; failed: &quot; + e + &quot;\n&quot;);</span>
<a href="#l2.399"></a><span id="l2.399">   }</span>
<a href="#l2.400"></a><span id="l2.400"> }</span>
<a href="#l2.401"></a><span id="l2.401"> </span>
<a href="#l2.402"></a><span id="l2.402"> function doStyleUICommand(cmdStr) {</span>
<a href="#l2.403"></a><span id="l2.403">   try {</span>
<a href="#l2.404"></a><span id="l2.404">     var cmdParams = newCommandParams();</span>
<a href="#l2.405"></a><span id="l2.405">     goDoCommandParams(cmdStr, cmdParams);</span>
<a href="#l2.406"></a><span id="l2.406" class="difflineminus">-    if (cmdParams)</span>
<a href="#l2.407"></a><span id="l2.407" class="difflineplus">+    if (cmdParams) {</span>
<a href="#l2.408"></a><span id="l2.408">       pokeStyleUI(cmdStr, cmdParams.getBooleanValue(&quot;state_all&quot;));</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineplus">+    }</span>
<a href="#l2.410"></a><span id="l2.410"> </span>
<a href="#l2.411"></a><span id="l2.411">     ResetStructToolbar();</span>
<a href="#l2.412"></a><span id="l2.412">   } catch (e) {}</span>
<a href="#l2.413"></a><span id="l2.413"> }</span>
<a href="#l2.414"></a><span id="l2.414"> </span>
<a href="#l2.415"></a><span id="l2.415"> // Copied from jsmime.js.</span>
<a href="#l2.416"></a><span id="l2.416"> function stringToTypedArray(buffer) {</span>
<a href="#l2.417"></a><span id="l2.417">   var typedarray = new Uint8Array(buffer.length);</span>
<a href="#l2.418"></a><span id="l2.418" class="difflineat">@@ -332,94 +416,100 @@ function stringToTypedArray(buffer) {</span>
<a href="#l2.419"></a><span id="l2.419">     typedarray[i] = buffer.charCodeAt(i);</span>
<a href="#l2.420"></a><span id="l2.420">   }</span>
<a href="#l2.421"></a><span id="l2.421">   return typedarray;</span>
<a href="#l2.422"></a><span id="l2.422"> }</span>
<a href="#l2.423"></a><span id="l2.423"> </span>
<a href="#l2.424"></a><span id="l2.424"> function pokeMultiStateUI(uiID, cmdParams) {</span>
<a href="#l2.425"></a><span id="l2.425">   try {</span>
<a href="#l2.426"></a><span id="l2.426">     var commandNode = document.getElementById(uiID);</span>
<a href="#l2.427"></a><span id="l2.427" class="difflineminus">-    if (!commandNode)</span>
<a href="#l2.428"></a><span id="l2.428" class="difflineplus">+    if (!commandNode) {</span>
<a href="#l2.429"></a><span id="l2.429">       return;</span>
<a href="#l2.430"></a><span id="l2.430" class="difflineplus">+    }</span>
<a href="#l2.431"></a><span id="l2.431"> </span>
<a href="#l2.432"></a><span id="l2.432">     var isMixed = cmdParams.getBooleanValue(&quot;state_mixed&quot;);</span>
<a href="#l2.433"></a><span id="l2.433">     var desiredAttrib;</span>
<a href="#l2.434"></a><span id="l2.434">     if (isMixed) {</span>
<a href="#l2.435"></a><span id="l2.435">       desiredAttrib = &quot;mixed&quot;;</span>
<a href="#l2.436"></a><span id="l2.436">     } else {</span>
<a href="#l2.437"></a><span id="l2.437">       var valuetype = cmdParams.getValueType(&quot;state_attribute&quot;);</span>
<a href="#l2.438"></a><span id="l2.438">       if (valuetype == Ci.nsICommandParams.eStringType) {</span>
<a href="#l2.439"></a><span id="l2.439">         desiredAttrib = cmdParams.getCStringValue(&quot;state_attribute&quot;);</span>
<a href="#l2.440"></a><span id="l2.440">         // Decode UTF-8, for example for font names in Japanese.</span>
<a href="#l2.441"></a><span id="l2.441" class="difflineminus">-        desiredAttrib = new TextDecoder(&quot;UTF-8&quot;).decode(stringToTypedArray(desiredAttrib));</span>
<a href="#l2.442"></a><span id="l2.442" class="difflineplus">+        desiredAttrib = new TextDecoder(&quot;UTF-8&quot;).decode(</span>
<a href="#l2.443"></a><span id="l2.443" class="difflineplus">+          stringToTypedArray(desiredAttrib)</span>
<a href="#l2.444"></a><span id="l2.444" class="difflineplus">+        );</span>
<a href="#l2.445"></a><span id="l2.445">       } else {</span>
<a href="#l2.446"></a><span id="l2.446">         desiredAttrib = cmdParams.getStringValue(&quot;state_attribute&quot;);</span>
<a href="#l2.447"></a><span id="l2.447">       }</span>
<a href="#l2.448"></a><span id="l2.448">     }</span>
<a href="#l2.449"></a><span id="l2.449"> </span>
<a href="#l2.450"></a><span id="l2.450">     var uiState = commandNode.getAttribute(&quot;state&quot;);</span>
<a href="#l2.451"></a><span id="l2.451">     if (desiredAttrib != uiState) {</span>
<a href="#l2.452"></a><span id="l2.452">       commandNode.setAttribute(&quot;state&quot;, desiredAttrib);</span>
<a href="#l2.453"></a><span id="l2.453">     }</span>
<a href="#l2.454"></a><span id="l2.454">   } catch (e) {}</span>
<a href="#l2.455"></a><span id="l2.455"> }</span>
<a href="#l2.456"></a><span id="l2.456"> </span>
<a href="#l2.457"></a><span id="l2.457"> function doStatefulCommand(commandID, newState) {</span>
<a href="#l2.458"></a><span id="l2.458">   var commandNode = document.getElementById(commandID);</span>
<a href="#l2.459"></a><span id="l2.459" class="difflineminus">-  if (commandNode)</span>
<a href="#l2.460"></a><span id="l2.460" class="difflineminus">-      commandNode.setAttribute(&quot;state&quot;, newState);</span>
<a href="#l2.461"></a><span id="l2.461" class="difflineminus">-  gContentWindow.focus();   // needed for command dispatch to work</span>
<a href="#l2.462"></a><span id="l2.462" class="difflineplus">+  if (commandNode) {</span>
<a href="#l2.463"></a><span id="l2.463" class="difflineplus">+    commandNode.setAttribute(&quot;state&quot;, newState);</span>
<a href="#l2.464"></a><span id="l2.464" class="difflineplus">+  }</span>
<a href="#l2.465"></a><span id="l2.465" class="difflineplus">+  gContentWindow.focus(); // needed for command dispatch to work</span>
<a href="#l2.466"></a><span id="l2.466"> </span>
<a href="#l2.467"></a><span id="l2.467">   try {</span>
<a href="#l2.468"></a><span id="l2.468">     var cmdParams = newCommandParams();</span>
<a href="#l2.469"></a><span id="l2.469" class="difflineminus">-    if (!cmdParams) return;</span>
<a href="#l2.470"></a><span id="l2.470" class="difflineplus">+    if (!cmdParams) {</span>
<a href="#l2.471"></a><span id="l2.471" class="difflineplus">+      return;</span>
<a href="#l2.472"></a><span id="l2.472" class="difflineplus">+    }</span>
<a href="#l2.473"></a><span id="l2.473"> </span>
<a href="#l2.474"></a><span id="l2.474">     cmdParams.setStringValue(&quot;state_attribute&quot;, newState);</span>
<a href="#l2.475"></a><span id="l2.475">     goDoCommandParams(commandID, cmdParams);</span>
<a href="#l2.476"></a><span id="l2.476"> </span>
<a href="#l2.477"></a><span id="l2.477">     pokeMultiStateUI(commandID, cmdParams);</span>
<a href="#l2.478"></a><span id="l2.478"> </span>
<a href="#l2.479"></a><span id="l2.479">     ResetStructToolbar();</span>
<a href="#l2.480"></a><span id="l2.480">   } catch (e) {</span>
<a href="#l2.481"></a><span id="l2.481">     dump(&quot;error thrown in doStatefulCommand: &quot; + e + &quot;\n&quot;);</span>
<a href="#l2.482"></a><span id="l2.482">   }</span>
<a href="#l2.483"></a><span id="l2.483"> }</span>
<a href="#l2.484"></a><span id="l2.484"> </span>
<a href="#l2.485"></a><span id="l2.485"> function PrintObject(obj) {</span>
<a href="#l2.486"></a><span id="l2.486">   dump(&quot;-----&quot; + obj + &quot;------\n&quot;);</span>
<a href="#l2.487"></a><span id="l2.487">   var names = &quot;&quot;;</span>
<a href="#l2.488"></a><span id="l2.488">   for (var i in obj) {</span>
<a href="#l2.489"></a><span id="l2.489" class="difflineminus">-    if (i == &quot;value&quot;)</span>
<a href="#l2.490"></a><span id="l2.490" class="difflineplus">+    if (i == &quot;value&quot;) {</span>
<a href="#l2.491"></a><span id="l2.491">       names += i + &quot;: &quot; + obj.value + &quot;\n&quot;;</span>
<a href="#l2.492"></a><span id="l2.492" class="difflineminus">-    else if (i == &quot;id&quot;)</span>
<a href="#l2.493"></a><span id="l2.493" class="difflineplus">+    } else if (i == &quot;id&quot;) {</span>
<a href="#l2.494"></a><span id="l2.494">       names += i + &quot;: &quot; + obj.id + &quot;\n&quot;;</span>
<a href="#l2.495"></a><span id="l2.495" class="difflineminus">-    else</span>
<a href="#l2.496"></a><span id="l2.496" class="difflineplus">+    } else {</span>
<a href="#l2.497"></a><span id="l2.497">       names += i + &quot;\n&quot;;</span>
<a href="#l2.498"></a><span id="l2.498" class="difflineplus">+    }</span>
<a href="#l2.499"></a><span id="l2.499">   }</span>
<a href="#l2.500"></a><span id="l2.500"> </span>
<a href="#l2.501"></a><span id="l2.501">   dump(names + &quot;-----------\n&quot;);</span>
<a href="#l2.502"></a><span id="l2.502"> }</span>
<a href="#l2.503"></a><span id="l2.503"> </span>
<a href="#l2.504"></a><span id="l2.504"> function PrintNodeID(id) {</span>
<a href="#l2.505"></a><span id="l2.505">   PrintObject(document.getElementById(id));</span>
<a href="#l2.506"></a><span id="l2.506"> }</span>
<a href="#l2.507"></a><span id="l2.507"> </span>
<a href="#l2.508"></a><span id="l2.508"> var nsDummyHTMLCommand = {</span>
<a href="#l2.509"></a><span id="l2.509">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.510"></a><span id="l2.510" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.511"></a><span id="l2.511" class="difflineplus">+    return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l2.512"></a><span id="l2.512">   },</span>
<a href="#l2.513"></a><span id="l2.513"> </span>
<a href="#l2.514"></a><span id="l2.514">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.515"></a><span id="l2.515">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.516"></a><span id="l2.516"> </span>
<a href="#l2.517"></a><span id="l2.517">   doCommand(aCommand) {</span>
<a href="#l2.518"></a><span id="l2.518">     // do nothing</span>
<a href="#l2.519"></a><span id="l2.519">     dump(&quot;Hey, who's calling the dummy command?\n&quot;);</span>
<a href="#l2.520"></a><span id="l2.520">   },</span>
<a href="#l2.521"></a><span id="l2.521" class="difflineminus">-</span>
<a href="#l2.522"></a><span id="l2.522"> };</span>
<a href="#l2.523"></a><span id="l2.523"> </span>
<a href="#l2.524"></a><span id="l2.524"> /* eslint-disable */</span>
<a href="#l2.525"></a><span id="l2.525"> var nsOpenCommand = {</span>
<a href="#l2.526"></a><span id="l2.526">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.527"></a><span id="l2.527">     return true;    // we can always do this</span>
<a href="#l2.528"></a><span id="l2.528">   },</span>
<a href="#l2.529"></a><span id="l2.529"> </span>
<a href="#l2.530"></a><span id="l2.530" class="difflineat">@@ -473,88 +563,103 @@ var nsUpdateStructToolbarCommand = {</span>
<a href="#l2.531"></a><span id="l2.531"> // ******* File output commands and utilities ******** //</span>
<a href="#l2.532"></a><span id="l2.532"> var nsSaveCommand = {</span>
<a href="#l2.533"></a><span id="l2.533">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.534"></a><span id="l2.534">     // Always allow saving when editing a remote document,</span>
<a href="#l2.535"></a><span id="l2.535">     //  otherwise the document modified state would prevent that</span>
<a href="#l2.536"></a><span id="l2.536">     //  when you first open a remote file.</span>
<a href="#l2.537"></a><span id="l2.537">     try {</span>
<a href="#l2.538"></a><span id="l2.538">       var docUrl = GetDocumentUrl();</span>
<a href="#l2.539"></a><span id="l2.539" class="difflineminus">-      return IsDocumentEditable() &amp;&amp;</span>
<a href="#l2.540"></a><span id="l2.540" class="difflineminus">-        (IsDocumentModified() || IsHTMLSourceChanged() ||</span>
<a href="#l2.541"></a><span id="l2.541" class="difflineminus">-         IsUrlAboutBlank(docUrl) || GetScheme(docUrl) != &quot;file&quot;);</span>
<a href="#l2.542"></a><span id="l2.542" class="difflineplus">+      return (</span>
<a href="#l2.543"></a><span id="l2.543" class="difflineplus">+        IsDocumentEditable() &amp;&amp;</span>
<a href="#l2.544"></a><span id="l2.544" class="difflineplus">+        (IsDocumentModified() ||</span>
<a href="#l2.545"></a><span id="l2.545" class="difflineplus">+          IsHTMLSourceChanged() ||</span>
<a href="#l2.546"></a><span id="l2.546" class="difflineplus">+          IsUrlAboutBlank(docUrl) ||</span>
<a href="#l2.547"></a><span id="l2.547" class="difflineplus">+          GetScheme(docUrl) != &quot;file&quot;)</span>
<a href="#l2.548"></a><span id="l2.548" class="difflineplus">+      );</span>
<a href="#l2.549"></a><span id="l2.549">     } catch (e) {</span>
<a href="#l2.550"></a><span id="l2.550">       return false;</span>
<a href="#l2.551"></a><span id="l2.551">     }</span>
<a href="#l2.552"></a><span id="l2.552">   },</span>
<a href="#l2.553"></a><span id="l2.553"> </span>
<a href="#l2.554"></a><span id="l2.554">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.555"></a><span id="l2.555">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.556"></a><span id="l2.556"> </span>
<a href="#l2.557"></a><span id="l2.557">   doCommand(aCommand) {</span>
<a href="#l2.558"></a><span id="l2.558">     var editor = GetCurrentEditor();</span>
<a href="#l2.559"></a><span id="l2.559">     if (editor) {</span>
<a href="#l2.560"></a><span id="l2.560" class="difflineminus">-      if (IsHTMLEditor())</span>
<a href="#l2.561"></a><span id="l2.561" class="difflineplus">+      if (IsHTMLEditor()) {</span>
<a href="#l2.562"></a><span id="l2.562">         SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l2.563"></a><span id="l2.563" class="difflineminus">-      SaveDocument(IsUrlAboutBlank(GetDocumentUrl()), false, editor.contentsMIMEType);</span>
<a href="#l2.564"></a><span id="l2.564" class="difflineplus">+      }</span>
<a href="#l2.565"></a><span id="l2.565" class="difflineplus">+      SaveDocument(</span>
<a href="#l2.566"></a><span id="l2.566" class="difflineplus">+        IsUrlAboutBlank(GetDocumentUrl()),</span>
<a href="#l2.567"></a><span id="l2.567" class="difflineplus">+        false,</span>
<a href="#l2.568"></a><span id="l2.568" class="difflineplus">+        editor.contentsMIMEType</span>
<a href="#l2.569"></a><span id="l2.569" class="difflineplus">+      );</span>
<a href="#l2.570"></a><span id="l2.570">     }</span>
<a href="#l2.571"></a><span id="l2.571">   },</span>
<a href="#l2.572"></a><span id="l2.572"> };</span>
<a href="#l2.573"></a><span id="l2.573"> </span>
<a href="#l2.574"></a><span id="l2.574"> var nsSaveAsCommand = {</span>
<a href="#l2.575"></a><span id="l2.575">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.576"></a><span id="l2.576" class="difflineminus">-    return (IsDocumentEditable());</span>
<a href="#l2.577"></a><span id="l2.577" class="difflineplus">+    return IsDocumentEditable();</span>
<a href="#l2.578"></a><span id="l2.578">   },</span>
<a href="#l2.579"></a><span id="l2.579"> </span>
<a href="#l2.580"></a><span id="l2.580">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.581"></a><span id="l2.581">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.582"></a><span id="l2.582"> </span>
<a href="#l2.583"></a><span id="l2.583">   doCommand(aCommand) {</span>
<a href="#l2.584"></a><span id="l2.584">     var editor = GetCurrentEditor();</span>
<a href="#l2.585"></a><span id="l2.585">     if (editor) {</span>
<a href="#l2.586"></a><span id="l2.586" class="difflineminus">-      if (IsHTMLEditor())</span>
<a href="#l2.587"></a><span id="l2.587" class="difflineplus">+      if (IsHTMLEditor()) {</span>
<a href="#l2.588"></a><span id="l2.588">         SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l2.589"></a><span id="l2.589" class="difflineplus">+      }</span>
<a href="#l2.590"></a><span id="l2.590">       SaveDocument(true, false, editor.contentsMIMEType);</span>
<a href="#l2.591"></a><span id="l2.591">     }</span>
<a href="#l2.592"></a><span id="l2.592">   },</span>
<a href="#l2.593"></a><span id="l2.593"> };</span>
<a href="#l2.594"></a><span id="l2.594"> </span>
<a href="#l2.595"></a><span id="l2.595"> var nsExportToTextCommand = {</span>
<a href="#l2.596"></a><span id="l2.596">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.597"></a><span id="l2.597" class="difflineminus">-    return (IsDocumentEditable());</span>
<a href="#l2.598"></a><span id="l2.598" class="difflineplus">+    return IsDocumentEditable();</span>
<a href="#l2.599"></a><span id="l2.599">   },</span>
<a href="#l2.600"></a><span id="l2.600"> </span>
<a href="#l2.601"></a><span id="l2.601">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.602"></a><span id="l2.602">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.603"></a><span id="l2.603"> </span>
<a href="#l2.604"></a><span id="l2.604">   doCommand(aCommand) {</span>
<a href="#l2.605"></a><span id="l2.605">     if (GetCurrentEditor()) {</span>
<a href="#l2.606"></a><span id="l2.606">       SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l2.607"></a><span id="l2.607">       SaveDocument(true, true, &quot;text/plain&quot;);</span>
<a href="#l2.608"></a><span id="l2.608">     }</span>
<a href="#l2.609"></a><span id="l2.609">   },</span>
<a href="#l2.610"></a><span id="l2.610"> };</span>
<a href="#l2.611"></a><span id="l2.611"> </span>
<a href="#l2.612"></a><span id="l2.612"> var nsSaveAndChangeEncodingCommand = {</span>
<a href="#l2.613"></a><span id="l2.613">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.614"></a><span id="l2.614" class="difflineminus">-    return (IsDocumentEditable());</span>
<a href="#l2.615"></a><span id="l2.615" class="difflineplus">+    return IsDocumentEditable();</span>
<a href="#l2.616"></a><span id="l2.616">   },</span>
<a href="#l2.617"></a><span id="l2.617"> </span>
<a href="#l2.618"></a><span id="l2.618">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.619"></a><span id="l2.619">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.620"></a><span id="l2.620"> </span>
<a href="#l2.621"></a><span id="l2.621">   doCommand(aCommand) {</span>
<a href="#l2.622"></a><span id="l2.622">     SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l2.623"></a><span id="l2.623">     window.ok = false;</span>
<a href="#l2.624"></a><span id="l2.624">     window.exportToText = false;</span>
<a href="#l2.625"></a><span id="l2.625">     var oldTitle = GetDocumentTitle();</span>
<a href="#l2.626"></a><span id="l2.626" class="difflineminus">-    window.openDialog(&quot;chrome://editor/content/EditorSaveAsCharset.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal,resizable=yes&quot;);</span>
<a href="#l2.627"></a><span id="l2.627" class="difflineminus">-</span>
<a href="#l2.628"></a><span id="l2.628" class="difflineminus">-    if (GetDocumentTitle() != oldTitle)</span>
<a href="#l2.629"></a><span id="l2.629" class="difflineplus">+    window.openDialog(</span>
<a href="#l2.630"></a><span id="l2.630" class="difflineplus">+      &quot;chrome://editor/content/EditorSaveAsCharset.xul&quot;,</span>
<a href="#l2.631"></a><span id="l2.631" class="difflineplus">+      &quot;_blank&quot;,</span>
<a href="#l2.632"></a><span id="l2.632" class="difflineplus">+      &quot;chrome,close,titlebar,modal,resizable=yes&quot;</span>
<a href="#l2.633"></a><span id="l2.633" class="difflineplus">+    );</span>
<a href="#l2.634"></a><span id="l2.634" class="difflineplus">+</span>
<a href="#l2.635"></a><span id="l2.635" class="difflineplus">+    if (GetDocumentTitle() != oldTitle) {</span>
<a href="#l2.636"></a><span id="l2.636">       UpdateWindowTitle();</span>
<a href="#l2.637"></a><span id="l2.637" class="difflineplus">+    }</span>
<a href="#l2.638"></a><span id="l2.638"> </span>
<a href="#l2.639"></a><span id="l2.639">     if (window.ok) {</span>
<a href="#l2.640"></a><span id="l2.640">       if (window.exportToText) {</span>
<a href="#l2.641"></a><span id="l2.641">         SaveDocument(true, true, &quot;text/plain&quot;);</span>
<a href="#l2.642"></a><span id="l2.642">       } else {</span>
<a href="#l2.643"></a><span id="l2.643">         var editor = GetCurrentEditor();</span>
<a href="#l2.644"></a><span id="l2.644">         SaveDocument(true, false, editor ? editor.contentsMIMEType : null);</span>
<a href="#l2.645"></a><span id="l2.645">       }</span>
<a href="#l2.646"></a><span id="l2.646" class="difflineat">@@ -621,158 +726,188 @@ var nsPublishCommand = {</span>
<a href="#l2.647"></a><span id="l2.647">     }</span>
<a href="#l2.648"></a><span id="l2.648">     return false;</span>
<a href="#l2.649"></a><span id="l2.649">   },</span>
<a href="#l2.650"></a><span id="l2.650"> };</span>
<a href="#l2.651"></a><span id="l2.651"> /* eslint-enable */</span>
<a href="#l2.652"></a><span id="l2.652"> </span>
<a href="#l2.653"></a><span id="l2.653"> var nsPublishAsCommand = {</span>
<a href="#l2.654"></a><span id="l2.654">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.655"></a><span id="l2.655" class="difflineminus">-    return (IsDocumentEditable());</span>
<a href="#l2.656"></a><span id="l2.656" class="difflineplus">+    return IsDocumentEditable();</span>
<a href="#l2.657"></a><span id="l2.657">   },</span>
<a href="#l2.658"></a><span id="l2.658"> </span>
<a href="#l2.659"></a><span id="l2.659">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.660"></a><span id="l2.660">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.661"></a><span id="l2.661"> </span>
<a href="#l2.662"></a><span id="l2.662">   doCommand(aCommand) {</span>
<a href="#l2.663"></a><span id="l2.663">     if (GetCurrentEditor()) {</span>
<a href="#l2.664"></a><span id="l2.664">       SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l2.665"></a><span id="l2.665"> </span>
<a href="#l2.666"></a><span id="l2.666">       window.ok = false;</span>
<a href="#l2.667"></a><span id="l2.667">       var publishData = {};</span>
<a href="#l2.668"></a><span id="l2.668">       var oldTitle = GetDocumentTitle();</span>
<a href="#l2.669"></a><span id="l2.669" class="difflineminus">-      window.openDialog(&quot;chrome://editor/content/EditorPublish.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l2.670"></a><span id="l2.670" class="difflineminus">-                        &quot;chrome,close,titlebar,modal&quot;, &quot;&quot;, &quot;&quot;, publishData);</span>
<a href="#l2.671"></a><span id="l2.671" class="difflineminus">-      if (GetDocumentTitle() != oldTitle)</span>
<a href="#l2.672"></a><span id="l2.672" class="difflineplus">+      window.openDialog(</span>
<a href="#l2.673"></a><span id="l2.673" class="difflineplus">+        &quot;chrome://editor/content/EditorPublish.xul&quot;,</span>
<a href="#l2.674"></a><span id="l2.674" class="difflineplus">+        &quot;_blank&quot;,</span>
<a href="#l2.675"></a><span id="l2.675" class="difflineplus">+        &quot;chrome,close,titlebar,modal&quot;,</span>
<a href="#l2.676"></a><span id="l2.676" class="difflineplus">+        &quot;&quot;,</span>
<a href="#l2.677"></a><span id="l2.677" class="difflineplus">+        &quot;&quot;,</span>
<a href="#l2.678"></a><span id="l2.678" class="difflineplus">+        publishData</span>
<a href="#l2.679"></a><span id="l2.679" class="difflineplus">+      );</span>
<a href="#l2.680"></a><span id="l2.680" class="difflineplus">+      if (GetDocumentTitle() != oldTitle) {</span>
<a href="#l2.681"></a><span id="l2.681">         UpdateWindowTitle();</span>
<a href="#l2.682"></a><span id="l2.682" class="difflineminus">-</span>
<a href="#l2.683"></a><span id="l2.683" class="difflineminus">-      if (window.ok)</span>
<a href="#l2.684"></a><span id="l2.684" class="difflineplus">+      }</span>
<a href="#l2.685"></a><span id="l2.685" class="difflineplus">+</span>
<a href="#l2.686"></a><span id="l2.686" class="difflineplus">+      if (window.ok) {</span>
<a href="#l2.687"></a><span id="l2.687">         return Publish(publishData);</span>
<a href="#l2.688"></a><span id="l2.688" class="difflineplus">+      }</span>
<a href="#l2.689"></a><span id="l2.689">     }</span>
<a href="#l2.690"></a><span id="l2.690">     return false;</span>
<a href="#l2.691"></a><span id="l2.691">   },</span>
<a href="#l2.692"></a><span id="l2.692"> };</span>
<a href="#l2.693"></a><span id="l2.693"> </span>
<a href="#l2.694"></a><span id="l2.694"> // ------- output utilities   ----- //</span>
<a href="#l2.695"></a><span id="l2.695"> </span>
<a href="#l2.696"></a><span id="l2.696"> // returns a fileExtension string</span>
<a href="#l2.697"></a><span id="l2.697"> function GetExtensionBasedOnMimeType(aMIMEType) {</span>
<a href="#l2.698"></a><span id="l2.698">   try {</span>
<a href="#l2.699"></a><span id="l2.699">     var mimeService = null;</span>
<a href="#l2.700"></a><span id="l2.700" class="difflineminus">-    mimeService = Cc[&quot;@mozilla.org/mime;1&quot;]</span>
<a href="#l2.701"></a><span id="l2.701" class="difflineminus">-                    .getService(Ci.nsIMIMEService);</span>
<a href="#l2.702"></a><span id="l2.702" class="difflineplus">+    mimeService = Cc[&quot;@mozilla.org/mime;1&quot;].getService(Ci.nsIMIMEService);</span>
<a href="#l2.703"></a><span id="l2.703"> </span>
<a href="#l2.704"></a><span id="l2.704">     var fileExtension = mimeService.getPrimaryExtension(aMIMEType, null);</span>
<a href="#l2.705"></a><span id="l2.705"> </span>
<a href="#l2.706"></a><span id="l2.706">     // the MIME service likes to give back &quot;.htm&quot; for text/html files,</span>
<a href="#l2.707"></a><span id="l2.707">     // so do a special-case fix here.</span>
<a href="#l2.708"></a><span id="l2.708" class="difflineminus">-    if (fileExtension == &quot;htm&quot;)</span>
<a href="#l2.709"></a><span id="l2.709" class="difflineplus">+    if (fileExtension == &quot;htm&quot;) {</span>
<a href="#l2.710"></a><span id="l2.710">       fileExtension = &quot;html&quot;;</span>
<a href="#l2.711"></a><span id="l2.711" class="difflineplus">+    }</span>
<a href="#l2.712"></a><span id="l2.712"> </span>
<a href="#l2.713"></a><span id="l2.713">     return fileExtension;</span>
<a href="#l2.714"></a><span id="l2.714">   } catch (e) {}</span>
<a href="#l2.715"></a><span id="l2.715">   return &quot;&quot;;</span>
<a href="#l2.716"></a><span id="l2.716"> }</span>
<a href="#l2.717"></a><span id="l2.717"> </span>
<a href="#l2.718"></a><span id="l2.718"> function GetSuggestedFileName(aDocumentURLString, aMIMEType) {</span>
<a href="#l2.719"></a><span id="l2.719">   var extension = GetExtensionBasedOnMimeType(aMIMEType);</span>
<a href="#l2.720"></a><span id="l2.720" class="difflineminus">-  if (extension)</span>
<a href="#l2.721"></a><span id="l2.721" class="difflineplus">+  if (extension) {</span>
<a href="#l2.722"></a><span id="l2.722">     extension = &quot;.&quot; + extension;</span>
<a href="#l2.723"></a><span id="l2.723" class="difflineplus">+  }</span>
<a href="#l2.724"></a><span id="l2.724"> </span>
<a href="#l2.725"></a><span id="l2.725">   // check for existing file name we can use</span>
<a href="#l2.726"></a><span id="l2.726">   if (aDocumentURLString &amp;&amp; !IsUrlAboutBlank(aDocumentURLString)) {</span>
<a href="#l2.727"></a><span id="l2.727">     try {</span>
<a href="#l2.728"></a><span id="l2.728" class="difflineminus">-      let docURI = Services.io.newURI(aDocumentURLString,</span>
<a href="#l2.729"></a><span id="l2.729" class="difflineminus">-        GetCurrentEditor().documentCharacterSet);</span>
<a href="#l2.730"></a><span id="l2.730" class="difflineplus">+      let docURI = Services.io.newURI(</span>
<a href="#l2.731"></a><span id="l2.731" class="difflineplus">+        aDocumentURLString,</span>
<a href="#l2.732"></a><span id="l2.732" class="difflineplus">+        GetCurrentEditor().documentCharacterSet</span>
<a href="#l2.733"></a><span id="l2.733" class="difflineplus">+      );</span>
<a href="#l2.734"></a><span id="l2.734">       docURI = docURI.QueryInterface(Ci.nsIURL);</span>
<a href="#l2.735"></a><span id="l2.735"> </span>
<a href="#l2.736"></a><span id="l2.736">       // grab the file name</span>
<a href="#l2.737"></a><span id="l2.737">       let url = validateFileName(decodeURIComponent(docURI.fileBaseName));</span>
<a href="#l2.738"></a><span id="l2.738" class="difflineminus">-      if (url)</span>
<a href="#l2.739"></a><span id="l2.739" class="difflineplus">+      if (url) {</span>
<a href="#l2.740"></a><span id="l2.740">         return url + extension;</span>
<a href="#l2.741"></a><span id="l2.741" class="difflineplus">+      }</span>
<a href="#l2.742"></a><span id="l2.742">     } catch (e) {}</span>
<a href="#l2.743"></a><span id="l2.743">   }</span>
<a href="#l2.744"></a><span id="l2.744"> </span>
<a href="#l2.745"></a><span id="l2.745">   // Check if there is a title we can use to generate a valid filename,</span>
<a href="#l2.746"></a><span id="l2.746">   // if we can't, use the default filename.</span>
<a href="#l2.747"></a><span id="l2.747" class="difflineminus">-  var title = validateFileName(GetDocumentTitle()) ||</span>
<a href="#l2.748"></a><span id="l2.748" class="difflineminus">-              GetString(&quot;untitledDefaultFilename&quot;);</span>
<a href="#l2.749"></a><span id="l2.749" class="difflineplus">+  var title =</span>
<a href="#l2.750"></a><span id="l2.750" class="difflineplus">+    validateFileName(GetDocumentTitle()) ||</span>
<a href="#l2.751"></a><span id="l2.751" class="difflineplus">+    GetString(&quot;untitledDefaultFilename&quot;);</span>
<a href="#l2.752"></a><span id="l2.752">   return title + extension;</span>
<a href="#l2.753"></a><span id="l2.753"> }</span>
<a href="#l2.754"></a><span id="l2.754"> </span>
<a href="#l2.755"></a><span id="l2.755"> /**</span>
<a href="#l2.756"></a><span id="l2.756">  * @return {Promise} dialogResult</span>
<a href="#l2.757"></a><span id="l2.757">  */</span>
<a href="#l2.758"></a><span id="l2.758" class="difflineminus">-function PromptForSaveLocation(aDoSaveAsText, aEditorType, aMIMEType, aDocumentURLString) {</span>
<a href="#l2.759"></a><span id="l2.759" class="difflineplus">+function PromptForSaveLocation(</span>
<a href="#l2.760"></a><span id="l2.760" class="difflineplus">+  aDoSaveAsText,</span>
<a href="#l2.761"></a><span id="l2.761" class="difflineplus">+  aEditorType,</span>
<a href="#l2.762"></a><span id="l2.762" class="difflineplus">+  aMIMEType,</span>
<a href="#l2.763"></a><span id="l2.763" class="difflineplus">+  aDocumentURLString</span>
<a href="#l2.764"></a><span id="l2.764" class="difflineplus">+) {</span>
<a href="#l2.765"></a><span id="l2.765">   var dialogResult = {};</span>
<a href="#l2.766"></a><span id="l2.766">   dialogResult.filepickerClick = nsIFilePicker.returnCancel;</span>
<a href="#l2.767"></a><span id="l2.767">   dialogResult.resultingURI = &quot;&quot;;</span>
<a href="#l2.768"></a><span id="l2.768">   dialogResult.resultingLocalFile = null;</span>
<a href="#l2.769"></a><span id="l2.769"> </span>
<a href="#l2.770"></a><span id="l2.770">   var fp = null;</span>
<a href="#l2.771"></a><span id="l2.771">   try {</span>
<a href="#l2.772"></a><span id="l2.772">     fp = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(nsIFilePicker);</span>
<a href="#l2.773"></a><span id="l2.773">   } catch (e) {}</span>
<a href="#l2.774"></a><span id="l2.774" class="difflineminus">-  if (!fp) return dialogResult;</span>
<a href="#l2.775"></a><span id="l2.775" class="difflineplus">+  if (!fp) {</span>
<a href="#l2.776"></a><span id="l2.776" class="difflineplus">+    return dialogResult;</span>
<a href="#l2.777"></a><span id="l2.777" class="difflineplus">+  }</span>
<a href="#l2.778"></a><span id="l2.778"> </span>
<a href="#l2.779"></a><span id="l2.779">   // determine prompt string based on type of saving we'll do</span>
<a href="#l2.780"></a><span id="l2.780">   var promptString;</span>
<a href="#l2.781"></a><span id="l2.781" class="difflineminus">-  if (aDoSaveAsText || aEditorType == &quot;text&quot;)</span>
<a href="#l2.782"></a><span id="l2.782" class="difflineplus">+  if (aDoSaveAsText || aEditorType == &quot;text&quot;) {</span>
<a href="#l2.783"></a><span id="l2.783">     promptString = GetString(&quot;SaveTextAs&quot;);</span>
<a href="#l2.784"></a><span id="l2.784" class="difflineminus">-  else</span>
<a href="#l2.785"></a><span id="l2.785" class="difflineplus">+  } else {</span>
<a href="#l2.786"></a><span id="l2.786">     promptString = GetString(&quot;SaveDocumentAs&quot;);</span>
<a href="#l2.787"></a><span id="l2.787" class="difflineplus">+  }</span>
<a href="#l2.788"></a><span id="l2.788"> </span>
<a href="#l2.789"></a><span id="l2.789">   fp.init(window, promptString, nsIFilePicker.modeSave);</span>
<a href="#l2.790"></a><span id="l2.790"> </span>
<a href="#l2.791"></a><span id="l2.791">   // Set filters according to the type of output</span>
<a href="#l2.792"></a><span id="l2.792" class="difflineminus">-  if (aDoSaveAsText)</span>
<a href="#l2.793"></a><span id="l2.793" class="difflineplus">+  if (aDoSaveAsText) {</span>
<a href="#l2.794"></a><span id="l2.794">     fp.appendFilters(nsIFilePicker.filterText);</span>
<a href="#l2.795"></a><span id="l2.795" class="difflineminus">-  else</span>
<a href="#l2.796"></a><span id="l2.796" class="difflineplus">+  } else {</span>
<a href="#l2.797"></a><span id="l2.797">     fp.appendFilters(nsIFilePicker.filterHTML);</span>
<a href="#l2.798"></a><span id="l2.798" class="difflineplus">+  }</span>
<a href="#l2.799"></a><span id="l2.799">   fp.appendFilters(nsIFilePicker.filterAll);</span>
<a href="#l2.800"></a><span id="l2.800"> </span>
<a href="#l2.801"></a><span id="l2.801">   // now let's actually set the filepicker's suggested filename</span>
<a href="#l2.802"></a><span id="l2.802">   var suggestedFileName = GetSuggestedFileName(aDocumentURLString, aMIMEType);</span>
<a href="#l2.803"></a><span id="l2.803" class="difflineminus">-  if (suggestedFileName)</span>
<a href="#l2.804"></a><span id="l2.804" class="difflineplus">+  if (suggestedFileName) {</span>
<a href="#l2.805"></a><span id="l2.805">     fp.defaultString = suggestedFileName;</span>
<a href="#l2.806"></a><span id="l2.806" class="difflineplus">+  }</span>
<a href="#l2.807"></a><span id="l2.807"> </span>
<a href="#l2.808"></a><span id="l2.808">   // set the file picker's current directory</span>
<a href="#l2.809"></a><span id="l2.809">   // assuming we have information needed (like prior saved location)</span>
<a href="#l2.810"></a><span id="l2.810">   try {</span>
<a href="#l2.811"></a><span id="l2.811">     var fileHandler = GetFileProtocolHandler();</span>
<a href="#l2.812"></a><span id="l2.812"> </span>
<a href="#l2.813"></a><span id="l2.813">     var isLocalFile = true;</span>
<a href="#l2.814"></a><span id="l2.814">     try {</span>
<a href="#l2.815"></a><span id="l2.815" class="difflineminus">-      let docURI = Services.io.newURI(aDocumentURLString, GetCurrentEditor().documentCharacterSet);</span>
<a href="#l2.816"></a><span id="l2.816" class="difflineplus">+      let docURI = Services.io.newURI(</span>
<a href="#l2.817"></a><span id="l2.817" class="difflineplus">+        aDocumentURLString,</span>
<a href="#l2.818"></a><span id="l2.818" class="difflineplus">+        GetCurrentEditor().documentCharacterSet</span>
<a href="#l2.819"></a><span id="l2.819" class="difflineplus">+      );</span>
<a href="#l2.820"></a><span id="l2.820">       isLocalFile = docURI.schemeIs(&quot;file&quot;);</span>
<a href="#l2.821"></a><span id="l2.821">     } catch (e) {}</span>
<a href="#l2.822"></a><span id="l2.822"> </span>
<a href="#l2.823"></a><span id="l2.823">     var parentLocation = null;</span>
<a href="#l2.824"></a><span id="l2.824">     if (isLocalFile) {</span>
<a href="#l2.825"></a><span id="l2.825">       var fileLocation = fileHandler.getFileFromURLSpec(aDocumentURLString); // this asserts if url is not local</span>
<a href="#l2.826"></a><span id="l2.826">       parentLocation = fileLocation.parent;</span>
<a href="#l2.827"></a><span id="l2.827">     }</span>
<a href="#l2.828"></a><span id="l2.828">     if (parentLocation) {</span>
<a href="#l2.829"></a><span id="l2.829">       // Save current filepicker's default location</span>
<a href="#l2.830"></a><span id="l2.830" class="difflineminus">-      if (&quot;gFilePickerDirectory&quot; in window)</span>
<a href="#l2.831"></a><span id="l2.831" class="difflineplus">+      if (&quot;gFilePickerDirectory&quot; in window) {</span>
<a href="#l2.832"></a><span id="l2.832">         gFilePickerDirectory = fp.displayDirectory;</span>
<a href="#l2.833"></a><span id="l2.833" class="difflineplus">+      }</span>
<a href="#l2.834"></a><span id="l2.834"> </span>
<a href="#l2.835"></a><span id="l2.835">       fp.displayDirectory = parentLocation;</span>
<a href="#l2.836"></a><span id="l2.836">     } else {</span>
<a href="#l2.837"></a><span id="l2.837">       // Initialize to the last-used directory for the particular type (saved in prefs)</span>
<a href="#l2.838"></a><span id="l2.838">       SetFilePickerDirectory(fp, aEditorType);</span>
<a href="#l2.839"></a><span id="l2.839">     }</span>
<a href="#l2.840"></a><span id="l2.840">   } catch (e) {}</span>
<a href="#l2.841"></a><span id="l2.841"> </span>
<a href="#l2.842"></a><span id="l2.842">   return new Promise(resolve =&gt; {</span>
<a href="#l2.843"></a><span id="l2.843">     fp.open(rv =&gt; {</span>
<a href="#l2.844"></a><span id="l2.844">       dialogResult.filepickerClick = rv;</span>
<a href="#l2.845"></a><span id="l2.845" class="difflineminus">-      if (rv != nsIFilePicker.returnCancel &amp;&amp; fp.file) { // Allow OK and replace.</span>
<a href="#l2.846"></a><span id="l2.846" class="difflineplus">+      if (rv != nsIFilePicker.returnCancel &amp;&amp; fp.file) {</span>
<a href="#l2.847"></a><span id="l2.847" class="difflineplus">+        // Allow OK and replace.</span>
<a href="#l2.848"></a><span id="l2.848">         // reset urlstring to new save location</span>
<a href="#l2.849"></a><span id="l2.849" class="difflineminus">-        dialogResult.resultingURIString = fileHandler.getURLSpecFromFile(fp.file);</span>
<a href="#l2.850"></a><span id="l2.850" class="difflineplus">+        dialogResult.resultingURIString = fileHandler.getURLSpecFromFile(</span>
<a href="#l2.851"></a><span id="l2.851" class="difflineplus">+          fp.file</span>
<a href="#l2.852"></a><span id="l2.852" class="difflineplus">+        );</span>
<a href="#l2.853"></a><span id="l2.853">         dialogResult.resultingLocalFile = fp.file;</span>
<a href="#l2.854"></a><span id="l2.854">         SaveFilePickerDirectory(fp, aEditorType);</span>
<a href="#l2.855"></a><span id="l2.855">         resolve(dialogResult);</span>
<a href="#l2.856"></a><span id="l2.856">       } else if (&quot;gFilePickerDirectory&quot; in window &amp;&amp; gFilePickerDirectory) {</span>
<a href="#l2.857"></a><span id="l2.857">         fp.displayDirectory = gFilePickerDirectory;</span>
<a href="#l2.858"></a><span id="l2.858">         resolve(null);</span>
<a href="#l2.859"></a><span id="l2.859">       }</span>
<a href="#l2.860"></a><span id="l2.860">     });</span>
<a href="#l2.861"></a><span id="l2.861" class="difflineat">@@ -781,42 +916,57 @@ function PromptForSaveLocation(aDoSaveAs</span>
<a href="#l2.862"></a><span id="l2.862"> </span>
<a href="#l2.863"></a><span id="l2.863"> /**</span>
<a href="#l2.864"></a><span id="l2.864">  * If needed, prompt for document title and set the document title to the</span>
<a href="#l2.865"></a><span id="l2.865">  * preferred value.</span>
<a href="#l2.866"></a><span id="l2.866">  * @return true if the title was set up successfully;</span>
<a href="#l2.867"></a><span id="l2.867">  *         false if the user cancelled the title prompt</span>
<a href="#l2.868"></a><span id="l2.868">  */</span>
<a href="#l2.869"></a><span id="l2.869"> function PromptAndSetTitleIfNone() {</span>
<a href="#l2.870"></a><span id="l2.870" class="difflineminus">-  if (GetDocumentTitle()) // we have a title; no need to prompt!</span>
<a href="#l2.871"></a><span id="l2.871" class="difflineplus">+  if (GetDocumentTitle()) {</span>
<a href="#l2.872"></a><span id="l2.872" class="difflineplus">+    // we have a title; no need to prompt!</span>
<a href="#l2.873"></a><span id="l2.873">     return true;</span>
<a href="#l2.874"></a><span id="l2.874" class="difflineminus">-</span>
<a href="#l2.875"></a><span id="l2.875" class="difflineminus">-  let result = {value: null};</span>
<a href="#l2.876"></a><span id="l2.876" class="difflineplus">+  }</span>
<a href="#l2.877"></a><span id="l2.877" class="difflineplus">+</span>
<a href="#l2.878"></a><span id="l2.878" class="difflineplus">+  let result = { value: null };</span>
<a href="#l2.879"></a><span id="l2.879">   let captionStr = GetString(&quot;DocumentTitle&quot;);</span>
<a href="#l2.880"></a><span id="l2.880">   let msgStr = GetString(&quot;NeedDocTitle&quot;) + &quot;\n&quot; + GetString(&quot;DocTitleHelp&quot;);</span>
<a href="#l2.881"></a><span id="l2.881" class="difflineminus">-  let confirmed = Services.prompt.prompt(window, captionStr, msgStr, result, null, {value: 0});</span>
<a href="#l2.882"></a><span id="l2.882" class="difflineminus">-  if (confirmed)</span>
<a href="#l2.883"></a><span id="l2.883" class="difflineplus">+  let confirmed = Services.prompt.prompt(</span>
<a href="#l2.884"></a><span id="l2.884" class="difflineplus">+    window,</span>
<a href="#l2.885"></a><span id="l2.885" class="difflineplus">+    captionStr,</span>
<a href="#l2.886"></a><span id="l2.886" class="difflineplus">+    msgStr,</span>
<a href="#l2.887"></a><span id="l2.887" class="difflineplus">+    result,</span>
<a href="#l2.888"></a><span id="l2.888" class="difflineplus">+    null,</span>
<a href="#l2.889"></a><span id="l2.889" class="difflineplus">+    { value: 0 }</span>
<a href="#l2.890"></a><span id="l2.890" class="difflineplus">+  );</span>
<a href="#l2.891"></a><span id="l2.891" class="difflineplus">+  if (confirmed) {</span>
<a href="#l2.892"></a><span id="l2.892">     SetDocumentTitle(TrimString(result.value));</span>
<a href="#l2.893"></a><span id="l2.893" class="difflineplus">+  }</span>
<a href="#l2.894"></a><span id="l2.894"> </span>
<a href="#l2.895"></a><span id="l2.895">   return confirmed;</span>
<a href="#l2.896"></a><span id="l2.896"> }</span>
<a href="#l2.897"></a><span id="l2.897"> </span>
<a href="#l2.898"></a><span id="l2.898"> var gPersistObj;</span>
<a href="#l2.899"></a><span id="l2.899"> </span>
<a href="#l2.900"></a><span id="l2.900"> // Don't forget to do these things after calling OutputFileWithPersistAPI:</span>
<a href="#l2.901"></a><span id="l2.901"> // we need to update the uri before notifying listeners</span>
<a href="#l2.902"></a><span id="l2.902"> //    if (doUpdateURI)</span>
<a href="#l2.903"></a><span id="l2.903"> //      SetDocumentURI(docURI);</span>
<a href="#l2.904"></a><span id="l2.904"> //    UpdateWindowTitle();</span>
<a href="#l2.905"></a><span id="l2.905"> //    if (!aSaveCopy)</span>
<a href="#l2.906"></a><span id="l2.906"> //      editor.resetModificationCount();</span>
<a href="#l2.907"></a><span id="l2.907" class="difflineminus">-      // this should cause notification to listeners that document has changed</span>
<a href="#l2.908"></a><span id="l2.908" class="difflineplus">+// this should cause notification to listeners that document has changed</span>
<a href="#l2.909"></a><span id="l2.909"> </span>
<a href="#l2.910"></a><span id="l2.910"> const webPersist = Ci.nsIWebBrowserPersist;</span>
<a href="#l2.911"></a><span id="l2.911" class="difflineminus">-function OutputFileWithPersistAPI(editorDoc, aDestinationLocation, aRelatedFilesParentDir, aMimeType) {</span>
<a href="#l2.912"></a><span id="l2.912" class="difflineplus">+function OutputFileWithPersistAPI(</span>
<a href="#l2.913"></a><span id="l2.913" class="difflineplus">+  editorDoc,</span>
<a href="#l2.914"></a><span id="l2.914" class="difflineplus">+  aDestinationLocation,</span>
<a href="#l2.915"></a><span id="l2.915" class="difflineplus">+  aRelatedFilesParentDir,</span>
<a href="#l2.916"></a><span id="l2.916" class="difflineplus">+  aMimeType</span>
<a href="#l2.917"></a><span id="l2.917" class="difflineplus">+) {</span>
<a href="#l2.918"></a><span id="l2.918">   gPersistObj = null;</span>
<a href="#l2.919"></a><span id="l2.919">   var editor = GetCurrentEditor();</span>
<a href="#l2.920"></a><span id="l2.920">   try {</span>
<a href="#l2.921"></a><span id="l2.921">     editor.forceCompositionEnd();</span>
<a href="#l2.922"></a><span id="l2.922">   } catch (e) {}</span>
<a href="#l2.923"></a><span id="l2.923"> </span>
<a href="#l2.924"></a><span id="l2.924">   var isLocalFile = false;</span>
<a href="#l2.925"></a><span id="l2.925">   try {</span>
<a href="#l2.926"></a><span id="l2.926" class="difflineat">@@ -826,82 +976,106 @@ function OutputFileWithPersistAPI(editor</span>
<a href="#l2.927"></a><span id="l2.927">     try {</span>
<a href="#l2.928"></a><span id="l2.928">       var tmp = aDestinationLocation.QueryInterface(Ci.nsIURI);</span>
<a href="#l2.929"></a><span id="l2.929">       isLocalFile = tmp.schemeIs(&quot;file&quot;);</span>
<a href="#l2.930"></a><span id="l2.930">     } catch (e) {}</span>
<a href="#l2.931"></a><span id="l2.931">   }</span>
<a href="#l2.932"></a><span id="l2.932"> </span>
<a href="#l2.933"></a><span id="l2.933">   try {</span>
<a href="#l2.934"></a><span id="l2.934">     // we should supply a parent directory if/when we turn on functionality to save related documents</span>
<a href="#l2.935"></a><span id="l2.935" class="difflineminus">-    var persistObj = Cc[&quot;@mozilla.org/embedding/browser/nsWebBrowserPersist;1&quot;].createInstance(webPersist);</span>
<a href="#l2.936"></a><span id="l2.936" class="difflineplus">+    var persistObj = Cc[</span>
<a href="#l2.937"></a><span id="l2.937" class="difflineplus">+      &quot;@mozilla.org/embedding/browser/nsWebBrowserPersist;1&quot;</span>
<a href="#l2.938"></a><span id="l2.938" class="difflineplus">+    ].createInstance(webPersist);</span>
<a href="#l2.939"></a><span id="l2.939">     persistObj.progressListener = gEditorOutputProgressListener;</span>
<a href="#l2.940"></a><span id="l2.940"> </span>
<a href="#l2.941"></a><span id="l2.941">     var wrapColumn = GetWrapColumn();</span>
<a href="#l2.942"></a><span id="l2.942">     var outputFlags = GetOutputFlags(aMimeType, wrapColumn);</span>
<a href="#l2.943"></a><span id="l2.943"> </span>
<a href="#l2.944"></a><span id="l2.944">     // for 4.x parity as well as improving readability of file locally on server</span>
<a href="#l2.945"></a><span id="l2.945">     // this will always send crlf for upload (http/ftp)</span>
<a href="#l2.946"></a><span id="l2.946" class="difflineminus">-    if (!isLocalFile) { // if we aren't saving locally then send both cr and lf</span>
<a href="#l2.947"></a><span id="l2.947" class="difflineminus">-      outputFlags |= webPersist.ENCODE_FLAGS_CR_LINEBREAKS | webPersist.ENCODE_FLAGS_LF_LINEBREAKS;</span>
<a href="#l2.948"></a><span id="l2.948" class="difflineplus">+    if (!isLocalFile) {</span>
<a href="#l2.949"></a><span id="l2.949" class="difflineplus">+      // if we aren't saving locally then send both cr and lf</span>
<a href="#l2.950"></a><span id="l2.950" class="difflineplus">+      outputFlags |=</span>
<a href="#l2.951"></a><span id="l2.951" class="difflineplus">+        webPersist.ENCODE_FLAGS_CR_LINEBREAKS |</span>
<a href="#l2.952"></a><span id="l2.952" class="difflineplus">+        webPersist.ENCODE_FLAGS_LF_LINEBREAKS;</span>
<a href="#l2.953"></a><span id="l2.953"> </span>
<a href="#l2.954"></a><span id="l2.954">       // we want to serialize the output for all remote publishing</span>
<a href="#l2.955"></a><span id="l2.955">       // some servers can handle only one connection at a time</span>
<a href="#l2.956"></a><span id="l2.956">       // some day perhaps we can make this user-configurable per site?</span>
<a href="#l2.957"></a><span id="l2.957" class="difflineminus">-      persistObj.persistFlags = persistObj.persistFlags | webPersist.PERSIST_FLAGS_SERIALIZE_OUTPUT;</span>
<a href="#l2.958"></a><span id="l2.958" class="difflineplus">+      persistObj.persistFlags =</span>
<a href="#l2.959"></a><span id="l2.959" class="difflineplus">+        persistObj.persistFlags | webPersist.PERSIST_FLAGS_SERIALIZE_OUTPUT;</span>
<a href="#l2.960"></a><span id="l2.960">     }</span>
<a href="#l2.961"></a><span id="l2.961"> </span>
<a href="#l2.962"></a><span id="l2.962">     // note: we always want to set the replace existing files flag since we have</span>
<a href="#l2.963"></a><span id="l2.963">     // already given user the chance to not replace an existing file (file picker)</span>
<a href="#l2.964"></a><span id="l2.964">     // or the user picked an option where the file is implicitly being replaced (save)</span>
<a href="#l2.965"></a><span id="l2.965" class="difflineminus">-    persistObj.persistFlags = persistObj.persistFlags</span>
<a href="#l2.966"></a><span id="l2.966" class="difflineminus">-                            | webPersist.PERSIST_FLAGS_NO_BASE_TAG_MODIFICATIONS</span>
<a href="#l2.967"></a><span id="l2.967" class="difflineminus">-                            | webPersist.PERSIST_FLAGS_REPLACE_EXISTING_FILES</span>
<a href="#l2.968"></a><span id="l2.968" class="difflineminus">-                            | webPersist.PERSIST_FLAGS_DONT_FIXUP_LINKS</span>
<a href="#l2.969"></a><span id="l2.969" class="difflineminus">-                            | webPersist.PERSIST_FLAGS_DONT_CHANGE_FILENAMES</span>
<a href="#l2.970"></a><span id="l2.970" class="difflineminus">-                            | webPersist.PERSIST_FLAGS_FIXUP_ORIGINAL_DOM;</span>
<a href="#l2.971"></a><span id="l2.971" class="difflineminus">-    persistObj.saveDocument(editorDoc, aDestinationLocation, aRelatedFilesParentDir,</span>
<a href="#l2.972"></a><span id="l2.972" class="difflineminus">-                            aMimeType, outputFlags, wrapColumn);</span>
<a href="#l2.973"></a><span id="l2.973" class="difflineplus">+    persistObj.persistFlags =</span>
<a href="#l2.974"></a><span id="l2.974" class="difflineplus">+      persistObj.persistFlags |</span>
<a href="#l2.975"></a><span id="l2.975" class="difflineplus">+      webPersist.PERSIST_FLAGS_NO_BASE_TAG_MODIFICATIONS |</span>
<a href="#l2.976"></a><span id="l2.976" class="difflineplus">+      webPersist.PERSIST_FLAGS_REPLACE_EXISTING_FILES |</span>
<a href="#l2.977"></a><span id="l2.977" class="difflineplus">+      webPersist.PERSIST_FLAGS_DONT_FIXUP_LINKS |</span>
<a href="#l2.978"></a><span id="l2.978" class="difflineplus">+      webPersist.PERSIST_FLAGS_DONT_CHANGE_FILENAMES |</span>
<a href="#l2.979"></a><span id="l2.979" class="difflineplus">+      webPersist.PERSIST_FLAGS_FIXUP_ORIGINAL_DOM;</span>
<a href="#l2.980"></a><span id="l2.980" class="difflineplus">+    persistObj.saveDocument(</span>
<a href="#l2.981"></a><span id="l2.981" class="difflineplus">+      editorDoc,</span>
<a href="#l2.982"></a><span id="l2.982" class="difflineplus">+      aDestinationLocation,</span>
<a href="#l2.983"></a><span id="l2.983" class="difflineplus">+      aRelatedFilesParentDir,</span>
<a href="#l2.984"></a><span id="l2.984" class="difflineplus">+      aMimeType,</span>
<a href="#l2.985"></a><span id="l2.985" class="difflineplus">+      outputFlags,</span>
<a href="#l2.986"></a><span id="l2.986" class="difflineplus">+      wrapColumn</span>
<a href="#l2.987"></a><span id="l2.987" class="difflineplus">+    );</span>
<a href="#l2.988"></a><span id="l2.988">     gPersistObj = persistObj;</span>
<a href="#l2.989"></a><span id="l2.989">   } catch (e) {</span>
<a href="#l2.990"></a><span id="l2.990">     dump(&quot;caught an error, bail\n&quot;);</span>
<a href="#l2.991"></a><span id="l2.991">     return false;</span>
<a href="#l2.992"></a><span id="l2.992">   }</span>
<a href="#l2.993"></a><span id="l2.993"> </span>
<a href="#l2.994"></a><span id="l2.994">   return true;</span>
<a href="#l2.995"></a><span id="l2.995"> }</span>
<a href="#l2.996"></a><span id="l2.996"> </span>
<a href="#l2.997"></a><span id="l2.997"> // returns output flags based on mimetype, wrapCol and prefs</span>
<a href="#l2.998"></a><span id="l2.998"> function GetOutputFlags(aMimeType, aWrapColumn) {</span>
<a href="#l2.999"></a><span id="l2.999">   var outputFlags = 0;</span>
<a href="#l2.1000"></a><span id="l2.1000">   var editor = GetCurrentEditor();</span>
<a href="#l2.1001"></a><span id="l2.1001" class="difflineminus">-  var outputEntity = (editor &amp;&amp; editor.documentCharacterSet == &quot;ISO-8859-1&quot;)</span>
<a href="#l2.1002"></a><span id="l2.1002" class="difflineminus">-    ? webPersist.ENCODE_FLAGS_ENCODE_LATIN1_ENTITIES</span>
<a href="#l2.1003"></a><span id="l2.1003" class="difflineminus">-    : webPersist.ENCODE_FLAGS_ENCODE_BASIC_ENTITIES;</span>
<a href="#l2.1004"></a><span id="l2.1004" class="difflineplus">+  var outputEntity =</span>
<a href="#l2.1005"></a><span id="l2.1005" class="difflineplus">+    editor &amp;&amp; editor.documentCharacterSet == &quot;ISO-8859-1&quot;</span>
<a href="#l2.1006"></a><span id="l2.1006" class="difflineplus">+      ? webPersist.ENCODE_FLAGS_ENCODE_LATIN1_ENTITIES</span>
<a href="#l2.1007"></a><span id="l2.1007" class="difflineplus">+      : webPersist.ENCODE_FLAGS_ENCODE_BASIC_ENTITIES;</span>
<a href="#l2.1008"></a><span id="l2.1008">   if (aMimeType == &quot;text/plain&quot;) {</span>
<a href="#l2.1009"></a><span id="l2.1009">     // When saving in &quot;text/plain&quot; format, always do formatting</span>
<a href="#l2.1010"></a><span id="l2.1010">     outputFlags |= webPersist.ENCODE_FLAGS_FORMATTED;</span>
<a href="#l2.1011"></a><span id="l2.1011">   } else {</span>
<a href="#l2.1012"></a><span id="l2.1012">     // Should we prettyprint? Check the pref</span>
<a href="#l2.1013"></a><span id="l2.1013" class="difflineminus">-    if (Services.prefs.getBoolPref(&quot;editor.prettyprint&quot;))</span>
<a href="#l2.1014"></a><span id="l2.1014" class="difflineplus">+    if (Services.prefs.getBoolPref(&quot;editor.prettyprint&quot;)) {</span>
<a href="#l2.1015"></a><span id="l2.1015">       outputFlags |= webPersist.ENCODE_FLAGS_FORMATTED;</span>
<a href="#l2.1016"></a><span id="l2.1016" class="difflineplus">+    }</span>
<a href="#l2.1017"></a><span id="l2.1017"> </span>
<a href="#l2.1018"></a><span id="l2.1018">     try {</span>
<a href="#l2.1019"></a><span id="l2.1019">       // How much entity names should we output? Check the pref</span>
<a href="#l2.1020"></a><span id="l2.1020">       switch (Services.prefs.getCharPref(&quot;editor.encode_entity&quot;)) {</span>
<a href="#l2.1021"></a><span id="l2.1021" class="difflineminus">-        case &quot;basic&quot; : outputEntity = webPersist.ENCODE_FLAGS_ENCODE_BASIC_ENTITIES; break;</span>
<a href="#l2.1022"></a><span id="l2.1022" class="difflineminus">-        case &quot;latin1&quot; : outputEntity = webPersist.ENCODE_FLAGS_ENCODE_LATIN1_ENTITIES; break;</span>
<a href="#l2.1023"></a><span id="l2.1023" class="difflineminus">-        case &quot;html&quot; : outputEntity = webPersist.ENCODE_FLAGS_ENCODE_HTML_ENTITIES; break;</span>
<a href="#l2.1024"></a><span id="l2.1024" class="difflineminus">-        case &quot;none&quot; : outputEntity = 0; break;</span>
<a href="#l2.1025"></a><span id="l2.1025" class="difflineplus">+        case &quot;basic&quot;:</span>
<a href="#l2.1026"></a><span id="l2.1026" class="difflineplus">+          outputEntity = webPersist.ENCODE_FLAGS_ENCODE_BASIC_ENTITIES;</span>
<a href="#l2.1027"></a><span id="l2.1027" class="difflineplus">+          break;</span>
<a href="#l2.1028"></a><span id="l2.1028" class="difflineplus">+        case &quot;latin1&quot;:</span>
<a href="#l2.1029"></a><span id="l2.1029" class="difflineplus">+          outputEntity = webPersist.ENCODE_FLAGS_ENCODE_LATIN1_ENTITIES;</span>
<a href="#l2.1030"></a><span id="l2.1030" class="difflineplus">+          break;</span>
<a href="#l2.1031"></a><span id="l2.1031" class="difflineplus">+        case &quot;html&quot;:</span>
<a href="#l2.1032"></a><span id="l2.1032" class="difflineplus">+          outputEntity = webPersist.ENCODE_FLAGS_ENCODE_HTML_ENTITIES;</span>
<a href="#l2.1033"></a><span id="l2.1033" class="difflineplus">+          break;</span>
<a href="#l2.1034"></a><span id="l2.1034" class="difflineplus">+        case &quot;none&quot;:</span>
<a href="#l2.1035"></a><span id="l2.1035" class="difflineplus">+          outputEntity = 0;</span>
<a href="#l2.1036"></a><span id="l2.1036" class="difflineplus">+          break;</span>
<a href="#l2.1037"></a><span id="l2.1037">       }</span>
<a href="#l2.1038"></a><span id="l2.1038">     } catch (e) {}</span>
<a href="#l2.1039"></a><span id="l2.1039">   }</span>
<a href="#l2.1040"></a><span id="l2.1040">   outputFlags |= outputEntity;</span>
<a href="#l2.1041"></a><span id="l2.1041"> </span>
<a href="#l2.1042"></a><span id="l2.1042" class="difflineminus">-  if (aWrapColumn &gt; 0)</span>
<a href="#l2.1043"></a><span id="l2.1043" class="difflineplus">+  if (aWrapColumn &gt; 0) {</span>
<a href="#l2.1044"></a><span id="l2.1044">     outputFlags |= webPersist.ENCODE_FLAGS_WRAP;</span>
<a href="#l2.1045"></a><span id="l2.1045" class="difflineplus">+  }</span>
<a href="#l2.1046"></a><span id="l2.1046"> </span>
<a href="#l2.1047"></a><span id="l2.1047">   return outputFlags;</span>
<a href="#l2.1048"></a><span id="l2.1048"> }</span>
<a href="#l2.1049"></a><span id="l2.1049"> </span>
<a href="#l2.1050"></a><span id="l2.1050"> // returns number of column where to wrap</span>
<a href="#l2.1051"></a><span id="l2.1051"> const nsIWebBrowserPersist = Ci.nsIWebBrowserPersist;</span>
<a href="#l2.1052"></a><span id="l2.1052"> function GetWrapColumn() {</span>
<a href="#l2.1053"></a><span id="l2.1053">   try {</span>
<a href="#l2.1054"></a><span id="l2.1054" class="difflineat">@@ -1294,132 +1468,169 @@ var gEditorOutputProgressListener = {</span>
<a href="#l2.1055"></a><span id="l2.1055">     return ret;</span>
<a href="#l2.1056"></a><span id="l2.1056">   },</span>
<a href="#l2.1057"></a><span id="l2.1057"> };</span>
<a href="#l2.1058"></a><span id="l2.1058"> /* eslint-enable */</span>
<a href="#l2.1059"></a><span id="l2.1059"> </span>
<a href="#l2.1060"></a><span id="l2.1060"> function PromptUsernameAndPassword(dlgTitle, text, savePW, userObj, pwObj) {</span>
<a href="#l2.1061"></a><span id="l2.1061">   // HTTP prompts us twice even if user Cancels from 1st attempt!</span>
<a href="#l2.1062"></a><span id="l2.1062">   // So never put up dialog if there's no publish data</span>
<a href="#l2.1063"></a><span id="l2.1063" class="difflineminus">-  if (!gPublishData)</span>
<a href="#l2.1064"></a><span id="l2.1064" class="difflineplus">+  if (!gPublishData) {</span>
<a href="#l2.1065"></a><span id="l2.1065">     return false;</span>
<a href="#l2.1066"></a><span id="l2.1066" class="difflineplus">+  }</span>
<a href="#l2.1067"></a><span id="l2.1067"> </span>
<a href="#l2.1068"></a><span id="l2.1068">   var ret = false;</span>
<a href="#l2.1069"></a><span id="l2.1069">   try {</span>
<a href="#l2.1070"></a><span id="l2.1070" class="difflineminus">-    var savePWObj = {value: savePW};</span>
<a href="#l2.1071"></a><span id="l2.1071" class="difflineplus">+    var savePWObj = { value: savePW };</span>
<a href="#l2.1072"></a><span id="l2.1072"> </span>
<a href="#l2.1073"></a><span id="l2.1073">     // Initialize with user's previous preference for this site</span>
<a href="#l2.1074"></a><span id="l2.1074">     if (gPublishData) {</span>
<a href="#l2.1075"></a><span id="l2.1075">       // HTTP put uses this dialog if either username or password is bad,</span>
<a href="#l2.1076"></a><span id="l2.1076">       //   so prefill username input field with the previous value for modification</span>
<a href="#l2.1077"></a><span id="l2.1077">       savePWObj.value = gPublishData.savePassword;</span>
<a href="#l2.1078"></a><span id="l2.1078" class="difflineminus">-      if (!userObj.value)</span>
<a href="#l2.1079"></a><span id="l2.1079" class="difflineplus">+      if (!userObj.value) {</span>
<a href="#l2.1080"></a><span id="l2.1080">         userObj.value = gPublishData.username;</span>
<a href="#l2.1081"></a><span id="l2.1081" class="difflineplus">+      }</span>
<a href="#l2.1082"></a><span id="l2.1082">     }</span>
<a href="#l2.1083"></a><span id="l2.1083"> </span>
<a href="#l2.1084"></a><span id="l2.1084" class="difflineminus">-    ret = Services.prompt.promptUsernameAndPassword(gProgressDialog ? gProgressDialog : window,</span>
<a href="#l2.1085"></a><span id="l2.1085" class="difflineminus">-                                                    dlgTitle, text, userObj, pwObj,</span>
<a href="#l2.1086"></a><span id="l2.1086" class="difflineminus">-                                                    GetString(&quot;SavePassword&quot;), savePWObj);</span>
<a href="#l2.1087"></a><span id="l2.1087" class="difflineminus">-    if (ret &amp;&amp; gPublishData)</span>
<a href="#l2.1088"></a><span id="l2.1088" class="difflineminus">-      UpdateUsernamePasswordFromPrompt(gPublishData, userObj.value, pwObj.value, savePWObj.value);</span>
<a href="#l2.1089"></a><span id="l2.1089" class="difflineplus">+    ret = Services.prompt.promptUsernameAndPassword(</span>
<a href="#l2.1090"></a><span id="l2.1090" class="difflineplus">+      gProgressDialog ? gProgressDialog : window,</span>
<a href="#l2.1091"></a><span id="l2.1091" class="difflineplus">+      dlgTitle,</span>
<a href="#l2.1092"></a><span id="l2.1092" class="difflineplus">+      text,</span>
<a href="#l2.1093"></a><span id="l2.1093" class="difflineplus">+      userObj,</span>
<a href="#l2.1094"></a><span id="l2.1094" class="difflineplus">+      pwObj,</span>
<a href="#l2.1095"></a><span id="l2.1095" class="difflineplus">+      GetString(&quot;SavePassword&quot;),</span>
<a href="#l2.1096"></a><span id="l2.1096" class="difflineplus">+      savePWObj</span>
<a href="#l2.1097"></a><span id="l2.1097" class="difflineplus">+    );</span>
<a href="#l2.1098"></a><span id="l2.1098" class="difflineplus">+    if (ret &amp;&amp; gPublishData) {</span>
<a href="#l2.1099"></a><span id="l2.1099" class="difflineplus">+      UpdateUsernamePasswordFromPrompt(</span>
<a href="#l2.1100"></a><span id="l2.1100" class="difflineplus">+        gPublishData,</span>
<a href="#l2.1101"></a><span id="l2.1101" class="difflineplus">+        userObj.value,</span>
<a href="#l2.1102"></a><span id="l2.1102" class="difflineplus">+        pwObj.value,</span>
<a href="#l2.1103"></a><span id="l2.1103" class="difflineplus">+        savePWObj.value</span>
<a href="#l2.1104"></a><span id="l2.1104" class="difflineplus">+      );</span>
<a href="#l2.1105"></a><span id="l2.1105" class="difflineplus">+    }</span>
<a href="#l2.1106"></a><span id="l2.1106">   } catch (e) {}</span>
<a href="#l2.1107"></a><span id="l2.1107"> </span>
<a href="#l2.1108"></a><span id="l2.1108">   return ret;</span>
<a href="#l2.1109"></a><span id="l2.1109"> }</span>
<a href="#l2.1110"></a><span id="l2.1110"> </span>
<a href="#l2.1111"></a><span id="l2.1111"> /* eslint-disable complexity */</span>
<a href="#l2.1112"></a><span id="l2.1112"> function DumpDebugStatus(aStatus) {</span>
<a href="#l2.1113"></a><span id="l2.1113">   // see nsError.h and netCore.h and ftpCore.h</span>
<a href="#l2.1114"></a><span id="l2.1114"> </span>
<a href="#l2.1115"></a><span id="l2.1115" class="difflineminus">-  if (aStatus == kErrorBindingAborted)</span>
<a href="#l2.1116"></a><span id="l2.1116" class="difflineplus">+  if (aStatus == kErrorBindingAborted) {</span>
<a href="#l2.1117"></a><span id="l2.1117">     dump(&quot;***** status is NS_BINDING_ABORTED\n&quot;);</span>
<a href="#l2.1118"></a><span id="l2.1118" class="difflineminus">-  else if (aStatus == kErrorBindingRedirected)</span>
<a href="#l2.1119"></a><span id="l2.1119" class="difflineplus">+  } else if (aStatus == kErrorBindingRedirected) {</span>
<a href="#l2.1120"></a><span id="l2.1120">     dump(&quot;***** status is NS_BINDING_REDIRECTED\n&quot;);</span>
<a href="#l2.1121"></a><span id="l2.1121" class="difflineminus">-  else if (aStatus == 2152398859) // in netCore.h 11</span>
<a href="#l2.1122"></a><span id="l2.1122" class="difflineplus">+  } else if (aStatus == 2152398859) {</span>
<a href="#l2.1123"></a><span id="l2.1123" class="difflineplus">+    // in netCore.h 11</span>
<a href="#l2.1124"></a><span id="l2.1124">     dump(&quot;***** status is ALREADY_CONNECTED\n&quot;);</span>
<a href="#l2.1125"></a><span id="l2.1125" class="difflineminus">-  else if (aStatus == 2152398860) // in netCore.h 12</span>
<a href="#l2.1126"></a><span id="l2.1126" class="difflineplus">+  } else if (aStatus == 2152398860) {</span>
<a href="#l2.1127"></a><span id="l2.1127" class="difflineplus">+    // in netCore.h 12</span>
<a href="#l2.1128"></a><span id="l2.1128">     dump(&quot;***** status is NOT_CONNECTED\n&quot;);</span>
<a href="#l2.1129"></a><span id="l2.1129" class="difflineminus">-  else if (aStatus == 2152398861) //  in nsISocketTransportService.idl 13</span>
<a href="#l2.1130"></a><span id="l2.1130" class="difflineplus">+  } else if (aStatus == 2152398861) {</span>
<a href="#l2.1131"></a><span id="l2.1131" class="difflineplus">+    //  in nsISocketTransportService.idl 13</span>
<a href="#l2.1132"></a><span id="l2.1132">     dump(&quot;***** status is CONNECTION_REFUSED\n&quot;);</span>
<a href="#l2.1133"></a><span id="l2.1133" class="difflineminus">-  else if (aStatus == 2152398862) // in nsISocketTransportService.idl 14</span>
<a href="#l2.1134"></a><span id="l2.1134" class="difflineplus">+  } else if (aStatus == 2152398862) {</span>
<a href="#l2.1135"></a><span id="l2.1135" class="difflineplus">+    // in nsISocketTransportService.idl 14</span>
<a href="#l2.1136"></a><span id="l2.1136">     dump(&quot;***** status is NET_TIMEOUT\n&quot;);</span>
<a href="#l2.1137"></a><span id="l2.1137" class="difflineminus">-  else if (aStatus == 2152398863) // in netCore.h 15</span>
<a href="#l2.1138"></a><span id="l2.1138" class="difflineplus">+  } else if (aStatus == 2152398863) {</span>
<a href="#l2.1139"></a><span id="l2.1139" class="difflineplus">+    // in netCore.h 15</span>
<a href="#l2.1140"></a><span id="l2.1140">     dump(&quot;***** status is IN_PROGRESS\n&quot;);</span>
<a href="#l2.1141"></a><span id="l2.1141" class="difflineminus">-  else if (aStatus == 2152398864) // 0x804b0010 in netCore.h 16</span>
<a href="#l2.1142"></a><span id="l2.1142" class="difflineplus">+  } else if (aStatus == 2152398864) {</span>
<a href="#l2.1143"></a><span id="l2.1143" class="difflineplus">+    // 0x804b0010 in netCore.h 16</span>
<a href="#l2.1144"></a><span id="l2.1144">     dump(&quot;***** status is OFFLINE\n&quot;);</span>
<a href="#l2.1145"></a><span id="l2.1145" class="difflineminus">-  else if (aStatus == 2152398865) // in netCore.h 17</span>
<a href="#l2.1146"></a><span id="l2.1146" class="difflineplus">+  } else if (aStatus == 2152398865) {</span>
<a href="#l2.1147"></a><span id="l2.1147" class="difflineplus">+    // in netCore.h 17</span>
<a href="#l2.1148"></a><span id="l2.1148">     dump(&quot;***** status is NO_CONTENT\n&quot;);</span>
<a href="#l2.1149"></a><span id="l2.1149" class="difflineminus">-  else if (aStatus == 2152398866) // in netCore.h 18</span>
<a href="#l2.1150"></a><span id="l2.1150" class="difflineplus">+  } else if (aStatus == 2152398866) {</span>
<a href="#l2.1151"></a><span id="l2.1151" class="difflineplus">+    // in netCore.h 18</span>
<a href="#l2.1152"></a><span id="l2.1152">     dump(&quot;***** status is UNKNOWN_PROTOCOL\n&quot;);</span>
<a href="#l2.1153"></a><span id="l2.1153" class="difflineminus">-  else if (aStatus == 2152398867) // in netCore.h 19</span>
<a href="#l2.1154"></a><span id="l2.1154" class="difflineplus">+  } else if (aStatus == 2152398867) {</span>
<a href="#l2.1155"></a><span id="l2.1155" class="difflineplus">+    // in netCore.h 19</span>
<a href="#l2.1156"></a><span id="l2.1156">     dump(&quot;***** status is PORT_ACCESS_NOT_ALLOWED\n&quot;);</span>
<a href="#l2.1157"></a><span id="l2.1157" class="difflineminus">-  else if (aStatus == 2152398868) // in nsISocketTransportService.idl 20</span>
<a href="#l2.1158"></a><span id="l2.1158" class="difflineplus">+  } else if (aStatus == 2152398868) {</span>
<a href="#l2.1159"></a><span id="l2.1159" class="difflineplus">+    // in nsISocketTransportService.idl 20</span>
<a href="#l2.1160"></a><span id="l2.1160">     dump(&quot;***** status is NET_RESET\n&quot;);</span>
<a href="#l2.1161"></a><span id="l2.1161" class="difflineminus">-  else if (aStatus == 2152398869) // in ftpCore.h 21</span>
<a href="#l2.1162"></a><span id="l2.1162" class="difflineplus">+  } else if (aStatus == 2152398869) {</span>
<a href="#l2.1163"></a><span id="l2.1163" class="difflineplus">+    // in ftpCore.h 21</span>
<a href="#l2.1164"></a><span id="l2.1164">     dump(&quot;***** status is FTP_LOGIN\n&quot;);</span>
<a href="#l2.1165"></a><span id="l2.1165" class="difflineminus">-  else if (aStatus == 2152398870) // in ftpCore.h 22</span>
<a href="#l2.1166"></a><span id="l2.1166" class="difflineplus">+  } else if (aStatus == 2152398870) {</span>
<a href="#l2.1167"></a><span id="l2.1167" class="difflineplus">+    // in ftpCore.h 22</span>
<a href="#l2.1168"></a><span id="l2.1168">     dump(&quot;***** status is FTP_CWD\n&quot;);</span>
<a href="#l2.1169"></a><span id="l2.1169" class="difflineminus">-  else if (aStatus == 2152398871) // in ftpCore.h 23</span>
<a href="#l2.1170"></a><span id="l2.1170" class="difflineplus">+  } else if (aStatus == 2152398871) {</span>
<a href="#l2.1171"></a><span id="l2.1171" class="difflineplus">+    // in ftpCore.h 23</span>
<a href="#l2.1172"></a><span id="l2.1172">     dump(&quot;***** status is FTP_PASV\n&quot;);</span>
<a href="#l2.1173"></a><span id="l2.1173" class="difflineminus">-  else if (aStatus == 2152398872) // in ftpCore.h 24</span>
<a href="#l2.1174"></a><span id="l2.1174" class="difflineplus">+  } else if (aStatus == 2152398872) {</span>
<a href="#l2.1175"></a><span id="l2.1175" class="difflineplus">+    // in ftpCore.h 24</span>
<a href="#l2.1176"></a><span id="l2.1176">     dump(&quot;***** status is FTP_PWD\n&quot;);</span>
<a href="#l2.1177"></a><span id="l2.1177" class="difflineminus">-  else if (aStatus == 2152857601)</span>
<a href="#l2.1178"></a><span id="l2.1178" class="difflineplus">+  } else if (aStatus == 2152857601) {</span>
<a href="#l2.1179"></a><span id="l2.1179">     dump(&quot;***** status is UNRECOGNIZED_PATH\n&quot;);</span>
<a href="#l2.1180"></a><span id="l2.1180" class="difflineminus">-  else if (aStatus == 2152857602)</span>
<a href="#l2.1181"></a><span id="l2.1181" class="difflineplus">+  } else if (aStatus == 2152857602) {</span>
<a href="#l2.1182"></a><span id="l2.1182">     dump(&quot;***** status is UNRESOLABLE SYMLINK\n&quot;);</span>
<a href="#l2.1183"></a><span id="l2.1183" class="difflineminus">-  else if (aStatus == 2152857604)</span>
<a href="#l2.1184"></a><span id="l2.1184" class="difflineplus">+  } else if (aStatus == 2152857604) {</span>
<a href="#l2.1185"></a><span id="l2.1185">     dump(&quot;***** status is UNKNOWN_TYPE\n&quot;);</span>
<a href="#l2.1186"></a><span id="l2.1186" class="difflineminus">-  else if (aStatus == 2152857605)</span>
<a href="#l2.1187"></a><span id="l2.1187" class="difflineplus">+  } else if (aStatus == 2152857605) {</span>
<a href="#l2.1188"></a><span id="l2.1188">     dump(&quot;***** status is DESTINATION_NOT_DIR\n&quot;);</span>
<a href="#l2.1189"></a><span id="l2.1189" class="difflineminus">-  else if (aStatus == 2152857606)</span>
<a href="#l2.1190"></a><span id="l2.1190" class="difflineplus">+  } else if (aStatus == 2152857606) {</span>
<a href="#l2.1191"></a><span id="l2.1191">     dump(&quot;***** status is TARGET_DOES_NOT_EXIST\n&quot;);</span>
<a href="#l2.1192"></a><span id="l2.1192" class="difflineminus">-  else if (aStatus == 2152857608)</span>
<a href="#l2.1193"></a><span id="l2.1193" class="difflineplus">+  } else if (aStatus == 2152857608) {</span>
<a href="#l2.1194"></a><span id="l2.1194">     dump(&quot;***** status is ALREADY_EXISTS\n&quot;);</span>
<a href="#l2.1195"></a><span id="l2.1195" class="difflineminus">-  else if (aStatus == 2152857609)</span>
<a href="#l2.1196"></a><span id="l2.1196" class="difflineplus">+  } else if (aStatus == 2152857609) {</span>
<a href="#l2.1197"></a><span id="l2.1197">     dump(&quot;***** status is INVALID_PATH\n&quot;);</span>
<a href="#l2.1198"></a><span id="l2.1198" class="difflineminus">-  else if (aStatus == 2152857610)</span>
<a href="#l2.1199"></a><span id="l2.1199" class="difflineplus">+  } else if (aStatus == 2152857610) {</span>
<a href="#l2.1200"></a><span id="l2.1200">     dump(&quot;***** status is DISK_FULL\n&quot;);</span>
<a href="#l2.1201"></a><span id="l2.1201" class="difflineminus">-  else if (aStatus == 2152857612)</span>
<a href="#l2.1202"></a><span id="l2.1202" class="difflineplus">+  } else if (aStatus == 2152857612) {</span>
<a href="#l2.1203"></a><span id="l2.1203">     dump(&quot;***** status is NOT_DIRECTORY\n&quot;);</span>
<a href="#l2.1204"></a><span id="l2.1204" class="difflineminus">-  else if (aStatus == 2152857613)</span>
<a href="#l2.1205"></a><span id="l2.1205" class="difflineplus">+  } else if (aStatus == 2152857613) {</span>
<a href="#l2.1206"></a><span id="l2.1206">     dump(&quot;***** status is IS_DIRECTORY\n&quot;);</span>
<a href="#l2.1207"></a><span id="l2.1207" class="difflineminus">-  else if (aStatus == 2152857614)</span>
<a href="#l2.1208"></a><span id="l2.1208" class="difflineplus">+  } else if (aStatus == 2152857614) {</span>
<a href="#l2.1209"></a><span id="l2.1209">     dump(&quot;***** status is IS_LOCKED\n&quot;);</span>
<a href="#l2.1210"></a><span id="l2.1210" class="difflineminus">-  else if (aStatus == 2152857615)</span>
<a href="#l2.1211"></a><span id="l2.1211" class="difflineplus">+  } else if (aStatus == 2152857615) {</span>
<a href="#l2.1212"></a><span id="l2.1212">     dump(&quot;***** status is TOO_BIG\n&quot;);</span>
<a href="#l2.1213"></a><span id="l2.1213" class="difflineminus">-  else if (aStatus == 2152857616)</span>
<a href="#l2.1214"></a><span id="l2.1214" class="difflineplus">+  } else if (aStatus == 2152857616) {</span>
<a href="#l2.1215"></a><span id="l2.1215">     dump(&quot;***** status is NO_DEVICE_SPACE\n&quot;);</span>
<a href="#l2.1216"></a><span id="l2.1216" class="difflineminus">-  else if (aStatus == 2152857617)</span>
<a href="#l2.1217"></a><span id="l2.1217" class="difflineplus">+  } else if (aStatus == 2152857617) {</span>
<a href="#l2.1218"></a><span id="l2.1218">     dump(&quot;***** status is NAME_TOO_LONG\n&quot;);</span>
<a href="#l2.1219"></a><span id="l2.1219" class="difflineminus">-  else if (aStatus == 2152857618) // 80520012</span>
<a href="#l2.1220"></a><span id="l2.1220" class="difflineplus">+  } else if (aStatus == 2152857618) {</span>
<a href="#l2.1221"></a><span id="l2.1221" class="difflineplus">+    // 80520012</span>
<a href="#l2.1222"></a><span id="l2.1222">     dump(&quot;***** status is FILE_NOT_FOUND\n&quot;);</span>
<a href="#l2.1223"></a><span id="l2.1223" class="difflineminus">-  else if (aStatus == 2152857619)</span>
<a href="#l2.1224"></a><span id="l2.1224" class="difflineplus">+  } else if (aStatus == 2152857619) {</span>
<a href="#l2.1225"></a><span id="l2.1225">     dump(&quot;***** status is READ_ONLY\n&quot;);</span>
<a href="#l2.1226"></a><span id="l2.1226" class="difflineminus">-  else if (aStatus == 2152857620)</span>
<a href="#l2.1227"></a><span id="l2.1227" class="difflineplus">+  } else if (aStatus == 2152857620) {</span>
<a href="#l2.1228"></a><span id="l2.1228">     dump(&quot;***** status is DIR_NOT_EMPTY\n&quot;);</span>
<a href="#l2.1229"></a><span id="l2.1229" class="difflineminus">-  else if (aStatus == 2152857621)</span>
<a href="#l2.1230"></a><span id="l2.1230" class="difflineplus">+  } else if (aStatus == 2152857621) {</span>
<a href="#l2.1231"></a><span id="l2.1231">     dump(&quot;***** status is ACCESS_DENIED\n&quot;);</span>
<a href="#l2.1232"></a><span id="l2.1232" class="difflineminus">-  else if (aStatus == 2152398878)</span>
<a href="#l2.1233"></a><span id="l2.1233" class="difflineplus">+  } else if (aStatus == 2152398878) {</span>
<a href="#l2.1234"></a><span id="l2.1234">     dump(&quot;***** status is ? (No connection or time out?)\n&quot;);</span>
<a href="#l2.1235"></a><span id="l2.1235" class="difflineminus">-  else</span>
<a href="#l2.1236"></a><span id="l2.1236" class="difflineplus">+  } else {</span>
<a href="#l2.1237"></a><span id="l2.1237">     dump(&quot;***** status is &quot; + aStatus + &quot;\n&quot;);</span>
<a href="#l2.1238"></a><span id="l2.1238" class="difflineplus">+  }</span>
<a href="#l2.1239"></a><span id="l2.1239"> }</span>
<a href="#l2.1240"></a><span id="l2.1240"> /* eslint-enable complexity */</span>
<a href="#l2.1241"></a><span id="l2.1241"> </span>
<a href="#l2.1242"></a><span id="l2.1242"> // Update any data that the user supplied in a prompt dialog</span>
<a href="#l2.1243"></a><span id="l2.1243" class="difflineminus">-function UpdateUsernamePasswordFromPrompt(publishData, username, password, savePassword) {</span>
<a href="#l2.1244"></a><span id="l2.1244" class="difflineminus">-  if (!publishData)</span>
<a href="#l2.1245"></a><span id="l2.1245" class="difflineplus">+function UpdateUsernamePasswordFromPrompt(</span>
<a href="#l2.1246"></a><span id="l2.1246" class="difflineplus">+  publishData,</span>
<a href="#l2.1247"></a><span id="l2.1247" class="difflineplus">+  username,</span>
<a href="#l2.1248"></a><span id="l2.1248" class="difflineplus">+  password,</span>
<a href="#l2.1249"></a><span id="l2.1249" class="difflineplus">+  savePassword</span>
<a href="#l2.1250"></a><span id="l2.1250" class="difflineplus">+) {</span>
<a href="#l2.1251"></a><span id="l2.1251" class="difflineplus">+  if (!publishData) {</span>
<a href="#l2.1252"></a><span id="l2.1252">     return;</span>
<a href="#l2.1253"></a><span id="l2.1253" class="difflineplus">+  }</span>
<a href="#l2.1254"></a><span id="l2.1254"> </span>
<a href="#l2.1255"></a><span id="l2.1255">   // Set flag to save publish data after publishing if it changed in dialog</span>
<a href="#l2.1256"></a><span id="l2.1256">   //  and the &quot;SavePassword&quot; checkbox was checked</span>
<a href="#l2.1257"></a><span id="l2.1257">   //  or we already had site data for this site</span>
<a href="#l2.1258"></a><span id="l2.1258">   // (Thus we don't automatically create a site until user brings up Publish As dialog)</span>
<a href="#l2.1259"></a><span id="l2.1259" class="difflineminus">-  publishData.savePublishData = (gPublishData.username != username || gPublishData.password != password)</span>
<a href="#l2.1260"></a><span id="l2.1260" class="difflineminus">-                                &amp;&amp; (savePassword || !publishData.notInSiteData);</span>
<a href="#l2.1261"></a><span id="l2.1261" class="difflineplus">+  publishData.savePublishData =</span>
<a href="#l2.1262"></a><span id="l2.1262" class="difflineplus">+    (gPublishData.username != username || gPublishData.password != password) &amp;&amp;</span>
<a href="#l2.1263"></a><span id="l2.1263" class="difflineplus">+    (savePassword || !publishData.notInSiteData);</span>
<a href="#l2.1264"></a><span id="l2.1264"> </span>
<a href="#l2.1265"></a><span id="l2.1265">   publishData.username = username;</span>
<a href="#l2.1266"></a><span id="l2.1266">   publishData.password = password;</span>
<a href="#l2.1267"></a><span id="l2.1267">   publishData.savePassword = savePassword;</span>
<a href="#l2.1268"></a><span id="l2.1268"> }</span>
<a href="#l2.1269"></a><span id="l2.1269"> </span>
<a href="#l2.1270"></a><span id="l2.1270"> const kSupportedTextMimeTypes = [</span>
<a href="#l2.1271"></a><span id="l2.1271">   &quot;text/plain&quot;,</span>
<a href="#l2.1272"></a><span id="l2.1272" class="difflineat">@@ -1432,18 +1643,19 @@ const kSupportedTextMimeTypes = [</span>
<a href="#l2.1273"></a><span id="l2.1273">   &quot;application/ecmascript&quot;,</span>
<a href="#l2.1274"></a><span id="l2.1274">   &quot;application/x-javascript&quot;,</span>
<a href="#l2.1275"></a><span id="l2.1275">   &quot;text/xul&quot;,</span>
<a href="#l2.1276"></a><span id="l2.1276">   &quot;application/vnd.mozilla.xul+xml&quot;,</span>
<a href="#l2.1277"></a><span id="l2.1277"> ];</span>
<a href="#l2.1278"></a><span id="l2.1278"> </span>
<a href="#l2.1279"></a><span id="l2.1279"> function IsSupportedTextMimeType(aMimeType) {</span>
<a href="#l2.1280"></a><span id="l2.1280">   for (var i = 0; i &lt; kSupportedTextMimeTypes.length; i++) {</span>
<a href="#l2.1281"></a><span id="l2.1281" class="difflineminus">-    if (kSupportedTextMimeTypes[i] == aMimeType)</span>
<a href="#l2.1282"></a><span id="l2.1282" class="difflineplus">+    if (kSupportedTextMimeTypes[i] == aMimeType) {</span>
<a href="#l2.1283"></a><span id="l2.1283">       return true;</span>
<a href="#l2.1284"></a><span id="l2.1284" class="difflineplus">+    }</span>
<a href="#l2.1285"></a><span id="l2.1285">   }</span>
<a href="#l2.1286"></a><span id="l2.1286">   return false;</span>
<a href="#l2.1287"></a><span id="l2.1287"> }</span>
<a href="#l2.1288"></a><span id="l2.1288"> </span>
<a href="#l2.1289"></a><span id="l2.1289"> /* eslint-disable */</span>
<a href="#l2.1290"></a><span id="l2.1290"> /* eslint-disable complexity */</span>
<a href="#l2.1291"></a><span id="l2.1291"> // throws an error or returns true if user attempted save; false if user canceled save</span>
<a href="#l2.1292"></a><span id="l2.1292"> async function SaveDocument(aSaveAs, aSaveCopy, aMimeType) {</span>
<a href="#l2.1293"></a><span id="l2.1293" class="difflineat">@@ -1604,53 +1816,87 @@ function SetDocumentURI(uri) {</span>
<a href="#l2.1294"></a><span id="l2.1294"> </span>
<a href="#l2.1295"></a><span id="l2.1295"> // -------------------------------  Publishing</span>
<a href="#l2.1296"></a><span id="l2.1296"> var gPublishData;</span>
<a href="#l2.1297"></a><span id="l2.1297"> var gProgressDialog;</span>
<a href="#l2.1298"></a><span id="l2.1298"> var gCommandAfterPublishing = null;</span>
<a href="#l2.1299"></a><span id="l2.1299"> var gRestoreDocumentSource;</span>
<a href="#l2.1300"></a><span id="l2.1300"> </span>
<a href="#l2.1301"></a><span id="l2.1301"> function Publish(publishData) {</span>
<a href="#l2.1302"></a><span id="l2.1302" class="difflineminus">-  if (!publishData)</span>
<a href="#l2.1303"></a><span id="l2.1303" class="difflineplus">+  if (!publishData) {</span>
<a href="#l2.1304"></a><span id="l2.1304">     return false;</span>
<a href="#l2.1305"></a><span id="l2.1305" class="difflineplus">+  }</span>
<a href="#l2.1306"></a><span id="l2.1306"> </span>
<a href="#l2.1307"></a><span id="l2.1307">   // Set data in global for username password requests</span>
<a href="#l2.1308"></a><span id="l2.1308">   //  and to do &quot;post saving&quot; actions after monitoring nsIWebProgressListener messages</span>
<a href="#l2.1309"></a><span id="l2.1309">   //  and we are sure file transfer was successful</span>
<a href="#l2.1310"></a><span id="l2.1310">   gPublishData = publishData;</span>
<a href="#l2.1311"></a><span id="l2.1311"> </span>
<a href="#l2.1312"></a><span id="l2.1312">   gPublishData.docURI = CreateURIFromPublishData(publishData, true);</span>
<a href="#l2.1313"></a><span id="l2.1313">   if (!gPublishData.docURI) {</span>
<a href="#l2.1314"></a><span id="l2.1314" class="difflineminus">-    Services.prompt.alert(window, GetString(&quot;Publish&quot;), GetString(&quot;PublishFailed&quot;));</span>
<a href="#l2.1315"></a><span id="l2.1315" class="difflineplus">+    Services.prompt.alert(</span>
<a href="#l2.1316"></a><span id="l2.1316" class="difflineplus">+      window,</span>
<a href="#l2.1317"></a><span id="l2.1317" class="difflineplus">+      GetString(&quot;Publish&quot;),</span>
<a href="#l2.1318"></a><span id="l2.1318" class="difflineplus">+      GetString(&quot;PublishFailed&quot;)</span>
<a href="#l2.1319"></a><span id="l2.1319" class="difflineplus">+    );</span>
<a href="#l2.1320"></a><span id="l2.1320">     return false;</span>
<a href="#l2.1321"></a><span id="l2.1321">   }</span>
<a href="#l2.1322"></a><span id="l2.1322"> </span>
<a href="#l2.1323"></a><span id="l2.1323" class="difflineminus">-  if (gPublishData.publishOtherFiles)</span>
<a href="#l2.1324"></a><span id="l2.1324" class="difflineplus">+  if (gPublishData.publishOtherFiles) {</span>
<a href="#l2.1325"></a><span id="l2.1325">     gPublishData.otherFilesURI = CreateURIFromPublishData(publishData, false);</span>
<a href="#l2.1326"></a><span id="l2.1326" class="difflineminus">-  else</span>
<a href="#l2.1327"></a><span id="l2.1327" class="difflineplus">+  } else {</span>
<a href="#l2.1328"></a><span id="l2.1328">     gPublishData.otherFilesURI = null;</span>
<a href="#l2.1329"></a><span id="l2.1329" class="difflineplus">+  }</span>
<a href="#l2.1330"></a><span id="l2.1330"> </span>
<a href="#l2.1331"></a><span id="l2.1331">   if (gShowDebugOutputStateChange) {</span>
<a href="#l2.1332"></a><span id="l2.1332" class="difflineminus">-    dump(&quot;\n *** publishData: PublishUrl=&quot; + publishData.publishUrl + &quot;, BrowseUrl=&quot; + publishData.browseUrl +</span>
<a href="#l2.1333"></a><span id="l2.1333" class="difflineminus">-      &quot;, Username=&quot; + publishData.username + &quot;, Dir=&quot; + publishData.docDir +</span>
<a href="#l2.1334"></a><span id="l2.1334" class="difflineminus">-      &quot;, Filename=&quot; + publishData.filename + &quot;\n&quot;);</span>
<a href="#l2.1335"></a><span id="l2.1335" class="difflineminus">-    dump(&quot; * gPublishData.docURI.spec w/o pass=&quot; + StripPassword(gPublishData.docURI.spec) + &quot;, PublishOtherFiles=&quot; + gPublishData.publishOtherFiles + &quot;\n&quot;);</span>
<a href="#l2.1336"></a><span id="l2.1336" class="difflineplus">+    dump(</span>
<a href="#l2.1337"></a><span id="l2.1337" class="difflineplus">+      &quot;\n *** publishData: PublishUrl=&quot; +</span>
<a href="#l2.1338"></a><span id="l2.1338" class="difflineplus">+        publishData.publishUrl +</span>
<a href="#l2.1339"></a><span id="l2.1339" class="difflineplus">+        &quot;, BrowseUrl=&quot; +</span>
<a href="#l2.1340"></a><span id="l2.1340" class="difflineplus">+        publishData.browseUrl +</span>
<a href="#l2.1341"></a><span id="l2.1341" class="difflineplus">+        &quot;, Username=&quot; +</span>
<a href="#l2.1342"></a><span id="l2.1342" class="difflineplus">+        publishData.username +</span>
<a href="#l2.1343"></a><span id="l2.1343" class="difflineplus">+        &quot;, Dir=&quot; +</span>
<a href="#l2.1344"></a><span id="l2.1344" class="difflineplus">+        publishData.docDir +</span>
<a href="#l2.1345"></a><span id="l2.1345" class="difflineplus">+        &quot;, Filename=&quot; +</span>
<a href="#l2.1346"></a><span id="l2.1346" class="difflineplus">+        publishData.filename +</span>
<a href="#l2.1347"></a><span id="l2.1347" class="difflineplus">+        &quot;\n&quot;</span>
<a href="#l2.1348"></a><span id="l2.1348" class="difflineplus">+    );</span>
<a href="#l2.1349"></a><span id="l2.1349" class="difflineplus">+    dump(</span>
<a href="#l2.1350"></a><span id="l2.1350" class="difflineplus">+      &quot; * gPublishData.docURI.spec w/o pass=&quot; +</span>
<a href="#l2.1351"></a><span id="l2.1351" class="difflineplus">+        StripPassword(gPublishData.docURI.spec) +</span>
<a href="#l2.1352"></a><span id="l2.1352" class="difflineplus">+        &quot;, PublishOtherFiles=&quot; +</span>
<a href="#l2.1353"></a><span id="l2.1353" class="difflineplus">+        gPublishData.publishOtherFiles +</span>
<a href="#l2.1354"></a><span id="l2.1354" class="difflineplus">+        &quot;\n&quot;</span>
<a href="#l2.1355"></a><span id="l2.1355" class="difflineplus">+    );</span>
<a href="#l2.1356"></a><span id="l2.1356">   }</span>
<a href="#l2.1357"></a><span id="l2.1357"> </span>
<a href="#l2.1358"></a><span id="l2.1358">   // XXX Missing username will make FTP fail</span>
<a href="#l2.1359"></a><span id="l2.1359">   // and it won't call us for prompt dialog (bug 132320)</span>
<a href="#l2.1360"></a><span id="l2.1360">   // (It does prompt if just password is missing)</span>
<a href="#l2.1361"></a><span id="l2.1361">   // So we should do the prompt ourselves before trying to publish</span>
<a href="#l2.1362"></a><span id="l2.1362">   if (GetScheme(publishData.publishUrl) == &quot;ftp&quot; &amp;&amp; !publishData.username) {</span>
<a href="#l2.1363"></a><span id="l2.1363" class="difflineminus">-    var message = GetString(&quot;PromptFTPUsernamePassword&quot;).replace(/%host%/, GetHost(publishData.publishUrl));</span>
<a href="#l2.1364"></a><span id="l2.1364" class="difflineminus">-    var savePWobj = {value: publishData.savePassword};</span>
<a href="#l2.1365"></a><span id="l2.1365" class="difflineminus">-    var userObj = {value: publishData.username};</span>
<a href="#l2.1366"></a><span id="l2.1366" class="difflineminus">-    var pwObj = {value: publishData.password};</span>
<a href="#l2.1367"></a><span id="l2.1367" class="difflineminus">-    if (!PromptUsernameAndPassword(GetString(&quot;Prompt&quot;), message, savePWobj, userObj, pwObj))</span>
<a href="#l2.1368"></a><span id="l2.1368" class="difflineminus">-      return false; // User canceled out of dialog</span>
<a href="#l2.1369"></a><span id="l2.1369" class="difflineplus">+    var message = GetString(&quot;PromptFTPUsernamePassword&quot;).replace(</span>
<a href="#l2.1370"></a><span id="l2.1370" class="difflineplus">+      /%host%/,</span>
<a href="#l2.1371"></a><span id="l2.1371" class="difflineplus">+      GetHost(publishData.publishUrl)</span>
<a href="#l2.1372"></a><span id="l2.1372" class="difflineplus">+    );</span>
<a href="#l2.1373"></a><span id="l2.1373" class="difflineplus">+    var savePWobj = { value: publishData.savePassword };</span>
<a href="#l2.1374"></a><span id="l2.1374" class="difflineplus">+    var userObj = { value: publishData.username };</span>
<a href="#l2.1375"></a><span id="l2.1375" class="difflineplus">+    var pwObj = { value: publishData.password };</span>
<a href="#l2.1376"></a><span id="l2.1376" class="difflineplus">+    if (</span>
<a href="#l2.1377"></a><span id="l2.1377" class="difflineplus">+      !PromptUsernameAndPassword(</span>
<a href="#l2.1378"></a><span id="l2.1378" class="difflineplus">+        GetString(&quot;Prompt&quot;),</span>
<a href="#l2.1379"></a><span id="l2.1379" class="difflineplus">+        message,</span>
<a href="#l2.1380"></a><span id="l2.1380" class="difflineplus">+        savePWobj,</span>
<a href="#l2.1381"></a><span id="l2.1381" class="difflineplus">+        userObj,</span>
<a href="#l2.1382"></a><span id="l2.1382" class="difflineplus">+        pwObj</span>
<a href="#l2.1383"></a><span id="l2.1383" class="difflineplus">+      )</span>
<a href="#l2.1384"></a><span id="l2.1384" class="difflineplus">+    ) {</span>
<a href="#l2.1385"></a><span id="l2.1385" class="difflineplus">+      return false;</span>
<a href="#l2.1386"></a><span id="l2.1386" class="difflineplus">+    } // User canceled out of dialog</span>
<a href="#l2.1387"></a><span id="l2.1387"> </span>
<a href="#l2.1388"></a><span id="l2.1388">     // Reset data in URI objects</span>
<a href="#l2.1389"></a><span id="l2.1389">     gPublishData.docURI.username = publishData.username;</span>
<a href="#l2.1390"></a><span id="l2.1390">     gPublishData.docURI.password = publishData.password;</span>
<a href="#l2.1391"></a><span id="l2.1391"> </span>
<a href="#l2.1392"></a><span id="l2.1392">     if (gPublishData.otherFilesURI) {</span>
<a href="#l2.1393"></a><span id="l2.1393">       gPublishData.otherFilesURI.username = publishData.username;</span>
<a href="#l2.1394"></a><span id="l2.1394">       gPublishData.otherFilesURI.password = publishData.password;</span>
<a href="#l2.1395"></a><span id="l2.1395" class="difflineat">@@ -1658,19 +1904,23 @@ function Publish(publishData) {</span>
<a href="#l2.1396"></a><span id="l2.1396">   }</span>
<a href="#l2.1397"></a><span id="l2.1397"> </span>
<a href="#l2.1398"></a><span id="l2.1398">   try {</span>
<a href="#l2.1399"></a><span id="l2.1399">     // We launch dialog as a dependent</span>
<a href="#l2.1400"></a><span id="l2.1400">     // Don't allow editing document!</span>
<a href="#l2.1401"></a><span id="l2.1401">     SetDocumentEditable(false);</span>
<a href="#l2.1402"></a><span id="l2.1402"> </span>
<a href="#l2.1403"></a><span id="l2.1403">     // Start progress monitoring</span>
<a href="#l2.1404"></a><span id="l2.1404" class="difflineminus">-    gProgressDialog =</span>
<a href="#l2.1405"></a><span id="l2.1405" class="difflineminus">-      window.openDialog(&quot;chrome://editor/content/EditorPublishProgress.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l2.1406"></a><span id="l2.1406" class="difflineminus">-                        &quot;chrome,dependent,titlebar&quot;, gPublishData, gPersistObj);</span>
<a href="#l2.1407"></a><span id="l2.1407" class="difflineplus">+    gProgressDialog = window.openDialog(</span>
<a href="#l2.1408"></a><span id="l2.1408" class="difflineplus">+      &quot;chrome://editor/content/EditorPublishProgress.xul&quot;,</span>
<a href="#l2.1409"></a><span id="l2.1409" class="difflineplus">+      &quot;_blank&quot;,</span>
<a href="#l2.1410"></a><span id="l2.1410" class="difflineplus">+      &quot;chrome,dependent,titlebar&quot;,</span>
<a href="#l2.1411"></a><span id="l2.1411" class="difflineplus">+      gPublishData,</span>
<a href="#l2.1412"></a><span id="l2.1412" class="difflineplus">+      gPersistObj</span>
<a href="#l2.1413"></a><span id="l2.1413" class="difflineplus">+    );</span>
<a href="#l2.1414"></a><span id="l2.1414">   } catch (e) {}</span>
<a href="#l2.1415"></a><span id="l2.1415"> </span>
<a href="#l2.1416"></a><span id="l2.1416">   // Network transfer is often too quick for the progress dialog to be initialized</span>
<a href="#l2.1417"></a><span id="l2.1417">   //  and we can completely miss messages for quickly-terminated bad URLs,</span>
<a href="#l2.1418"></a><span id="l2.1418">   //  so we can't call OutputFileWithPersistAPI right away.</span>
<a href="#l2.1419"></a><span id="l2.1419">   // StartPublishing() is called at the end of the dialog's onload method</span>
<a href="#l2.1420"></a><span id="l2.1420">   return true;</span>
<a href="#l2.1421"></a><span id="l2.1421"> }</span>
<a href="#l2.1422"></a><span id="l2.1422" class="difflineat">@@ -1679,24 +1929,29 @@ function StartPublishing() {</span>
<a href="#l2.1423"></a><span id="l2.1423">   var editor = GetCurrentEditor();</span>
<a href="#l2.1424"></a><span id="l2.1424">   if (editor &amp;&amp; gPublishData &amp;&amp; gPublishData.docURI &amp;&amp; gProgressDialog) {</span>
<a href="#l2.1425"></a><span id="l2.1425">     gRestoreDocumentSource = null;</span>
<a href="#l2.1426"></a><span id="l2.1426"> </span>
<a href="#l2.1427"></a><span id="l2.1427">     // Save backup document since nsIWebBrowserPersist changes image src urls</span>
<a href="#l2.1428"></a><span id="l2.1428">     // but we only need to do this if publishing images and other related files</span>
<a href="#l2.1429"></a><span id="l2.1429">     if (gPublishData.otherFilesURI) {</span>
<a href="#l2.1430"></a><span id="l2.1430">       try {</span>
<a href="#l2.1431"></a><span id="l2.1431" class="difflineminus">-        gRestoreDocumentSource =</span>
<a href="#l2.1432"></a><span id="l2.1432" class="difflineminus">-          editor.outputToString(editor.contentsMIMEType, kOutputEncodeW3CEntities);</span>
<a href="#l2.1433"></a><span id="l2.1433" class="difflineplus">+        gRestoreDocumentSource = editor.outputToString(</span>
<a href="#l2.1434"></a><span id="l2.1434" class="difflineplus">+          editor.contentsMIMEType,</span>
<a href="#l2.1435"></a><span id="l2.1435" class="difflineplus">+          kOutputEncodeW3CEntities</span>
<a href="#l2.1436"></a><span id="l2.1436" class="difflineplus">+        );</span>
<a href="#l2.1437"></a><span id="l2.1437">       } catch (e) {}</span>
<a href="#l2.1438"></a><span id="l2.1438">     }</span>
<a href="#l2.1439"></a><span id="l2.1439"> </span>
<a href="#l2.1440"></a><span id="l2.1440" class="difflineminus">-    OutputFileWithPersistAPI(editor.document,</span>
<a href="#l2.1441"></a><span id="l2.1441" class="difflineminus">-                             gPublishData.docURI, gPublishData.otherFilesURI,</span>
<a href="#l2.1442"></a><span id="l2.1442" class="difflineminus">-                             editor.contentsMIMEType);</span>
<a href="#l2.1443"></a><span id="l2.1443" class="difflineplus">+    OutputFileWithPersistAPI(</span>
<a href="#l2.1444"></a><span id="l2.1444" class="difflineplus">+      editor.document,</span>
<a href="#l2.1445"></a><span id="l2.1445" class="difflineplus">+      gPublishData.docURI,</span>
<a href="#l2.1446"></a><span id="l2.1446" class="difflineplus">+      gPublishData.otherFilesURI,</span>
<a href="#l2.1447"></a><span id="l2.1447" class="difflineplus">+      editor.contentsMIMEType</span>
<a href="#l2.1448"></a><span id="l2.1448" class="difflineplus">+    );</span>
<a href="#l2.1449"></a><span id="l2.1449">     return gPersistObj;</span>
<a href="#l2.1450"></a><span id="l2.1450">   }</span>
<a href="#l2.1451"></a><span id="l2.1451">   return null;</span>
<a href="#l2.1452"></a><span id="l2.1452"> }</span>
<a href="#l2.1453"></a><span id="l2.1453"> </span>
<a href="#l2.1454"></a><span id="l2.1454"> function CancelPublishing() {</span>
<a href="#l2.1455"></a><span id="l2.1455">   try {</span>
<a href="#l2.1456"></a><span id="l2.1456">     gPersistObj.cancelSave();</span>
<a href="#l2.1457"></a><span id="l2.1457" class="difflineat">@@ -1785,67 +2040,82 @@ function SetSaveAndPublishUI(urlstring) </span>
<a href="#l2.1458"></a><span id="l2.1458">   goUpdateCommand(&quot;cmd_publish&quot;);</span>
<a href="#l2.1459"></a><span id="l2.1459"> }</span>
<a href="#l2.1460"></a><span id="l2.1460"> </span>
<a href="#l2.1461"></a><span id="l2.1461"> function SetDocumentEditable(isDocEditable) {</span>
<a href="#l2.1462"></a><span id="l2.1462">   var editor = GetCurrentEditor();</span>
<a href="#l2.1463"></a><span id="l2.1463">   if (editor &amp;&amp; editor.document) {</span>
<a href="#l2.1464"></a><span id="l2.1464">     try {</span>
<a href="#l2.1465"></a><span id="l2.1465">       var flags = editor.flags;</span>
<a href="#l2.1466"></a><span id="l2.1466" class="difflineminus">-      editor.flags = isDocEditable ?</span>
<a href="#l2.1467"></a><span id="l2.1467" class="difflineminus">-            flags &amp;= ~nsIPlaintextEditor.eEditorReadonlyMask :</span>
<a href="#l2.1468"></a><span id="l2.1468" class="difflineminus">-            flags | nsIPlaintextEditor.eEditorReadonlyMask;</span>
<a href="#l2.1469"></a><span id="l2.1469" class="difflineplus">+      editor.flags = isDocEditable</span>
<a href="#l2.1470"></a><span id="l2.1470" class="difflineplus">+        ? (flags &amp;= ~nsIPlaintextEditor.eEditorReadonlyMask)</span>
<a href="#l2.1471"></a><span id="l2.1471" class="difflineplus">+        : flags | nsIPlaintextEditor.eEditorReadonlyMask;</span>
<a href="#l2.1472"></a><span id="l2.1472">     } catch (e) {}</span>
<a href="#l2.1473"></a><span id="l2.1473"> </span>
<a href="#l2.1474"></a><span id="l2.1474">     // update all commands</span>
<a href="#l2.1475"></a><span id="l2.1475">     window.updateCommands(&quot;create&quot;);</span>
<a href="#l2.1476"></a><span id="l2.1476">   }</span>
<a href="#l2.1477"></a><span id="l2.1477"> }</span>
<a href="#l2.1478"></a><span id="l2.1478"> </span>
<a href="#l2.1479"></a><span id="l2.1479"> // ****** end of save / publish **********//</span>
<a href="#l2.1480"></a><span id="l2.1480"> </span>
<a href="#l2.1481"></a><span id="l2.1481"> var nsPublishSettingsCommand = {</span>
<a href="#l2.1482"></a><span id="l2.1482">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.1483"></a><span id="l2.1483" class="difflineminus">-    return (IsDocumentEditable());</span>
<a href="#l2.1484"></a><span id="l2.1484" class="difflineplus">+    return IsDocumentEditable();</span>
<a href="#l2.1485"></a><span id="l2.1485">   },</span>
<a href="#l2.1486"></a><span id="l2.1486"> </span>
<a href="#l2.1487"></a><span id="l2.1487">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.1488"></a><span id="l2.1488">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.1489"></a><span id="l2.1489"> </span>
<a href="#l2.1490"></a><span id="l2.1490">   doCommand(aCommand) {</span>
<a href="#l2.1491"></a><span id="l2.1491">     if (GetCurrentEditor()) {</span>
<a href="#l2.1492"></a><span id="l2.1492">       // Launch Publish Settings dialog</span>
<a href="#l2.1493"></a><span id="l2.1493"> </span>
<a href="#l2.1494"></a><span id="l2.1494" class="difflineminus">-      window.ok = window.openDialog(&quot;chrome://editor/content/EditorPublishSettings.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, &quot;&quot;);</span>
<a href="#l2.1495"></a><span id="l2.1495" class="difflineplus">+      window.ok = window.openDialog(</span>
<a href="#l2.1496"></a><span id="l2.1496" class="difflineplus">+        &quot;chrome://editor/content/EditorPublishSettings.xul&quot;,</span>
<a href="#l2.1497"></a><span id="l2.1497" class="difflineplus">+        &quot;_blank&quot;,</span>
<a href="#l2.1498"></a><span id="l2.1498" class="difflineplus">+        &quot;chrome,close,titlebar,modal&quot;,</span>
<a href="#l2.1499"></a><span id="l2.1499" class="difflineplus">+        &quot;&quot;</span>
<a href="#l2.1500"></a><span id="l2.1500" class="difflineplus">+      );</span>
<a href="#l2.1501"></a><span id="l2.1501">       return window.ok;</span>
<a href="#l2.1502"></a><span id="l2.1502">     }</span>
<a href="#l2.1503"></a><span id="l2.1503">     return false;</span>
<a href="#l2.1504"></a><span id="l2.1504">   },</span>
<a href="#l2.1505"></a><span id="l2.1505"> };</span>
<a href="#l2.1506"></a><span id="l2.1506"> </span>
<a href="#l2.1507"></a><span id="l2.1507"> var nsRevertCommand = {</span>
<a href="#l2.1508"></a><span id="l2.1508">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.1509"></a><span id="l2.1509" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp;</span>
<a href="#l2.1510"></a><span id="l2.1510" class="difflineminus">-            IsDocumentModified() &amp;&amp;</span>
<a href="#l2.1511"></a><span id="l2.1511" class="difflineminus">-            !IsUrlAboutBlank(GetDocumentUrl()));</span>
<a href="#l2.1512"></a><span id="l2.1512" class="difflineplus">+    return (</span>
<a href="#l2.1513"></a><span id="l2.1513" class="difflineplus">+      IsDocumentEditable() &amp;&amp;</span>
<a href="#l2.1514"></a><span id="l2.1514" class="difflineplus">+      IsDocumentModified() &amp;&amp;</span>
<a href="#l2.1515"></a><span id="l2.1515" class="difflineplus">+      !IsUrlAboutBlank(GetDocumentUrl())</span>
<a href="#l2.1516"></a><span id="l2.1516" class="difflineplus">+    );</span>
<a href="#l2.1517"></a><span id="l2.1517">   },</span>
<a href="#l2.1518"></a><span id="l2.1518"> </span>
<a href="#l2.1519"></a><span id="l2.1519">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.1520"></a><span id="l2.1520">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.1521"></a><span id="l2.1521"> </span>
<a href="#l2.1522"></a><span id="l2.1522">   doCommand(aCommand) {</span>
<a href="#l2.1523"></a><span id="l2.1523">     // Confirm with the user to abandon current changes</span>
<a href="#l2.1524"></a><span id="l2.1524">     // Put the page title in the message string</span>
<a href="#l2.1525"></a><span id="l2.1525">     let title = GetDocumentTitle();</span>
<a href="#l2.1526"></a><span id="l2.1526">     let msg = GetString(&quot;AbandonChanges&quot;).replace(/%title%/, title);</span>
<a href="#l2.1527"></a><span id="l2.1527"> </span>
<a href="#l2.1528"></a><span id="l2.1528" class="difflineminus">-    let result = Services.prompt.confirmEx(window, GetString(&quot;RevertCaption&quot;), msg,</span>
<a href="#l2.1529"></a><span id="l2.1529" class="difflineminus">-                   (Services.prompt.BUTTON_TITLE_REVERT * Services.prompt.BUTTON_POS_0) +</span>
<a href="#l2.1530"></a><span id="l2.1530" class="difflineminus">-                   (Services.prompt.BUTTON_TITLE_CANCEL * Services.prompt.BUTTON_POS_1),</span>
<a href="#l2.1531"></a><span id="l2.1531" class="difflineminus">-                   null, null, null, null, {value: 0});</span>
<a href="#l2.1532"></a><span id="l2.1532" class="difflineplus">+    let result = Services.prompt.confirmEx(</span>
<a href="#l2.1533"></a><span id="l2.1533" class="difflineplus">+      window,</span>
<a href="#l2.1534"></a><span id="l2.1534" class="difflineplus">+      GetString(&quot;RevertCaption&quot;),</span>
<a href="#l2.1535"></a><span id="l2.1535" class="difflineplus">+      msg,</span>
<a href="#l2.1536"></a><span id="l2.1536" class="difflineplus">+      Services.prompt.BUTTON_TITLE_REVERT * Services.prompt.BUTTON_POS_0 +</span>
<a href="#l2.1537"></a><span id="l2.1537" class="difflineplus">+        Services.prompt.BUTTON_TITLE_CANCEL * Services.prompt.BUTTON_POS_1,</span>
<a href="#l2.1538"></a><span id="l2.1538" class="difflineplus">+      null,</span>
<a href="#l2.1539"></a><span id="l2.1539" class="difflineplus">+      null,</span>
<a href="#l2.1540"></a><span id="l2.1540" class="difflineplus">+      null,</span>
<a href="#l2.1541"></a><span id="l2.1541" class="difflineplus">+      null,</span>
<a href="#l2.1542"></a><span id="l2.1542" class="difflineplus">+      { value: 0 }</span>
<a href="#l2.1543"></a><span id="l2.1543" class="difflineplus">+    );</span>
<a href="#l2.1544"></a><span id="l2.1544"> </span>
<a href="#l2.1545"></a><span id="l2.1545">     // Reload page if first button (Revert) was pressed</span>
<a href="#l2.1546"></a><span id="l2.1546">     if (result == 0) {</span>
<a href="#l2.1547"></a><span id="l2.1547">       CancelHTMLSource();</span>
<a href="#l2.1548"></a><span id="l2.1548">       EditorLoadUrl(GetDocumentUrl());</span>
<a href="#l2.1549"></a><span id="l2.1549">     }</span>
<a href="#l2.1550"></a><span id="l2.1550">   },</span>
<a href="#l2.1551"></a><span id="l2.1551"> };</span>
<a href="#l2.1552"></a><span id="l2.1552" class="difflineat">@@ -1862,25 +2132,26 @@ var nsCloseCommand = {</span>
<a href="#l2.1553"></a><span id="l2.1553">     CloseWindow();</span>
<a href="#l2.1554"></a><span id="l2.1554">   },</span>
<a href="#l2.1555"></a><span id="l2.1555"> };</span>
<a href="#l2.1556"></a><span id="l2.1556"> </span>
<a href="#l2.1557"></a><span id="l2.1557"> async function CloseWindow() {</span>
<a href="#l2.1558"></a><span id="l2.1558">   // Check to make sure document is saved. &quot;true&quot; means allow &quot;Don't Save&quot; button,</span>
<a href="#l2.1559"></a><span id="l2.1559">   //   so user can choose to close without saving</span>
<a href="#l2.1560"></a><span id="l2.1560">   if (await CheckAndSaveDocument(&quot;cmd_close&quot;, true)) {</span>
<a href="#l2.1561"></a><span id="l2.1561" class="difflineminus">-    if (window.InsertCharWindow)</span>
<a href="#l2.1562"></a><span id="l2.1562" class="difflineplus">+    if (window.InsertCharWindow) {</span>
<a href="#l2.1563"></a><span id="l2.1563">       SwitchInsertCharToAnotherEditorOrClose();</span>
<a href="#l2.1564"></a><span id="l2.1564" class="difflineplus">+    }</span>
<a href="#l2.1565"></a><span id="l2.1565"> </span>
<a href="#l2.1566"></a><span id="l2.1566">     try {</span>
<a href="#l2.1567"></a><span id="l2.1567" class="difflineminus">-      var basewin = window.getInterface(Ci.nsIWebNavigation)</span>
<a href="#l2.1568"></a><span id="l2.1568" class="difflineminus">-                          .QueryInterface(Ci.nsIDocShellTreeItem)</span>
<a href="#l2.1569"></a><span id="l2.1569" class="difflineminus">-                          .treeOwner</span>
<a href="#l2.1570"></a><span id="l2.1570" class="difflineminus">-                          .QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l2.1571"></a><span id="l2.1571" class="difflineminus">-                          .getInterface(Ci.nsIBaseWindow);</span>
<a href="#l2.1572"></a><span id="l2.1572" class="difflineplus">+      var basewin = window</span>
<a href="#l2.1573"></a><span id="l2.1573" class="difflineplus">+        .getInterface(Ci.nsIWebNavigation)</span>
<a href="#l2.1574"></a><span id="l2.1574" class="difflineplus">+        .QueryInterface(Ci.nsIDocShellTreeItem)</span>
<a href="#l2.1575"></a><span id="l2.1575" class="difflineplus">+        .treeOwner.QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l2.1576"></a><span id="l2.1576" class="difflineplus">+        .getInterface(Ci.nsIBaseWindow);</span>
<a href="#l2.1577"></a><span id="l2.1577">       basewin.destroy();</span>
<a href="#l2.1578"></a><span id="l2.1578">     } catch (e) {}</span>
<a href="#l2.1579"></a><span id="l2.1579">   }</span>
<a href="#l2.1580"></a><span id="l2.1580"> }</span>
<a href="#l2.1581"></a><span id="l2.1581"> </span>
<a href="#l2.1582"></a><span id="l2.1582"> /* eslint-disable */</span>
<a href="#l2.1583"></a><span id="l2.1583"> var nsOpenRemoteCommand = {</span>
<a href="#l2.1584"></a><span id="l2.1584">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.1585"></a><span id="l2.1585" class="difflineat">@@ -1918,51 +2189,63 @@ var nsOpenRemoteCommand = {</span>
<a href="#l2.1586"></a><span id="l2.1586">         break;</span>
<a href="#l2.1587"></a><span id="l2.1587">     }</span>
<a href="#l2.1588"></a><span id="l2.1588">   },</span>
<a href="#l2.1589"></a><span id="l2.1589"> };</span>
<a href="#l2.1590"></a><span id="l2.1590"> /* eslint-enable */</span>
<a href="#l2.1591"></a><span id="l2.1591"> </span>
<a href="#l2.1592"></a><span id="l2.1592"> var nsPreviewCommand = {</span>
<a href="#l2.1593"></a><span id="l2.1593">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.1594"></a><span id="l2.1594" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp;</span>
<a href="#l2.1595"></a><span id="l2.1595" class="difflineminus">-            IsHTMLEditor() &amp;&amp;</span>
<a href="#l2.1596"></a><span id="l2.1596" class="difflineminus">-            (DocumentHasBeenSaved() || IsDocumentModified()));</span>
<a href="#l2.1597"></a><span id="l2.1597" class="difflineplus">+    return (</span>
<a href="#l2.1598"></a><span id="l2.1598" class="difflineplus">+      IsDocumentEditable() &amp;&amp;</span>
<a href="#l2.1599"></a><span id="l2.1599" class="difflineplus">+      IsHTMLEditor() &amp;&amp;</span>
<a href="#l2.1600"></a><span id="l2.1600" class="difflineplus">+      (DocumentHasBeenSaved() || IsDocumentModified())</span>
<a href="#l2.1601"></a><span id="l2.1601" class="difflineplus">+    );</span>
<a href="#l2.1602"></a><span id="l2.1602">   },</span>
<a href="#l2.1603"></a><span id="l2.1603"> </span>
<a href="#l2.1604"></a><span id="l2.1604">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.1605"></a><span id="l2.1605">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.1606"></a><span id="l2.1606"> </span>
<a href="#l2.1607"></a><span id="l2.1607">   async doCommand(aCommand) {</span>
<a href="#l2.1608"></a><span id="l2.1608">     // Don't continue if user canceled during prompt for saving</span>
<a href="#l2.1609"></a><span id="l2.1609">     // DocumentHasBeenSaved will test if we have a URL and suppress &quot;Don't Save&quot; button if not</span>
<a href="#l2.1610"></a><span id="l2.1610" class="difflineminus">-    if (!(await CheckAndSaveDocument(&quot;cmd_preview&quot;, DocumentHasBeenSaved())))</span>
<a href="#l2.1611"></a><span id="l2.1611" class="difflineplus">+    if (!(await CheckAndSaveDocument(&quot;cmd_preview&quot;, DocumentHasBeenSaved()))) {</span>
<a href="#l2.1612"></a><span id="l2.1612">       return;</span>
<a href="#l2.1613"></a><span id="l2.1613" class="difflineplus">+    }</span>
<a href="#l2.1614"></a><span id="l2.1614"> </span>
<a href="#l2.1615"></a><span id="l2.1615">     // Check if we saved again just in case?</span>
<a href="#l2.1616"></a><span id="l2.1616">     if (DocumentHasBeenSaved()) {</span>
<a href="#l2.1617"></a><span id="l2.1617">       let browser;</span>
<a href="#l2.1618"></a><span id="l2.1618">       try {</span>
<a href="#l2.1619"></a><span id="l2.1619">         // Find a browser with this URL</span>
<a href="#l2.1620"></a><span id="l2.1620">         let enumerator = Services.wm.getEnumerator(&quot;navigator:browser&quot;);</span>
<a href="#l2.1621"></a><span id="l2.1621"> </span>
<a href="#l2.1622"></a><span id="l2.1622">         var documentURI = GetDocumentUrl();</span>
<a href="#l2.1623"></a><span id="l2.1623">         while (enumerator.hasMoreElements()) {</span>
<a href="#l2.1624"></a><span id="l2.1624">           browser = enumerator.getNext();</span>
<a href="#l2.1625"></a><span id="l2.1625" class="difflineminus">-          if (browser &amp;&amp; !browser.closed &amp;&amp;</span>
<a href="#l2.1626"></a><span id="l2.1626" class="difflineminus">-              (documentURI == browser.getBrowser().currentURI.spec))</span>
<a href="#l2.1627"></a><span id="l2.1627" class="difflineplus">+          if (</span>
<a href="#l2.1628"></a><span id="l2.1628" class="difflineplus">+            browser &amp;&amp;</span>
<a href="#l2.1629"></a><span id="l2.1629" class="difflineplus">+            !browser.closed &amp;&amp;</span>
<a href="#l2.1630"></a><span id="l2.1630" class="difflineplus">+            documentURI == browser.getBrowser().currentURI.spec</span>
<a href="#l2.1631"></a><span id="l2.1631" class="difflineplus">+          ) {</span>
<a href="#l2.1632"></a><span id="l2.1632">             break;</span>
<a href="#l2.1633"></a><span id="l2.1633" class="difflineplus">+          }</span>
<a href="#l2.1634"></a><span id="l2.1634"> </span>
<a href="#l2.1635"></a><span id="l2.1635">           browser = null;</span>
<a href="#l2.1636"></a><span id="l2.1636">         }</span>
<a href="#l2.1637"></a><span id="l2.1637">       } catch (ex) {}</span>
<a href="#l2.1638"></a><span id="l2.1638"> </span>
<a href="#l2.1639"></a><span id="l2.1639">       // If none found, open a new browser</span>
<a href="#l2.1640"></a><span id="l2.1640">       if (!browser) {</span>
<a href="#l2.1641"></a><span id="l2.1641" class="difflineminus">-        browser = window.openDialog(getBrowserURL(), &quot;_blank&quot;, &quot;chrome,all,dialog=no&quot;, documentURI);</span>
<a href="#l2.1642"></a><span id="l2.1642" class="difflineplus">+        browser = window.openDialog(</span>
<a href="#l2.1643"></a><span id="l2.1643" class="difflineplus">+          getBrowserURL(),</span>
<a href="#l2.1644"></a><span id="l2.1644" class="difflineplus">+          &quot;_blank&quot;,</span>
<a href="#l2.1645"></a><span id="l2.1645" class="difflineplus">+          &quot;chrome,all,dialog=no&quot;,</span>
<a href="#l2.1646"></a><span id="l2.1646" class="difflineplus">+          documentURI</span>
<a href="#l2.1647"></a><span id="l2.1647" class="difflineplus">+        );</span>
<a href="#l2.1648"></a><span id="l2.1648">       } else {</span>
<a href="#l2.1649"></a><span id="l2.1649">         try {</span>
<a href="#l2.1650"></a><span id="l2.1650">           browser.BrowserReloadSkipCache();</span>
<a href="#l2.1651"></a><span id="l2.1651">           browser.focus();</span>
<a href="#l2.1652"></a><span id="l2.1652">         } catch (ex) {}</span>
<a href="#l2.1653"></a><span id="l2.1653">       }</span>
<a href="#l2.1654"></a><span id="l2.1654">     }</span>
<a href="#l2.1655"></a><span id="l2.1655">   },</span>
<a href="#l2.1656"></a><span id="l2.1656" class="difflineat">@@ -1994,17 +2277,17 @@ var nsSendPageCommand = {</span>
<a href="#l2.1657"></a><span id="l2.1657">       }</span>
<a href="#l2.1658"></a><span id="l2.1658">     }</span>
<a href="#l2.1659"></a><span id="l2.1659">   },</span>
<a href="#l2.1660"></a><span id="l2.1660"> };</span>
<a href="#l2.1661"></a><span id="l2.1661"> /* eslint-enable */</span>
<a href="#l2.1662"></a><span id="l2.1662"> </span>
<a href="#l2.1663"></a><span id="l2.1663"> var nsPrintCommand = {</span>
<a href="#l2.1664"></a><span id="l2.1664">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.1665"></a><span id="l2.1665" class="difflineminus">-    return true;    // we can always do this</span>
<a href="#l2.1666"></a><span id="l2.1666" class="difflineplus">+    return true; // we can always do this</span>
<a href="#l2.1667"></a><span id="l2.1667">   },</span>
<a href="#l2.1668"></a><span id="l2.1668"> </span>
<a href="#l2.1669"></a><span id="l2.1669">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.1670"></a><span id="l2.1670">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.1671"></a><span id="l2.1671"> </span>
<a href="#l2.1672"></a><span id="l2.1672">   doCommand(aCommand) {</span>
<a href="#l2.1673"></a><span id="l2.1673">     // In editor.js</span>
<a href="#l2.1674"></a><span id="l2.1674">     SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l2.1675"></a><span id="l2.1675" class="difflineat">@@ -2031,17 +2314,17 @@ var nsPrintPreviewCommand = {</span>
<a href="#l2.1676"></a><span id="l2.1676">       PrintUtils.printPreview(PrintPreviewListener);</span>
<a href="#l2.1677"></a><span id="l2.1677">     } catch (e) {}</span>
<a href="#l2.1678"></a><span id="l2.1678">   },</span>
<a href="#l2.1679"></a><span id="l2.1679"> };</span>
<a href="#l2.1680"></a><span id="l2.1680"> /* eslint-enable */</span>
<a href="#l2.1681"></a><span id="l2.1681"> </span>
<a href="#l2.1682"></a><span id="l2.1682"> var nsPrintSetupCommand = {</span>
<a href="#l2.1683"></a><span id="l2.1683">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.1684"></a><span id="l2.1684" class="difflineminus">-    return true;    // we can always do this</span>
<a href="#l2.1685"></a><span id="l2.1685" class="difflineplus">+    return true; // we can always do this</span>
<a href="#l2.1686"></a><span id="l2.1686">   },</span>
<a href="#l2.1687"></a><span id="l2.1687"> </span>
<a href="#l2.1688"></a><span id="l2.1688">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.1689"></a><span id="l2.1689">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.1690"></a><span id="l2.1690"> </span>
<a href="#l2.1691"></a><span id="l2.1691">   doCommand(aCommand) {</span>
<a href="#l2.1692"></a><span id="l2.1692">     // In editor.js</span>
<a href="#l2.1693"></a><span id="l2.1693">     SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l2.1694"></a><span id="l2.1694" class="difflineat">@@ -2053,18 +2336,22 @@ var nsFindReplaceCommand = {</span>
<a href="#l2.1695"></a><span id="l2.1695">   isCommandEnabled(aCommand, editorElement) {</span>
<a href="#l2.1696"></a><span id="l2.1696">     return editorElement.getEditor(editorElement.contentWindow) != null;</span>
<a href="#l2.1697"></a><span id="l2.1697">   },</span>
<a href="#l2.1698"></a><span id="l2.1698"> </span>
<a href="#l2.1699"></a><span id="l2.1699">   getCommandStateParams(aCommand, aParams, editorElement) {},</span>
<a href="#l2.1700"></a><span id="l2.1700">   doCommandParams(aCommand, aParams, editorElement) {},</span>
<a href="#l2.1701"></a><span id="l2.1701"> </span>
<a href="#l2.1702"></a><span id="l2.1702">   doCommand(aCommand, editorElement) {</span>
<a href="#l2.1703"></a><span id="l2.1703" class="difflineminus">-    window.openDialog(&quot;chrome://editor/content/EdReplace.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l2.1704"></a><span id="l2.1704" class="difflineminus">-                      &quot;chrome,modal,titlebar&quot;, editorElement);</span>
<a href="#l2.1705"></a><span id="l2.1705" class="difflineplus">+    window.openDialog(</span>
<a href="#l2.1706"></a><span id="l2.1706" class="difflineplus">+      &quot;chrome://editor/content/EdReplace.xul&quot;,</span>
<a href="#l2.1707"></a><span id="l2.1707" class="difflineplus">+      &quot;_blank&quot;,</span>
<a href="#l2.1708"></a><span id="l2.1708" class="difflineplus">+      &quot;chrome,modal,titlebar&quot;,</span>
<a href="#l2.1709"></a><span id="l2.1709" class="difflineplus">+      editorElement</span>
<a href="#l2.1710"></a><span id="l2.1710" class="difflineplus">+    );</span>
<a href="#l2.1711"></a><span id="l2.1711">   },</span>
<a href="#l2.1712"></a><span id="l2.1712"> };</span>
<a href="#l2.1713"></a><span id="l2.1713"> </span>
<a href="#l2.1714"></a><span id="l2.1714"> var nsFindCommand = {</span>
<a href="#l2.1715"></a><span id="l2.1715">   isCommandEnabled(aCommand, editorElement) {</span>
<a href="#l2.1716"></a><span id="l2.1716">     return editorElement.getEditor(editorElement.contentWindow) != null;</span>
<a href="#l2.1717"></a><span id="l2.1717">   },</span>
<a href="#l2.1718"></a><span id="l2.1718"> </span>
<a href="#l2.1719"></a><span id="l2.1719" class="difflineat">@@ -2082,50 +2369,64 @@ var nsFindAgainCommand = {</span>
<a href="#l2.1720"></a><span id="l2.1720">     // to get that from here</span>
<a href="#l2.1721"></a><span id="l2.1721">     return editorElement.getEditor(editorElement.contentWindow) != null;</span>
<a href="#l2.1722"></a><span id="l2.1722">   },</span>
<a href="#l2.1723"></a><span id="l2.1723"> </span>
<a href="#l2.1724"></a><span id="l2.1724">   getCommandStateParams(aCommand, aParams, editorElement) {},</span>
<a href="#l2.1725"></a><span id="l2.1725">   doCommandParams(aCommand, aParams, editorElement) {},</span>
<a href="#l2.1726"></a><span id="l2.1726"> </span>
<a href="#l2.1727"></a><span id="l2.1727">   doCommand(aCommand, editorElement) {</span>
<a href="#l2.1728"></a><span id="l2.1728" class="difflineminus">-    let findPrev = (aCommand == &quot;cmd_findPrev&quot;);</span>
<a href="#l2.1729"></a><span id="l2.1729" class="difflineplus">+    let findPrev = aCommand == &quot;cmd_findPrev&quot;;</span>
<a href="#l2.1730"></a><span id="l2.1730">     document.getElementById(&quot;FindToolbar&quot;).onFindAgainCommand(findPrev);</span>
<a href="#l2.1731"></a><span id="l2.1731">   },</span>
<a href="#l2.1732"></a><span id="l2.1732"> };</span>
<a href="#l2.1733"></a><span id="l2.1733"> </span>
<a href="#l2.1734"></a><span id="l2.1734"> var nsRewrapCommand = {</span>
<a href="#l2.1735"></a><span id="l2.1735">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.1736"></a><span id="l2.1736" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp; !IsInHTMLSourceMode() &amp;&amp;</span>
<a href="#l2.1737"></a><span id="l2.1737" class="difflineminus">-            GetCurrentEditor() instanceof Ci.nsIEditorMailSupport);</span>
<a href="#l2.1738"></a><span id="l2.1738" class="difflineplus">+    return (</span>
<a href="#l2.1739"></a><span id="l2.1739" class="difflineplus">+      IsDocumentEditable() &amp;&amp;</span>
<a href="#l2.1740"></a><span id="l2.1740" class="difflineplus">+      !IsInHTMLSourceMode() &amp;&amp;</span>
<a href="#l2.1741"></a><span id="l2.1741" class="difflineplus">+      GetCurrentEditor() instanceof Ci.nsIEditorMailSupport</span>
<a href="#l2.1742"></a><span id="l2.1742" class="difflineplus">+    );</span>
<a href="#l2.1743"></a><span id="l2.1743">   },</span>
<a href="#l2.1744"></a><span id="l2.1744"> </span>
<a href="#l2.1745"></a><span id="l2.1745">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.1746"></a><span id="l2.1746">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.1747"></a><span id="l2.1747"> </span>
<a href="#l2.1748"></a><span id="l2.1748">   doCommand(aCommand) {</span>
<a href="#l2.1749"></a><span id="l2.1749" class="difflineminus">-    GetCurrentEditor().QueryInterface(Ci.nsIEditorMailSupport).rewrap(false);</span>
<a href="#l2.1750"></a><span id="l2.1750" class="difflineplus">+    GetCurrentEditor()</span>
<a href="#l2.1751"></a><span id="l2.1751" class="difflineplus">+      .QueryInterface(Ci.nsIEditorMailSupport)</span>
<a href="#l2.1752"></a><span id="l2.1752" class="difflineplus">+      .rewrap(false);</span>
<a href="#l2.1753"></a><span id="l2.1753">   },</span>
<a href="#l2.1754"></a><span id="l2.1754"> };</span>
<a href="#l2.1755"></a><span id="l2.1755"> </span>
<a href="#l2.1756"></a><span id="l2.1756"> var nsSpellingCommand = {</span>
<a href="#l2.1757"></a><span id="l2.1757">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.1758"></a><span id="l2.1758" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp;</span>
<a href="#l2.1759"></a><span id="l2.1759" class="difflineminus">-            !IsInHTMLSourceMode() &amp;&amp; IsSpellCheckerInstalled());</span>
<a href="#l2.1760"></a><span id="l2.1760" class="difflineplus">+    return (</span>
<a href="#l2.1761"></a><span id="l2.1761" class="difflineplus">+      IsDocumentEditable() &amp;&amp; !IsInHTMLSourceMode() &amp;&amp; IsSpellCheckerInstalled()</span>
<a href="#l2.1762"></a><span id="l2.1762" class="difflineplus">+    );</span>
<a href="#l2.1763"></a><span id="l2.1763">   },</span>
<a href="#l2.1764"></a><span id="l2.1764"> </span>
<a href="#l2.1765"></a><span id="l2.1765">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.1766"></a><span id="l2.1766">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.1767"></a><span id="l2.1767"> </span>
<a href="#l2.1768"></a><span id="l2.1768">   doCommand(aCommand) {</span>
<a href="#l2.1769"></a><span id="l2.1769">     window.cancelSendMessage = false;</span>
<a href="#l2.1770"></a><span id="l2.1770">     try {</span>
<a href="#l2.1771"></a><span id="l2.1771" class="difflineminus">-      var skipBlockQuotes = (window.document.documentElement.getAttribute(&quot;windowtype&quot;) == &quot;msgcompose&quot;);</span>
<a href="#l2.1772"></a><span id="l2.1772" class="difflineminus">-      window.openDialog(&quot;chrome://editor/content/EdSpellCheck.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l2.1773"></a><span id="l2.1773" class="difflineminus">-              &quot;dialog,close,titlebar,modal,resizable&quot;, false, skipBlockQuotes, true);</span>
<a href="#l2.1774"></a><span id="l2.1774" class="difflineplus">+      var skipBlockQuotes =</span>
<a href="#l2.1775"></a><span id="l2.1775" class="difflineplus">+        window.document.documentElement.getAttribute(&quot;windowtype&quot;) ==</span>
<a href="#l2.1776"></a><span id="l2.1776" class="difflineplus">+        &quot;msgcompose&quot;;</span>
<a href="#l2.1777"></a><span id="l2.1777" class="difflineplus">+      window.openDialog(</span>
<a href="#l2.1778"></a><span id="l2.1778" class="difflineplus">+        &quot;chrome://editor/content/EdSpellCheck.xul&quot;,</span>
<a href="#l2.1779"></a><span id="l2.1779" class="difflineplus">+        &quot;_blank&quot;,</span>
<a href="#l2.1780"></a><span id="l2.1780" class="difflineplus">+        &quot;dialog,close,titlebar,modal,resizable&quot;,</span>
<a href="#l2.1781"></a><span id="l2.1781" class="difflineplus">+        false,</span>
<a href="#l2.1782"></a><span id="l2.1782" class="difflineplus">+        skipBlockQuotes,</span>
<a href="#l2.1783"></a><span id="l2.1783" class="difflineplus">+        true</span>
<a href="#l2.1784"></a><span id="l2.1784" class="difflineplus">+      );</span>
<a href="#l2.1785"></a><span id="l2.1785">     } catch (ex) {}</span>
<a href="#l2.1786"></a><span id="l2.1786">   },</span>
<a href="#l2.1787"></a><span id="l2.1787"> };</span>
<a href="#l2.1788"></a><span id="l2.1788"> </span>
<a href="#l2.1789"></a><span id="l2.1789"> // Validate using http://validator.w3.org/file-upload.html</span>
<a href="#l2.1790"></a><span id="l2.1790"> var URL2Validate;</span>
<a href="#l2.1791"></a><span id="l2.1791"> var nsValidateCommand = {</span>
<a href="#l2.1792"></a><span id="l2.1792">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.1793"></a><span id="l2.1793" class="difflineat">@@ -2134,204 +2435,259 @@ var nsValidateCommand = {</span>
<a href="#l2.1794"></a><span id="l2.1794"> </span>
<a href="#l2.1795"></a><span id="l2.1795">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.1796"></a><span id="l2.1796">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.1797"></a><span id="l2.1797"> </span>
<a href="#l2.1798"></a><span id="l2.1798">   async doCommand(aCommand) {</span>
<a href="#l2.1799"></a><span id="l2.1799">     // If the document hasn't been modified,</span>
<a href="#l2.1800"></a><span id="l2.1800">     // then just validate the current url.</span>
<a href="#l2.1801"></a><span id="l2.1801">     if (IsDocumentModified() || IsHTMLSourceChanged()) {</span>
<a href="#l2.1802"></a><span id="l2.1802" class="difflineminus">-      if (!(await CheckAndSaveDocument(&quot;cmd_validate&quot;, false)))</span>
<a href="#l2.1803"></a><span id="l2.1803" class="difflineplus">+      if (!(await CheckAndSaveDocument(&quot;cmd_validate&quot;, false))) {</span>
<a href="#l2.1804"></a><span id="l2.1804">         return;</span>
<a href="#l2.1805"></a><span id="l2.1805" class="difflineplus">+      }</span>
<a href="#l2.1806"></a><span id="l2.1806"> </span>
<a href="#l2.1807"></a><span id="l2.1807">       // Check if we saved again just in case?</span>
<a href="#l2.1808"></a><span id="l2.1808" class="difflineminus">-      if (!DocumentHasBeenSaved())    // user hit cancel?</span>
<a href="#l2.1809"></a><span id="l2.1809" class="difflineplus">+      if (!DocumentHasBeenSaved()) {</span>
<a href="#l2.1810"></a><span id="l2.1810" class="difflineplus">+        // user hit cancel?</span>
<a href="#l2.1811"></a><span id="l2.1811">         return;</span>
<a href="#l2.1812"></a><span id="l2.1812" class="difflineplus">+      }</span>
<a href="#l2.1813"></a><span id="l2.1813">     }</span>
<a href="#l2.1814"></a><span id="l2.1814"> </span>
<a href="#l2.1815"></a><span id="l2.1815">     URL2Validate = GetDocumentUrl();</span>
<a href="#l2.1816"></a><span id="l2.1816">     // See if it's a file:</span>
<a href="#l2.1817"></a><span id="l2.1817">     var ifile;</span>
<a href="#l2.1818"></a><span id="l2.1818">     try {</span>
<a href="#l2.1819"></a><span id="l2.1819">       var fileHandler = GetFileProtocolHandler();</span>
<a href="#l2.1820"></a><span id="l2.1820">       ifile = fileHandler.getFileFromURLSpec(URL2Validate);</span>
<a href="#l2.1821"></a><span id="l2.1821">       // nsIFile throws an exception if it's not a file url</span>
<a href="#l2.1822"></a><span id="l2.1822">     } catch (e) {</span>
<a href="#l2.1823"></a><span id="l2.1823">       ifile = null;</span>
<a href="#l2.1824"></a><span id="l2.1824">     }</span>
<a href="#l2.1825"></a><span id="l2.1825">     if (ifile) {</span>
<a href="#l2.1826"></a><span id="l2.1826">       URL2Validate = ifile.path;</span>
<a href="#l2.1827"></a><span id="l2.1827" class="difflineminus">-      var vwin = window.open(&quot;http://validator.w3.org/file-upload.html&quot;,</span>
<a href="#l2.1828"></a><span id="l2.1828" class="difflineminus">-                             &quot;EditorValidate&quot;);</span>
<a href="#l2.1829"></a><span id="l2.1829" class="difflineplus">+      var vwin = window.open(</span>
<a href="#l2.1830"></a><span id="l2.1830" class="difflineplus">+        &quot;http://validator.w3.org/file-upload.html&quot;,</span>
<a href="#l2.1831"></a><span id="l2.1831" class="difflineplus">+        &quot;EditorValidate&quot;</span>
<a href="#l2.1832"></a><span id="l2.1832" class="difflineplus">+      );</span>
<a href="#l2.1833"></a><span id="l2.1833">       // Window loads asynchronously, so pass control to the load listener:</span>
<a href="#l2.1834"></a><span id="l2.1834">       vwin.addEventListener(&quot;load&quot;, this.validateFilePageLoaded);</span>
<a href="#l2.1835"></a><span id="l2.1835">     } else {</span>
<a href="#l2.1836"></a><span id="l2.1836" class="difflineminus">-      window.open(`http://validator.w3.org/check?uri=${URL2Validate}&amp;doctype=Inline`,</span>
<a href="#l2.1837"></a><span id="l2.1837" class="difflineminus">-                  &quot;EditorValidate&quot;);</span>
<a href="#l2.1838"></a><span id="l2.1838" class="difflineplus">+      window.open(</span>
<a href="#l2.1839"></a><span id="l2.1839" class="difflineplus">+        `http://validator.w3.org/check?uri=${URL2Validate}&amp;doctype=Inline`,</span>
<a href="#l2.1840"></a><span id="l2.1840" class="difflineplus">+        &quot;EditorValidate&quot;</span>
<a href="#l2.1841"></a><span id="l2.1841" class="difflineplus">+      );</span>
<a href="#l2.1842"></a><span id="l2.1842">       // This does the validation, no need to wait for page loaded.</span>
<a href="#l2.1843"></a><span id="l2.1843">     }</span>
<a href="#l2.1844"></a><span id="l2.1844">   },</span>
<a href="#l2.1845"></a><span id="l2.1845">   validateFilePageLoaded(event) {</span>
<a href="#l2.1846"></a><span id="l2.1846">     event.target.forms[0].uploaded_file.value = URL2Validate;</span>
<a href="#l2.1847"></a><span id="l2.1847">   },</span>
<a href="#l2.1848"></a><span id="l2.1848"> };</span>
<a href="#l2.1849"></a><span id="l2.1849"> </span>
<a href="#l2.1850"></a><span id="l2.1850"> var nsFormCommand = {</span>
<a href="#l2.1851"></a><span id="l2.1851">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.1852"></a><span id="l2.1852" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.1853"></a><span id="l2.1853" class="difflineplus">+    return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l2.1854"></a><span id="l2.1854">   },</span>
<a href="#l2.1855"></a><span id="l2.1855"> </span>
<a href="#l2.1856"></a><span id="l2.1856">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.1857"></a><span id="l2.1857">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.1858"></a><span id="l2.1858"> </span>
<a href="#l2.1859"></a><span id="l2.1859">   doCommand(aCommand) {</span>
<a href="#l2.1860"></a><span id="l2.1860" class="difflineminus">-    window.openDialog(&quot;chrome://editor/content/EdFormProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.1861"></a><span id="l2.1861" class="difflineplus">+    window.openDialog(</span>
<a href="#l2.1862"></a><span id="l2.1862" class="difflineplus">+      &quot;chrome://editor/content/EdFormProps.xul&quot;,</span>
<a href="#l2.1863"></a><span id="l2.1863" class="difflineplus">+      &quot;_blank&quot;,</span>
<a href="#l2.1864"></a><span id="l2.1864" class="difflineplus">+      &quot;chrome,close,titlebar,modal&quot;</span>
<a href="#l2.1865"></a><span id="l2.1865" class="difflineplus">+    );</span>
<a href="#l2.1866"></a><span id="l2.1866">   },</span>
<a href="#l2.1867"></a><span id="l2.1867"> };</span>
<a href="#l2.1868"></a><span id="l2.1868"> </span>
<a href="#l2.1869"></a><span id="l2.1869"> var nsInputTagCommand = {</span>
<a href="#l2.1870"></a><span id="l2.1870">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.1871"></a><span id="l2.1871" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.1872"></a><span id="l2.1872" class="difflineplus">+    return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l2.1873"></a><span id="l2.1873">   },</span>
<a href="#l2.1874"></a><span id="l2.1874"> </span>
<a href="#l2.1875"></a><span id="l2.1875">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.1876"></a><span id="l2.1876">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.1877"></a><span id="l2.1877"> </span>
<a href="#l2.1878"></a><span id="l2.1878">   doCommand(aCommand) {</span>
<a href="#l2.1879"></a><span id="l2.1879" class="difflineminus">-    window.openDialog(&quot;chrome://editor/content/EdInputProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.1880"></a><span id="l2.1880" class="difflineplus">+    window.openDialog(</span>
<a href="#l2.1881"></a><span id="l2.1881" class="difflineplus">+      &quot;chrome://editor/content/EdInputProps.xul&quot;,</span>
<a href="#l2.1882"></a><span id="l2.1882" class="difflineplus">+      &quot;_blank&quot;,</span>
<a href="#l2.1883"></a><span id="l2.1883" class="difflineplus">+      &quot;chrome,close,titlebar,modal&quot;</span>
<a href="#l2.1884"></a><span id="l2.1884" class="difflineplus">+    );</span>
<a href="#l2.1885"></a><span id="l2.1885">   },</span>
<a href="#l2.1886"></a><span id="l2.1886"> };</span>
<a href="#l2.1887"></a><span id="l2.1887"> </span>
<a href="#l2.1888"></a><span id="l2.1888"> var nsInputImageCommand = {</span>
<a href="#l2.1889"></a><span id="l2.1889">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.1890"></a><span id="l2.1890" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.1891"></a><span id="l2.1891" class="difflineplus">+    return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l2.1892"></a><span id="l2.1892">   },</span>
<a href="#l2.1893"></a><span id="l2.1893"> </span>
<a href="#l2.1894"></a><span id="l2.1894">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.1895"></a><span id="l2.1895">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.1896"></a><span id="l2.1896"> </span>
<a href="#l2.1897"></a><span id="l2.1897">   doCommand(aCommand) {</span>
<a href="#l2.1898"></a><span id="l2.1898" class="difflineminus">-    window.openDialog(&quot;chrome://editor/content/EdInputImage.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.1899"></a><span id="l2.1899" class="difflineplus">+    window.openDialog(</span>
<a href="#l2.1900"></a><span id="l2.1900" class="difflineplus">+      &quot;chrome://editor/content/EdInputImage.xul&quot;,</span>
<a href="#l2.1901"></a><span id="l2.1901" class="difflineplus">+      &quot;_blank&quot;,</span>
<a href="#l2.1902"></a><span id="l2.1902" class="difflineplus">+      &quot;chrome,close,titlebar,modal&quot;</span>
<a href="#l2.1903"></a><span id="l2.1903" class="difflineplus">+    );</span>
<a href="#l2.1904"></a><span id="l2.1904">   },</span>
<a href="#l2.1905"></a><span id="l2.1905"> };</span>
<a href="#l2.1906"></a><span id="l2.1906"> </span>
<a href="#l2.1907"></a><span id="l2.1907"> var nsTextAreaCommand = {</span>
<a href="#l2.1908"></a><span id="l2.1908">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.1909"></a><span id="l2.1909" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.1910"></a><span id="l2.1910" class="difflineplus">+    return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l2.1911"></a><span id="l2.1911">   },</span>
<a href="#l2.1912"></a><span id="l2.1912"> </span>
<a href="#l2.1913"></a><span id="l2.1913">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.1914"></a><span id="l2.1914">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.1915"></a><span id="l2.1915"> </span>
<a href="#l2.1916"></a><span id="l2.1916">   doCommand(aCommand) {</span>
<a href="#l2.1917"></a><span id="l2.1917" class="difflineminus">-    window.openDialog(&quot;chrome://editor/content/EdTextAreaProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.1918"></a><span id="l2.1918" class="difflineplus">+    window.openDialog(</span>
<a href="#l2.1919"></a><span id="l2.1919" class="difflineplus">+      &quot;chrome://editor/content/EdTextAreaProps.xul&quot;,</span>
<a href="#l2.1920"></a><span id="l2.1920" class="difflineplus">+      &quot;_blank&quot;,</span>
<a href="#l2.1921"></a><span id="l2.1921" class="difflineplus">+      &quot;chrome,close,titlebar,modal&quot;</span>
<a href="#l2.1922"></a><span id="l2.1922" class="difflineplus">+    );</span>
<a href="#l2.1923"></a><span id="l2.1923">   },</span>
<a href="#l2.1924"></a><span id="l2.1924"> };</span>
<a href="#l2.1925"></a><span id="l2.1925"> </span>
<a href="#l2.1926"></a><span id="l2.1926"> var nsSelectCommand = {</span>
<a href="#l2.1927"></a><span id="l2.1927">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.1928"></a><span id="l2.1928" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.1929"></a><span id="l2.1929" class="difflineplus">+    return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l2.1930"></a><span id="l2.1930">   },</span>
<a href="#l2.1931"></a><span id="l2.1931"> </span>
<a href="#l2.1932"></a><span id="l2.1932">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.1933"></a><span id="l2.1933">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.1934"></a><span id="l2.1934"> </span>
<a href="#l2.1935"></a><span id="l2.1935">   doCommand(aCommand) {</span>
<a href="#l2.1936"></a><span id="l2.1936" class="difflineminus">-    window.openDialog(&quot;chrome://editor/content/EdSelectProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.1937"></a><span id="l2.1937" class="difflineplus">+    window.openDialog(</span>
<a href="#l2.1938"></a><span id="l2.1938" class="difflineplus">+      &quot;chrome://editor/content/EdSelectProps.xul&quot;,</span>
<a href="#l2.1939"></a><span id="l2.1939" class="difflineplus">+      &quot;_blank&quot;,</span>
<a href="#l2.1940"></a><span id="l2.1940" class="difflineplus">+      &quot;chrome,close,titlebar,modal&quot;</span>
<a href="#l2.1941"></a><span id="l2.1941" class="difflineplus">+    );</span>
<a href="#l2.1942"></a><span id="l2.1942">   },</span>
<a href="#l2.1943"></a><span id="l2.1943"> };</span>
<a href="#l2.1944"></a><span id="l2.1944"> </span>
<a href="#l2.1945"></a><span id="l2.1945"> var nsButtonCommand = {</span>
<a href="#l2.1946"></a><span id="l2.1946">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.1947"></a><span id="l2.1947" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.1948"></a><span id="l2.1948" class="difflineplus">+    return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l2.1949"></a><span id="l2.1949">   },</span>
<a href="#l2.1950"></a><span id="l2.1950"> </span>
<a href="#l2.1951"></a><span id="l2.1951">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.1952"></a><span id="l2.1952">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.1953"></a><span id="l2.1953"> </span>
<a href="#l2.1954"></a><span id="l2.1954">   doCommand(aCommand) {</span>
<a href="#l2.1955"></a><span id="l2.1955" class="difflineminus">-    window.openDialog(&quot;chrome://editor/content/EdButtonProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.1956"></a><span id="l2.1956" class="difflineplus">+    window.openDialog(</span>
<a href="#l2.1957"></a><span id="l2.1957" class="difflineplus">+      &quot;chrome://editor/content/EdButtonProps.xul&quot;,</span>
<a href="#l2.1958"></a><span id="l2.1958" class="difflineplus">+      &quot;_blank&quot;,</span>
<a href="#l2.1959"></a><span id="l2.1959" class="difflineplus">+      &quot;chrome,close,titlebar,modal&quot;</span>
<a href="#l2.1960"></a><span id="l2.1960" class="difflineplus">+    );</span>
<a href="#l2.1961"></a><span id="l2.1961">   },</span>
<a href="#l2.1962"></a><span id="l2.1962"> };</span>
<a href="#l2.1963"></a><span id="l2.1963"> </span>
<a href="#l2.1964"></a><span id="l2.1964"> var nsLabelCommand = {</span>
<a href="#l2.1965"></a><span id="l2.1965">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.1966"></a><span id="l2.1966" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.1967"></a><span id="l2.1967" class="difflineplus">+    return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l2.1968"></a><span id="l2.1968">   },</span>
<a href="#l2.1969"></a><span id="l2.1969"> </span>
<a href="#l2.1970"></a><span id="l2.1970">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.1971"></a><span id="l2.1971">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.1972"></a><span id="l2.1972"> </span>
<a href="#l2.1973"></a><span id="l2.1973">   doCommand(aCommand) {</span>
<a href="#l2.1974"></a><span id="l2.1974">     var tagName = &quot;label&quot;;</span>
<a href="#l2.1975"></a><span id="l2.1975">     try {</span>
<a href="#l2.1976"></a><span id="l2.1976">       var editor = GetCurrentEditor();</span>
<a href="#l2.1977"></a><span id="l2.1977">       // Find selected label or if start/end of selection is in label</span>
<a href="#l2.1978"></a><span id="l2.1978">       var labelElement = editor.getSelectedElement(tagName);</span>
<a href="#l2.1979"></a><span id="l2.1979" class="difflineminus">-      if (!labelElement)</span>
<a href="#l2.1980"></a><span id="l2.1980" class="difflineminus">-        labelElement = editor.getElementOrParentByTagName(tagName, editor.selection.anchorNode);</span>
<a href="#l2.1981"></a><span id="l2.1981" class="difflineminus">-      if (!labelElement)</span>
<a href="#l2.1982"></a><span id="l2.1982" class="difflineminus">-        labelElement = editor.getElementOrParentByTagName(tagName, editor.selection.focusNode);</span>
<a href="#l2.1983"></a><span id="l2.1983" class="difflineplus">+      if (!labelElement) {</span>
<a href="#l2.1984"></a><span id="l2.1984" class="difflineplus">+        labelElement = editor.getElementOrParentByTagName(</span>
<a href="#l2.1985"></a><span id="l2.1985" class="difflineplus">+          tagName,</span>
<a href="#l2.1986"></a><span id="l2.1986" class="difflineplus">+          editor.selection.anchorNode</span>
<a href="#l2.1987"></a><span id="l2.1987" class="difflineplus">+        );</span>
<a href="#l2.1988"></a><span id="l2.1988" class="difflineplus">+      }</span>
<a href="#l2.1989"></a><span id="l2.1989" class="difflineplus">+      if (!labelElement) {</span>
<a href="#l2.1990"></a><span id="l2.1990" class="difflineplus">+        labelElement = editor.getElementOrParentByTagName(</span>
<a href="#l2.1991"></a><span id="l2.1991" class="difflineplus">+          tagName,</span>
<a href="#l2.1992"></a><span id="l2.1992" class="difflineplus">+          editor.selection.focusNode</span>
<a href="#l2.1993"></a><span id="l2.1993" class="difflineplus">+        );</span>
<a href="#l2.1994"></a><span id="l2.1994" class="difflineplus">+      }</span>
<a href="#l2.1995"></a><span id="l2.1995">       if (labelElement) {</span>
<a href="#l2.1996"></a><span id="l2.1996">         // We only open the dialog for an existing label</span>
<a href="#l2.1997"></a><span id="l2.1997" class="difflineminus">-        window.openDialog(&quot;chrome://editor/content/EdLabelProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, labelElement);</span>
<a href="#l2.1998"></a><span id="l2.1998" class="difflineplus">+        window.openDialog(</span>
<a href="#l2.1999"></a><span id="l2.1999" class="difflineplus">+          &quot;chrome://editor/content/EdLabelProps.xul&quot;,</span>
<a href="#l2.2000"></a><span id="l2.2000" class="difflineplus">+          &quot;_blank&quot;,</span>
<a href="#l2.2001"></a><span id="l2.2001" class="difflineplus">+          &quot;chrome,close,titlebar,modal&quot;,</span>
<a href="#l2.2002"></a><span id="l2.2002" class="difflineplus">+          labelElement</span>
<a href="#l2.2003"></a><span id="l2.2003" class="difflineplus">+        );</span>
<a href="#l2.2004"></a><span id="l2.2004">       } else {</span>
<a href="#l2.2005"></a><span id="l2.2005">         EditorSetTextProperty(tagName, &quot;&quot;, &quot;&quot;);</span>
<a href="#l2.2006"></a><span id="l2.2006">       }</span>
<a href="#l2.2007"></a><span id="l2.2007">     } catch (e) {}</span>
<a href="#l2.2008"></a><span id="l2.2008">   },</span>
<a href="#l2.2009"></a><span id="l2.2009"> };</span>
<a href="#l2.2010"></a><span id="l2.2010"> </span>
<a href="#l2.2011"></a><span id="l2.2011"> var nsFieldSetCommand = {</span>
<a href="#l2.2012"></a><span id="l2.2012">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2013"></a><span id="l2.2013" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.2014"></a><span id="l2.2014" class="difflineplus">+    return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l2.2015"></a><span id="l2.2015">   },</span>
<a href="#l2.2016"></a><span id="l2.2016"> </span>
<a href="#l2.2017"></a><span id="l2.2017">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2018"></a><span id="l2.2018">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2019"></a><span id="l2.2019"> </span>
<a href="#l2.2020"></a><span id="l2.2020">   doCommand(aCommand) {</span>
<a href="#l2.2021"></a><span id="l2.2021" class="difflineminus">-    window.openDialog(&quot;chrome://editor/content/EdFieldSetProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.2022"></a><span id="l2.2022" class="difflineplus">+    window.openDialog(</span>
<a href="#l2.2023"></a><span id="l2.2023" class="difflineplus">+      &quot;chrome://editor/content/EdFieldSetProps.xul&quot;,</span>
<a href="#l2.2024"></a><span id="l2.2024" class="difflineplus">+      &quot;_blank&quot;,</span>
<a href="#l2.2025"></a><span id="l2.2025" class="difflineplus">+      &quot;chrome,close,titlebar,modal&quot;</span>
<a href="#l2.2026"></a><span id="l2.2026" class="difflineplus">+    );</span>
<a href="#l2.2027"></a><span id="l2.2027">   },</span>
<a href="#l2.2028"></a><span id="l2.2028"> };</span>
<a href="#l2.2029"></a><span id="l2.2029"> </span>
<a href="#l2.2030"></a><span id="l2.2030"> var nsIsIndexCommand = {</span>
<a href="#l2.2031"></a><span id="l2.2031">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2032"></a><span id="l2.2032" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.2033"></a><span id="l2.2033" class="difflineplus">+    return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l2.2034"></a><span id="l2.2034">   },</span>
<a href="#l2.2035"></a><span id="l2.2035"> </span>
<a href="#l2.2036"></a><span id="l2.2036">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2037"></a><span id="l2.2037">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2038"></a><span id="l2.2038"> </span>
<a href="#l2.2039"></a><span id="l2.2039">   doCommand(aCommand) {</span>
<a href="#l2.2040"></a><span id="l2.2040">     try {</span>
<a href="#l2.2041"></a><span id="l2.2041">       var editor = GetCurrentEditor();</span>
<a href="#l2.2042"></a><span id="l2.2042">       var isindexElement = editor.createElementWithDefaults(&quot;isindex&quot;);</span>
<a href="#l2.2043"></a><span id="l2.2043" class="difflineminus">-      isindexElement.setAttribute(&quot;prompt&quot;, editor.outputToString(&quot;text/plain&quot;, kOutputSelectionOnly));</span>
<a href="#l2.2044"></a><span id="l2.2044" class="difflineplus">+      isindexElement.setAttribute(</span>
<a href="#l2.2045"></a><span id="l2.2045" class="difflineplus">+        &quot;prompt&quot;,</span>
<a href="#l2.2046"></a><span id="l2.2046" class="difflineplus">+        editor.outputToString(&quot;text/plain&quot;, kOutputSelectionOnly)</span>
<a href="#l2.2047"></a><span id="l2.2047" class="difflineplus">+      );</span>
<a href="#l2.2048"></a><span id="l2.2048">       editor.insertElementAtSelection(isindexElement, true);</span>
<a href="#l2.2049"></a><span id="l2.2049">     } catch (e) {}</span>
<a href="#l2.2050"></a><span id="l2.2050">   },</span>
<a href="#l2.2051"></a><span id="l2.2051"> };</span>
<a href="#l2.2052"></a><span id="l2.2052"> </span>
<a href="#l2.2053"></a><span id="l2.2053"> var nsImageCommand = {</span>
<a href="#l2.2054"></a><span id="l2.2054">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2055"></a><span id="l2.2055" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.2056"></a><span id="l2.2056" class="difflineplus">+    return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l2.2057"></a><span id="l2.2057">   },</span>
<a href="#l2.2058"></a><span id="l2.2058"> </span>
<a href="#l2.2059"></a><span id="l2.2059">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2060"></a><span id="l2.2060">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2061"></a><span id="l2.2061"> </span>
<a href="#l2.2062"></a><span id="l2.2062">   doCommand(aCommand) {</span>
<a href="#l2.2063"></a><span id="l2.2063" class="difflineminus">-    window.openDialog(&quot;chrome://editor/content/EdImageProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.2064"></a><span id="l2.2064" class="difflineplus">+    window.openDialog(</span>
<a href="#l2.2065"></a><span id="l2.2065" class="difflineplus">+      &quot;chrome://editor/content/EdImageProps.xul&quot;,</span>
<a href="#l2.2066"></a><span id="l2.2066" class="difflineplus">+      &quot;_blank&quot;,</span>
<a href="#l2.2067"></a><span id="l2.2067" class="difflineplus">+      &quot;chrome,close,titlebar,modal&quot;</span>
<a href="#l2.2068"></a><span id="l2.2068" class="difflineplus">+    );</span>
<a href="#l2.2069"></a><span id="l2.2069">   },</span>
<a href="#l2.2070"></a><span id="l2.2070"> };</span>
<a href="#l2.2071"></a><span id="l2.2071"> </span>
<a href="#l2.2072"></a><span id="l2.2072"> var nsHLineCommand = {</span>
<a href="#l2.2073"></a><span id="l2.2073">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2074"></a><span id="l2.2074" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.2075"></a><span id="l2.2075" class="difflineplus">+    return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l2.2076"></a><span id="l2.2076">   },</span>
<a href="#l2.2077"></a><span id="l2.2077"> </span>
<a href="#l2.2078"></a><span id="l2.2078">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2079"></a><span id="l2.2079">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2080"></a><span id="l2.2080"> </span>
<a href="#l2.2081"></a><span id="l2.2081">   doCommand(aCommand) {</span>
<a href="#l2.2082"></a><span id="l2.2082">     // Inserting an HLine is different in that we don't use properties dialog</span>
<a href="#l2.2083"></a><span id="l2.2083">     //  unless we are editing an existing line's attributes</span>
<a href="#l2.2084"></a><span id="l2.2084" class="difflineat">@@ -2344,202 +2700,250 @@ var nsHLineCommand = {</span>
<a href="#l2.2085"></a><span id="l2.2085">     try {</span>
<a href="#l2.2086"></a><span id="l2.2086">       hLine = editor.getSelectedElement(tagName);</span>
<a href="#l2.2087"></a><span id="l2.2087">     } catch (e) {</span>
<a href="#l2.2088"></a><span id="l2.2088">       return;</span>
<a href="#l2.2089"></a><span id="l2.2089">     }</span>
<a href="#l2.2090"></a><span id="l2.2090"> </span>
<a href="#l2.2091"></a><span id="l2.2091">     if (hLine) {</span>
<a href="#l2.2092"></a><span id="l2.2092">       // We only open the dialog for an existing HRule</span>
<a href="#l2.2093"></a><span id="l2.2093" class="difflineminus">-      window.openDialog(&quot;chrome://editor/content/EdHLineProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.2094"></a><span id="l2.2094" class="difflineplus">+      window.openDialog(</span>
<a href="#l2.2095"></a><span id="l2.2095" class="difflineplus">+        &quot;chrome://editor/content/EdHLineProps.xul&quot;,</span>
<a href="#l2.2096"></a><span id="l2.2096" class="difflineplus">+        &quot;_blank&quot;,</span>
<a href="#l2.2097"></a><span id="l2.2097" class="difflineplus">+        &quot;chrome,close,titlebar,modal&quot;</span>
<a href="#l2.2098"></a><span id="l2.2098" class="difflineplus">+      );</span>
<a href="#l2.2099"></a><span id="l2.2099">     } else {</span>
<a href="#l2.2100"></a><span id="l2.2100">       try {</span>
<a href="#l2.2101"></a><span id="l2.2101">         hLine = editor.createElementWithDefaults(tagName);</span>
<a href="#l2.2102"></a><span id="l2.2102"> </span>
<a href="#l2.2103"></a><span id="l2.2103">         // We change the default attributes to those saved in the user prefs</span>
<a href="#l2.2104"></a><span id="l2.2104">         let align = Services.prefs.getIntPref(&quot;editor.hrule.align&quot;);</span>
<a href="#l2.2105"></a><span id="l2.2105" class="difflineminus">-        if (align == 0)</span>
<a href="#l2.2106"></a><span id="l2.2106" class="difflineplus">+        if (align == 0) {</span>
<a href="#l2.2107"></a><span id="l2.2107">           editor.setAttributeOrEquivalent(hLine, &quot;align&quot;, &quot;left&quot;, true);</span>
<a href="#l2.2108"></a><span id="l2.2108" class="difflineminus">-        else if (align == 2)</span>
<a href="#l2.2109"></a><span id="l2.2109" class="difflineplus">+        } else if (align == 2) {</span>
<a href="#l2.2110"></a><span id="l2.2110">           editor.setAttributeOrEquivalent(hLine, &quot;align&quot;, &quot;right&quot;, true);</span>
<a href="#l2.2111"></a><span id="l2.2111" class="difflineplus">+        }</span>
<a href="#l2.2112"></a><span id="l2.2112"> </span>
<a href="#l2.2113"></a><span id="l2.2113">         // Note: Default is center (don't write attribute)</span>
<a href="#l2.2114"></a><span id="l2.2114"> </span>
<a href="#l2.2115"></a><span id="l2.2115">         let width = Services.prefs.getIntPref(&quot;editor.hrule.width&quot;);</span>
<a href="#l2.2116"></a><span id="l2.2116" class="difflineminus">-        if (Services.prefs.getBoolPref(&quot;editor.hrule.width_percent&quot;))</span>
<a href="#l2.2117"></a><span id="l2.2117" class="difflineplus">+        if (Services.prefs.getBoolPref(&quot;editor.hrule.width_percent&quot;)) {</span>
<a href="#l2.2118"></a><span id="l2.2118">           width = width + &quot;%&quot;;</span>
<a href="#l2.2119"></a><span id="l2.2119" class="difflineplus">+        }</span>
<a href="#l2.2120"></a><span id="l2.2120"> </span>
<a href="#l2.2121"></a><span id="l2.2121">         editor.setAttributeOrEquivalent(hLine, &quot;width&quot;, width, true);</span>
<a href="#l2.2122"></a><span id="l2.2122"> </span>
<a href="#l2.2123"></a><span id="l2.2123">         let height = Services.prefs.getIntPref(&quot;editor.hrule.height&quot;);</span>
<a href="#l2.2124"></a><span id="l2.2124">         editor.setAttributeOrEquivalent(hLine, &quot;size&quot;, String(height), true);</span>
<a href="#l2.2125"></a><span id="l2.2125"> </span>
<a href="#l2.2126"></a><span id="l2.2126" class="difflineminus">-        if (Services.prefs.getBoolPref(&quot;editor.hrule.shading&quot;))</span>
<a href="#l2.2127"></a><span id="l2.2127" class="difflineplus">+        if (Services.prefs.getBoolPref(&quot;editor.hrule.shading&quot;)) {</span>
<a href="#l2.2128"></a><span id="l2.2128">           hLine.removeAttribute(&quot;noshade&quot;);</span>
<a href="#l2.2129"></a><span id="l2.2129" class="difflineminus">-        else</span>
<a href="#l2.2130"></a><span id="l2.2130" class="difflineplus">+        } else {</span>
<a href="#l2.2131"></a><span id="l2.2131">           hLine.setAttribute(&quot;noshade&quot;, &quot;noshade&quot;);</span>
<a href="#l2.2132"></a><span id="l2.2132" class="difflineplus">+        }</span>
<a href="#l2.2133"></a><span id="l2.2133"> </span>
<a href="#l2.2134"></a><span id="l2.2134">         editor.insertElementAtSelection(hLine, true);</span>
<a href="#l2.2135"></a><span id="l2.2135">       } catch (e) {}</span>
<a href="#l2.2136"></a><span id="l2.2136">     }</span>
<a href="#l2.2137"></a><span id="l2.2137">   },</span>
<a href="#l2.2138"></a><span id="l2.2138"> };</span>
<a href="#l2.2139"></a><span id="l2.2139"> </span>
<a href="#l2.2140"></a><span id="l2.2140"> var nsLinkCommand = {</span>
<a href="#l2.2141"></a><span id="l2.2141">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2142"></a><span id="l2.2142" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.2143"></a><span id="l2.2143" class="difflineplus">+    return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l2.2144"></a><span id="l2.2144">   },</span>
<a href="#l2.2145"></a><span id="l2.2145"> </span>
<a href="#l2.2146"></a><span id="l2.2146">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2147"></a><span id="l2.2147">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2148"></a><span id="l2.2148"> </span>
<a href="#l2.2149"></a><span id="l2.2149">   doCommand(aCommand) {</span>
<a href="#l2.2150"></a><span id="l2.2150">     // If selected element is an image, launch that dialog instead</span>
<a href="#l2.2151"></a><span id="l2.2151">     // since last tab panel handles link around an image</span>
<a href="#l2.2152"></a><span id="l2.2152">     var element = GetObjectForProperties();</span>
<a href="#l2.2153"></a><span id="l2.2153" class="difflineminus">-    if (element &amp;&amp; element.nodeName.toLowerCase() == &quot;img&quot;)</span>
<a href="#l2.2154"></a><span id="l2.2154" class="difflineminus">-      window.openDialog(&quot;chrome://editor/content/EdImageProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, null, true);</span>
<a href="#l2.2155"></a><span id="l2.2155" class="difflineminus">-    else</span>
<a href="#l2.2156"></a><span id="l2.2156" class="difflineminus">-      window.openDialog(&quot;chrome://editor/content/EdLinkProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.2157"></a><span id="l2.2157" class="difflineplus">+    if (element &amp;&amp; element.nodeName.toLowerCase() == &quot;img&quot;) {</span>
<a href="#l2.2158"></a><span id="l2.2158" class="difflineplus">+      window.openDialog(</span>
<a href="#l2.2159"></a><span id="l2.2159" class="difflineplus">+        &quot;chrome://editor/content/EdImageProps.xul&quot;,</span>
<a href="#l2.2160"></a><span id="l2.2160" class="difflineplus">+        &quot;_blank&quot;,</span>
<a href="#l2.2161"></a><span id="l2.2161" class="difflineplus">+        &quot;chrome,close,titlebar,modal&quot;,</span>
<a href="#l2.2162"></a><span id="l2.2162" class="difflineplus">+        null,</span>
<a href="#l2.2163"></a><span id="l2.2163" class="difflineplus">+        true</span>
<a href="#l2.2164"></a><span id="l2.2164" class="difflineplus">+      );</span>
<a href="#l2.2165"></a><span id="l2.2165" class="difflineplus">+    } else {</span>
<a href="#l2.2166"></a><span id="l2.2166" class="difflineplus">+      window.openDialog(</span>
<a href="#l2.2167"></a><span id="l2.2167" class="difflineplus">+        &quot;chrome://editor/content/EdLinkProps.xul&quot;,</span>
<a href="#l2.2168"></a><span id="l2.2168" class="difflineplus">+        &quot;_blank&quot;,</span>
<a href="#l2.2169"></a><span id="l2.2169" class="difflineplus">+        &quot;chrome,close,titlebar,modal&quot;</span>
<a href="#l2.2170"></a><span id="l2.2170" class="difflineplus">+      );</span>
<a href="#l2.2171"></a><span id="l2.2171" class="difflineplus">+    }</span>
<a href="#l2.2172"></a><span id="l2.2172">   },</span>
<a href="#l2.2173"></a><span id="l2.2173"> };</span>
<a href="#l2.2174"></a><span id="l2.2174"> </span>
<a href="#l2.2175"></a><span id="l2.2175"> var nsAnchorCommand = {</span>
<a href="#l2.2176"></a><span id="l2.2176">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2177"></a><span id="l2.2177" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.2178"></a><span id="l2.2178" class="difflineplus">+    return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l2.2179"></a><span id="l2.2179">   },</span>
<a href="#l2.2180"></a><span id="l2.2180"> </span>
<a href="#l2.2181"></a><span id="l2.2181">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2182"></a><span id="l2.2182">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2183"></a><span id="l2.2183"> </span>
<a href="#l2.2184"></a><span id="l2.2184">   doCommand(aCommand) {</span>
<a href="#l2.2185"></a><span id="l2.2185" class="difflineminus">-    window.openDialog(&quot;chrome://editor/content/EdNamedAnchorProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, &quot;&quot;);</span>
<a href="#l2.2186"></a><span id="l2.2186" class="difflineplus">+    window.openDialog(</span>
<a href="#l2.2187"></a><span id="l2.2187" class="difflineplus">+      &quot;chrome://editor/content/EdNamedAnchorProps.xul&quot;,</span>
<a href="#l2.2188"></a><span id="l2.2188" class="difflineplus">+      &quot;_blank&quot;,</span>
<a href="#l2.2189"></a><span id="l2.2189" class="difflineplus">+      &quot;chrome,close,titlebar,modal&quot;,</span>
<a href="#l2.2190"></a><span id="l2.2190" class="difflineplus">+      &quot;&quot;</span>
<a href="#l2.2191"></a><span id="l2.2191" class="difflineplus">+    );</span>
<a href="#l2.2192"></a><span id="l2.2192">   },</span>
<a href="#l2.2193"></a><span id="l2.2193"> };</span>
<a href="#l2.2194"></a><span id="l2.2194"> </span>
<a href="#l2.2195"></a><span id="l2.2195"> var nsInsertHTMLWithDialogCommand = {</span>
<a href="#l2.2196"></a><span id="l2.2196">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2197"></a><span id="l2.2197" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.2198"></a><span id="l2.2198" class="difflineplus">+    return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l2.2199"></a><span id="l2.2199">   },</span>
<a href="#l2.2200"></a><span id="l2.2200"> </span>
<a href="#l2.2201"></a><span id="l2.2201">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2202"></a><span id="l2.2202">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2203"></a><span id="l2.2203"> </span>
<a href="#l2.2204"></a><span id="l2.2204">   doCommand(aCommand) {</span>
<a href="#l2.2205"></a><span id="l2.2205" class="difflineminus">-    window.openDialog(&quot;chrome://editor/content/EdInsSrc.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal,resizable&quot;, &quot;&quot;);</span>
<a href="#l2.2206"></a><span id="l2.2206" class="difflineplus">+    window.openDialog(</span>
<a href="#l2.2207"></a><span id="l2.2207" class="difflineplus">+      &quot;chrome://editor/content/EdInsSrc.xul&quot;,</span>
<a href="#l2.2208"></a><span id="l2.2208" class="difflineplus">+      &quot;_blank&quot;,</span>
<a href="#l2.2209"></a><span id="l2.2209" class="difflineplus">+      &quot;chrome,close,titlebar,modal,resizable&quot;,</span>
<a href="#l2.2210"></a><span id="l2.2210" class="difflineplus">+      &quot;&quot;</span>
<a href="#l2.2211"></a><span id="l2.2211" class="difflineplus">+    );</span>
<a href="#l2.2212"></a><span id="l2.2212">   },</span>
<a href="#l2.2213"></a><span id="l2.2213"> };</span>
<a href="#l2.2214"></a><span id="l2.2214"> </span>
<a href="#l2.2215"></a><span id="l2.2215"> var nsInsertMathWithDialogCommand = {</span>
<a href="#l2.2216"></a><span id="l2.2216">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2217"></a><span id="l2.2217" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.2218"></a><span id="l2.2218" class="difflineplus">+    return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l2.2219"></a><span id="l2.2219">   },</span>
<a href="#l2.2220"></a><span id="l2.2220"> </span>
<a href="#l2.2221"></a><span id="l2.2221">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2222"></a><span id="l2.2222">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2223"></a><span id="l2.2223"> </span>
<a href="#l2.2224"></a><span id="l2.2224">   doCommand(aCommand) {</span>
<a href="#l2.2225"></a><span id="l2.2225" class="difflineminus">-    window.openDialog(&quot;chrome://editor/content/EdInsertMath.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal,resizable&quot;, &quot;&quot;);</span>
<a href="#l2.2226"></a><span id="l2.2226" class="difflineplus">+    window.openDialog(</span>
<a href="#l2.2227"></a><span id="l2.2227" class="difflineplus">+      &quot;chrome://editor/content/EdInsertMath.xul&quot;,</span>
<a href="#l2.2228"></a><span id="l2.2228" class="difflineplus">+      &quot;_blank&quot;,</span>
<a href="#l2.2229"></a><span id="l2.2229" class="difflineplus">+      &quot;chrome,close,titlebar,modal,resizable&quot;,</span>
<a href="#l2.2230"></a><span id="l2.2230" class="difflineplus">+      &quot;&quot;</span>
<a href="#l2.2231"></a><span id="l2.2231" class="difflineplus">+    );</span>
<a href="#l2.2232"></a><span id="l2.2232">   },</span>
<a href="#l2.2233"></a><span id="l2.2233"> };</span>
<a href="#l2.2234"></a><span id="l2.2234"> </span>
<a href="#l2.2235"></a><span id="l2.2235"> var nsInsertCharsCommand = {</span>
<a href="#l2.2236"></a><span id="l2.2236">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2237"></a><span id="l2.2237" class="difflineminus">-    return (IsDocumentEditable());</span>
<a href="#l2.2238"></a><span id="l2.2238" class="difflineplus">+    return IsDocumentEditable();</span>
<a href="#l2.2239"></a><span id="l2.2239">   },</span>
<a href="#l2.2240"></a><span id="l2.2240"> </span>
<a href="#l2.2241"></a><span id="l2.2241">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2242"></a><span id="l2.2242">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2243"></a><span id="l2.2243"> </span>
<a href="#l2.2244"></a><span id="l2.2244">   doCommand(aCommand) {</span>
<a href="#l2.2245"></a><span id="l2.2245">     EditorFindOrCreateInsertCharWindow();</span>
<a href="#l2.2246"></a><span id="l2.2246">   },</span>
<a href="#l2.2247"></a><span id="l2.2247"> };</span>
<a href="#l2.2248"></a><span id="l2.2248"> </span>
<a href="#l2.2249"></a><span id="l2.2249"> var nsInsertBreakCommand = {</span>
<a href="#l2.2250"></a><span id="l2.2250">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2251"></a><span id="l2.2251" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.2252"></a><span id="l2.2252" class="difflineplus">+    return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l2.2253"></a><span id="l2.2253">   },</span>
<a href="#l2.2254"></a><span id="l2.2254"> </span>
<a href="#l2.2255"></a><span id="l2.2255">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2256"></a><span id="l2.2256">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2257"></a><span id="l2.2257"> </span>
<a href="#l2.2258"></a><span id="l2.2258">   doCommand(aCommand) {</span>
<a href="#l2.2259"></a><span id="l2.2259">     try {</span>
<a href="#l2.2260"></a><span id="l2.2260">       GetCurrentEditor().insertHTML(&quot;&lt;br&gt;&quot;);</span>
<a href="#l2.2261"></a><span id="l2.2261">     } catch (e) {}</span>
<a href="#l2.2262"></a><span id="l2.2262">   },</span>
<a href="#l2.2263"></a><span id="l2.2263"> };</span>
<a href="#l2.2264"></a><span id="l2.2264"> </span>
<a href="#l2.2265"></a><span id="l2.2265"> var nsInsertBreakAllCommand = {</span>
<a href="#l2.2266"></a><span id="l2.2266">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2267"></a><span id="l2.2267" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.2268"></a><span id="l2.2268" class="difflineplus">+    return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l2.2269"></a><span id="l2.2269">   },</span>
<a href="#l2.2270"></a><span id="l2.2270"> </span>
<a href="#l2.2271"></a><span id="l2.2271">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2272"></a><span id="l2.2272">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2273"></a><span id="l2.2273"> </span>
<a href="#l2.2274"></a><span id="l2.2274">   doCommand(aCommand) {</span>
<a href="#l2.2275"></a><span id="l2.2275">     try {</span>
<a href="#l2.2276"></a><span id="l2.2276">       GetCurrentEditor().insertHTML(&quot;&lt;br clear='all'&gt;&quot;);</span>
<a href="#l2.2277"></a><span id="l2.2277">     } catch (e) {}</span>
<a href="#l2.2278"></a><span id="l2.2278">   },</span>
<a href="#l2.2279"></a><span id="l2.2279"> };</span>
<a href="#l2.2280"></a><span id="l2.2280"> </span>
<a href="#l2.2281"></a><span id="l2.2281"> var nsGridCommand = {</span>
<a href="#l2.2282"></a><span id="l2.2282">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2283"></a><span id="l2.2283" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.2284"></a><span id="l2.2284" class="difflineplus">+    return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l2.2285"></a><span id="l2.2285">   },</span>
<a href="#l2.2286"></a><span id="l2.2286"> </span>
<a href="#l2.2287"></a><span id="l2.2287">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2288"></a><span id="l2.2288">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2289"></a><span id="l2.2289"> </span>
<a href="#l2.2290"></a><span id="l2.2290">   doCommand(aCommand) {</span>
<a href="#l2.2291"></a><span id="l2.2291" class="difflineminus">-    window.openDialog(&quot;chrome://editor/content/EdSnapToGrid.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.2292"></a><span id="l2.2292" class="difflineplus">+    window.openDialog(</span>
<a href="#l2.2293"></a><span id="l2.2293" class="difflineplus">+      &quot;chrome://editor/content/EdSnapToGrid.xul&quot;,</span>
<a href="#l2.2294"></a><span id="l2.2294" class="difflineplus">+      &quot;_blank&quot;,</span>
<a href="#l2.2295"></a><span id="l2.2295" class="difflineplus">+      &quot;chrome,close,titlebar,modal&quot;</span>
<a href="#l2.2296"></a><span id="l2.2296" class="difflineplus">+    );</span>
<a href="#l2.2297"></a><span id="l2.2297">   },</span>
<a href="#l2.2298"></a><span id="l2.2298"> };</span>
<a href="#l2.2299"></a><span id="l2.2299"> </span>
<a href="#l2.2300"></a><span id="l2.2300"> var nsListPropertiesCommand = {</span>
<a href="#l2.2301"></a><span id="l2.2301">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2302"></a><span id="l2.2302" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.2303"></a><span id="l2.2303" class="difflineplus">+    return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l2.2304"></a><span id="l2.2304">   },</span>
<a href="#l2.2305"></a><span id="l2.2305"> </span>
<a href="#l2.2306"></a><span id="l2.2306">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2307"></a><span id="l2.2307">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2308"></a><span id="l2.2308"> </span>
<a href="#l2.2309"></a><span id="l2.2309">   doCommand(aCommand) {</span>
<a href="#l2.2310"></a><span id="l2.2310" class="difflineminus">-    window.openDialog(&quot;chrome://editor/content/EdListProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.2311"></a><span id="l2.2311" class="difflineplus">+    window.openDialog(</span>
<a href="#l2.2312"></a><span id="l2.2312" class="difflineplus">+      &quot;chrome://editor/content/EdListProps.xul&quot;,</span>
<a href="#l2.2313"></a><span id="l2.2313" class="difflineplus">+      &quot;_blank&quot;,</span>
<a href="#l2.2314"></a><span id="l2.2314" class="difflineplus">+      &quot;chrome,close,titlebar,modal&quot;</span>
<a href="#l2.2315"></a><span id="l2.2315" class="difflineplus">+    );</span>
<a href="#l2.2316"></a><span id="l2.2316">   },</span>
<a href="#l2.2317"></a><span id="l2.2317"> };</span>
<a href="#l2.2318"></a><span id="l2.2318"> </span>
<a href="#l2.2319"></a><span id="l2.2319"> var nsPagePropertiesCommand = {</span>
<a href="#l2.2320"></a><span id="l2.2320">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2321"></a><span id="l2.2321" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.2322"></a><span id="l2.2322" class="difflineplus">+    return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l2.2323"></a><span id="l2.2323">   },</span>
<a href="#l2.2324"></a><span id="l2.2324"> </span>
<a href="#l2.2325"></a><span id="l2.2325">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2326"></a><span id="l2.2326">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2327"></a><span id="l2.2327"> </span>
<a href="#l2.2328"></a><span id="l2.2328">   doCommand(aCommand) {</span>
<a href="#l2.2329"></a><span id="l2.2329">     var oldTitle = GetDocumentTitle();</span>
<a href="#l2.2330"></a><span id="l2.2330" class="difflineminus">-    window.openDialog(&quot;chrome://editor/content/EdPageProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, &quot;&quot;);</span>
<a href="#l2.2331"></a><span id="l2.2331" class="difflineplus">+    window.openDialog(</span>
<a href="#l2.2332"></a><span id="l2.2332" class="difflineplus">+      &quot;chrome://editor/content/EdPageProps.xul&quot;,</span>
<a href="#l2.2333"></a><span id="l2.2333" class="difflineplus">+      &quot;_blank&quot;,</span>
<a href="#l2.2334"></a><span id="l2.2334" class="difflineplus">+      &quot;chrome,close,titlebar,modal&quot;,</span>
<a href="#l2.2335"></a><span id="l2.2335" class="difflineplus">+      &quot;&quot;</span>
<a href="#l2.2336"></a><span id="l2.2336" class="difflineplus">+    );</span>
<a href="#l2.2337"></a><span id="l2.2337"> </span>
<a href="#l2.2338"></a><span id="l2.2338">     // Update main window title and</span>
<a href="#l2.2339"></a><span id="l2.2339">     // recent menu data in prefs if doc title changed</span>
<a href="#l2.2340"></a><span id="l2.2340" class="difflineminus">-    if (GetDocumentTitle() != oldTitle)</span>
<a href="#l2.2341"></a><span id="l2.2341" class="difflineplus">+    if (GetDocumentTitle() != oldTitle) {</span>
<a href="#l2.2342"></a><span id="l2.2342">       UpdateWindowTitle();</span>
<a href="#l2.2343"></a><span id="l2.2343" class="difflineplus">+    }</span>
<a href="#l2.2344"></a><span id="l2.2344">   },</span>
<a href="#l2.2345"></a><span id="l2.2345"> };</span>
<a href="#l2.2346"></a><span id="l2.2346"> </span>
<a href="#l2.2347"></a><span id="l2.2347"> var nsObjectPropertiesCommand = {</span>
<a href="#l2.2348"></a><span id="l2.2348">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2349"></a><span id="l2.2349">     var isEnabled = false;</span>
<a href="#l2.2350"></a><span id="l2.2350">     if (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML()) {</span>
<a href="#l2.2351"></a><span id="l2.2351" class="difflineminus">-      isEnabled = (GetObjectForProperties() != null ||</span>
<a href="#l2.2352"></a><span id="l2.2352" class="difflineminus">-                   GetCurrentEditor().getSelectedElement(&quot;href&quot;) != null);</span>
<a href="#l2.2353"></a><span id="l2.2353" class="difflineplus">+      isEnabled =</span>
<a href="#l2.2354"></a><span id="l2.2354" class="difflineplus">+        GetObjectForProperties() != null ||</span>
<a href="#l2.2355"></a><span id="l2.2355" class="difflineplus">+        GetCurrentEditor().getSelectedElement(&quot;href&quot;) != null;</span>
<a href="#l2.2356"></a><span id="l2.2356">     }</span>
<a href="#l2.2357"></a><span id="l2.2357">     return isEnabled;</span>
<a href="#l2.2358"></a><span id="l2.2358">   },</span>
<a href="#l2.2359"></a><span id="l2.2359"> </span>
<a href="#l2.2360"></a><span id="l2.2360">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2361"></a><span id="l2.2361">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2362"></a><span id="l2.2362"> </span>
<a href="#l2.2363"></a><span id="l2.2363">   doCommand(aCommand) {</span>
<a href="#l2.2364"></a><span id="l2.2364" class="difflineat">@@ -2554,20 +2958,21 @@ var nsObjectPropertiesCommand = {</span>
<a href="#l2.2365"></a><span id="l2.2365">         case &quot;hr&quot;:</span>
<a href="#l2.2366"></a><span id="l2.2366">           goDoCommand(&quot;cmd_hline&quot;);</span>
<a href="#l2.2367"></a><span id="l2.2367">           break;</span>
<a href="#l2.2368"></a><span id="l2.2368">         case &quot;form&quot;:</span>
<a href="#l2.2369"></a><span id="l2.2369">           goDoCommand(&quot;cmd_form&quot;);</span>
<a href="#l2.2370"></a><span id="l2.2370">           break;</span>
<a href="#l2.2371"></a><span id="l2.2371">         case &quot;input&quot;:</span>
<a href="#l2.2372"></a><span id="l2.2372">           var type = element.getAttribute(&quot;type&quot;);</span>
<a href="#l2.2373"></a><span id="l2.2373" class="difflineminus">-          if (type &amp;&amp; type.toLowerCase() == &quot;image&quot;)</span>
<a href="#l2.2374"></a><span id="l2.2374" class="difflineplus">+          if (type &amp;&amp; type.toLowerCase() == &quot;image&quot;) {</span>
<a href="#l2.2375"></a><span id="l2.2375">             goDoCommand(&quot;cmd_inputimage&quot;);</span>
<a href="#l2.2376"></a><span id="l2.2376" class="difflineminus">-          else</span>
<a href="#l2.2377"></a><span id="l2.2377" class="difflineplus">+          } else {</span>
<a href="#l2.2378"></a><span id="l2.2378">             goDoCommand(&quot;cmd_inputtag&quot;);</span>
<a href="#l2.2379"></a><span id="l2.2379" class="difflineplus">+          }</span>
<a href="#l2.2380"></a><span id="l2.2380">           break;</span>
<a href="#l2.2381"></a><span id="l2.2381">         case &quot;textarea&quot;:</span>
<a href="#l2.2382"></a><span id="l2.2382">           goDoCommand(&quot;cmd_textarea&quot;);</span>
<a href="#l2.2383"></a><span id="l2.2383">           break;</span>
<a href="#l2.2384"></a><span id="l2.2384">         case &quot;select&quot;:</span>
<a href="#l2.2385"></a><span id="l2.2385">           goDoCommand(&quot;cmd_select&quot;);</span>
<a href="#l2.2386"></a><span id="l2.2386">           break;</span>
<a href="#l2.2387"></a><span id="l2.2387">         case &quot;button&quot;:</span>
<a href="#l2.2388"></a><span id="l2.2388" class="difflineat">@@ -2606,186 +3011,220 @@ var nsObjectPropertiesCommand = {</span>
<a href="#l2.2389"></a><span id="l2.2389">           doAdvancedProperties(element);</span>
<a href="#l2.2390"></a><span id="l2.2390">           break;</span>
<a href="#l2.2391"></a><span id="l2.2391">       }</span>
<a href="#l2.2392"></a><span id="l2.2392">     } else {</span>
<a href="#l2.2393"></a><span id="l2.2393">       // We get a partially-selected link if asked for specifically</span>
<a href="#l2.2394"></a><span id="l2.2394">       try {</span>
<a href="#l2.2395"></a><span id="l2.2395">         element = GetCurrentEditor().getSelectedElement(&quot;href&quot;);</span>
<a href="#l2.2396"></a><span id="l2.2396">       } catch (e) {}</span>
<a href="#l2.2397"></a><span id="l2.2397" class="difflineminus">-      if (element)</span>
<a href="#l2.2398"></a><span id="l2.2398" class="difflineplus">+      if (element) {</span>
<a href="#l2.2399"></a><span id="l2.2399">         goDoCommand(&quot;cmd_link&quot;);</span>
<a href="#l2.2400"></a><span id="l2.2400" class="difflineplus">+      }</span>
<a href="#l2.2401"></a><span id="l2.2401">     }</span>
<a href="#l2.2402"></a><span id="l2.2402">   },</span>
<a href="#l2.2403"></a><span id="l2.2403"> };</span>
<a href="#l2.2404"></a><span id="l2.2404"> </span>
<a href="#l2.2405"></a><span id="l2.2405"> var nsSetSmiley = {</span>
<a href="#l2.2406"></a><span id="l2.2406">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2407"></a><span id="l2.2407" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.2408"></a><span id="l2.2408" class="difflineplus">+    return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l2.2409"></a><span id="l2.2409">   },</span>
<a href="#l2.2410"></a><span id="l2.2410"> </span>
<a href="#l2.2411"></a><span id="l2.2411">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2412"></a><span id="l2.2412">   doCommandParams(aCommand, aParams, aRefCon) {</span>
<a href="#l2.2413"></a><span id="l2.2413">     var smileyCode = aParams.getStringValue(&quot;state_attribute&quot;);</span>
<a href="#l2.2414"></a><span id="l2.2414"> </span>
<a href="#l2.2415"></a><span id="l2.2415">     var strSml;</span>
<a href="#l2.2416"></a><span id="l2.2416">     switch (smileyCode) {</span>
<a href="#l2.2417"></a><span id="l2.2417" class="difflineminus">-        case &quot;:-)&quot;: strSml = &quot;s1&quot;;</span>
<a href="#l2.2418"></a><span id="l2.2418" class="difflineplus">+      case &quot;:-)&quot;:</span>
<a href="#l2.2419"></a><span id="l2.2419" class="difflineplus">+        strSml = &quot;s1&quot;;</span>
<a href="#l2.2420"></a><span id="l2.2420" class="difflineplus">+        break;</span>
<a href="#l2.2421"></a><span id="l2.2421" class="difflineplus">+      case &quot;:-(&quot;:</span>
<a href="#l2.2422"></a><span id="l2.2422" class="difflineplus">+        strSml = &quot;s2&quot;;</span>
<a href="#l2.2423"></a><span id="l2.2423">         break;</span>
<a href="#l2.2424"></a><span id="l2.2424" class="difflineminus">-        case &quot;:-(&quot;: strSml = &quot;s2&quot;;</span>
<a href="#l2.2425"></a><span id="l2.2425" class="difflineplus">+      case &quot;;-)&quot;:</span>
<a href="#l2.2426"></a><span id="l2.2426" class="difflineplus">+        strSml = &quot;s3&quot;;</span>
<a href="#l2.2427"></a><span id="l2.2427">         break;</span>
<a href="#l2.2428"></a><span id="l2.2428" class="difflineminus">-        case &quot;;-)&quot;: strSml = &quot;s3&quot;;</span>
<a href="#l2.2429"></a><span id="l2.2429" class="difflineplus">+      case &quot;:-P&quot;:</span>
<a href="#l2.2430"></a><span id="l2.2430" class="difflineplus">+      case &quot;:-p&quot;:</span>
<a href="#l2.2431"></a><span id="l2.2431" class="difflineplus">+      case &quot;:-b&quot;:</span>
<a href="#l2.2432"></a><span id="l2.2432" class="difflineplus">+        strSml = &quot;s4&quot;;</span>
<a href="#l2.2433"></a><span id="l2.2433">         break;</span>
<a href="#l2.2434"></a><span id="l2.2434" class="difflineminus">-        case &quot;:-P&quot;:</span>
<a href="#l2.2435"></a><span id="l2.2435" class="difflineminus">-        case &quot;:-p&quot;:</span>
<a href="#l2.2436"></a><span id="l2.2436" class="difflineminus">-        case &quot;:-b&quot;: strSml = &quot;s4&quot;;</span>
<a href="#l2.2437"></a><span id="l2.2437" class="difflineplus">+      case &quot;:-D&quot;:</span>
<a href="#l2.2438"></a><span id="l2.2438" class="difflineplus">+        strSml = &quot;s5&quot;;</span>
<a href="#l2.2439"></a><span id="l2.2439">         break;</span>
<a href="#l2.2440"></a><span id="l2.2440" class="difflineminus">-        case &quot;:-D&quot;: strSml = &quot;s5&quot;;</span>
<a href="#l2.2441"></a><span id="l2.2441" class="difflineplus">+      case &quot;:-[&quot;:</span>
<a href="#l2.2442"></a><span id="l2.2442" class="difflineplus">+        strSml = &quot;s6&quot;;</span>
<a href="#l2.2443"></a><span id="l2.2443">         break;</span>
<a href="#l2.2444"></a><span id="l2.2444" class="difflineminus">-        case &quot;:-[&quot;: strSml = &quot;s6&quot;;</span>
<a href="#l2.2445"></a><span id="l2.2445" class="difflineplus">+      case &quot;:-/&quot;:</span>
<a href="#l2.2446"></a><span id="l2.2446" class="difflineplus">+      case &quot;:/&quot;:</span>
<a href="#l2.2447"></a><span id="l2.2447" class="difflineplus">+      case &quot;:-\\&quot;:</span>
<a href="#l2.2448"></a><span id="l2.2448" class="difflineplus">+      case &quot;:\\&quot;:</span>
<a href="#l2.2449"></a><span id="l2.2449" class="difflineplus">+        strSml = &quot;s7&quot;;</span>
<a href="#l2.2450"></a><span id="l2.2450">         break;</span>
<a href="#l2.2451"></a><span id="l2.2451" class="difflineminus">-        case &quot;:-/&quot;:</span>
<a href="#l2.2452"></a><span id="l2.2452" class="difflineminus">-        case &quot;:/&quot;:</span>
<a href="#l2.2453"></a><span id="l2.2453" class="difflineminus">-        case &quot;:-\\&quot;:</span>
<a href="#l2.2454"></a><span id="l2.2454" class="difflineminus">-        case &quot;:\\&quot;: strSml = &quot;s7&quot;;</span>
<a href="#l2.2455"></a><span id="l2.2455" class="difflineplus">+      case &quot;=-O&quot;:</span>
<a href="#l2.2456"></a><span id="l2.2456" class="difflineplus">+      case &quot;=-o&quot;:</span>
<a href="#l2.2457"></a><span id="l2.2457" class="difflineplus">+        strSml = &quot;s8&quot;;</span>
<a href="#l2.2458"></a><span id="l2.2458">         break;</span>
<a href="#l2.2459"></a><span id="l2.2459" class="difflineminus">-        case &quot;=-O&quot;:</span>
<a href="#l2.2460"></a><span id="l2.2460" class="difflineminus">-        case &quot;=-o&quot;: strSml = &quot;s8&quot;;</span>
<a href="#l2.2461"></a><span id="l2.2461" class="difflineminus">-        break;</span>
<a href="#l2.2462"></a><span id="l2.2462" class="difflineminus">-        case &quot;:-*&quot;: strSml = &quot;s9&quot;;</span>
<a href="#l2.2463"></a><span id="l2.2463" class="difflineplus">+      case &quot;:-*&quot;:</span>
<a href="#l2.2464"></a><span id="l2.2464" class="difflineplus">+        strSml = &quot;s9&quot;;</span>
<a href="#l2.2465"></a><span id="l2.2465">         break;</span>
<a href="#l2.2466"></a><span id="l2.2466" class="difflineminus">-        case &quot;&gt;:o&quot;:</span>
<a href="#l2.2467"></a><span id="l2.2467" class="difflineminus">-        case &quot;&gt;:-o&quot;: strSml = &quot;s10&quot;;</span>
<a href="#l2.2468"></a><span id="l2.2468" class="difflineplus">+      case &quot;&gt;:o&quot;:</span>
<a href="#l2.2469"></a><span id="l2.2469" class="difflineplus">+      case &quot;&gt;:-o&quot;:</span>
<a href="#l2.2470"></a><span id="l2.2470" class="difflineplus">+        strSml = &quot;s10&quot;;</span>
<a href="#l2.2471"></a><span id="l2.2471">         break;</span>
<a href="#l2.2472"></a><span id="l2.2472" class="difflineminus">-        case &quot;8-)&quot;: strSml = &quot;s11&quot;;</span>
<a href="#l2.2473"></a><span id="l2.2473" class="difflineplus">+      case &quot;8-)&quot;:</span>
<a href="#l2.2474"></a><span id="l2.2474" class="difflineplus">+        strSml = &quot;s11&quot;;</span>
<a href="#l2.2475"></a><span id="l2.2475">         break;</span>
<a href="#l2.2476"></a><span id="l2.2476" class="difflineminus">-        case &quot;:-$&quot;: strSml = &quot;s12&quot;;</span>
<a href="#l2.2477"></a><span id="l2.2477" class="difflineplus">+      case &quot;:-$&quot;:</span>
<a href="#l2.2478"></a><span id="l2.2478" class="difflineplus">+        strSml = &quot;s12&quot;;</span>
<a href="#l2.2479"></a><span id="l2.2479">         break;</span>
<a href="#l2.2480"></a><span id="l2.2480" class="difflineminus">-        case &quot;:-!&quot;: strSml = &quot;s13&quot;;</span>
<a href="#l2.2481"></a><span id="l2.2481" class="difflineplus">+      case &quot;:-!&quot;:</span>
<a href="#l2.2482"></a><span id="l2.2482" class="difflineplus">+        strSml = &quot;s13&quot;;</span>
<a href="#l2.2483"></a><span id="l2.2483">         break;</span>
<a href="#l2.2484"></a><span id="l2.2484" class="difflineminus">-        case &quot;O:-)&quot;:</span>
<a href="#l2.2485"></a><span id="l2.2485" class="difflineminus">-        case &quot;o:-)&quot;: strSml = &quot;s14&quot;;</span>
<a href="#l2.2486"></a><span id="l2.2486" class="difflineplus">+      case &quot;O:-)&quot;:</span>
<a href="#l2.2487"></a><span id="l2.2487" class="difflineplus">+      case &quot;o:-)&quot;:</span>
<a href="#l2.2488"></a><span id="l2.2488" class="difflineplus">+        strSml = &quot;s14&quot;;</span>
<a href="#l2.2489"></a><span id="l2.2489">         break;</span>
<a href="#l2.2490"></a><span id="l2.2490" class="difflineminus">-        case &quot;:'(&quot;: strSml = &quot;s15&quot;;</span>
<a href="#l2.2491"></a><span id="l2.2491" class="difflineplus">+      case &quot;:'(&quot;:</span>
<a href="#l2.2492"></a><span id="l2.2492" class="difflineplus">+        strSml = &quot;s15&quot;;</span>
<a href="#l2.2493"></a><span id="l2.2493">         break;</span>
<a href="#l2.2494"></a><span id="l2.2494" class="difflineminus">-        case &quot;:-X&quot;:</span>
<a href="#l2.2495"></a><span id="l2.2495" class="difflineminus">-        case &quot;:-x&quot;: strSml = &quot;s16&quot;;</span>
<a href="#l2.2496"></a><span id="l2.2496" class="difflineplus">+      case &quot;:-X&quot;:</span>
<a href="#l2.2497"></a><span id="l2.2497" class="difflineplus">+      case &quot;:-x&quot;:</span>
<a href="#l2.2498"></a><span id="l2.2498" class="difflineplus">+        strSml = &quot;s16&quot;;</span>
<a href="#l2.2499"></a><span id="l2.2499">         break;</span>
<a href="#l2.2500"></a><span id="l2.2500" class="difflineminus">-        default: strSml = &quot;&quot;;</span>
<a href="#l2.2501"></a><span id="l2.2501" class="difflineplus">+      default:</span>
<a href="#l2.2502"></a><span id="l2.2502" class="difflineplus">+        strSml = &quot;&quot;;</span>
<a href="#l2.2503"></a><span id="l2.2503">         break;</span>
<a href="#l2.2504"></a><span id="l2.2504">     }</span>
<a href="#l2.2505"></a><span id="l2.2505"> </span>
<a href="#l2.2506"></a><span id="l2.2506">     try {</span>
<a href="#l2.2507"></a><span id="l2.2507">       var editor = GetCurrentEditor();</span>
<a href="#l2.2508"></a><span id="l2.2508">       var extElement = editor.createElementWithDefaults(&quot;span&quot;);</span>
<a href="#l2.2509"></a><span id="l2.2509">       extElement.setAttribute(&quot;class&quot;, &quot;moz-smiley-&quot; + strSml);</span>
<a href="#l2.2510"></a><span id="l2.2510"> </span>
<a href="#l2.2511"></a><span id="l2.2511">       var intElement = editor.createElementWithDefaults(&quot;span&quot;);</span>
<a href="#l2.2512"></a><span id="l2.2512" class="difflineminus">-      if (!intElement)</span>
<a href="#l2.2513"></a><span id="l2.2513" class="difflineplus">+      if (!intElement) {</span>
<a href="#l2.2514"></a><span id="l2.2514">         return;</span>
<a href="#l2.2515"></a><span id="l2.2515" class="difflineminus">-</span>
<a href="#l2.2516"></a><span id="l2.2516" class="difflineminus">-      var txtElement =  editor.document.createTextNode(smileyCode);</span>
<a href="#l2.2517"></a><span id="l2.2517" class="difflineminus">-      if (!txtElement)</span>
<a href="#l2.2518"></a><span id="l2.2518" class="difflineplus">+      }</span>
<a href="#l2.2519"></a><span id="l2.2519" class="difflineplus">+</span>
<a href="#l2.2520"></a><span id="l2.2520" class="difflineplus">+      var txtElement = editor.document.createTextNode(smileyCode);</span>
<a href="#l2.2521"></a><span id="l2.2521" class="difflineplus">+      if (!txtElement) {</span>
<a href="#l2.2522"></a><span id="l2.2522">         return;</span>
<a href="#l2.2523"></a><span id="l2.2523" class="difflineplus">+      }</span>
<a href="#l2.2524"></a><span id="l2.2524"> </span>
<a href="#l2.2525"></a><span id="l2.2525">       intElement.appendChild(txtElement);</span>
<a href="#l2.2526"></a><span id="l2.2526">       extElement.appendChild(intElement);</span>
<a href="#l2.2527"></a><span id="l2.2527"> </span>
<a href="#l2.2528"></a><span id="l2.2528" class="difflineminus">-</span>
<a href="#l2.2529"></a><span id="l2.2529">       editor.insertElementAtSelection(extElement, true);</span>
<a href="#l2.2530"></a><span id="l2.2530">       window.content.focus();</span>
<a href="#l2.2531"></a><span id="l2.2531">     } catch (e) {</span>
<a href="#l2.2532"></a><span id="l2.2532" class="difflineminus">-        dump(&quot;Exception occurred in smiley InsertElementAtSelection\n&quot;);</span>
<a href="#l2.2533"></a><span id="l2.2533" class="difflineplus">+      dump(&quot;Exception occurred in smiley InsertElementAtSelection\n&quot;);</span>
<a href="#l2.2534"></a><span id="l2.2534">     }</span>
<a href="#l2.2535"></a><span id="l2.2535">   },</span>
<a href="#l2.2536"></a><span id="l2.2536">   // This is now deprecated in favor of &quot;doCommandParams&quot;</span>
<a href="#l2.2537"></a><span id="l2.2537">   doCommand(aCommand) {},</span>
<a href="#l2.2538"></a><span id="l2.2538"> };</span>
<a href="#l2.2539"></a><span id="l2.2539"> </span>
<a href="#l2.2540"></a><span id="l2.2540"> function doAdvancedProperties(element) {</span>
<a href="#l2.2541"></a><span id="l2.2541">   if (element) {</span>
<a href="#l2.2542"></a><span id="l2.2542" class="difflineminus">-    window.openDialog(&quot;chrome://editor/content/EdAdvancedEdit.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal,resizable=yes&quot;, &quot;&quot;, element);</span>
<a href="#l2.2543"></a><span id="l2.2543" class="difflineplus">+    window.openDialog(</span>
<a href="#l2.2544"></a><span id="l2.2544" class="difflineplus">+      &quot;chrome://editor/content/EdAdvancedEdit.xul&quot;,</span>
<a href="#l2.2545"></a><span id="l2.2545" class="difflineplus">+      &quot;_blank&quot;,</span>
<a href="#l2.2546"></a><span id="l2.2546" class="difflineplus">+      &quot;chrome,close,titlebar,modal,resizable=yes&quot;,</span>
<a href="#l2.2547"></a><span id="l2.2547" class="difflineplus">+      &quot;&quot;,</span>
<a href="#l2.2548"></a><span id="l2.2548" class="difflineplus">+      element</span>
<a href="#l2.2549"></a><span id="l2.2549" class="difflineplus">+    );</span>
<a href="#l2.2550"></a><span id="l2.2550">   }</span>
<a href="#l2.2551"></a><span id="l2.2551"> }</span>
<a href="#l2.2552"></a><span id="l2.2552"> </span>
<a href="#l2.2553"></a><span id="l2.2553"> var nsAdvancedPropertiesCommand = {</span>
<a href="#l2.2554"></a><span id="l2.2554">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2555"></a><span id="l2.2555" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.2556"></a><span id="l2.2556" class="difflineplus">+    return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l2.2557"></a><span id="l2.2557">   },</span>
<a href="#l2.2558"></a><span id="l2.2558"> </span>
<a href="#l2.2559"></a><span id="l2.2559">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2560"></a><span id="l2.2560">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2561"></a><span id="l2.2561"> </span>
<a href="#l2.2562"></a><span id="l2.2562">   doCommand(aCommand) {</span>
<a href="#l2.2563"></a><span id="l2.2563">     // Launch AdvancedEdit dialog for the selected element</span>
<a href="#l2.2564"></a><span id="l2.2564">     try {</span>
<a href="#l2.2565"></a><span id="l2.2565">       var element = GetCurrentEditor().getSelectedElement(&quot;&quot;);</span>
<a href="#l2.2566"></a><span id="l2.2566">       doAdvancedProperties(element);</span>
<a href="#l2.2567"></a><span id="l2.2567">     } catch (e) {}</span>
<a href="#l2.2568"></a><span id="l2.2568">   },</span>
<a href="#l2.2569"></a><span id="l2.2569"> };</span>
<a href="#l2.2570"></a><span id="l2.2570"> </span>
<a href="#l2.2571"></a><span id="l2.2571"> var nsColorPropertiesCommand = {</span>
<a href="#l2.2572"></a><span id="l2.2572">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2573"></a><span id="l2.2573" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.2574"></a><span id="l2.2574" class="difflineplus">+    return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l2.2575"></a><span id="l2.2575">   },</span>
<a href="#l2.2576"></a><span id="l2.2576"> </span>
<a href="#l2.2577"></a><span id="l2.2577">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2578"></a><span id="l2.2578">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2579"></a><span id="l2.2579"> </span>
<a href="#l2.2580"></a><span id="l2.2580">   doCommand(aCommand) {</span>
<a href="#l2.2581"></a><span id="l2.2581" class="difflineminus">-    window.openDialog(&quot;chrome://editor/content/EdColorProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, &quot;&quot;);</span>
<a href="#l2.2582"></a><span id="l2.2582" class="difflineplus">+    window.openDialog(</span>
<a href="#l2.2583"></a><span id="l2.2583" class="difflineplus">+      &quot;chrome://editor/content/EdColorProps.xul&quot;,</span>
<a href="#l2.2584"></a><span id="l2.2584" class="difflineplus">+      &quot;_blank&quot;,</span>
<a href="#l2.2585"></a><span id="l2.2585" class="difflineplus">+      &quot;chrome,close,titlebar,modal&quot;,</span>
<a href="#l2.2586"></a><span id="l2.2586" class="difflineplus">+      &quot;&quot;</span>
<a href="#l2.2587"></a><span id="l2.2587" class="difflineplus">+    );</span>
<a href="#l2.2588"></a><span id="l2.2588">     UpdateDefaultColors();</span>
<a href="#l2.2589"></a><span id="l2.2589">   },</span>
<a href="#l2.2590"></a><span id="l2.2590"> };</span>
<a href="#l2.2591"></a><span id="l2.2591"> </span>
<a href="#l2.2592"></a><span id="l2.2592"> var nsIncreaseFontCommand = {</span>
<a href="#l2.2593"></a><span id="l2.2593">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2594"></a><span id="l2.2594" class="difflineminus">-    if (!(IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML()))</span>
<a href="#l2.2595"></a><span id="l2.2595" class="difflineplus">+    if (!(IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML())) {</span>
<a href="#l2.2596"></a><span id="l2.2596">       return false;</span>
<a href="#l2.2597"></a><span id="l2.2597" class="difflineplus">+    }</span>
<a href="#l2.2598"></a><span id="l2.2598">     var setIndex = getFontSizeIndex();</span>
<a href="#l2.2599"></a><span id="l2.2599" class="difflineminus">-    return (setIndex &gt;= 0 &amp;&amp; setIndex &lt; 5);</span>
<a href="#l2.2600"></a><span id="l2.2600" class="difflineplus">+    return setIndex &gt;= 0 &amp;&amp; setIndex &lt; 5;</span>
<a href="#l2.2601"></a><span id="l2.2601">   },</span>
<a href="#l2.2602"></a><span id="l2.2602"> </span>
<a href="#l2.2603"></a><span id="l2.2603">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2604"></a><span id="l2.2604">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2605"></a><span id="l2.2605"> </span>
<a href="#l2.2606"></a><span id="l2.2606">   doCommand(aCommand) {</span>
<a href="#l2.2607"></a><span id="l2.2607">     var setIndex = getFontSizeIndex();</span>
<a href="#l2.2608"></a><span id="l2.2608" class="difflineminus">-    if (setIndex &lt; 0 || setIndex &gt;= 5)</span>
<a href="#l2.2609"></a><span id="l2.2609" class="difflineplus">+    if (setIndex &lt; 0 || setIndex &gt;= 5) {</span>
<a href="#l2.2610"></a><span id="l2.2610">       return;</span>
<a href="#l2.2611"></a><span id="l2.2611" class="difflineminus">-    var sizes = [&quot;x-small&quot;, &quot;small&quot;, &quot;medium&quot;, &quot;large&quot;, &quot;x-large&quot;, &quot;xx-large&quot; ];</span>
<a href="#l2.2612"></a><span id="l2.2612" class="difflineplus">+    }</span>
<a href="#l2.2613"></a><span id="l2.2613" class="difflineplus">+    var sizes = [&quot;x-small&quot;, &quot;small&quot;, &quot;medium&quot;, &quot;large&quot;, &quot;x-large&quot;, &quot;xx-large&quot;];</span>
<a href="#l2.2614"></a><span id="l2.2614">     EditorSetFontSize(sizes[setIndex + 1]);</span>
<a href="#l2.2615"></a><span id="l2.2615">   },</span>
<a href="#l2.2616"></a><span id="l2.2616"> };</span>
<a href="#l2.2617"></a><span id="l2.2617"> </span>
<a href="#l2.2618"></a><span id="l2.2618"> var nsDecreaseFontCommand = {</span>
<a href="#l2.2619"></a><span id="l2.2619">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2620"></a><span id="l2.2620" class="difflineminus">-    if (!(IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML()))</span>
<a href="#l2.2621"></a><span id="l2.2621" class="difflineplus">+    if (!(IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML())) {</span>
<a href="#l2.2622"></a><span id="l2.2622">       return false;</span>
<a href="#l2.2623"></a><span id="l2.2623" class="difflineplus">+    }</span>
<a href="#l2.2624"></a><span id="l2.2624">     var setIndex = getFontSizeIndex();</span>
<a href="#l2.2625"></a><span id="l2.2625" class="difflineminus">-    return (setIndex &gt; 0);</span>
<a href="#l2.2626"></a><span id="l2.2626" class="difflineplus">+    return setIndex &gt; 0;</span>
<a href="#l2.2627"></a><span id="l2.2627">   },</span>
<a href="#l2.2628"></a><span id="l2.2628"> </span>
<a href="#l2.2629"></a><span id="l2.2629">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2630"></a><span id="l2.2630">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2631"></a><span id="l2.2631"> </span>
<a href="#l2.2632"></a><span id="l2.2632">   doCommand(aCommand) {</span>
<a href="#l2.2633"></a><span id="l2.2633">     var setIndex = getFontSizeIndex();</span>
<a href="#l2.2634"></a><span id="l2.2634" class="difflineminus">-    if (setIndex &lt;= 0)</span>
<a href="#l2.2635"></a><span id="l2.2635" class="difflineplus">+    if (setIndex &lt;= 0) {</span>
<a href="#l2.2636"></a><span id="l2.2636">       return;</span>
<a href="#l2.2637"></a><span id="l2.2637" class="difflineminus">-    var sizes = [&quot;x-small&quot;, &quot;small&quot;, &quot;medium&quot;, &quot;large&quot;, &quot;x-large&quot;, &quot;xx-large&quot; ];</span>
<a href="#l2.2638"></a><span id="l2.2638" class="difflineplus">+    }</span>
<a href="#l2.2639"></a><span id="l2.2639" class="difflineplus">+    var sizes = [&quot;x-small&quot;, &quot;small&quot;, &quot;medium&quot;, &quot;large&quot;, &quot;x-large&quot;, &quot;xx-large&quot;];</span>
<a href="#l2.2640"></a><span id="l2.2640">     EditorSetFontSize(sizes[setIndex - 1]);</span>
<a href="#l2.2641"></a><span id="l2.2641">   },</span>
<a href="#l2.2642"></a><span id="l2.2642"> };</span>
<a href="#l2.2643"></a><span id="l2.2643"> </span>
<a href="#l2.2644"></a><span id="l2.2644"> var nsRemoveNamedAnchorsCommand = {</span>
<a href="#l2.2645"></a><span id="l2.2645">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2646"></a><span id="l2.2646">     // We could see if there's any link in selection, but it doesn't seem worth the work!</span>
<a href="#l2.2647"></a><span id="l2.2647" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.2648"></a><span id="l2.2648" class="difflineplus">+    return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l2.2649"></a><span id="l2.2649">   },</span>
<a href="#l2.2650"></a><span id="l2.2650"> </span>
<a href="#l2.2651"></a><span id="l2.2651">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2652"></a><span id="l2.2652">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2653"></a><span id="l2.2653"> </span>
<a href="#l2.2654"></a><span id="l2.2654">   doCommand(aCommand) {</span>
<a href="#l2.2655"></a><span id="l2.2655">     EditorRemoveTextProperty(&quot;name&quot;, &quot;&quot;);</span>
<a href="#l2.2656"></a><span id="l2.2656">     window.content.focus();</span>
<a href="#l2.2657"></a><span id="l2.2657" class="difflineat">@@ -2823,66 +3262,67 @@ var nsNormalModeCommand = {</span>
<a href="#l2.2658"></a><span id="l2.2658"> </span>
<a href="#l2.2659"></a><span id="l2.2659">   doCommand(aCommand) {</span>
<a href="#l2.2660"></a><span id="l2.2660">     SetEditMode(kDisplayModeNormal);</span>
<a href="#l2.2661"></a><span id="l2.2661">   },</span>
<a href="#l2.2662"></a><span id="l2.2662"> };</span>
<a href="#l2.2663"></a><span id="l2.2663"> </span>
<a href="#l2.2664"></a><span id="l2.2664"> var nsAllTagsModeCommand = {</span>
<a href="#l2.2665"></a><span id="l2.2665">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2666"></a><span id="l2.2666" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp; IsHTMLEditor());</span>
<a href="#l2.2667"></a><span id="l2.2667" class="difflineplus">+    return IsDocumentEditable() &amp;&amp; IsHTMLEditor();</span>
<a href="#l2.2668"></a><span id="l2.2668">   },</span>
<a href="#l2.2669"></a><span id="l2.2669"> </span>
<a href="#l2.2670"></a><span id="l2.2670">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2671"></a><span id="l2.2671">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2672"></a><span id="l2.2672"> </span>
<a href="#l2.2673"></a><span id="l2.2673">   doCommand(aCommand) {</span>
<a href="#l2.2674"></a><span id="l2.2674">     SetEditMode(kDisplayModeAllTags);</span>
<a href="#l2.2675"></a><span id="l2.2675">   },</span>
<a href="#l2.2676"></a><span id="l2.2676"> };</span>
<a href="#l2.2677"></a><span id="l2.2677"> </span>
<a href="#l2.2678"></a><span id="l2.2678"> var nsHTMLSourceModeCommand = {</span>
<a href="#l2.2679"></a><span id="l2.2679">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2680"></a><span id="l2.2680" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp; IsHTMLEditor());</span>
<a href="#l2.2681"></a><span id="l2.2681" class="difflineplus">+    return IsDocumentEditable() &amp;&amp; IsHTMLEditor();</span>
<a href="#l2.2682"></a><span id="l2.2682">   },</span>
<a href="#l2.2683"></a><span id="l2.2683"> </span>
<a href="#l2.2684"></a><span id="l2.2684">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2685"></a><span id="l2.2685">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2686"></a><span id="l2.2686"> </span>
<a href="#l2.2687"></a><span id="l2.2687">   doCommand(aCommand) {</span>
<a href="#l2.2688"></a><span id="l2.2688">     SetEditMode(kDisplayModeSource);</span>
<a href="#l2.2689"></a><span id="l2.2689">   },</span>
<a href="#l2.2690"></a><span id="l2.2690"> };</span>
<a href="#l2.2691"></a><span id="l2.2691"> </span>
<a href="#l2.2692"></a><span id="l2.2692"> var nsPreviewModeCommand = {</span>
<a href="#l2.2693"></a><span id="l2.2693">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2694"></a><span id="l2.2694" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp; IsHTMLEditor());</span>
<a href="#l2.2695"></a><span id="l2.2695" class="difflineplus">+    return IsDocumentEditable() &amp;&amp; IsHTMLEditor();</span>
<a href="#l2.2696"></a><span id="l2.2696">   },</span>
<a href="#l2.2697"></a><span id="l2.2697"> </span>
<a href="#l2.2698"></a><span id="l2.2698">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2699"></a><span id="l2.2699">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2700"></a><span id="l2.2700"> </span>
<a href="#l2.2701"></a><span id="l2.2701">   doCommand(aCommand) {</span>
<a href="#l2.2702"></a><span id="l2.2702">     SetEditMode(kDisplayModePreview);</span>
<a href="#l2.2703"></a><span id="l2.2703">   },</span>
<a href="#l2.2704"></a><span id="l2.2704"> };</span>
<a href="#l2.2705"></a><span id="l2.2705"> </span>
<a href="#l2.2706"></a><span id="l2.2706"> var nsInsertOrEditTableCommand = {</span>
<a href="#l2.2707"></a><span id="l2.2707">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2708"></a><span id="l2.2708" class="difflineminus">-    return (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML());</span>
<a href="#l2.2709"></a><span id="l2.2709" class="difflineplus">+    return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l2.2710"></a><span id="l2.2710">   },</span>
<a href="#l2.2711"></a><span id="l2.2711"> </span>
<a href="#l2.2712"></a><span id="l2.2712">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2713"></a><span id="l2.2713">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2714"></a><span id="l2.2714"> </span>
<a href="#l2.2715"></a><span id="l2.2715">   doCommand(aCommand) {</span>
<a href="#l2.2716"></a><span id="l2.2716" class="difflineminus">-    if (IsInTableCell())</span>
<a href="#l2.2717"></a><span id="l2.2717" class="difflineplus">+    if (IsInTableCell()) {</span>
<a href="#l2.2718"></a><span id="l2.2718">       EditorTableCellProperties();</span>
<a href="#l2.2719"></a><span id="l2.2719" class="difflineminus">-    else</span>
<a href="#l2.2720"></a><span id="l2.2720" class="difflineplus">+    } else {</span>
<a href="#l2.2721"></a><span id="l2.2721">       EditorInsertOrEditTable(true);</span>
<a href="#l2.2722"></a><span id="l2.2722" class="difflineplus">+    }</span>
<a href="#l2.2723"></a><span id="l2.2723">   },</span>
<a href="#l2.2724"></a><span id="l2.2724"> };</span>
<a href="#l2.2725"></a><span id="l2.2725"> </span>
<a href="#l2.2726"></a><span id="l2.2726"> var nsEditTableCommand = {</span>
<a href="#l2.2727"></a><span id="l2.2727">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2728"></a><span id="l2.2728">     return IsInTable();</span>
<a href="#l2.2729"></a><span id="l2.2729">   },</span>
<a href="#l2.2730"></a><span id="l2.2730"> </span>
<a href="#l2.2731"></a><span id="l2.2731" class="difflineat">@@ -3105,18 +3545,19 @@ var nsDeleteTableRowCommand = {</span>
<a href="#l2.2732"></a><span id="l2.2732">   },</span>
<a href="#l2.2733"></a><span id="l2.2733"> </span>
<a href="#l2.2734"></a><span id="l2.2734">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2735"></a><span id="l2.2735">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2736"></a><span id="l2.2736"> </span>
<a href="#l2.2737"></a><span id="l2.2737">   doCommand(aCommand) {</span>
<a href="#l2.2738"></a><span id="l2.2738">     var rows = GetNumberOfContiguousSelectedRows();</span>
<a href="#l2.2739"></a><span id="l2.2739">     // Delete at least one row</span>
<a href="#l2.2740"></a><span id="l2.2740" class="difflineminus">-    if (rows == 0)</span>
<a href="#l2.2741"></a><span id="l2.2741" class="difflineplus">+    if (rows == 0) {</span>
<a href="#l2.2742"></a><span id="l2.2742">       rows = 1;</span>
<a href="#l2.2743"></a><span id="l2.2743" class="difflineplus">+    }</span>
<a href="#l2.2744"></a><span id="l2.2744"> </span>
<a href="#l2.2745"></a><span id="l2.2745">     try {</span>
<a href="#l2.2746"></a><span id="l2.2746">       var editor = GetCurrentTableEditor();</span>
<a href="#l2.2747"></a><span id="l2.2747">       editor.beginTransaction();</span>
<a href="#l2.2748"></a><span id="l2.2748"> </span>
<a href="#l2.2749"></a><span id="l2.2749">       // Loop to delete all blocks of contiguous, selected rows</span>
<a href="#l2.2750"></a><span id="l2.2750">       while (rows) {</span>
<a href="#l2.2751"></a><span id="l2.2751">         editor.deleteTableRow(rows);</span>
<a href="#l2.2752"></a><span id="l2.2752" class="difflineat">@@ -3135,18 +3576,19 @@ var nsDeleteTableColumnCommand = {</span>
<a href="#l2.2753"></a><span id="l2.2753">   },</span>
<a href="#l2.2754"></a><span id="l2.2754"> </span>
<a href="#l2.2755"></a><span id="l2.2755">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2756"></a><span id="l2.2756">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2757"></a><span id="l2.2757"> </span>
<a href="#l2.2758"></a><span id="l2.2758">   doCommand(aCommand) {</span>
<a href="#l2.2759"></a><span id="l2.2759">     var columns = GetNumberOfContiguousSelectedColumns();</span>
<a href="#l2.2760"></a><span id="l2.2760">     // Delete at least one column</span>
<a href="#l2.2761"></a><span id="l2.2761" class="difflineminus">-    if (columns == 0)</span>
<a href="#l2.2762"></a><span id="l2.2762" class="difflineplus">+    if (columns == 0) {</span>
<a href="#l2.2763"></a><span id="l2.2763">       columns = 1;</span>
<a href="#l2.2764"></a><span id="l2.2764" class="difflineplus">+    }</span>
<a href="#l2.2765"></a><span id="l2.2765"> </span>
<a href="#l2.2766"></a><span id="l2.2766">     try {</span>
<a href="#l2.2767"></a><span id="l2.2767">       var editor = GetCurrentTableEditor();</span>
<a href="#l2.2768"></a><span id="l2.2768">       editor.beginTransaction();</span>
<a href="#l2.2769"></a><span id="l2.2769"> </span>
<a href="#l2.2770"></a><span id="l2.2770">       // Loop to delete all blocks of contiguous, selected columns</span>
<a href="#l2.2771"></a><span id="l2.2771">       while (columns) {</span>
<a href="#l2.2772"></a><span id="l2.2772">         editor.deleteTableColumn(columns);</span>
<a href="#l2.2773"></a><span id="l2.2773" class="difflineat">@@ -3216,38 +3658,43 @@ var nsJoinTableCellsCommand = {</span>
<a href="#l2.2774"></a><span id="l2.2774">         var tagNameObj = { value: &quot;&quot; };</span>
<a href="#l2.2775"></a><span id="l2.2775">         var countObj = { value: 0 };</span>
<a href="#l2.2776"></a><span id="l2.2776">         var cell = editor.getSelectedOrParentTableElement(tagNameObj, countObj);</span>
<a href="#l2.2777"></a><span id="l2.2777"> </span>
<a href="#l2.2778"></a><span id="l2.2778">         // We need a cell and either &gt; 1 selected cell or a cell to the right</span>
<a href="#l2.2779"></a><span id="l2.2779">         //  (this cell may originate in a row spanned from above current row)</span>
<a href="#l2.2780"></a><span id="l2.2780">         // Note that editor returns &quot;td&quot; for &quot;th&quot; also.</span>
<a href="#l2.2781"></a><span id="l2.2781">         // (this is a pain! Editor and gecko use lowercase tagNames, JS uses uppercase!)</span>
<a href="#l2.2782"></a><span id="l2.2782" class="difflineminus">-        if (cell &amp;&amp; (tagNameObj.value == &quot;td&quot;)) {</span>
<a href="#l2.2783"></a><span id="l2.2783" class="difflineplus">+        if (cell &amp;&amp; tagNameObj.value == &quot;td&quot;) {</span>
<a href="#l2.2784"></a><span id="l2.2784">           // Selected cells</span>
<a href="#l2.2785"></a><span id="l2.2785" class="difflineminus">-          if (countObj.value &gt; 1) return true;</span>
<a href="#l2.2786"></a><span id="l2.2786" class="difflineplus">+          if (countObj.value &gt; 1) {</span>
<a href="#l2.2787"></a><span id="l2.2787" class="difflineplus">+            return true;</span>
<a href="#l2.2788"></a><span id="l2.2788" class="difflineplus">+          }</span>
<a href="#l2.2789"></a><span id="l2.2789"> </span>
<a href="#l2.2790"></a><span id="l2.2790">           var colSpan = cell.getAttribute(&quot;colspan&quot;);</span>
<a href="#l2.2791"></a><span id="l2.2791"> </span>
<a href="#l2.2792"></a><span id="l2.2792">           // getAttribute returns string, we need number</span>
<a href="#l2.2793"></a><span id="l2.2793">           // no attribute means colspan = 1</span>
<a href="#l2.2794"></a><span id="l2.2794" class="difflineminus">-          if (!colSpan)</span>
<a href="#l2.2795"></a><span id="l2.2795" class="difflineplus">+          if (!colSpan) {</span>
<a href="#l2.2796"></a><span id="l2.2796">             colSpan = Number(1);</span>
<a href="#l2.2797"></a><span id="l2.2797" class="difflineminus">-          else</span>
<a href="#l2.2798"></a><span id="l2.2798" class="difflineplus">+          } else {</span>
<a href="#l2.2799"></a><span id="l2.2799">             colSpan = Number(colSpan);</span>
<a href="#l2.2800"></a><span id="l2.2800" class="difflineplus">+          }</span>
<a href="#l2.2801"></a><span id="l2.2801"> </span>
<a href="#l2.2802"></a><span id="l2.2802">           var rowObj = { value: 0 };</span>
<a href="#l2.2803"></a><span id="l2.2803">           var colObj = { value: 0 };</span>
<a href="#l2.2804"></a><span id="l2.2804">           editor.getCellIndexes(cell, rowObj, colObj);</span>
<a href="#l2.2805"></a><span id="l2.2805"> </span>
<a href="#l2.2806"></a><span id="l2.2806">           // Test if cell exists to the right of current cell</span>
<a href="#l2.2807"></a><span id="l2.2807">           // (cells with 0 span should never have cells to the right</span>
<a href="#l2.2808"></a><span id="l2.2808">           //  if there is, user can select the 2 cells to join them)</span>
<a href="#l2.2809"></a><span id="l2.2809" class="difflineminus">-          return (colSpan &amp;&amp; editor.getCellAt(null, rowObj.value,</span>
<a href="#l2.2810"></a><span id="l2.2810" class="difflineminus">-                                              colObj.value + colSpan));</span>
<a href="#l2.2811"></a><span id="l2.2811" class="difflineplus">+          return (</span>
<a href="#l2.2812"></a><span id="l2.2812" class="difflineplus">+            colSpan &amp;&amp;</span>
<a href="#l2.2813"></a><span id="l2.2813" class="difflineplus">+            editor.getCellAt(null, rowObj.value, colObj.value + colSpan)</span>
<a href="#l2.2814"></a><span id="l2.2814" class="difflineplus">+          );</span>
<a href="#l2.2815"></a><span id="l2.2815">         }</span>
<a href="#l2.2816"></a><span id="l2.2816">       } catch (e) {}</span>
<a href="#l2.2817"></a><span id="l2.2817">     }</span>
<a href="#l2.2818"></a><span id="l2.2818">     return false;</span>
<a href="#l2.2819"></a><span id="l2.2819">   },</span>
<a href="#l2.2820"></a><span id="l2.2820"> </span>
<a href="#l2.2821"></a><span id="l2.2821">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2822"></a><span id="l2.2822">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2823"></a><span id="l2.2823" class="difflineat">@@ -3263,30 +3710,39 @@ var nsJoinTableCellsCommand = {</span>
<a href="#l2.2824"></a><span id="l2.2824"> </span>
<a href="#l2.2825"></a><span id="l2.2825"> var nsSplitTableCellCommand = {</span>
<a href="#l2.2826"></a><span id="l2.2826">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l2.2827"></a><span id="l2.2827">     if (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML()) {</span>
<a href="#l2.2828"></a><span id="l2.2828">       var tagNameObj = { value: &quot;&quot; };</span>
<a href="#l2.2829"></a><span id="l2.2829">       var countObj = { value: 0 };</span>
<a href="#l2.2830"></a><span id="l2.2830">       var cell;</span>
<a href="#l2.2831"></a><span id="l2.2831">       try {</span>
<a href="#l2.2832"></a><span id="l2.2832" class="difflineminus">-        cell = GetCurrentTableEditor().getSelectedOrParentTableElement(tagNameObj, countObj);</span>
<a href="#l2.2833"></a><span id="l2.2833" class="difflineplus">+        cell = GetCurrentTableEditor().getSelectedOrParentTableElement(</span>
<a href="#l2.2834"></a><span id="l2.2834" class="difflineplus">+          tagNameObj,</span>
<a href="#l2.2835"></a><span id="l2.2835" class="difflineplus">+          countObj</span>
<a href="#l2.2836"></a><span id="l2.2836" class="difflineplus">+        );</span>
<a href="#l2.2837"></a><span id="l2.2837">       } catch (e) {}</span>
<a href="#l2.2838"></a><span id="l2.2838"> </span>
<a href="#l2.2839"></a><span id="l2.2839">       // We need a cell parent and there's just 1 selected cell</span>
<a href="#l2.2840"></a><span id="l2.2840">       // or selection is entirely inside 1 cell</span>
<a href="#l2.2841"></a><span id="l2.2841" class="difflineminus">-      if (cell &amp;&amp; (tagNameObj.value == &quot;td&quot;) &amp;&amp;</span>
<a href="#l2.2842"></a><span id="l2.2842" class="difflineminus">-           countObj.value &lt;= 1 &amp;&amp;</span>
<a href="#l2.2843"></a><span id="l2.2843" class="difflineminus">-           IsSelectionInOneCell()) {</span>
<a href="#l2.2844"></a><span id="l2.2844" class="difflineplus">+      if (</span>
<a href="#l2.2845"></a><span id="l2.2845" class="difflineplus">+        cell &amp;&amp;</span>
<a href="#l2.2846"></a><span id="l2.2846" class="difflineplus">+        tagNameObj.value == &quot;td&quot; &amp;&amp;</span>
<a href="#l2.2847"></a><span id="l2.2847" class="difflineplus">+        countObj.value &lt;= 1 &amp;&amp;</span>
<a href="#l2.2848"></a><span id="l2.2848" class="difflineplus">+        IsSelectionInOneCell()</span>
<a href="#l2.2849"></a><span id="l2.2849" class="difflineplus">+      ) {</span>
<a href="#l2.2850"></a><span id="l2.2850">         var colSpan = cell.getAttribute(&quot;colspan&quot;);</span>
<a href="#l2.2851"></a><span id="l2.2851">         var rowSpan = cell.getAttribute(&quot;rowspan&quot;);</span>
<a href="#l2.2852"></a><span id="l2.2852" class="difflineminus">-        if (!colSpan) colSpan = 1;</span>
<a href="#l2.2853"></a><span id="l2.2853" class="difflineminus">-        if (!rowSpan) rowSpan = 1;</span>
<a href="#l2.2854"></a><span id="l2.2854" class="difflineminus">-        return (colSpan &gt; 1 || rowSpan &gt; 1 ||</span>
<a href="#l2.2855"></a><span id="l2.2855" class="difflineminus">-                colSpan == 0 || rowSpan == 0);</span>
<a href="#l2.2856"></a><span id="l2.2856" class="difflineplus">+        if (!colSpan) {</span>
<a href="#l2.2857"></a><span id="l2.2857" class="difflineplus">+          colSpan = 1;</span>
<a href="#l2.2858"></a><span id="l2.2858" class="difflineplus">+        }</span>
<a href="#l2.2859"></a><span id="l2.2859" class="difflineplus">+        if (!rowSpan) {</span>
<a href="#l2.2860"></a><span id="l2.2860" class="difflineplus">+          rowSpan = 1;</span>
<a href="#l2.2861"></a><span id="l2.2861" class="difflineplus">+        }</span>
<a href="#l2.2862"></a><span id="l2.2862" class="difflineplus">+        return colSpan &gt; 1 || rowSpan &gt; 1 || colSpan == 0 || rowSpan == 0;</span>
<a href="#l2.2863"></a><span id="l2.2863">       }</span>
<a href="#l2.2864"></a><span id="l2.2864">     }</span>
<a href="#l2.2865"></a><span id="l2.2865">     return false;</span>
<a href="#l2.2866"></a><span id="l2.2866">   },</span>
<a href="#l2.2867"></a><span id="l2.2867"> </span>
<a href="#l2.2868"></a><span id="l2.2868">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2869"></a><span id="l2.2869">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2870"></a><span id="l2.2870"> </span>
<a href="#l2.2871"></a><span id="l2.2871" class="difflineat">@@ -3365,37 +3821,46 @@ var nsConvertToTable = {</span>
<a href="#l2.2872"></a><span id="l2.2872">       if (selection &amp;&amp; !selection.isCollapsed) {</span>
<a href="#l2.2873"></a><span id="l2.2873">         // Don't allow if table or cell is the selection</span>
<a href="#l2.2874"></a><span id="l2.2874">         var element;</span>
<a href="#l2.2875"></a><span id="l2.2875">         try {</span>
<a href="#l2.2876"></a><span id="l2.2876">           element = GetCurrentEditor().getSelectedElement(&quot;&quot;);</span>
<a href="#l2.2877"></a><span id="l2.2877">         } catch (e) {}</span>
<a href="#l2.2878"></a><span id="l2.2878">         if (element) {</span>
<a href="#l2.2879"></a><span id="l2.2879">           var name = element.nodeName.toLowerCase();</span>
<a href="#l2.2880"></a><span id="l2.2880" class="difflineminus">-          if (name == &quot;td&quot; ||</span>
<a href="#l2.2881"></a><span id="l2.2881" class="difflineminus">-              name == &quot;th&quot; ||</span>
<a href="#l2.2882"></a><span id="l2.2882" class="difflineminus">-              name == &quot;caption&quot; ||</span>
<a href="#l2.2883"></a><span id="l2.2883" class="difflineminus">-              name == &quot;table&quot;)</span>
<a href="#l2.2884"></a><span id="l2.2884" class="difflineplus">+          if (</span>
<a href="#l2.2885"></a><span id="l2.2885" class="difflineplus">+            name == &quot;td&quot; ||</span>
<a href="#l2.2886"></a><span id="l2.2886" class="difflineplus">+            name == &quot;th&quot; ||</span>
<a href="#l2.2887"></a><span id="l2.2887" class="difflineplus">+            name == &quot;caption&quot; ||</span>
<a href="#l2.2888"></a><span id="l2.2888" class="difflineplus">+            name == &quot;table&quot;</span>
<a href="#l2.2889"></a><span id="l2.2889" class="difflineplus">+          ) {</span>
<a href="#l2.2890"></a><span id="l2.2890">             return false;</span>
<a href="#l2.2891"></a><span id="l2.2891" class="difflineplus">+          }</span>
<a href="#l2.2892"></a><span id="l2.2892">         }</span>
<a href="#l2.2893"></a><span id="l2.2893"> </span>
<a href="#l2.2894"></a><span id="l2.2894">         // Selection start and end must be in the same cell</span>
<a href="#l2.2895"></a><span id="l2.2895">         //   in same cell or both are NOT in a cell</span>
<a href="#l2.2896"></a><span id="l2.2896" class="difflineminus">-        if (GetParentTableCell(selection.focusNode) !=</span>
<a href="#l2.2897"></a><span id="l2.2897" class="difflineminus">-             GetParentTableCell(selection.anchorNode))</span>
<a href="#l2.2898"></a><span id="l2.2898" class="difflineplus">+        if (</span>
<a href="#l2.2899"></a><span id="l2.2899" class="difflineplus">+          GetParentTableCell(selection.focusNode) !=</span>
<a href="#l2.2900"></a><span id="l2.2900" class="difflineplus">+          GetParentTableCell(selection.anchorNode)</span>
<a href="#l2.2901"></a><span id="l2.2901" class="difflineplus">+        ) {</span>
<a href="#l2.2902"></a><span id="l2.2902">           return false;</span>
<a href="#l2.2903"></a><span id="l2.2903" class="difflineplus">+        }</span>
<a href="#l2.2904"></a><span id="l2.2904"> </span>
<a href="#l2.2905"></a><span id="l2.2905">         return true;</span>
<a href="#l2.2906"></a><span id="l2.2906">       }</span>
<a href="#l2.2907"></a><span id="l2.2907">     }</span>
<a href="#l2.2908"></a><span id="l2.2908">     return false;</span>
<a href="#l2.2909"></a><span id="l2.2909">   },</span>
<a href="#l2.2910"></a><span id="l2.2910"> </span>
<a href="#l2.2911"></a><span id="l2.2911">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2912"></a><span id="l2.2912">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l2.2913"></a><span id="l2.2913"> </span>
<a href="#l2.2914"></a><span id="l2.2914">   doCommand(aCommand) {</span>
<a href="#l2.2915"></a><span id="l2.2915">     if (this.isCommandEnabled()) {</span>
<a href="#l2.2916"></a><span id="l2.2916" class="difflineminus">-      window.openDialog(&quot;chrome://editor/content/EdConvertToTable.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;);</span>
<a href="#l2.2917"></a><span id="l2.2917" class="difflineplus">+      window.openDialog(</span>
<a href="#l2.2918"></a><span id="l2.2918" class="difflineplus">+        &quot;chrome://editor/content/EdConvertToTable.xul&quot;,</span>
<a href="#l2.2919"></a><span id="l2.2919" class="difflineplus">+        &quot;_blank&quot;,</span>
<a href="#l2.2920"></a><span id="l2.2920" class="difflineplus">+        &quot;chrome,close,titlebar,modal&quot;</span>
<a href="#l2.2921"></a><span id="l2.2921" class="difflineplus">+      );</span>
<a href="#l2.2922"></a><span id="l2.2922">     }</span>
<a href="#l2.2923"></a><span id="l2.2923">   },</span>
<a href="#l2.2924"></a><span id="l2.2924"> };</span>
<a href="#l2.2925"></a><span id="l2.2925" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/editor/ui/composer/content/editor.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/editor/ui/composer/content/editor.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -3,105 +3,142 @@</span>
<a href="#l3.4"></a><span id="l3.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.5"></a><span id="l3.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> /* import-globals-from ../../../../mail/base/content/utilityOverlay.js */</span>
<a href="#l3.8"></a><span id="l3.8"> /* import-globals-from ComposerCommands.js */</span>
<a href="#l3.9"></a><span id="l3.9"> /* import-globals-from editorUtilities.js */</span>
<a href="#l3.10"></a><span id="l3.10"> /* globals InlineSpellCheckerUI */</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-var {GetNextUntitledValue} = ChromeUtils.import(&quot;resource:///modules/editorUtilities.jsm&quot;);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-var {Async} = ChromeUtils.import(&quot;resource://services-common/async.js&quot;);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-var {AppConstants} = ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+var { GetNextUntitledValue } = ChromeUtils.import(</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+  &quot;resource:///modules/editorUtilities.jsm&quot;</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+);</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+var { Async } = ChromeUtils.import(&quot;resource://services-common/async.js&quot;);</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+var { AppConstants } = ChromeUtils.import(</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+  &quot;resource://gre/modules/AppConstants.jsm&quot;</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+);</span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23"> /* Main Composer window UI control */</span>
<a href="#l3.24"></a><span id="l3.24"> </span>
<a href="#l3.25"></a><span id="l3.25"> var gComposerWindowControllerID = 0;</span>
<a href="#l3.26"></a><span id="l3.26"> var prefAuthorString = &quot;&quot;;</span>
<a href="#l3.27"></a><span id="l3.27"> </span>
<a href="#l3.28"></a><span id="l3.28"> var kDisplayModeNormal = 0;</span>
<a href="#l3.29"></a><span id="l3.29"> var kDisplayModeAllTags = 1;</span>
<a href="#l3.30"></a><span id="l3.30"> var kDisplayModeSource = 2;</span>
<a href="#l3.31"></a><span id="l3.31"> var kDisplayModePreview = 3;</span>
<a href="#l3.32"></a><span id="l3.32"> </span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-const kDisplayModeMenuIDs = [&quot;viewNormalMode&quot;, &quot;viewAllTagsMode&quot;, &quot;viewSourceMode&quot;, &quot;viewPreviewMode&quot;];</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-const kDisplayModeTabIDS = [&quot;NormalModeButton&quot;, &quot;TagModeButton&quot;, &quot;SourceModeButton&quot;, &quot;PreviewModeButton&quot;];</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+const kDisplayModeMenuIDs = [</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+  &quot;viewNormalMode&quot;,</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+  &quot;viewAllTagsMode&quot;,</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+  &quot;viewSourceMode&quot;,</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+  &quot;viewPreviewMode&quot;,</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+];</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+const kDisplayModeTabIDS = [</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+  &quot;NormalModeButton&quot;,</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+  &quot;TagModeButton&quot;,</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+  &quot;SourceModeButton&quot;,</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+  &quot;PreviewModeButton&quot;,</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+];</span>
<a href="#l3.47"></a><span id="l3.47"> const kNormalStyleSheet = &quot;chrome://editor/content/EditorContent.css&quot;;</span>
<a href="#l3.48"></a><span id="l3.48"> const kAllTagsStyleSheet = &quot;chrome://editor/content/EditorAllTags.css&quot;;</span>
<a href="#l3.49"></a><span id="l3.49"> const kContentEditableStyleSheet = &quot;resource://gre/res/contenteditable.css&quot;;</span>
<a href="#l3.50"></a><span id="l3.50"> </span>
<a href="#l3.51"></a><span id="l3.51"> var kTextMimeType = &quot;text/plain&quot;;</span>
<a href="#l3.52"></a><span id="l3.52"> var kHTMLMimeType = &quot;text/html&quot;;</span>
<a href="#l3.53"></a><span id="l3.53"> var kXHTMLMimeType = &quot;application/xhtml+xml&quot;;</span>
<a href="#l3.54"></a><span id="l3.54"> </span>
<a href="#l3.55"></a><span id="l3.55"> var gPreviousNonSourceDisplayMode = 1;</span>
<a href="#l3.56"></a><span id="l3.56"> var gEditorDisplayMode = -1;</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-var gDocWasModified = false;  // Check if clean document, if clean then unload when user &quot;Opens&quot;</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+var gDocWasModified = false; // Check if clean document, if clean then unload when user &quot;Opens&quot;</span>
<a href="#l3.59"></a><span id="l3.59"> var gContentWindow = 0;</span>
<a href="#l3.60"></a><span id="l3.60"> var gSourceContentWindow = 0;</span>
<a href="#l3.61"></a><span id="l3.61"> var gSourceTextEditor = null;</span>
<a href="#l3.62"></a><span id="l3.62"> var gContentWindowDeck;</span>
<a href="#l3.63"></a><span id="l3.63"> var gFormatToolbar;</span>
<a href="#l3.64"></a><span id="l3.64"> var gFormatToolbarHidden = false;</span>
<a href="#l3.65"></a><span id="l3.65"> var gViewFormatToolbar;</span>
<a href="#l3.66"></a><span id="l3.66"> var gChromeState;</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-var gColorObj = { LastTextColor: &quot;&quot;, LastBackgroundColor: &quot;&quot;, LastHighlightColor: &quot;&quot;,</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-                  Type: &quot;&quot;, SelectedType: &quot;&quot;, NoDefault: false, Cancel: false,</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-                  HighlightColor: &quot;&quot;, BackgroundColor: &quot;&quot;, PageColor: &quot;&quot;,</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-                  TextColor: &quot;&quot;, TableColor: &quot;&quot;, CellColor: &quot;&quot;,</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-                };</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+var gColorObj = {</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+  LastTextColor: &quot;&quot;,</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+  LastBackgroundColor: &quot;&quot;,</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+  LastHighlightColor: &quot;&quot;,</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+  Type: &quot;&quot;,</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+  SelectedType: &quot;&quot;,</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+  NoDefault: false,</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+  Cancel: false,</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+  HighlightColor: &quot;&quot;,</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+  BackgroundColor: &quot;&quot;,</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+  PageColor: &quot;&quot;,</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+  TextColor: &quot;&quot;,</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+  TableColor: &quot;&quot;,</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+  CellColor: &quot;&quot;,</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+};</span>
<a href="#l3.87"></a><span id="l3.87"> var gDefaultTextColor = &quot;&quot;;</span>
<a href="#l3.88"></a><span id="l3.88"> var gDefaultBackgroundColor = &quot;&quot;;</span>
<a href="#l3.89"></a><span id="l3.89"> var gCSSPrefListener;</span>
<a href="#l3.90"></a><span id="l3.90"> var gEditorToolbarPrefListener;</span>
<a href="#l3.91"></a><span id="l3.91"> var gReturnInParagraphPrefListener;</span>
<a href="#l3.92"></a><span id="l3.92"> var gLocalFonts = null;</span>
<a href="#l3.93"></a><span id="l3.93"> </span>
<a href="#l3.94"></a><span id="l3.94"> var gLastFocusNode = null;</span>
<a href="#l3.95"></a><span id="l3.95"> var gLastFocusNodeWasSelected = false;</span>
<a href="#l3.96"></a><span id="l3.96"> </span>
<a href="#l3.97"></a><span id="l3.97"> // These must be kept in synch with the XUL &lt;options&gt; lists</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-var gFontSizeNames = [&quot;xx-small&quot;, &quot;x-small&quot;, &quot;small&quot;, &quot;medium&quot;, &quot;large&quot;, &quot;x-large&quot;, &quot;xx-large&quot;];</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+var gFontSizeNames = [</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+  &quot;xx-small&quot;,</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+  &quot;x-small&quot;,</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+  &quot;small&quot;,</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+  &quot;medium&quot;,</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+  &quot;large&quot;,</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+  &quot;x-large&quot;,</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+  &quot;xx-large&quot;,</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+];</span>
<a href="#l3.108"></a><span id="l3.108"> </span>
<a href="#l3.109"></a><span id="l3.109"> var nsIFilePicker = Ci.nsIFilePicker;</span>
<a href="#l3.110"></a><span id="l3.110"> </span>
<a href="#l3.111"></a><span id="l3.111"> var kEditorToolbarPrefs = &quot;editor.toolbars.showbutton.&quot;;</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-var kUseCssPref         = &quot;editor.use_css&quot;;</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+var kUseCssPref = &quot;editor.use_css&quot;;</span>
<a href="#l3.114"></a><span id="l3.114"> var kCRInParagraphsPref = &quot;editor.CR_creates_new_p&quot;;</span>
<a href="#l3.115"></a><span id="l3.115"> </span>
<a href="#l3.116"></a><span id="l3.116"> function ShowHideToolbarSeparators(toolbar) {</span>
<a href="#l3.117"></a><span id="l3.117">   // Make sure the toolbar actually exists.</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineminus">-  if (!toolbar)</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+  if (!toolbar) {</span>
<a href="#l3.120"></a><span id="l3.120">     return;</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+  }</span>
<a href="#l3.122"></a><span id="l3.122">   var childNodes = toolbar.childNodes;</span>
<a href="#l3.123"></a><span id="l3.123">   var separator = null;</span>
<a href="#l3.124"></a><span id="l3.124">   var hideSeparator = true;</span>
<a href="#l3.125"></a><span id="l3.125">   for (var i = 0; childNodes[i].localName != &quot;spacer&quot;; i++) {</span>
<a href="#l3.126"></a><span id="l3.126">     if (childNodes[i].localName == &quot;toolbarseparator&quot;) {</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-      if (separator)</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+      if (separator) {</span>
<a href="#l3.129"></a><span id="l3.129">         separator.hidden = true;</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+      }</span>
<a href="#l3.131"></a><span id="l3.131">       separator = childNodes[i];</span>
<a href="#l3.132"></a><span id="l3.132">     } else if (!childNodes[i].hidden) {</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineminus">-      if (separator)</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+      if (separator) {</span>
<a href="#l3.135"></a><span id="l3.135">         separator.hidden = hideSeparator;</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+      }</span>
<a href="#l3.137"></a><span id="l3.137">       separator = null;</span>
<a href="#l3.138"></a><span id="l3.138">       hideSeparator = false;</span>
<a href="#l3.139"></a><span id="l3.139">     }</span>
<a href="#l3.140"></a><span id="l3.140">   }</span>
<a href="#l3.141"></a><span id="l3.141"> }</span>
<a href="#l3.142"></a><span id="l3.142"> </span>
<a href="#l3.143"></a><span id="l3.143"> function ShowHideToolbarButtons() {</span>
<a href="#l3.144"></a><span id="l3.144">   let array = Services.prefs.getChildList(kEditorToolbarPrefs);</span>
<a href="#l3.145"></a><span id="l3.145">   for (let i in array) {</span>
<a href="#l3.146"></a><span id="l3.146">     let prefName = array[i];</span>
<a href="#l3.147"></a><span id="l3.147">     let id = prefName.substr(kEditorToolbarPrefs.length);</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineminus">-    let button = document.getElementById(id + &quot;Button&quot;) ||</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-                 document.getElementById(id + &quot;-button&quot;);</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineminus">-    if (button)</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+    let button =</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+      document.getElementById(id + &quot;Button&quot;) ||</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+      document.getElementById(id + &quot;-button&quot;);</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineplus">+    if (button) {</span>
<a href="#l3.155"></a><span id="l3.155">       button.hidden = !Services.prefs.getBoolPref(prefName);</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+    }</span>
<a href="#l3.157"></a><span id="l3.157">   }</span>
<a href="#l3.158"></a><span id="l3.158">   ShowHideToolbarSeparators(document.getElementById(&quot;EditToolbar&quot;));</span>
<a href="#l3.159"></a><span id="l3.159">   ShowHideToolbarSeparators(document.getElementById(&quot;FormatToolbar&quot;));</span>
<a href="#l3.160"></a><span id="l3.160"> }</span>
<a href="#l3.161"></a><span id="l3.161"> </span>
<a href="#l3.162"></a><span id="l3.162"> function nsPrefListener(prefName) {</span>
<a href="#l3.163"></a><span id="l3.163">   this.startup(prefName);</span>
<a href="#l3.164"></a><span id="l3.164"> }</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineat">@@ -120,21 +157,23 @@ nsPrefListener.prototype = {</span>
<a href="#l3.166"></a><span id="l3.166">   shutdown() {</span>
<a href="#l3.167"></a><span id="l3.167">     try {</span>
<a href="#l3.168"></a><span id="l3.168">       Services.prefs.removeObserver(this.domain, this);</span>
<a href="#l3.169"></a><span id="l3.169">     } catch (ex) {</span>
<a href="#l3.170"></a><span id="l3.170">       dump(&quot;Failed to remove pref observers: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l3.171"></a><span id="l3.171">     }</span>
<a href="#l3.172"></a><span id="l3.172">   },</span>
<a href="#l3.173"></a><span id="l3.173">   observe(subject, topic, prefName) {</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-    if (!IsHTMLEditor())</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineplus">+    if (!IsHTMLEditor()) {</span>
<a href="#l3.176"></a><span id="l3.176">       return;</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+    }</span>
<a href="#l3.178"></a><span id="l3.178">     // verify that we're changing a button pref</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineminus">-    if (topic != &quot;nsPref:changed&quot;)</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineplus">+    if (topic != &quot;nsPref:changed&quot;) {</span>
<a href="#l3.181"></a><span id="l3.181">       return;</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+    }</span>
<a href="#l3.183"></a><span id="l3.183"> </span>
<a href="#l3.184"></a><span id="l3.184">     let editor = GetCurrentEditor();</span>
<a href="#l3.185"></a><span id="l3.185">     if (prefName == kUseCssPref) {</span>
<a href="#l3.186"></a><span id="l3.186">       let cmd = document.getElementById(&quot;cmd_highlight&quot;);</span>
<a href="#l3.187"></a><span id="l3.187">       if (cmd) {</span>
<a href="#l3.188"></a><span id="l3.188">         let useCSS = Services.prefs.getBoolPref(prefName);</span>
<a href="#l3.189"></a><span id="l3.189"> </span>
<a href="#l3.190"></a><span id="l3.190">         if (useCSS &amp;&amp; editor) {</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineat">@@ -142,28 +181,31 @@ nsPrefListener.prototype = {</span>
<a href="#l3.192"></a><span id="l3.192">           let state = editor.getHighlightColorState(mixedObj);</span>
<a href="#l3.193"></a><span id="l3.193">           cmd.setAttribute(&quot;state&quot;, state);</span>
<a href="#l3.194"></a><span id="l3.194">           cmd.collapsed = false;</span>
<a href="#l3.195"></a><span id="l3.195">         } else {</span>
<a href="#l3.196"></a><span id="l3.196">           cmd.setAttribute(&quot;state&quot;, &quot;transparent&quot;);</span>
<a href="#l3.197"></a><span id="l3.197">           cmd.collapsed = true;</span>
<a href="#l3.198"></a><span id="l3.198">         }</span>
<a href="#l3.199"></a><span id="l3.199"> </span>
<a href="#l3.200"></a><span id="l3.200" class="difflineminus">-        if (editor)</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineplus">+        if (editor) {</span>
<a href="#l3.202"></a><span id="l3.202">           editor.isCSSEnabled = useCSS;</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+        }</span>
<a href="#l3.204"></a><span id="l3.204">       }</span>
<a href="#l3.205"></a><span id="l3.205">     } else if (prefName.startsWith(kEditorToolbarPrefs)) {</span>
<a href="#l3.206"></a><span id="l3.206">       let id = prefName.substr(kEditorToolbarPrefs.length) + &quot;Button&quot;;</span>
<a href="#l3.207"></a><span id="l3.207">       let button = document.getElementById(id);</span>
<a href="#l3.208"></a><span id="l3.208">       if (button) {</span>
<a href="#l3.209"></a><span id="l3.209">         button.hidden = !Services.prefs.getBoolPref(prefName);</span>
<a href="#l3.210"></a><span id="l3.210">         ShowHideToolbarSeparators(button.parentNode);</span>
<a href="#l3.211"></a><span id="l3.211">       }</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-    } else if (editor &amp;&amp; (prefName == kCRInParagraphsPref)) {</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineminus">-      editor.returnInParagraphCreatesNewParagraph = Services.prefs.getBoolPref(prefName);</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineplus">+    } else if (editor &amp;&amp; prefName == kCRInParagraphsPref) {</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+      editor.returnInParagraphCreatesNewParagraph = Services.prefs.getBoolPref(</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+        prefName</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineplus">+      );</span>
<a href="#l3.218"></a><span id="l3.218">     }</span>
<a href="#l3.219"></a><span id="l3.219">   },</span>
<a href="#l3.220"></a><span id="l3.220"> };</span>
<a href="#l3.221"></a><span id="l3.221"> </span>
<a href="#l3.222"></a><span id="l3.222"> const gSourceTextListener = {</span>
<a href="#l3.223"></a><span id="l3.223">   NotifyDocumentCreated() {},</span>
<a href="#l3.224"></a><span id="l3.224">   NotifyDocumentWillBeDestroyed() {},</span>
<a href="#l3.225"></a><span id="l3.225">   NotifyDocumentStateChanged(isChanged) {</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineat">@@ -201,83 +243,94 @@ var DocumentReloadListener = {</span>
<a href="#l3.227"></a><span id="l3.227">   },</span>
<a href="#l3.228"></a><span id="l3.228"> };</span>
<a href="#l3.229"></a><span id="l3.229"> </span>
<a href="#l3.230"></a><span id="l3.230"> // implements nsIObserver</span>
<a href="#l3.231"></a><span id="l3.231"> var gEditorDocumentObserver = {</span>
<a href="#l3.232"></a><span id="l3.232">   observe(aSubject, aTopic, aData) {</span>
<a href="#l3.233"></a><span id="l3.233">     // Should we allow this even if NOT the focused editor?</span>
<a href="#l3.234"></a><span id="l3.234">     var commandManager = GetCurrentCommandManager();</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineminus">-    if (commandManager != aSubject)</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineplus">+    if (commandManager != aSubject) {</span>
<a href="#l3.237"></a><span id="l3.237">       return;</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineplus">+    }</span>
<a href="#l3.239"></a><span id="l3.239"> </span>
<a href="#l3.240"></a><span id="l3.240">     var editor = GetCurrentEditor();</span>
<a href="#l3.241"></a><span id="l3.241">     switch (aTopic) {</span>
<a href="#l3.242"></a><span id="l3.242">       case &quot;obs_documentCreated&quot;:</span>
<a href="#l3.243"></a><span id="l3.243">         // Just for convenience</span>
<a href="#l3.244"></a><span id="l3.244">         gContentWindow = window.content;</span>
<a href="#l3.245"></a><span id="l3.245"> </span>
<a href="#l3.246"></a><span id="l3.246">         // Get state to see if document creation succeeded</span>
<a href="#l3.247"></a><span id="l3.247">         var params = newCommandParams();</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineminus">-        if (!params)</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineplus">+        if (!params) {</span>
<a href="#l3.250"></a><span id="l3.250">           return;</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineplus">+        }</span>
<a href="#l3.252"></a><span id="l3.252"> </span>
<a href="#l3.253"></a><span id="l3.253">         try {</span>
<a href="#l3.254"></a><span id="l3.254">           commandManager.getCommandState(aTopic, gContentWindow, params);</span>
<a href="#l3.255"></a><span id="l3.255">           var errorStringId = 0;</span>
<a href="#l3.256"></a><span id="l3.256">           var editorStatus = params.getLongValue(&quot;state_data&quot;);</span>
<a href="#l3.257"></a><span id="l3.257">           if (!editor &amp;&amp; editorStatus == nsIEditingSession.eEditorOK) {</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineminus">-            dump(&quot;\n ****** NO EDITOR BUT NO EDITOR ERROR REPORTED ******* \n\n&quot;);</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineplus">+            dump(</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineplus">+              &quot;\n ****** NO EDITOR BUT NO EDITOR ERROR REPORTED ******* \n\n&quot;</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineplus">+            );</span>
<a href="#l3.262"></a><span id="l3.262">             editorStatus = nsIEditingSession.eEditorErrorUnknown;</span>
<a href="#l3.263"></a><span id="l3.263">           }</span>
<a href="#l3.264"></a><span id="l3.264"> </span>
<a href="#l3.265"></a><span id="l3.265">           switch (editorStatus) {</span>
<a href="#l3.266"></a><span id="l3.266">             case nsIEditingSession.eEditorErrorCantEditFramesets:</span>
<a href="#l3.267"></a><span id="l3.267">               errorStringId = &quot;CantEditFramesetMsg&quot;;</span>
<a href="#l3.268"></a><span id="l3.268">               break;</span>
<a href="#l3.269"></a><span id="l3.269">             case nsIEditingSession.eEditorErrorCantEditMimeType:</span>
<a href="#l3.270"></a><span id="l3.270">               errorStringId = &quot;CantEditMimeTypeMsg&quot;;</span>
<a href="#l3.271"></a><span id="l3.271">               break;</span>
<a href="#l3.272"></a><span id="l3.272">             case nsIEditingSession.eEditorErrorUnknown:</span>
<a href="#l3.273"></a><span id="l3.273">               errorStringId = &quot;CantEditDocumentMsg&quot;;</span>
<a href="#l3.274"></a><span id="l3.274">               break;</span>
<a href="#l3.275"></a><span id="l3.275">             // Note that for &quot;eEditorErrorFileNotFound,</span>
<a href="#l3.276"></a><span id="l3.276">             // network code popped up an alert dialog, so we don't need to</span>
<a href="#l3.277"></a><span id="l3.277">           }</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineminus">-          if (errorStringId)</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineplus">+          if (errorStringId) {</span>
<a href="#l3.280"></a><span id="l3.280">             Services.prompt.alert(window, &quot;&quot;, GetString(errorStringId));</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineplus">+          }</span>
<a href="#l3.282"></a><span id="l3.282">         } catch (e) {</span>
<a href="#l3.283"></a><span id="l3.283">           dump(&quot;EXCEPTION GETTING obs_documentCreated state &quot; + e + &quot;\n&quot;);</span>
<a href="#l3.284"></a><span id="l3.284">         }</span>
<a href="#l3.285"></a><span id="l3.285"> </span>
<a href="#l3.286"></a><span id="l3.286">         // We have a bad editor -- nsIEditingSession will rebuild an editor</span>
<a href="#l3.287"></a><span id="l3.287">         //   with a blank page, so simply abort here</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineminus">-        if (editorStatus)</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineplus">+        if (editorStatus) {</span>
<a href="#l3.290"></a><span id="l3.290">           return;</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineminus">-</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineminus">-        if (!(&quot;InsertCharWindow&quot; in window))</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineplus">+        }</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineplus">+</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineplus">+        if (!(&quot;InsertCharWindow&quot; in window)) {</span>
<a href="#l3.296"></a><span id="l3.296">           window.InsertCharWindow = null;</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineplus">+        }</span>
<a href="#l3.298"></a><span id="l3.298"> </span>
<a href="#l3.299"></a><span id="l3.299">         try {</span>
<a href="#l3.300"></a><span id="l3.300">           editor.QueryInterface(nsIEditorStyleSheets);</span>
<a href="#l3.301"></a><span id="l3.301"> </span>
<a href="#l3.302"></a><span id="l3.302">           //  and extra styles for showing anchors, table borders, smileys, etc</span>
<a href="#l3.303"></a><span id="l3.303">           editor.addOverrideStyleSheet(kNormalStyleSheet);</span>
<a href="#l3.304"></a><span id="l3.304"> </span>
<a href="#l3.305"></a><span id="l3.305">           // remove contenteditable stylesheets if they were applied by the</span>
<a href="#l3.306"></a><span id="l3.306">           // editingSession</span>
<a href="#l3.307"></a><span id="l3.307">           editor.removeOverrideStyleSheet(kContentEditableStyleSheet);</span>
<a href="#l3.308"></a><span id="l3.308">         } catch (e) {}</span>
<a href="#l3.309"></a><span id="l3.309"> </span>
<a href="#l3.310"></a><span id="l3.310">         // Things for just the Web Composer application</span>
<a href="#l3.311"></a><span id="l3.311">         if (IsWebComposer()) {</span>
<a href="#l3.312"></a><span id="l3.312">           InlineSpellCheckerUI.init(editor);</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineminus">-          document.getElementById(&quot;menu_inlineSpellCheck&quot;).setAttribute(&quot;disabled&quot;, !InlineSpellCheckerUI.canSpellCheck);</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineminus">-</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineminus">-          editor.returnInParagraphCreatesNewParagraph = Services.prefs.getBoolPref(kCRInParagraphsPref);</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineplus">+          document</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineplus">+            .getElementById(&quot;menu_inlineSpellCheck&quot;)</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineplus">+            .setAttribute(&quot;disabled&quot;, !InlineSpellCheckerUI.canSpellCheck);</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineplus">+</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineplus">+          editor.returnInParagraphCreatesNewParagraph = Services.prefs.getBoolPref(</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineplus">+            kCRInParagraphsPref</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineplus">+          );</span>
<a href="#l3.323"></a><span id="l3.323"> </span>
<a href="#l3.324"></a><span id="l3.324">           // Set focus to content window if not a mail composer</span>
<a href="#l3.325"></a><span id="l3.325">           // Race conditions prevent us from setting focus here</span>
<a href="#l3.326"></a><span id="l3.326">           //   when loading a url into blank window</span>
<a href="#l3.327"></a><span id="l3.327">           setTimeout(SetFocusOnStartup, 0);</span>
<a href="#l3.328"></a><span id="l3.328"> </span>
<a href="#l3.329"></a><span id="l3.329">           // Call EditorSetDefaultPrefsAndDoctype first so it gets the default author before initing toolbars</span>
<a href="#l3.330"></a><span id="l3.330">           editor.enableUndo(false);</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineat">@@ -307,36 +360,39 @@ var gEditorDocumentObserver = {</span>
<a href="#l3.332"></a><span id="l3.332">             HideItem(&quot;linkButton&quot;);</span>
<a href="#l3.333"></a><span id="l3.333">             HideItem(&quot;namedAnchorButton&quot;);</span>
<a href="#l3.334"></a><span id="l3.334">             HideItem(&quot;hlineButton&quot;);</span>
<a href="#l3.335"></a><span id="l3.335">             HideItem(&quot;tableButton&quot;);</span>
<a href="#l3.336"></a><span id="l3.336"> </span>
<a href="#l3.337"></a><span id="l3.337">             HideItem(&quot;fileExportToText&quot;);</span>
<a href="#l3.338"></a><span id="l3.338">             HideItem(&quot;previewInBrowser&quot;);</span>
<a href="#l3.339"></a><span id="l3.339"> </span>
<a href="#l3.340"></a><span id="l3.340" class="difflineminus">-/* XXX When paste actually converts formatted rich text to pretty formatted plain text</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineplus">+            /* XXX When paste actually converts formatted rich text to pretty formatted plain text</span>
<a href="#l3.342"></a><span id="l3.342">        and pasteNoFormatting is fixed to paste the text without formatting (what paste</span>
<a href="#l3.343"></a><span id="l3.343">        currently does), then this item shouldn't be hidden: */</span>
<a href="#l3.344"></a><span id="l3.344">             HideItem(&quot;menu_pasteNoFormatting&quot;);</span>
<a href="#l3.345"></a><span id="l3.345"> </span>
<a href="#l3.346"></a><span id="l3.346">             HideItem(&quot;cmd_viewFormatToolbar&quot;);</span>
<a href="#l3.347"></a><span id="l3.347">             HideItem(&quot;cmd_viewEditModeToolbar&quot;);</span>
<a href="#l3.348"></a><span id="l3.348"> </span>
<a href="#l3.349"></a><span id="l3.349">             HideItem(&quot;viewSep1&quot;);</span>
<a href="#l3.350"></a><span id="l3.350">             HideItem(&quot;viewNormalMode&quot;);</span>
<a href="#l3.351"></a><span id="l3.351">             HideItem(&quot;viewAllTagsMode&quot;);</span>
<a href="#l3.352"></a><span id="l3.352">             HideItem(&quot;viewSourceMode&quot;);</span>
<a href="#l3.353"></a><span id="l3.353">             HideItem(&quot;viewPreviewMode&quot;);</span>
<a href="#l3.354"></a><span id="l3.354"> </span>
<a href="#l3.355"></a><span id="l3.355">             HideItem(&quot;structSpacer&quot;);</span>
<a href="#l3.356"></a><span id="l3.356"> </span>
<a href="#l3.357"></a><span id="l3.357">             // Hide everything in &quot;Insert&quot; except for &quot;Symbols&quot;</span>
<a href="#l3.358"></a><span id="l3.358" class="difflineminus">-            let menuPopupChildren = document.querySelectorAll('[id=&quot;insertMenuPopup&quot;] &gt; :not(#insertChars)');</span>
<a href="#l3.359"></a><span id="l3.359" class="difflineminus">-            for (let i = 0; i &lt; menuPopupChildren.length; i++)</span>
<a href="#l3.360"></a><span id="l3.360" class="difflineplus">+            let menuPopupChildren = document.querySelectorAll(</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineplus">+              '[id=&quot;insertMenuPopup&quot;] &gt; :not(#insertChars)'</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineplus">+            );</span>
<a href="#l3.363"></a><span id="l3.363" class="difflineplus">+            for (let i = 0; i &lt; menuPopupChildren.length; i++) {</span>
<a href="#l3.364"></a><span id="l3.364">               menuPopupChildren.item(i).hidden = true;</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineplus">+            }</span>
<a href="#l3.366"></a><span id="l3.366">           }</span>
<a href="#l3.367"></a><span id="l3.367"> </span>
<a href="#l3.368"></a><span id="l3.368">           // Set window title</span>
<a href="#l3.369"></a><span id="l3.369">           UpdateWindowTitle();</span>
<a href="#l3.370"></a><span id="l3.370"> </span>
<a href="#l3.371"></a><span id="l3.371">           // We must wait until document is created to get proper Url</span>
<a href="#l3.372"></a><span id="l3.372">           // (Windows may load with local file paths)</span>
<a href="#l3.373"></a><span id="l3.373">           SetSaveAndPublishUI(GetDocumentUrl());</span>
<a href="#l3.374"></a><span id="l3.374" class="difflineat">@@ -359,22 +415,23 @@ var gEditorDocumentObserver = {</span>
<a href="#l3.375"></a><span id="l3.375"> </span>
<a href="#l3.376"></a><span id="l3.376">       case &quot;obs_documentWillBeDestroyed&quot;:</span>
<a href="#l3.377"></a><span id="l3.377">         dump(&quot;obs_documentWillBeDestroyed notification\n&quot;);</span>
<a href="#l3.378"></a><span id="l3.378">         break;</span>
<a href="#l3.379"></a><span id="l3.379"> </span>
<a href="#l3.380"></a><span id="l3.380">       case &quot;obs_documentLocationChanged&quot;:</span>
<a href="#l3.381"></a><span id="l3.381">         // Ignore this when editor doesn't exist,</span>
<a href="#l3.382"></a><span id="l3.382">         //   which happens once when page load starts</span>
<a href="#l3.383"></a><span id="l3.383" class="difflineminus">-        if (editor)</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineplus">+        if (editor) {</span>
<a href="#l3.385"></a><span id="l3.385">           try {</span>
<a href="#l3.386"></a><span id="l3.386">             editor.updateBaseURL();</span>
<a href="#l3.387"></a><span id="l3.387">           } catch (e) {</span>
<a href="#l3.388"></a><span id="l3.388">             dump(e);</span>
<a href="#l3.389"></a><span id="l3.389">           }</span>
<a href="#l3.390"></a><span id="l3.390" class="difflineplus">+        }</span>
<a href="#l3.391"></a><span id="l3.391">         break;</span>
<a href="#l3.392"></a><span id="l3.392"> </span>
<a href="#l3.393"></a><span id="l3.393">       case &quot;cmd_bold&quot;:</span>
<a href="#l3.394"></a><span id="l3.394">         // Update all style items</span>
<a href="#l3.395"></a><span id="l3.395">         // cmd_bold is a proxy; see EditorSharedStartup (above) for details</span>
<a href="#l3.396"></a><span id="l3.396">         window.updateCommands(&quot;style&quot;);</span>
<a href="#l3.397"></a><span id="l3.397">         window.updateCommands(&quot;undo&quot;);</span>
<a href="#l3.398"></a><span id="l3.398">         break;</span>
<a href="#l3.399"></a><span id="l3.399" class="difflineat">@@ -405,30 +462,43 @@ function EditorSharedStartup() {</span>
<a href="#l3.400"></a><span id="l3.400">   // Just for convenience</span>
<a href="#l3.401"></a><span id="l3.401">   gContentWindow = window.content;</span>
<a href="#l3.402"></a><span id="l3.402"> </span>
<a href="#l3.403"></a><span id="l3.403">   // Disable DNS Prefetching on the docshell - we don't need it for composer</span>
<a href="#l3.404"></a><span id="l3.404">   // type windows.</span>
<a href="#l3.405"></a><span id="l3.405">   GetCurrentEditorElement().docShell.allowDNSPrefetch = false;</span>
<a href="#l3.406"></a><span id="l3.406"> </span>
<a href="#l3.407"></a><span id="l3.407">   // Set up the mime type and register the commands.</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineminus">-  if (IsHTMLEditor())</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineplus">+  if (IsHTMLEditor()) {</span>
<a href="#l3.410"></a><span id="l3.410">     SetupHTMLEditorCommands();</span>
<a href="#l3.411"></a><span id="l3.411" class="difflineminus">-  else</span>
<a href="#l3.412"></a><span id="l3.412" class="difflineplus">+  } else {</span>
<a href="#l3.413"></a><span id="l3.413">     SetupTextEditorCommands();</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineplus">+  }</span>
<a href="#l3.415"></a><span id="l3.415"> </span>
<a href="#l3.416"></a><span id="l3.416">   // add observer to be called when document is really done loading</span>
<a href="#l3.417"></a><span id="l3.417">   // and is modified</span>
<a href="#l3.418"></a><span id="l3.418">   // Note: We're really screwed if we fail to install this observer!</span>
<a href="#l3.419"></a><span id="l3.419">   try {</span>
<a href="#l3.420"></a><span id="l3.420">     var commandManager = GetCurrentCommandManager();</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineminus">-    commandManager.addCommandObserver(gEditorDocumentObserver, &quot;obs_documentCreated&quot;);</span>
<a href="#l3.422"></a><span id="l3.422" class="difflineminus">-    commandManager.addCommandObserver(gEditorDocumentObserver, &quot;cmd_setDocumentModified&quot;);</span>
<a href="#l3.423"></a><span id="l3.423" class="difflineminus">-    commandManager.addCommandObserver(gEditorDocumentObserver, &quot;obs_documentWillBeDestroyed&quot;);</span>
<a href="#l3.424"></a><span id="l3.424" class="difflineminus">-    commandManager.addCommandObserver(gEditorDocumentObserver, &quot;obs_documentLocationChanged&quot;);</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineplus">+    commandManager.addCommandObserver(</span>
<a href="#l3.426"></a><span id="l3.426" class="difflineplus">+      gEditorDocumentObserver,</span>
<a href="#l3.427"></a><span id="l3.427" class="difflineplus">+      &quot;obs_documentCreated&quot;</span>
<a href="#l3.428"></a><span id="l3.428" class="difflineplus">+    );</span>
<a href="#l3.429"></a><span id="l3.429" class="difflineplus">+    commandManager.addCommandObserver(</span>
<a href="#l3.430"></a><span id="l3.430" class="difflineplus">+      gEditorDocumentObserver,</span>
<a href="#l3.431"></a><span id="l3.431" class="difflineplus">+      &quot;cmd_setDocumentModified&quot;</span>
<a href="#l3.432"></a><span id="l3.432" class="difflineplus">+    );</span>
<a href="#l3.433"></a><span id="l3.433" class="difflineplus">+    commandManager.addCommandObserver(</span>
<a href="#l3.434"></a><span id="l3.434" class="difflineplus">+      gEditorDocumentObserver,</span>
<a href="#l3.435"></a><span id="l3.435" class="difflineplus">+      &quot;obs_documentWillBeDestroyed&quot;</span>
<a href="#l3.436"></a><span id="l3.436" class="difflineplus">+    );</span>
<a href="#l3.437"></a><span id="l3.437" class="difflineplus">+    commandManager.addCommandObserver(</span>
<a href="#l3.438"></a><span id="l3.438" class="difflineplus">+      gEditorDocumentObserver,</span>
<a href="#l3.439"></a><span id="l3.439" class="difflineplus">+      &quot;obs_documentLocationChanged&quot;</span>
<a href="#l3.440"></a><span id="l3.440" class="difflineplus">+    );</span>
<a href="#l3.441"></a><span id="l3.441"> </span>
<a href="#l3.442"></a><span id="l3.442">     // Until nsIControllerCommandGroup-based code is implemented,</span>
<a href="#l3.443"></a><span id="l3.443">     //  we will observe just the bold command to trigger update of</span>
<a href="#l3.444"></a><span id="l3.444">     //  all toolbar style items</span>
<a href="#l3.445"></a><span id="l3.445">     commandManager.addCommandObserver(gEditorDocumentObserver, &quot;cmd_bold&quot;);</span>
<a href="#l3.446"></a><span id="l3.446">   } catch (e) {</span>
<a href="#l3.447"></a><span id="l3.447">     dump(e);</span>
<a href="#l3.448"></a><span id="l3.448">   }</span>
<a href="#l3.449"></a><span id="l3.449" class="difflineat">@@ -464,57 +534,61 @@ function EditorSharedStartup() {</span>
<a href="#l3.450"></a><span id="l3.450"> </span>
<a href="#l3.451"></a><span id="l3.451">   // For new window, no default last-picked colors</span>
<a href="#l3.452"></a><span id="l3.452">   gColorObj.LastTextColor = &quot;&quot;;</span>
<a href="#l3.453"></a><span id="l3.453">   gColorObj.LastBackgroundColor = &quot;&quot;;</span>
<a href="#l3.454"></a><span id="l3.454">   gColorObj.LastHighlightColor = &quot;&quot;;</span>
<a href="#l3.455"></a><span id="l3.455"> }</span>
<a href="#l3.456"></a><span id="l3.456"> </span>
<a href="#l3.457"></a><span id="l3.457"> function SafeSetAttribute(nodeID, attributeName, attributeValue) {</span>
<a href="#l3.458"></a><span id="l3.458" class="difflineminus">-    var theNode = document.getElementById(nodeID);</span>
<a href="#l3.459"></a><span id="l3.459" class="difflineminus">-    if (theNode)</span>
<a href="#l3.460"></a><span id="l3.460" class="difflineminus">-        theNode.setAttribute(attributeName, attributeValue);</span>
<a href="#l3.461"></a><span id="l3.461" class="difflineplus">+  var theNode = document.getElementById(nodeID);</span>
<a href="#l3.462"></a><span id="l3.462" class="difflineplus">+  if (theNode) {</span>
<a href="#l3.463"></a><span id="l3.463" class="difflineplus">+    theNode.setAttribute(attributeName, attributeValue);</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineplus">+  }</span>
<a href="#l3.465"></a><span id="l3.465"> }</span>
<a href="#l3.466"></a><span id="l3.466"> </span>
<a href="#l3.467"></a><span id="l3.467"> function DocumentHasBeenSaved() {</span>
<a href="#l3.468"></a><span id="l3.468">   var fileurl = &quot;&quot;;</span>
<a href="#l3.469"></a><span id="l3.469">   try {</span>
<a href="#l3.470"></a><span id="l3.470">     fileurl = GetDocumentUrl();</span>
<a href="#l3.471"></a><span id="l3.471">   } catch (e) {</span>
<a href="#l3.472"></a><span id="l3.472">     return false;</span>
<a href="#l3.473"></a><span id="l3.473">   }</span>
<a href="#l3.474"></a><span id="l3.474"> </span>
<a href="#l3.475"></a><span id="l3.475" class="difflineminus">-  if (!fileurl || IsUrlAboutBlank(fileurl))</span>
<a href="#l3.476"></a><span id="l3.476" class="difflineplus">+  if (!fileurl || IsUrlAboutBlank(fileurl)) {</span>
<a href="#l3.477"></a><span id="l3.477">     return false;</span>
<a href="#l3.478"></a><span id="l3.478" class="difflineplus">+  }</span>
<a href="#l3.479"></a><span id="l3.479"> </span>
<a href="#l3.480"></a><span id="l3.480">   // We have a file URL already</span>
<a href="#l3.481"></a><span id="l3.481">   return true;</span>
<a href="#l3.482"></a><span id="l3.482"> }</span>
<a href="#l3.483"></a><span id="l3.483"> </span>
<a href="#l3.484"></a><span id="l3.484"> async function CheckAndSaveDocument(command, allowDontSave) {</span>
<a href="#l3.485"></a><span id="l3.485">   var document;</span>
<a href="#l3.486"></a><span id="l3.486">   try {</span>
<a href="#l3.487"></a><span id="l3.487">     // if we don't have an editor or an document, bail</span>
<a href="#l3.488"></a><span id="l3.488">     var editor = GetCurrentEditor();</span>
<a href="#l3.489"></a><span id="l3.489">     document = editor.document;</span>
<a href="#l3.490"></a><span id="l3.490" class="difflineminus">-    if (!document)</span>
<a href="#l3.491"></a><span id="l3.491" class="difflineplus">+    if (!document) {</span>
<a href="#l3.492"></a><span id="l3.492">       return true;</span>
<a href="#l3.493"></a><span id="l3.493" class="difflineplus">+    }</span>
<a href="#l3.494"></a><span id="l3.494">   } catch (e) {</span>
<a href="#l3.495"></a><span id="l3.495">     return true;</span>
<a href="#l3.496"></a><span id="l3.496">   }</span>
<a href="#l3.497"></a><span id="l3.497"> </span>
<a href="#l3.498"></a><span id="l3.498" class="difflineminus">-  if (!IsDocumentModified() &amp;&amp; !IsHTMLSourceChanged())</span>
<a href="#l3.499"></a><span id="l3.499" class="difflineplus">+  if (!IsDocumentModified() &amp;&amp; !IsHTMLSourceChanged()) {</span>
<a href="#l3.500"></a><span id="l3.500">     return true;</span>
<a href="#l3.501"></a><span id="l3.501" class="difflineplus">+  }</span>
<a href="#l3.502"></a><span id="l3.502"> </span>
<a href="#l3.503"></a><span id="l3.503">   // call window.focus, since we need to pop up a dialog</span>
<a href="#l3.504"></a><span id="l3.504">   // and therefore need to be visible (to prevent user confusion)</span>
<a href="#l3.505"></a><span id="l3.505">   top.document.commandDispatcher.focusedWindow.focus();</span>
<a href="#l3.506"></a><span id="l3.506"> </span>
<a href="#l3.507"></a><span id="l3.507">   var scheme = GetScheme(GetDocumentUrl());</span>
<a href="#l3.508"></a><span id="l3.508" class="difflineminus">-  var doPublish = (scheme &amp;&amp; scheme != &quot;file&quot;);</span>
<a href="#l3.509"></a><span id="l3.509" class="difflineplus">+  var doPublish = scheme &amp;&amp; scheme != &quot;file&quot;;</span>
<a href="#l3.510"></a><span id="l3.510"> </span>
<a href="#l3.511"></a><span id="l3.511">   var strID;</span>
<a href="#l3.512"></a><span id="l3.512">   switch (command) {</span>
<a href="#l3.513"></a><span id="l3.513">     case &quot;cmd_close&quot;:</span>
<a href="#l3.514"></a><span id="l3.514">       strID = &quot;BeforeClosing&quot;;</span>
<a href="#l3.515"></a><span id="l3.515">       break;</span>
<a href="#l3.516"></a><span id="l3.516">     case &quot;cmd_preview&quot;:</span>
<a href="#l3.517"></a><span id="l3.517">       strID = &quot;BeforePreview&quot;;</span>
<a href="#l3.518"></a><span id="l3.518" class="difflineat">@@ -528,39 +602,54 @@ async function CheckAndSaveDocument(comm</span>
<a href="#l3.519"></a><span id="l3.519">   }</span>
<a href="#l3.520"></a><span id="l3.520"> </span>
<a href="#l3.521"></a><span id="l3.521">   var reasonToSave = strID ? GetString(strID) : &quot;&quot;;</span>
<a href="#l3.522"></a><span id="l3.522"> </span>
<a href="#l3.523"></a><span id="l3.523">   var title = document.title || GetString(&quot;untitledDefaultFilename&quot;);</span>
<a href="#l3.524"></a><span id="l3.524"> </span>
<a href="#l3.525"></a><span id="l3.525">   var dialogTitle = GetString(doPublish ? &quot;PublishPage&quot; : &quot;SaveDocument&quot;);</span>
<a href="#l3.526"></a><span id="l3.526">   var dialogMsg = GetString(doPublish ? &quot;PublishPrompt&quot; : &quot;SaveFilePrompt&quot;);</span>
<a href="#l3.527"></a><span id="l3.527" class="difflineminus">-  dialogMsg = (dialogMsg.replace(/%title%/, title)).replace(/%reason%/, reasonToSave);</span>
<a href="#l3.528"></a><span id="l3.528" class="difflineminus">-</span>
<a href="#l3.529"></a><span id="l3.529" class="difflineminus">-  let result = {value: 0};</span>
<a href="#l3.530"></a><span id="l3.530" class="difflineminus">-  let promptFlags = Services.prompt.BUTTON_TITLE_CANCEL * Services.prompt.BUTTON_POS_1;</span>
<a href="#l3.531"></a><span id="l3.531" class="difflineplus">+  dialogMsg = dialogMsg</span>
<a href="#l3.532"></a><span id="l3.532" class="difflineplus">+    .replace(/%title%/, title)</span>
<a href="#l3.533"></a><span id="l3.533" class="difflineplus">+    .replace(/%reason%/, reasonToSave);</span>
<a href="#l3.534"></a><span id="l3.534" class="difflineplus">+</span>
<a href="#l3.535"></a><span id="l3.535" class="difflineplus">+  let result = { value: 0 };</span>
<a href="#l3.536"></a><span id="l3.536" class="difflineplus">+  let promptFlags =</span>
<a href="#l3.537"></a><span id="l3.537" class="difflineplus">+    Services.prompt.BUTTON_TITLE_CANCEL * Services.prompt.BUTTON_POS_1;</span>
<a href="#l3.538"></a><span id="l3.538">   let button1Title = null;</span>
<a href="#l3.539"></a><span id="l3.539">   let button3Title = null;</span>
<a href="#l3.540"></a><span id="l3.540"> </span>
<a href="#l3.541"></a><span id="l3.541">   if (doPublish) {</span>
<a href="#l3.542"></a><span id="l3.542" class="difflineminus">-    promptFlags += Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_0;</span>
<a href="#l3.543"></a><span id="l3.543" class="difflineplus">+    promptFlags +=</span>
<a href="#l3.544"></a><span id="l3.544" class="difflineplus">+      Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_0;</span>
<a href="#l3.545"></a><span id="l3.545">     button1Title = GetString(&quot;Publish&quot;);</span>
<a href="#l3.546"></a><span id="l3.546">     button3Title = GetString(&quot;DontPublish&quot;);</span>
<a href="#l3.547"></a><span id="l3.547">   } else {</span>
<a href="#l3.548"></a><span id="l3.548" class="difflineminus">-    promptFlags += Services.prompt.BUTTON_TITLE_SAVE * Services.prompt.BUTTON_POS_0;</span>
<a href="#l3.549"></a><span id="l3.549" class="difflineplus">+    promptFlags +=</span>
<a href="#l3.550"></a><span id="l3.550" class="difflineplus">+      Services.prompt.BUTTON_TITLE_SAVE * Services.prompt.BUTTON_POS_0;</span>
<a href="#l3.551"></a><span id="l3.551">   }</span>
<a href="#l3.552"></a><span id="l3.552"> </span>
<a href="#l3.553"></a><span id="l3.553">   // If allowing &quot;Don't...&quot; button, add that</span>
<a href="#l3.554"></a><span id="l3.554" class="difflineminus">-  if (allowDontSave)</span>
<a href="#l3.555"></a><span id="l3.555" class="difflineminus">-    promptFlags += doPublish ?</span>
<a href="#l3.556"></a><span id="l3.556" class="difflineminus">-        (Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_2)</span>
<a href="#l3.557"></a><span id="l3.557" class="difflineminus">-        : (Services.prompt.BUTTON_TITLE_DONT_SAVE * Services.prompt.BUTTON_POS_2);</span>
<a href="#l3.558"></a><span id="l3.558" class="difflineminus">-</span>
<a href="#l3.559"></a><span id="l3.559" class="difflineminus">-  result = Services.prompt.confirmEx(window, dialogTitle, dialogMsg, promptFlags,</span>
<a href="#l3.560"></a><span id="l3.560" class="difflineminus">-                          button1Title, null, button3Title, null, {value: 0});</span>
<a href="#l3.561"></a><span id="l3.561" class="difflineplus">+  if (allowDontSave) {</span>
<a href="#l3.562"></a><span id="l3.562" class="difflineplus">+    promptFlags += doPublish</span>
<a href="#l3.563"></a><span id="l3.563" class="difflineplus">+      ? Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_2</span>
<a href="#l3.564"></a><span id="l3.564" class="difflineplus">+      : Services.prompt.BUTTON_TITLE_DONT_SAVE * Services.prompt.BUTTON_POS_2;</span>
<a href="#l3.565"></a><span id="l3.565" class="difflineplus">+  }</span>
<a href="#l3.566"></a><span id="l3.566" class="difflineplus">+</span>
<a href="#l3.567"></a><span id="l3.567" class="difflineplus">+  result = Services.prompt.confirmEx(</span>
<a href="#l3.568"></a><span id="l3.568" class="difflineplus">+    window,</span>
<a href="#l3.569"></a><span id="l3.569" class="difflineplus">+    dialogTitle,</span>
<a href="#l3.570"></a><span id="l3.570" class="difflineplus">+    dialogMsg,</span>
<a href="#l3.571"></a><span id="l3.571" class="difflineplus">+    promptFlags,</span>
<a href="#l3.572"></a><span id="l3.572" class="difflineplus">+    button1Title,</span>
<a href="#l3.573"></a><span id="l3.573" class="difflineplus">+    null,</span>
<a href="#l3.574"></a><span id="l3.574" class="difflineplus">+    button3Title,</span>
<a href="#l3.575"></a><span id="l3.575" class="difflineplus">+    null,</span>
<a href="#l3.576"></a><span id="l3.576" class="difflineplus">+    { value: 0 }</span>
<a href="#l3.577"></a><span id="l3.577" class="difflineplus">+  );</span>
<a href="#l3.578"></a><span id="l3.578"> </span>
<a href="#l3.579"></a><span id="l3.579">   if (result == 0) {</span>
<a href="#l3.580"></a><span id="l3.580">     // Save, but first finish HTML source mode</span>
<a href="#l3.581"></a><span id="l3.581">     SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l3.582"></a><span id="l3.582">     if (doPublish) {</span>
<a href="#l3.583"></a><span id="l3.583">       // We save the command the user wanted to do in a global</span>
<a href="#l3.584"></a><span id="l3.584">       // and return as if user canceled because publishing is asynchronous</span>
<a href="#l3.585"></a><span id="l3.585">       // This command will be fired when publishing finishes</span>
<a href="#l3.586"></a><span id="l3.586" class="difflineat">@@ -568,52 +657,57 @@ async function CheckAndSaveDocument(comm</span>
<a href="#l3.587"></a><span id="l3.587">       goDoCommand(&quot;cmd_publish&quot;);</span>
<a href="#l3.588"></a><span id="l3.588">       return false;</span>
<a href="#l3.589"></a><span id="l3.589">     }</span>
<a href="#l3.590"></a><span id="l3.590"> </span>
<a href="#l3.591"></a><span id="l3.591">     // Save to local disk</span>
<a href="#l3.592"></a><span id="l3.592">     return SaveDocument(false, false, editor.contentsMIMEType);</span>
<a href="#l3.593"></a><span id="l3.593">   }</span>
<a href="#l3.594"></a><span id="l3.594"> </span>
<a href="#l3.595"></a><span id="l3.595" class="difflineminus">-  if (result == 2) // &quot;Don't Save&quot;</span>
<a href="#l3.596"></a><span id="l3.596" class="difflineplus">+  if (result == 2) {</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineplus">+    // &quot;Don't Save&quot;</span>
<a href="#l3.598"></a><span id="l3.598">     return true;</span>
<a href="#l3.599"></a><span id="l3.599" class="difflineplus">+  }</span>
<a href="#l3.600"></a><span id="l3.600"> </span>
<a href="#l3.601"></a><span id="l3.601">   // Default or result == 1 (Cancel)</span>
<a href="#l3.602"></a><span id="l3.602">   return false;</span>
<a href="#l3.603"></a><span id="l3.603"> }</span>
<a href="#l3.604"></a><span id="l3.604"> </span>
<a href="#l3.605"></a><span id="l3.605"> // --------------------------- View menu ---------------------------</span>
<a href="#l3.606"></a><span id="l3.606"> </span>
<a href="#l3.607"></a><span id="l3.607"> function EditorSetCharacterSet(aEvent) {</span>
<a href="#l3.608"></a><span id="l3.608">   try {</span>
<a href="#l3.609"></a><span id="l3.609">     var editor = GetCurrentEditor();</span>
<a href="#l3.610"></a><span id="l3.610" class="difflineminus">-    if (aEvent.target.hasAttribute(&quot;charset&quot;))</span>
<a href="#l3.611"></a><span id="l3.611" class="difflineplus">+    if (aEvent.target.hasAttribute(&quot;charset&quot;)) {</span>
<a href="#l3.612"></a><span id="l3.612">       editor.documentCharacterSet = aEvent.target.getAttribute(&quot;charset&quot;);</span>
<a href="#l3.613"></a><span id="l3.613" class="difflineplus">+    }</span>
<a href="#l3.614"></a><span id="l3.614">     var docUrl = GetDocumentUrl();</span>
<a href="#l3.615"></a><span id="l3.615">     if (!IsUrlAboutBlank(docUrl)) {</span>
<a href="#l3.616"></a><span id="l3.616">       // reloading the document will reverse any changes to the META charset,</span>
<a href="#l3.617"></a><span id="l3.617">       // we need to put them back in, which is achieved by a dedicated listener</span>
<a href="#l3.618"></a><span id="l3.618">       editor.addDocumentStateListener(DocumentReloadListener);</span>
<a href="#l3.619"></a><span id="l3.619">       EditorLoadUrl(docUrl);</span>
<a href="#l3.620"></a><span id="l3.620">     }</span>
<a href="#l3.621"></a><span id="l3.621">   } catch (e) {}</span>
<a href="#l3.622"></a><span id="l3.622"> }</span>
<a href="#l3.623"></a><span id="l3.623"> </span>
<a href="#l3.624"></a><span id="l3.624"> // --------------------------- Text style ---------------------------</span>
<a href="#l3.625"></a><span id="l3.625"> </span>
<a href="#l3.626"></a><span id="l3.626"> function onParagraphFormatChange(paraMenuList, commandID) {</span>
<a href="#l3.627"></a><span id="l3.627" class="difflineminus">-  if (!paraMenuList)</span>
<a href="#l3.628"></a><span id="l3.628" class="difflineplus">+  if (!paraMenuList) {</span>
<a href="#l3.629"></a><span id="l3.629">     return;</span>
<a href="#l3.630"></a><span id="l3.630" class="difflineplus">+  }</span>
<a href="#l3.631"></a><span id="l3.631"> </span>
<a href="#l3.632"></a><span id="l3.632">   var commandNode = document.getElementById(commandID);</span>
<a href="#l3.633"></a><span id="l3.633">   var state = commandNode.getAttribute(&quot;state&quot;);</span>
<a href="#l3.634"></a><span id="l3.634"> </span>
<a href="#l3.635"></a><span id="l3.635">   // force match with &quot;normal&quot;</span>
<a href="#l3.636"></a><span id="l3.636" class="difflineminus">-  if (state == &quot;body&quot;)</span>
<a href="#l3.637"></a><span id="l3.637" class="difflineplus">+  if (state == &quot;body&quot;) {</span>
<a href="#l3.638"></a><span id="l3.638">     state = &quot;&quot;;</span>
<a href="#l3.639"></a><span id="l3.639" class="difflineplus">+  }</span>
<a href="#l3.640"></a><span id="l3.640"> </span>
<a href="#l3.641"></a><span id="l3.641">   if (state == &quot;mixed&quot;) {</span>
<a href="#l3.642"></a><span id="l3.642">     // Selection is the &quot;mixed&quot; ( &gt; 1 style) state</span>
<a href="#l3.643"></a><span id="l3.643">     paraMenuList.selectedItem = null;</span>
<a href="#l3.644"></a><span id="l3.644">     paraMenuList.setAttribute(&quot;label&quot;, GetString(&quot;Mixed&quot;));</span>
<a href="#l3.645"></a><span id="l3.645">   } else {</span>
<a href="#l3.646"></a><span id="l3.646">     var menuPopup = document.getElementById(&quot;ParagraphPopup&quot;);</span>
<a href="#l3.647"></a><span id="l3.647">     var menuItems = menuPopup.childNodes;</span>
<a href="#l3.648"></a><span id="l3.648" class="difflineat">@@ -640,46 +734,54 @@ function onFontFaceChange(fontFaceMenuLi</span>
<a href="#l3.649"></a><span id="l3.649"> </span>
<a href="#l3.650"></a><span id="l3.650">   // Strip quotes in font names. Experiments have shown that we only</span>
<a href="#l3.651"></a><span id="l3.651">   // ever get double quotes around the font name, never single quotes,</span>
<a href="#l3.652"></a><span id="l3.652">   // even if they were in the HTML source. Also single or double</span>
<a href="#l3.653"></a><span id="l3.653">   // quotes within the font name are never returned.</span>
<a href="#l3.654"></a><span id="l3.654">   editorFont = editorFont.replace(/&quot;/g, &quot;&quot;);</span>
<a href="#l3.655"></a><span id="l3.655"> </span>
<a href="#l3.656"></a><span id="l3.656">   switch (editorFont) {</span>
<a href="#l3.657"></a><span id="l3.657" class="difflineminus">-  case &quot;mixed&quot;:</span>
<a href="#l3.658"></a><span id="l3.658" class="difflineminus">-    // Selection is the &quot;mixed&quot; ( &gt; 1 style) state.</span>
<a href="#l3.659"></a><span id="l3.659" class="difflineminus">-    fontFaceMenuList.selectedItem = null;</span>
<a href="#l3.660"></a><span id="l3.660" class="difflineminus">-    fontFaceMenuList.setAttribute(&quot;label&quot;, GetString(&quot;Mixed&quot;));</span>
<a href="#l3.661"></a><span id="l3.661" class="difflineminus">-    return;</span>
<a href="#l3.662"></a><span id="l3.662" class="difflineminus">-  case &quot;&quot;:</span>
<a href="#l3.663"></a><span id="l3.663" class="difflineminus">-  case &quot;serif&quot;:</span>
<a href="#l3.664"></a><span id="l3.664" class="difflineminus">-  case &quot;sans-serif&quot;:</span>
<a href="#l3.665"></a><span id="l3.665" class="difflineminus">-    // Generic variable width.</span>
<a href="#l3.666"></a><span id="l3.666" class="difflineminus">-    fontFaceMenuList.selectedIndex = 0;</span>
<a href="#l3.667"></a><span id="l3.667" class="difflineminus">-    return;</span>
<a href="#l3.668"></a><span id="l3.668" class="difflineminus">-  case &quot;tt&quot;:</span>
<a href="#l3.669"></a><span id="l3.669" class="difflineminus">-  case &quot;monospace&quot;:</span>
<a href="#l3.670"></a><span id="l3.670" class="difflineminus">-    // Generic fixed width.</span>
<a href="#l3.671"></a><span id="l3.671" class="difflineminus">-    fontFaceMenuList.selectedIndex = 1;</span>
<a href="#l3.672"></a><span id="l3.672" class="difflineminus">-    return;</span>
<a href="#l3.673"></a><span id="l3.673" class="difflineminus">-  default:</span>
<a href="#l3.674"></a><span id="l3.674" class="difflineplus">+    case &quot;mixed&quot;:</span>
<a href="#l3.675"></a><span id="l3.675" class="difflineplus">+      // Selection is the &quot;mixed&quot; ( &gt; 1 style) state.</span>
<a href="#l3.676"></a><span id="l3.676" class="difflineplus">+      fontFaceMenuList.selectedItem = null;</span>
<a href="#l3.677"></a><span id="l3.677" class="difflineplus">+      fontFaceMenuList.setAttribute(&quot;label&quot;, GetString(&quot;Mixed&quot;));</span>
<a href="#l3.678"></a><span id="l3.678" class="difflineplus">+      return;</span>
<a href="#l3.679"></a><span id="l3.679" class="difflineplus">+    case &quot;&quot;:</span>
<a href="#l3.680"></a><span id="l3.680" class="difflineplus">+    case &quot;serif&quot;:</span>
<a href="#l3.681"></a><span id="l3.681" class="difflineplus">+    case &quot;sans-serif&quot;:</span>
<a href="#l3.682"></a><span id="l3.682" class="difflineplus">+      // Generic variable width.</span>
<a href="#l3.683"></a><span id="l3.683" class="difflineplus">+      fontFaceMenuList.selectedIndex = 0;</span>
<a href="#l3.684"></a><span id="l3.684" class="difflineplus">+      return;</span>
<a href="#l3.685"></a><span id="l3.685" class="difflineplus">+    case &quot;tt&quot;:</span>
<a href="#l3.686"></a><span id="l3.686" class="difflineplus">+    case &quot;monospace&quot;:</span>
<a href="#l3.687"></a><span id="l3.687" class="difflineplus">+      // Generic fixed width.</span>
<a href="#l3.688"></a><span id="l3.688" class="difflineplus">+      fontFaceMenuList.selectedIndex = 1;</span>
<a href="#l3.689"></a><span id="l3.689" class="difflineplus">+      return;</span>
<a href="#l3.690"></a><span id="l3.690" class="difflineplus">+    default:</span>
<a href="#l3.691"></a><span id="l3.691">   }</span>
<a href="#l3.692"></a><span id="l3.692"> </span>
<a href="#l3.693"></a><span id="l3.693">   let menuPopup = fontFaceMenuList.menupopup;</span>
<a href="#l3.694"></a><span id="l3.694">   let menuItems = menuPopup.childNodes;</span>
<a href="#l3.695"></a><span id="l3.695"> </span>
<a href="#l3.696"></a><span id="l3.696" class="difflineminus">-  const genericFamilies = [ &quot;serif&quot;, &quot;sans-serif&quot;, &quot;monospace&quot;, &quot;fantasy&quot;, &quot;cursive&quot; ];</span>
<a href="#l3.697"></a><span id="l3.697" class="difflineplus">+  const genericFamilies = [</span>
<a href="#l3.698"></a><span id="l3.698" class="difflineplus">+    &quot;serif&quot;,</span>
<a href="#l3.699"></a><span id="l3.699" class="difflineplus">+    &quot;sans-serif&quot;,</span>
<a href="#l3.700"></a><span id="l3.700" class="difflineplus">+    &quot;monospace&quot;,</span>
<a href="#l3.701"></a><span id="l3.701" class="difflineplus">+    &quot;fantasy&quot;,</span>
<a href="#l3.702"></a><span id="l3.702" class="difflineplus">+    &quot;cursive&quot;,</span>
<a href="#l3.703"></a><span id="l3.703" class="difflineplus">+  ];</span>
<a href="#l3.704"></a><span id="l3.704">   // Bug 1139524: Normalise before we compare: Make it lower case</span>
<a href="#l3.705"></a><span id="l3.705">   // and replace &quot;, &quot; with &quot;,&quot; so that entries like</span>
<a href="#l3.706"></a><span id="l3.706">   // &quot;Helvetica, Arial, sans-serif&quot; are always recognised correctly</span>
<a href="#l3.707"></a><span id="l3.707">   let editorFontToLower = editorFont.toLowerCase().replace(/, /g, &quot;,&quot;);</span>
<a href="#l3.708"></a><span id="l3.708">   let foundFont = null;</span>
<a href="#l3.709"></a><span id="l3.709">   let exactMatch = false;</span>
<a href="#l3.710"></a><span id="l3.710" class="difflineminus">-  let usedFontsSep = menuPopup.querySelector(&quot;menuseparator.fontFaceMenuAfterUsedFonts&quot;);</span>
<a href="#l3.711"></a><span id="l3.711" class="difflineplus">+  let usedFontsSep = menuPopup.querySelector(</span>
<a href="#l3.712"></a><span id="l3.712" class="difflineplus">+    &quot;menuseparator.fontFaceMenuAfterUsedFonts&quot;</span>
<a href="#l3.713"></a><span id="l3.713" class="difflineplus">+  );</span>
<a href="#l3.714"></a><span id="l3.714">   let editorFontOptions = editorFontToLower.split(&quot;,&quot;);</span>
<a href="#l3.715"></a><span id="l3.715">   let editorOptionsCount = editorFontOptions.length;</span>
<a href="#l3.716"></a><span id="l3.716">   let matchedFontIndex = editorOptionsCount; // initialise to high invalid value</span>
<a href="#l3.717"></a><span id="l3.717"> </span>
<a href="#l3.718"></a><span id="l3.718">   // The font menu has this structure:</span>
<a href="#l3.719"></a><span id="l3.719">   // 0: Variable Width</span>
<a href="#l3.720"></a><span id="l3.720">   // 1: Fixed Width</span>
<a href="#l3.721"></a><span id="l3.721">   // 2: Separator</span>
<a href="#l3.722"></a><span id="l3.722" class="difflineat">@@ -696,80 +798,107 @@ function onFontFaceChange(fontFaceMenuLi</span>
<a href="#l3.723"></a><span id="l3.723">   // The menu items not only have &quot;label&quot; and &quot;value&quot;, but also some other attributes:</span>
<a href="#l3.724"></a><span id="l3.724">   // &quot;value_parsed&quot;: Is the toLowerCase() and space-stripped value.</span>
<a href="#l3.725"></a><span id="l3.725">   // &quot;value_cache&quot;:  Is a concatenation of all editor fonts that were ever mapped</span>
<a href="#l3.726"></a><span id="l3.726">   //                 onto this menu item. This is done for optimization.</span>
<a href="#l3.727"></a><span id="l3.727">   // &quot;used&quot;:         This item is in the used font section.</span>
<a href="#l3.728"></a><span id="l3.728"> </span>
<a href="#l3.729"></a><span id="l3.729">   for (let i = 0; i &lt; menuItems.length; i++) {</span>
<a href="#l3.730"></a><span id="l3.730">     let menuItem = menuItems.item(i);</span>
<a href="#l3.731"></a><span id="l3.731" class="difflineminus">-    if (menuItem.hasAttribute(&quot;label&quot;) &amp;&amp; menuItem.hasAttribute(&quot;value_parsed&quot;)) {</span>
<a href="#l3.732"></a><span id="l3.732" class="difflineplus">+    if (</span>
<a href="#l3.733"></a><span id="l3.733" class="difflineplus">+      menuItem.hasAttribute(&quot;label&quot;) &amp;&amp;</span>
<a href="#l3.734"></a><span id="l3.734" class="difflineplus">+      menuItem.hasAttribute(&quot;value_parsed&quot;)</span>
<a href="#l3.735"></a><span id="l3.735" class="difflineplus">+    ) {</span>
<a href="#l3.736"></a><span id="l3.736">       // The element seems to represent a font &lt;menuitem&gt;.</span>
<a href="#l3.737"></a><span id="l3.737">       let fontMenuValue = menuItem.getAttribute(&quot;value_parsed&quot;);</span>
<a href="#l3.738"></a><span id="l3.738" class="difflineminus">-      if (fontMenuValue == editorFontToLower ||</span>
<a href="#l3.739"></a><span id="l3.739" class="difflineminus">-          (menuItem.hasAttribute(&quot;value_cache&quot;) &amp;&amp;</span>
<a href="#l3.740"></a><span id="l3.740" class="difflineminus">-           menuItem.getAttribute(&quot;value_cache&quot;).split(&quot;|&quot;).includes(editorFontToLower))) {</span>
<a href="#l3.741"></a><span id="l3.741" class="difflineplus">+      if (</span>
<a href="#l3.742"></a><span id="l3.742" class="difflineplus">+        fontMenuValue == editorFontToLower ||</span>
<a href="#l3.743"></a><span id="l3.743" class="difflineplus">+        (menuItem.hasAttribute(&quot;value_cache&quot;) &amp;&amp;</span>
<a href="#l3.744"></a><span id="l3.744" class="difflineplus">+          menuItem</span>
<a href="#l3.745"></a><span id="l3.745" class="difflineplus">+            .getAttribute(&quot;value_cache&quot;)</span>
<a href="#l3.746"></a><span id="l3.746" class="difflineplus">+            .split(&quot;|&quot;)</span>
<a href="#l3.747"></a><span id="l3.747" class="difflineplus">+            .includes(editorFontToLower))</span>
<a href="#l3.748"></a><span id="l3.748" class="difflineplus">+      ) {</span>
<a href="#l3.749"></a><span id="l3.749">         // This menuitem contains the font we are looking for.</span>
<a href="#l3.750"></a><span id="l3.750">         foundFont = menuItem;</span>
<a href="#l3.751"></a><span id="l3.751">         exactMatch = true;</span>
<a href="#l3.752"></a><span id="l3.752">         break;</span>
<a href="#l3.753"></a><span id="l3.753">       } else if (editorOptionsCount &gt; 1 &amp;&amp; afterUsedFontSection) {</span>
<a href="#l3.754"></a><span id="l3.754">         // Once we are in the list of all other available fonts,</span>
<a href="#l3.755"></a><span id="l3.755">         // we will find the one that best matches one of the options.</span>
<a href="#l3.756"></a><span id="l3.756">         let matchPos = editorFontOptions.indexOf(fontMenuValue);</span>
<a href="#l3.757"></a><span id="l3.757">         if (matchPos &gt;= 0 &amp;&amp; matchPos &lt; matchedFontIndex) {</span>
<a href="#l3.758"></a><span id="l3.758">           // This menu font comes earlier in the list of options,</span>
<a href="#l3.759"></a><span id="l3.759">           // so prefer it.</span>
<a href="#l3.760"></a><span id="l3.760">           matchedFontIndex = matchPos;</span>
<a href="#l3.761"></a><span id="l3.761">           foundFont = menuItem;</span>
<a href="#l3.762"></a><span id="l3.762">           // If we matched the first option, we don't need to look for</span>
<a href="#l3.763"></a><span id="l3.763">           // a better match.</span>
<a href="#l3.764"></a><span id="l3.764" class="difflineminus">-          if (matchPos == 0)</span>
<a href="#l3.765"></a><span id="l3.765" class="difflineplus">+          if (matchPos == 0) {</span>
<a href="#l3.766"></a><span id="l3.766">             break;</span>
<a href="#l3.767"></a><span id="l3.767" class="difflineplus">+          }</span>
<a href="#l3.768"></a><span id="l3.768">         }</span>
<a href="#l3.769"></a><span id="l3.769">       }</span>
<a href="#l3.770"></a><span id="l3.770" class="difflineminus">-    } else if (menuItem == usedFontsSep) { // Some other element type.</span>
<a href="#l3.771"></a><span id="l3.771" class="difflineplus">+    } else if (menuItem == usedFontsSep) {</span>
<a href="#l3.772"></a><span id="l3.772" class="difflineplus">+      // Some other element type.</span>
<a href="#l3.773"></a><span id="l3.773">       // We have now passed the section of used fonts and are now in the list of all.</span>
<a href="#l3.774"></a><span id="l3.774">       afterUsedFontSection = true;</span>
<a href="#l3.775"></a><span id="l3.775">     }</span>
<a href="#l3.776"></a><span id="l3.776">   }</span>
<a href="#l3.777"></a><span id="l3.777"> </span>
<a href="#l3.778"></a><span id="l3.778">   if (foundFont) {</span>
<a href="#l3.779"></a><span id="l3.779" class="difflineminus">-    let defaultFontsSep = menuPopup.querySelector(&quot;menuseparator.fontFaceMenuAfterDefaultFonts&quot;);</span>
<a href="#l3.780"></a><span id="l3.780" class="difflineplus">+    let defaultFontsSep = menuPopup.querySelector(</span>
<a href="#l3.781"></a><span id="l3.781" class="difflineplus">+      &quot;menuseparator.fontFaceMenuAfterDefaultFonts&quot;</span>
<a href="#l3.782"></a><span id="l3.782" class="difflineplus">+    );</span>
<a href="#l3.783"></a><span id="l3.783">     if (exactMatch) {</span>
<a href="#l3.784"></a><span id="l3.784">       if (afterUsedFontSection) {</span>
<a href="#l3.785"></a><span id="l3.785">         // Copy the matched font into the section of used fonts.</span>
<a href="#l3.786"></a><span id="l3.786">         // We insert after the separator following the default fonts,</span>
<a href="#l3.787"></a><span id="l3.787">         // so right at the beginning of the used fonts section.</span>
<a href="#l3.788"></a><span id="l3.788">         let copyItem = foundFont.cloneNode(true);</span>
<a href="#l3.789"></a><span id="l3.789">         menuPopup.insertBefore(copyItem, defaultFontsSep.nextSibling);</span>
<a href="#l3.790"></a><span id="l3.790">         usedFontsSep.hidden = false;</span>
<a href="#l3.791"></a><span id="l3.791">         foundFont = copyItem;</span>
<a href="#l3.792"></a><span id="l3.792">         foundFont.setAttribute(&quot;used&quot;, &quot;true&quot;);</span>
<a href="#l3.793"></a><span id="l3.793">       }</span>
<a href="#l3.794"></a><span id="l3.794">     } else {</span>
<a href="#l3.795"></a><span id="l3.795">       // Keep only the found font and generic families in the font string.</span>
<a href="#l3.796"></a><span id="l3.796" class="difflineminus">-      editorFont = editorFont.replace(/, /g, &quot;,&quot;).split(&quot;,&quot;).filter(</span>
<a href="#l3.797"></a><span id="l3.797" class="difflineminus">-        font =&gt; ((font.toLowerCase() == foundFont.getAttribute(&quot;value_parsed&quot;)) ||</span>
<a href="#l3.798"></a><span id="l3.798" class="difflineminus">-                 genericFamilies.includes(font))).join(&quot;,&quot;);</span>
<a href="#l3.799"></a><span id="l3.799" class="difflineplus">+      editorFont = editorFont</span>
<a href="#l3.800"></a><span id="l3.800" class="difflineplus">+        .replace(/, /g, &quot;,&quot;)</span>
<a href="#l3.801"></a><span id="l3.801" class="difflineplus">+        .split(&quot;,&quot;)</span>
<a href="#l3.802"></a><span id="l3.802" class="difflineplus">+        .filter(</span>
<a href="#l3.803"></a><span id="l3.803" class="difflineplus">+          font =&gt;</span>
<a href="#l3.804"></a><span id="l3.804" class="difflineplus">+            font.toLowerCase() == foundFont.getAttribute(&quot;value_parsed&quot;) ||</span>
<a href="#l3.805"></a><span id="l3.805" class="difflineplus">+            genericFamilies.includes(font)</span>
<a href="#l3.806"></a><span id="l3.806" class="difflineplus">+        )</span>
<a href="#l3.807"></a><span id="l3.807" class="difflineplus">+        .join(&quot;,&quot;);</span>
<a href="#l3.808"></a><span id="l3.808"> </span>
<a href="#l3.809"></a><span id="l3.809">       // Check if such an item is already in the used font section.</span>
<a href="#l3.810"></a><span id="l3.810" class="difflineminus">-      if (afterUsedFontSection)</span>
<a href="#l3.811"></a><span id="l3.811" class="difflineminus">-        foundFont = menuPopup.querySelector('menuitem[used=&quot;true&quot;][value_parsed=&quot;' +</span>
<a href="#l3.812"></a><span id="l3.812" class="difflineminus">-                    editorFont.toLowerCase() + '&quot;]');</span>
<a href="#l3.813"></a><span id="l3.813" class="difflineplus">+      if (afterUsedFontSection) {</span>
<a href="#l3.814"></a><span id="l3.814" class="difflineplus">+        foundFont = menuPopup.querySelector(</span>
<a href="#l3.815"></a><span id="l3.815" class="difflineplus">+          'menuitem[used=&quot;true&quot;][value_parsed=&quot;' +</span>
<a href="#l3.816"></a><span id="l3.816" class="difflineplus">+            editorFont.toLowerCase() +</span>
<a href="#l3.817"></a><span id="l3.817" class="difflineplus">+            '&quot;]'</span>
<a href="#l3.818"></a><span id="l3.818" class="difflineplus">+        );</span>
<a href="#l3.819"></a><span id="l3.819" class="difflineplus">+      }</span>
<a href="#l3.820"></a><span id="l3.820">       // If not, create a new entry which will be inserted into that section.</span>
<a href="#l3.821"></a><span id="l3.821" class="difflineminus">-      if (!foundFont)</span>
<a href="#l3.822"></a><span id="l3.822" class="difflineplus">+      if (!foundFont) {</span>
<a href="#l3.823"></a><span id="l3.823">         foundFont = createFontFaceMenuitem(editorFont, editorFont, menuPopup);</span>
<a href="#l3.824"></a><span id="l3.824" class="difflineplus">+      }</span>
<a href="#l3.825"></a><span id="l3.825"> </span>
<a href="#l3.826"></a><span id="l3.826">       // Add the editor font string into the 'cache' attribute in the element</span>
<a href="#l3.827"></a><span id="l3.827">       // so we can later find it quickly without building the reduced string again.</span>
<a href="#l3.828"></a><span id="l3.828">       let fontCache = &quot;&quot;;</span>
<a href="#l3.829"></a><span id="l3.829" class="difflineminus">-      if (foundFont.hasAttribute(&quot;value_cache&quot;))</span>
<a href="#l3.830"></a><span id="l3.830" class="difflineplus">+      if (foundFont.hasAttribute(&quot;value_cache&quot;)) {</span>
<a href="#l3.831"></a><span id="l3.831">         fontCache = foundFont.getAttribute(&quot;value_cache&quot;);</span>
<a href="#l3.832"></a><span id="l3.832" class="difflineminus">-      foundFont.setAttribute(&quot;value_cache&quot;, fontCache + &quot;|&quot; + editorFontToLower);</span>
<a href="#l3.833"></a><span id="l3.833" class="difflineplus">+      }</span>
<a href="#l3.834"></a><span id="l3.834" class="difflineplus">+      foundFont.setAttribute(</span>
<a href="#l3.835"></a><span id="l3.835" class="difflineplus">+        &quot;value_cache&quot;,</span>
<a href="#l3.836"></a><span id="l3.836" class="difflineplus">+        fontCache + &quot;|&quot; + editorFontToLower</span>
<a href="#l3.837"></a><span id="l3.837" class="difflineplus">+      );</span>
<a href="#l3.838"></a><span id="l3.838"> </span>
<a href="#l3.839"></a><span id="l3.839">       // If we created a new item, set it up and insert.</span>
<a href="#l3.840"></a><span id="l3.840">       if (!foundFont.hasAttribute(&quot;used&quot;)) {</span>
<a href="#l3.841"></a><span id="l3.841">         foundFont.setAttribute(&quot;used&quot;, &quot;true&quot;);</span>
<a href="#l3.842"></a><span id="l3.842">         usedFontsSep.hidden = false;</span>
<a href="#l3.843"></a><span id="l3.843">         menuPopup.insertBefore(foundFont, defaultFontsSep.nextSibling);</span>
<a href="#l3.844"></a><span id="l3.844">       }</span>
<a href="#l3.845"></a><span id="l3.845">     }</span>
<a href="#l3.846"></a><span id="l3.846" class="difflineat">@@ -785,35 +914,38 @@ function onFontFaceChange(fontFaceMenuLi</span>
<a href="#l3.847"></a><span id="l3.847">   }</span>
<a href="#l3.848"></a><span id="l3.848">   fontFaceMenuList.selectedItem = foundFont;</span>
<a href="#l3.849"></a><span id="l3.849"> }</span>
<a href="#l3.850"></a><span id="l3.850"> </span>
<a href="#l3.851"></a><span id="l3.851"> /**</span>
<a href="#l3.852"></a><span id="l3.852">  * Clears the used fonts list from all the font face menulists.</span>
<a href="#l3.853"></a><span id="l3.853">  */</span>
<a href="#l3.854"></a><span id="l3.854"> function ClearUsedFonts() {</span>
<a href="#l3.855"></a><span id="l3.855" class="difflineminus">-  let userFontSeps = document.querySelectorAll(&quot;menuseparator.fontFaceMenuAfterDefaultFonts&quot;);</span>
<a href="#l3.856"></a><span id="l3.856" class="difflineplus">+  let userFontSeps = document.querySelectorAll(</span>
<a href="#l3.857"></a><span id="l3.857" class="difflineplus">+    &quot;menuseparator.fontFaceMenuAfterDefaultFonts&quot;</span>
<a href="#l3.858"></a><span id="l3.858" class="difflineplus">+  );</span>
<a href="#l3.859"></a><span id="l3.859">   for (let userFontSep of userFontSeps) {</span>
<a href="#l3.860"></a><span id="l3.860">     while (true) {</span>
<a href="#l3.861"></a><span id="l3.861">       let nextNode = userFontSep.nextSibling;</span>
<a href="#l3.862"></a><span id="l3.862">       if (nextNode.tagName != &quot;menuseparator&quot;) {</span>
<a href="#l3.863"></a><span id="l3.863">         nextNode.remove();</span>
<a href="#l3.864"></a><span id="l3.864">       } else if (nextNode.classList.contains(&quot;fontFaceMenuAfterUsedFonts&quot;)) {</span>
<a href="#l3.865"></a><span id="l3.865" class="difflineminus">-          nextNode.hidden = true;</span>
<a href="#l3.866"></a><span id="l3.866" class="difflineminus">-          break;</span>
<a href="#l3.867"></a><span id="l3.867" class="difflineminus">-        }</span>
<a href="#l3.868"></a><span id="l3.868" class="difflineplus">+        nextNode.hidden = true;</span>
<a href="#l3.869"></a><span id="l3.869" class="difflineplus">+        break;</span>
<a href="#l3.870"></a><span id="l3.870" class="difflineplus">+      }</span>
<a href="#l3.871"></a><span id="l3.871">     }</span>
<a href="#l3.872"></a><span id="l3.872">   }</span>
<a href="#l3.873"></a><span id="l3.873"> }</span>
<a href="#l3.874"></a><span id="l3.874"> </span>
<a href="#l3.875"></a><span id="l3.875"> function EditorSelectFontSize() {</span>
<a href="#l3.876"></a><span id="l3.876">   var select = document.getElementById(&quot;FontSizeSelect&quot;);</span>
<a href="#l3.877"></a><span id="l3.877">   if (select) {</span>
<a href="#l3.878"></a><span id="l3.878" class="difflineminus">-    if (select.selectedIndex == -1)</span>
<a href="#l3.879"></a><span id="l3.879" class="difflineplus">+    if (select.selectedIndex == -1) {</span>
<a href="#l3.880"></a><span id="l3.880">       return;</span>
<a href="#l3.881"></a><span id="l3.881" class="difflineplus">+    }</span>
<a href="#l3.882"></a><span id="l3.882"> </span>
<a href="#l3.883"></a><span id="l3.883">     EditorSetFontSize(gFontSizeNames[select.selectedIndex]);</span>
<a href="#l3.884"></a><span id="l3.884">   }</span>
<a href="#l3.885"></a><span id="l3.885"> }</span>
<a href="#l3.886"></a><span id="l3.886"> </span>
<a href="#l3.887"></a><span id="l3.887"> function onFontSizeChange(fontSizeMenulist, commandID) {</span>
<a href="#l3.888"></a><span id="l3.888">   // If we don't match anything, set to &quot;0 (normal)&quot;</span>
<a href="#l3.889"></a><span id="l3.889">   var newIndex = 2;</span>
<a href="#l3.890"></a><span id="l3.890" class="difflineat">@@ -824,23 +956,23 @@ function onFontSizeChange(fontSizeMenuli</span>
<a href="#l3.891"></a><span id="l3.891">   } else {</span>
<a href="#l3.892"></a><span id="l3.892">     for (var i = 0; i &lt; gFontSizeNames.length; i++) {</span>
<a href="#l3.893"></a><span id="l3.893">       if (gFontSizeNames[i] == size) {</span>
<a href="#l3.894"></a><span id="l3.894">         newIndex = i;</span>
<a href="#l3.895"></a><span id="l3.895">         break;</span>
<a href="#l3.896"></a><span id="l3.896">       }</span>
<a href="#l3.897"></a><span id="l3.897">     }</span>
<a href="#l3.898"></a><span id="l3.898">   }</span>
<a href="#l3.899"></a><span id="l3.899" class="difflineminus">-  if (fontSizeMenulist.selectedIndex != newIndex)</span>
<a href="#l3.900"></a><span id="l3.900" class="difflineplus">+  if (fontSizeMenulist.selectedIndex != newIndex) {</span>
<a href="#l3.901"></a><span id="l3.901">     fontSizeMenulist.selectedIndex = newIndex;</span>
<a href="#l3.902"></a><span id="l3.902" class="difflineplus">+  }</span>
<a href="#l3.903"></a><span id="l3.903"> }</span>
<a href="#l3.904"></a><span id="l3.904"> </span>
<a href="#l3.905"></a><span id="l3.905"> function EditorSetFontSize(size) {</span>
<a href="#l3.906"></a><span id="l3.906" class="difflineminus">-  if (size == &quot;0&quot; || size == &quot;normal&quot; ||</span>
<a href="#l3.907"></a><span id="l3.907" class="difflineminus">-      size == &quot;medium&quot;) {</span>
<a href="#l3.908"></a><span id="l3.908" class="difflineplus">+  if (size == &quot;0&quot; || size == &quot;normal&quot; || size == &quot;medium&quot;) {</span>
<a href="#l3.909"></a><span id="l3.909">     EditorRemoveTextProperty(&quot;font&quot;, &quot;size&quot;);</span>
<a href="#l3.910"></a><span id="l3.910">     // Also remove big and small,</span>
<a href="#l3.911"></a><span id="l3.911">     //  else it will seem like size isn't changing correctly</span>
<a href="#l3.912"></a><span id="l3.912">     EditorRemoveTextProperty(&quot;small&quot;, &quot;&quot;);</span>
<a href="#l3.913"></a><span id="l3.913">     EditorRemoveTextProperty(&quot;big&quot;, &quot;&quot;);</span>
<a href="#l3.914"></a><span id="l3.914">   } else {</span>
<a href="#l3.915"></a><span id="l3.915">     // Temp: convert from new CSS size strings to old HTML size strings</span>
<a href="#l3.916"></a><span id="l3.916">     switch (size) {</span>
<a href="#l3.917"></a><span id="l3.917" class="difflineat">@@ -866,79 +998,87 @@ function EditorSetFontSize(size) {</span>
<a href="#l3.918"></a><span id="l3.918">   gContentWindow.focus();</span>
<a href="#l3.919"></a><span id="l3.919"> }</span>
<a href="#l3.920"></a><span id="l3.920"> </span>
<a href="#l3.921"></a><span id="l3.921"> function initFontFaceMenu(menuPopup) {</span>
<a href="#l3.922"></a><span id="l3.922">   initLocalFontFaceMenu(menuPopup);</span>
<a href="#l3.923"></a><span id="l3.923"> </span>
<a href="#l3.924"></a><span id="l3.924">   if (menuPopup) {</span>
<a href="#l3.925"></a><span id="l3.925">     var children = menuPopup.childNodes;</span>
<a href="#l3.926"></a><span id="l3.926" class="difflineminus">-    if (!children) return;</span>
<a href="#l3.927"></a><span id="l3.927" class="difflineplus">+    if (!children) {</span>
<a href="#l3.928"></a><span id="l3.928" class="difflineplus">+      return;</span>
<a href="#l3.929"></a><span id="l3.929" class="difflineplus">+    }</span>
<a href="#l3.930"></a><span id="l3.930"> </span>
<a href="#l3.931"></a><span id="l3.931">     var mixed = { value: false };</span>
<a href="#l3.932"></a><span id="l3.932">     var editorFont = GetCurrentEditor().getFontFaceState(mixed);</span>
<a href="#l3.933"></a><span id="l3.933"> </span>
<a href="#l3.934"></a><span id="l3.934">     // Strip quotes in font names. Experiments have shown that we only</span>
<a href="#l3.935"></a><span id="l3.935">     // ever get double quotes around the font name, never single quotes,</span>
<a href="#l3.936"></a><span id="l3.936">     // even if they were in the HTML source. Also single or double</span>
<a href="#l3.937"></a><span id="l3.937">     // quotes within the font name are never returned.</span>
<a href="#l3.938"></a><span id="l3.938">     editorFont = editorFont.replace(/&quot;/g, &quot;&quot;);</span>
<a href="#l3.939"></a><span id="l3.939"> </span>
<a href="#l3.940"></a><span id="l3.940">     if (!mixed.value) {</span>
<a href="#l3.941"></a><span id="l3.941">       switch (editorFont) {</span>
<a href="#l3.942"></a><span id="l3.942" class="difflineminus">-      case &quot;&quot;:</span>
<a href="#l3.943"></a><span id="l3.943" class="difflineminus">-      case &quot;serif&quot;:</span>
<a href="#l3.944"></a><span id="l3.944" class="difflineminus">-      case &quot;sans-serif&quot;:</span>
<a href="#l3.945"></a><span id="l3.945" class="difflineminus">-        // Generic variable width.</span>
<a href="#l3.946"></a><span id="l3.946" class="difflineminus">-        editorFont = &quot;&quot;;</span>
<a href="#l3.947"></a><span id="l3.947" class="difflineminus">-        break;</span>
<a href="#l3.948"></a><span id="l3.948" class="difflineminus">-      case &quot;tt&quot;:</span>
<a href="#l3.949"></a><span id="l3.949" class="difflineminus">-      case &quot;monospace&quot;:</span>
<a href="#l3.950"></a><span id="l3.950" class="difflineminus">-        // Generic fixed width.</span>
<a href="#l3.951"></a><span id="l3.951" class="difflineminus">-        editorFont = &quot;tt&quot;;</span>
<a href="#l3.952"></a><span id="l3.952" class="difflineminus">-        break;</span>
<a href="#l3.953"></a><span id="l3.953" class="difflineminus">-      default:</span>
<a href="#l3.954"></a><span id="l3.954" class="difflineminus">-        editorFont = editorFont.toLowerCase().replace(/, /g, &quot;,&quot;); // bug 1139524</span>
<a href="#l3.955"></a><span id="l3.955" class="difflineplus">+        case &quot;&quot;:</span>
<a href="#l3.956"></a><span id="l3.956" class="difflineplus">+        case &quot;serif&quot;:</span>
<a href="#l3.957"></a><span id="l3.957" class="difflineplus">+        case &quot;sans-serif&quot;:</span>
<a href="#l3.958"></a><span id="l3.958" class="difflineplus">+          // Generic variable width.</span>
<a href="#l3.959"></a><span id="l3.959" class="difflineplus">+          editorFont = &quot;&quot;;</span>
<a href="#l3.960"></a><span id="l3.960" class="difflineplus">+          break;</span>
<a href="#l3.961"></a><span id="l3.961" class="difflineplus">+        case &quot;tt&quot;:</span>
<a href="#l3.962"></a><span id="l3.962" class="difflineplus">+        case &quot;monospace&quot;:</span>
<a href="#l3.963"></a><span id="l3.963" class="difflineplus">+          // Generic fixed width.</span>
<a href="#l3.964"></a><span id="l3.964" class="difflineplus">+          editorFont = &quot;tt&quot;;</span>
<a href="#l3.965"></a><span id="l3.965" class="difflineplus">+          break;</span>
<a href="#l3.966"></a><span id="l3.966" class="difflineplus">+        default:</span>
<a href="#l3.967"></a><span id="l3.967" class="difflineplus">+          editorFont = editorFont.toLowerCase().replace(/, /g, &quot;,&quot;); // bug 1139524</span>
<a href="#l3.968"></a><span id="l3.968">       }</span>
<a href="#l3.969"></a><span id="l3.969">     }</span>
<a href="#l3.970"></a><span id="l3.970"> </span>
<a href="#l3.971"></a><span id="l3.971">     var editorFontOptions = editorFont.split(&quot;,&quot;);</span>
<a href="#l3.972"></a><span id="l3.972" class="difflineminus">-    var matchedOption = editorFontOptions.length;  // initialise to high invalid value</span>
<a href="#l3.973"></a><span id="l3.973" class="difflineplus">+    var matchedOption = editorFontOptions.length; // initialise to high invalid value</span>
<a href="#l3.974"></a><span id="l3.974">     for (var i = 0; i &lt; children.length; i++) {</span>
<a href="#l3.975"></a><span id="l3.975">       var menuItem = children[i];</span>
<a href="#l3.976"></a><span id="l3.976">       if (menuItem.localName == &quot;menuitem&quot;) {</span>
<a href="#l3.977"></a><span id="l3.977">         var matchFound = false;</span>
<a href="#l3.978"></a><span id="l3.978">         if (!mixed.value) {</span>
<a href="#l3.979"></a><span id="l3.979" class="difflineminus">-          var menuFont = menuItem.getAttribute(&quot;value&quot;).toLowerCase().replace(/, /g, &quot;,&quot;);</span>
<a href="#l3.980"></a><span id="l3.980" class="difflineplus">+          var menuFont = menuItem</span>
<a href="#l3.981"></a><span id="l3.981" class="difflineplus">+            .getAttribute(&quot;value&quot;)</span>
<a href="#l3.982"></a><span id="l3.982" class="difflineplus">+            .toLowerCase()</span>
<a href="#l3.983"></a><span id="l3.983" class="difflineplus">+            .replace(/, /g, &quot;,&quot;);</span>
<a href="#l3.984"></a><span id="l3.984"> </span>
<a href="#l3.985"></a><span id="l3.985">           // First compare the entire font string to match items that contain commas.</span>
<a href="#l3.986"></a><span id="l3.986">           if (menuFont == editorFont) {</span>
<a href="#l3.987"></a><span id="l3.987">             menuItem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l3.988"></a><span id="l3.988">             break;</span>
<a href="#l3.989"></a><span id="l3.989" class="difflineminus">-          } else if (editorFontOptions.length &gt; 1) { // Next compare the individual options.</span>
<a href="#l3.990"></a><span id="l3.990" class="difflineplus">+          } else if (editorFontOptions.length &gt; 1) {</span>
<a href="#l3.991"></a><span id="l3.991" class="difflineplus">+            // Next compare the individual options.</span>
<a href="#l3.992"></a><span id="l3.992">             var matchPos = editorFontOptions.indexOf(menuFont);</span>
<a href="#l3.993"></a><span id="l3.993">             if (matchPos &gt;= 0 &amp;&amp; matchPos &lt; matchedOption) {</span>
<a href="#l3.994"></a><span id="l3.994">               // This menu font comes earlier in the list of options,</span>
<a href="#l3.995"></a><span id="l3.995">               // so prefer it.</span>
<a href="#l3.996"></a><span id="l3.996">               menuItem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l3.997"></a><span id="l3.997"> </span>
<a href="#l3.998"></a><span id="l3.998">               // If we matched the first option, we don't need to look for</span>
<a href="#l3.999"></a><span id="l3.999">               // a better match.</span>
<a href="#l3.1000"></a><span id="l3.1000" class="difflineminus">-              if (matchPos == 0)</span>
<a href="#l3.1001"></a><span id="l3.1001" class="difflineplus">+              if (matchPos == 0) {</span>
<a href="#l3.1002"></a><span id="l3.1002">                 break;</span>
<a href="#l3.1003"></a><span id="l3.1003" class="difflineplus">+              }</span>
<a href="#l3.1004"></a><span id="l3.1004"> </span>
<a href="#l3.1005"></a><span id="l3.1005">               matchedOption = matchPos;</span>
<a href="#l3.1006"></a><span id="l3.1006">               matchFound = true;</span>
<a href="#l3.1007"></a><span id="l3.1007">             }</span>
<a href="#l3.1008"></a><span id="l3.1008">           }</span>
<a href="#l3.1009"></a><span id="l3.1009">         }</span>
<a href="#l3.1010"></a><span id="l3.1010"> </span>
<a href="#l3.1011"></a><span id="l3.1011">         // In case this item doesn't match, make sure we've cleared the checkmark.</span>
<a href="#l3.1012"></a><span id="l3.1012" class="difflineminus">-        if (!matchFound)</span>
<a href="#l3.1013"></a><span id="l3.1013" class="difflineplus">+        if (!matchFound) {</span>
<a href="#l3.1014"></a><span id="l3.1014">           menuItem.removeAttribute(&quot;checked&quot;);</span>
<a href="#l3.1015"></a><span id="l3.1015" class="difflineplus">+        }</span>
<a href="#l3.1016"></a><span id="l3.1016">       }</span>
<a href="#l3.1017"></a><span id="l3.1017">     }</span>
<a href="#l3.1018"></a><span id="l3.1018">   }</span>
<a href="#l3.1019"></a><span id="l3.1019"> }</span>
<a href="#l3.1020"></a><span id="l3.1020"> </span>
<a href="#l3.1021"></a><span id="l3.1021"> // Number of fixed font face menuitems, these are:</span>
<a href="#l3.1022"></a><span id="l3.1022"> // Variable Width</span>
<a href="#l3.1023"></a><span id="l3.1023"> // Fixed Width</span>
<a href="#l3.1024"></a><span id="l3.1024" class="difflineat">@@ -949,36 +1089,43 @@ function initFontFaceMenu(menuPopup) {</span>
<a href="#l3.1025"></a><span id="l3.1025"> // ==separator</span>
<a href="#l3.1026"></a><span id="l3.1026"> // ==separator</span>
<a href="#l3.1027"></a><span id="l3.1027"> const kFixedFontFaceMenuItems = 8;</span>
<a href="#l3.1028"></a><span id="l3.1028"> </span>
<a href="#l3.1029"></a><span id="l3.1029"> function initLocalFontFaceMenu(menuPopup) {</span>
<a href="#l3.1030"></a><span id="l3.1030">   if (!gLocalFonts) {</span>
<a href="#l3.1031"></a><span id="l3.1031">     // Build list of all local fonts once per editor</span>
<a href="#l3.1032"></a><span id="l3.1032">     try {</span>
<a href="#l3.1033"></a><span id="l3.1033" class="difflineminus">-      var enumerator = Cc[&quot;@mozilla.org/gfx/fontenumerator;1&quot;]</span>
<a href="#l3.1034"></a><span id="l3.1034" class="difflineminus">-                         .getService(Ci.nsIFontEnumerator);</span>
<a href="#l3.1035"></a><span id="l3.1035" class="difflineplus">+      var enumerator = Cc[&quot;@mozilla.org/gfx/fontenumerator;1&quot;].getService(</span>
<a href="#l3.1036"></a><span id="l3.1036" class="difflineplus">+        Ci.nsIFontEnumerator</span>
<a href="#l3.1037"></a><span id="l3.1037" class="difflineplus">+      );</span>
<a href="#l3.1038"></a><span id="l3.1038">       gLocalFonts = enumerator.EnumerateAllFonts();</span>
<a href="#l3.1039"></a><span id="l3.1039">     } catch (e) {}</span>
<a href="#l3.1040"></a><span id="l3.1040">   }</span>
<a href="#l3.1041"></a><span id="l3.1041"> </span>
<a href="#l3.1042"></a><span id="l3.1042">   // Don't use radios for menulists.</span>
<a href="#l3.1043"></a><span id="l3.1043" class="difflineminus">-  let useRadioMenuitems = (menuPopup.parentNode.localName == &quot;menu&quot;);</span>
<a href="#l3.1044"></a><span id="l3.1044" class="difflineplus">+  let useRadioMenuitems = menuPopup.parentNode.localName == &quot;menu&quot;;</span>
<a href="#l3.1045"></a><span id="l3.1045">   menuPopup.setAttribute(&quot;useRadios&quot;, useRadioMenuitems);</span>
<a href="#l3.1046"></a><span id="l3.1046">   if (menuPopup.childNodes.length == kFixedFontFaceMenuItems) {</span>
<a href="#l3.1047"></a><span id="l3.1047">     if (gLocalFonts.length == 0) {</span>
<a href="#l3.1048"></a><span id="l3.1048">       menuPopup.querySelector(&quot;.fontFaceMenuAfterDefaultFonts&quot;).hidden = true;</span>
<a href="#l3.1049"></a><span id="l3.1049">     }</span>
<a href="#l3.1050"></a><span id="l3.1050">     for (let i = 0; i &lt; gLocalFonts.length; ++i) {</span>
<a href="#l3.1051"></a><span id="l3.1051">       // Remove Linux system generic fonts that collide with CSS generic fonts.</span>
<a href="#l3.1052"></a><span id="l3.1052" class="difflineminus">-      if (gLocalFonts[i] != &quot;&quot; &amp;&amp;</span>
<a href="#l3.1053"></a><span id="l3.1053" class="difflineminus">-          gLocalFonts[i] != &quot;serif&quot; &amp;&amp;</span>
<a href="#l3.1054"></a><span id="l3.1054" class="difflineminus">-          gLocalFonts[i] != &quot;sans-serif&quot; &amp;&amp;</span>
<a href="#l3.1055"></a><span id="l3.1055" class="difflineminus">-          gLocalFonts[i] != &quot;monospace&quot;) {</span>
<a href="#l3.1056"></a><span id="l3.1056" class="difflineminus">-        let itemNode = createFontFaceMenuitem(gLocalFonts[i], gLocalFonts[i], menuPopup);</span>
<a href="#l3.1057"></a><span id="l3.1057" class="difflineplus">+      if (</span>
<a href="#l3.1058"></a><span id="l3.1058" class="difflineplus">+        gLocalFonts[i] != &quot;&quot; &amp;&amp;</span>
<a href="#l3.1059"></a><span id="l3.1059" class="difflineplus">+        gLocalFonts[i] != &quot;serif&quot; &amp;&amp;</span>
<a href="#l3.1060"></a><span id="l3.1060" class="difflineplus">+        gLocalFonts[i] != &quot;sans-serif&quot; &amp;&amp;</span>
<a href="#l3.1061"></a><span id="l3.1061" class="difflineplus">+        gLocalFonts[i] != &quot;monospace&quot;</span>
<a href="#l3.1062"></a><span id="l3.1062" class="difflineplus">+      ) {</span>
<a href="#l3.1063"></a><span id="l3.1063" class="difflineplus">+        let itemNode = createFontFaceMenuitem(</span>
<a href="#l3.1064"></a><span id="l3.1064" class="difflineplus">+          gLocalFonts[i],</span>
<a href="#l3.1065"></a><span id="l3.1065" class="difflineplus">+          gLocalFonts[i],</span>
<a href="#l3.1066"></a><span id="l3.1066" class="difflineplus">+          menuPopup</span>
<a href="#l3.1067"></a><span id="l3.1067" class="difflineplus">+        );</span>
<a href="#l3.1068"></a><span id="l3.1068">         menuPopup.appendChild(itemNode);</span>
<a href="#l3.1069"></a><span id="l3.1069">       }</span>
<a href="#l3.1070"></a><span id="l3.1070">     }</span>
<a href="#l3.1071"></a><span id="l3.1071">   }</span>
<a href="#l3.1072"></a><span id="l3.1072"> }</span>
<a href="#l3.1073"></a><span id="l3.1073"> </span>
<a href="#l3.1074"></a><span id="l3.1074"> /**</span>
<a href="#l3.1075"></a><span id="l3.1075">  * Creates a menuitem element for the font faces menulist. Returns the menuitem</span>
<a href="#l3.1076"></a><span id="l3.1076" class="difflineat">@@ -988,47 +1135,59 @@ function initLocalFontFaceMenu(menuPopup</span>
<a href="#l3.1077"></a><span id="l3.1077">  * @param aFontName   The font face value to be used for the item.</span>
<a href="#l3.1078"></a><span id="l3.1078">  *                    Will be used in &lt;font face=&quot;value&quot;&gt; in the edited document.</span>
<a href="#l3.1079"></a><span id="l3.1079">  * @param aMenuPopup  The menupopup for which this menuitem is created.</span>
<a href="#l3.1080"></a><span id="l3.1080">  */</span>
<a href="#l3.1081"></a><span id="l3.1081"> function createFontFaceMenuitem(aFontLabel, aFontName, aMenuPopup) {</span>
<a href="#l3.1082"></a><span id="l3.1082">   let itemNode = document.createXULElement(&quot;menuitem&quot;);</span>
<a href="#l3.1083"></a><span id="l3.1083">   itemNode.setAttribute(&quot;label&quot;, aFontLabel);</span>
<a href="#l3.1084"></a><span id="l3.1084">   itemNode.setAttribute(&quot;value&quot;, aFontName);</span>
<a href="#l3.1085"></a><span id="l3.1085" class="difflineminus">-  itemNode.setAttribute(&quot;value_parsed&quot;, aFontName.toLowerCase().replace(/, /g, &quot;,&quot;));</span>
<a href="#l3.1086"></a><span id="l3.1086" class="difflineplus">+  itemNode.setAttribute(</span>
<a href="#l3.1087"></a><span id="l3.1087" class="difflineplus">+    &quot;value_parsed&quot;,</span>
<a href="#l3.1088"></a><span id="l3.1088" class="difflineplus">+    aFontName.toLowerCase().replace(/, /g, &quot;,&quot;)</span>
<a href="#l3.1089"></a><span id="l3.1089" class="difflineplus">+  );</span>
<a href="#l3.1090"></a><span id="l3.1090">   itemNode.setAttribute(&quot;tooltiptext&quot;, aFontLabel);</span>
<a href="#l3.1091"></a><span id="l3.1091">   if (aMenuPopup.getAttribute(&quot;useRadios&quot;) == &quot;true&quot;) {</span>
<a href="#l3.1092"></a><span id="l3.1092">     itemNode.setAttribute(&quot;type&quot;, &quot;radio&quot;);</span>
<a href="#l3.1093"></a><span id="l3.1093">     itemNode.setAttribute(&quot;observes&quot;, &quot;cmd_renderedHTMLEnabler&quot;);</span>
<a href="#l3.1094"></a><span id="l3.1094">   }</span>
<a href="#l3.1095"></a><span id="l3.1095">   return itemNode;</span>
<a href="#l3.1096"></a><span id="l3.1096"> }</span>
<a href="#l3.1097"></a><span id="l3.1097"> </span>
<a href="#l3.1098"></a><span id="l3.1098"> /**</span>
<a href="#l3.1099"></a><span id="l3.1099">  * Helper function</span>
<a href="#l3.1100"></a><span id="l3.1100">  */</span>
<a href="#l3.1101"></a><span id="l3.1101"> function getFontSizeIndex() {</span>
<a href="#l3.1102"></a><span id="l3.1102">   var firstHas = { value: false };</span>
<a href="#l3.1103"></a><span id="l3.1103">   var anyHas = { value: false };</span>
<a href="#l3.1104"></a><span id="l3.1104">   var allHas = { value: false };</span>
<a href="#l3.1105"></a><span id="l3.1105"> </span>
<a href="#l3.1106"></a><span id="l3.1106" class="difflineminus">-  var fontSize = EditorGetTextProperty(&quot;font&quot;, &quot;size&quot;, null, firstHas, anyHas, allHas);</span>
<a href="#l3.1107"></a><span id="l3.1107" class="difflineplus">+  var fontSize = EditorGetTextProperty(</span>
<a href="#l3.1108"></a><span id="l3.1108" class="difflineplus">+    &quot;font&quot;,</span>
<a href="#l3.1109"></a><span id="l3.1109" class="difflineplus">+    &quot;size&quot;,</span>
<a href="#l3.1110"></a><span id="l3.1110" class="difflineplus">+    null,</span>
<a href="#l3.1111"></a><span id="l3.1111" class="difflineplus">+    firstHas,</span>
<a href="#l3.1112"></a><span id="l3.1112" class="difflineplus">+    anyHas,</span>
<a href="#l3.1113"></a><span id="l3.1113" class="difflineplus">+    allHas</span>
<a href="#l3.1114"></a><span id="l3.1114" class="difflineplus">+  );</span>
<a href="#l3.1115"></a><span id="l3.1115"> </span>
<a href="#l3.1116"></a><span id="l3.1116">   // If the element has no size attribute and no size was found at all,</span>
<a href="#l3.1117"></a><span id="l3.1117">   // we assume &quot;medium&quot; size. This is highly problematic since</span>
<a href="#l3.1118"></a><span id="l3.1118">   // CSS sizes are not recognised and will show as &quot;medium&quot; as well.</span>
<a href="#l3.1119"></a><span id="l3.1119">   // Currently we can't distinguish between &quot;no attribute&quot; which</span>
<a href="#l3.1120"></a><span id="l3.1120">   // can imply &quot;medium&quot; and &quot;CSS attribute present&quot; which should not</span>
<a href="#l3.1121"></a><span id="l3.1121">   // imply &quot;medium&quot;.</span>
<a href="#l3.1122"></a><span id="l3.1122" class="difflineminus">-  if (!anyHas.value)</span>
<a href="#l3.1123"></a><span id="l3.1123" class="difflineplus">+  if (!anyHas.value) {</span>
<a href="#l3.1124"></a><span id="l3.1124">     return 2;</span>
<a href="#l3.1125"></a><span id="l3.1125" class="difflineplus">+  }</span>
<a href="#l3.1126"></a><span id="l3.1126"> </span>
<a href="#l3.1127"></a><span id="l3.1127">   // Mixed selection.</span>
<a href="#l3.1128"></a><span id="l3.1128" class="difflineminus">-  if (!allHas.value)</span>
<a href="#l3.1129"></a><span id="l3.1129" class="difflineplus">+  if (!allHas.value) {</span>
<a href="#l3.1130"></a><span id="l3.1130">     return -1;</span>
<a href="#l3.1131"></a><span id="l3.1131" class="difflineplus">+  }</span>
<a href="#l3.1132"></a><span id="l3.1132"> </span>
<a href="#l3.1133"></a><span id="l3.1133">   switch (fontSize) {</span>
<a href="#l3.1134"></a><span id="l3.1134">     case &quot;-3&quot;:</span>
<a href="#l3.1135"></a><span id="l3.1135">     case &quot;-2&quot;:</span>
<a href="#l3.1136"></a><span id="l3.1136">     case &quot;0&quot;:</span>
<a href="#l3.1137"></a><span id="l3.1137">     case &quot;1&quot;:</span>
<a href="#l3.1138"></a><span id="l3.1138">       // x-small.</span>
<a href="#l3.1139"></a><span id="l3.1139">       return 0;</span>
<a href="#l3.1140"></a><span id="l3.1140" class="difflineat">@@ -1057,18 +1216,19 @@ function getFontSizeIndex() {</span>
<a href="#l3.1141"></a><span id="l3.1141"> </span>
<a href="#l3.1142"></a><span id="l3.1142">   // We shouldn't get here. All the selection has a value we don't understand.</span>
<a href="#l3.1143"></a><span id="l3.1143">   return -1;</span>
<a href="#l3.1144"></a><span id="l3.1144"> }</span>
<a href="#l3.1145"></a><span id="l3.1145"> </span>
<a href="#l3.1146"></a><span id="l3.1146"> function initFontSizeMenu(menuPopup, fullMenu) {</span>
<a href="#l3.1147"></a><span id="l3.1147">   if (menuPopup) {</span>
<a href="#l3.1148"></a><span id="l3.1148">     var children = menuPopup.childNodes;</span>
<a href="#l3.1149"></a><span id="l3.1149" class="difflineminus">-    if (!children)</span>
<a href="#l3.1150"></a><span id="l3.1150" class="difflineplus">+    if (!children) {</span>
<a href="#l3.1151"></a><span id="l3.1151">       return;</span>
<a href="#l3.1152"></a><span id="l3.1152" class="difflineplus">+    }</span>
<a href="#l3.1153"></a><span id="l3.1153"> </span>
<a href="#l3.1154"></a><span id="l3.1154">     // Fixed size items start after menu separator depending on whether it is</span>
<a href="#l3.1155"></a><span id="l3.1155">     // a full menu.</span>
<a href="#l3.1156"></a><span id="l3.1156">     var menuIndex = fullMenu ? 3 : 0;</span>
<a href="#l3.1157"></a><span id="l3.1157"> </span>
<a href="#l3.1158"></a><span id="l3.1158">     var setIndex = getFontSizeIndex();</span>
<a href="#l3.1159"></a><span id="l3.1159">     if (setIndex &gt;= 0) {</span>
<a href="#l3.1160"></a><span id="l3.1160">       children[menuIndex + setIndex].setAttribute(&quot;checked&quot;, true);</span>
<a href="#l3.1161"></a><span id="l3.1161" class="difflineat">@@ -1076,168 +1236,193 @@ function initFontSizeMenu(menuPopup, ful</span>
<a href="#l3.1162"></a><span id="l3.1162">       // In case of mixed, clear all items.</span>
<a href="#l3.1163"></a><span id="l3.1163">       for (var i = menuIndex; i &lt; children.length; i++) {</span>
<a href="#l3.1164"></a><span id="l3.1164">         children[i].setAttribute(&quot;checked&quot;, false);</span>
<a href="#l3.1165"></a><span id="l3.1165">       }</span>
<a href="#l3.1166"></a><span id="l3.1166">     }</span>
<a href="#l3.1167"></a><span id="l3.1167"> </span>
<a href="#l3.1168"></a><span id="l3.1168">     // Some configurations might not have the &quot;small/big&quot; indicator as</span>
<a href="#l3.1169"></a><span id="l3.1169">     // last item. If there is no indicator, we are done.</span>
<a href="#l3.1170"></a><span id="l3.1170" class="difflineminus">-    if (!menuPopup.lastChild.id.includes(&quot;smallBigInfo&quot;))</span>
<a href="#l3.1171"></a><span id="l3.1171" class="difflineplus">+    if (!menuPopup.lastChild.id.includes(&quot;smallBigInfo&quot;)) {</span>
<a href="#l3.1172"></a><span id="l3.1172">       return;</span>
<a href="#l3.1173"></a><span id="l3.1173" class="difflineplus">+    }</span>
<a href="#l3.1174"></a><span id="l3.1174"> </span>
<a href="#l3.1175"></a><span id="l3.1175">     // While it would be better to show the number of levels,</span>
<a href="#l3.1176"></a><span id="l3.1176">     // at least this tells user if either of them are set.</span>
<a href="#l3.1177"></a><span id="l3.1177">     var firstHas = { value: false };</span>
<a href="#l3.1178"></a><span id="l3.1178">     var anyHas = { value: false };</span>
<a href="#l3.1179"></a><span id="l3.1179">     var allHas = { value: false };</span>
<a href="#l3.1180"></a><span id="l3.1180"> </span>
<a href="#l3.1181"></a><span id="l3.1181">     // Show &quot;small&quot;/&quot;big&quot; indicator.</span>
<a href="#l3.1182"></a><span id="l3.1182">     var htmlInfo = &quot;&quot;;</span>
<a href="#l3.1183"></a><span id="l3.1183">     EditorGetTextProperty(&quot;small&quot;, &quot;&quot;, &quot;&quot;, firstHas, anyHas, allHas);</span>
<a href="#l3.1184"></a><span id="l3.1184" class="difflineminus">-    if (anyHas.value)</span>
<a href="#l3.1185"></a><span id="l3.1185" class="difflineplus">+    if (anyHas.value) {</span>
<a href="#l3.1186"></a><span id="l3.1186">       htmlInfo = &quot;&lt;small&gt;&quot;;</span>
<a href="#l3.1187"></a><span id="l3.1187" class="difflineplus">+    }</span>
<a href="#l3.1188"></a><span id="l3.1188">     EditorGetTextProperty(&quot;big&quot;, &quot;&quot;, &quot;&quot;, firstHas, anyHas, allHas);</span>
<a href="#l3.1189"></a><span id="l3.1189" class="difflineminus">-    if (anyHas.value)</span>
<a href="#l3.1190"></a><span id="l3.1190" class="difflineplus">+    if (anyHas.value) {</span>
<a href="#l3.1191"></a><span id="l3.1191">       htmlInfo += &quot;&lt;big&gt;&quot;;</span>
<a href="#l3.1192"></a><span id="l3.1192" class="difflineplus">+    }</span>
<a href="#l3.1193"></a><span id="l3.1193"> </span>
<a href="#l3.1194"></a><span id="l3.1194">     if (htmlInfo) {</span>
<a href="#l3.1195"></a><span id="l3.1195">       menuPopup.lastChild.hidden = false;</span>
<a href="#l3.1196"></a><span id="l3.1196">       menuPopup.lastChild.setAttribute(&quot;label&quot;, &quot;HTML: &quot; + htmlInfo);</span>
<a href="#l3.1197"></a><span id="l3.1197">       menuPopup.lastChild.setAttribute(&quot;checked&quot;, true);</span>
<a href="#l3.1198"></a><span id="l3.1198">     } else {</span>
<a href="#l3.1199"></a><span id="l3.1199">       menuPopup.lastChild.hidden = true;</span>
<a href="#l3.1200"></a><span id="l3.1200">     }</span>
<a href="#l3.1201"></a><span id="l3.1201">   }</span>
<a href="#l3.1202"></a><span id="l3.1202"> }</span>
<a href="#l3.1203"></a><span id="l3.1203"> </span>
<a href="#l3.1204"></a><span id="l3.1204"> function onHighlightColorChange() {</span>
<a href="#l3.1205"></a><span id="l3.1205" class="difflineminus">-  ChangeButtonColor(&quot;cmd_highlight&quot;, &quot;HighlightColorButton&quot;,</span>
<a href="#l3.1206"></a><span id="l3.1206" class="difflineminus">-                    &quot;transparent&quot;);</span>
<a href="#l3.1207"></a><span id="l3.1207" class="difflineplus">+  ChangeButtonColor(&quot;cmd_highlight&quot;, &quot;HighlightColorButton&quot;, &quot;transparent&quot;);</span>
<a href="#l3.1208"></a><span id="l3.1208"> }</span>
<a href="#l3.1209"></a><span id="l3.1209"> </span>
<a href="#l3.1210"></a><span id="l3.1210"> function onFontColorChange() {</span>
<a href="#l3.1211"></a><span id="l3.1211" class="difflineminus">-  ChangeButtonColor(&quot;cmd_fontColor&quot;, &quot;TextColorButton&quot;,</span>
<a href="#l3.1212"></a><span id="l3.1212" class="difflineminus">-                    gDefaultTextColor);</span>
<a href="#l3.1213"></a><span id="l3.1213" class="difflineplus">+  ChangeButtonColor(&quot;cmd_fontColor&quot;, &quot;TextColorButton&quot;, gDefaultTextColor);</span>
<a href="#l3.1214"></a><span id="l3.1214"> }</span>
<a href="#l3.1215"></a><span id="l3.1215"> </span>
<a href="#l3.1216"></a><span id="l3.1216"> function onBackgroundColorChange() {</span>
<a href="#l3.1217"></a><span id="l3.1217" class="difflineminus">-  ChangeButtonColor(&quot;cmd_backgroundColor&quot;, &quot;BackgroundColorButton&quot;,</span>
<a href="#l3.1218"></a><span id="l3.1218" class="difflineminus">-                    gDefaultBackgroundColor);</span>
<a href="#l3.1219"></a><span id="l3.1219" class="difflineplus">+  ChangeButtonColor(</span>
<a href="#l3.1220"></a><span id="l3.1220" class="difflineplus">+    &quot;cmd_backgroundColor&quot;,</span>
<a href="#l3.1221"></a><span id="l3.1221" class="difflineplus">+    &quot;BackgroundColorButton&quot;,</span>
<a href="#l3.1222"></a><span id="l3.1222" class="difflineplus">+    gDefaultBackgroundColor</span>
<a href="#l3.1223"></a><span id="l3.1223" class="difflineplus">+  );</span>
<a href="#l3.1224"></a><span id="l3.1224"> }</span>
<a href="#l3.1225"></a><span id="l3.1225"> </span>
<a href="#l3.1226"></a><span id="l3.1226"> /* Helper function that changes the button color.</span>
<a href="#l3.1227"></a><span id="l3.1227">  *   commandID - The ID of the command element.</span>
<a href="#l3.1228"></a><span id="l3.1228">  *   id - The ID of the button needing to be changed.</span>
<a href="#l3.1229"></a><span id="l3.1229">  *   defaultColor - The default color the button gets set to.</span>
<a href="#l3.1230"></a><span id="l3.1230">  */</span>
<a href="#l3.1231"></a><span id="l3.1231"> function ChangeButtonColor(commandID, id, defaultColor) {</span>
<a href="#l3.1232"></a><span id="l3.1232">   var commandNode = document.getElementById(commandID);</span>
<a href="#l3.1233"></a><span id="l3.1233">   if (commandNode) {</span>
<a href="#l3.1234"></a><span id="l3.1234">     var color = commandNode.getAttribute(&quot;state&quot;);</span>
<a href="#l3.1235"></a><span id="l3.1235">     var button = document.getElementById(id);</span>
<a href="#l3.1236"></a><span id="l3.1236">     if (button) {</span>
<a href="#l3.1237"></a><span id="l3.1237">       button.setAttribute(&quot;color&quot;, color);</span>
<a href="#l3.1238"></a><span id="l3.1238"> </span>
<a href="#l3.1239"></a><span id="l3.1239">       // No color or a mixed color - get color set on page or other defaults.</span>
<a href="#l3.1240"></a><span id="l3.1240" class="difflineminus">-      if (!color || color == &quot;mixed&quot;)</span>
<a href="#l3.1241"></a><span id="l3.1241" class="difflineplus">+      if (!color || color == &quot;mixed&quot;) {</span>
<a href="#l3.1242"></a><span id="l3.1242">         color = defaultColor;</span>
<a href="#l3.1243"></a><span id="l3.1243" class="difflineplus">+      }</span>
<a href="#l3.1244"></a><span id="l3.1244"> </span>
<a href="#l3.1245"></a><span id="l3.1245">       button.setAttribute(&quot;style&quot;, &quot;background-color:&quot; + color + &quot; !important&quot;);</span>
<a href="#l3.1246"></a><span id="l3.1246">     }</span>
<a href="#l3.1247"></a><span id="l3.1247">   }</span>
<a href="#l3.1248"></a><span id="l3.1248"> }</span>
<a href="#l3.1249"></a><span id="l3.1249"> </span>
<a href="#l3.1250"></a><span id="l3.1250"> // Call this when user changes text and/or background colors of the page</span>
<a href="#l3.1251"></a><span id="l3.1251"> function UpdateDefaultColors() {</span>
<a href="#l3.1252"></a><span id="l3.1252">   var BrowserColors = GetDefaultBrowserColors();</span>
<a href="#l3.1253"></a><span id="l3.1253">   var bodyelement = GetBodyElement();</span>
<a href="#l3.1254"></a><span id="l3.1254">   var defTextColor = gDefaultTextColor;</span>
<a href="#l3.1255"></a><span id="l3.1255">   var defBackColor = gDefaultBackgroundColor;</span>
<a href="#l3.1256"></a><span id="l3.1256"> </span>
<a href="#l3.1257"></a><span id="l3.1257">   if (bodyelement) {</span>
<a href="#l3.1258"></a><span id="l3.1258">     var color = bodyelement.getAttribute(&quot;text&quot;);</span>
<a href="#l3.1259"></a><span id="l3.1259" class="difflineminus">-    if (color)</span>
<a href="#l3.1260"></a><span id="l3.1260" class="difflineplus">+    if (color) {</span>
<a href="#l3.1261"></a><span id="l3.1261">       gDefaultTextColor = color;</span>
<a href="#l3.1262"></a><span id="l3.1262" class="difflineminus">-    else if (BrowserColors)</span>
<a href="#l3.1263"></a><span id="l3.1263" class="difflineplus">+    } else if (BrowserColors) {</span>
<a href="#l3.1264"></a><span id="l3.1264">       gDefaultTextColor = BrowserColors.TextColor;</span>
<a href="#l3.1265"></a><span id="l3.1265" class="difflineplus">+    }</span>
<a href="#l3.1266"></a><span id="l3.1266"> </span>
<a href="#l3.1267"></a><span id="l3.1267">     color = bodyelement.getAttribute(&quot;bgcolor&quot;);</span>
<a href="#l3.1268"></a><span id="l3.1268" class="difflineminus">-    if (color)</span>
<a href="#l3.1269"></a><span id="l3.1269" class="difflineplus">+    if (color) {</span>
<a href="#l3.1270"></a><span id="l3.1270">       gDefaultBackgroundColor = color;</span>
<a href="#l3.1271"></a><span id="l3.1271" class="difflineminus">-    else if (BrowserColors)</span>
<a href="#l3.1272"></a><span id="l3.1272" class="difflineplus">+    } else if (BrowserColors) {</span>
<a href="#l3.1273"></a><span id="l3.1273">       gDefaultBackgroundColor = BrowserColors.BackgroundColor;</span>
<a href="#l3.1274"></a><span id="l3.1274" class="difflineplus">+    }</span>
<a href="#l3.1275"></a><span id="l3.1275">   }</span>
<a href="#l3.1276"></a><span id="l3.1276"> </span>
<a href="#l3.1277"></a><span id="l3.1277">   // Trigger update on toolbar</span>
<a href="#l3.1278"></a><span id="l3.1278">   if (defTextColor != gDefaultTextColor) {</span>
<a href="#l3.1279"></a><span id="l3.1279">     goUpdateCommandState(&quot;cmd_fontColor&quot;);</span>
<a href="#l3.1280"></a><span id="l3.1280">     onFontColorChange();</span>
<a href="#l3.1281"></a><span id="l3.1281">   }</span>
<a href="#l3.1282"></a><span id="l3.1282">   if (defBackColor != gDefaultBackgroundColor) {</span>
<a href="#l3.1283"></a><span id="l3.1283">     goUpdateCommandState(&quot;cmd_backgroundColor&quot;);</span>
<a href="#l3.1284"></a><span id="l3.1284">     onBackgroundColorChange();</span>
<a href="#l3.1285"></a><span id="l3.1285">   }</span>
<a href="#l3.1286"></a><span id="l3.1286"> }</span>
<a href="#l3.1287"></a><span id="l3.1287"> </span>
<a href="#l3.1288"></a><span id="l3.1288"> function GetBackgroundElementWithColor() {</span>
<a href="#l3.1289"></a><span id="l3.1289">   var editor = GetCurrentTableEditor();</span>
<a href="#l3.1290"></a><span id="l3.1290" class="difflineminus">-  if (!editor)</span>
<a href="#l3.1291"></a><span id="l3.1291" class="difflineplus">+  if (!editor) {</span>
<a href="#l3.1292"></a><span id="l3.1292">     return null;</span>
<a href="#l3.1293"></a><span id="l3.1293" class="difflineplus">+  }</span>
<a href="#l3.1294"></a><span id="l3.1294"> </span>
<a href="#l3.1295"></a><span id="l3.1295">   gColorObj.Type = &quot;&quot;;</span>
<a href="#l3.1296"></a><span id="l3.1296">   gColorObj.PageColor = &quot;&quot;;</span>
<a href="#l3.1297"></a><span id="l3.1297">   gColorObj.TableColor = &quot;&quot;;</span>
<a href="#l3.1298"></a><span id="l3.1298">   gColorObj.CellColor = &quot;&quot;;</span>
<a href="#l3.1299"></a><span id="l3.1299">   gColorObj.BackgroundColor = &quot;&quot;;</span>
<a href="#l3.1300"></a><span id="l3.1300">   gColorObj.SelectedType = &quot;&quot;;</span>
<a href="#l3.1301"></a><span id="l3.1301"> </span>
<a href="#l3.1302"></a><span id="l3.1302">   var tagNameObj = { value: &quot;&quot; };</span>
<a href="#l3.1303"></a><span id="l3.1303">   var element;</span>
<a href="#l3.1304"></a><span id="l3.1304">   try {</span>
<a href="#l3.1305"></a><span id="l3.1305" class="difflineminus">-    element = editor.getSelectedOrParentTableElement(tagNameObj, {value: 0});</span>
<a href="#l3.1306"></a><span id="l3.1306" class="difflineplus">+    element = editor.getSelectedOrParentTableElement(tagNameObj, { value: 0 });</span>
<a href="#l3.1307"></a><span id="l3.1307">   } catch (e) {}</span>
<a href="#l3.1308"></a><span id="l3.1308"> </span>
<a href="#l3.1309"></a><span id="l3.1309">   if (element &amp;&amp; tagNameObj &amp;&amp; tagNameObj.value) {</span>
<a href="#l3.1310"></a><span id="l3.1310" class="difflineminus">-    gColorObj.BackgroundColor = GetHTMLOrCSSStyleValue(element, &quot;bgcolor&quot;, &quot;background-color&quot;);</span>
<a href="#l3.1311"></a><span id="l3.1311" class="difflineminus">-    gColorObj.BackgroundColor = ConvertRGBColorIntoHEXColor(gColorObj.BackgroundColor);</span>
<a href="#l3.1312"></a><span id="l3.1312" class="difflineplus">+    gColorObj.BackgroundColor = GetHTMLOrCSSStyleValue(</span>
<a href="#l3.1313"></a><span id="l3.1313" class="difflineplus">+      element,</span>
<a href="#l3.1314"></a><span id="l3.1314" class="difflineplus">+      &quot;bgcolor&quot;,</span>
<a href="#l3.1315"></a><span id="l3.1315" class="difflineplus">+      &quot;background-color&quot;</span>
<a href="#l3.1316"></a><span id="l3.1316" class="difflineplus">+    );</span>
<a href="#l3.1317"></a><span id="l3.1317" class="difflineplus">+    gColorObj.BackgroundColor = ConvertRGBColorIntoHEXColor(</span>
<a href="#l3.1318"></a><span id="l3.1318" class="difflineplus">+      gColorObj.BackgroundColor</span>
<a href="#l3.1319"></a><span id="l3.1319" class="difflineplus">+    );</span>
<a href="#l3.1320"></a><span id="l3.1320">     if (tagNameObj.value.toLowerCase() == &quot;td&quot;) {</span>
<a href="#l3.1321"></a><span id="l3.1321">       gColorObj.Type = &quot;Cell&quot;;</span>
<a href="#l3.1322"></a><span id="l3.1322">       gColorObj.CellColor = gColorObj.BackgroundColor;</span>
<a href="#l3.1323"></a><span id="l3.1323"> </span>
<a href="#l3.1324"></a><span id="l3.1324">       // Get any color that might be on parent table</span>
<a href="#l3.1325"></a><span id="l3.1325">       var table = GetParentTable(element);</span>
<a href="#l3.1326"></a><span id="l3.1326" class="difflineminus">-      gColorObj.TableColor = GetHTMLOrCSSStyleValue(table, &quot;bgcolor&quot;, &quot;background-color&quot;);</span>
<a href="#l3.1327"></a><span id="l3.1327" class="difflineplus">+      gColorObj.TableColor = GetHTMLOrCSSStyleValue(</span>
<a href="#l3.1328"></a><span id="l3.1328" class="difflineplus">+        table,</span>
<a href="#l3.1329"></a><span id="l3.1329" class="difflineplus">+        &quot;bgcolor&quot;,</span>
<a href="#l3.1330"></a><span id="l3.1330" class="difflineplus">+        &quot;background-color&quot;</span>
<a href="#l3.1331"></a><span id="l3.1331" class="difflineplus">+      );</span>
<a href="#l3.1332"></a><span id="l3.1332">       gColorObj.TableColor = ConvertRGBColorIntoHEXColor(gColorObj.TableColor);</span>
<a href="#l3.1333"></a><span id="l3.1333">     } else {</span>
<a href="#l3.1334"></a><span id="l3.1334">       gColorObj.Type = &quot;Table&quot;;</span>
<a href="#l3.1335"></a><span id="l3.1335">       gColorObj.TableColor = gColorObj.BackgroundColor;</span>
<a href="#l3.1336"></a><span id="l3.1336">     }</span>
<a href="#l3.1337"></a><span id="l3.1337">     gColorObj.SelectedType = gColorObj.Type;</span>
<a href="#l3.1338"></a><span id="l3.1338">   } else {</span>
<a href="#l3.1339"></a><span id="l3.1339">     let IsCSSPrefChecked = Services.prefs.getBoolPref(kUseCssPref);</span>
<a href="#l3.1340"></a><span id="l3.1340">     if (IsCSSPrefChecked &amp;&amp; IsHTMLEditor()) {</span>
<a href="#l3.1341"></a><span id="l3.1341">       let selection = editor.selection;</span>
<a href="#l3.1342"></a><span id="l3.1342">       if (selection) {</span>
<a href="#l3.1343"></a><span id="l3.1343">         element = selection.focusNode;</span>
<a href="#l3.1344"></a><span id="l3.1344" class="difflineminus">-        while (!editor.nodeIsBlock(element))</span>
<a href="#l3.1345"></a><span id="l3.1345" class="difflineplus">+        while (!editor.nodeIsBlock(element)) {</span>
<a href="#l3.1346"></a><span id="l3.1346">           element = element.parentNode;</span>
<a href="#l3.1347"></a><span id="l3.1347" class="difflineplus">+        }</span>
<a href="#l3.1348"></a><span id="l3.1348">       } else {</span>
<a href="#l3.1349"></a><span id="l3.1349">         element = GetBodyElement();</span>
<a href="#l3.1350"></a><span id="l3.1350">       }</span>
<a href="#l3.1351"></a><span id="l3.1351">     } else {</span>
<a href="#l3.1352"></a><span id="l3.1352">       element = GetBodyElement();</span>
<a href="#l3.1353"></a><span id="l3.1353">     }</span>
<a href="#l3.1354"></a><span id="l3.1354">     if (element) {</span>
<a href="#l3.1355"></a><span id="l3.1355">       gColorObj.Type = &quot;Page&quot;;</span>
<a href="#l3.1356"></a><span id="l3.1356" class="difflineminus">-      gColorObj.BackgroundColor = GetHTMLOrCSSStyleValue(element, &quot;bgcolor&quot;, &quot;background-color&quot;);</span>
<a href="#l3.1357"></a><span id="l3.1357" class="difflineplus">+      gColorObj.BackgroundColor = GetHTMLOrCSSStyleValue(</span>
<a href="#l3.1358"></a><span id="l3.1358" class="difflineplus">+        element,</span>
<a href="#l3.1359"></a><span id="l3.1359" class="difflineplus">+        &quot;bgcolor&quot;,</span>
<a href="#l3.1360"></a><span id="l3.1360" class="difflineplus">+        &quot;background-color&quot;</span>
<a href="#l3.1361"></a><span id="l3.1361" class="difflineplus">+      );</span>
<a href="#l3.1362"></a><span id="l3.1362">       if (gColorObj.BackgroundColor == &quot;&quot;) {</span>
<a href="#l3.1363"></a><span id="l3.1363">         gColorObj.BackgroundColor = &quot;transparent&quot;;</span>
<a href="#l3.1364"></a><span id="l3.1364">       } else {</span>
<a href="#l3.1365"></a><span id="l3.1365" class="difflineminus">-        gColorObj.BackgroundColor = ConvertRGBColorIntoHEXColor(gColorObj.BackgroundColor);</span>
<a href="#l3.1366"></a><span id="l3.1366" class="difflineplus">+        gColorObj.BackgroundColor = ConvertRGBColorIntoHEXColor(</span>
<a href="#l3.1367"></a><span id="l3.1367" class="difflineplus">+          gColorObj.BackgroundColor</span>
<a href="#l3.1368"></a><span id="l3.1368" class="difflineplus">+        );</span>
<a href="#l3.1369"></a><span id="l3.1369">       }</span>
<a href="#l3.1370"></a><span id="l3.1370">       gColorObj.PageColor = gColorObj.BackgroundColor;</span>
<a href="#l3.1371"></a><span id="l3.1371">     }</span>
<a href="#l3.1372"></a><span id="l3.1372">   }</span>
<a href="#l3.1373"></a><span id="l3.1373">   return element;</span>
<a href="#l3.1374"></a><span id="l3.1374"> }</span>
<a href="#l3.1375"></a><span id="l3.1375"> </span>
<a href="#l3.1376"></a><span id="l3.1376"> function SetSmiley(smileyText) {</span>
<a href="#l3.1377"></a><span id="l3.1377" class="difflineat">@@ -1245,163 +1430,206 @@ function SetSmiley(smileyText) {</span>
<a href="#l3.1378"></a><span id="l3.1378">     GetCurrentEditor().insertText(smileyText);</span>
<a href="#l3.1379"></a><span id="l3.1379">     gContentWindow.focus();</span>
<a href="#l3.1380"></a><span id="l3.1380">   } catch (e) {}</span>
<a href="#l3.1381"></a><span id="l3.1381"> }</span>
<a href="#l3.1382"></a><span id="l3.1382"> </span>
<a href="#l3.1383"></a><span id="l3.1383"> /* eslint-disable complexity */</span>
<a href="#l3.1384"></a><span id="l3.1384"> function EditorSelectColor(colorType, mouseEvent) {</span>
<a href="#l3.1385"></a><span id="l3.1385">   var editor = GetCurrentEditor();</span>
<a href="#l3.1386"></a><span id="l3.1386" class="difflineminus">-  if (!editor || !gColorObj)</span>
<a href="#l3.1387"></a><span id="l3.1387" class="difflineplus">+  if (!editor || !gColorObj) {</span>
<a href="#l3.1388"></a><span id="l3.1388">     return;</span>
<a href="#l3.1389"></a><span id="l3.1389" class="difflineplus">+  }</span>
<a href="#l3.1390"></a><span id="l3.1390"> </span>
<a href="#l3.1391"></a><span id="l3.1391">   // Shift + mouse click automatically applies last color, if available</span>
<a href="#l3.1392"></a><span id="l3.1392" class="difflineminus">-  var useLastColor = mouseEvent ? (mouseEvent.button == 0 &amp;&amp; mouseEvent.shiftKey) : false;</span>
<a href="#l3.1393"></a><span id="l3.1393" class="difflineplus">+  var useLastColor = mouseEvent</span>
<a href="#l3.1394"></a><span id="l3.1394" class="difflineplus">+    ? mouseEvent.button == 0 &amp;&amp; mouseEvent.shiftKey</span>
<a href="#l3.1395"></a><span id="l3.1395" class="difflineplus">+    : false;</span>
<a href="#l3.1396"></a><span id="l3.1396">   var element;</span>
<a href="#l3.1397"></a><span id="l3.1397">   var table;</span>
<a href="#l3.1398"></a><span id="l3.1398">   var currentColor = &quot;&quot;;</span>
<a href="#l3.1399"></a><span id="l3.1399">   var commandNode;</span>
<a href="#l3.1400"></a><span id="l3.1400"> </span>
<a href="#l3.1401"></a><span id="l3.1401" class="difflineminus">-  if (!colorType)</span>
<a href="#l3.1402"></a><span id="l3.1402" class="difflineplus">+  if (!colorType) {</span>
<a href="#l3.1403"></a><span id="l3.1403">     colorType = &quot;&quot;;</span>
<a href="#l3.1404"></a><span id="l3.1404" class="difflineplus">+  }</span>
<a href="#l3.1405"></a><span id="l3.1405"> </span>
<a href="#l3.1406"></a><span id="l3.1406">   if (colorType == &quot;Text&quot;) {</span>
<a href="#l3.1407"></a><span id="l3.1407">     gColorObj.Type = colorType;</span>
<a href="#l3.1408"></a><span id="l3.1408"> </span>
<a href="#l3.1409"></a><span id="l3.1409">     // Get color from command node state</span>
<a href="#l3.1410"></a><span id="l3.1410">     commandNode = document.getElementById(&quot;cmd_fontColor&quot;);</span>
<a href="#l3.1411"></a><span id="l3.1411">     currentColor = commandNode.getAttribute(&quot;state&quot;);</span>
<a href="#l3.1412"></a><span id="l3.1412">     currentColor = ConvertRGBColorIntoHEXColor(currentColor);</span>
<a href="#l3.1413"></a><span id="l3.1413">     gColorObj.TextColor = currentColor;</span>
<a href="#l3.1414"></a><span id="l3.1414"> </span>
<a href="#l3.1415"></a><span id="l3.1415" class="difflineminus">-    if (useLastColor &amp;&amp; gColorObj.LastTextColor)</span>
<a href="#l3.1416"></a><span id="l3.1416" class="difflineplus">+    if (useLastColor &amp;&amp; gColorObj.LastTextColor) {</span>
<a href="#l3.1417"></a><span id="l3.1417">       gColorObj.TextColor = gColorObj.LastTextColor;</span>
<a href="#l3.1418"></a><span id="l3.1418" class="difflineminus">-    else</span>
<a href="#l3.1419"></a><span id="l3.1419" class="difflineplus">+    } else {</span>
<a href="#l3.1420"></a><span id="l3.1420">       useLastColor = false;</span>
<a href="#l3.1421"></a><span id="l3.1421" class="difflineplus">+    }</span>
<a href="#l3.1422"></a><span id="l3.1422">   } else if (colorType == &quot;Highlight&quot;) {</span>
<a href="#l3.1423"></a><span id="l3.1423">     gColorObj.Type = colorType;</span>
<a href="#l3.1424"></a><span id="l3.1424"> </span>
<a href="#l3.1425"></a><span id="l3.1425">     // Get color from command node state</span>
<a href="#l3.1426"></a><span id="l3.1426">     commandNode = document.getElementById(&quot;cmd_highlight&quot;);</span>
<a href="#l3.1427"></a><span id="l3.1427">     currentColor = commandNode.getAttribute(&quot;state&quot;);</span>
<a href="#l3.1428"></a><span id="l3.1428">     currentColor = ConvertRGBColorIntoHEXColor(currentColor);</span>
<a href="#l3.1429"></a><span id="l3.1429">     gColorObj.HighlightColor = currentColor;</span>
<a href="#l3.1430"></a><span id="l3.1430"> </span>
<a href="#l3.1431"></a><span id="l3.1431" class="difflineminus">-    if (useLastColor &amp;&amp; gColorObj.LastHighlightColor)</span>
<a href="#l3.1432"></a><span id="l3.1432" class="difflineplus">+    if (useLastColor &amp;&amp; gColorObj.LastHighlightColor) {</span>
<a href="#l3.1433"></a><span id="l3.1433">       gColorObj.HighlightColor = gColorObj.LastHighlightColor;</span>
<a href="#l3.1434"></a><span id="l3.1434" class="difflineminus">-    else</span>
<a href="#l3.1435"></a><span id="l3.1435" class="difflineplus">+    } else {</span>
<a href="#l3.1436"></a><span id="l3.1436">       useLastColor = false;</span>
<a href="#l3.1437"></a><span id="l3.1437" class="difflineplus">+    }</span>
<a href="#l3.1438"></a><span id="l3.1438">   } else {</span>
<a href="#l3.1439"></a><span id="l3.1439">     element = GetBackgroundElementWithColor();</span>
<a href="#l3.1440"></a><span id="l3.1440" class="difflineminus">-    if (!element)</span>
<a href="#l3.1441"></a><span id="l3.1441" class="difflineplus">+    if (!element) {</span>
<a href="#l3.1442"></a><span id="l3.1442">       return;</span>
<a href="#l3.1443"></a><span id="l3.1443" class="difflineplus">+    }</span>
<a href="#l3.1444"></a><span id="l3.1444"> </span>
<a href="#l3.1445"></a><span id="l3.1445">     // Get the table if we found a cell</span>
<a href="#l3.1446"></a><span id="l3.1446" class="difflineminus">-    if (gColorObj.Type == &quot;Table&quot;)</span>
<a href="#l3.1447"></a><span id="l3.1447" class="difflineplus">+    if (gColorObj.Type == &quot;Table&quot;) {</span>
<a href="#l3.1448"></a><span id="l3.1448">       table = element;</span>
<a href="#l3.1449"></a><span id="l3.1449" class="difflineminus">-    else if (gColorObj.Type == &quot;Cell&quot;)</span>
<a href="#l3.1450"></a><span id="l3.1450" class="difflineplus">+    } else if (gColorObj.Type == &quot;Cell&quot;) {</span>
<a href="#l3.1451"></a><span id="l3.1451">       table = GetParentTable(element);</span>
<a href="#l3.1452"></a><span id="l3.1452" class="difflineplus">+    }</span>
<a href="#l3.1453"></a><span id="l3.1453"> </span>
<a href="#l3.1454"></a><span id="l3.1454">     // Save to avoid resetting if not necessary</span>
<a href="#l3.1455"></a><span id="l3.1455">     currentColor = gColorObj.BackgroundColor;</span>
<a href="#l3.1456"></a><span id="l3.1456"> </span>
<a href="#l3.1457"></a><span id="l3.1457">     if (colorType == &quot;TableOrCell&quot; || colorType == &quot;Cell&quot;) {</span>
<a href="#l3.1458"></a><span id="l3.1458" class="difflineminus">-      if (gColorObj.Type == &quot;Cell&quot;)</span>
<a href="#l3.1459"></a><span id="l3.1459" class="difflineplus">+      if (gColorObj.Type == &quot;Cell&quot;) {</span>
<a href="#l3.1460"></a><span id="l3.1460">         gColorObj.Type = colorType;</span>
<a href="#l3.1461"></a><span id="l3.1461" class="difflineminus">-      else if (gColorObj.Type != &quot;Table&quot;)</span>
<a href="#l3.1462"></a><span id="l3.1462" class="difflineplus">+      } else if (gColorObj.Type != &quot;Table&quot;) {</span>
<a href="#l3.1463"></a><span id="l3.1463">         return;</span>
<a href="#l3.1464"></a><span id="l3.1464" class="difflineplus">+      }</span>
<a href="#l3.1465"></a><span id="l3.1465">     } else if (colorType == &quot;Table&quot; &amp;&amp; gColorObj.Type == &quot;Page&quot;) {</span>
<a href="#l3.1466"></a><span id="l3.1466">       return;</span>
<a href="#l3.1467"></a><span id="l3.1467">     }</span>
<a href="#l3.1468"></a><span id="l3.1468"> </span>
<a href="#l3.1469"></a><span id="l3.1469">     if (colorType == &quot;&quot; &amp;&amp; gColorObj.Type == &quot;Cell&quot;) {</span>
<a href="#l3.1470"></a><span id="l3.1470">       // Using empty string for requested type means</span>
<a href="#l3.1471"></a><span id="l3.1471">       //  we can let user select cell or table</span>
<a href="#l3.1472"></a><span id="l3.1472">       gColorObj.Type = &quot;TableOrCell&quot;;</span>
<a href="#l3.1473"></a><span id="l3.1473">     }</span>
<a href="#l3.1474"></a><span id="l3.1474"> </span>
<a href="#l3.1475"></a><span id="l3.1475" class="difflineminus">-    if (useLastColor &amp;&amp; gColorObj.LastBackgroundColor)</span>
<a href="#l3.1476"></a><span id="l3.1476" class="difflineplus">+    if (useLastColor &amp;&amp; gColorObj.LastBackgroundColor) {</span>
<a href="#l3.1477"></a><span id="l3.1477">       gColorObj.BackgroundColor = gColorObj.LastBackgroundColor;</span>
<a href="#l3.1478"></a><span id="l3.1478" class="difflineminus">-    else</span>
<a href="#l3.1479"></a><span id="l3.1479" class="difflineplus">+    } else {</span>
<a href="#l3.1480"></a><span id="l3.1480">       useLastColor = false;</span>
<a href="#l3.1481"></a><span id="l3.1481" class="difflineplus">+    }</span>
<a href="#l3.1482"></a><span id="l3.1482">   }</span>
<a href="#l3.1483"></a><span id="l3.1483">   // Save the type we are really requesting</span>
<a href="#l3.1484"></a><span id="l3.1484">   colorType = gColorObj.Type;</span>
<a href="#l3.1485"></a><span id="l3.1485"> </span>
<a href="#l3.1486"></a><span id="l3.1486">   if (!useLastColor) {</span>
<a href="#l3.1487"></a><span id="l3.1487">     // Avoid the JS warning</span>
<a href="#l3.1488"></a><span id="l3.1488">     gColorObj.NoDefault = false;</span>
<a href="#l3.1489"></a><span id="l3.1489"> </span>
<a href="#l3.1490"></a><span id="l3.1490">     // Launch the ColorPicker dialog</span>
<a href="#l3.1491"></a><span id="l3.1491">     // TODO: Figure out how to position this under the color buttons on the toolbar</span>
<a href="#l3.1492"></a><span id="l3.1492" class="difflineminus">-    window.openDialog(&quot;chrome://editor/content/EdColorPicker.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, &quot;&quot;, gColorObj);</span>
<a href="#l3.1493"></a><span id="l3.1493" class="difflineplus">+    window.openDialog(</span>
<a href="#l3.1494"></a><span id="l3.1494" class="difflineplus">+      &quot;chrome://editor/content/EdColorPicker.xul&quot;,</span>
<a href="#l3.1495"></a><span id="l3.1495" class="difflineplus">+      &quot;_blank&quot;,</span>
<a href="#l3.1496"></a><span id="l3.1496" class="difflineplus">+      &quot;chrome,close,titlebar,modal&quot;,</span>
<a href="#l3.1497"></a><span id="l3.1497" class="difflineplus">+      &quot;&quot;,</span>
<a href="#l3.1498"></a><span id="l3.1498" class="difflineplus">+      gColorObj</span>
<a href="#l3.1499"></a><span id="l3.1499" class="difflineplus">+    );</span>
<a href="#l3.1500"></a><span id="l3.1500"> </span>
<a href="#l3.1501"></a><span id="l3.1501">     // User canceled the dialog</span>
<a href="#l3.1502"></a><span id="l3.1502" class="difflineminus">-    if (gColorObj.Cancel)</span>
<a href="#l3.1503"></a><span id="l3.1503" class="difflineplus">+    if (gColorObj.Cancel) {</span>
<a href="#l3.1504"></a><span id="l3.1504">       return;</span>
<a href="#l3.1505"></a><span id="l3.1505" class="difflineplus">+    }</span>
<a href="#l3.1506"></a><span id="l3.1506">   }</span>
<a href="#l3.1507"></a><span id="l3.1507"> </span>
<a href="#l3.1508"></a><span id="l3.1508">   if (gColorObj.Type == &quot;Text&quot;) {</span>
<a href="#l3.1509"></a><span id="l3.1509">     if (currentColor != gColorObj.TextColor) {</span>
<a href="#l3.1510"></a><span id="l3.1510" class="difflineminus">-      if (gColorObj.TextColor)</span>
<a href="#l3.1511"></a><span id="l3.1511" class="difflineplus">+      if (gColorObj.TextColor) {</span>
<a href="#l3.1512"></a><span id="l3.1512">         EditorSetTextProperty(&quot;font&quot;, &quot;color&quot;, gColorObj.TextColor);</span>
<a href="#l3.1513"></a><span id="l3.1513" class="difflineminus">-      else</span>
<a href="#l3.1514"></a><span id="l3.1514" class="difflineplus">+      } else {</span>
<a href="#l3.1515"></a><span id="l3.1515">         EditorRemoveTextProperty(&quot;font&quot;, &quot;color&quot;);</span>
<a href="#l3.1516"></a><span id="l3.1516" class="difflineplus">+      }</span>
<a href="#l3.1517"></a><span id="l3.1517">     }</span>
<a href="#l3.1518"></a><span id="l3.1518">     // Update the command state (this will trigger color button update)</span>
<a href="#l3.1519"></a><span id="l3.1519">     goUpdateCommandState(&quot;cmd_fontColor&quot;);</span>
<a href="#l3.1520"></a><span id="l3.1520">   } else if (gColorObj.Type == &quot;Highlight&quot;) {</span>
<a href="#l3.1521"></a><span id="l3.1521">     if (currentColor != gColorObj.HighlightColor) {</span>
<a href="#l3.1522"></a><span id="l3.1522" class="difflineminus">-      if (gColorObj.HighlightColor)</span>
<a href="#l3.1523"></a><span id="l3.1523" class="difflineplus">+      if (gColorObj.HighlightColor) {</span>
<a href="#l3.1524"></a><span id="l3.1524">         EditorSetTextProperty(&quot;font&quot;, &quot;bgcolor&quot;, gColorObj.HighlightColor);</span>
<a href="#l3.1525"></a><span id="l3.1525" class="difflineminus">-      else</span>
<a href="#l3.1526"></a><span id="l3.1526" class="difflineplus">+      } else {</span>
<a href="#l3.1527"></a><span id="l3.1527">         EditorRemoveTextProperty(&quot;font&quot;, &quot;bgcolor&quot;);</span>
<a href="#l3.1528"></a><span id="l3.1528" class="difflineplus">+      }</span>
<a href="#l3.1529"></a><span id="l3.1529">     }</span>
<a href="#l3.1530"></a><span id="l3.1530">     // Update the command state (this will trigger color button update)</span>
<a href="#l3.1531"></a><span id="l3.1531">     goUpdateCommandState(&quot;cmd_highlight&quot;);</span>
<a href="#l3.1532"></a><span id="l3.1532">   } else if (element) {</span>
<a href="#l3.1533"></a><span id="l3.1533">     if (gColorObj.Type == &quot;Table&quot;) {</span>
<a href="#l3.1534"></a><span id="l3.1534">       // Set background on a table</span>
<a href="#l3.1535"></a><span id="l3.1535">       // Note that we shouldn't trust &quot;currentColor&quot; because of &quot;TableOrCell&quot; behavior</span>
<a href="#l3.1536"></a><span id="l3.1536">       if (table) {</span>
<a href="#l3.1537"></a><span id="l3.1537">         var bgcolor = table.getAttribute(&quot;bgcolor&quot;);</span>
<a href="#l3.1538"></a><span id="l3.1538" class="difflineminus">-        if (bgcolor != gColorObj.BackgroundColor)</span>
<a href="#l3.1539"></a><span id="l3.1539" class="difflineminus">-        try {</span>
<a href="#l3.1540"></a><span id="l3.1540" class="difflineminus">-          if (gColorObj.BackgroundColor)</span>
<a href="#l3.1541"></a><span id="l3.1541" class="difflineminus">-            editor.setAttributeOrEquivalent(table, &quot;bgcolor&quot;, gColorObj.BackgroundColor, false);</span>
<a href="#l3.1542"></a><span id="l3.1542" class="difflineminus">-          else</span>
<a href="#l3.1543"></a><span id="l3.1543" class="difflineminus">-            editor.removeAttributeOrEquivalent(table, &quot;bgcolor&quot;, false);</span>
<a href="#l3.1544"></a><span id="l3.1544" class="difflineminus">-        } catch (e) {}</span>
<a href="#l3.1545"></a><span id="l3.1545" class="difflineplus">+        if (bgcolor != gColorObj.BackgroundColor) {</span>
<a href="#l3.1546"></a><span id="l3.1546" class="difflineplus">+          try {</span>
<a href="#l3.1547"></a><span id="l3.1547" class="difflineplus">+            if (gColorObj.BackgroundColor) {</span>
<a href="#l3.1548"></a><span id="l3.1548" class="difflineplus">+              editor.setAttributeOrEquivalent(</span>
<a href="#l3.1549"></a><span id="l3.1549" class="difflineplus">+                table,</span>
<a href="#l3.1550"></a><span id="l3.1550" class="difflineplus">+                &quot;bgcolor&quot;,</span>
<a href="#l3.1551"></a><span id="l3.1551" class="difflineplus">+                gColorObj.BackgroundColor,</span>
<a href="#l3.1552"></a><span id="l3.1552" class="difflineplus">+                false</span>
<a href="#l3.1553"></a><span id="l3.1553" class="difflineplus">+              );</span>
<a href="#l3.1554"></a><span id="l3.1554" class="difflineplus">+            } else {</span>
<a href="#l3.1555"></a><span id="l3.1555" class="difflineplus">+              editor.removeAttributeOrEquivalent(table, &quot;bgcolor&quot;, false);</span>
<a href="#l3.1556"></a><span id="l3.1556" class="difflineplus">+            }</span>
<a href="#l3.1557"></a><span id="l3.1557" class="difflineplus">+          } catch (e) {}</span>
<a href="#l3.1558"></a><span id="l3.1558" class="difflineplus">+        }</span>
<a href="#l3.1559"></a><span id="l3.1559">       }</span>
<a href="#l3.1560"></a><span id="l3.1560">     } else if (currentColor != gColorObj.BackgroundColor &amp;&amp; IsHTMLEditor()) {</span>
<a href="#l3.1561"></a><span id="l3.1561">       editor.beginTransaction();</span>
<a href="#l3.1562"></a><span id="l3.1562">       try {</span>
<a href="#l3.1563"></a><span id="l3.1563">         editor.setBackgroundColor(gColorObj.BackgroundColor);</span>
<a href="#l3.1564"></a><span id="l3.1564"> </span>
<a href="#l3.1565"></a><span id="l3.1565">         if (gColorObj.Type == &quot;Page&quot; &amp;&amp; gColorObj.BackgroundColor) {</span>
<a href="#l3.1566"></a><span id="l3.1566">           // Set all page colors not explicitly set,</span>
<a href="#l3.1567"></a><span id="l3.1567">           //  else you can end up with unreadable pages</span>
<a href="#l3.1568"></a><span id="l3.1568">           //  because viewer's default colors may not be same as page author's</span>
<a href="#l3.1569"></a><span id="l3.1569">           var bodyelement = GetBodyElement();</span>
<a href="#l3.1570"></a><span id="l3.1570">           if (bodyelement) {</span>
<a href="#l3.1571"></a><span id="l3.1571">             var defColors = GetDefaultBrowserColors();</span>
<a href="#l3.1572"></a><span id="l3.1572">             if (defColors) {</span>
<a href="#l3.1573"></a><span id="l3.1573" class="difflineminus">-              if (!bodyelement.getAttribute(&quot;text&quot;))</span>
<a href="#l3.1574"></a><span id="l3.1574" class="difflineminus">-                editor.setAttributeOrEquivalent(bodyelement, &quot;text&quot;, defColors.TextColor, false);</span>
<a href="#l3.1575"></a><span id="l3.1575" class="difflineplus">+              if (!bodyelement.getAttribute(&quot;text&quot;)) {</span>
<a href="#l3.1576"></a><span id="l3.1576" class="difflineplus">+                editor.setAttributeOrEquivalent(</span>
<a href="#l3.1577"></a><span id="l3.1577" class="difflineplus">+                  bodyelement,</span>
<a href="#l3.1578"></a><span id="l3.1578" class="difflineplus">+                  &quot;text&quot;,</span>
<a href="#l3.1579"></a><span id="l3.1579" class="difflineplus">+                  defColors.TextColor,</span>
<a href="#l3.1580"></a><span id="l3.1580" class="difflineplus">+                  false</span>
<a href="#l3.1581"></a><span id="l3.1581" class="difflineplus">+                );</span>
<a href="#l3.1582"></a><span id="l3.1582" class="difflineplus">+              }</span>
<a href="#l3.1583"></a><span id="l3.1583"> </span>
<a href="#l3.1584"></a><span id="l3.1584">               // The following attributes have no individual CSS declaration counterparts</span>
<a href="#l3.1585"></a><span id="l3.1585">               // Getting rid of them in favor of CSS implies CSS rules management</span>
<a href="#l3.1586"></a><span id="l3.1586" class="difflineminus">-              if (!bodyelement.getAttribute(&quot;link&quot;))</span>
<a href="#l3.1587"></a><span id="l3.1587" class="difflineplus">+              if (!bodyelement.getAttribute(&quot;link&quot;)) {</span>
<a href="#l3.1588"></a><span id="l3.1588">                 editor.setAttribute(bodyelement, &quot;link&quot;, defColors.LinkColor);</span>
<a href="#l3.1589"></a><span id="l3.1589" class="difflineminus">-</span>
<a href="#l3.1590"></a><span id="l3.1590" class="difflineminus">-              if (!bodyelement.getAttribute(&quot;alink&quot;))</span>
<a href="#l3.1591"></a><span id="l3.1591" class="difflineminus">-                editor.setAttribute(bodyelement, &quot;alink&quot;, defColors.ActiveLinkColor);</span>
<a href="#l3.1592"></a><span id="l3.1592" class="difflineminus">-</span>
<a href="#l3.1593"></a><span id="l3.1593" class="difflineminus">-              if (!bodyelement.getAttribute(&quot;vlink&quot;))</span>
<a href="#l3.1594"></a><span id="l3.1594" class="difflineminus">-                editor.setAttribute(bodyelement, &quot;vlink&quot;, defColors.VisitedLinkColor);</span>
<a href="#l3.1595"></a><span id="l3.1595" class="difflineplus">+              }</span>
<a href="#l3.1596"></a><span id="l3.1596" class="difflineplus">+</span>
<a href="#l3.1597"></a><span id="l3.1597" class="difflineplus">+              if (!bodyelement.getAttribute(&quot;alink&quot;)) {</span>
<a href="#l3.1598"></a><span id="l3.1598" class="difflineplus">+                editor.setAttribute(</span>
<a href="#l3.1599"></a><span id="l3.1599" class="difflineplus">+                  bodyelement,</span>
<a href="#l3.1600"></a><span id="l3.1600" class="difflineplus">+                  &quot;alink&quot;,</span>
<a href="#l3.1601"></a><span id="l3.1601" class="difflineplus">+                  defColors.ActiveLinkColor</span>
<a href="#l3.1602"></a><span id="l3.1602" class="difflineplus">+                );</span>
<a href="#l3.1603"></a><span id="l3.1603" class="difflineplus">+              }</span>
<a href="#l3.1604"></a><span id="l3.1604" class="difflineplus">+</span>
<a href="#l3.1605"></a><span id="l3.1605" class="difflineplus">+              if (!bodyelement.getAttribute(&quot;vlink&quot;)) {</span>
<a href="#l3.1606"></a><span id="l3.1606" class="difflineplus">+                editor.setAttribute(</span>
<a href="#l3.1607"></a><span id="l3.1607" class="difflineplus">+                  bodyelement,</span>
<a href="#l3.1608"></a><span id="l3.1608" class="difflineplus">+                  &quot;vlink&quot;,</span>
<a href="#l3.1609"></a><span id="l3.1609" class="difflineplus">+                  defColors.VisitedLinkColor</span>
<a href="#l3.1610"></a><span id="l3.1610" class="difflineplus">+                );</span>
<a href="#l3.1611"></a><span id="l3.1611" class="difflineplus">+              }</span>
<a href="#l3.1612"></a><span id="l3.1612">             }</span>
<a href="#l3.1613"></a><span id="l3.1613">           }</span>
<a href="#l3.1614"></a><span id="l3.1614">         }</span>
<a href="#l3.1615"></a><span id="l3.1615">       } catch (e) {}</span>
<a href="#l3.1616"></a><span id="l3.1616"> </span>
<a href="#l3.1617"></a><span id="l3.1617">       editor.endTransaction();</span>
<a href="#l3.1618"></a><span id="l3.1618">     }</span>
<a href="#l3.1619"></a><span id="l3.1619"> </span>
<a href="#l3.1620"></a><span id="l3.1620" class="difflineat">@@ -1409,57 +1637,76 @@ function EditorSelectColor(colorType, mo</span>
<a href="#l3.1621"></a><span id="l3.1621">   }</span>
<a href="#l3.1622"></a><span id="l3.1622">   gContentWindow.focus();</span>
<a href="#l3.1623"></a><span id="l3.1623"> }</span>
<a href="#l3.1624"></a><span id="l3.1624"> /* eslint-enable complexity */</span>
<a href="#l3.1625"></a><span id="l3.1625"> </span>
<a href="#l3.1626"></a><span id="l3.1626"> function GetParentTable(element) {</span>
<a href="#l3.1627"></a><span id="l3.1627">   var node = element;</span>
<a href="#l3.1628"></a><span id="l3.1628">   while (node) {</span>
<a href="#l3.1629"></a><span id="l3.1629" class="difflineminus">-    if (node.nodeName.toLowerCase() == &quot;table&quot;)</span>
<a href="#l3.1630"></a><span id="l3.1630" class="difflineplus">+    if (node.nodeName.toLowerCase() == &quot;table&quot;) {</span>
<a href="#l3.1631"></a><span id="l3.1631">       return node;</span>
<a href="#l3.1632"></a><span id="l3.1632" class="difflineplus">+    }</span>
<a href="#l3.1633"></a><span id="l3.1633"> </span>
<a href="#l3.1634"></a><span id="l3.1634">     node = node.parentNode;</span>
<a href="#l3.1635"></a><span id="l3.1635">   }</span>
<a href="#l3.1636"></a><span id="l3.1636">   return node;</span>
<a href="#l3.1637"></a><span id="l3.1637"> }</span>
<a href="#l3.1638"></a><span id="l3.1638"> </span>
<a href="#l3.1639"></a><span id="l3.1639"> function GetParentTableCell(element) {</span>
<a href="#l3.1640"></a><span id="l3.1640">   var node = element;</span>
<a href="#l3.1641"></a><span id="l3.1641">   while (node) {</span>
<a href="#l3.1642"></a><span id="l3.1642" class="difflineminus">-    if (node.nodeName.toLowerCase() == &quot;td&quot; || node.nodeName.toLowerCase() == &quot;th&quot;)</span>
<a href="#l3.1643"></a><span id="l3.1643" class="difflineplus">+    if (</span>
<a href="#l3.1644"></a><span id="l3.1644" class="difflineplus">+      node.nodeName.toLowerCase() == &quot;td&quot; ||</span>
<a href="#l3.1645"></a><span id="l3.1645" class="difflineplus">+      node.nodeName.toLowerCase() == &quot;th&quot;</span>
<a href="#l3.1646"></a><span id="l3.1646" class="difflineplus">+    ) {</span>
<a href="#l3.1647"></a><span id="l3.1647">       return node;</span>
<a href="#l3.1648"></a><span id="l3.1648" class="difflineplus">+    }</span>
<a href="#l3.1649"></a><span id="l3.1649"> </span>
<a href="#l3.1650"></a><span id="l3.1650">     node = node.parentNode;</span>
<a href="#l3.1651"></a><span id="l3.1651">   }</span>
<a href="#l3.1652"></a><span id="l3.1652">   return node;</span>
<a href="#l3.1653"></a><span id="l3.1653"> }</span>
<a href="#l3.1654"></a><span id="l3.1654"> </span>
<a href="#l3.1655"></a><span id="l3.1655"> function EditorDblClick(event) {</span>
<a href="#l3.1656"></a><span id="l3.1656">   // We check event.explicitOriginalTarget here because .target will never</span>
<a href="#l3.1657"></a><span id="l3.1657">   // be a textnode (bug 193689)</span>
<a href="#l3.1658"></a><span id="l3.1658">   if (event.explicitOriginalTarget) {</span>
<a href="#l3.1659"></a><span id="l3.1659">     // Only bring up properties if clicked on an element or selected link</span>
<a href="#l3.1660"></a><span id="l3.1660">     var element;</span>
<a href="#l3.1661"></a><span id="l3.1661">     try {</span>
<a href="#l3.1662"></a><span id="l3.1662">       element = event.explicitOriginalTarget;</span>
<a href="#l3.1663"></a><span id="l3.1663">     } catch (e) {}</span>
<a href="#l3.1664"></a><span id="l3.1664"> </span>
<a href="#l3.1665"></a><span id="l3.1665" class="difflineminus">-     //  We use &quot;href&quot; instead of &quot;a&quot; to not be fooled by named anchor</span>
<a href="#l3.1666"></a><span id="l3.1666" class="difflineminus">-    if (!element)</span>
<a href="#l3.1667"></a><span id="l3.1667" class="difflineplus">+    //  We use &quot;href&quot; instead of &quot;a&quot; to not be fooled by named anchor</span>
<a href="#l3.1668"></a><span id="l3.1668" class="difflineplus">+    if (!element) {</span>
<a href="#l3.1669"></a><span id="l3.1669">       try {</span>
<a href="#l3.1670"></a><span id="l3.1670">         element = GetCurrentEditor().getSelectedElement(&quot;href&quot;);</span>
<a href="#l3.1671"></a><span id="l3.1671">       } catch (e) {}</span>
<a href="#l3.1672"></a><span id="l3.1672" class="difflineplus">+    }</span>
<a href="#l3.1673"></a><span id="l3.1673"> </span>
<a href="#l3.1674"></a><span id="l3.1674">     // Don't fire for body/p and other block elements.</span>
<a href="#l3.1675"></a><span id="l3.1675">     // It's common that people try to double-click</span>
<a href="#l3.1676"></a><span id="l3.1676">     // to select a word, but the click hits an empty area.</span>
<a href="#l3.1677"></a><span id="l3.1677" class="difflineminus">-    if (element &amp;&amp;</span>
<a href="#l3.1678"></a><span id="l3.1678" class="difflineminus">-        ![&quot;body&quot;, &quot;p&quot;, &quot;h1&quot;, &quot;h2&quot;, &quot;h3&quot;, &quot;h4&quot;, &quot;h5&quot;, &quot;h6&quot;, &quot;blockquote&quot;, &quot;div&quot;, &quot;pre&quot;]</span>
<a href="#l3.1679"></a><span id="l3.1679" class="difflineminus">-         .includes(element.nodeName.toLowerCase())) {</span>
<a href="#l3.1680"></a><span id="l3.1680" class="difflineplus">+    if (</span>
<a href="#l3.1681"></a><span id="l3.1681" class="difflineplus">+      element &amp;&amp;</span>
<a href="#l3.1682"></a><span id="l3.1682" class="difflineplus">+      ![</span>
<a href="#l3.1683"></a><span id="l3.1683" class="difflineplus">+        &quot;body&quot;,</span>
<a href="#l3.1684"></a><span id="l3.1684" class="difflineplus">+        &quot;p&quot;,</span>
<a href="#l3.1685"></a><span id="l3.1685" class="difflineplus">+        &quot;h1&quot;,</span>
<a href="#l3.1686"></a><span id="l3.1686" class="difflineplus">+        &quot;h2&quot;,</span>
<a href="#l3.1687"></a><span id="l3.1687" class="difflineplus">+        &quot;h3&quot;,</span>
<a href="#l3.1688"></a><span id="l3.1688" class="difflineplus">+        &quot;h4&quot;,</span>
<a href="#l3.1689"></a><span id="l3.1689" class="difflineplus">+        &quot;h5&quot;,</span>
<a href="#l3.1690"></a><span id="l3.1690" class="difflineplus">+        &quot;h6&quot;,</span>
<a href="#l3.1691"></a><span id="l3.1691" class="difflineplus">+        &quot;blockquote&quot;,</span>
<a href="#l3.1692"></a><span id="l3.1692" class="difflineplus">+        &quot;div&quot;,</span>
<a href="#l3.1693"></a><span id="l3.1693" class="difflineplus">+        &quot;pre&quot;,</span>
<a href="#l3.1694"></a><span id="l3.1694" class="difflineplus">+      ].includes(element.nodeName.toLowerCase())</span>
<a href="#l3.1695"></a><span id="l3.1695" class="difflineplus">+    ) {</span>
<a href="#l3.1696"></a><span id="l3.1696">       goDoCommand(&quot;cmd_objectProperties&quot;);</span>
<a href="#l3.1697"></a><span id="l3.1697">       event.preventDefault();</span>
<a href="#l3.1698"></a><span id="l3.1698">     }</span>
<a href="#l3.1699"></a><span id="l3.1699">   }</span>
<a href="#l3.1700"></a><span id="l3.1700"> }</span>
<a href="#l3.1701"></a><span id="l3.1701"> </span>
<a href="#l3.1702"></a><span id="l3.1702"> function EditorClick(event) {</span>
<a href="#l3.1703"></a><span id="l3.1703">   // For Web Composer: In Show All Tags Mode,</span>
<a href="#l3.1704"></a><span id="l3.1704" class="difflineat">@@ -1482,18 +1729,19 @@ function EditorClick(event) {</span>
<a href="#l3.1705"></a><span id="l3.1705"> /* TODO: We need an oncreate hook to do enabling/disabling for the</span>
<a href="#l3.1706"></a><span id="l3.1706">         Format menu. There should be code like this for the</span>
<a href="#l3.1707"></a><span id="l3.1707">         object-specific &quot;Properties&quot; item</span>
<a href="#l3.1708"></a><span id="l3.1708"> */</span>
<a href="#l3.1709"></a><span id="l3.1709"> // For property dialogs, we want the selected element,</span>
<a href="#l3.1710"></a><span id="l3.1710"> //  but will accept a parent link, list, or table cell if inside one</span>
<a href="#l3.1711"></a><span id="l3.1711"> function GetObjectForProperties() {</span>
<a href="#l3.1712"></a><span id="l3.1712">   var editor = GetCurrentEditor();</span>
<a href="#l3.1713"></a><span id="l3.1713" class="difflineminus">-  if (!editor || !IsHTMLEditor())</span>
<a href="#l3.1714"></a><span id="l3.1714" class="difflineplus">+  if (!editor || !IsHTMLEditor()) {</span>
<a href="#l3.1715"></a><span id="l3.1715">     return null;</span>
<a href="#l3.1716"></a><span id="l3.1716" class="difflineplus">+  }</span>
<a href="#l3.1717"></a><span id="l3.1717"> </span>
<a href="#l3.1718"></a><span id="l3.1718">   var element;</span>
<a href="#l3.1719"></a><span id="l3.1719">   try {</span>
<a href="#l3.1720"></a><span id="l3.1720">     element = editor.getSelectedElement(&quot;&quot;);</span>
<a href="#l3.1721"></a><span id="l3.1721">   } catch (e) {}</span>
<a href="#l3.1722"></a><span id="l3.1722">   if (element) {</span>
<a href="#l3.1723"></a><span id="l3.1723">     if (element.namespaceURI == &quot;http://www.w3.org/1998/Math/MathML&quot;) {</span>
<a href="#l3.1724"></a><span id="l3.1724">       // If the object is a MathML element, we collapse the selection on it and</span>
<a href="#l3.1725"></a><span id="l3.1725" class="difflineat">@@ -1513,114 +1761,140 @@ function GetObjectForProperties() {</span>
<a href="#l3.1726"></a><span id="l3.1726">     anchorNode = editor.selection.anchorNode;</span>
<a href="#l3.1727"></a><span id="l3.1727">     if (anchorNode.firstChild) {</span>
<a href="#l3.1728"></a><span id="l3.1728">       // Start at actual selected node</span>
<a href="#l3.1729"></a><span id="l3.1729">       var offset = editor.selection.anchorOffset;</span>
<a href="#l3.1730"></a><span id="l3.1730">       // Note: If collapsed, offset points to element AFTER caret,</span>
<a href="#l3.1731"></a><span id="l3.1731">       //  thus node may be null</span>
<a href="#l3.1732"></a><span id="l3.1732">       node = anchorNode.childNodes.item(offset);</span>
<a href="#l3.1733"></a><span id="l3.1733">     }</span>
<a href="#l3.1734"></a><span id="l3.1734" class="difflineminus">-    if (!node)</span>
<a href="#l3.1735"></a><span id="l3.1735" class="difflineplus">+    if (!node) {</span>
<a href="#l3.1736"></a><span id="l3.1736">       node = anchorNode;</span>
<a href="#l3.1737"></a><span id="l3.1737" class="difflineplus">+    }</span>
<a href="#l3.1738"></a><span id="l3.1738">   } catch (e) {}</span>
<a href="#l3.1739"></a><span id="l3.1739"> </span>
<a href="#l3.1740"></a><span id="l3.1740">   while (node) {</span>
<a href="#l3.1741"></a><span id="l3.1741">     if (node.nodeName) {</span>
<a href="#l3.1742"></a><span id="l3.1742">       var nodeName = node.nodeName.toLowerCase();</span>
<a href="#l3.1743"></a><span id="l3.1743"> </span>
<a href="#l3.1744"></a><span id="l3.1744">       // Done when we hit the body or #text.</span>
<a href="#l3.1745"></a><span id="l3.1745">       if (nodeName == &quot;body&quot; || nodeName == &quot;#text&quot;) {</span>
<a href="#l3.1746"></a><span id="l3.1746">         break;</span>
<a href="#l3.1747"></a><span id="l3.1747">       }</span>
<a href="#l3.1748"></a><span id="l3.1748"> </span>
<a href="#l3.1749"></a><span id="l3.1749" class="difflineminus">-      if ((nodeName == &quot;a&quot; &amp;&amp; node.href) ||</span>
<a href="#l3.1750"></a><span id="l3.1750" class="difflineminus">-          nodeName == &quot;ol&quot; || nodeName == &quot;ul&quot; || nodeName == &quot;dl&quot; ||</span>
<a href="#l3.1751"></a><span id="l3.1751" class="difflineminus">-          nodeName == &quot;td&quot; || nodeName == &quot;th&quot; ||</span>
<a href="#l3.1752"></a><span id="l3.1752" class="difflineminus">-          nodeName == &quot;table&quot; || nodeName == &quot;math&quot;) {</span>
<a href="#l3.1753"></a><span id="l3.1753" class="difflineplus">+      if (</span>
<a href="#l3.1754"></a><span id="l3.1754" class="difflineplus">+        (nodeName == &quot;a&quot; &amp;&amp; node.href) ||</span>
<a href="#l3.1755"></a><span id="l3.1755" class="difflineplus">+        nodeName == &quot;ol&quot; ||</span>
<a href="#l3.1756"></a><span id="l3.1756" class="difflineplus">+        nodeName == &quot;ul&quot; ||</span>
<a href="#l3.1757"></a><span id="l3.1757" class="difflineplus">+        nodeName == &quot;dl&quot; ||</span>
<a href="#l3.1758"></a><span id="l3.1758" class="difflineplus">+        nodeName == &quot;td&quot; ||</span>
<a href="#l3.1759"></a><span id="l3.1759" class="difflineplus">+        nodeName == &quot;th&quot; ||</span>
<a href="#l3.1760"></a><span id="l3.1760" class="difflineplus">+        nodeName == &quot;table&quot; ||</span>
<a href="#l3.1761"></a><span id="l3.1761" class="difflineplus">+        nodeName == &quot;math&quot;</span>
<a href="#l3.1762"></a><span id="l3.1762" class="difflineplus">+      ) {</span>
<a href="#l3.1763"></a><span id="l3.1763">         return node;</span>
<a href="#l3.1764"></a><span id="l3.1764">       }</span>
<a href="#l3.1765"></a><span id="l3.1765">     }</span>
<a href="#l3.1766"></a><span id="l3.1766">     node = node.parentNode;</span>
<a href="#l3.1767"></a><span id="l3.1767">   }</span>
<a href="#l3.1768"></a><span id="l3.1768">   return null;</span>
<a href="#l3.1769"></a><span id="l3.1769"> }</span>
<a href="#l3.1770"></a><span id="l3.1770"> </span>
<a href="#l3.1771"></a><span id="l3.1771"> function SetEditMode(mode) {</span>
<a href="#l3.1772"></a><span id="l3.1772" class="difflineminus">-  if (!IsHTMLEditor())</span>
<a href="#l3.1773"></a><span id="l3.1773" class="difflineplus">+  if (!IsHTMLEditor()) {</span>
<a href="#l3.1774"></a><span id="l3.1774">     return;</span>
<a href="#l3.1775"></a><span id="l3.1775" class="difflineplus">+  }</span>
<a href="#l3.1776"></a><span id="l3.1776"> </span>
<a href="#l3.1777"></a><span id="l3.1777">   var bodyElement = GetBodyElement();</span>
<a href="#l3.1778"></a><span id="l3.1778">   if (!bodyElement) {</span>
<a href="#l3.1779"></a><span id="l3.1779">     dump(&quot;SetEditMode: We don't have a body node!\n&quot;);</span>
<a href="#l3.1780"></a><span id="l3.1780">     return;</span>
<a href="#l3.1781"></a><span id="l3.1781">   }</span>
<a href="#l3.1782"></a><span id="l3.1782"> </span>
<a href="#l3.1783"></a><span id="l3.1783">   // must have editor if here!</span>
<a href="#l3.1784"></a><span id="l3.1784">   var editor = GetCurrentEditor();</span>
<a href="#l3.1785"></a><span id="l3.1785">   var inlineSpellCheckItem = document.getElementById(&quot;menu_inlineSpellCheck&quot;);</span>
<a href="#l3.1786"></a><span id="l3.1786"> </span>
<a href="#l3.1787"></a><span id="l3.1787">   // Switch the UI mode before inserting contents</span>
<a href="#l3.1788"></a><span id="l3.1788">   //   so user can't type in source window while new window is being filled</span>
<a href="#l3.1789"></a><span id="l3.1789">   var previousMode = gEditorDisplayMode;</span>
<a href="#l3.1790"></a><span id="l3.1790" class="difflineminus">-  if (!SetDisplayMode(mode))</span>
<a href="#l3.1791"></a><span id="l3.1791" class="difflineplus">+  if (!SetDisplayMode(mode)) {</span>
<a href="#l3.1792"></a><span id="l3.1792">     return;</span>
<a href="#l3.1793"></a><span id="l3.1793" class="difflineplus">+  }</span>
<a href="#l3.1794"></a><span id="l3.1794"> </span>
<a href="#l3.1795"></a><span id="l3.1795">   if (mode == kDisplayModeSource) {</span>
<a href="#l3.1796"></a><span id="l3.1796">     // Display the DOCTYPE as a non-editable string above edit area</span>
<a href="#l3.1797"></a><span id="l3.1797">     var domdoc;</span>
<a href="#l3.1798"></a><span id="l3.1798">     try {</span>
<a href="#l3.1799"></a><span id="l3.1799">       domdoc = editor.document;</span>
<a href="#l3.1800"></a><span id="l3.1800">     } catch (e) {</span>
<a href="#l3.1801"></a><span id="l3.1801">       dump(e + &quot;\n&quot;);</span>
<a href="#l3.1802"></a><span id="l3.1802">     }</span>
<a href="#l3.1803"></a><span id="l3.1803">     if (domdoc) {</span>
<a href="#l3.1804"></a><span id="l3.1804">       var doctypeNode = document.getElementById(&quot;doctype-text&quot;);</span>
<a href="#l3.1805"></a><span id="l3.1805">       var dt = domdoc.doctype;</span>
<a href="#l3.1806"></a><span id="l3.1806">       if (doctypeNode) {</span>
<a href="#l3.1807"></a><span id="l3.1807">         if (dt) {</span>
<a href="#l3.1808"></a><span id="l3.1808">           doctypeNode.collapsed = false;</span>
<a href="#l3.1809"></a><span id="l3.1809">           var doctypeText = &quot;&lt;!DOCTYPE &quot; + domdoc.doctype.name;</span>
<a href="#l3.1810"></a><span id="l3.1810" class="difflineminus">-          if (dt.publicId)</span>
<a href="#l3.1811"></a><span id="l3.1811" class="difflineminus">-            doctypeText += &quot; PUBLIC \&quot;&quot; + domdoc.doctype.publicId;</span>
<a href="#l3.1812"></a><span id="l3.1812" class="difflineminus">-          if (dt.systemId)</span>
<a href="#l3.1813"></a><span id="l3.1813" class="difflineminus">-            doctypeText += &quot; \&quot;&quot; + dt.systemId;</span>
<a href="#l3.1814"></a><span id="l3.1814" class="difflineminus">-          doctypeText += &quot;\&quot;&gt;&quot;;</span>
<a href="#l3.1815"></a><span id="l3.1815" class="difflineplus">+          if (dt.publicId) {</span>
<a href="#l3.1816"></a><span id="l3.1816" class="difflineplus">+            doctypeText += ' PUBLIC &quot;' + domdoc.doctype.publicId;</span>
<a href="#l3.1817"></a><span id="l3.1817" class="difflineplus">+          }</span>
<a href="#l3.1818"></a><span id="l3.1818" class="difflineplus">+          if (dt.systemId) {</span>
<a href="#l3.1819"></a><span id="l3.1819" class="difflineplus">+            doctypeText += ' &quot;' + dt.systemId;</span>
<a href="#l3.1820"></a><span id="l3.1820" class="difflineplus">+          }</span>
<a href="#l3.1821"></a><span id="l3.1821" class="difflineplus">+          doctypeText += '&quot;&gt;';</span>
<a href="#l3.1822"></a><span id="l3.1822">           doctypeNode.setAttribute(&quot;value&quot;, doctypeText);</span>
<a href="#l3.1823"></a><span id="l3.1823">         } else {</span>
<a href="#l3.1824"></a><span id="l3.1824">           doctypeNode.collapsed = true;</span>
<a href="#l3.1825"></a><span id="l3.1825">         }</span>
<a href="#l3.1826"></a><span id="l3.1826">       }</span>
<a href="#l3.1827"></a><span id="l3.1827">     }</span>
<a href="#l3.1828"></a><span id="l3.1828">     // Get the entire document's source string</span>
<a href="#l3.1829"></a><span id="l3.1829"> </span>
<a href="#l3.1830"></a><span id="l3.1830" class="difflineminus">-    var flags = (editor.documentCharacterSet == &quot;ISO-8859-1&quot;)</span>
<a href="#l3.1831"></a><span id="l3.1831" class="difflineminus">-      ? kOutputEncodeLatin1Entities</span>
<a href="#l3.1832"></a><span id="l3.1832" class="difflineminus">-      : kOutputEncodeBasicEntities;</span>
<a href="#l3.1833"></a><span id="l3.1833" class="difflineplus">+    var flags =</span>
<a href="#l3.1834"></a><span id="l3.1834" class="difflineplus">+      editor.documentCharacterSet == &quot;ISO-8859-1&quot;</span>
<a href="#l3.1835"></a><span id="l3.1835" class="difflineplus">+        ? kOutputEncodeLatin1Entities</span>
<a href="#l3.1836"></a><span id="l3.1836" class="difflineplus">+        : kOutputEncodeBasicEntities;</span>
<a href="#l3.1837"></a><span id="l3.1837">     try {</span>
<a href="#l3.1838"></a><span id="l3.1838">       let encodeEntity = Services.prefs.getCharPref(&quot;editor.encode_entity&quot;);</span>
<a href="#l3.1839"></a><span id="l3.1839">       switch (encodeEntity) {</span>
<a href="#l3.1840"></a><span id="l3.1840" class="difflineminus">-        case &quot;basic&quot; : flags = kOutputEncodeBasicEntities; break;</span>
<a href="#l3.1841"></a><span id="l3.1841" class="difflineminus">-        case &quot;latin1&quot; : flags = kOutputEncodeLatin1Entities; break;</span>
<a href="#l3.1842"></a><span id="l3.1842" class="difflineminus">-        case &quot;html&quot; : flags = kOutputEncodeHTMLEntities; break;</span>
<a href="#l3.1843"></a><span id="l3.1843" class="difflineminus">-        case &quot;none&quot; : flags = 0; break;</span>
<a href="#l3.1844"></a><span id="l3.1844" class="difflineplus">+        case &quot;basic&quot;:</span>
<a href="#l3.1845"></a><span id="l3.1845" class="difflineplus">+          flags = kOutputEncodeBasicEntities;</span>
<a href="#l3.1846"></a><span id="l3.1846" class="difflineplus">+          break;</span>
<a href="#l3.1847"></a><span id="l3.1847" class="difflineplus">+        case &quot;latin1&quot;:</span>
<a href="#l3.1848"></a><span id="l3.1848" class="difflineplus">+          flags = kOutputEncodeLatin1Entities;</span>
<a href="#l3.1849"></a><span id="l3.1849" class="difflineplus">+          break;</span>
<a href="#l3.1850"></a><span id="l3.1850" class="difflineplus">+        case &quot;html&quot;:</span>
<a href="#l3.1851"></a><span id="l3.1851" class="difflineplus">+          flags = kOutputEncodeHTMLEntities;</span>
<a href="#l3.1852"></a><span id="l3.1852" class="difflineplus">+          break;</span>
<a href="#l3.1853"></a><span id="l3.1853" class="difflineplus">+        case &quot;none&quot;:</span>
<a href="#l3.1854"></a><span id="l3.1854" class="difflineplus">+          flags = 0;</span>
<a href="#l3.1855"></a><span id="l3.1855" class="difflineplus">+          break;</span>
<a href="#l3.1856"></a><span id="l3.1856">       }</span>
<a href="#l3.1857"></a><span id="l3.1857">     } catch (e) {}</span>
<a href="#l3.1858"></a><span id="l3.1858"> </span>
<a href="#l3.1859"></a><span id="l3.1859" class="difflineminus">-    if (Services.prefs.getBoolPref(&quot;editor.prettyprint&quot;))</span>
<a href="#l3.1860"></a><span id="l3.1860" class="difflineplus">+    if (Services.prefs.getBoolPref(&quot;editor.prettyprint&quot;)) {</span>
<a href="#l3.1861"></a><span id="l3.1861">       flags |= kOutputFormatted;</span>
<a href="#l3.1862"></a><span id="l3.1862" class="difflineplus">+    }</span>
<a href="#l3.1863"></a><span id="l3.1863"> </span>
<a href="#l3.1864"></a><span id="l3.1864">     flags |= kOutputLFLineBreak;</span>
<a href="#l3.1865"></a><span id="l3.1865">     var source = editor.outputToString(editor.contentsMIMEType, flags);</span>
<a href="#l3.1866"></a><span id="l3.1866">     var start = source.search(/&lt;html/i);</span>
<a href="#l3.1867"></a><span id="l3.1867" class="difflineminus">-    if (start == -1) start = 0;</span>
<a href="#l3.1868"></a><span id="l3.1868" class="difflineplus">+    if (start == -1) {</span>
<a href="#l3.1869"></a><span id="l3.1869" class="difflineplus">+      start = 0;</span>
<a href="#l3.1870"></a><span id="l3.1870" class="difflineplus">+    }</span>
<a href="#l3.1871"></a><span id="l3.1871">     gSourceTextEditor.insertText(source.slice(start));</span>
<a href="#l3.1872"></a><span id="l3.1872">     gSourceTextEditor.resetModificationCount();</span>
<a href="#l3.1873"></a><span id="l3.1873">     gSourceTextEditor.addDocumentStateListener(gSourceTextListener);</span>
<a href="#l3.1874"></a><span id="l3.1874">     gSourceTextEditor.enableUndo(true);</span>
<a href="#l3.1875"></a><span id="l3.1875" class="difflineminus">-    gSourceContentWindow.commandManager.addCommandObserver(gSourceTextObserver, &quot;cmd_undo&quot;);</span>
<a href="#l3.1876"></a><span id="l3.1876" class="difflineplus">+    gSourceContentWindow.commandManager.addCommandObserver(</span>
<a href="#l3.1877"></a><span id="l3.1877" class="difflineplus">+      gSourceTextObserver,</span>
<a href="#l3.1878"></a><span id="l3.1878" class="difflineplus">+      &quot;cmd_undo&quot;</span>
<a href="#l3.1879"></a><span id="l3.1879" class="difflineplus">+    );</span>
<a href="#l3.1880"></a><span id="l3.1880">     gSourceContentWindow.contentWindow.focus();</span>
<a href="#l3.1881"></a><span id="l3.1881">     goDoCommand(&quot;cmd_moveTop&quot;);</span>
<a href="#l3.1882"></a><span id="l3.1882">   } else if (previousMode == kDisplayModeSource) {</span>
<a href="#l3.1883"></a><span id="l3.1883">     // Only rebuild document if a change was made in source window</span>
<a href="#l3.1884"></a><span id="l3.1884">     if (IsHTMLSourceChanged()) {</span>
<a href="#l3.1885"></a><span id="l3.1885">       // Disable spell checking when rebuilding source</span>
<a href="#l3.1886"></a><span id="l3.1886">       InlineSpellCheckerUI.enabled = false;</span>
<a href="#l3.1887"></a><span id="l3.1887">       inlineSpellCheckItem.removeAttribute(&quot;checked&quot;);</span>
<a href="#l3.1888"></a><span id="l3.1888" class="difflineat">@@ -1631,25 +1905,32 @@ function SetEditMode(mode) {</span>
<a href="#l3.1889"></a><span id="l3.1889">       try {</span>
<a href="#l3.1890"></a><span id="l3.1890">         editor.transactionManager.maxTransactionCount = 1;</span>
<a href="#l3.1891"></a><span id="l3.1891">       } catch (e) {}</span>
<a href="#l3.1892"></a><span id="l3.1892"> </span>
<a href="#l3.1893"></a><span id="l3.1893">       editor.beginTransaction();</span>
<a href="#l3.1894"></a><span id="l3.1894">       try {</span>
<a href="#l3.1895"></a><span id="l3.1895">         // We are coming from edit source mode,</span>
<a href="#l3.1896"></a><span id="l3.1896">         //   so transfer that back into the document</span>
<a href="#l3.1897"></a><span id="l3.1897" class="difflineminus">-        source = gSourceTextEditor.outputToString(kTextMimeType, kOutputLFLineBreak).trim();</span>
<a href="#l3.1898"></a><span id="l3.1898" class="difflineplus">+        source = gSourceTextEditor</span>
<a href="#l3.1899"></a><span id="l3.1899" class="difflineplus">+          .outputToString(kTextMimeType, kOutputLFLineBreak)</span>
<a href="#l3.1900"></a><span id="l3.1900" class="difflineplus">+          .trim();</span>
<a href="#l3.1901"></a><span id="l3.1901">         if (editor.contentsMIMEType != kXHTMLMimeType) {</span>
<a href="#l3.1902"></a><span id="l3.1902">           editor.rebuildDocumentFromSource(source);</span>
<a href="#l3.1903"></a><span id="l3.1903">         } else {</span>
<a href="#l3.1904"></a><span id="l3.1904">           /* eslint-disable-next-line no-unsanitized/method */</span>
<a href="#l3.1905"></a><span id="l3.1905" class="difflineminus">-          var fragment = editor.document.createRange().createContextualFragment(source);</span>
<a href="#l3.1906"></a><span id="l3.1906" class="difflineplus">+          var fragment = editor.document</span>
<a href="#l3.1907"></a><span id="l3.1907" class="difflineplus">+            .createRange()</span>
<a href="#l3.1908"></a><span id="l3.1908" class="difflineplus">+            .createContextualFragment(source);</span>
<a href="#l3.1909"></a><span id="l3.1909">           editor.enableUndo(false);</span>
<a href="#l3.1910"></a><span id="l3.1910">           GetBodyElement().remove();</span>
<a href="#l3.1911"></a><span id="l3.1911" class="difflineminus">-          editor.document.replaceChild(fragment.firstChild, editor.document.documentElement);</span>
<a href="#l3.1912"></a><span id="l3.1912" class="difflineplus">+          editor.document.replaceChild(</span>
<a href="#l3.1913"></a><span id="l3.1913" class="difflineplus">+            fragment.firstChild,</span>
<a href="#l3.1914"></a><span id="l3.1914" class="difflineplus">+            editor.document.documentElement</span>
<a href="#l3.1915"></a><span id="l3.1915" class="difflineplus">+          );</span>
<a href="#l3.1916"></a><span id="l3.1916">           editor.enableUndo(true);</span>
<a href="#l3.1917"></a><span id="l3.1917">         }</span>
<a href="#l3.1918"></a><span id="l3.1918"> </span>
<a href="#l3.1919"></a><span id="l3.1919">         // Get the text for the &lt;title&gt; from the newly-parsed document</span>
<a href="#l3.1920"></a><span id="l3.1920">         // (must do this for proper conversion of &quot;escaped&quot; characters)</span>
<a href="#l3.1921"></a><span id="l3.1921">         let titleNode = editor.document.querySelector(&quot;title&quot;);</span>
<a href="#l3.1922"></a><span id="l3.1922">         SetDocumentTitle(titleNode ? titleNode.textContent : &quot;&quot;);</span>
<a href="#l3.1923"></a><span id="l3.1923">       } catch (ex) {</span>
<a href="#l3.1924"></a><span id="l3.1924" class="difflineat">@@ -1659,57 +1940,67 @@ function SetEditMode(mode) {</span>
<a href="#l3.1925"></a><span id="l3.1925"> </span>
<a href="#l3.1926"></a><span id="l3.1926">       // Restore unlimited undo count</span>
<a href="#l3.1927"></a><span id="l3.1927">       try {</span>
<a href="#l3.1928"></a><span id="l3.1928">         editor.transactionManager.maxTransactionCount = -1;</span>
<a href="#l3.1929"></a><span id="l3.1929">       } catch (e) {}</span>
<a href="#l3.1930"></a><span id="l3.1930">     }</span>
<a href="#l3.1931"></a><span id="l3.1931"> </span>
<a href="#l3.1932"></a><span id="l3.1932">     // Clear out the string buffers</span>
<a href="#l3.1933"></a><span id="l3.1933" class="difflineminus">-    gSourceContentWindow.commandManager.removeCommandObserver(gSourceTextObserver, &quot;cmd_undo&quot;);</span>
<a href="#l3.1934"></a><span id="l3.1934" class="difflineplus">+    gSourceContentWindow.commandManager.removeCommandObserver(</span>
<a href="#l3.1935"></a><span id="l3.1935" class="difflineplus">+      gSourceTextObserver,</span>
<a href="#l3.1936"></a><span id="l3.1936" class="difflineplus">+      &quot;cmd_undo&quot;</span>
<a href="#l3.1937"></a><span id="l3.1937" class="difflineplus">+    );</span>
<a href="#l3.1938"></a><span id="l3.1938">     gSourceTextEditor.removeDocumentStateListener(gSourceTextListener);</span>
<a href="#l3.1939"></a><span id="l3.1939">     gSourceTextEditor.enableUndo(false);</span>
<a href="#l3.1940"></a><span id="l3.1940">     gSourceTextEditor.selectAll();</span>
<a href="#l3.1941"></a><span id="l3.1941" class="difflineminus">-    gSourceTextEditor.deleteSelection(gSourceTextEditor.eNone,</span>
<a href="#l3.1942"></a><span id="l3.1942" class="difflineminus">-                                      gSourceTextEditor.eStrip);</span>
<a href="#l3.1943"></a><span id="l3.1943" class="difflineplus">+    gSourceTextEditor.deleteSelection(</span>
<a href="#l3.1944"></a><span id="l3.1944" class="difflineplus">+      gSourceTextEditor.eNone,</span>
<a href="#l3.1945"></a><span id="l3.1945" class="difflineplus">+      gSourceTextEditor.eStrip</span>
<a href="#l3.1946"></a><span id="l3.1946" class="difflineplus">+    );</span>
<a href="#l3.1947"></a><span id="l3.1947">     gSourceTextEditor.resetModificationCount();</span>
<a href="#l3.1948"></a><span id="l3.1948"> </span>
<a href="#l3.1949"></a><span id="l3.1949">     gContentWindow.focus();</span>
<a href="#l3.1950"></a><span id="l3.1950">     // goDoCommand(&quot;cmd_moveTop&quot;);</span>
<a href="#l3.1951"></a><span id="l3.1951">   }</span>
<a href="#l3.1952"></a><span id="l3.1952"> </span>
<a href="#l3.1953"></a><span id="l3.1953">   switch (mode) {</span>
<a href="#l3.1954"></a><span id="l3.1954">     case kDisplayModePreview:</span>
<a href="#l3.1955"></a><span id="l3.1955">       // Disable spell checking when previewing</span>
<a href="#l3.1956"></a><span id="l3.1956">       InlineSpellCheckerUI.enabled = false;</span>
<a href="#l3.1957"></a><span id="l3.1957">       inlineSpellCheckItem.removeAttribute(&quot;checked&quot;);</span>
<a href="#l3.1958"></a><span id="l3.1958" class="difflineminus">-      // fall through</span>
<a href="#l3.1959"></a><span id="l3.1959" class="difflineplus">+    // fall through</span>
<a href="#l3.1960"></a><span id="l3.1960">     case kDisplayModeSource:</span>
<a href="#l3.1961"></a><span id="l3.1961">       inlineSpellCheckItem.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l3.1962"></a><span id="l3.1962">       break;</span>
<a href="#l3.1963"></a><span id="l3.1963">     default:</span>
<a href="#l3.1964"></a><span id="l3.1964" class="difflineminus">-      inlineSpellCheckItem.setAttribute(&quot;disabled&quot;, !InlineSpellCheckerUI.canSpellCheck);</span>
<a href="#l3.1965"></a><span id="l3.1965" class="difflineplus">+      inlineSpellCheckItem.setAttribute(</span>
<a href="#l3.1966"></a><span id="l3.1966" class="difflineplus">+        &quot;disabled&quot;,</span>
<a href="#l3.1967"></a><span id="l3.1967" class="difflineplus">+        !InlineSpellCheckerUI.canSpellCheck</span>
<a href="#l3.1968"></a><span id="l3.1968" class="difflineplus">+      );</span>
<a href="#l3.1969"></a><span id="l3.1969">       break;</span>
<a href="#l3.1970"></a><span id="l3.1970">   }</span>
<a href="#l3.1971"></a><span id="l3.1971"> }</span>
<a href="#l3.1972"></a><span id="l3.1972"> </span>
<a href="#l3.1973"></a><span id="l3.1973"> function CancelHTMLSource() {</span>
<a href="#l3.1974"></a><span id="l3.1974">   // Don't convert source text back into the DOM document</span>
<a href="#l3.1975"></a><span id="l3.1975">   gSourceTextEditor.resetModificationCount();</span>
<a href="#l3.1976"></a><span id="l3.1976">   SetDisplayMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l3.1977"></a><span id="l3.1977"> }</span>
<a href="#l3.1978"></a><span id="l3.1978"> </span>
<a href="#l3.1979"></a><span id="l3.1979"> function SetDisplayMode(mode) {</span>
<a href="#l3.1980"></a><span id="l3.1980" class="difflineminus">-  if (!IsHTMLEditor())</span>
<a href="#l3.1981"></a><span id="l3.1981" class="difflineplus">+  if (!IsHTMLEditor()) {</span>
<a href="#l3.1982"></a><span id="l3.1982">     return false;</span>
<a href="#l3.1983"></a><span id="l3.1983" class="difflineplus">+  }</span>
<a href="#l3.1984"></a><span id="l3.1984"> </span>
<a href="#l3.1985"></a><span id="l3.1985">   // Already in requested mode:</span>
<a href="#l3.1986"></a><span id="l3.1986">   //  return false to indicate we didn't switch</span>
<a href="#l3.1987"></a><span id="l3.1987" class="difflineminus">-  if (mode == gEditorDisplayMode)</span>
<a href="#l3.1988"></a><span id="l3.1988" class="difflineplus">+  if (mode == gEditorDisplayMode) {</span>
<a href="#l3.1989"></a><span id="l3.1989">     return false;</span>
<a href="#l3.1990"></a><span id="l3.1990" class="difflineplus">+  }</span>
<a href="#l3.1991"></a><span id="l3.1991"> </span>
<a href="#l3.1992"></a><span id="l3.1992">   var previousMode = gEditorDisplayMode;</span>
<a href="#l3.1993"></a><span id="l3.1993">   gEditorDisplayMode = mode;</span>
<a href="#l3.1994"></a><span id="l3.1994"> </span>
<a href="#l3.1995"></a><span id="l3.1995">   ResetStructToolbar();</span>
<a href="#l3.1996"></a><span id="l3.1996">   if (mode == kDisplayModeSource) {</span>
<a href="#l3.1997"></a><span id="l3.1997">     // Switch to the sourceWindow (second in the deck)</span>
<a href="#l3.1998"></a><span id="l3.1998">     gContentWindowDeck.selectedIndex = 1;</span>
<a href="#l3.1999"></a><span id="l3.1999" class="difflineat">@@ -1768,53 +2059,61 @@ function SetDisplayMode(mode) {</span>
<a href="#l3.2000"></a><span id="l3.2000">     gContentWindow.focus();</span>
<a href="#l3.2001"></a><span id="l3.2001">   }</span>
<a href="#l3.2002"></a><span id="l3.2002"> </span>
<a href="#l3.2003"></a><span id="l3.2003">   // update commands to disable or re-enable stuff</span>
<a href="#l3.2004"></a><span id="l3.2004">   window.updateCommands(&quot;mode_switch&quot;);</span>
<a href="#l3.2005"></a><span id="l3.2005"> </span>
<a href="#l3.2006"></a><span id="l3.2006">   // Set the selected tab at bottom of window:</span>
<a href="#l3.2007"></a><span id="l3.2007">   // (Note: Setting &quot;selectedIndex = mode&quot; won't redraw tabs when menu is used.)</span>
<a href="#l3.2008"></a><span id="l3.2008" class="difflineminus">-  document.getElementById(&quot;EditModeTabs&quot;).selectedItem = document.getElementById(kDisplayModeTabIDS[mode]);</span>
<a href="#l3.2009"></a><span id="l3.2009" class="difflineplus">+  document.getElementById(</span>
<a href="#l3.2010"></a><span id="l3.2010" class="difflineplus">+    &quot;EditModeTabs&quot;</span>
<a href="#l3.2011"></a><span id="l3.2011" class="difflineplus">+  ).selectedItem = document.getElementById(kDisplayModeTabIDS[mode]);</span>
<a href="#l3.2012"></a><span id="l3.2012"> </span>
<a href="#l3.2013"></a><span id="l3.2013">   // Uncheck previous menuitem and set new check since toolbar may have been used</span>
<a href="#l3.2014"></a><span id="l3.2014" class="difflineminus">-  if (previousMode &gt;= 0)</span>
<a href="#l3.2015"></a><span id="l3.2015" class="difflineminus">-    document.getElementById(kDisplayModeMenuIDs[previousMode]).setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l3.2016"></a><span id="l3.2016" class="difflineminus">-  document.getElementById(kDisplayModeMenuIDs[mode]).setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l3.2017"></a><span id="l3.2017" class="difflineminus">-</span>
<a href="#l3.2018"></a><span id="l3.2018" class="difflineplus">+  if (previousMode &gt;= 0) {</span>
<a href="#l3.2019"></a><span id="l3.2019" class="difflineplus">+    document</span>
<a href="#l3.2020"></a><span id="l3.2020" class="difflineplus">+      .getElementById(kDisplayModeMenuIDs[previousMode])</span>
<a href="#l3.2021"></a><span id="l3.2021" class="difflineplus">+      .setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l3.2022"></a><span id="l3.2022" class="difflineplus">+  }</span>
<a href="#l3.2023"></a><span id="l3.2023" class="difflineplus">+  document</span>
<a href="#l3.2024"></a><span id="l3.2024" class="difflineplus">+    .getElementById(kDisplayModeMenuIDs[mode])</span>
<a href="#l3.2025"></a><span id="l3.2025" class="difflineplus">+    .setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l3.2026"></a><span id="l3.2026"> </span>
<a href="#l3.2027"></a><span id="l3.2027">   return true;</span>
<a href="#l3.2028"></a><span id="l3.2028"> }</span>
<a href="#l3.2029"></a><span id="l3.2029"> </span>
<a href="#l3.2030"></a><span id="l3.2030"> function UpdateWindowTitle() {</span>
<a href="#l3.2031"></a><span id="l3.2031">   try {</span>
<a href="#l3.2032"></a><span id="l3.2032">     var filename = &quot;&quot;;</span>
<a href="#l3.2033"></a><span id="l3.2033">     var windowTitle = &quot;&quot;;</span>
<a href="#l3.2034"></a><span id="l3.2034">     var title = GetDocumentTitle();</span>
<a href="#l3.2035"></a><span id="l3.2035"> </span>
<a href="#l3.2036"></a><span id="l3.2036">     // Append just the 'leaf' filename to the Doc. Title for the window caption</span>
<a href="#l3.2037"></a><span id="l3.2037">     var docUrl = GetDocumentUrl();</span>
<a href="#l3.2038"></a><span id="l3.2038">     if (docUrl &amp;&amp; !IsUrlAboutBlank(docUrl)) {</span>
<a href="#l3.2039"></a><span id="l3.2039">       var scheme = GetScheme(docUrl);</span>
<a href="#l3.2040"></a><span id="l3.2040">       filename = GetFilename(docUrl);</span>
<a href="#l3.2041"></a><span id="l3.2041" class="difflineminus">-      if (filename)</span>
<a href="#l3.2042"></a><span id="l3.2042" class="difflineplus">+      if (filename) {</span>
<a href="#l3.2043"></a><span id="l3.2043">         windowTitle = &quot; [&quot; + scheme + &quot;:/.../&quot; + filename + &quot;]&quot;;</span>
<a href="#l3.2044"></a><span id="l3.2044" class="difflineplus">+      }</span>
<a href="#l3.2045"></a><span id="l3.2045"> </span>
<a href="#l3.2046"></a><span id="l3.2046">       var fileType = IsHTMLEditor() ? &quot;html&quot; : &quot;text&quot;;</span>
<a href="#l3.2047"></a><span id="l3.2047">       // Save changed title in the recent pages data in prefs</span>
<a href="#l3.2048"></a><span id="l3.2048">       SaveRecentFilesPrefs(title, fileType);</span>
<a href="#l3.2049"></a><span id="l3.2049">     }</span>
<a href="#l3.2050"></a><span id="l3.2050"> </span>
<a href="#l3.2051"></a><span id="l3.2051">     // Set window title with &quot; - Composer&quot; or &quot; - Text Editor&quot; appended.</span>
<a href="#l3.2052"></a><span id="l3.2052">     var xulWin = document.documentElement;</span>
<a href="#l3.2053"></a><span id="l3.2053"> </span>
<a href="#l3.2054"></a><span id="l3.2054" class="difflineminus">-    document.title = (title || filename || window.gUntitledString) +</span>
<a href="#l3.2055"></a><span id="l3.2055" class="difflineminus">-                     windowTitle +</span>
<a href="#l3.2056"></a><span id="l3.2056" class="difflineminus">-                     xulWin.getAttribute(&quot;titlemenuseparator&quot;) +</span>
<a href="#l3.2057"></a><span id="l3.2057" class="difflineminus">-                     xulWin.getAttribute(&quot;titlemodifier&quot;);</span>
<a href="#l3.2058"></a><span id="l3.2058" class="difflineplus">+    document.title =</span>
<a href="#l3.2059"></a><span id="l3.2059" class="difflineplus">+      (title || filename || window.gUntitledString) +</span>
<a href="#l3.2060"></a><span id="l3.2060" class="difflineplus">+      windowTitle +</span>
<a href="#l3.2061"></a><span id="l3.2061" class="difflineplus">+      xulWin.getAttribute(&quot;titlemenuseparator&quot;) +</span>
<a href="#l3.2062"></a><span id="l3.2062" class="difflineplus">+      xulWin.getAttribute(&quot;titlemodifier&quot;);</span>
<a href="#l3.2063"></a><span id="l3.2063">   } catch (e) {</span>
<a href="#l3.2064"></a><span id="l3.2064">     dump(e);</span>
<a href="#l3.2065"></a><span id="l3.2065">   }</span>
<a href="#l3.2066"></a><span id="l3.2066"> }</span>
<a href="#l3.2067"></a><span id="l3.2067"> </span>
<a href="#l3.2068"></a><span id="l3.2068"> function SaveRecentFilesPrefs(aTitle, aFileType) {</span>
<a href="#l3.2069"></a><span id="l3.2069">   var curUrl = StripPassword(GetDocumentUrl());</span>
<a href="#l3.2070"></a><span id="l3.2070">   var historyCount = Services.prefs.getIntPref(&quot;editor.history.url_maximum&quot;);</span>
<a href="#l3.2071"></a><span id="l3.2071" class="difflineat">@@ -1833,17 +2132,20 @@ function SaveRecentFilesPrefs(aTitle, aF</span>
<a href="#l3.2072"></a><span id="l3.2072">     let url = Services.prefs.getStringPref(&quot;editor.history_url_&quot; + i, &quot;&quot;);</span>
<a href="#l3.2073"></a><span id="l3.2073"> </span>
<a href="#l3.2074"></a><span id="l3.2074">     // Continue if URL pref is missing because</span>
<a href="#l3.2075"></a><span id="l3.2075">     //  a URL not found during loading may have been removed</span>
<a href="#l3.2076"></a><span id="l3.2076"> </span>
<a href="#l3.2077"></a><span id="l3.2077">     // Skip over current an &quot;data&quot; URLs</span>
<a href="#l3.2078"></a><span id="l3.2078">     if (url &amp;&amp; url != curUrl &amp;&amp; GetScheme(url) != &quot;data&quot;) {</span>
<a href="#l3.2079"></a><span id="l3.2079">       let title = Services.prefs.getStringPref(&quot;editor.history_title_&quot; + i, &quot;&quot;);</span>
<a href="#l3.2080"></a><span id="l3.2080" class="difflineminus">-      let fileType = Services.prefs.getStringPref(&quot;editor.history_type_&quot; + i, &quot;&quot;);</span>
<a href="#l3.2081"></a><span id="l3.2081" class="difflineplus">+      let fileType = Services.prefs.getStringPref(</span>
<a href="#l3.2082"></a><span id="l3.2082" class="difflineplus">+        &quot;editor.history_type_&quot; + i,</span>
<a href="#l3.2083"></a><span id="l3.2083" class="difflineplus">+        &quot;&quot;</span>
<a href="#l3.2084"></a><span id="l3.2084" class="difflineplus">+      );</span>
<a href="#l3.2085"></a><span id="l3.2085">       titleArray.push(title);</span>
<a href="#l3.2086"></a><span id="l3.2086">       urlArray.push(url);</span>
<a href="#l3.2087"></a><span id="l3.2087">       typeArray.push(fileType);</span>
<a href="#l3.2088"></a><span id="l3.2088">     }</span>
<a href="#l3.2089"></a><span id="l3.2089">   }</span>
<a href="#l3.2090"></a><span id="l3.2090"> </span>
<a href="#l3.2091"></a><span id="l3.2091">   // Resave the list back to prefs in the new order</span>
<a href="#l3.2092"></a><span id="l3.2092">   for (let i = 0; i &lt; urlArray.length; i++) {</span>
<a href="#l3.2093"></a><span id="l3.2093" class="difflineat">@@ -1851,34 +2153,40 @@ function SaveRecentFilesPrefs(aTitle, aF</span>
<a href="#l3.2094"></a><span id="l3.2094">     SetStringPref(&quot;editor.history_url_&quot; + i, urlArray[i]);</span>
<a href="#l3.2095"></a><span id="l3.2095">     SetStringPref(&quot;editor.history_type_&quot; + i, typeArray[i]);</span>
<a href="#l3.2096"></a><span id="l3.2096">   }</span>
<a href="#l3.2097"></a><span id="l3.2097"> }</span>
<a href="#l3.2098"></a><span id="l3.2098"> </span>
<a href="#l3.2099"></a><span id="l3.2099"> function EditorInitFormatMenu() {</span>
<a href="#l3.2100"></a><span id="l3.2100">   try {</span>
<a href="#l3.2101"></a><span id="l3.2101">     InitObjectPropertiesMenuitem();</span>
<a href="#l3.2102"></a><span id="l3.2102" class="difflineminus">-    InitRemoveStylesMenuitems(&quot;removeStylesMenuitem&quot;, &quot;removeLinksMenuitem&quot;, &quot;removeNamedAnchorsMenuitem&quot;);</span>
<a href="#l3.2103"></a><span id="l3.2103" class="difflineplus">+    InitRemoveStylesMenuitems(</span>
<a href="#l3.2104"></a><span id="l3.2104" class="difflineplus">+      &quot;removeStylesMenuitem&quot;,</span>
<a href="#l3.2105"></a><span id="l3.2105" class="difflineplus">+      &quot;removeLinksMenuitem&quot;,</span>
<a href="#l3.2106"></a><span id="l3.2106" class="difflineplus">+      &quot;removeNamedAnchorsMenuitem&quot;</span>
<a href="#l3.2107"></a><span id="l3.2107" class="difflineplus">+    );</span>
<a href="#l3.2108"></a><span id="l3.2108">   } catch (ex) {}</span>
<a href="#l3.2109"></a><span id="l3.2109"> }</span>
<a href="#l3.2110"></a><span id="l3.2110"> </span>
<a href="#l3.2111"></a><span id="l3.2111"> function InitObjectPropertiesMenuitem() {</span>
<a href="#l3.2112"></a><span id="l3.2112">   // Set strings and enable for the [Object] Properties item</span>
<a href="#l3.2113"></a><span id="l3.2113">   // Note that we directly do the enabling instead of</span>
<a href="#l3.2114"></a><span id="l3.2114">   // using goSetCommandEnabled since we already have the command.</span>
<a href="#l3.2115"></a><span id="l3.2115">   var cmd = document.getElementById(&quot;cmd_objectProperties&quot;);</span>
<a href="#l3.2116"></a><span id="l3.2116" class="difflineminus">-  if (!cmd)</span>
<a href="#l3.2117"></a><span id="l3.2117" class="difflineplus">+  if (!cmd) {</span>
<a href="#l3.2118"></a><span id="l3.2118">     return null;</span>
<a href="#l3.2119"></a><span id="l3.2119" class="difflineplus">+  }</span>
<a href="#l3.2120"></a><span id="l3.2120"> </span>
<a href="#l3.2121"></a><span id="l3.2121">   var element;</span>
<a href="#l3.2122"></a><span id="l3.2122">   var menuStr = GetString(&quot;AdvancedProperties&quot;);</span>
<a href="#l3.2123"></a><span id="l3.2123">   var name;</span>
<a href="#l3.2124"></a><span id="l3.2124"> </span>
<a href="#l3.2125"></a><span id="l3.2125" class="difflineminus">-  if (IsEditingRenderedHTML())</span>
<a href="#l3.2126"></a><span id="l3.2126" class="difflineplus">+  if (IsEditingRenderedHTML()) {</span>
<a href="#l3.2127"></a><span id="l3.2127">     element = GetObjectForProperties();</span>
<a href="#l3.2128"></a><span id="l3.2128" class="difflineplus">+  }</span>
<a href="#l3.2129"></a><span id="l3.2129"> </span>
<a href="#l3.2130"></a><span id="l3.2130">   if (element &amp;&amp; element.nodeName) {</span>
<a href="#l3.2131"></a><span id="l3.2131">     var objStr = &quot;&quot;;</span>
<a href="#l3.2132"></a><span id="l3.2132">     cmd.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l3.2133"></a><span id="l3.2133">     name = element.nodeName.toLowerCase();</span>
<a href="#l3.2134"></a><span id="l3.2134">     switch (name) {</span>
<a href="#l3.2135"></a><span id="l3.2135">       case &quot;img&quot;:</span>
<a href="#l3.2136"></a><span id="l3.2136">         // Check if img is enclosed in link</span>
<a href="#l3.2137"></a><span id="l3.2137" class="difflineat">@@ -1886,48 +2194,50 @@ function InitObjectPropertiesMenuitem() </span>
<a href="#l3.2138"></a><span id="l3.2138">         try {</span>
<a href="#l3.2139"></a><span id="l3.2139">           if (GetCurrentEditor().getElementOrParentByTagName(&quot;href&quot;, element)) {</span>
<a href="#l3.2140"></a><span id="l3.2140">             objStr = GetString(&quot;ImageAndLink&quot;);</span>
<a href="#l3.2141"></a><span id="l3.2141">             // Return &quot;href&quot; so it is detected as a link.</span>
<a href="#l3.2142"></a><span id="l3.2142">             name = &quot;href&quot;;</span>
<a href="#l3.2143"></a><span id="l3.2143">           }</span>
<a href="#l3.2144"></a><span id="l3.2144">         } catch (e) {}</span>
<a href="#l3.2145"></a><span id="l3.2145"> </span>
<a href="#l3.2146"></a><span id="l3.2146" class="difflineminus">-        if (objStr == &quot;&quot;)</span>
<a href="#l3.2147"></a><span id="l3.2147" class="difflineplus">+        if (objStr == &quot;&quot;) {</span>
<a href="#l3.2148"></a><span id="l3.2148">           objStr = GetString(&quot;Image&quot;);</span>
<a href="#l3.2149"></a><span id="l3.2149" class="difflineplus">+        }</span>
<a href="#l3.2150"></a><span id="l3.2150">         break;</span>
<a href="#l3.2151"></a><span id="l3.2151">       case &quot;hr&quot;:</span>
<a href="#l3.2152"></a><span id="l3.2152">         objStr = GetString(&quot;HLine&quot;);</span>
<a href="#l3.2153"></a><span id="l3.2153">         break;</span>
<a href="#l3.2154"></a><span id="l3.2154">       case &quot;table&quot;:</span>
<a href="#l3.2155"></a><span id="l3.2155">         objStr = GetString(&quot;Table&quot;);</span>
<a href="#l3.2156"></a><span id="l3.2156">         break;</span>
<a href="#l3.2157"></a><span id="l3.2157">       case &quot;th&quot;:</span>
<a href="#l3.2158"></a><span id="l3.2158">         name = &quot;td&quot;;</span>
<a href="#l3.2159"></a><span id="l3.2159" class="difflineminus">-        // Falls through</span>
<a href="#l3.2160"></a><span id="l3.2160" class="difflineplus">+      // Falls through</span>
<a href="#l3.2161"></a><span id="l3.2161">       case &quot;td&quot;:</span>
<a href="#l3.2162"></a><span id="l3.2162">         objStr = GetString(&quot;TableCell&quot;);</span>
<a href="#l3.2163"></a><span id="l3.2163">         break;</span>
<a href="#l3.2164"></a><span id="l3.2164">       case &quot;ol&quot;:</span>
<a href="#l3.2165"></a><span id="l3.2165">       case &quot;ul&quot;:</span>
<a href="#l3.2166"></a><span id="l3.2166">       case &quot;dl&quot;:</span>
<a href="#l3.2167"></a><span id="l3.2167">         objStr = GetString(&quot;List&quot;);</span>
<a href="#l3.2168"></a><span id="l3.2168">         break;</span>
<a href="#l3.2169"></a><span id="l3.2169">       case &quot;li&quot;:</span>
<a href="#l3.2170"></a><span id="l3.2170">         objStr = GetString(&quot;ListItem&quot;);</span>
<a href="#l3.2171"></a><span id="l3.2171">         break;</span>
<a href="#l3.2172"></a><span id="l3.2172">       case &quot;form&quot;:</span>
<a href="#l3.2173"></a><span id="l3.2173">         objStr = GetString(&quot;Form&quot;);</span>
<a href="#l3.2174"></a><span id="l3.2174">         break;</span>
<a href="#l3.2175"></a><span id="l3.2175">       case &quot;input&quot;:</span>
<a href="#l3.2176"></a><span id="l3.2176">         var type = element.getAttribute(&quot;type&quot;);</span>
<a href="#l3.2177"></a><span id="l3.2177" class="difflineminus">-        if (type &amp;&amp; type.toLowerCase() == &quot;image&quot;)</span>
<a href="#l3.2178"></a><span id="l3.2178" class="difflineplus">+        if (type &amp;&amp; type.toLowerCase() == &quot;image&quot;) {</span>
<a href="#l3.2179"></a><span id="l3.2179">           objStr = GetString(&quot;InputImage&quot;);</span>
<a href="#l3.2180"></a><span id="l3.2180" class="difflineminus">-        else</span>
<a href="#l3.2181"></a><span id="l3.2181" class="difflineplus">+        } else {</span>
<a href="#l3.2182"></a><span id="l3.2182">           objStr = GetString(&quot;InputTag&quot;);</span>
<a href="#l3.2183"></a><span id="l3.2183" class="difflineplus">+        }</span>
<a href="#l3.2184"></a><span id="l3.2184">         break;</span>
<a href="#l3.2185"></a><span id="l3.2185">       case &quot;textarea&quot;:</span>
<a href="#l3.2186"></a><span id="l3.2186">         objStr = GetString(&quot;TextArea&quot;);</span>
<a href="#l3.2187"></a><span id="l3.2187">         break;</span>
<a href="#l3.2188"></a><span id="l3.2188">       case &quot;select&quot;:</span>
<a href="#l3.2189"></a><span id="l3.2189">         objStr = GetString(&quot;Select&quot;);</span>
<a href="#l3.2190"></a><span id="l3.2190">         break;</span>
<a href="#l3.2191"></a><span id="l3.2191">       case &quot;button&quot;:</span>
<a href="#l3.2192"></a><span id="l3.2192" class="difflineat">@@ -1944,18 +2254,19 @@ function InitObjectPropertiesMenuitem() </span>
<a href="#l3.2193"></a><span id="l3.2193">           objStr = GetString(&quot;NamedAnchor&quot;);</span>
<a href="#l3.2194"></a><span id="l3.2194">           name = &quot;anchor&quot;;</span>
<a href="#l3.2195"></a><span id="l3.2195">         } else if (element.href) {</span>
<a href="#l3.2196"></a><span id="l3.2196">           objStr = GetString(&quot;Link&quot;);</span>
<a href="#l3.2197"></a><span id="l3.2197">           name = &quot;href&quot;;</span>
<a href="#l3.2198"></a><span id="l3.2198">         }</span>
<a href="#l3.2199"></a><span id="l3.2199">         break;</span>
<a href="#l3.2200"></a><span id="l3.2200">     }</span>
<a href="#l3.2201"></a><span id="l3.2201" class="difflineminus">-    if (objStr)</span>
<a href="#l3.2202"></a><span id="l3.2202" class="difflineplus">+    if (objStr) {</span>
<a href="#l3.2203"></a><span id="l3.2203">       menuStr = GetString(&quot;ObjectProperties&quot;).replace(/%obj%/, objStr);</span>
<a href="#l3.2204"></a><span id="l3.2204" class="difflineplus">+    }</span>
<a href="#l3.2205"></a><span id="l3.2205">   } else {</span>
<a href="#l3.2206"></a><span id="l3.2206">     // We show generic &quot;Properties&quot; string, but disable the command.</span>
<a href="#l3.2207"></a><span id="l3.2207">     cmd.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l3.2208"></a><span id="l3.2208">   }</span>
<a href="#l3.2209"></a><span id="l3.2209">   cmd.setAttribute(&quot;label&quot;, menuStr);</span>
<a href="#l3.2210"></a><span id="l3.2210">   cmd.setAttribute(&quot;accesskey&quot;, GetString(&quot;ObjectPropertiesAccessKey&quot;));</span>
<a href="#l3.2211"></a><span id="l3.2211">   return name;</span>
<a href="#l3.2212"></a><span id="l3.2212"> }</span>
<a href="#l3.2213"></a><span id="l3.2213" class="difflineat">@@ -1967,115 +2278,134 @@ function InitParagraphMenu() {</span>
<a href="#l3.2214"></a><span id="l3.2214">     state = GetCurrentEditor().getParagraphState(mixedObj);</span>
<a href="#l3.2215"></a><span id="l3.2215">   } catch (e) {}</span>
<a href="#l3.2216"></a><span id="l3.2216">   var IDSuffix;</span>
<a href="#l3.2217"></a><span id="l3.2217"> </span>
<a href="#l3.2218"></a><span id="l3.2218">   // PROBLEM: When we get blockquote, it masks other styles contained by it</span>
<a href="#l3.2219"></a><span id="l3.2219">   // We need a separate method to get blockquote state</span>
<a href="#l3.2220"></a><span id="l3.2220"> </span>
<a href="#l3.2221"></a><span id="l3.2221">   // We use &quot;x&quot; as uninitialized paragraph state</span>
<a href="#l3.2222"></a><span id="l3.2222" class="difflineminus">-  if (!state || state == &quot;x&quot;)</span>
<a href="#l3.2223"></a><span id="l3.2223" class="difflineminus">-    IDSuffix = &quot;bodyText&quot;; // No paragraph container</span>
<a href="#l3.2224"></a><span id="l3.2224" class="difflineminus">-  else</span>
<a href="#l3.2225"></a><span id="l3.2225" class="difflineplus">+  if (!state || state == &quot;x&quot;) {</span>
<a href="#l3.2226"></a><span id="l3.2226" class="difflineplus">+    IDSuffix = &quot;bodyText&quot;;</span>
<a href="#l3.2227"></a><span id="l3.2227" class="difflineplus">+  } // No paragraph container</span>
<a href="#l3.2228"></a><span id="l3.2228" class="difflineplus">+  else {</span>
<a href="#l3.2229"></a><span id="l3.2229">     IDSuffix = state;</span>
<a href="#l3.2230"></a><span id="l3.2230" class="difflineplus">+  }</span>
<a href="#l3.2231"></a><span id="l3.2231"> </span>
<a href="#l3.2232"></a><span id="l3.2232">   // Set &quot;radio&quot; check on one item, but...</span>
<a href="#l3.2233"></a><span id="l3.2233">   var menuItem = document.getElementById(&quot;menu_&quot; + IDSuffix);</span>
<a href="#l3.2234"></a><span id="l3.2234">   menuItem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l3.2235"></a><span id="l3.2235"> </span>
<a href="#l3.2236"></a><span id="l3.2236">   // ...&quot;bodyText&quot; is returned if mixed selection, so remove checkmark</span>
<a href="#l3.2237"></a><span id="l3.2237" class="difflineminus">-  if (mixedObj.value)</span>
<a href="#l3.2238"></a><span id="l3.2238" class="difflineplus">+  if (mixedObj.value) {</span>
<a href="#l3.2239"></a><span id="l3.2239">     menuItem.setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l3.2240"></a><span id="l3.2240" class="difflineplus">+  }</span>
<a href="#l3.2241"></a><span id="l3.2241"> }</span>
<a href="#l3.2242"></a><span id="l3.2242"> </span>
<a href="#l3.2243"></a><span id="l3.2243"> function GetListStateString() {</span>
<a href="#l3.2244"></a><span id="l3.2244">   try {</span>
<a href="#l3.2245"></a><span id="l3.2245">     var editor = GetCurrentEditor();</span>
<a href="#l3.2246"></a><span id="l3.2246"> </span>
<a href="#l3.2247"></a><span id="l3.2247">     var mixedObj = { value: null };</span>
<a href="#l3.2248"></a><span id="l3.2248">     var hasOL = { value: false };</span>
<a href="#l3.2249"></a><span id="l3.2249">     var hasUL = { value: false };</span>
<a href="#l3.2250"></a><span id="l3.2250">     var hasDL = { value: false };</span>
<a href="#l3.2251"></a><span id="l3.2251">     editor.getListState(mixedObj, hasOL, hasUL, hasDL);</span>
<a href="#l3.2252"></a><span id="l3.2252"> </span>
<a href="#l3.2253"></a><span id="l3.2253" class="difflineminus">-    if (mixedObj.value)</span>
<a href="#l3.2254"></a><span id="l3.2254" class="difflineplus">+    if (mixedObj.value) {</span>
<a href="#l3.2255"></a><span id="l3.2255">       return &quot;mixed&quot;;</span>
<a href="#l3.2256"></a><span id="l3.2256" class="difflineminus">-    if (hasOL.value)</span>
<a href="#l3.2257"></a><span id="l3.2257" class="difflineplus">+    }</span>
<a href="#l3.2258"></a><span id="l3.2258" class="difflineplus">+    if (hasOL.value) {</span>
<a href="#l3.2259"></a><span id="l3.2259">       return &quot;ol&quot;;</span>
<a href="#l3.2260"></a><span id="l3.2260" class="difflineminus">-    if (hasUL.value)</span>
<a href="#l3.2261"></a><span id="l3.2261" class="difflineplus">+    }</span>
<a href="#l3.2262"></a><span id="l3.2262" class="difflineplus">+    if (hasUL.value) {</span>
<a href="#l3.2263"></a><span id="l3.2263">       return &quot;ul&quot;;</span>
<a href="#l3.2264"></a><span id="l3.2264" class="difflineplus">+    }</span>
<a href="#l3.2265"></a><span id="l3.2265"> </span>
<a href="#l3.2266"></a><span id="l3.2266">     if (hasDL.value) {</span>
<a href="#l3.2267"></a><span id="l3.2267">       var hasLI = { value: false };</span>
<a href="#l3.2268"></a><span id="l3.2268">       var hasDT = { value: false };</span>
<a href="#l3.2269"></a><span id="l3.2269">       var hasDD = { value: false };</span>
<a href="#l3.2270"></a><span id="l3.2270">       editor.getListItemState(mixedObj, hasLI, hasDT, hasDD);</span>
<a href="#l3.2271"></a><span id="l3.2271" class="difflineminus">-      if (mixedObj.value)</span>
<a href="#l3.2272"></a><span id="l3.2272" class="difflineplus">+      if (mixedObj.value) {</span>
<a href="#l3.2273"></a><span id="l3.2273">         return &quot;mixed&quot;;</span>
<a href="#l3.2274"></a><span id="l3.2274" class="difflineminus">-      if (hasLI.value)</span>
<a href="#l3.2275"></a><span id="l3.2275" class="difflineplus">+      }</span>
<a href="#l3.2276"></a><span id="l3.2276" class="difflineplus">+      if (hasLI.value) {</span>
<a href="#l3.2277"></a><span id="l3.2277">         return &quot;li&quot;;</span>
<a href="#l3.2278"></a><span id="l3.2278" class="difflineminus">-      if (hasDT.value)</span>
<a href="#l3.2279"></a><span id="l3.2279" class="difflineplus">+      }</span>
<a href="#l3.2280"></a><span id="l3.2280" class="difflineplus">+      if (hasDT.value) {</span>
<a href="#l3.2281"></a><span id="l3.2281">         return &quot;dt&quot;;</span>
<a href="#l3.2282"></a><span id="l3.2282" class="difflineminus">-      if (hasDD.value)</span>
<a href="#l3.2283"></a><span id="l3.2283" class="difflineplus">+      }</span>
<a href="#l3.2284"></a><span id="l3.2284" class="difflineplus">+      if (hasDD.value) {</span>
<a href="#l3.2285"></a><span id="l3.2285">         return &quot;dd&quot;;</span>
<a href="#l3.2286"></a><span id="l3.2286" class="difflineplus">+      }</span>
<a href="#l3.2287"></a><span id="l3.2287">     }</span>
<a href="#l3.2288"></a><span id="l3.2288">   } catch (e) {}</span>
<a href="#l3.2289"></a><span id="l3.2289"> </span>
<a href="#l3.2290"></a><span id="l3.2290">   // return &quot;noList&quot; if we aren't in a list at all</span>
<a href="#l3.2291"></a><span id="l3.2291">   return &quot;noList&quot;;</span>
<a href="#l3.2292"></a><span id="l3.2292"> }</span>
<a href="#l3.2293"></a><span id="l3.2293"> </span>
<a href="#l3.2294"></a><span id="l3.2294"> function InitListMenu() {</span>
<a href="#l3.2295"></a><span id="l3.2295" class="difflineminus">-  if (!IsHTMLEditor())</span>
<a href="#l3.2296"></a><span id="l3.2296" class="difflineplus">+  if (!IsHTMLEditor()) {</span>
<a href="#l3.2297"></a><span id="l3.2297">     return;</span>
<a href="#l3.2298"></a><span id="l3.2298" class="difflineplus">+  }</span>
<a href="#l3.2299"></a><span id="l3.2299"> </span>
<a href="#l3.2300"></a><span id="l3.2300">   var IDSuffix = GetListStateString();</span>
<a href="#l3.2301"></a><span id="l3.2301"> </span>
<a href="#l3.2302"></a><span id="l3.2302">   // Set enable state for the &quot;None&quot; menuitem</span>
<a href="#l3.2303"></a><span id="l3.2303">   goSetCommandEnabled(&quot;cmd_removeList&quot;, IDSuffix != &quot;noList&quot;);</span>
<a href="#l3.2304"></a><span id="l3.2304"> </span>
<a href="#l3.2305"></a><span id="l3.2305">   // Set &quot;radio&quot; check on one item, but...</span>
<a href="#l3.2306"></a><span id="l3.2306">   // we won't find a match if it's &quot;mixed&quot;</span>
<a href="#l3.2307"></a><span id="l3.2307">   var menuItem = document.getElementById(&quot;menu_&quot; + IDSuffix);</span>
<a href="#l3.2308"></a><span id="l3.2308" class="difflineminus">-  if (menuItem)</span>
<a href="#l3.2309"></a><span id="l3.2309" class="difflineplus">+  if (menuItem) {</span>
<a href="#l3.2310"></a><span id="l3.2310">     menuItem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l3.2311"></a><span id="l3.2311" class="difflineplus">+  }</span>
<a href="#l3.2312"></a><span id="l3.2312"> }</span>
<a href="#l3.2313"></a><span id="l3.2313"> </span>
<a href="#l3.2314"></a><span id="l3.2314"> function GetAlignmentString() {</span>
<a href="#l3.2315"></a><span id="l3.2315">   var mixedObj = { value: null };</span>
<a href="#l3.2316"></a><span id="l3.2316">   var alignObj = { value: null };</span>
<a href="#l3.2317"></a><span id="l3.2317">   try {</span>
<a href="#l3.2318"></a><span id="l3.2318">     GetCurrentEditor().getAlignment(mixedObj, alignObj);</span>
<a href="#l3.2319"></a><span id="l3.2319">   } catch (e) {}</span>
<a href="#l3.2320"></a><span id="l3.2320"> </span>
<a href="#l3.2321"></a><span id="l3.2321" class="difflineminus">-  if (mixedObj.value)</span>
<a href="#l3.2322"></a><span id="l3.2322" class="difflineplus">+  if (mixedObj.value) {</span>
<a href="#l3.2323"></a><span id="l3.2323">     return &quot;mixed&quot;;</span>
<a href="#l3.2324"></a><span id="l3.2324" class="difflineminus">-  if (alignObj.value == nsIHTMLEditor.eLeft)</span>
<a href="#l3.2325"></a><span id="l3.2325" class="difflineplus">+  }</span>
<a href="#l3.2326"></a><span id="l3.2326" class="difflineplus">+  if (alignObj.value == nsIHTMLEditor.eLeft) {</span>
<a href="#l3.2327"></a><span id="l3.2327">     return &quot;left&quot;;</span>
<a href="#l3.2328"></a><span id="l3.2328" class="difflineminus">-  if (alignObj.value == nsIHTMLEditor.eCenter)</span>
<a href="#l3.2329"></a><span id="l3.2329" class="difflineplus">+  }</span>
<a href="#l3.2330"></a><span id="l3.2330" class="difflineplus">+  if (alignObj.value == nsIHTMLEditor.eCenter) {</span>
<a href="#l3.2331"></a><span id="l3.2331">     return &quot;center&quot;;</span>
<a href="#l3.2332"></a><span id="l3.2332" class="difflineminus">-  if (alignObj.value == nsIHTMLEditor.eRight)</span>
<a href="#l3.2333"></a><span id="l3.2333" class="difflineplus">+  }</span>
<a href="#l3.2334"></a><span id="l3.2334" class="difflineplus">+  if (alignObj.value == nsIHTMLEditor.eRight) {</span>
<a href="#l3.2335"></a><span id="l3.2335">     return &quot;right&quot;;</span>
<a href="#l3.2336"></a><span id="l3.2336" class="difflineminus">-  if (alignObj.value == nsIHTMLEditor.eJustify)</span>
<a href="#l3.2337"></a><span id="l3.2337" class="difflineplus">+  }</span>
<a href="#l3.2338"></a><span id="l3.2338" class="difflineplus">+  if (alignObj.value == nsIHTMLEditor.eJustify) {</span>
<a href="#l3.2339"></a><span id="l3.2339">     return &quot;justify&quot;;</span>
<a href="#l3.2340"></a><span id="l3.2340" class="difflineplus">+  }</span>
<a href="#l3.2341"></a><span id="l3.2341"> </span>
<a href="#l3.2342"></a><span id="l3.2342">   // return &quot;left&quot; if we got here</span>
<a href="#l3.2343"></a><span id="l3.2343">   return &quot;left&quot;;</span>
<a href="#l3.2344"></a><span id="l3.2344"> }</span>
<a href="#l3.2345"></a><span id="l3.2345"> </span>
<a href="#l3.2346"></a><span id="l3.2346"> function InitAlignMenu() {</span>
<a href="#l3.2347"></a><span id="l3.2347" class="difflineminus">-  if (!IsHTMLEditor())</span>
<a href="#l3.2348"></a><span id="l3.2348" class="difflineplus">+  if (!IsHTMLEditor()) {</span>
<a href="#l3.2349"></a><span id="l3.2349">     return;</span>
<a href="#l3.2350"></a><span id="l3.2350" class="difflineplus">+  }</span>
<a href="#l3.2351"></a><span id="l3.2351"> </span>
<a href="#l3.2352"></a><span id="l3.2352">   var IDSuffix = GetAlignmentString();</span>
<a href="#l3.2353"></a><span id="l3.2353"> </span>
<a href="#l3.2354"></a><span id="l3.2354">   // we won't find a match if it's &quot;mixed&quot;</span>
<a href="#l3.2355"></a><span id="l3.2355">   var menuItem = document.getElementById(&quot;menu_&quot; + IDSuffix);</span>
<a href="#l3.2356"></a><span id="l3.2356" class="difflineminus">-  if (menuItem)</span>
<a href="#l3.2357"></a><span id="l3.2357" class="difflineplus">+  if (menuItem) {</span>
<a href="#l3.2358"></a><span id="l3.2358">     menuItem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l3.2359"></a><span id="l3.2359" class="difflineplus">+  }</span>
<a href="#l3.2360"></a><span id="l3.2360"> }</span>
<a href="#l3.2361"></a><span id="l3.2361"> </span>
<a href="#l3.2362"></a><span id="l3.2362"> function EditorSetDefaultPrefsAndDoctype() {</span>
<a href="#l3.2363"></a><span id="l3.2363">   var editor = GetCurrentEditor();</span>
<a href="#l3.2364"></a><span id="l3.2364"> </span>
<a href="#l3.2365"></a><span id="l3.2365">   var domdoc;</span>
<a href="#l3.2366"></a><span id="l3.2366">   try {</span>
<a href="#l3.2367"></a><span id="l3.2367">     domdoc = editor.document;</span>
<a href="#l3.2368"></a><span id="l3.2368" class="difflineat">@@ -2085,94 +2415,134 @@ function EditorSetDefaultPrefsAndDoctype</span>
<a href="#l3.2369"></a><span id="l3.2369">   if (!domdoc) {</span>
<a href="#l3.2370"></a><span id="l3.2370">     dump(&quot;EditorSetDefaultPrefsAndDoctype: EDITOR DOCUMENT NOT FOUND\n&quot;);</span>
<a href="#l3.2371"></a><span id="l3.2371">     return;</span>
<a href="#l3.2372"></a><span id="l3.2372">   }</span>
<a href="#l3.2373"></a><span id="l3.2373"> </span>
<a href="#l3.2374"></a><span id="l3.2374">   // Insert a doctype element</span>
<a href="#l3.2375"></a><span id="l3.2375">   // if it is missing from existing doc</span>
<a href="#l3.2376"></a><span id="l3.2376">   if (!domdoc.doctype) {</span>
<a href="#l3.2377"></a><span id="l3.2377" class="difflineminus">-    var newdoctype = domdoc.implementation.createDocumentType(&quot;HTML&quot;, &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;, &quot;&quot;);</span>
<a href="#l3.2378"></a><span id="l3.2378" class="difflineminus">-    if (newdoctype)</span>
<a href="#l3.2379"></a><span id="l3.2379" class="difflineplus">+    var newdoctype = domdoc.implementation.createDocumentType(</span>
<a href="#l3.2380"></a><span id="l3.2380" class="difflineplus">+      &quot;HTML&quot;,</span>
<a href="#l3.2381"></a><span id="l3.2381" class="difflineplus">+      &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;,</span>
<a href="#l3.2382"></a><span id="l3.2382" class="difflineplus">+      &quot;&quot;</span>
<a href="#l3.2383"></a><span id="l3.2383" class="difflineplus">+    );</span>
<a href="#l3.2384"></a><span id="l3.2384" class="difflineplus">+    if (newdoctype) {</span>
<a href="#l3.2385"></a><span id="l3.2385">       domdoc.insertBefore(newdoctype, domdoc.firstChild);</span>
<a href="#l3.2386"></a><span id="l3.2386" class="difflineplus">+    }</span>
<a href="#l3.2387"></a><span id="l3.2387">   }</span>
<a href="#l3.2388"></a><span id="l3.2388"> </span>
<a href="#l3.2389"></a><span id="l3.2389">   // search for head; we'll need this for meta tag additions</span>
<a href="#l3.2390"></a><span id="l3.2390">   let headelement = domdoc.querySelector(&quot;head&quot;);</span>
<a href="#l3.2391"></a><span id="l3.2391">   if (!headelement) {</span>
<a href="#l3.2392"></a><span id="l3.2392">     headelement = domdoc.createElement(&quot;head&quot;);</span>
<a href="#l3.2393"></a><span id="l3.2393" class="difflineminus">-    if (headelement)</span>
<a href="#l3.2394"></a><span id="l3.2394" class="difflineplus">+    if (headelement) {</span>
<a href="#l3.2395"></a><span id="l3.2395">       domdoc.insertAfter(headelement, domdoc.firstChild);</span>
<a href="#l3.2396"></a><span id="l3.2396" class="difflineplus">+    }</span>
<a href="#l3.2397"></a><span id="l3.2397">   }</span>
<a href="#l3.2398"></a><span id="l3.2398"> </span>
<a href="#l3.2399"></a><span id="l3.2399">   /* only set default prefs for new documents */</span>
<a href="#l3.2400"></a><span id="l3.2400" class="difflineminus">-  if (!IsUrlAboutBlank(GetDocumentUrl()))</span>
<a href="#l3.2401"></a><span id="l3.2401" class="difflineplus">+  if (!IsUrlAboutBlank(GetDocumentUrl())) {</span>
<a href="#l3.2402"></a><span id="l3.2402">     return;</span>
<a href="#l3.2403"></a><span id="l3.2403" class="difflineplus">+  }</span>
<a href="#l3.2404"></a><span id="l3.2404"> </span>
<a href="#l3.2405"></a><span id="l3.2405">   // search for author meta tag.</span>
<a href="#l3.2406"></a><span id="l3.2406">   // if one is found, don't do anything.</span>
<a href="#l3.2407"></a><span id="l3.2407">   // if not, create one and make it a child of the head tag</span>
<a href="#l3.2408"></a><span id="l3.2408">   //   and set its content attribute to the value of the editor.author preference.</span>
<a href="#l3.2409"></a><span id="l3.2409"> </span>
<a href="#l3.2410"></a><span id="l3.2410">   if (domdoc.querySelector(&quot;meta&quot;)) {</span>
<a href="#l3.2411"></a><span id="l3.2411">     // we should do charset first since we need to have charset before</span>
<a href="#l3.2412"></a><span id="l3.2412">     // hitting other 8-bit char in other meta tags</span>
<a href="#l3.2413"></a><span id="l3.2413">     // grab charset pref and make it the default charset</span>
<a href="#l3.2414"></a><span id="l3.2414">     var element;</span>
<a href="#l3.2415"></a><span id="l3.2415" class="difflineminus">-    var prefCharsetString = Services.prefs.getCharPref(&quot;intl.charset.fallback.override&quot;);</span>
<a href="#l3.2416"></a><span id="l3.2416" class="difflineminus">-    if (prefCharsetString)</span>
<a href="#l3.2417"></a><span id="l3.2417" class="difflineplus">+    var prefCharsetString = Services.prefs.getCharPref(</span>
<a href="#l3.2418"></a><span id="l3.2418" class="difflineplus">+      &quot;intl.charset.fallback.override&quot;</span>
<a href="#l3.2419"></a><span id="l3.2419" class="difflineplus">+    );</span>
<a href="#l3.2420"></a><span id="l3.2420" class="difflineplus">+    if (prefCharsetString) {</span>
<a href="#l3.2421"></a><span id="l3.2421">       editor.documentCharacterSet = prefCharsetString;</span>
<a href="#l3.2422"></a><span id="l3.2422" class="difflineplus">+    }</span>
<a href="#l3.2423"></a><span id="l3.2423"> </span>
<a href="#l3.2424"></a><span id="l3.2424">     // let's start by assuming we have an author in case we don't have the pref</span>
<a href="#l3.2425"></a><span id="l3.2425"> </span>
<a href="#l3.2426"></a><span id="l3.2426">     var prefAuthorString = null;</span>
<a href="#l3.2427"></a><span id="l3.2427">     let authorFound = domdoc.querySelector('meta[name=&quot;author&quot;]');</span>
<a href="#l3.2428"></a><span id="l3.2428">     try {</span>
<a href="#l3.2429"></a><span id="l3.2429">       prefAuthorString = Services.prefs.getStringPref(&quot;editor.author&quot;);</span>
<a href="#l3.2430"></a><span id="l3.2430">     } catch (ex) {}</span>
<a href="#l3.2431"></a><span id="l3.2431" class="difflineminus">-    if (prefAuthorString &amp;&amp; prefAuthorString != 0 &amp;&amp; !authorFound &amp;&amp; headelement) {</span>
<a href="#l3.2432"></a><span id="l3.2432" class="difflineplus">+    if (</span>
<a href="#l3.2433"></a><span id="l3.2433" class="difflineplus">+      prefAuthorString &amp;&amp;</span>
<a href="#l3.2434"></a><span id="l3.2434" class="difflineplus">+      prefAuthorString != 0 &amp;&amp;</span>
<a href="#l3.2435"></a><span id="l3.2435" class="difflineplus">+      !authorFound &amp;&amp;</span>
<a href="#l3.2436"></a><span id="l3.2436" class="difflineplus">+      headelement</span>
<a href="#l3.2437"></a><span id="l3.2437" class="difflineplus">+    ) {</span>
<a href="#l3.2438"></a><span id="l3.2438">       // create meta tag with 2 attributes</span>
<a href="#l3.2439"></a><span id="l3.2439">       element = domdoc.createElement(&quot;meta&quot;);</span>
<a href="#l3.2440"></a><span id="l3.2440">       if (element) {</span>
<a href="#l3.2441"></a><span id="l3.2441">         element.setAttribute(&quot;name&quot;, &quot;author&quot;);</span>
<a href="#l3.2442"></a><span id="l3.2442">         element.setAttribute(&quot;content&quot;, prefAuthorString);</span>
<a href="#l3.2443"></a><span id="l3.2443">         headelement.appendChild(element);</span>
<a href="#l3.2444"></a><span id="l3.2444">       }</span>
<a href="#l3.2445"></a><span id="l3.2445">     }</span>
<a href="#l3.2446"></a><span id="l3.2446">   }</span>
<a href="#l3.2447"></a><span id="l3.2447"> </span>
<a href="#l3.2448"></a><span id="l3.2448">   // add title tag if not present</span>
<a href="#l3.2449"></a><span id="l3.2449">   if (headelement &amp;&amp; !editor.document.querySelector(&quot;title&quot;)) {</span>
<a href="#l3.2450"></a><span id="l3.2450" class="difflineminus">-     var titleElement = domdoc.createElement(&quot;title&quot;);</span>
<a href="#l3.2451"></a><span id="l3.2451" class="difflineminus">-     if (titleElement)</span>
<a href="#l3.2452"></a><span id="l3.2452" class="difflineminus">-       headelement.appendChild(titleElement);</span>
<a href="#l3.2453"></a><span id="l3.2453" class="difflineplus">+    var titleElement = domdoc.createElement(&quot;title&quot;);</span>
<a href="#l3.2454"></a><span id="l3.2454" class="difflineplus">+    if (titleElement) {</span>
<a href="#l3.2455"></a><span id="l3.2455" class="difflineplus">+      headelement.appendChild(titleElement);</span>
<a href="#l3.2456"></a><span id="l3.2456" class="difflineplus">+    }</span>
<a href="#l3.2457"></a><span id="l3.2457">   }</span>
<a href="#l3.2458"></a><span id="l3.2458"> </span>
<a href="#l3.2459"></a><span id="l3.2459">   // find body node</span>
<a href="#l3.2460"></a><span id="l3.2460">   var bodyelement = GetBodyElement();</span>
<a href="#l3.2461"></a><span id="l3.2461">   if (bodyelement) {</span>
<a href="#l3.2462"></a><span id="l3.2462">     if (Services.prefs.getBoolPref(&quot;editor.use_custom_colors&quot;)) {</span>
<a href="#l3.2463"></a><span id="l3.2463">       let text_color = Services.prefs.getCharPref(&quot;editor.text_color&quot;);</span>
<a href="#l3.2464"></a><span id="l3.2464" class="difflineminus">-      let background_color = Services.prefs.getCharPref(&quot;editor.background_color&quot;);</span>
<a href="#l3.2465"></a><span id="l3.2465" class="difflineplus">+      let background_color = Services.prefs.getCharPref(</span>
<a href="#l3.2466"></a><span id="l3.2466" class="difflineplus">+        &quot;editor.background_color&quot;</span>
<a href="#l3.2467"></a><span id="l3.2467" class="difflineplus">+      );</span>
<a href="#l3.2468"></a><span id="l3.2468"> </span>
<a href="#l3.2469"></a><span id="l3.2469">       // add the color attributes to the body tag.</span>
<a href="#l3.2470"></a><span id="l3.2470">       // and use them for the default text and background colors if not empty</span>
<a href="#l3.2471"></a><span id="l3.2471">       editor.setAttributeOrEquivalent(bodyelement, &quot;text&quot;, text_color, true);</span>
<a href="#l3.2472"></a><span id="l3.2472">       gDefaultTextColor = text_color;</span>
<a href="#l3.2473"></a><span id="l3.2473" class="difflineminus">-      editor.setAttributeOrEquivalent(bodyelement, &quot;bgcolor&quot;, background_color, true);</span>
<a href="#l3.2474"></a><span id="l3.2474" class="difflineplus">+      editor.setAttributeOrEquivalent(</span>
<a href="#l3.2475"></a><span id="l3.2475" class="difflineplus">+        bodyelement,</span>
<a href="#l3.2476"></a><span id="l3.2476" class="difflineplus">+        &quot;bgcolor&quot;,</span>
<a href="#l3.2477"></a><span id="l3.2477" class="difflineplus">+        background_color,</span>
<a href="#l3.2478"></a><span id="l3.2478" class="difflineplus">+        true</span>
<a href="#l3.2479"></a><span id="l3.2479" class="difflineplus">+      );</span>
<a href="#l3.2480"></a><span id="l3.2480">       gDefaultBackgroundColor = background_color;</span>
<a href="#l3.2481"></a><span id="l3.2481" class="difflineminus">-      bodyelement.setAttribute(&quot;link&quot;, Services.prefs.getCharPref(&quot;editor.link_color&quot;));</span>
<a href="#l3.2482"></a><span id="l3.2482" class="difflineminus">-      bodyelement.setAttribute(&quot;alink&quot;, Services.prefs.getCharPref(&quot;editor.active_link_color&quot;));</span>
<a href="#l3.2483"></a><span id="l3.2483" class="difflineminus">-      bodyelement.setAttribute(&quot;vlink&quot;, Services.prefs.getCharPref(&quot;editor.followed_link_color&quot;));</span>
<a href="#l3.2484"></a><span id="l3.2484" class="difflineplus">+      bodyelement.setAttribute(</span>
<a href="#l3.2485"></a><span id="l3.2485" class="difflineplus">+        &quot;link&quot;,</span>
<a href="#l3.2486"></a><span id="l3.2486" class="difflineplus">+        Services.prefs.getCharPref(&quot;editor.link_color&quot;)</span>
<a href="#l3.2487"></a><span id="l3.2487" class="difflineplus">+      );</span>
<a href="#l3.2488"></a><span id="l3.2488" class="difflineplus">+      bodyelement.setAttribute(</span>
<a href="#l3.2489"></a><span id="l3.2489" class="difflineplus">+        &quot;alink&quot;,</span>
<a href="#l3.2490"></a><span id="l3.2490" class="difflineplus">+        Services.prefs.getCharPref(&quot;editor.active_link_color&quot;)</span>
<a href="#l3.2491"></a><span id="l3.2491" class="difflineplus">+      );</span>
<a href="#l3.2492"></a><span id="l3.2492" class="difflineplus">+      bodyelement.setAttribute(</span>
<a href="#l3.2493"></a><span id="l3.2493" class="difflineplus">+        &quot;vlink&quot;,</span>
<a href="#l3.2494"></a><span id="l3.2494" class="difflineplus">+        Services.prefs.getCharPref(&quot;editor.followed_link_color&quot;)</span>
<a href="#l3.2495"></a><span id="l3.2495" class="difflineplus">+      );</span>
<a href="#l3.2496"></a><span id="l3.2496">     }</span>
<a href="#l3.2497"></a><span id="l3.2497">     // Default image is independent of Custom colors???</span>
<a href="#l3.2498"></a><span id="l3.2498">     try {</span>
<a href="#l3.2499"></a><span id="l3.2499" class="difflineminus">-      let background_image = Services.prefs.getCharPref(&quot;editor.default_background_image&quot;);</span>
<a href="#l3.2500"></a><span id="l3.2500" class="difflineminus">-      if (background_image)</span>
<a href="#l3.2501"></a><span id="l3.2501" class="difflineminus">-        editor.setAttributeOrEquivalent(bodyelement, &quot;background&quot;, background_image, true);</span>
<a href="#l3.2502"></a><span id="l3.2502" class="difflineplus">+      let background_image = Services.prefs.getCharPref(</span>
<a href="#l3.2503"></a><span id="l3.2503" class="difflineplus">+        &quot;editor.default_background_image&quot;</span>
<a href="#l3.2504"></a><span id="l3.2504" class="difflineplus">+      );</span>
<a href="#l3.2505"></a><span id="l3.2505" class="difflineplus">+      if (background_image) {</span>
<a href="#l3.2506"></a><span id="l3.2506" class="difflineplus">+        editor.setAttributeOrEquivalent(</span>
<a href="#l3.2507"></a><span id="l3.2507" class="difflineplus">+          bodyelement,</span>
<a href="#l3.2508"></a><span id="l3.2508" class="difflineplus">+          &quot;background&quot;,</span>
<a href="#l3.2509"></a><span id="l3.2509" class="difflineplus">+          background_image,</span>
<a href="#l3.2510"></a><span id="l3.2510" class="difflineplus">+          true</span>
<a href="#l3.2511"></a><span id="l3.2511" class="difflineplus">+        );</span>
<a href="#l3.2512"></a><span id="l3.2512" class="difflineplus">+      }</span>
<a href="#l3.2513"></a><span id="l3.2513">     } catch (e) {</span>
<a href="#l3.2514"></a><span id="l3.2514">       dump(&quot;BACKGROUND EXCEPTION: &quot; + e + &quot;\n&quot;);</span>
<a href="#l3.2515"></a><span id="l3.2515">     }</span>
<a href="#l3.2516"></a><span id="l3.2516">   }</span>
<a href="#l3.2517"></a><span id="l3.2517">   // auto-save???</span>
<a href="#l3.2518"></a><span id="l3.2518"> }</span>
<a href="#l3.2519"></a><span id="l3.2519"> </span>
<a href="#l3.2520"></a><span id="l3.2520"> function GetBodyElement() {</span>
<a href="#l3.2521"></a><span id="l3.2521" class="difflineat">@@ -2187,42 +2557,43 @@ function GetBodyElement() {</span>
<a href="#l3.2522"></a><span id="l3.2522"> </span>
<a href="#l3.2523"></a><span id="l3.2523"> // --------------------------- Logging stuff ---------------------------</span>
<a href="#l3.2524"></a><span id="l3.2524"> </span>
<a href="#l3.2525"></a><span id="l3.2525"> function EditorGetNodeFromOffsets(offsets) {</span>
<a href="#l3.2526"></a><span id="l3.2526">   var node = null;</span>
<a href="#l3.2527"></a><span id="l3.2527">   try {</span>
<a href="#l3.2528"></a><span id="l3.2528">     node = GetCurrentEditor().document;</span>
<a href="#l3.2529"></a><span id="l3.2529"> </span>
<a href="#l3.2530"></a><span id="l3.2530" class="difflineminus">-    for (var i = 0; i &lt; offsets.length; i++)</span>
<a href="#l3.2531"></a><span id="l3.2531" class="difflineplus">+    for (var i = 0; i &lt; offsets.length; i++) {</span>
<a href="#l3.2532"></a><span id="l3.2532">       node = node.childNodes[offsets[i]];</span>
<a href="#l3.2533"></a><span id="l3.2533" class="difflineplus">+    }</span>
<a href="#l3.2534"></a><span id="l3.2534">   } catch (e) {}</span>
<a href="#l3.2535"></a><span id="l3.2535">   return node;</span>
<a href="#l3.2536"></a><span id="l3.2536"> }</span>
<a href="#l3.2537"></a><span id="l3.2537"> </span>
<a href="#l3.2538"></a><span id="l3.2538"> function EditorSetSelectionFromOffsets(selRanges) {</span>
<a href="#l3.2539"></a><span id="l3.2539">   try {</span>
<a href="#l3.2540"></a><span id="l3.2540">     var editor = GetCurrentEditor();</span>
<a href="#l3.2541"></a><span id="l3.2541">     var selection = editor.selection;</span>
<a href="#l3.2542"></a><span id="l3.2542">     selection.removeAllRanges();</span>
<a href="#l3.2543"></a><span id="l3.2543"> </span>
<a href="#l3.2544"></a><span id="l3.2544">     var rangeArr, start, end, node, offset;</span>
<a href="#l3.2545"></a><span id="l3.2545">     for (var i = 0; i &lt; selRanges.length; i++) {</span>
<a href="#l3.2546"></a><span id="l3.2546">       rangeArr = selRanges[i];</span>
<a href="#l3.2547"></a><span id="l3.2547" class="difflineminus">-      start    = rangeArr[0];</span>
<a href="#l3.2548"></a><span id="l3.2548" class="difflineminus">-      end      = rangeArr[1];</span>
<a href="#l3.2549"></a><span id="l3.2549" class="difflineplus">+      start = rangeArr[0];</span>
<a href="#l3.2550"></a><span id="l3.2550" class="difflineplus">+      end = rangeArr[1];</span>
<a href="#l3.2551"></a><span id="l3.2551"> </span>
<a href="#l3.2552"></a><span id="l3.2552">       var range = editor.document.createRange();</span>
<a href="#l3.2553"></a><span id="l3.2553"> </span>
<a href="#l3.2554"></a><span id="l3.2554" class="difflineminus">-      node   = EditorGetNodeFromOffsets(start[0]);</span>
<a href="#l3.2555"></a><span id="l3.2555" class="difflineplus">+      node = EditorGetNodeFromOffsets(start[0]);</span>
<a href="#l3.2556"></a><span id="l3.2556">       offset = start[1];</span>
<a href="#l3.2557"></a><span id="l3.2557"> </span>
<a href="#l3.2558"></a><span id="l3.2558">       range.setStart(node, offset);</span>
<a href="#l3.2559"></a><span id="l3.2559"> </span>
<a href="#l3.2560"></a><span id="l3.2560" class="difflineminus">-      node   = EditorGetNodeFromOffsets(end[0]);</span>
<a href="#l3.2561"></a><span id="l3.2561" class="difflineplus">+      node = EditorGetNodeFromOffsets(end[0]);</span>
<a href="#l3.2562"></a><span id="l3.2562">       offset = end[1];</span>
<a href="#l3.2563"></a><span id="l3.2563"> </span>
<a href="#l3.2564"></a><span id="l3.2564">       range.setEnd(node, offset);</span>
<a href="#l3.2565"></a><span id="l3.2565"> </span>
<a href="#l3.2566"></a><span id="l3.2566">       selection.addRange(range);</span>
<a href="#l3.2567"></a><span id="l3.2567">     }</span>
<a href="#l3.2568"></a><span id="l3.2568">   } catch (e) {}</span>
<a href="#l3.2569"></a><span id="l3.2569"> }</span>
<a href="#l3.2570"></a><span id="l3.2570" class="difflineat">@@ -2251,58 +2622,61 @@ function onStateButtonUpdate(button, com</span>
<a href="#l3.2571"></a><span id="l3.2571">   var state = commandNode.getAttribute(&quot;state&quot;);</span>
<a href="#l3.2572"></a><span id="l3.2572"> </span>
<a href="#l3.2573"></a><span id="l3.2573">   button.checked = state == onState;</span>
<a href="#l3.2574"></a><span id="l3.2574"> }</span>
<a href="#l3.2575"></a><span id="l3.2575"> </span>
<a href="#l3.2576"></a><span id="l3.2576"> // --------------------------- Status calls ---------------------------</span>
<a href="#l3.2577"></a><span id="l3.2577"> function getColorAndSetColorWell(ColorPickerID, ColorWellID) {</span>
<a href="#l3.2578"></a><span id="l3.2578">   var colorWell;</span>
<a href="#l3.2579"></a><span id="l3.2579" class="difflineminus">-  if (ColorWellID)</span>
<a href="#l3.2580"></a><span id="l3.2580" class="difflineplus">+  if (ColorWellID) {</span>
<a href="#l3.2581"></a><span id="l3.2581">     colorWell = document.getElementById(ColorWellID);</span>
<a href="#l3.2582"></a><span id="l3.2582" class="difflineplus">+  }</span>
<a href="#l3.2583"></a><span id="l3.2583"> </span>
<a href="#l3.2584"></a><span id="l3.2584">   var colorPicker = document.getElementById(ColorPickerID);</span>
<a href="#l3.2585"></a><span id="l3.2585">   if (colorPicker) {</span>
<a href="#l3.2586"></a><span id="l3.2586">     // Extract color from colorPicker and assign to colorWell.</span>
<a href="#l3.2587"></a><span id="l3.2587">     var color = colorPicker.getAttribute(&quot;color&quot;);</span>
<a href="#l3.2588"></a><span id="l3.2588"> </span>
<a href="#l3.2589"></a><span id="l3.2589">     if (colorWell &amp;&amp; color) {</span>
<a href="#l3.2590"></a><span id="l3.2590">       // Use setAttribute so colorwell can be a XUL element, such as button</span>
<a href="#l3.2591"></a><span id="l3.2591">       colorWell.setAttribute(&quot;style&quot;, &quot;background-color: &quot; + color);</span>
<a href="#l3.2592"></a><span id="l3.2592">     }</span>
<a href="#l3.2593"></a><span id="l3.2593">   }</span>
<a href="#l3.2594"></a><span id="l3.2594">   return color;</span>
<a href="#l3.2595"></a><span id="l3.2595"> }</span>
<a href="#l3.2596"></a><span id="l3.2596"> </span>
<a href="#l3.2597"></a><span id="l3.2597"> // -----------------------------------------------------------------------------------</span>
<a href="#l3.2598"></a><span id="l3.2598"> function IsSpellCheckerInstalled() {</span>
<a href="#l3.2599"></a><span id="l3.2599" class="difflineminus">-  return true;  // Always installed.</span>
<a href="#l3.2600"></a><span id="l3.2600" class="difflineplus">+  return true; // Always installed.</span>
<a href="#l3.2601"></a><span id="l3.2601"> }</span>
<a href="#l3.2602"></a><span id="l3.2602"> </span>
<a href="#l3.2603"></a><span id="l3.2603"> // -----------------------------------------------------------------------------------</span>
<a href="#l3.2604"></a><span id="l3.2604"> function IsFindInstalled() {</span>
<a href="#l3.2605"></a><span id="l3.2605" class="difflineminus">-  return &quot;@mozilla.org/embedcomp/rangefind;1&quot; in Cc</span>
<a href="#l3.2606"></a><span id="l3.2606" class="difflineminus">-          &amp;&amp; &quot;@mozilla.org/find/find_service;1&quot; in Cc;</span>
<a href="#l3.2607"></a><span id="l3.2607" class="difflineplus">+  return (</span>
<a href="#l3.2608"></a><span id="l3.2608" class="difflineplus">+    &quot;@mozilla.org/embedcomp/rangefind;1&quot; in Cc &amp;&amp;</span>
<a href="#l3.2609"></a><span id="l3.2609" class="difflineplus">+    &quot;@mozilla.org/find/find_service;1&quot; in Cc</span>
<a href="#l3.2610"></a><span id="l3.2610" class="difflineplus">+  );</span>
<a href="#l3.2611"></a><span id="l3.2611"> }</span>
<a href="#l3.2612"></a><span id="l3.2612"> </span>
<a href="#l3.2613"></a><span id="l3.2613"> // -----------------------------------------------------------------------------------</span>
<a href="#l3.2614"></a><span id="l3.2614"> function RemoveInapplicableUIElements() {</span>
<a href="#l3.2615"></a><span id="l3.2615">   // For items that are in their own menu block, remove associated separator</span>
<a href="#l3.2616"></a><span id="l3.2616">   // (we can't use &quot;hidden&quot; since class=&quot;hide-in-IM&quot; CSS rule interferes)</span>
<a href="#l3.2617"></a><span id="l3.2617"> </span>
<a href="#l3.2618"></a><span id="l3.2618" class="difflineminus">-   // if no find, remove find ui</span>
<a href="#l3.2619"></a><span id="l3.2619" class="difflineplus">+  // if no find, remove find ui</span>
<a href="#l3.2620"></a><span id="l3.2620">   if (!IsFindInstalled()) {</span>
<a href="#l3.2621"></a><span id="l3.2621">     HideItem(&quot;menu_find&quot;);</span>
<a href="#l3.2622"></a><span id="l3.2622">     HideItem(&quot;menu_findnext&quot;);</span>
<a href="#l3.2623"></a><span id="l3.2623">     HideItem(&quot;menu_replace&quot;);</span>
<a href="#l3.2624"></a><span id="l3.2624">     HideItem(&quot;menu_find&quot;);</span>
<a href="#l3.2625"></a><span id="l3.2625">     RemoveItem(&quot;sep_find&quot;);</span>
<a href="#l3.2626"></a><span id="l3.2626">   }</span>
<a href="#l3.2627"></a><span id="l3.2627"> </span>
<a href="#l3.2628"></a><span id="l3.2628" class="difflineminus">-   // if no spell checker, remove spell checker ui</span>
<a href="#l3.2629"></a><span id="l3.2629" class="difflineplus">+  // if no spell checker, remove spell checker ui</span>
<a href="#l3.2630"></a><span id="l3.2630">   if (!IsSpellCheckerInstalled()) {</span>
<a href="#l3.2631"></a><span id="l3.2631">     HideItem(&quot;spellingButton&quot;);</span>
<a href="#l3.2632"></a><span id="l3.2632">     HideItem(&quot;menu_checkspelling&quot;);</span>
<a href="#l3.2633"></a><span id="l3.2633">     RemoveItem(&quot;sep_checkspelling&quot;);</span>
<a href="#l3.2634"></a><span id="l3.2634">   }</span>
<a href="#l3.2635"></a><span id="l3.2635"> </span>
<a href="#l3.2636"></a><span id="l3.2636">   // Remove menu items (from overlay shared with HTML editor) in non-HTML.</span>
<a href="#l3.2637"></a><span id="l3.2637">   if (!IsHTMLEditor()) {</span>
<a href="#l3.2638"></a><span id="l3.2638" class="difflineat">@@ -2315,24 +2689,26 @@ function RemoveInapplicableUIElements() </span>
<a href="#l3.2639"></a><span id="l3.2639">     HideItem(&quot;fileExportToText&quot;);</span>
<a href="#l3.2640"></a><span id="l3.2640">     HideItem(&quot;viewFormatToolbar&quot;);</span>
<a href="#l3.2641"></a><span id="l3.2641">     HideItem(&quot;viewEditModeToolbar&quot;);</span>
<a href="#l3.2642"></a><span id="l3.2642">   }</span>
<a href="#l3.2643"></a><span id="l3.2643"> }</span>
<a href="#l3.2644"></a><span id="l3.2644"> </span>
<a href="#l3.2645"></a><span id="l3.2645"> function HideItem(id) {</span>
<a href="#l3.2646"></a><span id="l3.2646">   var item = document.getElementById(id);</span>
<a href="#l3.2647"></a><span id="l3.2647" class="difflineminus">-  if (item)</span>
<a href="#l3.2648"></a><span id="l3.2648" class="difflineplus">+  if (item) {</span>
<a href="#l3.2649"></a><span id="l3.2649">     item.hidden = true;</span>
<a href="#l3.2650"></a><span id="l3.2650" class="difflineplus">+  }</span>
<a href="#l3.2651"></a><span id="l3.2651"> }</span>
<a href="#l3.2652"></a><span id="l3.2652"> </span>
<a href="#l3.2653"></a><span id="l3.2653"> function RemoveItem(id) {</span>
<a href="#l3.2654"></a><span id="l3.2654">   var item = document.getElementById(id);</span>
<a href="#l3.2655"></a><span id="l3.2655" class="difflineminus">-  if (item)</span>
<a href="#l3.2656"></a><span id="l3.2656" class="difflineplus">+  if (item) {</span>
<a href="#l3.2657"></a><span id="l3.2657">     item.remove();</span>
<a href="#l3.2658"></a><span id="l3.2658" class="difflineplus">+  }</span>
<a href="#l3.2659"></a><span id="l3.2659"> }</span>
<a href="#l3.2660"></a><span id="l3.2660"> </span>
<a href="#l3.2661"></a><span id="l3.2661"> // Command Updating Strategy:</span>
<a href="#l3.2662"></a><span id="l3.2662"> //   Don't update on on selection change, only when menu is displayed,</span>
<a href="#l3.2663"></a><span id="l3.2663"> //   with this &quot;oncreate&quot; handler:</span>
<a href="#l3.2664"></a><span id="l3.2664"> function EditorInitTableMenu() {</span>
<a href="#l3.2665"></a><span id="l3.2665">   try {</span>
<a href="#l3.2666"></a><span id="l3.2666">     InitJoinCellMenuitem(&quot;menu_JoinTableCells&quot;);</span>
<a href="#l3.2667"></a><span id="l3.2667" class="difflineat">@@ -2345,61 +2721,83 @@ function EditorInitTableMenu() {</span>
<a href="#l3.2668"></a><span id="l3.2668"> function InitJoinCellMenuitem(id) {</span>
<a href="#l3.2669"></a><span id="l3.2669">   // Change text on the &quot;Join...&quot; item depending if we</span>
<a href="#l3.2670"></a><span id="l3.2670">   //   are joining selected cells or just cell to right</span>
<a href="#l3.2671"></a><span id="l3.2671">   // TODO: What to do about normal selection that crosses</span>
<a href="#l3.2672"></a><span id="l3.2672">   //       table border? Try to figure out all cells</span>
<a href="#l3.2673"></a><span id="l3.2673">   //       included in the selection?</span>
<a href="#l3.2674"></a><span id="l3.2674">   var menuText;</span>
<a href="#l3.2675"></a><span id="l3.2675">   var menuItem = document.getElementById(id);</span>
<a href="#l3.2676"></a><span id="l3.2676" class="difflineminus">-  if (!menuItem) return;</span>
<a href="#l3.2677"></a><span id="l3.2677" class="difflineplus">+  if (!menuItem) {</span>
<a href="#l3.2678"></a><span id="l3.2678" class="difflineplus">+    return;</span>
<a href="#l3.2679"></a><span id="l3.2679" class="difflineplus">+  }</span>
<a href="#l3.2680"></a><span id="l3.2680"> </span>
<a href="#l3.2681"></a><span id="l3.2681">   // Use &quot;Join selected cells if there's more than 1 cell selected</span>
<a href="#l3.2682"></a><span id="l3.2682">   var numSelected;</span>
<a href="#l3.2683"></a><span id="l3.2683">   var foundElement;</span>
<a href="#l3.2684"></a><span id="l3.2684"> </span>
<a href="#l3.2685"></a><span id="l3.2685">   try {</span>
<a href="#l3.2686"></a><span id="l3.2686">     var tagNameObj = {};</span>
<a href="#l3.2687"></a><span id="l3.2687" class="difflineminus">-    var countObj = {value: 0};</span>
<a href="#l3.2688"></a><span id="l3.2688" class="difflineminus">-    foundElement = GetCurrentTableEditor().getSelectedOrParentTableElement(tagNameObj, countObj);</span>
<a href="#l3.2689"></a><span id="l3.2689" class="difflineplus">+    var countObj = { value: 0 };</span>
<a href="#l3.2690"></a><span id="l3.2690" class="difflineplus">+    foundElement = GetCurrentTableEditor().getSelectedOrParentTableElement(</span>
<a href="#l3.2691"></a><span id="l3.2691" class="difflineplus">+      tagNameObj,</span>
<a href="#l3.2692"></a><span id="l3.2692" class="difflineplus">+      countObj</span>
<a href="#l3.2693"></a><span id="l3.2693" class="difflineplus">+    );</span>
<a href="#l3.2694"></a><span id="l3.2694">     numSelected = countObj.value;</span>
<a href="#l3.2695"></a><span id="l3.2695">   } catch (e) {}</span>
<a href="#l3.2696"></a><span id="l3.2696" class="difflineminus">-  if (foundElement &amp;&amp; numSelected &gt; 1)</span>
<a href="#l3.2697"></a><span id="l3.2697" class="difflineplus">+  if (foundElement &amp;&amp; numSelected &gt; 1) {</span>
<a href="#l3.2698"></a><span id="l3.2698">     menuText = GetString(&quot;JoinSelectedCells&quot;);</span>
<a href="#l3.2699"></a><span id="l3.2699" class="difflineminus">-  else</span>
<a href="#l3.2700"></a><span id="l3.2700" class="difflineplus">+  } else {</span>
<a href="#l3.2701"></a><span id="l3.2701">     menuText = GetString(&quot;JoinCellToRight&quot;);</span>
<a href="#l3.2702"></a><span id="l3.2702" class="difflineplus">+  }</span>
<a href="#l3.2703"></a><span id="l3.2703"> </span>
<a href="#l3.2704"></a><span id="l3.2704">   menuItem.setAttribute(&quot;label&quot;, menuText);</span>
<a href="#l3.2705"></a><span id="l3.2705">   menuItem.setAttribute(&quot;accesskey&quot;, GetString(&quot;JoinCellAccesskey&quot;));</span>
<a href="#l3.2706"></a><span id="l3.2706"> }</span>
<a href="#l3.2707"></a><span id="l3.2707"> </span>
<a href="#l3.2708"></a><span id="l3.2708" class="difflineminus">-function InitRemoveStylesMenuitems(removeStylesId, removeLinksId, removeNamedAnchorsId) {</span>
<a href="#l3.2709"></a><span id="l3.2709" class="difflineplus">+function InitRemoveStylesMenuitems(</span>
<a href="#l3.2710"></a><span id="l3.2710" class="difflineplus">+  removeStylesId,</span>
<a href="#l3.2711"></a><span id="l3.2711" class="difflineplus">+  removeLinksId,</span>
<a href="#l3.2712"></a><span id="l3.2712" class="difflineplus">+  removeNamedAnchorsId</span>
<a href="#l3.2713"></a><span id="l3.2713" class="difflineplus">+) {</span>
<a href="#l3.2714"></a><span id="l3.2714">   var editor = GetCurrentEditor();</span>
<a href="#l3.2715"></a><span id="l3.2715" class="difflineminus">-  if (!editor)</span>
<a href="#l3.2716"></a><span id="l3.2716" class="difflineplus">+  if (!editor) {</span>
<a href="#l3.2717"></a><span id="l3.2717">     return;</span>
<a href="#l3.2718"></a><span id="l3.2718" class="difflineplus">+  }</span>
<a href="#l3.2719"></a><span id="l3.2719"> </span>
<a href="#l3.2720"></a><span id="l3.2720">   // Change wording of menuitems depending on selection</span>
<a href="#l3.2721"></a><span id="l3.2721">   var stylesItem = document.getElementById(removeStylesId);</span>
<a href="#l3.2722"></a><span id="l3.2722">   var linkItem = document.getElementById(removeLinksId);</span>
<a href="#l3.2723"></a><span id="l3.2723"> </span>
<a href="#l3.2724"></a><span id="l3.2724">   var isCollapsed = editor.selection.isCollapsed;</span>
<a href="#l3.2725"></a><span id="l3.2725">   if (stylesItem) {</span>
<a href="#l3.2726"></a><span id="l3.2726" class="difflineminus">-    stylesItem.setAttribute(&quot;label&quot;, isCollapsed ? GetString(&quot;StopTextStyles&quot;) : GetString(&quot;RemoveTextStyles&quot;));</span>
<a href="#l3.2727"></a><span id="l3.2727" class="difflineminus">-    stylesItem.setAttribute(&quot;accesskey&quot;, GetString(&quot;RemoveTextStylesAccesskey&quot;));</span>
<a href="#l3.2728"></a><span id="l3.2728" class="difflineplus">+    stylesItem.setAttribute(</span>
<a href="#l3.2729"></a><span id="l3.2729" class="difflineplus">+      &quot;label&quot;,</span>
<a href="#l3.2730"></a><span id="l3.2730" class="difflineplus">+      isCollapsed ? GetString(&quot;StopTextStyles&quot;) : GetString(&quot;RemoveTextStyles&quot;)</span>
<a href="#l3.2731"></a><span id="l3.2731" class="difflineplus">+    );</span>
<a href="#l3.2732"></a><span id="l3.2732" class="difflineplus">+    stylesItem.setAttribute(</span>
<a href="#l3.2733"></a><span id="l3.2733" class="difflineplus">+      &quot;accesskey&quot;,</span>
<a href="#l3.2734"></a><span id="l3.2734" class="difflineplus">+      GetString(&quot;RemoveTextStylesAccesskey&quot;)</span>
<a href="#l3.2735"></a><span id="l3.2735" class="difflineplus">+    );</span>
<a href="#l3.2736"></a><span id="l3.2736">   }</span>
<a href="#l3.2737"></a><span id="l3.2737">   if (linkItem) {</span>
<a href="#l3.2738"></a><span id="l3.2738" class="difflineminus">-    linkItem.setAttribute(&quot;label&quot;, isCollapsed ? GetString(&quot;StopLinks&quot;) : GetString(&quot;RemoveLinks&quot;));</span>
<a href="#l3.2739"></a><span id="l3.2739" class="difflineplus">+    linkItem.setAttribute(</span>
<a href="#l3.2740"></a><span id="l3.2740" class="difflineplus">+      &quot;label&quot;,</span>
<a href="#l3.2741"></a><span id="l3.2741" class="difflineplus">+      isCollapsed ? GetString(&quot;StopLinks&quot;) : GetString(&quot;RemoveLinks&quot;)</span>
<a href="#l3.2742"></a><span id="l3.2742" class="difflineplus">+    );</span>
<a href="#l3.2743"></a><span id="l3.2743">     linkItem.setAttribute(&quot;accesskey&quot;, GetString(&quot;RemoveLinksAccesskey&quot;));</span>
<a href="#l3.2744"></a><span id="l3.2744">     // Note: disabling text style is a pain since there are so many - forget it!</span>
<a href="#l3.2745"></a><span id="l3.2745"> </span>
<a href="#l3.2746"></a><span id="l3.2746">     // Disable if not in a link, but always allow &quot;Remove&quot;</span>
<a href="#l3.2747"></a><span id="l3.2747">     //  if selection isn't collapsed since we only look at anchor node</span>
<a href="#l3.2748"></a><span id="l3.2748">     try {</span>
<a href="#l3.2749"></a><span id="l3.2749" class="difflineminus">-      SetElementEnabled(linkItem, !isCollapsed ||</span>
<a href="#l3.2750"></a><span id="l3.2750" class="difflineminus">-                      editor.getElementOrParentByTagName(&quot;href&quot;, null));</span>
<a href="#l3.2751"></a><span id="l3.2751" class="difflineplus">+      SetElementEnabled(</span>
<a href="#l3.2752"></a><span id="l3.2752" class="difflineplus">+        linkItem,</span>
<a href="#l3.2753"></a><span id="l3.2753" class="difflineplus">+        !isCollapsed || editor.getElementOrParentByTagName(&quot;href&quot;, null)</span>
<a href="#l3.2754"></a><span id="l3.2754" class="difflineplus">+      );</span>
<a href="#l3.2755"></a><span id="l3.2755">     } catch (e) {}</span>
<a href="#l3.2756"></a><span id="l3.2756">   }</span>
<a href="#l3.2757"></a><span id="l3.2757">   // Disable if selection is collapsed</span>
<a href="#l3.2758"></a><span id="l3.2758">   SetElementEnabledById(removeNamedAnchorsId, !isCollapsed);</span>
<a href="#l3.2759"></a><span id="l3.2759"> }</span>
<a href="#l3.2760"></a><span id="l3.2760"> </span>
<a href="#l3.2761"></a><span id="l3.2761"> function goUpdateTableMenuItems(commandset) {</span>
<a href="#l3.2762"></a><span id="l3.2762">   var editor = GetCurrentTableEditor();</span>
<a href="#l3.2763"></a><span id="l3.2763" class="difflineat">@@ -2407,228 +2805,279 @@ function goUpdateTableMenuItems(commands</span>
<a href="#l3.2764"></a><span id="l3.2764">     dump(&quot;goUpdateTableMenuItems: too early, not initialized\n&quot;);</span>
<a href="#l3.2765"></a><span id="l3.2765">     return;</span>
<a href="#l3.2766"></a><span id="l3.2766">   }</span>
<a href="#l3.2767"></a><span id="l3.2767"> </span>
<a href="#l3.2768"></a><span id="l3.2768">   var enabled = false;</span>
<a href="#l3.2769"></a><span id="l3.2769">   var enabledIfTable = false;</span>
<a href="#l3.2770"></a><span id="l3.2770"> </span>
<a href="#l3.2771"></a><span id="l3.2771">   var flags = editor.flags;</span>
<a href="#l3.2772"></a><span id="l3.2772" class="difflineminus">-  if (!(flags &amp; nsIPlaintextEditor.eEditorReadonlyMask) &amp;&amp;</span>
<a href="#l3.2773"></a><span id="l3.2773" class="difflineminus">-      IsEditingRenderedHTML()) {</span>
<a href="#l3.2774"></a><span id="l3.2774" class="difflineplus">+  if (</span>
<a href="#l3.2775"></a><span id="l3.2775" class="difflineplus">+    !(flags &amp; nsIPlaintextEditor.eEditorReadonlyMask) &amp;&amp;</span>
<a href="#l3.2776"></a><span id="l3.2776" class="difflineplus">+    IsEditingRenderedHTML()</span>
<a href="#l3.2777"></a><span id="l3.2777" class="difflineplus">+  ) {</span>
<a href="#l3.2778"></a><span id="l3.2778">     var tagNameObj = { value: &quot;&quot; };</span>
<a href="#l3.2779"></a><span id="l3.2779">     var element;</span>
<a href="#l3.2780"></a><span id="l3.2780">     try {</span>
<a href="#l3.2781"></a><span id="l3.2781" class="difflineminus">-      element = editor.getSelectedOrParentTableElement(tagNameObj, {value: 0});</span>
<a href="#l3.2782"></a><span id="l3.2782" class="difflineplus">+      element = editor.getSelectedOrParentTableElement(tagNameObj, {</span>
<a href="#l3.2783"></a><span id="l3.2783" class="difflineplus">+        value: 0,</span>
<a href="#l3.2784"></a><span id="l3.2784" class="difflineplus">+      });</span>
<a href="#l3.2785"></a><span id="l3.2785">     } catch (e) {}</span>
<a href="#l3.2786"></a><span id="l3.2786"> </span>
<a href="#l3.2787"></a><span id="l3.2787">     if (element) {</span>
<a href="#l3.2788"></a><span id="l3.2788">       // Value when we need to have a selected table or inside a table</span>
<a href="#l3.2789"></a><span id="l3.2789">       enabledIfTable = true;</span>
<a href="#l3.2790"></a><span id="l3.2790"> </span>
<a href="#l3.2791"></a><span id="l3.2791">       // All others require being inside a cell or selected cell</span>
<a href="#l3.2792"></a><span id="l3.2792" class="difflineminus">-      enabled = (tagNameObj.value == &quot;td&quot;);</span>
<a href="#l3.2793"></a><span id="l3.2793" class="difflineplus">+      enabled = tagNameObj.value == &quot;td&quot;;</span>
<a href="#l3.2794"></a><span id="l3.2794">     }</span>
<a href="#l3.2795"></a><span id="l3.2795">   }</span>
<a href="#l3.2796"></a><span id="l3.2796"> </span>
<a href="#l3.2797"></a><span id="l3.2797">   // Loop through command nodes</span>
<a href="#l3.2798"></a><span id="l3.2798">   for (var i = 0; i &lt; commandset.childNodes.length; i++) {</span>
<a href="#l3.2799"></a><span id="l3.2799">     var commandID = commandset.childNodes[i].getAttribute(&quot;id&quot;);</span>
<a href="#l3.2800"></a><span id="l3.2800">     if (commandID) {</span>
<a href="#l3.2801"></a><span id="l3.2801" class="difflineminus">-      if (commandID == &quot;cmd_InsertTable&quot; ||</span>
<a href="#l3.2802"></a><span id="l3.2802" class="difflineminus">-          commandID == &quot;cmd_JoinTableCells&quot; ||</span>
<a href="#l3.2803"></a><span id="l3.2803" class="difflineminus">-          commandID == &quot;cmd_SplitTableCell&quot; ||</span>
<a href="#l3.2804"></a><span id="l3.2804" class="difflineminus">-          commandID == &quot;cmd_ConvertToTable&quot;) {</span>
<a href="#l3.2805"></a><span id="l3.2805" class="difflineplus">+      if (</span>
<a href="#l3.2806"></a><span id="l3.2806" class="difflineplus">+        commandID == &quot;cmd_InsertTable&quot; ||</span>
<a href="#l3.2807"></a><span id="l3.2807" class="difflineplus">+        commandID == &quot;cmd_JoinTableCells&quot; ||</span>
<a href="#l3.2808"></a><span id="l3.2808" class="difflineplus">+        commandID == &quot;cmd_SplitTableCell&quot; ||</span>
<a href="#l3.2809"></a><span id="l3.2809" class="difflineplus">+        commandID == &quot;cmd_ConvertToTable&quot;</span>
<a href="#l3.2810"></a><span id="l3.2810" class="difflineplus">+      ) {</span>
<a href="#l3.2811"></a><span id="l3.2811">         // Call the update method in the command class</span>
<a href="#l3.2812"></a><span id="l3.2812">         goUpdateCommand(commandID);</span>
<a href="#l3.2813"></a><span id="l3.2813" class="difflineminus">-      } else if (commandID == &quot;cmd_DeleteTable&quot; ||</span>
<a href="#l3.2814"></a><span id="l3.2814" class="difflineminus">-                 commandID == &quot;cmd_NormalizeTable&quot; ||</span>
<a href="#l3.2815"></a><span id="l3.2815" class="difflineminus">-                 commandID == &quot;cmd_editTable&quot; ||</span>
<a href="#l3.2816"></a><span id="l3.2816" class="difflineminus">-                 commandID == &quot;cmd_TableOrCellColor&quot; ||</span>
<a href="#l3.2817"></a><span id="l3.2817" class="difflineminus">-                 commandID == &quot;cmd_SelectTable&quot;) { // Directly set with the values calculated here</span>
<a href="#l3.2818"></a><span id="l3.2818" class="difflineplus">+      } else if (</span>
<a href="#l3.2819"></a><span id="l3.2819" class="difflineplus">+        commandID == &quot;cmd_DeleteTable&quot; ||</span>
<a href="#l3.2820"></a><span id="l3.2820" class="difflineplus">+        commandID == &quot;cmd_NormalizeTable&quot; ||</span>
<a href="#l3.2821"></a><span id="l3.2821" class="difflineplus">+        commandID == &quot;cmd_editTable&quot; ||</span>
<a href="#l3.2822"></a><span id="l3.2822" class="difflineplus">+        commandID == &quot;cmd_TableOrCellColor&quot; ||</span>
<a href="#l3.2823"></a><span id="l3.2823" class="difflineplus">+        commandID == &quot;cmd_SelectTable&quot;</span>
<a href="#l3.2824"></a><span id="l3.2824" class="difflineplus">+      ) {</span>
<a href="#l3.2825"></a><span id="l3.2825" class="difflineplus">+        // Directly set with the values calculated here</span>
<a href="#l3.2826"></a><span id="l3.2826">         goSetCommandEnabled(commandID, enabledIfTable);</span>
<a href="#l3.2827"></a><span id="l3.2827">       } else {</span>
<a href="#l3.2828"></a><span id="l3.2828">         goSetCommandEnabled(commandID, enabled);</span>
<a href="#l3.2829"></a><span id="l3.2829">       }</span>
<a href="#l3.2830"></a><span id="l3.2830">     }</span>
<a href="#l3.2831"></a><span id="l3.2831">   }</span>
<a href="#l3.2832"></a><span id="l3.2832"> }</span>
<a href="#l3.2833"></a><span id="l3.2833"> </span>
<a href="#l3.2834"></a><span id="l3.2834"> // -----------------------------------------------------------------------------------</span>
<a href="#l3.2835"></a><span id="l3.2835"> // Helpers for inserting and editing tables:</span>
<a href="#l3.2836"></a><span id="l3.2836"> </span>
<a href="#l3.2837"></a><span id="l3.2837"> function IsInTable() {</span>
<a href="#l3.2838"></a><span id="l3.2838">   var editor = GetCurrentEditor();</span>
<a href="#l3.2839"></a><span id="l3.2839">   try {</span>
<a href="#l3.2840"></a><span id="l3.2840">     var flags = editor.flags;</span>
<a href="#l3.2841"></a><span id="l3.2841" class="difflineminus">-    return (IsHTMLEditor() &amp;&amp;</span>
<a href="#l3.2842"></a><span id="l3.2842" class="difflineminus">-            !(flags &amp; nsIPlaintextEditor.eEditorReadonlyMask) &amp;&amp;</span>
<a href="#l3.2843"></a><span id="l3.2843" class="difflineminus">-            IsEditingRenderedHTML() &amp;&amp;</span>
<a href="#l3.2844"></a><span id="l3.2844" class="difflineminus">-            null != editor.getElementOrParentByTagName(&quot;table&quot;, null));</span>
<a href="#l3.2845"></a><span id="l3.2845" class="difflineplus">+    return (</span>
<a href="#l3.2846"></a><span id="l3.2846" class="difflineplus">+      IsHTMLEditor() &amp;&amp;</span>
<a href="#l3.2847"></a><span id="l3.2847" class="difflineplus">+      !(flags &amp; nsIPlaintextEditor.eEditorReadonlyMask) &amp;&amp;</span>
<a href="#l3.2848"></a><span id="l3.2848" class="difflineplus">+      IsEditingRenderedHTML() &amp;&amp;</span>
<a href="#l3.2849"></a><span id="l3.2849" class="difflineplus">+      null != editor.getElementOrParentByTagName(&quot;table&quot;, null)</span>
<a href="#l3.2850"></a><span id="l3.2850" class="difflineplus">+    );</span>
<a href="#l3.2851"></a><span id="l3.2851">   } catch (e) {}</span>
<a href="#l3.2852"></a><span id="l3.2852">   return false;</span>
<a href="#l3.2853"></a><span id="l3.2853"> }</span>
<a href="#l3.2854"></a><span id="l3.2854"> </span>
<a href="#l3.2855"></a><span id="l3.2855"> function IsInTableCell() {</span>
<a href="#l3.2856"></a><span id="l3.2856">   try {</span>
<a href="#l3.2857"></a><span id="l3.2857">     var editor = GetCurrentEditor();</span>
<a href="#l3.2858"></a><span id="l3.2858">     var flags = editor.flags;</span>
<a href="#l3.2859"></a><span id="l3.2859" class="difflineminus">-    return (IsHTMLEditor() &amp;&amp;</span>
<a href="#l3.2860"></a><span id="l3.2860" class="difflineminus">-            !(flags &amp; nsIPlaintextEditor.eEditorReadonlyMask) &amp;&amp;</span>
<a href="#l3.2861"></a><span id="l3.2861" class="difflineminus">-            IsEditingRenderedHTML() &amp;&amp;</span>
<a href="#l3.2862"></a><span id="l3.2862" class="difflineminus">-            null != editor.getElementOrParentByTagName(&quot;td&quot;, null));</span>
<a href="#l3.2863"></a><span id="l3.2863" class="difflineplus">+    return (</span>
<a href="#l3.2864"></a><span id="l3.2864" class="difflineplus">+      IsHTMLEditor() &amp;&amp;</span>
<a href="#l3.2865"></a><span id="l3.2865" class="difflineplus">+      !(flags &amp; nsIPlaintextEditor.eEditorReadonlyMask) &amp;&amp;</span>
<a href="#l3.2866"></a><span id="l3.2866" class="difflineplus">+      IsEditingRenderedHTML() &amp;&amp;</span>
<a href="#l3.2867"></a><span id="l3.2867" class="difflineplus">+      null != editor.getElementOrParentByTagName(&quot;td&quot;, null)</span>
<a href="#l3.2868"></a><span id="l3.2868" class="difflineplus">+    );</span>
<a href="#l3.2869"></a><span id="l3.2869">   } catch (e) {}</span>
<a href="#l3.2870"></a><span id="l3.2870">   return false;</span>
<a href="#l3.2871"></a><span id="l3.2871"> }</span>
<a href="#l3.2872"></a><span id="l3.2872"> </span>
<a href="#l3.2873"></a><span id="l3.2873"> function IsSelectionInOneCell() {</span>
<a href="#l3.2874"></a><span id="l3.2874">   try {</span>
<a href="#l3.2875"></a><span id="l3.2875">     var editor = GetCurrentEditor();</span>
<a href="#l3.2876"></a><span id="l3.2876">     var selection = editor.selection;</span>
<a href="#l3.2877"></a><span id="l3.2877"> </span>
<a href="#l3.2878"></a><span id="l3.2878">     if (selection.rangeCount == 1) {</span>
<a href="#l3.2879"></a><span id="l3.2879">       // We have a &quot;normal&quot; single-range selection</span>
<a href="#l3.2880"></a><span id="l3.2880" class="difflineminus">-      if (!selection.isCollapsed &amp;&amp;</span>
<a href="#l3.2881"></a><span id="l3.2881" class="difflineminus">-         selection.anchorNode != selection.focusNode) {</span>
<a href="#l3.2882"></a><span id="l3.2882" class="difflineplus">+      if (</span>
<a href="#l3.2883"></a><span id="l3.2883" class="difflineplus">+        !selection.isCollapsed &amp;&amp;</span>
<a href="#l3.2884"></a><span id="l3.2884" class="difflineplus">+        selection.anchorNode != selection.focusNode</span>
<a href="#l3.2885"></a><span id="l3.2885" class="difflineplus">+      ) {</span>
<a href="#l3.2886"></a><span id="l3.2886">         // Check if both nodes are within the same cell</span>
<a href="#l3.2887"></a><span id="l3.2887" class="difflineminus">-        var anchorCell = editor.getElementOrParentByTagName(&quot;td&quot;, selection.anchorNode);</span>
<a href="#l3.2888"></a><span id="l3.2888" class="difflineminus">-        var focusCell = editor.getElementOrParentByTagName(&quot;td&quot;, selection.focusNode);</span>
<a href="#l3.2889"></a><span id="l3.2889" class="difflineminus">-        return (focusCell != null &amp;&amp; anchorCell != null &amp;&amp; (focusCell == anchorCell));</span>
<a href="#l3.2890"></a><span id="l3.2890" class="difflineplus">+        var anchorCell = editor.getElementOrParentByTagName(</span>
<a href="#l3.2891"></a><span id="l3.2891" class="difflineplus">+          &quot;td&quot;,</span>
<a href="#l3.2892"></a><span id="l3.2892" class="difflineplus">+          selection.anchorNode</span>
<a href="#l3.2893"></a><span id="l3.2893" class="difflineplus">+        );</span>
<a href="#l3.2894"></a><span id="l3.2894" class="difflineplus">+        var focusCell = editor.getElementOrParentByTagName(</span>
<a href="#l3.2895"></a><span id="l3.2895" class="difflineplus">+          &quot;td&quot;,</span>
<a href="#l3.2896"></a><span id="l3.2896" class="difflineplus">+          selection.focusNode</span>
<a href="#l3.2897"></a><span id="l3.2897" class="difflineplus">+        );</span>
<a href="#l3.2898"></a><span id="l3.2898" class="difflineplus">+        return (</span>
<a href="#l3.2899"></a><span id="l3.2899" class="difflineplus">+          focusCell != null &amp;&amp; anchorCell != null &amp;&amp; focusCell == anchorCell</span>
<a href="#l3.2900"></a><span id="l3.2900" class="difflineplus">+        );</span>
<a href="#l3.2901"></a><span id="l3.2901">       }</span>
<a href="#l3.2902"></a><span id="l3.2902">       // Collapsed selection or anchor == focus (thus must be in 1 cell)</span>
<a href="#l3.2903"></a><span id="l3.2903">       return true;</span>
<a href="#l3.2904"></a><span id="l3.2904">     }</span>
<a href="#l3.2905"></a><span id="l3.2905">   } catch (e) {}</span>
<a href="#l3.2906"></a><span id="l3.2906">   return false;</span>
<a href="#l3.2907"></a><span id="l3.2907"> }</span>
<a href="#l3.2908"></a><span id="l3.2908"> </span>
<a href="#l3.2909"></a><span id="l3.2909"> // Call this with insertAllowed = true to allow inserting if not in existing table,</span>
<a href="#l3.2910"></a><span id="l3.2910"> //   else use false to do nothing if not in a table</span>
<a href="#l3.2911"></a><span id="l3.2911"> function EditorInsertOrEditTable(insertAllowed) {</span>
<a href="#l3.2912"></a><span id="l3.2912">   if (IsInTable()) {</span>
<a href="#l3.2913"></a><span id="l3.2913">     // Edit properties of existing table</span>
<a href="#l3.2914"></a><span id="l3.2914" class="difflineminus">-    window.openDialog(&quot;chrome://editor/content/EdTableProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, &quot;&quot;, &quot;TablePanel&quot;);</span>
<a href="#l3.2915"></a><span id="l3.2915" class="difflineplus">+    window.openDialog(</span>
<a href="#l3.2916"></a><span id="l3.2916" class="difflineplus">+      &quot;chrome://editor/content/EdTableProps.xul&quot;,</span>
<a href="#l3.2917"></a><span id="l3.2917" class="difflineplus">+      &quot;_blank&quot;,</span>
<a href="#l3.2918"></a><span id="l3.2918" class="difflineplus">+      &quot;chrome,close,titlebar,modal&quot;,</span>
<a href="#l3.2919"></a><span id="l3.2919" class="difflineplus">+      &quot;&quot;,</span>
<a href="#l3.2920"></a><span id="l3.2920" class="difflineplus">+      &quot;TablePanel&quot;</span>
<a href="#l3.2921"></a><span id="l3.2921" class="difflineplus">+    );</span>
<a href="#l3.2922"></a><span id="l3.2922">     gContentWindow.focus();</span>
<a href="#l3.2923"></a><span id="l3.2923">   } else if (insertAllowed) {</span>
<a href="#l3.2924"></a><span id="l3.2924">     try {</span>
<a href="#l3.2925"></a><span id="l3.2925" class="difflineminus">-      if (GetCurrentEditor().selection.isCollapsed)</span>
<a href="#l3.2926"></a><span id="l3.2926" class="difflineplus">+      if (GetCurrentEditor().selection.isCollapsed) {</span>
<a href="#l3.2927"></a><span id="l3.2927">         // If we have a caret, insert a blank table...</span>
<a href="#l3.2928"></a><span id="l3.2928">         EditorInsertTable();</span>
<a href="#l3.2929"></a><span id="l3.2929" class="difflineminus">-      else</span>
<a href="#l3.2930"></a><span id="l3.2930" class="difflineminus">-        // else convert the selection into a table</span>
<a href="#l3.2931"></a><span id="l3.2931" class="difflineplus">+      }</span>
<a href="#l3.2932"></a><span id="l3.2932" class="difflineplus">+      // else convert the selection into a table</span>
<a href="#l3.2933"></a><span id="l3.2933" class="difflineplus">+      else {</span>
<a href="#l3.2934"></a><span id="l3.2934">         goDoCommand(&quot;cmd_ConvertToTable&quot;);</span>
<a href="#l3.2935"></a><span id="l3.2935" class="difflineplus">+      }</span>
<a href="#l3.2936"></a><span id="l3.2936">     } catch (e) {}</span>
<a href="#l3.2937"></a><span id="l3.2937">   }</span>
<a href="#l3.2938"></a><span id="l3.2938"> }</span>
<a href="#l3.2939"></a><span id="l3.2939"> </span>
<a href="#l3.2940"></a><span id="l3.2940"> function EditorInsertTable() {</span>
<a href="#l3.2941"></a><span id="l3.2941">   // Insert a new table</span>
<a href="#l3.2942"></a><span id="l3.2942" class="difflineminus">-  window.openDialog(&quot;chrome://editor/content/EdInsertTable.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, &quot;&quot;);</span>
<a href="#l3.2943"></a><span id="l3.2943" class="difflineplus">+  window.openDialog(</span>
<a href="#l3.2944"></a><span id="l3.2944" class="difflineplus">+    &quot;chrome://editor/content/EdInsertTable.xul&quot;,</span>
<a href="#l3.2945"></a><span id="l3.2945" class="difflineplus">+    &quot;_blank&quot;,</span>
<a href="#l3.2946"></a><span id="l3.2946" class="difflineplus">+    &quot;chrome,close,titlebar,modal&quot;,</span>
<a href="#l3.2947"></a><span id="l3.2947" class="difflineplus">+    &quot;&quot;</span>
<a href="#l3.2948"></a><span id="l3.2948" class="difflineplus">+  );</span>
<a href="#l3.2949"></a><span id="l3.2949">   gContentWindow.focus();</span>
<a href="#l3.2950"></a><span id="l3.2950"> }</span>
<a href="#l3.2951"></a><span id="l3.2951"> </span>
<a href="#l3.2952"></a><span id="l3.2952"> function EditorTableCellProperties() {</span>
<a href="#l3.2953"></a><span id="l3.2953" class="difflineminus">-  if (!IsHTMLEditor())</span>
<a href="#l3.2954"></a><span id="l3.2954" class="difflineplus">+  if (!IsHTMLEditor()) {</span>
<a href="#l3.2955"></a><span id="l3.2955">     return;</span>
<a href="#l3.2956"></a><span id="l3.2956" class="difflineplus">+  }</span>
<a href="#l3.2957"></a><span id="l3.2957"> </span>
<a href="#l3.2958"></a><span id="l3.2958">   try {</span>
<a href="#l3.2959"></a><span id="l3.2959">     var cell = GetCurrentEditor().getElementOrParentByTagName(&quot;td&quot;, null);</span>
<a href="#l3.2960"></a><span id="l3.2960">     if (cell) {</span>
<a href="#l3.2961"></a><span id="l3.2961">       // Start Table Properties dialog on the &quot;Cell&quot; panel</span>
<a href="#l3.2962"></a><span id="l3.2962" class="difflineminus">-      window.openDialog(&quot;chrome://editor/content/EdTableProps.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, &quot;&quot;, &quot;CellPanel&quot;);</span>
<a href="#l3.2963"></a><span id="l3.2963" class="difflineplus">+      window.openDialog(</span>
<a href="#l3.2964"></a><span id="l3.2964" class="difflineplus">+        &quot;chrome://editor/content/EdTableProps.xul&quot;,</span>
<a href="#l3.2965"></a><span id="l3.2965" class="difflineplus">+        &quot;_blank&quot;,</span>
<a href="#l3.2966"></a><span id="l3.2966" class="difflineplus">+        &quot;chrome,close,titlebar,modal&quot;,</span>
<a href="#l3.2967"></a><span id="l3.2967" class="difflineplus">+        &quot;&quot;,</span>
<a href="#l3.2968"></a><span id="l3.2968" class="difflineplus">+        &quot;CellPanel&quot;</span>
<a href="#l3.2969"></a><span id="l3.2969" class="difflineplus">+      );</span>
<a href="#l3.2970"></a><span id="l3.2970">       gContentWindow.focus();</span>
<a href="#l3.2971"></a><span id="l3.2971">     }</span>
<a href="#l3.2972"></a><span id="l3.2972">   } catch (e) {}</span>
<a href="#l3.2973"></a><span id="l3.2973"> }</span>
<a href="#l3.2974"></a><span id="l3.2974"> </span>
<a href="#l3.2975"></a><span id="l3.2975"> function GetNumberOfContiguousSelectedRows() {</span>
<a href="#l3.2976"></a><span id="l3.2976" class="difflineminus">-  if (!IsHTMLEditor())</span>
<a href="#l3.2977"></a><span id="l3.2977" class="difflineplus">+  if (!IsHTMLEditor()) {</span>
<a href="#l3.2978"></a><span id="l3.2978">     return 0;</span>
<a href="#l3.2979"></a><span id="l3.2979" class="difflineplus">+  }</span>
<a href="#l3.2980"></a><span id="l3.2980"> </span>
<a href="#l3.2981"></a><span id="l3.2981">   var rows = 0;</span>
<a href="#l3.2982"></a><span id="l3.2982">   try {</span>
<a href="#l3.2983"></a><span id="l3.2983">     var editor = GetCurrentTableEditor();</span>
<a href="#l3.2984"></a><span id="l3.2984">     var rowObj = { value: 0 };</span>
<a href="#l3.2985"></a><span id="l3.2985">     var colObj = { value: 0 };</span>
<a href="#l3.2986"></a><span id="l3.2986">     var cell = editor.getFirstSelectedCellInTable(rowObj, colObj);</span>
<a href="#l3.2987"></a><span id="l3.2987" class="difflineminus">-    if (!cell)</span>
<a href="#l3.2988"></a><span id="l3.2988" class="difflineplus">+    if (!cell) {</span>
<a href="#l3.2989"></a><span id="l3.2989">       return 0;</span>
<a href="#l3.2990"></a><span id="l3.2990" class="difflineplus">+    }</span>
<a href="#l3.2991"></a><span id="l3.2991"> </span>
<a href="#l3.2992"></a><span id="l3.2992">     // We have at least one row</span>
<a href="#l3.2993"></a><span id="l3.2993">     rows++;</span>
<a href="#l3.2994"></a><span id="l3.2994"> </span>
<a href="#l3.2995"></a><span id="l3.2995">     var lastIndex = rowObj.value;</span>
<a href="#l3.2996"></a><span id="l3.2996">     do {</span>
<a href="#l3.2997"></a><span id="l3.2997" class="difflineminus">-      cell = editor.getNextSelectedCell({value: 0});</span>
<a href="#l3.2998"></a><span id="l3.2998" class="difflineplus">+      cell = editor.getNextSelectedCell({ value: 0 });</span>
<a href="#l3.2999"></a><span id="l3.2999">       if (cell) {</span>
<a href="#l3.3000"></a><span id="l3.3000">         editor.getCellIndexes(cell, rowObj, colObj);</span>
<a href="#l3.3001"></a><span id="l3.3001">         var index = rowObj.value;</span>
<a href="#l3.3002"></a><span id="l3.3002">         if (index == lastIndex + 1) {</span>
<a href="#l3.3003"></a><span id="l3.3003">           lastIndex = index;</span>
<a href="#l3.3004"></a><span id="l3.3004">           rows++;</span>
<a href="#l3.3005"></a><span id="l3.3005">         }</span>
<a href="#l3.3006"></a><span id="l3.3006">       }</span>
<a href="#l3.3007"></a><span id="l3.3007" class="difflineminus">-    }</span>
<a href="#l3.3008"></a><span id="l3.3008" class="difflineminus">-    while (cell);</span>
<a href="#l3.3009"></a><span id="l3.3009" class="difflineplus">+    } while (cell);</span>
<a href="#l3.3010"></a><span id="l3.3010">   } catch (e) {}</span>
<a href="#l3.3011"></a><span id="l3.3011"> </span>
<a href="#l3.3012"></a><span id="l3.3012">   return rows;</span>
<a href="#l3.3013"></a><span id="l3.3013"> }</span>
<a href="#l3.3014"></a><span id="l3.3014"> </span>
<a href="#l3.3015"></a><span id="l3.3015"> function GetNumberOfContiguousSelectedColumns() {</span>
<a href="#l3.3016"></a><span id="l3.3016" class="difflineminus">-  if (!IsHTMLEditor())</span>
<a href="#l3.3017"></a><span id="l3.3017" class="difflineplus">+  if (!IsHTMLEditor()) {</span>
<a href="#l3.3018"></a><span id="l3.3018">     return 0;</span>
<a href="#l3.3019"></a><span id="l3.3019" class="difflineplus">+  }</span>
<a href="#l3.3020"></a><span id="l3.3020"> </span>
<a href="#l3.3021"></a><span id="l3.3021">   var columns = 0;</span>
<a href="#l3.3022"></a><span id="l3.3022">   try {</span>
<a href="#l3.3023"></a><span id="l3.3023">     var editor = GetCurrentTableEditor();</span>
<a href="#l3.3024"></a><span id="l3.3024">     var colObj = { value: 0 };</span>
<a href="#l3.3025"></a><span id="l3.3025">     var rowObj = { value: 0 };</span>
<a href="#l3.3026"></a><span id="l3.3026">     var cell = editor.getFirstSelectedCellInTable(rowObj, colObj);</span>
<a href="#l3.3027"></a><span id="l3.3027" class="difflineminus">-    if (!cell)</span>
<a href="#l3.3028"></a><span id="l3.3028" class="difflineplus">+    if (!cell) {</span>
<a href="#l3.3029"></a><span id="l3.3029">       return 0;</span>
<a href="#l3.3030"></a><span id="l3.3030" class="difflineplus">+    }</span>
<a href="#l3.3031"></a><span id="l3.3031"> </span>
<a href="#l3.3032"></a><span id="l3.3032">     // We have at least one column</span>
<a href="#l3.3033"></a><span id="l3.3033">     columns++;</span>
<a href="#l3.3034"></a><span id="l3.3034"> </span>
<a href="#l3.3035"></a><span id="l3.3035">     var lastIndex = colObj.value;</span>
<a href="#l3.3036"></a><span id="l3.3036">     do {</span>
<a href="#l3.3037"></a><span id="l3.3037" class="difflineminus">-      cell = editor.getNextSelectedCell({value: 0});</span>
<a href="#l3.3038"></a><span id="l3.3038" class="difflineplus">+      cell = editor.getNextSelectedCell({ value: 0 });</span>
<a href="#l3.3039"></a><span id="l3.3039">       if (cell) {</span>
<a href="#l3.3040"></a><span id="l3.3040">         editor.getCellIndexes(cell, rowObj, colObj);</span>
<a href="#l3.3041"></a><span id="l3.3041">         var index = colObj.value;</span>
<a href="#l3.3042"></a><span id="l3.3042">         if (index == lastIndex + 1) {</span>
<a href="#l3.3043"></a><span id="l3.3043">           lastIndex = index;</span>
<a href="#l3.3044"></a><span id="l3.3044">           columns++;</span>
<a href="#l3.3045"></a><span id="l3.3045">         }</span>
<a href="#l3.3046"></a><span id="l3.3046">       }</span>
<a href="#l3.3047"></a><span id="l3.3047" class="difflineminus">-    }</span>
<a href="#l3.3048"></a><span id="l3.3048" class="difflineminus">-    while (cell);</span>
<a href="#l3.3049"></a><span id="l3.3049" class="difflineplus">+    } while (cell);</span>
<a href="#l3.3050"></a><span id="l3.3050">   } catch (e) {}</span>
<a href="#l3.3051"></a><span id="l3.3051"> </span>
<a href="#l3.3052"></a><span id="l3.3052">   return columns;</span>
<a href="#l3.3053"></a><span id="l3.3053"> }</span>
<a href="#l3.3054"></a><span id="l3.3054"> </span>
<a href="#l3.3055"></a><span id="l3.3055"> function EditorOnFocus() {</span>
<a href="#l3.3056"></a><span id="l3.3056">   // Current window already has the InsertCharWindow</span>
<a href="#l3.3057"></a><span id="l3.3057" class="difflineminus">-  if (&quot;InsertCharWindow&quot; in window &amp;&amp; window.InsertCharWindow) return;</span>
<a href="#l3.3058"></a><span id="l3.3058" class="difflineplus">+  if (&quot;InsertCharWindow&quot; in window &amp;&amp; window.InsertCharWindow) {</span>
<a href="#l3.3059"></a><span id="l3.3059" class="difflineplus">+    return;</span>
<a href="#l3.3060"></a><span id="l3.3060" class="difflineplus">+  }</span>
<a href="#l3.3061"></a><span id="l3.3061"> </span>
<a href="#l3.3062"></a><span id="l3.3062">   // Find window with an InsertCharsWindow and switch association to this one</span>
<a href="#l3.3063"></a><span id="l3.3063">   var windowWithDialog = FindEditorWithInsertCharDialog();</span>
<a href="#l3.3064"></a><span id="l3.3064">   if (windowWithDialog) {</span>
<a href="#l3.3065"></a><span id="l3.3065">     // Switch the dialog to current window</span>
<a href="#l3.3066"></a><span id="l3.3066">     // this sets focus to dialog, so bring focus back to editor window</span>
<a href="#l3.3067"></a><span id="l3.3067" class="difflineminus">-    if (SwitchInsertCharToThisWindow(windowWithDialog))</span>
<a href="#l3.3068"></a><span id="l3.3068" class="difflineplus">+    if (SwitchInsertCharToThisWindow(windowWithDialog)) {</span>
<a href="#l3.3069"></a><span id="l3.3069">       top.document.commandDispatcher.focusedWindow.focus();</span>
<a href="#l3.3070"></a><span id="l3.3070" class="difflineplus">+    }</span>
<a href="#l3.3071"></a><span id="l3.3071">   }</span>
<a href="#l3.3072"></a><span id="l3.3072"> }</span>
<a href="#l3.3073"></a><span id="l3.3073"> </span>
<a href="#l3.3074"></a><span id="l3.3074"> function SwitchInsertCharToThisWindow(windowWithDialog) {</span>
<a href="#l3.3075"></a><span id="l3.3075" class="difflineminus">-  if (windowWithDialog &amp;&amp; &quot;InsertCharWindow&quot; in windowWithDialog &amp;&amp;</span>
<a href="#l3.3076"></a><span id="l3.3076" class="difflineminus">-      windowWithDialog.InsertCharWindow) {</span>
<a href="#l3.3077"></a><span id="l3.3077" class="difflineplus">+  if (</span>
<a href="#l3.3078"></a><span id="l3.3078" class="difflineplus">+    windowWithDialog &amp;&amp;</span>
<a href="#l3.3079"></a><span id="l3.3079" class="difflineplus">+    &quot;InsertCharWindow&quot; in windowWithDialog &amp;&amp;</span>
<a href="#l3.3080"></a><span id="l3.3080" class="difflineplus">+    windowWithDialog.InsertCharWindow</span>
<a href="#l3.3081"></a><span id="l3.3081" class="difflineplus">+  ) {</span>
<a href="#l3.3082"></a><span id="l3.3082">     // Move dialog association to the current window</span>
<a href="#l3.3083"></a><span id="l3.3083">     window.InsertCharWindow = windowWithDialog.InsertCharWindow;</span>
<a href="#l3.3084"></a><span id="l3.3084">     windowWithDialog.InsertCharWindow = null;</span>
<a href="#l3.3085"></a><span id="l3.3085"> </span>
<a href="#l3.3086"></a><span id="l3.3086">     // Switch the dialog's opener to current window's</span>
<a href="#l3.3087"></a><span id="l3.3087">     window.InsertCharWindow.opener = window;</span>
<a href="#l3.3088"></a><span id="l3.3088"> </span>
<a href="#l3.3089"></a><span id="l3.3089">     // Bring dialog to the foreground</span>
<a href="#l3.3090"></a><span id="l3.3090" class="difflineat">@@ -2641,18 +3090,22 @@ function SwitchInsertCharToThisWindow(wi</span>
<a href="#l3.3091"></a><span id="l3.3091"> function FindEditorWithInsertCharDialog() {</span>
<a href="#l3.3092"></a><span id="l3.3092">   try {</span>
<a href="#l3.3093"></a><span id="l3.3093">     // Find window with an InsertCharsWindow and switch association to this one</span>
<a href="#l3.3094"></a><span id="l3.3094">     let enumerator = Services.wm.getEnumerator(null);</span>
<a href="#l3.3095"></a><span id="l3.3095"> </span>
<a href="#l3.3096"></a><span id="l3.3096">     while (enumerator.hasMoreElements()) {</span>
<a href="#l3.3097"></a><span id="l3.3097">       var tempWindow = enumerator.getNext();</span>
<a href="#l3.3098"></a><span id="l3.3098"> </span>
<a href="#l3.3099"></a><span id="l3.3099" class="difflineminus">-      if (!tempWindow.closed &amp;&amp; tempWindow != window &amp;&amp;</span>
<a href="#l3.3100"></a><span id="l3.3100" class="difflineminus">-          &quot;InsertCharWindow&quot; in tempWindow &amp;&amp; tempWindow.InsertCharWindow) {</span>
<a href="#l3.3101"></a><span id="l3.3101" class="difflineplus">+      if (</span>
<a href="#l3.3102"></a><span id="l3.3102" class="difflineplus">+        !tempWindow.closed &amp;&amp;</span>
<a href="#l3.3103"></a><span id="l3.3103" class="difflineplus">+        tempWindow != window &amp;&amp;</span>
<a href="#l3.3104"></a><span id="l3.3104" class="difflineplus">+        &quot;InsertCharWindow&quot; in tempWindow &amp;&amp;</span>
<a href="#l3.3105"></a><span id="l3.3105" class="difflineplus">+        tempWindow.InsertCharWindow</span>
<a href="#l3.3106"></a><span id="l3.3106" class="difflineplus">+      ) {</span>
<a href="#l3.3107"></a><span id="l3.3107">         return tempWindow;</span>
<a href="#l3.3108"></a><span id="l3.3108">       }</span>
<a href="#l3.3109"></a><span id="l3.3109">     }</span>
<a href="#l3.3110"></a><span id="l3.3110">   } catch (e) {}</span>
<a href="#l3.3111"></a><span id="l3.3111">   return null;</span>
<a href="#l3.3112"></a><span id="l3.3112"> }</span>
<a href="#l3.3113"></a><span id="l3.3113"> </span>
<a href="#l3.3114"></a><span id="l3.3114"> function EditorFindOrCreateInsertCharWindow() {</span>
<a href="#l3.3115"></a><span id="l3.3115" class="difflineat">@@ -2661,38 +3114,49 @@ function EditorFindOrCreateInsertCharWin</span>
<a href="#l3.3116"></a><span id="l3.3116">   } else {</span>
<a href="#l3.3117"></a><span id="l3.3117">     // Since we switch the dialog during EditorOnFocus(),</span>
<a href="#l3.3118"></a><span id="l3.3118">     //   this should really never be found, but it's good to be sure</span>
<a href="#l3.3119"></a><span id="l3.3119">     var windowWithDialog = FindEditorWithInsertCharDialog();</span>
<a href="#l3.3120"></a><span id="l3.3120">     if (windowWithDialog) {</span>
<a href="#l3.3121"></a><span id="l3.3121">       SwitchInsertCharToThisWindow(windowWithDialog);</span>
<a href="#l3.3122"></a><span id="l3.3122">     } else {</span>
<a href="#l3.3123"></a><span id="l3.3123">       // The dialog will set window.InsertCharWindow to itself</span>
<a href="#l3.3124"></a><span id="l3.3124" class="difflineminus">-      window.openDialog(&quot;chrome://editor/content/EdInsertChars.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar&quot;, &quot;&quot;);</span>
<a href="#l3.3125"></a><span id="l3.3125" class="difflineplus">+      window.openDialog(</span>
<a href="#l3.3126"></a><span id="l3.3126" class="difflineplus">+        &quot;chrome://editor/content/EdInsertChars.xul&quot;,</span>
<a href="#l3.3127"></a><span id="l3.3127" class="difflineplus">+        &quot;_blank&quot;,</span>
<a href="#l3.3128"></a><span id="l3.3128" class="difflineplus">+        &quot;chrome,close,titlebar&quot;,</span>
<a href="#l3.3129"></a><span id="l3.3129" class="difflineplus">+        &quot;&quot;</span>
<a href="#l3.3130"></a><span id="l3.3130" class="difflineplus">+      );</span>
<a href="#l3.3131"></a><span id="l3.3131">     }</span>
<a href="#l3.3132"></a><span id="l3.3132">   }</span>
<a href="#l3.3133"></a><span id="l3.3133"> }</span>
<a href="#l3.3134"></a><span id="l3.3134"> </span>
<a href="#l3.3135"></a><span id="l3.3135"> // Find another HTML editor window to associate with the InsertChar dialog</span>
<a href="#l3.3136"></a><span id="l3.3136"> //   or close it if none found  (May be a mail composer)</span>
<a href="#l3.3137"></a><span id="l3.3137"> function SwitchInsertCharToAnotherEditorOrClose() {</span>
<a href="#l3.3138"></a><span id="l3.3138">   if (&quot;InsertCharWindow&quot; in window &amp;&amp; window.InsertCharWindow) {</span>
<a href="#l3.3139"></a><span id="l3.3139">     var enumerator;</span>
<a href="#l3.3140"></a><span id="l3.3140">     try {</span>
<a href="#l3.3141"></a><span id="l3.3141">       enumerator = Services.wm.getEnumerator(null);</span>
<a href="#l3.3142"></a><span id="l3.3142">     } catch (e) {}</span>
<a href="#l3.3143"></a><span id="l3.3143" class="difflineminus">-    if (!enumerator) return;</span>
<a href="#l3.3144"></a><span id="l3.3144" class="difflineplus">+    if (!enumerator) {</span>
<a href="#l3.3145"></a><span id="l3.3145" class="difflineplus">+      return;</span>
<a href="#l3.3146"></a><span id="l3.3146" class="difflineplus">+    }</span>
<a href="#l3.3147"></a><span id="l3.3147"> </span>
<a href="#l3.3148"></a><span id="l3.3148">     // TODO: Fix this to search for command controllers and look for &quot;cmd_InsertChars&quot;</span>
<a href="#l3.3149"></a><span id="l3.3149">     // For now, detect just Web Composer and HTML Mail Composer</span>
<a href="#l3.3150"></a><span id="l3.3150">     while (enumerator.hasMoreElements()) {</span>
<a href="#l3.3151"></a><span id="l3.3151">       var tempWindow = enumerator.getNext();</span>
<a href="#l3.3152"></a><span id="l3.3152" class="difflineminus">-      if (!tempWindow.closed &amp;&amp; tempWindow != window &amp;&amp;</span>
<a href="#l3.3153"></a><span id="l3.3153" class="difflineminus">-          tempWindow != window.InsertCharWindow &amp;&amp;</span>
<a href="#l3.3154"></a><span id="l3.3154" class="difflineminus">-          &quot;GetCurrentEditor&quot; in tempWindow &amp;&amp; tempWindow.GetCurrentEditor()) {</span>
<a href="#l3.3155"></a><span id="l3.3155" class="difflineplus">+      if (</span>
<a href="#l3.3156"></a><span id="l3.3156" class="difflineplus">+        !tempWindow.closed &amp;&amp;</span>
<a href="#l3.3157"></a><span id="l3.3157" class="difflineplus">+        tempWindow != window &amp;&amp;</span>
<a href="#l3.3158"></a><span id="l3.3158" class="difflineplus">+        tempWindow != window.InsertCharWindow &amp;&amp;</span>
<a href="#l3.3159"></a><span id="l3.3159" class="difflineplus">+        &quot;GetCurrentEditor&quot; in tempWindow &amp;&amp;</span>
<a href="#l3.3160"></a><span id="l3.3160" class="difflineplus">+        tempWindow.GetCurrentEditor()</span>
<a href="#l3.3161"></a><span id="l3.3161" class="difflineplus">+      ) {</span>
<a href="#l3.3162"></a><span id="l3.3162">         tempWindow.InsertCharWindow = window.InsertCharWindow;</span>
<a href="#l3.3163"></a><span id="l3.3163">         window.InsertCharWindow = null;</span>
<a href="#l3.3164"></a><span id="l3.3164">         tempWindow.InsertCharWindow.opener = tempWindow;</span>
<a href="#l3.3165"></a><span id="l3.3165">         return;</span>
<a href="#l3.3166"></a><span id="l3.3166">       }</span>
<a href="#l3.3167"></a><span id="l3.3167">     }</span>
<a href="#l3.3168"></a><span id="l3.3168">     // Didn't find another editor - close the dialog</span>
<a href="#l3.3169"></a><span id="l3.3169">     window.InsertCharWindow.close();</span>
<a href="#l3.3170"></a><span id="l3.3170" class="difflineat">@@ -2700,44 +3164,59 @@ function SwitchInsertCharToAnotherEditor</span>
<a href="#l3.3171"></a><span id="l3.3171"> }</span>
<a href="#l3.3172"></a><span id="l3.3172"> </span>
<a href="#l3.3173"></a><span id="l3.3173"> function ResetStructToolbar() {</span>
<a href="#l3.3174"></a><span id="l3.3174">   gLastFocusNode = null;</span>
<a href="#l3.3175"></a><span id="l3.3175">   UpdateStructToolbar();</span>
<a href="#l3.3176"></a><span id="l3.3176"> }</span>
<a href="#l3.3177"></a><span id="l3.3177"> </span>
<a href="#l3.3178"></a><span id="l3.3178"> function newCommandListener(element) {</span>
<a href="#l3.3179"></a><span id="l3.3179" class="difflineminus">-  return function() { return SelectFocusNodeAncestor(element); };</span>
<a href="#l3.3180"></a><span id="l3.3180" class="difflineplus">+  return function() {</span>
<a href="#l3.3181"></a><span id="l3.3181" class="difflineplus">+    return SelectFocusNodeAncestor(element);</span>
<a href="#l3.3182"></a><span id="l3.3182" class="difflineplus">+  };</span>
<a href="#l3.3183"></a><span id="l3.3183"> }</span>
<a href="#l3.3184"></a><span id="l3.3184"> </span>
<a href="#l3.3185"></a><span id="l3.3185"> function newContextmenuListener(button, element) {</span>
<a href="#l3.3186"></a><span id="l3.3186" class="difflineminus">-  /* globals InitStructBarContextMenu */// SeaMonkey only.</span>
<a href="#l3.3187"></a><span id="l3.3187" class="difflineminus">-  return function() { return InitStructBarContextMenu(button, element); };</span>
<a href="#l3.3188"></a><span id="l3.3188" class="difflineplus">+  /* globals InitStructBarContextMenu */ // SeaMonkey only.</span>
<a href="#l3.3189"></a><span id="l3.3189" class="difflineplus">+  return function() {</span>
<a href="#l3.3190"></a><span id="l3.3190" class="difflineplus">+    return InitStructBarContextMenu(button, element);</span>
<a href="#l3.3191"></a><span id="l3.3191" class="difflineplus">+  };</span>
<a href="#l3.3192"></a><span id="l3.3192"> }</span>
<a href="#l3.3193"></a><span id="l3.3193"> </span>
<a href="#l3.3194"></a><span id="l3.3194"> function UpdateStructToolbar() {</span>
<a href="#l3.3195"></a><span id="l3.3195">   var editor = GetCurrentEditor();</span>
<a href="#l3.3196"></a><span id="l3.3196" class="difflineminus">-  if (!editor) return;</span>
<a href="#l3.3197"></a><span id="l3.3197" class="difflineplus">+  if (!editor) {</span>
<a href="#l3.3198"></a><span id="l3.3198" class="difflineplus">+    return;</span>
<a href="#l3.3199"></a><span id="l3.3199" class="difflineplus">+  }</span>
<a href="#l3.3200"></a><span id="l3.3200"> </span>
<a href="#l3.3201"></a><span id="l3.3201">   var mixed = GetSelectionContainer();</span>
<a href="#l3.3202"></a><span id="l3.3202" class="difflineminus">-  if (!mixed) return;</span>
<a href="#l3.3203"></a><span id="l3.3203" class="difflineplus">+  if (!mixed) {</span>
<a href="#l3.3204"></a><span id="l3.3204" class="difflineplus">+    return;</span>
<a href="#l3.3205"></a><span id="l3.3205" class="difflineplus">+  }</span>
<a href="#l3.3206"></a><span id="l3.3206">   var element = mixed.node;</span>
<a href="#l3.3207"></a><span id="l3.3207">   var oneElementSelected = mixed.oneElementSelected;</span>
<a href="#l3.3208"></a><span id="l3.3208"> </span>
<a href="#l3.3209"></a><span id="l3.3209" class="difflineminus">-  if (!element) return;</span>
<a href="#l3.3210"></a><span id="l3.3210" class="difflineminus">-</span>
<a href="#l3.3211"></a><span id="l3.3211" class="difflineminus">-  if (element == gLastFocusNode &amp;&amp;</span>
<a href="#l3.3212"></a><span id="l3.3212" class="difflineminus">-      oneElementSelected == gLastFocusNodeWasSelected)</span>
<a href="#l3.3213"></a><span id="l3.3213" class="difflineplus">+  if (!element) {</span>
<a href="#l3.3214"></a><span id="l3.3214">     return;</span>
<a href="#l3.3215"></a><span id="l3.3215" class="difflineplus">+  }</span>
<a href="#l3.3216"></a><span id="l3.3216" class="difflineplus">+</span>
<a href="#l3.3217"></a><span id="l3.3217" class="difflineplus">+  if (</span>
<a href="#l3.3218"></a><span id="l3.3218" class="difflineplus">+    element == gLastFocusNode &amp;&amp;</span>
<a href="#l3.3219"></a><span id="l3.3219" class="difflineplus">+    oneElementSelected == gLastFocusNodeWasSelected</span>
<a href="#l3.3220"></a><span id="l3.3220" class="difflineplus">+  ) {</span>
<a href="#l3.3221"></a><span id="l3.3221" class="difflineplus">+    return;</span>
<a href="#l3.3222"></a><span id="l3.3222" class="difflineplus">+  }</span>
<a href="#l3.3223"></a><span id="l3.3223"> </span>
<a href="#l3.3224"></a><span id="l3.3224">   gLastFocusNode = element;</span>
<a href="#l3.3225"></a><span id="l3.3225">   gLastFocusNodeWasSelected = mixed.oneElementSelected;</span>
<a href="#l3.3226"></a><span id="l3.3226"> </span>
<a href="#l3.3227"></a><span id="l3.3227">   var toolbar = document.getElementById(&quot;structToolbar&quot;);</span>
<a href="#l3.3228"></a><span id="l3.3228" class="difflineminus">-  if (!toolbar) return;</span>
<a href="#l3.3229"></a><span id="l3.3229" class="difflineplus">+  if (!toolbar) {</span>
<a href="#l3.3230"></a><span id="l3.3230" class="difflineplus">+    return;</span>
<a href="#l3.3231"></a><span id="l3.3231" class="difflineplus">+  }</span>
<a href="#l3.3232"></a><span id="l3.3232">   // We need to leave the &lt;label&gt; to flex the buttons to the left.</span>
<a href="#l3.3233"></a><span id="l3.3233">   for (let node of toolbar.querySelectorAll(&quot;toolbarbutton&quot;)) {</span>
<a href="#l3.3234"></a><span id="l3.3234">     node.remove();</span>
<a href="#l3.3235"></a><span id="l3.3235">   }</span>
<a href="#l3.3236"></a><span id="l3.3236"> </span>
<a href="#l3.3237"></a><span id="l3.3237">   toolbar.removeAttribute(&quot;label&quot;);</span>
<a href="#l3.3238"></a><span id="l3.3238"> </span>
<a href="#l3.3239"></a><span id="l3.3239">   if (IsInHTMLSourceMode()) {</span>
<a href="#l3.3240"></a><span id="l3.3240" class="difflineat">@@ -2759,47 +3238,55 @@ function UpdateStructToolbar() {</span>
<a href="#l3.3241"></a><span id="l3.3241">     button.setAttribute(&quot;value&quot;, tag);</span>
<a href="#l3.3242"></a><span id="l3.3242">     button.setAttribute(&quot;context&quot;, &quot;structToolbarContext&quot;);</span>
<a href="#l3.3243"></a><span id="l3.3243">     button.className = &quot;struct-button&quot;;</span>
<a href="#l3.3244"></a><span id="l3.3244"> </span>
<a href="#l3.3245"></a><span id="l3.3245">     toolbar.insertBefore(button, toolbar.firstChild);</span>
<a href="#l3.3246"></a><span id="l3.3246"> </span>
<a href="#l3.3247"></a><span id="l3.3247">     button.addEventListener(&quot;command&quot;, newCommandListener(element));</span>
<a href="#l3.3248"></a><span id="l3.3248"> </span>
<a href="#l3.3249"></a><span id="l3.3249" class="difflineminus">-    button.addEventListener(&quot;contextmenu&quot;, newContextmenuListener(button, element));</span>
<a href="#l3.3250"></a><span id="l3.3250" class="difflineplus">+    button.addEventListener(</span>
<a href="#l3.3251"></a><span id="l3.3251" class="difflineplus">+      &quot;contextmenu&quot;,</span>
<a href="#l3.3252"></a><span id="l3.3252" class="difflineplus">+      newContextmenuListener(button, element)</span>
<a href="#l3.3253"></a><span id="l3.3253" class="difflineplus">+    );</span>
<a href="#l3.3254"></a><span id="l3.3254"> </span>
<a href="#l3.3255"></a><span id="l3.3255">     if (isFocusNode &amp;&amp; oneElementSelected) {</span>
<a href="#l3.3256"></a><span id="l3.3256">       button.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l3.3257"></a><span id="l3.3257">       isFocusNode = false;</span>
<a href="#l3.3258"></a><span id="l3.3258">     }</span>
<a href="#l3.3259"></a><span id="l3.3259"> </span>
<a href="#l3.3260"></a><span id="l3.3260">     tmp = element;</span>
<a href="#l3.3261"></a><span id="l3.3261">     element = element.parentNode;</span>
<a href="#l3.3262"></a><span id="l3.3262">   } while (tmp != bodyElement);</span>
<a href="#l3.3263"></a><span id="l3.3263"> }</span>
<a href="#l3.3264"></a><span id="l3.3264"> </span>
<a href="#l3.3265"></a><span id="l3.3265"> function SelectFocusNodeAncestor(element) {</span>
<a href="#l3.3266"></a><span id="l3.3266">   var editor = GetCurrentEditor();</span>
<a href="#l3.3267"></a><span id="l3.3267">   if (editor) {</span>
<a href="#l3.3268"></a><span id="l3.3268" class="difflineminus">-    if (element == GetBodyElement())</span>
<a href="#l3.3269"></a><span id="l3.3269" class="difflineplus">+    if (element == GetBodyElement()) {</span>
<a href="#l3.3270"></a><span id="l3.3270">       editor.selectAll();</span>
<a href="#l3.3271"></a><span id="l3.3271" class="difflineminus">-    else</span>
<a href="#l3.3272"></a><span id="l3.3272" class="difflineplus">+    } else {</span>
<a href="#l3.3273"></a><span id="l3.3273">       editor.selectElement(element);</span>
<a href="#l3.3274"></a><span id="l3.3274" class="difflineplus">+    }</span>
<a href="#l3.3275"></a><span id="l3.3275">   }</span>
<a href="#l3.3276"></a><span id="l3.3276">   ResetStructToolbar();</span>
<a href="#l3.3277"></a><span id="l3.3277"> }</span>
<a href="#l3.3278"></a><span id="l3.3278"> </span>
<a href="#l3.3279"></a><span id="l3.3279"> function GetSelectionContainer() {</span>
<a href="#l3.3280"></a><span id="l3.3280">   var editor = GetCurrentEditor();</span>
<a href="#l3.3281"></a><span id="l3.3281" class="difflineminus">-  if (!editor) return null;</span>
<a href="#l3.3282"></a><span id="l3.3282" class="difflineplus">+  if (!editor) {</span>
<a href="#l3.3283"></a><span id="l3.3283" class="difflineplus">+    return null;</span>
<a href="#l3.3284"></a><span id="l3.3284" class="difflineplus">+  }</span>
<a href="#l3.3285"></a><span id="l3.3285"> </span>
<a href="#l3.3286"></a><span id="l3.3286">   var selection;</span>
<a href="#l3.3287"></a><span id="l3.3287">   try {</span>
<a href="#l3.3288"></a><span id="l3.3288">     selection = editor.selection;</span>
<a href="#l3.3289"></a><span id="l3.3289" class="difflineminus">-    if (!selection) return null;</span>
<a href="#l3.3290"></a><span id="l3.3290" class="difflineplus">+    if (!selection) {</span>
<a href="#l3.3291"></a><span id="l3.3291" class="difflineplus">+      return null;</span>
<a href="#l3.3292"></a><span id="l3.3292" class="difflineplus">+    }</span>
<a href="#l3.3293"></a><span id="l3.3293">   } catch (e) {</span>
<a href="#l3.3294"></a><span id="l3.3294">     return null;</span>
<a href="#l3.3295"></a><span id="l3.3295">   }</span>
<a href="#l3.3296"></a><span id="l3.3296"> </span>
<a href="#l3.3297"></a><span id="l3.3297">   var result = { oneElementSelected: false };</span>
<a href="#l3.3298"></a><span id="l3.3298"> </span>
<a href="#l3.3299"></a><span id="l3.3299">   if (selection.isCollapsed) {</span>
<a href="#l3.3300"></a><span id="l3.3300">     result.node = selection.focusNode;</span>
<a href="#l3.3301"></a><span id="l3.3301" class="difflineat">@@ -2809,59 +3296,67 @@ function GetSelectionContainer() {</span>
<a href="#l3.3302"></a><span id="l3.3302">       result.node = editor.getSelectedElement(&quot;&quot;);</span>
<a href="#l3.3303"></a><span id="l3.3303">       var range = selection.getRangeAt(0);</span>
<a href="#l3.3304"></a><span id="l3.3304"> </span>
<a href="#l3.3305"></a><span id="l3.3305">       // check for a weird case : when we select a piece of text inside</span>
<a href="#l3.3306"></a><span id="l3.3306">       // a text node and apply an inline style to it, the selection starts</span>
<a href="#l3.3307"></a><span id="l3.3307">       // at the end of the text node preceding the style and ends after the</span>
<a href="#l3.3308"></a><span id="l3.3308">       // last char of the style. Assume the style element is selected for</span>
<a href="#l3.3309"></a><span id="l3.3309">       // user's pleasure</span>
<a href="#l3.3310"></a><span id="l3.3310" class="difflineminus">-      if (!result.node &amp;&amp;</span>
<a href="#l3.3311"></a><span id="l3.3311" class="difflineminus">-          range.startContainer.nodeType == Node.TEXT_NODE &amp;&amp;</span>
<a href="#l3.3312"></a><span id="l3.3312" class="difflineminus">-          range.startOffset == range.startContainer.length &amp;&amp;</span>
<a href="#l3.3313"></a><span id="l3.3313" class="difflineminus">-          range.endContainer.nodeType == Node.TEXT_NODE &amp;&amp;</span>
<a href="#l3.3314"></a><span id="l3.3314" class="difflineminus">-          range.endOffset == range.endContainer.length &amp;&amp;</span>
<a href="#l3.3315"></a><span id="l3.3315" class="difflineminus">-          range.endContainer.nextSibling == null &amp;&amp;</span>
<a href="#l3.3316"></a><span id="l3.3316" class="difflineminus">-          range.startContainer.nextSibling == range.endContainer.parentNode)</span>
<a href="#l3.3317"></a><span id="l3.3317" class="difflineplus">+      if (</span>
<a href="#l3.3318"></a><span id="l3.3318" class="difflineplus">+        !result.node &amp;&amp;</span>
<a href="#l3.3319"></a><span id="l3.3319" class="difflineplus">+        range.startContainer.nodeType == Node.TEXT_NODE &amp;&amp;</span>
<a href="#l3.3320"></a><span id="l3.3320" class="difflineplus">+        range.startOffset == range.startContainer.length &amp;&amp;</span>
<a href="#l3.3321"></a><span id="l3.3321" class="difflineplus">+        range.endContainer.nodeType == Node.TEXT_NODE &amp;&amp;</span>
<a href="#l3.3322"></a><span id="l3.3322" class="difflineplus">+        range.endOffset == range.endContainer.length &amp;&amp;</span>
<a href="#l3.3323"></a><span id="l3.3323" class="difflineplus">+        range.endContainer.nextSibling == null &amp;&amp;</span>
<a href="#l3.3324"></a><span id="l3.3324" class="difflineplus">+        range.startContainer.nextSibling == range.endContainer.parentNode</span>
<a href="#l3.3325"></a><span id="l3.3325" class="difflineplus">+      ) {</span>
<a href="#l3.3326"></a><span id="l3.3326">         result.node = range.endContainer.parentNode;</span>
<a href="#l3.3327"></a><span id="l3.3327" class="difflineplus">+      }</span>
<a href="#l3.3328"></a><span id="l3.3328"> </span>
<a href="#l3.3329"></a><span id="l3.3329">       if (!result.node) {</span>
<a href="#l3.3330"></a><span id="l3.3330">         // let's rely on the common ancestor of the selection</span>
<a href="#l3.3331"></a><span id="l3.3331">         result.node = range.commonAncestorContainer;</span>
<a href="#l3.3332"></a><span id="l3.3332">       } else {</span>
<a href="#l3.3333"></a><span id="l3.3333">         result.oneElementSelected = true;</span>
<a href="#l3.3334"></a><span id="l3.3334">       }</span>
<a href="#l3.3335"></a><span id="l3.3335">     } else {</span>
<a href="#l3.3336"></a><span id="l3.3336">       // assume table cells !</span>
<a href="#l3.3337"></a><span id="l3.3337" class="difflineminus">-      var i, container = null;</span>
<a href="#l3.3338"></a><span id="l3.3338" class="difflineplus">+      var i,</span>
<a href="#l3.3339"></a><span id="l3.3339" class="difflineplus">+        container = null;</span>
<a href="#l3.3340"></a><span id="l3.3340">       for (i = 0; i &lt; rangeCount; i++) {</span>
<a href="#l3.3341"></a><span id="l3.3341">         range = selection.getRangeAt(i);</span>
<a href="#l3.3342"></a><span id="l3.3342">         if (!container) {</span>
<a href="#l3.3343"></a><span id="l3.3343">           container = range.startContainer;</span>
<a href="#l3.3344"></a><span id="l3.3344">         } else if (container != range.startContainer) {</span>
<a href="#l3.3345"></a><span id="l3.3345">           // all table cells don't belong to same row so let's</span>
<a href="#l3.3346"></a><span id="l3.3346">           // select the parent of all rows</span>
<a href="#l3.3347"></a><span id="l3.3347">           result.node = container.parentNode;</span>
<a href="#l3.3348"></a><span id="l3.3348">           break;</span>
<a href="#l3.3349"></a><span id="l3.3349">         }</span>
<a href="#l3.3350"></a><span id="l3.3350">         result.node = container;</span>
<a href="#l3.3351"></a><span id="l3.3351">       }</span>
<a href="#l3.3352"></a><span id="l3.3352">     }</span>
<a href="#l3.3353"></a><span id="l3.3353">   }</span>
<a href="#l3.3354"></a><span id="l3.3354"> </span>
<a href="#l3.3355"></a><span id="l3.3355">   // make sure we have an element here</span>
<a href="#l3.3356"></a><span id="l3.3356" class="difflineminus">-  while (result.node.nodeType != Node.ELEMENT_NODE)</span>
<a href="#l3.3357"></a><span id="l3.3357" class="difflineplus">+  while (result.node.nodeType != Node.ELEMENT_NODE) {</span>
<a href="#l3.3358"></a><span id="l3.3358">     result.node = result.node.parentNode;</span>
<a href="#l3.3359"></a><span id="l3.3359" class="difflineplus">+  }</span>
<a href="#l3.3360"></a><span id="l3.3360"> </span>
<a href="#l3.3361"></a><span id="l3.3361">   // and make sure the element is not a special editor node like</span>
<a href="#l3.3362"></a><span id="l3.3362">   // the &lt;br&gt; we insert in blank lines</span>
<a href="#l3.3363"></a><span id="l3.3363">   // and don't select anonymous content !!! (fix for bug 190279)</span>
<a href="#l3.3364"></a><span id="l3.3364" class="difflineminus">-  while (result.node.hasAttribute(&quot;_moz_editor_bogus_node&quot;) ||</span>
<a href="#l3.3365"></a><span id="l3.3365" class="difflineminus">-         editor.isAnonymousElement(result.node))</span>
<a href="#l3.3366"></a><span id="l3.3366" class="difflineplus">+  while (</span>
<a href="#l3.3367"></a><span id="l3.3367" class="difflineplus">+    result.node.hasAttribute(&quot;_moz_editor_bogus_node&quot;) ||</span>
<a href="#l3.3368"></a><span id="l3.3368" class="difflineplus">+    editor.isAnonymousElement(result.node)</span>
<a href="#l3.3369"></a><span id="l3.3369" class="difflineplus">+  ) {</span>
<a href="#l3.3370"></a><span id="l3.3370">     result.node = result.node.parentNode;</span>
<a href="#l3.3371"></a><span id="l3.3371" class="difflineplus">+  }</span>
<a href="#l3.3372"></a><span id="l3.3372"> </span>
<a href="#l3.3373"></a><span id="l3.3373">   return result;</span>
<a href="#l3.3374"></a><span id="l3.3374"> }</span>
<a href="#l3.3375"></a><span id="l3.3375"> </span>
<a href="#l3.3376"></a><span id="l3.3376"> function FillInHTMLTooltipEditor(tooltip) {</span>
<a href="#l3.3377"></a><span id="l3.3377">   const XLinkNS = &quot;http://www.w3.org/1999/xlink&quot;;</span>
<a href="#l3.3378"></a><span id="l3.3378">   var tooltipText = null;</span>
<a href="#l3.3379"></a><span id="l3.3379">   var node;</span>
<a href="#l3.3380"></a><span id="l3.3380" class="difflineat">@@ -2877,33 +3372,39 @@ function FillInHTMLTooltipEditor(tooltip</span>
<a href="#l3.3381"></a><span id="l3.3381">         if (tooltipText &amp;&amp; /\S/.test(tooltipText)) {</span>
<a href="#l3.3382"></a><span id="l3.3382">           tooltip.setAttribute(&quot;label&quot;, tooltipText);</span>
<a href="#l3.3383"></a><span id="l3.3383">           return true;</span>
<a href="#l3.3384"></a><span id="l3.3384">         }</span>
<a href="#l3.3385"></a><span id="l3.3385">       }</span>
<a href="#l3.3386"></a><span id="l3.3386">     }</span>
<a href="#l3.3387"></a><span id="l3.3387">   } else {</span>
<a href="#l3.3388"></a><span id="l3.3388">     for (node = document.tooltipNode; node; node = node.parentNode) {</span>
<a href="#l3.3389"></a><span id="l3.3389" class="difflineminus">-      if (ChromeUtils.getClassName(node) === &quot;HTMLImageElement&quot; ||</span>
<a href="#l3.3390"></a><span id="l3.3390" class="difflineminus">-          ChromeUtils.getClassName(node) === &quot;HTMLInputElement&quot;)</span>
<a href="#l3.3391"></a><span id="l3.3391" class="difflineplus">+      if (</span>
<a href="#l3.3392"></a><span id="l3.3392" class="difflineplus">+        ChromeUtils.getClassName(node) === &quot;HTMLImageElement&quot; ||</span>
<a href="#l3.3393"></a><span id="l3.3393" class="difflineplus">+        ChromeUtils.getClassName(node) === &quot;HTMLInputElement&quot;</span>
<a href="#l3.3394"></a><span id="l3.3394" class="difflineplus">+      ) {</span>
<a href="#l3.3395"></a><span id="l3.3395">         tooltipText = node.getAttribute(&quot;src&quot;);</span>
<a href="#l3.3396"></a><span id="l3.3396" class="difflineminus">-      else if (ChromeUtils.getClassName(node) === &quot;HTMLAnchorElement&quot;)</span>
<a href="#l3.3397"></a><span id="l3.3397" class="difflineplus">+      } else if (ChromeUtils.getClassName(node) === &quot;HTMLAnchorElement&quot;) {</span>
<a href="#l3.3398"></a><span id="l3.3398">         tooltipText = node.getAttribute(&quot;href&quot;) || node.getAttribute(&quot;name&quot;);</span>
<a href="#l3.3399"></a><span id="l3.3399" class="difflineplus">+      }</span>
<a href="#l3.3400"></a><span id="l3.3400">       if (tooltipText) {</span>
<a href="#l3.3401"></a><span id="l3.3401">         tooltip.setAttribute(&quot;label&quot;, tooltipText);</span>
<a href="#l3.3402"></a><span id="l3.3402">         return true;</span>
<a href="#l3.3403"></a><span id="l3.3403">       }</span>
<a href="#l3.3404"></a><span id="l3.3404">     }</span>
<a href="#l3.3405"></a><span id="l3.3405">   }</span>
<a href="#l3.3406"></a><span id="l3.3406">   return false;</span>
<a href="#l3.3407"></a><span id="l3.3407"> }</span>
<a href="#l3.3408"></a><span id="l3.3408"> </span>
<a href="#l3.3409"></a><span id="l3.3409"> function UpdateTOC() {</span>
<a href="#l3.3410"></a><span id="l3.3410" class="difflineminus">-  window.openDialog(&quot;chrome://editor/content/EdInsertTOC.xul&quot;,</span>
<a href="#l3.3411"></a><span id="l3.3411" class="difflineminus">-                    &quot;_blank&quot;, &quot;chrome,close,modal,titlebar&quot;);</span>
<a href="#l3.3412"></a><span id="l3.3412" class="difflineplus">+  window.openDialog(</span>
<a href="#l3.3413"></a><span id="l3.3413" class="difflineplus">+    &quot;chrome://editor/content/EdInsertTOC.xul&quot;,</span>
<a href="#l3.3414"></a><span id="l3.3414" class="difflineplus">+    &quot;_blank&quot;,</span>
<a href="#l3.3415"></a><span id="l3.3415" class="difflineplus">+    &quot;chrome,close,modal,titlebar&quot;</span>
<a href="#l3.3416"></a><span id="l3.3416" class="difflineplus">+  );</span>
<a href="#l3.3417"></a><span id="l3.3417">   window.content.focus();</span>
<a href="#l3.3418"></a><span id="l3.3418"> }</span>
<a href="#l3.3419"></a><span id="l3.3419"> </span>
<a href="#l3.3420"></a><span id="l3.3420"> function InitTOCMenu() {</span>
<a href="#l3.3421"></a><span id="l3.3421">   var elt = GetCurrentEditor().document.getElementById(&quot;mozToc&quot;);</span>
<a href="#l3.3422"></a><span id="l3.3422">   var createMenuitem = document.getElementById(&quot;insertTOCMenuitem&quot;);</span>
<a href="#l3.3423"></a><span id="l3.3423">   var updateMenuitem = document.getElementById(&quot;updateTOCMenuitem&quot;);</span>
<a href="#l3.3424"></a><span id="l3.3424">   var removeMenuitem = document.getElementById(&quot;removeTOCMenuitem&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/editor/ui/composer/content/editorUtilities.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/editor/ui/composer/content/editorUtilities.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,143 +1,177 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.5"></a><span id="l4.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.6"></a><span id="l4.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> /* import-globals-from editor.js */</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineminus">-var {AppConstants} = ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+var { AppConstants } = ChromeUtils.import(</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+  &quot;resource://gre/modules/AppConstants.jsm&quot;</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+);</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17"> // Each editor window must include this file</span>
<a href="#l4.18"></a><span id="l4.18"> // Variables  shared by all dialogs:</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20"> // Object to attach commonly-used widgets (all dialogs should use this)</span>
<a href="#l4.21"></a><span id="l4.21"> var gDialog = {};</span>
<a href="#l4.22"></a><span id="l4.22"> </span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-var kOutputEncodeBasicEntities = Ci.nsIDocumentEncoder.OutputEncodeBasicEntities;</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+var kOutputEncodeBasicEntities =</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+  Ci.nsIDocumentEncoder.OutputEncodeBasicEntities;</span>
<a href="#l4.26"></a><span id="l4.26"> var kOutputEncodeHTMLEntities = Ci.nsIDocumentEncoder.OutputEncodeHTMLEntities;</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-var kOutputEncodeLatin1Entities = Ci.nsIDocumentEncoder.OutputEncodeLatin1Entities;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+var kOutputEncodeLatin1Entities =</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+  Ci.nsIDocumentEncoder.OutputEncodeLatin1Entities;</span>
<a href="#l4.30"></a><span id="l4.30"> var kOutputEncodeW3CEntities = Ci.nsIDocumentEncoder.OutputEncodeW3CEntities;</span>
<a href="#l4.31"></a><span id="l4.31"> var kOutputFormatted = Ci.nsIDocumentEncoder.OutputFormatted;</span>
<a href="#l4.32"></a><span id="l4.32"> var kOutputLFLineBreak = Ci.nsIDocumentEncoder.OutputLFLineBreak;</span>
<a href="#l4.33"></a><span id="l4.33"> var kOutputSelectionOnly = Ci.nsIDocumentEncoder.OutputSelectionOnly;</span>
<a href="#l4.34"></a><span id="l4.34"> var kOutputWrap = Ci.nsIDocumentEncoder.OutputWrap;</span>
<a href="#l4.35"></a><span id="l4.35"> </span>
<a href="#l4.36"></a><span id="l4.36"> var gStringBundle;</span>
<a href="#l4.37"></a><span id="l4.37"> var gFilePickerDirectory;</span>
<a href="#l4.38"></a><span id="l4.38"> </span>
<a href="#l4.39"></a><span id="l4.39"> /** *********** Message dialogs ***************/</span>
<a href="#l4.40"></a><span id="l4.40"> </span>
<a href="#l4.41"></a><span id="l4.41"> // Optional: Caller may supply text to substitute for &quot;Ok&quot; and/or &quot;Cancel&quot;</span>
<a href="#l4.42"></a><span id="l4.42"> function ConfirmWithTitle(title, message, okButtonText, cancelButtonText) {</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-  let okFlag = okButtonText ? Services.prompt.BUTTON_TITLE_IS_STRING : Services.prompt.BUTTON_TITLE_OK;</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-  let cancelFlag = cancelButtonText ? Services.prompt.BUTTON_TITLE_IS_STRING : Services.prompt.BUTTON_TITLE_CANCEL;</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+  let okFlag = okButtonText</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+    ? Services.prompt.BUTTON_TITLE_IS_STRING</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+    : Services.prompt.BUTTON_TITLE_OK;</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+  let cancelFlag = cancelButtonText</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+    ? Services.prompt.BUTTON_TITLE_IS_STRING</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+    : Services.prompt.BUTTON_TITLE_CANCEL;</span>
<a href="#l4.51"></a><span id="l4.51"> </span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-  return Services.prompt.confirmEx(window, title, message,</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-                                   (okFlag * Services.prompt.BUTTON_POS_0) +</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-                                   (cancelFlag * Services.prompt.BUTTON_POS_1),</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-                                   okButtonText, cancelButtonText, null, null, {value: 0}) == 0;</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+  return (</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+    Services.prompt.confirmEx(</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+      window,</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+      title,</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+      message,</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+      okFlag * Services.prompt.BUTTON_POS_0 +</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+        cancelFlag * Services.prompt.BUTTON_POS_1,</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+      okButtonText,</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+      cancelButtonText,</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+      null,</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+      null,</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+      { value: 0 }</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+    ) == 0</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+  );</span>
<a href="#l4.70"></a><span id="l4.70"> }</span>
<a href="#l4.71"></a><span id="l4.71"> </span>
<a href="#l4.72"></a><span id="l4.72"> /** *********** String Utilities ***************/</span>
<a href="#l4.73"></a><span id="l4.73"> </span>
<a href="#l4.74"></a><span id="l4.74"> function GetString(name) {</span>
<a href="#l4.75"></a><span id="l4.75">   if (!gStringBundle) {</span>
<a href="#l4.76"></a><span id="l4.76">     try {</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-      gStringBundle = Services.strings.createBundle(&quot;chrome://editor/locale/editor.properties&quot;);</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+      gStringBundle = Services.strings.createBundle(</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+        &quot;chrome://editor/locale/editor.properties&quot;</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+      );</span>
<a href="#l4.81"></a><span id="l4.81">     } catch (ex) {}</span>
<a href="#l4.82"></a><span id="l4.82">   }</span>
<a href="#l4.83"></a><span id="l4.83">   if (gStringBundle) {</span>
<a href="#l4.84"></a><span id="l4.84">     try {</span>
<a href="#l4.85"></a><span id="l4.85">       return gStringBundle.GetStringFromName(name);</span>
<a href="#l4.86"></a><span id="l4.86">     } catch (e) {}</span>
<a href="#l4.87"></a><span id="l4.87">   }</span>
<a href="#l4.88"></a><span id="l4.88">   return null;</span>
<a href="#l4.89"></a><span id="l4.89"> }</span>
<a href="#l4.90"></a><span id="l4.90"> </span>
<a href="#l4.91"></a><span id="l4.91"> function GetFormattedString(aName, aVal) {</span>
<a href="#l4.92"></a><span id="l4.92">   if (!gStringBundle) {</span>
<a href="#l4.93"></a><span id="l4.93">     try {</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineminus">-      gStringBundle = Services.strings.createBundle(&quot;chrome://editor/locale/editor.properties&quot;);</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+      gStringBundle = Services.strings.createBundle(</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+        &quot;chrome://editor/locale/editor.properties&quot;</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+      );</span>
<a href="#l4.98"></a><span id="l4.98">     } catch (ex) {}</span>
<a href="#l4.99"></a><span id="l4.99">   }</span>
<a href="#l4.100"></a><span id="l4.100">   if (gStringBundle) {</span>
<a href="#l4.101"></a><span id="l4.101">     try {</span>
<a href="#l4.102"></a><span id="l4.102">       return gStringBundle.formatStringFromName(aName, [aVal]);</span>
<a href="#l4.103"></a><span id="l4.103">     } catch (e) {}</span>
<a href="#l4.104"></a><span id="l4.104">   }</span>
<a href="#l4.105"></a><span id="l4.105">   return null;</span>
<a href="#l4.106"></a><span id="l4.106"> }</span>
<a href="#l4.107"></a><span id="l4.107"> </span>
<a href="#l4.108"></a><span id="l4.108"> function TrimStringLeft(string) {</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineminus">-  if (!string)</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+  if (!string) {</span>
<a href="#l4.111"></a><span id="l4.111">     return &quot;&quot;;</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+  }</span>
<a href="#l4.113"></a><span id="l4.113">   return string.trimLeft();</span>
<a href="#l4.114"></a><span id="l4.114"> }</span>
<a href="#l4.115"></a><span id="l4.115"> </span>
<a href="#l4.116"></a><span id="l4.116"> function TrimStringRight(string) {</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineminus">-  if (!string)</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+  if (!string) {</span>
<a href="#l4.119"></a><span id="l4.119">     return &quot;&quot;;</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+  }</span>
<a href="#l4.121"></a><span id="l4.121">   return string.trimRight();</span>
<a href="#l4.122"></a><span id="l4.122"> }</span>
<a href="#l4.123"></a><span id="l4.123"> </span>
<a href="#l4.124"></a><span id="l4.124"> // Remove whitespace from both ends of a string</span>
<a href="#l4.125"></a><span id="l4.125"> function TrimString(string) {</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineminus">-  if (!string)</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+  if (!string) {</span>
<a href="#l4.128"></a><span id="l4.128">     return &quot;&quot;;</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+  }</span>
<a href="#l4.130"></a><span id="l4.130">   return string.trim();</span>
<a href="#l4.131"></a><span id="l4.131"> }</span>
<a href="#l4.132"></a><span id="l4.132"> </span>
<a href="#l4.133"></a><span id="l4.133"> function TruncateStringAtWordEnd(string, maxLength, addEllipses) {</span>
<a href="#l4.134"></a><span id="l4.134">   // Return empty if string is null, undefined, or the empty string</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineminus">-  if (!string)</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+  if (!string) {</span>
<a href="#l4.137"></a><span id="l4.137">     return &quot;&quot;;</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+  }</span>
<a href="#l4.139"></a><span id="l4.139"> </span>
<a href="#l4.140"></a><span id="l4.140">   // We assume they probably don't want whitespace at the beginning</span>
<a href="#l4.141"></a><span id="l4.141">   string = string.trimLeft();</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineminus">-  if (string.length &lt;= maxLength)</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+  if (string.length &lt;= maxLength) {</span>
<a href="#l4.144"></a><span id="l4.144">     return string;</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+  }</span>
<a href="#l4.146"></a><span id="l4.146"> </span>
<a href="#l4.147"></a><span id="l4.147">   // We need to truncate the string to maxLength or fewer chars</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineminus">-  if (addEllipses)</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+  if (addEllipses) {</span>
<a href="#l4.150"></a><span id="l4.150">     maxLength -= 3;</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+  }</span>
<a href="#l4.152"></a><span id="l4.152">   string = string.replace(RegExp(&quot;(.{0,&quot; + maxLength + &quot;})\\s.*&quot;), &quot;$1&quot;);</span>
<a href="#l4.153"></a><span id="l4.153"> </span>
<a href="#l4.154"></a><span id="l4.154" class="difflineminus">-  if (string.length &gt; maxLength)</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+  if (string.length &gt; maxLength) {</span>
<a href="#l4.156"></a><span id="l4.156">     string = string.slice(0, maxLength);</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+  }</span>
<a href="#l4.158"></a><span id="l4.158"> </span>
<a href="#l4.159"></a><span id="l4.159" class="difflineminus">-  if (addEllipses)</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+  if (addEllipses) {</span>
<a href="#l4.161"></a><span id="l4.161">     string += &quot;...&quot;;</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineplus">+  }</span>
<a href="#l4.163"></a><span id="l4.163">   return string;</span>
<a href="#l4.164"></a><span id="l4.164"> }</span>
<a href="#l4.165"></a><span id="l4.165"> </span>
<a href="#l4.166"></a><span id="l4.166"> // Replace all whitespace characters with supplied character</span>
<a href="#l4.167"></a><span id="l4.167"> // E.g.: Use charReplace = &quot; &quot;, to &quot;unwrap&quot; the string by removing line-end chars</span>
<a href="#l4.168"></a><span id="l4.168"> //       Use charReplace = &quot;_&quot; when you don't want spaces (like in a URL)</span>
<a href="#l4.169"></a><span id="l4.169"> function ReplaceWhitespace(string, charReplace) {</span>
<a href="#l4.170"></a><span id="l4.170">   return string.trim().replace(/\s+/g, charReplace);</span>
<a href="#l4.171"></a><span id="l4.171"> }</span>
<a href="#l4.172"></a><span id="l4.172"> </span>
<a href="#l4.173"></a><span id="l4.173"> // Replace whitespace with &quot;_&quot; and allow only HTML CDATA</span>
<a href="#l4.174"></a><span id="l4.174"> //   characters: &quot;a&quot;-&quot;z&quot;,&quot;A&quot;-&quot;Z&quot;,&quot;0&quot;-&quot;9&quot;, &quot;_&quot;, &quot;:&quot;, &quot;-&quot;, &quot;.&quot;,</span>
<a href="#l4.175"></a><span id="l4.175"> //   and characters above ASCII 127</span>
<a href="#l4.176"></a><span id="l4.176"> function ConvertToCDATAString(string) {</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineminus">-  return string.replace(/\s+/g, &quot;_&quot;).replace(/[^a-zA-Z0-9_\.\-\:\u0080-\uFFFF]+/g, &quot;&quot;);</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+  return string</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+    .replace(/\s+/g, &quot;_&quot;)</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineplus">+    .replace(/[^a-zA-Z0-9_\.\-\:\u0080-\uFFFF]+/g, &quot;&quot;);</span>
<a href="#l4.181"></a><span id="l4.181"> }</span>
<a href="#l4.182"></a><span id="l4.182"> </span>
<a href="#l4.183"></a><span id="l4.183"> function GetSelectionAsText() {</span>
<a href="#l4.184"></a><span id="l4.184">   try {</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineminus">-    return GetCurrentEditor().outputToString(&quot;text/plain&quot;, kOutputSelectionOnly);</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineplus">+    return GetCurrentEditor().outputToString(</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineplus">+      &quot;text/plain&quot;,</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+      kOutputSelectionOnly</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+    );</span>
<a href="#l4.190"></a><span id="l4.190">   } catch (e) {}</span>
<a href="#l4.191"></a><span id="l4.191"> </span>
<a href="#l4.192"></a><span id="l4.192">   return &quot;&quot;;</span>
<a href="#l4.193"></a><span id="l4.193"> }</span>
<a href="#l4.194"></a><span id="l4.194"> </span>
<a href="#l4.195"></a><span id="l4.195" class="difflineminus">-</span>
<a href="#l4.196"></a><span id="l4.196"> /** *********** Get Current Editor and associated interfaces or info ***************/</span>
<a href="#l4.197"></a><span id="l4.197"> const nsIPlaintextEditor = Ci.nsIPlaintextEditor;</span>
<a href="#l4.198"></a><span id="l4.198"> const nsIHTMLEditor = Ci.nsIHTMLEditor;</span>
<a href="#l4.199"></a><span id="l4.199"> const nsITableEditor = Ci.nsITableEditor;</span>
<a href="#l4.200"></a><span id="l4.200"> const nsIEditorStyleSheets = Ci.nsIEditorStyleSheets;</span>
<a href="#l4.201"></a><span id="l4.201"> const nsIEditingSession = Ci.nsIEditingSession;</span>
<a href="#l4.202"></a><span id="l4.202"> </span>
<a href="#l4.203"></a><span id="l4.203"> function GetCurrentEditor() {</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineat">@@ -159,33 +193,33 @@ function GetCurrentEditor() {</span>
<a href="#l4.205"></a><span id="l4.205">     dump(e) + &quot;\n&quot;;</span>
<a href="#l4.206"></a><span id="l4.206">   }</span>
<a href="#l4.207"></a><span id="l4.207"> </span>
<a href="#l4.208"></a><span id="l4.208">   return editor;</span>
<a href="#l4.209"></a><span id="l4.209"> }</span>
<a href="#l4.210"></a><span id="l4.210"> </span>
<a href="#l4.211"></a><span id="l4.211"> function GetCurrentTableEditor() {</span>
<a href="#l4.212"></a><span id="l4.212">   var editor = GetCurrentEditor();</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineminus">-  return (editor &amp;&amp; (editor instanceof nsITableEditor)) ? editor : null;</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+  return editor &amp;&amp; editor instanceof nsITableEditor ? editor : null;</span>
<a href="#l4.215"></a><span id="l4.215"> }</span>
<a href="#l4.216"></a><span id="l4.216"> </span>
<a href="#l4.217"></a><span id="l4.217"> function GetCurrentEditorElement() {</span>
<a href="#l4.218"></a><span id="l4.218">   var tmpWindow = window;</span>
<a href="#l4.219"></a><span id="l4.219"> </span>
<a href="#l4.220"></a><span id="l4.220">   do {</span>
<a href="#l4.221"></a><span id="l4.221">     // Get the &lt;editor&gt; element(s)</span>
<a href="#l4.222"></a><span id="l4.222">     let editorItem = tmpWindow.document.querySelector(&quot;editor&quot;);</span>
<a href="#l4.223"></a><span id="l4.223"> </span>
<a href="#l4.224"></a><span id="l4.224">     // This will change if we support &gt; 1 editor element</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineminus">-    if (editorItem)</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineplus">+    if (editorItem) {</span>
<a href="#l4.227"></a><span id="l4.227">       return editorItem;</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineplus">+    }</span>
<a href="#l4.229"></a><span id="l4.229"> </span>
<a href="#l4.230"></a><span id="l4.230">     tmpWindow = tmpWindow.opener;</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineminus">-  }</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineminus">-  while (tmpWindow);</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineplus">+  } while (tmpWindow);</span>
<a href="#l4.234"></a><span id="l4.234"> </span>
<a href="#l4.235"></a><span id="l4.235">   return null;</span>
<a href="#l4.236"></a><span id="l4.236"> }</span>
<a href="#l4.237"></a><span id="l4.237"> </span>
<a href="#l4.238"></a><span id="l4.238"> function GetCurrentCommandManager() {</span>
<a href="#l4.239"></a><span id="l4.239">   try {</span>
<a href="#l4.240"></a><span id="l4.240">     return GetCurrentEditorElement().commandManager;</span>
<a href="#l4.241"></a><span id="l4.241">   } catch (e) {</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineat">@@ -202,46 +236,47 @@ function GetCurrentEditorType() {</span>
<a href="#l4.243"></a><span id="l4.243">     dump(e) + &quot;\n&quot;;</span>
<a href="#l4.244"></a><span id="l4.244">   }</span>
<a href="#l4.245"></a><span id="l4.245"> </span>
<a href="#l4.246"></a><span id="l4.246">   return &quot;&quot;;</span>
<a href="#l4.247"></a><span id="l4.247"> }</span>
<a href="#l4.248"></a><span id="l4.248"> </span>
<a href="#l4.249"></a><span id="l4.249"> function IsHTMLEditor() {</span>
<a href="#l4.250"></a><span id="l4.250">   // We don't have an editorElement, just return false</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineminus">-  if (!GetCurrentEditorElement())</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineplus">+  if (!GetCurrentEditorElement()) {</span>
<a href="#l4.253"></a><span id="l4.253">     return false;</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineplus">+  }</span>
<a href="#l4.255"></a><span id="l4.255"> </span>
<a href="#l4.256"></a><span id="l4.256">   var editortype = GetCurrentEditorType();</span>
<a href="#l4.257"></a><span id="l4.257">   switch (editortype) {</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineminus">-      case &quot;html&quot;:</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineminus">-      case &quot;htmlmail&quot;:</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineminus">-        return true;</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineplus">+    case &quot;html&quot;:</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineplus">+    case &quot;htmlmail&quot;:</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineplus">+      return true;</span>
<a href="#l4.264"></a><span id="l4.264"> </span>
<a href="#l4.265"></a><span id="l4.265" class="difflineminus">-      case &quot;text&quot;:</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineminus">-      case &quot;textmail&quot;:</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineminus">-        return false;</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineplus">+    case &quot;text&quot;:</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineplus">+    case &quot;textmail&quot;:</span>
<a href="#l4.270"></a><span id="l4.270" class="difflineplus">+      return false;</span>
<a href="#l4.271"></a><span id="l4.271"> </span>
<a href="#l4.272"></a><span id="l4.272" class="difflineminus">-      default:</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineminus">-        dump(&quot;INVALID EDITOR TYPE: &quot; + editortype + &quot;\n&quot;);</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineminus">-        break;</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineplus">+    default:</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineplus">+      dump(&quot;INVALID EDITOR TYPE: &quot; + editortype + &quot;\n&quot;);</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineplus">+      break;</span>
<a href="#l4.278"></a><span id="l4.278">   }</span>
<a href="#l4.279"></a><span id="l4.279">   return false;</span>
<a href="#l4.280"></a><span id="l4.280"> }</span>
<a href="#l4.281"></a><span id="l4.281"> </span>
<a href="#l4.282"></a><span id="l4.282"> function PageIsEmptyAndUntouched() {</span>
<a href="#l4.283"></a><span id="l4.283">   return IsDocumentEmpty() &amp;&amp; !IsDocumentModified() &amp;&amp; !IsHTMLSourceChanged();</span>
<a href="#l4.284"></a><span id="l4.284"> }</span>
<a href="#l4.285"></a><span id="l4.285"> </span>
<a href="#l4.286"></a><span id="l4.286"> function IsInHTMLSourceMode() {</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineminus">-  return (gEditorDisplayMode == kDisplayModeSource);</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineplus">+  return gEditorDisplayMode == kDisplayModeSource;</span>
<a href="#l4.289"></a><span id="l4.289"> }</span>
<a href="#l4.290"></a><span id="l4.290"> </span>
<a href="#l4.291"></a><span id="l4.291"> function IsInPreviewMode() {</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineminus">-  return (gEditorDisplayMode == kDisplayModePreview);</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineplus">+  return gEditorDisplayMode == kDisplayModePreview;</span>
<a href="#l4.294"></a><span id="l4.294"> }</span>
<a href="#l4.295"></a><span id="l4.295"> </span>
<a href="#l4.296"></a><span id="l4.296"> // are we editing HTML (i.e. neither in HTML source mode, nor editing a text file)</span>
<a href="#l4.297"></a><span id="l4.297"> function IsEditingRenderedHTML() {</span>
<a href="#l4.298"></a><span id="l4.298">   return IsHTMLEditor() &amp;&amp; !IsInHTMLSourceMode();</span>
<a href="#l4.299"></a><span id="l4.299"> }</span>
<a href="#l4.300"></a><span id="l4.300"> </span>
<a href="#l4.301"></a><span id="l4.301"> function IsWebComposer() {</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineat">@@ -293,59 +328,76 @@ function GetDocumentTitle() {</span>
<a href="#l4.303"></a><span id="l4.303">   return &quot;&quot;;</span>
<a href="#l4.304"></a><span id="l4.304"> }</span>
<a href="#l4.305"></a><span id="l4.305"> </span>
<a href="#l4.306"></a><span id="l4.306"> function SetDocumentTitle(title) {</span>
<a href="#l4.307"></a><span id="l4.307">   try {</span>
<a href="#l4.308"></a><span id="l4.308">     GetCurrentEditorElement().contentDocument.title = title;</span>
<a href="#l4.309"></a><span id="l4.309"> </span>
<a href="#l4.310"></a><span id="l4.310">     // Update window title (doesn't work if called from a dialog)</span>
<a href="#l4.311"></a><span id="l4.311" class="difflineminus">-    if (&quot;UpdateWindowTitle&quot; in window)</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineplus">+    if (&quot;UpdateWindowTitle&quot; in window) {</span>
<a href="#l4.313"></a><span id="l4.313">       window.UpdateWindowTitle();</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineplus">+    }</span>
<a href="#l4.315"></a><span id="l4.315">   } catch (e) {}</span>
<a href="#l4.316"></a><span id="l4.316"> }</span>
<a href="#l4.317"></a><span id="l4.317"> </span>
<a href="#l4.318"></a><span id="l4.318" class="difflineminus">-function EditorGetTextProperty(property, attribute, value, firstHas, anyHas, allHas) {</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineplus">+function EditorGetTextProperty(</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineplus">+  property,</span>
<a href="#l4.321"></a><span id="l4.321" class="difflineplus">+  attribute,</span>
<a href="#l4.322"></a><span id="l4.322" class="difflineplus">+  value,</span>
<a href="#l4.323"></a><span id="l4.323" class="difflineplus">+  firstHas,</span>
<a href="#l4.324"></a><span id="l4.324" class="difflineplus">+  anyHas,</span>
<a href="#l4.325"></a><span id="l4.325" class="difflineplus">+  allHas</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineplus">+) {</span>
<a href="#l4.327"></a><span id="l4.327">   try {</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineminus">-    return GetCurrentEditor().getInlinePropertyWithAttrValue(property,</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineminus">-                                attribute, value, firstHas, anyHas, allHas);</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineplus">+    return GetCurrentEditor().getInlinePropertyWithAttrValue(</span>
<a href="#l4.331"></a><span id="l4.331" class="difflineplus">+      property,</span>
<a href="#l4.332"></a><span id="l4.332" class="difflineplus">+      attribute,</span>
<a href="#l4.333"></a><span id="l4.333" class="difflineplus">+      value,</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineplus">+      firstHas,</span>
<a href="#l4.335"></a><span id="l4.335" class="difflineplus">+      anyHas,</span>
<a href="#l4.336"></a><span id="l4.336" class="difflineplus">+      allHas</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineplus">+    );</span>
<a href="#l4.338"></a><span id="l4.338">   } catch (e) {}</span>
<a href="#l4.339"></a><span id="l4.339"> }</span>
<a href="#l4.340"></a><span id="l4.340"> </span>
<a href="#l4.341"></a><span id="l4.341"> function EditorSetTextProperty(property, attribute, value) {</span>
<a href="#l4.342"></a><span id="l4.342">   try {</span>
<a href="#l4.343"></a><span id="l4.343">     GetCurrentEditor().setInlineProperty(property, attribute, value);</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineminus">-    if (&quot;gContentWindow&quot; in window)</span>
<a href="#l4.345"></a><span id="l4.345" class="difflineplus">+    if (&quot;gContentWindow&quot; in window) {</span>
<a href="#l4.346"></a><span id="l4.346">       window.gContentWindow.focus();</span>
<a href="#l4.347"></a><span id="l4.347" class="difflineplus">+    }</span>
<a href="#l4.348"></a><span id="l4.348">   } catch (e) {}</span>
<a href="#l4.349"></a><span id="l4.349"> }</span>
<a href="#l4.350"></a><span id="l4.350"> </span>
<a href="#l4.351"></a><span id="l4.351"> function EditorRemoveTextProperty(property, attribute) {</span>
<a href="#l4.352"></a><span id="l4.352">   try {</span>
<a href="#l4.353"></a><span id="l4.353">     GetCurrentEditor().removeInlineProperty(property, attribute);</span>
<a href="#l4.354"></a><span id="l4.354" class="difflineminus">-    if (&quot;gContentWindow&quot; in window)</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineplus">+    if (&quot;gContentWindow&quot; in window) {</span>
<a href="#l4.356"></a><span id="l4.356">       window.gContentWindow.focus();</span>
<a href="#l4.357"></a><span id="l4.357" class="difflineplus">+    }</span>
<a href="#l4.358"></a><span id="l4.358">   } catch (e) {}</span>
<a href="#l4.359"></a><span id="l4.359"> }</span>
<a href="#l4.360"></a><span id="l4.360"> </span>
<a href="#l4.361"></a><span id="l4.361"> /** *********** Element enbabling/disabling ***************/</span>
<a href="#l4.362"></a><span id="l4.362"> </span>
<a href="#l4.363"></a><span id="l4.363"> // this function takes an elementID and a flag</span>
<a href="#l4.364"></a><span id="l4.364"> // if the element can be found by ID, then it is either enabled (by removing &quot;disabled&quot; attr)</span>
<a href="#l4.365"></a><span id="l4.365"> // or disabled (setAttribute) as specified in the &quot;doEnable&quot; parameter</span>
<a href="#l4.366"></a><span id="l4.366"> function SetElementEnabledById(elementID, doEnable) {</span>
<a href="#l4.367"></a><span id="l4.367">   SetElementEnabled(document.getElementById(elementID), doEnable);</span>
<a href="#l4.368"></a><span id="l4.368"> }</span>
<a href="#l4.369"></a><span id="l4.369"> </span>
<a href="#l4.370"></a><span id="l4.370"> function SetElementEnabled(element, doEnable) {</span>
<a href="#l4.371"></a><span id="l4.371">   if (element) {</span>
<a href="#l4.372"></a><span id="l4.372" class="difflineminus">-    if (doEnable)</span>
<a href="#l4.373"></a><span id="l4.373" class="difflineplus">+    if (doEnable) {</span>
<a href="#l4.374"></a><span id="l4.374">       element.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l4.375"></a><span id="l4.375" class="difflineminus">-    else</span>
<a href="#l4.376"></a><span id="l4.376" class="difflineplus">+    } else {</span>
<a href="#l4.377"></a><span id="l4.377">       element.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l4.378"></a><span id="l4.378" class="difflineplus">+    }</span>
<a href="#l4.379"></a><span id="l4.379">   } else {</span>
<a href="#l4.380"></a><span id="l4.380">     dump(&quot;Element  not found in SetElementEnabled\n&quot;);</span>
<a href="#l4.381"></a><span id="l4.381">   }</span>
<a href="#l4.382"></a><span id="l4.382"> }</span>
<a href="#l4.383"></a><span id="l4.383"> </span>
<a href="#l4.384"></a><span id="l4.384"> /** *********** Services / Prefs ***************/</span>
<a href="#l4.385"></a><span id="l4.385"> </span>
<a href="#l4.386"></a><span id="l4.386"> function GetFileProtocolHandler() {</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineat">@@ -361,212 +413,263 @@ function SetStringPref(aPrefName, aPrefV</span>
<a href="#l4.388"></a><span id="l4.388"> </span>
<a href="#l4.389"></a><span id="l4.389"> // Set initial directory for a filepicker from URLs saved in prefs</span>
<a href="#l4.390"></a><span id="l4.390"> function SetFilePickerDirectory(filePicker, fileType) {</span>
<a href="#l4.391"></a><span id="l4.391">   if (filePicker) {</span>
<a href="#l4.392"></a><span id="l4.392">     try {</span>
<a href="#l4.393"></a><span id="l4.393">       // Save current directory so we can reset it in SaveFilePickerDirectory</span>
<a href="#l4.394"></a><span id="l4.394">       gFilePickerDirectory = filePicker.displayDirectory;</span>
<a href="#l4.395"></a><span id="l4.395"> </span>
<a href="#l4.396"></a><span id="l4.396" class="difflineminus">-      let location = Services.prefs.getComplexValue(&quot;editor.lastFileLocation.&quot; + fileType,</span>
<a href="#l4.397"></a><span id="l4.397" class="difflineminus">-                                                    Ci.nsIFile);</span>
<a href="#l4.398"></a><span id="l4.398" class="difflineminus">-      if (location)</span>
<a href="#l4.399"></a><span id="l4.399" class="difflineplus">+      let location = Services.prefs.getComplexValue(</span>
<a href="#l4.400"></a><span id="l4.400" class="difflineplus">+        &quot;editor.lastFileLocation.&quot; + fileType,</span>
<a href="#l4.401"></a><span id="l4.401" class="difflineplus">+        Ci.nsIFile</span>
<a href="#l4.402"></a><span id="l4.402" class="difflineplus">+      );</span>
<a href="#l4.403"></a><span id="l4.403" class="difflineplus">+      if (location) {</span>
<a href="#l4.404"></a><span id="l4.404">         filePicker.displayDirectory = location;</span>
<a href="#l4.405"></a><span id="l4.405" class="difflineplus">+      }</span>
<a href="#l4.406"></a><span id="l4.406">     } catch (e) {}</span>
<a href="#l4.407"></a><span id="l4.407">   }</span>
<a href="#l4.408"></a><span id="l4.408"> }</span>
<a href="#l4.409"></a><span id="l4.409"> </span>
<a href="#l4.410"></a><span id="l4.410"> // Save the directory of the selected file to prefs</span>
<a href="#l4.411"></a><span id="l4.411"> function SaveFilePickerDirectory(filePicker, fileType) {</span>
<a href="#l4.412"></a><span id="l4.412">   if (filePicker &amp;&amp; filePicker.file) {</span>
<a href="#l4.413"></a><span id="l4.413">     try {</span>
<a href="#l4.414"></a><span id="l4.414">       var fileDir;</span>
<a href="#l4.415"></a><span id="l4.415" class="difflineminus">-      if (filePicker.file.parent)</span>
<a href="#l4.416"></a><span id="l4.416" class="difflineplus">+      if (filePicker.file.parent) {</span>
<a href="#l4.417"></a><span id="l4.417">         fileDir = filePicker.file.parent.QueryInterface(Ci.nsIFile);</span>
<a href="#l4.418"></a><span id="l4.418" class="difflineplus">+      }</span>
<a href="#l4.419"></a><span id="l4.419"> </span>
<a href="#l4.420"></a><span id="l4.420" class="difflineminus">-        Services.prefs.setComplexValue(&quot;editor.lastFileLocation.&quot; + fileType,</span>
<a href="#l4.421"></a><span id="l4.421" class="difflineminus">-                                       Ci.nsIFile, fileDir);</span>
<a href="#l4.422"></a><span id="l4.422" class="difflineplus">+      Services.prefs.setComplexValue(</span>
<a href="#l4.423"></a><span id="l4.423" class="difflineplus">+        &quot;editor.lastFileLocation.&quot; + fileType,</span>
<a href="#l4.424"></a><span id="l4.424" class="difflineplus">+        Ci.nsIFile,</span>
<a href="#l4.425"></a><span id="l4.425" class="difflineplus">+        fileDir</span>
<a href="#l4.426"></a><span id="l4.426" class="difflineplus">+      );</span>
<a href="#l4.427"></a><span id="l4.427"> </span>
<a href="#l4.428"></a><span id="l4.428" class="difflineminus">-        Services.prefs.savePrefFile(null);</span>
<a href="#l4.429"></a><span id="l4.429" class="difflineplus">+      Services.prefs.savePrefFile(null);</span>
<a href="#l4.430"></a><span id="l4.430">     } catch (e) {}</span>
<a href="#l4.431"></a><span id="l4.431">   }</span>
<a href="#l4.432"></a><span id="l4.432"> </span>
<a href="#l4.433"></a><span id="l4.433">   // Restore the directory used before SetFilePickerDirectory was called;</span>
<a href="#l4.434"></a><span id="l4.434">   // This reduces interference with Browser and other module directory defaults</span>
<a href="#l4.435"></a><span id="l4.435" class="difflineminus">-  if (gFilePickerDirectory)</span>
<a href="#l4.436"></a><span id="l4.436" class="difflineplus">+  if (gFilePickerDirectory) {</span>
<a href="#l4.437"></a><span id="l4.437">     filePicker.displayDirectory = gFilePickerDirectory;</span>
<a href="#l4.438"></a><span id="l4.438" class="difflineplus">+  }</span>
<a href="#l4.439"></a><span id="l4.439"> </span>
<a href="#l4.440"></a><span id="l4.440">   gFilePickerDirectory = null;</span>
<a href="#l4.441"></a><span id="l4.441"> }</span>
<a href="#l4.442"></a><span id="l4.442"> </span>
<a href="#l4.443"></a><span id="l4.443"> function GetDefaultBrowserColors() {</span>
<a href="#l4.444"></a><span id="l4.444" class="difflineminus">-  var colors = { TextColor: 0, BackgroundColor: 0, LinkColor: 0, ActiveLinkColor: 0, VisitedLinkColor: 0 };</span>
<a href="#l4.445"></a><span id="l4.445" class="difflineminus">-  var useSysColors = Services.prefs.getBoolPref(&quot;browser.display.use_system_colors&quot;, false);</span>
<a href="#l4.446"></a><span id="l4.446" class="difflineplus">+  var colors = {</span>
<a href="#l4.447"></a><span id="l4.447" class="difflineplus">+    TextColor: 0,</span>
<a href="#l4.448"></a><span id="l4.448" class="difflineplus">+    BackgroundColor: 0,</span>
<a href="#l4.449"></a><span id="l4.449" class="difflineplus">+    LinkColor: 0,</span>
<a href="#l4.450"></a><span id="l4.450" class="difflineplus">+    ActiveLinkColor: 0,</span>
<a href="#l4.451"></a><span id="l4.451" class="difflineplus">+    VisitedLinkColor: 0,</span>
<a href="#l4.452"></a><span id="l4.452" class="difflineplus">+  };</span>
<a href="#l4.453"></a><span id="l4.453" class="difflineplus">+  var useSysColors = Services.prefs.getBoolPref(</span>
<a href="#l4.454"></a><span id="l4.454" class="difflineplus">+    &quot;browser.display.use_system_colors&quot;,</span>
<a href="#l4.455"></a><span id="l4.455" class="difflineplus">+    false</span>
<a href="#l4.456"></a><span id="l4.456" class="difflineplus">+  );</span>
<a href="#l4.457"></a><span id="l4.457"> </span>
<a href="#l4.458"></a><span id="l4.458">   if (!useSysColors) {</span>
<a href="#l4.459"></a><span id="l4.459" class="difflineminus">-    colors.TextColor = Services.prefs.getCharPref(&quot;browser.display.foreground_color&quot;, 0);</span>
<a href="#l4.460"></a><span id="l4.460" class="difflineminus">-    colors.BackgroundColor = Services.prefs.getCharPref(&quot;browser.display.background_color&quot;, 0);</span>
<a href="#l4.461"></a><span id="l4.461" class="difflineplus">+    colors.TextColor = Services.prefs.getCharPref(</span>
<a href="#l4.462"></a><span id="l4.462" class="difflineplus">+      &quot;browser.display.foreground_color&quot;,</span>
<a href="#l4.463"></a><span id="l4.463" class="difflineplus">+      0</span>
<a href="#l4.464"></a><span id="l4.464" class="difflineplus">+    );</span>
<a href="#l4.465"></a><span id="l4.465" class="difflineplus">+    colors.BackgroundColor = Services.prefs.getCharPref(</span>
<a href="#l4.466"></a><span id="l4.466" class="difflineplus">+      &quot;browser.display.background_color&quot;,</span>
<a href="#l4.467"></a><span id="l4.467" class="difflineplus">+      0</span>
<a href="#l4.468"></a><span id="l4.468" class="difflineplus">+    );</span>
<a href="#l4.469"></a><span id="l4.469">   }</span>
<a href="#l4.470"></a><span id="l4.470">   // Use OS colors for text and background if explicitly asked or pref is not set</span>
<a href="#l4.471"></a><span id="l4.471" class="difflineminus">-  if (!colors.TextColor)</span>
<a href="#l4.472"></a><span id="l4.472" class="difflineplus">+  if (!colors.TextColor) {</span>
<a href="#l4.473"></a><span id="l4.473">     colors.TextColor = &quot;windowtext&quot;;</span>
<a href="#l4.474"></a><span id="l4.474" class="difflineplus">+  }</span>
<a href="#l4.475"></a><span id="l4.475"> </span>
<a href="#l4.476"></a><span id="l4.476" class="difflineminus">-  if (!colors.BackgroundColor)</span>
<a href="#l4.477"></a><span id="l4.477" class="difflineplus">+  if (!colors.BackgroundColor) {</span>
<a href="#l4.478"></a><span id="l4.478">     colors.BackgroundColor = &quot;window&quot;;</span>
<a href="#l4.479"></a><span id="l4.479" class="difflineplus">+  }</span>
<a href="#l4.480"></a><span id="l4.480"> </span>
<a href="#l4.481"></a><span id="l4.481">   colors.LinkColor = Services.prefs.getCharPref(&quot;browser.anchor_color&quot;);</span>
<a href="#l4.482"></a><span id="l4.482">   colors.ActiveLinkColor = Services.prefs.getCharPref(&quot;browser.active_color&quot;);</span>
<a href="#l4.483"></a><span id="l4.483">   colors.VisitedLinkColor = Services.prefs.getCharPref(&quot;browser.visited_color&quot;);</span>
<a href="#l4.484"></a><span id="l4.484"> </span>
<a href="#l4.485"></a><span id="l4.485">   return colors;</span>
<a href="#l4.486"></a><span id="l4.486"> }</span>
<a href="#l4.487"></a><span id="l4.487"> </span>
<a href="#l4.488"></a><span id="l4.488"> /** *********** URL handling ***************/</span>
<a href="#l4.489"></a><span id="l4.489"> </span>
<a href="#l4.490"></a><span id="l4.490"> function TextIsURI(selectedText) {</span>
<a href="#l4.491"></a><span id="l4.491" class="difflineminus">-  return selectedText &amp;&amp; /^http:\/\/|^https:\/\/|^file:\/\/|^ftp:\/\/|^about:|^mailto:|^news:|^snews:|^telnet:|^ldap:|^ldaps:|^gopher:|^finger:|^javascript:/i.test(selectedText);</span>
<a href="#l4.492"></a><span id="l4.492" class="difflineplus">+  return (</span>
<a href="#l4.493"></a><span id="l4.493" class="difflineplus">+    selectedText &amp;&amp;</span>
<a href="#l4.494"></a><span id="l4.494" class="difflineplus">+    /^http:\/\/|^https:\/\/|^file:\/\/|^ftp:\/\/|^about:|^mailto:|^news:|^snews:|^telnet:|^ldap:|^ldaps:|^gopher:|^finger:|^javascript:/i.test(</span>
<a href="#l4.495"></a><span id="l4.495" class="difflineplus">+      selectedText</span>
<a href="#l4.496"></a><span id="l4.496" class="difflineplus">+    )</span>
<a href="#l4.497"></a><span id="l4.497" class="difflineplus">+  );</span>
<a href="#l4.498"></a><span id="l4.498"> }</span>
<a href="#l4.499"></a><span id="l4.499"> </span>
<a href="#l4.500"></a><span id="l4.500"> function IsUrlAboutBlank(urlString) {</span>
<a href="#l4.501"></a><span id="l4.501" class="difflineminus">-  return (urlString == &quot;about:blank&quot;);</span>
<a href="#l4.502"></a><span id="l4.502" class="difflineplus">+  return urlString == &quot;about:blank&quot;;</span>
<a href="#l4.503"></a><span id="l4.503"> }</span>
<a href="#l4.504"></a><span id="l4.504"> </span>
<a href="#l4.505"></a><span id="l4.505"> function MakeRelativeUrl(url) {</span>
<a href="#l4.506"></a><span id="l4.506">   let inputUrl = url.trim();</span>
<a href="#l4.507"></a><span id="l4.507" class="difflineminus">-  if (!inputUrl)</span>
<a href="#l4.508"></a><span id="l4.508" class="difflineplus">+  if (!inputUrl) {</span>
<a href="#l4.509"></a><span id="l4.509">     return inputUrl;</span>
<a href="#l4.510"></a><span id="l4.510" class="difflineplus">+  }</span>
<a href="#l4.511"></a><span id="l4.511"> </span>
<a href="#l4.512"></a><span id="l4.512">   // Get the filespec relative to current document's location</span>
<a href="#l4.513"></a><span id="l4.513">   // NOTE: Can't do this if file isn't saved yet!</span>
<a href="#l4.514"></a><span id="l4.514">   var docUrl = GetDocumentBaseUrl();</span>
<a href="#l4.515"></a><span id="l4.515">   var docScheme = GetScheme(docUrl);</span>
<a href="#l4.516"></a><span id="l4.516"> </span>
<a href="#l4.517"></a><span id="l4.517">   // Can't relativize if no doc scheme (page hasn't been saved)</span>
<a href="#l4.518"></a><span id="l4.518" class="difflineminus">-  if (!docScheme)</span>
<a href="#l4.519"></a><span id="l4.519" class="difflineplus">+  if (!docScheme) {</span>
<a href="#l4.520"></a><span id="l4.520">     return inputUrl;</span>
<a href="#l4.521"></a><span id="l4.521" class="difflineplus">+  }</span>
<a href="#l4.522"></a><span id="l4.522"> </span>
<a href="#l4.523"></a><span id="l4.523">   var urlScheme = GetScheme(inputUrl);</span>
<a href="#l4.524"></a><span id="l4.524"> </span>
<a href="#l4.525"></a><span id="l4.525">   // Do nothing if not the same scheme or url is already relativized</span>
<a href="#l4.526"></a><span id="l4.526" class="difflineminus">-  if (docScheme != urlScheme)</span>
<a href="#l4.527"></a><span id="l4.527" class="difflineplus">+  if (docScheme != urlScheme) {</span>
<a href="#l4.528"></a><span id="l4.528">     return inputUrl;</span>
<a href="#l4.529"></a><span id="l4.529" class="difflineplus">+  }</span>
<a href="#l4.530"></a><span id="l4.530"> </span>
<a href="#l4.531"></a><span id="l4.531">   // Host must be the same</span>
<a href="#l4.532"></a><span id="l4.532">   var docHost = GetHost(docUrl);</span>
<a href="#l4.533"></a><span id="l4.533">   var urlHost = GetHost(inputUrl);</span>
<a href="#l4.534"></a><span id="l4.534" class="difflineminus">-  if (docHost != urlHost)</span>
<a href="#l4.535"></a><span id="l4.535" class="difflineplus">+  if (docHost != urlHost) {</span>
<a href="#l4.536"></a><span id="l4.536">     return inputUrl;</span>
<a href="#l4.537"></a><span id="l4.537" class="difflineminus">-</span>
<a href="#l4.538"></a><span id="l4.538" class="difflineplus">+  }</span>
<a href="#l4.539"></a><span id="l4.539"> </span>
<a href="#l4.540"></a><span id="l4.540">   // Get just the file path part of the urls</span>
<a href="#l4.541"></a><span id="l4.541">   // XXX Should we use GetCurrentEditor().documentCharacterSet for 2nd param ?</span>
<a href="#l4.542"></a><span id="l4.542" class="difflineminus">-  let docPath = Services.io.newURI(docUrl, GetCurrentEditor().documentCharacterSet).pathQueryRef;</span>
<a href="#l4.543"></a><span id="l4.543" class="difflineminus">-  let urlPath = Services.io.newURI(inputUrl, GetCurrentEditor().documentCharacterSet).pathQueryRef;</span>
<a href="#l4.544"></a><span id="l4.544" class="difflineplus">+  let docPath = Services.io.newURI(</span>
<a href="#l4.545"></a><span id="l4.545" class="difflineplus">+    docUrl,</span>
<a href="#l4.546"></a><span id="l4.546" class="difflineplus">+    GetCurrentEditor().documentCharacterSet</span>
<a href="#l4.547"></a><span id="l4.547" class="difflineplus">+  ).pathQueryRef;</span>
<a href="#l4.548"></a><span id="l4.548" class="difflineplus">+  let urlPath = Services.io.newURI(</span>
<a href="#l4.549"></a><span id="l4.549" class="difflineplus">+    inputUrl,</span>
<a href="#l4.550"></a><span id="l4.550" class="difflineplus">+    GetCurrentEditor().documentCharacterSet</span>
<a href="#l4.551"></a><span id="l4.551" class="difflineplus">+  ).pathQueryRef;</span>
<a href="#l4.552"></a><span id="l4.552"> </span>
<a href="#l4.553"></a><span id="l4.553">   // We only return &quot;urlPath&quot;, so we can convert the entire docPath for</span>
<a href="#l4.554"></a><span id="l4.554">   // case-insensitive comparisons.</span>
<a href="#l4.555"></a><span id="l4.555" class="difflineminus">-  var doCaseInsensitive = (docScheme == &quot;file&quot; &amp;&amp;</span>
<a href="#l4.556"></a><span id="l4.556" class="difflineminus">-                           AppConstants.platform == &quot;win&quot;);</span>
<a href="#l4.557"></a><span id="l4.557" class="difflineminus">-  if (doCaseInsensitive)</span>
<a href="#l4.558"></a><span id="l4.558" class="difflineplus">+  var doCaseInsensitive = docScheme == &quot;file&quot; &amp;&amp; AppConstants.platform == &quot;win&quot;;</span>
<a href="#l4.559"></a><span id="l4.559" class="difflineplus">+  if (doCaseInsensitive) {</span>
<a href="#l4.560"></a><span id="l4.560">     docPath = docPath.toLowerCase();</span>
<a href="#l4.561"></a><span id="l4.561" class="difflineplus">+  }</span>
<a href="#l4.562"></a><span id="l4.562"> </span>
<a href="#l4.563"></a><span id="l4.563">   // Get document filename before we start chopping up the docPath</span>
<a href="#l4.564"></a><span id="l4.564">   var docFilename = GetFilename(docPath);</span>
<a href="#l4.565"></a><span id="l4.565"> </span>
<a href="#l4.566"></a><span id="l4.566">   // Both url and doc paths now begin with &quot;/&quot;</span>
<a href="#l4.567"></a><span id="l4.567">   // Look for shared dirs starting after that</span>
<a href="#l4.568"></a><span id="l4.568">   urlPath = urlPath.slice(1);</span>
<a href="#l4.569"></a><span id="l4.569">   docPath = docPath.slice(1);</span>
<a href="#l4.570"></a><span id="l4.570"> </span>
<a href="#l4.571"></a><span id="l4.571">   var firstDirTest = true;</span>
<a href="#l4.572"></a><span id="l4.572">   var nextDocSlash = 0;</span>
<a href="#l4.573"></a><span id="l4.573">   var done = false;</span>
<a href="#l4.574"></a><span id="l4.574"> </span>
<a href="#l4.575"></a><span id="l4.575">   // Remove all matching subdirs common to both doc and input urls</span>
<a href="#l4.576"></a><span id="l4.576">   do {</span>
<a href="#l4.577"></a><span id="l4.577" class="difflineminus">-    nextDocSlash = docPath.indexOf(&quot;\/&quot;);</span>
<a href="#l4.578"></a><span id="l4.578" class="difflineminus">-    var nextUrlSlash = urlPath.indexOf(&quot;\/&quot;);</span>
<a href="#l4.579"></a><span id="l4.579" class="difflineplus">+    nextDocSlash = docPath.indexOf(&quot;/&quot;);</span>
<a href="#l4.580"></a><span id="l4.580" class="difflineplus">+    var nextUrlSlash = urlPath.indexOf(&quot;/&quot;);</span>
<a href="#l4.581"></a><span id="l4.581"> </span>
<a href="#l4.582"></a><span id="l4.582">     if (nextUrlSlash == -1) {</span>
<a href="#l4.583"></a><span id="l4.583">       // We're done matching and all dirs in url</span>
<a href="#l4.584"></a><span id="l4.584">       // what's left is the filename</span>
<a href="#l4.585"></a><span id="l4.585">       done = true;</span>
<a href="#l4.586"></a><span id="l4.586"> </span>
<a href="#l4.587"></a><span id="l4.587">       // Remove filename for named anchors in the same file</span>
<a href="#l4.588"></a><span id="l4.588">       if (nextDocSlash == -1 &amp;&amp; docFilename) {</span>
<a href="#l4.589"></a><span id="l4.589">         var anchorIndex = urlPath.indexOf(&quot;#&quot;);</span>
<a href="#l4.590"></a><span id="l4.590">         if (anchorIndex &gt; 0) {</span>
<a href="#l4.591"></a><span id="l4.591">           var urlFilename = doCaseInsensitive ? urlPath.toLowerCase() : urlPath;</span>
<a href="#l4.592"></a><span id="l4.592"> </span>
<a href="#l4.593"></a><span id="l4.593" class="difflineminus">-          if (urlFilename.startsWith(docFilename))</span>
<a href="#l4.594"></a><span id="l4.594" class="difflineplus">+          if (urlFilename.startsWith(docFilename)) {</span>
<a href="#l4.595"></a><span id="l4.595">             urlPath = urlPath.slice(anchorIndex);</span>
<a href="#l4.596"></a><span id="l4.596" class="difflineplus">+          }</span>
<a href="#l4.597"></a><span id="l4.597">         }</span>
<a href="#l4.598"></a><span id="l4.598">       }</span>
<a href="#l4.599"></a><span id="l4.599">     } else if (nextDocSlash &gt;= 0) {</span>
<a href="#l4.600"></a><span id="l4.600">       // Test for matching subdir</span>
<a href="#l4.601"></a><span id="l4.601">       var docDir = docPath.slice(0, nextDocSlash);</span>
<a href="#l4.602"></a><span id="l4.602">       var urlDir = urlPath.slice(0, nextUrlSlash);</span>
<a href="#l4.603"></a><span id="l4.603" class="difflineminus">-      if (doCaseInsensitive)</span>
<a href="#l4.604"></a><span id="l4.604" class="difflineplus">+      if (doCaseInsensitive) {</span>
<a href="#l4.605"></a><span id="l4.605">         urlDir = urlDir.toLowerCase();</span>
<a href="#l4.606"></a><span id="l4.606" class="difflineplus">+      }</span>
<a href="#l4.607"></a><span id="l4.607"> </span>
<a href="#l4.608"></a><span id="l4.608">       if (urlDir == docDir) {</span>
<a href="#l4.609"></a><span id="l4.609">         // Remove matching dir+&quot;/&quot; from each path</span>
<a href="#l4.610"></a><span id="l4.610">         // and continue to next dir.</span>
<a href="#l4.611"></a><span id="l4.611">         docPath = docPath.slice(nextDocSlash + 1);</span>
<a href="#l4.612"></a><span id="l4.612">         urlPath = urlPath.slice(nextUrlSlash + 1);</span>
<a href="#l4.613"></a><span id="l4.613">       } else {</span>
<a href="#l4.614"></a><span id="l4.614">         // No match, we're done.</span>
<a href="#l4.615"></a><span id="l4.615">         done = true;</span>
<a href="#l4.616"></a><span id="l4.616"> </span>
<a href="#l4.617"></a><span id="l4.617">         // Be sure we are on the same local drive or volume</span>
<a href="#l4.618"></a><span id="l4.618">         //   (the first &quot;dir&quot; in the path) because we can't</span>
<a href="#l4.619"></a><span id="l4.619">         //   relativize to different drives/volumes.</span>
<a href="#l4.620"></a><span id="l4.620">         // UNIX doesn't have volumes, so we must not do this else</span>
<a href="#l4.621"></a><span id="l4.621">         // the first directory will be misinterpreted as a volume name.</span>
<a href="#l4.622"></a><span id="l4.622" class="difflineminus">-        if (firstDirTest &amp;&amp; docScheme == &quot;file&quot; &amp;&amp;</span>
<a href="#l4.623"></a><span id="l4.623" class="difflineminus">-            AppConstants.platform != &quot;unix&quot;)</span>
<a href="#l4.624"></a><span id="l4.624" class="difflineplus">+        if (</span>
<a href="#l4.625"></a><span id="l4.625" class="difflineplus">+          firstDirTest &amp;&amp;</span>
<a href="#l4.626"></a><span id="l4.626" class="difflineplus">+          docScheme == &quot;file&quot; &amp;&amp;</span>
<a href="#l4.627"></a><span id="l4.627" class="difflineplus">+          AppConstants.platform != &quot;unix&quot;</span>
<a href="#l4.628"></a><span id="l4.628" class="difflineplus">+        ) {</span>
<a href="#l4.629"></a><span id="l4.629">           return inputUrl;</span>
<a href="#l4.630"></a><span id="l4.630" class="difflineplus">+        }</span>
<a href="#l4.631"></a><span id="l4.631">       }</span>
<a href="#l4.632"></a><span id="l4.632" class="difflineminus">-    } else { // No more doc dirs left, we're done</span>
<a href="#l4.633"></a><span id="l4.633" class="difflineplus">+    } else {</span>
<a href="#l4.634"></a><span id="l4.634" class="difflineplus">+      // No more doc dirs left, we're done</span>
<a href="#l4.635"></a><span id="l4.635">       done = true;</span>
<a href="#l4.636"></a><span id="l4.636">     }</span>
<a href="#l4.637"></a><span id="l4.637"> </span>
<a href="#l4.638"></a><span id="l4.638">     firstDirTest = false;</span>
<a href="#l4.639"></a><span id="l4.639" class="difflineminus">-  }</span>
<a href="#l4.640"></a><span id="l4.640" class="difflineminus">-  while (!done);</span>
<a href="#l4.641"></a><span id="l4.641" class="difflineplus">+  } while (!done);</span>
<a href="#l4.642"></a><span id="l4.642"> </span>
<a href="#l4.643"></a><span id="l4.643">   // Add &quot;../&quot; for each dir left in docPath</span>
<a href="#l4.644"></a><span id="l4.644">   while (nextDocSlash &gt; 0) {</span>
<a href="#l4.645"></a><span id="l4.645">     urlPath = &quot;../&quot; + urlPath;</span>
<a href="#l4.646"></a><span id="l4.646" class="difflineminus">-    nextDocSlash = docPath.indexOf(&quot;\/&quot;, nextDocSlash + 1);</span>
<a href="#l4.647"></a><span id="l4.647" class="difflineplus">+    nextDocSlash = docPath.indexOf(&quot;/&quot;, nextDocSlash + 1);</span>
<a href="#l4.648"></a><span id="l4.648">   }</span>
<a href="#l4.649"></a><span id="l4.649">   return urlPath;</span>
<a href="#l4.650"></a><span id="l4.650"> }</span>
<a href="#l4.651"></a><span id="l4.651"> </span>
<a href="#l4.652"></a><span id="l4.652"> function MakeAbsoluteUrl(url) {</span>
<a href="#l4.653"></a><span id="l4.653">   let resultUrl = TrimString(url);</span>
<a href="#l4.654"></a><span id="l4.654" class="difflineminus">-  if (!resultUrl)</span>
<a href="#l4.655"></a><span id="l4.655" class="difflineplus">+  if (!resultUrl) {</span>
<a href="#l4.656"></a><span id="l4.656">     return resultUrl;</span>
<a href="#l4.657"></a><span id="l4.657" class="difflineplus">+  }</span>
<a href="#l4.658"></a><span id="l4.658"> </span>
<a href="#l4.659"></a><span id="l4.659">   // Check if URL is already absolute, i.e., it has a scheme</span>
<a href="#l4.660"></a><span id="l4.660">   let urlScheme = GetScheme(resultUrl);</span>
<a href="#l4.661"></a><span id="l4.661"> </span>
<a href="#l4.662"></a><span id="l4.662" class="difflineminus">-  if (urlScheme)</span>
<a href="#l4.663"></a><span id="l4.663" class="difflineplus">+  if (urlScheme) {</span>
<a href="#l4.664"></a><span id="l4.664">     return resultUrl;</span>
<a href="#l4.665"></a><span id="l4.665" class="difflineplus">+  }</span>
<a href="#l4.666"></a><span id="l4.666"> </span>
<a href="#l4.667"></a><span id="l4.667">   let docUrl = GetDocumentBaseUrl();</span>
<a href="#l4.668"></a><span id="l4.668">   let docScheme = GetScheme(docUrl);</span>
<a href="#l4.669"></a><span id="l4.669"> </span>
<a href="#l4.670"></a><span id="l4.670">   // Can't relativize if no doc scheme (page hasn't been saved)</span>
<a href="#l4.671"></a><span id="l4.671" class="difflineminus">-  if (!docScheme)</span>
<a href="#l4.672"></a><span id="l4.672" class="difflineplus">+  if (!docScheme) {</span>
<a href="#l4.673"></a><span id="l4.673">     return resultUrl;</span>
<a href="#l4.674"></a><span id="l4.674" class="difflineplus">+  }</span>
<a href="#l4.675"></a><span id="l4.675"> </span>
<a href="#l4.676"></a><span id="l4.676">   // Make a URI object to use its &quot;resolve&quot; method</span>
<a href="#l4.677"></a><span id="l4.677">   let absoluteUrl = resultUrl;</span>
<a href="#l4.678"></a><span id="l4.678" class="difflineminus">-  let docUri = Services.io.newURI(docUrl, GetCurrentEditor().documentCharacterSet);</span>
<a href="#l4.679"></a><span id="l4.679" class="difflineplus">+  let docUri = Services.io.newURI(</span>
<a href="#l4.680"></a><span id="l4.680" class="difflineplus">+    docUrl,</span>
<a href="#l4.681"></a><span id="l4.681" class="difflineplus">+    GetCurrentEditor().documentCharacterSet</span>
<a href="#l4.682"></a><span id="l4.682" class="difflineplus">+  );</span>
<a href="#l4.683"></a><span id="l4.683"> </span>
<a href="#l4.684"></a><span id="l4.684">   try {</span>
<a href="#l4.685"></a><span id="l4.685">     absoluteUrl = docUri.resolve(resultUrl);</span>
<a href="#l4.686"></a><span id="l4.686">     // This is deprecated and buggy!</span>
<a href="#l4.687"></a><span id="l4.687">     // If used, we must make it a path for the parent directory (remove filename)</span>
<a href="#l4.688"></a><span id="l4.688">     // absoluteUrl = IOService.resolveRelativePath(resultUrl, docUrl);</span>
<a href="#l4.689"></a><span id="l4.689">   } catch (e) {}</span>
<a href="#l4.690"></a><span id="l4.690"> </span>
<a href="#l4.691"></a><span id="l4.691" class="difflineat">@@ -576,143 +679,160 @@ function MakeAbsoluteUrl(url) {</span>
<a href="#l4.692"></a><span id="l4.692"> // Get the HREF of the page's &lt;base&gt; tag or the document location</span>
<a href="#l4.693"></a><span id="l4.693"> // returns empty string if no base href and document hasn't been saved yet</span>
<a href="#l4.694"></a><span id="l4.694"> function GetDocumentBaseUrl() {</span>
<a href="#l4.695"></a><span id="l4.695">   try {</span>
<a href="#l4.696"></a><span id="l4.696">     var docUrl;</span>
<a href="#l4.697"></a><span id="l4.697"> </span>
<a href="#l4.698"></a><span id="l4.698">     // if document supplies a &lt;base&gt; tag, use that URL instead</span>
<a href="#l4.699"></a><span id="l4.699">     let base = GetCurrentEditor().document.querySelector(&quot;base&quot;);</span>
<a href="#l4.700"></a><span id="l4.700" class="difflineminus">-    if (base)</span>
<a href="#l4.701"></a><span id="l4.701" class="difflineplus">+    if (base) {</span>
<a href="#l4.702"></a><span id="l4.702">       docUrl = base.getAttribute(&quot;href&quot;);</span>
<a href="#l4.703"></a><span id="l4.703" class="difflineminus">-    if (!docUrl)</span>
<a href="#l4.704"></a><span id="l4.704" class="difflineplus">+    }</span>
<a href="#l4.705"></a><span id="l4.705" class="difflineplus">+    if (!docUrl) {</span>
<a href="#l4.706"></a><span id="l4.706">       docUrl = GetDocumentUrl();</span>
<a href="#l4.707"></a><span id="l4.707" class="difflineplus">+    }</span>
<a href="#l4.708"></a><span id="l4.708"> </span>
<a href="#l4.709"></a><span id="l4.709" class="difflineminus">-    if (!IsUrlAboutBlank(docUrl))</span>
<a href="#l4.710"></a><span id="l4.710" class="difflineplus">+    if (!IsUrlAboutBlank(docUrl)) {</span>
<a href="#l4.711"></a><span id="l4.711">       return docUrl;</span>
<a href="#l4.712"></a><span id="l4.712" class="difflineplus">+    }</span>
<a href="#l4.713"></a><span id="l4.713">   } catch (e) {}</span>
<a href="#l4.714"></a><span id="l4.714">   return &quot;&quot;;</span>
<a href="#l4.715"></a><span id="l4.715"> }</span>
<a href="#l4.716"></a><span id="l4.716"> </span>
<a href="#l4.717"></a><span id="l4.717"> function GetDocumentUrl() {</span>
<a href="#l4.718"></a><span id="l4.718">   try {</span>
<a href="#l4.719"></a><span id="l4.719">     return GetCurrentEditor().document.URL;</span>
<a href="#l4.720"></a><span id="l4.720">   } catch (e) {}</span>
<a href="#l4.721"></a><span id="l4.721">   return &quot;&quot;;</span>
<a href="#l4.722"></a><span id="l4.722"> }</span>
<a href="#l4.723"></a><span id="l4.723"> </span>
<a href="#l4.724"></a><span id="l4.724"> // Extract the scheme (e.g., 'file', 'http') from a URL string</span>
<a href="#l4.725"></a><span id="l4.725"> function GetScheme(urlspec) {</span>
<a href="#l4.726"></a><span id="l4.726">   var resultUrl = TrimString(urlspec);</span>
<a href="#l4.727"></a><span id="l4.727">   // Unsaved document URL has no acceptable scheme yet</span>
<a href="#l4.728"></a><span id="l4.728" class="difflineminus">-  if (!resultUrl || IsUrlAboutBlank(resultUrl))</span>
<a href="#l4.729"></a><span id="l4.729" class="difflineplus">+  if (!resultUrl || IsUrlAboutBlank(resultUrl)) {</span>
<a href="#l4.730"></a><span id="l4.730">     return &quot;&quot;;</span>
<a href="#l4.731"></a><span id="l4.731" class="difflineplus">+  }</span>
<a href="#l4.732"></a><span id="l4.732"> </span>
<a href="#l4.733"></a><span id="l4.733">   var scheme = &quot;&quot;;</span>
<a href="#l4.734"></a><span id="l4.734">   try {</span>
<a href="#l4.735"></a><span id="l4.735">     // This fails if there's no scheme</span>
<a href="#l4.736"></a><span id="l4.736">     scheme = Services.io.extractScheme(resultUrl);</span>
<a href="#l4.737"></a><span id="l4.737">   } catch (e) {}</span>
<a href="#l4.738"></a><span id="l4.738"> </span>
<a href="#l4.739"></a><span id="l4.739">   return scheme ? scheme.toLowerCase() : &quot;&quot;;</span>
<a href="#l4.740"></a><span id="l4.740"> }</span>
<a href="#l4.741"></a><span id="l4.741"> </span>
<a href="#l4.742"></a><span id="l4.742"> function GetHost(urlspec) {</span>
<a href="#l4.743"></a><span id="l4.743" class="difflineminus">-  if (!urlspec)</span>
<a href="#l4.744"></a><span id="l4.744" class="difflineplus">+  if (!urlspec) {</span>
<a href="#l4.745"></a><span id="l4.745">     return &quot;&quot;;</span>
<a href="#l4.746"></a><span id="l4.746" class="difflineplus">+  }</span>
<a href="#l4.747"></a><span id="l4.747"> </span>
<a href="#l4.748"></a><span id="l4.748">   var host = &quot;&quot;;</span>
<a href="#l4.749"></a><span id="l4.749">   try {</span>
<a href="#l4.750"></a><span id="l4.750">     host = Services.io.newURI(urlspec).host;</span>
<a href="#l4.751"></a><span id="l4.751" class="difflineminus">-   } catch (e) {}</span>
<a href="#l4.752"></a><span id="l4.752" class="difflineplus">+  } catch (e) {}</span>
<a href="#l4.753"></a><span id="l4.753"> </span>
<a href="#l4.754"></a><span id="l4.754">   return host;</span>
<a href="#l4.755"></a><span id="l4.755"> }</span>
<a href="#l4.756"></a><span id="l4.756"> </span>
<a href="#l4.757"></a><span id="l4.757"> function GetUsername(urlspec) {</span>
<a href="#l4.758"></a><span id="l4.758" class="difflineminus">-  if (!urlspec)</span>
<a href="#l4.759"></a><span id="l4.759" class="difflineplus">+  if (!urlspec) {</span>
<a href="#l4.760"></a><span id="l4.760">     return &quot;&quot;;</span>
<a href="#l4.761"></a><span id="l4.761" class="difflineplus">+  }</span>
<a href="#l4.762"></a><span id="l4.762"> </span>
<a href="#l4.763"></a><span id="l4.763">   var username = &quot;&quot;;</span>
<a href="#l4.764"></a><span id="l4.764">   try {</span>
<a href="#l4.765"></a><span id="l4.765">     username = Services.io.newURI(urlspec).username;</span>
<a href="#l4.766"></a><span id="l4.766">   } catch (e) {}</span>
<a href="#l4.767"></a><span id="l4.767"> </span>
<a href="#l4.768"></a><span id="l4.768">   return username;</span>
<a href="#l4.769"></a><span id="l4.769"> }</span>
<a href="#l4.770"></a><span id="l4.770"> </span>
<a href="#l4.771"></a><span id="l4.771"> function GetFilename(urlspec) {</span>
<a href="#l4.772"></a><span id="l4.772" class="difflineminus">-  if (!urlspec || IsUrlAboutBlank(urlspec))</span>
<a href="#l4.773"></a><span id="l4.773" class="difflineplus">+  if (!urlspec || IsUrlAboutBlank(urlspec)) {</span>
<a href="#l4.774"></a><span id="l4.774">     return &quot;&quot;;</span>
<a href="#l4.775"></a><span id="l4.775" class="difflineplus">+  }</span>
<a href="#l4.776"></a><span id="l4.776"> </span>
<a href="#l4.777"></a><span id="l4.777">   var filename;</span>
<a href="#l4.778"></a><span id="l4.778"> </span>
<a href="#l4.779"></a><span id="l4.779">   try {</span>
<a href="#l4.780"></a><span id="l4.780">     let uri = Services.io.newURI(urlspec);</span>
<a href="#l4.781"></a><span id="l4.781">     if (uri) {</span>
<a href="#l4.782"></a><span id="l4.782">       let url = uri.QueryInterface(Ci.nsIURL);</span>
<a href="#l4.783"></a><span id="l4.783" class="difflineminus">-      if (url)</span>
<a href="#l4.784"></a><span id="l4.784" class="difflineplus">+      if (url) {</span>
<a href="#l4.785"></a><span id="l4.785">         filename = url.fileName;</span>
<a href="#l4.786"></a><span id="l4.786" class="difflineplus">+      }</span>
<a href="#l4.787"></a><span id="l4.787">     }</span>
<a href="#l4.788"></a><span id="l4.788">   } catch (e) {}</span>
<a href="#l4.789"></a><span id="l4.789"> </span>
<a href="#l4.790"></a><span id="l4.790">   return filename ? filename : &quot;&quot;;</span>
<a href="#l4.791"></a><span id="l4.791"> }</span>
<a href="#l4.792"></a><span id="l4.792"> </span>
<a href="#l4.793"></a><span id="l4.793"> // Return the url without username and password</span>
<a href="#l4.794"></a><span id="l4.794"> // Optional output objects return extracted username and password strings</span>
<a href="#l4.795"></a><span id="l4.795"> // This uses just string routines via nsIIOServices</span>
<a href="#l4.796"></a><span id="l4.796"> function StripUsernamePassword(urlspec, usernameObj, passwordObj) {</span>
<a href="#l4.797"></a><span id="l4.797">   urlspec = TrimString(urlspec);</span>
<a href="#l4.798"></a><span id="l4.798" class="difflineminus">-  if (!urlspec || IsUrlAboutBlank(urlspec))</span>
<a href="#l4.799"></a><span id="l4.799" class="difflineplus">+  if (!urlspec || IsUrlAboutBlank(urlspec)) {</span>
<a href="#l4.800"></a><span id="l4.800">     return urlspec;</span>
<a href="#l4.801"></a><span id="l4.801" class="difflineplus">+  }</span>
<a href="#l4.802"></a><span id="l4.802"> </span>
<a href="#l4.803"></a><span id="l4.803" class="difflineminus">-  if (usernameObj)</span>
<a href="#l4.804"></a><span id="l4.804" class="difflineplus">+  if (usernameObj) {</span>
<a href="#l4.805"></a><span id="l4.805">     usernameObj.value = &quot;&quot;;</span>
<a href="#l4.806"></a><span id="l4.806" class="difflineminus">-  if (passwordObj)</span>
<a href="#l4.807"></a><span id="l4.807" class="difflineplus">+  }</span>
<a href="#l4.808"></a><span id="l4.808" class="difflineplus">+  if (passwordObj) {</span>
<a href="#l4.809"></a><span id="l4.809">     passwordObj.value = &quot;&quot;;</span>
<a href="#l4.810"></a><span id="l4.810" class="difflineplus">+  }</span>
<a href="#l4.811"></a><span id="l4.811"> </span>
<a href="#l4.812"></a><span id="l4.812">   // &quot;@&quot; must exist else we will never detect username or password</span>
<a href="#l4.813"></a><span id="l4.813">   var atIndex = urlspec.indexOf(&quot;@&quot;);</span>
<a href="#l4.814"></a><span id="l4.814">   if (atIndex &gt; 0) {</span>
<a href="#l4.815"></a><span id="l4.815">     try {</span>
<a href="#l4.816"></a><span id="l4.816">       let uri = Services.io.newURI(urlspec);</span>
<a href="#l4.817"></a><span id="l4.817">       let username = uri.username;</span>
<a href="#l4.818"></a><span id="l4.818">       let password = uri.password;</span>
<a href="#l4.819"></a><span id="l4.819"> </span>
<a href="#l4.820"></a><span id="l4.820" class="difflineminus">-      if (usernameObj &amp;&amp; username)</span>
<a href="#l4.821"></a><span id="l4.821" class="difflineplus">+      if (usernameObj &amp;&amp; username) {</span>
<a href="#l4.822"></a><span id="l4.822">         usernameObj.value = username;</span>
<a href="#l4.823"></a><span id="l4.823" class="difflineminus">-      if (passwordObj &amp;&amp; password)</span>
<a href="#l4.824"></a><span id="l4.824" class="difflineplus">+      }</span>
<a href="#l4.825"></a><span id="l4.825" class="difflineplus">+      if (passwordObj &amp;&amp; password) {</span>
<a href="#l4.826"></a><span id="l4.826">         passwordObj.value = password;</span>
<a href="#l4.827"></a><span id="l4.827" class="difflineplus">+      }</span>
<a href="#l4.828"></a><span id="l4.828">       if (username) {</span>
<a href="#l4.829"></a><span id="l4.829">         let usernameStart = urlspec.indexOf(username);</span>
<a href="#l4.830"></a><span id="l4.830" class="difflineminus">-        if (usernameStart != -1)</span>
<a href="#l4.831"></a><span id="l4.831" class="difflineplus">+        if (usernameStart != -1) {</span>
<a href="#l4.832"></a><span id="l4.832">           return urlspec.slice(0, usernameStart) + urlspec.slice(atIndex + 1);</span>
<a href="#l4.833"></a><span id="l4.833" class="difflineplus">+        }</span>
<a href="#l4.834"></a><span id="l4.834">       }</span>
<a href="#l4.835"></a><span id="l4.835">     } catch (e) {}</span>
<a href="#l4.836"></a><span id="l4.836">   }</span>
<a href="#l4.837"></a><span id="l4.837">   return urlspec;</span>
<a href="#l4.838"></a><span id="l4.838"> }</span>
<a href="#l4.839"></a><span id="l4.839"> </span>
<a href="#l4.840"></a><span id="l4.840"> function StripPassword(urlspec, passwordObj) {</span>
<a href="#l4.841"></a><span id="l4.841">   urlspec = TrimString(urlspec);</span>
<a href="#l4.842"></a><span id="l4.842" class="difflineminus">-  if (!urlspec || IsUrlAboutBlank(urlspec))</span>
<a href="#l4.843"></a><span id="l4.843" class="difflineplus">+  if (!urlspec || IsUrlAboutBlank(urlspec)) {</span>
<a href="#l4.844"></a><span id="l4.844">     return urlspec;</span>
<a href="#l4.845"></a><span id="l4.845" class="difflineplus">+  }</span>
<a href="#l4.846"></a><span id="l4.846"> </span>
<a href="#l4.847"></a><span id="l4.847" class="difflineminus">-  if (passwordObj)</span>
<a href="#l4.848"></a><span id="l4.848" class="difflineplus">+  if (passwordObj) {</span>
<a href="#l4.849"></a><span id="l4.849">     passwordObj.value = &quot;&quot;;</span>
<a href="#l4.850"></a><span id="l4.850" class="difflineplus">+  }</span>
<a href="#l4.851"></a><span id="l4.851"> </span>
<a href="#l4.852"></a><span id="l4.852">   // &quot;@&quot; must exist else we will never detect password</span>
<a href="#l4.853"></a><span id="l4.853">   var atIndex = urlspec.indexOf(&quot;@&quot;);</span>
<a href="#l4.854"></a><span id="l4.854">   if (atIndex &gt; 0) {</span>
<a href="#l4.855"></a><span id="l4.855">     try {</span>
<a href="#l4.856"></a><span id="l4.856">       let password = Services.io.newURI(urlspec).password;</span>
<a href="#l4.857"></a><span id="l4.857"> </span>
<a href="#l4.858"></a><span id="l4.858" class="difflineminus">-      if (passwordObj &amp;&amp; password)</span>
<a href="#l4.859"></a><span id="l4.859" class="difflineplus">+      if (passwordObj &amp;&amp; password) {</span>
<a href="#l4.860"></a><span id="l4.860">         passwordObj.value = password;</span>
<a href="#l4.861"></a><span id="l4.861" class="difflineplus">+      }</span>
<a href="#l4.862"></a><span id="l4.862">       if (password) {</span>
<a href="#l4.863"></a><span id="l4.863">         // Find last &quot;:&quot; before &quot;@&quot;</span>
<a href="#l4.864"></a><span id="l4.864">         let colon = urlspec.lastIndexOf(&quot;:&quot;, atIndex);</span>
<a href="#l4.865"></a><span id="l4.865">         if (colon != -1) {</span>
<a href="#l4.866"></a><span id="l4.866">           // Include the &quot;@&quot;</span>
<a href="#l4.867"></a><span id="l4.867">           return urlspec.slice(0, colon) + urlspec.slice(atIndex);</span>
<a href="#l4.868"></a><span id="l4.868">         }</span>
<a href="#l4.869"></a><span id="l4.869">       }</span>
<a href="#l4.870"></a><span id="l4.870" class="difflineat">@@ -725,102 +845,118 @@ function StripPassword(urlspec, password</span>
<a href="#l4.871"></a><span id="l4.871"> function StripUsernamePasswordFromURI(uri) {</span>
<a href="#l4.872"></a><span id="l4.872">   var urlspec = &quot;&quot;;</span>
<a href="#l4.873"></a><span id="l4.873">   if (uri) {</span>
<a href="#l4.874"></a><span id="l4.874">     try {</span>
<a href="#l4.875"></a><span id="l4.875">       urlspec = uri.spec;</span>
<a href="#l4.876"></a><span id="l4.876">       var userPass = uri.userPass;</span>
<a href="#l4.877"></a><span id="l4.877">       if (userPass) {</span>
<a href="#l4.878"></a><span id="l4.878">         let start = urlspec.indexOf(userPass);</span>
<a href="#l4.879"></a><span id="l4.879" class="difflineminus">-        urlspec = urlspec.slice(0, start) + urlspec.slice(start + userPass.length + 1);</span>
<a href="#l4.880"></a><span id="l4.880" class="difflineplus">+        urlspec =</span>
<a href="#l4.881"></a><span id="l4.881" class="difflineplus">+          urlspec.slice(0, start) + urlspec.slice(start + userPass.length + 1);</span>
<a href="#l4.882"></a><span id="l4.882">       }</span>
<a href="#l4.883"></a><span id="l4.883">     } catch (e) {}</span>
<a href="#l4.884"></a><span id="l4.884">   }</span>
<a href="#l4.885"></a><span id="l4.885">   return urlspec;</span>
<a href="#l4.886"></a><span id="l4.886"> }</span>
<a href="#l4.887"></a><span id="l4.887"> </span>
<a href="#l4.888"></a><span id="l4.888"> function InsertUsernameIntoUrl(urlspec, username) {</span>
<a href="#l4.889"></a><span id="l4.889" class="difflineminus">-  if (!urlspec || !username)</span>
<a href="#l4.890"></a><span id="l4.890" class="difflineplus">+  if (!urlspec || !username) {</span>
<a href="#l4.891"></a><span id="l4.891">     return urlspec;</span>
<a href="#l4.892"></a><span id="l4.892" class="difflineplus">+  }</span>
<a href="#l4.893"></a><span id="l4.893"> </span>
<a href="#l4.894"></a><span id="l4.894">   try {</span>
<a href="#l4.895"></a><span id="l4.895" class="difflineminus">-    let URI = Services.io.newURI(urlspec, GetCurrentEditor().documentCharacterSet);</span>
<a href="#l4.896"></a><span id="l4.896" class="difflineplus">+    let URI = Services.io.newURI(</span>
<a href="#l4.897"></a><span id="l4.897" class="difflineplus">+      urlspec,</span>
<a href="#l4.898"></a><span id="l4.898" class="difflineplus">+      GetCurrentEditor().documentCharacterSet</span>
<a href="#l4.899"></a><span id="l4.899" class="difflineplus">+    );</span>
<a href="#l4.900"></a><span id="l4.900">     URI.username = username;</span>
<a href="#l4.901"></a><span id="l4.901">     return URI.spec;</span>
<a href="#l4.902"></a><span id="l4.902">   } catch (e) {}</span>
<a href="#l4.903"></a><span id="l4.903"> </span>
<a href="#l4.904"></a><span id="l4.904">   return urlspec;</span>
<a href="#l4.905"></a><span id="l4.905"> }</span>
<a href="#l4.906"></a><span id="l4.906"> </span>
<a href="#l4.907"></a><span id="l4.907"> function ConvertRGBColorIntoHEXColor(color) {</span>
<a href="#l4.908"></a><span id="l4.908">   if (/rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/.test(color)) {</span>
<a href="#l4.909"></a><span id="l4.909">     var r = Number(RegExp.$1).toString(16);</span>
<a href="#l4.910"></a><span id="l4.910" class="difflineminus">-    if (r.length == 1) r = &quot;0&quot; + r;</span>
<a href="#l4.911"></a><span id="l4.911" class="difflineplus">+    if (r.length == 1) {</span>
<a href="#l4.912"></a><span id="l4.912" class="difflineplus">+      r = &quot;0&quot; + r;</span>
<a href="#l4.913"></a><span id="l4.913" class="difflineplus">+    }</span>
<a href="#l4.914"></a><span id="l4.914">     var g = Number(RegExp.$2).toString(16);</span>
<a href="#l4.915"></a><span id="l4.915" class="difflineminus">-    if (g.length == 1) g = &quot;0&quot; + g;</span>
<a href="#l4.916"></a><span id="l4.916" class="difflineplus">+    if (g.length == 1) {</span>
<a href="#l4.917"></a><span id="l4.917" class="difflineplus">+      g = &quot;0&quot; + g;</span>
<a href="#l4.918"></a><span id="l4.918" class="difflineplus">+    }</span>
<a href="#l4.919"></a><span id="l4.919">     var b = Number(RegExp.$3).toString(16);</span>
<a href="#l4.920"></a><span id="l4.920" class="difflineminus">-    if (b.length == 1) b = &quot;0&quot; + b;</span>
<a href="#l4.921"></a><span id="l4.921" class="difflineplus">+    if (b.length == 1) {</span>
<a href="#l4.922"></a><span id="l4.922" class="difflineplus">+      b = &quot;0&quot; + b;</span>
<a href="#l4.923"></a><span id="l4.923" class="difflineplus">+    }</span>
<a href="#l4.924"></a><span id="l4.924">     return &quot;#&quot; + r + g + b;</span>
<a href="#l4.925"></a><span id="l4.925">   }</span>
<a href="#l4.926"></a><span id="l4.926"> </span>
<a href="#l4.927"></a><span id="l4.927" class="difflineminus">-    return color;</span>
<a href="#l4.928"></a><span id="l4.928" class="difflineplus">+  return color;</span>
<a href="#l4.929"></a><span id="l4.929"> }</span>
<a href="#l4.930"></a><span id="l4.930"> </span>
<a href="#l4.931"></a><span id="l4.931"> /** *********** CSS ***************/</span>
<a href="#l4.932"></a><span id="l4.932"> </span>
<a href="#l4.933"></a><span id="l4.933"> function GetHTMLOrCSSStyleValue(element, attrName, cssPropertyName) {</span>
<a href="#l4.934"></a><span id="l4.934">   var value;</span>
<a href="#l4.935"></a><span id="l4.935" class="difflineminus">-  if (Services.prefs.getBoolPref(&quot;editor.use_css&quot;) &amp;&amp; IsHTMLEditor())</span>
<a href="#l4.936"></a><span id="l4.936" class="difflineplus">+  if (Services.prefs.getBoolPref(&quot;editor.use_css&quot;) &amp;&amp; IsHTMLEditor()) {</span>
<a href="#l4.937"></a><span id="l4.937">     value = element.style.getPropertyValue(cssPropertyName);</span>
<a href="#l4.938"></a><span id="l4.938" class="difflineplus">+  }</span>
<a href="#l4.939"></a><span id="l4.939"> </span>
<a href="#l4.940"></a><span id="l4.940" class="difflineminus">-  if (!value)</span>
<a href="#l4.941"></a><span id="l4.941" class="difflineplus">+  if (!value) {</span>
<a href="#l4.942"></a><span id="l4.942">     value = element.getAttribute(attrName);</span>
<a href="#l4.943"></a><span id="l4.943" class="difflineplus">+  }</span>
<a href="#l4.944"></a><span id="l4.944"> </span>
<a href="#l4.945"></a><span id="l4.945" class="difflineminus">-  if (!value)</span>
<a href="#l4.946"></a><span id="l4.946" class="difflineplus">+  if (!value) {</span>
<a href="#l4.947"></a><span id="l4.947">     return &quot;&quot;;</span>
<a href="#l4.948"></a><span id="l4.948" class="difflineplus">+  }</span>
<a href="#l4.949"></a><span id="l4.949"> </span>
<a href="#l4.950"></a><span id="l4.950">   return value;</span>
<a href="#l4.951"></a><span id="l4.951"> }</span>
<a href="#l4.952"></a><span id="l4.952"> </span>
<a href="#l4.953"></a><span id="l4.953"> /** *********** Miscellaneous ***************/</span>
<a href="#l4.954"></a><span id="l4.954"> // Clone simple JS objects</span>
<a href="#l4.955"></a><span id="l4.955"> function Clone(obj) {</span>
<a href="#l4.956"></a><span id="l4.956">   var clone = {};</span>
<a href="#l4.957"></a><span id="l4.957">   for (var i in obj) {</span>
<a href="#l4.958"></a><span id="l4.958" class="difflineminus">-    if (typeof obj[i] == &quot;object&quot;)</span>
<a href="#l4.959"></a><span id="l4.959" class="difflineplus">+    if (typeof obj[i] == &quot;object&quot;) {</span>
<a href="#l4.960"></a><span id="l4.960">       clone[i] = Clone(obj[i]);</span>
<a href="#l4.961"></a><span id="l4.961" class="difflineminus">-    else</span>
<a href="#l4.962"></a><span id="l4.962" class="difflineplus">+    } else {</span>
<a href="#l4.963"></a><span id="l4.963">       clone[i] = obj[i];</span>
<a href="#l4.964"></a><span id="l4.964" class="difflineplus">+    }</span>
<a href="#l4.965"></a><span id="l4.965">   }</span>
<a href="#l4.966"></a><span id="l4.966">   return clone;</span>
<a href="#l4.967"></a><span id="l4.967"> }</span>
<a href="#l4.968"></a><span id="l4.968"> </span>
<a href="#l4.969"></a><span id="l4.969"> /**</span>
<a href="#l4.970"></a><span id="l4.970">  * Utility functions to handle shortended data: URLs in EdColorProps.js and EdImageOverlay.js.</span>
<a href="#l4.971"></a><span id="l4.971">  */</span>
<a href="#l4.972"></a><span id="l4.972"> </span>
<a href="#l4.973"></a><span id="l4.973"> /**</span>
<a href="#l4.974"></a><span id="l4.974">  * Is the passed in image URI a shortened data URI?</span>
<a href="#l4.975"></a><span id="l4.975">  * @return {bool}</span>
<a href="#l4.976"></a><span id="l4.976">  */</span>
<a href="#l4.977"></a><span id="l4.977"> function isImageDataShortened(aImageData) {</span>
<a href="#l4.978"></a><span id="l4.978" class="difflineminus">-  return (/^data:/i.test(aImageData) &amp;&amp; aImageData.includes(&quot;…&quot;));</span>
<a href="#l4.979"></a><span id="l4.979" class="difflineplus">+  return /^data:/i.test(aImageData) &amp;&amp; aImageData.includes(&quot;…&quot;);</span>
<a href="#l4.980"></a><span id="l4.980"> }</span>
<a href="#l4.981"></a><span id="l4.981"> </span>
<a href="#l4.982"></a><span id="l4.982"> /**</span>
<a href="#l4.983"></a><span id="l4.983">  * Event handler for Copy or Cut</span>
<a href="#l4.984"></a><span id="l4.984">  * @param aEvent  the event</span>
<a href="#l4.985"></a><span id="l4.985">  */</span>
<a href="#l4.986"></a><span id="l4.986"> function onCopyOrCutShortened(aEvent) {</span>
<a href="#l4.987"></a><span id="l4.987">   // Put the original data URI onto the clipboard in case the value</span>
<a href="#l4.988"></a><span id="l4.988">   // is a shortened data URI.</span>
<a href="#l4.989"></a><span id="l4.989">   let field = aEvent.target;</span>
<a href="#l4.990"></a><span id="l4.990">   let startPos = field.selectionStart;</span>
<a href="#l4.991"></a><span id="l4.991" class="difflineminus">-  if (startPos == undefined)</span>
<a href="#l4.992"></a><span id="l4.992" class="difflineplus">+  if (startPos == undefined) {</span>
<a href="#l4.993"></a><span id="l4.993">     return;</span>
<a href="#l4.994"></a><span id="l4.994" class="difflineplus">+  }</span>
<a href="#l4.995"></a><span id="l4.995">   let endPos = field.selectionEnd;</span>
<a href="#l4.996"></a><span id="l4.996">   let selection = field.value.substring(startPos, endPos).trim();</span>
<a href="#l4.997"></a><span id="l4.997"> </span>
<a href="#l4.998"></a><span id="l4.998">   // Test that a) the user selected the whole value,</span>
<a href="#l4.999"></a><span id="l4.999">   //           b) the value is a data URI,</span>
<a href="#l4.1000"></a><span id="l4.1000">   //           c) it contains the ellipsis we added. Otherwise it could be</span>
<a href="#l4.1001"></a><span id="l4.1001">   //              a new value that the user pasted in.</span>
<a href="#l4.1002"></a><span id="l4.1002">   if (selection == field.value.trim() &amp;&amp; isImageDataShortened(selection)) {</span>
<a href="#l4.1003"></a><span id="l4.1003" class="difflineat">@@ -840,30 +976,38 @@ function onCopyOrCutShortened(aEvent) {</span>
<a href="#l4.1004"></a><span id="l4.1004">  *</span>
<a href="#l4.1005"></a><span id="l4.1005">  * @param aImageData    the data: URL of the image to be shortened.</span>
<a href="#l4.1006"></a><span id="l4.1006">  *                      Note: Original stored in 'aDialogField.fullDataURI'.</span>
<a href="#l4.1007"></a><span id="l4.1007">  * @param aDialogField  The field of the dialog to contain the data.</span>
<a href="#l4.1008"></a><span id="l4.1008">  * @return {bool}       URL was shortened?</span>
<a href="#l4.1009"></a><span id="l4.1009">  */</span>
<a href="#l4.1010"></a><span id="l4.1010"> function shortenImageData(aImageData, aDialogField) {</span>
<a href="#l4.1011"></a><span id="l4.1011">   let shortened = false;</span>
<a href="#l4.1012"></a><span id="l4.1012" class="difflineminus">-  aDialogField.value = aImageData.replace(/^(data:.+;base64,)(.*)/i,</span>
<a href="#l4.1013"></a><span id="l4.1013" class="difflineminus">-    function(match, nonDataPart, dataPart) {</span>
<a href="#l4.1014"></a><span id="l4.1014" class="difflineminus">-      if (dataPart.length &lt;= 35)</span>
<a href="#l4.1015"></a><span id="l4.1015" class="difflineminus">-        return match;</span>
<a href="#l4.1016"></a><span id="l4.1016" class="difflineplus">+  aDialogField.value = aImageData.replace(/^(data:.+;base64,)(.*)/i, function(</span>
<a href="#l4.1017"></a><span id="l4.1017" class="difflineplus">+    match,</span>
<a href="#l4.1018"></a><span id="l4.1018" class="difflineplus">+    nonDataPart,</span>
<a href="#l4.1019"></a><span id="l4.1019" class="difflineplus">+    dataPart</span>
<a href="#l4.1020"></a><span id="l4.1020" class="difflineplus">+  ) {</span>
<a href="#l4.1021"></a><span id="l4.1021" class="difflineplus">+    if (dataPart.length &lt;= 35) {</span>
<a href="#l4.1022"></a><span id="l4.1022" class="difflineplus">+      return match;</span>
<a href="#l4.1023"></a><span id="l4.1023" class="difflineplus">+    }</span>
<a href="#l4.1024"></a><span id="l4.1024"> </span>
<a href="#l4.1025"></a><span id="l4.1025" class="difflineminus">-      shortened = true;</span>
<a href="#l4.1026"></a><span id="l4.1026" class="difflineminus">-      aDialogField.addEventListener(&quot;copy&quot;, onCopyOrCutShortened);</span>
<a href="#l4.1027"></a><span id="l4.1027" class="difflineminus">-      aDialogField.addEventListener(&quot;cut&quot;, onCopyOrCutShortened);</span>
<a href="#l4.1028"></a><span id="l4.1028" class="difflineminus">-      aDialogField.fullDataURI = aImageData;</span>
<a href="#l4.1029"></a><span id="l4.1029" class="difflineminus">-      aDialogField.removeAttribute(&quot;tooltiptext&quot;);</span>
<a href="#l4.1030"></a><span id="l4.1030" class="difflineminus">-      aDialogField.setAttribute(&quot;tooltip&quot;, &quot;shortenedDataURI&quot;);</span>
<a href="#l4.1031"></a><span id="l4.1031" class="difflineminus">-      return nonDataPart + dataPart.substring(0, 5) + &quot;…&quot; +</span>
<a href="#l4.1032"></a><span id="l4.1032" class="difflineminus">-                           dataPart.substring(dataPart.length - 30);</span>
<a href="#l4.1033"></a><span id="l4.1033" class="difflineminus">-    });</span>
<a href="#l4.1034"></a><span id="l4.1034" class="difflineplus">+    shortened = true;</span>
<a href="#l4.1035"></a><span id="l4.1035" class="difflineplus">+    aDialogField.addEventListener(&quot;copy&quot;, onCopyOrCutShortened);</span>
<a href="#l4.1036"></a><span id="l4.1036" class="difflineplus">+    aDialogField.addEventListener(&quot;cut&quot;, onCopyOrCutShortened);</span>
<a href="#l4.1037"></a><span id="l4.1037" class="difflineplus">+    aDialogField.fullDataURI = aImageData;</span>
<a href="#l4.1038"></a><span id="l4.1038" class="difflineplus">+    aDialogField.removeAttribute(&quot;tooltiptext&quot;);</span>
<a href="#l4.1039"></a><span id="l4.1039" class="difflineplus">+    aDialogField.setAttribute(&quot;tooltip&quot;, &quot;shortenedDataURI&quot;);</span>
<a href="#l4.1040"></a><span id="l4.1040" class="difflineplus">+    return (</span>
<a href="#l4.1041"></a><span id="l4.1041" class="difflineplus">+      nonDataPart +</span>
<a href="#l4.1042"></a><span id="l4.1042" class="difflineplus">+      dataPart.substring(0, 5) +</span>
<a href="#l4.1043"></a><span id="l4.1043" class="difflineplus">+      &quot;…&quot; +</span>
<a href="#l4.1044"></a><span id="l4.1044" class="difflineplus">+      dataPart.substring(dataPart.length - 30)</span>
<a href="#l4.1045"></a><span id="l4.1045" class="difflineplus">+    );</span>
<a href="#l4.1046"></a><span id="l4.1046" class="difflineplus">+  });</span>
<a href="#l4.1047"></a><span id="l4.1047">   return shortened;</span>
<a href="#l4.1048"></a><span id="l4.1048"> }</span>
<a href="#l4.1049"></a><span id="l4.1049"> </span>
<a href="#l4.1050"></a><span id="l4.1050"> /**</span>
<a href="#l4.1051"></a><span id="l4.1051">  * Return full data URIs for a shortened element.</span>
<a href="#l4.1052"></a><span id="l4.1052">  *</span>
<a href="#l4.1053"></a><span id="l4.1053">  * @param aDialogField  The field of the dialog containing the data.</span>
<a href="#l4.1054"></a><span id="l4.1054">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdAEAttributes.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdAEAttributes.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -3,24 +3,19 @@</span>
<a href="#l5.4"></a><span id="l5.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> // HTML Attributes object for &quot;Name&quot; menulist</span>
<a href="#l5.7"></a><span id="l5.7"> var gHTMLAttr = {};</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9"> // JS Events Attributes object for &quot;Name&quot; menulist</span>
<a href="#l5.10"></a><span id="l5.10"> var gJSAttr = {};</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-</span>
<a href="#l5.13"></a><span id="l5.13"> // Core HTML attribute values //</span>
<a href="#l5.14"></a><span id="l5.14"> // This is appended to Name menulist when &quot;_core&quot; is attribute name</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-var gCoreHTMLAttr = [</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-  &quot;^id&quot;,</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-  &quot;class&quot;,</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-  &quot;title&quot;,</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-];</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+var gCoreHTMLAttr = [&quot;^id&quot;, &quot;class&quot;, &quot;title&quot;];</span>
<a href="#l5.21"></a><span id="l5.21"> </span>
<a href="#l5.22"></a><span id="l5.22"> // Core event attribute values //</span>
<a href="#l5.23"></a><span id="l5.23"> // This is appended to all JS menulists</span>
<a href="#l5.24"></a><span id="l5.24"> //   except those elements having &quot;noJSEvents&quot;</span>
<a href="#l5.25"></a><span id="l5.25"> //   as a value in their gJSAttr array.</span>
<a href="#l5.26"></a><span id="l5.26"> var gCoreJSEvents = [</span>
<a href="#l5.27"></a><span id="l5.27">   &quot;onclick&quot;,</span>
<a href="#l5.28"></a><span id="l5.28">   &quot;ondblclick&quot;,</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineat">@@ -52,50 +47,25 @@ var gHTMLColors = [</span>
<a href="#l5.30"></a><span id="l5.30">   &quot;Purple&quot;,</span>
<a href="#l5.31"></a><span id="l5.31">   &quot;Red&quot;,</span>
<a href="#l5.32"></a><span id="l5.32">   &quot;Silver&quot;,</span>
<a href="#l5.33"></a><span id="l5.33">   &quot;Teal&quot;,</span>
<a href="#l5.34"></a><span id="l5.34">   &quot;White&quot;,</span>
<a href="#l5.35"></a><span id="l5.35">   &quot;Yellow&quot;,</span>
<a href="#l5.36"></a><span id="l5.36"> ];</span>
<a href="#l5.37"></a><span id="l5.37"> </span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-var gHAlign = [</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-  &quot;left&quot;,</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-  &quot;center&quot;,</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-  &quot;right&quot;,</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-];</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+var gHAlign = [&quot;left&quot;, &quot;center&quot;, &quot;right&quot;];</span>
<a href="#l5.44"></a><span id="l5.44"> </span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-var gHAlignJustify = [</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-  &quot;left&quot;,</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-  &quot;center&quot;,</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-  &quot;right&quot;,</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-  &quot;justify&quot;,</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-];</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+var gHAlignJustify = [&quot;left&quot;, &quot;center&quot;, &quot;right&quot;, &quot;justify&quot;];</span>
<a href="#l5.52"></a><span id="l5.52"> </span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-var gHAlignTableContent = [</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-  &quot;left&quot;,</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-  &quot;center&quot;,</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-  &quot;right&quot;,</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-  &quot;justify&quot;,</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-  &quot;char&quot;,</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-];</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+var gHAlignTableContent = [&quot;left&quot;, &quot;center&quot;, &quot;right&quot;, &quot;justify&quot;, &quot;char&quot;];</span>
<a href="#l5.61"></a><span id="l5.61"> </span>
<a href="#l5.62"></a><span id="l5.62" class="difflineminus">-var gVAlignTable = [</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineminus">-  &quot;top&quot;,</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">-  &quot;middle&quot;,</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-  &quot;bottom&quot;,</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineminus">-  &quot;baseline&quot;,</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineminus">-];</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+var gVAlignTable = [&quot;top&quot;, &quot;middle&quot;, &quot;bottom&quot;, &quot;baseline&quot;];</span>
<a href="#l5.69"></a><span id="l5.69"> </span>
<a href="#l5.70"></a><span id="l5.70" class="difflineminus">-var gTarget = [</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineminus">-  &quot;_blank&quot;,</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">-  &quot;_self&quot;,</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">-  &quot;_parent&quot;,</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineminus">-  &quot;_top&quot;,</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineminus">-];</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+var gTarget = [&quot;_blank&quot;, &quot;_self&quot;, &quot;_parent&quot;, &quot;_top&quot;];</span>
<a href="#l5.77"></a><span id="l5.77"> </span>
<a href="#l5.78"></a><span id="l5.78"> // ================ HTML Attributes ================ //</span>
<a href="#l5.79"></a><span id="l5.79"> /* For each element, there is an array of attributes,</span>
<a href="#l5.80"></a><span id="l5.80">    whose name is the element name,</span>
<a href="#l5.81"></a><span id="l5.81">    used to fill the &quot;Attribute Name&quot; menulist.</span>
<a href="#l5.82"></a><span id="l5.82">    For each of those attributes, if they have a specific</span>
<a href="#l5.83"></a><span id="l5.83">    set of values, those are listed in an array named:</span>
<a href="#l5.84"></a><span id="l5.84">    &quot;elementName_attName&quot;.</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineat">@@ -111,34 +81,30 @@ var gTarget = [</span>
<a href="#l5.86"></a><span id="l5.86"> */</span>
<a href="#l5.87"></a><span id="l5.87"> </span>
<a href="#l5.88"></a><span id="l5.88"> /*</span>
<a href="#l5.89"></a><span id="l5.89">    Most elements have the &quot;dir&quot; attribute,</span>
<a href="#l5.90"></a><span id="l5.90">    so we use this value array</span>
<a href="#l5.91"></a><span id="l5.91">    for all elements instead of specifying</span>
<a href="#l5.92"></a><span id="l5.92">    separately for each element</span>
<a href="#l5.93"></a><span id="l5.93"> */</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineminus">-gHTMLAttr.all_dir = [</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineminus">-  &quot;ltr&quot;,</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">-  &quot;rtl&quot;,</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineminus">-];</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineminus">-</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+gHTMLAttr.all_dir = [&quot;ltr&quot;, &quot;rtl&quot;];</span>
<a href="#l5.100"></a><span id="l5.100"> </span>
<a href="#l5.101"></a><span id="l5.101"> gHTMLAttr.a = [</span>
<a href="#l5.102"></a><span id="l5.102">   &quot;charset&quot;,</span>
<a href="#l5.103"></a><span id="l5.103">   &quot;type&quot;,</span>
<a href="#l5.104"></a><span id="l5.104">   &quot;name&quot;,</span>
<a href="#l5.105"></a><span id="l5.105">   &quot;href&quot;,</span>
<a href="#l5.106"></a><span id="l5.106">   &quot;^hreflang&quot;,</span>
<a href="#l5.107"></a><span id="l5.107">   &quot;target&quot;,</span>
<a href="#l5.108"></a><span id="l5.108">   &quot;rel&quot;,</span>
<a href="#l5.109"></a><span id="l5.109">   &quot;rev&quot;,</span>
<a href="#l5.110"></a><span id="l5.110">   &quot;!accesskey&quot;,</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineminus">-  &quot;shape&quot;,   // with imagemap //</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineminus">-  &quot;coords&quot;,  // with imagemap //</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+  &quot;shape&quot;, // with imagemap //</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+  &quot;coords&quot;, // with imagemap //</span>
<a href="#l5.115"></a><span id="l5.115">   &quot;#tabindex&quot;,</span>
<a href="#l5.116"></a><span id="l5.116">   &quot;-&quot;,</span>
<a href="#l5.117"></a><span id="l5.117">   &quot;_core&quot;,</span>
<a href="#l5.118"></a><span id="l5.118">   &quot;-&quot;,</span>
<a href="#l5.119"></a><span id="l5.119">   &quot;^lang&quot;,</span>
<a href="#l5.120"></a><span id="l5.120">   &quot;dir&quot;,</span>
<a href="#l5.121"></a><span id="l5.121"> ];</span>
<a href="#l5.122"></a><span id="l5.122"> </span>
<a href="#l5.123"></a><span id="l5.123" class="difflineat">@@ -175,43 +141,23 @@ gHTMLAttr.a_rev = [</span>
<a href="#l5.124"></a><span id="l5.124">   &quot;chapter&quot;,</span>
<a href="#l5.125"></a><span id="l5.125">   &quot;section&quot;,</span>
<a href="#l5.126"></a><span id="l5.126">   &quot;subsection&quot;,</span>
<a href="#l5.127"></a><span id="l5.127">   &quot;appendix&quot;,</span>
<a href="#l5.128"></a><span id="l5.128">   &quot;help&quot;,</span>
<a href="#l5.129"></a><span id="l5.129">   &quot;bookmark&quot;,</span>
<a href="#l5.130"></a><span id="l5.130"> ];</span>
<a href="#l5.131"></a><span id="l5.131"> </span>
<a href="#l5.132"></a><span id="l5.132" class="difflineminus">-gHTMLAttr.a_shape = [</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineminus">-  &quot;rect&quot;,</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineminus">-  &quot;circle&quot;,</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineminus">-  &quot;poly&quot;,</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineminus">-  &quot;default&quot;,</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineminus">-];</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+gHTMLAttr.a_shape = [&quot;rect&quot;, &quot;circle&quot;, &quot;poly&quot;, &quot;default&quot;];</span>
<a href="#l5.139"></a><span id="l5.139"> </span>
<a href="#l5.140"></a><span id="l5.140" class="difflineminus">-gHTMLAttr.abbr = [</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineminus">-];</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+gHTMLAttr.abbr = [&quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.147"></a><span id="l5.147"> </span>
<a href="#l5.148"></a><span id="l5.148" class="difflineminus">-gHTMLAttr.acronym = [</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineminus">-];</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineplus">+gHTMLAttr.acronym = [&quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.155"></a><span id="l5.155"> </span>
<a href="#l5.156"></a><span id="l5.156" class="difflineminus">-gHTMLAttr.address = [</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineminus">-];</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineplus">+gHTMLAttr.address = [&quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.163"></a><span id="l5.163"> </span>
<a href="#l5.164"></a><span id="l5.164"> // this is deprecated //</span>
<a href="#l5.165"></a><span id="l5.165"> gHTMLAttr.applet = [</span>
<a href="#l5.166"></a><span id="l5.166">   &quot;codebase&quot;,</span>
<a href="#l5.167"></a><span id="l5.167">   &quot;archive&quot;,</span>
<a href="#l5.168"></a><span id="l5.168">   &quot;code&quot;,</span>
<a href="#l5.169"></a><span id="l5.169">   &quot;object&quot;,</span>
<a href="#l5.170"></a><span id="l5.170">   &quot;alt&quot;,</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineat">@@ -220,23 +166,17 @@ gHTMLAttr.applet = [</span>
<a href="#l5.172"></a><span id="l5.172">   &quot;%$height&quot;,</span>
<a href="#l5.173"></a><span id="l5.173">   &quot;align&quot;,</span>
<a href="#l5.174"></a><span id="l5.174">   &quot;#hspace&quot;,</span>
<a href="#l5.175"></a><span id="l5.175">   &quot;#vspace&quot;,</span>
<a href="#l5.176"></a><span id="l5.176">   &quot;-&quot;,</span>
<a href="#l5.177"></a><span id="l5.177">   &quot;_core&quot;,</span>
<a href="#l5.178"></a><span id="l5.178"> ];</span>
<a href="#l5.179"></a><span id="l5.179"> </span>
<a href="#l5.180"></a><span id="l5.180" class="difflineminus">-gHTMLAttr.applet_align = [</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineminus">-  &quot;top&quot;,</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineminus">-  &quot;middle&quot;,</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineminus">-  &quot;bottom&quot;,</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineminus">-  &quot;left&quot;,</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineminus">-  &quot;right&quot;,</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineminus">-];</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineplus">+gHTMLAttr.applet_align = [&quot;top&quot;, &quot;middle&quot;, &quot;bottom&quot;, &quot;left&quot;, &quot;right&quot;];</span>
<a href="#l5.188"></a><span id="l5.188"> </span>
<a href="#l5.189"></a><span id="l5.189"> gHTMLAttr.area = [</span>
<a href="#l5.190"></a><span id="l5.190">   &quot;shape&quot;,</span>
<a href="#l5.191"></a><span id="l5.191">   &quot;coords&quot;,</span>
<a href="#l5.192"></a><span id="l5.192">   &quot;href&quot;,</span>
<a href="#l5.193"></a><span id="l5.193">   &quot;nohref&quot;,</span>
<a href="#l5.194"></a><span id="l5.194">   &quot;target&quot;,</span>
<a href="#l5.195"></a><span id="l5.195">   &quot;$alt&quot;,</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineat">@@ -246,78 +186,38 @@ gHTMLAttr.area = [</span>
<a href="#l5.197"></a><span id="l5.197">   &quot;_core&quot;,</span>
<a href="#l5.198"></a><span id="l5.198">   &quot;-&quot;,</span>
<a href="#l5.199"></a><span id="l5.199">   &quot;^lang&quot;,</span>
<a href="#l5.200"></a><span id="l5.200">   &quot;dir&quot;,</span>
<a href="#l5.201"></a><span id="l5.201"> ];</span>
<a href="#l5.202"></a><span id="l5.202"> </span>
<a href="#l5.203"></a><span id="l5.203"> gHTMLAttr.area_target = gTarget;</span>
<a href="#l5.204"></a><span id="l5.204"> </span>
<a href="#l5.205"></a><span id="l5.205" class="difflineminus">-gHTMLAttr.area_shape = [</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineminus">-  &quot;rect&quot;,</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineminus">-  &quot;circle&quot;,</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineminus">-  &quot;poly&quot;,</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineminus">-  &quot;default&quot;,</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineminus">-];</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineplus">+gHTMLAttr.area_shape = [&quot;rect&quot;, &quot;circle&quot;, &quot;poly&quot;, &quot;default&quot;];</span>
<a href="#l5.212"></a><span id="l5.212"> </span>
<a href="#l5.213"></a><span id="l5.213" class="difflineminus">-gHTMLAttr.area_nohref = [</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineminus">-  &quot;nohref&quot;,</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineminus">-];</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineplus">+gHTMLAttr.area_nohref = [&quot;nohref&quot;];</span>
<a href="#l5.217"></a><span id="l5.217"> </span>
<a href="#l5.218"></a><span id="l5.218" class="difflineminus">-gHTMLAttr.b = [</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineminus">-];</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineplus">+gHTMLAttr.b = [&quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.225"></a><span id="l5.225"> </span>
<a href="#l5.226"></a><span id="l5.226" class="difflineminus">-gHTMLAttr.base = [</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineminus">-  &quot;href&quot;,</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineminus">-  &quot;target&quot;,</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineminus">-];</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineplus">+gHTMLAttr.base = [&quot;href&quot;, &quot;target&quot;];</span>
<a href="#l5.231"></a><span id="l5.231"> </span>
<a href="#l5.232"></a><span id="l5.232"> gHTMLAttr.base_target = gTarget;</span>
<a href="#l5.233"></a><span id="l5.233"> </span>
<a href="#l5.234"></a><span id="l5.234"> // this is deprecated //</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineminus">-gHTMLAttr.basefont = [</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineminus">-  &quot;^id&quot;,</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineminus">-  &quot;$size&quot;,</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineminus">-  &quot;color&quot;,</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineminus">-  &quot;face&quot;,</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineminus">-];</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineplus">+gHTMLAttr.basefont = [&quot;^id&quot;, &quot;$size&quot;, &quot;color&quot;, &quot;face&quot;];</span>
<a href="#l5.242"></a><span id="l5.242"> </span>
<a href="#l5.243"></a><span id="l5.243"> gHTMLAttr.basefont_color = gHTMLColors;</span>
<a href="#l5.244"></a><span id="l5.244"> </span>
<a href="#l5.245"></a><span id="l5.245" class="difflineminus">-gHTMLAttr.bdo = [</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineminus">-  &quot;$dir&quot;,</span>
<a href="#l5.250"></a><span id="l5.250" class="difflineminus">-];</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineplus">+gHTMLAttr.bdo = [&quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;$dir&quot;];</span>
<a href="#l5.252"></a><span id="l5.252"> </span>
<a href="#l5.253"></a><span id="l5.253" class="difflineminus">-gHTMLAttr.bdo_dir = [</span>
<a href="#l5.254"></a><span id="l5.254" class="difflineminus">-  &quot;ltr&quot;,</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineminus">-  &quot;rtl&quot;,</span>
<a href="#l5.256"></a><span id="l5.256" class="difflineminus">-];</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineplus">+gHTMLAttr.bdo_dir = [&quot;ltr&quot;, &quot;rtl&quot;];</span>
<a href="#l5.258"></a><span id="l5.258"> </span>
<a href="#l5.259"></a><span id="l5.259" class="difflineminus">-gHTMLAttr.big = [</span>
<a href="#l5.260"></a><span id="l5.260" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineminus">-];</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineplus">+gHTMLAttr.big = [&quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.266"></a><span id="l5.266"> </span>
<a href="#l5.267"></a><span id="l5.267" class="difflineminus">-gHTMLAttr.blockquote = [</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineminus">-  &quot;cite&quot;,</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.270"></a><span id="l5.270" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineminus">-];</span>
<a href="#l5.275"></a><span id="l5.275" class="difflineplus">+gHTMLAttr.blockquote = [&quot;cite&quot;, &quot;-&quot;, &quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.276"></a><span id="l5.276"> </span>
<a href="#l5.277"></a><span id="l5.277"> gHTMLAttr.body = [</span>
<a href="#l5.278"></a><span id="l5.278">   &quot;background&quot;,</span>
<a href="#l5.279"></a><span id="l5.279">   &quot;bgcolor&quot;,</span>
<a href="#l5.280"></a><span id="l5.280">   &quot;text&quot;,</span>
<a href="#l5.281"></a><span id="l5.281">   &quot;link&quot;,</span>
<a href="#l5.282"></a><span id="l5.282">   &quot;vlink&quot;,</span>
<a href="#l5.283"></a><span id="l5.283">   &quot;alink&quot;,</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineat">@@ -333,91 +233,48 @@ gHTMLAttr.body_bgcolor = gHTMLColors;</span>
<a href="#l5.285"></a><span id="l5.285"> gHTMLAttr.body_text = gHTMLColors;</span>
<a href="#l5.286"></a><span id="l5.286"> </span>
<a href="#l5.287"></a><span id="l5.287"> gHTMLAttr.body_link = gHTMLColors;</span>
<a href="#l5.288"></a><span id="l5.288"> </span>
<a href="#l5.289"></a><span id="l5.289"> gHTMLAttr.body_vlink = gHTMLColors;</span>
<a href="#l5.290"></a><span id="l5.290"> </span>
<a href="#l5.291"></a><span id="l5.291"> gHTMLAttr.body_alink = gHTMLColors;</span>
<a href="#l5.292"></a><span id="l5.292"> </span>
<a href="#l5.293"></a><span id="l5.293" class="difflineminus">-gHTMLAttr.br = [</span>
<a href="#l5.294"></a><span id="l5.294" class="difflineminus">-  &quot;clear&quot;,</span>
<a href="#l5.295"></a><span id="l5.295" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.296"></a><span id="l5.296" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.297"></a><span id="l5.297" class="difflineminus">-];</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineplus">+gHTMLAttr.br = [&quot;clear&quot;, &quot;-&quot;, &quot;_core&quot;];</span>
<a href="#l5.299"></a><span id="l5.299"> </span>
<a href="#l5.300"></a><span id="l5.300" class="difflineminus">-gHTMLAttr.br_clear = [</span>
<a href="#l5.301"></a><span id="l5.301" class="difflineminus">-  &quot;none&quot;,</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineminus">-  &quot;left&quot;,</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineminus">-  &quot;all&quot;,</span>
<a href="#l5.304"></a><span id="l5.304" class="difflineminus">-  &quot;right&quot;,</span>
<a href="#l5.305"></a><span id="l5.305" class="difflineminus">-];</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineplus">+gHTMLAttr.br_clear = [&quot;none&quot;, &quot;left&quot;, &quot;all&quot;, &quot;right&quot;];</span>
<a href="#l5.307"></a><span id="l5.307"> </span>
<a href="#l5.308"></a><span id="l5.308"> gHTMLAttr.button = [</span>
<a href="#l5.309"></a><span id="l5.309">   &quot;name&quot;,</span>
<a href="#l5.310"></a><span id="l5.310">   &quot;value&quot;,</span>
<a href="#l5.311"></a><span id="l5.311">   &quot;$type&quot;,</span>
<a href="#l5.312"></a><span id="l5.312">   &quot;disabled&quot;,</span>
<a href="#l5.313"></a><span id="l5.313">   &quot;#tabindex&quot;,</span>
<a href="#l5.314"></a><span id="l5.314">   &quot;!accesskey&quot;,</span>
<a href="#l5.315"></a><span id="l5.315">   &quot;-&quot;,</span>
<a href="#l5.316"></a><span id="l5.316">   &quot;_core&quot;,</span>
<a href="#l5.317"></a><span id="l5.317">   &quot;-&quot;,</span>
<a href="#l5.318"></a><span id="l5.318">   &quot;^lang&quot;,</span>
<a href="#l5.319"></a><span id="l5.319">   &quot;dir&quot;,</span>
<a href="#l5.320"></a><span id="l5.320"> ];</span>
<a href="#l5.321"></a><span id="l5.321"> </span>
<a href="#l5.322"></a><span id="l5.322" class="difflineminus">-gHTMLAttr.button_type = [</span>
<a href="#l5.323"></a><span id="l5.323" class="difflineminus">-  &quot;submit&quot;,</span>
<a href="#l5.324"></a><span id="l5.324" class="difflineminus">-  &quot;button&quot;,</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineminus">-  &quot;reset&quot;,</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineminus">-];</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineplus">+gHTMLAttr.button_type = [&quot;submit&quot;, &quot;button&quot;, &quot;reset&quot;];</span>
<a href="#l5.328"></a><span id="l5.328"> </span>
<a href="#l5.329"></a><span id="l5.329" class="difflineminus">-gHTMLAttr.button_disabled = [</span>
<a href="#l5.330"></a><span id="l5.330" class="difflineminus">-  &quot;disabled&quot;,</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineminus">-];</span>
<a href="#l5.332"></a><span id="l5.332" class="difflineplus">+gHTMLAttr.button_disabled = [&quot;disabled&quot;];</span>
<a href="#l5.333"></a><span id="l5.333"> </span>
<a href="#l5.334"></a><span id="l5.334" class="difflineminus">-gHTMLAttr.caption = [</span>
<a href="#l5.335"></a><span id="l5.335" class="difflineminus">-  &quot;align&quot;,</span>
<a href="#l5.336"></a><span id="l5.336" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.337"></a><span id="l5.337" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.338"></a><span id="l5.338" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.339"></a><span id="l5.339" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.340"></a><span id="l5.340" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.341"></a><span id="l5.341" class="difflineminus">-];</span>
<a href="#l5.342"></a><span id="l5.342" class="difflineplus">+gHTMLAttr.caption = [&quot;align&quot;, &quot;-&quot;, &quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.343"></a><span id="l5.343"> </span>
<a href="#l5.344"></a><span id="l5.344" class="difflineminus">-gHTMLAttr.caption_align = [</span>
<a href="#l5.345"></a><span id="l5.345" class="difflineminus">-  &quot;top&quot;,</span>
<a href="#l5.346"></a><span id="l5.346" class="difflineminus">-  &quot;bottom&quot;,</span>
<a href="#l5.347"></a><span id="l5.347" class="difflineminus">-  &quot;left&quot;,</span>
<a href="#l5.348"></a><span id="l5.348" class="difflineminus">-  &quot;right&quot;,</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineminus">-];</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineminus">-</span>
<a href="#l5.351"></a><span id="l5.351" class="difflineplus">+gHTMLAttr.caption_align = [&quot;top&quot;, &quot;bottom&quot;, &quot;left&quot;, &quot;right&quot;];</span>
<a href="#l5.352"></a><span id="l5.352"> </span>
<a href="#l5.353"></a><span id="l5.353"> // this is deprecated //</span>
<a href="#l5.354"></a><span id="l5.354" class="difflineminus">-gHTMLAttr.center = [</span>
<a href="#l5.355"></a><span id="l5.355" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.356"></a><span id="l5.356" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.357"></a><span id="l5.357" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.358"></a><span id="l5.358" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.359"></a><span id="l5.359" class="difflineminus">-];</span>
<a href="#l5.360"></a><span id="l5.360" class="difflineplus">+gHTMLAttr.center = [&quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.361"></a><span id="l5.361"> </span>
<a href="#l5.362"></a><span id="l5.362" class="difflineminus">-gHTMLAttr.cite = [</span>
<a href="#l5.363"></a><span id="l5.363" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.364"></a><span id="l5.364" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.365"></a><span id="l5.365" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.366"></a><span id="l5.366" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.367"></a><span id="l5.367" class="difflineminus">-];</span>
<a href="#l5.368"></a><span id="l5.368" class="difflineplus">+gHTMLAttr.cite = [&quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.369"></a><span id="l5.369"> </span>
<a href="#l5.370"></a><span id="l5.370" class="difflineminus">-gHTMLAttr.code = [</span>
<a href="#l5.371"></a><span id="l5.371" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.372"></a><span id="l5.372" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.373"></a><span id="l5.373" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.374"></a><span id="l5.374" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.375"></a><span id="l5.375" class="difflineminus">-];</span>
<a href="#l5.376"></a><span id="l5.376" class="difflineplus">+gHTMLAttr.code = [&quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.377"></a><span id="l5.377"> </span>
<a href="#l5.378"></a><span id="l5.378"> gHTMLAttr.col = [</span>
<a href="#l5.379"></a><span id="l5.379">   &quot;#$span&quot;,</span>
<a href="#l5.380"></a><span id="l5.380">   &quot;%width&quot;,</span>
<a href="#l5.381"></a><span id="l5.381">   &quot;align&quot;,</span>
<a href="#l5.382"></a><span id="l5.382">   &quot;!char&quot;,</span>
<a href="#l5.383"></a><span id="l5.383">   &quot;#charoff&quot;,</span>
<a href="#l5.384"></a><span id="l5.384">   &quot;valign&quot;,</span>
<a href="#l5.385"></a><span id="l5.385" class="difflineat">@@ -425,28 +282,22 @@ gHTMLAttr.col = [</span>
<a href="#l5.386"></a><span id="l5.386">   &quot;-&quot;,</span>
<a href="#l5.387"></a><span id="l5.387">   &quot;_core&quot;,</span>
<a href="#l5.388"></a><span id="l5.388">   &quot;-&quot;,</span>
<a href="#l5.389"></a><span id="l5.389">   &quot;^lang&quot;,</span>
<a href="#l5.390"></a><span id="l5.390">   &quot;dir&quot;,</span>
<a href="#l5.391"></a><span id="l5.391"> ];</span>
<a href="#l5.392"></a><span id="l5.392"> </span>
<a href="#l5.393"></a><span id="l5.393"> gHTMLAttr.col_span = [</span>
<a href="#l5.394"></a><span id="l5.394" class="difflineminus">-  &quot;1&quot;,  // default</span>
<a href="#l5.395"></a><span id="l5.395" class="difflineplus">+  &quot;1&quot;, // default</span>
<a href="#l5.396"></a><span id="l5.396"> ];</span>
<a href="#l5.397"></a><span id="l5.397"> </span>
<a href="#l5.398"></a><span id="l5.398"> gHTMLAttr.col_align = gHAlignTableContent;</span>
<a href="#l5.399"></a><span id="l5.399"> </span>
<a href="#l5.400"></a><span id="l5.400" class="difflineminus">-gHTMLAttr.col_valign = [</span>
<a href="#l5.401"></a><span id="l5.401" class="difflineminus">-  &quot;top&quot;,</span>
<a href="#l5.402"></a><span id="l5.402" class="difflineminus">-  &quot;middle&quot;,</span>
<a href="#l5.403"></a><span id="l5.403" class="difflineminus">-  &quot;bottom&quot;,</span>
<a href="#l5.404"></a><span id="l5.404" class="difflineminus">-  &quot;baseline&quot;,</span>
<a href="#l5.405"></a><span id="l5.405" class="difflineminus">-];</span>
<a href="#l5.406"></a><span id="l5.406" class="difflineminus">-</span>
<a href="#l5.407"></a><span id="l5.407" class="difflineplus">+gHTMLAttr.col_valign = [&quot;top&quot;, &quot;middle&quot;, &quot;bottom&quot;, &quot;baseline&quot;];</span>
<a href="#l5.408"></a><span id="l5.408"> </span>
<a href="#l5.409"></a><span id="l5.409"> gHTMLAttr.colgroup = [</span>
<a href="#l5.410"></a><span id="l5.410">   &quot;#$span&quot;,</span>
<a href="#l5.411"></a><span id="l5.411">   &quot;%width&quot;,</span>
<a href="#l5.412"></a><span id="l5.412">   &quot;align&quot;,</span>
<a href="#l5.413"></a><span id="l5.413">   &quot;!char&quot;,</span>
<a href="#l5.414"></a><span id="l5.414">   &quot;#charoff&quot;,</span>
<a href="#l5.415"></a><span id="l5.415">   &quot;valign&quot;,</span>
<a href="#l5.416"></a><span id="l5.416" class="difflineat">@@ -458,117 +309,45 @@ gHTMLAttr.colgroup = [</span>
<a href="#l5.417"></a><span id="l5.417"> ];</span>
<a href="#l5.418"></a><span id="l5.418"> </span>
<a href="#l5.419"></a><span id="l5.419"> gHTMLAttr.colgroup_span = [</span>
<a href="#l5.420"></a><span id="l5.420">   &quot;1&quot;, // default</span>
<a href="#l5.421"></a><span id="l5.421"> ];</span>
<a href="#l5.422"></a><span id="l5.422"> </span>
<a href="#l5.423"></a><span id="l5.423"> gHTMLAttr.colgroup_align = gHAlignTableContent;</span>
<a href="#l5.424"></a><span id="l5.424"> </span>
<a href="#l5.425"></a><span id="l5.425" class="difflineminus">-gHTMLAttr.colgroup_valign = [</span>
<a href="#l5.426"></a><span id="l5.426" class="difflineminus">-  &quot;top&quot;,</span>
<a href="#l5.427"></a><span id="l5.427" class="difflineminus">-  &quot;middle&quot;,</span>
<a href="#l5.428"></a><span id="l5.428" class="difflineminus">-  &quot;bottom&quot;,</span>
<a href="#l5.429"></a><span id="l5.429" class="difflineminus">-  &quot;baseline&quot;,</span>
<a href="#l5.430"></a><span id="l5.430" class="difflineminus">-];</span>
<a href="#l5.431"></a><span id="l5.431" class="difflineplus">+gHTMLAttr.colgroup_valign = [&quot;top&quot;, &quot;middle&quot;, &quot;bottom&quot;, &quot;baseline&quot;];</span>
<a href="#l5.432"></a><span id="l5.432"> </span>
<a href="#l5.433"></a><span id="l5.433" class="difflineminus">-gHTMLAttr.dd = [</span>
<a href="#l5.434"></a><span id="l5.434" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.435"></a><span id="l5.435" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.436"></a><span id="l5.436" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.437"></a><span id="l5.437" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.438"></a><span id="l5.438" class="difflineminus">-];</span>
<a href="#l5.439"></a><span id="l5.439" class="difflineplus">+gHTMLAttr.dd = [&quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.440"></a><span id="l5.440"> </span>
<a href="#l5.441"></a><span id="l5.441" class="difflineminus">-gHTMLAttr.del = [</span>
<a href="#l5.442"></a><span id="l5.442" class="difflineminus">-  &quot;cite&quot;,</span>
<a href="#l5.443"></a><span id="l5.443" class="difflineminus">-  &quot;datetime&quot;,</span>
<a href="#l5.444"></a><span id="l5.444" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.445"></a><span id="l5.445" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.446"></a><span id="l5.446" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.447"></a><span id="l5.447" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.448"></a><span id="l5.448" class="difflineminus">-];</span>
<a href="#l5.449"></a><span id="l5.449" class="difflineplus">+gHTMLAttr.del = [&quot;cite&quot;, &quot;datetime&quot;, &quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.450"></a><span id="l5.450"> </span>
<a href="#l5.451"></a><span id="l5.451" class="difflineminus">-gHTMLAttr.dfn = [</span>
<a href="#l5.452"></a><span id="l5.452" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.453"></a><span id="l5.453" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.454"></a><span id="l5.454" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.455"></a><span id="l5.455" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.456"></a><span id="l5.456" class="difflineminus">-];</span>
<a href="#l5.457"></a><span id="l5.457" class="difflineplus">+gHTMLAttr.dfn = [&quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.458"></a><span id="l5.458"> </span>
<a href="#l5.459"></a><span id="l5.459"> // this is deprecated //</span>
<a href="#l5.460"></a><span id="l5.460" class="difflineminus">-gHTMLAttr.dir = [</span>
<a href="#l5.461"></a><span id="l5.461" class="difflineminus">-  &quot;compact&quot;,</span>
<a href="#l5.462"></a><span id="l5.462" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.463"></a><span id="l5.463" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.464"></a><span id="l5.464" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.465"></a><span id="l5.465" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.466"></a><span id="l5.466" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.467"></a><span id="l5.467" class="difflineminus">-];</span>
<a href="#l5.468"></a><span id="l5.468" class="difflineplus">+gHTMLAttr.dir = [&quot;compact&quot;, &quot;-&quot;, &quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.469"></a><span id="l5.469"> </span>
<a href="#l5.470"></a><span id="l5.470" class="difflineminus">-gHTMLAttr.dir_compact = [</span>
<a href="#l5.471"></a><span id="l5.471" class="difflineminus">-  &quot;compact&quot;,</span>
<a href="#l5.472"></a><span id="l5.472" class="difflineminus">-];</span>
<a href="#l5.473"></a><span id="l5.473" class="difflineplus">+gHTMLAttr.dir_compact = [&quot;compact&quot;];</span>
<a href="#l5.474"></a><span id="l5.474"> </span>
<a href="#l5.475"></a><span id="l5.475" class="difflineminus">-gHTMLAttr.div = [</span>
<a href="#l5.476"></a><span id="l5.476" class="difflineminus">-  &quot;align&quot;,</span>
<a href="#l5.477"></a><span id="l5.477" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.478"></a><span id="l5.478" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.479"></a><span id="l5.479" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.480"></a><span id="l5.480" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.481"></a><span id="l5.481" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.482"></a><span id="l5.482" class="difflineminus">-];</span>
<a href="#l5.483"></a><span id="l5.483" class="difflineplus">+gHTMLAttr.div = [&quot;align&quot;, &quot;-&quot;, &quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.484"></a><span id="l5.484"> </span>
<a href="#l5.485"></a><span id="l5.485"> gHTMLAttr.div_align = gHAlignJustify;</span>
<a href="#l5.486"></a><span id="l5.486"> </span>
<a href="#l5.487"></a><span id="l5.487" class="difflineminus">-gHTMLAttr.dl = [</span>
<a href="#l5.488"></a><span id="l5.488" class="difflineminus">-  &quot;compact&quot;,</span>
<a href="#l5.489"></a><span id="l5.489" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.490"></a><span id="l5.490" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.491"></a><span id="l5.491" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.492"></a><span id="l5.492" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.493"></a><span id="l5.493" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.494"></a><span id="l5.494" class="difflineminus">-];</span>
<a href="#l5.495"></a><span id="l5.495" class="difflineplus">+gHTMLAttr.dl = [&quot;compact&quot;, &quot;-&quot;, &quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.496"></a><span id="l5.496"> </span>
<a href="#l5.497"></a><span id="l5.497" class="difflineminus">-gHTMLAttr.dl_compact = [</span>
<a href="#l5.498"></a><span id="l5.498" class="difflineminus">-  &quot;compact&quot;,</span>
<a href="#l5.499"></a><span id="l5.499" class="difflineminus">-];</span>
<a href="#l5.500"></a><span id="l5.500" class="difflineminus">-</span>
<a href="#l5.501"></a><span id="l5.501" class="difflineplus">+gHTMLAttr.dl_compact = [&quot;compact&quot;];</span>
<a href="#l5.502"></a><span id="l5.502"> </span>
<a href="#l5.503"></a><span id="l5.503" class="difflineminus">-gHTMLAttr.dt = [</span>
<a href="#l5.504"></a><span id="l5.504" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.505"></a><span id="l5.505" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.506"></a><span id="l5.506" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.507"></a><span id="l5.507" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.508"></a><span id="l5.508" class="difflineminus">-];</span>
<a href="#l5.509"></a><span id="l5.509" class="difflineplus">+gHTMLAttr.dt = [&quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.510"></a><span id="l5.510"> </span>
<a href="#l5.511"></a><span id="l5.511" class="difflineminus">-gHTMLAttr.em = [</span>
<a href="#l5.512"></a><span id="l5.512" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.513"></a><span id="l5.513" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.514"></a><span id="l5.514" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.515"></a><span id="l5.515" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.516"></a><span id="l5.516" class="difflineminus">-];</span>
<a href="#l5.517"></a><span id="l5.517" class="difflineplus">+gHTMLAttr.em = [&quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.518"></a><span id="l5.518"> </span>
<a href="#l5.519"></a><span id="l5.519" class="difflineminus">-gHTMLAttr.fieldset = [</span>
<a href="#l5.520"></a><span id="l5.520" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.521"></a><span id="l5.521" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.522"></a><span id="l5.522" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.523"></a><span id="l5.523" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.524"></a><span id="l5.524" class="difflineminus">-];</span>
<a href="#l5.525"></a><span id="l5.525" class="difflineplus">+gHTMLAttr.fieldset = [&quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.526"></a><span id="l5.526"> </span>
<a href="#l5.527"></a><span id="l5.527"> // this is deprecated //</span>
<a href="#l5.528"></a><span id="l5.528" class="difflineminus">-gHTMLAttr.font = [</span>
<a href="#l5.529"></a><span id="l5.529" class="difflineminus">-  &quot;+size&quot;,</span>
<a href="#l5.530"></a><span id="l5.530" class="difflineminus">-  &quot;color&quot;,</span>
<a href="#l5.531"></a><span id="l5.531" class="difflineminus">-  &quot;face&quot;,</span>
<a href="#l5.532"></a><span id="l5.532" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.533"></a><span id="l5.533" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.534"></a><span id="l5.534" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.535"></a><span id="l5.535" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.536"></a><span id="l5.536" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.537"></a><span id="l5.537" class="difflineminus">-];</span>
<a href="#l5.538"></a><span id="l5.538" class="difflineplus">+gHTMLAttr.font = [&quot;+size&quot;, &quot;color&quot;, &quot;face&quot;, &quot;-&quot;, &quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.539"></a><span id="l5.539"> </span>
<a href="#l5.540"></a><span id="l5.540"> gHTMLAttr.font_color = gHTMLColors;</span>
<a href="#l5.541"></a><span id="l5.541"> </span>
<a href="#l5.542"></a><span id="l5.542"> gHTMLAttr.form = [</span>
<a href="#l5.543"></a><span id="l5.543">   &quot;$action&quot;,</span>
<a href="#l5.544"></a><span id="l5.544">   &quot;$method&quot;,</span>
<a href="#l5.545"></a><span id="l5.545">   &quot;enctype&quot;,</span>
<a href="#l5.546"></a><span id="l5.546">   &quot;accept&quot;,</span>
<a href="#l5.547"></a><span id="l5.547" class="difflineat">@@ -577,201 +356,107 @@ gHTMLAttr.form = [</span>
<a href="#l5.548"></a><span id="l5.548">   &quot;target&quot;,</span>
<a href="#l5.549"></a><span id="l5.549">   &quot;-&quot;,</span>
<a href="#l5.550"></a><span id="l5.550">   &quot;_core&quot;,</span>
<a href="#l5.551"></a><span id="l5.551">   &quot;-&quot;,</span>
<a href="#l5.552"></a><span id="l5.552">   &quot;^lang&quot;,</span>
<a href="#l5.553"></a><span id="l5.553">   &quot;dir&quot;,</span>
<a href="#l5.554"></a><span id="l5.554"> ];</span>
<a href="#l5.555"></a><span id="l5.555"> </span>
<a href="#l5.556"></a><span id="l5.556" class="difflineminus">-gHTMLAttr.form_method = [</span>
<a href="#l5.557"></a><span id="l5.557" class="difflineminus">-  &quot;get&quot;,</span>
<a href="#l5.558"></a><span id="l5.558" class="difflineminus">-  &quot;post&quot;,</span>
<a href="#l5.559"></a><span id="l5.559" class="difflineminus">-];</span>
<a href="#l5.560"></a><span id="l5.560" class="difflineplus">+gHTMLAttr.form_method = [&quot;get&quot;, &quot;post&quot;];</span>
<a href="#l5.561"></a><span id="l5.561"> </span>
<a href="#l5.562"></a><span id="l5.562" class="difflineminus">-gHTMLAttr.form_enctype = [</span>
<a href="#l5.563"></a><span id="l5.563" class="difflineminus">-  &quot;application/x-www-form-urlencoded&quot;,</span>
<a href="#l5.564"></a><span id="l5.564" class="difflineminus">-];</span>
<a href="#l5.565"></a><span id="l5.565" class="difflineplus">+gHTMLAttr.form_enctype = [&quot;application/x-www-form-urlencoded&quot;];</span>
<a href="#l5.566"></a><span id="l5.566"> </span>
<a href="#l5.567"></a><span id="l5.567"> gHTMLAttr.form_target = gTarget;</span>
<a href="#l5.568"></a><span id="l5.568"> </span>
<a href="#l5.569"></a><span id="l5.569"> gHTMLAttr.frame = [</span>
<a href="#l5.570"></a><span id="l5.570">   &quot;longdesc&quot;,</span>
<a href="#l5.571"></a><span id="l5.571">   &quot;name&quot;,</span>
<a href="#l5.572"></a><span id="l5.572">   &quot;src&quot;,</span>
<a href="#l5.573"></a><span id="l5.573">   &quot;#frameborder&quot;,</span>
<a href="#l5.574"></a><span id="l5.574">   &quot;#marginwidth&quot;,</span>
<a href="#l5.575"></a><span id="l5.575">   &quot;#marginheight&quot;,</span>
<a href="#l5.576"></a><span id="l5.576">   &quot;noresize&quot;,</span>
<a href="#l5.577"></a><span id="l5.577">   &quot;$scrolling&quot;,</span>
<a href="#l5.578"></a><span id="l5.578"> ];</span>
<a href="#l5.579"></a><span id="l5.579"> </span>
<a href="#l5.580"></a><span id="l5.580" class="difflineminus">-gHTMLAttr.frame_frameborder = [</span>
<a href="#l5.581"></a><span id="l5.581" class="difflineminus">-  &quot;1&quot;,</span>
<a href="#l5.582"></a><span id="l5.582" class="difflineminus">-  &quot;0&quot;,</span>
<a href="#l5.583"></a><span id="l5.583" class="difflineminus">-];</span>
<a href="#l5.584"></a><span id="l5.584" class="difflineplus">+gHTMLAttr.frame_frameborder = [&quot;1&quot;, &quot;0&quot;];</span>
<a href="#l5.585"></a><span id="l5.585"> </span>
<a href="#l5.586"></a><span id="l5.586" class="difflineminus">-gHTMLAttr.frame_noresize = [</span>
<a href="#l5.587"></a><span id="l5.587" class="difflineminus">-  &quot;noresize&quot;,</span>
<a href="#l5.588"></a><span id="l5.588" class="difflineminus">-];</span>
<a href="#l5.589"></a><span id="l5.589" class="difflineminus">-</span>
<a href="#l5.590"></a><span id="l5.590" class="difflineminus">-gHTMLAttr.frame_scrolling = [</span>
<a href="#l5.591"></a><span id="l5.591" class="difflineminus">-  &quot;auto&quot;,</span>
<a href="#l5.592"></a><span id="l5.592" class="difflineminus">-  &quot;yes&quot;,</span>
<a href="#l5.593"></a><span id="l5.593" class="difflineminus">-  &quot;no&quot;,</span>
<a href="#l5.594"></a><span id="l5.594" class="difflineminus">-];</span>
<a href="#l5.595"></a><span id="l5.595" class="difflineminus">-</span>
<a href="#l5.596"></a><span id="l5.596" class="difflineplus">+gHTMLAttr.frame_noresize = [&quot;noresize&quot;];</span>
<a href="#l5.597"></a><span id="l5.597"> </span>
<a href="#l5.598"></a><span id="l5.598" class="difflineminus">-gHTMLAttr.frameset = [</span>
<a href="#l5.599"></a><span id="l5.599" class="difflineminus">-  &quot;rows&quot;,</span>
<a href="#l5.600"></a><span id="l5.600" class="difflineminus">-  &quot;cols&quot;,</span>
<a href="#l5.601"></a><span id="l5.601" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.602"></a><span id="l5.602" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.603"></a><span id="l5.603" class="difflineminus">-];</span>
<a href="#l5.604"></a><span id="l5.604" class="difflineplus">+gHTMLAttr.frame_scrolling = [&quot;auto&quot;, &quot;yes&quot;, &quot;no&quot;];</span>
<a href="#l5.605"></a><span id="l5.605"> </span>
<a href="#l5.606"></a><span id="l5.606" class="difflineminus">-gHTMLAttr.h1 = [</span>
<a href="#l5.607"></a><span id="l5.607" class="difflineminus">-  &quot;align&quot;,</span>
<a href="#l5.608"></a><span id="l5.608" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.609"></a><span id="l5.609" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.610"></a><span id="l5.610" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.611"></a><span id="l5.611" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.612"></a><span id="l5.612" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.613"></a><span id="l5.613" class="difflineminus">-];</span>
<a href="#l5.614"></a><span id="l5.614" class="difflineplus">+gHTMLAttr.frameset = [&quot;rows&quot;, &quot;cols&quot;, &quot;-&quot;, &quot;_core&quot;];</span>
<a href="#l5.615"></a><span id="l5.615" class="difflineplus">+</span>
<a href="#l5.616"></a><span id="l5.616" class="difflineplus">+gHTMLAttr.h1 = [&quot;align&quot;, &quot;-&quot;, &quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.617"></a><span id="l5.617"> </span>
<a href="#l5.618"></a><span id="l5.618"> gHTMLAttr.h1_align = gHAlignJustify;</span>
<a href="#l5.619"></a><span id="l5.619"> </span>
<a href="#l5.620"></a><span id="l5.620" class="difflineminus">-gHTMLAttr.h2 = [</span>
<a href="#l5.621"></a><span id="l5.621" class="difflineminus">-  &quot;align&quot;,</span>
<a href="#l5.622"></a><span id="l5.622" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.623"></a><span id="l5.623" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.624"></a><span id="l5.624" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.625"></a><span id="l5.625" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.626"></a><span id="l5.626" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.627"></a><span id="l5.627" class="difflineminus">-];</span>
<a href="#l5.628"></a><span id="l5.628" class="difflineplus">+gHTMLAttr.h2 = [&quot;align&quot;, &quot;-&quot;, &quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.629"></a><span id="l5.629"> </span>
<a href="#l5.630"></a><span id="l5.630"> gHTMLAttr.h2_align = gHAlignJustify;</span>
<a href="#l5.631"></a><span id="l5.631"> </span>
<a href="#l5.632"></a><span id="l5.632" class="difflineminus">-gHTMLAttr.h3 = [</span>
<a href="#l5.633"></a><span id="l5.633" class="difflineminus">-  &quot;align&quot;,</span>
<a href="#l5.634"></a><span id="l5.634" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.635"></a><span id="l5.635" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.636"></a><span id="l5.636" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.637"></a><span id="l5.637" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.638"></a><span id="l5.638" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.639"></a><span id="l5.639" class="difflineminus">-];</span>
<a href="#l5.640"></a><span id="l5.640" class="difflineplus">+gHTMLAttr.h3 = [&quot;align&quot;, &quot;-&quot;, &quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.641"></a><span id="l5.641"> </span>
<a href="#l5.642"></a><span id="l5.642" class="difflineminus">-gHTMLAttr.h3_align =  gHAlignJustify;</span>
<a href="#l5.643"></a><span id="l5.643" class="difflineplus">+gHTMLAttr.h3_align = gHAlignJustify;</span>
<a href="#l5.644"></a><span id="l5.644"> </span>
<a href="#l5.645"></a><span id="l5.645" class="difflineminus">-gHTMLAttr.h4 = [</span>
<a href="#l5.646"></a><span id="l5.646" class="difflineminus">-  &quot;align&quot;,</span>
<a href="#l5.647"></a><span id="l5.647" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.648"></a><span id="l5.648" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.649"></a><span id="l5.649" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.650"></a><span id="l5.650" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.651"></a><span id="l5.651" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.652"></a><span id="l5.652" class="difflineminus">-];</span>
<a href="#l5.653"></a><span id="l5.653" class="difflineplus">+gHTMLAttr.h4 = [&quot;align&quot;, &quot;-&quot;, &quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.654"></a><span id="l5.654"> </span>
<a href="#l5.655"></a><span id="l5.655"> gHTMLAttr.h4_align = gHAlignJustify;</span>
<a href="#l5.656"></a><span id="l5.656"> </span>
<a href="#l5.657"></a><span id="l5.657" class="difflineminus">-</span>
<a href="#l5.658"></a><span id="l5.658" class="difflineminus">-gHTMLAttr.h5 = [</span>
<a href="#l5.659"></a><span id="l5.659" class="difflineminus">-  &quot;align&quot;,</span>
<a href="#l5.660"></a><span id="l5.660" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.661"></a><span id="l5.661" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.662"></a><span id="l5.662" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.663"></a><span id="l5.663" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.664"></a><span id="l5.664" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.665"></a><span id="l5.665" class="difflineminus">-];</span>
<a href="#l5.666"></a><span id="l5.666" class="difflineplus">+gHTMLAttr.h5 = [&quot;align&quot;, &quot;-&quot;, &quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.667"></a><span id="l5.667"> </span>
<a href="#l5.668"></a><span id="l5.668"> gHTMLAttr.h5_align = gHAlignJustify;</span>
<a href="#l5.669"></a><span id="l5.669"> </span>
<a href="#l5.670"></a><span id="l5.670" class="difflineminus">-gHTMLAttr.h6 = [</span>
<a href="#l5.671"></a><span id="l5.671" class="difflineminus">-  &quot;align&quot;,</span>
<a href="#l5.672"></a><span id="l5.672" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.673"></a><span id="l5.673" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.674"></a><span id="l5.674" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.675"></a><span id="l5.675" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.676"></a><span id="l5.676" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.677"></a><span id="l5.677" class="difflineminus">-];</span>
<a href="#l5.678"></a><span id="l5.678" class="difflineplus">+gHTMLAttr.h6 = [&quot;align&quot;, &quot;-&quot;, &quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.679"></a><span id="l5.679"> </span>
<a href="#l5.680"></a><span id="l5.680"> gHTMLAttr.h6_align = gHAlignJustify;</span>
<a href="#l5.681"></a><span id="l5.681"> </span>
<a href="#l5.682"></a><span id="l5.682" class="difflineminus">-gHTMLAttr.head = [</span>
<a href="#l5.683"></a><span id="l5.683" class="difflineminus">-  &quot;profile&quot;,</span>
<a href="#l5.684"></a><span id="l5.684" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.685"></a><span id="l5.685" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.686"></a><span id="l5.686" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.687"></a><span id="l5.687" class="difflineminus">-];</span>
<a href="#l5.688"></a><span id="l5.688" class="difflineplus">+gHTMLAttr.head = [&quot;profile&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.689"></a><span id="l5.689"> </span>
<a href="#l5.690"></a><span id="l5.690"> gHTMLAttr.hr = [</span>
<a href="#l5.691"></a><span id="l5.691">   &quot;align&quot;,</span>
<a href="#l5.692"></a><span id="l5.692">   &quot;noshade&quot;,</span>
<a href="#l5.693"></a><span id="l5.693">   &quot;#size&quot;,</span>
<a href="#l5.694"></a><span id="l5.694">   &quot;%width&quot;,</span>
<a href="#l5.695"></a><span id="l5.695">   &quot;-&quot;,</span>
<a href="#l5.696"></a><span id="l5.696">   &quot;_core&quot;,</span>
<a href="#l5.697"></a><span id="l5.697">   &quot;-&quot;,</span>
<a href="#l5.698"></a><span id="l5.698">   &quot;^lang&quot;,</span>
<a href="#l5.699"></a><span id="l5.699">   &quot;dir&quot;,</span>
<a href="#l5.700"></a><span id="l5.700"> ];</span>
<a href="#l5.701"></a><span id="l5.701"> </span>
<a href="#l5.702"></a><span id="l5.702"> gHTMLAttr.hr_align = gHAlign;</span>
<a href="#l5.703"></a><span id="l5.703"> </span>
<a href="#l5.704"></a><span id="l5.704" class="difflineminus">-gHTMLAttr.hr_noshade = [</span>
<a href="#l5.705"></a><span id="l5.705" class="difflineminus">-  &quot;noshade&quot;,</span>
<a href="#l5.706"></a><span id="l5.706" class="difflineminus">-];</span>
<a href="#l5.707"></a><span id="l5.707" class="difflineminus">-</span>
<a href="#l5.708"></a><span id="l5.708" class="difflineplus">+gHTMLAttr.hr_noshade = [&quot;noshade&quot;];</span>
<a href="#l5.709"></a><span id="l5.709"> </span>
<a href="#l5.710"></a><span id="l5.710" class="difflineminus">-gHTMLAttr.html = [</span>
<a href="#l5.711"></a><span id="l5.711" class="difflineminus">-  &quot;version&quot;,</span>
<a href="#l5.712"></a><span id="l5.712" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.713"></a><span id="l5.713" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.714"></a><span id="l5.714" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.715"></a><span id="l5.715" class="difflineminus">-];</span>
<a href="#l5.716"></a><span id="l5.716" class="difflineplus">+gHTMLAttr.html = [&quot;version&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.717"></a><span id="l5.717"> </span>
<a href="#l5.718"></a><span id="l5.718" class="difflineminus">-gHTMLAttr.i = [</span>
<a href="#l5.719"></a><span id="l5.719" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.720"></a><span id="l5.720" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.721"></a><span id="l5.721" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.722"></a><span id="l5.722" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.723"></a><span id="l5.723" class="difflineminus">-];</span>
<a href="#l5.724"></a><span id="l5.724" class="difflineplus">+gHTMLAttr.i = [&quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.725"></a><span id="l5.725"> </span>
<a href="#l5.726"></a><span id="l5.726"> gHTMLAttr.iframe = [</span>
<a href="#l5.727"></a><span id="l5.727">   &quot;longdesc&quot;,</span>
<a href="#l5.728"></a><span id="l5.728">   &quot;name&quot;,</span>
<a href="#l5.729"></a><span id="l5.729">   &quot;src&quot;,</span>
<a href="#l5.730"></a><span id="l5.730">   &quot;$frameborder&quot;,</span>
<a href="#l5.731"></a><span id="l5.731">   &quot;marginwidth&quot;,</span>
<a href="#l5.732"></a><span id="l5.732">   &quot;marginheight&quot;,</span>
<a href="#l5.733"></a><span id="l5.733">   &quot;$scrolling&quot;,</span>
<a href="#l5.734"></a><span id="l5.734">   &quot;align&quot;,</span>
<a href="#l5.735"></a><span id="l5.735">   &quot;%height&quot;,</span>
<a href="#l5.736"></a><span id="l5.736">   &quot;%width&quot;,</span>
<a href="#l5.737"></a><span id="l5.737">   &quot;-&quot;,</span>
<a href="#l5.738"></a><span id="l5.738">   &quot;_core&quot;,</span>
<a href="#l5.739"></a><span id="l5.739"> ];</span>
<a href="#l5.740"></a><span id="l5.740"> </span>
<a href="#l5.741"></a><span id="l5.741" class="difflineminus">-gHTMLAttr.iframe_frameborder = [</span>
<a href="#l5.742"></a><span id="l5.742" class="difflineminus">-  &quot;1&quot;,</span>
<a href="#l5.743"></a><span id="l5.743" class="difflineminus">-  &quot;0&quot;,</span>
<a href="#l5.744"></a><span id="l5.744" class="difflineminus">-];</span>
<a href="#l5.745"></a><span id="l5.745" class="difflineplus">+gHTMLAttr.iframe_frameborder = [&quot;1&quot;, &quot;0&quot;];</span>
<a href="#l5.746"></a><span id="l5.746"> </span>
<a href="#l5.747"></a><span id="l5.747" class="difflineminus">-gHTMLAttr.iframe_scrolling = [</span>
<a href="#l5.748"></a><span id="l5.748" class="difflineminus">-  &quot;auto&quot;,</span>
<a href="#l5.749"></a><span id="l5.749" class="difflineminus">-  &quot;yes&quot;,</span>
<a href="#l5.750"></a><span id="l5.750" class="difflineminus">-  &quot;no&quot;,</span>
<a href="#l5.751"></a><span id="l5.751" class="difflineminus">-];</span>
<a href="#l5.752"></a><span id="l5.752" class="difflineplus">+gHTMLAttr.iframe_scrolling = [&quot;auto&quot;, &quot;yes&quot;, &quot;no&quot;];</span>
<a href="#l5.753"></a><span id="l5.753"> </span>
<a href="#l5.754"></a><span id="l5.754" class="difflineminus">-gHTMLAttr.iframe_align = [</span>
<a href="#l5.755"></a><span id="l5.755" class="difflineminus">-  &quot;top&quot;,</span>
<a href="#l5.756"></a><span id="l5.756" class="difflineminus">-  &quot;middle&quot;,</span>
<a href="#l5.757"></a><span id="l5.757" class="difflineminus">-  &quot;bottom&quot;,</span>
<a href="#l5.758"></a><span id="l5.758" class="difflineminus">-  &quot;left&quot;,</span>
<a href="#l5.759"></a><span id="l5.759" class="difflineminus">-  &quot;right&quot;,</span>
<a href="#l5.760"></a><span id="l5.760" class="difflineminus">-];</span>
<a href="#l5.761"></a><span id="l5.761" class="difflineplus">+gHTMLAttr.iframe_align = [&quot;top&quot;, &quot;middle&quot;, &quot;bottom&quot;, &quot;left&quot;, &quot;right&quot;];</span>
<a href="#l5.762"></a><span id="l5.762"> </span>
<a href="#l5.763"></a><span id="l5.763"> gHTMLAttr.img = [</span>
<a href="#l5.764"></a><span id="l5.764">   &quot;$src&quot;,</span>
<a href="#l5.765"></a><span id="l5.765">   &quot;$alt&quot;,</span>
<a href="#l5.766"></a><span id="l5.766">   &quot;longdesc&quot;,</span>
<a href="#l5.767"></a><span id="l5.767">   &quot;name&quot;,</span>
<a href="#l5.768"></a><span id="l5.768">   &quot;%height&quot;,</span>
<a href="#l5.769"></a><span id="l5.769">   &quot;%width&quot;,</span>
<a href="#l5.770"></a><span id="l5.770" class="difflineat">@@ -783,27 +468,19 @@ gHTMLAttr.img = [</span>
<a href="#l5.771"></a><span id="l5.771">   &quot;#vspace&quot;,</span>
<a href="#l5.772"></a><span id="l5.772">   &quot;-&quot;,</span>
<a href="#l5.773"></a><span id="l5.773">   &quot;_core&quot;,</span>
<a href="#l5.774"></a><span id="l5.774">   &quot;-&quot;,</span>
<a href="#l5.775"></a><span id="l5.775">   &quot;^lang&quot;,</span>
<a href="#l5.776"></a><span id="l5.776">   &quot;dir&quot;,</span>
<a href="#l5.777"></a><span id="l5.777"> ];</span>
<a href="#l5.778"></a><span id="l5.778"> </span>
<a href="#l5.779"></a><span id="l5.779" class="difflineminus">-gHTMLAttr.img_ismap = [</span>
<a href="#l5.780"></a><span id="l5.780" class="difflineminus">-  &quot;ismap&quot;,</span>
<a href="#l5.781"></a><span id="l5.781" class="difflineminus">-];</span>
<a href="#l5.782"></a><span id="l5.782" class="difflineplus">+gHTMLAttr.img_ismap = [&quot;ismap&quot;];</span>
<a href="#l5.783"></a><span id="l5.783"> </span>
<a href="#l5.784"></a><span id="l5.784" class="difflineminus">-gHTMLAttr.img_align = [</span>
<a href="#l5.785"></a><span id="l5.785" class="difflineminus">-  &quot;top&quot;,</span>
<a href="#l5.786"></a><span id="l5.786" class="difflineminus">-  &quot;middle&quot;,</span>
<a href="#l5.787"></a><span id="l5.787" class="difflineminus">-  &quot;bottom&quot;,</span>
<a href="#l5.788"></a><span id="l5.788" class="difflineminus">-  &quot;left&quot;,</span>
<a href="#l5.789"></a><span id="l5.789" class="difflineminus">-  &quot;right&quot;,</span>
<a href="#l5.790"></a><span id="l5.790" class="difflineminus">-];</span>
<a href="#l5.791"></a><span id="l5.791" class="difflineplus">+gHTMLAttr.img_align = [&quot;top&quot;, &quot;middle&quot;, &quot;bottom&quot;, &quot;left&quot;, &quot;right&quot;];</span>
<a href="#l5.792"></a><span id="l5.792"> </span>
<a href="#l5.793"></a><span id="l5.793"> gHTMLAttr.input = [</span>
<a href="#l5.794"></a><span id="l5.794">   &quot;$type&quot;,</span>
<a href="#l5.795"></a><span id="l5.795">   &quot;name&quot;,</span>
<a href="#l5.796"></a><span id="l5.796">   &quot;value&quot;,</span>
<a href="#l5.797"></a><span id="l5.797">   &quot;checked&quot;,</span>
<a href="#l5.798"></a><span id="l5.798">   &quot;disabled&quot;,</span>
<a href="#l5.799"></a><span id="l5.799">   &quot;readonly&quot;,</span>
<a href="#l5.800"></a><span id="l5.800" class="difflineat">@@ -832,116 +509,41 @@ gHTMLAttr.input_type = [</span>
<a href="#l5.801"></a><span id="l5.801">   &quot;submit&quot;,</span>
<a href="#l5.802"></a><span id="l5.802">   &quot;reset&quot;,</span>
<a href="#l5.803"></a><span id="l5.803">   &quot;file&quot;,</span>
<a href="#l5.804"></a><span id="l5.804">   &quot;hidden&quot;,</span>
<a href="#l5.805"></a><span id="l5.805">   &quot;image&quot;,</span>
<a href="#l5.806"></a><span id="l5.806">   &quot;button&quot;,</span>
<a href="#l5.807"></a><span id="l5.807"> ];</span>
<a href="#l5.808"></a><span id="l5.808"> </span>
<a href="#l5.809"></a><span id="l5.809" class="difflineminus">-gHTMLAttr.input_checked = [</span>
<a href="#l5.810"></a><span id="l5.810" class="difflineminus">-  &quot;checked&quot;,</span>
<a href="#l5.811"></a><span id="l5.811" class="difflineminus">-];</span>
<a href="#l5.812"></a><span id="l5.812" class="difflineminus">-</span>
<a href="#l5.813"></a><span id="l5.813" class="difflineminus">-gHTMLAttr.input_disabled = [</span>
<a href="#l5.814"></a><span id="l5.814" class="difflineminus">-  &quot;disabled&quot;,</span>
<a href="#l5.815"></a><span id="l5.815" class="difflineminus">-];</span>
<a href="#l5.816"></a><span id="l5.816" class="difflineplus">+gHTMLAttr.input_checked = [&quot;checked&quot;];</span>
<a href="#l5.817"></a><span id="l5.817"> </span>
<a href="#l5.818"></a><span id="l5.818" class="difflineminus">-gHTMLAttr.input_readonly = [</span>
<a href="#l5.819"></a><span id="l5.819" class="difflineminus">-  &quot;readonly&quot;,</span>
<a href="#l5.820"></a><span id="l5.820" class="difflineminus">-];</span>
<a href="#l5.821"></a><span id="l5.821" class="difflineminus">-</span>
<a href="#l5.822"></a><span id="l5.822" class="difflineplus">+gHTMLAttr.input_disabled = [&quot;disabled&quot;];</span>
<a href="#l5.823"></a><span id="l5.823"> </span>
<a href="#l5.824"></a><span id="l5.824" class="difflineminus">-gHTMLAttr.input_ismap = [</span>
<a href="#l5.825"></a><span id="l5.825" class="difflineminus">-  &quot;ismap&quot;,</span>
<a href="#l5.826"></a><span id="l5.826" class="difflineminus">-];</span>
<a href="#l5.827"></a><span id="l5.827" class="difflineminus">-</span>
<a href="#l5.828"></a><span id="l5.828" class="difflineplus">+gHTMLAttr.input_readonly = [&quot;readonly&quot;];</span>
<a href="#l5.829"></a><span id="l5.829"> </span>
<a href="#l5.830"></a><span id="l5.830" class="difflineminus">-gHTMLAttr.input_align = [</span>
<a href="#l5.831"></a><span id="l5.831" class="difflineminus">-  &quot;top&quot;,</span>
<a href="#l5.832"></a><span id="l5.832" class="difflineminus">-  &quot;middle&quot;,</span>
<a href="#l5.833"></a><span id="l5.833" class="difflineminus">-  &quot;bottom&quot;,</span>
<a href="#l5.834"></a><span id="l5.834" class="difflineminus">-  &quot;left&quot;,</span>
<a href="#l5.835"></a><span id="l5.835" class="difflineminus">-  &quot;right&quot;,</span>
<a href="#l5.836"></a><span id="l5.836" class="difflineminus">-];</span>
<a href="#l5.837"></a><span id="l5.837" class="difflineplus">+gHTMLAttr.input_ismap = [&quot;ismap&quot;];</span>
<a href="#l5.838"></a><span id="l5.838"> </span>
<a href="#l5.839"></a><span id="l5.839" class="difflineminus">-gHTMLAttr.ins = [</span>
<a href="#l5.840"></a><span id="l5.840" class="difflineminus">-  &quot;cite&quot;,</span>
<a href="#l5.841"></a><span id="l5.841" class="difflineminus">-  &quot;datetime&quot;,</span>
<a href="#l5.842"></a><span id="l5.842" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.843"></a><span id="l5.843" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.844"></a><span id="l5.844" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.845"></a><span id="l5.845" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.846"></a><span id="l5.846" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.847"></a><span id="l5.847" class="difflineminus">-];</span>
<a href="#l5.848"></a><span id="l5.848" class="difflineplus">+gHTMLAttr.input_align = [&quot;top&quot;, &quot;middle&quot;, &quot;bottom&quot;, &quot;left&quot;, &quot;right&quot;];</span>
<a href="#l5.849"></a><span id="l5.849"> </span>
<a href="#l5.850"></a><span id="l5.850" class="difflineminus">-gHTMLAttr.isindex = [</span>
<a href="#l5.851"></a><span id="l5.851" class="difflineminus">-  &quot;prompt&quot;,</span>
<a href="#l5.852"></a><span id="l5.852" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.853"></a><span id="l5.853" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.854"></a><span id="l5.854" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.855"></a><span id="l5.855" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.856"></a><span id="l5.856" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.857"></a><span id="l5.857" class="difflineminus">-];</span>
<a href="#l5.858"></a><span id="l5.858" class="difflineplus">+gHTMLAttr.ins = [&quot;cite&quot;, &quot;datetime&quot;, &quot;-&quot;, &quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.859"></a><span id="l5.859"> </span>
<a href="#l5.860"></a><span id="l5.860" class="difflineminus">-gHTMLAttr.kbd = [</span>
<a href="#l5.861"></a><span id="l5.861" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.862"></a><span id="l5.862" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.863"></a><span id="l5.863" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.864"></a><span id="l5.864" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.865"></a><span id="l5.865" class="difflineminus">-];</span>
<a href="#l5.866"></a><span id="l5.866" class="difflineplus">+gHTMLAttr.isindex = [&quot;prompt&quot;, &quot;-&quot;, &quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.867"></a><span id="l5.867"> </span>
<a href="#l5.868"></a><span id="l5.868" class="difflineminus">-gHTMLAttr.label = [</span>
<a href="#l5.869"></a><span id="l5.869" class="difflineminus">-  &quot;for&quot;,</span>
<a href="#l5.870"></a><span id="l5.870" class="difflineminus">-  &quot;!accesskey&quot;,</span>
<a href="#l5.871"></a><span id="l5.871" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.872"></a><span id="l5.872" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.873"></a><span id="l5.873" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.874"></a><span id="l5.874" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.875"></a><span id="l5.875" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.876"></a><span id="l5.876" class="difflineminus">-];</span>
<a href="#l5.877"></a><span id="l5.877" class="difflineplus">+gHTMLAttr.kbd = [&quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.878"></a><span id="l5.878"> </span>
<a href="#l5.879"></a><span id="l5.879" class="difflineminus">-gHTMLAttr.legend = [</span>
<a href="#l5.880"></a><span id="l5.880" class="difflineminus">-  &quot;!accesskey&quot;,</span>
<a href="#l5.881"></a><span id="l5.881" class="difflineminus">-  &quot;align&quot;,</span>
<a href="#l5.882"></a><span id="l5.882" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.883"></a><span id="l5.883" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.884"></a><span id="l5.884" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.885"></a><span id="l5.885" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.886"></a><span id="l5.886" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.887"></a><span id="l5.887" class="difflineminus">-];</span>
<a href="#l5.888"></a><span id="l5.888" class="difflineplus">+gHTMLAttr.label = [&quot;for&quot;, &quot;!accesskey&quot;, &quot;-&quot;, &quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.889"></a><span id="l5.889"> </span>
<a href="#l5.890"></a><span id="l5.890" class="difflineminus">-gHTMLAttr.legend_align = [</span>
<a href="#l5.891"></a><span id="l5.891" class="difflineminus">-  &quot;top&quot;,</span>
<a href="#l5.892"></a><span id="l5.892" class="difflineminus">-  &quot;bottom&quot;,</span>
<a href="#l5.893"></a><span id="l5.893" class="difflineminus">-  &quot;left&quot;,</span>
<a href="#l5.894"></a><span id="l5.894" class="difflineminus">-  &quot;right&quot;,</span>
<a href="#l5.895"></a><span id="l5.895" class="difflineminus">-];</span>
<a href="#l5.896"></a><span id="l5.896" class="difflineplus">+gHTMLAttr.legend = [&quot;!accesskey&quot;, &quot;align&quot;, &quot;-&quot;, &quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.897"></a><span id="l5.897" class="difflineplus">+</span>
<a href="#l5.898"></a><span id="l5.898" class="difflineplus">+gHTMLAttr.legend_align = [&quot;top&quot;, &quot;bottom&quot;, &quot;left&quot;, &quot;right&quot;];</span>
<a href="#l5.899"></a><span id="l5.899"> </span>
<a href="#l5.900"></a><span id="l5.900" class="difflineminus">-gHTMLAttr.li = [</span>
<a href="#l5.901"></a><span id="l5.901" class="difflineminus">-  &quot;type&quot;,</span>
<a href="#l5.902"></a><span id="l5.902" class="difflineminus">-  &quot;#value&quot;,</span>
<a href="#l5.903"></a><span id="l5.903" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.904"></a><span id="l5.904" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.905"></a><span id="l5.905" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.906"></a><span id="l5.906" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.907"></a><span id="l5.907" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.908"></a><span id="l5.908" class="difflineminus">-];</span>
<a href="#l5.909"></a><span id="l5.909" class="difflineplus">+gHTMLAttr.li = [&quot;type&quot;, &quot;#value&quot;, &quot;-&quot;, &quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.910"></a><span id="l5.910"> </span>
<a href="#l5.911"></a><span id="l5.911" class="difflineminus">-gHTMLAttr.li_type = [</span>
<a href="#l5.912"></a><span id="l5.912" class="difflineminus">-  &quot;disc&quot;,</span>
<a href="#l5.913"></a><span id="l5.913" class="difflineminus">-  &quot;square&quot;,</span>
<a href="#l5.914"></a><span id="l5.914" class="difflineminus">-  &quot;circle&quot;,</span>
<a href="#l5.915"></a><span id="l5.915" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.916"></a><span id="l5.916" class="difflineminus">-  &quot;1&quot;,</span>
<a href="#l5.917"></a><span id="l5.917" class="difflineminus">-  &quot;a&quot;,</span>
<a href="#l5.918"></a><span id="l5.918" class="difflineminus">-  &quot;A&quot;,</span>
<a href="#l5.919"></a><span id="l5.919" class="difflineminus">-  &quot;i&quot;,</span>
<a href="#l5.920"></a><span id="l5.920" class="difflineminus">-  &quot;I&quot;,</span>
<a href="#l5.921"></a><span id="l5.921" class="difflineminus">-];</span>
<a href="#l5.922"></a><span id="l5.922" class="difflineplus">+gHTMLAttr.li_type = [&quot;disc&quot;, &quot;square&quot;, &quot;circle&quot;, &quot;-&quot;, &quot;1&quot;, &quot;a&quot;, &quot;A&quot;, &quot;i&quot;, &quot;I&quot;];</span>
<a href="#l5.923"></a><span id="l5.923"> </span>
<a href="#l5.924"></a><span id="l5.924"> gHTMLAttr.link = [</span>
<a href="#l5.925"></a><span id="l5.925">   &quot;charset&quot;,</span>
<a href="#l5.926"></a><span id="l5.926">   &quot;href&quot;,</span>
<a href="#l5.927"></a><span id="l5.927">   &quot;^hreflang&quot;,</span>
<a href="#l5.928"></a><span id="l5.928">   &quot;type&quot;,</span>
<a href="#l5.929"></a><span id="l5.929">   &quot;rel&quot;,</span>
<a href="#l5.930"></a><span id="l5.930">   &quot;rev&quot;,</span>
<a href="#l5.931"></a><span id="l5.931" class="difflineat">@@ -987,61 +589,35 @@ gHTMLAttr.link_rev = [</span>
<a href="#l5.932"></a><span id="l5.932">   &quot;chapter&quot;,</span>
<a href="#l5.933"></a><span id="l5.933">   &quot;section&quot;,</span>
<a href="#l5.934"></a><span id="l5.934">   &quot;subsection&quot;,</span>
<a href="#l5.935"></a><span id="l5.935">   &quot;appendix&quot;,</span>
<a href="#l5.936"></a><span id="l5.936">   &quot;help&quot;,</span>
<a href="#l5.937"></a><span id="l5.937">   &quot;bookmark&quot;,</span>
<a href="#l5.938"></a><span id="l5.938"> ];</span>
<a href="#l5.939"></a><span id="l5.939"> </span>
<a href="#l5.940"></a><span id="l5.940" class="difflineminus">-gHTMLAttr.map = [</span>
<a href="#l5.941"></a><span id="l5.941" class="difflineminus">-  &quot;$name&quot;,</span>
<a href="#l5.942"></a><span id="l5.942" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.943"></a><span id="l5.943" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.944"></a><span id="l5.944" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.945"></a><span id="l5.945" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.946"></a><span id="l5.946" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.947"></a><span id="l5.947" class="difflineminus">-];</span>
<a href="#l5.948"></a><span id="l5.948" class="difflineplus">+gHTMLAttr.map = [&quot;$name&quot;, &quot;-&quot;, &quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.949"></a><span id="l5.949"> </span>
<a href="#l5.950"></a><span id="l5.950" class="difflineminus">-gHTMLAttr.menu = [</span>
<a href="#l5.951"></a><span id="l5.951" class="difflineminus">-  &quot;compact&quot;,</span>
<a href="#l5.952"></a><span id="l5.952" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.953"></a><span id="l5.953" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.954"></a><span id="l5.954" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.955"></a><span id="l5.955" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.956"></a><span id="l5.956" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.957"></a><span id="l5.957" class="difflineminus">-];</span>
<a href="#l5.958"></a><span id="l5.958" class="difflineplus">+gHTMLAttr.menu = [&quot;compact&quot;, &quot;-&quot;, &quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.959"></a><span id="l5.959"> </span>
<a href="#l5.960"></a><span id="l5.960" class="difflineminus">-gHTMLAttr.menu_compact = [</span>
<a href="#l5.961"></a><span id="l5.961" class="difflineminus">-  &quot;compact&quot;,</span>
<a href="#l5.962"></a><span id="l5.962" class="difflineminus">-];</span>
<a href="#l5.963"></a><span id="l5.963" class="difflineplus">+gHTMLAttr.menu_compact = [&quot;compact&quot;];</span>
<a href="#l5.964"></a><span id="l5.964"> </span>
<a href="#l5.965"></a><span id="l5.965"> gHTMLAttr.meta = [</span>
<a href="#l5.966"></a><span id="l5.966">   &quot;http-equiv&quot;,</span>
<a href="#l5.967"></a><span id="l5.967">   &quot;name&quot;,</span>
<a href="#l5.968"></a><span id="l5.968">   &quot;$content&quot;,</span>
<a href="#l5.969"></a><span id="l5.969">   &quot;scheme&quot;,</span>
<a href="#l5.970"></a><span id="l5.970">   &quot;-&quot;,</span>
<a href="#l5.971"></a><span id="l5.971">   &quot;^lang&quot;,</span>
<a href="#l5.972"></a><span id="l5.972">   &quot;dir&quot;,</span>
<a href="#l5.973"></a><span id="l5.973"> ];</span>
<a href="#l5.974"></a><span id="l5.974"> </span>
<a href="#l5.975"></a><span id="l5.975" class="difflineminus">-gHTMLAttr.noframes = [</span>
<a href="#l5.976"></a><span id="l5.976" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.977"></a><span id="l5.977" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.978"></a><span id="l5.978" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.979"></a><span id="l5.979" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.980"></a><span id="l5.980" class="difflineminus">-];</span>
<a href="#l5.981"></a><span id="l5.981" class="difflineplus">+gHTMLAttr.noframes = [&quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.982"></a><span id="l5.982"> </span>
<a href="#l5.983"></a><span id="l5.983" class="difflineminus">-gHTMLAttr.noscript = [</span>
<a href="#l5.984"></a><span id="l5.984" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.985"></a><span id="l5.985" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.986"></a><span id="l5.986" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.987"></a><span id="l5.987" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.988"></a><span id="l5.988" class="difflineminus">-];</span>
<a href="#l5.989"></a><span id="l5.989" class="difflineplus">+gHTMLAttr.noscript = [&quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.990"></a><span id="l5.990"> </span>
<a href="#l5.991"></a><span id="l5.991"> gHTMLAttr.object = [</span>
<a href="#l5.992"></a><span id="l5.992">   &quot;declare&quot;,</span>
<a href="#l5.993"></a><span id="l5.993">   &quot;classid&quot;,</span>
<a href="#l5.994"></a><span id="l5.994">   &quot;codebase&quot;,</span>
<a href="#l5.995"></a><span id="l5.995">   &quot;data&quot;,</span>
<a href="#l5.996"></a><span id="l5.996">   &quot;type&quot;,</span>
<a href="#l5.997"></a><span id="l5.997">   &quot;codetype&quot;,</span>
<a href="#l5.998"></a><span id="l5.998" class="difflineat">@@ -1058,230 +634,96 @@ gHTMLAttr.object = [</span>
<a href="#l5.999"></a><span id="l5.999">   &quot;#vspace&quot;,</span>
<a href="#l5.1000"></a><span id="l5.1000">   &quot;-&quot;,</span>
<a href="#l5.1001"></a><span id="l5.1001">   &quot;_core&quot;,</span>
<a href="#l5.1002"></a><span id="l5.1002">   &quot;-&quot;,</span>
<a href="#l5.1003"></a><span id="l5.1003">   &quot;^lang&quot;,</span>
<a href="#l5.1004"></a><span id="l5.1004">   &quot;dir&quot;,</span>
<a href="#l5.1005"></a><span id="l5.1005"> ];</span>
<a href="#l5.1006"></a><span id="l5.1006"> </span>
<a href="#l5.1007"></a><span id="l5.1007" class="difflineminus">-gHTMLAttr.object_declare = [</span>
<a href="#l5.1008"></a><span id="l5.1008" class="difflineminus">-  &quot;declare&quot;,</span>
<a href="#l5.1009"></a><span id="l5.1009" class="difflineminus">-];</span>
<a href="#l5.1010"></a><span id="l5.1010" class="difflineplus">+gHTMLAttr.object_declare = [&quot;declare&quot;];</span>
<a href="#l5.1011"></a><span id="l5.1011"> </span>
<a href="#l5.1012"></a><span id="l5.1012" class="difflineminus">-gHTMLAttr.object_align = [</span>
<a href="#l5.1013"></a><span id="l5.1013" class="difflineminus">-  &quot;top&quot;,</span>
<a href="#l5.1014"></a><span id="l5.1014" class="difflineminus">-  &quot;middle&quot;,</span>
<a href="#l5.1015"></a><span id="l5.1015" class="difflineminus">-  &quot;bottom&quot;,</span>
<a href="#l5.1016"></a><span id="l5.1016" class="difflineminus">-  &quot;left&quot;,</span>
<a href="#l5.1017"></a><span id="l5.1017" class="difflineminus">-  &quot;right&quot;,</span>
<a href="#l5.1018"></a><span id="l5.1018" class="difflineminus">-];</span>
<a href="#l5.1019"></a><span id="l5.1019" class="difflineplus">+gHTMLAttr.object_align = [&quot;top&quot;, &quot;middle&quot;, &quot;bottom&quot;, &quot;left&quot;, &quot;right&quot;];</span>
<a href="#l5.1020"></a><span id="l5.1020"> </span>
<a href="#l5.1021"></a><span id="l5.1021" class="difflineminus">-gHTMLAttr.ol = [</span>
<a href="#l5.1022"></a><span id="l5.1022" class="difflineminus">-  &quot;type&quot;,</span>
<a href="#l5.1023"></a><span id="l5.1023" class="difflineminus">-  &quot;compact&quot;,</span>
<a href="#l5.1024"></a><span id="l5.1024" class="difflineminus">-  &quot;#start&quot;,</span>
<a href="#l5.1025"></a><span id="l5.1025" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.1026"></a><span id="l5.1026" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.1027"></a><span id="l5.1027" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.1028"></a><span id="l5.1028" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.1029"></a><span id="l5.1029" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.1030"></a><span id="l5.1030" class="difflineminus">-];</span>
<a href="#l5.1031"></a><span id="l5.1031" class="difflineplus">+gHTMLAttr.ol = [&quot;type&quot;, &quot;compact&quot;, &quot;#start&quot;, &quot;-&quot;, &quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.1032"></a><span id="l5.1032"> </span>
<a href="#l5.1033"></a><span id="l5.1033" class="difflineminus">-gHTMLAttr.ol_type = [</span>
<a href="#l5.1034"></a><span id="l5.1034" class="difflineminus">-  &quot;1&quot;,</span>
<a href="#l5.1035"></a><span id="l5.1035" class="difflineminus">-  &quot;a&quot;,</span>
<a href="#l5.1036"></a><span id="l5.1036" class="difflineminus">-  &quot;A&quot;,</span>
<a href="#l5.1037"></a><span id="l5.1037" class="difflineminus">-  &quot;i&quot;,</span>
<a href="#l5.1038"></a><span id="l5.1038" class="difflineminus">-  &quot;I&quot;,</span>
<a href="#l5.1039"></a><span id="l5.1039" class="difflineminus">-];</span>
<a href="#l5.1040"></a><span id="l5.1040" class="difflineplus">+gHTMLAttr.ol_type = [&quot;1&quot;, &quot;a&quot;, &quot;A&quot;, &quot;i&quot;, &quot;I&quot;];</span>
<a href="#l5.1041"></a><span id="l5.1041"> </span>
<a href="#l5.1042"></a><span id="l5.1042" class="difflineminus">-gHTMLAttr.ol_compact = [</span>
<a href="#l5.1043"></a><span id="l5.1043" class="difflineminus">-  &quot;compact&quot;,</span>
<a href="#l5.1044"></a><span id="l5.1044" class="difflineminus">-];</span>
<a href="#l5.1045"></a><span id="l5.1045" class="difflineminus">-</span>
<a href="#l5.1046"></a><span id="l5.1046" class="difflineplus">+gHTMLAttr.ol_compact = [&quot;compact&quot;];</span>
<a href="#l5.1047"></a><span id="l5.1047"> </span>
<a href="#l5.1048"></a><span id="l5.1048" class="difflineminus">-gHTMLAttr.optgroup = [</span>
<a href="#l5.1049"></a><span id="l5.1049" class="difflineminus">-  &quot;disabled&quot;,</span>
<a href="#l5.1050"></a><span id="l5.1050" class="difflineminus">-  &quot;$label&quot;,</span>
<a href="#l5.1051"></a><span id="l5.1051" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.1052"></a><span id="l5.1052" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.1053"></a><span id="l5.1053" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.1054"></a><span id="l5.1054" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.1055"></a><span id="l5.1055" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.1056"></a><span id="l5.1056" class="difflineminus">-];</span>
<a href="#l5.1057"></a><span id="l5.1057" class="difflineplus">+gHTMLAttr.optgroup = [&quot;disabled&quot;, &quot;$label&quot;, &quot;-&quot;, &quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.1058"></a><span id="l5.1058"> </span>
<a href="#l5.1059"></a><span id="l5.1059" class="difflineminus">-gHTMLAttr.optgroup_disabled = [</span>
<a href="#l5.1060"></a><span id="l5.1060" class="difflineminus">-  &quot;disabled&quot;,</span>
<a href="#l5.1061"></a><span id="l5.1061" class="difflineminus">-];</span>
<a href="#l5.1062"></a><span id="l5.1062" class="difflineminus">-</span>
<a href="#l5.1063"></a><span id="l5.1063" class="difflineplus">+gHTMLAttr.optgroup_disabled = [&quot;disabled&quot;];</span>
<a href="#l5.1064"></a><span id="l5.1064"> </span>
<a href="#l5.1065"></a><span id="l5.1065"> gHTMLAttr.option = [</span>
<a href="#l5.1066"></a><span id="l5.1066">   &quot;selected&quot;,</span>
<a href="#l5.1067"></a><span id="l5.1067">   &quot;disabled&quot;,</span>
<a href="#l5.1068"></a><span id="l5.1068">   &quot;label&quot;,</span>
<a href="#l5.1069"></a><span id="l5.1069">   &quot;value&quot;,</span>
<a href="#l5.1070"></a><span id="l5.1070">   &quot;-&quot;,</span>
<a href="#l5.1071"></a><span id="l5.1071">   &quot;_core&quot;,</span>
<a href="#l5.1072"></a><span id="l5.1072">   &quot;-&quot;,</span>
<a href="#l5.1073"></a><span id="l5.1073">   &quot;^lang&quot;,</span>
<a href="#l5.1074"></a><span id="l5.1074">   &quot;dir&quot;,</span>
<a href="#l5.1075"></a><span id="l5.1075"> ];</span>
<a href="#l5.1076"></a><span id="l5.1076"> </span>
<a href="#l5.1077"></a><span id="l5.1077" class="difflineminus">-gHTMLAttr.option_selected = [</span>
<a href="#l5.1078"></a><span id="l5.1078" class="difflineminus">-  &quot;selected&quot;,</span>
<a href="#l5.1079"></a><span id="l5.1079" class="difflineminus">-];</span>
<a href="#l5.1080"></a><span id="l5.1080" class="difflineminus">-</span>
<a href="#l5.1081"></a><span id="l5.1081" class="difflineminus">-gHTMLAttr.option_disabled = [</span>
<a href="#l5.1082"></a><span id="l5.1082" class="difflineminus">-  &quot;disabled&quot;,</span>
<a href="#l5.1083"></a><span id="l5.1083" class="difflineminus">-];</span>
<a href="#l5.1084"></a><span id="l5.1084" class="difflineminus">-</span>
<a href="#l5.1085"></a><span id="l5.1085" class="difflineplus">+gHTMLAttr.option_selected = [&quot;selected&quot;];</span>
<a href="#l5.1086"></a><span id="l5.1086"> </span>
<a href="#l5.1087"></a><span id="l5.1087" class="difflineminus">-gHTMLAttr.p = [</span>
<a href="#l5.1088"></a><span id="l5.1088" class="difflineminus">-  &quot;align&quot;,</span>
<a href="#l5.1089"></a><span id="l5.1089" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.1090"></a><span id="l5.1090" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.1091"></a><span id="l5.1091" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.1092"></a><span id="l5.1092" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.1093"></a><span id="l5.1093" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.1094"></a><span id="l5.1094" class="difflineminus">-];</span>
<a href="#l5.1095"></a><span id="l5.1095" class="difflineplus">+gHTMLAttr.option_disabled = [&quot;disabled&quot;];</span>
<a href="#l5.1096"></a><span id="l5.1096" class="difflineplus">+</span>
<a href="#l5.1097"></a><span id="l5.1097" class="difflineplus">+gHTMLAttr.p = [&quot;align&quot;, &quot;-&quot;, &quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.1098"></a><span id="l5.1098"> </span>
<a href="#l5.1099"></a><span id="l5.1099"> gHTMLAttr.p_align = gHAlignJustify;</span>
<a href="#l5.1100"></a><span id="l5.1100"> </span>
<a href="#l5.1101"></a><span id="l5.1101" class="difflineminus">-gHTMLAttr.param = [</span>
<a href="#l5.1102"></a><span id="l5.1102" class="difflineminus">-  &quot;^id&quot;,</span>
<a href="#l5.1103"></a><span id="l5.1103" class="difflineminus">-  &quot;$name&quot;,</span>
<a href="#l5.1104"></a><span id="l5.1104" class="difflineminus">-  &quot;value&quot;,</span>
<a href="#l5.1105"></a><span id="l5.1105" class="difflineminus">-  &quot;$valuetype&quot;,</span>
<a href="#l5.1106"></a><span id="l5.1106" class="difflineminus">-  &quot;type&quot;,</span>
<a href="#l5.1107"></a><span id="l5.1107" class="difflineminus">-];</span>
<a href="#l5.1108"></a><span id="l5.1108" class="difflineplus">+gHTMLAttr.param = [&quot;^id&quot;, &quot;$name&quot;, &quot;value&quot;, &quot;$valuetype&quot;, &quot;type&quot;];</span>
<a href="#l5.1109"></a><span id="l5.1109" class="difflineplus">+</span>
<a href="#l5.1110"></a><span id="l5.1110" class="difflineplus">+gHTMLAttr.param_valuetype = [&quot;data&quot;, &quot;ref&quot;, &quot;object&quot;];</span>
<a href="#l5.1111"></a><span id="l5.1111"> </span>
<a href="#l5.1112"></a><span id="l5.1112" class="difflineminus">-gHTMLAttr.param_valuetype = [</span>
<a href="#l5.1113"></a><span id="l5.1113" class="difflineminus">-  &quot;data&quot;,</span>
<a href="#l5.1114"></a><span id="l5.1114" class="difflineminus">-  &quot;ref&quot;,</span>
<a href="#l5.1115"></a><span id="l5.1115" class="difflineminus">-  &quot;object&quot;,</span>
<a href="#l5.1116"></a><span id="l5.1116" class="difflineminus">-];</span>
<a href="#l5.1117"></a><span id="l5.1117" class="difflineminus">-</span>
<a href="#l5.1118"></a><span id="l5.1118" class="difflineplus">+gHTMLAttr.pre = [&quot;%width&quot;, &quot;-&quot;, &quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.1119"></a><span id="l5.1119"> </span>
<a href="#l5.1120"></a><span id="l5.1120" class="difflineminus">-gHTMLAttr.pre = [</span>
<a href="#l5.1121"></a><span id="l5.1121" class="difflineminus">-  &quot;%width&quot;,</span>
<a href="#l5.1122"></a><span id="l5.1122" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.1123"></a><span id="l5.1123" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.1124"></a><span id="l5.1124" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.1125"></a><span id="l5.1125" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.1126"></a><span id="l5.1126" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.1127"></a><span id="l5.1127" class="difflineminus">-];</span>
<a href="#l5.1128"></a><span id="l5.1128" class="difflineplus">+gHTMLAttr.q = [&quot;cite&quot;, &quot;-&quot;, &quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.1129"></a><span id="l5.1129"> </span>
<a href="#l5.1130"></a><span id="l5.1130" class="difflineminus">-gHTMLAttr.q = [</span>
<a href="#l5.1131"></a><span id="l5.1131" class="difflineminus">-  &quot;cite&quot;,</span>
<a href="#l5.1132"></a><span id="l5.1132" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.1133"></a><span id="l5.1133" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.1134"></a><span id="l5.1134" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.1135"></a><span id="l5.1135" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.1136"></a><span id="l5.1136" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.1137"></a><span id="l5.1137" class="difflineminus">-];</span>
<a href="#l5.1138"></a><span id="l5.1138" class="difflineplus">+gHTMLAttr.s = [&quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.1139"></a><span id="l5.1139"> </span>
<a href="#l5.1140"></a><span id="l5.1140" class="difflineminus">-gHTMLAttr.s = [</span>
<a href="#l5.1141"></a><span id="l5.1141" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.1142"></a><span id="l5.1142" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.1143"></a><span id="l5.1143" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.1144"></a><span id="l5.1144" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.1145"></a><span id="l5.1145" class="difflineminus">-];</span>
<a href="#l5.1146"></a><span id="l5.1146" class="difflineplus">+gHTMLAttr.samp = [&quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.1147"></a><span id="l5.1147"> </span>
<a href="#l5.1148"></a><span id="l5.1148" class="difflineminus">-gHTMLAttr.samp = [</span>
<a href="#l5.1149"></a><span id="l5.1149" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.1150"></a><span id="l5.1150" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.1151"></a><span id="l5.1151" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.1152"></a><span id="l5.1152" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.1153"></a><span id="l5.1153" class="difflineminus">-];</span>
<a href="#l5.1154"></a><span id="l5.1154" class="difflineplus">+gHTMLAttr.script = [&quot;charset&quot;, &quot;$type&quot;, &quot;language&quot;, &quot;src&quot;, &quot;defer&quot;];</span>
<a href="#l5.1155"></a><span id="l5.1155"> </span>
<a href="#l5.1156"></a><span id="l5.1156" class="difflineminus">-gHTMLAttr.script = [</span>
<a href="#l5.1157"></a><span id="l5.1157" class="difflineminus">-  &quot;charset&quot;,</span>
<a href="#l5.1158"></a><span id="l5.1158" class="difflineminus">-  &quot;$type&quot;,</span>
<a href="#l5.1159"></a><span id="l5.1159" class="difflineminus">-  &quot;language&quot;,</span>
<a href="#l5.1160"></a><span id="l5.1160" class="difflineminus">-  &quot;src&quot;,</span>
<a href="#l5.1161"></a><span id="l5.1161" class="difflineminus">-  &quot;defer&quot;,</span>
<a href="#l5.1162"></a><span id="l5.1162" class="difflineminus">-];</span>
<a href="#l5.1163"></a><span id="l5.1163" class="difflineminus">-</span>
<a href="#l5.1164"></a><span id="l5.1164" class="difflineminus">-gHTMLAttr.script_defer = [</span>
<a href="#l5.1165"></a><span id="l5.1165" class="difflineminus">-  &quot;defer&quot;,</span>
<a href="#l5.1166"></a><span id="l5.1166" class="difflineminus">-];</span>
<a href="#l5.1167"></a><span id="l5.1167" class="difflineminus">-</span>
<a href="#l5.1168"></a><span id="l5.1168" class="difflineplus">+gHTMLAttr.script_defer = [&quot;defer&quot;];</span>
<a href="#l5.1169"></a><span id="l5.1169"> </span>
<a href="#l5.1170"></a><span id="l5.1170"> gHTMLAttr.select = [</span>
<a href="#l5.1171"></a><span id="l5.1171">   &quot;name&quot;,</span>
<a href="#l5.1172"></a><span id="l5.1172">   &quot;#size&quot;,</span>
<a href="#l5.1173"></a><span id="l5.1173">   &quot;multiple&quot;,</span>
<a href="#l5.1174"></a><span id="l5.1174">   &quot;disabled&quot;,</span>
<a href="#l5.1175"></a><span id="l5.1175">   &quot;#tabindex&quot;,</span>
<a href="#l5.1176"></a><span id="l5.1176">   &quot;-&quot;,</span>
<a href="#l5.1177"></a><span id="l5.1177">   &quot;_core&quot;,</span>
<a href="#l5.1178"></a><span id="l5.1178">   &quot;-&quot;,</span>
<a href="#l5.1179"></a><span id="l5.1179">   &quot;^lang&quot;,</span>
<a href="#l5.1180"></a><span id="l5.1180">   &quot;dir&quot;,</span>
<a href="#l5.1181"></a><span id="l5.1181"> ];</span>
<a href="#l5.1182"></a><span id="l5.1182"> </span>
<a href="#l5.1183"></a><span id="l5.1183" class="difflineminus">-gHTMLAttr.select_multiple = [</span>
<a href="#l5.1184"></a><span id="l5.1184" class="difflineminus">-  &quot;multiple&quot;,</span>
<a href="#l5.1185"></a><span id="l5.1185" class="difflineminus">-];</span>
<a href="#l5.1186"></a><span id="l5.1186" class="difflineplus">+gHTMLAttr.select_multiple = [&quot;multiple&quot;];</span>
<a href="#l5.1187"></a><span id="l5.1187"> </span>
<a href="#l5.1188"></a><span id="l5.1188" class="difflineminus">-gHTMLAttr.select_disabled = [</span>
<a href="#l5.1189"></a><span id="l5.1189" class="difflineminus">-  &quot;disabled&quot;,</span>
<a href="#l5.1190"></a><span id="l5.1190" class="difflineminus">-];</span>
<a href="#l5.1191"></a><span id="l5.1191" class="difflineplus">+gHTMLAttr.select_disabled = [&quot;disabled&quot;];</span>
<a href="#l5.1192"></a><span id="l5.1192"> </span>
<a href="#l5.1193"></a><span id="l5.1193" class="difflineminus">-gHTMLAttr.small = [</span>
<a href="#l5.1194"></a><span id="l5.1194" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.1195"></a><span id="l5.1195" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.1196"></a><span id="l5.1196" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.1197"></a><span id="l5.1197" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.1198"></a><span id="l5.1198" class="difflineminus">-];</span>
<a href="#l5.1199"></a><span id="l5.1199" class="difflineplus">+gHTMLAttr.small = [&quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.1200"></a><span id="l5.1200"> </span>
<a href="#l5.1201"></a><span id="l5.1201" class="difflineminus">-gHTMLAttr.span = [</span>
<a href="#l5.1202"></a><span id="l5.1202" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.1203"></a><span id="l5.1203" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.1204"></a><span id="l5.1204" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.1205"></a><span id="l5.1205" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.1206"></a><span id="l5.1206" class="difflineminus">-];</span>
<a href="#l5.1207"></a><span id="l5.1207" class="difflineminus">-</span>
<a href="#l5.1208"></a><span id="l5.1208" class="difflineminus">-gHTMLAttr.strike = [</span>
<a href="#l5.1209"></a><span id="l5.1209" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.1210"></a><span id="l5.1210" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.1211"></a><span id="l5.1211" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.1212"></a><span id="l5.1212" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.1213"></a><span id="l5.1213" class="difflineminus">-];</span>
<a href="#l5.1214"></a><span id="l5.1214" class="difflineplus">+gHTMLAttr.span = [&quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.1215"></a><span id="l5.1215"> </span>
<a href="#l5.1216"></a><span id="l5.1216" class="difflineminus">-gHTMLAttr.strong = [</span>
<a href="#l5.1217"></a><span id="l5.1217" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.1218"></a><span id="l5.1218" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.1219"></a><span id="l5.1219" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.1220"></a><span id="l5.1220" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.1221"></a><span id="l5.1221" class="difflineminus">-];</span>
<a href="#l5.1222"></a><span id="l5.1222" class="difflineplus">+gHTMLAttr.strike = [&quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.1223"></a><span id="l5.1223" class="difflineplus">+</span>
<a href="#l5.1224"></a><span id="l5.1224" class="difflineplus">+gHTMLAttr.strong = [&quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.1225"></a><span id="l5.1225"> </span>
<a href="#l5.1226"></a><span id="l5.1226" class="difflineminus">-gHTMLAttr.style = [</span>
<a href="#l5.1227"></a><span id="l5.1227" class="difflineminus">-  &quot;$type&quot;,</span>
<a href="#l5.1228"></a><span id="l5.1228" class="difflineminus">-  &quot;media&quot;,</span>
<a href="#l5.1229"></a><span id="l5.1229" class="difflineminus">-  &quot;title&quot;,</span>
<a href="#l5.1230"></a><span id="l5.1230" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.1231"></a><span id="l5.1231" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.1232"></a><span id="l5.1232" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.1233"></a><span id="l5.1233" class="difflineminus">-];</span>
<a href="#l5.1234"></a><span id="l5.1234" class="difflineplus">+gHTMLAttr.style = [&quot;$type&quot;, &quot;media&quot;, &quot;title&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.1235"></a><span id="l5.1235"> </span>
<a href="#l5.1236"></a><span id="l5.1236" class="difflineminus">-gHTMLAttr.sub = [</span>
<a href="#l5.1237"></a><span id="l5.1237" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.1238"></a><span id="l5.1238" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.1239"></a><span id="l5.1239" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.1240"></a><span id="l5.1240" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.1241"></a><span id="l5.1241" class="difflineminus">-];</span>
<a href="#l5.1242"></a><span id="l5.1242" class="difflineplus">+gHTMLAttr.sub = [&quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.1243"></a><span id="l5.1243"> </span>
<a href="#l5.1244"></a><span id="l5.1244" class="difflineminus">-gHTMLAttr.sup = [</span>
<a href="#l5.1245"></a><span id="l5.1245" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.1246"></a><span id="l5.1246" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.1247"></a><span id="l5.1247" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.1248"></a><span id="l5.1248" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.1249"></a><span id="l5.1249" class="difflineminus">-];</span>
<a href="#l5.1250"></a><span id="l5.1250" class="difflineplus">+gHTMLAttr.sup = [&quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.1251"></a><span id="l5.1251"> </span>
<a href="#l5.1252"></a><span id="l5.1252"> gHTMLAttr.table = [</span>
<a href="#l5.1253"></a><span id="l5.1253">   &quot;summary&quot;,</span>
<a href="#l5.1254"></a><span id="l5.1254">   &quot;%width&quot;,</span>
<a href="#l5.1255"></a><span id="l5.1255">   &quot;#border&quot;,</span>
<a href="#l5.1256"></a><span id="l5.1256">   &quot;frame&quot;,</span>
<a href="#l5.1257"></a><span id="l5.1257">   &quot;rules&quot;,</span>
<a href="#l5.1258"></a><span id="l5.1258">   &quot;#cellspacing&quot;,</span>
<a href="#l5.1259"></a><span id="l5.1259" class="difflineat">@@ -1302,23 +744,17 @@ gHTMLAttr.table_frame = [</span>
<a href="#l5.1260"></a><span id="l5.1260">   &quot;hsides&quot;,</span>
<a href="#l5.1261"></a><span id="l5.1261">   &quot;lhs&quot;,</span>
<a href="#l5.1262"></a><span id="l5.1262">   &quot;rhs&quot;,</span>
<a href="#l5.1263"></a><span id="l5.1263">   &quot;vsides&quot;,</span>
<a href="#l5.1264"></a><span id="l5.1264">   &quot;box&quot;,</span>
<a href="#l5.1265"></a><span id="l5.1265">   &quot;border&quot;,</span>
<a href="#l5.1266"></a><span id="l5.1266"> ];</span>
<a href="#l5.1267"></a><span id="l5.1267"> </span>
<a href="#l5.1268"></a><span id="l5.1268" class="difflineminus">-gHTMLAttr.table_rules = [</span>
<a href="#l5.1269"></a><span id="l5.1269" class="difflineminus">-  &quot;none&quot;,</span>
<a href="#l5.1270"></a><span id="l5.1270" class="difflineminus">-  &quot;groups&quot;,</span>
<a href="#l5.1271"></a><span id="l5.1271" class="difflineminus">-  &quot;rows&quot;,</span>
<a href="#l5.1272"></a><span id="l5.1272" class="difflineminus">-  &quot;cols&quot;,</span>
<a href="#l5.1273"></a><span id="l5.1273" class="difflineminus">-  &quot;all&quot;,</span>
<a href="#l5.1274"></a><span id="l5.1274" class="difflineminus">-];</span>
<a href="#l5.1275"></a><span id="l5.1275" class="difflineplus">+gHTMLAttr.table_rules = [&quot;none&quot;, &quot;groups&quot;, &quot;rows&quot;, &quot;cols&quot;, &quot;all&quot;];</span>
<a href="#l5.1276"></a><span id="l5.1276"> </span>
<a href="#l5.1277"></a><span id="l5.1277"> // Note; This is alignment of the table,</span>
<a href="#l5.1278"></a><span id="l5.1278"> //  not table contents, like all other table child elements</span>
<a href="#l5.1279"></a><span id="l5.1279"> gHTMLAttr.table_align = gHAlign;</span>
<a href="#l5.1280"></a><span id="l5.1280"> </span>
<a href="#l5.1281"></a><span id="l5.1281"> gHTMLAttr.table_bgcolor = gHTMLColors;</span>
<a href="#l5.1282"></a><span id="l5.1282"> </span>
<a href="#l5.1283"></a><span id="l5.1283"> gHTMLAttr.tbody = [</span>
<a href="#l5.1284"></a><span id="l5.1284" class="difflineat">@@ -1354,38 +790,31 @@ gHTMLAttr.td = [</span>
<a href="#l5.1285"></a><span id="l5.1285">   &quot;%height&quot;,</span>
<a href="#l5.1286"></a><span id="l5.1286">   &quot;-&quot;,</span>
<a href="#l5.1287"></a><span id="l5.1287">   &quot;_core&quot;,</span>
<a href="#l5.1288"></a><span id="l5.1288">   &quot;-&quot;,</span>
<a href="#l5.1289"></a><span id="l5.1289">   &quot;^lang&quot;,</span>
<a href="#l5.1290"></a><span id="l5.1290">   &quot;dir&quot;,</span>
<a href="#l5.1291"></a><span id="l5.1291"> ];</span>
<a href="#l5.1292"></a><span id="l5.1292"> </span>
<a href="#l5.1293"></a><span id="l5.1293" class="difflineminus">-gHTMLAttr.td_scope = [</span>
<a href="#l5.1294"></a><span id="l5.1294" class="difflineminus">-  &quot;row&quot;,</span>
<a href="#l5.1295"></a><span id="l5.1295" class="difflineminus">-  &quot;col&quot;,</span>
<a href="#l5.1296"></a><span id="l5.1296" class="difflineminus">-  &quot;rowgroup&quot;,</span>
<a href="#l5.1297"></a><span id="l5.1297" class="difflineminus">-  &quot;colgroup&quot;,</span>
<a href="#l5.1298"></a><span id="l5.1298" class="difflineminus">-];</span>
<a href="#l5.1299"></a><span id="l5.1299" class="difflineplus">+gHTMLAttr.td_scope = [&quot;row&quot;, &quot;col&quot;, &quot;rowgroup&quot;, &quot;colgroup&quot;];</span>
<a href="#l5.1300"></a><span id="l5.1300"> </span>
<a href="#l5.1301"></a><span id="l5.1301"> gHTMLAttr.td_rowspan = [</span>
<a href="#l5.1302"></a><span id="l5.1302">   &quot;1&quot;, // default</span>
<a href="#l5.1303"></a><span id="l5.1303"> ];</span>
<a href="#l5.1304"></a><span id="l5.1304"> </span>
<a href="#l5.1305"></a><span id="l5.1305"> gHTMLAttr.td_colspan = [</span>
<a href="#l5.1306"></a><span id="l5.1306">   &quot;1&quot;, // default</span>
<a href="#l5.1307"></a><span id="l5.1307"> ];</span>
<a href="#l5.1308"></a><span id="l5.1308"> </span>
<a href="#l5.1309"></a><span id="l5.1309"> gHTMLAttr.td_align = gHAlignTableContent;</span>
<a href="#l5.1310"></a><span id="l5.1310"> </span>
<a href="#l5.1311"></a><span id="l5.1311"> gHTMLAttr.td_valign = gVAlignTable;</span>
<a href="#l5.1312"></a><span id="l5.1312"> </span>
<a href="#l5.1313"></a><span id="l5.1313" class="difflineminus">-gHTMLAttr.td_nowrap = [</span>
<a href="#l5.1314"></a><span id="l5.1314" class="difflineminus">-  &quot;nowrap&quot;,</span>
<a href="#l5.1315"></a><span id="l5.1315" class="difflineminus">-];</span>
<a href="#l5.1316"></a><span id="l5.1316" class="difflineplus">+gHTMLAttr.td_nowrap = [&quot;nowrap&quot;];</span>
<a href="#l5.1317"></a><span id="l5.1317"> </span>
<a href="#l5.1318"></a><span id="l5.1318"> gHTMLAttr.td_bgcolor = gHTMLColors;</span>
<a href="#l5.1319"></a><span id="l5.1319"> </span>
<a href="#l5.1320"></a><span id="l5.1320"> gHTMLAttr.textarea = [</span>
<a href="#l5.1321"></a><span id="l5.1321">   &quot;name&quot;,</span>
<a href="#l5.1322"></a><span id="l5.1322">   &quot;$#rows&quot;,</span>
<a href="#l5.1323"></a><span id="l5.1323">   &quot;$#cols&quot;,</span>
<a href="#l5.1324"></a><span id="l5.1324">   &quot;disabled&quot;,</span>
<a href="#l5.1325"></a><span id="l5.1325" class="difflineat">@@ -1394,24 +823,19 @@ gHTMLAttr.textarea = [</span>
<a href="#l5.1326"></a><span id="l5.1326">   &quot;!accesskey&quot;,</span>
<a href="#l5.1327"></a><span id="l5.1327">   &quot;-&quot;,</span>
<a href="#l5.1328"></a><span id="l5.1328">   &quot;_core&quot;,</span>
<a href="#l5.1329"></a><span id="l5.1329">   &quot;-&quot;,</span>
<a href="#l5.1330"></a><span id="l5.1330">   &quot;^lang&quot;,</span>
<a href="#l5.1331"></a><span id="l5.1331">   &quot;dir&quot;,</span>
<a href="#l5.1332"></a><span id="l5.1332"> ];</span>
<a href="#l5.1333"></a><span id="l5.1333"> </span>
<a href="#l5.1334"></a><span id="l5.1334" class="difflineminus">-gHTMLAttr.textarea_disabled = [</span>
<a href="#l5.1335"></a><span id="l5.1335" class="difflineminus">-  &quot;disabled&quot;,</span>
<a href="#l5.1336"></a><span id="l5.1336" class="difflineminus">-];</span>
<a href="#l5.1337"></a><span id="l5.1337" class="difflineplus">+gHTMLAttr.textarea_disabled = [&quot;disabled&quot;];</span>
<a href="#l5.1338"></a><span id="l5.1338"> </span>
<a href="#l5.1339"></a><span id="l5.1339" class="difflineminus">-gHTMLAttr.textarea_readonly = [</span>
<a href="#l5.1340"></a><span id="l5.1340" class="difflineminus">-  &quot;readonly&quot;,</span>
<a href="#l5.1341"></a><span id="l5.1341" class="difflineminus">-];</span>
<a href="#l5.1342"></a><span id="l5.1342" class="difflineminus">-</span>
<a href="#l5.1343"></a><span id="l5.1343" class="difflineplus">+gHTMLAttr.textarea_readonly = [&quot;readonly&quot;];</span>
<a href="#l5.1344"></a><span id="l5.1344"> </span>
<a href="#l5.1345"></a><span id="l5.1345"> gHTMLAttr.tfoot = [</span>
<a href="#l5.1346"></a><span id="l5.1346">   &quot;align&quot;,</span>
<a href="#l5.1347"></a><span id="l5.1347">   &quot;!char&quot;,</span>
<a href="#l5.1348"></a><span id="l5.1348">   &quot;#charoff&quot;,</span>
<a href="#l5.1349"></a><span id="l5.1349">   &quot;valign&quot;,</span>
<a href="#l5.1350"></a><span id="l5.1350">   &quot;-&quot;,</span>
<a href="#l5.1351"></a><span id="l5.1351">   &quot;_core&quot;,</span>
<a href="#l5.1352"></a><span id="l5.1352" class="difflineat">@@ -1441,38 +865,31 @@ gHTMLAttr.th = [</span>
<a href="#l5.1353"></a><span id="l5.1353">   &quot;%height&quot;,</span>
<a href="#l5.1354"></a><span id="l5.1354">   &quot;-&quot;,</span>
<a href="#l5.1355"></a><span id="l5.1355">   &quot;_core&quot;,</span>
<a href="#l5.1356"></a><span id="l5.1356">   &quot;-&quot;,</span>
<a href="#l5.1357"></a><span id="l5.1357">   &quot;^lang&quot;,</span>
<a href="#l5.1358"></a><span id="l5.1358">   &quot;dir&quot;,</span>
<a href="#l5.1359"></a><span id="l5.1359"> ];</span>
<a href="#l5.1360"></a><span id="l5.1360"> </span>
<a href="#l5.1361"></a><span id="l5.1361" class="difflineminus">-gHTMLAttr.th_scope = [</span>
<a href="#l5.1362"></a><span id="l5.1362" class="difflineminus">-  &quot;row&quot;,</span>
<a href="#l5.1363"></a><span id="l5.1363" class="difflineminus">-  &quot;col&quot;,</span>
<a href="#l5.1364"></a><span id="l5.1364" class="difflineminus">-  &quot;rowgroup&quot;,</span>
<a href="#l5.1365"></a><span id="l5.1365" class="difflineminus">-  &quot;colgroup&quot;,</span>
<a href="#l5.1366"></a><span id="l5.1366" class="difflineminus">-];</span>
<a href="#l5.1367"></a><span id="l5.1367" class="difflineplus">+gHTMLAttr.th_scope = [&quot;row&quot;, &quot;col&quot;, &quot;rowgroup&quot;, &quot;colgroup&quot;];</span>
<a href="#l5.1368"></a><span id="l5.1368"> </span>
<a href="#l5.1369"></a><span id="l5.1369"> gHTMLAttr.th_rowspan = [</span>
<a href="#l5.1370"></a><span id="l5.1370">   &quot;1&quot;, // default</span>
<a href="#l5.1371"></a><span id="l5.1371"> ];</span>
<a href="#l5.1372"></a><span id="l5.1372"> </span>
<a href="#l5.1373"></a><span id="l5.1373"> gHTMLAttr.th_colspan = [</span>
<a href="#l5.1374"></a><span id="l5.1374">   &quot;1&quot;, // default</span>
<a href="#l5.1375"></a><span id="l5.1375"> ];</span>
<a href="#l5.1376"></a><span id="l5.1376"> </span>
<a href="#l5.1377"></a><span id="l5.1377"> gHTMLAttr.th_align = gHAlignTableContent;</span>
<a href="#l5.1378"></a><span id="l5.1378"> </span>
<a href="#l5.1379"></a><span id="l5.1379"> gHTMLAttr.th_valign = gVAlignTable;</span>
<a href="#l5.1380"></a><span id="l5.1380"> </span>
<a href="#l5.1381"></a><span id="l5.1381" class="difflineminus">-gHTMLAttr.th_nowrap = [</span>
<a href="#l5.1382"></a><span id="l5.1382" class="difflineminus">-  &quot;nowrap&quot;,</span>
<a href="#l5.1383"></a><span id="l5.1383" class="difflineminus">-];</span>
<a href="#l5.1384"></a><span id="l5.1384" class="difflineplus">+gHTMLAttr.th_nowrap = [&quot;nowrap&quot;];</span>
<a href="#l5.1385"></a><span id="l5.1385"> </span>
<a href="#l5.1386"></a><span id="l5.1386"> gHTMLAttr.th_bgcolor = gHTMLColors;</span>
<a href="#l5.1387"></a><span id="l5.1387"> </span>
<a href="#l5.1388"></a><span id="l5.1388"> gHTMLAttr.thead = [</span>
<a href="#l5.1389"></a><span id="l5.1389">   &quot;align&quot;,</span>
<a href="#l5.1390"></a><span id="l5.1390">   &quot;!char&quot;,</span>
<a href="#l5.1391"></a><span id="l5.1391">   &quot;#charoff&quot;,</span>
<a href="#l5.1392"></a><span id="l5.1392">   &quot;valign&quot;,</span>
<a href="#l5.1393"></a><span id="l5.1393" class="difflineat">@@ -1482,20 +899,17 @@ gHTMLAttr.thead = [</span>
<a href="#l5.1394"></a><span id="l5.1394">   &quot;^lang&quot;,</span>
<a href="#l5.1395"></a><span id="l5.1395">   &quot;dir&quot;,</span>
<a href="#l5.1396"></a><span id="l5.1396"> ];</span>
<a href="#l5.1397"></a><span id="l5.1397"> </span>
<a href="#l5.1398"></a><span id="l5.1398"> gHTMLAttr.thead_align = gHAlignTableContent;</span>
<a href="#l5.1399"></a><span id="l5.1399"> </span>
<a href="#l5.1400"></a><span id="l5.1400"> gHTMLAttr.thead_valign = gVAlignTable;</span>
<a href="#l5.1401"></a><span id="l5.1401"> </span>
<a href="#l5.1402"></a><span id="l5.1402" class="difflineminus">-gHTMLAttr.title = [</span>
<a href="#l5.1403"></a><span id="l5.1403" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.1404"></a><span id="l5.1404" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.1405"></a><span id="l5.1405" class="difflineminus">-];</span>
<a href="#l5.1406"></a><span id="l5.1406" class="difflineplus">+gHTMLAttr.title = [&quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.1407"></a><span id="l5.1407"> </span>
<a href="#l5.1408"></a><span id="l5.1408"> gHTMLAttr.tr = [</span>
<a href="#l5.1409"></a><span id="l5.1409">   &quot;align&quot;,</span>
<a href="#l5.1410"></a><span id="l5.1410">   &quot;!char&quot;,</span>
<a href="#l5.1411"></a><span id="l5.1411">   &quot;#charoff&quot;,</span>
<a href="#l5.1412"></a><span id="l5.1412">   &quot;valign&quot;,</span>
<a href="#l5.1413"></a><span id="l5.1413">   &quot;bgcolor&quot;,</span>
<a href="#l5.1414"></a><span id="l5.1414">   &quot;-&quot;,</span>
<a href="#l5.1415"></a><span id="l5.1415" class="difflineat">@@ -1506,128 +920,54 @@ gHTMLAttr.tr = [</span>
<a href="#l5.1416"></a><span id="l5.1416"> ];</span>
<a href="#l5.1417"></a><span id="l5.1417"> </span>
<a href="#l5.1418"></a><span id="l5.1418"> gHTMLAttr.tr_align = gHAlignTableContent;</span>
<a href="#l5.1419"></a><span id="l5.1419"> </span>
<a href="#l5.1420"></a><span id="l5.1420"> gHTMLAttr.tr_valign = gVAlignTable;</span>
<a href="#l5.1421"></a><span id="l5.1421"> </span>
<a href="#l5.1422"></a><span id="l5.1422"> gHTMLAttr.tr_bgcolor = gHTMLColors;</span>
<a href="#l5.1423"></a><span id="l5.1423"> </span>
<a href="#l5.1424"></a><span id="l5.1424" class="difflineminus">-gHTMLAttr.tt = [</span>
<a href="#l5.1425"></a><span id="l5.1425" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.1426"></a><span id="l5.1426" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.1427"></a><span id="l5.1427" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.1428"></a><span id="l5.1428" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.1429"></a><span id="l5.1429" class="difflineminus">-];</span>
<a href="#l5.1430"></a><span id="l5.1430" class="difflineplus">+gHTMLAttr.tt = [&quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.1431"></a><span id="l5.1431"> </span>
<a href="#l5.1432"></a><span id="l5.1432" class="difflineminus">-gHTMLAttr.u = [</span>
<a href="#l5.1433"></a><span id="l5.1433" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.1434"></a><span id="l5.1434" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.1435"></a><span id="l5.1435" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.1436"></a><span id="l5.1436" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.1437"></a><span id="l5.1437" class="difflineminus">-];</span>
<a href="#l5.1438"></a><span id="l5.1438" class="difflineminus">-gHTMLAttr.ul = [</span>
<a href="#l5.1439"></a><span id="l5.1439" class="difflineminus">-  &quot;type&quot;,</span>
<a href="#l5.1440"></a><span id="l5.1440" class="difflineminus">-  &quot;compact&quot;,</span>
<a href="#l5.1441"></a><span id="l5.1441" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.1442"></a><span id="l5.1442" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.1443"></a><span id="l5.1443" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.1444"></a><span id="l5.1444" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.1445"></a><span id="l5.1445" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.1446"></a><span id="l5.1446" class="difflineminus">-];</span>
<a href="#l5.1447"></a><span id="l5.1447" class="difflineplus">+gHTMLAttr.u = [&quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.1448"></a><span id="l5.1448" class="difflineplus">+gHTMLAttr.ul = [&quot;type&quot;, &quot;compact&quot;, &quot;-&quot;, &quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.1449"></a><span id="l5.1449"> </span>
<a href="#l5.1450"></a><span id="l5.1450" class="difflineminus">-gHTMLAttr.ul_type = [</span>
<a href="#l5.1451"></a><span id="l5.1451" class="difflineminus">-  &quot;disc&quot;,</span>
<a href="#l5.1452"></a><span id="l5.1452" class="difflineminus">-  &quot;square&quot;,</span>
<a href="#l5.1453"></a><span id="l5.1453" class="difflineminus">-  &quot;circle&quot;,</span>
<a href="#l5.1454"></a><span id="l5.1454" class="difflineminus">-];</span>
<a href="#l5.1455"></a><span id="l5.1455" class="difflineplus">+gHTMLAttr.ul_type = [&quot;disc&quot;, &quot;square&quot;, &quot;circle&quot;];</span>
<a href="#l5.1456"></a><span id="l5.1456"> </span>
<a href="#l5.1457"></a><span id="l5.1457" class="difflineminus">-gHTMLAttr.ul_compact = [</span>
<a href="#l5.1458"></a><span id="l5.1458" class="difflineminus">-  &quot;compact&quot;,</span>
<a href="#l5.1459"></a><span id="l5.1459" class="difflineminus">-];</span>
<a href="#l5.1460"></a><span id="l5.1460" class="difflineminus">-</span>
<a href="#l5.1461"></a><span id="l5.1461" class="difflineplus">+gHTMLAttr.ul_compact = [&quot;compact&quot;];</span>
<a href="#l5.1462"></a><span id="l5.1462"> </span>
<a href="#l5.1463"></a><span id="l5.1463"> // Prefix with &quot;_&quot; since this is reserved (it's stripped out)</span>
<a href="#l5.1464"></a><span id="l5.1464" class="difflineminus">-gHTMLAttr._var = [</span>
<a href="#l5.1465"></a><span id="l5.1465" class="difflineminus">-  &quot;_core&quot;,</span>
<a href="#l5.1466"></a><span id="l5.1466" class="difflineminus">-  &quot;-&quot;,</span>
<a href="#l5.1467"></a><span id="l5.1467" class="difflineminus">-  &quot;^lang&quot;,</span>
<a href="#l5.1468"></a><span id="l5.1468" class="difflineminus">-  &quot;dir&quot;,</span>
<a href="#l5.1469"></a><span id="l5.1469" class="difflineminus">-];</span>
<a href="#l5.1470"></a><span id="l5.1470" class="difflineplus">+gHTMLAttr._var = [&quot;_core&quot;, &quot;-&quot;, &quot;^lang&quot;, &quot;dir&quot;];</span>
<a href="#l5.1471"></a><span id="l5.1471"> </span>
<a href="#l5.1472"></a><span id="l5.1472"> // ================ JS Attributes ================ //</span>
<a href="#l5.1473"></a><span id="l5.1473"> // These are element specific even handlers.</span>
<a href="#l5.1474"></a><span id="l5.1474"> /* Most all elements use gCoreJSEvents, so those</span>
<a href="#l5.1475"></a><span id="l5.1475">    are assumed except for those listed here with &quot;noEvents&quot;</span>
<a href="#l5.1476"></a><span id="l5.1476"> */</span>
<a href="#l5.1477"></a><span id="l5.1477"> </span>
<a href="#l5.1478"></a><span id="l5.1478" class="difflineminus">-gJSAttr.a = [</span>
<a href="#l5.1479"></a><span id="l5.1479" class="difflineminus">-  &quot;onfocus&quot;,</span>
<a href="#l5.1480"></a><span id="l5.1480" class="difflineminus">-  &quot;onblur&quot;,</span>
<a href="#l5.1481"></a><span id="l5.1481" class="difflineminus">-];</span>
<a href="#l5.1482"></a><span id="l5.1482" class="difflineplus">+gJSAttr.a = [&quot;onfocus&quot;, &quot;onblur&quot;];</span>
<a href="#l5.1483"></a><span id="l5.1483"> </span>
<a href="#l5.1484"></a><span id="l5.1484" class="difflineminus">-gJSAttr.area = [</span>
<a href="#l5.1485"></a><span id="l5.1485" class="difflineminus">-  &quot;onfocus&quot;,</span>
<a href="#l5.1486"></a><span id="l5.1486" class="difflineminus">-  &quot;onblur&quot;,</span>
<a href="#l5.1487"></a><span id="l5.1487" class="difflineminus">-];</span>
<a href="#l5.1488"></a><span id="l5.1488" class="difflineplus">+gJSAttr.area = [&quot;onfocus&quot;, &quot;onblur&quot;];</span>
<a href="#l5.1489"></a><span id="l5.1489"> </span>
<a href="#l5.1490"></a><span id="l5.1490" class="difflineminus">-gJSAttr.body = [</span>
<a href="#l5.1491"></a><span id="l5.1491" class="difflineminus">-  &quot;onload&quot;,</span>
<a href="#l5.1492"></a><span id="l5.1492" class="difflineminus">-  &quot;onupload&quot;,</span>
<a href="#l5.1493"></a><span id="l5.1493" class="difflineminus">-];</span>
<a href="#l5.1494"></a><span id="l5.1494" class="difflineplus">+gJSAttr.body = [&quot;onload&quot;, &quot;onupload&quot;];</span>
<a href="#l5.1495"></a><span id="l5.1495"> </span>
<a href="#l5.1496"></a><span id="l5.1496" class="difflineminus">-gJSAttr.button = [</span>
<a href="#l5.1497"></a><span id="l5.1497" class="difflineminus">-  &quot;onfocus&quot;,</span>
<a href="#l5.1498"></a><span id="l5.1498" class="difflineminus">-  &quot;onblur&quot;,</span>
<a href="#l5.1499"></a><span id="l5.1499" class="difflineminus">-];</span>
<a href="#l5.1500"></a><span id="l5.1500" class="difflineplus">+gJSAttr.button = [&quot;onfocus&quot;, &quot;onblur&quot;];</span>
<a href="#l5.1501"></a><span id="l5.1501"> </span>
<a href="#l5.1502"></a><span id="l5.1502" class="difflineminus">-gJSAttr.form = [</span>
<a href="#l5.1503"></a><span id="l5.1503" class="difflineminus">-  &quot;onsubmit&quot;,</span>
<a href="#l5.1504"></a><span id="l5.1504" class="difflineminus">-  &quot;onreset&quot;,</span>
<a href="#l5.1505"></a><span id="l5.1505" class="difflineminus">-];</span>
<a href="#l5.1506"></a><span id="l5.1506" class="difflineplus">+gJSAttr.form = [&quot;onsubmit&quot;, &quot;onreset&quot;];</span>
<a href="#l5.1507"></a><span id="l5.1507"> </span>
<a href="#l5.1508"></a><span id="l5.1508" class="difflineminus">-gJSAttr.frameset = [</span>
<a href="#l5.1509"></a><span id="l5.1509" class="difflineminus">-  &quot;onload&quot;,</span>
<a href="#l5.1510"></a><span id="l5.1510" class="difflineminus">-  &quot;onunload&quot;,</span>
<a href="#l5.1511"></a><span id="l5.1511" class="difflineminus">-];</span>
<a href="#l5.1512"></a><span id="l5.1512" class="difflineplus">+gJSAttr.frameset = [&quot;onload&quot;, &quot;onunload&quot;];</span>
<a href="#l5.1513"></a><span id="l5.1513"> </span>
<a href="#l5.1514"></a><span id="l5.1514" class="difflineminus">-gJSAttr.input = [</span>
<a href="#l5.1515"></a><span id="l5.1515" class="difflineminus">-  &quot;onfocus&quot;,</span>
<a href="#l5.1516"></a><span id="l5.1516" class="difflineminus">-  &quot;onblur&quot;,</span>
<a href="#l5.1517"></a><span id="l5.1517" class="difflineminus">-  &quot;onselect&quot;,</span>
<a href="#l5.1518"></a><span id="l5.1518" class="difflineminus">-  &quot;onchange&quot;,</span>
<a href="#l5.1519"></a><span id="l5.1519" class="difflineminus">-];</span>
<a href="#l5.1520"></a><span id="l5.1520" class="difflineplus">+gJSAttr.input = [&quot;onfocus&quot;, &quot;onblur&quot;, &quot;onselect&quot;, &quot;onchange&quot;];</span>
<a href="#l5.1521"></a><span id="l5.1521"> </span>
<a href="#l5.1522"></a><span id="l5.1522" class="difflineminus">-gJSAttr.label = [</span>
<a href="#l5.1523"></a><span id="l5.1523" class="difflineminus">-  &quot;onfocus&quot;,</span>
<a href="#l5.1524"></a><span id="l5.1524" class="difflineminus">-  &quot;onblur&quot;,</span>
<a href="#l5.1525"></a><span id="l5.1525" class="difflineminus">-];</span>
<a href="#l5.1526"></a><span id="l5.1526" class="difflineplus">+gJSAttr.label = [&quot;onfocus&quot;, &quot;onblur&quot;];</span>
<a href="#l5.1527"></a><span id="l5.1527"> </span>
<a href="#l5.1528"></a><span id="l5.1528" class="difflineminus">-gJSAttr.select = [</span>
<a href="#l5.1529"></a><span id="l5.1529" class="difflineminus">-  &quot;onfocus&quot;,</span>
<a href="#l5.1530"></a><span id="l5.1530" class="difflineminus">-  &quot;onblur&quot;,</span>
<a href="#l5.1531"></a><span id="l5.1531" class="difflineminus">-  &quot;onchange&quot;,</span>
<a href="#l5.1532"></a><span id="l5.1532" class="difflineminus">-];</span>
<a href="#l5.1533"></a><span id="l5.1533" class="difflineplus">+gJSAttr.select = [&quot;onfocus&quot;, &quot;onblur&quot;, &quot;onchange&quot;];</span>
<a href="#l5.1534"></a><span id="l5.1534"> </span>
<a href="#l5.1535"></a><span id="l5.1535" class="difflineminus">-gJSAttr.textarea = [</span>
<a href="#l5.1536"></a><span id="l5.1536" class="difflineminus">-  &quot;onfocus&quot;,</span>
<a href="#l5.1537"></a><span id="l5.1537" class="difflineminus">-  &quot;onblur&quot;,</span>
<a href="#l5.1538"></a><span id="l5.1538" class="difflineminus">-  &quot;onselect&quot;,</span>
<a href="#l5.1539"></a><span id="l5.1539" class="difflineminus">-  &quot;onchange&quot;,</span>
<a href="#l5.1540"></a><span id="l5.1540" class="difflineminus">-];</span>
<a href="#l5.1541"></a><span id="l5.1541" class="difflineplus">+gJSAttr.textarea = [&quot;onfocus&quot;, &quot;onblur&quot;, &quot;onselect&quot;, &quot;onchange&quot;];</span>
<a href="#l5.1542"></a><span id="l5.1542"> </span>
<a href="#l5.1543"></a><span id="l5.1543"> // Elements that don't have JSEvents:</span>
<a href="#l5.1544"></a><span id="l5.1544" class="difflineminus">-gJSAttr.font = [</span>
<a href="#l5.1545"></a><span id="l5.1545" class="difflineminus">-  &quot;noJSEvents&quot;,</span>
<a href="#l5.1546"></a><span id="l5.1546" class="difflineminus">-];</span>
<a href="#l5.1547"></a><span id="l5.1547" class="difflineplus">+gJSAttr.font = [&quot;noJSEvents&quot;];</span>
<a href="#l5.1548"></a><span id="l5.1548"> </span>
<a href="#l5.1549"></a><span id="l5.1549" class="difflineminus">-gJSAttr.applet = [</span>
<a href="#l5.1550"></a><span id="l5.1550" class="difflineminus">-  &quot;noJSEvents&quot;,</span>
<a href="#l5.1551"></a><span id="l5.1551" class="difflineminus">-];</span>
<a href="#l5.1552"></a><span id="l5.1552" class="difflineplus">+gJSAttr.applet = [&quot;noJSEvents&quot;];</span>
<a href="#l5.1553"></a><span id="l5.1553"> </span>
<a href="#l5.1554"></a><span id="l5.1554" class="difflineminus">-gJSAttr.isindex = [</span>
<a href="#l5.1555"></a><span id="l5.1555" class="difflineminus">-  &quot;noJSEvents&quot;,</span>
<a href="#l5.1556"></a><span id="l5.1556" class="difflineminus">-];</span>
<a href="#l5.1557"></a><span id="l5.1557" class="difflineplus">+gJSAttr.isindex = [&quot;noJSEvents&quot;];</span>
<a href="#l5.1558"></a><span id="l5.1558"> </span>
<a href="#l5.1559"></a><span id="l5.1559" class="difflineminus">-gJSAttr.iframe = [</span>
<a href="#l5.1560"></a><span id="l5.1560" class="difflineminus">-  &quot;noJSEvents&quot;,</span>
<a href="#l5.1561"></a><span id="l5.1561" class="difflineminus">-];</span>
<a href="#l5.1562"></a><span id="l5.1562" class="difflineminus">-</span>
<a href="#l5.1563"></a><span id="l5.1563" class="difflineplus">+gJSAttr.iframe = [&quot;noJSEvents&quot;];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdAECSSAttributes.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdAECSSAttributes.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -32,84 +32,99 @@ function BuildCSSAttributeTable() {</span>
<a href="#l6.4"></a><span id="l6.4">     }</span>
<a href="#l6.5"></a><span id="l6.5">   }</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7">   ClearCSSInputWidgets();</span>
<a href="#l6.8"></a><span id="l6.8"> }</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10"> function onChangeCSSAttribute() {</span>
<a href="#l6.11"></a><span id="l6.11">   var name = TrimString(gDialog.AddCSSAttributeNameInput.value);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  if (!name)</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  if (!name) {</span>
<a href="#l6.14"></a><span id="l6.14">     return;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+  }</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17">   var value = TrimString(gDialog.AddCSSAttributeValueInput.value);</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19">   // First try to update existing attribute</span>
<a href="#l6.20"></a><span id="l6.20">   // If not found, add new attribute</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-  if (!UpdateExistingAttribute(name, value, &quot;CSSAList&quot;) &amp;&amp; value)</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+  if (!UpdateExistingAttribute(name, value, &quot;CSSAList&quot;) &amp;&amp; value) {</span>
<a href="#l6.23"></a><span id="l6.23">     AddTreeItem(name, value, &quot;CSSAList&quot;, CSSAttrs);</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+  }</span>
<a href="#l6.25"></a><span id="l6.25"> }</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27"> function ClearCSSInputWidgets() {</span>
<a href="#l6.28"></a><span id="l6.28">   gDialog.AddCSSAttributeTree.view.selection.clearSelection();</span>
<a href="#l6.29"></a><span id="l6.29">   gDialog.AddCSSAttributeNameInput.value = &quot;&quot;;</span>
<a href="#l6.30"></a><span id="l6.30">   gDialog.AddCSSAttributeValueInput.value = &quot;&quot;;</span>
<a href="#l6.31"></a><span id="l6.31">   SetTextboxFocus(gDialog.AddCSSAttributeNameInput);</span>
<a href="#l6.32"></a><span id="l6.32"> }</span>
<a href="#l6.33"></a><span id="l6.33"> </span>
<a href="#l6.34"></a><span id="l6.34"> function onSelectCSSTreeItem() {</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-  if (!gDoOnSelectTree)</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+  if (!gDoOnSelectTree) {</span>
<a href="#l6.37"></a><span id="l6.37">     return;</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+  }</span>
<a href="#l6.39"></a><span id="l6.39"> </span>
<a href="#l6.40"></a><span id="l6.40">   var tree = gDialog.AddCSSAttributeTree;</span>
<a href="#l6.41"></a><span id="l6.41">   if (tree &amp;&amp; tree.view.selection.count) {</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-    gDialog.AddCSSAttributeNameInput.value = GetTreeItemAttributeStr(getSelectedItem(tree));</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-    gDialog.AddCSSAttributeValueInput.value = GetTreeItemValueStr(getSelectedItem(tree));</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+    gDialog.AddCSSAttributeNameInput.value = GetTreeItemAttributeStr(</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+      getSelectedItem(tree)</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+    );</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+    gDialog.AddCSSAttributeValueInput.value = GetTreeItemValueStr(</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+      getSelectedItem(tree)</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+    );</span>
<a href="#l6.50"></a><span id="l6.50">   }</span>
<a href="#l6.51"></a><span id="l6.51"> }</span>
<a href="#l6.52"></a><span id="l6.52"> </span>
<a href="#l6.53"></a><span id="l6.53"> function onInputCSSAttributeName() {</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-  var attName = TrimString(gDialog.AddCSSAttributeNameInput.value).toLowerCase();</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+  var attName = TrimString(</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+    gDialog.AddCSSAttributeNameInput.value</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+  ).toLowerCase();</span>
<a href="#l6.58"></a><span id="l6.58">   var newValue = &quot;&quot;;</span>
<a href="#l6.59"></a><span id="l6.59"> </span>
<a href="#l6.60"></a><span id="l6.60">   var existingValue = GetAndSelectExistingAttributeValue(attName, &quot;CSSAList&quot;);</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-  if (existingValue)</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+  if (existingValue) {</span>
<a href="#l6.63"></a><span id="l6.63">     newValue = existingValue;</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+  }</span>
<a href="#l6.65"></a><span id="l6.65"> </span>
<a href="#l6.66"></a><span id="l6.66">   gDialog.AddCSSAttributeValueInput.value = newValue;</span>
<a href="#l6.67"></a><span id="l6.67"> }</span>
<a href="#l6.68"></a><span id="l6.68"> </span>
<a href="#l6.69"></a><span id="l6.69"> function editCSSAttributeValue(targetCell) {</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-  if (IsNotTreeHeader(targetCell))</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+  if (IsNotTreeHeader(targetCell)) {</span>
<a href="#l6.72"></a><span id="l6.72">     gDialog.AddCSSAttributeValueInput.inputField.select();</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+  }</span>
<a href="#l6.74"></a><span id="l6.74"> }</span>
<a href="#l6.75"></a><span id="l6.75"> </span>
<a href="#l6.76"></a><span id="l6.76"> function UpdateCSSAttributes() {</span>
<a href="#l6.77"></a><span id="l6.77">   var CSSAList = document.getElementById(&quot;CSSAList&quot;);</span>
<a href="#l6.78"></a><span id="l6.78">   var styleString = &quot;&quot;;</span>
<a href="#l6.79"></a><span id="l6.79">   for (var i = 0; i &lt; CSSAList.childNodes.length; i++) {</span>
<a href="#l6.80"></a><span id="l6.80">     var item = CSSAList.childNodes[i];</span>
<a href="#l6.81"></a><span id="l6.81">     var name = GetTreeItemAttributeStr(item);</span>
<a href="#l6.82"></a><span id="l6.82">     var value = GetTreeItemValueStr(item);</span>
<a href="#l6.83"></a><span id="l6.83">     // this code allows users to be sloppy in typing in values, and enter</span>
<a href="#l6.84"></a><span id="l6.84">     // things like &quot;foo: &quot; and &quot;bar;&quot;. This will trim off everything after the</span>
<a href="#l6.85"></a><span id="l6.85">     // respective character.</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-    if (name.includes(&quot;:&quot;))</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+    if (name.includes(&quot;:&quot;)) {</span>
<a href="#l6.88"></a><span id="l6.88">       name = name.substring(0, name.lastIndexOf(&quot;:&quot;));</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-    if (value.includes(&quot;;&quot;))</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+    }</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+    if (value.includes(&quot;;&quot;)) {</span>
<a href="#l6.92"></a><span id="l6.92">       value = value.substring(0, value.lastIndexOf(&quot;;&quot;));</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-    if (i == (CSSAList.childNodes.length - 1))</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-      styleString += name + &quot;: &quot; + value + &quot;;&quot;;   // last property</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineminus">-    else</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+    }</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+    if (i == CSSAList.childNodes.length - 1) {</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+      styleString += name + &quot;: &quot; + value + &quot;;&quot;;</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+    } // last property</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+    else {</span>
<a href="#l6.101"></a><span id="l6.101">       styleString += name + &quot;: &quot; + value + &quot;; &quot;;</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+    }</span>
<a href="#l6.103"></a><span id="l6.103">   }</span>
<a href="#l6.104"></a><span id="l6.104">   if (styleString) {</span>
<a href="#l6.105"></a><span id="l6.105">     // Use editor transactions if modifying the element directly in the document</span>
<a href="#l6.106"></a><span id="l6.106">     doRemoveAttribute(&quot;style&quot;);</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineminus">-    doSetAttribute(&quot;style&quot;, styleString);  // NOTE BUG 18894!!!</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+    doSetAttribute(&quot;style&quot;, styleString); // NOTE BUG 18894!!!</span>
<a href="#l6.109"></a><span id="l6.109">   } else if (gElement.getAttribute(&quot;style&quot;)) {</span>
<a href="#l6.110"></a><span id="l6.110">     doRemoveAttribute(&quot;style&quot;);</span>
<a href="#l6.111"></a><span id="l6.111">   }</span>
<a href="#l6.112"></a><span id="l6.112"> }</span>
<a href="#l6.113"></a><span id="l6.113"> </span>
<a href="#l6.114"></a><span id="l6.114"> function RemoveCSSAttribute() {</span>
<a href="#l6.115"></a><span id="l6.115">   // We only allow 1 selected item</span>
<a href="#l6.116"></a><span id="l6.116">   if (gDialog.AddCSSAttributeTree.view.selection.count) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdAEHTMLAttributes.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdAEHTMLAttributes.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -33,99 +33,116 @@ function BuildHTMLAttributeNameList() {</span>
<a href="#l7.4"></a><span id="l7.4">             gDialog.AddHTMLAttributeNameInput.appendItem(name, name);</span>
<a href="#l7.5"></a><span id="l7.5">           }</span>
<a href="#l7.6"></a><span id="l7.6">         }</span>
<a href="#l7.7"></a><span id="l7.7">       } else if (name == &quot;-&quot;) {</span>
<a href="#l7.8"></a><span id="l7.8">         // Signal for separator</span>
<a href="#l7.9"></a><span id="l7.9">         var popup = gDialog.AddHTMLAttributeNameInput.menupopup;</span>
<a href="#l7.10"></a><span id="l7.10">         if (popup) {</span>
<a href="#l7.11"></a><span id="l7.11">           var sep = document.createXULElement(&quot;menuseparator&quot;);</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-          if (sep)</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+          if (sep) {</span>
<a href="#l7.14"></a><span id="l7.14">             popup.appendChild(sep);</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+          }</span>
<a href="#l7.16"></a><span id="l7.16">         }</span>
<a href="#l7.17"></a><span id="l7.17">       } else {</span>
<a href="#l7.18"></a><span id="l7.18">         // Get information about value filtering</span>
<a href="#l7.19"></a><span id="l7.19">         let forceOneChar = name.includes(&quot;!&quot;);</span>
<a href="#l7.20"></a><span id="l7.20">         let forceInteger = name.includes(&quot;#&quot;);</span>
<a href="#l7.21"></a><span id="l7.21">         let forceSignedInteger = name.includes(&quot;+&quot;);</span>
<a href="#l7.22"></a><span id="l7.22">         let forceIntOrPercent = name.includes(&quot;%&quot;);</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-        let limitFirstChar = name.includes(&quot;\^&quot;);</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+        let limitFirstChar = name.includes(&quot;^&quot;);</span>
<a href="#l7.25"></a><span id="l7.25">         // let required = name.includes(&quot;$&quot;);</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27">         // Strip flag characters</span>
<a href="#l7.28"></a><span id="l7.28">         name = name.replace(/[!^#%$+]/g, &quot;&quot;);</span>
<a href="#l7.29"></a><span id="l7.29"> </span>
<a href="#l7.30"></a><span id="l7.30">         menuitem = gDialog.AddHTMLAttributeNameInput.appendItem(name, name);</span>
<a href="#l7.31"></a><span id="l7.31">         if (menuitem) {</span>
<a href="#l7.32"></a><span id="l7.32">           // Signify &quot;required&quot; attributes by special style</span>
<a href="#l7.33"></a><span id="l7.33">           // TODO: Don't do this until next version, when we add</span>
<a href="#l7.34"></a><span id="l7.34">           //      explanatory text and an 'Autofill Required Attributes' button</span>
<a href="#l7.35"></a><span id="l7.35">           // if (required)</span>
<a href="#l7.36"></a><span id="l7.36">           //  menuitem.setAttribute(&quot;class&quot;, &quot;menuitem-highlight-1&quot;);</span>
<a href="#l7.37"></a><span id="l7.37"> </span>
<a href="#l7.38"></a><span id="l7.38">           // Set flags to filter value input</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-          if (forceOneChar)</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+          if (forceOneChar) {</span>
<a href="#l7.41"></a><span id="l7.41">             menuitem.setAttribute(&quot;forceOneChar&quot;, &quot;true&quot;);</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-          if (limitFirstChar)</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+          }</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+          if (limitFirstChar) {</span>
<a href="#l7.45"></a><span id="l7.45">             menuitem.setAttribute(&quot;limitFirstChar&quot;, &quot;true&quot;);</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-          if (forceInteger)</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+          }</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+          if (forceInteger) {</span>
<a href="#l7.49"></a><span id="l7.49">             menuitem.setAttribute(&quot;forceInteger&quot;, &quot;true&quot;);</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-          if (forceSignedInteger)</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+          }</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+          if (forceSignedInteger) {</span>
<a href="#l7.53"></a><span id="l7.53">             menuitem.setAttribute(&quot;forceSignedInteger&quot;, &quot;true&quot;);</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-          if (forceIntOrPercent)</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+          }</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+          if (forceIntOrPercent) {</span>
<a href="#l7.57"></a><span id="l7.57">             menuitem.setAttribute(&quot;forceIntOrPercent&quot;, &quot;true&quot;);</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+          }</span>
<a href="#l7.59"></a><span id="l7.59">         }</span>
<a href="#l7.60"></a><span id="l7.60">       }</span>
<a href="#l7.61"></a><span id="l7.61">     }</span>
<a href="#l7.62"></a><span id="l7.62">   }</span>
<a href="#l7.63"></a><span id="l7.63"> }</span>
<a href="#l7.64"></a><span id="l7.64"> </span>
<a href="#l7.65"></a><span id="l7.65"> // build attribute list in tree form from element attributes</span>
<a href="#l7.66"></a><span id="l7.66"> function BuildHTMLAttributeTable() {</span>
<a href="#l7.67"></a><span id="l7.67">   var nodeMap = gElement.attributes;</span>
<a href="#l7.68"></a><span id="l7.68">   var i;</span>
<a href="#l7.69"></a><span id="l7.69">   if (nodeMap.length &gt; 0) {</span>
<a href="#l7.70"></a><span id="l7.70">     var added = false;</span>
<a href="#l7.71"></a><span id="l7.71">     for (i = 0; i &lt; nodeMap.length; i++) {</span>
<a href="#l7.72"></a><span id="l7.72">       let name = nodeMap[i].name.trim().toLowerCase();</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-      if (CheckAttributeNameSimilarity(nodeMap[i].nodeName, HTMLAttrs) ||</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-           name.startsWith(&quot;on&quot;) || name == &quot;style&quot;) {</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-        continue;   // repeated or non-HTML attribute, ignore this one and go to next</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+      if (</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+        CheckAttributeNameSimilarity(nodeMap[i].nodeName, HTMLAttrs) ||</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+        name.startsWith(&quot;on&quot;) ||</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+        name == &quot;style&quot;</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+      ) {</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+        continue; // repeated or non-HTML attribute, ignore this one and go to next</span>
<a href="#l7.82"></a><span id="l7.82">       }</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-      if (!name.startsWith(&quot;_moz&quot;) &amp;&amp;</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-          AddTreeItem(name, nodeMap[i].value, &quot;HTMLAList&quot;, HTMLAttrs)) {</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+      if (</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+        !name.startsWith(&quot;_moz&quot;) &amp;&amp;</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+        AddTreeItem(name, nodeMap[i].value, &quot;HTMLAList&quot;, HTMLAttrs)</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+      ) {</span>
<a href="#l7.89"></a><span id="l7.89">         added = true;</span>
<a href="#l7.90"></a><span id="l7.90">       }</span>
<a href="#l7.91"></a><span id="l7.91">     }</span>
<a href="#l7.92"></a><span id="l7.92"> </span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-    if (added)</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+    if (added) {</span>
<a href="#l7.95"></a><span id="l7.95">       SelectHTMLTree(0);</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+    }</span>
<a href="#l7.97"></a><span id="l7.97">   }</span>
<a href="#l7.98"></a><span id="l7.98"> }</span>
<a href="#l7.99"></a><span id="l7.99"> </span>
<a href="#l7.100"></a><span id="l7.100"> function ClearHTMLInputWidgets() {</span>
<a href="#l7.101"></a><span id="l7.101">   gDialog.AddHTMLAttributeTree.view.selection.clearSelection();</span>
<a href="#l7.102"></a><span id="l7.102">   gDialog.AddHTMLAttributeNameInput.value = &quot;&quot;;</span>
<a href="#l7.103"></a><span id="l7.103">   gDialog.AddHTMLAttributeValueInput.value = &quot;&quot;;</span>
<a href="#l7.104"></a><span id="l7.104">   SetTextboxFocus(gDialog.AddHTMLAttributeNameInput);</span>
<a href="#l7.105"></a><span id="l7.105"> }</span>
<a href="#l7.106"></a><span id="l7.106"> </span>
<a href="#l7.107"></a><span id="l7.107"> function onSelectHTMLTreeItem() {</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-  if (!gDoOnSelectTree)</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+  if (!gDoOnSelectTree) {</span>
<a href="#l7.110"></a><span id="l7.110">     return;</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+  }</span>
<a href="#l7.112"></a><span id="l7.112"> </span>
<a href="#l7.113"></a><span id="l7.113">   var tree = gDialog.AddHTMLAttributeTree;</span>
<a href="#l7.114"></a><span id="l7.114">   if (tree &amp;&amp; tree.view.selection.count) {</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineminus">-    var inputName = TrimString(gDialog.AddHTMLAttributeNameInput.value).toLowerCase();</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+    var inputName = TrimString(</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+      gDialog.AddHTMLAttributeNameInput.value</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+    ).toLowerCase();</span>
<a href="#l7.119"></a><span id="l7.119">     var selectedItem = getSelectedItem(tree);</span>
<a href="#l7.120"></a><span id="l7.120">     var selectedName = selectedItem.firstChild.firstChild.getAttribute(&quot;label&quot;);</span>
<a href="#l7.121"></a><span id="l7.121"> </span>
<a href="#l7.122"></a><span id="l7.122">     if (inputName == selectedName) {</span>
<a href="#l7.123"></a><span id="l7.123">       // Already editing selected name - just update the value input</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineminus">-      gDialog.AddHTMLAttributeValueInput.value = GetTreeItemValueStr(selectedItem);</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+      gDialog.AddHTMLAttributeValueInput.value = GetTreeItemValueStr(</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+        selectedItem</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+      );</span>
<a href="#l7.128"></a><span id="l7.128">     } else {</span>
<a href="#l7.129"></a><span id="l7.129">       gDialog.AddHTMLAttributeNameInput.value = selectedName;</span>
<a href="#l7.130"></a><span id="l7.130"> </span>
<a href="#l7.131"></a><span id="l7.131">       // Change value input based on new selected name</span>
<a href="#l7.132"></a><span id="l7.132">       onInputHTMLAttributeName();</span>
<a href="#l7.133"></a><span id="l7.133">     }</span>
<a href="#l7.134"></a><span id="l7.134">   }</span>
<a href="#l7.135"></a><span id="l7.135"> }</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineat">@@ -140,158 +157,185 @@ function onInputHTMLAttributeName() {</span>
<a href="#l7.137"></a><span id="l7.137"> </span>
<a href="#l7.138"></a><span id="l7.138">   if (attName) {</span>
<a href="#l7.139"></a><span id="l7.139">     // Get value list for current attribute name</span>
<a href="#l7.140"></a><span id="l7.140">     var valueListName;</span>
<a href="#l7.141"></a><span id="l7.141"> </span>
<a href="#l7.142"></a><span id="l7.142">     // Most elements have the &quot;dir&quot; attribute,</span>
<a href="#l7.143"></a><span id="l7.143">     //   so we have just one array for the allowed values instead</span>
<a href="#l7.144"></a><span id="l7.144">     //   requiring duplicate entries for each element in EdAEAttributes.js</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineminus">-    if (attName == &quot;dir&quot;)</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+    if (attName == &quot;dir&quot;) {</span>
<a href="#l7.147"></a><span id="l7.147">       valueListName = &quot;all_dir&quot;;</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineminus">-    else</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineplus">+    } else {</span>
<a href="#l7.150"></a><span id="l7.150">       valueListName = gElement.localName + &quot;_&quot; + attName;</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+    }</span>
<a href="#l7.152"></a><span id="l7.152"> </span>
<a href="#l7.153"></a><span id="l7.153">     // Strip off leading &quot;_&quot; we sometimes use (when element name is reserved word)</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineminus">-    if (valueListName.startsWith(&quot;_&quot;))</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineplus">+    if (valueListName.startsWith(&quot;_&quot;)) {</span>
<a href="#l7.156"></a><span id="l7.156">       valueListName = valueListName.slice(1);</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+    }</span>
<a href="#l7.158"></a><span id="l7.158"> </span>
<a href="#l7.159"></a><span id="l7.159">     var newValue = &quot;&quot;;</span>
<a href="#l7.160"></a><span id="l7.160">     var listLen = 0;</span>
<a href="#l7.161"></a><span id="l7.161"> </span>
<a href="#l7.162"></a><span id="l7.162">     // Index to which widget we were using to edit the value</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineminus">-    var deckIndex = gDialog.AddHTMLAttributeValueDeck.getAttribute(&quot;selectedIndex&quot;);</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+    var deckIndex = gDialog.AddHTMLAttributeValueDeck.getAttribute(</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+      &quot;selectedIndex&quot;</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+    );</span>
<a href="#l7.167"></a><span id="l7.167"> </span>
<a href="#l7.168"></a><span id="l7.168">     if (valueListName in gHTMLAttr) {</span>
<a href="#l7.169"></a><span id="l7.169">       var valueList = gHTMLAttr[valueListName];</span>
<a href="#l7.170"></a><span id="l7.170"> </span>
<a href="#l7.171"></a><span id="l7.171">       listLen = valueList.length;</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineminus">-      if (listLen == 1)</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+      if (listLen == 1) {</span>
<a href="#l7.174"></a><span id="l7.174">         newValue = valueList[0];</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+      }</span>
<a href="#l7.176"></a><span id="l7.176"> </span>
<a href="#l7.177"></a><span id="l7.177">       // Note: For case where &quot;value list&quot; is actually just</span>
<a href="#l7.178"></a><span id="l7.178">       // one (default) item, don't use menulist for that</span>
<a href="#l7.179"></a><span id="l7.179">       if (listLen &gt; 1) {</span>
<a href="#l7.180"></a><span id="l7.180">         gDialog.AddHTMLAttributeValueMenulist.removeAllItems();</span>
<a href="#l7.181"></a><span id="l7.181"> </span>
<a href="#l7.182"></a><span id="l7.182">         if (deckIndex != &quot;1&quot;) {</span>
<a href="#l7.183"></a><span id="l7.183">           // Switch to using editable menulist</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineminus">-          gDialog.AddHTMLAttributeValueInput = gDialog.AddHTMLAttributeValueMenulist;</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineplus">+          gDialog.AddHTMLAttributeValueInput =</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineplus">+            gDialog.AddHTMLAttributeValueMenulist;</span>
<a href="#l7.187"></a><span id="l7.187">           gDialog.AddHTMLAttributeValueDeck.setAttribute(&quot;selectedIndex&quot;, &quot;1&quot;);</span>
<a href="#l7.188"></a><span id="l7.188">         }</span>
<a href="#l7.189"></a><span id="l7.189">         // Rebuild the list</span>
<a href="#l7.190"></a><span id="l7.190">         for (var i = 0; i &lt; listLen; i++) {</span>
<a href="#l7.191"></a><span id="l7.191">           if (valueList[i] == &quot;-&quot;) {</span>
<a href="#l7.192"></a><span id="l7.192">             // Signal for separator</span>
<a href="#l7.193"></a><span id="l7.193">             var popup = gDialog.AddHTMLAttributeValueInput.menupopup;</span>
<a href="#l7.194"></a><span id="l7.194">             if (popup) {</span>
<a href="#l7.195"></a><span id="l7.195">               var sep = document.createXULElement(&quot;menuseparator&quot;);</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-              if (sep)</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+              if (sep) {</span>
<a href="#l7.198"></a><span id="l7.198">                 popup.appendChild(sep);</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+              }</span>
<a href="#l7.200"></a><span id="l7.200">             }</span>
<a href="#l7.201"></a><span id="l7.201">           } else {</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineminus">-            gDialog.AddHTMLAttributeValueMenulist.appendItem(valueList[i], valueList[i]);</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+            gDialog.AddHTMLAttributeValueMenulist.appendItem(</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+              valueList[i],</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineplus">+              valueList[i]</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineplus">+            );</span>
<a href="#l7.207"></a><span id="l7.207">           }</span>
<a href="#l7.208"></a><span id="l7.208">         }</span>
<a href="#l7.209"></a><span id="l7.209">       }</span>
<a href="#l7.210"></a><span id="l7.210">     }</span>
<a href="#l7.211"></a><span id="l7.211"> </span>
<a href="#l7.212"></a><span id="l7.212">     if (listLen &lt;= 1 &amp;&amp; deckIndex != &quot;0&quot;) {</span>
<a href="#l7.213"></a><span id="l7.213">       // No list: Use textbox for input instead</span>
<a href="#l7.214"></a><span id="l7.214">       gDialog.AddHTMLAttributeValueInput = gDialog.AddHTMLAttributeValueTextbox;</span>
<a href="#l7.215"></a><span id="l7.215">       gDialog.AddHTMLAttributeValueDeck.setAttribute(&quot;selectedIndex&quot;, &quot;0&quot;);</span>
<a href="#l7.216"></a><span id="l7.216">     }</span>
<a href="#l7.217"></a><span id="l7.217"> </span>
<a href="#l7.218"></a><span id="l7.218">     // If attribute already exists in tree, use associated value,</span>
<a href="#l7.219"></a><span id="l7.219">     //  else use default found above</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineminus">-    var existingValue = GetAndSelectExistingAttributeValue(attName, &quot;HTMLAList&quot;);</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineminus">-    if (existingValue)</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineplus">+    var existingValue = GetAndSelectExistingAttributeValue(</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineplus">+      attName,</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineplus">+      &quot;HTMLAList&quot;</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineplus">+    );</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineplus">+    if (existingValue) {</span>
<a href="#l7.227"></a><span id="l7.227">       newValue = existingValue;</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineplus">+    }</span>
<a href="#l7.229"></a><span id="l7.229"> </span>
<a href="#l7.230"></a><span id="l7.230">     gDialog.AddHTMLAttributeValueInput.value = newValue;</span>
<a href="#l7.231"></a><span id="l7.231"> </span>
<a href="#l7.232"></a><span id="l7.232" class="difflineminus">-    if (!existingValue)</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineplus">+    if (!existingValue) {</span>
<a href="#l7.234"></a><span id="l7.234">       onInputHTMLAttributeValue();</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineplus">+    }</span>
<a href="#l7.236"></a><span id="l7.236">   }</span>
<a href="#l7.237"></a><span id="l7.237"> }</span>
<a href="#l7.238"></a><span id="l7.238"> </span>
<a href="#l7.239"></a><span id="l7.239"> function onInputHTMLAttributeValue() {</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineminus">-  if (!gUpdateTreeValue)</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineplus">+  if (!gUpdateTreeValue) {</span>
<a href="#l7.242"></a><span id="l7.242">     return;</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineplus">+  }</span>
<a href="#l7.244"></a><span id="l7.244"> </span>
<a href="#l7.245"></a><span id="l7.245">   var name = TrimString(gDialog.AddHTMLAttributeNameInput.value);</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineminus">-  if (!name)</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineplus">+  if (!name) {</span>
<a href="#l7.248"></a><span id="l7.248">     return;</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineplus">+  }</span>
<a href="#l7.250"></a><span id="l7.250"> </span>
<a href="#l7.251"></a><span id="l7.251">   // Trim spaces only from left since we must allow spaces within the string</span>
<a href="#l7.252"></a><span id="l7.252">   //  (we always reset the input field's value below)</span>
<a href="#l7.253"></a><span id="l7.253">   var value = TrimStringLeft(gDialog.AddHTMLAttributeValueInput.value);</span>
<a href="#l7.254"></a><span id="l7.254">   if (value) {</span>
<a href="#l7.255"></a><span id="l7.255">     // Do value filtering based on type of attribute</span>
<a href="#l7.256"></a><span id="l7.256">     // (Do not use &quot;forceInteger()&quot; to avoid multiple</span>
<a href="#l7.257"></a><span id="l7.257">     //  resetting of input's value and flickering)</span>
<a href="#l7.258"></a><span id="l7.258">     var selectedItem = gDialog.AddHTMLAttributeNameInput.selectedItem;</span>
<a href="#l7.259"></a><span id="l7.259"> </span>
<a href="#l7.260"></a><span id="l7.260">     if (selectedItem) {</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineminus">-      if (selectedItem.getAttribute(&quot;forceOneChar&quot;) == &quot;true&quot; &amp;&amp;</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineminus">-           value.length &gt; 1)</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineplus">+      if (</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineplus">+        selectedItem.getAttribute(&quot;forceOneChar&quot;) == &quot;true&quot; &amp;&amp;</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineplus">+        value.length &gt; 1</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineplus">+      ) {</span>
<a href="#l7.267"></a><span id="l7.267">         value = value.slice(0, 1);</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineplus">+      }</span>
<a href="#l7.269"></a><span id="l7.269"> </span>
<a href="#l7.270"></a><span id="l7.270">       if (selectedItem.getAttribute(&quot;forceIntOrPercent&quot;) == &quot;true&quot;) {</span>
<a href="#l7.271"></a><span id="l7.271">         // Allow integer with optional &quot;%&quot; as last character</span>
<a href="#l7.272"></a><span id="l7.272">         var percent = TrimStringRight(value).slice(-1);</span>
<a href="#l7.273"></a><span id="l7.273">         value = value.replace(/\D+/g, &quot;&quot;);</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineminus">-        if (percent == &quot;%&quot;)</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineplus">+        if (percent == &quot;%&quot;) {</span>
<a href="#l7.276"></a><span id="l7.276">           value += percent;</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineplus">+        }</span>
<a href="#l7.278"></a><span id="l7.278">       } else if (selectedItem.getAttribute(&quot;forceInteger&quot;) == &quot;true&quot;) {</span>
<a href="#l7.279"></a><span id="l7.279">         value = value.replace(/\D+/g, &quot;&quot;);</span>
<a href="#l7.280"></a><span id="l7.280">       } else if (selectedItem.getAttribute(&quot;forceSignedInteger&quot;) == &quot;true&quot;) {</span>
<a href="#l7.281"></a><span id="l7.281">         // Allow integer with optional &quot;+&quot; or &quot;-&quot; as first character</span>
<a href="#l7.282"></a><span id="l7.282">         var sign = value[0];</span>
<a href="#l7.283"></a><span id="l7.283">         value = value.replace(/\D+/g, &quot;&quot;);</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineminus">-        if (sign == &quot;+&quot; || sign == &quot;-&quot;)</span>
<a href="#l7.285"></a><span id="l7.285" class="difflineplus">+        if (sign == &quot;+&quot; || sign == &quot;-&quot;) {</span>
<a href="#l7.286"></a><span id="l7.286">           value = sign + value;</span>
<a href="#l7.287"></a><span id="l7.287" class="difflineplus">+        }</span>
<a href="#l7.288"></a><span id="l7.288">       }</span>
<a href="#l7.289"></a><span id="l7.289"> </span>
<a href="#l7.290"></a><span id="l7.290">       // Special case attributes</span>
<a href="#l7.291"></a><span id="l7.291">       if (selectedItem.getAttribute(&quot;limitFirstChar&quot;) == &quot;true&quot;) {</span>
<a href="#l7.292"></a><span id="l7.292">         // Limit first character to letter, and all others to</span>
<a href="#l7.293"></a><span id="l7.293">         //  letters, numbers, and a few others</span>
<a href="#l7.294"></a><span id="l7.294" class="difflineminus">-        value = value.replace(/^[^a-zA-Z\u0080-\uFFFF]/, &quot;&quot;).replace(/[^a-zA-Z0-9_\.\-\:\u0080-\uFFFF]+/g, &quot;&quot;);</span>
<a href="#l7.295"></a><span id="l7.295" class="difflineplus">+        value = value</span>
<a href="#l7.296"></a><span id="l7.296" class="difflineplus">+          .replace(/^[^a-zA-Z\u0080-\uFFFF]/, &quot;&quot;)</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineplus">+          .replace(/[^a-zA-Z0-9_\.\-\:\u0080-\uFFFF]+/g, &quot;&quot;);</span>
<a href="#l7.298"></a><span id="l7.298">       }</span>
<a href="#l7.299"></a><span id="l7.299"> </span>
<a href="#l7.300"></a><span id="l7.300">       // Update once only if it changed</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineminus">-      if (value != gDialog.AddHTMLAttributeValueInput.value)</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineplus">+      if (value != gDialog.AddHTMLAttributeValueInput.value) {</span>
<a href="#l7.303"></a><span id="l7.303">         gDialog.AddHTMLAttributeValueInput.value = value;</span>
<a href="#l7.304"></a><span id="l7.304" class="difflineplus">+      }</span>
<a href="#l7.305"></a><span id="l7.305">     }</span>
<a href="#l7.306"></a><span id="l7.306">   }</span>
<a href="#l7.307"></a><span id="l7.307"> </span>
<a href="#l7.308"></a><span id="l7.308">   // Update value in the tree list</span>
<a href="#l7.309"></a><span id="l7.309">   // If not found, add new attribute</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineminus">-  if (!UpdateExistingAttribute(name, value, &quot;HTMLAList&quot;) &amp;&amp; value)</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineplus">+  if (!UpdateExistingAttribute(name, value, &quot;HTMLAList&quot;) &amp;&amp; value) {</span>
<a href="#l7.312"></a><span id="l7.312">     AddTreeItem(name, value, &quot;HTMLAList&quot;, HTMLAttrs);</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineplus">+  }</span>
<a href="#l7.314"></a><span id="l7.314"> }</span>
<a href="#l7.315"></a><span id="l7.315"> </span>
<a href="#l7.316"></a><span id="l7.316"> function editHTMLAttributeValue(targetCell) {</span>
<a href="#l7.317"></a><span id="l7.317" class="difflineminus">-  if (IsNotTreeHeader(targetCell))</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineplus">+  if (IsNotTreeHeader(targetCell)) {</span>
<a href="#l7.319"></a><span id="l7.319">     gDialog.AddHTMLAttributeValueInput.select();</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineplus">+  }</span>
<a href="#l7.321"></a><span id="l7.321"> }</span>
<a href="#l7.322"></a><span id="l7.322"> </span>
<a href="#l7.323"></a><span id="l7.323" class="difflineminus">-</span>
<a href="#l7.324"></a><span id="l7.324"> // update the object with added and removed attributes</span>
<a href="#l7.325"></a><span id="l7.325"> function UpdateHTMLAttributes() {</span>
<a href="#l7.326"></a><span id="l7.326">   var HTMLAList = document.getElementById(&quot;HTMLAList&quot;);</span>
<a href="#l7.327"></a><span id="l7.327">   var i;</span>
<a href="#l7.328"></a><span id="l7.328"> </span>
<a href="#l7.329"></a><span id="l7.329">   // remove removed attributes</span>
<a href="#l7.330"></a><span id="l7.330">   for (i = 0; i &lt; HTMLRAttrs.length; i++) {</span>
<a href="#l7.331"></a><span id="l7.331">     var name = HTMLRAttrs[i];</span>
<a href="#l7.332"></a><span id="l7.332"> </span>
<a href="#l7.333"></a><span id="l7.333" class="difflineminus">-    if (gElement.hasAttribute(name))</span>
<a href="#l7.334"></a><span id="l7.334" class="difflineplus">+    if (gElement.hasAttribute(name)) {</span>
<a href="#l7.335"></a><span id="l7.335">       doRemoveAttribute(name);</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineplus">+    }</span>
<a href="#l7.337"></a><span id="l7.337">   }</span>
<a href="#l7.338"></a><span id="l7.338"> </span>
<a href="#l7.339"></a><span id="l7.339">   // Set added or changed attributes</span>
<a href="#l7.340"></a><span id="l7.340">   for (i = 0; i &lt; HTMLAList.childNodes.length; i++) {</span>
<a href="#l7.341"></a><span id="l7.341">     var item = HTMLAList.childNodes[i];</span>
<a href="#l7.342"></a><span id="l7.342">     doSetAttribute(GetTreeItemAttributeStr(item), GetTreeItemValueStr(item));</span>
<a href="#l7.343"></a><span id="l7.343">   }</span>
<a href="#l7.344"></a><span id="l7.344"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdAEJSEAttributes.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdAEJSEAttributes.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -17,126 +17,149 @@ function BuildJSEAttributeNameList() {</span>
<a href="#l8.4"></a><span id="l8.4">     var popup;</span>
<a href="#l8.5"></a><span id="l8.5">     var sep;</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7">     if (attNames &amp;&amp; attNames.length) {</span>
<a href="#l8.8"></a><span id="l8.8">       // Since we don't allow user-editable JS events yet (but we will soon)</span>
<a href="#l8.9"></a><span id="l8.9">       //  simply remove the JS tab to not allow adding JS events</span>
<a href="#l8.10"></a><span id="l8.10">       if (attNames[0] == &quot;noJSEvents&quot;) {</span>
<a href="#l8.11"></a><span id="l8.11">         var tab = document.getElementById(&quot;tabJSE&quot;);</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-        if (tab)</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+        if (tab) {</span>
<a href="#l8.14"></a><span id="l8.14">           tab.remove();</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+        }</span>
<a href="#l8.16"></a><span id="l8.16"> </span>
<a href="#l8.17"></a><span id="l8.17">         return;</span>
<a href="#l8.18"></a><span id="l8.18">       }</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-      for (i = 0; i &lt; attNames.length; i++)</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+      for (i = 0; i &lt; attNames.length; i++) {</span>
<a href="#l8.22"></a><span id="l8.22">         gDialog.AddJSEAttributeNameList.appendItem(attNames[i], attNames[i]);</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+      }</span>
<a href="#l8.24"></a><span id="l8.24"> </span>
<a href="#l8.25"></a><span id="l8.25">       popup = gDialog.AddJSEAttributeNameList.firstChild;</span>
<a href="#l8.26"></a><span id="l8.26">       if (popup) {</span>
<a href="#l8.27"></a><span id="l8.27">         sep = document.createXULElement(&quot;menuseparator&quot;);</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-        if (sep)</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+        if (sep) {</span>
<a href="#l8.30"></a><span id="l8.30">           popup.appendChild(sep);</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+        }</span>
<a href="#l8.32"></a><span id="l8.32">       }</span>
<a href="#l8.33"></a><span id="l8.33">     }</span>
<a href="#l8.34"></a><span id="l8.34">   }</span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36">   // Always add core JS events unless we aborted above</span>
<a href="#l8.37"></a><span id="l8.37">   for (i = 0; i &lt; gCoreJSEvents.length; i++) {</span>
<a href="#l8.38"></a><span id="l8.38">     if (gCoreJSEvents[i] == &quot;-&quot;) {</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-      if (!popup)</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+      if (!popup) {</span>
<a href="#l8.41"></a><span id="l8.41">         popup = gDialog.AddJSEAttributeNameList.firstChild;</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+      }</span>
<a href="#l8.43"></a><span id="l8.43"> </span>
<a href="#l8.44"></a><span id="l8.44">       sep = document.createXULElement(&quot;menuseparator&quot;);</span>
<a href="#l8.45"></a><span id="l8.45"> </span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-      if (popup &amp;&amp; sep)</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+      if (popup &amp;&amp; sep) {</span>
<a href="#l8.48"></a><span id="l8.48">         popup.appendChild(sep);</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+      }</span>
<a href="#l8.50"></a><span id="l8.50">     } else {</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-      gDialog.AddJSEAttributeNameList.appendItem(gCoreJSEvents[i], gCoreJSEvents[i]);</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+      gDialog.AddJSEAttributeNameList.appendItem(</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+        gCoreJSEvents[i],</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+        gCoreJSEvents[i]</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+      );</span>
<a href="#l8.56"></a><span id="l8.56">     }</span>
<a href="#l8.57"></a><span id="l8.57">   }</span>
<a href="#l8.58"></a><span id="l8.58"> </span>
<a href="#l8.59"></a><span id="l8.59">   gDialog.AddJSEAttributeNameList.selectedIndex = 0;</span>
<a href="#l8.60"></a><span id="l8.60"> </span>
<a href="#l8.61"></a><span id="l8.61">   // Use current name and value of first tree item if it exists</span>
<a href="#l8.62"></a><span id="l8.62">   onSelectJSETreeItem();</span>
<a href="#l8.63"></a><span id="l8.63"> }</span>
<a href="#l8.64"></a><span id="l8.64"> </span>
<a href="#l8.65"></a><span id="l8.65"> // build attribute list in tree form from element attributes</span>
<a href="#l8.66"></a><span id="l8.66"> function BuildJSEAttributeTable() {</span>
<a href="#l8.67"></a><span id="l8.67">   var nodeMap = gElement.attributes;</span>
<a href="#l8.68"></a><span id="l8.68">   if (nodeMap.length &gt; 0) {</span>
<a href="#l8.69"></a><span id="l8.69">     var added = false;</span>
<a href="#l8.70"></a><span id="l8.70">     for (var i = 0; i &lt; nodeMap.length; i++) {</span>
<a href="#l8.71"></a><span id="l8.71">       let name = nodeMap[i].nodeName.toLowerCase();</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-      if (CheckAttributeNameSimilarity(nodeMap[i].nodeName, JSEAttrs))</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-        continue;   // repeated or non-JS handler, ignore this one and go to next</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-      if (!name.startsWith(&quot;on&quot;))</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-        continue; // attribute isn't an event handler.</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+      if (CheckAttributeNameSimilarity(nodeMap[i].nodeName, JSEAttrs)) {</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+        continue;</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+      } // repeated or non-JS handler, ignore this one and go to next</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+      if (!name.startsWith(&quot;on&quot;)) {</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+        continue;</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+      } // attribute isn't an event handler.</span>
<a href="#l8.82"></a><span id="l8.82">       var value = gElement.getAttribute(nodeMap[i].nodeName);</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-      if (AddTreeItem(name, value, &quot;JSEAList&quot;, JSEAttrs)) // add item to tree</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+      if (AddTreeItem(name, value, &quot;JSEAList&quot;, JSEAttrs)) {</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+        // add item to tree</span>
<a href="#l8.86"></a><span id="l8.86">         added = true;</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+      }</span>
<a href="#l8.88"></a><span id="l8.88">     }</span>
<a href="#l8.89"></a><span id="l8.89"> </span>
<a href="#l8.90"></a><span id="l8.90">     // Select first item</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineminus">-    if (added)</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+    if (added) {</span>
<a href="#l8.93"></a><span id="l8.93">       gDialog.AddJSEAttributeTree.selectedIndex = 0;</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+    }</span>
<a href="#l8.95"></a><span id="l8.95">   }</span>
<a href="#l8.96"></a><span id="l8.96"> }</span>
<a href="#l8.97"></a><span id="l8.97"> </span>
<a href="#l8.98"></a><span id="l8.98"> function onSelectJSEAttribute() {</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineminus">-  if (!gDoOnSelectTree)</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+  if (!gDoOnSelectTree) {</span>
<a href="#l8.101"></a><span id="l8.101">     return;</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+  }</span>
<a href="#l8.103"></a><span id="l8.103"> </span>
<a href="#l8.104"></a><span id="l8.104" class="difflineminus">-  gDialog.AddJSEAttributeValueInput.value =</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineminus">-      GetAndSelectExistingAttributeValue(gDialog.AddJSEAttributeNameList.label, &quot;JSEAList&quot;);</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+  gDialog.AddJSEAttributeValueInput.value = GetAndSelectExistingAttributeValue(</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+    gDialog.AddJSEAttributeNameList.label,</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+    &quot;JSEAList&quot;</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+  );</span>
<a href="#l8.110"></a><span id="l8.110"> }</span>
<a href="#l8.111"></a><span id="l8.111"> </span>
<a href="#l8.112"></a><span id="l8.112"> function onSelectJSETreeItem() {</span>
<a href="#l8.113"></a><span id="l8.113">   var tree = gDialog.AddJSEAttributeTree;</span>
<a href="#l8.114"></a><span id="l8.114">   if (tree &amp;&amp; tree.view.selection.count) {</span>
<a href="#l8.115"></a><span id="l8.115">     // Select attribute name in list</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineminus">-    gDialog.AddJSEAttributeNameList.value = GetTreeItemAttributeStr(getSelectedItem(tree));</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+    gDialog.AddJSEAttributeNameList.value = GetTreeItemAttributeStr(</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+      getSelectedItem(tree)</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+    );</span>
<a href="#l8.120"></a><span id="l8.120"> </span>
<a href="#l8.121"></a><span id="l8.121">     // Set value input to that in tree (no need to update this in the tree)</span>
<a href="#l8.122"></a><span id="l8.122">     gUpdateTreeValue = false;</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineminus">-    gDialog.AddJSEAttributeValueInput.value =  GetTreeItemValueStr(getSelectedItem(tree));</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+    gDialog.AddJSEAttributeValueInput.value = GetTreeItemValueStr(</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+      getSelectedItem(tree)</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+    );</span>
<a href="#l8.127"></a><span id="l8.127">     gUpdateTreeValue = true;</span>
<a href="#l8.128"></a><span id="l8.128">   }</span>
<a href="#l8.129"></a><span id="l8.129"> }</span>
<a href="#l8.130"></a><span id="l8.130"> </span>
<a href="#l8.131"></a><span id="l8.131"> function onInputJSEAttributeValue() {</span>
<a href="#l8.132"></a><span id="l8.132">   if (gUpdateTreeValue) {</span>
<a href="#l8.133"></a><span id="l8.133">     var name = TrimString(gDialog.AddJSEAttributeNameList.label);</span>
<a href="#l8.134"></a><span id="l8.134">     var value = TrimString(gDialog.AddJSEAttributeValueInput.value);</span>
<a href="#l8.135"></a><span id="l8.135"> </span>
<a href="#l8.136"></a><span id="l8.136">     // Update value in the tree list</span>
<a href="#l8.137"></a><span id="l8.137">     // Since we have a non-editable menulist,</span>
<a href="#l8.138"></a><span id="l8.138">     //   we MUST automatically add the event attribute if it doesn't exist</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineminus">-    if (!UpdateExistingAttribute(name, value, &quot;JSEAList&quot;) &amp;&amp; value)</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+    if (!UpdateExistingAttribute(name, value, &quot;JSEAList&quot;) &amp;&amp; value) {</span>
<a href="#l8.141"></a><span id="l8.141">       AddTreeItem(name, value, &quot;JSEAList&quot;, JSEAttrs);</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+    }</span>
<a href="#l8.143"></a><span id="l8.143">   }</span>
<a href="#l8.144"></a><span id="l8.144"> }</span>
<a href="#l8.145"></a><span id="l8.145"> </span>
<a href="#l8.146"></a><span id="l8.146"> function editJSEAttributeValue(targetCell) {</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineminus">-  if (IsNotTreeHeader(targetCell))</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+  if (IsNotTreeHeader(targetCell)) {</span>
<a href="#l8.149"></a><span id="l8.149">     gDialog.AddJSEAttributeValueInput.inputField.select();</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+  }</span>
<a href="#l8.151"></a><span id="l8.151"> }</span>
<a href="#l8.152"></a><span id="l8.152"> </span>
<a href="#l8.153"></a><span id="l8.153"> function UpdateJSEAttributes() {</span>
<a href="#l8.154"></a><span id="l8.154">   var JSEAList = document.getElementById(&quot;JSEAList&quot;);</span>
<a href="#l8.155"></a><span id="l8.155">   var i;</span>
<a href="#l8.156"></a><span id="l8.156"> </span>
<a href="#l8.157"></a><span id="l8.157">   // remove removed attributes</span>
<a href="#l8.158"></a><span id="l8.158">   for (i = 0; i &lt; JSERAttrs.length; i++) {</span>
<a href="#l8.159"></a><span id="l8.159">     var name = JSERAttrs[i];</span>
<a href="#l8.160"></a><span id="l8.160"> </span>
<a href="#l8.161"></a><span id="l8.161" class="difflineminus">-    if (gElement.hasAttribute(name))</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineplus">+    if (gElement.hasAttribute(name)) {</span>
<a href="#l8.163"></a><span id="l8.163">       doRemoveAttribute(name);</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+    }</span>
<a href="#l8.165"></a><span id="l8.165">   }</span>
<a href="#l8.166"></a><span id="l8.166"> </span>
<a href="#l8.167"></a><span id="l8.167">   // Add events</span>
<a href="#l8.168"></a><span id="l8.168">   for (i = 0; i &lt; JSEAList.childNodes.length; i++) {</span>
<a href="#l8.169"></a><span id="l8.169">     var item = JSEAList.childNodes[i];</span>
<a href="#l8.170"></a><span id="l8.170"> </span>
<a href="#l8.171"></a><span id="l8.171">     // set the event handler</span>
<a href="#l8.172"></a><span id="l8.172">     doSetAttribute(GetTreeItemAttributeStr(item), GetTreeItemValueStr(item));</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineat">@@ -153,18 +176,19 @@ function RemoveJSEAttribute() {</span>
<a href="#l8.174"></a><span id="l8.174">   // We only allow 1 selected item</span>
<a href="#l8.175"></a><span id="l8.175">   if (gDialog.AddJSEAttributeTree.view.selection.count) {</span>
<a href="#l8.176"></a><span id="l8.176">     var item = getSelectedItem(gDialog.AddJSEAttributeTree);</span>
<a href="#l8.177"></a><span id="l8.177"> </span>
<a href="#l8.178"></a><span id="l8.178">     // Name is the text of the treecell</span>
<a href="#l8.179"></a><span id="l8.179">     var attr = GetTreeItemAttributeStr(item);</span>
<a href="#l8.180"></a><span id="l8.180"> </span>
<a href="#l8.181"></a><span id="l8.181">     // remove the item from the attribute array</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineminus">-    if (newIndex &gt;= (JSEAttrs.length - 1))</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineplus">+    if (newIndex &gt;= JSEAttrs.length - 1) {</span>
<a href="#l8.184"></a><span id="l8.184">       newIndex--;</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineplus">+    }</span>
<a href="#l8.186"></a><span id="l8.186"> </span>
<a href="#l8.187"></a><span id="l8.187">     // remove the item from the attribute array</span>
<a href="#l8.188"></a><span id="l8.188">     JSERAttrs[JSERAttrs.length] = attr;</span>
<a href="#l8.189"></a><span id="l8.189">     RemoveNameFromAttArray(attr, JSEAttrs);</span>
<a href="#l8.190"></a><span id="l8.190"> </span>
<a href="#l8.191"></a><span id="l8.191">     // Remove the item from the tree</span>
<a href="#l8.192"></a><span id="l8.192">     item.remove();</span>
<a href="#l8.193"></a><span id="l8.193"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdAdvancedEdit.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdAdvancedEdit.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -5,24 +5,24 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /* import-globals-from ../../composer/content/editorUtilities.js */</span>
<a href="#l9.5"></a><span id="l9.5"> /* import-globals-from EdAEAttributes.js */</span>
<a href="#l9.6"></a><span id="l9.6"> /* import-globals-from EdAECSSAttributes.js */</span>
<a href="#l9.7"></a><span id="l9.7"> /* import-globals-from EdAEHTMLAttributes.js */</span>
<a href="#l9.8"></a><span id="l9.8"> /* import-globals-from EdAEJSEAttributes.js */</span>
<a href="#l9.9"></a><span id="l9.9"> /* import-globals-from EdDialogCommon.js */</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11"> /** ************         GLOBALS         **************/</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-var gElement    = null; // handle to actual element edited</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+var gElement = null; // handle to actual element edited</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-var HTMLAttrs   = [];   // html attributes</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-var CSSAttrs    = [];   // css attributes</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-var JSEAttrs    = [];   // js events</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+var HTMLAttrs = []; // html attributes</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+var CSSAttrs = []; // css attributes</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+var JSEAttrs = []; // js events</span>
<a href="#l9.21"></a><span id="l9.21"> </span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-var HTMLRAttrs  = [];   // removed html attributes</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-var JSERAttrs   = [];   // removed js events</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+var HTMLRAttrs = []; // removed html attributes</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+var JSERAttrs = []; // removed js events</span>
<a href="#l9.26"></a><span id="l9.26"> </span>
<a href="#l9.27"></a><span id="l9.27"> /* Set false to allow changing selection in tree</span>
<a href="#l9.28"></a><span id="l9.28">    without doing &quot;onselect&quot; handler actions</span>
<a href="#l9.29"></a><span id="l9.29"> */</span>
<a href="#l9.30"></a><span id="l9.30"> var gDoOnSelectTree = true;</span>
<a href="#l9.31"></a><span id="l9.31"> var gUpdateTreeValue = true;</span>
<a href="#l9.32"></a><span id="l9.32"> </span>
<a href="#l9.33"></a><span id="l9.33"> /** ************ INITIALISATION &amp;&amp; SETUP **************/</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineat">@@ -49,35 +49,51 @@ function Startup() {</span>
<a href="#l9.35"></a><span id="l9.35">   // who only needs to know if OK was clicked</span>
<a href="#l9.36"></a><span id="l9.36">   window.opener.AdvancedEditOK = false;</span>
<a href="#l9.37"></a><span id="l9.37"> </span>
<a href="#l9.38"></a><span id="l9.38">   // The actual element edited (not a copy!)</span>
<a href="#l9.39"></a><span id="l9.39">   gElement = window.arguments[1];</span>
<a href="#l9.40"></a><span id="l9.40"> </span>
<a href="#l9.41"></a><span id="l9.41">   // place the tag name in the header</span>
<a href="#l9.42"></a><span id="l9.42">   var tagLabel = document.getElementById(&quot;tagLabel&quot;);</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-  tagLabel.setAttribute(&quot;value&quot;, (&quot;&lt;&quot; + gElement.localName + &quot;&gt;&quot;));</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+  tagLabel.setAttribute(&quot;value&quot;, &quot;&lt;&quot; + gElement.localName + &quot;&gt;&quot;);</span>
<a href="#l9.45"></a><span id="l9.45"> </span>
<a href="#l9.46"></a><span id="l9.46">   // Create dialog object to store controls for easy access</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-  gDialog.AddHTMLAttributeNameInput  = document.getElementById(&quot;AddHTMLAttributeNameInput&quot;);</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+  gDialog.AddHTMLAttributeNameInput = document.getElementById(</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+    &quot;AddHTMLAttributeNameInput&quot;</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+  );</span>
<a href="#l9.51"></a><span id="l9.51"> </span>
<a href="#l9.52"></a><span id="l9.52">   // We use a &lt;deck&gt; to switch between editable menulist and textbox</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-  gDialog.AddHTMLAttributeValueDeck     = document.getElementById(&quot;AddHTMLAttributeValueDeck&quot;);</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-  gDialog.AddHTMLAttributeValueMenulist = document.getElementById(&quot;AddHTMLAttributeValueMenulist&quot;);</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-  gDialog.AddHTMLAttributeValueTextbox  = document.getElementById(&quot;AddHTMLAttributeValueTextbox&quot;);</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-  gDialog.AddHTMLAttributeValueInput    = gDialog.AddHTMLAttributeValueTextbox;</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+  gDialog.AddHTMLAttributeValueDeck = document.getElementById(</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+    &quot;AddHTMLAttributeValueDeck&quot;</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+  );</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+  gDialog.AddHTMLAttributeValueMenulist = document.getElementById(</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+    &quot;AddHTMLAttributeValueMenulist&quot;</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+  );</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+  gDialog.AddHTMLAttributeValueTextbox = document.getElementById(</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+    &quot;AddHTMLAttributeValueTextbox&quot;</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+  );</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+  gDialog.AddHTMLAttributeValueInput = gDialog.AddHTMLAttributeValueTextbox;</span>
<a href="#l9.67"></a><span id="l9.67"> </span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-  gDialog.AddHTMLAttributeTree          = document.getElementById(&quot;HTMLATree&quot;);</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-  gDialog.AddCSSAttributeNameInput      = document.getElementById(&quot;AddCSSAttributeNameInput&quot;);</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-  gDialog.AddCSSAttributeValueInput     = document.getElementById(&quot;AddCSSAttributeValueInput&quot;);</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-  gDialog.AddCSSAttributeTree           = document.getElementById(&quot;CSSATree&quot;);</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineminus">-  gDialog.AddJSEAttributeNameList       = document.getElementById(&quot;AddJSEAttributeNameList&quot;);</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-  gDialog.AddJSEAttributeValueInput     = document.getElementById(&quot;AddJSEAttributeValueInput&quot;);</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-  gDialog.AddJSEAttributeTree           = document.getElementById(&quot;JSEATree&quot;);</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-  gDialog.okButton                      = document.documentElement.getButton(&quot;accept&quot;);</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineplus">+  gDialog.AddHTMLAttributeTree = document.getElementById(&quot;HTMLATree&quot;);</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+  gDialog.AddCSSAttributeNameInput = document.getElementById(</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+    &quot;AddCSSAttributeNameInput&quot;</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+  );</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+  gDialog.AddCSSAttributeValueInput = document.getElementById(</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+    &quot;AddCSSAttributeValueInput&quot;</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+  );</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+  gDialog.AddCSSAttributeTree = document.getElementById(&quot;CSSATree&quot;);</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+  gDialog.AddJSEAttributeNameList = document.getElementById(</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+    &quot;AddJSEAttributeNameList&quot;</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+  );</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+  gDialog.AddJSEAttributeValueInput = document.getElementById(</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineplus">+    &quot;AddJSEAttributeValueInput&quot;</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineplus">+  );</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+  gDialog.AddJSEAttributeTree = document.getElementById(&quot;JSEATree&quot;);</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+  gDialog.okButton = document.documentElement.getButton(&quot;accept&quot;);</span>
<a href="#l9.92"></a><span id="l9.92"> </span>
<a href="#l9.93"></a><span id="l9.93">   // build the attribute trees</span>
<a href="#l9.94"></a><span id="l9.94">   BuildHTMLAttributeTable();</span>
<a href="#l9.95"></a><span id="l9.95">   BuildCSSAttributeTable();</span>
<a href="#l9.96"></a><span id="l9.96">   BuildJSEAttributeTable();</span>
<a href="#l9.97"></a><span id="l9.97"> </span>
<a href="#l9.98"></a><span id="l9.98">   // Build attribute name arrays for menulists</span>
<a href="#l9.99"></a><span id="l9.99">   BuildJSEAttributeNameList();</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineat">@@ -117,59 +133,63 @@ function onAccept() {</span>
<a href="#l9.101"></a><span id="l9.101"> }</span>
<a href="#l9.102"></a><span id="l9.102"> </span>
<a href="#l9.103"></a><span id="l9.103"> // Helpers for removing and setting attributes</span>
<a href="#l9.104"></a><span id="l9.104"> // Use editor transactions if modifying the element already in the document</span>
<a href="#l9.105"></a><span id="l9.105"> // (Temporary element from a property dialog won't have a parent node)</span>
<a href="#l9.106"></a><span id="l9.106"> function doRemoveAttribute(attrib) {</span>
<a href="#l9.107"></a><span id="l9.107">   try {</span>
<a href="#l9.108"></a><span id="l9.108">     var editor = GetCurrentEditor();</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineminus">-    if (gElement.parentNode)</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineplus">+    if (gElement.parentNode) {</span>
<a href="#l9.111"></a><span id="l9.111">       editor.removeAttribute(gElement, attrib);</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineminus">-    else</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineplus">+    } else {</span>
<a href="#l9.114"></a><span id="l9.114">       gElement.removeAttribute(attrib);</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineplus">+    }</span>
<a href="#l9.116"></a><span id="l9.116">   } catch (ex) {}</span>
<a href="#l9.117"></a><span id="l9.117"> }</span>
<a href="#l9.118"></a><span id="l9.118"> </span>
<a href="#l9.119"></a><span id="l9.119"> function doSetAttribute(attrib, value) {</span>
<a href="#l9.120"></a><span id="l9.120">   try {</span>
<a href="#l9.121"></a><span id="l9.121">     var editor = GetCurrentEditor();</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineminus">-    if (gElement.parentNode)</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineplus">+    if (gElement.parentNode) {</span>
<a href="#l9.124"></a><span id="l9.124">       editor.setAttribute(gElement, attrib, value);</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineminus">-    else</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineplus">+    } else {</span>
<a href="#l9.127"></a><span id="l9.127">       gElement.setAttribute(attrib, value);</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineplus">+    }</span>
<a href="#l9.129"></a><span id="l9.129">   } catch (ex) {}</span>
<a href="#l9.130"></a><span id="l9.130"> }</span>
<a href="#l9.131"></a><span id="l9.131"> </span>
<a href="#l9.132"></a><span id="l9.132"> /**</span>
<a href="#l9.133"></a><span id="l9.133">  * function   : bool CheckAttributeNameSimilarity ( string attName, array attArray );</span>
<a href="#l9.134"></a><span id="l9.134">  * parameters : attribute to look for, array of current attributes</span>
<a href="#l9.135"></a><span id="l9.135">  * returns    : true if attribute already exists, false if it does not</span>
<a href="#l9.136"></a><span id="l9.136">  * desc.      : checks to see if any other attributes by the same name as the arg supplied</span>
<a href="#l9.137"></a><span id="l9.137">  *              already exist.</span>
<a href="#l9.138"></a><span id="l9.138">  **/</span>
<a href="#l9.139"></a><span id="l9.139"> function CheckAttributeNameSimilarity(attName, attArray) {</span>
<a href="#l9.140"></a><span id="l9.140">   for (var i = 0; i &lt; attArray.length; i++) {</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineminus">-    if (attName.toLowerCase() == attArray[i].toLowerCase())</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineplus">+    if (attName.toLowerCase() == attArray[i].toLowerCase()) {</span>
<a href="#l9.143"></a><span id="l9.143">       return true;</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineplus">+    }</span>
<a href="#l9.145"></a><span id="l9.145">   }</span>
<a href="#l9.146"></a><span id="l9.146">   return false;</span>
<a href="#l9.147"></a><span id="l9.147"> }</span>
<a href="#l9.148"></a><span id="l9.148"> </span>
<a href="#l9.149"></a><span id="l9.149"> /**</span>
<a href="#l9.150"></a><span id="l9.150">  * function   : bool UpdateExistingAttribute ( string attName, string attValue, string treeChildrenId );</span>
<a href="#l9.151"></a><span id="l9.151">  * parameters : attribute to look for, new value, ID of &lt;treeChildren&gt; node in XUL tree</span>
<a href="#l9.152"></a><span id="l9.152">  * returns    : true if attribute already exists in tree, false if it does not</span>
<a href="#l9.153"></a><span id="l9.153">  * desc.      : checks to see if any other attributes by the same name as the arg supplied</span>
<a href="#l9.154"></a><span id="l9.154">  *              already exist while setting the associated value if different from current value</span>
<a href="#l9.155"></a><span id="l9.155">  **/</span>
<a href="#l9.156"></a><span id="l9.156"> function UpdateExistingAttribute(attName, attValue, treeChildrenId) {</span>
<a href="#l9.157"></a><span id="l9.157">   var treeChildren = document.getElementById(treeChildrenId);</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineminus">-  if (!treeChildren)</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineplus">+  if (!treeChildren) {</span>
<a href="#l9.160"></a><span id="l9.160">     return false;</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineplus">+  }</span>
<a href="#l9.162"></a><span id="l9.162"> </span>
<a href="#l9.163"></a><span id="l9.163">   var name;</span>
<a href="#l9.164"></a><span id="l9.164">   var i;</span>
<a href="#l9.165"></a><span id="l9.165">   attName = TrimString(attName).toLowerCase();</span>
<a href="#l9.166"></a><span id="l9.166">   attValue = TrimString(attValue);</span>
<a href="#l9.167"></a><span id="l9.167"> </span>
<a href="#l9.168"></a><span id="l9.168">   for (i = 0; i &lt; treeChildren.childNodes.length; i++) {</span>
<a href="#l9.169"></a><span id="l9.169">     var item = treeChildren.childNodes[i];</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineat">@@ -193,18 +213,19 @@ function UpdateExistingAttribute(attName</span>
<a href="#l9.171"></a><span id="l9.171"> }</span>
<a href="#l9.172"></a><span id="l9.172"> </span>
<a href="#l9.173"></a><span id="l9.173"> /**</span>
<a href="#l9.174"></a><span id="l9.174">  * function   : string GetAndSelectExistingAttributeValue ( string attName, string treeChildrenId );</span>
<a href="#l9.175"></a><span id="l9.175">  * parameters : attribute to look for, ID of &lt;treeChildren&gt; node in XUL tree</span>
<a href="#l9.176"></a><span id="l9.176">  * returns    : value in from the tree or empty string if name not found</span>
<a href="#l9.177"></a><span id="l9.177">  **/</span>
<a href="#l9.178"></a><span id="l9.178"> function GetAndSelectExistingAttributeValue(attName, treeChildrenId) {</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineminus">-  if (!attName)</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineplus">+  if (!attName) {</span>
<a href="#l9.181"></a><span id="l9.181">     return &quot;&quot;;</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineplus">+  }</span>
<a href="#l9.183"></a><span id="l9.183"> </span>
<a href="#l9.184"></a><span id="l9.184">   var treeChildren = document.getElementById(treeChildrenId);</span>
<a href="#l9.185"></a><span id="l9.185">   var name;</span>
<a href="#l9.186"></a><span id="l9.186">   var i;</span>
<a href="#l9.187"></a><span id="l9.187"> </span>
<a href="#l9.188"></a><span id="l9.188">   for (i = 0; i &lt; treeChildren.childNodes.length; i++) {</span>
<a href="#l9.189"></a><span id="l9.189">     var item = treeChildren.childNodes[i];</span>
<a href="#l9.190"></a><span id="l9.190">     name = GetTreeItemAttributeStr(item);</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineat">@@ -234,37 +255,41 @@ function GetAndSelectExistingAttributeVa</span>
<a href="#l9.192"></a><span id="l9.192"> </span>
<a href="#l9.193"></a><span id="l9.193"> /* Tree structure:</span>
<a href="#l9.194"></a><span id="l9.194">   &lt;treeItem&gt;</span>
<a href="#l9.195"></a><span id="l9.195">     &lt;treeRow&gt;</span>
<a href="#l9.196"></a><span id="l9.196">       &lt;treeCell&gt; // Name Cell</span>
<a href="#l9.197"></a><span id="l9.197">       &lt;treeCell  // Value Cell</span>
<a href="#l9.198"></a><span id="l9.198"> */</span>
<a href="#l9.199"></a><span id="l9.199"> function GetTreeItemAttributeStr(treeItem) {</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineminus">-  if (treeItem)</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineplus">+  if (treeItem) {</span>
<a href="#l9.202"></a><span id="l9.202">     return TrimString(treeItem.firstChild.firstChild.getAttribute(&quot;label&quot;));</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineplus">+  }</span>
<a href="#l9.204"></a><span id="l9.204"> </span>
<a href="#l9.205"></a><span id="l9.205">   return &quot;&quot;;</span>
<a href="#l9.206"></a><span id="l9.206"> }</span>
<a href="#l9.207"></a><span id="l9.207"> </span>
<a href="#l9.208"></a><span id="l9.208"> function GetTreeItemValueStr(treeItem) {</span>
<a href="#l9.209"></a><span id="l9.209" class="difflineminus">-  if (treeItem)</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineplus">+  if (treeItem) {</span>
<a href="#l9.211"></a><span id="l9.211">     return TrimString(treeItem.firstChild.lastChild.getAttribute(&quot;label&quot;));</span>
<a href="#l9.212"></a><span id="l9.212" class="difflineplus">+  }</span>
<a href="#l9.213"></a><span id="l9.213"> </span>
<a href="#l9.214"></a><span id="l9.214">   return &quot;&quot;;</span>
<a href="#l9.215"></a><span id="l9.215"> }</span>
<a href="#l9.216"></a><span id="l9.216"> </span>
<a href="#l9.217"></a><span id="l9.217"> function SetTreeItemValueStr(treeItem, value) {</span>
<a href="#l9.218"></a><span id="l9.218" class="difflineminus">-  if (treeItem &amp;&amp; GetTreeItemValueStr(treeItem) != value)</span>
<a href="#l9.219"></a><span id="l9.219" class="difflineplus">+  if (treeItem &amp;&amp; GetTreeItemValueStr(treeItem) != value) {</span>
<a href="#l9.220"></a><span id="l9.220">     treeItem.firstChild.lastChild.setAttribute(&quot;label&quot;, value);</span>
<a href="#l9.221"></a><span id="l9.221" class="difflineplus">+  }</span>
<a href="#l9.222"></a><span id="l9.222"> }</span>
<a href="#l9.223"></a><span id="l9.223"> </span>
<a href="#l9.224"></a><span id="l9.224"> function IsNotTreeHeader(treeCell) {</span>
<a href="#l9.225"></a><span id="l9.225" class="difflineminus">-  if (treeCell)</span>
<a href="#l9.226"></a><span id="l9.226" class="difflineminus">-    return (treeCell.parentNode.parentNode.nodeName != &quot;treehead&quot;);</span>
<a href="#l9.227"></a><span id="l9.227" class="difflineplus">+  if (treeCell) {</span>
<a href="#l9.228"></a><span id="l9.228" class="difflineplus">+    return treeCell.parentNode.parentNode.nodeName != &quot;treehead&quot;;</span>
<a href="#l9.229"></a><span id="l9.229" class="difflineplus">+  }</span>
<a href="#l9.230"></a><span id="l9.230"> </span>
<a href="#l9.231"></a><span id="l9.231">   return false;</span>
<a href="#l9.232"></a><span id="l9.232"> }</span>
<a href="#l9.233"></a><span id="l9.233"> </span>
<a href="#l9.234"></a><span id="l9.234"> function RemoveNameFromAttArray(attName, attArray) {</span>
<a href="#l9.235"></a><span id="l9.235">   for (var i = 0; i &lt; attArray.length; i++) {</span>
<a href="#l9.236"></a><span id="l9.236">     if (attName.toLowerCase() == attArray[i].toLowerCase()) {</span>
<a href="#l9.237"></a><span id="l9.237">       // Remove 1 array item</span>
<a href="#l9.238"></a><span id="l9.238" class="difflineat">@@ -305,12 +330,13 @@ function AddTreeItem(name, value, treeCh</span>
<a href="#l9.239"></a><span id="l9.239"> }</span>
<a href="#l9.240"></a><span id="l9.240"> </span>
<a href="#l9.241"></a><span id="l9.241"> function selectTreeItem(treeChildren, item) {</span>
<a href="#l9.242"></a><span id="l9.242">   var index = treeChildren.parentNode.view.getIndexOfItem(item);</span>
<a href="#l9.243"></a><span id="l9.243">   treeChildren.parentNode.view.selection.select(index);</span>
<a href="#l9.244"></a><span id="l9.244"> }</span>
<a href="#l9.245"></a><span id="l9.245"> </span>
<a href="#l9.246"></a><span id="l9.246"> function getSelectedItem(tree) {</span>
<a href="#l9.247"></a><span id="l9.247" class="difflineminus">-  if (tree.view.selection.count == 1)</span>
<a href="#l9.248"></a><span id="l9.248" class="difflineplus">+  if (tree.view.selection.count == 1) {</span>
<a href="#l9.249"></a><span id="l9.249">     return tree.view.getItemAtIndex(tree.currentIndex);</span>
<a href="#l9.250"></a><span id="l9.250" class="difflineplus">+  }</span>
<a href="#l9.251"></a><span id="l9.251">   return null;</span>
<a href="#l9.252"></a><span id="l9.252"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdButtonProps.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdButtonProps.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -16,25 +16,25 @@ document.addEventListener(&quot;dialogcancel&quot;</span>
<a href="#l10.4"></a><span id="l10.4"> function Startup() {</span>
<a href="#l10.5"></a><span id="l10.5">   var editor = GetCurrentEditor();</span>
<a href="#l10.6"></a><span id="l10.6">   if (!editor) {</span>
<a href="#l10.7"></a><span id="l10.7">     window.close();</span>
<a href="#l10.8"></a><span id="l10.8">     return;</span>
<a href="#l10.9"></a><span id="l10.9">   }</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11">   gDialog = {</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-    buttonType:       document.getElementById(&quot;ButtonType&quot;),</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-    buttonName:       document.getElementById(&quot;ButtonName&quot;),</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-    buttonValue:      document.getElementById(&quot;ButtonValue&quot;),</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-    buttonDisabled:   document.getElementById(&quot;ButtonDisabled&quot;),</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-    buttonTabIndex:   document.getElementById(&quot;ButtonTabIndex&quot;),</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-    buttonAccessKey:  document.getElementById(&quot;ButtonAccessKey&quot;),</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-    MoreSection:      document.getElementById(&quot;MoreSection&quot;),</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-    MoreFewerButton:  document.getElementById(&quot;MoreFewerButton&quot;),</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-    RemoveButton:     document.getElementById(&quot;RemoveButton&quot;),</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+    buttonType: document.getElementById(&quot;ButtonType&quot;),</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+    buttonName: document.getElementById(&quot;ButtonName&quot;),</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+    buttonValue: document.getElementById(&quot;ButtonValue&quot;),</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+    buttonDisabled: document.getElementById(&quot;ButtonDisabled&quot;),</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+    buttonTabIndex: document.getElementById(&quot;ButtonTabIndex&quot;),</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+    buttonAccessKey: document.getElementById(&quot;ButtonAccessKey&quot;),</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+    MoreSection: document.getElementById(&quot;MoreSection&quot;),</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+    MoreFewerButton: document.getElementById(&quot;MoreFewerButton&quot;),</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+    RemoveButton: document.getElementById(&quot;RemoveButton&quot;),</span>
<a href="#l10.30"></a><span id="l10.30">   };</span>
<a href="#l10.31"></a><span id="l10.31"> </span>
<a href="#l10.32"></a><span id="l10.32">   // Get a single selected button element</span>
<a href="#l10.33"></a><span id="l10.33">   const kTagName = &quot;button&quot;;</span>
<a href="#l10.34"></a><span id="l10.34">   try {</span>
<a href="#l10.35"></a><span id="l10.35">     buttonElement = editor.getSelectedElement(kTagName);</span>
<a href="#l10.36"></a><span id="l10.36">   } catch (e) {}</span>
<a href="#l10.37"></a><span id="l10.37"> </span>
<a href="#l10.38"></a><span id="l10.38" class="difflineat">@@ -80,17 +80,20 @@ function InitDialog() {</span>
<a href="#l10.39"></a><span id="l10.39">       break;</span>
<a href="#l10.40"></a><span id="l10.40">     case &quot;reset&quot;:</span>
<a href="#l10.41"></a><span id="l10.41">       index = 1;</span>
<a href="#l10.42"></a><span id="l10.42">       break;</span>
<a href="#l10.43"></a><span id="l10.43">   }</span>
<a href="#l10.44"></a><span id="l10.44">   gDialog.buttonType.selectedIndex = index;</span>
<a href="#l10.45"></a><span id="l10.45">   gDialog.buttonName.value = globalElement.getAttribute(&quot;name&quot;);</span>
<a href="#l10.46"></a><span id="l10.46">   gDialog.buttonValue.value = globalElement.getAttribute(&quot;value&quot;);</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-  gDialog.buttonDisabled.setAttribute(&quot;checked&quot;, globalElement.hasAttribute(&quot;disabled&quot;));</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+  gDialog.buttonDisabled.setAttribute(</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+    &quot;checked&quot;,</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+    globalElement.hasAttribute(&quot;disabled&quot;)</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+  );</span>
<a href="#l10.52"></a><span id="l10.52">   gDialog.buttonTabIndex.value = globalElement.getAttribute(&quot;tabindex&quot;);</span>
<a href="#l10.53"></a><span id="l10.53">   gDialog.buttonAccessKey.value = globalElement.getAttribute(&quot;accesskey&quot;);</span>
<a href="#l10.54"></a><span id="l10.54"> }</span>
<a href="#l10.55"></a><span id="l10.55"> </span>
<a href="#l10.56"></a><span id="l10.56"> function RemoveButton() {</span>
<a href="#l10.57"></a><span id="l10.57">   RemoveContainer(buttonElement);</span>
<a href="#l10.58"></a><span id="l10.58">   SaveWindowLocation();</span>
<a href="#l10.59"></a><span id="l10.59">   window.close();</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineat">@@ -100,40 +103,44 @@ function ValidateData() {</span>
<a href="#l10.61"></a><span id="l10.61">   var attributes = {</span>
<a href="#l10.62"></a><span id="l10.62">     type: [&quot;&quot;, &quot;reset&quot;, &quot;button&quot;][gDialog.buttonType.selectedIndex],</span>
<a href="#l10.63"></a><span id="l10.63">     name: gDialog.buttonName.value,</span>
<a href="#l10.64"></a><span id="l10.64">     value: gDialog.buttonValue.value,</span>
<a href="#l10.65"></a><span id="l10.65">     tabindex: gDialog.buttonTabIndex.value,</span>
<a href="#l10.66"></a><span id="l10.66">     accesskey: gDialog.buttonAccessKey.value,</span>
<a href="#l10.67"></a><span id="l10.67">   };</span>
<a href="#l10.68"></a><span id="l10.68">   for (var a in attributes) {</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-    if (attributes[a])</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+    if (attributes[a]) {</span>
<a href="#l10.71"></a><span id="l10.71">       globalElement.setAttribute(a, attributes[a]);</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineminus">-    else</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+    } else {</span>
<a href="#l10.74"></a><span id="l10.74">       globalElement.removeAttribute(a);</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+    }</span>
<a href="#l10.76"></a><span id="l10.76">   }</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineminus">-  if (gDialog.buttonDisabled.checked)</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+  if (gDialog.buttonDisabled.checked) {</span>
<a href="#l10.79"></a><span id="l10.79">     globalElement.setAttribute(&quot;disabled&quot;, &quot;&quot;);</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineminus">-  else</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+  } else {</span>
<a href="#l10.82"></a><span id="l10.82">     globalElement.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+  }</span>
<a href="#l10.84"></a><span id="l10.84">   return true;</span>
<a href="#l10.85"></a><span id="l10.85"> }</span>
<a href="#l10.86"></a><span id="l10.86"> </span>
<a href="#l10.87"></a><span id="l10.87"> function onAccept() {</span>
<a href="#l10.88"></a><span id="l10.88">   // All values are valid - copy to actual element in doc or</span>
<a href="#l10.89"></a><span id="l10.89">   //   element created to insert</span>
<a href="#l10.90"></a><span id="l10.90">   ValidateData();</span>
<a href="#l10.91"></a><span id="l10.91"> </span>
<a href="#l10.92"></a><span id="l10.92">   var editor = GetCurrentEditor();</span>
<a href="#l10.93"></a><span id="l10.93"> </span>
<a href="#l10.94"></a><span id="l10.94">   editor.cloneAttributes(buttonElement, globalElement);</span>
<a href="#l10.95"></a><span id="l10.95"> </span>
<a href="#l10.96"></a><span id="l10.96">   if (insertNew) {</span>
<a href="#l10.97"></a><span id="l10.97">     if (!InsertElementAroundSelection(buttonElement)) {</span>
<a href="#l10.98"></a><span id="l10.98">       /* eslint-disable-next-line no-unsanitized/property */</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineminus">-      buttonElement.innerHTML = editor.outputToString(&quot;text/html&quot;, kOutputSelectionOnly);</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+      buttonElement.innerHTML = editor.outputToString(</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+        &quot;text/html&quot;,</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+        kOutputSelectionOnly</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+      );</span>
<a href="#l10.104"></a><span id="l10.104">       editor.insertElementAtSelection(buttonElement, true);</span>
<a href="#l10.105"></a><span id="l10.105">     }</span>
<a href="#l10.106"></a><span id="l10.106">   }</span>
<a href="#l10.107"></a><span id="l10.107"> </span>
<a href="#l10.108"></a><span id="l10.108">   SaveWindowLocation();</span>
<a href="#l10.109"></a><span id="l10.109"> }</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdColorPicker.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdColorPicker.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -29,60 +29,64 @@ function Startup() {</span>
<a href="#l11.4"></a><span id="l11.4">     dump(&quot;EdColorPicker: Missing color object param\n&quot;);</span>
<a href="#l11.5"></a><span id="l11.5">     return;</span>
<a href="#l11.6"></a><span id="l11.6">   }</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8">   // window.arguments[1] is object to get initial values and return color data</span>
<a href="#l11.9"></a><span id="l11.9">   gColorObj = window.arguments[1];</span>
<a href="#l11.10"></a><span id="l11.10">   gColorObj.Cancel = false;</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  gDialog.ColorPicker      = document.getElementById(&quot;ColorPicker&quot;);</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-  gDialog.ColorInput       = document.getElementById(&quot;ColorInput&quot;);</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+  gDialog.ColorPicker = document.getElementById(&quot;ColorPicker&quot;);</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+  gDialog.ColorInput = document.getElementById(&quot;ColorInput&quot;);</span>
<a href="#l11.16"></a><span id="l11.16">   gDialog.LastPickedButton = document.getElementById(&quot;LastPickedButton&quot;);</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-  gDialog.LastPickedColor  = document.getElementById(&quot;LastPickedColor&quot;);</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+  gDialog.LastPickedColor = document.getElementById(&quot;LastPickedColor&quot;);</span>
<a href="#l11.19"></a><span id="l11.19">   gDialog.CellOrTableGroup = document.getElementById(&quot;CellOrTableGroup&quot;);</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-  gDialog.TableRadio       = document.getElementById(&quot;TableRadio&quot;);</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-  gDialog.CellRadio        = document.getElementById(&quot;CellRadio&quot;);</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-  gDialog.ColorSwatch      = document.getElementById(&quot;ColorPickerSwatch&quot;);</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-  gDialog.Ok               = document.documentElement.getButton(&quot;accept&quot;);</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+  gDialog.TableRadio = document.getElementById(&quot;TableRadio&quot;);</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+  gDialog.CellRadio = document.getElementById(&quot;CellRadio&quot;);</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+  gDialog.ColorSwatch = document.getElementById(&quot;ColorPickerSwatch&quot;);</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+  gDialog.Ok = document.documentElement.getButton(&quot;accept&quot;);</span>
<a href="#l11.28"></a><span id="l11.28"> </span>
<a href="#l11.29"></a><span id="l11.29">   // The type of color we are setting:</span>
<a href="#l11.30"></a><span id="l11.30">   //  text: Text, Link, ActiveLink, VisitedLink,</span>
<a href="#l11.31"></a><span id="l11.31">   //  or background: Page, Table, or Cell</span>
<a href="#l11.32"></a><span id="l11.32">   if (gColorObj.Type) {</span>
<a href="#l11.33"></a><span id="l11.33">     ColorType = gColorObj.Type;</span>
<a href="#l11.34"></a><span id="l11.34">     // Get string for dialog title from passed-in type</span>
<a href="#l11.35"></a><span id="l11.35">     //   (note constraint on editor.properties string name)</span>
<a href="#l11.36"></a><span id="l11.36">     let IsCSSPrefChecked = Services.prefs.getBoolPref(&quot;editor.use_css&quot;);</span>
<a href="#l11.37"></a><span id="l11.37"> </span>
<a href="#l11.38"></a><span id="l11.38">     if (GetCurrentEditor()) {</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-      if (ColorType == &quot;Page&quot; &amp;&amp; IsCSSPrefChecked &amp;&amp; IsHTMLEditor())</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+      if (ColorType == &quot;Page&quot; &amp;&amp; IsCSSPrefChecked &amp;&amp; IsHTMLEditor()) {</span>
<a href="#l11.41"></a><span id="l11.41">         document.title = GetString(&quot;BlockColor&quot;);</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-      else</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+      } else {</span>
<a href="#l11.44"></a><span id="l11.44">         document.title = GetString(ColorType + &quot;Color&quot;);</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+      }</span>
<a href="#l11.46"></a><span id="l11.46">     }</span>
<a href="#l11.47"></a><span id="l11.47">   }</span>
<a href="#l11.48"></a><span id="l11.48"> </span>
<a href="#l11.49"></a><span id="l11.49">   gDialog.ColorInput.value = &quot;&quot;;</span>
<a href="#l11.50"></a><span id="l11.50">   var tmpColor;</span>
<a href="#l11.51"></a><span id="l11.51">   var haveTableRadio = false;</span>
<a href="#l11.52"></a><span id="l11.52"> </span>
<a href="#l11.53"></a><span id="l11.53">   switch (ColorType) {</span>
<a href="#l11.54"></a><span id="l11.54">     case &quot;Page&quot;:</span>
<a href="#l11.55"></a><span id="l11.55">       tmpColor = gColorObj.PageColor;</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-      if (tmpColor &amp;&amp; tmpColor.toLowerCase() != &quot;window&quot;)</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+      if (tmpColor &amp;&amp; tmpColor.toLowerCase() != &quot;window&quot;) {</span>
<a href="#l11.58"></a><span id="l11.58">         gColor = tmpColor;</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+      }</span>
<a href="#l11.60"></a><span id="l11.60">       break;</span>
<a href="#l11.61"></a><span id="l11.61">     case &quot;Table&quot;:</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-      if (gColorObj.TableColor)</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+      if (gColorObj.TableColor) {</span>
<a href="#l11.64"></a><span id="l11.64">         gColor = gColorObj.TableColor;</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+      }</span>
<a href="#l11.66"></a><span id="l11.66">       break;</span>
<a href="#l11.67"></a><span id="l11.67">     case &quot;Cell&quot;:</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-      if (gColorObj.CellColor)</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+      if (gColorObj.CellColor) {</span>
<a href="#l11.70"></a><span id="l11.70">         gColor = gColorObj.CellColor;</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+      }</span>
<a href="#l11.72"></a><span id="l11.72">       break;</span>
<a href="#l11.73"></a><span id="l11.73">     case &quot;TableOrCell&quot;:</span>
<a href="#l11.74"></a><span id="l11.74">       TableOrCell = true;</span>
<a href="#l11.75"></a><span id="l11.75">       document.getElementById(&quot;TableOrCellGroup&quot;).collapsed = false;</span>
<a href="#l11.76"></a><span id="l11.76">       haveTableRadio = true;</span>
<a href="#l11.77"></a><span id="l11.77">       if (gColorObj.SelectedType == &quot;Cell&quot;) {</span>
<a href="#l11.78"></a><span id="l11.78">         gColor = gColorObj.CellColor;</span>
<a href="#l11.79"></a><span id="l11.79">         gDialog.CellOrTableGroup.selectedItem = gDialog.CellRadio;</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineat">@@ -90,80 +94,99 @@ function Startup() {</span>
<a href="#l11.81"></a><span id="l11.81">       } else {</span>
<a href="#l11.82"></a><span id="l11.82">         gColor = gColorObj.TableColor;</span>
<a href="#l11.83"></a><span id="l11.83">         gDialog.CellOrTableGroup.selectedItem = gDialog.TableRadio;</span>
<a href="#l11.84"></a><span id="l11.84">         gDialog.TableRadio.focus();</span>
<a href="#l11.85"></a><span id="l11.85">       }</span>
<a href="#l11.86"></a><span id="l11.86">       break;</span>
<a href="#l11.87"></a><span id="l11.87">     case &quot;Highlight&quot;:</span>
<a href="#l11.88"></a><span id="l11.88">       HighlightType = true;</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineminus">-      if (gColorObj.HighlightColor)</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+      if (gColorObj.HighlightColor) {</span>
<a href="#l11.91"></a><span id="l11.91">         gColor = gColorObj.HighlightColor;</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+      }</span>
<a href="#l11.93"></a><span id="l11.93">       break;</span>
<a href="#l11.94"></a><span id="l11.94">     default:</span>
<a href="#l11.95"></a><span id="l11.95">       // Any other type will change some kind of text,</span>
<a href="#l11.96"></a><span id="l11.96">       TextType = true;</span>
<a href="#l11.97"></a><span id="l11.97">       tmpColor = gColorObj.TextColor;</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineminus">-      if (tmpColor &amp;&amp; tmpColor.toLowerCase() != &quot;windowtext&quot;)</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineplus">+      if (tmpColor &amp;&amp; tmpColor.toLowerCase() != &quot;windowtext&quot;) {</span>
<a href="#l11.100"></a><span id="l11.100">         gColor = gColorObj.TextColor;</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+      }</span>
<a href="#l11.102"></a><span id="l11.102">       break;</span>
<a href="#l11.103"></a><span id="l11.103">   }</span>
<a href="#l11.104"></a><span id="l11.104"> </span>
<a href="#l11.105"></a><span id="l11.105">   // Set initial color in input field and in the colorpicker</span>
<a href="#l11.106"></a><span id="l11.106">   SetCurrentColor(gColor);</span>
<a href="#l11.107"></a><span id="l11.107">   gDialog.ColorPicker.value = gColor;</span>
<a href="#l11.108"></a><span id="l11.108"> </span>
<a href="#l11.109"></a><span id="l11.109">   // Use last-picked colors passed in, or those persistent on dialog</span>
<a href="#l11.110"></a><span id="l11.110">   if (TextType) {</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineminus">-    if (!(&quot;LastTextColor&quot; in gColorObj) || !gColorObj.LastTextColor)</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineminus">-      gColorObj.LastTextColor = gDialog.LastPickedColor.getAttribute(&quot;LastTextColor&quot;);</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+    if (!(&quot;LastTextColor&quot; in gColorObj) || !gColorObj.LastTextColor) {</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+      gColorObj.LastTextColor = gDialog.LastPickedColor.getAttribute(</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineplus">+        &quot;LastTextColor&quot;</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineplus">+      );</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineplus">+    }</span>
<a href="#l11.118"></a><span id="l11.118">     LastPickedColor = gColorObj.LastTextColor;</span>
<a href="#l11.119"></a><span id="l11.119">   } else if (HighlightType) {</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineminus">-    if (!(&quot;LastHighlightColor&quot; in gColorObj) || !gColorObj.LastHighlightColor)</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineminus">-      gColorObj.LastHighlightColor = gDialog.LastPickedColor.getAttribute(&quot;LastHighlightColor&quot;);</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineplus">+    if (!(&quot;LastHighlightColor&quot; in gColorObj) || !gColorObj.LastHighlightColor) {</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineplus">+      gColorObj.LastHighlightColor = gDialog.LastPickedColor.getAttribute(</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineplus">+        &quot;LastHighlightColor&quot;</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineplus">+      );</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+    }</span>
<a href="#l11.127"></a><span id="l11.127">     LastPickedColor = gColorObj.LastHighlightColor;</span>
<a href="#l11.128"></a><span id="l11.128">   } else {</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineminus">-    if (!(&quot;LastBackgroundColor&quot; in gColorObj) || !gColorObj.LastBackgroundColor)</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineminus">-      gColorObj.LastBackgroundColor = gDialog.LastPickedColor.getAttribute(&quot;LastBackgroundColor&quot;);</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineplus">+    if (</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineplus">+      !(&quot;LastBackgroundColor&quot; in gColorObj) ||</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineplus">+      !gColorObj.LastBackgroundColor</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineplus">+    ) {</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineplus">+      gColorObj.LastBackgroundColor = gDialog.LastPickedColor.getAttribute(</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineplus">+        &quot;LastBackgroundColor&quot;</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineplus">+      );</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineplus">+    }</span>
<a href="#l11.139"></a><span id="l11.139">     LastPickedColor = gColorObj.LastBackgroundColor;</span>
<a href="#l11.140"></a><span id="l11.140">   }</span>
<a href="#l11.141"></a><span id="l11.141"> </span>
<a href="#l11.142"></a><span id="l11.142">   // Set method to detect clicking on OK button</span>
<a href="#l11.143"></a><span id="l11.143">   //  so we don't get fooled by changing &quot;default&quot; behavior</span>
<a href="#l11.144"></a><span id="l11.144">   gDialog.Ok.setAttribute(&quot;onclick&quot;, &quot;SetDefaultToOk()&quot;);</span>
<a href="#l11.145"></a><span id="l11.145"> </span>
<a href="#l11.146"></a><span id="l11.146">   if (!LastPickedColor) {</span>
<a href="#l11.147"></a><span id="l11.147">     // Hide the button, as there is no last color available.</span>
<a href="#l11.148"></a><span id="l11.148">     gDialog.LastPickedButton.hidden = true;</span>
<a href="#l11.149"></a><span id="l11.149">   } else {</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineminus">-    gDialog.LastPickedColor.setAttribute(&quot;style&quot;, &quot;background-color: &quot; + LastPickedColor);</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineplus">+    gDialog.LastPickedColor.setAttribute(</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineplus">+      &quot;style&quot;,</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineplus">+      &quot;background-color: &quot; + LastPickedColor</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineplus">+    );</span>
<a href="#l11.155"></a><span id="l11.155"> </span>
<a href="#l11.156"></a><span id="l11.156">     // Make &quot;Last-picked&quot; the default button, until the user selects a color.</span>
<a href="#l11.157"></a><span id="l11.157">     gDialog.Ok.removeAttribute(&quot;default&quot;);</span>
<a href="#l11.158"></a><span id="l11.158">     gDialog.LastPickedButton.setAttribute(&quot;default&quot;, &quot;true&quot;);</span>
<a href="#l11.159"></a><span id="l11.159">   }</span>
<a href="#l11.160"></a><span id="l11.160"> </span>
<a href="#l11.161"></a><span id="l11.161">   // Caller can prevent user from submitting an empty, i.e., default color</span>
<a href="#l11.162"></a><span id="l11.162">   NoDefault = gColorObj.NoDefault;</span>
<a href="#l11.163"></a><span id="l11.163">   if (NoDefault) {</span>
<a href="#l11.164"></a><span id="l11.164">     // Hide the &quot;Default button -- user must pick a color</span>
<a href="#l11.165"></a><span id="l11.165">     document.getElementById(&quot;DefaultColorButton&quot;).collapsed = true;</span>
<a href="#l11.166"></a><span id="l11.166">   }</span>
<a href="#l11.167"></a><span id="l11.167"> </span>
<a href="#l11.168"></a><span id="l11.168">   // Set focus to colorpicker if not set to table radio buttons above</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineminus">-  if (!haveTableRadio)</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineplus">+  if (!haveTableRadio) {</span>
<a href="#l11.171"></a><span id="l11.171">     gDialog.ColorPicker.focus();</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineplus">+  }</span>
<a href="#l11.173"></a><span id="l11.173"> </span>
<a href="#l11.174"></a><span id="l11.174">   SetWindowLocation();</span>
<a href="#l11.175"></a><span id="l11.175"> }</span>
<a href="#l11.176"></a><span id="l11.176"> </span>
<a href="#l11.177"></a><span id="l11.177"> function SelectColor() {</span>
<a href="#l11.178"></a><span id="l11.178">   var color = gDialog.ColorPicker.value;</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineminus">-  if (color)</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineplus">+  if (color) {</span>
<a href="#l11.181"></a><span id="l11.181">     SetCurrentColor(color);</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineplus">+  }</span>
<a href="#l11.183"></a><span id="l11.183"> }</span>
<a href="#l11.184"></a><span id="l11.184"> </span>
<a href="#l11.185"></a><span id="l11.185"> function RemoveColor() {</span>
<a href="#l11.186"></a><span id="l11.186">   SetCurrentColor(&quot;&quot;);</span>
<a href="#l11.187"></a><span id="l11.187">   gDialog.ColorInput.focus();</span>
<a href="#l11.188"></a><span id="l11.188">   SetDefaultToOk();</span>
<a href="#l11.189"></a><span id="l11.189"> }</span>
<a href="#l11.190"></a><span id="l11.190"> </span>
<a href="#l11.191"></a><span id="l11.191" class="difflineat">@@ -171,56 +194,61 @@ function SelectColorByKeypress(aEvent) {</span>
<a href="#l11.192"></a><span id="l11.192">   if (aEvent.charCode == aEvent.DOM_VK_SPACE) {</span>
<a href="#l11.193"></a><span id="l11.193">     SelectColor();</span>
<a href="#l11.194"></a><span id="l11.194">     SetDefaultToOk();</span>
<a href="#l11.195"></a><span id="l11.195">   }</span>
<a href="#l11.196"></a><span id="l11.196"> }</span>
<a href="#l11.197"></a><span id="l11.197"> </span>
<a href="#l11.198"></a><span id="l11.198"> function SelectLastPickedColor() {</span>
<a href="#l11.199"></a><span id="l11.199">   SetCurrentColor(LastPickedColor);</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineminus">-  if (onAccept())</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineplus">+  if (onAccept()) {</span>
<a href="#l11.202"></a><span id="l11.202">     // window.close();</span>
<a href="#l11.203"></a><span id="l11.203">     return true;</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineplus">+  }</span>
<a href="#l11.205"></a><span id="l11.205"> </span>
<a href="#l11.206"></a><span id="l11.206">   return false;</span>
<a href="#l11.207"></a><span id="l11.207"> }</span>
<a href="#l11.208"></a><span id="l11.208"> </span>
<a href="#l11.209"></a><span id="l11.209"> function SetCurrentColor(color) {</span>
<a href="#l11.210"></a><span id="l11.210">   // TODO: Validate color?</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineminus">-  if (!color) color = &quot;&quot;;</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineplus">+  if (!color) {</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineplus">+    color = &quot;&quot;;</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineplus">+  }</span>
<a href="#l11.215"></a><span id="l11.215">   gColor = TrimString(color).toLowerCase();</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineminus">-  if (gColor == &quot;mixed&quot;)</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineplus">+  if (gColor == &quot;mixed&quot;) {</span>
<a href="#l11.218"></a><span id="l11.218">     gColor = &quot;&quot;;</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineplus">+  }</span>
<a href="#l11.220"></a><span id="l11.220">   gDialog.ColorInput.value = gColor;</span>
<a href="#l11.221"></a><span id="l11.221">   SetColorSwatch();</span>
<a href="#l11.222"></a><span id="l11.222"> }</span>
<a href="#l11.223"></a><span id="l11.223"> </span>
<a href="#l11.224"></a><span id="l11.224"> function SetColorSwatch() {</span>
<a href="#l11.225"></a><span id="l11.225">   // TODO: DON'T ALLOW SPACES?</span>
<a href="#l11.226"></a><span id="l11.226">   var color = TrimString(gDialog.ColorInput.value);</span>
<a href="#l11.227"></a><span id="l11.227">   if (color) {</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineminus">-    gDialog.ColorSwatch.setAttribute(&quot;style&quot;, (&quot;background-color:&quot; + color));</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineplus">+    gDialog.ColorSwatch.setAttribute(&quot;style&quot;, &quot;background-color:&quot; + color);</span>
<a href="#l11.230"></a><span id="l11.230">     gDialog.ColorSwatch.removeAttribute(&quot;default&quot;);</span>
<a href="#l11.231"></a><span id="l11.231">   } else {</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineminus">-    gDialog.ColorSwatch.setAttribute(&quot;style&quot;, (&quot;background-color:inherit&quot;));</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineplus">+    gDialog.ColorSwatch.setAttribute(&quot;style&quot;, &quot;background-color:inherit&quot;);</span>
<a href="#l11.234"></a><span id="l11.234">     gDialog.ColorSwatch.setAttribute(&quot;default&quot;, &quot;true&quot;);</span>
<a href="#l11.235"></a><span id="l11.235">   }</span>
<a href="#l11.236"></a><span id="l11.236"> }</span>
<a href="#l11.237"></a><span id="l11.237"> </span>
<a href="#l11.238"></a><span id="l11.238"> function SetDefaultToOk() {</span>
<a href="#l11.239"></a><span id="l11.239">   gDialog.LastPickedButton.removeAttribute(&quot;default&quot;);</span>
<a href="#l11.240"></a><span id="l11.240">   gDialog.Ok.setAttribute(&quot;default&quot;, &quot;true&quot;);</span>
<a href="#l11.241"></a><span id="l11.241">   LastPickedIsDefault = false;</span>
<a href="#l11.242"></a><span id="l11.242"> }</span>
<a href="#l11.243"></a><span id="l11.243"> </span>
<a href="#l11.244"></a><span id="l11.244"> function ValidateData() {</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineminus">-  if (LastPickedIsDefault)</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineplus">+  if (LastPickedIsDefault) {</span>
<a href="#l11.247"></a><span id="l11.247">     gColor = LastPickedColor;</span>
<a href="#l11.248"></a><span id="l11.248" class="difflineminus">-  else</span>
<a href="#l11.249"></a><span id="l11.249" class="difflineplus">+  } else {</span>
<a href="#l11.250"></a><span id="l11.250">     gColor = gDialog.ColorInput.value;</span>
<a href="#l11.251"></a><span id="l11.251" class="difflineplus">+  }</span>
<a href="#l11.252"></a><span id="l11.252"> </span>
<a href="#l11.253"></a><span id="l11.253">   gColor = TrimString(gColor).toLowerCase();</span>
<a href="#l11.254"></a><span id="l11.254"> </span>
<a href="#l11.255"></a><span id="l11.255">   // TODO: Validate the color string!</span>
<a href="#l11.256"></a><span id="l11.256"> </span>
<a href="#l11.257"></a><span id="l11.257">   if (NoDefault &amp;&amp; !gColor) {</span>
<a href="#l11.258"></a><span id="l11.258">     ShowInputErrorMessage(GetString(&quot;NoColorError&quot;));</span>
<a href="#l11.259"></a><span id="l11.259">     SetTextboxFocus(gDialog.ColorInput);</span>
<a href="#l11.260"></a><span id="l11.260" class="difflineat">@@ -250,18 +278,19 @@ function onAccept(event) {</span>
<a href="#l11.261"></a><span id="l11.261">     }</span>
<a href="#l11.262"></a><span id="l11.262">   } else {</span>
<a href="#l11.263"></a><span id="l11.263">     gColorObj.BackgroundColor = gColor;</span>
<a href="#l11.264"></a><span id="l11.264">     if (gColor.length &gt; 0) {</span>
<a href="#l11.265"></a><span id="l11.265">       gDialog.LastPickedColor.setAttribute(&quot;LastBackgroundColor&quot;, gColor);</span>
<a href="#l11.266"></a><span id="l11.266">       gColorObj.LastBackgroundColor = gColor;</span>
<a href="#l11.267"></a><span id="l11.267">     }</span>
<a href="#l11.268"></a><span id="l11.268">     // If table or cell requested, tell caller which element to set on</span>
<a href="#l11.269"></a><span id="l11.269" class="difflineminus">-    if (TableOrCell &amp;&amp; gDialog.TableRadio.selected)</span>
<a href="#l11.270"></a><span id="l11.270" class="difflineplus">+    if (TableOrCell &amp;&amp; gDialog.TableRadio.selected) {</span>
<a href="#l11.271"></a><span id="l11.271">       gColorObj.Type = &quot;Table&quot;;</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineplus">+    }</span>
<a href="#l11.273"></a><span id="l11.273">   }</span>
<a href="#l11.274"></a><span id="l11.274">   SaveWindowLocation();</span>
<a href="#l11.275"></a><span id="l11.275"> }</span>
<a href="#l11.276"></a><span id="l11.276"> </span>
<a href="#l11.277"></a><span id="l11.277"> function onCancelColor() {</span>
<a href="#l11.278"></a><span id="l11.278">   // Tells caller that user canceled</span>
<a href="#l11.279"></a><span id="l11.279">   gColorObj.Cancel = true;</span>
<a href="#l11.280"></a><span id="l11.280">   SaveWindowLocation();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdColorProps.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdColorProps.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -25,27 +25,27 @@ var prefs;</span>
<a href="#l12.4"></a><span id="l12.4"> var gBackgroundImage;</span>
<a href="#l12.5"></a><span id="l12.5"> </span>
<a href="#l12.6"></a><span id="l12.6"> // Initialize in case we can't get them from prefs???</span>
<a href="#l12.7"></a><span id="l12.7"> var defaultTextColor = &quot;#000000&quot;;</span>
<a href="#l12.8"></a><span id="l12.8"> var defaultLinkColor = &quot;#000099&quot;;</span>
<a href="#l12.9"></a><span id="l12.9"> var defaultActiveColor = &quot;#000099&quot;;</span>
<a href="#l12.10"></a><span id="l12.10"> var defaultVisitedColor = &quot;#990099&quot;;</span>
<a href="#l12.11"></a><span id="l12.11"> var defaultBackgroundColor = &quot;#FFFFFF&quot;;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-const styleStr =       &quot;style&quot;;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-const textStr =        &quot;text&quot;;</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-const linkStr =        &quot;link&quot;;</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-const vlinkStr =       &quot;vlink&quot;;</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-const alinkStr =       &quot;alink&quot;;</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-const bgcolorStr =     &quot;bgcolor&quot;;</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-const backgroundStr =  &quot;background&quot;;</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+const styleStr = &quot;style&quot;;</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+const textStr = &quot;text&quot;;</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+const linkStr = &quot;link&quot;;</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+const vlinkStr = &quot;vlink&quot;;</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+const alinkStr = &quot;alink&quot;;</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+const bgcolorStr = &quot;bgcolor&quot;;</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+const backgroundStr = &quot;background&quot;;</span>
<a href="#l12.26"></a><span id="l12.26"> const cssColorStr = &quot;color&quot;;</span>
<a href="#l12.27"></a><span id="l12.27"> const cssBackgroundColorStr = &quot;background-color&quot;;</span>
<a href="#l12.28"></a><span id="l12.28"> const cssBackgroundImageStr = &quot;background-image&quot;;</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-const colorStyle =     cssColorStr + &quot;: &quot;;</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+const colorStyle = cssColorStr + &quot;: &quot;;</span>
<a href="#l12.31"></a><span id="l12.31"> const backColorStyle = cssBackgroundColorStr + &quot;: &quot;;</span>
<a href="#l12.32"></a><span id="l12.32"> const backImageStyle = &quot;; &quot; + cssBackgroundImageStr + &quot;: url(&quot;;</span>
<a href="#l12.33"></a><span id="l12.33"> </span>
<a href="#l12.34"></a><span id="l12.34"> var customTextColor;</span>
<a href="#l12.35"></a><span id="l12.35"> var customLinkColor;</span>
<a href="#l12.36"></a><span id="l12.36"> var customActiveColor;</span>
<a href="#l12.37"></a><span id="l12.37"> var customVisitedColor;</span>
<a href="#l12.38"></a><span id="l12.38"> var customBackgroundColor;</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineat">@@ -62,17 +62,19 @@ function Startup() {</span>
<a href="#l12.40"></a><span id="l12.40">   gDialog.ColorPreview = document.getElementById(&quot;ColorPreview&quot;);</span>
<a href="#l12.41"></a><span id="l12.41">   gDialog.NormalText = document.getElementById(&quot;NormalText&quot;);</span>
<a href="#l12.42"></a><span id="l12.42">   gDialog.LinkText = document.getElementById(&quot;LinkText&quot;);</span>
<a href="#l12.43"></a><span id="l12.43">   gDialog.ActiveLinkText = document.getElementById(&quot;ActiveLinkText&quot;);</span>
<a href="#l12.44"></a><span id="l12.44">   gDialog.VisitedLinkText = document.getElementById(&quot;VisitedLinkText&quot;);</span>
<a href="#l12.45"></a><span id="l12.45">   gDialog.PageColorGroup = document.getElementById(&quot;PageColorGroup&quot;);</span>
<a href="#l12.46"></a><span id="l12.46">   gDialog.DefaultColorsRadio = document.getElementById(&quot;DefaultColorsRadio&quot;);</span>
<a href="#l12.47"></a><span id="l12.47">   gDialog.CustomColorsRadio = document.getElementById(&quot;CustomColorsRadio&quot;);</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineminus">-  gDialog.BackgroundImageInput = document.getElementById(&quot;BackgroundImageInput&quot;);</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+  gDialog.BackgroundImageInput = document.getElementById(</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+    &quot;BackgroundImageInput&quot;</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+  );</span>
<a href="#l12.52"></a><span id="l12.52"> </span>
<a href="#l12.53"></a><span id="l12.53">   try {</span>
<a href="#l12.54"></a><span id="l12.54">     gBodyElement = editor.rootElement;</span>
<a href="#l12.55"></a><span id="l12.55">   } catch (e) {}</span>
<a href="#l12.56"></a><span id="l12.56"> </span>
<a href="#l12.57"></a><span id="l12.57">   if (!gBodyElement) {</span>
<a href="#l12.58"></a><span id="l12.58">     dump(&quot;Failed to get BODY element!\n&quot;);</span>
<a href="#l12.59"></a><span id="l12.59">     window.close();</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineat">@@ -83,89 +85,121 @@ function Startup() {</span>
<a href="#l12.61"></a><span id="l12.61"> </span>
<a href="#l12.62"></a><span id="l12.62">   // Initialize default colors from browser prefs</span>
<a href="#l12.63"></a><span id="l12.63">   var browserColors = GetDefaultBrowserColors();</span>
<a href="#l12.64"></a><span id="l12.64">   if (browserColors) {</span>
<a href="#l12.65"></a><span id="l12.65">     // Use author's browser pref colors passed into dialog</span>
<a href="#l12.66"></a><span id="l12.66">     defaultTextColor = browserColors.TextColor;</span>
<a href="#l12.67"></a><span id="l12.67">     defaultLinkColor = browserColors.LinkColor;</span>
<a href="#l12.68"></a><span id="l12.68">     defaultActiveColor = browserColors.ActiveLinkColor;</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineminus">-    defaultVisitedColor =  browserColors.VisitedLinkColor;</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineminus">-    defaultBackgroundColor =  browserColors.BackgroundColor;</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineplus">+    defaultVisitedColor = browserColors.VisitedLinkColor;</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+    defaultBackgroundColor = browserColors.BackgroundColor;</span>
<a href="#l12.73"></a><span id="l12.73">   }</span>
<a href="#l12.74"></a><span id="l12.74"> </span>
<a href="#l12.75"></a><span id="l12.75">   // We only need to test for this once per dialog load</span>
<a href="#l12.76"></a><span id="l12.76">   gHaveDocumentUrl = GetDocumentBaseUrl();</span>
<a href="#l12.77"></a><span id="l12.77"> </span>
<a href="#l12.78"></a><span id="l12.78">   InitDialog();</span>
<a href="#l12.79"></a><span id="l12.79"> </span>
<a href="#l12.80"></a><span id="l12.80">   gDialog.PageColorGroup.focus();</span>
<a href="#l12.81"></a><span id="l12.81"> </span>
<a href="#l12.82"></a><span id="l12.82">   SetWindowLocation();</span>
<a href="#l12.83"></a><span id="l12.83"> }</span>
<a href="#l12.84"></a><span id="l12.84"> </span>
<a href="#l12.85"></a><span id="l12.85"> function InitDialog() {</span>
<a href="#l12.86"></a><span id="l12.86">   // Get image from document</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineminus">-  gBackgroundImage = GetHTMLOrCSSStyleValue(globalElement, backgroundStr, cssBackgroundImageStr);</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineminus">-  if (/url\((.*)\)/.test(gBackgroundImage))</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+  gBackgroundImage = GetHTMLOrCSSStyleValue(</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+    globalElement,</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+    backgroundStr,</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+    cssBackgroundImageStr</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+  );</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+  if (/url\((.*)\)/.test(gBackgroundImage)) {</span>
<a href="#l12.95"></a><span id="l12.95">     gBackgroundImage = RegExp.$1;</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+  }</span>
<a href="#l12.97"></a><span id="l12.97"> </span>
<a href="#l12.98"></a><span id="l12.98">   if (gBackgroundImage) {</span>
<a href="#l12.99"></a><span id="l12.99">     // Shorten data URIs for display.</span>
<a href="#l12.100"></a><span id="l12.100">     shortenImageData(gBackgroundImage, gDialog.BackgroundImageInput);</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineminus">-    gDialog.ColorPreview.setAttribute(styleStr, backImageStyle + gBackgroundImage + &quot;);&quot;);</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineplus">+    gDialog.ColorPreview.setAttribute(</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineplus">+      styleStr,</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+      backImageStyle + gBackgroundImage + &quot;);&quot;</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineplus">+    );</span>
<a href="#l12.106"></a><span id="l12.106">   }</span>
<a href="#l12.107"></a><span id="l12.107"> </span>
<a href="#l12.108"></a><span id="l12.108">   SetRelativeCheckbox();</span>
<a href="#l12.109"></a><span id="l12.109"> </span>
<a href="#l12.110"></a><span id="l12.110" class="difflineminus">-  customTextColor        = GetHTMLOrCSSStyleValue(globalElement, textStr, cssColorStr);</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineminus">-  customTextColor        = ConvertRGBColorIntoHEXColor(customTextColor);</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineminus">-  customLinkColor        = globalElement.getAttribute(linkStr);</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineminus">-  customActiveColor      = globalElement.getAttribute(alinkStr);</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineminus">-  customVisitedColor     = globalElement.getAttribute(vlinkStr);</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineminus">-  customBackgroundColor  = GetHTMLOrCSSStyleValue(globalElement, bgcolorStr, cssBackgroundColorStr);</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineminus">-  customBackgroundColor  = ConvertRGBColorIntoHEXColor(customBackgroundColor);</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineplus">+  customTextColor = GetHTMLOrCSSStyleValue(globalElement, textStr, cssColorStr);</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+  customTextColor = ConvertRGBColorIntoHEXColor(customTextColor);</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineplus">+  customLinkColor = globalElement.getAttribute(linkStr);</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineplus">+  customActiveColor = globalElement.getAttribute(alinkStr);</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineplus">+  customVisitedColor = globalElement.getAttribute(vlinkStr);</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineplus">+  customBackgroundColor = GetHTMLOrCSSStyleValue(</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineplus">+    globalElement,</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineplus">+    bgcolorStr,</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineplus">+    cssBackgroundColorStr</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineplus">+  );</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineplus">+  customBackgroundColor = ConvertRGBColorIntoHEXColor(customBackgroundColor);</span>
<a href="#l12.128"></a><span id="l12.128"> </span>
<a href="#l12.129"></a><span id="l12.129">   var haveCustomColor =</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineminus">-        customTextColor ||</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineminus">-        customLinkColor ||</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineminus">-        customVisitedColor ||</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineminus">-        customActiveColor ||</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineminus">-        customBackgroundColor;</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineplus">+    customTextColor ||</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineplus">+    customLinkColor ||</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineplus">+    customVisitedColor ||</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineplus">+    customActiveColor ||</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineplus">+    customBackgroundColor;</span>
<a href="#l12.140"></a><span id="l12.140"> </span>
<a href="#l12.141"></a><span id="l12.141">   // Set default color explicitly for any that are missing</span>
<a href="#l12.142"></a><span id="l12.142">   // PROBLEM: We are using &quot;windowtext&quot; and &quot;window&quot; for the Windows OS</span>
<a href="#l12.143"></a><span id="l12.143">   //   default color values. This works with CSS in preview window,</span>
<a href="#l12.144"></a><span id="l12.144">   //   but we should NOT use these as values for HTML attributes!</span>
<a href="#l12.145"></a><span id="l12.145"> </span>
<a href="#l12.146"></a><span id="l12.146" class="difflineminus">-  if (!customTextColor) customTextColor = defaultTextColor;</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineminus">-  if (!customLinkColor) customLinkColor = defaultLinkColor;</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineminus">-  if (!customActiveColor) customActiveColor = defaultActiveColor;</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineminus">-  if (!customVisitedColor) customVisitedColor = defaultVisitedColor;</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineminus">-  if (!customBackgroundColor) customBackgroundColor = defaultBackgroundColor;</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineplus">+  if (!customTextColor) {</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineplus">+    customTextColor = defaultTextColor;</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+  }</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineplus">+  if (!customLinkColor) {</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineplus">+    customLinkColor = defaultLinkColor;</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineplus">+  }</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineplus">+  if (!customActiveColor) {</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineplus">+    customActiveColor = defaultActiveColor;</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineplus">+  }</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineplus">+  if (!customVisitedColor) {</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineplus">+    customVisitedColor = defaultVisitedColor;</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineplus">+  }</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineplus">+  if (!customBackgroundColor) {</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineplus">+    customBackgroundColor = defaultBackgroundColor;</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineplus">+  }</span>
<a href="#l12.166"></a><span id="l12.166"> </span>
<a href="#l12.167"></a><span id="l12.167">   if (haveCustomColor) {</span>
<a href="#l12.168"></a><span id="l12.168">     // If any colors are set, then check the &quot;Custom&quot; radio button</span>
<a href="#l12.169"></a><span id="l12.169">     gDialog.PageColorGroup.selectedItem = gDialog.CustomColorsRadio;</span>
<a href="#l12.170"></a><span id="l12.170">     UseCustomColors();</span>
<a href="#l12.171"></a><span id="l12.171">   } else {</span>
<a href="#l12.172"></a><span id="l12.172">     gDialog.PageColorGroup.selectedItem = gDialog.DefaultColorsRadio;</span>
<a href="#l12.173"></a><span id="l12.173">     UseDefaultColors();</span>
<a href="#l12.174"></a><span id="l12.174">   }</span>
<a href="#l12.175"></a><span id="l12.175"> }</span>
<a href="#l12.176"></a><span id="l12.176"> </span>
<a href="#l12.177"></a><span id="l12.177"> function GetColorAndUpdate(ColorWellID) {</span>
<a href="#l12.178"></a><span id="l12.178">   // Only allow selecting when in custom mode</span>
<a href="#l12.179"></a><span id="l12.179" class="difflineminus">-  if (!gDialog.CustomColorsRadio.selected) return;</span>
<a href="#l12.180"></a><span id="l12.180" class="difflineplus">+  if (!gDialog.CustomColorsRadio.selected) {</span>
<a href="#l12.181"></a><span id="l12.181" class="difflineplus">+    return;</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineplus">+  }</span>
<a href="#l12.183"></a><span id="l12.183"> </span>
<a href="#l12.184"></a><span id="l12.184">   var colorWell = document.getElementById(ColorWellID);</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineminus">-  if (!colorWell) return;</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineplus">+  if (!colorWell) {</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineplus">+    return;</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineplus">+  }</span>
<a href="#l12.189"></a><span id="l12.189"> </span>
<a href="#l12.190"></a><span id="l12.190">   // Don't allow a blank color, i.e., using the &quot;default&quot;</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineminus">-  var colorObj = { NoDefault: true, Type: &quot;&quot;, TextColor: 0, PageColor: 0, Cancel: false };</span>
<a href="#l12.192"></a><span id="l12.192" class="difflineplus">+  var colorObj = {</span>
<a href="#l12.193"></a><span id="l12.193" class="difflineplus">+    NoDefault: true,</span>
<a href="#l12.194"></a><span id="l12.194" class="difflineplus">+    Type: &quot;&quot;,</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineplus">+    TextColor: 0,</span>
<a href="#l12.196"></a><span id="l12.196" class="difflineplus">+    PageColor: 0,</span>
<a href="#l12.197"></a><span id="l12.197" class="difflineplus">+    Cancel: false,</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineplus">+  };</span>
<a href="#l12.199"></a><span id="l12.199"> </span>
<a href="#l12.200"></a><span id="l12.200">   switch (ColorWellID) {</span>
<a href="#l12.201"></a><span id="l12.201">     case &quot;textCW&quot;:</span>
<a href="#l12.202"></a><span id="l12.202">       colorObj.Type = &quot;Text&quot;;</span>
<a href="#l12.203"></a><span id="l12.203">       colorObj.TextColor = customTextColor;</span>
<a href="#l12.204"></a><span id="l12.204">       break;</span>
<a href="#l12.205"></a><span id="l12.205">     case &quot;linkCW&quot;:</span>
<a href="#l12.206"></a><span id="l12.206">       colorObj.Type = &quot;Link&quot;;</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineat">@@ -180,21 +214,28 @@ function GetColorAndUpdate(ColorWellID) </span>
<a href="#l12.208"></a><span id="l12.208">       colorObj.TextColor = customVisitedColor;</span>
<a href="#l12.209"></a><span id="l12.209">       break;</span>
<a href="#l12.210"></a><span id="l12.210">     case &quot;backgroundCW&quot;:</span>
<a href="#l12.211"></a><span id="l12.211">       colorObj.Type = &quot;Page&quot;;</span>
<a href="#l12.212"></a><span id="l12.212">       colorObj.PageColor = customBackgroundColor;</span>
<a href="#l12.213"></a><span id="l12.213">       break;</span>
<a href="#l12.214"></a><span id="l12.214">   }</span>
<a href="#l12.215"></a><span id="l12.215"> </span>
<a href="#l12.216"></a><span id="l12.216" class="difflineminus">-  window.openDialog(&quot;chrome://editor/content/EdColorPicker.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, &quot;&quot;, colorObj);</span>
<a href="#l12.217"></a><span id="l12.217" class="difflineplus">+  window.openDialog(</span>
<a href="#l12.218"></a><span id="l12.218" class="difflineplus">+    &quot;chrome://editor/content/EdColorPicker.xul&quot;,</span>
<a href="#l12.219"></a><span id="l12.219" class="difflineplus">+    &quot;_blank&quot;,</span>
<a href="#l12.220"></a><span id="l12.220" class="difflineplus">+    &quot;chrome,close,titlebar,modal&quot;,</span>
<a href="#l12.221"></a><span id="l12.221" class="difflineplus">+    &quot;&quot;,</span>
<a href="#l12.222"></a><span id="l12.222" class="difflineplus">+    colorObj</span>
<a href="#l12.223"></a><span id="l12.223" class="difflineplus">+  );</span>
<a href="#l12.224"></a><span id="l12.224"> </span>
<a href="#l12.225"></a><span id="l12.225">   // User canceled the dialog</span>
<a href="#l12.226"></a><span id="l12.226" class="difflineminus">-  if (colorObj.Cancel)</span>
<a href="#l12.227"></a><span id="l12.227" class="difflineplus">+  if (colorObj.Cancel) {</span>
<a href="#l12.228"></a><span id="l12.228">     return;</span>
<a href="#l12.229"></a><span id="l12.229" class="difflineplus">+  }</span>
<a href="#l12.230"></a><span id="l12.230"> </span>
<a href="#l12.231"></a><span id="l12.231">   var color = &quot;&quot;;</span>
<a href="#l12.232"></a><span id="l12.232">   switch (ColorWellID) {</span>
<a href="#l12.233"></a><span id="l12.233">     case &quot;textCW&quot;:</span>
<a href="#l12.234"></a><span id="l12.234">       color = customTextColor = colorObj.TextColor;</span>
<a href="#l12.235"></a><span id="l12.235">       break;</span>
<a href="#l12.236"></a><span id="l12.236">     case &quot;linkCW&quot;:</span>
<a href="#l12.237"></a><span id="l12.237">       color = customLinkColor = colorObj.TextColor;</span>
<a href="#l12.238"></a><span id="l12.238" class="difflineat">@@ -226,18 +267,19 @@ function SetColorPreview(ColorWellID, co</span>
<a href="#l12.239"></a><span id="l12.239">       gDialog.ActiveLinkText.setAttribute(styleStr, colorStyle + color);</span>
<a href="#l12.240"></a><span id="l12.240">       break;</span>
<a href="#l12.241"></a><span id="l12.241">     case &quot;visitedCW&quot;:</span>
<a href="#l12.242"></a><span id="l12.242">       gDialog.VisitedLinkText.setAttribute(styleStr, colorStyle + color);</span>
<a href="#l12.243"></a><span id="l12.243">       break;</span>
<a href="#l12.244"></a><span id="l12.244">     case &quot;backgroundCW&quot;:</span>
<a href="#l12.245"></a><span id="l12.245">       // Must combine background color and image style values</span>
<a href="#l12.246"></a><span id="l12.246">       var styleValue = backColorStyle + color;</span>
<a href="#l12.247"></a><span id="l12.247" class="difflineminus">-      if (gBackgroundImage)</span>
<a href="#l12.248"></a><span id="l12.248" class="difflineplus">+      if (gBackgroundImage) {</span>
<a href="#l12.249"></a><span id="l12.249">         styleValue += &quot;;&quot; + backImageStyle + gBackgroundImage + &quot;);&quot;;</span>
<a href="#l12.250"></a><span id="l12.250" class="difflineplus">+      }</span>
<a href="#l12.251"></a><span id="l12.251"> </span>
<a href="#l12.252"></a><span id="l12.252">       gDialog.ColorPreview.setAttribute(styleStr, styleValue);</span>
<a href="#l12.253"></a><span id="l12.253">       previewBGColor = color;</span>
<a href="#l12.254"></a><span id="l12.254">       break;</span>
<a href="#l12.255"></a><span id="l12.255">   }</span>
<a href="#l12.256"></a><span id="l12.256"> }</span>
<a href="#l12.257"></a><span id="l12.257"> </span>
<a href="#l12.258"></a><span id="l12.258"> function UseCustomColors() {</span>
<a href="#l12.259"></a><span id="l12.259" class="difflineat">@@ -291,18 +333,19 @@ function UseDefaultColors() {</span>
<a href="#l12.260"></a><span id="l12.260">   SetElementEnabledById(&quot;Visited&quot;, false);</span>
<a href="#l12.261"></a><span id="l12.261">   SetElementEnabledById(&quot;Background&quot;, false);</span>
<a href="#l12.262"></a><span id="l12.262"> }</span>
<a href="#l12.263"></a><span id="l12.263"> </span>
<a href="#l12.264"></a><span id="l12.264"> function chooseFile() {</span>
<a href="#l12.265"></a><span id="l12.265">   // Get a local image file, converted into URL format</span>
<a href="#l12.266"></a><span id="l12.266">   GetLocalFileURL(&quot;img&quot;).then(fileURL =&gt; {</span>
<a href="#l12.267"></a><span id="l12.267">     // Always try to relativize local file URLs</span>
<a href="#l12.268"></a><span id="l12.268" class="difflineminus">-    if (gHaveDocumentUrl)</span>
<a href="#l12.269"></a><span id="l12.269" class="difflineplus">+    if (gHaveDocumentUrl) {</span>
<a href="#l12.270"></a><span id="l12.270">       fileURL = MakeRelativeUrl(fileURL);</span>
<a href="#l12.271"></a><span id="l12.271" class="difflineplus">+    }</span>
<a href="#l12.272"></a><span id="l12.272"> </span>
<a href="#l12.273"></a><span id="l12.273">     gDialog.BackgroundImageInput.value = fileURL;</span>
<a href="#l12.274"></a><span id="l12.274"> </span>
<a href="#l12.275"></a><span id="l12.275">     SetRelativeCheckbox();</span>
<a href="#l12.276"></a><span id="l12.276">     ValidateAndPreviewImage(true);</span>
<a href="#l12.277"></a><span id="l12.277">     SetTextboxFocus(gDialog.BackgroundImageInput);</span>
<a href="#l12.278"></a><span id="l12.278">   });</span>
<a href="#l12.279"></a><span id="l12.279"> }</span>
<a href="#l12.280"></a><span id="l12.280" class="difflineat">@@ -350,50 +393,63 @@ function ValidateData() {</span>
<a href="#l12.281"></a><span id="l12.281">       globalElement.removeAttribute(vlinkStr);</span>
<a href="#l12.282"></a><span id="l12.282">       globalElement.removeAttribute(alinkStr);</span>
<a href="#l12.283"></a><span id="l12.283">       editor.removeAttributeOrEquivalent(globalElement, bgcolorStr, true);</span>
<a href="#l12.284"></a><span id="l12.284">     } else {</span>
<a href="#l12.285"></a><span id="l12.285">       // Do NOT accept the CSS &quot;WindowsOS&quot; color strings!</span>
<a href="#l12.286"></a><span id="l12.286">       // Problem: We really should try to get the actual color values</span>
<a href="#l12.287"></a><span id="l12.287">       //  from windows, but I don't know how to do that!</span>
<a href="#l12.288"></a><span id="l12.288">       var tmpColor = customTextColor.toLowerCase();</span>
<a href="#l12.289"></a><span id="l12.289" class="difflineminus">-      if (tmpColor != &quot;windowtext&quot;)</span>
<a href="#l12.290"></a><span id="l12.290" class="difflineminus">-        editor.setAttributeOrEquivalent(globalElement, textStr,</span>
<a href="#l12.291"></a><span id="l12.291" class="difflineminus">-                                        customTextColor, true);</span>
<a href="#l12.292"></a><span id="l12.292" class="difflineminus">-      else</span>
<a href="#l12.293"></a><span id="l12.293" class="difflineplus">+      if (tmpColor != &quot;windowtext&quot;) {</span>
<a href="#l12.294"></a><span id="l12.294" class="difflineplus">+        editor.setAttributeOrEquivalent(</span>
<a href="#l12.295"></a><span id="l12.295" class="difflineplus">+          globalElement,</span>
<a href="#l12.296"></a><span id="l12.296" class="difflineplus">+          textStr,</span>
<a href="#l12.297"></a><span id="l12.297" class="difflineplus">+          customTextColor,</span>
<a href="#l12.298"></a><span id="l12.298" class="difflineplus">+          true</span>
<a href="#l12.299"></a><span id="l12.299" class="difflineplus">+        );</span>
<a href="#l12.300"></a><span id="l12.300" class="difflineplus">+      } else {</span>
<a href="#l12.301"></a><span id="l12.301">         editor.removeAttributeOrEquivalent(globalElement, textStr, true);</span>
<a href="#l12.302"></a><span id="l12.302" class="difflineplus">+      }</span>
<a href="#l12.303"></a><span id="l12.303"> </span>
<a href="#l12.304"></a><span id="l12.304">       tmpColor = customBackgroundColor.toLowerCase();</span>
<a href="#l12.305"></a><span id="l12.305" class="difflineminus">-      if (tmpColor != &quot;window&quot;)</span>
<a href="#l12.306"></a><span id="l12.306" class="difflineminus">-        editor.setAttributeOrEquivalent(globalElement, bgcolorStr, customBackgroundColor, true);</span>
<a href="#l12.307"></a><span id="l12.307" class="difflineminus">-      else</span>
<a href="#l12.308"></a><span id="l12.308" class="difflineplus">+      if (tmpColor != &quot;window&quot;) {</span>
<a href="#l12.309"></a><span id="l12.309" class="difflineplus">+        editor.setAttributeOrEquivalent(</span>
<a href="#l12.310"></a><span id="l12.310" class="difflineplus">+          globalElement,</span>
<a href="#l12.311"></a><span id="l12.311" class="difflineplus">+          bgcolorStr,</span>
<a href="#l12.312"></a><span id="l12.312" class="difflineplus">+          customBackgroundColor,</span>
<a href="#l12.313"></a><span id="l12.313" class="difflineplus">+          true</span>
<a href="#l12.314"></a><span id="l12.314" class="difflineplus">+        );</span>
<a href="#l12.315"></a><span id="l12.315" class="difflineplus">+      } else {</span>
<a href="#l12.316"></a><span id="l12.316">         editor.removeAttributeOrEquivalent(globalElement, bgcolorStr, true);</span>
<a href="#l12.317"></a><span id="l12.317" class="difflineplus">+      }</span>
<a href="#l12.318"></a><span id="l12.318"> </span>
<a href="#l12.319"></a><span id="l12.319">       globalElement.setAttribute(linkStr, customLinkColor);</span>
<a href="#l12.320"></a><span id="l12.320">       globalElement.setAttribute(vlinkStr, customVisitedColor);</span>
<a href="#l12.321"></a><span id="l12.321">       globalElement.setAttribute(alinkStr, customActiveColor);</span>
<a href="#l12.322"></a><span id="l12.322">     }</span>
<a href="#l12.323"></a><span id="l12.323"> </span>
<a href="#l12.324"></a><span id="l12.324">     if (ValidateAndPreviewImage(true)) {</span>
<a href="#l12.325"></a><span id="l12.325">       // A valid image may be null for no image</span>
<a href="#l12.326"></a><span id="l12.326" class="difflineminus">-      if (gBackgroundImage)</span>
<a href="#l12.327"></a><span id="l12.327" class="difflineplus">+      if (gBackgroundImage) {</span>
<a href="#l12.328"></a><span id="l12.328">         globalElement.setAttribute(backgroundStr, gBackgroundImage);</span>
<a href="#l12.329"></a><span id="l12.329" class="difflineminus">-      else</span>
<a href="#l12.330"></a><span id="l12.330" class="difflineplus">+      } else {</span>
<a href="#l12.331"></a><span id="l12.331">         editor.removeAttributeOrEquivalent(globalElement, backgroundStr, true);</span>
<a href="#l12.332"></a><span id="l12.332" class="difflineplus">+      }</span>
<a href="#l12.333"></a><span id="l12.333"> </span>
<a href="#l12.334"></a><span id="l12.334">       return true;</span>
<a href="#l12.335"></a><span id="l12.335">     }</span>
<a href="#l12.336"></a><span id="l12.336">   } catch (e) {}</span>
<a href="#l12.337"></a><span id="l12.337">   return false;</span>
<a href="#l12.338"></a><span id="l12.338"> }</span>
<a href="#l12.339"></a><span id="l12.339"> </span>
<a href="#l12.340"></a><span id="l12.340"> function onAccept(event) {</span>
<a href="#l12.341"></a><span id="l12.341">   // If it's a file, convert to a data URL.</span>
<a href="#l12.342"></a><span id="l12.342">   if (gBackgroundImage &amp;&amp; /^file:/i.test(gBackgroundImage)) {</span>
<a href="#l12.343"></a><span id="l12.343" class="difflineminus">-    let nsFile = Services.io.newURI(gBackgroundImage)</span>
<a href="#l12.344"></a><span id="l12.344" class="difflineplus">+    let nsFile = Services.io</span>
<a href="#l12.345"></a><span id="l12.345" class="difflineplus">+      .newURI(gBackgroundImage)</span>
<a href="#l12.346"></a><span id="l12.346">       .QueryInterface(Ci.nsIFileURL).file;</span>
<a href="#l12.347"></a><span id="l12.347">     if (nsFile.exists()) {</span>
<a href="#l12.348"></a><span id="l12.348">       let reader = new FileReader();</span>
<a href="#l12.349"></a><span id="l12.349">       reader.addEventListener(&quot;load&quot;, function() {</span>
<a href="#l12.350"></a><span id="l12.350">         gBackgroundImage = reader.result;</span>
<a href="#l12.351"></a><span id="l12.351">         gDialog.BackgroundImageInput.value = reader.result;</span>
<a href="#l12.352"></a><span id="l12.352">         if (onAccept(event)) {</span>
<a href="#l12.353"></a><span id="l12.353">           window.close();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdConvertToTable.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdConvertToTable.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -15,23 +15,25 @@ var gOtherIndex = &quot;2&quot;;</span>
<a href="#l13.4"></a><span id="l13.4"> </span>
<a href="#l13.5"></a><span id="l13.5"> // dialog initialization code</span>
<a href="#l13.6"></a><span id="l13.6"> function Startup() {</span>
<a href="#l13.7"></a><span id="l13.7">   if (!GetCurrentEditor()) {</span>
<a href="#l13.8"></a><span id="l13.8">     window.close();</span>
<a href="#l13.9"></a><span id="l13.9">     return;</span>
<a href="#l13.10"></a><span id="l13.10">   }</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-  gDialog.sepRadioGroup      = document.getElementById(&quot;SepRadioGroup&quot;);</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-  gDialog.sepCharacterInput  = document.getElementById(&quot;SepCharacterInput&quot;);</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+  gDialog.sepRadioGroup = document.getElementById(&quot;SepRadioGroup&quot;);</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+  gDialog.sepCharacterInput = document.getElementById(&quot;SepCharacterInput&quot;);</span>
<a href="#l13.16"></a><span id="l13.16">   gDialog.deleteSepCharacter = document.getElementById(&quot;DeleteSepCharacter&quot;);</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-  gDialog.collapseSpaces     = document.getElementById(&quot;CollapseSpaces&quot;);</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+  gDialog.collapseSpaces = document.getElementById(&quot;CollapseSpaces&quot;);</span>
<a href="#l13.19"></a><span id="l13.19"> </span>
<a href="#l13.20"></a><span id="l13.20">   // We persist the user's separator character</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-  gDialog.sepCharacterInput.value = gDialog.sepRadioGroup.getAttribute(&quot;character&quot;);</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+  gDialog.sepCharacterInput.value = gDialog.sepRadioGroup.getAttribute(</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+    &quot;character&quot;</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+  );</span>
<a href="#l13.25"></a><span id="l13.25"> </span>
<a href="#l13.26"></a><span id="l13.26">   gIndex = gDialog.sepRadioGroup.getAttribute(&quot;index&quot;);</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28">   switch (gIndex) {</span>
<a href="#l13.29"></a><span id="l13.29">     case gCommaIndex:</span>
<a href="#l13.30"></a><span id="l13.30">     default:</span>
<a href="#l13.31"></a><span id="l13.31">       gDialog.sepRadioGroup.selectedItem = document.getElementById(&quot;comma&quot;);</span>
<a href="#l13.32"></a><span id="l13.32">       break;</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineat">@@ -48,22 +50,24 @@ function Startup() {</span>
<a href="#l13.34"></a><span id="l13.34"> </span>
<a href="#l13.35"></a><span id="l13.35">   SetWindowLocation();</span>
<a href="#l13.36"></a><span id="l13.36"> }</span>
<a href="#l13.37"></a><span id="l13.37"> </span>
<a href="#l13.38"></a><span id="l13.38"> function InputSepCharacter() {</span>
<a href="#l13.39"></a><span id="l13.39">   var str = gDialog.sepCharacterInput.value;</span>
<a href="#l13.40"></a><span id="l13.40"> </span>
<a href="#l13.41"></a><span id="l13.41">   // Limit input to 1 character</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-  if (str.length &gt; 1)</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+  if (str.length &gt; 1) {</span>
<a href="#l13.44"></a><span id="l13.44">     str = str.slice(0, 1);</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+  }</span>
<a href="#l13.46"></a><span id="l13.46"> </span>
<a href="#l13.47"></a><span id="l13.47">   // We can never allow tag or entity delimiters for separator character</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineminus">-  if (str == &quot;&lt;&quot; || str == &quot;&gt;&quot; || str == &quot;&amp;&quot; || str == &quot;;&quot; || str == &quot; &quot;)</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+  if (str == &quot;&lt;&quot; || str == &quot;&gt;&quot; || str == &quot;&amp;&quot; || str == &quot;;&quot; || str == &quot; &quot;) {</span>
<a href="#l13.50"></a><span id="l13.50">     str = &quot;&quot;;</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+  }</span>
<a href="#l13.52"></a><span id="l13.52"> </span>
<a href="#l13.53"></a><span id="l13.53">   gDialog.sepCharacterInput.value = str;</span>
<a href="#l13.54"></a><span id="l13.54"> }</span>
<a href="#l13.55"></a><span id="l13.55"> </span>
<a href="#l13.56"></a><span id="l13.56"> function SelectCharacter(radioGroupIndex) {</span>
<a href="#l13.57"></a><span id="l13.57">   gIndex = radioGroupIndex;</span>
<a href="#l13.58"></a><span id="l13.58">   SetElementEnabledById(&quot;SepCharacterInput&quot;, gIndex == gOtherIndex);</span>
<a href="#l13.59"></a><span id="l13.59">   SetElementEnabledById(&quot;CollapseSpaces&quot;, gIndex == gSpaceIndex);</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineat">@@ -82,17 +86,20 @@ function onAccept() {</span>
<a href="#l13.61"></a><span id="l13.61">     case gOtherIndex:</span>
<a href="#l13.62"></a><span id="l13.62">       sepCharacter = gDialog.sepCharacterInput.value.slice(0, 1);</span>
<a href="#l13.63"></a><span id="l13.63">       break;</span>
<a href="#l13.64"></a><span id="l13.64">   }</span>
<a href="#l13.65"></a><span id="l13.65"> </span>
<a href="#l13.66"></a><span id="l13.66">   var editor = GetCurrentEditor();</span>
<a href="#l13.67"></a><span id="l13.67">   var str;</span>
<a href="#l13.68"></a><span id="l13.68">   try {</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineminus">-    str = editor.outputToString(&quot;text/html&quot;, kOutputLFLineBreak | kOutputSelectionOnly);</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+    str = editor.outputToString(</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+      &quot;text/html&quot;,</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+      kOutputLFLineBreak | kOutputSelectionOnly</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+    );</span>
<a href="#l13.74"></a><span id="l13.74">   } catch (e) {}</span>
<a href="#l13.75"></a><span id="l13.75">   if (!str) {</span>
<a href="#l13.76"></a><span id="l13.76">     SaveWindowLocation();</span>
<a href="#l13.77"></a><span id="l13.77">     return;</span>
<a href="#l13.78"></a><span id="l13.78">   }</span>
<a href="#l13.79"></a><span id="l13.79"> </span>
<a href="#l13.80"></a><span id="l13.80">   // Replace nbsp with spaces:</span>
<a href="#l13.81"></a><span id="l13.81">   str = str.replace(/\u00a0/g, &quot; &quot;);</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineat">@@ -136,31 +143,34 @@ function onAccept() {</span>
<a href="#l13.83"></a><span id="l13.83">       end = str.indexOf(&quot;&gt;&quot;, start + 1);</span>
<a href="#l13.84"></a><span id="l13.84">       if (end &gt; start) {</span>
<a href="#l13.85"></a><span id="l13.85">         let tagContent = str.slice(start + 1, end).trim();</span>
<a href="#l13.86"></a><span id="l13.86"> </span>
<a href="#l13.87"></a><span id="l13.87">         if (/^ol|^ul|^dl/.test(tagContent)) {</span>
<a href="#l13.88"></a><span id="l13.88">           //  Replace list tag with &lt;BR&gt; to start new row</span>
<a href="#l13.89"></a><span id="l13.89">           //   at beginning of second or greater list tag</span>
<a href="#l13.90"></a><span id="l13.90">           str = str.slice(0, start) + listSeparator + str.slice(end + 1);</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineminus">-          if (listSeparator == &quot;&quot;)</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineplus">+          if (listSeparator == &quot;&quot;) {</span>
<a href="#l13.93"></a><span id="l13.93">             listSeparator = &quot;&lt;br&gt;&quot;;</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineplus">+          }</span>
<a href="#l13.95"></a><span id="l13.95"> </span>
<a href="#l13.96"></a><span id="l13.96">           // Reset for list item separation into cells</span>
<a href="#l13.97"></a><span id="l13.97">           listItemSeparator = &quot;&quot;;</span>
<a href="#l13.98"></a><span id="l13.98">         } else if (/^li|^dt|^dd/.test(tagContent)) {</span>
<a href="#l13.99"></a><span id="l13.99">           // Start a new row if this is first item after the ending the last list</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineminus">-          if (endList)</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineplus">+          if (endList) {</span>
<a href="#l13.102"></a><span id="l13.102">             listItemSeparator = &quot;&lt;br&gt;&quot;;</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineplus">+          }</span>
<a href="#l13.104"></a><span id="l13.104"> </span>
<a href="#l13.105"></a><span id="l13.105">           // Start new cell at beginning of second or greater list items</span>
<a href="#l13.106"></a><span id="l13.106">           str = str.slice(0, start) + listItemSeparator + str.slice(end + 1);</span>
<a href="#l13.107"></a><span id="l13.107"> </span>
<a href="#l13.108"></a><span id="l13.108" class="difflineminus">-          if (endList || listItemSeparator == &quot;&quot;)</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineplus">+          if (endList || listItemSeparator == &quot;&quot;) {</span>
<a href="#l13.110"></a><span id="l13.110">             listItemSeparator = sepCharacter;</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineplus">+          }</span>
<a href="#l13.112"></a><span id="l13.112"> </span>
<a href="#l13.113"></a><span id="l13.113">           endList = false;</span>
<a href="#l13.114"></a><span id="l13.114">         } else {</span>
<a href="#l13.115"></a><span id="l13.115">           // Find end tags</span>
<a href="#l13.116"></a><span id="l13.116">           endList = /^\/ol|^\/ul|^\/dl/.test(tagContent);</span>
<a href="#l13.117"></a><span id="l13.117">           if (endList || /^\/li|^\/dt|^\/dd/.test(tagContent)) {</span>
<a href="#l13.118"></a><span id="l13.118">             // Strip out tag</span>
<a href="#l13.119"></a><span id="l13.119">             str = str.slice(0, start) + str.slice(end + 1);</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineat">@@ -187,27 +197,29 @@ function onAccept() {</span>
<a href="#l13.121"></a><span id="l13.121">     //  so include it at start of string to replace</span>
<a href="#l13.122"></a><span id="l13.122">     replaceString = sepCharacter;</span>
<a href="#l13.123"></a><span id="l13.123">   }</span>
<a href="#l13.124"></a><span id="l13.124"> </span>
<a href="#l13.125"></a><span id="l13.125">   replaceString += &quot;&lt;td&gt;&quot;;</span>
<a href="#l13.126"></a><span id="l13.126"> </span>
<a href="#l13.127"></a><span id="l13.127">   if (sepCharacter.length &gt; 0) {</span>
<a href="#l13.128"></a><span id="l13.128">     var tempStr = sepCharacter;</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineminus">-    var regExpChars = &quot;.!@#$%^&amp;*-+[]{}()\|\\\/&quot;;</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineminus">-    if (regExpChars.includes(sepCharacter))</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineplus">+    var regExpChars = &quot;.!@#$%^&amp;*-+[]{}()|\\/&quot;;</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineplus">+    if (regExpChars.includes(sepCharacter)) {</span>
<a href="#l13.133"></a><span id="l13.133">       tempStr = &quot;\\&quot; + sepCharacter;</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineplus">+    }</span>
<a href="#l13.135"></a><span id="l13.135"> </span>
<a href="#l13.136"></a><span id="l13.136">     if (gIndex == gSpaceIndex) {</span>
<a href="#l13.137"></a><span id="l13.137">       // If checkbox is checked,</span>
<a href="#l13.138"></a><span id="l13.138">       //   one or more adjacent spaces are one separator</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineminus">-      if (gDialog.collapseSpaces.checked)</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineminus">-          tempStr = &quot;\\s+&quot;;</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineminus">-        else</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineminus">-          tempStr = &quot;\\s&quot;;</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineplus">+      if (gDialog.collapseSpaces.checked) {</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineplus">+        tempStr = &quot;\\s+&quot;;</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineplus">+      } else {</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineplus">+        tempStr = &quot;\\s&quot;;</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineplus">+      }</span>
<a href="#l13.148"></a><span id="l13.148">     }</span>
<a href="#l13.149"></a><span id="l13.149">     var pattern = new RegExp(tempStr, &quot;g&quot;);</span>
<a href="#l13.150"></a><span id="l13.150">     str = str.replace(pattern, replaceString);</span>
<a href="#l13.151"></a><span id="l13.151">   }</span>
<a href="#l13.152"></a><span id="l13.152"> </span>
<a href="#l13.153"></a><span id="l13.153">   // Put back tag contents that we removed above</span>
<a href="#l13.154"></a><span id="l13.154">   searchStart = 0;</span>
<a href="#l13.155"></a><span id="l13.155">   var stackIndex = 0;</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineat">@@ -222,17 +234,20 @@ function onAccept() {</span>
<a href="#l13.157"></a><span id="l13.157">   } while (start &gt;= 0);</span>
<a href="#l13.158"></a><span id="l13.158"> </span>
<a href="#l13.159"></a><span id="l13.159">   // End table row and start another for each br or p</span>
<a href="#l13.160"></a><span id="l13.160">   str = str.replace(/\s*&lt;br&gt;\s*/g, &quot;&lt;/tr&gt;\n&lt;tr&gt;&lt;td&gt;&quot;);</span>
<a href="#l13.161"></a><span id="l13.161"> </span>
<a href="#l13.162"></a><span id="l13.162">   // Add the table tags and the opening and closing tr/td tags</span>
<a href="#l13.163"></a><span id="l13.163">   // Default table attributes should be same as those used in nsHTMLEditor::CreateElementWithDefaults()</span>
<a href="#l13.164"></a><span id="l13.164">   // (Default width=&quot;100%&quot; is used in EdInsertTable.js)</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineminus">-  str = &quot;&lt;table border=\&quot;1\&quot; width=\&quot;100%\&quot; cellpadding=\&quot;2\&quot; cellspacing=\&quot;2\&quot;&gt;\n&lt;tr&gt;&lt;td&gt;&quot; + str + &quot;&lt;/tr&gt;\n&lt;/table&gt;\n&quot;;</span>
<a href="#l13.166"></a><span id="l13.166" class="difflineplus">+  str =</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineplus">+    '&lt;table border=&quot;1&quot; width=&quot;100%&quot; cellpadding=&quot;2&quot; cellspacing=&quot;2&quot;&gt;\n&lt;tr&gt;&lt;td&gt;' +</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineplus">+    str +</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineplus">+    &quot;&lt;/tr&gt;\n&lt;/table&gt;\n&quot;;</span>
<a href="#l13.170"></a><span id="l13.170"> </span>
<a href="#l13.171"></a><span id="l13.171">   editor.beginTransaction();</span>
<a href="#l13.172"></a><span id="l13.172"> </span>
<a href="#l13.173"></a><span id="l13.173">   // Delete the selection -- makes it easier to find where table will insert</span>
<a href="#l13.174"></a><span id="l13.174">   var nodeBeforeTable = null;</span>
<a href="#l13.175"></a><span id="l13.175">   var nodeAfterTable = null;</span>
<a href="#l13.176"></a><span id="l13.176">   try {</span>
<a href="#l13.177"></a><span id="l13.177">     editor.deleteSelection(editor.eNone, editor.eStrip);</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineat">@@ -240,65 +255,72 @@ function onAccept() {</span>
<a href="#l13.179"></a><span id="l13.179">     var anchorNodeBeforeInsert = editor.selection.anchorNode;</span>
<a href="#l13.180"></a><span id="l13.180">     var offset = editor.selection.anchorOffset;</span>
<a href="#l13.181"></a><span id="l13.181">     if (anchorNodeBeforeInsert.nodeType == Node.TEXT_NODE) {</span>
<a href="#l13.182"></a><span id="l13.182">       // Text was split. Table should be right after the first or before</span>
<a href="#l13.183"></a><span id="l13.183">       nodeBeforeTable = anchorNodeBeforeInsert.previousSibling;</span>
<a href="#l13.184"></a><span id="l13.184">       nodeAfterTable = anchorNodeBeforeInsert;</span>
<a href="#l13.185"></a><span id="l13.185">     } else {</span>
<a href="#l13.186"></a><span id="l13.186">       // Table should be inserted right after node pointed to by selection</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineminus">-      if (offset &gt; 0)</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineplus">+      if (offset &gt; 0) {</span>
<a href="#l13.189"></a><span id="l13.189">         nodeBeforeTable = anchorNodeBeforeInsert.childNodes.item(offset - 1);</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineplus">+      }</span>
<a href="#l13.191"></a><span id="l13.191"> </span>
<a href="#l13.192"></a><span id="l13.192">       nodeAfterTable = anchorNodeBeforeInsert.childNodes.item(offset);</span>
<a href="#l13.193"></a><span id="l13.193">     }</span>
<a href="#l13.194"></a><span id="l13.194"> </span>
<a href="#l13.195"></a><span id="l13.195">     editor.insertHTML(str);</span>
<a href="#l13.196"></a><span id="l13.196">   } catch (e) {}</span>
<a href="#l13.197"></a><span id="l13.197"> </span>
<a href="#l13.198"></a><span id="l13.198">   var table = null;</span>
<a href="#l13.199"></a><span id="l13.199">   if (nodeAfterTable) {</span>
<a href="#l13.200"></a><span id="l13.200">     var previous = nodeAfterTable.previousSibling;</span>
<a href="#l13.201"></a><span id="l13.201" class="difflineminus">-    if (previous &amp;&amp; previous.nodeName.toLowerCase() == &quot;table&quot;)</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineplus">+    if (previous &amp;&amp; previous.nodeName.toLowerCase() == &quot;table&quot;) {</span>
<a href="#l13.203"></a><span id="l13.203">       table = previous;</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineplus">+    }</span>
<a href="#l13.205"></a><span id="l13.205">   }</span>
<a href="#l13.206"></a><span id="l13.206">   if (!table &amp;&amp; nodeBeforeTable) {</span>
<a href="#l13.207"></a><span id="l13.207">     var next = nodeBeforeTable.nextSibling;</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineminus">-    if (next &amp;&amp; next.nodeName.toLowerCase() == &quot;table&quot;)</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineplus">+    if (next &amp;&amp; next.nodeName.toLowerCase() == &quot;table&quot;) {</span>
<a href="#l13.210"></a><span id="l13.210">       table = next;</span>
<a href="#l13.211"></a><span id="l13.211" class="difflineplus">+    }</span>
<a href="#l13.212"></a><span id="l13.212">   }</span>
<a href="#l13.213"></a><span id="l13.213"> </span>
<a href="#l13.214"></a><span id="l13.214">   if (table) {</span>
<a href="#l13.215"></a><span id="l13.215">     // Fixup table only if pref is set</span>
<a href="#l13.216"></a><span id="l13.216">     var firstRow;</span>
<a href="#l13.217"></a><span id="l13.217">     try {</span>
<a href="#l13.218"></a><span id="l13.218" class="difflineminus">-      if (Services.prefs.getBoolPref(&quot;editor.table.maintain_structure&quot;))</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineplus">+      if (Services.prefs.getBoolPref(&quot;editor.table.maintain_structure&quot;)) {</span>
<a href="#l13.220"></a><span id="l13.220">         editor.normalizeTable(table);</span>
<a href="#l13.221"></a><span id="l13.221" class="difflineplus">+      }</span>
<a href="#l13.222"></a><span id="l13.222"> </span>
<a href="#l13.223"></a><span id="l13.223">       firstRow = editor.getFirstRow(table);</span>
<a href="#l13.224"></a><span id="l13.224">     } catch (e) {}</span>
<a href="#l13.225"></a><span id="l13.225"> </span>
<a href="#l13.226"></a><span id="l13.226">     // Put caret in first cell</span>
<a href="#l13.227"></a><span id="l13.227">     if (firstRow) {</span>
<a href="#l13.228"></a><span id="l13.228">       var node2 = firstRow.firstChild;</span>
<a href="#l13.229"></a><span id="l13.229">       do {</span>
<a href="#l13.230"></a><span id="l13.230" class="difflineminus">-        if (node2.nodeName.toLowerCase() == &quot;td&quot; ||</span>
<a href="#l13.231"></a><span id="l13.231" class="difflineminus">-            node2.nodeName.toLowerCase() == &quot;th&quot;) {</span>
<a href="#l13.232"></a><span id="l13.232" class="difflineplus">+        if (</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineplus">+          node2.nodeName.toLowerCase() == &quot;td&quot; ||</span>
<a href="#l13.234"></a><span id="l13.234" class="difflineplus">+          node2.nodeName.toLowerCase() == &quot;th&quot;</span>
<a href="#l13.235"></a><span id="l13.235" class="difflineplus">+        ) {</span>
<a href="#l13.236"></a><span id="l13.236">           try {</span>
<a href="#l13.237"></a><span id="l13.237">             editor.selection.collapse(node2, 0);</span>
<a href="#l13.238"></a><span id="l13.238">           } catch (e) {}</span>
<a href="#l13.239"></a><span id="l13.239">           break;</span>
<a href="#l13.240"></a><span id="l13.240">         }</span>
<a href="#l13.241"></a><span id="l13.241">         node2 = node2.nextSibling;</span>
<a href="#l13.242"></a><span id="l13.242">       } while (node2);</span>
<a href="#l13.243"></a><span id="l13.243">     }</span>
<a href="#l13.244"></a><span id="l13.244">   }</span>
<a href="#l13.245"></a><span id="l13.245"> </span>
<a href="#l13.246"></a><span id="l13.246">   editor.endTransaction();</span>
<a href="#l13.247"></a><span id="l13.247"> </span>
<a href="#l13.248"></a><span id="l13.248">   // Save persisted attributes</span>
<a href="#l13.249"></a><span id="l13.249">   gDialog.sepRadioGroup.setAttribute(&quot;index&quot;, gIndex);</span>
<a href="#l13.250"></a><span id="l13.250" class="difflineminus">-  if (gIndex == gOtherIndex)</span>
<a href="#l13.251"></a><span id="l13.251" class="difflineplus">+  if (gIndex == gOtherIndex) {</span>
<a href="#l13.252"></a><span id="l13.252">     gDialog.sepRadioGroup.setAttribute(&quot;character&quot;, sepCharacter);</span>
<a href="#l13.253"></a><span id="l13.253" class="difflineplus">+  }</span>
<a href="#l13.254"></a><span id="l13.254"> </span>
<a href="#l13.255"></a><span id="l13.255">   SaveWindowLocation();</span>
<a href="#l13.256"></a><span id="l13.256"> }</span>
<a href="#l13.257"></a><span id="l13.257"> /* eslint-enable complexity */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdDialogCommon.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdDialogCommon.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -12,20 +12,20 @@ var gDialog = {};</span>
<a href="#l14.4"></a><span id="l14.4"> </span>
<a href="#l14.5"></a><span id="l14.5"> var gHaveDocumentUrl = false;</span>
<a href="#l14.6"></a><span id="l14.6"> var gValidationError = false;</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8"> // Use for 'defaultIndex' param in InitPixelOrPercentMenulist</span>
<a href="#l14.9"></a><span id="l14.9"> const gPixel = 0;</span>
<a href="#l14.10"></a><span id="l14.10"> const gPercent = 1;</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-const gMaxPixels  = 100000; // Used for image size, borders, spacing, and padding</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+const gMaxPixels = 100000; // Used for image size, borders, spacing, and padding</span>
<a href="#l14.14"></a><span id="l14.14"> // Gecko code uses 1000 for maximum rowspan, colspan</span>
<a href="#l14.15"></a><span id="l14.15"> // Also, editing performance is really bad above this</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-const gMaxRows    = 1000;</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+const gMaxRows = 1000;</span>
<a href="#l14.18"></a><span id="l14.18"> const gMaxColumns = 1000;</span>
<a href="#l14.19"></a><span id="l14.19"> const gMaxTableSize = 1000000; // Width or height of table or cells</span>
<a href="#l14.20"></a><span id="l14.20"> </span>
<a href="#l14.21"></a><span id="l14.21"> // For dialogs that expand in size. Default is smaller size see &quot;onMoreFewer()&quot; below</span>
<a href="#l14.22"></a><span id="l14.22"> var SeeMore = false;</span>
<a href="#l14.23"></a><span id="l14.23"> </span>
<a href="#l14.24"></a><span id="l14.24"> // A XUL element with id=&quot;location&quot; for managing</span>
<a href="#l14.25"></a><span id="l14.25"> // dialog location relative to parent window</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineat">@@ -51,55 +51,78 @@ var globalElement;</span>
<a href="#l14.27"></a><span id="l14.27">  *    If error, we also:</span>
<a href="#l14.28"></a><span id="l14.28">  *      Shift focus and select contents of the inputWidget,</span>
<a href="#l14.29"></a><span id="l14.29">  *      Switch to appropriate panel of tabbed dialog if user implements &quot;SwitchToValidate()&quot;,</span>
<a href="#l14.30"></a><span id="l14.30">  *      and/or will expand the dialog to full size if &quot;More / Fewer&quot; feature is implemented</span>
<a href="#l14.31"></a><span id="l14.31">  *</span>
<a href="#l14.32"></a><span id="l14.32">  *  Returns the &quot;value&quot; as a string, or &quot;&quot; if error or input contents are empty</span>
<a href="#l14.33"></a><span id="l14.33">  *  The global &quot;gValidationError&quot; variable is set true if error was found</span>
<a href="#l14.34"></a><span id="l14.34">  */</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">-function ValidateNumber(inputWidget, listWidget, minVal, maxVal, element, attName, mustHaveValue, mustShowMoreSection) {</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+function ValidateNumber(</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+  inputWidget,</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+  listWidget,</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+  minVal,</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+  maxVal,</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+  element,</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+  attName,</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+  mustHaveValue,</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+  mustShowMoreSection</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+) {</span>
<a href="#l14.46"></a><span id="l14.46">   if (!inputWidget) {</span>
<a href="#l14.47"></a><span id="l14.47">     gValidationError = true;</span>
<a href="#l14.48"></a><span id="l14.48">     return &quot;&quot;;</span>
<a href="#l14.49"></a><span id="l14.49">   }</span>
<a href="#l14.50"></a><span id="l14.50"> </span>
<a href="#l14.51"></a><span id="l14.51">   // Global error return value</span>
<a href="#l14.52"></a><span id="l14.52">   gValidationError = false;</span>
<a href="#l14.53"></a><span id="l14.53">   var maxLimit = maxVal;</span>
<a href="#l14.54"></a><span id="l14.54">   var isPercent = false;</span>
<a href="#l14.55"></a><span id="l14.55"> </span>
<a href="#l14.56"></a><span id="l14.56">   var numString = TrimString(inputWidget.value);</span>
<a href="#l14.57"></a><span id="l14.57">   if (numString || mustHaveValue) {</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineminus">-    if (listWidget)</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineminus">-      isPercent = (listWidget.selectedIndex == 1);</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineminus">-    if (isPercent)</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+    if (listWidget) {</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+      isPercent = listWidget.selectedIndex == 1;</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+    }</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+    if (isPercent) {</span>
<a href="#l14.65"></a><span id="l14.65">       maxLimit = 100;</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+    }</span>
<a href="#l14.67"></a><span id="l14.67"> </span>
<a href="#l14.68"></a><span id="l14.68">     // This method puts up the error message</span>
<a href="#l14.69"></a><span id="l14.69">     numString = ValidateNumberRange(numString, minVal, maxLimit, mustHaveValue);</span>
<a href="#l14.70"></a><span id="l14.70">     if (!numString) {</span>
<a href="#l14.71"></a><span id="l14.71">       // Switch to appropriate panel for error reporting</span>
<a href="#l14.72"></a><span id="l14.72">       SwitchToValidatePanel();</span>
<a href="#l14.73"></a><span id="l14.73"> </span>
<a href="#l14.74"></a><span id="l14.74">       // or expand dialog for users of &quot;More / Fewer&quot; button</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineminus">-      if (&quot;dialog&quot; in window &amp;&amp; window.dialog &amp;&amp;</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineminus">-           &quot;MoreSection&quot; in gDialog &amp;&amp; gDialog.MoreSection) {</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineminus">-        if (!SeeMore)</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+      if (</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+        &quot;dialog&quot; in window &amp;&amp;</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+        window.dialog &amp;&amp;</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+        &quot;MoreSection&quot; in gDialog &amp;&amp;</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+        gDialog.MoreSection</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+      ) {</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+        if (!SeeMore) {</span>
<a href="#l14.85"></a><span id="l14.85">           onMoreFewer();</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+        }</span>
<a href="#l14.87"></a><span id="l14.87">       }</span>
<a href="#l14.88"></a><span id="l14.88"> </span>
<a href="#l14.89"></a><span id="l14.89">       // Error - shift to offending input widget</span>
<a href="#l14.90"></a><span id="l14.90">       SetTextboxFocus(inputWidget);</span>
<a href="#l14.91"></a><span id="l14.91">       gValidationError = true;</span>
<a href="#l14.92"></a><span id="l14.92">     } else {</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineminus">-      if (isPercent)</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+      if (isPercent) {</span>
<a href="#l14.95"></a><span id="l14.95">         numString += &quot;%&quot;;</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineminus">-      if (element)</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineminus">-        GetCurrentEditor().setAttributeOrEquivalent(element, attName, numString, true);</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+      }</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+      if (element) {</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineplus">+        GetCurrentEditor().setAttributeOrEquivalent(</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineplus">+          element,</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineplus">+          attName,</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+          numString,</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+          true</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+        );</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+      }</span>
<a href="#l14.107"></a><span id="l14.107">     }</span>
<a href="#l14.108"></a><span id="l14.108">   } else if (element) {</span>
<a href="#l14.109"></a><span id="l14.109">     GetCurrentEditor().removeAttributeOrEquivalent(element, attName, true);</span>
<a href="#l14.110"></a><span id="l14.110">   }</span>
<a href="#l14.111"></a><span id="l14.111">   return numString;</span>
<a href="#l14.112"></a><span id="l14.112"> }</span>
<a href="#l14.113"></a><span id="l14.113"> </span>
<a href="#l14.114"></a><span id="l14.114"> /* Validate contents of an input field</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineat">@@ -119,18 +142,19 @@ function ValidateNumber(inputWidget, lis</span>
<a href="#l14.116"></a><span id="l14.116">  *  The global &quot;gValidationError&quot; variable is set true if error was found</span>
<a href="#l14.117"></a><span id="l14.117">  */</span>
<a href="#l14.118"></a><span id="l14.118"> function ValidateNumberRange(value, minValue, maxValue, mustHaveValue) {</span>
<a href="#l14.119"></a><span id="l14.119">   // Initialize global error flag</span>
<a href="#l14.120"></a><span id="l14.120">   gValidationError = false;</span>
<a href="#l14.121"></a><span id="l14.121">   value = TrimString(String(value));</span>
<a href="#l14.122"></a><span id="l14.122"> </span>
<a href="#l14.123"></a><span id="l14.123">   // We don't show error for empty string unless caller wants to</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineminus">-  if (!value &amp;&amp; !mustHaveValue)</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineplus">+  if (!value &amp;&amp; !mustHaveValue) {</span>
<a href="#l14.126"></a><span id="l14.126">     return &quot;&quot;;</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineplus">+  }</span>
<a href="#l14.128"></a><span id="l14.128"> </span>
<a href="#l14.129"></a><span id="l14.129">   var numberStr = &quot;&quot;;</span>
<a href="#l14.130"></a><span id="l14.130"> </span>
<a href="#l14.131"></a><span id="l14.131">   if (value.length &gt; 0) {</span>
<a href="#l14.132"></a><span id="l14.132">     // Extract just numeric characters</span>
<a href="#l14.133"></a><span id="l14.133">     var number = Number(value.replace(/\D+/g, &quot;&quot;));</span>
<a href="#l14.134"></a><span id="l14.134">     if (number &gt;= minValue &amp;&amp; number &lt;= maxValue) {</span>
<a href="#l14.135"></a><span id="l14.135">       // Return string version of the number</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineat">@@ -161,17 +185,24 @@ function ValidateNumberRange(value, minV</span>
<a href="#l14.137"></a><span id="l14.137"> function SetTextboxFocusById(id) {</span>
<a href="#l14.138"></a><span id="l14.138">   SetTextboxFocus(document.getElementById(id));</span>
<a href="#l14.139"></a><span id="l14.139"> }</span>
<a href="#l14.140"></a><span id="l14.140"> </span>
<a href="#l14.141"></a><span id="l14.141"> function SetTextboxFocus(textbox) {</span>
<a href="#l14.142"></a><span id="l14.142">   if (textbox) {</span>
<a href="#l14.143"></a><span id="l14.143">     // XXX Using the setTimeout is hacky workaround for bug 103197</span>
<a href="#l14.144"></a><span id="l14.144">     // Must create a new function to keep &quot;textbox&quot; in scope</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineminus">-    setTimeout(function(textbox) { textbox.focus(); textbox.select(); }, 0, textbox);</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineplus">+    setTimeout(</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineplus">+      function(textbox) {</span>
<a href="#l14.148"></a><span id="l14.148" class="difflineplus">+        textbox.focus();</span>
<a href="#l14.149"></a><span id="l14.149" class="difflineplus">+        textbox.select();</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineplus">+      },</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineplus">+      0,</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineplus">+      textbox</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineplus">+    );</span>
<a href="#l14.154"></a><span id="l14.154">   }</span>
<a href="#l14.155"></a><span id="l14.155"> }</span>
<a href="#l14.156"></a><span id="l14.156"> </span>
<a href="#l14.157"></a><span id="l14.157"> function ShowInputErrorMessage(message) {</span>
<a href="#l14.158"></a><span id="l14.158">   Services.prompt.alert(window, GetString(&quot;InputError&quot;), message);</span>
<a href="#l14.159"></a><span id="l14.159">   window.focus();</span>
<a href="#l14.160"></a><span id="l14.160"> }</span>
<a href="#l14.161"></a><span id="l14.161"> </span>
<a href="#l14.162"></a><span id="l14.162" class="difflineat">@@ -179,117 +210,145 @@ function ShowInputErrorMessage(message) </span>
<a href="#l14.163"></a><span id="l14.163"> //  to determine what a &quot;%&quot; value is referring to.</span>
<a href="#l14.164"></a><span id="l14.164"> // elementForAtt is element we are actually setting attributes on</span>
<a href="#l14.165"></a><span id="l14.165"> //  (a temporary copy of element in the doc to allow canceling),</span>
<a href="#l14.166"></a><span id="l14.166"> //  but elementInDoc is needed to find parent context in document</span>
<a href="#l14.167"></a><span id="l14.167"> function GetAppropriatePercentString(elementForAtt, elementInDoc) {</span>
<a href="#l14.168"></a><span id="l14.168">   var editor = GetCurrentEditor();</span>
<a href="#l14.169"></a><span id="l14.169">   try {</span>
<a href="#l14.170"></a><span id="l14.170">     var name = elementForAtt.nodeName.toLowerCase();</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineminus">-    if (name == &quot;td&quot; || name == &quot;th&quot;)</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineplus">+    if (name == &quot;td&quot; || name == &quot;th&quot;) {</span>
<a href="#l14.173"></a><span id="l14.173">       return GetString(&quot;PercentOfTable&quot;);</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineplus">+    }</span>
<a href="#l14.175"></a><span id="l14.175"> </span>
<a href="#l14.176"></a><span id="l14.176">     // Check if element is within a table cell</span>
<a href="#l14.177"></a><span id="l14.177" class="difflineminus">-    if (editor.getElementOrParentByTagName(&quot;td&quot;, elementInDoc))</span>
<a href="#l14.178"></a><span id="l14.178" class="difflineplus">+    if (editor.getElementOrParentByTagName(&quot;td&quot;, elementInDoc)) {</span>
<a href="#l14.179"></a><span id="l14.179">       return GetString(&quot;PercentOfCell&quot;);</span>
<a href="#l14.180"></a><span id="l14.180" class="difflineplus">+    }</span>
<a href="#l14.181"></a><span id="l14.181">     return GetString(&quot;PercentOfWindow&quot;);</span>
<a href="#l14.182"></a><span id="l14.182">   } catch (e) {</span>
<a href="#l14.183"></a><span id="l14.183">     return &quot;&quot;;</span>
<a href="#l14.184"></a><span id="l14.184">   }</span>
<a href="#l14.185"></a><span id="l14.185"> }</span>
<a href="#l14.186"></a><span id="l14.186"> </span>
<a href="#l14.187"></a><span id="l14.187"> function ClearListbox(listbox) {</span>
<a href="#l14.188"></a><span id="l14.188">   if (listbox) {</span>
<a href="#l14.189"></a><span id="l14.189">     listbox.clearSelection();</span>
<a href="#l14.190"></a><span id="l14.190" class="difflineminus">-    while (listbox.hasChildNodes())</span>
<a href="#l14.191"></a><span id="l14.191" class="difflineplus">+    while (listbox.hasChildNodes()) {</span>
<a href="#l14.192"></a><span id="l14.192">       listbox.lastChild.remove();</span>
<a href="#l14.193"></a><span id="l14.193" class="difflineplus">+    }</span>
<a href="#l14.194"></a><span id="l14.194">   }</span>
<a href="#l14.195"></a><span id="l14.195"> }</span>
<a href="#l14.196"></a><span id="l14.196"> </span>
<a href="#l14.197"></a><span id="l14.197"> function forceInteger(elementID) {</span>
<a href="#l14.198"></a><span id="l14.198">   var editField = document.getElementById(elementID);</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineminus">-  if (!editField)</span>
<a href="#l14.200"></a><span id="l14.200" class="difflineplus">+  if (!editField) {</span>
<a href="#l14.201"></a><span id="l14.201">     return;</span>
<a href="#l14.202"></a><span id="l14.202" class="difflineplus">+  }</span>
<a href="#l14.203"></a><span id="l14.203"> </span>
<a href="#l14.204"></a><span id="l14.204">   var stringIn = editField.value;</span>
<a href="#l14.205"></a><span id="l14.205">   if (stringIn &amp;&amp; stringIn.length &gt; 0) {</span>
<a href="#l14.206"></a><span id="l14.206">     // Strip out all nonnumeric characters</span>
<a href="#l14.207"></a><span id="l14.207">     stringIn = stringIn.replace(/\D+/g, &quot;&quot;);</span>
<a href="#l14.208"></a><span id="l14.208" class="difflineminus">-    if (!stringIn) stringIn = &quot;&quot;;</span>
<a href="#l14.209"></a><span id="l14.209" class="difflineplus">+    if (!stringIn) {</span>
<a href="#l14.210"></a><span id="l14.210" class="difflineplus">+      stringIn = &quot;&quot;;</span>
<a href="#l14.211"></a><span id="l14.211" class="difflineplus">+    }</span>
<a href="#l14.212"></a><span id="l14.212"> </span>
<a href="#l14.213"></a><span id="l14.213">     // Write back only if changed</span>
<a href="#l14.214"></a><span id="l14.214" class="difflineminus">-    if (stringIn != editField.value)</span>
<a href="#l14.215"></a><span id="l14.215" class="difflineplus">+    if (stringIn != editField.value) {</span>
<a href="#l14.216"></a><span id="l14.216">       editField.value = stringIn;</span>
<a href="#l14.217"></a><span id="l14.217" class="difflineplus">+    }</span>
<a href="#l14.218"></a><span id="l14.218">   }</span>
<a href="#l14.219"></a><span id="l14.219"> }</span>
<a href="#l14.220"></a><span id="l14.220"> </span>
<a href="#l14.221"></a><span id="l14.221" class="difflineminus">-function InitPixelOrPercentMenulist(elementForAtt, elementInDoc, attribute, menulistID, defaultIndex) {</span>
<a href="#l14.222"></a><span id="l14.222" class="difflineminus">-  if (!defaultIndex) defaultIndex = gPixel;</span>
<a href="#l14.223"></a><span id="l14.223" class="difflineplus">+function InitPixelOrPercentMenulist(</span>
<a href="#l14.224"></a><span id="l14.224" class="difflineplus">+  elementForAtt,</span>
<a href="#l14.225"></a><span id="l14.225" class="difflineplus">+  elementInDoc,</span>
<a href="#l14.226"></a><span id="l14.226" class="difflineplus">+  attribute,</span>
<a href="#l14.227"></a><span id="l14.227" class="difflineplus">+  menulistID,</span>
<a href="#l14.228"></a><span id="l14.228" class="difflineplus">+  defaultIndex</span>
<a href="#l14.229"></a><span id="l14.229" class="difflineplus">+) {</span>
<a href="#l14.230"></a><span id="l14.230" class="difflineplus">+  if (!defaultIndex) {</span>
<a href="#l14.231"></a><span id="l14.231" class="difflineplus">+    defaultIndex = gPixel;</span>
<a href="#l14.232"></a><span id="l14.232" class="difflineplus">+  }</span>
<a href="#l14.233"></a><span id="l14.233"> </span>
<a href="#l14.234"></a><span id="l14.234">   // var size  = elementForAtt.getAttribute(attribute);</span>
<a href="#l14.235"></a><span id="l14.235">   var size = GetHTMLOrCSSStyleValue(elementForAtt, attribute, attribute);</span>
<a href="#l14.236"></a><span id="l14.236">   var menulist = document.getElementById(menulistID);</span>
<a href="#l14.237"></a><span id="l14.237">   var pixelItem;</span>
<a href="#l14.238"></a><span id="l14.238">   var percentItem;</span>
<a href="#l14.239"></a><span id="l14.239"> </span>
<a href="#l14.240"></a><span id="l14.240">   if (!menulist) {</span>
<a href="#l14.241"></a><span id="l14.241">     dump(&quot;NO MENULIST found for ID=&quot; + menulistID + &quot;\n&quot;);</span>
<a href="#l14.242"></a><span id="l14.242">     return size;</span>
<a href="#l14.243"></a><span id="l14.243">   }</span>
<a href="#l14.244"></a><span id="l14.244"> </span>
<a href="#l14.245"></a><span id="l14.245">   menulist.removeAllItems();</span>
<a href="#l14.246"></a><span id="l14.246">   pixelItem = menulist.appendItem(GetString(&quot;Pixels&quot;));</span>
<a href="#l14.247"></a><span id="l14.247"> </span>
<a href="#l14.248"></a><span id="l14.248" class="difflineminus">-  if (!pixelItem) return 0;</span>
<a href="#l14.249"></a><span id="l14.249" class="difflineplus">+  if (!pixelItem) {</span>
<a href="#l14.250"></a><span id="l14.250" class="difflineplus">+    return 0;</span>
<a href="#l14.251"></a><span id="l14.251" class="difflineplus">+  }</span>
<a href="#l14.252"></a><span id="l14.252"> </span>
<a href="#l14.253"></a><span id="l14.253" class="difflineminus">-  percentItem = menulist.appendItem(GetAppropriatePercentString(elementForAtt, elementInDoc));</span>
<a href="#l14.254"></a><span id="l14.254" class="difflineplus">+  percentItem = menulist.appendItem(</span>
<a href="#l14.255"></a><span id="l14.255" class="difflineplus">+    GetAppropriatePercentString(elementForAtt, elementInDoc)</span>
<a href="#l14.256"></a><span id="l14.256" class="difflineplus">+  );</span>
<a href="#l14.257"></a><span id="l14.257">   if (size &amp;&amp; size.length &gt; 0) {</span>
<a href="#l14.258"></a><span id="l14.258">     // Search for a &quot;%&quot; or &quot;px&quot;</span>
<a href="#l14.259"></a><span id="l14.259">     if (size.includes(&quot;%&quot;)) {</span>
<a href="#l14.260"></a><span id="l14.260">       // Strip out the %</span>
<a href="#l14.261"></a><span id="l14.261">       size = size.substr(0, size.indexOf(&quot;%&quot;));</span>
<a href="#l14.262"></a><span id="l14.262" class="difflineminus">-      if (percentItem)</span>
<a href="#l14.263"></a><span id="l14.263" class="difflineplus">+      if (percentItem) {</span>
<a href="#l14.264"></a><span id="l14.264">         menulist.selectedItem = percentItem;</span>
<a href="#l14.265"></a><span id="l14.265" class="difflineplus">+      }</span>
<a href="#l14.266"></a><span id="l14.266">     } else {</span>
<a href="#l14.267"></a><span id="l14.267" class="difflineminus">-      if (size.includes(&quot;px&quot;))</span>
<a href="#l14.268"></a><span id="l14.268" class="difflineplus">+      if (size.includes(&quot;px&quot;)) {</span>
<a href="#l14.269"></a><span id="l14.269">         // Strip out the px</span>
<a href="#l14.270"></a><span id="l14.270">         size = size.substr(0, size.indexOf(&quot;px&quot;));</span>
<a href="#l14.271"></a><span id="l14.271" class="difflineplus">+      }</span>
<a href="#l14.272"></a><span id="l14.272">       menulist.selectedItem = pixelItem;</span>
<a href="#l14.273"></a><span id="l14.273">     }</span>
<a href="#l14.274"></a><span id="l14.274">   } else {</span>
<a href="#l14.275"></a><span id="l14.275">     menulist.selectedIndex = defaultIndex;</span>
<a href="#l14.276"></a><span id="l14.276">   }</span>
<a href="#l14.277"></a><span id="l14.277"> </span>
<a href="#l14.278"></a><span id="l14.278">   return size;</span>
<a href="#l14.279"></a><span id="l14.279"> }</span>
<a href="#l14.280"></a><span id="l14.280"> </span>
<a href="#l14.281"></a><span id="l14.281"> function onAdvancedEdit() {</span>
<a href="#l14.282"></a><span id="l14.282">   // First validate data from widgets in the &quot;simpler&quot; property dialog</span>
<a href="#l14.283"></a><span id="l14.283">   if (ValidateData()) {</span>
<a href="#l14.284"></a><span id="l14.284">     // Set true if OK is clicked in the Advanced Edit dialog</span>
<a href="#l14.285"></a><span id="l14.285">     window.AdvancedEditOK = false;</span>
<a href="#l14.286"></a><span id="l14.286">     // Open the AdvancedEdit dialog, passing in the element to be edited</span>
<a href="#l14.287"></a><span id="l14.287">     //  (the copy named &quot;globalElement&quot;)</span>
<a href="#l14.288"></a><span id="l14.288" class="difflineminus">-    window.openDialog(&quot;chrome://editor/content/EdAdvancedEdit.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal,resizable=yes&quot;, &quot;&quot;, globalElement);</span>
<a href="#l14.289"></a><span id="l14.289" class="difflineplus">+    window.openDialog(</span>
<a href="#l14.290"></a><span id="l14.290" class="difflineplus">+      &quot;chrome://editor/content/EdAdvancedEdit.xul&quot;,</span>
<a href="#l14.291"></a><span id="l14.291" class="difflineplus">+      &quot;_blank&quot;,</span>
<a href="#l14.292"></a><span id="l14.292" class="difflineplus">+      &quot;chrome,close,titlebar,modal,resizable=yes&quot;,</span>
<a href="#l14.293"></a><span id="l14.293" class="difflineplus">+      &quot;&quot;,</span>
<a href="#l14.294"></a><span id="l14.294" class="difflineplus">+      globalElement</span>
<a href="#l14.295"></a><span id="l14.295" class="difflineplus">+    );</span>
<a href="#l14.296"></a><span id="l14.296">     window.focus();</span>
<a href="#l14.297"></a><span id="l14.297">     if (window.AdvancedEditOK) {</span>
<a href="#l14.298"></a><span id="l14.298">       // Copy edited attributes to the dialog widgets:</span>
<a href="#l14.299"></a><span id="l14.299">       InitDialog();</span>
<a href="#l14.300"></a><span id="l14.300">     }</span>
<a href="#l14.301"></a><span id="l14.301">   }</span>
<a href="#l14.302"></a><span id="l14.302"> }</span>
<a href="#l14.303"></a><span id="l14.303"> </span>
<a href="#l14.304"></a><span id="l14.304"> function getColor(ColorPickerID) {</span>
<a href="#l14.305"></a><span id="l14.305">   var colorPicker = document.getElementById(ColorPickerID);</span>
<a href="#l14.306"></a><span id="l14.306">   var color;</span>
<a href="#l14.307"></a><span id="l14.307">   if (colorPicker) {</span>
<a href="#l14.308"></a><span id="l14.308">     // Extract color from colorPicker and assign to colorWell.</span>
<a href="#l14.309"></a><span id="l14.309">     color = colorPicker.getAttribute(&quot;color&quot;);</span>
<a href="#l14.310"></a><span id="l14.310" class="difflineminus">-    if (color &amp;&amp; color == &quot;&quot;)</span>
<a href="#l14.311"></a><span id="l14.311" class="difflineplus">+    if (color &amp;&amp; color == &quot;&quot;) {</span>
<a href="#l14.312"></a><span id="l14.312">       return null;</span>
<a href="#l14.313"></a><span id="l14.313" class="difflineplus">+    }</span>
<a href="#l14.314"></a><span id="l14.314">     // Clear color so next if it's called again before</span>
<a href="#l14.315"></a><span id="l14.315">     //  color picker is actually used, we dedect the &quot;don't set color&quot; state</span>
<a href="#l14.316"></a><span id="l14.316">     colorPicker.setAttribute(&quot;color&quot;, &quot;&quot;);</span>
<a href="#l14.317"></a><span id="l14.317">   }</span>
<a href="#l14.318"></a><span id="l14.318"> </span>
<a href="#l14.319"></a><span id="l14.319">   return color;</span>
<a href="#l14.320"></a><span id="l14.320"> }</span>
<a href="#l14.321"></a><span id="l14.321"> </span>
<a href="#l14.322"></a><span id="l14.322" class="difflineat">@@ -317,19 +376,22 @@ function getColorAndSetColorWell(ColorPi</span>
<a href="#l14.323"></a><span id="l14.323">   return color;</span>
<a href="#l14.324"></a><span id="l14.324"> }</span>
<a href="#l14.325"></a><span id="l14.325"> </span>
<a href="#l14.326"></a><span id="l14.326"> function InitMoreFewer() {</span>
<a href="#l14.327"></a><span id="l14.327">   // Set SeeMore bool to the OPPOSITE of the current state,</span>
<a href="#l14.328"></a><span id="l14.328">   //   which is automatically saved by using the 'persist=&quot;more&quot;'</span>
<a href="#l14.329"></a><span id="l14.329">   //   attribute on the gDialog.MoreFewerButton button</span>
<a href="#l14.330"></a><span id="l14.330">   //   onMoreFewer will toggle it and redraw the dialog</span>
<a href="#l14.331"></a><span id="l14.331" class="difflineminus">-  SeeMore = (gDialog.MoreFewerButton.getAttribute(&quot;more&quot;) != &quot;1&quot;);</span>
<a href="#l14.332"></a><span id="l14.332" class="difflineplus">+  SeeMore = gDialog.MoreFewerButton.getAttribute(&quot;more&quot;) != &quot;1&quot;;</span>
<a href="#l14.333"></a><span id="l14.333">   onMoreFewer();</span>
<a href="#l14.334"></a><span id="l14.334" class="difflineminus">-  gDialog.MoreFewerButton.setAttribute(&quot;accesskey&quot;, GetString(&quot;PropertiesAccessKey&quot;));</span>
<a href="#l14.335"></a><span id="l14.335" class="difflineplus">+  gDialog.MoreFewerButton.setAttribute(</span>
<a href="#l14.336"></a><span id="l14.336" class="difflineplus">+    &quot;accesskey&quot;,</span>
<a href="#l14.337"></a><span id="l14.337" class="difflineplus">+    GetString(&quot;PropertiesAccessKey&quot;)</span>
<a href="#l14.338"></a><span id="l14.338" class="difflineplus">+  );</span>
<a href="#l14.339"></a><span id="l14.339"> }</span>
<a href="#l14.340"></a><span id="l14.340"> </span>
<a href="#l14.341"></a><span id="l14.341"> function onMoreFewer() {</span>
<a href="#l14.342"></a><span id="l14.342">   if (SeeMore) {</span>
<a href="#l14.343"></a><span id="l14.343">     gDialog.MoreSection.collapsed = true;</span>
<a href="#l14.344"></a><span id="l14.344">     gDialog.MoreFewerButton.setAttribute(&quot;more&quot;, &quot;0&quot;);</span>
<a href="#l14.345"></a><span id="l14.345">     gDialog.MoreFewerButton.setAttribute(&quot;label&quot;, GetString(&quot;MoreProperties&quot;));</span>
<a href="#l14.346"></a><span id="l14.346">     SeeMore = false;</span>
<a href="#l14.347"></a><span id="l14.347" class="difflineat">@@ -366,18 +428,19 @@ function GetLocalFileURL(filterType) {</span>
<a href="#l14.348"></a><span id="l14.348">     fp.init(window, GetString(&quot;OpenHTMLFile&quot;), nsIFilePicker.modeOpen);</span>
<a href="#l14.349"></a><span id="l14.349"> </span>
<a href="#l14.350"></a><span id="l14.350">     // When loading into Composer, direct user to prefer HTML files and text files,</span>
<a href="#l14.351"></a><span id="l14.351">     //   so we call separately to control the order of the filter list</span>
<a href="#l14.352"></a><span id="l14.352">     fp.appendFilters(nsIFilePicker.filterHTML);</span>
<a href="#l14.353"></a><span id="l14.353">     fp.appendFilters(nsIFilePicker.filterText);</span>
<a href="#l14.354"></a><span id="l14.354"> </span>
<a href="#l14.355"></a><span id="l14.355">     // Link dialog also allows linking to images</span>
<a href="#l14.356"></a><span id="l14.356" class="difflineminus">-    if (filterType.includes(&quot;img&quot;, 1))</span>
<a href="#l14.357"></a><span id="l14.357" class="difflineplus">+    if (filterType.includes(&quot;img&quot;, 1)) {</span>
<a href="#l14.358"></a><span id="l14.358">       fp.appendFilters(nsIFilePicker.filterImages);</span>
<a href="#l14.359"></a><span id="l14.359" class="difflineplus">+    }</span>
<a href="#l14.360"></a><span id="l14.360">   }</span>
<a href="#l14.361"></a><span id="l14.361">   // Default or last filter is &quot;All Files&quot;</span>
<a href="#l14.362"></a><span id="l14.362">   fp.appendFilters(nsIFilePicker.filterAll);</span>
<a href="#l14.363"></a><span id="l14.363"> </span>
<a href="#l14.364"></a><span id="l14.364">   // set the file picker's current directory to last-opened location saved in prefs</span>
<a href="#l14.365"></a><span id="l14.365">   SetFilePickerDirectory(fp, fileType);</span>
<a href="#l14.366"></a><span id="l14.366"> </span>
<a href="#l14.367"></a><span id="l14.367">   return new Promise(resolve =&gt; {</span>
<a href="#l14.368"></a><span id="l14.368" class="difflineat">@@ -392,17 +455,19 @@ function GetLocalFileURL(filterType) {</span>
<a href="#l14.369"></a><span id="l14.369">   });</span>
<a href="#l14.370"></a><span id="l14.370"> }</span>
<a href="#l14.371"></a><span id="l14.371"> </span>
<a href="#l14.372"></a><span id="l14.372"> function GetMetaElementByAttribute(name, value) {</span>
<a href="#l14.373"></a><span id="l14.373">   if (name) {</span>
<a href="#l14.374"></a><span id="l14.374">     name = name.toLowerCase();</span>
<a href="#l14.375"></a><span id="l14.375">     let editor = GetCurrentEditor();</span>
<a href="#l14.376"></a><span id="l14.376">     try {</span>
<a href="#l14.377"></a><span id="l14.377" class="difflineminus">-      return editor.document.querySelector(&quot;meta[&quot; + name + '=&quot;' + value + '&quot;]');</span>
<a href="#l14.378"></a><span id="l14.378" class="difflineplus">+      return editor.document.querySelector(</span>
<a href="#l14.379"></a><span id="l14.379" class="difflineplus">+        &quot;meta[&quot; + name + '=&quot;' + value + '&quot;]'</span>
<a href="#l14.380"></a><span id="l14.380" class="difflineplus">+      );</span>
<a href="#l14.381"></a><span id="l14.381">     } catch (e) {}</span>
<a href="#l14.382"></a><span id="l14.382">   }</span>
<a href="#l14.383"></a><span id="l14.383">   return null;</span>
<a href="#l14.384"></a><span id="l14.384"> }</span>
<a href="#l14.385"></a><span id="l14.385"> </span>
<a href="#l14.386"></a><span id="l14.386"> function CreateMetaElementWithAttribute(name, value) {</span>
<a href="#l14.387"></a><span id="l14.387">   let editor = GetCurrentEditor();</span>
<a href="#l14.388"></a><span id="l14.388">   try {</span>
<a href="#l14.389"></a><span id="l14.389" class="difflineat">@@ -418,24 +483,26 @@ function CreateMetaElementWithAttribute(</span>
<a href="#l14.390"></a><span id="l14.390"> // Change &quot;content&quot; attribute on a META element,</span>
<a href="#l14.391"></a><span id="l14.391"> //   or delete entire element it if content is empty</span>
<a href="#l14.392"></a><span id="l14.392"> // This uses undoable editor transactions</span>
<a href="#l14.393"></a><span id="l14.393"> function SetMetaElementContent(metaElement, content, insertNew, prepend) {</span>
<a href="#l14.394"></a><span id="l14.394">   if (metaElement) {</span>
<a href="#l14.395"></a><span id="l14.395">     var editor = GetCurrentEditor();</span>
<a href="#l14.396"></a><span id="l14.396">     try {</span>
<a href="#l14.397"></a><span id="l14.397">       if (!content || content == &quot;&quot;) {</span>
<a href="#l14.398"></a><span id="l14.398" class="difflineminus">-        if (!insertNew)</span>
<a href="#l14.399"></a><span id="l14.399" class="difflineplus">+        if (!insertNew) {</span>
<a href="#l14.400"></a><span id="l14.400">           editor.deleteNode(metaElement);</span>
<a href="#l14.401"></a><span id="l14.401" class="difflineplus">+        }</span>
<a href="#l14.402"></a><span id="l14.402">       } else if (insertNew) {</span>
<a href="#l14.403"></a><span id="l14.403">         metaElement.setAttribute(&quot;content&quot;, content);</span>
<a href="#l14.404"></a><span id="l14.404" class="difflineminus">-        if (prepend)</span>
<a href="#l14.405"></a><span id="l14.405" class="difflineplus">+        if (prepend) {</span>
<a href="#l14.406"></a><span id="l14.406">           PrependHeadElement(metaElement);</span>
<a href="#l14.407"></a><span id="l14.407" class="difflineminus">-        else</span>
<a href="#l14.408"></a><span id="l14.408" class="difflineplus">+        } else {</span>
<a href="#l14.409"></a><span id="l14.409">           AppendHeadElement(metaElement);</span>
<a href="#l14.410"></a><span id="l14.410" class="difflineplus">+        }</span>
<a href="#l14.411"></a><span id="l14.411">       } else {</span>
<a href="#l14.412"></a><span id="l14.412">         editor.setAttribute(metaElement, &quot;content&quot;, content);</span>
<a href="#l14.413"></a><span id="l14.413">       }</span>
<a href="#l14.414"></a><span id="l14.414">     } catch (e) {}</span>
<a href="#l14.415"></a><span id="l14.415">   }</span>
<a href="#l14.416"></a><span id="l14.416"> }</span>
<a href="#l14.417"></a><span id="l14.417"> </span>
<a href="#l14.418"></a><span id="l14.418"> function GetHeadElement() {</span>
<a href="#l14.419"></a><span id="l14.419" class="difflineat">@@ -458,35 +525,46 @@ function PrependHeadElement(element) {</span>
<a href="#l14.420"></a><span id="l14.420">     } catch (e) {}</span>
<a href="#l14.421"></a><span id="l14.421">   }</span>
<a href="#l14.422"></a><span id="l14.422"> }</span>
<a href="#l14.423"></a><span id="l14.423"> </span>
<a href="#l14.424"></a><span id="l14.424"> function AppendHeadElement(element) {</span>
<a href="#l14.425"></a><span id="l14.425">   var head = GetHeadElement();</span>
<a href="#l14.426"></a><span id="l14.426">   if (head) {</span>
<a href="#l14.427"></a><span id="l14.427">     var position = 0;</span>
<a href="#l14.428"></a><span id="l14.428" class="difflineminus">-    if (head.hasChildNodes())</span>
<a href="#l14.429"></a><span id="l14.429" class="difflineplus">+    if (head.hasChildNodes()) {</span>
<a href="#l14.430"></a><span id="l14.430">       position = head.childNodes.length;</span>
<a href="#l14.431"></a><span id="l14.431" class="difflineplus">+    }</span>
<a href="#l14.432"></a><span id="l14.432"> </span>
<a href="#l14.433"></a><span id="l14.433">     var editor = GetCurrentEditor();</span>
<a href="#l14.434"></a><span id="l14.434">     try {</span>
<a href="#l14.435"></a><span id="l14.435">       // Use editor's undoable transaction</span>
<a href="#l14.436"></a><span id="l14.436">       // Last param &quot;true&quot; says &quot;don't change the selection&quot;</span>
<a href="#l14.437"></a><span id="l14.437">       editor.insertNode(element, head, position, true);</span>
<a href="#l14.438"></a><span id="l14.438">     } catch (e) {}</span>
<a href="#l14.439"></a><span id="l14.439">   }</span>
<a href="#l14.440"></a><span id="l14.440"> }</span>
<a href="#l14.441"></a><span id="l14.441"> </span>
<a href="#l14.442"></a><span id="l14.442"> function SetWindowLocation() {</span>
<a href="#l14.443"></a><span id="l14.443">   gLocation = document.getElementById(&quot;location&quot;);</span>
<a href="#l14.444"></a><span id="l14.444">   if (gLocation) {</span>
<a href="#l14.445"></a><span id="l14.445" class="difflineminus">-    window.screenX = Math.max(0, Math.min(window.opener.screenX + Number(gLocation.getAttribute(&quot;offsetX&quot;)),</span>
<a href="#l14.446"></a><span id="l14.446" class="difflineminus">-                                          screen.availWidth - window.outerWidth));</span>
<a href="#l14.447"></a><span id="l14.447" class="difflineminus">-    window.screenY = Math.max(0, Math.min(window.opener.screenY + Number(gLocation.getAttribute(&quot;offsetY&quot;)),</span>
<a href="#l14.448"></a><span id="l14.448" class="difflineminus">-                                          screen.availHeight - window.outerHeight));</span>
<a href="#l14.449"></a><span id="l14.449" class="difflineplus">+    window.screenX = Math.max(</span>
<a href="#l14.450"></a><span id="l14.450" class="difflineplus">+      0,</span>
<a href="#l14.451"></a><span id="l14.451" class="difflineplus">+      Math.min(</span>
<a href="#l14.452"></a><span id="l14.452" class="difflineplus">+        window.opener.screenX + Number(gLocation.getAttribute(&quot;offsetX&quot;)),</span>
<a href="#l14.453"></a><span id="l14.453" class="difflineplus">+        screen.availWidth - window.outerWidth</span>
<a href="#l14.454"></a><span id="l14.454" class="difflineplus">+      )</span>
<a href="#l14.455"></a><span id="l14.455" class="difflineplus">+    );</span>
<a href="#l14.456"></a><span id="l14.456" class="difflineplus">+    window.screenY = Math.max(</span>
<a href="#l14.457"></a><span id="l14.457" class="difflineplus">+      0,</span>
<a href="#l14.458"></a><span id="l14.458" class="difflineplus">+      Math.min(</span>
<a href="#l14.459"></a><span id="l14.459" class="difflineplus">+        window.opener.screenY + Number(gLocation.getAttribute(&quot;offsetY&quot;)),</span>
<a href="#l14.460"></a><span id="l14.460" class="difflineplus">+        screen.availHeight - window.outerHeight</span>
<a href="#l14.461"></a><span id="l14.461" class="difflineplus">+      )</span>
<a href="#l14.462"></a><span id="l14.462" class="difflineplus">+    );</span>
<a href="#l14.463"></a><span id="l14.463">   }</span>
<a href="#l14.464"></a><span id="l14.464"> }</span>
<a href="#l14.465"></a><span id="l14.465"> </span>
<a href="#l14.466"></a><span id="l14.466"> function SaveWindowLocation() {</span>
<a href="#l14.467"></a><span id="l14.467">   if (gLocation) {</span>
<a href="#l14.468"></a><span id="l14.468">     gLocation.setAttribute(&quot;offsetX&quot;, window.screenX - window.opener.screenX);</span>
<a href="#l14.469"></a><span id="l14.469">     gLocation.setAttribute(&quot;offsetY&quot;, window.screenY - window.opener.screenY);</span>
<a href="#l14.470"></a><span id="l14.470">   }</span>
<a href="#l14.471"></a><span id="l14.471" class="difflineat">@@ -494,30 +572,32 @@ function SaveWindowLocation() {</span>
<a href="#l14.472"></a><span id="l14.472"> </span>
<a href="#l14.473"></a><span id="l14.473"> function onCancel() {</span>
<a href="#l14.474"></a><span id="l14.474">   SaveWindowLocation();</span>
<a href="#l14.475"></a><span id="l14.475"> }</span>
<a href="#l14.476"></a><span id="l14.476"> </span>
<a href="#l14.477"></a><span id="l14.477"> function SetRelativeCheckbox(checkbox) {</span>
<a href="#l14.478"></a><span id="l14.478">   if (!checkbox) {</span>
<a href="#l14.479"></a><span id="l14.479">     checkbox = document.getElementById(&quot;MakeRelativeCheckbox&quot;);</span>
<a href="#l14.480"></a><span id="l14.480" class="difflineminus">-    if (!checkbox)</span>
<a href="#l14.481"></a><span id="l14.481" class="difflineplus">+    if (!checkbox) {</span>
<a href="#l14.482"></a><span id="l14.482">       return;</span>
<a href="#l14.483"></a><span id="l14.483" class="difflineplus">+    }</span>
<a href="#l14.484"></a><span id="l14.484">   }</span>
<a href="#l14.485"></a><span id="l14.485"> </span>
<a href="#l14.486"></a><span id="l14.486">   var editor = GetCurrentEditor();</span>
<a href="#l14.487"></a><span id="l14.487">   // Mail never allows relative URLs, so hide the checkbox</span>
<a href="#l14.488"></a><span id="l14.488" class="difflineminus">-  if (editor &amp;&amp; (editor.flags &amp; Ci.nsIPlaintextEditor.eEditorMailMask)) {</span>
<a href="#l14.489"></a><span id="l14.489" class="difflineplus">+  if (editor &amp;&amp; editor.flags &amp; Ci.nsIPlaintextEditor.eEditorMailMask) {</span>
<a href="#l14.490"></a><span id="l14.490">     checkbox.collapsed = true;</span>
<a href="#l14.491"></a><span id="l14.491">     return;</span>
<a href="#l14.492"></a><span id="l14.492">   }</span>
<a href="#l14.493"></a><span id="l14.493"> </span>
<a href="#l14.494"></a><span id="l14.494" class="difflineminus">-  var input =  document.getElementById(checkbox.getAttribute(&quot;for&quot;));</span>
<a href="#l14.495"></a><span id="l14.495" class="difflineminus">-  if (!input)</span>
<a href="#l14.496"></a><span id="l14.496" class="difflineplus">+  var input = document.getElementById(checkbox.getAttribute(&quot;for&quot;));</span>
<a href="#l14.497"></a><span id="l14.497" class="difflineplus">+  if (!input) {</span>
<a href="#l14.498"></a><span id="l14.498">     return;</span>
<a href="#l14.499"></a><span id="l14.499" class="difflineplus">+  }</span>
<a href="#l14.500"></a><span id="l14.500"> </span>
<a href="#l14.501"></a><span id="l14.501">   var url = TrimString(input.value);</span>
<a href="#l14.502"></a><span id="l14.502">   var urlScheme = GetScheme(url);</span>
<a href="#l14.503"></a><span id="l14.503"> </span>
<a href="#l14.504"></a><span id="l14.504">   // Check it if url is relative (no scheme).</span>
<a href="#l14.505"></a><span id="l14.505">   checkbox.checked = url.length &gt; 0 &amp;&amp; !urlScheme;</span>
<a href="#l14.506"></a><span id="l14.506"> </span>
<a href="#l14.507"></a><span id="l14.507">   // Now do checkbox enabling:</span>
<a href="#l14.508"></a><span id="l14.508" class="difflineat">@@ -526,18 +606,19 @@ function SetRelativeCheckbox(checkbox) {</span>
<a href="#l14.509"></a><span id="l14.509">   var docUrl = GetDocumentBaseUrl();</span>
<a href="#l14.510"></a><span id="l14.510">   var docScheme = GetScheme(docUrl);</span>
<a href="#l14.511"></a><span id="l14.511"> </span>
<a href="#l14.512"></a><span id="l14.512">   if (url &amp;&amp; docUrl &amp;&amp; docScheme) {</span>
<a href="#l14.513"></a><span id="l14.513">     if (urlScheme) {</span>
<a href="#l14.514"></a><span id="l14.514">       // Url is absolute</span>
<a href="#l14.515"></a><span id="l14.515">       // If we can make a relative URL, then enable must be true!</span>
<a href="#l14.516"></a><span id="l14.516">       // (this lets the smarts of MakeRelativeUrl do all the hard work)</span>
<a href="#l14.517"></a><span id="l14.517" class="difflineminus">-      enable = (GetScheme(MakeRelativeUrl(url)).length == 0);</span>
<a href="#l14.518"></a><span id="l14.518" class="difflineminus">-    } else if (url[0] == &quot;#&quot;) { // Url is relative</span>
<a href="#l14.519"></a><span id="l14.519" class="difflineplus">+      enable = GetScheme(MakeRelativeUrl(url)).length == 0;</span>
<a href="#l14.520"></a><span id="l14.520" class="difflineplus">+    } else if (url[0] == &quot;#&quot;) {</span>
<a href="#l14.521"></a><span id="l14.521" class="difflineplus">+      // Url is relative</span>
<a href="#l14.522"></a><span id="l14.522">       // Check if url is a named anchor</span>
<a href="#l14.523"></a><span id="l14.523">       //  but document doesn't have a filename</span>
<a href="#l14.524"></a><span id="l14.524">       // (it's probably &quot;index.html&quot; or &quot;index.htm&quot;,</span>
<a href="#l14.525"></a><span id="l14.525">       //  but we don't want to allow a malformed URL)</span>
<a href="#l14.526"></a><span id="l14.526">       var docFilename = GetFilename(docUrl);</span>
<a href="#l14.527"></a><span id="l14.527">       enable = docFilename.length &gt; 0;</span>
<a href="#l14.528"></a><span id="l14.528">     } else {</span>
<a href="#l14.529"></a><span id="l14.529">       // Any other url is assumed</span>
<a href="#l14.530"></a><span id="l14.530" class="difflineat">@@ -546,33 +627,35 @@ function SetRelativeCheckbox(checkbox) {</span>
<a href="#l14.531"></a><span id="l14.531">     }</span>
<a href="#l14.532"></a><span id="l14.532">   }</span>
<a href="#l14.533"></a><span id="l14.533"> </span>
<a href="#l14.534"></a><span id="l14.534">   SetElementEnabled(checkbox, enable);</span>
<a href="#l14.535"></a><span id="l14.535"> }</span>
<a href="#l14.536"></a><span id="l14.536"> </span>
<a href="#l14.537"></a><span id="l14.537"> // oncommand handler for the Relativize checkbox in EditorOverlay.xul</span>
<a href="#l14.538"></a><span id="l14.538"> function MakeInputValueRelativeOrAbsolute(checkbox) {</span>
<a href="#l14.539"></a><span id="l14.539" class="difflineminus">-  var input =  document.getElementById(checkbox.getAttribute(&quot;for&quot;));</span>
<a href="#l14.540"></a><span id="l14.540" class="difflineminus">-  if (!input)</span>
<a href="#l14.541"></a><span id="l14.541" class="difflineplus">+  var input = document.getElementById(checkbox.getAttribute(&quot;for&quot;));</span>
<a href="#l14.542"></a><span id="l14.542" class="difflineplus">+  if (!input) {</span>
<a href="#l14.543"></a><span id="l14.543">     return;</span>
<a href="#l14.544"></a><span id="l14.544" class="difflineplus">+  }</span>
<a href="#l14.545"></a><span id="l14.545"> </span>
<a href="#l14.546"></a><span id="l14.546">   var docUrl = GetDocumentBaseUrl();</span>
<a href="#l14.547"></a><span id="l14.547">   if (!docUrl) {</span>
<a href="#l14.548"></a><span id="l14.548">     // Checkbox should be disabled if not saved,</span>
<a href="#l14.549"></a><span id="l14.549">     //  but keep this error message in case we change that</span>
<a href="#l14.550"></a><span id="l14.550">     Services.prompt.alert(window, &quot;&quot;, GetString(&quot;SaveToUseRelativeUrl&quot;));</span>
<a href="#l14.551"></a><span id="l14.551">     window.focus();</span>
<a href="#l14.552"></a><span id="l14.552">   } else {</span>
<a href="#l14.553"></a><span id="l14.553">     // Note that &quot;checked&quot; is opposite of its last state,</span>
<a href="#l14.554"></a><span id="l14.554">     //  which determines what we want to do here</span>
<a href="#l14.555"></a><span id="l14.555" class="difflineminus">-    if (checkbox.checked)</span>
<a href="#l14.556"></a><span id="l14.556" class="difflineplus">+    if (checkbox.checked) {</span>
<a href="#l14.557"></a><span id="l14.557">       input.value = MakeRelativeUrl(input.value);</span>
<a href="#l14.558"></a><span id="l14.558" class="difflineminus">-    else</span>
<a href="#l14.559"></a><span id="l14.559" class="difflineplus">+    } else {</span>
<a href="#l14.560"></a><span id="l14.560">       input.value = MakeAbsoluteUrl(input.value);</span>
<a href="#l14.561"></a><span id="l14.561" class="difflineplus">+    }</span>
<a href="#l14.562"></a><span id="l14.562"> </span>
<a href="#l14.563"></a><span id="l14.563">     // Reset checkbox to reflect url state</span>
<a href="#l14.564"></a><span id="l14.564">     SetRelativeCheckbox(checkbox);</span>
<a href="#l14.565"></a><span id="l14.565">   }</span>
<a href="#l14.566"></a><span id="l14.566"> }</span>
<a href="#l14.567"></a><span id="l14.567"> </span>
<a href="#l14.568"></a><span id="l14.568"> var IsBlockParent = [</span>
<a href="#l14.569"></a><span id="l14.569">   &quot;applet&quot;,</span>
<a href="#l14.570"></a><span id="l14.570" class="difflineat">@@ -623,62 +706,75 @@ function InsertElementAroundSelection(el</span>
<a href="#l14.571"></a><span id="l14.571">       range = editor.document.createRange();</span>
<a href="#l14.572"></a><span id="l14.572">       start = editor.selection.getRangeAt(0);</span>
<a href="#l14.573"></a><span id="l14.573">       range.setStart(start.startContainer, start.startOffset);</span>
<a href="#l14.574"></a><span id="l14.574">       end = editor.selection.getRangeAt(--count);</span>
<a href="#l14.575"></a><span id="l14.575">       range.setEnd(end.endContainer, end.endOffset);</span>
<a href="#l14.576"></a><span id="l14.576">     }</span>
<a href="#l14.577"></a><span id="l14.577"> </span>
<a href="#l14.578"></a><span id="l14.578">     // Flatten the selection to child nodes of the common ancestor</span>
<a href="#l14.579"></a><span id="l14.579" class="difflineminus">-    while (range.startContainer != range.commonAncestorContainer)</span>
<a href="#l14.580"></a><span id="l14.580" class="difflineplus">+    while (range.startContainer != range.commonAncestorContainer) {</span>
<a href="#l14.581"></a><span id="l14.581">       range.setStartBefore(range.startContainer);</span>
<a href="#l14.582"></a><span id="l14.582" class="difflineminus">-    while (range.endContainer != range.commonAncestorContainer)</span>
<a href="#l14.583"></a><span id="l14.583" class="difflineplus">+    }</span>
<a href="#l14.584"></a><span id="l14.584" class="difflineplus">+    while (range.endContainer != range.commonAncestorContainer) {</span>
<a href="#l14.585"></a><span id="l14.585">       range.setEndAfter(range.endContainer);</span>
<a href="#l14.586"></a><span id="l14.586" class="difflineplus">+    }</span>
<a href="#l14.587"></a><span id="l14.587"> </span>
<a href="#l14.588"></a><span id="l14.588">     if (editor.nodeIsBlock(element)) {</span>
<a href="#l14.589"></a><span id="l14.589">       // Block element parent must be a valid block</span>
<a href="#l14.590"></a><span id="l14.590" class="difflineminus">-      while (!IsBlockParent.includes(range.commonAncestorContainer.localName))</span>
<a href="#l14.591"></a><span id="l14.591" class="difflineplus">+      while (!IsBlockParent.includes(range.commonAncestorContainer.localName)) {</span>
<a href="#l14.592"></a><span id="l14.592">         range.selectNode(range.commonAncestorContainer);</span>
<a href="#l14.593"></a><span id="l14.593" class="difflineplus">+      }</span>
<a href="#l14.594"></a><span id="l14.594">     } else if (!nodeIsBreak(editor, range.commonAncestorContainer)) {</span>
<a href="#l14.595"></a><span id="l14.595">       // Fail if we're not inserting a block (use setInlineProperty instead)</span>
<a href="#l14.596"></a><span id="l14.596">       return false;</span>
<a href="#l14.597"></a><span id="l14.597" class="difflineminus">-    } else if (NotAnInlineParent.includes(range.commonAncestorContainer.localName)) {</span>
<a href="#l14.598"></a><span id="l14.598" class="difflineplus">+    } else if (</span>
<a href="#l14.599"></a><span id="l14.599" class="difflineplus">+      NotAnInlineParent.includes(range.commonAncestorContainer.localName)</span>
<a href="#l14.600"></a><span id="l14.600" class="difflineplus">+    ) {</span>
<a href="#l14.601"></a><span id="l14.601">       // Inline element parent must not be an invalid block</span>
<a href="#l14.602"></a><span id="l14.602" class="difflineminus">-      do range.selectNode(range.commonAncestorContainer);</span>
<a href="#l14.603"></a><span id="l14.603" class="difflineminus">-      while (NotAnInlineParent.includes(range.commonAncestorContainer.localName));</span>
<a href="#l14.604"></a><span id="l14.604" class="difflineplus">+      do {</span>
<a href="#l14.605"></a><span id="l14.605" class="difflineplus">+        range.selectNode(range.commonAncestorContainer);</span>
<a href="#l14.606"></a><span id="l14.606" class="difflineplus">+      } while (</span>
<a href="#l14.607"></a><span id="l14.607" class="difflineplus">+        NotAnInlineParent.includes(range.commonAncestorContainer.localName)</span>
<a href="#l14.608"></a><span id="l14.608" class="difflineplus">+      );</span>
<a href="#l14.609"></a><span id="l14.609">     } else {</span>
<a href="#l14.610"></a><span id="l14.610">       // Further insert block check</span>
<a href="#l14.611"></a><span id="l14.611">       for (var i = range.startOffset; ; i++) {</span>
<a href="#l14.612"></a><span id="l14.612" class="difflineminus">-        if (i == range.endOffset)</span>
<a href="#l14.613"></a><span id="l14.613" class="difflineplus">+        if (i == range.endOffset) {</span>
<a href="#l14.614"></a><span id="l14.614">           return false;</span>
<a href="#l14.615"></a><span id="l14.615" class="difflineminus">-        else if (nodeIsBreak(editor, range.commonAncestorContainer.childNodes[i]))</span>
<a href="#l14.616"></a><span id="l14.616" class="difflineplus">+        } else if (</span>
<a href="#l14.617"></a><span id="l14.617" class="difflineplus">+          nodeIsBreak(editor, range.commonAncestorContainer.childNodes[i])</span>
<a href="#l14.618"></a><span id="l14.618" class="difflineplus">+        ) {</span>
<a href="#l14.619"></a><span id="l14.619">           break;</span>
<a href="#l14.620"></a><span id="l14.620" class="difflineplus">+        }</span>
<a href="#l14.621"></a><span id="l14.621">       }</span>
<a href="#l14.622"></a><span id="l14.622">     }</span>
<a href="#l14.623"></a><span id="l14.623"> </span>
<a href="#l14.624"></a><span id="l14.624">     // The range may be contained by body text, which should all be selected.</span>
<a href="#l14.625"></a><span id="l14.625">     offset = range.startOffset;</span>
<a href="#l14.626"></a><span id="l14.626">     start = range.startContainer.childNodes[offset];</span>
<a href="#l14.627"></a><span id="l14.627">     if (!nodeIsBreak(editor, start)) {</span>
<a href="#l14.628"></a><span id="l14.628">       while (!nodeIsBreak(editor, start.previousSibling)) {</span>
<a href="#l14.629"></a><span id="l14.629">         start = start.previousSibling;</span>
<a href="#l14.630"></a><span id="l14.630">         offset--;</span>
<a href="#l14.631"></a><span id="l14.631">       }</span>
<a href="#l14.632"></a><span id="l14.632">     }</span>
<a href="#l14.633"></a><span id="l14.633">     end = range.endContainer.childNodes[range.endOffset];</span>
<a href="#l14.634"></a><span id="l14.634">     if (end &amp;&amp; !nodeIsBreak(editor, end.previousSibling)) {</span>
<a href="#l14.635"></a><span id="l14.635" class="difflineminus">-      while (!nodeIsBreak(editor, end))</span>
<a href="#l14.636"></a><span id="l14.636" class="difflineplus">+      while (!nodeIsBreak(editor, end)) {</span>
<a href="#l14.637"></a><span id="l14.637">         end = end.nextSibling;</span>
<a href="#l14.638"></a><span id="l14.638" class="difflineplus">+      }</span>
<a href="#l14.639"></a><span id="l14.639">     }</span>
<a href="#l14.640"></a><span id="l14.640"> </span>
<a href="#l14.641"></a><span id="l14.641">     // Now insert the node</span>
<a href="#l14.642"></a><span id="l14.642">     editor.insertNode(element, range.commonAncestorContainer, offset, true);</span>
<a href="#l14.643"></a><span id="l14.643">     offset = element.childNodes.length;</span>
<a href="#l14.644"></a><span id="l14.644" class="difflineminus">-    if (!editor.nodeIsBlock(element))</span>
<a href="#l14.645"></a><span id="l14.645" class="difflineplus">+    if (!editor.nodeIsBlock(element)) {</span>
<a href="#l14.646"></a><span id="l14.646">       editor.setShouldTxnSetSelection(false);</span>
<a href="#l14.647"></a><span id="l14.647" class="difflineplus">+    }</span>
<a href="#l14.648"></a><span id="l14.648"> </span>
<a href="#l14.649"></a><span id="l14.649">     // Move all the old child nodes to the element</span>
<a href="#l14.650"></a><span id="l14.650">     var empty = true;</span>
<a href="#l14.651"></a><span id="l14.651">     while (start != end) {</span>
<a href="#l14.652"></a><span id="l14.652">       var next = start.nextSibling;</span>
<a href="#l14.653"></a><span id="l14.653">       editor.deleteNode(start);</span>
<a href="#l14.654"></a><span id="l14.654">       editor.insertNode(start, element, element.childNodes.length);</span>
<a href="#l14.655"></a><span id="l14.655">       empty = false;</span>
<a href="#l14.656"></a><span id="l14.656" class="difflineat">@@ -690,72 +786,98 @@ function InsertElementAroundSelection(el</span>
<a href="#l14.657"></a><span id="l14.657">       // Also move a trailing &lt;br&gt;</span>
<a href="#l14.658"></a><span id="l14.658">       // XXX This doesn't work because .localName is lowercase (see bug 1306060).</span>
<a href="#l14.659"></a><span id="l14.659">       if (start &amp;&amp; start.localName == &quot;BR&quot;) {</span>
<a href="#l14.660"></a><span id="l14.660">         editor.deleteNode(start);</span>
<a href="#l14.661"></a><span id="l14.661">         editor.insertNode(start, element, element.childNodes.length);</span>
<a href="#l14.662"></a><span id="l14.662">         empty = false;</span>
<a href="#l14.663"></a><span id="l14.663">       }</span>
<a href="#l14.664"></a><span id="l14.664">       // Still nothing? Insert a &lt;br&gt; so the node is not empty</span>
<a href="#l14.665"></a><span id="l14.665" class="difflineminus">-      if (empty)</span>
<a href="#l14.666"></a><span id="l14.666" class="difflineminus">-        editor.insertNode(editor.createElementWithDefaults(&quot;br&quot;), element, element.childNodes.length);</span>
<a href="#l14.667"></a><span id="l14.667" class="difflineplus">+      if (empty) {</span>
<a href="#l14.668"></a><span id="l14.668" class="difflineplus">+        editor.insertNode(</span>
<a href="#l14.669"></a><span id="l14.669" class="difflineplus">+          editor.createElementWithDefaults(&quot;br&quot;),</span>
<a href="#l14.670"></a><span id="l14.670" class="difflineplus">+          element,</span>
<a href="#l14.671"></a><span id="l14.671" class="difflineplus">+          element.childNodes.length</span>
<a href="#l14.672"></a><span id="l14.672" class="difflineplus">+        );</span>
<a href="#l14.673"></a><span id="l14.673" class="difflineplus">+      }</span>
<a href="#l14.674"></a><span id="l14.674"> </span>
<a href="#l14.675"></a><span id="l14.675">       // Hack to set the selection just inside the element</span>
<a href="#l14.676"></a><span id="l14.676">       editor.insertNode(editor.document.createTextNode(&quot;&quot;), element, offset);</span>
<a href="#l14.677"></a><span id="l14.677">     }</span>
<a href="#l14.678"></a><span id="l14.678">   } finally {</span>
<a href="#l14.679"></a><span id="l14.679">     editor.endTransaction();</span>
<a href="#l14.680"></a><span id="l14.680">   }</span>
<a href="#l14.681"></a><span id="l14.681"> </span>
<a href="#l14.682"></a><span id="l14.682">   return true;</span>
<a href="#l14.683"></a><span id="l14.683"> }</span>
<a href="#l14.684"></a><span id="l14.684"> </span>
<a href="#l14.685"></a><span id="l14.685"> function nodeIsBlank(node) {</span>
<a href="#l14.686"></a><span id="l14.686">   return node &amp;&amp; node.nodeType == Node.TEXT_NODE &amp;&amp; !/\S/.test(node.data);</span>
<a href="#l14.687"></a><span id="l14.687"> }</span>
<a href="#l14.688"></a><span id="l14.688"> </span>
<a href="#l14.689"></a><span id="l14.689"> function nodeBeginsBlock(editor, node) {</span>
<a href="#l14.690"></a><span id="l14.690" class="difflineminus">-  while (nodeIsBlank(node))</span>
<a href="#l14.691"></a><span id="l14.691" class="difflineplus">+  while (nodeIsBlank(node)) {</span>
<a href="#l14.692"></a><span id="l14.692">     node = node.nextSibling;</span>
<a href="#l14.693"></a><span id="l14.693" class="difflineplus">+  }</span>
<a href="#l14.694"></a><span id="l14.694">   return nodeIsBreak(editor, node);</span>
<a href="#l14.695"></a><span id="l14.695"> }</span>
<a href="#l14.696"></a><span id="l14.696"> </span>
<a href="#l14.697"></a><span id="l14.697"> function nodeEndsBlock(editor, node) {</span>
<a href="#l14.698"></a><span id="l14.698" class="difflineminus">-  while (nodeIsBlank(node))</span>
<a href="#l14.699"></a><span id="l14.699" class="difflineplus">+  while (nodeIsBlank(node)) {</span>
<a href="#l14.700"></a><span id="l14.700">     node = node.previousSibling;</span>
<a href="#l14.701"></a><span id="l14.701" class="difflineplus">+  }</span>
<a href="#l14.702"></a><span id="l14.702">   return nodeIsBreak(editor, node);</span>
<a href="#l14.703"></a><span id="l14.703"> }</span>
<a href="#l14.704"></a><span id="l14.704"> </span>
<a href="#l14.705"></a><span id="l14.705"> // C++ function isn't exposed to JS :-(</span>
<a href="#l14.706"></a><span id="l14.706"> function RemoveBlockContainer(element) {</span>
<a href="#l14.707"></a><span id="l14.707">   var editor = GetCurrentEditor();</span>
<a href="#l14.708"></a><span id="l14.708">   editor.beginTransaction();</span>
<a href="#l14.709"></a><span id="l14.709"> </span>
<a href="#l14.710"></a><span id="l14.710">   try {</span>
<a href="#l14.711"></a><span id="l14.711">     var range = editor.document.createRange();</span>
<a href="#l14.712"></a><span id="l14.712">     range.selectNode(element);</span>
<a href="#l14.713"></a><span id="l14.713">     var offset = range.startOffset;</span>
<a href="#l14.714"></a><span id="l14.714">     var parent = element.parentNode;</span>
<a href="#l14.715"></a><span id="l14.715"> </span>
<a href="#l14.716"></a><span id="l14.716">     // May need to insert a break after the removed element</span>
<a href="#l14.717"></a><span id="l14.717" class="difflineminus">-    if (!nodeBeginsBlock(editor, element.nextSibling) &amp;&amp;</span>
<a href="#l14.718"></a><span id="l14.718" class="difflineminus">-        !nodeEndsBlock(editor, element.lastChild))</span>
<a href="#l14.719"></a><span id="l14.719" class="difflineminus">-      editor.insertNode(editor.createElementWithDefaults(&quot;br&quot;), parent, range.endOffset);</span>
<a href="#l14.720"></a><span id="l14.720" class="difflineplus">+    if (</span>
<a href="#l14.721"></a><span id="l14.721" class="difflineplus">+      !nodeBeginsBlock(editor, element.nextSibling) &amp;&amp;</span>
<a href="#l14.722"></a><span id="l14.722" class="difflineplus">+      !nodeEndsBlock(editor, element.lastChild)</span>
<a href="#l14.723"></a><span id="l14.723" class="difflineplus">+    ) {</span>
<a href="#l14.724"></a><span id="l14.724" class="difflineplus">+      editor.insertNode(</span>
<a href="#l14.725"></a><span id="l14.725" class="difflineplus">+        editor.createElementWithDefaults(&quot;br&quot;),</span>
<a href="#l14.726"></a><span id="l14.726" class="difflineplus">+        parent,</span>
<a href="#l14.727"></a><span id="l14.727" class="difflineplus">+        range.endOffset</span>
<a href="#l14.728"></a><span id="l14.728" class="difflineplus">+      );</span>
<a href="#l14.729"></a><span id="l14.729" class="difflineplus">+    }</span>
<a href="#l14.730"></a><span id="l14.730"> </span>
<a href="#l14.731"></a><span id="l14.731">     // May need to insert a break before the removed element, or if it was empty</span>
<a href="#l14.732"></a><span id="l14.732" class="difflineminus">-    if (!nodeEndsBlock(editor, element.previousSibling) &amp;&amp;</span>
<a href="#l14.733"></a><span id="l14.733" class="difflineminus">-        !nodeBeginsBlock(editor, element.firstChild || element.nextSibling))</span>
<a href="#l14.734"></a><span id="l14.734" class="difflineminus">-      editor.insertNode(editor.createElementWithDefaults(&quot;br&quot;), parent, offset++);</span>
<a href="#l14.735"></a><span id="l14.735" class="difflineplus">+    if (</span>
<a href="#l14.736"></a><span id="l14.736" class="difflineplus">+      !nodeEndsBlock(editor, element.previousSibling) &amp;&amp;</span>
<a href="#l14.737"></a><span id="l14.737" class="difflineplus">+      !nodeBeginsBlock(editor, element.firstChild || element.nextSibling)</span>
<a href="#l14.738"></a><span id="l14.738" class="difflineplus">+    ) {</span>
<a href="#l14.739"></a><span id="l14.739" class="difflineplus">+      editor.insertNode(</span>
<a href="#l14.740"></a><span id="l14.740" class="difflineplus">+        editor.createElementWithDefaults(&quot;br&quot;),</span>
<a href="#l14.741"></a><span id="l14.741" class="difflineplus">+        parent,</span>
<a href="#l14.742"></a><span id="l14.742" class="difflineplus">+        offset++</span>
<a href="#l14.743"></a><span id="l14.743" class="difflineplus">+      );</span>
<a href="#l14.744"></a><span id="l14.744" class="difflineplus">+    }</span>
<a href="#l14.745"></a><span id="l14.745"> </span>
<a href="#l14.746"></a><span id="l14.746">     // Now remove the element</span>
<a href="#l14.747"></a><span id="l14.747">     editor.deleteNode(element);</span>
<a href="#l14.748"></a><span id="l14.748"> </span>
<a href="#l14.749"></a><span id="l14.749">     // Need to copy the contained nodes?</span>
<a href="#l14.750"></a><span id="l14.750" class="difflineminus">-    for (var i = 0; i &lt; element.childNodes.length; i++)</span>
<a href="#l14.751"></a><span id="l14.751" class="difflineminus">-      editor.insertNode(element.childNodes[i].cloneNode(true), parent, offset++);</span>
<a href="#l14.752"></a><span id="l14.752" class="difflineplus">+    for (var i = 0; i &lt; element.childNodes.length; i++) {</span>
<a href="#l14.753"></a><span id="l14.753" class="difflineplus">+      editor.insertNode(</span>
<a href="#l14.754"></a><span id="l14.754" class="difflineplus">+        element.childNodes[i].cloneNode(true),</span>
<a href="#l14.755"></a><span id="l14.755" class="difflineplus">+        parent,</span>
<a href="#l14.756"></a><span id="l14.756" class="difflineplus">+        offset++</span>
<a href="#l14.757"></a><span id="l14.757" class="difflineplus">+      );</span>
<a href="#l14.758"></a><span id="l14.758" class="difflineplus">+    }</span>
<a href="#l14.759"></a><span id="l14.759">   } finally {</span>
<a href="#l14.760"></a><span id="l14.760">     editor.endTransaction();</span>
<a href="#l14.761"></a><span id="l14.761">   }</span>
<a href="#l14.762"></a><span id="l14.762"> }</span>
<a href="#l14.763"></a><span id="l14.763"> </span>
<a href="#l14.764"></a><span id="l14.764"> // C++ function isn't exposed to JS :-(</span>
<a href="#l14.765"></a><span id="l14.765"> function RemoveContainer(element) {</span>
<a href="#l14.766"></a><span id="l14.766">   var editor = GetCurrentEditor();</span>
<a href="#l14.767"></a><span id="l14.767" class="difflineat">@@ -764,116 +886,149 @@ function RemoveContainer(element) {</span>
<a href="#l14.768"></a><span id="l14.768">   try {</span>
<a href="#l14.769"></a><span id="l14.769">     var range = editor.document.createRange();</span>
<a href="#l14.770"></a><span id="l14.770">     var parent = element.parentNode;</span>
<a href="#l14.771"></a><span id="l14.771">     // Allow for automatic joining of text nodes</span>
<a href="#l14.772"></a><span id="l14.772">     // so we can't delete the container yet</span>
<a href="#l14.773"></a><span id="l14.773">     // so we need to copy the contained nodes</span>
<a href="#l14.774"></a><span id="l14.774">     for (var i = 0; i &lt; element.childNodes.length; i++) {</span>
<a href="#l14.775"></a><span id="l14.775">       range.selectNode(element);</span>
<a href="#l14.776"></a><span id="l14.776" class="difflineminus">-      editor.insertNode(element.childNodes[i].cloneNode(true), parent, range.startOffset);</span>
<a href="#l14.777"></a><span id="l14.777" class="difflineplus">+      editor.insertNode(</span>
<a href="#l14.778"></a><span id="l14.778" class="difflineplus">+        element.childNodes[i].cloneNode(true),</span>
<a href="#l14.779"></a><span id="l14.779" class="difflineplus">+        parent,</span>
<a href="#l14.780"></a><span id="l14.780" class="difflineplus">+        range.startOffset</span>
<a href="#l14.781"></a><span id="l14.781" class="difflineplus">+      );</span>
<a href="#l14.782"></a><span id="l14.782">     }</span>
<a href="#l14.783"></a><span id="l14.783">     // Now remove the element</span>
<a href="#l14.784"></a><span id="l14.784">     editor.deleteNode(element);</span>
<a href="#l14.785"></a><span id="l14.785">   } finally {</span>
<a href="#l14.786"></a><span id="l14.786">     editor.endTransaction();</span>
<a href="#l14.787"></a><span id="l14.787">   }</span>
<a href="#l14.788"></a><span id="l14.788"> }</span>
<a href="#l14.789"></a><span id="l14.789"> </span>
<a href="#l14.790"></a><span id="l14.790"> function FillLinkMenulist(linkMenulist, headingsArray) {</span>
<a href="#l14.791"></a><span id="l14.791">   var menupopup = linkMenulist.firstChild;</span>
<a href="#l14.792"></a><span id="l14.792">   var editor = GetCurrentEditor();</span>
<a href="#l14.793"></a><span id="l14.793">   try {</span>
<a href="#l14.794"></a><span id="l14.794" class="difflineminus">-    var treeWalker = editor.document.createTreeWalker(editor.document, 1, null, true);</span>
<a href="#l14.795"></a><span id="l14.795" class="difflineplus">+    var treeWalker = editor.document.createTreeWalker(</span>
<a href="#l14.796"></a><span id="l14.796" class="difflineplus">+      editor.document,</span>
<a href="#l14.797"></a><span id="l14.797" class="difflineplus">+      1,</span>
<a href="#l14.798"></a><span id="l14.798" class="difflineplus">+      null,</span>
<a href="#l14.799"></a><span id="l14.799" class="difflineplus">+      true</span>
<a href="#l14.800"></a><span id="l14.800" class="difflineplus">+    );</span>
<a href="#l14.801"></a><span id="l14.801">     var headingList = [];</span>
<a href="#l14.802"></a><span id="l14.802">     var anchorList = []; // for sorting</span>
<a href="#l14.803"></a><span id="l14.803" class="difflineminus">-    var anchorMap  = {}; // for weeding out duplicates and making heading anchors unique</span>
<a href="#l14.804"></a><span id="l14.804" class="difflineplus">+    var anchorMap = {}; // for weeding out duplicates and making heading anchors unique</span>
<a href="#l14.805"></a><span id="l14.805">     var anchor;</span>
<a href="#l14.806"></a><span id="l14.806">     var i;</span>
<a href="#l14.807"></a><span id="l14.807" class="difflineminus">-    for (var element = treeWalker.nextNode(); element; element = treeWalker.nextNode()) {</span>
<a href="#l14.808"></a><span id="l14.808" class="difflineplus">+    for (</span>
<a href="#l14.809"></a><span id="l14.809" class="difflineplus">+      var element = treeWalker.nextNode();</span>
<a href="#l14.810"></a><span id="l14.810" class="difflineplus">+      element;</span>
<a href="#l14.811"></a><span id="l14.811" class="difflineplus">+      element = treeWalker.nextNode()</span>
<a href="#l14.812"></a><span id="l14.812" class="difflineplus">+    ) {</span>
<a href="#l14.813"></a><span id="l14.813">       // grab headings</span>
<a href="#l14.814"></a><span id="l14.814">       // Skip headings that already have a named anchor as their first child</span>
<a href="#l14.815"></a><span id="l14.815">       //  (this may miss nearby anchors, but at least we don't insert another</span>
<a href="#l14.816"></a><span id="l14.816">       //   under the same heading)</span>
<a href="#l14.817"></a><span id="l14.817" class="difflineminus">-      if (element instanceof HTMLHeadingElement &amp;&amp; element.textContent &amp;&amp;</span>
<a href="#l14.818"></a><span id="l14.818" class="difflineminus">-          !(element.firstChild instanceof HTMLAnchorElement &amp;&amp; element.firstChild.name))</span>
<a href="#l14.819"></a><span id="l14.819" class="difflineplus">+      if (</span>
<a href="#l14.820"></a><span id="l14.820" class="difflineplus">+        element instanceof HTMLHeadingElement &amp;&amp;</span>
<a href="#l14.821"></a><span id="l14.821" class="difflineplus">+        element.textContent &amp;&amp;</span>
<a href="#l14.822"></a><span id="l14.822" class="difflineplus">+        !(</span>
<a href="#l14.823"></a><span id="l14.823" class="difflineplus">+          element.firstChild instanceof HTMLAnchorElement &amp;&amp;</span>
<a href="#l14.824"></a><span id="l14.824" class="difflineplus">+          element.firstChild.name</span>
<a href="#l14.825"></a><span id="l14.825" class="difflineplus">+        )</span>
<a href="#l14.826"></a><span id="l14.826" class="difflineplus">+      ) {</span>
<a href="#l14.827"></a><span id="l14.827">         headingList.push(element);</span>
<a href="#l14.828"></a><span id="l14.828" class="difflineplus">+      }</span>
<a href="#l14.829"></a><span id="l14.829"> </span>
<a href="#l14.830"></a><span id="l14.830">       // grab named anchors</span>
<a href="#l14.831"></a><span id="l14.831">       if (element instanceof HTMLAnchorElement &amp;&amp; element.name) {</span>
<a href="#l14.832"></a><span id="l14.832">         anchor = &quot;#&quot; + element.name;</span>
<a href="#l14.833"></a><span id="l14.833">         if (!(anchor in anchorMap)) {</span>
<a href="#l14.834"></a><span id="l14.834" class="difflineminus">-          anchorList.push({anchor, sortkey: anchor.toLowerCase()});</span>
<a href="#l14.835"></a><span id="l14.835" class="difflineplus">+          anchorList.push({ anchor, sortkey: anchor.toLowerCase() });</span>
<a href="#l14.836"></a><span id="l14.836">           anchorMap[anchor] = true;</span>
<a href="#l14.837"></a><span id="l14.837">         }</span>
<a href="#l14.838"></a><span id="l14.838">       }</span>
<a href="#l14.839"></a><span id="l14.839"> </span>
<a href="#l14.840"></a><span id="l14.840">       // grab IDs</span>
<a href="#l14.841"></a><span id="l14.841">       if (element.id) {</span>
<a href="#l14.842"></a><span id="l14.842">         anchor = &quot;#&quot; + element.id;</span>
<a href="#l14.843"></a><span id="l14.843">         if (!(anchor in anchorMap)) {</span>
<a href="#l14.844"></a><span id="l14.844" class="difflineminus">-          anchorList.push({anchor, sortkey: anchor.toLowerCase()});</span>
<a href="#l14.845"></a><span id="l14.845" class="difflineplus">+          anchorList.push({ anchor, sortkey: anchor.toLowerCase() });</span>
<a href="#l14.846"></a><span id="l14.846">           anchorMap[anchor] = true;</span>
<a href="#l14.847"></a><span id="l14.847">         }</span>
<a href="#l14.848"></a><span id="l14.848">       }</span>
<a href="#l14.849"></a><span id="l14.849">     }</span>
<a href="#l14.850"></a><span id="l14.850">     // add anchor for headings</span>
<a href="#l14.851"></a><span id="l14.851">     for (i = 0; i &lt; headingList.length; i++) {</span>
<a href="#l14.852"></a><span id="l14.852">       var heading = headingList[i];</span>
<a href="#l14.853"></a><span id="l14.853"> </span>
<a href="#l14.854"></a><span id="l14.854">       // Use just first 40 characters, don't add &quot;...&quot;,</span>
<a href="#l14.855"></a><span id="l14.855">       //  and replace whitespace with &quot;_&quot; and strip non-word characters</span>
<a href="#l14.856"></a><span id="l14.856" class="difflineminus">-      anchor = &quot;#&quot; + ConvertToCDATAString(TruncateStringAtWordEnd(heading.textContent, 40, false));</span>
<a href="#l14.857"></a><span id="l14.857" class="difflineplus">+      anchor =</span>
<a href="#l14.858"></a><span id="l14.858" class="difflineplus">+        &quot;#&quot; +</span>
<a href="#l14.859"></a><span id="l14.859" class="difflineplus">+        ConvertToCDATAString(</span>
<a href="#l14.860"></a><span id="l14.860" class="difflineplus">+          TruncateStringAtWordEnd(heading.textContent, 40, false)</span>
<a href="#l14.861"></a><span id="l14.861" class="difflineplus">+        );</span>
<a href="#l14.862"></a><span id="l14.862"> </span>
<a href="#l14.863"></a><span id="l14.863">       // Append &quot;_&quot; to any name already in the list</span>
<a href="#l14.864"></a><span id="l14.864" class="difflineminus">-      while (anchor in anchorMap)</span>
<a href="#l14.865"></a><span id="l14.865" class="difflineplus">+      while (anchor in anchorMap) {</span>
<a href="#l14.866"></a><span id="l14.866">         anchor += &quot;_&quot;;</span>
<a href="#l14.867"></a><span id="l14.867" class="difflineminus">-      anchorList.push({anchor, sortkey: anchor.toLowerCase()});</span>
<a href="#l14.868"></a><span id="l14.868" class="difflineplus">+      }</span>
<a href="#l14.869"></a><span id="l14.869" class="difflineplus">+      anchorList.push({ anchor, sortkey: anchor.toLowerCase() });</span>
<a href="#l14.870"></a><span id="l14.870">       anchorMap[anchor] = true;</span>
<a href="#l14.871"></a><span id="l14.871"> </span>
<a href="#l14.872"></a><span id="l14.872">       // Save nodes in an array so we can create anchor node under it later</span>
<a href="#l14.873"></a><span id="l14.873">       headingsArray[anchor] = heading;</span>
<a href="#l14.874"></a><span id="l14.874">     }</span>
<a href="#l14.875"></a><span id="l14.875">     if (anchorList.length) {</span>
<a href="#l14.876"></a><span id="l14.876">       // case insensitive sort</span>
<a href="#l14.877"></a><span id="l14.877">       anchorList.sort((a, b) =&gt; {</span>
<a href="#l14.878"></a><span id="l14.878" class="difflineminus">-        if (a.sortkey &lt; b.sortkey) return -1;</span>
<a href="#l14.879"></a><span id="l14.879" class="difflineminus">-        if (a.sortkey &gt; b.sortkey) return 1;</span>
<a href="#l14.880"></a><span id="l14.880" class="difflineplus">+        if (a.sortkey &lt; b.sortkey) {</span>
<a href="#l14.881"></a><span id="l14.881" class="difflineplus">+          return -1;</span>
<a href="#l14.882"></a><span id="l14.882" class="difflineplus">+        }</span>
<a href="#l14.883"></a><span id="l14.883" class="difflineplus">+        if (a.sortkey &gt; b.sortkey) {</span>
<a href="#l14.884"></a><span id="l14.884" class="difflineplus">+          return 1;</span>
<a href="#l14.885"></a><span id="l14.885" class="difflineplus">+        }</span>
<a href="#l14.886"></a><span id="l14.886">         return 0;</span>
<a href="#l14.887"></a><span id="l14.887">       });</span>
<a href="#l14.888"></a><span id="l14.888"> </span>
<a href="#l14.889"></a><span id="l14.889" class="difflineminus">-      for (i = 0; i &lt; anchorList.length; i++)</span>
<a href="#l14.890"></a><span id="l14.890" class="difflineplus">+      for (i = 0; i &lt; anchorList.length; i++) {</span>
<a href="#l14.891"></a><span id="l14.891">         createMenuItem(menupopup, anchorList[i].anchor);</span>
<a href="#l14.892"></a><span id="l14.892" class="difflineplus">+      }</span>
<a href="#l14.893"></a><span id="l14.893">     } else {</span>
<a href="#l14.894"></a><span id="l14.894">       // Don't bother with named anchors in Mail.</span>
<a href="#l14.895"></a><span id="l14.895" class="difflineminus">-      if (editor &amp;&amp; (editor.flags &amp; Ci.nsIPlaintextEditor.eEditorMailMask)) {</span>
<a href="#l14.896"></a><span id="l14.896" class="difflineplus">+      if (editor &amp;&amp; editor.flags &amp; Ci.nsIPlaintextEditor.eEditorMailMask) {</span>
<a href="#l14.897"></a><span id="l14.897">         menupopup.remove();</span>
<a href="#l14.898"></a><span id="l14.898">         linkMenulist.removeAttribute(&quot;enablehistory&quot;);</span>
<a href="#l14.899"></a><span id="l14.899">         return;</span>
<a href="#l14.900"></a><span id="l14.900">       }</span>
<a href="#l14.901"></a><span id="l14.901" class="difflineminus">-      var item = createMenuItem(menupopup, GetString(&quot;NoNamedAnchorsOrHeadings&quot;));</span>
<a href="#l14.902"></a><span id="l14.902" class="difflineplus">+      var item = createMenuItem(</span>
<a href="#l14.903"></a><span id="l14.903" class="difflineplus">+        menupopup,</span>
<a href="#l14.904"></a><span id="l14.904" class="difflineplus">+        GetString(&quot;NoNamedAnchorsOrHeadings&quot;)</span>
<a href="#l14.905"></a><span id="l14.905" class="difflineplus">+      );</span>
<a href="#l14.906"></a><span id="l14.906">       item.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l14.907"></a><span id="l14.907">     }</span>
<a href="#l14.908"></a><span id="l14.908">   } catch (e) {}</span>
<a href="#l14.909"></a><span id="l14.909"> }</span>
<a href="#l14.910"></a><span id="l14.910"> </span>
<a href="#l14.911"></a><span id="l14.911"> function createMenuItem(aMenuPopup, aLabel) {</span>
<a href="#l14.912"></a><span id="l14.912">   var menuitem = document.createXULElement(&quot;menuitem&quot;);</span>
<a href="#l14.913"></a><span id="l14.913">   menuitem.setAttribute(&quot;label&quot;, aLabel);</span>
<a href="#l14.914"></a><span id="l14.914">   aMenuPopup.appendChild(menuitem);</span>
<a href="#l14.915"></a><span id="l14.915">   return menuitem;</span>
<a href="#l14.916"></a><span id="l14.916"> }</span>
<a href="#l14.917"></a><span id="l14.917"> </span>
<a href="#l14.918"></a><span id="l14.918"> // Shared by Image and Link dialogs for the &quot;Choose&quot; button for links</span>
<a href="#l14.919"></a><span id="l14.919"> function chooseLinkFile() {</span>
<a href="#l14.920"></a><span id="l14.920">   GetLocalFileURL(&quot;html, img&quot;).then(fileURL =&gt; {</span>
<a href="#l14.921"></a><span id="l14.921">     // Always try to relativize local file URLs</span>
<a href="#l14.922"></a><span id="l14.922" class="difflineminus">-    if (gHaveDocumentUrl)</span>
<a href="#l14.923"></a><span id="l14.923" class="difflineplus">+    if (gHaveDocumentUrl) {</span>
<a href="#l14.924"></a><span id="l14.924">       fileURL = MakeRelativeUrl(fileURL);</span>
<a href="#l14.925"></a><span id="l14.925" class="difflineplus">+    }</span>
<a href="#l14.926"></a><span id="l14.926"> </span>
<a href="#l14.927"></a><span id="l14.927">     gDialog.hrefInput.value = fileURL;</span>
<a href="#l14.928"></a><span id="l14.928"> </span>
<a href="#l14.929"></a><span id="l14.929">     // Do stuff specific to a particular dialog</span>
<a href="#l14.930"></a><span id="l14.930">     // (This is defined separately in Image and Link dialogs)</span>
<a href="#l14.931"></a><span id="l14.931">     ChangeLinkLocation();</span>
<a href="#l14.932"></a><span id="l14.932">   });</span>
<a href="#l14.933"></a><span id="l14.933"> }</span>
<a href="#l14.934"></a><span id="l14.934" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdDictionary.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdDictionary.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -10,18 +10,19 @@ var gSpellChecker;</span>
<a href="#l15.4"></a><span id="l15.4"> var gWordToAdd;</span>
<a href="#l15.5"></a><span id="l15.5"> </span>
<a href="#l15.6"></a><span id="l15.6"> function Startup() {</span>
<a href="#l15.7"></a><span id="l15.7">   if (!GetCurrentEditor()) {</span>
<a href="#l15.8"></a><span id="l15.8">     window.close();</span>
<a href="#l15.9"></a><span id="l15.9">     return;</span>
<a href="#l15.10"></a><span id="l15.10">   }</span>
<a href="#l15.11"></a><span id="l15.11">   // Get the SpellChecker shell</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  if (&quot;gSpellChecker&quot; in window.opener &amp;&amp; window.opener.gSpellChecker)</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+  if (&quot;gSpellChecker&quot; in window.opener &amp;&amp; window.opener.gSpellChecker) {</span>
<a href="#l15.14"></a><span id="l15.14">     gSpellChecker = window.opener.gSpellChecker;</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+  }</span>
<a href="#l15.16"></a><span id="l15.16"> </span>
<a href="#l15.17"></a><span id="l15.17">   if (!gSpellChecker) {</span>
<a href="#l15.18"></a><span id="l15.18">     dump(&quot;SpellChecker not found!!!\n&quot;);</span>
<a href="#l15.19"></a><span id="l15.19">     window.close();</span>
<a href="#l15.20"></a><span id="l15.20">     return;</span>
<a href="#l15.21"></a><span id="l15.21">   }</span>
<a href="#l15.22"></a><span id="l15.22">   // The word to add word is passed as the 2nd extra parameter in window.openDialog()</span>
<a href="#l15.23"></a><span id="l15.23">   gWordToAdd = window.arguments[1];</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineat">@@ -37,17 +38,17 @@ function Startup() {</span>
<a href="#l15.25"></a><span id="l15.25">   SetTextboxFocus(gDialog.WordInput);</span>
<a href="#l15.26"></a><span id="l15.26"> }</span>
<a href="#l15.27"></a><span id="l15.27"> </span>
<a href="#l15.28"></a><span id="l15.28"> function ValidateWordToAdd() {</span>
<a href="#l15.29"></a><span id="l15.29">   gWordToAdd = TrimString(gDialog.WordInput.value);</span>
<a href="#l15.30"></a><span id="l15.30">   if (gWordToAdd.length &gt; 0) {</span>
<a href="#l15.31"></a><span id="l15.31">     return true;</span>
<a href="#l15.32"></a><span id="l15.32">   }</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineminus">-    return false;</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+  return false;</span>
<a href="#l15.35"></a><span id="l15.35"> }</span>
<a href="#l15.36"></a><span id="l15.36"> </span>
<a href="#l15.37"></a><span id="l15.37"> function SelectWordToAddInList() {</span>
<a href="#l15.38"></a><span id="l15.38">   for (var i = 0; i &lt; gDialog.DictionaryList.getRowCount(); i++) {</span>
<a href="#l15.39"></a><span id="l15.39">     var wordInList = gDialog.DictionaryList.getItemAtIndex(i);</span>
<a href="#l15.40"></a><span id="l15.40">     if (wordInList &amp;&amp; gWordToAdd == wordInList.label) {</span>
<a href="#l15.41"></a><span id="l15.41">       gDialog.DictionaryList.selectedIndex = i;</span>
<a href="#l15.42"></a><span id="l15.42">       break;</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineat">@@ -55,17 +56,19 @@ function SelectWordToAddInList() {</span>
<a href="#l15.44"></a><span id="l15.44">   }</span>
<a href="#l15.45"></a><span id="l15.45"> }</span>
<a href="#l15.46"></a><span id="l15.46"> </span>
<a href="#l15.47"></a><span id="l15.47"> function AddWord() {</span>
<a href="#l15.48"></a><span id="l15.48">   if (ValidateWordToAdd()) {</span>
<a href="#l15.49"></a><span id="l15.49">     try {</span>
<a href="#l15.50"></a><span id="l15.50">       gSpellChecker.AddWordToDictionary(gWordToAdd);</span>
<a href="#l15.51"></a><span id="l15.51">     } catch (e) {</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineminus">-      dump(&quot;Exception occurred in gSpellChecker.AddWordToDictionary\nWord to add probably already existed\n&quot;);</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+      dump(</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+        &quot;Exception occurred in gSpellChecker.AddWordToDictionary\nWord to add probably already existed\n&quot;</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+      );</span>
<a href="#l15.56"></a><span id="l15.56">     }</span>
<a href="#l15.57"></a><span id="l15.57"> </span>
<a href="#l15.58"></a><span id="l15.58">     // Rebuild the dialog list</span>
<a href="#l15.59"></a><span id="l15.59">     FillDictionaryList();</span>
<a href="#l15.60"></a><span id="l15.60"> </span>
<a href="#l15.61"></a><span id="l15.61">     SelectWordToAddInList();</span>
<a href="#l15.62"></a><span id="l15.62">     gDialog.WordInput.value = &quot;&quot;;</span>
<a href="#l15.63"></a><span id="l15.63">   }</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineat">@@ -133,26 +136,29 @@ function FillDictionaryList() {</span>
<a href="#l15.65"></a><span id="l15.65">     if (word != &quot;&quot;) {</span>
<a href="#l15.66"></a><span id="l15.66">       gDialog.DictionaryList.appendItem(word, &quot;&quot;);</span>
<a href="#l15.67"></a><span id="l15.67">       haveList = true;</span>
<a href="#l15.68"></a><span id="l15.68">     }</span>
<a href="#l15.69"></a><span id="l15.69">   } while (word != &quot;&quot;);</span>
<a href="#l15.70"></a><span id="l15.70"> </span>
<a href="#l15.71"></a><span id="l15.71">   // XXX: BUG 74467: If list is empty, it doesn't layout to full height correctly</span>
<a href="#l15.72"></a><span id="l15.72">   //     (ignores &quot;rows&quot; attribute) (bug is latered, so we are fixing here for now)</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineminus">-  if (!haveList)</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineminus">-      gDialog.DictionaryList.appendItem(&quot;&quot;, &quot;&quot;);</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+  if (!haveList) {</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+    gDialog.DictionaryList.appendItem(&quot;&quot;, &quot;&quot;);</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineplus">+  }</span>
<a href="#l15.78"></a><span id="l15.78"> </span>
<a href="#l15.79"></a><span id="l15.79">   ResetSelectedItem(selIndex);</span>
<a href="#l15.80"></a><span id="l15.80"> }</span>
<a href="#l15.81"></a><span id="l15.81"> </span>
<a href="#l15.82"></a><span id="l15.82"> function ResetSelectedItem(index) {</span>
<a href="#l15.83"></a><span id="l15.83">   var lastIndex = gDialog.DictionaryList.getRowCount() - 1;</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineminus">-  if (index &gt; lastIndex)</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineplus">+  if (index &gt; lastIndex) {</span>
<a href="#l15.86"></a><span id="l15.86">     index = lastIndex;</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineplus">+  }</span>
<a href="#l15.88"></a><span id="l15.88"> </span>
<a href="#l15.89"></a><span id="l15.89">   // If we didn't have a selected item,</span>
<a href="#l15.90"></a><span id="l15.90">   //  set it to the first item</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineminus">-  if (index == -1 &amp;&amp; lastIndex &gt;= 0)</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineplus">+  if (index == -1 &amp;&amp; lastIndex &gt;= 0) {</span>
<a href="#l15.93"></a><span id="l15.93">     index = 0;</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineplus">+  }</span>
<a href="#l15.95"></a><span id="l15.95"> </span>
<a href="#l15.96"></a><span id="l15.96">   gDialog.DictionaryList.selectedIndex = index;</span>
<a href="#l15.97"></a><span id="l15.97"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdFieldSetProps.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdFieldSetProps.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -28,20 +28,28 @@ function Startup() {</span>
<a href="#l16.4"></a><span id="l16.4">   gDialog.legendAlign = document.getElementById(&quot;LegendAlign&quot;);</span>
<a href="#l16.5"></a><span id="l16.5">   gDialog.RemoveFieldSet = document.getElementById(&quot;RemoveFieldSet&quot;);</span>
<a href="#l16.6"></a><span id="l16.6"> </span>
<a href="#l16.7"></a><span id="l16.7">   // Get a single selected field set element</span>
<a href="#l16.8"></a><span id="l16.8">   const kTagName = &quot;fieldset&quot;;</span>
<a href="#l16.9"></a><span id="l16.9">   try {</span>
<a href="#l16.10"></a><span id="l16.10">     // Find a selected fieldset, or if one is at start or end of selection.</span>
<a href="#l16.11"></a><span id="l16.11">     fieldsetElement = editor.getSelectedElement(kTagName);</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-    if (!fieldsetElement)</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-      fieldsetElement = editor.getElementOrParentByTagName(kTagName, editor.selection.anchorNode);</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-    if (!fieldsetElement)</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-      fieldsetElement = editor.getElementOrParentByTagName(kTagName, editor.selection.focusNode);</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+    if (!fieldsetElement) {</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+      fieldsetElement = editor.getElementOrParentByTagName(</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+        kTagName,</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+        editor.selection.anchorNode</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+      );</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+    }</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+    if (!fieldsetElement) {</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+      fieldsetElement = editor.getElementOrParentByTagName(</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineplus">+        kTagName,</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+        editor.selection.focusNode</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineplus">+      );</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineplus">+    }</span>
<a href="#l16.28"></a><span id="l16.28">   } catch (e) {}</span>
<a href="#l16.29"></a><span id="l16.29"> </span>
<a href="#l16.30"></a><span id="l16.30">   if (fieldsetElement) {</span>
<a href="#l16.31"></a><span id="l16.31">     // We found an element and don't need to insert one</span>
<a href="#l16.32"></a><span id="l16.32">     insertNew = false;</span>
<a href="#l16.33"></a><span id="l16.33">   } else {</span>
<a href="#l16.34"></a><span id="l16.34">     insertNew = true;</span>
<a href="#l16.35"></a><span id="l16.35"> </span>
<a href="#l16.36"></a><span id="l16.36" class="difflineat">@@ -65,19 +73,26 @@ function Startup() {</span>
<a href="#l16.37"></a><span id="l16.37">     newLegend = false;</span>
<a href="#l16.38"></a><span id="l16.38">     var range = editor.document.createRange();</span>
<a href="#l16.39"></a><span id="l16.39">     range.selectNode(legendElement);</span>
<a href="#l16.40"></a><span id="l16.40">     gDialog.legendText.value = range.toString();</span>
<a href="#l16.41"></a><span id="l16.41">     if (legendElement.innerHTML.includes(&quot;&lt;&quot;)) {</span>
<a href="#l16.42"></a><span id="l16.42">       gDialog.editText.checked = false;</span>
<a href="#l16.43"></a><span id="l16.43">       gDialog.editText.disabled = false;</span>
<a href="#l16.44"></a><span id="l16.44">       gDialog.legendText.disabled = true;</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineminus">-      gDialog.editText.addEventListener(&quot;command&quot;,</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineminus">-        () =&gt; Services.prompt.alert(window, GetString(&quot;Alert&quot;), GetString(&quot;EditTextWarning&quot;)),</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineminus">-        {capture: false, once: true});</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+      gDialog.editText.addEventListener(</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+        &quot;command&quot;,</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+        () =&gt;</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+          Services.prompt.alert(</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+            window,</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineplus">+            GetString(&quot;Alert&quot;),</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+            GetString(&quot;EditTextWarning&quot;)</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineplus">+          ),</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+        { capture: false, once: true }</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+      );</span>
<a href="#l16.58"></a><span id="l16.58">       gDialog.RemoveFieldSet.focus();</span>
<a href="#l16.59"></a><span id="l16.59">     } else {</span>
<a href="#l16.60"></a><span id="l16.60">       SetTextboxFocus(gDialog.legendText);</span>
<a href="#l16.61"></a><span id="l16.61">     }</span>
<a href="#l16.62"></a><span id="l16.62">   } else {</span>
<a href="#l16.63"></a><span id="l16.63">     newLegend = true;</span>
<a href="#l16.64"></a><span id="l16.64"> </span>
<a href="#l16.65"></a><span id="l16.65">     // We don't have an element selected,</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineat">@@ -96,38 +111,44 @@ function Startup() {</span>
<a href="#l16.67"></a><span id="l16.67">   globalElement = legendElement.cloneNode(false);</span>
<a href="#l16.68"></a><span id="l16.68"> </span>
<a href="#l16.69"></a><span id="l16.69">   InitDialog();</span>
<a href="#l16.70"></a><span id="l16.70"> </span>
<a href="#l16.71"></a><span id="l16.71">   SetWindowLocation();</span>
<a href="#l16.72"></a><span id="l16.72"> }</span>
<a href="#l16.73"></a><span id="l16.73"> </span>
<a href="#l16.74"></a><span id="l16.74"> function InitDialog() {</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineminus">-  gDialog.legendAlign.value = GetHTMLOrCSSStyleValue(globalElement, &quot;align&quot;, &quot;caption-side&quot;);</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineplus">+  gDialog.legendAlign.value = GetHTMLOrCSSStyleValue(</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+    globalElement,</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+    &quot;align&quot;,</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+    &quot;caption-side&quot;</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineplus">+  );</span>
<a href="#l16.81"></a><span id="l16.81"> }</span>
<a href="#l16.82"></a><span id="l16.82"> </span>
<a href="#l16.83"></a><span id="l16.83"> function RemoveFieldSet() {</span>
<a href="#l16.84"></a><span id="l16.84">   var editor = GetCurrentEditor();</span>
<a href="#l16.85"></a><span id="l16.85">   editor.beginTransaction();</span>
<a href="#l16.86"></a><span id="l16.86">   try {</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineminus">-    if (!newLegend)</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineplus">+    if (!newLegend) {</span>
<a href="#l16.89"></a><span id="l16.89">       editor.deleteNode(legendElement);</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineplus">+    }</span>
<a href="#l16.91"></a><span id="l16.91">     RemoveBlockContainer(fieldsetElement);</span>
<a href="#l16.92"></a><span id="l16.92">   } finally {</span>
<a href="#l16.93"></a><span id="l16.93">     editor.endTransaction();</span>
<a href="#l16.94"></a><span id="l16.94">   }</span>
<a href="#l16.95"></a><span id="l16.95">   SaveWindowLocation();</span>
<a href="#l16.96"></a><span id="l16.96">   window.close();</span>
<a href="#l16.97"></a><span id="l16.97"> }</span>
<a href="#l16.98"></a><span id="l16.98"> </span>
<a href="#l16.99"></a><span id="l16.99"> function ValidateData() {</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineminus">-  if (gDialog.legendAlign.value)</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineplus">+  if (gDialog.legendAlign.value) {</span>
<a href="#l16.102"></a><span id="l16.102">     globalElement.setAttribute(&quot;align&quot;, gDialog.legendAlign.value);</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineminus">-  else</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineplus">+  } else {</span>
<a href="#l16.105"></a><span id="l16.105">     globalElement.removeAttribute(&quot;align&quot;);</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineplus">+  }</span>
<a href="#l16.107"></a><span id="l16.107">   return true;</span>
<a href="#l16.108"></a><span id="l16.108"> }</span>
<a href="#l16.109"></a><span id="l16.109"> </span>
<a href="#l16.110"></a><span id="l16.110"> function onAccept() {</span>
<a href="#l16.111"></a><span id="l16.111">   // All values are valid - copy to actual element in doc</span>
<a href="#l16.112"></a><span id="l16.112">   ValidateData();</span>
<a href="#l16.113"></a><span id="l16.113"> </span>
<a href="#l16.114"></a><span id="l16.114">   var editor = GetCurrentEditor();</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineat">@@ -135,33 +156,41 @@ function onAccept() {</span>
<a href="#l16.116"></a><span id="l16.116">   editor.beginTransaction();</span>
<a href="#l16.117"></a><span id="l16.117"> </span>
<a href="#l16.118"></a><span id="l16.118">   try {</span>
<a href="#l16.119"></a><span id="l16.119">     editor.cloneAttributes(legendElement, globalElement);</span>
<a href="#l16.120"></a><span id="l16.120"> </span>
<a href="#l16.121"></a><span id="l16.121">     if (insertNew) {</span>
<a href="#l16.122"></a><span id="l16.122">       if (gDialog.legendText.value) {</span>
<a href="#l16.123"></a><span id="l16.123">         fieldsetElement.appendChild(legendElement);</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineminus">-        legendElement.appendChild(editor.document.createTextNode(gDialog.legendText.value));</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineplus">+        legendElement.appendChild(</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineplus">+          editor.document.createTextNode(gDialog.legendText.value)</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineplus">+        );</span>
<a href="#l16.128"></a><span id="l16.128">       }</span>
<a href="#l16.129"></a><span id="l16.129">       InsertElementAroundSelection(fieldsetElement);</span>
<a href="#l16.130"></a><span id="l16.130">     } else if (gDialog.editText.checked) {</span>
<a href="#l16.131"></a><span id="l16.131">       editor.setShouldTxnSetSelection(false);</span>
<a href="#l16.132"></a><span id="l16.132"> </span>
<a href="#l16.133"></a><span id="l16.133">       if (gDialog.legendText.value) {</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineminus">-        if (newLegend)</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineplus">+        if (newLegend) {</span>
<a href="#l16.136"></a><span id="l16.136">           editor.insertNode(legendElement, fieldsetElement, 0, true);</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineminus">-        else while (legendElement.firstChild)</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineminus">-          editor.deleteNode(legendElement.lastChild);</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineminus">-        editor.insertNode(editor.document.createTextNode(gDialog.legendText.value), legendElement, 0);</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineplus">+        } else {</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineplus">+          while (legendElement.firstChild) {</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineplus">+            editor.deleteNode(legendElement.lastChild);</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineplus">+          }</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineplus">+        }</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineplus">+        editor.insertNode(</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineplus">+          editor.document.createTextNode(gDialog.legendText.value),</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineplus">+          legendElement,</span>
<a href="#l16.148"></a><span id="l16.148" class="difflineplus">+          0</span>
<a href="#l16.149"></a><span id="l16.149" class="difflineplus">+        );</span>
<a href="#l16.150"></a><span id="l16.150">       } else if (!newLegend) {</span>
<a href="#l16.151"></a><span id="l16.151">         editor.deleteNode(legendElement);</span>
<a href="#l16.152"></a><span id="l16.152">       }</span>
<a href="#l16.153"></a><span id="l16.153"> </span>
<a href="#l16.154"></a><span id="l16.154">       editor.setShouldTxnSetSelection(true);</span>
<a href="#l16.155"></a><span id="l16.155">     }</span>
<a href="#l16.156"></a><span id="l16.156">   } finally {</span>
<a href="#l16.157"></a><span id="l16.157">     editor.endTransaction();</span>
<a href="#l16.158"></a><span id="l16.158">   }</span>
<a href="#l16.159"></a><span id="l16.159"> </span>
<a href="#l16.160"></a><span id="l16.160">   SaveWindowLocation();</span>
<a href="#l16.161"></a><span id="l16.161"> }</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdFormProps.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdFormProps.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -17,34 +17,42 @@ function Startup() {</span>
<a href="#l17.4"></a><span id="l17.4">   var editor = GetCurrentEditor();</span>
<a href="#l17.5"></a><span id="l17.5">   if (!editor) {</span>
<a href="#l17.6"></a><span id="l17.6">     dump(&quot;Failed to get active editor!\n&quot;);</span>
<a href="#l17.7"></a><span id="l17.7">     window.close();</span>
<a href="#l17.8"></a><span id="l17.8">     return;</span>
<a href="#l17.9"></a><span id="l17.9">   }</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11">   gForm = {</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-    Name:     document.getElementById(&quot;FormName&quot;),</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-    Action:   document.getElementById(&quot;FormAction&quot;),</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-    Method:   document.getElementById(&quot;FormMethod&quot;),</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-    EncType:  document.getElementById(&quot;FormEncType&quot;),</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-    Target:   document.getElementById(&quot;FormTarget&quot;),</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+    Name: document.getElementById(&quot;FormName&quot;),</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+    Action: document.getElementById(&quot;FormAction&quot;),</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+    Method: document.getElementById(&quot;FormMethod&quot;),</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+    EncType: document.getElementById(&quot;FormEncType&quot;),</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+    Target: document.getElementById(&quot;FormTarget&quot;),</span>
<a href="#l17.22"></a><span id="l17.22">   };</span>
<a href="#l17.23"></a><span id="l17.23">   gDialog.MoreSection = document.getElementById(&quot;MoreSection&quot;);</span>
<a href="#l17.24"></a><span id="l17.24">   gDialog.MoreFewerButton = document.getElementById(&quot;MoreFewerButton&quot;);</span>
<a href="#l17.25"></a><span id="l17.25">   gDialog.RemoveForm = document.getElementById(&quot;RemoveForm&quot;);</span>
<a href="#l17.26"></a><span id="l17.26"> </span>
<a href="#l17.27"></a><span id="l17.27">   // Get a single selected form element</span>
<a href="#l17.28"></a><span id="l17.28">   const kTagName = &quot;form&quot;;</span>
<a href="#l17.29"></a><span id="l17.29">   try {</span>
<a href="#l17.30"></a><span id="l17.30">     formElement = editor.getSelectedElement(kTagName);</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-    if (!formElement)</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-      formElement = editor.getElementOrParentByTagName(kTagName, editor.selection.anchorNode);</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-    if (!formElement)</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineminus">-      formElement = editor.getElementOrParentByTagName(kTagName, editor.selection.focusNode);</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+    if (!formElement) {</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+      formElement = editor.getElementOrParentByTagName(</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+        kTagName,</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+        editor.selection.anchorNode</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+      );</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+    }</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+    if (!formElement) {</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+      formElement = editor.getElementOrParentByTagName(</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+        kTagName,</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+        editor.selection.focusNode</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+      );</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+    }</span>
<a href="#l17.47"></a><span id="l17.47">   } catch (e) {}</span>
<a href="#l17.48"></a><span id="l17.48"> </span>
<a href="#l17.49"></a><span id="l17.49">   if (formElement) {</span>
<a href="#l17.50"></a><span id="l17.50">     // We found an element and don't need to insert one</span>
<a href="#l17.51"></a><span id="l17.51">     insertNew = false;</span>
<a href="#l17.52"></a><span id="l17.52">     formActionWarning = formElement.hasAttribute(&quot;action&quot;);</span>
<a href="#l17.53"></a><span id="l17.53">   } else {</span>
<a href="#l17.54"></a><span id="l17.54">     insertNew = true;</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineat">@@ -73,49 +81,56 @@ function Startup() {</span>
<a href="#l17.56"></a><span id="l17.56">   InitMoreFewer();</span>
<a href="#l17.57"></a><span id="l17.57"> </span>
<a href="#l17.58"></a><span id="l17.58">   SetTextboxFocus(gForm.Name);</span>
<a href="#l17.59"></a><span id="l17.59"> </span>
<a href="#l17.60"></a><span id="l17.60">   SetWindowLocation();</span>
<a href="#l17.61"></a><span id="l17.61"> }</span>
<a href="#l17.62"></a><span id="l17.62"> </span>
<a href="#l17.63"></a><span id="l17.63"> function InitDialog() {</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineminus">-  for (var attribute in gForm)</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineplus">+  for (var attribute in gForm) {</span>
<a href="#l17.66"></a><span id="l17.66">     gForm[attribute].value = globalElement.getAttribute(attribute);</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineplus">+  }</span>
<a href="#l17.68"></a><span id="l17.68"> }</span>
<a href="#l17.69"></a><span id="l17.69"> </span>
<a href="#l17.70"></a><span id="l17.70"> function RemoveForm() {</span>
<a href="#l17.71"></a><span id="l17.71">   RemoveBlockContainer(formElement);</span>
<a href="#l17.72"></a><span id="l17.72">   SaveWindowLocation();</span>
<a href="#l17.73"></a><span id="l17.73">   window.close();</span>
<a href="#l17.74"></a><span id="l17.74"> }</span>
<a href="#l17.75"></a><span id="l17.75"> </span>
<a href="#l17.76"></a><span id="l17.76"> function ValidateData() {</span>
<a href="#l17.77"></a><span id="l17.77">   for (var attribute in gForm) {</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineminus">-    if (gForm[attribute].value)</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineplus">+    if (gForm[attribute].value) {</span>
<a href="#l17.80"></a><span id="l17.80">       globalElement.setAttribute(attribute, gForm[attribute].value);</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineminus">-    else</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineplus">+    } else {</span>
<a href="#l17.83"></a><span id="l17.83">       globalElement.removeAttribute(attribute);</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineplus">+    }</span>
<a href="#l17.85"></a><span id="l17.85">   }</span>
<a href="#l17.86"></a><span id="l17.86">   return true;</span>
<a href="#l17.87"></a><span id="l17.87"> }</span>
<a href="#l17.88"></a><span id="l17.88"> </span>
<a href="#l17.89"></a><span id="l17.89"> function onAccept(event) {</span>
<a href="#l17.90"></a><span id="l17.90">   if (formActionWarning &amp;&amp; !gForm.Action.value) {</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineminus">-    Services.prompt.alert(window, GetString(&quot;Alert&quot;), GetString(&quot;NoFormAction&quot;));</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineplus">+    Services.prompt.alert(</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineplus">+      window,</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineplus">+      GetString(&quot;Alert&quot;),</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineplus">+      GetString(&quot;NoFormAction&quot;)</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineplus">+    );</span>
<a href="#l17.97"></a><span id="l17.97">     gForm.Action.focus();</span>
<a href="#l17.98"></a><span id="l17.98">     formActionWarning = false;</span>
<a href="#l17.99"></a><span id="l17.99">     event.preventDefault();</span>
<a href="#l17.100"></a><span id="l17.100">     return;</span>
<a href="#l17.101"></a><span id="l17.101">   }</span>
<a href="#l17.102"></a><span id="l17.102">   // All values are valid - copy to actual element in doc or</span>
<a href="#l17.103"></a><span id="l17.103">   //   element created to insert</span>
<a href="#l17.104"></a><span id="l17.104">   ValidateData();</span>
<a href="#l17.105"></a><span id="l17.105"> </span>
<a href="#l17.106"></a><span id="l17.106">   var editor = GetCurrentEditor();</span>
<a href="#l17.107"></a><span id="l17.107"> </span>
<a href="#l17.108"></a><span id="l17.108">   editor.cloneAttributes(formElement, globalElement);</span>
<a href="#l17.109"></a><span id="l17.109"> </span>
<a href="#l17.110"></a><span id="l17.110" class="difflineminus">-  if (insertNew)</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineplus">+  if (insertNew) {</span>
<a href="#l17.112"></a><span id="l17.112">     InsertElementAroundSelection(formElement);</span>
<a href="#l17.113"></a><span id="l17.113" class="difflineplus">+  }</span>
<a href="#l17.114"></a><span id="l17.114"> </span>
<a href="#l17.115"></a><span id="l17.115">   SaveWindowLocation();</span>
<a href="#l17.116"></a><span id="l17.116"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdHLineProps.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdHLineProps.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -36,17 +36,19 @@ function Startup() {</span>
<a href="#l18.4"></a><span id="l18.4">   }</span>
<a href="#l18.5"></a><span id="l18.5">   gDialog.heightInput = document.getElementById(&quot;height&quot;);</span>
<a href="#l18.6"></a><span id="l18.6">   gDialog.widthInput = document.getElementById(&quot;width&quot;);</span>
<a href="#l18.7"></a><span id="l18.7">   gDialog.leftAlign = document.getElementById(&quot;leftAlign&quot;);</span>
<a href="#l18.8"></a><span id="l18.8">   gDialog.centerAlign = document.getElementById(&quot;centerAlign&quot;);</span>
<a href="#l18.9"></a><span id="l18.9">   gDialog.rightAlign = document.getElementById(&quot;rightAlign&quot;);</span>
<a href="#l18.10"></a><span id="l18.10">   gDialog.alignGroup = gDialog.rightAlign.radioGroup;</span>
<a href="#l18.11"></a><span id="l18.11">   gDialog.shading = document.getElementById(&quot;3dShading&quot;);</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-  gDialog.pixelOrPercentMenulist = document.getElementById(&quot;pixelOrPercentMenulist&quot;);</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+  gDialog.pixelOrPercentMenulist = document.getElementById(</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+    &quot;pixelOrPercentMenulist&quot;</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+  );</span>
<a href="#l18.16"></a><span id="l18.16"> </span>
<a href="#l18.17"></a><span id="l18.17">   // Make a copy to use for AdvancedEdit and onSaveDefault</span>
<a href="#l18.18"></a><span id="l18.18">   globalElement = gHLineElement.cloneNode(false);</span>
<a href="#l18.19"></a><span id="l18.19"> </span>
<a href="#l18.20"></a><span id="l18.20">   // Initialize control values based on existing attributes</span>
<a href="#l18.21"></a><span id="l18.21">   InitDialog();</span>
<a href="#l18.22"></a><span id="l18.22"> </span>
<a href="#l18.23"></a><span id="l18.23">   // SET FOCUS TO FIRST CONTROL</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineat">@@ -72,24 +74,38 @@ function InitDialog() {</span>
<a href="#l18.25"></a><span id="l18.25">     height = 2; // Default value</span>
<a href="#l18.26"></a><span id="l18.26">   }</span>
<a href="#l18.27"></a><span id="l18.27"> </span>
<a href="#l18.28"></a><span id="l18.28">   // We will use &quot;height&quot; here and in UI</span>
<a href="#l18.29"></a><span id="l18.29">   gDialog.heightInput.value = height;</span>
<a href="#l18.30"></a><span id="l18.30"> </span>
<a href="#l18.31"></a><span id="l18.31">   // Get the width attribute of the element, stripping out &quot;%&quot;</span>
<a href="#l18.32"></a><span id="l18.32">   // This sets contents of menulist (adds pixel and percent menuitems elements)</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-  gDialog.widthInput.value = InitPixelOrPercentMenulist(globalElement, gHLineElement, &quot;width&quot;, &quot;pixelOrPercentMenulist&quot;);</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+  gDialog.widthInput.value = InitPixelOrPercentMenulist(</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+    globalElement,</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+    gHLineElement,</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+    &quot;width&quot;,</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineplus">+    &quot;pixelOrPercentMenulist&quot;</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineplus">+  );</span>
<a href="#l18.40"></a><span id="l18.40"> </span>
<a href="#l18.41"></a><span id="l18.41" class="difflineminus">-  var marginLeft  = GetHTMLOrCSSStyleValue(globalElement, &quot;align&quot;, &quot;margin-left&quot;).toLowerCase();</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineminus">-  var marginRight = GetHTMLOrCSSStyleValue(globalElement, &quot;align&quot;, &quot;margin-right&quot;).toLowerCase();</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+  var marginLeft = GetHTMLOrCSSStyleValue(</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+    globalElement,</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineplus">+    &quot;align&quot;,</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+    &quot;margin-left&quot;</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+  ).toLowerCase();</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineplus">+  var marginRight = GetHTMLOrCSSStyleValue(</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineplus">+    globalElement,</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+    &quot;align&quot;,</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+    &quot;margin-right&quot;</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+  ).toLowerCase();</span>
<a href="#l18.53"></a><span id="l18.53">   align = marginLeft + &quot; &quot; + marginRight;</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineminus">-  gDialog.leftAlign.checked   = (align == &quot;left left&quot; || align == &quot;0px auto&quot;);</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineminus">-  gDialog.centerAlign.checked = (align == &quot;center center&quot; || align == &quot;auto auto&quot; || align == &quot; &quot;);</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineminus">-  gDialog.rightAlign.checked  = (align == &quot;right right&quot; || align == &quot;auto 0px&quot;);</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineplus">+  gDialog.leftAlign.checked = align == &quot;left left&quot; || align == &quot;0px auto&quot;;</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineplus">+  gDialog.centerAlign.checked =</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineplus">+    align == &quot;center center&quot; || align == &quot;auto auto&quot; || align == &quot; &quot;;</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineplus">+  gDialog.rightAlign.checked = align == &quot;right right&quot; || align == &quot;auto 0px&quot;;</span>
<a href="#l18.61"></a><span id="l18.61"> </span>
<a href="#l18.62"></a><span id="l18.62">   if (gDialog.centerAlign.checked) {</span>
<a href="#l18.63"></a><span id="l18.63">     gDialog.alignGroup.selectedItem = gDialog.centerAlign;</span>
<a href="#l18.64"></a><span id="l18.64">   } else if (gDialog.rightAlign.checked) {</span>
<a href="#l18.65"></a><span id="l18.65">     gDialog.alignGroup.selectedItem = gDialog.rightAlign;</span>
<a href="#l18.66"></a><span id="l18.66">   } else {</span>
<a href="#l18.67"></a><span id="l18.67">     gDialog.alignGroup.selectedItem = gDialog.leftAlign;</span>
<a href="#l18.68"></a><span id="l18.68">   }</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineat">@@ -139,39 +155,60 @@ function onSaveDefault() {</span>
<a href="#l18.70"></a><span id="l18.70">     Services.prefs.savePrefFile(null);</span>
<a href="#l18.71"></a><span id="l18.71">   }</span>
<a href="#l18.72"></a><span id="l18.72"> }</span>
<a href="#l18.73"></a><span id="l18.73"> </span>
<a href="#l18.74"></a><span id="l18.74"> // Get and validate data from widgets.</span>
<a href="#l18.75"></a><span id="l18.75"> // Set attributes on globalElement so they can be accessed by AdvancedEdit()</span>
<a href="#l18.76"></a><span id="l18.76"> function ValidateData() {</span>
<a href="#l18.77"></a><span id="l18.77">   // Height is always pixels</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineminus">-  height = ValidateNumber(gDialog.heightInput, null, 1, gMaxHRSize,</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineminus">-                          globalElement, &quot;size&quot;, false);</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineminus">-  if (gValidationError)</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineplus">+  height = ValidateNumber(</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineplus">+    gDialog.heightInput,</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineplus">+    null,</span>
<a href="#l18.84"></a><span id="l18.84" class="difflineplus">+    1,</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineplus">+    gMaxHRSize,</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineplus">+    globalElement,</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineplus">+    &quot;size&quot;,</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineplus">+    false</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineplus">+  );</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineplus">+  if (gValidationError) {</span>
<a href="#l18.91"></a><span id="l18.91">     return false;</span>
<a href="#l18.92"></a><span id="l18.92" class="difflineplus">+  }</span>
<a href="#l18.93"></a><span id="l18.93"> </span>
<a href="#l18.94"></a><span id="l18.94" class="difflineminus">-  width = ValidateNumber(gDialog.widthInput, gDialog.pixelOrPercentMenulist, 1, gMaxPixels,</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineminus">-                         globalElement, &quot;width&quot;, false);</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineminus">-  if (gValidationError)</span>
<a href="#l18.97"></a><span id="l18.97" class="difflineplus">+  width = ValidateNumber(</span>
<a href="#l18.98"></a><span id="l18.98" class="difflineplus">+    gDialog.widthInput,</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineplus">+    gDialog.pixelOrPercentMenulist,</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineplus">+    1,</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineplus">+    gMaxPixels,</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineplus">+    globalElement,</span>
<a href="#l18.103"></a><span id="l18.103" class="difflineplus">+    &quot;width&quot;,</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineplus">+    false</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineplus">+  );</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineplus">+  if (gValidationError) {</span>
<a href="#l18.107"></a><span id="l18.107">     return false;</span>
<a href="#l18.108"></a><span id="l18.108" class="difflineplus">+  }</span>
<a href="#l18.109"></a><span id="l18.109"> </span>
<a href="#l18.110"></a><span id="l18.110">   align = &quot;left&quot;;</span>
<a href="#l18.111"></a><span id="l18.111">   if (gDialog.centerAlign.selected) {</span>
<a href="#l18.112"></a><span id="l18.112">     // Don't write out default attribute</span>
<a href="#l18.113"></a><span id="l18.113">     align = &quot;&quot;;</span>
<a href="#l18.114"></a><span id="l18.114">   } else if (gDialog.rightAlign.selected) {</span>
<a href="#l18.115"></a><span id="l18.115">     align = &quot;right&quot;;</span>
<a href="#l18.116"></a><span id="l18.116">   }</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineminus">-  if (align)</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineplus">+  if (align) {</span>
<a href="#l18.119"></a><span id="l18.119">     globalElement.setAttribute(&quot;align&quot;, align);</span>
<a href="#l18.120"></a><span id="l18.120" class="difflineminus">-  else</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineplus">+  } else {</span>
<a href="#l18.122"></a><span id="l18.122">     try {</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineminus">-      GetCurrentEditor().removeAttributeOrEquivalent(globalElement, &quot;align&quot;, true);</span>
<a href="#l18.124"></a><span id="l18.124" class="difflineplus">+      GetCurrentEditor().removeAttributeOrEquivalent(</span>
<a href="#l18.125"></a><span id="l18.125" class="difflineplus">+        globalElement,</span>
<a href="#l18.126"></a><span id="l18.126" class="difflineplus">+        &quot;align&quot;,</span>
<a href="#l18.127"></a><span id="l18.127" class="difflineplus">+        true</span>
<a href="#l18.128"></a><span id="l18.128" class="difflineplus">+      );</span>
<a href="#l18.129"></a><span id="l18.129">     } catch (e) {}</span>
<a href="#l18.130"></a><span id="l18.130" class="difflineplus">+  }</span>
<a href="#l18.131"></a><span id="l18.131"> </span>
<a href="#l18.132"></a><span id="l18.132">   if (gDialog.shading.checked) {</span>
<a href="#l18.133"></a><span id="l18.133">     shading = true;</span>
<a href="#l18.134"></a><span id="l18.134">     globalElement.removeAttribute(&quot;noshade&quot;);</span>
<a href="#l18.135"></a><span id="l18.135">   } else {</span>
<a href="#l18.136"></a><span id="l18.136">     shading = false;</span>
<a href="#l18.137"></a><span id="l18.137">     globalElement.setAttribute(&quot;noshade&quot;, &quot;noshade&quot;);</span>
<a href="#l18.138"></a><span id="l18.138">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdImageDialog.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdImageDialog.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -15,17 +15,17 @@</span>
<a href="#l19.4"></a><span id="l19.4"> /* import-globals-from ../../composer/content/editorUtilities.js */</span>
<a href="#l19.5"></a><span id="l19.5"> /* import-globals-from EdDialogCommon.js */</span>
<a href="#l19.6"></a><span id="l19.6"> </span>
<a href="#l19.7"></a><span id="l19.7"> var gInsertNewImage = true;</span>
<a href="#l19.8"></a><span id="l19.8"> var gDoAltTextError = false;</span>
<a href="#l19.9"></a><span id="l19.9"> var gConstrainOn = false;</span>
<a href="#l19.10"></a><span id="l19.10"> // Note used in current version, but these are set correctly</span>
<a href="#l19.11"></a><span id="l19.11"> //  and could be used to reset width and height used for constrain ratio</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-var gConstrainWidth  = 0;</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+var gConstrainWidth = 0;</span>
<a href="#l19.14"></a><span id="l19.14"> var gConstrainHeight = 0;</span>
<a href="#l19.15"></a><span id="l19.15"> var imageElement;</span>
<a href="#l19.16"></a><span id="l19.16"> var gImageMap = 0;</span>
<a href="#l19.17"></a><span id="l19.17"> var gCanRemoveImageMap = false;</span>
<a href="#l19.18"></a><span id="l19.18"> var gRemoveImageMap = false;</span>
<a href="#l19.19"></a><span id="l19.19"> var gImageMapDisabled = false;</span>
<a href="#l19.20"></a><span id="l19.20"> var gActualWidth = &quot;&quot;;</span>
<a href="#l19.21"></a><span id="l19.21"> var gActualHeight = &quot;&quot;;</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineat">@@ -37,42 +37,42 @@ var gInsertNewIMap;</span>
<a href="#l19.23"></a><span id="l19.23"> // These must correspond to values in EditorDialog.css for each theme</span>
<a href="#l19.24"></a><span id="l19.24"> // (unfortunately, setting &quot;style&quot; attribute here doesn't work!)</span>
<a href="#l19.25"></a><span id="l19.25"> var gPreviewImageWidth = 80;</span>
<a href="#l19.26"></a><span id="l19.26"> var gPreviewImageHeight = 50;</span>
<a href="#l19.27"></a><span id="l19.27"> </span>
<a href="#l19.28"></a><span id="l19.28"> // dialog initialization code</span>
<a href="#l19.29"></a><span id="l19.29"> </span>
<a href="#l19.30"></a><span id="l19.30"> function ImageStartup() {</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-  gDialog.tabBox            = document.getElementById(&quot;TabBox&quot;);</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-  gDialog.tabLocation       = document.getElementById(&quot;imageLocationTab&quot;);</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineminus">-  gDialog.tabDimensions     = document.getElementById(&quot;imageDimensionsTab&quot;);</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineminus">-  gDialog.tabBorder         = document.getElementById(&quot;imageBorderTab&quot;);</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineminus">-  gDialog.srcInput          = document.getElementById(&quot;srcInput&quot;);</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineminus">-  gDialog.titleInput        = document.getElementById(&quot;titleInput&quot;);</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineminus">-  gDialog.altTextInput      = document.getElementById(&quot;altTextInput&quot;);</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+  gDialog.tabBox = document.getElementById(&quot;TabBox&quot;);</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineplus">+  gDialog.tabLocation = document.getElementById(&quot;imageLocationTab&quot;);</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+  gDialog.tabDimensions = document.getElementById(&quot;imageDimensionsTab&quot;);</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineplus">+  gDialog.tabBorder = document.getElementById(&quot;imageBorderTab&quot;);</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+  gDialog.srcInput = document.getElementById(&quot;srcInput&quot;);</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+  gDialog.titleInput = document.getElementById(&quot;titleInput&quot;);</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineplus">+  gDialog.altTextInput = document.getElementById(&quot;altTextInput&quot;);</span>
<a href="#l19.45"></a><span id="l19.45">   gDialog.altTextRadioGroup = document.getElementById(&quot;altTextRadioGroup&quot;);</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineminus">-  gDialog.altTextRadio      = document.getElementById(&quot;altTextRadio&quot;);</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineminus">-  gDialog.noAltTextRadio    = document.getElementById(&quot;noAltTextRadio&quot;);</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineminus">-  gDialog.actualSizeRadio   = document.getElementById(&quot;actualSizeRadio&quot;);</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineplus">+  gDialog.altTextRadio = document.getElementById(&quot;altTextRadio&quot;);</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineplus">+  gDialog.noAltTextRadio = document.getElementById(&quot;noAltTextRadio&quot;);</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineplus">+  gDialog.actualSizeRadio = document.getElementById(&quot;actualSizeRadio&quot;);</span>
<a href="#l19.52"></a><span id="l19.52">   gDialog.constrainCheckbox = document.getElementById(&quot;constrainCheckbox&quot;);</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineminus">-  gDialog.widthInput        = document.getElementById(&quot;widthInput&quot;);</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineminus">-  gDialog.heightInput       = document.getElementById(&quot;heightInput&quot;);</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineminus">-  gDialog.widthUnitsMenulist   = document.getElementById(&quot;widthUnitsMenulist&quot;);</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineminus">-  gDialog.heightUnitsMenulist  = document.getElementById(&quot;heightUnitsMenulist&quot;);</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineminus">-  gDialog.imagelrInput      = document.getElementById(&quot;imageleftrightInput&quot;);</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineminus">-  gDialog.imagetbInput      = document.getElementById(&quot;imagetopbottomInput&quot;);</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineminus">-  gDialog.border            = document.getElementById(&quot;border&quot;);</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineminus">-  gDialog.alignTypeSelect   = document.getElementById(&quot;alignTypeSelect&quot;);</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineminus">-  gDialog.ImageHolder       = document.getElementById(&quot;preview-image-holder&quot;);</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineminus">-  gDialog.PreviewWidth      = document.getElementById(&quot;PreviewWidth&quot;);</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineminus">-  gDialog.PreviewHeight     = document.getElementById(&quot;PreviewHeight&quot;);</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineminus">-  gDialog.PreviewSize       = document.getElementById(&quot;PreviewSize&quot;);</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineminus">-  gDialog.PreviewImage      = null;</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineminus">-  gDialog.OkButton          = document.documentElement.getButton(&quot;accept&quot;);</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineplus">+  gDialog.widthInput = document.getElementById(&quot;widthInput&quot;);</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineplus">+  gDialog.heightInput = document.getElementById(&quot;heightInput&quot;);</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineplus">+  gDialog.widthUnitsMenulist = document.getElementById(&quot;widthUnitsMenulist&quot;);</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineplus">+  gDialog.heightUnitsMenulist = document.getElementById(&quot;heightUnitsMenulist&quot;);</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineplus">+  gDialog.imagelrInput = document.getElementById(&quot;imageleftrightInput&quot;);</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineplus">+  gDialog.imagetbInput = document.getElementById(&quot;imagetopbottomInput&quot;);</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineplus">+  gDialog.border = document.getElementById(&quot;border&quot;);</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineplus">+  gDialog.alignTypeSelect = document.getElementById(&quot;alignTypeSelect&quot;);</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineplus">+  gDialog.ImageHolder = document.getElementById(&quot;preview-image-holder&quot;);</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineplus">+  gDialog.PreviewWidth = document.getElementById(&quot;PreviewWidth&quot;);</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineplus">+  gDialog.PreviewHeight = document.getElementById(&quot;PreviewHeight&quot;);</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineplus">+  gDialog.PreviewSize = document.getElementById(&quot;PreviewSize&quot;);</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineplus">+  gDialog.PreviewImage = null;</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineplus">+  gDialog.OkButton = document.documentElement.getButton(&quot;accept&quot;);</span>
<a href="#l19.81"></a><span id="l19.81"> }</span>
<a href="#l19.82"></a><span id="l19.82"> </span>
<a href="#l19.83"></a><span id="l19.83"> // Set dialog widgets with attribute data</span>
<a href="#l19.84"></a><span id="l19.84"> // We get them from globalElement copy so this can be used</span>
<a href="#l19.85"></a><span id="l19.85"> //   by AdvancedEdit(), which is shared by all property dialogs</span>
<a href="#l19.86"></a><span id="l19.86"> function InitImage() {</span>
<a href="#l19.87"></a><span id="l19.87">   // Set the controls to the image's attributes</span>
<a href="#l19.88"></a><span id="l19.88">   var src = globalElement.getAttribute(&quot;src&quot;);</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineat">@@ -94,31 +94,41 @@ function InitImage() {</span>
<a href="#l19.90"></a><span id="l19.90">   var hasAltText = globalElement.hasAttribute(&quot;alt&quot;);</span>
<a href="#l19.91"></a><span id="l19.91">   var altText = globalElement.getAttribute(&quot;alt&quot;);</span>
<a href="#l19.92"></a><span id="l19.92">   gDialog.altTextInput.value = altText;</span>
<a href="#l19.93"></a><span id="l19.93">   if (altText || (!hasAltText &amp;&amp; globalElement.hasAttribute(&quot;src&quot;))) {</span>
<a href="#l19.94"></a><span id="l19.94">     gDialog.altTextRadioGroup.selectedItem = gDialog.altTextRadio;</span>
<a href="#l19.95"></a><span id="l19.95">   } else if (hasAltText) {</span>
<a href="#l19.96"></a><span id="l19.96">     gDialog.altTextRadioGroup.selectedItem = gDialog.noAltTextRadio;</span>
<a href="#l19.97"></a><span id="l19.97">   }</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineminus">-  SetAltTextDisabled(gDialog.altTextRadioGroup.selectedItem == gDialog.noAltTextRadio);</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineplus">+  SetAltTextDisabled(</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineplus">+    gDialog.altTextRadioGroup.selectedItem == gDialog.noAltTextRadio</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineplus">+  );</span>
<a href="#l19.102"></a><span id="l19.102"> </span>
<a href="#l19.103"></a><span id="l19.103">   // setup the height and width widgets</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineminus">-  var width = InitPixelOrPercentMenulist(globalElement,</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineminus">-                    gInsertNewImage ? null : imageElement,</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineminus">-                    &quot;width&quot;, &quot;widthUnitsMenulist&quot;, gPixel);</span>
<a href="#l19.107"></a><span id="l19.107" class="difflineminus">-  var height = InitPixelOrPercentMenulist(globalElement,</span>
<a href="#l19.108"></a><span id="l19.108" class="difflineminus">-                    gInsertNewImage ? null : imageElement,</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineminus">-                    &quot;height&quot;, &quot;heightUnitsMenulist&quot;, gPixel);</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineplus">+  var width = InitPixelOrPercentMenulist(</span>
<a href="#l19.111"></a><span id="l19.111" class="difflineplus">+    globalElement,</span>
<a href="#l19.112"></a><span id="l19.112" class="difflineplus">+    gInsertNewImage ? null : imageElement,</span>
<a href="#l19.113"></a><span id="l19.113" class="difflineplus">+    &quot;width&quot;,</span>
<a href="#l19.114"></a><span id="l19.114" class="difflineplus">+    &quot;widthUnitsMenulist&quot;,</span>
<a href="#l19.115"></a><span id="l19.115" class="difflineplus">+    gPixel</span>
<a href="#l19.116"></a><span id="l19.116" class="difflineplus">+  );</span>
<a href="#l19.117"></a><span id="l19.117" class="difflineplus">+  var height = InitPixelOrPercentMenulist(</span>
<a href="#l19.118"></a><span id="l19.118" class="difflineplus">+    globalElement,</span>
<a href="#l19.119"></a><span id="l19.119" class="difflineplus">+    gInsertNewImage ? null : imageElement,</span>
<a href="#l19.120"></a><span id="l19.120" class="difflineplus">+    &quot;height&quot;,</span>
<a href="#l19.121"></a><span id="l19.121" class="difflineplus">+    &quot;heightUnitsMenulist&quot;,</span>
<a href="#l19.122"></a><span id="l19.122" class="difflineplus">+    gPixel</span>
<a href="#l19.123"></a><span id="l19.123" class="difflineplus">+  );</span>
<a href="#l19.124"></a><span id="l19.124"> </span>
<a href="#l19.125"></a><span id="l19.125">   // Set actual radio button if both set values are the same as actual</span>
<a href="#l19.126"></a><span id="l19.126">   SetSizeWidgets(width, height);</span>
<a href="#l19.127"></a><span id="l19.127"> </span>
<a href="#l19.128"></a><span id="l19.128" class="difflineminus">-  gDialog.widthInput.value  = gConstrainWidth = (width || gActualWidth || &quot;&quot;);</span>
<a href="#l19.129"></a><span id="l19.129" class="difflineminus">-  gDialog.heightInput.value = gConstrainHeight = (height || gActualHeight || &quot;&quot;);</span>
<a href="#l19.130"></a><span id="l19.130" class="difflineplus">+  gDialog.widthInput.value = gConstrainWidth = width || gActualWidth || &quot;&quot;;</span>
<a href="#l19.131"></a><span id="l19.131" class="difflineplus">+  gDialog.heightInput.value = gConstrainHeight = height || gActualHeight || &quot;&quot;;</span>
<a href="#l19.132"></a><span id="l19.132"> </span>
<a href="#l19.133"></a><span id="l19.133">   // set spacing editfields</span>
<a href="#l19.134"></a><span id="l19.134">   gDialog.imagelrInput.value = globalElement.getAttribute(&quot;hspace&quot;);</span>
<a href="#l19.135"></a><span id="l19.135">   gDialog.imagetbInput.value = globalElement.getAttribute(&quot;vspace&quot;);</span>
<a href="#l19.136"></a><span id="l19.136"> </span>
<a href="#l19.137"></a><span id="l19.137">   // dialog.border.value       = globalElement.getAttribute(&quot;border&quot;);</span>
<a href="#l19.138"></a><span id="l19.138">   var bv = GetHTMLOrCSSStyleValue(globalElement, &quot;border&quot;, &quot;border-top-width&quot;);</span>
<a href="#l19.139"></a><span id="l19.139">   if (bv.includes(&quot;px&quot;)) {</span>
<a href="#l19.140"></a><span id="l19.140" class="difflineat">@@ -130,105 +140,121 @@ function InitImage() {</span>
<a href="#l19.141"></a><span id="l19.141">     bv = &quot;3&quot;;</span>
<a href="#l19.142"></a><span id="l19.142">   } else if (bv == &quot;thick&quot;) {</span>
<a href="#l19.143"></a><span id="l19.143">     bv = &quot;5&quot;;</span>
<a href="#l19.144"></a><span id="l19.144">   }</span>
<a href="#l19.145"></a><span id="l19.145">   gDialog.border.value = bv;</span>
<a href="#l19.146"></a><span id="l19.146"> </span>
<a href="#l19.147"></a><span id="l19.147">   // Get alignment setting</span>
<a href="#l19.148"></a><span id="l19.148">   var align = globalElement.getAttribute(&quot;align&quot;);</span>
<a href="#l19.149"></a><span id="l19.149" class="difflineminus">-  if (align)</span>
<a href="#l19.150"></a><span id="l19.150" class="difflineplus">+  if (align) {</span>
<a href="#l19.151"></a><span id="l19.151">     align = align.toLowerCase();</span>
<a href="#l19.152"></a><span id="l19.152" class="difflineplus">+  }</span>
<a href="#l19.153"></a><span id="l19.153"> </span>
<a href="#l19.154"></a><span id="l19.154">   switch (align) {</span>
<a href="#l19.155"></a><span id="l19.155">     case &quot;top&quot;:</span>
<a href="#l19.156"></a><span id="l19.156">     case &quot;middle&quot;:</span>
<a href="#l19.157"></a><span id="l19.157">     case &quot;right&quot;:</span>
<a href="#l19.158"></a><span id="l19.158">     case &quot;left&quot;:</span>
<a href="#l19.159"></a><span id="l19.159">       gDialog.alignTypeSelect.value = align;</span>
<a href="#l19.160"></a><span id="l19.160">       break;</span>
<a href="#l19.161"></a><span id="l19.161" class="difflineminus">-    default:  // Default or &quot;bottom&quot;</span>
<a href="#l19.162"></a><span id="l19.162" class="difflineplus">+    default:</span>
<a href="#l19.163"></a><span id="l19.163" class="difflineplus">+      // Default or &quot;bottom&quot;</span>
<a href="#l19.164"></a><span id="l19.164">       gDialog.alignTypeSelect.value = &quot;bottom&quot;;</span>
<a href="#l19.165"></a><span id="l19.165">   }</span>
<a href="#l19.166"></a><span id="l19.166"> </span>
<a href="#l19.167"></a><span id="l19.167">   // Get image map for image</span>
<a href="#l19.168"></a><span id="l19.168">   gImageMap = GetImageMap();</span>
<a href="#l19.169"></a><span id="l19.169"> </span>
<a href="#l19.170"></a><span id="l19.170">   doOverallEnabling();</span>
<a href="#l19.171"></a><span id="l19.171">   doDimensionEnabling();</span>
<a href="#l19.172"></a><span id="l19.172"> }</span>
<a href="#l19.173"></a><span id="l19.173"> </span>
<a href="#l19.174"></a><span id="l19.174"> function SetSizeWidgets(width, height) {</span>
<a href="#l19.175"></a><span id="l19.175" class="difflineminus">-  if (!(width || height) || (gActualWidth &amp;&amp; gActualHeight &amp;&amp; width == gActualWidth &amp;&amp; height == gActualHeight))</span>
<a href="#l19.176"></a><span id="l19.176" class="difflineplus">+  if (</span>
<a href="#l19.177"></a><span id="l19.177" class="difflineplus">+    !(width || height) ||</span>
<a href="#l19.178"></a><span id="l19.178" class="difflineplus">+    (gActualWidth &amp;&amp;</span>
<a href="#l19.179"></a><span id="l19.179" class="difflineplus">+      gActualHeight &amp;&amp;</span>
<a href="#l19.180"></a><span id="l19.180" class="difflineplus">+      width == gActualWidth &amp;&amp;</span>
<a href="#l19.181"></a><span id="l19.181" class="difflineplus">+      height == gActualHeight)</span>
<a href="#l19.182"></a><span id="l19.182" class="difflineplus">+  ) {</span>
<a href="#l19.183"></a><span id="l19.183">     gDialog.actualSizeRadio.radioGroup.selectedItem = gDialog.actualSizeRadio;</span>
<a href="#l19.184"></a><span id="l19.184" class="difflineplus">+  }</span>
<a href="#l19.185"></a><span id="l19.185"> </span>
<a href="#l19.186"></a><span id="l19.186">   if (!gDialog.actualSizeRadio.selected) {</span>
<a href="#l19.187"></a><span id="l19.187">     // Decide if user's sizes are in the same ratio as actual sizes</span>
<a href="#l19.188"></a><span id="l19.188">     if (gActualWidth &amp;&amp; gActualHeight) {</span>
<a href="#l19.189"></a><span id="l19.189" class="difflineminus">-      if (gActualWidth &gt; gActualHeight)</span>
<a href="#l19.190"></a><span id="l19.190" class="difflineminus">-        gDialog.constrainCheckbox.checked = (Math.round(gActualHeight * width / gActualWidth) == height);</span>
<a href="#l19.191"></a><span id="l19.191" class="difflineminus">-      else</span>
<a href="#l19.192"></a><span id="l19.192" class="difflineminus">-        gDialog.constrainCheckbox.checked = (Math.round(gActualWidth * height / gActualHeight) == width);</span>
<a href="#l19.193"></a><span id="l19.193" class="difflineplus">+      if (gActualWidth &gt; gActualHeight) {</span>
<a href="#l19.194"></a><span id="l19.194" class="difflineplus">+        gDialog.constrainCheckbox.checked =</span>
<a href="#l19.195"></a><span id="l19.195" class="difflineplus">+          Math.round((gActualHeight * width) / gActualWidth) == height;</span>
<a href="#l19.196"></a><span id="l19.196" class="difflineplus">+      } else {</span>
<a href="#l19.197"></a><span id="l19.197" class="difflineplus">+        gDialog.constrainCheckbox.checked =</span>
<a href="#l19.198"></a><span id="l19.198" class="difflineplus">+          Math.round((gActualWidth * height) / gActualHeight) == width;</span>
<a href="#l19.199"></a><span id="l19.199" class="difflineplus">+      }</span>
<a href="#l19.200"></a><span id="l19.200">     }</span>
<a href="#l19.201"></a><span id="l19.201">   }</span>
<a href="#l19.202"></a><span id="l19.202"> }</span>
<a href="#l19.203"></a><span id="l19.203"> </span>
<a href="#l19.204"></a><span id="l19.204"> // Disable alt text input when &quot;Don't use alt&quot; radio is checked</span>
<a href="#l19.205"></a><span id="l19.205"> function SetAltTextDisabled(disable) {</span>
<a href="#l19.206"></a><span id="l19.206">   gDialog.altTextInput.disabled = disable;</span>
<a href="#l19.207"></a><span id="l19.207"> }</span>
<a href="#l19.208"></a><span id="l19.208"> </span>
<a href="#l19.209"></a><span id="l19.209"> function GetImageMap() {</span>
<a href="#l19.210"></a><span id="l19.210">   var usemap = globalElement.getAttribute(&quot;usemap&quot;);</span>
<a href="#l19.211"></a><span id="l19.211">   if (usemap) {</span>
<a href="#l19.212"></a><span id="l19.212">     gCanRemoveImageMap = true;</span>
<a href="#l19.213"></a><span id="l19.213">     let mapname = usemap.substr(1);</span>
<a href="#l19.214"></a><span id="l19.214">     try {</span>
<a href="#l19.215"></a><span id="l19.215" class="difflineminus">-      return GetCurrentEditor().document.querySelector('[name=&quot;' + mapname + '&quot;]');</span>
<a href="#l19.216"></a><span id="l19.216" class="difflineplus">+      return GetCurrentEditor().document.querySelector(</span>
<a href="#l19.217"></a><span id="l19.217" class="difflineplus">+        '[name=&quot;' + mapname + '&quot;]'</span>
<a href="#l19.218"></a><span id="l19.218" class="difflineplus">+      );</span>
<a href="#l19.219"></a><span id="l19.219">     } catch (e) {}</span>
<a href="#l19.220"></a><span id="l19.220">   } else {</span>
<a href="#l19.221"></a><span id="l19.221">     gCanRemoveImageMap = false;</span>
<a href="#l19.222"></a><span id="l19.222">   }</span>
<a href="#l19.223"></a><span id="l19.223"> </span>
<a href="#l19.224"></a><span id="l19.224">   return null;</span>
<a href="#l19.225"></a><span id="l19.225"> }</span>
<a href="#l19.226"></a><span id="l19.226"> </span>
<a href="#l19.227"></a><span id="l19.227"> function chooseFile() {</span>
<a href="#l19.228"></a><span id="l19.228" class="difflineminus">-  if (gTimerID)</span>
<a href="#l19.229"></a><span id="l19.229" class="difflineplus">+  if (gTimerID) {</span>
<a href="#l19.230"></a><span id="l19.230">     clearTimeout(gTimerID);</span>
<a href="#l19.231"></a><span id="l19.231" class="difflineplus">+  }</span>
<a href="#l19.232"></a><span id="l19.232"> </span>
<a href="#l19.233"></a><span id="l19.233">   // Put focus into the input field</span>
<a href="#l19.234"></a><span id="l19.234">   SetTextboxFocus(gDialog.srcInput);</span>
<a href="#l19.235"></a><span id="l19.235"> </span>
<a href="#l19.236"></a><span id="l19.236">   GetLocalFileURL(&quot;img&quot;).then(fileURL =&gt; {</span>
<a href="#l19.237"></a><span id="l19.237">     // Always try to relativize local file URLs</span>
<a href="#l19.238"></a><span id="l19.238" class="difflineminus">-    if (gHaveDocumentUrl)</span>
<a href="#l19.239"></a><span id="l19.239" class="difflineplus">+    if (gHaveDocumentUrl) {</span>
<a href="#l19.240"></a><span id="l19.240">       fileURL = MakeRelativeUrl(fileURL);</span>
<a href="#l19.241"></a><span id="l19.241" class="difflineplus">+    }</span>
<a href="#l19.242"></a><span id="l19.242"> </span>
<a href="#l19.243"></a><span id="l19.243">     gDialog.srcInput.value = fileURL;</span>
<a href="#l19.244"></a><span id="l19.244"> </span>
<a href="#l19.245"></a><span id="l19.245">     SetRelativeCheckbox();</span>
<a href="#l19.246"></a><span id="l19.246">     doOverallEnabling();</span>
<a href="#l19.247"></a><span id="l19.247">     LoadPreviewImage();</span>
<a href="#l19.248"></a><span id="l19.248">   });</span>
<a href="#l19.249"></a><span id="l19.249"> }</span>
<a href="#l19.250"></a><span id="l19.250"> </span>
<a href="#l19.251"></a><span id="l19.251"> function PreviewImageLoaded() {</span>
<a href="#l19.252"></a><span id="l19.252">   if (gDialog.PreviewImage) {</span>
<a href="#l19.253"></a><span id="l19.253">     // Image loading has completed -- we can get actual width</span>
<a href="#l19.254"></a><span id="l19.254" class="difflineminus">-    gActualWidth  = gDialog.PreviewImage.naturalWidth;</span>
<a href="#l19.255"></a><span id="l19.255" class="difflineplus">+    gActualWidth = gDialog.PreviewImage.naturalWidth;</span>
<a href="#l19.256"></a><span id="l19.256">     gActualHeight = gDialog.PreviewImage.naturalHeight;</span>
<a href="#l19.257"></a><span id="l19.257"> </span>
<a href="#l19.258"></a><span id="l19.258">     if (gActualWidth &amp;&amp; gActualHeight) {</span>
<a href="#l19.259"></a><span id="l19.259">       // Use actual size or scale to fit preview if either dimension is too large</span>
<a href="#l19.260"></a><span id="l19.260">       var width = gActualWidth;</span>
<a href="#l19.261"></a><span id="l19.261">       var height = gActualHeight;</span>
<a href="#l19.262"></a><span id="l19.262">       if (gActualWidth &gt; gPreviewImageWidth) {</span>
<a href="#l19.263"></a><span id="l19.263" class="difflineminus">-          width = gPreviewImageWidth;</span>
<a href="#l19.264"></a><span id="l19.264" class="difflineminus">-          height = gActualHeight * (gPreviewImageWidth / gActualWidth);</span>
<a href="#l19.265"></a><span id="l19.265" class="difflineplus">+        width = gPreviewImageWidth;</span>
<a href="#l19.266"></a><span id="l19.266" class="difflineplus">+        height = gActualHeight * (gPreviewImageWidth / gActualWidth);</span>
<a href="#l19.267"></a><span id="l19.267">       }</span>
<a href="#l19.268"></a><span id="l19.268">       if (height &gt; gPreviewImageHeight) {</span>
<a href="#l19.269"></a><span id="l19.269">         height = gPreviewImageHeight;</span>
<a href="#l19.270"></a><span id="l19.270">         width = gActualWidth * (gPreviewImageHeight / gActualHeight);</span>
<a href="#l19.271"></a><span id="l19.271">       }</span>
<a href="#l19.272"></a><span id="l19.272">       gDialog.PreviewImage.width = width;</span>
<a href="#l19.273"></a><span id="l19.273">       gDialog.PreviewImage.height = height;</span>
<a href="#l19.274"></a><span id="l19.274"> </span>
<a href="#l19.275"></a><span id="l19.275" class="difflineat">@@ -236,60 +262,68 @@ function PreviewImageLoaded() {</span>
<a href="#l19.276"></a><span id="l19.276">       gDialog.PreviewHeight.setAttribute(&quot;value&quot;, gActualHeight);</span>
<a href="#l19.277"></a><span id="l19.277"> </span>
<a href="#l19.278"></a><span id="l19.278">       gDialog.PreviewSize.collapsed = false;</span>
<a href="#l19.279"></a><span id="l19.279">       gDialog.ImageHolder.collapsed = false;</span>
<a href="#l19.280"></a><span id="l19.280"> </span>
<a href="#l19.281"></a><span id="l19.281">       SetSizeWidgets(gDialog.widthInput.value, gDialog.heightInput.value);</span>
<a href="#l19.282"></a><span id="l19.282">     }</span>
<a href="#l19.283"></a><span id="l19.283"> </span>
<a href="#l19.284"></a><span id="l19.284" class="difflineminus">-    if (gDialog.actualSizeRadio.selected)</span>
<a href="#l19.285"></a><span id="l19.285" class="difflineplus">+    if (gDialog.actualSizeRadio.selected) {</span>
<a href="#l19.286"></a><span id="l19.286">       SetActualSize();</span>
<a href="#l19.287"></a><span id="l19.287" class="difflineplus">+    }</span>
<a href="#l19.288"></a><span id="l19.288">   }</span>
<a href="#l19.289"></a><span id="l19.289"> }</span>
<a href="#l19.290"></a><span id="l19.290"> </span>
<a href="#l19.291"></a><span id="l19.291"> function LoadPreviewImage() {</span>
<a href="#l19.292"></a><span id="l19.292">   gDialog.PreviewSize.collapsed = true;</span>
<a href="#l19.293"></a><span id="l19.293">   // XXXbz workaround for bug 265416 / bug 266284</span>
<a href="#l19.294"></a><span id="l19.294">   gDialog.ImageHolder.collapsed = true;</span>
<a href="#l19.295"></a><span id="l19.295"> </span>
<a href="#l19.296"></a><span id="l19.296">   var imageSrc = TrimString(gDialog.srcInput.value);</span>
<a href="#l19.297"></a><span id="l19.297" class="difflineminus">-  if (!imageSrc)</span>
<a href="#l19.298"></a><span id="l19.298" class="difflineplus">+  if (!imageSrc) {</span>
<a href="#l19.299"></a><span id="l19.299">     return;</span>
<a href="#l19.300"></a><span id="l19.300" class="difflineplus">+  }</span>
<a href="#l19.301"></a><span id="l19.301">   if (isImageDataShortened(imageSrc)) {</span>
<a href="#l19.302"></a><span id="l19.302">     imageSrc = restoredImageData(gDialog.srcInput);</span>
<a href="#l19.303"></a><span id="l19.303">   }</span>
<a href="#l19.304"></a><span id="l19.304"> </span>
<a href="#l19.305"></a><span id="l19.305">   try {</span>
<a href="#l19.306"></a><span id="l19.306">     // Remove the image URL from image cache so it loads fresh</span>
<a href="#l19.307"></a><span id="l19.307">     //  (if we don't do this, loads after the first will always use image cache</span>
<a href="#l19.308"></a><span id="l19.308">     //   and we won't see image edit changes or be able to get actual width and height)</span>
<a href="#l19.309"></a><span id="l19.309"> </span>
<a href="#l19.310"></a><span id="l19.310">     // We must have an absolute URL to preview it or remove it from the cache</span>
<a href="#l19.311"></a><span id="l19.311">     imageSrc = MakeAbsoluteUrl(imageSrc);</span>
<a href="#l19.312"></a><span id="l19.312"> </span>
<a href="#l19.313"></a><span id="l19.313">     if (GetScheme(imageSrc)) {</span>
<a href="#l19.314"></a><span id="l19.314">       let uri = Services.io.newURI(imageSrc);</span>
<a href="#l19.315"></a><span id="l19.315">       if (uri) {</span>
<a href="#l19.316"></a><span id="l19.316" class="difflineminus">-        let imgCache = Cc[&quot;@mozilla.org/image/cache;1&quot;]</span>
<a href="#l19.317"></a><span id="l19.317" class="difflineminus">-                         .getService(Ci.imgICache);</span>
<a href="#l19.318"></a><span id="l19.318" class="difflineplus">+        let imgCache = Cc[&quot;@mozilla.org/image/cache;1&quot;].getService(</span>
<a href="#l19.319"></a><span id="l19.319" class="difflineplus">+          Ci.imgICache</span>
<a href="#l19.320"></a><span id="l19.320" class="difflineplus">+        );</span>
<a href="#l19.321"></a><span id="l19.321"> </span>
<a href="#l19.322"></a><span id="l19.322">         // This returns error if image wasn't in the cache; ignore that</span>
<a href="#l19.323"></a><span id="l19.323">         imgCache.removeEntry(uri);</span>
<a href="#l19.324"></a><span id="l19.324">       }</span>
<a href="#l19.325"></a><span id="l19.325">     }</span>
<a href="#l19.326"></a><span id="l19.326">   } catch (e) {}</span>
<a href="#l19.327"></a><span id="l19.327"> </span>
<a href="#l19.328"></a><span id="l19.328" class="difflineminus">-  if (gDialog.PreviewImage)</span>
<a href="#l19.329"></a><span id="l19.329" class="difflineplus">+  if (gDialog.PreviewImage) {</span>
<a href="#l19.330"></a><span id="l19.330">     removeEventListener(&quot;load&quot;, PreviewImageLoaded, true);</span>
<a href="#l19.331"></a><span id="l19.331" class="difflineplus">+  }</span>
<a href="#l19.332"></a><span id="l19.332"> </span>
<a href="#l19.333"></a><span id="l19.333" class="difflineminus">-  if (gDialog.ImageHolder.hasChildNodes())</span>
<a href="#l19.334"></a><span id="l19.334" class="difflineplus">+  if (gDialog.ImageHolder.hasChildNodes()) {</span>
<a href="#l19.335"></a><span id="l19.335">     gDialog.ImageHolder.firstChild.remove();</span>
<a href="#l19.336"></a><span id="l19.336" class="difflineplus">+  }</span>
<a href="#l19.337"></a><span id="l19.337"> </span>
<a href="#l19.338"></a><span id="l19.338" class="difflineminus">-  gDialog.PreviewImage = document.createElementNS(&quot;http://www.w3.org/1999/xhtml&quot;, &quot;img&quot;);</span>
<a href="#l19.339"></a><span id="l19.339" class="difflineplus">+  gDialog.PreviewImage = document.createElementNS(</span>
<a href="#l19.340"></a><span id="l19.340" class="difflineplus">+    &quot;http://www.w3.org/1999/xhtml&quot;,</span>
<a href="#l19.341"></a><span id="l19.341" class="difflineplus">+    &quot;img&quot;</span>
<a href="#l19.342"></a><span id="l19.342" class="difflineplus">+  );</span>
<a href="#l19.343"></a><span id="l19.343">   if (gDialog.PreviewImage) {</span>
<a href="#l19.344"></a><span id="l19.344">     // set the src before appending to the document -- see bug 198435 for why</span>
<a href="#l19.345"></a><span id="l19.345">     // this is needed.</span>
<a href="#l19.346"></a><span id="l19.346">     // XXXbz that bug is long-since fixed.  Is this still needed?</span>
<a href="#l19.347"></a><span id="l19.347">     gDialog.PreviewImage.addEventListener(&quot;load&quot;, PreviewImageLoaded, true);</span>
<a href="#l19.348"></a><span id="l19.348">     gDialog.PreviewImage.src = imageSrc;</span>
<a href="#l19.349"></a><span id="l19.349">     gDialog.ImageHolder.appendChild(gDialog.PreviewImage);</span>
<a href="#l19.350"></a><span id="l19.350">   }</span>
<a href="#l19.351"></a><span id="l19.351" class="difflineat">@@ -299,18 +333,19 @@ function SetActualSize() {</span>
<a href="#l19.352"></a><span id="l19.352">   gDialog.widthInput.value = gActualWidth ? gActualWidth : &quot;&quot;;</span>
<a href="#l19.353"></a><span id="l19.353">   gDialog.widthUnitsMenulist.selectedIndex = 0;</span>
<a href="#l19.354"></a><span id="l19.354">   gDialog.heightInput.value = gActualHeight ? gActualHeight : &quot;&quot;;</span>
<a href="#l19.355"></a><span id="l19.355">   gDialog.heightUnitsMenulist.selectedIndex = 0;</span>
<a href="#l19.356"></a><span id="l19.356">   doDimensionEnabling();</span>
<a href="#l19.357"></a><span id="l19.357"> }</span>
<a href="#l19.358"></a><span id="l19.358"> </span>
<a href="#l19.359"></a><span id="l19.359"> function ChangeImageSrc() {</span>
<a href="#l19.360"></a><span id="l19.360" class="difflineminus">-  if (gTimerID)</span>
<a href="#l19.361"></a><span id="l19.361" class="difflineplus">+  if (gTimerID) {</span>
<a href="#l19.362"></a><span id="l19.362">     clearTimeout(gTimerID);</span>
<a href="#l19.363"></a><span id="l19.363" class="difflineplus">+  }</span>
<a href="#l19.364"></a><span id="l19.364"> </span>
<a href="#l19.365"></a><span id="l19.365">   gTimerID = setTimeout(LoadPreviewImage, 800);</span>
<a href="#l19.366"></a><span id="l19.366"> </span>
<a href="#l19.367"></a><span id="l19.367">   SetRelativeCheckbox();</span>
<a href="#l19.368"></a><span id="l19.368">   doOverallEnabling();</span>
<a href="#l19.369"></a><span id="l19.369"> }</span>
<a href="#l19.370"></a><span id="l19.370"> </span>
<a href="#l19.371"></a><span id="l19.371"> function doDimensionEnabling() {</span>
<a href="#l19.372"></a><span id="l19.372" class="difflineat">@@ -323,137 +358,170 @@ function doDimensionEnabling() {</span>
<a href="#l19.373"></a><span id="l19.373">   SetElementEnabledById(&quot;heightInput&quot;, enable);</span>
<a href="#l19.374"></a><span id="l19.374">   SetElementEnabledById(&quot;heightLabel&quot;, enable);</span>
<a href="#l19.375"></a><span id="l19.375">   SetElementEnabledById(&quot;heightUnitsMenulist&quot;, enable);</span>
<a href="#l19.376"></a><span id="l19.376"> </span>
<a href="#l19.377"></a><span id="l19.377">   SetElementEnabledById(&quot;widthInput&quot;, enable);</span>
<a href="#l19.378"></a><span id="l19.378">   SetElementEnabledById(&quot;widthLabel&quot;, enable);</span>
<a href="#l19.379"></a><span id="l19.379">   SetElementEnabledById(&quot;widthUnitsMenulist&quot;, enable);</span>
<a href="#l19.380"></a><span id="l19.380"> </span>
<a href="#l19.381"></a><span id="l19.381" class="difflineminus">-  var constrainEnable = enable</span>
<a href="#l19.382"></a><span id="l19.382" class="difflineminus">-         &amp;&amp; (gDialog.widthUnitsMenulist.selectedIndex == 0)</span>
<a href="#l19.383"></a><span id="l19.383" class="difflineminus">-         &amp;&amp; (gDialog.heightUnitsMenulist.selectedIndex == 0);</span>
<a href="#l19.384"></a><span id="l19.384" class="difflineplus">+  var constrainEnable =</span>
<a href="#l19.385"></a><span id="l19.385" class="difflineplus">+    enable &amp;&amp;</span>
<a href="#l19.386"></a><span id="l19.386" class="difflineplus">+    gDialog.widthUnitsMenulist.selectedIndex == 0 &amp;&amp;</span>
<a href="#l19.387"></a><span id="l19.387" class="difflineplus">+    gDialog.heightUnitsMenulist.selectedIndex == 0;</span>
<a href="#l19.388"></a><span id="l19.388"> </span>
<a href="#l19.389"></a><span id="l19.389">   SetElementEnabledById(&quot;constrainCheckbox&quot;, constrainEnable);</span>
<a href="#l19.390"></a><span id="l19.390"> }</span>
<a href="#l19.391"></a><span id="l19.391"> </span>
<a href="#l19.392"></a><span id="l19.392"> function doOverallEnabling() {</span>
<a href="#l19.393"></a><span id="l19.393">   var enabled = TrimString(gDialog.srcInput.value) != &quot;&quot;;</span>
<a href="#l19.394"></a><span id="l19.394"> </span>
<a href="#l19.395"></a><span id="l19.395">   SetElementEnabled(gDialog.OkButton, enabled);</span>
<a href="#l19.396"></a><span id="l19.396">   SetElementEnabledById(&quot;AdvancedEditButton1&quot;, enabled);</span>
<a href="#l19.397"></a><span id="l19.397">   SetElementEnabledById(&quot;imagemapLabel&quot;, enabled);</span>
<a href="#l19.398"></a><span id="l19.398">   SetElementEnabledById(&quot;removeImageMap&quot;, gCanRemoveImageMap);</span>
<a href="#l19.399"></a><span id="l19.399"> }</span>
<a href="#l19.400"></a><span id="l19.400"> </span>
<a href="#l19.401"></a><span id="l19.401"> function ToggleConstrain() {</span>
<a href="#l19.402"></a><span id="l19.402">   // If just turned on, save the current width and height as basis for constrain ratio</span>
<a href="#l19.403"></a><span id="l19.403">   // Thus clicking on/off lets user say &quot;Use these values as aspect ration&quot;</span>
<a href="#l19.404"></a><span id="l19.404" class="difflineminus">-  if (gDialog.constrainCheckbox.checked &amp;&amp; !gDialog.constrainCheckbox.disabled</span>
<a href="#l19.405"></a><span id="l19.405" class="difflineminus">-     &amp;&amp; (gDialog.widthUnitsMenulist.selectedIndex == 0)</span>
<a href="#l19.406"></a><span id="l19.406" class="difflineminus">-     &amp;&amp; (gDialog.heightUnitsMenulist.selectedIndex == 0)) {</span>
<a href="#l19.407"></a><span id="l19.407" class="difflineplus">+  if (</span>
<a href="#l19.408"></a><span id="l19.408" class="difflineplus">+    gDialog.constrainCheckbox.checked &amp;&amp;</span>
<a href="#l19.409"></a><span id="l19.409" class="difflineplus">+    !gDialog.constrainCheckbox.disabled &amp;&amp;</span>
<a href="#l19.410"></a><span id="l19.410" class="difflineplus">+    gDialog.widthUnitsMenulist.selectedIndex == 0 &amp;&amp;</span>
<a href="#l19.411"></a><span id="l19.411" class="difflineplus">+    gDialog.heightUnitsMenulist.selectedIndex == 0</span>
<a href="#l19.412"></a><span id="l19.412" class="difflineplus">+  ) {</span>
<a href="#l19.413"></a><span id="l19.413">     gConstrainWidth = Number(TrimString(gDialog.widthInput.value));</span>
<a href="#l19.414"></a><span id="l19.414">     gConstrainHeight = Number(TrimString(gDialog.heightInput.value));</span>
<a href="#l19.415"></a><span id="l19.415">   }</span>
<a href="#l19.416"></a><span id="l19.416"> }</span>
<a href="#l19.417"></a><span id="l19.417"> </span>
<a href="#l19.418"></a><span id="l19.418"> function constrainProportions(srcID, destID) {</span>
<a href="#l19.419"></a><span id="l19.419">   var srcElement = document.getElementById(srcID);</span>
<a href="#l19.420"></a><span id="l19.420" class="difflineminus">-  if (!srcElement)</span>
<a href="#l19.421"></a><span id="l19.421" class="difflineplus">+  if (!srcElement) {</span>
<a href="#l19.422"></a><span id="l19.422">     return;</span>
<a href="#l19.423"></a><span id="l19.423" class="difflineplus">+  }</span>
<a href="#l19.424"></a><span id="l19.424"> </span>
<a href="#l19.425"></a><span id="l19.425">   var destElement = document.getElementById(destID);</span>
<a href="#l19.426"></a><span id="l19.426" class="difflineminus">-  if (!destElement)</span>
<a href="#l19.427"></a><span id="l19.427" class="difflineplus">+  if (!destElement) {</span>
<a href="#l19.428"></a><span id="l19.428">     return;</span>
<a href="#l19.429"></a><span id="l19.429" class="difflineplus">+  }</span>
<a href="#l19.430"></a><span id="l19.430"> </span>
<a href="#l19.431"></a><span id="l19.431">   // always force an integer (whether we are constraining or not)</span>
<a href="#l19.432"></a><span id="l19.432">   forceInteger(srcID);</span>
<a href="#l19.433"></a><span id="l19.433"> </span>
<a href="#l19.434"></a><span id="l19.434" class="difflineminus">-  if (!gActualWidth || !gActualHeight ||</span>
<a href="#l19.435"></a><span id="l19.435" class="difflineminus">-      !(gDialog.constrainCheckbox.checked &amp;&amp; !gDialog.constrainCheckbox.disabled))</span>
<a href="#l19.436"></a><span id="l19.436" class="difflineplus">+  if (</span>
<a href="#l19.437"></a><span id="l19.437" class="difflineplus">+    !gActualWidth ||</span>
<a href="#l19.438"></a><span id="l19.438" class="difflineplus">+    !gActualHeight ||</span>
<a href="#l19.439"></a><span id="l19.439" class="difflineplus">+    !(gDialog.constrainCheckbox.checked &amp;&amp; !gDialog.constrainCheckbox.disabled)</span>
<a href="#l19.440"></a><span id="l19.440" class="difflineplus">+  ) {</span>
<a href="#l19.441"></a><span id="l19.441">     return;</span>
<a href="#l19.442"></a><span id="l19.442" class="difflineplus">+  }</span>
<a href="#l19.443"></a><span id="l19.443"> </span>
<a href="#l19.444"></a><span id="l19.444">   // double-check that neither width nor height is in percent mode; bail if so!</span>
<a href="#l19.445"></a><span id="l19.445" class="difflineminus">-  if ((gDialog.widthUnitsMenulist.selectedIndex != 0)</span>
<a href="#l19.446"></a><span id="l19.446" class="difflineminus">-     || (gDialog.heightUnitsMenulist.selectedIndex != 0))</span>
<a href="#l19.447"></a><span id="l19.447" class="difflineplus">+  if (</span>
<a href="#l19.448"></a><span id="l19.448" class="difflineplus">+    gDialog.widthUnitsMenulist.selectedIndex != 0 ||</span>
<a href="#l19.449"></a><span id="l19.449" class="difflineplus">+    gDialog.heightUnitsMenulist.selectedIndex != 0</span>
<a href="#l19.450"></a><span id="l19.450" class="difflineplus">+  ) {</span>
<a href="#l19.451"></a><span id="l19.451">     return;</span>
<a href="#l19.452"></a><span id="l19.452" class="difflineplus">+  }</span>
<a href="#l19.453"></a><span id="l19.453"> </span>
<a href="#l19.454"></a><span id="l19.454">   // This always uses the actual width and height ratios</span>
<a href="#l19.455"></a><span id="l19.455">   // which is kind of funky if you change one number without the constrain</span>
<a href="#l19.456"></a><span id="l19.456">   // and then turn constrain on and change a number</span>
<a href="#l19.457"></a><span id="l19.457">   // I prefer the old strategy (below) but I can see some merit to this solution</span>
<a href="#l19.458"></a><span id="l19.458" class="difflineminus">-  if (srcID == &quot;widthInput&quot;)</span>
<a href="#l19.459"></a><span id="l19.459" class="difflineminus">-    destElement.value = Math.round(srcElement.value * gActualHeight / gActualWidth);</span>
<a href="#l19.460"></a><span id="l19.460" class="difflineminus">-  else</span>
<a href="#l19.461"></a><span id="l19.461" class="difflineminus">-    destElement.value = Math.round(srcElement.value * gActualWidth / gActualHeight);</span>
<a href="#l19.462"></a><span id="l19.462" class="difflineplus">+  if (srcID == &quot;widthInput&quot;) {</span>
<a href="#l19.463"></a><span id="l19.463" class="difflineplus">+    destElement.value = Math.round(</span>
<a href="#l19.464"></a><span id="l19.464" class="difflineplus">+      (srcElement.value * gActualHeight) / gActualWidth</span>
<a href="#l19.465"></a><span id="l19.465" class="difflineplus">+    );</span>
<a href="#l19.466"></a><span id="l19.466" class="difflineplus">+  } else {</span>
<a href="#l19.467"></a><span id="l19.467" class="difflineplus">+    destElement.value = Math.round(</span>
<a href="#l19.468"></a><span id="l19.468" class="difflineplus">+      (srcElement.value * gActualWidth) / gActualHeight</span>
<a href="#l19.469"></a><span id="l19.469" class="difflineplus">+    );</span>
<a href="#l19.470"></a><span id="l19.470" class="difflineplus">+  }</span>
<a href="#l19.471"></a><span id="l19.471"> </span>
<a href="#l19.472"></a><span id="l19.472" class="difflineminus">-/*</span>
<a href="#l19.473"></a><span id="l19.473" class="difflineplus">+  /*</span>
<a href="#l19.474"></a><span id="l19.474">   // With this strategy, the width and height ratio</span>
<a href="#l19.475"></a><span id="l19.475">   //   can be reset to whatever the user entered.</span>
<a href="#l19.476"></a><span id="l19.476">   if (srcID == &quot;widthInput&quot;)</span>
<a href="#l19.477"></a><span id="l19.477">     destElement.value = Math.round( srcElement.value * gConstrainHeight / gConstrainWidth );</span>
<a href="#l19.478"></a><span id="l19.478">   else</span>
<a href="#l19.479"></a><span id="l19.479">     destElement.value = Math.round( srcElement.value * gConstrainWidth / gConstrainHeight );</span>
<a href="#l19.480"></a><span id="l19.480"> */</span>
<a href="#l19.481"></a><span id="l19.481"> }</span>
<a href="#l19.482"></a><span id="l19.482"> </span>
<a href="#l19.483"></a><span id="l19.483"> function removeImageMap() {</span>
<a href="#l19.484"></a><span id="l19.484">   gRemoveImageMap = true;</span>
<a href="#l19.485"></a><span id="l19.485">   gCanRemoveImageMap = false;</span>
<a href="#l19.486"></a><span id="l19.486">   SetElementEnabledById(&quot;removeImageMap&quot;, false);</span>
<a href="#l19.487"></a><span id="l19.487"> }</span>
<a href="#l19.488"></a><span id="l19.488"> </span>
<a href="#l19.489"></a><span id="l19.489"> function SwitchToValidatePanel() {</span>
<a href="#l19.490"></a><span id="l19.490" class="difflineminus">-  if (gDialog.tabBox &amp;&amp; gValidateTab &amp;&amp; gDialog.tabBox.selectedTab != gValidateTab)</span>
<a href="#l19.491"></a><span id="l19.491" class="difflineplus">+  if (</span>
<a href="#l19.492"></a><span id="l19.492" class="difflineplus">+    gDialog.tabBox &amp;&amp;</span>
<a href="#l19.493"></a><span id="l19.493" class="difflineplus">+    gValidateTab &amp;&amp;</span>
<a href="#l19.494"></a><span id="l19.494" class="difflineplus">+    gDialog.tabBox.selectedTab != gValidateTab</span>
<a href="#l19.495"></a><span id="l19.495" class="difflineplus">+  ) {</span>
<a href="#l19.496"></a><span id="l19.496">     gDialog.tabBox.selectedTab = gValidateTab;</span>
<a href="#l19.497"></a><span id="l19.497" class="difflineplus">+  }</span>
<a href="#l19.498"></a><span id="l19.498"> }</span>
<a href="#l19.499"></a><span id="l19.499"> </span>
<a href="#l19.500"></a><span id="l19.500"> // Get data from widgets, validate, and set for the global element</span>
<a href="#l19.501"></a><span id="l19.501"> //   accessible to AdvancedEdit() [in EdDialogCommon.js]</span>
<a href="#l19.502"></a><span id="l19.502"> function ValidateImage() {</span>
<a href="#l19.503"></a><span id="l19.503">   var editor = GetCurrentEditor();</span>
<a href="#l19.504"></a><span id="l19.504" class="difflineminus">-  if (!editor)</span>
<a href="#l19.505"></a><span id="l19.505" class="difflineplus">+  if (!editor) {</span>
<a href="#l19.506"></a><span id="l19.506">     return false;</span>
<a href="#l19.507"></a><span id="l19.507" class="difflineplus">+  }</span>
<a href="#l19.508"></a><span id="l19.508"> </span>
<a href="#l19.509"></a><span id="l19.509">   gValidateTab = gDialog.tabLocation;</span>
<a href="#l19.510"></a><span id="l19.510">   if (!gDialog.srcInput.value) {</span>
<a href="#l19.511"></a><span id="l19.511" class="difflineminus">-    Services.prompt.alert(window, GetString(&quot;Alert&quot;), GetString(&quot;MissingImageError&quot;));</span>
<a href="#l19.512"></a><span id="l19.512" class="difflineplus">+    Services.prompt.alert(</span>
<a href="#l19.513"></a><span id="l19.513" class="difflineplus">+      window,</span>
<a href="#l19.514"></a><span id="l19.514" class="difflineplus">+      GetString(&quot;Alert&quot;),</span>
<a href="#l19.515"></a><span id="l19.515" class="difflineplus">+      GetString(&quot;MissingImageError&quot;)</span>
<a href="#l19.516"></a><span id="l19.516" class="difflineplus">+    );</span>
<a href="#l19.517"></a><span id="l19.517">     SwitchToValidatePanel();</span>
<a href="#l19.518"></a><span id="l19.518">     gDialog.srcInput.focus();</span>
<a href="#l19.519"></a><span id="l19.519">     return false;</span>
<a href="#l19.520"></a><span id="l19.520">   }</span>
<a href="#l19.521"></a><span id="l19.521"> </span>
<a href="#l19.522"></a><span id="l19.522">   // We must convert to &quot;file:///&quot; or &quot;http://&quot; format else image doesn't load!</span>
<a href="#l19.523"></a><span id="l19.523">   let src = gDialog.srcInput.value.trim();</span>
<a href="#l19.524"></a><span id="l19.524"> </span>
<a href="#l19.525"></a><span id="l19.525">   if (isImageDataShortened(src)) {</span>
<a href="#l19.526"></a><span id="l19.526">     src = restoredImageData(gDialog.srcInput);</span>
<a href="#l19.527"></a><span id="l19.527">   } else {</span>
<a href="#l19.528"></a><span id="l19.528">     var checkbox = document.getElementById(&quot;MakeRelativeCheckbox&quot;);</span>
<a href="#l19.529"></a><span id="l19.529">     try {</span>
<a href="#l19.530"></a><span id="l19.530">       if (checkbox &amp;&amp; !checkbox.checked) {</span>
<a href="#l19.531"></a><span id="l19.531" class="difflineminus">-        src = Services.uriFixup.createFixupURI(src, Ci.nsIURIFixup.FIXUP_FLAG_NONE).spec;</span>
<a href="#l19.532"></a><span id="l19.532" class="difflineplus">+        src = Services.uriFixup.createFixupURI(</span>
<a href="#l19.533"></a><span id="l19.533" class="difflineplus">+          src,</span>
<a href="#l19.534"></a><span id="l19.534" class="difflineplus">+          Ci.nsIURIFixup.FIXUP_FLAG_NONE</span>
<a href="#l19.535"></a><span id="l19.535" class="difflineplus">+        ).spec;</span>
<a href="#l19.536"></a><span id="l19.536">       }</span>
<a href="#l19.537"></a><span id="l19.537">     } catch (e) {}</span>
<a href="#l19.538"></a><span id="l19.538"> </span>
<a href="#l19.539"></a><span id="l19.539">     globalElement.setAttribute(&quot;src&quot;, src);</span>
<a href="#l19.540"></a><span id="l19.540">   }</span>
<a href="#l19.541"></a><span id="l19.541"> </span>
<a href="#l19.542"></a><span id="l19.542">   let title = gDialog.titleInput.value.trim();</span>
<a href="#l19.543"></a><span id="l19.543" class="difflineminus">-  if (title)</span>
<a href="#l19.544"></a><span id="l19.544" class="difflineplus">+  if (title) {</span>
<a href="#l19.545"></a><span id="l19.545">     globalElement.setAttribute(&quot;title&quot;, title);</span>
<a href="#l19.546"></a><span id="l19.546" class="difflineminus">-  else</span>
<a href="#l19.547"></a><span id="l19.547" class="difflineplus">+  } else {</span>
<a href="#l19.548"></a><span id="l19.548">     globalElement.removeAttribute(&quot;title&quot;);</span>
<a href="#l19.549"></a><span id="l19.549" class="difflineplus">+  }</span>
<a href="#l19.550"></a><span id="l19.550"> </span>
<a href="#l19.551"></a><span id="l19.551">   // Force user to enter Alt text only if &quot;Alternate text&quot; radio is checked</span>
<a href="#l19.552"></a><span id="l19.552">   // Don't allow just spaces in alt text</span>
<a href="#l19.553"></a><span id="l19.553">   var alt = &quot;&quot;;</span>
<a href="#l19.554"></a><span id="l19.554">   var useAlt = gDialog.altTextRadioGroup.selectedItem == gDialog.altTextRadio;</span>
<a href="#l19.555"></a><span id="l19.555" class="difflineminus">-  if (useAlt)</span>
<a href="#l19.556"></a><span id="l19.556" class="difflineplus">+  if (useAlt) {</span>
<a href="#l19.557"></a><span id="l19.557">     alt = TrimString(gDialog.altTextInput.value);</span>
<a href="#l19.558"></a><span id="l19.558" class="difflineplus">+  }</span>
<a href="#l19.559"></a><span id="l19.559"> </span>
<a href="#l19.560"></a><span id="l19.560">   if (alt || !useAlt) {</span>
<a href="#l19.561"></a><span id="l19.561">     globalElement.setAttribute(&quot;alt&quot;, alt);</span>
<a href="#l19.562"></a><span id="l19.562">   } else if (!gDoAltTextError) {</span>
<a href="#l19.563"></a><span id="l19.563">     globalElement.removeAttribute(&quot;alt&quot;);</span>
<a href="#l19.564"></a><span id="l19.564">   } else {</span>
<a href="#l19.565"></a><span id="l19.565">     Services.prompt.alert(window, GetString(&quot;Alert&quot;), GetString(&quot;NoAltText&quot;));</span>
<a href="#l19.566"></a><span id="l19.566">     SwitchToValidatePanel();</span>
<a href="#l19.567"></a><span id="l19.567" class="difflineat">@@ -462,76 +530,130 @@ function ValidateImage() {</span>
<a href="#l19.568"></a><span id="l19.568">   }</span>
<a href="#l19.569"></a><span id="l19.569"> </span>
<a href="#l19.570"></a><span id="l19.570">   var width = &quot;&quot;;</span>
<a href="#l19.571"></a><span id="l19.571">   var height = &quot;&quot;;</span>
<a href="#l19.572"></a><span id="l19.572"> </span>
<a href="#l19.573"></a><span id="l19.573">   gValidateTab = gDialog.tabDimensions;</span>
<a href="#l19.574"></a><span id="l19.574">   if (!gDialog.actualSizeRadio.selected) {</span>
<a href="#l19.575"></a><span id="l19.575">     // Get user values for width and height</span>
<a href="#l19.576"></a><span id="l19.576" class="difflineminus">-    width = ValidateNumber(gDialog.widthInput, gDialog.widthUnitsMenulist, 1, gMaxPixels,</span>
<a href="#l19.577"></a><span id="l19.577" class="difflineminus">-                           globalElement, &quot;width&quot;, false, true);</span>
<a href="#l19.578"></a><span id="l19.578" class="difflineminus">-    if (gValidationError)</span>
<a href="#l19.579"></a><span id="l19.579" class="difflineplus">+    width = ValidateNumber(</span>
<a href="#l19.580"></a><span id="l19.580" class="difflineplus">+      gDialog.widthInput,</span>
<a href="#l19.581"></a><span id="l19.581" class="difflineplus">+      gDialog.widthUnitsMenulist,</span>
<a href="#l19.582"></a><span id="l19.582" class="difflineplus">+      1,</span>
<a href="#l19.583"></a><span id="l19.583" class="difflineplus">+      gMaxPixels,</span>
<a href="#l19.584"></a><span id="l19.584" class="difflineplus">+      globalElement,</span>
<a href="#l19.585"></a><span id="l19.585" class="difflineplus">+      &quot;width&quot;,</span>
<a href="#l19.586"></a><span id="l19.586" class="difflineplus">+      false,</span>
<a href="#l19.587"></a><span id="l19.587" class="difflineplus">+      true</span>
<a href="#l19.588"></a><span id="l19.588" class="difflineplus">+    );</span>
<a href="#l19.589"></a><span id="l19.589" class="difflineplus">+    if (gValidationError) {</span>
<a href="#l19.590"></a><span id="l19.590">       return false;</span>
<a href="#l19.591"></a><span id="l19.591" class="difflineplus">+    }</span>
<a href="#l19.592"></a><span id="l19.592"> </span>
<a href="#l19.593"></a><span id="l19.593" class="difflineminus">-    height = ValidateNumber(gDialog.heightInput, gDialog.heightUnitsMenulist, 1, gMaxPixels,</span>
<a href="#l19.594"></a><span id="l19.594" class="difflineminus">-                            globalElement, &quot;height&quot;, false, true);</span>
<a href="#l19.595"></a><span id="l19.595" class="difflineminus">-    if (gValidationError)</span>
<a href="#l19.596"></a><span id="l19.596" class="difflineplus">+    height = ValidateNumber(</span>
<a href="#l19.597"></a><span id="l19.597" class="difflineplus">+      gDialog.heightInput,</span>
<a href="#l19.598"></a><span id="l19.598" class="difflineplus">+      gDialog.heightUnitsMenulist,</span>
<a href="#l19.599"></a><span id="l19.599" class="difflineplus">+      1,</span>
<a href="#l19.600"></a><span id="l19.600" class="difflineplus">+      gMaxPixels,</span>
<a href="#l19.601"></a><span id="l19.601" class="difflineplus">+      globalElement,</span>
<a href="#l19.602"></a><span id="l19.602" class="difflineplus">+      &quot;height&quot;,</span>
<a href="#l19.603"></a><span id="l19.603" class="difflineplus">+      false,</span>
<a href="#l19.604"></a><span id="l19.604" class="difflineplus">+      true</span>
<a href="#l19.605"></a><span id="l19.605" class="difflineplus">+    );</span>
<a href="#l19.606"></a><span id="l19.606" class="difflineplus">+    if (gValidationError) {</span>
<a href="#l19.607"></a><span id="l19.607">       return false;</span>
<a href="#l19.608"></a><span id="l19.608" class="difflineplus">+    }</span>
<a href="#l19.609"></a><span id="l19.609">   }</span>
<a href="#l19.610"></a><span id="l19.610"> </span>
<a href="#l19.611"></a><span id="l19.611">   // We always set the width and height attributes, even if same as actual.</span>
<a href="#l19.612"></a><span id="l19.612">   //  This speeds up layout of pages since sizes are known before image is loaded</span>
<a href="#l19.613"></a><span id="l19.613" class="difflineminus">-  if (!width)</span>
<a href="#l19.614"></a><span id="l19.614" class="difflineplus">+  if (!width) {</span>
<a href="#l19.615"></a><span id="l19.615">     width = gActualWidth;</span>
<a href="#l19.616"></a><span id="l19.616" class="difflineminus">-  if (!height)</span>
<a href="#l19.617"></a><span id="l19.617" class="difflineplus">+  }</span>
<a href="#l19.618"></a><span id="l19.618" class="difflineplus">+  if (!height) {</span>
<a href="#l19.619"></a><span id="l19.619">     height = gActualHeight;</span>
<a href="#l19.620"></a><span id="l19.620" class="difflineplus">+  }</span>
<a href="#l19.621"></a><span id="l19.621"> </span>
<a href="#l19.622"></a><span id="l19.622">   // Remove existing width and height only if source changed</span>
<a href="#l19.623"></a><span id="l19.623">   //  and we couldn't obtain actual dimensions</span>
<a href="#l19.624"></a><span id="l19.624" class="difflineminus">-  var srcChanged = (src != gOriginalSrc);</span>
<a href="#l19.625"></a><span id="l19.625" class="difflineminus">-  if (width)</span>
<a href="#l19.626"></a><span id="l19.626" class="difflineplus">+  var srcChanged = src != gOriginalSrc;</span>
<a href="#l19.627"></a><span id="l19.627" class="difflineplus">+  if (width) {</span>
<a href="#l19.628"></a><span id="l19.628">     editor.setAttributeOrEquivalent(globalElement, &quot;width&quot;, width, true);</span>
<a href="#l19.629"></a><span id="l19.629" class="difflineminus">-  else if (srcChanged)</span>
<a href="#l19.630"></a><span id="l19.630" class="difflineplus">+  } else if (srcChanged) {</span>
<a href="#l19.631"></a><span id="l19.631">     editor.removeAttributeOrEquivalent(globalElement, &quot;width&quot;, true);</span>
<a href="#l19.632"></a><span id="l19.632" class="difflineplus">+  }</span>
<a href="#l19.633"></a><span id="l19.633"> </span>
<a href="#l19.634"></a><span id="l19.634" class="difflineminus">-  if (height)</span>
<a href="#l19.635"></a><span id="l19.635" class="difflineplus">+  if (height) {</span>
<a href="#l19.636"></a><span id="l19.636">     editor.setAttributeOrEquivalent(globalElement, &quot;height&quot;, height, true);</span>
<a href="#l19.637"></a><span id="l19.637" class="difflineminus">-  else if (srcChanged)</span>
<a href="#l19.638"></a><span id="l19.638" class="difflineplus">+  } else if (srcChanged) {</span>
<a href="#l19.639"></a><span id="l19.639">     editor.removeAttributeOrEquivalent(globalElement, &quot;height&quot;, true);</span>
<a href="#l19.640"></a><span id="l19.640" class="difflineplus">+  }</span>
<a href="#l19.641"></a><span id="l19.641"> </span>
<a href="#l19.642"></a><span id="l19.642">   // spacing attributes</span>
<a href="#l19.643"></a><span id="l19.643">   gValidateTab = gDialog.tabBorder;</span>
<a href="#l19.644"></a><span id="l19.644" class="difflineminus">-  ValidateNumber(gDialog.imagelrInput, null, 0, gMaxPixels,</span>
<a href="#l19.645"></a><span id="l19.645" class="difflineminus">-                 globalElement, &quot;hspace&quot;, false, true, true);</span>
<a href="#l19.646"></a><span id="l19.646" class="difflineminus">-  if (gValidationError)</span>
<a href="#l19.647"></a><span id="l19.647" class="difflineplus">+  ValidateNumber(</span>
<a href="#l19.648"></a><span id="l19.648" class="difflineplus">+    gDialog.imagelrInput,</span>
<a href="#l19.649"></a><span id="l19.649" class="difflineplus">+    null,</span>
<a href="#l19.650"></a><span id="l19.650" class="difflineplus">+    0,</span>
<a href="#l19.651"></a><span id="l19.651" class="difflineplus">+    gMaxPixels,</span>
<a href="#l19.652"></a><span id="l19.652" class="difflineplus">+    globalElement,</span>
<a href="#l19.653"></a><span id="l19.653" class="difflineplus">+    &quot;hspace&quot;,</span>
<a href="#l19.654"></a><span id="l19.654" class="difflineplus">+    false,</span>
<a href="#l19.655"></a><span id="l19.655" class="difflineplus">+    true,</span>
<a href="#l19.656"></a><span id="l19.656" class="difflineplus">+    true</span>
<a href="#l19.657"></a><span id="l19.657" class="difflineplus">+  );</span>
<a href="#l19.658"></a><span id="l19.658" class="difflineplus">+  if (gValidationError) {</span>
<a href="#l19.659"></a><span id="l19.659">     return false;</span>
<a href="#l19.660"></a><span id="l19.660" class="difflineplus">+  }</span>
<a href="#l19.661"></a><span id="l19.661"> </span>
<a href="#l19.662"></a><span id="l19.662" class="difflineminus">-  ValidateNumber(gDialog.imagetbInput, null, 0, gMaxPixels,</span>
<a href="#l19.663"></a><span id="l19.663" class="difflineminus">-                 globalElement, &quot;vspace&quot;, false, true);</span>
<a href="#l19.664"></a><span id="l19.664" class="difflineminus">-  if (gValidationError)</span>
<a href="#l19.665"></a><span id="l19.665" class="difflineplus">+  ValidateNumber(</span>
<a href="#l19.666"></a><span id="l19.666" class="difflineplus">+    gDialog.imagetbInput,</span>
<a href="#l19.667"></a><span id="l19.667" class="difflineplus">+    null,</span>
<a href="#l19.668"></a><span id="l19.668" class="difflineplus">+    0,</span>
<a href="#l19.669"></a><span id="l19.669" class="difflineplus">+    gMaxPixels,</span>
<a href="#l19.670"></a><span id="l19.670" class="difflineplus">+    globalElement,</span>
<a href="#l19.671"></a><span id="l19.671" class="difflineplus">+    &quot;vspace&quot;,</span>
<a href="#l19.672"></a><span id="l19.672" class="difflineplus">+    false,</span>
<a href="#l19.673"></a><span id="l19.673" class="difflineplus">+    true</span>
<a href="#l19.674"></a><span id="l19.674" class="difflineplus">+  );</span>
<a href="#l19.675"></a><span id="l19.675" class="difflineplus">+  if (gValidationError) {</span>
<a href="#l19.676"></a><span id="l19.676">     return false;</span>
<a href="#l19.677"></a><span id="l19.677" class="difflineplus">+  }</span>
<a href="#l19.678"></a><span id="l19.678"> </span>
<a href="#l19.679"></a><span id="l19.679">   // note this is deprecated and should be converted to stylesheets</span>
<a href="#l19.680"></a><span id="l19.680" class="difflineminus">-  ValidateNumber(gDialog.border, null, 0, gMaxPixels,</span>
<a href="#l19.681"></a><span id="l19.681" class="difflineminus">-                 globalElement, &quot;border&quot;, false, true);</span>
<a href="#l19.682"></a><span id="l19.682" class="difflineminus">-  if (gValidationError)</span>
<a href="#l19.683"></a><span id="l19.683" class="difflineplus">+  ValidateNumber(</span>
<a href="#l19.684"></a><span id="l19.684" class="difflineplus">+    gDialog.border,</span>
<a href="#l19.685"></a><span id="l19.685" class="difflineplus">+    null,</span>
<a href="#l19.686"></a><span id="l19.686" class="difflineplus">+    0,</span>
<a href="#l19.687"></a><span id="l19.687" class="difflineplus">+    gMaxPixels,</span>
<a href="#l19.688"></a><span id="l19.688" class="difflineplus">+    globalElement,</span>
<a href="#l19.689"></a><span id="l19.689" class="difflineplus">+    &quot;border&quot;,</span>
<a href="#l19.690"></a><span id="l19.690" class="difflineplus">+    false,</span>
<a href="#l19.691"></a><span id="l19.691" class="difflineplus">+    true</span>
<a href="#l19.692"></a><span id="l19.692" class="difflineplus">+  );</span>
<a href="#l19.693"></a><span id="l19.693" class="difflineplus">+  if (gValidationError) {</span>
<a href="#l19.694"></a><span id="l19.694">     return false;</span>
<a href="#l19.695"></a><span id="l19.695" class="difflineplus">+  }</span>
<a href="#l19.696"></a><span id="l19.696"> </span>
<a href="#l19.697"></a><span id="l19.697">   // Default or setting &quot;bottom&quot; means don't set the attribute</span>
<a href="#l19.698"></a><span id="l19.698">   // Note that the attributes &quot;left&quot; and &quot;right&quot; are opposite</span>
<a href="#l19.699"></a><span id="l19.699">   //  of what we use in the UI, which describes where the TEXT wraps,</span>
<a href="#l19.700"></a><span id="l19.700">   //  not the image location (which is what the HTML describes)</span>
<a href="#l19.701"></a><span id="l19.701">   switch (gDialog.alignTypeSelect.value) {</span>
<a href="#l19.702"></a><span id="l19.702">     case &quot;top&quot;:</span>
<a href="#l19.703"></a><span id="l19.703">     case &quot;middle&quot;:</span>
<a href="#l19.704"></a><span id="l19.704">     case &quot;right&quot;:</span>
<a href="#l19.705"></a><span id="l19.705">     case &quot;left&quot;:</span>
<a href="#l19.706"></a><span id="l19.706" class="difflineminus">-      editor.setAttributeOrEquivalent(globalElement, &quot;align&quot;,</span>
<a href="#l19.707"></a><span id="l19.707" class="difflineminus">-                                       gDialog.alignTypeSelect.value, true);</span>
<a href="#l19.708"></a><span id="l19.708" class="difflineplus">+      editor.setAttributeOrEquivalent(</span>
<a href="#l19.709"></a><span id="l19.709" class="difflineplus">+        globalElement,</span>
<a href="#l19.710"></a><span id="l19.710" class="difflineplus">+        &quot;align&quot;,</span>
<a href="#l19.711"></a><span id="l19.711" class="difflineplus">+        gDialog.alignTypeSelect.value,</span>
<a href="#l19.712"></a><span id="l19.712" class="difflineplus">+        true</span>
<a href="#l19.713"></a><span id="l19.713" class="difflineplus">+      );</span>
<a href="#l19.714"></a><span id="l19.714">       break;</span>
<a href="#l19.715"></a><span id="l19.715">     default:</span>
<a href="#l19.716"></a><span id="l19.716">       try {</span>
<a href="#l19.717"></a><span id="l19.717">         editor.removeAttributeOrEquivalent(globalElement, &quot;align&quot;, true);</span>
<a href="#l19.718"></a><span id="l19.718">       } catch (e) {}</span>
<a href="#l19.719"></a><span id="l19.719">   }</span>
<a href="#l19.720"></a><span id="l19.720"> </span>
<a href="#l19.721"></a><span id="l19.721">   return true;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdImageLinkLoader.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdImageLinkLoader.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -1,55 +1,64 @@</span>
<a href="#l20.4"></a><span id="l20.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.5"></a><span id="l20.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.6"></a><span id="l20.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.7"></a><span id="l20.7"> </span>
<a href="#l20.8"></a><span id="l20.8"> /* import-globals-from ../../composer/content/editorUtilities.js */</span>
<a href="#l20.9"></a><span id="l20.9"> /* import-globals-from EdDialogCommon.js */</span>
<a href="#l20.10"></a><span id="l20.10"> </span>
<a href="#l20.11"></a><span id="l20.11" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l20.13"></a><span id="l20.13"> </span>
<a href="#l20.14"></a><span id="l20.14"> var gMsgCompProcessLink = false;</span>
<a href="#l20.15"></a><span id="l20.15"> var gMsgCompInputElement = null;</span>
<a href="#l20.16"></a><span id="l20.16"> var gMsgCompPrevInputValue = null;</span>
<a href="#l20.17"></a><span id="l20.17"> var gMsgCompPrevMozDoNotSendAttribute;</span>
<a href="#l20.18"></a><span id="l20.18"> var gMsgCompAttachSourceElement = null;</span>
<a href="#l20.19"></a><span id="l20.19"> </span>
<a href="#l20.20"></a><span id="l20.20"> function OnLoadDialog() {</span>
<a href="#l20.21"></a><span id="l20.21">   gMsgCompAttachSourceElement = document.getElementById(&quot;AttachSourceToMail&quot;);</span>
<a href="#l20.22"></a><span id="l20.22">   var editor = GetCurrentEditor();</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineminus">-  if (gMsgCompAttachSourceElement &amp;&amp; editor &amp;&amp;</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineminus">-      (editor.flags &amp; Ci.nsIPlaintextEditor.eEditorMailMask)) {</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineminus">-    SetRelativeCheckbox = function() { SetAttachCheckbox(); };</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineplus">+  if (</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineplus">+    gMsgCompAttachSourceElement &amp;&amp;</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineplus">+    editor &amp;&amp;</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineplus">+    editor.flags &amp; Ci.nsIPlaintextEditor.eEditorMailMask</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineplus">+  ) {</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+    SetRelativeCheckbox = function() {</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+      SetAttachCheckbox();</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+    };</span>
<a href="#l20.34"></a><span id="l20.34">     // initialize the AttachSourceToMail checkbox</span>
<a href="#l20.35"></a><span id="l20.35">     gMsgCompAttachSourceElement.hidden = false;</span>
<a href="#l20.36"></a><span id="l20.36"> </span>
<a href="#l20.37"></a><span id="l20.37">     switch (document.documentElement.id) {</span>
<a href="#l20.38"></a><span id="l20.38">       case &quot;imageDlg&quot;:</span>
<a href="#l20.39"></a><span id="l20.39">         gMsgCompInputElement = gDialog.srcInput;</span>
<a href="#l20.40"></a><span id="l20.40">         gMsgCompProcessLink = false;</span>
<a href="#l20.41"></a><span id="l20.41">         break;</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineminus">-      case &quot;linkDlg&quot; :</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineminus">-        gMsgCompInputElement =  gDialog.hrefInput;</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineplus">+      case &quot;linkDlg&quot;:</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineplus">+        gMsgCompInputElement = gDialog.hrefInput;</span>
<a href="#l20.46"></a><span id="l20.46">         gMsgCompProcessLink = true;</span>
<a href="#l20.47"></a><span id="l20.47">         break;</span>
<a href="#l20.48"></a><span id="l20.48">     }</span>
<a href="#l20.49"></a><span id="l20.49">     if (gMsgCompInputElement) {</span>
<a href="#l20.50"></a><span id="l20.50">       SetAttachCheckbox();</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineminus">-      gMsgCompPrevMozDoNotSendAttribute = globalElement.getAttribute(&quot;moz-do-not-send&quot;);</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineplus">+      gMsgCompPrevMozDoNotSendAttribute = globalElement.getAttribute(</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineplus">+        &quot;moz-do-not-send&quot;</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineplus">+      );</span>
<a href="#l20.55"></a><span id="l20.55">     }</span>
<a href="#l20.56"></a><span id="l20.56">   }</span>
<a href="#l20.57"></a><span id="l20.57"> }</span>
<a href="#l20.58"></a><span id="l20.58"> addEventListener(&quot;load&quot;, OnLoadDialog, false);</span>
<a href="#l20.59"></a><span id="l20.59"> </span>
<a href="#l20.60"></a><span id="l20.60"> function OnAcceptDialog() {</span>
<a href="#l20.61"></a><span id="l20.61">   // Auto-convert file URLs to data URLs. If we're in the link properties</span>
<a href="#l20.62"></a><span id="l20.62">   // dialog convert only when requested - for the image dialog do it always.</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineminus">-  if (/^file:/i.test(gMsgCompInputElement.value.trim()) &amp;&amp;</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineminus">-      (gMsgCompAttachSourceElement.checked || !gMsgCompProcessLink)) {</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineplus">+  if (</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineplus">+    /^file:/i.test(gMsgCompInputElement.value.trim()) &amp;&amp;</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineplus">+    (gMsgCompAttachSourceElement.checked || !gMsgCompProcessLink)</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineplus">+  ) {</span>
<a href="#l20.69"></a><span id="l20.69">     var dataURI = GenerateDataURL(gMsgCompInputElement.value.trim());</span>
<a href="#l20.70"></a><span id="l20.70">     gMsgCompInputElement.value = dataURI;</span>
<a href="#l20.71"></a><span id="l20.71">     gMsgCompAttachSourceElement.checked = true;</span>
<a href="#l20.72"></a><span id="l20.72">   }</span>
<a href="#l20.73"></a><span id="l20.73">   DoAttachSourceCheckbox();</span>
<a href="#l20.74"></a><span id="l20.74"> }</span>
<a href="#l20.75"></a><span id="l20.75"> document.addEventListener(&quot;dialogaccept&quot;, OnAcceptDialog, true);</span>
<a href="#l20.76"></a><span id="l20.76"> </span>
<a href="#l20.77"></a><span id="l20.77" class="difflineat">@@ -59,65 +68,79 @@ function SetAttachCheckbox() {</span>
<a href="#l20.78"></a><span id="l20.78"> </span>
<a href="#l20.79"></a><span id="l20.79">   // In case somebody played with the advanced property and changed the moz-do-not-send attribute</span>
<a href="#l20.80"></a><span id="l20.80">   if (mozDoNotSend != gMsgCompPrevMozDoNotSendAttribute) {</span>
<a href="#l20.81"></a><span id="l20.81">     gMsgCompPrevMozDoNotSendAttribute = mozDoNotSend;</span>
<a href="#l20.82"></a><span id="l20.82">     resetCheckbox = true;</span>
<a href="#l20.83"></a><span id="l20.83">   }</span>
<a href="#l20.84"></a><span id="l20.84"> </span>
<a href="#l20.85"></a><span id="l20.85">   // Has the URL changed</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineminus">-  if (gMsgCompInputElement &amp;&amp; gMsgCompInputElement.value != gMsgCompPrevInputValue) {</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineplus">+  if (</span>
<a href="#l20.88"></a><span id="l20.88" class="difflineplus">+    gMsgCompInputElement &amp;&amp;</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineplus">+    gMsgCompInputElement.value != gMsgCompPrevInputValue</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineplus">+  ) {</span>
<a href="#l20.91"></a><span id="l20.91">     gMsgCompPrevInputValue = gMsgCompInputElement.value;</span>
<a href="#l20.92"></a><span id="l20.92">     resetCheckbox = true;</span>
<a href="#l20.93"></a><span id="l20.93">   }</span>
<a href="#l20.94"></a><span id="l20.94"> </span>
<a href="#l20.95"></a><span id="l20.95">   if (gMsgCompInputElement &amp;&amp; resetCheckbox) {</span>
<a href="#l20.96"></a><span id="l20.96">     // Here is the rule about how to set the checkbox Attach Source To Message:</span>
<a href="#l20.97"></a><span id="l20.97">     // If the attribute &quot;moz-do-not-send&quot; has not been set, we look at the scheme of the URL</span>
<a href="#l20.98"></a><span id="l20.98">     // and at some preference to decide what is the best for the user.</span>
<a href="#l20.99"></a><span id="l20.99">     // If it is set to &quot;false&quot;, the checkbox is checked, otherwise unchecked.</span>
<a href="#l20.100"></a><span id="l20.100">     var attach = false;</span>
<a href="#l20.101"></a><span id="l20.101">     if (mozDoNotSend == null) {</span>
<a href="#l20.102"></a><span id="l20.102">       // We haven't yet set the &quot;moz-do-not-send&quot; attribute.</span>
<a href="#l20.103"></a><span id="l20.103">       var inputValue = gMsgCompInputElement.value.trim();</span>
<a href="#l20.104"></a><span id="l20.104">       if (/^(file|data):/i.test(inputValue)) {</span>
<a href="#l20.105"></a><span id="l20.105">         // For files or data URLs, default to attach them.</span>
<a href="#l20.106"></a><span id="l20.106">         attach = true;</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineminus">-      } else if (!gMsgCompProcessLink &amp;&amp; // Implies image dialogue.</span>
<a href="#l20.108"></a><span id="l20.108" class="difflineminus">-                 /^https?:/i.test(inputValue)) {</span>
<a href="#l20.109"></a><span id="l20.109" class="difflineplus">+      } else if (</span>
<a href="#l20.110"></a><span id="l20.110" class="difflineplus">+        !gMsgCompProcessLink &amp;&amp; // Implies image dialogue.</span>
<a href="#l20.111"></a><span id="l20.111" class="difflineplus">+        /^https?:/i.test(inputValue)</span>
<a href="#l20.112"></a><span id="l20.112" class="difflineplus">+      ) {</span>
<a href="#l20.113"></a><span id="l20.113">         // For images loaded via http(s) we default to the preference value.</span>
<a href="#l20.114"></a><span id="l20.114">         attach = Services.prefs.getBoolPref(&quot;mail.compose.attach_http_images&quot;);</span>
<a href="#l20.115"></a><span id="l20.115">       }</span>
<a href="#l20.116"></a><span id="l20.116">     } else {</span>
<a href="#l20.117"></a><span id="l20.117" class="difflineminus">-      attach = (mozDoNotSend == &quot;false&quot;);</span>
<a href="#l20.118"></a><span id="l20.118" class="difflineplus">+      attach = mozDoNotSend == &quot;false&quot;;</span>
<a href="#l20.119"></a><span id="l20.119">     }</span>
<a href="#l20.120"></a><span id="l20.120"> </span>
<a href="#l20.121"></a><span id="l20.121">     gMsgCompAttachSourceElement.checked = attach;</span>
<a href="#l20.122"></a><span id="l20.122">   }</span>
<a href="#l20.123"></a><span id="l20.123"> }</span>
<a href="#l20.124"></a><span id="l20.124"> </span>
<a href="#l20.125"></a><span id="l20.125"> function DoAttachSourceCheckbox() {</span>
<a href="#l20.126"></a><span id="l20.126">   gMsgCompPrevMozDoNotSendAttribute = (!gMsgCompAttachSourceElement.checked).toString();</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineminus">-  globalElement.setAttribute(&quot;moz-do-not-send&quot;, gMsgCompPrevMozDoNotSendAttribute);</span>
<a href="#l20.128"></a><span id="l20.128" class="difflineplus">+  globalElement.setAttribute(</span>
<a href="#l20.129"></a><span id="l20.129" class="difflineplus">+    &quot;moz-do-not-send&quot;,</span>
<a href="#l20.130"></a><span id="l20.130" class="difflineplus">+    gMsgCompPrevMozDoNotSendAttribute</span>
<a href="#l20.131"></a><span id="l20.131" class="difflineplus">+  );</span>
<a href="#l20.132"></a><span id="l20.132"> }</span>
<a href="#l20.133"></a><span id="l20.133"> </span>
<a href="#l20.134"></a><span id="l20.134"> function GenerateDataURL(url) {</span>
<a href="#l20.135"></a><span id="l20.135" class="difflineminus">-  var file = Services.io.newURI(url)</span>
<a href="#l20.136"></a><span id="l20.136" class="difflineminus">-    .QueryInterface(Ci.nsIFileURL).file;</span>
<a href="#l20.137"></a><span id="l20.137" class="difflineplus">+  var file = Services.io.newURI(url).QueryInterface(Ci.nsIFileURL).file;</span>
<a href="#l20.138"></a><span id="l20.138">   var contentType = Cc[&quot;@mozilla.org/mime;1&quot;]</span>
<a href="#l20.139"></a><span id="l20.139">     .getService(Ci.nsIMIMEService)</span>
<a href="#l20.140"></a><span id="l20.140">     .getTypeFromFile(file);</span>
<a href="#l20.141"></a><span id="l20.141" class="difflineminus">-  var inputStream = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l20.142"></a><span id="l20.142" class="difflineminus">-    .createInstance(Ci.nsIFileInputStream);</span>
<a href="#l20.143"></a><span id="l20.143" class="difflineplus">+  var inputStream = Cc[</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineplus">+    &quot;@mozilla.org/network/file-input-stream;1&quot;</span>
<a href="#l20.145"></a><span id="l20.145" class="difflineplus">+  ].createInstance(Ci.nsIFileInputStream);</span>
<a href="#l20.146"></a><span id="l20.146">   inputStream.init(file, 0x01, 0o600, 0);</span>
<a href="#l20.147"></a><span id="l20.147" class="difflineminus">-  var stream = Cc[&quot;@mozilla.org/binaryinputstream;1&quot;]</span>
<a href="#l20.148"></a><span id="l20.148" class="difflineminus">-    .createInstance(Ci.nsIBinaryInputStream);</span>
<a href="#l20.149"></a><span id="l20.149" class="difflineplus">+  var stream = Cc[&quot;@mozilla.org/binaryinputstream;1&quot;].createInstance(</span>
<a href="#l20.150"></a><span id="l20.150" class="difflineplus">+    Ci.nsIBinaryInputStream</span>
<a href="#l20.151"></a><span id="l20.151" class="difflineplus">+  );</span>
<a href="#l20.152"></a><span id="l20.152">   stream.setInputStream(inputStream);</span>
<a href="#l20.153"></a><span id="l20.153">   let data = &quot;&quot;;</span>
<a href="#l20.154"></a><span id="l20.154">   while (stream.available() &gt; 0) {</span>
<a href="#l20.155"></a><span id="l20.155">     data += stream.readBytes(stream.available());</span>
<a href="#l20.156"></a><span id="l20.156">   }</span>
<a href="#l20.157"></a><span id="l20.157">   let encoded = btoa(data);</span>
<a href="#l20.158"></a><span id="l20.158">   stream.close();</span>
<a href="#l20.159"></a><span id="l20.159" class="difflineminus">-  return &quot;data:&quot; + contentType +</span>
<a href="#l20.160"></a><span id="l20.160" class="difflineminus">-    &quot;;filename=&quot; + encodeURIComponent(file.leafName) +</span>
<a href="#l20.161"></a><span id="l20.161" class="difflineminus">-    &quot;;base64,&quot; + encoded;</span>
<a href="#l20.162"></a><span id="l20.162" class="difflineplus">+  return (</span>
<a href="#l20.163"></a><span id="l20.163" class="difflineplus">+    &quot;data:&quot; +</span>
<a href="#l20.164"></a><span id="l20.164" class="difflineplus">+    contentType +</span>
<a href="#l20.165"></a><span id="l20.165" class="difflineplus">+    &quot;;filename=&quot; +</span>
<a href="#l20.166"></a><span id="l20.166" class="difflineplus">+    encodeURIComponent(file.leafName) +</span>
<a href="#l20.167"></a><span id="l20.167" class="difflineplus">+    &quot;;base64,&quot; +</span>
<a href="#l20.168"></a><span id="l20.168" class="difflineplus">+    encoded</span>
<a href="#l20.169"></a><span id="l20.169" class="difflineplus">+  );</span>
<a href="#l20.170"></a><span id="l20.170"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdImageProps.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdImageProps.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -19,48 +19,52 @@ document.addEventListener(&quot;dialogcancel&quot;</span>
<a href="#l21.4"></a><span id="l21.4"> function Startup() {</span>
<a href="#l21.5"></a><span id="l21.5">   var editor = GetCurrentEditor();</span>
<a href="#l21.6"></a><span id="l21.6">   if (!editor) {</span>
<a href="#l21.7"></a><span id="l21.7">     window.close();</span>
<a href="#l21.8"></a><span id="l21.8">     return;</span>
<a href="#l21.9"></a><span id="l21.9">   }</span>
<a href="#l21.10"></a><span id="l21.10"> </span>
<a href="#l21.11"></a><span id="l21.11">   ImageStartup();</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-  gDialog.hrefInput        = document.getElementById(&quot;hrefInput&quot;);</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+  gDialog.hrefInput = document.getElementById(&quot;hrefInput&quot;);</span>
<a href="#l21.14"></a><span id="l21.14">   gDialog.makeRelativeLink = document.getElementById(&quot;MakeRelativeLink&quot;);</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-  gDialog.showLinkBorder   = document.getElementById(&quot;showLinkBorder&quot;);</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-  gDialog.linkTab          = document.getElementById(&quot;imageLinkTab&quot;);</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineminus">-  gDialog.linkAdvanced     = document.getElementById(&quot;LinkAdvancedEditButton&quot;);</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+  gDialog.showLinkBorder = document.getElementById(&quot;showLinkBorder&quot;);</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineplus">+  gDialog.linkTab = document.getElementById(&quot;imageLinkTab&quot;);</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineplus">+  gDialog.linkAdvanced = document.getElementById(&quot;LinkAdvancedEditButton&quot;);</span>
<a href="#l21.21"></a><span id="l21.21"> </span>
<a href="#l21.22"></a><span id="l21.22">   // Get a single selected image element</span>
<a href="#l21.23"></a><span id="l21.23">   var tagName = &quot;img&quot;;</span>
<a href="#l21.24"></a><span id="l21.24">   if (&quot;arguments&quot; in window &amp;&amp; window.arguments[0]) {</span>
<a href="#l21.25"></a><span id="l21.25">     imageElement = window.arguments[0];</span>
<a href="#l21.26"></a><span id="l21.26">     // We've been called from form field properties, so we can't insert a link</span>
<a href="#l21.27"></a><span id="l21.27">     gDialog.linkTab.remove();</span>
<a href="#l21.28"></a><span id="l21.28">     gDialog.linkTab = null;</span>
<a href="#l21.29"></a><span id="l21.29">   } else {</span>
<a href="#l21.30"></a><span id="l21.30">     // First check for &lt;input type=&quot;image&quot;&gt;</span>
<a href="#l21.31"></a><span id="l21.31">     try {</span>
<a href="#l21.32"></a><span id="l21.32">       imageElement = editor.getSelectedElement(&quot;input&quot;);</span>
<a href="#l21.33"></a><span id="l21.33"> </span>
<a href="#l21.34"></a><span id="l21.34">       if (!imageElement || imageElement.getAttribute(&quot;type&quot;) != &quot;image&quot;) {</span>
<a href="#l21.35"></a><span id="l21.35">         // Get a single selected image element</span>
<a href="#l21.36"></a><span id="l21.36">         imageElement = editor.getSelectedElement(tagName);</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineminus">-        if (imageElement)</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineminus">-          gAnchorElement = editor.getElementOrParentByTagName(&quot;href&quot;, imageElement);</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineplus">+        if (imageElement) {</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineplus">+          gAnchorElement = editor.getElementOrParentByTagName(</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineplus">+            &quot;href&quot;,</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineplus">+            imageElement</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineplus">+          );</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineplus">+        }</span>
<a href="#l21.45"></a><span id="l21.45">       }</span>
<a href="#l21.46"></a><span id="l21.46">     } catch (e) {}</span>
<a href="#l21.47"></a><span id="l21.47">   }</span>
<a href="#l21.48"></a><span id="l21.48"> </span>
<a href="#l21.49"></a><span id="l21.49">   if (imageElement) {</span>
<a href="#l21.50"></a><span id="l21.50">     // We found an element and don't need to insert one</span>
<a href="#l21.51"></a><span id="l21.51">     if (imageElement.hasAttribute(&quot;src&quot;)) {</span>
<a href="#l21.52"></a><span id="l21.52">       gInsertNewImage = false;</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineminus">-      gActualWidth  = imageElement.naturalWidth;</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineplus">+      gActualWidth = imageElement.naturalWidth;</span>
<a href="#l21.55"></a><span id="l21.55">       gActualHeight = imageElement.naturalHeight;</span>
<a href="#l21.56"></a><span id="l21.56">     }</span>
<a href="#l21.57"></a><span id="l21.57">   } else {</span>
<a href="#l21.58"></a><span id="l21.58">     gInsertNewImage = true;</span>
<a href="#l21.59"></a><span id="l21.59"> </span>
<a href="#l21.60"></a><span id="l21.60">     // We don't have an element selected,</span>
<a href="#l21.61"></a><span id="l21.61">     //  so create one with default attributes</span>
<a href="#l21.62"></a><span id="l21.62">     try {</span>
<a href="#l21.63"></a><span id="l21.63" class="difflineat">@@ -130,18 +134,19 @@ function ChangeLinkLocation() {</span>
<a href="#l21.64"></a><span id="l21.64">   gDialog.showLinkBorder.disabled = !href;</span>
<a href="#l21.65"></a><span id="l21.65">   gDialog.linkAdvanced.disabled = !href;</span>
<a href="#l21.66"></a><span id="l21.66">   gLinkElement.setAttribute(&quot;href&quot;, href);</span>
<a href="#l21.67"></a><span id="l21.67"> }</span>
<a href="#l21.68"></a><span id="l21.68"> </span>
<a href="#l21.69"></a><span id="l21.69"> function ToggleShowLinkBorder() {</span>
<a href="#l21.70"></a><span id="l21.70">   if (gDialog.showLinkBorder.checked) {</span>
<a href="#l21.71"></a><span id="l21.71">     var border = TrimString(gDialog.border.value);</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineminus">-    if (!border || border == &quot;0&quot;)</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineplus">+    if (!border || border == &quot;0&quot;) {</span>
<a href="#l21.74"></a><span id="l21.74">       gDialog.border.value = &quot;2&quot;;</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineplus">+    }</span>
<a href="#l21.76"></a><span id="l21.76">   } else {</span>
<a href="#l21.77"></a><span id="l21.77">     gDialog.border.value = &quot;0&quot;;</span>
<a href="#l21.78"></a><span id="l21.78">   }</span>
<a href="#l21.79"></a><span id="l21.79"> }</span>
<a href="#l21.80"></a><span id="l21.80"> </span>
<a href="#l21.81"></a><span id="l21.81"> // Get data from widgets, validate, and set for the global element</span>
<a href="#l21.82"></a><span id="l21.82"> //   accessible to AdvancedEdit() [in EdDialogCommon.js]</span>
<a href="#l21.83"></a><span id="l21.83"> function ValidateData() {</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineat">@@ -180,41 +185,47 @@ function onAccept(event) {</span>
<a href="#l21.85"></a><span id="l21.85">         testArea.setAttribute(&quot;coords&quot;, &quot;86,102,52&quot;);</span>
<a href="#l21.86"></a><span id="l21.86">         testArea.setAttribute(&quot;href&quot;, &quot;test&quot;);</span>
<a href="#l21.87"></a><span id="l21.87">         gImageMap.appendChild(testArea);</span>
<a href="#l21.88"></a><span id="l21.88">         */</span>
<a href="#l21.89"></a><span id="l21.89"> </span>
<a href="#l21.90"></a><span id="l21.90">         // Assign to map if there is one</span>
<a href="#l21.91"></a><span id="l21.91">         var mapName = gImageMap.getAttribute(&quot;name&quot;);</span>
<a href="#l21.92"></a><span id="l21.92">         if (mapName != &quot;&quot;) {</span>
<a href="#l21.93"></a><span id="l21.93" class="difflineminus">-          globalElement.setAttribute(&quot;usemap&quot;, (&quot;#&quot; + mapName));</span>
<a href="#l21.94"></a><span id="l21.94" class="difflineminus">-          if (globalElement.getAttribute(&quot;border&quot;) == &quot;&quot;)</span>
<a href="#l21.95"></a><span id="l21.95" class="difflineplus">+          globalElement.setAttribute(&quot;usemap&quot;, &quot;#&quot; + mapName);</span>
<a href="#l21.96"></a><span id="l21.96" class="difflineplus">+          if (globalElement.getAttribute(&quot;border&quot;) == &quot;&quot;) {</span>
<a href="#l21.97"></a><span id="l21.97">             globalElement.setAttribute(&quot;border&quot;, 0);</span>
<a href="#l21.98"></a><span id="l21.98" class="difflineplus">+          }</span>
<a href="#l21.99"></a><span id="l21.99">         }</span>
<a href="#l21.100"></a><span id="l21.100">       }</span>
<a href="#l21.101"></a><span id="l21.101"> </span>
<a href="#l21.102"></a><span id="l21.102">       // Create or remove the link as appropriate</span>
<a href="#l21.103"></a><span id="l21.103">       var href = gDialog.hrefInput.value;</span>
<a href="#l21.104"></a><span id="l21.104">       if (href != gOriginalHref) {</span>
<a href="#l21.105"></a><span id="l21.105">         if (href &amp;&amp; !gInsertNewImage) {</span>
<a href="#l21.106"></a><span id="l21.106">           EditorSetTextProperty(&quot;a&quot;, &quot;href&quot;, href);</span>
<a href="#l21.107"></a><span id="l21.107">           // gAnchorElement is needed for cloning attributes later.</span>
<a href="#l21.108"></a><span id="l21.108" class="difflineminus">-          if (!gAnchorElement)</span>
<a href="#l21.109"></a><span id="l21.109" class="difflineminus">-            gAnchorElement = editor.getElementOrParentByTagName(&quot;href&quot;, imageElement);</span>
<a href="#l21.110"></a><span id="l21.110" class="difflineplus">+          if (!gAnchorElement) {</span>
<a href="#l21.111"></a><span id="l21.111" class="difflineplus">+            gAnchorElement = editor.getElementOrParentByTagName(</span>
<a href="#l21.112"></a><span id="l21.112" class="difflineplus">+              &quot;href&quot;,</span>
<a href="#l21.113"></a><span id="l21.113" class="difflineplus">+              imageElement</span>
<a href="#l21.114"></a><span id="l21.114" class="difflineplus">+            );</span>
<a href="#l21.115"></a><span id="l21.115" class="difflineplus">+          }</span>
<a href="#l21.116"></a><span id="l21.116">         } else {</span>
<a href="#l21.117"></a><span id="l21.117">           EditorRemoveTextProperty(&quot;href&quot;, &quot;&quot;);</span>
<a href="#l21.118"></a><span id="l21.118">         }</span>
<a href="#l21.119"></a><span id="l21.119">       }</span>
<a href="#l21.120"></a><span id="l21.120"> </span>
<a href="#l21.121"></a><span id="l21.121">       // If inside a link, always write the 'border' attribute</span>
<a href="#l21.122"></a><span id="l21.122">       if (href) {</span>
<a href="#l21.123"></a><span id="l21.123">         if (gDialog.showLinkBorder.checked) {</span>
<a href="#l21.124"></a><span id="l21.124">           // Use default = 2 if border attribute is empty</span>
<a href="#l21.125"></a><span id="l21.125" class="difflineminus">-          if (!globalElement.hasAttribute(&quot;border&quot;))</span>
<a href="#l21.126"></a><span id="l21.126" class="difflineplus">+          if (!globalElement.hasAttribute(&quot;border&quot;)) {</span>
<a href="#l21.127"></a><span id="l21.127">             globalElement.setAttribute(&quot;border&quot;, &quot;2&quot;);</span>
<a href="#l21.128"></a><span id="l21.128" class="difflineplus">+          }</span>
<a href="#l21.129"></a><span id="l21.129">         } else {</span>
<a href="#l21.130"></a><span id="l21.130">           globalElement.setAttribute(&quot;border&quot;, &quot;0&quot;);</span>
<a href="#l21.131"></a><span id="l21.131">         }</span>
<a href="#l21.132"></a><span id="l21.132">       }</span>
<a href="#l21.133"></a><span id="l21.133"> </span>
<a href="#l21.134"></a><span id="l21.134">       if (gInsertNewImage) {</span>
<a href="#l21.135"></a><span id="l21.135">         if (href) {</span>
<a href="#l21.136"></a><span id="l21.136">           gLinkElement.appendChild(imageElement);</span>
<a href="#l21.137"></a><span id="l21.137" class="difflineat">@@ -233,18 +244,19 @@ function onAccept(event) {</span>
<a href="#l21.138"></a><span id="l21.138">           anchorNode.name = href.substr(1);</span>
<a href="#l21.139"></a><span id="l21.139">           // Remember to use editor method so it is undoable!</span>
<a href="#l21.140"></a><span id="l21.140">           editor.insertNode(anchorNode, gHNodeArray[href], 0, false);</span>
<a href="#l21.141"></a><span id="l21.141">         }</span>
<a href="#l21.142"></a><span id="l21.142">       }</span>
<a href="#l21.143"></a><span id="l21.143">       // All values are valid - copy to actual element in doc or</span>
<a href="#l21.144"></a><span id="l21.144">       //   element we just inserted</span>
<a href="#l21.145"></a><span id="l21.145">       editor.cloneAttributes(imageElement, globalElement);</span>
<a href="#l21.146"></a><span id="l21.146" class="difflineminus">-      if (gAnchorElement)</span>
<a href="#l21.147"></a><span id="l21.147" class="difflineplus">+      if (gAnchorElement) {</span>
<a href="#l21.148"></a><span id="l21.148">         editor.cloneAttributes(gAnchorElement, gLinkElement);</span>
<a href="#l21.149"></a><span id="l21.149" class="difflineplus">+      }</span>
<a href="#l21.150"></a><span id="l21.150"> </span>
<a href="#l21.151"></a><span id="l21.151">       // If document is empty, the map element won't insert,</span>
<a href="#l21.152"></a><span id="l21.152">       //  so always insert the image first</span>
<a href="#l21.153"></a><span id="l21.153">       if (gImageMap &amp;&amp; gInsertNewIMap) {</span>
<a href="#l21.154"></a><span id="l21.154">         // Insert the ImageMap element at beginning of document</span>
<a href="#l21.155"></a><span id="l21.155">         var body = editor.rootElement;</span>
<a href="#l21.156"></a><span id="l21.156">         editor.setShouldTxnSetSelection(false);</span>
<a href="#l21.157"></a><span id="l21.157">         editor.insertNode(gImageMap, body, 0);</span>
<a href="#l21.158"></a><span id="l21.158" class="difflineat">@@ -262,15 +274,20 @@ function onAccept(event) {</span>
<a href="#l21.159"></a><span id="l21.159"> </span>
<a href="#l21.160"></a><span id="l21.160">   gDoAltTextError = false;</span>
<a href="#l21.161"></a><span id="l21.161"> </span>
<a href="#l21.162"></a><span id="l21.162">   event.preventDefault();</span>
<a href="#l21.163"></a><span id="l21.163"> }</span>
<a href="#l21.164"></a><span id="l21.164"> </span>
<a href="#l21.165"></a><span id="l21.165"> function onLinkAdvancedEdit() {</span>
<a href="#l21.166"></a><span id="l21.166">   window.AdvancedEditOK = false;</span>
<a href="#l21.167"></a><span id="l21.167" class="difflineminus">-  window.openDialog(&quot;chrome://editor/content/EdAdvancedEdit.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l21.168"></a><span id="l21.168" class="difflineminus">-                    &quot;chrome,close,titlebar,modal,resizable=yes&quot;, &quot;&quot;,</span>
<a href="#l21.169"></a><span id="l21.169" class="difflineminus">-                    gLinkElement);</span>
<a href="#l21.170"></a><span id="l21.170" class="difflineplus">+  window.openDialog(</span>
<a href="#l21.171"></a><span id="l21.171" class="difflineplus">+    &quot;chrome://editor/content/EdAdvancedEdit.xul&quot;,</span>
<a href="#l21.172"></a><span id="l21.172" class="difflineplus">+    &quot;_blank&quot;,</span>
<a href="#l21.173"></a><span id="l21.173" class="difflineplus">+    &quot;chrome,close,titlebar,modal,resizable=yes&quot;,</span>
<a href="#l21.174"></a><span id="l21.174" class="difflineplus">+    &quot;&quot;,</span>
<a href="#l21.175"></a><span id="l21.175" class="difflineplus">+    gLinkElement</span>
<a href="#l21.176"></a><span id="l21.176" class="difflineplus">+  );</span>
<a href="#l21.177"></a><span id="l21.177">   window.focus();</span>
<a href="#l21.178"></a><span id="l21.178" class="difflineminus">-  if (window.AdvancedEditOK)</span>
<a href="#l21.179"></a><span id="l21.179" class="difflineplus">+  if (window.AdvancedEditOK) {</span>
<a href="#l21.180"></a><span id="l21.180">     gDialog.hrefInput.value = gLinkElement.getAttribute(&quot;href&quot;);</span>
<a href="#l21.181"></a><span id="l21.181" class="difflineplus">+  }</span>
<a href="#l21.182"></a><span id="l21.182"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdInputImage.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdInputImage.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -14,19 +14,19 @@ document.addEventListener(&quot;dialogcancel&quot;</span>
<a href="#l22.4"></a><span id="l22.4"> function Startup() {</span>
<a href="#l22.5"></a><span id="l22.5">   var editor = GetCurrentEditor();</span>
<a href="#l22.6"></a><span id="l22.6">   if (!editor) {</span>
<a href="#l22.7"></a><span id="l22.7">     window.close();</span>
<a href="#l22.8"></a><span id="l22.8">     return;</span>
<a href="#l22.9"></a><span id="l22.9">   }</span>
<a href="#l22.10"></a><span id="l22.10"> </span>
<a href="#l22.11"></a><span id="l22.11">   gDialog = {</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-    inputName:      document.getElementById(&quot;InputName&quot;),</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-    inputDisabled:  document.getElementById(&quot;InputDisabled&quot;),</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">-    inputTabIndex:  document.getElementById(&quot;InputTabIndex&quot;),</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+    inputName: document.getElementById(&quot;InputName&quot;),</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+    inputDisabled: document.getElementById(&quot;InputDisabled&quot;),</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineplus">+    inputTabIndex: document.getElementById(&quot;InputTabIndex&quot;),</span>
<a href="#l22.18"></a><span id="l22.18">   };</span>
<a href="#l22.19"></a><span id="l22.19"> </span>
<a href="#l22.20"></a><span id="l22.20">   ImageStartup();</span>
<a href="#l22.21"></a><span id="l22.21"> </span>
<a href="#l22.22"></a><span id="l22.22">   // Get a single selected input element</span>
<a href="#l22.23"></a><span id="l22.23">   var tagName = &quot;input&quot;;</span>
<a href="#l22.24"></a><span id="l22.24">   try {</span>
<a href="#l22.25"></a><span id="l22.25">     imageElement = editor.getSelectedElement(tagName);</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineat">@@ -51,19 +51,34 @@ function Startup() {</span>
<a href="#l22.27"></a><span id="l22.27">     }</span>
<a href="#l22.28"></a><span id="l22.28">     var imgElement;</span>
<a href="#l22.29"></a><span id="l22.29">     try {</span>
<a href="#l22.30"></a><span id="l22.30">       imgElement = editor.getSelectedElement(&quot;img&quot;);</span>
<a href="#l22.31"></a><span id="l22.31">     } catch (e) {}</span>
<a href="#l22.32"></a><span id="l22.32"> </span>
<a href="#l22.33"></a><span id="l22.33">     if (imgElement) {</span>
<a href="#l22.34"></a><span id="l22.34">       // We found an image element, convert it to an input type=&quot;image&quot;</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineminus">-      var attributes = [&quot;src&quot;, &quot;alt&quot;, &quot;width&quot;, &quot;height&quot;, &quot;hspace&quot;, &quot;vspace&quot;, &quot;border&quot;, &quot;align&quot;, &quot;usemap&quot;, &quot;ismap&quot;];</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineminus">-      for (let i in attributes)</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineminus">-        imageElement.setAttribute(attributes[i], imgElement.getAttribute(attributes[i]));</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineplus">+      var attributes = [</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineplus">+        &quot;src&quot;,</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineplus">+        &quot;alt&quot;,</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineplus">+        &quot;width&quot;,</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineplus">+        &quot;height&quot;,</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineplus">+        &quot;hspace&quot;,</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineplus">+        &quot;vspace&quot;,</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineplus">+        &quot;border&quot;,</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineplus">+        &quot;align&quot;,</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineplus">+        &quot;usemap&quot;,</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineplus">+        &quot;ismap&quot;,</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineplus">+      ];</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineplus">+      for (let i in attributes) {</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineplus">+        imageElement.setAttribute(</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineplus">+          attributes[i],</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineplus">+          imgElement.getAttribute(attributes[i])</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineplus">+        );</span>
<a href="#l22.55"></a><span id="l22.55" class="difflineplus">+      }</span>
<a href="#l22.56"></a><span id="l22.56">     }</span>
<a href="#l22.57"></a><span id="l22.57">   }</span>
<a href="#l22.58"></a><span id="l22.58"> </span>
<a href="#l22.59"></a><span id="l22.59">   // Make a copy to use for AdvancedEdit</span>
<a href="#l22.60"></a><span id="l22.60">   globalElement = imageElement.cloneNode(false);</span>
<a href="#l22.61"></a><span id="l22.61"> </span>
<a href="#l22.62"></a><span id="l22.62">   // We only need to test for this once per dialog load</span>
<a href="#l22.63"></a><span id="l22.63">   gHaveDocumentUrl = GetDocumentBaseUrl();</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineat">@@ -81,35 +96,42 @@ function Startup() {</span>
<a href="#l22.65"></a><span id="l22.65">   SetTextboxFocus(gDialog.inputName);</span>
<a href="#l22.66"></a><span id="l22.66"> </span>
<a href="#l22.67"></a><span id="l22.67">   SetWindowLocation();</span>
<a href="#l22.68"></a><span id="l22.68"> }</span>
<a href="#l22.69"></a><span id="l22.69"> </span>
<a href="#l22.70"></a><span id="l22.70"> function InitDialog() {</span>
<a href="#l22.71"></a><span id="l22.71">   InitImage();</span>
<a href="#l22.72"></a><span id="l22.72">   gDialog.inputName.value = globalElement.getAttribute(&quot;name&quot;);</span>
<a href="#l22.73"></a><span id="l22.73" class="difflineminus">-  gDialog.inputDisabled.setAttribute(&quot;checked&quot;, globalElement.hasAttribute(&quot;disabled&quot;));</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineplus">+  gDialog.inputDisabled.setAttribute(</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineplus">+    &quot;checked&quot;,</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineplus">+    globalElement.hasAttribute(&quot;disabled&quot;)</span>
<a href="#l22.77"></a><span id="l22.77" class="difflineplus">+  );</span>
<a href="#l22.78"></a><span id="l22.78">   gDialog.inputTabIndex.value = globalElement.getAttribute(&quot;tabindex&quot;);</span>
<a href="#l22.79"></a><span id="l22.79"> }</span>
<a href="#l22.80"></a><span id="l22.80"> </span>
<a href="#l22.81"></a><span id="l22.81"> function ValidateData() {</span>
<a href="#l22.82"></a><span id="l22.82" class="difflineminus">-  if (!ValidateImage())</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineplus">+  if (!ValidateImage()) {</span>
<a href="#l22.84"></a><span id="l22.84">     return false;</span>
<a href="#l22.85"></a><span id="l22.85" class="difflineminus">-  if (gDialog.inputName.value)</span>
<a href="#l22.86"></a><span id="l22.86" class="difflineplus">+  }</span>
<a href="#l22.87"></a><span id="l22.87" class="difflineplus">+  if (gDialog.inputName.value) {</span>
<a href="#l22.88"></a><span id="l22.88">     globalElement.setAttribute(&quot;name&quot;, gDialog.inputName.value);</span>
<a href="#l22.89"></a><span id="l22.89" class="difflineminus">-  else</span>
<a href="#l22.90"></a><span id="l22.90" class="difflineplus">+  } else {</span>
<a href="#l22.91"></a><span id="l22.91">     globalElement.removeAttribute(&quot;name&quot;);</span>
<a href="#l22.92"></a><span id="l22.92" class="difflineminus">-  if (gDialog.inputTabIndex.value)</span>
<a href="#l22.93"></a><span id="l22.93" class="difflineplus">+  }</span>
<a href="#l22.94"></a><span id="l22.94" class="difflineplus">+  if (gDialog.inputTabIndex.value) {</span>
<a href="#l22.95"></a><span id="l22.95">     globalElement.setAttribute(&quot;tabindex&quot;, gDialog.inputTabIndex.value);</span>
<a href="#l22.96"></a><span id="l22.96" class="difflineminus">-  else</span>
<a href="#l22.97"></a><span id="l22.97" class="difflineplus">+  } else {</span>
<a href="#l22.98"></a><span id="l22.98">     globalElement.removeAttribute(&quot;tabindex&quot;);</span>
<a href="#l22.99"></a><span id="l22.99" class="difflineminus">-  if (gDialog.inputDisabled.checked)</span>
<a href="#l22.100"></a><span id="l22.100" class="difflineplus">+  }</span>
<a href="#l22.101"></a><span id="l22.101" class="difflineplus">+  if (gDialog.inputDisabled.checked) {</span>
<a href="#l22.102"></a><span id="l22.102">     globalElement.setAttribute(&quot;disabled&quot;, &quot;&quot;);</span>
<a href="#l22.103"></a><span id="l22.103" class="difflineminus">-  else</span>
<a href="#l22.104"></a><span id="l22.104" class="difflineplus">+  } else {</span>
<a href="#l22.105"></a><span id="l22.105">     globalElement.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l22.106"></a><span id="l22.106" class="difflineplus">+  }</span>
<a href="#l22.107"></a><span id="l22.107">   globalElement.setAttribute(&quot;type&quot;, &quot;image&quot;);</span>
<a href="#l22.108"></a><span id="l22.108">   return true;</span>
<a href="#l22.109"></a><span id="l22.109"> }</span>
<a href="#l22.110"></a><span id="l22.110"> </span>
<a href="#l22.111"></a><span id="l22.111"> function onAccept(event) {</span>
<a href="#l22.112"></a><span id="l22.112">   // Show alt text error only once</span>
<a href="#l22.113"></a><span id="l22.113">   // (we don't initialize doAltTextError=true</span>
<a href="#l22.114"></a><span id="l22.114">   //  so Advanced edit button dialog doesn't trigger that error message)</span>
<a href="#l22.115"></a><span id="l22.115" class="difflineat">@@ -127,19 +149,20 @@ function onAccept(event) {</span>
<a href="#l22.116"></a><span id="l22.116">           editor.deleteNode(gImageMap);</span>
<a href="#l22.117"></a><span id="l22.117">           gInsertNewIMap = true;</span>
<a href="#l22.118"></a><span id="l22.118">           gImageMap = null;</span>
<a href="#l22.119"></a><span id="l22.119">         }</span>
<a href="#l22.120"></a><span id="l22.120">       } else if (gImageMap) {</span>
<a href="#l22.121"></a><span id="l22.121">         // Assign to map if there is one</span>
<a href="#l22.122"></a><span id="l22.122">         var mapName = gImageMap.getAttribute(&quot;name&quot;);</span>
<a href="#l22.123"></a><span id="l22.123">         if (mapName != &quot;&quot;) {</span>
<a href="#l22.124"></a><span id="l22.124" class="difflineminus">-          globalElement.setAttribute(&quot;usemap&quot;, (&quot;#&quot; + mapName));</span>
<a href="#l22.125"></a><span id="l22.125" class="difflineminus">-          if (globalElement.getAttribute(&quot;border&quot;) == &quot;&quot;)</span>
<a href="#l22.126"></a><span id="l22.126" class="difflineplus">+          globalElement.setAttribute(&quot;usemap&quot;, &quot;#&quot; + mapName);</span>
<a href="#l22.127"></a><span id="l22.127" class="difflineplus">+          if (globalElement.getAttribute(&quot;border&quot;) == &quot;&quot;) {</span>
<a href="#l22.128"></a><span id="l22.128">             globalElement.setAttribute(&quot;border&quot;, 0);</span>
<a href="#l22.129"></a><span id="l22.129" class="difflineplus">+          }</span>
<a href="#l22.130"></a><span id="l22.130">         }</span>
<a href="#l22.131"></a><span id="l22.131">       }</span>
<a href="#l22.132"></a><span id="l22.132"> </span>
<a href="#l22.133"></a><span id="l22.133">       if (gInsertNewImage) {</span>
<a href="#l22.134"></a><span id="l22.134">         // 'true' means delete the selection before inserting</span>
<a href="#l22.135"></a><span id="l22.135">         // in case were are converting an image to an input type=&quot;image&quot;</span>
<a href="#l22.136"></a><span id="l22.136">         editor.insertElementAtSelection(imageElement, true);</span>
<a href="#l22.137"></a><span id="l22.137">       }</span>
<a href="#l22.138"></a><span id="l22.138" class="difflineat">@@ -159,9 +182,8 @@ function onAccept(event) {</span>
<a href="#l22.139"></a><span id="l22.139">     editor.endTransaction();</span>
<a href="#l22.140"></a><span id="l22.140"> </span>
<a href="#l22.141"></a><span id="l22.141">     SaveWindowLocation();</span>
<a href="#l22.142"></a><span id="l22.142"> </span>
<a href="#l22.143"></a><span id="l22.143">     return;</span>
<a href="#l22.144"></a><span id="l22.144">   }</span>
<a href="#l22.145"></a><span id="l22.145">   event.preventDefault();</span>
<a href="#l22.146"></a><span id="l22.146"> }</span>
<a href="#l22.147"></a><span id="l22.147" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdInputProps.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdInputProps.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -17,36 +17,36 @@ function Startup() {</span>
<a href="#l23.4"></a><span id="l23.4">   var editor = GetCurrentEditor();</span>
<a href="#l23.5"></a><span id="l23.5">   if (!editor) {</span>
<a href="#l23.6"></a><span id="l23.6">     dump(&quot;Failed to get active editor!\n&quot;);</span>
<a href="#l23.7"></a><span id="l23.7">     window.close();</span>
<a href="#l23.8"></a><span id="l23.8">     return;</span>
<a href="#l23.9"></a><span id="l23.9">   }</span>
<a href="#l23.10"></a><span id="l23.10"> </span>
<a href="#l23.11"></a><span id="l23.11">   gDialog = {</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-    accept:             document.documentElement.getButton(&quot;accept&quot;),</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-    inputType:          document.getElementById(&quot;InputType&quot;),</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineminus">-    inputNameDeck:      document.getElementById(&quot;InputNameDeck&quot;),</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineminus">-    inputName:          document.getElementById(&quot;InputName&quot;),</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineminus">-    inputValueDeck:     document.getElementById(&quot;InputValueDeck&quot;),</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineminus">-    inputValue:         document.getElementById(&quot;InputValue&quot;),</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineminus">-    inputDeck:          document.getElementById(&quot;InputDeck&quot;),</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineminus">-    inputChecked:       document.getElementById(&quot;InputChecked&quot;),</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineminus">-    inputSelected:      document.getElementById(&quot;InputSelected&quot;),</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineminus">-    inputReadOnly:      document.getElementById(&quot;InputReadOnly&quot;),</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineminus">-    inputDisabled:      document.getElementById(&quot;InputDisabled&quot;),</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineminus">-    inputTabIndex:      document.getElementById(&quot;InputTabIndex&quot;),</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineminus">-    inputAccessKey:     document.getElementById(&quot;InputAccessKey&quot;),</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineminus">-    inputSize:          document.getElementById(&quot;InputSize&quot;),</span>
<a href="#l23.26"></a><span id="l23.26" class="difflineminus">-    inputMaxLength:     document.getElementById(&quot;InputMaxLength&quot;),</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineminus">-    inputAccept:        document.getElementById(&quot;InputAccept&quot;),</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineminus">-    MoreSection:        document.getElementById(&quot;MoreSection&quot;),</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineminus">-    MoreFewerButton:    document.getElementById(&quot;MoreFewerButton&quot;),</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineplus">+    accept: document.documentElement.getButton(&quot;accept&quot;),</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineplus">+    inputType: document.getElementById(&quot;InputType&quot;),</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineplus">+    inputNameDeck: document.getElementById(&quot;InputNameDeck&quot;),</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineplus">+    inputName: document.getElementById(&quot;InputName&quot;),</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineplus">+    inputValueDeck: document.getElementById(&quot;InputValueDeck&quot;),</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineplus">+    inputValue: document.getElementById(&quot;InputValue&quot;),</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineplus">+    inputDeck: document.getElementById(&quot;InputDeck&quot;),</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineplus">+    inputChecked: document.getElementById(&quot;InputChecked&quot;),</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineplus">+    inputSelected: document.getElementById(&quot;InputSelected&quot;),</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineplus">+    inputReadOnly: document.getElementById(&quot;InputReadOnly&quot;),</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineplus">+    inputDisabled: document.getElementById(&quot;InputDisabled&quot;),</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineplus">+    inputTabIndex: document.getElementById(&quot;InputTabIndex&quot;),</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineplus">+    inputAccessKey: document.getElementById(&quot;InputAccessKey&quot;),</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineplus">+    inputSize: document.getElementById(&quot;InputSize&quot;),</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineplus">+    inputMaxLength: document.getElementById(&quot;InputMaxLength&quot;),</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineplus">+    inputAccept: document.getElementById(&quot;InputAccept&quot;),</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineplus">+    MoreSection: document.getElementById(&quot;MoreSection&quot;),</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineplus">+    MoreFewerButton: document.getElementById(&quot;MoreFewerButton&quot;),</span>
<a href="#l23.48"></a><span id="l23.48">     AdvancedEditButton: document.getElementById(&quot;AdvancedEditButton&quot;),</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineminus">-    AdvancedEditDeck:   document.getElementById(&quot;AdvancedEditDeck&quot;),</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineplus">+    AdvancedEditDeck: document.getElementById(&quot;AdvancedEditDeck&quot;),</span>
<a href="#l23.51"></a><span id="l23.51">   };</span>
<a href="#l23.52"></a><span id="l23.52"> </span>
<a href="#l23.53"></a><span id="l23.53">   // Get a single selected input element</span>
<a href="#l23.54"></a><span id="l23.54">   const kTagName = &quot;input&quot;;</span>
<a href="#l23.55"></a><span id="l23.55">   try {</span>
<a href="#l23.56"></a><span id="l23.56">     inputElement = editor.getSelectedElement(kTagName);</span>
<a href="#l23.57"></a><span id="l23.57">   } catch (e) {}</span>
<a href="#l23.58"></a><span id="l23.58"> </span>
<a href="#l23.59"></a><span id="l23.59" class="difflineat">@@ -68,19 +68,32 @@ function Startup() {</span>
<a href="#l23.60"></a><span id="l23.60">       return;</span>
<a href="#l23.61"></a><span id="l23.61">     }</span>
<a href="#l23.62"></a><span id="l23.62"> </span>
<a href="#l23.63"></a><span id="l23.63">     var imgElement = editor.getSelectedElement(&quot;img&quot;);</span>
<a href="#l23.64"></a><span id="l23.64">     if (imgElement) {</span>
<a href="#l23.65"></a><span id="l23.65">       // We found an image element, convert it to an input type=&quot;image&quot;</span>
<a href="#l23.66"></a><span id="l23.66">       inputElement.setAttribute(&quot;type&quot;, &quot;image&quot;);</span>
<a href="#l23.67"></a><span id="l23.67"> </span>
<a href="#l23.68"></a><span id="l23.68" class="difflineminus">-      var attributes = [&quot;src&quot;, &quot;alt&quot;, &quot;width&quot;, &quot;height&quot;, &quot;hspace&quot;, &quot;vspace&quot;, &quot;border&quot;, &quot;align&quot;];</span>
<a href="#l23.69"></a><span id="l23.69" class="difflineminus">-      for (let i in attributes)</span>
<a href="#l23.70"></a><span id="l23.70" class="difflineminus">-        inputElement.setAttribute(attributes[i], imgElement.getAttribute(attributes[i]));</span>
<a href="#l23.71"></a><span id="l23.71" class="difflineplus">+      var attributes = [</span>
<a href="#l23.72"></a><span id="l23.72" class="difflineplus">+        &quot;src&quot;,</span>
<a href="#l23.73"></a><span id="l23.73" class="difflineplus">+        &quot;alt&quot;,</span>
<a href="#l23.74"></a><span id="l23.74" class="difflineplus">+        &quot;width&quot;,</span>
<a href="#l23.75"></a><span id="l23.75" class="difflineplus">+        &quot;height&quot;,</span>
<a href="#l23.76"></a><span id="l23.76" class="difflineplus">+        &quot;hspace&quot;,</span>
<a href="#l23.77"></a><span id="l23.77" class="difflineplus">+        &quot;vspace&quot;,</span>
<a href="#l23.78"></a><span id="l23.78" class="difflineplus">+        &quot;border&quot;,</span>
<a href="#l23.79"></a><span id="l23.79" class="difflineplus">+        &quot;align&quot;,</span>
<a href="#l23.80"></a><span id="l23.80" class="difflineplus">+      ];</span>
<a href="#l23.81"></a><span id="l23.81" class="difflineplus">+      for (let i in attributes) {</span>
<a href="#l23.82"></a><span id="l23.82" class="difflineplus">+        inputElement.setAttribute(</span>
<a href="#l23.83"></a><span id="l23.83" class="difflineplus">+          attributes[i],</span>
<a href="#l23.84"></a><span id="l23.84" class="difflineplus">+          imgElement.getAttribute(attributes[i])</span>
<a href="#l23.85"></a><span id="l23.85" class="difflineplus">+        );</span>
<a href="#l23.86"></a><span id="l23.86" class="difflineplus">+      }</span>
<a href="#l23.87"></a><span id="l23.87">     } else {</span>
<a href="#l23.88"></a><span id="l23.88">       inputElement.setAttribute(&quot;value&quot;, GetSelectionAsText());</span>
<a href="#l23.89"></a><span id="l23.89">     }</span>
<a href="#l23.90"></a><span id="l23.90">   }</span>
<a href="#l23.91"></a><span id="l23.91"> </span>
<a href="#l23.92"></a><span id="l23.92">   // Make a copy to use for AdvancedEdit</span>
<a href="#l23.93"></a><span id="l23.93">   globalElement = inputElement.cloneNode(false);</span>
<a href="#l23.94"></a><span id="l23.94"> </span>
<a href="#l23.95"></a><span id="l23.95" class="difflineat">@@ -123,20 +136,32 @@ function InitDialog() {</span>
<a href="#l23.96"></a><span id="l23.96">       break;</span>
<a href="#l23.97"></a><span id="l23.97">     case &quot;submit&quot;:</span>
<a href="#l23.98"></a><span id="l23.98">       index = 4;</span>
<a href="#l23.99"></a><span id="l23.99">       break;</span>
<a href="#l23.100"></a><span id="l23.100">   }</span>
<a href="#l23.101"></a><span id="l23.101">   gDialog.inputType.selectedIndex = index;</span>
<a href="#l23.102"></a><span id="l23.102">   gDialog.inputName.value = globalElement.getAttribute(&quot;name&quot;);</span>
<a href="#l23.103"></a><span id="l23.103">   gDialog.inputValue.value = globalElement.getAttribute(&quot;value&quot;);</span>
<a href="#l23.104"></a><span id="l23.104" class="difflineminus">-  gDialog.inputChecked.setAttribute(&quot;checked&quot;, globalElement.hasAttribute(&quot;checked&quot;));</span>
<a href="#l23.105"></a><span id="l23.105" class="difflineminus">-  gDialog.inputSelected.setAttribute(&quot;checked&quot;, globalElement.hasAttribute(&quot;checked&quot;));</span>
<a href="#l23.106"></a><span id="l23.106" class="difflineminus">-  gDialog.inputReadOnly.setAttribute(&quot;checked&quot;, globalElement.hasAttribute(&quot;readonly&quot;));</span>
<a href="#l23.107"></a><span id="l23.107" class="difflineminus">-  gDialog.inputDisabled.setAttribute(&quot;checked&quot;, globalElement.hasAttribute(&quot;disabled&quot;));</span>
<a href="#l23.108"></a><span id="l23.108" class="difflineplus">+  gDialog.inputChecked.setAttribute(</span>
<a href="#l23.109"></a><span id="l23.109" class="difflineplus">+    &quot;checked&quot;,</span>
<a href="#l23.110"></a><span id="l23.110" class="difflineplus">+    globalElement.hasAttribute(&quot;checked&quot;)</span>
<a href="#l23.111"></a><span id="l23.111" class="difflineplus">+  );</span>
<a href="#l23.112"></a><span id="l23.112" class="difflineplus">+  gDialog.inputSelected.setAttribute(</span>
<a href="#l23.113"></a><span id="l23.113" class="difflineplus">+    &quot;checked&quot;,</span>
<a href="#l23.114"></a><span id="l23.114" class="difflineplus">+    globalElement.hasAttribute(&quot;checked&quot;)</span>
<a href="#l23.115"></a><span id="l23.115" class="difflineplus">+  );</span>
<a href="#l23.116"></a><span id="l23.116" class="difflineplus">+  gDialog.inputReadOnly.setAttribute(</span>
<a href="#l23.117"></a><span id="l23.117" class="difflineplus">+    &quot;checked&quot;,</span>
<a href="#l23.118"></a><span id="l23.118" class="difflineplus">+    globalElement.hasAttribute(&quot;readonly&quot;)</span>
<a href="#l23.119"></a><span id="l23.119" class="difflineplus">+  );</span>
<a href="#l23.120"></a><span id="l23.120" class="difflineplus">+  gDialog.inputDisabled.setAttribute(</span>
<a href="#l23.121"></a><span id="l23.121" class="difflineplus">+    &quot;checked&quot;,</span>
<a href="#l23.122"></a><span id="l23.122" class="difflineplus">+    globalElement.hasAttribute(&quot;disabled&quot;)</span>
<a href="#l23.123"></a><span id="l23.123" class="difflineplus">+  );</span>
<a href="#l23.124"></a><span id="l23.124">   gDialog.inputTabIndex.value = globalElement.getAttribute(&quot;tabindex&quot;);</span>
<a href="#l23.125"></a><span id="l23.125">   gDialog.inputAccessKey.value = globalElement.getAttribute(&quot;accesskey&quot;);</span>
<a href="#l23.126"></a><span id="l23.126">   gDialog.inputSize.value = globalElement.getAttribute(&quot;size&quot;);</span>
<a href="#l23.127"></a><span id="l23.127">   gDialog.inputMaxLength.value = globalElement.getAttribute(&quot;maxlength&quot;);</span>
<a href="#l23.128"></a><span id="l23.128">   gDialog.inputAccept.value = globalElement.getAttribute(&quot;accept&quot;);</span>
<a href="#l23.129"></a><span id="l23.129">   SelectInputType();</span>
<a href="#l23.130"></a><span id="l23.130"> }</span>
<a href="#l23.131"></a><span id="l23.131"> </span>
<a href="#l23.132"></a><span id="l23.132" class="difflineat">@@ -181,38 +206,42 @@ function SelectInputType() {</span>
<a href="#l23.133"></a><span id="l23.133">       break;</span>
<a href="#l23.134"></a><span id="l23.134">   }</span>
<a href="#l23.135"></a><span id="l23.135">   onInput();</span>
<a href="#l23.136"></a><span id="l23.136"> }</span>
<a href="#l23.137"></a><span id="l23.137"> </span>
<a href="#l23.138"></a><span id="l23.138"> function onInput() {</span>
<a href="#l23.139"></a><span id="l23.139">   var disabled = false;</span>
<a href="#l23.140"></a><span id="l23.140">   switch (gDialog.inputType.selectedIndex) {</span>
<a href="#l23.141"></a><span id="l23.141" class="difflineminus">-  case 3:</span>
<a href="#l23.142"></a><span id="l23.142" class="difflineminus">-    disabled = disabled || !gDialog.inputValue.value;</span>
<a href="#l23.143"></a><span id="l23.143" class="difflineminus">-    break;</span>
<a href="#l23.144"></a><span id="l23.144" class="difflineminus">-  case 4:</span>
<a href="#l23.145"></a><span id="l23.145" class="difflineminus">-  case 5:</span>
<a href="#l23.146"></a><span id="l23.146" class="difflineminus">-    break;</span>
<a href="#l23.147"></a><span id="l23.147" class="difflineminus">-  case 8:</span>
<a href="#l23.148"></a><span id="l23.148" class="difflineminus">-    disabled = !globalElement.hasAttribute(&quot;src&quot;);</span>
<a href="#l23.149"></a><span id="l23.149" class="difflineminus">-    break;</span>
<a href="#l23.150"></a><span id="l23.150" class="difflineminus">-  default:</span>
<a href="#l23.151"></a><span id="l23.151" class="difflineminus">-    disabled = !gDialog.inputName.value;</span>
<a href="#l23.152"></a><span id="l23.152" class="difflineminus">-    break;</span>
<a href="#l23.153"></a><span id="l23.153" class="difflineplus">+    case 3:</span>
<a href="#l23.154"></a><span id="l23.154" class="difflineplus">+      disabled = disabled || !gDialog.inputValue.value;</span>
<a href="#l23.155"></a><span id="l23.155" class="difflineplus">+      break;</span>
<a href="#l23.156"></a><span id="l23.156" class="difflineplus">+    case 4:</span>
<a href="#l23.157"></a><span id="l23.157" class="difflineplus">+    case 5:</span>
<a href="#l23.158"></a><span id="l23.158" class="difflineplus">+      break;</span>
<a href="#l23.159"></a><span id="l23.159" class="difflineplus">+    case 8:</span>
<a href="#l23.160"></a><span id="l23.160" class="difflineplus">+      disabled = !globalElement.hasAttribute(&quot;src&quot;);</span>
<a href="#l23.161"></a><span id="l23.161" class="difflineplus">+      break;</span>
<a href="#l23.162"></a><span id="l23.162" class="difflineplus">+    default:</span>
<a href="#l23.163"></a><span id="l23.163" class="difflineplus">+      disabled = !gDialog.inputName.value;</span>
<a href="#l23.164"></a><span id="l23.164" class="difflineplus">+      break;</span>
<a href="#l23.165"></a><span id="l23.165">   }</span>
<a href="#l23.166"></a><span id="l23.166">   if (gDialog.accept.disabled != disabled) {</span>
<a href="#l23.167"></a><span id="l23.167">     gDialog.accept.disabled = disabled;</span>
<a href="#l23.168"></a><span id="l23.168">     gDialog.AdvancedEditButton.disabled = disabled;</span>
<a href="#l23.169"></a><span id="l23.169">   }</span>
<a href="#l23.170"></a><span id="l23.170"> }</span>
<a href="#l23.171"></a><span id="l23.171"> </span>
<a href="#l23.172"></a><span id="l23.172"> function doImageProperties() {</span>
<a href="#l23.173"></a><span id="l23.173" class="difflineminus">-  window.openDialog(&quot;chrome://editor/content/EdImageProps.xul&quot;,</span>
<a href="#l23.174"></a><span id="l23.174" class="difflineminus">-                    &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, globalElement);</span>
<a href="#l23.175"></a><span id="l23.175" class="difflineplus">+  window.openDialog(</span>
<a href="#l23.176"></a><span id="l23.176" class="difflineplus">+    &quot;chrome://editor/content/EdImageProps.xul&quot;,</span>
<a href="#l23.177"></a><span id="l23.177" class="difflineplus">+    &quot;_blank&quot;,</span>
<a href="#l23.178"></a><span id="l23.178" class="difflineplus">+    &quot;chrome,close,titlebar,modal&quot;,</span>
<a href="#l23.179"></a><span id="l23.179" class="difflineplus">+    globalElement</span>
<a href="#l23.180"></a><span id="l23.180" class="difflineplus">+  );</span>
<a href="#l23.181"></a><span id="l23.181">   window.focus();</span>
<a href="#l23.182"></a><span id="l23.182">   onInput();</span>
<a href="#l23.183"></a><span id="l23.183"> }</span>
<a href="#l23.184"></a><span id="l23.184"> </span>
<a href="#l23.185"></a><span id="l23.185"> function ValidateData() {</span>
<a href="#l23.186"></a><span id="l23.186">   var attributes = {</span>
<a href="#l23.187"></a><span id="l23.187">     type: &quot;&quot;,</span>
<a href="#l23.188"></a><span id="l23.188">     name: gDialog.inputName.value,</span>
<a href="#l23.189"></a><span id="l23.189" class="difflineat">@@ -227,17 +256,17 @@ function ValidateData() {</span>
<a href="#l23.190"></a><span id="l23.190">   var flags = {</span>
<a href="#l23.191"></a><span id="l23.191">     checked: false,</span>
<a href="#l23.192"></a><span id="l23.192">     readonly: false,</span>
<a href="#l23.193"></a><span id="l23.193">     disabled: gDialog.inputDisabled.checked,</span>
<a href="#l23.194"></a><span id="l23.194">   };</span>
<a href="#l23.195"></a><span id="l23.195">   switch (index) {</span>
<a href="#l23.196"></a><span id="l23.196">     case 1:</span>
<a href="#l23.197"></a><span id="l23.197">       attributes.type = &quot;password&quot;;</span>
<a href="#l23.198"></a><span id="l23.198" class="difflineminus">-      // Falls through</span>
<a href="#l23.199"></a><span id="l23.199" class="difflineplus">+    // Falls through</span>
<a href="#l23.200"></a><span id="l23.200">     case 0:</span>
<a href="#l23.201"></a><span id="l23.201">       flags.readonly = gDialog.inputReadOnly.checked;</span>
<a href="#l23.202"></a><span id="l23.202">       attributes.size = gDialog.inputSize.value;</span>
<a href="#l23.203"></a><span id="l23.203">       attributes.maxlength = gDialog.inputMaxLength.value;</span>
<a href="#l23.204"></a><span id="l23.204">       break;</span>
<a href="#l23.205"></a><span id="l23.205">     case 2:</span>
<a href="#l23.206"></a><span id="l23.206">       attributes.type = &quot;checkbox&quot;;</span>
<a href="#l23.207"></a><span id="l23.207">       flags.checked = gDialog.inputChecked.checked;</span>
<a href="#l23.208"></a><span id="l23.208" class="difflineat">@@ -268,26 +297,28 @@ function ValidateData() {</span>
<a href="#l23.209"></a><span id="l23.209">       attributes.value = &quot;&quot;;</span>
<a href="#l23.210"></a><span id="l23.210">       break;</span>
<a href="#l23.211"></a><span id="l23.211">     case 9:</span>
<a href="#l23.212"></a><span id="l23.212">       attributes.type = &quot;button&quot;;</span>
<a href="#l23.213"></a><span id="l23.213">       attributes.accesskey = gDialog.inputAccessKey.value;</span>
<a href="#l23.214"></a><span id="l23.214">       break;</span>
<a href="#l23.215"></a><span id="l23.215">   }</span>
<a href="#l23.216"></a><span id="l23.216">   for (var a in attributes) {</span>
<a href="#l23.217"></a><span id="l23.217" class="difflineminus">-    if (attributes[a])</span>
<a href="#l23.218"></a><span id="l23.218" class="difflineplus">+    if (attributes[a]) {</span>
<a href="#l23.219"></a><span id="l23.219">       globalElement.setAttribute(a, attributes[a]);</span>
<a href="#l23.220"></a><span id="l23.220" class="difflineminus">-    else</span>
<a href="#l23.221"></a><span id="l23.221" class="difflineplus">+    } else {</span>
<a href="#l23.222"></a><span id="l23.222">       globalElement.removeAttribute(a);</span>
<a href="#l23.223"></a><span id="l23.223" class="difflineplus">+    }</span>
<a href="#l23.224"></a><span id="l23.224">   }</span>
<a href="#l23.225"></a><span id="l23.225">   for (var f in flags) {</span>
<a href="#l23.226"></a><span id="l23.226" class="difflineminus">-    if (flags[f])</span>
<a href="#l23.227"></a><span id="l23.227" class="difflineplus">+    if (flags[f]) {</span>
<a href="#l23.228"></a><span id="l23.228">       globalElement.setAttribute(f, &quot;&quot;);</span>
<a href="#l23.229"></a><span id="l23.229" class="difflineminus">-    else</span>
<a href="#l23.230"></a><span id="l23.230" class="difflineplus">+    } else {</span>
<a href="#l23.231"></a><span id="l23.231">       globalElement.removeAttribute(f);</span>
<a href="#l23.232"></a><span id="l23.232" class="difflineplus">+    }</span>
<a href="#l23.233"></a><span id="l23.233">   }</span>
<a href="#l23.234"></a><span id="l23.234">   return true;</span>
<a href="#l23.235"></a><span id="l23.235"> }</span>
<a href="#l23.236"></a><span id="l23.236"> </span>
<a href="#l23.237"></a><span id="l23.237"> function onAccept(event) {</span>
<a href="#l23.238"></a><span id="l23.238">   if (ValidateData()) {</span>
<a href="#l23.239"></a><span id="l23.239">     // All values are valid - copy to actual element in doc or</span>
<a href="#l23.240"></a><span id="l23.240">     //   element created to insert</span>
<a href="#l23.241"></a><span id="l23.241" class="difflineat">@@ -307,9 +338,8 @@ function onAccept(event) {</span>
<a href="#l23.242"></a><span id="l23.242">     }</span>
<a href="#l23.243"></a><span id="l23.243"> </span>
<a href="#l23.244"></a><span id="l23.244">     SaveWindowLocation();</span>
<a href="#l23.245"></a><span id="l23.245"> </span>
<a href="#l23.246"></a><span id="l23.246">     return;</span>
<a href="#l23.247"></a><span id="l23.247">   }</span>
<a href="#l23.248"></a><span id="l23.248">   event.preventDefault();</span>
<a href="#l23.249"></a><span id="l23.249"> }</span>
<a href="#l23.250"></a><span id="l23.250" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdInsSrc.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdInsSrc.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -27,114 +27,132 @@ function Startup() {</span>
<a href="#l24.4"></a><span id="l24.4">   // Create dialog object to store controls for easy access</span>
<a href="#l24.5"></a><span id="l24.5">   gDialog.srcInput = document.getElementById(&quot;srcInput&quot;);</span>
<a href="#l24.6"></a><span id="l24.6"> </span>
<a href="#l24.7"></a><span id="l24.7">   // Attach a paste listener so we can detect pasted data URIs we need to shorten.</span>
<a href="#l24.8"></a><span id="l24.8">   gDialog.srcInput.addEventListener(&quot;paste&quot;, onPaste);</span>
<a href="#l24.9"></a><span id="l24.9"> </span>
<a href="#l24.10"></a><span id="l24.10">   let selection;</span>
<a href="#l24.11"></a><span id="l24.11">   try {</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-    selection = editor.outputToString(&quot;text/html&quot;, kOutputFormatted | kOutputSelectionOnly | kOutputWrap);</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+    selection = editor.outputToString(</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+      &quot;text/html&quot;,</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineplus">+      kOutputFormatted | kOutputSelectionOnly | kOutputWrap</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineplus">+    );</span>
<a href="#l24.17"></a><span id="l24.17">   } catch (e) {}</span>
<a href="#l24.18"></a><span id="l24.18">   if (selection) {</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineminus">-    selection = (selection.replace(/&lt;body[^&gt;]*&gt;/, &quot;&quot;)).replace(/&lt;\/body&gt;/, &quot;&quot;);</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineplus">+    selection = selection.replace(/&lt;body[^&gt;]*&gt;/, &quot;&quot;).replace(/&lt;\/body&gt;/, &quot;&quot;);</span>
<a href="#l24.21"></a><span id="l24.21"> </span>
<a href="#l24.22"></a><span id="l24.22">     // Shorten data URIs for display.</span>
<a href="#l24.23"></a><span id="l24.23">     selection = replaceDataURIs(selection);</span>
<a href="#l24.24"></a><span id="l24.24"> </span>
<a href="#l24.25"></a><span id="l24.25" class="difflineminus">-    if (selection)</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineplus">+    if (selection) {</span>
<a href="#l24.27"></a><span id="l24.27">       gDialog.srcInput.value = selection;</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineplus">+    }</span>
<a href="#l24.29"></a><span id="l24.29">   }</span>
<a href="#l24.30"></a><span id="l24.30">   // Set initial focus</span>
<a href="#l24.31"></a><span id="l24.31">   gDialog.srcInput.focus();</span>
<a href="#l24.32"></a><span id="l24.32">   SetWindowLocation();</span>
<a href="#l24.33"></a><span id="l24.33"> }</span>
<a href="#l24.34"></a><span id="l24.34"> </span>
<a href="#l24.35"></a><span id="l24.35"> function replaceDataURIs(input) {</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineminus">-  return input.replace(/(data:.+;base64,)([^&quot;' &gt;]+)/gi,</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineminus">-    function(match, nonDataPart, dataPart) {</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineminus">-      if (gShortDataStrings.has(dataPart)) {</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineminus">-          // We found the exact same data URI, just return the shortened URI.</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineminus">-          return nonDataPart + gShortDataStrings.get(dataPart);</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineminus">-      }</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineplus">+  return input.replace(/(data:.+;base64,)([^&quot;' &gt;]+)/gi, function(</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineplus">+    match,</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineplus">+    nonDataPart,</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineplus">+    dataPart</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineplus">+  ) {</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineplus">+    if (gShortDataStrings.has(dataPart)) {</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineplus">+      // We found the exact same data URI, just return the shortened URI.</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineplus">+      return nonDataPart + gShortDataStrings.get(dataPart);</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineplus">+    }</span>
<a href="#l24.51"></a><span id="l24.51"> </span>
<a href="#l24.52"></a><span id="l24.52" class="difflineminus">-      let l = 5;</span>
<a href="#l24.53"></a><span id="l24.53" class="difflineminus">-      let key;</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineminus">-      // Normally we insert the ellipsis after five characters but if it's not unique</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineminus">-      // we include more data.</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineminus">-      do {</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineminus">-        key = dataPart.substr(0, l) + &quot;…&quot; + dataPart.substr(dataPart.length - 10);</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineminus">-        l++;</span>
<a href="#l24.59"></a><span id="l24.59" class="difflineminus">-      } while (gFullDataStrings.has(key) &amp;&amp; l &lt; dataPart.length - 10);</span>
<a href="#l24.60"></a><span id="l24.60" class="difflineminus">-      gFullDataStrings.set(key, dataPart);</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineminus">-      gShortDataStrings.set(dataPart, key);</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineplus">+    let l = 5;</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineplus">+    let key;</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineplus">+    // Normally we insert the ellipsis after five characters but if it's not unique</span>
<a href="#l24.65"></a><span id="l24.65" class="difflineplus">+    // we include more data.</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineplus">+    do {</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineplus">+      key = dataPart.substr(0, l) + &quot;…&quot; + dataPart.substr(dataPart.length - 10);</span>
<a href="#l24.68"></a><span id="l24.68" class="difflineplus">+      l++;</span>
<a href="#l24.69"></a><span id="l24.69" class="difflineplus">+    } while (gFullDataStrings.has(key) &amp;&amp; l &lt; dataPart.length - 10);</span>
<a href="#l24.70"></a><span id="l24.70" class="difflineplus">+    gFullDataStrings.set(key, dataPart);</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineplus">+    gShortDataStrings.set(dataPart, key);</span>
<a href="#l24.72"></a><span id="l24.72"> </span>
<a href="#l24.73"></a><span id="l24.73" class="difflineminus">-      // Attach listeners. In case anyone copies/cuts from the HTML window,</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineminus">-      // we want to restore the data URI on the clipboard.</span>
<a href="#l24.75"></a><span id="l24.75" class="difflineminus">-      if (!gListenerAttached) {</span>
<a href="#l24.76"></a><span id="l24.76" class="difflineminus">-        gDialog.srcInput.addEventListener(&quot;copy&quot;, onCopyOrCut);</span>
<a href="#l24.77"></a><span id="l24.77" class="difflineminus">-        gDialog.srcInput.addEventListener(&quot;cut&quot;, onCopyOrCut);</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineminus">-        gListenerAttached = true;</span>
<a href="#l24.79"></a><span id="l24.79" class="difflineminus">-      }</span>
<a href="#l24.80"></a><span id="l24.80" class="difflineplus">+    // Attach listeners. In case anyone copies/cuts from the HTML window,</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineplus">+    // we want to restore the data URI on the clipboard.</span>
<a href="#l24.82"></a><span id="l24.82" class="difflineplus">+    if (!gListenerAttached) {</span>
<a href="#l24.83"></a><span id="l24.83" class="difflineplus">+      gDialog.srcInput.addEventListener(&quot;copy&quot;, onCopyOrCut);</span>
<a href="#l24.84"></a><span id="l24.84" class="difflineplus">+      gDialog.srcInput.addEventListener(&quot;cut&quot;, onCopyOrCut);</span>
<a href="#l24.85"></a><span id="l24.85" class="difflineplus">+      gListenerAttached = true;</span>
<a href="#l24.86"></a><span id="l24.86" class="difflineplus">+    }</span>
<a href="#l24.87"></a><span id="l24.87"> </span>
<a href="#l24.88"></a><span id="l24.88" class="difflineminus">-      return nonDataPart + key;</span>
<a href="#l24.89"></a><span id="l24.89" class="difflineminus">-    });</span>
<a href="#l24.90"></a><span id="l24.90" class="difflineplus">+    return nonDataPart + key;</span>
<a href="#l24.91"></a><span id="l24.91" class="difflineplus">+  });</span>
<a href="#l24.92"></a><span id="l24.92"> }</span>
<a href="#l24.93"></a><span id="l24.93"> </span>
<a href="#l24.94"></a><span id="l24.94"> function onCopyOrCut(event) {</span>
<a href="#l24.95"></a><span id="l24.95">   let startPos = gDialog.srcInput.selectionStart;</span>
<a href="#l24.96"></a><span id="l24.96" class="difflineminus">-  if (startPos == undefined)</span>
<a href="#l24.97"></a><span id="l24.97" class="difflineplus">+  if (startPos == undefined) {</span>
<a href="#l24.98"></a><span id="l24.98">     return;</span>
<a href="#l24.99"></a><span id="l24.99" class="difflineplus">+  }</span>
<a href="#l24.100"></a><span id="l24.100">   let endPos = gDialog.srcInput.selectionEnd;</span>
<a href="#l24.101"></a><span id="l24.101">   let clipboard = gDialog.srcInput.value.substring(startPos, endPos);</span>
<a href="#l24.102"></a><span id="l24.102"> </span>
<a href="#l24.103"></a><span id="l24.103">   // Add back the original data URIs we stashed away earlier.</span>
<a href="#l24.104"></a><span id="l24.104" class="difflineminus">-  clipboard = clipboard.replace(/(data:.+;base64,)([^&quot;' &gt;]+)/gi,</span>
<a href="#l24.105"></a><span id="l24.105" class="difflineminus">-    function(match, nonDataPart, key) {</span>
<a href="#l24.106"></a><span id="l24.106" class="difflineminus">-      if (!gFullDataStrings.has(key))</span>
<a href="#l24.107"></a><span id="l24.107" class="difflineminus">-        return match; // user changed data URI</span>
<a href="#l24.108"></a><span id="l24.108" class="difflineminus">-      return nonDataPart + gFullDataStrings.get(key);</span>
<a href="#l24.109"></a><span id="l24.109" class="difflineminus">-    });</span>
<a href="#l24.110"></a><span id="l24.110" class="difflineplus">+  clipboard = clipboard.replace(/(data:.+;base64,)([^&quot;' &gt;]+)/gi, function(</span>
<a href="#l24.111"></a><span id="l24.111" class="difflineplus">+    match,</span>
<a href="#l24.112"></a><span id="l24.112" class="difflineplus">+    nonDataPart,</span>
<a href="#l24.113"></a><span id="l24.113" class="difflineplus">+    key</span>
<a href="#l24.114"></a><span id="l24.114" class="difflineplus">+  ) {</span>
<a href="#l24.115"></a><span id="l24.115" class="difflineplus">+    if (!gFullDataStrings.has(key)) {</span>
<a href="#l24.116"></a><span id="l24.116" class="difflineplus">+      return match;</span>
<a href="#l24.117"></a><span id="l24.117" class="difflineplus">+    } // user changed data URI</span>
<a href="#l24.118"></a><span id="l24.118" class="difflineplus">+    return nonDataPart + gFullDataStrings.get(key);</span>
<a href="#l24.119"></a><span id="l24.119" class="difflineplus">+  });</span>
<a href="#l24.120"></a><span id="l24.120">   event.clipboardData.setData(&quot;text/plain&quot;, clipboard);</span>
<a href="#l24.121"></a><span id="l24.121">   if (event.type == &quot;cut&quot;) {</span>
<a href="#l24.122"></a><span id="l24.122">     // We have to cut the selection manually.</span>
<a href="#l24.123"></a><span id="l24.123" class="difflineminus">-    gDialog.srcInput.value = gDialog.srcInput.value.substr(0, startPos) +</span>
<a href="#l24.124"></a><span id="l24.124" class="difflineminus">-                             gDialog.srcInput.value.substr(endPos);</span>
<a href="#l24.125"></a><span id="l24.125" class="difflineplus">+    gDialog.srcInput.value =</span>
<a href="#l24.126"></a><span id="l24.126" class="difflineplus">+      gDialog.srcInput.value.substr(0, startPos) +</span>
<a href="#l24.127"></a><span id="l24.127" class="difflineplus">+      gDialog.srcInput.value.substr(endPos);</span>
<a href="#l24.128"></a><span id="l24.128">   }</span>
<a href="#l24.129"></a><span id="l24.129">   event.preventDefault();</span>
<a href="#l24.130"></a><span id="l24.130"> }</span>
<a href="#l24.131"></a><span id="l24.131"> </span>
<a href="#l24.132"></a><span id="l24.132"> function onPaste(event) {</span>
<a href="#l24.133"></a><span id="l24.133">   let startPos = gDialog.srcInput.selectionStart;</span>
<a href="#l24.134"></a><span id="l24.134" class="difflineminus">-  if (startPos == undefined)</span>
<a href="#l24.135"></a><span id="l24.135" class="difflineplus">+  if (startPos == undefined) {</span>
<a href="#l24.136"></a><span id="l24.136">     return;</span>
<a href="#l24.137"></a><span id="l24.137" class="difflineplus">+  }</span>
<a href="#l24.138"></a><span id="l24.138">   let endPos = gDialog.srcInput.selectionEnd;</span>
<a href="#l24.139"></a><span id="l24.139">   let clipboard = event.clipboardData.getData(&quot;text/plain&quot;);</span>
<a href="#l24.140"></a><span id="l24.140"> </span>
<a href="#l24.141"></a><span id="l24.141">   // We do out own paste by replacing the selection with the pre-processed</span>
<a href="#l24.142"></a><span id="l24.142">   // clipboard data.</span>
<a href="#l24.143"></a><span id="l24.143" class="difflineminus">-  gDialog.srcInput.value = gDialog.srcInput.value.substr(0, startPos) +</span>
<a href="#l24.144"></a><span id="l24.144" class="difflineminus">-                           replaceDataURIs(clipboard) +</span>
<a href="#l24.145"></a><span id="l24.145" class="difflineminus">-                           gDialog.srcInput.value.substr(endPos);</span>
<a href="#l24.146"></a><span id="l24.146" class="difflineplus">+  gDialog.srcInput.value =</span>
<a href="#l24.147"></a><span id="l24.147" class="difflineplus">+    gDialog.srcInput.value.substr(0, startPos) +</span>
<a href="#l24.148"></a><span id="l24.148" class="difflineplus">+    replaceDataURIs(clipboard) +</span>
<a href="#l24.149"></a><span id="l24.149" class="difflineplus">+    gDialog.srcInput.value.substr(endPos);</span>
<a href="#l24.150"></a><span id="l24.150">   event.preventDefault();</span>
<a href="#l24.151"></a><span id="l24.151"> }</span>
<a href="#l24.152"></a><span id="l24.152"> </span>
<a href="#l24.153"></a><span id="l24.153"> function onAccept(event) {</span>
<a href="#l24.154"></a><span id="l24.154">   let html = gDialog.srcInput.value;</span>
<a href="#l24.155"></a><span id="l24.155">   if (!html) {</span>
<a href="#l24.156"></a><span id="l24.156">     event.preventDefault();</span>
<a href="#l24.157"></a><span id="l24.157">     return;</span>
<a href="#l24.158"></a><span id="l24.158">   }</span>
<a href="#l24.159"></a><span id="l24.159"> </span>
<a href="#l24.160"></a><span id="l24.160">   // Add back the original data URIs we stashed away earlier.</span>
<a href="#l24.161"></a><span id="l24.161" class="difflineminus">-  html = html.replace(/(data:.+;base64,)([^&quot;' &gt;]+)/gi,</span>
<a href="#l24.162"></a><span id="l24.162" class="difflineminus">-    function(match, nonDataPart, key) {</span>
<a href="#l24.163"></a><span id="l24.163" class="difflineminus">-      if (!gFullDataStrings.has(key))</span>
<a href="#l24.164"></a><span id="l24.164" class="difflineminus">-        return match; // user changed data URI</span>
<a href="#l24.165"></a><span id="l24.165" class="difflineminus">-      return nonDataPart + gFullDataStrings.get(key);</span>
<a href="#l24.166"></a><span id="l24.166" class="difflineminus">-    });</span>
<a href="#l24.167"></a><span id="l24.167" class="difflineplus">+  html = html.replace(/(data:.+;base64,)([^&quot;' &gt;]+)/gi, function(</span>
<a href="#l24.168"></a><span id="l24.168" class="difflineplus">+    match,</span>
<a href="#l24.169"></a><span id="l24.169" class="difflineplus">+    nonDataPart,</span>
<a href="#l24.170"></a><span id="l24.170" class="difflineplus">+    key</span>
<a href="#l24.171"></a><span id="l24.171" class="difflineplus">+  ) {</span>
<a href="#l24.172"></a><span id="l24.172" class="difflineplus">+    if (!gFullDataStrings.has(key)) {</span>
<a href="#l24.173"></a><span id="l24.173" class="difflineplus">+      return match;</span>
<a href="#l24.174"></a><span id="l24.174" class="difflineplus">+    } // user changed data URI</span>
<a href="#l24.175"></a><span id="l24.175" class="difflineplus">+    return nonDataPart + gFullDataStrings.get(key);</span>
<a href="#l24.176"></a><span id="l24.176" class="difflineplus">+  });</span>
<a href="#l24.177"></a><span id="l24.177"> </span>
<a href="#l24.178"></a><span id="l24.178">   try {</span>
<a href="#l24.179"></a><span id="l24.179">     GetCurrentEditor().insertHTML(html);</span>
<a href="#l24.180"></a><span id="l24.180">   } catch (e) {}</span>
<a href="#l24.181"></a><span id="l24.181">   SaveWindowLocation();</span>
<a href="#l24.182"></a><span id="l24.182"> }</span>
<a href="#l24.183"></a><span id="l24.183" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdInsertChars.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdInsertChars.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -5,17 +5,17 @@</span>
<a href="#l25.4"></a><span id="l25.4"> /* import-globals-from ../../composer/content/editorUtilities.js */</span>
<a href="#l25.5"></a><span id="l25.5"> /* import-globals-from EdDialogCommon.js */</span>
<a href="#l25.6"></a><span id="l25.6"> </span>
<a href="#l25.7"></a><span id="l25.7"> // ------------------------------------------------------------------</span>
<a href="#l25.8"></a><span id="l25.8"> // From Unicode 3.0 Page 54. 3.11 Conjoining Jamo Behavior</span>
<a href="#l25.9"></a><span id="l25.9"> var SBase = 0xac00;</span>
<a href="#l25.10"></a><span id="l25.10"> var LBase = 0x1100;</span>
<a href="#l25.11"></a><span id="l25.11"> var VBase = 0x1161;</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-var TBase = 0x11A7;</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+var TBase = 0x11a7;</span>
<a href="#l25.14"></a><span id="l25.14"> var LCount = 19;</span>
<a href="#l25.15"></a><span id="l25.15"> var VCount = 21;</span>
<a href="#l25.16"></a><span id="l25.16"> var TCount = 28;</span>
<a href="#l25.17"></a><span id="l25.17"> var NCount = VCount * TCount;</span>
<a href="#l25.18"></a><span id="l25.18"> // End of Unicode 3.0</span>
<a href="#l25.19"></a><span id="l25.19"> </span>
<a href="#l25.20"></a><span id="l25.20"> // dialog initialization code</span>
<a href="#l25.21"></a><span id="l25.21"> function Startup() {</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineat">@@ -48,18 +48,19 @@ function onAccept() {</span>
<a href="#l25.23"></a><span id="l25.23"> </span>
<a href="#l25.24"></a><span id="l25.24">   // Don't close the dialog</span>
<a href="#l25.25"></a><span id="l25.25">   return false;</span>
<a href="#l25.26"></a><span id="l25.26"> }</span>
<a href="#l25.27"></a><span id="l25.27"> </span>
<a href="#l25.28"></a><span id="l25.28"> // Don't allow inserting in HTML Source Mode</span>
<a href="#l25.29"></a><span id="l25.29"> function onFocus() {</span>
<a href="#l25.30"></a><span id="l25.30">   var enable = true;</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-  if (&quot;gEditorDisplayMode&quot; in window.opener)</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineplus">+  if (&quot;gEditorDisplayMode&quot; in window.opener) {</span>
<a href="#l25.33"></a><span id="l25.33">     enable = !window.opener.IsInHTMLSourceMode();</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineplus">+  }</span>
<a href="#l25.35"></a><span id="l25.35"> </span>
<a href="#l25.36"></a><span id="l25.36">   SetElementEnabled(document.documentElement.getButton(&quot;accept&quot;), enable);</span>
<a href="#l25.37"></a><span id="l25.37"> }</span>
<a href="#l25.38"></a><span id="l25.38"> </span>
<a href="#l25.39"></a><span id="l25.39"> function onClose() {</span>
<a href="#l25.40"></a><span id="l25.40">   window.opener.InsertCharWindow = null;</span>
<a href="#l25.41"></a><span id="l25.41">   SaveWindowLocation();</span>
<a href="#l25.42"></a><span id="l25.42">   return true;</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineat">@@ -83,34 +84,35 @@ var CategoryGroup;</span>
<a href="#l25.44"></a><span id="l25.44"> var initialize = true;</span>
<a href="#l25.45"></a><span id="l25.45"> </span>
<a href="#l25.46"></a><span id="l25.46"> function StartupLatin() {</span>
<a href="#l25.47"></a><span id="l25.47">   LatinL = document.getElementById(&quot;LatinL&quot;);</span>
<a href="#l25.48"></a><span id="l25.48">   LatinM = document.getElementById(&quot;LatinM&quot;);</span>
<a href="#l25.49"></a><span id="l25.49">   LatinL_Label = document.getElementById(&quot;LatinL_Label&quot;);</span>
<a href="#l25.50"></a><span id="l25.50">   LatinM_Label = document.getElementById(&quot;LatinM_Label&quot;);</span>
<a href="#l25.51"></a><span id="l25.51"> </span>
<a href="#l25.52"></a><span id="l25.52" class="difflineminus">-  var Symbol      = document.getElementById(&quot;Symbol&quot;);</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineplus">+  var Symbol = document.getElementById(&quot;Symbol&quot;);</span>
<a href="#l25.54"></a><span id="l25.54">   var AccentUpper = document.getElementById(&quot;AccentUpper&quot;);</span>
<a href="#l25.55"></a><span id="l25.55">   var AccentLower = document.getElementById(&quot;AccentLower&quot;);</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineminus">-  var Upper       = document.getElementById(&quot;Upper&quot;);</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineminus">-  var Lower       = document.getElementById(&quot;Lower&quot;);</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineminus">-  CategoryGroup   = document.getElementById(&quot;CatGrp&quot;);</span>
<a href="#l25.59"></a><span id="l25.59" class="difflineplus">+  var Upper = document.getElementById(&quot;Upper&quot;);</span>
<a href="#l25.60"></a><span id="l25.60" class="difflineplus">+  var Lower = document.getElementById(&quot;Lower&quot;);</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineplus">+  CategoryGroup = document.getElementById(&quot;CatGrp&quot;);</span>
<a href="#l25.62"></a><span id="l25.62"> </span>
<a href="#l25.63"></a><span id="l25.63">   // Initialize which radio button is set from persistent attribute...</span>
<a href="#l25.64"></a><span id="l25.64">   var category = CategoryGroup.getAttribute(&quot;category&quot;);</span>
<a href="#l25.65"></a><span id="l25.65"> </span>
<a href="#l25.66"></a><span id="l25.66">   // ...as well as indexes into the letter and character lists</span>
<a href="#l25.67"></a><span id="l25.67">   var index = Number(CategoryGroup.getAttribute(&quot;letter_index&quot;));</span>
<a href="#l25.68"></a><span id="l25.68" class="difflineminus">-  if (index &amp;&amp; index &gt;= 0)</span>
<a href="#l25.69"></a><span id="l25.69" class="difflineplus">+  if (index &amp;&amp; index &gt;= 0) {</span>
<a href="#l25.70"></a><span id="l25.70">     indexL = index;</span>
<a href="#l25.71"></a><span id="l25.71" class="difflineplus">+  }</span>
<a href="#l25.72"></a><span id="l25.72">   index = Number(CategoryGroup.getAttribute(&quot;char_index&quot;));</span>
<a href="#l25.73"></a><span id="l25.73" class="difflineminus">-  if (index &amp;&amp; index &gt;= 0)</span>
<a href="#l25.74"></a><span id="l25.74" class="difflineplus">+  if (index &amp;&amp; index &gt;= 0) {</span>
<a href="#l25.75"></a><span id="l25.75">     indexM = index;</span>
<a href="#l25.76"></a><span id="l25.76" class="difflineminus">-</span>
<a href="#l25.77"></a><span id="l25.77" class="difflineplus">+  }</span>
<a href="#l25.78"></a><span id="l25.78"> </span>
<a href="#l25.79"></a><span id="l25.79">   switch (category) {</span>
<a href="#l25.80"></a><span id="l25.80">     case &quot;AccentUpper&quot;: // Uppercase Diacritical</span>
<a href="#l25.81"></a><span id="l25.81">       CategoryGroup.selectedItem = AccentUpper;</span>
<a href="#l25.82"></a><span id="l25.82">       indexM_AU = indexM;</span>
<a href="#l25.83"></a><span id="l25.83">       break;</span>
<a href="#l25.84"></a><span id="l25.84">     case &quot;AccentLower&quot;: // Lowercase Diacritical</span>
<a href="#l25.85"></a><span id="l25.85">       CategoryGroup.selectedItem = AccentLower;</span>
<a href="#l25.86"></a><span id="l25.86" class="difflineat">@@ -169,86 +171,100 @@ function DisableLatinL(disable) {</span>
<a href="#l25.87"></a><span id="l25.87">   }</span>
<a href="#l25.88"></a><span id="l25.88"> }</span>
<a href="#l25.89"></a><span id="l25.89"> </span>
<a href="#l25.90"></a><span id="l25.90"> function UpdateLatinL() {</span>
<a href="#l25.91"></a><span id="l25.91">   LatinL.removeAllItems();</span>
<a href="#l25.92"></a><span id="l25.92">   if (category == &quot;AccentUpper&quot; || category == &quot;AccentLower&quot;) {</span>
<a href="#l25.93"></a><span id="l25.93">     DisableLatinL(false);</span>
<a href="#l25.94"></a><span id="l25.94">     // No Q or q</span>
<a href="#l25.95"></a><span id="l25.95" class="difflineminus">-    var alphabet = category == &quot;AccentUpper&quot; ? &quot;ABCDEFGHIJKLMNOPRSTUVWXYZ&quot; : &quot;abcdefghijklmnoprstuvwxyz&quot;;</span>
<a href="#l25.96"></a><span id="l25.96" class="difflineminus">-    for (var letter = 0; letter &lt; alphabet.length; letter++)</span>
<a href="#l25.97"></a><span id="l25.97" class="difflineplus">+    var alphabet =</span>
<a href="#l25.98"></a><span id="l25.98" class="difflineplus">+      category == &quot;AccentUpper&quot;</span>
<a href="#l25.99"></a><span id="l25.99" class="difflineplus">+        ? &quot;ABCDEFGHIJKLMNOPRSTUVWXYZ&quot;</span>
<a href="#l25.100"></a><span id="l25.100" class="difflineplus">+        : &quot;abcdefghijklmnoprstuvwxyz&quot;;</span>
<a href="#l25.101"></a><span id="l25.101" class="difflineplus">+    for (var letter = 0; letter &lt; alphabet.length; letter++) {</span>
<a href="#l25.102"></a><span id="l25.102">       LatinL.appendItem(alphabet.charAt(letter));</span>
<a href="#l25.103"></a><span id="l25.103" class="difflineplus">+    }</span>
<a href="#l25.104"></a><span id="l25.104"> </span>
<a href="#l25.105"></a><span id="l25.105">     LatinL.selectedIndex = indexL;</span>
<a href="#l25.106"></a><span id="l25.106">   } else {</span>
<a href="#l25.107"></a><span id="l25.107">     // Other categories don't hinge on a &quot;letter&quot;</span>
<a href="#l25.108"></a><span id="l25.108">     DisableLatinL(true);</span>
<a href="#l25.109"></a><span id="l25.109">     // Note: don't change the indexL so it can be used next time</span>
<a href="#l25.110"></a><span id="l25.110">   }</span>
<a href="#l25.111"></a><span id="l25.111"> }</span>
<a href="#l25.112"></a><span id="l25.112"> </span>
<a href="#l25.113"></a><span id="l25.113"> function UpdateLatinM() {</span>
<a href="#l25.114"></a><span id="l25.114">   LatinM.removeAllItems();</span>
<a href="#l25.115"></a><span id="l25.115">   var i, accent;</span>
<a href="#l25.116"></a><span id="l25.116">   switch (category) {</span>
<a href="#l25.117"></a><span id="l25.117">     case &quot;AccentUpper&quot;: // Uppercase Diacritical</span>
<a href="#l25.118"></a><span id="l25.118">       accent = upper[indexL];</span>
<a href="#l25.119"></a><span id="l25.119" class="difflineminus">-      for (i = 0; i &lt; accent.length; i++)</span>
<a href="#l25.120"></a><span id="l25.120" class="difflineplus">+      for (i = 0; i &lt; accent.length; i++) {</span>
<a href="#l25.121"></a><span id="l25.121">         LatinM.appendItem(accent.charAt(i));</span>
<a href="#l25.122"></a><span id="l25.122" class="difflineplus">+      }</span>
<a href="#l25.123"></a><span id="l25.123"> </span>
<a href="#l25.124"></a><span id="l25.124" class="difflineminus">-      if (indexM_AU &lt; accent.length)</span>
<a href="#l25.125"></a><span id="l25.125" class="difflineplus">+      if (indexM_AU &lt; accent.length) {</span>
<a href="#l25.126"></a><span id="l25.126">         indexM = indexM_AU;</span>
<a href="#l25.127"></a><span id="l25.127" class="difflineminus">-      else</span>
<a href="#l25.128"></a><span id="l25.128" class="difflineplus">+      } else {</span>
<a href="#l25.129"></a><span id="l25.129">         indexM = accent.length - 1;</span>
<a href="#l25.130"></a><span id="l25.130" class="difflineplus">+      }</span>
<a href="#l25.131"></a><span id="l25.131">       indexM_AU = indexM;</span>
<a href="#l25.132"></a><span id="l25.132">       break;</span>
<a href="#l25.133"></a><span id="l25.133"> </span>
<a href="#l25.134"></a><span id="l25.134">     case &quot;AccentLower&quot;: // Lowercase Diacritical</span>
<a href="#l25.135"></a><span id="l25.135">       accent = lower[indexL];</span>
<a href="#l25.136"></a><span id="l25.136" class="difflineminus">-      for (i = 0; i &lt; accent.length; i++)</span>
<a href="#l25.137"></a><span id="l25.137" class="difflineplus">+      for (i = 0; i &lt; accent.length; i++) {</span>
<a href="#l25.138"></a><span id="l25.138">         LatinM.appendItem(accent.charAt(i));</span>
<a href="#l25.139"></a><span id="l25.139" class="difflineplus">+      }</span>
<a href="#l25.140"></a><span id="l25.140"> </span>
<a href="#l25.141"></a><span id="l25.141" class="difflineminus">-      if (indexM_AL &lt; accent.length)</span>
<a href="#l25.142"></a><span id="l25.142" class="difflineplus">+      if (indexM_AL &lt; accent.length) {</span>
<a href="#l25.143"></a><span id="l25.143">         indexM = indexM_AL;</span>
<a href="#l25.144"></a><span id="l25.144" class="difflineminus">-      else</span>
<a href="#l25.145"></a><span id="l25.145" class="difflineplus">+      } else {</span>
<a href="#l25.146"></a><span id="l25.146">         indexM = lower[indexL].length - 1;</span>
<a href="#l25.147"></a><span id="l25.147" class="difflineplus">+      }</span>
<a href="#l25.148"></a><span id="l25.148">       indexM_AL = indexM;</span>
<a href="#l25.149"></a><span id="l25.149">       break;</span>
<a href="#l25.150"></a><span id="l25.150"> </span>
<a href="#l25.151"></a><span id="l25.151">     case &quot;Upper&quot;: // Uppercase w/o Diacritical</span>
<a href="#l25.152"></a><span id="l25.152" class="difflineminus">-      for (i = 0; i &lt; otherupper.length; i++)</span>
<a href="#l25.153"></a><span id="l25.153" class="difflineplus">+      for (i = 0; i &lt; otherupper.length; i++) {</span>
<a href="#l25.154"></a><span id="l25.154">         LatinM.appendItem(otherupper.charAt(i));</span>
<a href="#l25.155"></a><span id="l25.155" class="difflineplus">+      }</span>
<a href="#l25.156"></a><span id="l25.156"> </span>
<a href="#l25.157"></a><span id="l25.157" class="difflineminus">-      if (indexM_U &lt; otherupper.length)</span>
<a href="#l25.158"></a><span id="l25.158" class="difflineplus">+      if (indexM_U &lt; otherupper.length) {</span>
<a href="#l25.159"></a><span id="l25.159">         indexM = indexM_U;</span>
<a href="#l25.160"></a><span id="l25.160" class="difflineminus">-      else</span>
<a href="#l25.161"></a><span id="l25.161" class="difflineplus">+      } else {</span>
<a href="#l25.162"></a><span id="l25.162">         indexM = otherupper.length - 1;</span>
<a href="#l25.163"></a><span id="l25.163" class="difflineplus">+      }</span>
<a href="#l25.164"></a><span id="l25.164">       indexM_U = indexM;</span>
<a href="#l25.165"></a><span id="l25.165">       break;</span>
<a href="#l25.166"></a><span id="l25.166"> </span>
<a href="#l25.167"></a><span id="l25.167">     case &quot;Lower&quot;: // Lowercase w/o Diacritical</span>
<a href="#l25.168"></a><span id="l25.168" class="difflineminus">-      for (i = 0; i &lt; otherlower.length; i++)</span>
<a href="#l25.169"></a><span id="l25.169" class="difflineplus">+      for (i = 0; i &lt; otherlower.length; i++) {</span>
<a href="#l25.170"></a><span id="l25.170">         LatinM.appendItem(otherlower.charAt(i));</span>
<a href="#l25.171"></a><span id="l25.171" class="difflineplus">+      }</span>
<a href="#l25.172"></a><span id="l25.172"> </span>
<a href="#l25.173"></a><span id="l25.173" class="difflineminus">-      if (indexM_L &lt; otherlower.length)</span>
<a href="#l25.174"></a><span id="l25.174" class="difflineplus">+      if (indexM_L &lt; otherlower.length) {</span>
<a href="#l25.175"></a><span id="l25.175">         indexM = indexM_L;</span>
<a href="#l25.176"></a><span id="l25.176" class="difflineminus">-      else</span>
<a href="#l25.177"></a><span id="l25.177" class="difflineplus">+      } else {</span>
<a href="#l25.178"></a><span id="l25.178">         indexM = otherlower.length - 1;</span>
<a href="#l25.179"></a><span id="l25.179" class="difflineplus">+      }</span>
<a href="#l25.180"></a><span id="l25.180">       indexM_L = indexM;</span>
<a href="#l25.181"></a><span id="l25.181">       break;</span>
<a href="#l25.182"></a><span id="l25.182"> </span>
<a href="#l25.183"></a><span id="l25.183">     case &quot;Symbol&quot;: // Symbol</span>
<a href="#l25.184"></a><span id="l25.184" class="difflineminus">-      for (i = 0; i &lt; symbol.length; i++)</span>
<a href="#l25.185"></a><span id="l25.185" class="difflineplus">+      for (i = 0; i &lt; symbol.length; i++) {</span>
<a href="#l25.186"></a><span id="l25.186">         LatinM.appendItem(symbol.charAt(i));</span>
<a href="#l25.187"></a><span id="l25.187" class="difflineplus">+      }</span>
<a href="#l25.188"></a><span id="l25.188"> </span>
<a href="#l25.189"></a><span id="l25.189" class="difflineminus">-      if (indexM_S &lt; symbol.length)</span>
<a href="#l25.190"></a><span id="l25.190" class="difflineplus">+      if (indexM_S &lt; symbol.length) {</span>
<a href="#l25.191"></a><span id="l25.191">         indexM = indexM_S;</span>
<a href="#l25.192"></a><span id="l25.192" class="difflineminus">-      else</span>
<a href="#l25.193"></a><span id="l25.193" class="difflineplus">+      } else {</span>
<a href="#l25.194"></a><span id="l25.194">         indexM = symbol.length - 1;</span>
<a href="#l25.195"></a><span id="l25.195" class="difflineplus">+      }</span>
<a href="#l25.196"></a><span id="l25.196">       indexM_S = indexM;</span>
<a href="#l25.197"></a><span id="l25.197">       break;</span>
<a href="#l25.198"></a><span id="l25.198">   }</span>
<a href="#l25.199"></a><span id="l25.199">   LatinM.selectedIndex = indexM;</span>
<a href="#l25.200"></a><span id="l25.200"> }</span>
<a href="#l25.201"></a><span id="l25.201"> </span>
<a href="#l25.202"></a><span id="l25.202"> function UpdateCharacter() {</span>
<a href="#l25.203"></a><span id="l25.203">   indexM = LatinM.selectedIndex;</span>
<a href="#l25.204"></a><span id="l25.204" class="difflineat">@@ -265,17 +281,17 @@ function UpdateCharacter() {</span>
<a href="#l25.205"></a><span id="l25.205">       break;</span>
<a href="#l25.206"></a><span id="l25.206">     case &quot;Lower&quot;: // Lowercase w/o Diacritical</span>
<a href="#l25.207"></a><span id="l25.207">       indexM_L = indexM;</span>
<a href="#l25.208"></a><span id="l25.208">       break;</span>
<a href="#l25.209"></a><span id="l25.209">     case &quot;Symbol&quot;:</span>
<a href="#l25.210"></a><span id="l25.210">       indexM_S = indexM;</span>
<a href="#l25.211"></a><span id="l25.211">       break;</span>
<a href="#l25.212"></a><span id="l25.212">   }</span>
<a href="#l25.213"></a><span id="l25.213" class="difflineminus">-// dump(&quot;Letter Index=&quot;+indexL+&quot;, Character Index=&quot;+indexM+&quot;, Character = &quot;+LatinM.label+&quot;\n&quot;);</span>
<a href="#l25.214"></a><span id="l25.214" class="difflineplus">+  // dump(&quot;Letter Index=&quot;+indexL+&quot;, Character Index=&quot;+indexM+&quot;, Character = &quot;+LatinM.label+&quot;\n&quot;);</span>
<a href="#l25.215"></a><span id="l25.215"> }</span>
<a href="#l25.216"></a><span id="l25.216"> </span>
<a href="#l25.217"></a><span id="l25.217"> const upper = [</span>
<a href="#l25.218"></a><span id="l25.218">   // A</span>
<a href="#l25.219"></a><span id="l25.219">   &quot;\u00c0\u00c1\u00c2\u00c3\u00c4\u00c5\u0100\u0102\u0104\u01cd\u01de\u01de\u01e0\u01fa\u0200\u0202\u0226\u1e00\u1ea0\u1ea2\u1ea4\u1ea6\u1ea8\u1eaa\u1eac\u1eae\u1eb0\u1eb2\u1eb4\u1eb6&quot;,</span>
<a href="#l25.220"></a><span id="l25.220">   // B</span>
<a href="#l25.221"></a><span id="l25.221">   &quot;\u0181\u0182\u0184\u1e02\u1e04\u1e06&quot;,</span>
<a href="#l25.222"></a><span id="l25.222">   // C</span>
<a href="#l25.223"></a><span id="l25.223" class="difflineat">@@ -376,14 +392,16 @@ const lower = [</span>
<a href="#l25.224"></a><span id="l25.224">   // x</span>
<a href="#l25.225"></a><span id="l25.225">   &quot;\u1e8b\u1e8d&quot;,</span>
<a href="#l25.226"></a><span id="l25.226">   // y</span>
<a href="#l25.227"></a><span id="l25.227">   &quot;\u00fd\u00ff\u0177\u0233\u1e8f\u1e99\u1ef3\u1ef5\u1ef7\u1ef9&quot;,</span>
<a href="#l25.228"></a><span id="l25.228">   // z</span>
<a href="#l25.229"></a><span id="l25.229">   &quot;\u017a\u017c\u017e\u0225\u1e91\u1e93\u1e95&quot;,</span>
<a href="#l25.230"></a><span id="l25.230"> ];</span>
<a href="#l25.231"></a><span id="l25.231"> </span>
<a href="#l25.232"></a><span id="l25.232" class="difflineminus">-</span>
<a href="#l25.233"></a><span id="l25.233" class="difflineminus">-const symbol = &quot;\u00a1\u00a2\u00a3\u00a4\u00a5\u20ac\u00a6\u00a7\u00a8\u00a9\u00aa\u00ab\u00ac\u00ae\u00af\u00b0\u00b1\u00b2\u00b3\u00b4\u00b5\u00b6\u00b7\u00b8\u00b9\u00ba\u00bb\u00bc\u00bd\u00be\u00bf\u00d7\u00f7&quot;;</span>
<a href="#l25.234"></a><span id="l25.234" class="difflineplus">+const symbol =</span>
<a href="#l25.235"></a><span id="l25.235" class="difflineplus">+  &quot;\u00a1\u00a2\u00a3\u00a4\u00a5\u20ac\u00a6\u00a7\u00a8\u00a9\u00aa\u00ab\u00ac\u00ae\u00af\u00b0\u00b1\u00b2\u00b3\u00b4\u00b5\u00b6\u00b7\u00b8\u00b9\u00ba\u00bb\u00bc\u00bd\u00be\u00bf\u00d7\u00f7&quot;;</span>
<a href="#l25.236"></a><span id="l25.236"> </span>
<a href="#l25.237"></a><span id="l25.237" class="difflineminus">-const otherupper = &quot;\u00c6\u00d0\u00d8\u00de\u0132\u0152\u0186\u01c4\u01c5\u01c7\u01c8\u01ca\u01cb\u01F1\u01f2&quot;;</span>
<a href="#l25.238"></a><span id="l25.238" class="difflineplus">+const otherupper =</span>
<a href="#l25.239"></a><span id="l25.239" class="difflineplus">+  &quot;\u00c6\u00d0\u00d8\u00de\u0132\u0152\u0186\u01c4\u01c5\u01c7\u01c8\u01ca\u01cb\u01F1\u01f2&quot;;</span>
<a href="#l25.240"></a><span id="l25.240"> </span>
<a href="#l25.241"></a><span id="l25.241" class="difflineminus">-const otherlower = &quot;\u00e6\u00f0\u00f8\u00fe\u00df\u0133\u0153\u01c6\u01c9\u01cc\u01f3&quot;;</span>
<a href="#l25.242"></a><span id="l25.242" class="difflineplus">+const otherlower =</span>
<a href="#l25.243"></a><span id="l25.243" class="difflineplus">+  &quot;\u00e6\u00f0\u00f8\u00fe\u00df\u0133\u0153\u01c6\u01c9\u01cc\u01f3&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdInsertMath.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdInsertMath.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -29,67 +29,75 @@ function Startup() {</span>
<a href="#l26.4"></a><span id="l26.4">   // Set initial focus</span>
<a href="#l26.5"></a><span id="l26.5">   gDialog.input.focus();</span>
<a href="#l26.6"></a><span id="l26.6"> </span>
<a href="#l26.7"></a><span id="l26.7">   // Load TeXZilla</span>
<a href="#l26.8"></a><span id="l26.8">   // TeXZilla.js contains non-ASCII characters and explicitly sets</span>
<a href="#l26.9"></a><span id="l26.9">   // window.TeXZilla, so we have to specify the charset parameter but don't</span>
<a href="#l26.10"></a><span id="l26.10">   // need to worry about the targetObj parameter.</span>
<a href="#l26.11"></a><span id="l26.11">   /* globals TeXZilla */</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-  Services.scriptloader.loadSubScript(&quot;chrome://editor/content/TeXZilla.js&quot;, {}, &quot;UTF-8&quot;);</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+  Services.scriptloader.loadSubScript(</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+    &quot;chrome://editor/content/TeXZilla.js&quot;,</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+    {},</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineplus">+    &quot;UTF-8&quot;</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineplus">+  );</span>
<a href="#l26.18"></a><span id="l26.18"> </span>
<a href="#l26.19"></a><span id="l26.19">   // Verify if the selection is on a &lt;math&gt; and initialize the dialog.</span>
<a href="#l26.20"></a><span id="l26.20">   gDialog.oldMath = editor.getElementOrParentByTagName(&quot;math&quot;, null);</span>
<a href="#l26.21"></a><span id="l26.21">   if (gDialog.oldMath) {</span>
<a href="#l26.22"></a><span id="l26.22">     // When these attributes are absent or invalid, they default to &quot;inline&quot; and &quot;ltr&quot; respectively.</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineminus">-    gDialog.mode.selectedIndex = gDialog.oldMath.getAttribute(&quot;display&quot;) == &quot;block&quot; ? 1 : 0;</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineminus">-    gDialog.direction.selectedIndex = gDialog.oldMath.getAttribute(&quot;dir&quot;) == &quot;rtl&quot; ? 1 : 0;</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineplus">+    gDialog.mode.selectedIndex =</span>
<a href="#l26.26"></a><span id="l26.26" class="difflineplus">+      gDialog.oldMath.getAttribute(&quot;display&quot;) == &quot;block&quot; ? 1 : 0;</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineplus">+    gDialog.direction.selectedIndex =</span>
<a href="#l26.28"></a><span id="l26.28" class="difflineplus">+      gDialog.oldMath.getAttribute(&quot;dir&quot;) == &quot;rtl&quot; ? 1 : 0;</span>
<a href="#l26.29"></a><span id="l26.29">     gDialog.input.value = TeXZilla.getTeXSource(gDialog.oldMath);</span>
<a href="#l26.30"></a><span id="l26.30">   }</span>
<a href="#l26.31"></a><span id="l26.31"> </span>
<a href="#l26.32"></a><span id="l26.32">   // Create the tabbox with LaTeX commands.</span>
<a href="#l26.33"></a><span id="l26.33">   createCommandPanel({</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineminus">-    &quot;√⅗²&quot;: [&quot;{⋯}^{⋯}&quot;,</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineminus">-            &quot;{⋯}_{⋯}&quot;,</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineminus">-            &quot;{⋯}_{⋯}^{⋯}&quot;,</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineminus">-            &quot;\\underset{⋯}{⋯}&quot;,</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineminus">-            &quot;\\overset{⋯}{⋯}&quot;,</span>
<a href="#l26.39"></a><span id="l26.39" class="difflineminus">-            &quot;\\underoverset{⋯}{⋯}{⋯}&quot;,</span>
<a href="#l26.40"></a><span id="l26.40" class="difflineminus">-            &quot;\\left(⋯\\right)&quot;,</span>
<a href="#l26.41"></a><span id="l26.41" class="difflineminus">-            &quot;\\left[⋯\\right]&quot;,</span>
<a href="#l26.42"></a><span id="l26.42" class="difflineminus">-            &quot;\\frac{⋯}{⋯}&quot;,</span>
<a href="#l26.43"></a><span id="l26.43" class="difflineminus">-            &quot;\\binom{⋯}{⋯}&quot;,</span>
<a href="#l26.44"></a><span id="l26.44" class="difflineminus">-            &quot;\\sqrt{⋯}&quot;,</span>
<a href="#l26.45"></a><span id="l26.45" class="difflineminus">-            &quot;\\sqrt[⋯]{⋯}&quot;,</span>
<a href="#l26.46"></a><span id="l26.46" class="difflineminus">-            &quot;\\cos\\left({⋯}\\right)&quot;,</span>
<a href="#l26.47"></a><span id="l26.47" class="difflineminus">-            &quot;\\sin\\left({⋯}\\right)&quot;,</span>
<a href="#l26.48"></a><span id="l26.48" class="difflineminus">-            &quot;\\tan\\left({⋯}\\right)&quot;,</span>
<a href="#l26.49"></a><span id="l26.49" class="difflineminus">-            &quot;\\exp\\left({⋯}\\right)&quot;,</span>
<a href="#l26.50"></a><span id="l26.50" class="difflineminus">-            &quot;\\ln\\left({⋯}\\right)&quot;,</span>
<a href="#l26.51"></a><span id="l26.51" class="difflineminus">-            &quot;\\underbrace{⋯}&quot;,</span>
<a href="#l26.52"></a><span id="l26.52" class="difflineminus">-            &quot;\\underline{⋯}&quot;,</span>
<a href="#l26.53"></a><span id="l26.53" class="difflineminus">-            &quot;\\overbrace{⋯}&quot;,</span>
<a href="#l26.54"></a><span id="l26.54" class="difflineminus">-            &quot;\\widevec{⋯}&quot;,</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineminus">-            &quot;\\widetilde{⋯}&quot;,</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineminus">-            &quot;\\widehat{⋯}&quot;,</span>
<a href="#l26.57"></a><span id="l26.57" class="difflineminus">-            &quot;\\widecheck{⋯}&quot;,</span>
<a href="#l26.58"></a><span id="l26.58" class="difflineminus">-            &quot;\\widebar{⋯}&quot;,</span>
<a href="#l26.59"></a><span id="l26.59" class="difflineminus">-            &quot;\\dot{⋯}&quot;,</span>
<a href="#l26.60"></a><span id="l26.60" class="difflineminus">-            &quot;\\ddot{⋯}&quot;,</span>
<a href="#l26.61"></a><span id="l26.61" class="difflineminus">-            &quot;\\boxed{⋯}&quot;,</span>
<a href="#l26.62"></a><span id="l26.62" class="difflineminus">-            &quot;\\slash{⋯}&quot;,</span>
<a href="#l26.63"></a><span id="l26.63" class="difflineplus">+    &quot;√⅗²&quot;: [</span>
<a href="#l26.64"></a><span id="l26.64" class="difflineplus">+      &quot;{⋯}^{⋯}&quot;,</span>
<a href="#l26.65"></a><span id="l26.65" class="difflineplus">+      &quot;{⋯}_{⋯}&quot;,</span>
<a href="#l26.66"></a><span id="l26.66" class="difflineplus">+      &quot;{⋯}_{⋯}^{⋯}&quot;,</span>
<a href="#l26.67"></a><span id="l26.67" class="difflineplus">+      &quot;\\underset{⋯}{⋯}&quot;,</span>
<a href="#l26.68"></a><span id="l26.68" class="difflineplus">+      &quot;\\overset{⋯}{⋯}&quot;,</span>
<a href="#l26.69"></a><span id="l26.69" class="difflineplus">+      &quot;\\underoverset{⋯}{⋯}{⋯}&quot;,</span>
<a href="#l26.70"></a><span id="l26.70" class="difflineplus">+      &quot;\\left(⋯\\right)&quot;,</span>
<a href="#l26.71"></a><span id="l26.71" class="difflineplus">+      &quot;\\left[⋯\\right]&quot;,</span>
<a href="#l26.72"></a><span id="l26.72" class="difflineplus">+      &quot;\\frac{⋯}{⋯}&quot;,</span>
<a href="#l26.73"></a><span id="l26.73" class="difflineplus">+      &quot;\\binom{⋯}{⋯}&quot;,</span>
<a href="#l26.74"></a><span id="l26.74" class="difflineplus">+      &quot;\\sqrt{⋯}&quot;,</span>
<a href="#l26.75"></a><span id="l26.75" class="difflineplus">+      &quot;\\sqrt[⋯]{⋯}&quot;,</span>
<a href="#l26.76"></a><span id="l26.76" class="difflineplus">+      &quot;\\cos\\left({⋯}\\right)&quot;,</span>
<a href="#l26.77"></a><span id="l26.77" class="difflineplus">+      &quot;\\sin\\left({⋯}\\right)&quot;,</span>
<a href="#l26.78"></a><span id="l26.78" class="difflineplus">+      &quot;\\tan\\left({⋯}\\right)&quot;,</span>
<a href="#l26.79"></a><span id="l26.79" class="difflineplus">+      &quot;\\exp\\left({⋯}\\right)&quot;,</span>
<a href="#l26.80"></a><span id="l26.80" class="difflineplus">+      &quot;\\ln\\left({⋯}\\right)&quot;,</span>
<a href="#l26.81"></a><span id="l26.81" class="difflineplus">+      &quot;\\underbrace{⋯}&quot;,</span>
<a href="#l26.82"></a><span id="l26.82" class="difflineplus">+      &quot;\\underline{⋯}&quot;,</span>
<a href="#l26.83"></a><span id="l26.83" class="difflineplus">+      &quot;\\overbrace{⋯}&quot;,</span>
<a href="#l26.84"></a><span id="l26.84" class="difflineplus">+      &quot;\\widevec{⋯}&quot;,</span>
<a href="#l26.85"></a><span id="l26.85" class="difflineplus">+      &quot;\\widetilde{⋯}&quot;,</span>
<a href="#l26.86"></a><span id="l26.86" class="difflineplus">+      &quot;\\widehat{⋯}&quot;,</span>
<a href="#l26.87"></a><span id="l26.87" class="difflineplus">+      &quot;\\widecheck{⋯}&quot;,</span>
<a href="#l26.88"></a><span id="l26.88" class="difflineplus">+      &quot;\\widebar{⋯}&quot;,</span>
<a href="#l26.89"></a><span id="l26.89" class="difflineplus">+      &quot;\\dot{⋯}&quot;,</span>
<a href="#l26.90"></a><span id="l26.90" class="difflineplus">+      &quot;\\ddot{⋯}&quot;,</span>
<a href="#l26.91"></a><span id="l26.91" class="difflineplus">+      &quot;\\boxed{⋯}&quot;,</span>
<a href="#l26.92"></a><span id="l26.92" class="difflineplus">+      &quot;\\slash{⋯}&quot;,</span>
<a href="#l26.93"></a><span id="l26.93">     ],</span>
<a href="#l26.94"></a><span id="l26.94" class="difflineminus">-    &quot;(▦)&quot;: [&quot;\\begin{matrix} ⋯ &amp; ⋯ \\\\ ⋯ &amp; ⋯ \\end{matrix}&quot;,</span>
<a href="#l26.95"></a><span id="l26.95" class="difflineminus">-            &quot;\\begin{pmatrix} ⋯ &amp; ⋯ \\\\ ⋯ &amp; ⋯ \\end{pmatrix}&quot;,</span>
<a href="#l26.96"></a><span id="l26.96" class="difflineminus">-            &quot;\\begin{bmatrix} ⋯ &amp; ⋯ \\\\ ⋯ &amp; ⋯ \\end{bmatrix}&quot;,</span>
<a href="#l26.97"></a><span id="l26.97" class="difflineminus">-            &quot;\\begin{Bmatrix} ⋯ &amp; ⋯ \\\\ ⋯ &amp; ⋯ \\end{Bmatrix}&quot;,</span>
<a href="#l26.98"></a><span id="l26.98" class="difflineminus">-            &quot;\\begin{vmatrix} ⋯ &amp; ⋯ \\\\ ⋯ &amp; ⋯ \\end{vmatrix}&quot;,</span>
<a href="#l26.99"></a><span id="l26.99" class="difflineminus">-            &quot;\\begin{Vmatrix} ⋯ &amp; ⋯ \\\\ ⋯ &amp; ⋯ \\end{Vmatrix}&quot;,</span>
<a href="#l26.100"></a><span id="l26.100" class="difflineminus">-            &quot;\\begin{cases} ⋯ \\\\ ⋯  \\end{cases}&quot;,</span>
<a href="#l26.101"></a><span id="l26.101" class="difflineminus">-            &quot;\\begin{aligned} ⋯ &amp;= ⋯ \\\\ ⋯ &amp;= ⋯ \\end{aligned}&quot;,</span>
<a href="#l26.102"></a><span id="l26.102" class="difflineplus">+    &quot;(▦)&quot;: [</span>
<a href="#l26.103"></a><span id="l26.103" class="difflineplus">+      &quot;\\begin{matrix} ⋯ &amp; ⋯ \\\\ ⋯ &amp; ⋯ \\end{matrix}&quot;,</span>
<a href="#l26.104"></a><span id="l26.104" class="difflineplus">+      &quot;\\begin{pmatrix} ⋯ &amp; ⋯ \\\\ ⋯ &amp; ⋯ \\end{pmatrix}&quot;,</span>
<a href="#l26.105"></a><span id="l26.105" class="difflineplus">+      &quot;\\begin{bmatrix} ⋯ &amp; ⋯ \\\\ ⋯ &amp; ⋯ \\end{bmatrix}&quot;,</span>
<a href="#l26.106"></a><span id="l26.106" class="difflineplus">+      &quot;\\begin{Bmatrix} ⋯ &amp; ⋯ \\\\ ⋯ &amp; ⋯ \\end{Bmatrix}&quot;,</span>
<a href="#l26.107"></a><span id="l26.107" class="difflineplus">+      &quot;\\begin{vmatrix} ⋯ &amp; ⋯ \\\\ ⋯ &amp; ⋯ \\end{vmatrix}&quot;,</span>
<a href="#l26.108"></a><span id="l26.108" class="difflineplus">+      &quot;\\begin{Vmatrix} ⋯ &amp; ⋯ \\\\ ⋯ &amp; ⋯ \\end{Vmatrix}&quot;,</span>
<a href="#l26.109"></a><span id="l26.109" class="difflineplus">+      &quot;\\begin{cases} ⋯ \\\\ ⋯  \\end{cases}&quot;,</span>
<a href="#l26.110"></a><span id="l26.110" class="difflineplus">+      &quot;\\begin{aligned} ⋯ &amp;= ⋯ \\\\ ⋯ &amp;= ⋯ \\end{aligned}&quot;,</span>
<a href="#l26.111"></a><span id="l26.111">     ],</span>
<a href="#l26.112"></a><span id="l26.112">   });</span>
<a href="#l26.113"></a><span id="l26.113">   createSymbolPanels([</span>
<a href="#l26.114"></a><span id="l26.114">     &quot;∏∐∑∫∬∭⨌∮⊎⊕⊖⊗⊘⊙⋀⋁⋂⋃⌈⌉⌊⌋⎰⎱⟨⟩⟪⟫∥⫼⨀⨁⨂⨄⨅⨆ðıȷℏℑℓ℘ℜℵℶ&quot;,</span>
<a href="#l26.115"></a><span id="l26.115">     &quot;∀∃∄∅∉∊∋∌⊂⊃⊄⊅⊆⊇⊈⊈⊉⊊⊊⊋⊋⊏⊐⊑⊒⊓⊔⊥⋐⋑⋔⫅⫆⫋⫋⫌⫌…⋮⋯⋰⋱♭♮♯∂∇&quot;,</span>
<a href="#l26.116"></a><span id="l26.116">     &quot;±×÷†‡•∓∔∗∘∝∠∡∢∧∨∴∵∼∽≁≃≅≇≈≈≊≍≎≏≐≑≒≓≖≗≜≡≢≬⊚⊛⊞⊡⊢⊣⊤⊥&quot;,</span>
<a href="#l26.117"></a><span id="l26.117">     &quot;⊨⊩⊪⊫⊬⊭⊯⊲⊲⊳⊴⊵⊸⊻⋄⋅⋇⋈⋉⋊⋋⋌⋍⋎⋏⋒⋓⌅⌆⌣△▴▵▸▹▽▾▿◂◃◊○★♠♡♢♣⧫&quot;,</span>
<a href="#l26.118"></a><span id="l26.118">     &quot;≦≧≨≩≩≪≫≮≯≰≱≲≳≶≷≺≻≼≽≾≿⊀⊁⋖⋗⋘⋙⋚⋛⋞⋟⋦⋧⋨⋩⩽⩾⪅⪆⪇⪈⪉⪊⪋⪌⪕⪯⪰⪷⪸⪹⪺&quot;,</span>
<a href="#l26.119"></a><span id="l26.119" class="difflineat">@@ -106,63 +114,69 @@ function Startup() {</span>
<a href="#l26.120"></a><span id="l26.120">   SetWindowLocation();</span>
<a href="#l26.121"></a><span id="l26.121"> }</span>
<a href="#l26.122"></a><span id="l26.122"> </span>
<a href="#l26.123"></a><span id="l26.123"> function insertLaTeXCommand(aButton) {</span>
<a href="#l26.124"></a><span id="l26.124">   gDialog.input.focus();</span>
<a href="#l26.125"></a><span id="l26.125"> </span>
<a href="#l26.126"></a><span id="l26.126">   // For a single math symbol, just use the insertText command.</span>
<a href="#l26.127"></a><span id="l26.127">   if (aButton.label) {</span>
<a href="#l26.128"></a><span id="l26.128" class="difflineminus">-    gDialog.input.editor.QueryInterface(Ci.nsIPlaintextEditor).insertText(aButton.label);</span>
<a href="#l26.129"></a><span id="l26.129" class="difflineplus">+    gDialog.input.editor</span>
<a href="#l26.130"></a><span id="l26.130" class="difflineplus">+      .QueryInterface(Ci.nsIPlaintextEditor)</span>
<a href="#l26.131"></a><span id="l26.131" class="difflineplus">+      .insertText(aButton.label);</span>
<a href="#l26.132"></a><span id="l26.132">     return;</span>
<a href="#l26.133"></a><span id="l26.133">   }</span>
<a href="#l26.134"></a><span id="l26.134"> </span>
<a href="#l26.135"></a><span id="l26.135">   // Otherwise, it's a LaTeX command with at least one argument...</span>
<a href="#l26.136"></a><span id="l26.136">   var latex = TeXZilla.getTeXSource(aButton.firstChild);</span>
<a href="#l26.137"></a><span id="l26.137">   var selectionStart = gDialog.input.selectionStart;</span>
<a href="#l26.138"></a><span id="l26.138">   var selectionEnd = gDialog.input.selectionEnd;</span>
<a href="#l26.139"></a><span id="l26.139"> </span>
<a href="#l26.140"></a><span id="l26.140">   // If the selection is not empty, we replace the first argument of the LaTeX</span>
<a href="#l26.141"></a><span id="l26.141">   // command with the current selection.</span>
<a href="#l26.142"></a><span id="l26.142">   var selection = gDialog.input.value.substring(selectionStart, selectionEnd);</span>
<a href="#l26.143"></a><span id="l26.143">   if (selection != &quot;&quot;) {</span>
<a href="#l26.144"></a><span id="l26.144">     latex = latex.replace(&quot;⋯&quot;, selection);</span>
<a href="#l26.145"></a><span id="l26.145">   }</span>
<a href="#l26.146"></a><span id="l26.146"> </span>
<a href="#l26.147"></a><span id="l26.147">   // Try and move to the next position.</span>
<a href="#l26.148"></a><span id="l26.148" class="difflineminus">-  var latexNewStart = latex.indexOf(&quot;⋯&quot;), latexNewEnd;</span>
<a href="#l26.149"></a><span id="l26.149" class="difflineplus">+  var latexNewStart = latex.indexOf(&quot;⋯&quot;),</span>
<a href="#l26.150"></a><span id="l26.150" class="difflineplus">+    latexNewEnd;</span>
<a href="#l26.151"></a><span id="l26.151">   if (latexNewStart == -1) {</span>
<a href="#l26.152"></a><span id="l26.152">     // This is a unary function and the selection was used as an argument above.</span>
<a href="#l26.153"></a><span id="l26.153">     // We select the expression again so that one can choose to apply further</span>
<a href="#l26.154"></a><span id="l26.154">     // command to it or just move the caret after that text.</span>
<a href="#l26.155"></a><span id="l26.155">     latexNewStart = 0;</span>
<a href="#l26.156"></a><span id="l26.156">     latexNewEnd = latex.length;</span>
<a href="#l26.157"></a><span id="l26.157">   } else {</span>
<a href="#l26.158"></a><span id="l26.158">     // Otherwise, select the dots representing the next argument.</span>
<a href="#l26.159"></a><span id="l26.159">     latexNewEnd = latexNewStart + 1;</span>
<a href="#l26.160"></a><span id="l26.160">   }</span>
<a href="#l26.161"></a><span id="l26.161"> </span>
<a href="#l26.162"></a><span id="l26.162">   // Update the input text and selection.</span>
<a href="#l26.163"></a><span id="l26.163">   gDialog.input.editor.QueryInterface(Ci.nsIPlaintextEditor).insertText(latex);</span>
<a href="#l26.164"></a><span id="l26.164" class="difflineminus">-  gDialog.input.setSelectionRange(selectionStart + latexNewStart,</span>
<a href="#l26.165"></a><span id="l26.165" class="difflineminus">-                                  selectionStart + latexNewEnd);</span>
<a href="#l26.166"></a><span id="l26.166" class="difflineplus">+  gDialog.input.setSelectionRange(</span>
<a href="#l26.167"></a><span id="l26.167" class="difflineplus">+    selectionStart + latexNewStart,</span>
<a href="#l26.168"></a><span id="l26.168" class="difflineplus">+    selectionStart + latexNewEnd</span>
<a href="#l26.169"></a><span id="l26.169" class="difflineplus">+  );</span>
<a href="#l26.170"></a><span id="l26.170"> </span>
<a href="#l26.171"></a><span id="l26.171">   updateMath();</span>
<a href="#l26.172"></a><span id="l26.172"> }</span>
<a href="#l26.173"></a><span id="l26.173"> </span>
<a href="#l26.174"></a><span id="l26.174"> function createCommandPanel(aCommandPanelList) {</span>
<a href="#l26.175"></a><span id="l26.175">   const columnCount = 10;</span>
<a href="#l26.176"></a><span id="l26.176"> </span>
<a href="#l26.177"></a><span id="l26.177">   for (var label in aCommandPanelList) {</span>
<a href="#l26.178"></a><span id="l26.178">     var commands = aCommandPanelList[label];</span>
<a href="#l26.179"></a><span id="l26.179"> </span>
<a href="#l26.180"></a><span id="l26.180">     // Create a &lt;rows&gt; element with some LaTeX commands.</span>
<a href="#l26.181"></a><span id="l26.181">     var rows = document.createXULElement(&quot;rows&quot;);</span>
<a href="#l26.182"></a><span id="l26.182"> </span>
<a href="#l26.183"></a><span id="l26.183" class="difflineminus">-    var i = 0, row;</span>
<a href="#l26.184"></a><span id="l26.184" class="difflineplus">+    var i = 0,</span>
<a href="#l26.185"></a><span id="l26.185" class="difflineplus">+      row;</span>
<a href="#l26.186"></a><span id="l26.186">     for (var command of commands) {</span>
<a href="#l26.187"></a><span id="l26.187">       if (i % columnCount == 0) {</span>
<a href="#l26.188"></a><span id="l26.188">         // Create a new row.</span>
<a href="#l26.189"></a><span id="l26.189">         row = document.createXULElement(&quot;row&quot;);</span>
<a href="#l26.190"></a><span id="l26.190">         rows.appendChild(row);</span>
<a href="#l26.191"></a><span id="l26.191">       }</span>
<a href="#l26.192"></a><span id="l26.192"> </span>
<a href="#l26.193"></a><span id="l26.193">       // Create a new button to insert the symbol.</span>
<a href="#l26.194"></a><span id="l26.194" class="difflineat">@@ -193,22 +207,25 @@ function createCommandPanel(aCommandPane</span>
<a href="#l26.195"></a><span id="l26.195">     gDialog.tabbox.tabs.appendChild(tab);</span>
<a href="#l26.196"></a><span id="l26.196"> </span>
<a href="#l26.197"></a><span id="l26.197">     // Append the new tab panel.</span>
<a href="#l26.198"></a><span id="l26.198">     gDialog.tabbox.tabpanels.appendChild(grid);</span>
<a href="#l26.199"></a><span id="l26.199">   }</span>
<a href="#l26.200"></a><span id="l26.200"> }</span>
<a href="#l26.201"></a><span id="l26.201"> </span>
<a href="#l26.202"></a><span id="l26.202"> function createSymbolPanels(aSymbolPanelList) {</span>
<a href="#l26.203"></a><span id="l26.203" class="difflineminus">-  const columnCount = 13, tabLabelLength = 3;</span>
<a href="#l26.204"></a><span id="l26.204" class="difflineplus">+  const columnCount = 13,</span>
<a href="#l26.205"></a><span id="l26.205" class="difflineplus">+    tabLabelLength = 3;</span>
<a href="#l26.206"></a><span id="l26.206"> </span>
<a href="#l26.207"></a><span id="l26.207">   for (var symbols of aSymbolPanelList) {</span>
<a href="#l26.208"></a><span id="l26.208">     // Create a &lt;rows&gt; element with the symbols of the i-th panel.</span>
<a href="#l26.209"></a><span id="l26.209">     var rows = document.createXULElement(&quot;rows&quot;);</span>
<a href="#l26.210"></a><span id="l26.210" class="difflineminus">-    var i = 0, tabLabel = &quot;&quot;, row;</span>
<a href="#l26.211"></a><span id="l26.211" class="difflineplus">+    var i = 0,</span>
<a href="#l26.212"></a><span id="l26.212" class="difflineplus">+      tabLabel = &quot;&quot;,</span>
<a href="#l26.213"></a><span id="l26.213" class="difflineplus">+      row;</span>
<a href="#l26.214"></a><span id="l26.214">     for (var symbol of symbols) {</span>
<a href="#l26.215"></a><span id="l26.215">       if (i % columnCount == 0) {</span>
<a href="#l26.216"></a><span id="l26.216">         // Create a new row.</span>
<a href="#l26.217"></a><span id="l26.217">         row = document.createXULElement(&quot;row&quot;);</span>
<a href="#l26.218"></a><span id="l26.218">         rows.appendChild(row);</span>
<a href="#l26.219"></a><span id="l26.219">       }</span>
<a href="#l26.220"></a><span id="l26.220"> </span>
<a href="#l26.221"></a><span id="l26.221">       // Build the tab label from the first symbols of this tab.</span>
<a href="#l26.222"></a><span id="l26.222" class="difflineat">@@ -270,33 +287,46 @@ function onAccept(event) {</span>
<a href="#l26.223"></a><span id="l26.223">     dump(&quot;Null value -- not inserting in MathML Source dialog\n&quot;);</span>
<a href="#l26.224"></a><span id="l26.224">     event.preventDefault();</span>
<a href="#l26.225"></a><span id="l26.225">   }</span>
<a href="#l26.226"></a><span id="l26.226">   SaveWindowLocation();</span>
<a href="#l26.227"></a><span id="l26.227"> }</span>
<a href="#l26.228"></a><span id="l26.228"> </span>
<a href="#l26.229"></a><span id="l26.229"> function updateMath() {</span>
<a href="#l26.230"></a><span id="l26.230">   // Remove the preview, if any.</span>
<a href="#l26.231"></a><span id="l26.231" class="difflineminus">-  if (gDialog.output.firstChild)</span>
<a href="#l26.232"></a><span id="l26.232" class="difflineplus">+  if (gDialog.output.firstChild) {</span>
<a href="#l26.233"></a><span id="l26.233">     gDialog.output.firstChild.remove();</span>
<a href="#l26.234"></a><span id="l26.234" class="difflineplus">+  }</span>
<a href="#l26.235"></a><span id="l26.235"> </span>
<a href="#l26.236"></a><span id="l26.236">   // Try to convert the LaTeX source into MathML using TeXZilla.</span>
<a href="#l26.237"></a><span id="l26.237">   // We use the placeholder text if no input is provided.</span>
<a href="#l26.238"></a><span id="l26.238">   try {</span>
<a href="#l26.239"></a><span id="l26.239">     var input = gDialog.input.value || gDialog.input.placeholder;</span>
<a href="#l26.240"></a><span id="l26.240" class="difflineminus">-    var newMath = TeXZilla.toMathML(input, gDialog.mode.selectedIndex, gDialog.direction.selectedIndex, true);</span>
<a href="#l26.241"></a><span id="l26.241" class="difflineplus">+    var newMath = TeXZilla.toMathML(</span>
<a href="#l26.242"></a><span id="l26.242" class="difflineplus">+      input,</span>
<a href="#l26.243"></a><span id="l26.243" class="difflineplus">+      gDialog.mode.selectedIndex,</span>
<a href="#l26.244"></a><span id="l26.244" class="difflineplus">+      gDialog.direction.selectedIndex,</span>
<a href="#l26.245"></a><span id="l26.245" class="difflineplus">+      true</span>
<a href="#l26.246"></a><span id="l26.246" class="difflineplus">+    );</span>
<a href="#l26.247"></a><span id="l26.247">     gDialog.output.appendChild(document.importNode(newMath, true));</span>
<a href="#l26.248"></a><span id="l26.248" class="difflineminus">-    gDialog.output.style.opacity = gDialog.input.value ? 1 : .5;</span>
<a href="#l26.249"></a><span id="l26.249" class="difflineminus">-  } catch (e) {</span>
<a href="#l26.250"></a><span id="l26.250" class="difflineminus">-  }</span>
<a href="#l26.251"></a><span id="l26.251" class="difflineplus">+    gDialog.output.style.opacity = gDialog.input.value ? 1 : 0.5;</span>
<a href="#l26.252"></a><span id="l26.252" class="difflineplus">+  } catch (e) {}</span>
<a href="#l26.253"></a><span id="l26.253">   // Disable the accept button if parsing fails or when the placeholder is used.</span>
<a href="#l26.254"></a><span id="l26.254">   gDialog.accept.disabled = !gDialog.input.value || !gDialog.output.firstChild;</span>
<a href="#l26.255"></a><span id="l26.255"> }</span>
<a href="#l26.256"></a><span id="l26.256"> </span>
<a href="#l26.257"></a><span id="l26.257"> function updateMode() {</span>
<a href="#l26.258"></a><span id="l26.258" class="difflineminus">-  if (gDialog.output.firstChild)</span>
<a href="#l26.259"></a><span id="l26.259" class="difflineminus">-    gDialog.output.firstChild.setAttribute(&quot;display&quot;, gDialog.mode.selectedIndex ? &quot;block&quot; : &quot;inline&quot;);</span>
<a href="#l26.260"></a><span id="l26.260" class="difflineplus">+  if (gDialog.output.firstChild) {</span>
<a href="#l26.261"></a><span id="l26.261" class="difflineplus">+    gDialog.output.firstChild.setAttribute(</span>
<a href="#l26.262"></a><span id="l26.262" class="difflineplus">+      &quot;display&quot;,</span>
<a href="#l26.263"></a><span id="l26.263" class="difflineplus">+      gDialog.mode.selectedIndex ? &quot;block&quot; : &quot;inline&quot;</span>
<a href="#l26.264"></a><span id="l26.264" class="difflineplus">+    );</span>
<a href="#l26.265"></a><span id="l26.265" class="difflineplus">+  }</span>
<a href="#l26.266"></a><span id="l26.266"> }</span>
<a href="#l26.267"></a><span id="l26.267"> </span>
<a href="#l26.268"></a><span id="l26.268"> function updateDirection() {</span>
<a href="#l26.269"></a><span id="l26.269" class="difflineminus">-  if (gDialog.output.firstChild)</span>
<a href="#l26.270"></a><span id="l26.270" class="difflineminus">-    gDialog.output.firstChild.setAttribute(&quot;dir&quot;, gDialog.direction.selectedIndex ? &quot;rtl&quot; : &quot;ltr&quot;);</span>
<a href="#l26.271"></a><span id="l26.271" class="difflineplus">+  if (gDialog.output.firstChild) {</span>
<a href="#l26.272"></a><span id="l26.272" class="difflineplus">+    gDialog.output.firstChild.setAttribute(</span>
<a href="#l26.273"></a><span id="l26.273" class="difflineplus">+      &quot;dir&quot;,</span>
<a href="#l26.274"></a><span id="l26.274" class="difflineplus">+      gDialog.direction.selectedIndex ? &quot;rtl&quot; : &quot;ltr&quot;</span>
<a href="#l26.275"></a><span id="l26.275" class="difflineplus">+    );</span>
<a href="#l26.276"></a><span id="l26.276" class="difflineplus">+  }</span>
<a href="#l26.277"></a><span id="l26.277"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdInsertTOC.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdInsertTOC.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -14,43 +14,44 @@ var currentHeaderLevel = 0;</span>
<a href="#l27.4"></a><span id="l27.4"> </span>
<a href="#l27.5"></a><span id="l27.5"> // a global set to true if the TOC is to be readonly</span>
<a href="#l27.6"></a><span id="l27.6"> var readonly = false;</span>
<a href="#l27.7"></a><span id="l27.7"> </span>
<a href="#l27.8"></a><span id="l27.8"> // a global set to true if user wants indexes in the TOC</span>
<a href="#l27.9"></a><span id="l27.9"> var orderedList = true;</span>
<a href="#l27.10"></a><span id="l27.10"> </span>
<a href="#l27.11"></a><span id="l27.11"> // constants</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-const kMozToc                  = &quot;mozToc&quot;;</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-const kMozTocLength            = 6;</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineminus">-const kMozTocIdPrefix          = &quot;mozTocId&quot;;</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineminus">-const kMozTocIdPrefixLength    = 8;</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineminus">-const kMozTocClassPrefix       = &quot;mozToc&quot;;</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineplus">+const kMozToc = &quot;mozToc&quot;;</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineplus">+const kMozTocLength = 6;</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineplus">+const kMozTocIdPrefix = &quot;mozTocId&quot;;</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineplus">+const kMozTocIdPrefixLength = 8;</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineplus">+const kMozTocClassPrefix = &quot;mozToc&quot;;</span>
<a href="#l27.22"></a><span id="l27.22"> const kMozTocClassPrefixLength = 6;</span>
<a href="#l27.23"></a><span id="l27.23"> </span>
<a href="#l27.24"></a><span id="l27.24"> document.addEventListener(&quot;dialogaccept&quot;, () =&gt; BuildTOC(true));</span>
<a href="#l27.25"></a><span id="l27.25"> </span>
<a href="#l27.26"></a><span id="l27.26"> // Startup() is called when EdInsertTOC.xul is opened</span>
<a href="#l27.27"></a><span id="l27.27"> function Startup() {</span>
<a href="#l27.28"></a><span id="l27.28">   // early way out if if we have no editor</span>
<a href="#l27.29"></a><span id="l27.29">   if (!GetCurrentEditor()) {</span>
<a href="#l27.30"></a><span id="l27.30">     window.close();</span>
<a href="#l27.31"></a><span id="l27.31">     return;</span>
<a href="#l27.32"></a><span id="l27.32">   }</span>
<a href="#l27.33"></a><span id="l27.33"> </span>
<a href="#l27.34"></a><span id="l27.34">   var i;</span>
<a href="#l27.35"></a><span id="l27.35">   // clean the table of tag/class pairs we look for</span>
<a href="#l27.36"></a><span id="l27.36" class="difflineminus">-  for (i = 0; i &lt; 6; ++i)</span>
<a href="#l27.37"></a><span id="l27.37" class="difflineminus">-    tocHeadersArray[i] = [ &quot;&quot;, &quot;&quot; ];</span>
<a href="#l27.38"></a><span id="l27.38" class="difflineplus">+  for (i = 0; i &lt; 6; ++i) {</span>
<a href="#l27.39"></a><span id="l27.39" class="difflineplus">+    tocHeadersArray[i] = [&quot;&quot;, &quot;&quot;];</span>
<a href="#l27.40"></a><span id="l27.40" class="difflineplus">+  }</span>
<a href="#l27.41"></a><span id="l27.41"> </span>
<a href="#l27.42"></a><span id="l27.42">   // reset all settings</span>
<a href="#l27.43"></a><span id="l27.43">   for (i = 1; i &lt; 7; ++i) {</span>
<a href="#l27.44"></a><span id="l27.44">     var menulist = document.getElementById(&quot;header&quot; + i + &quot;Menulist&quot;);</span>
<a href="#l27.45"></a><span id="l27.45">     var menuitem = document.getElementById(&quot;header&quot; + i + &quot;none&quot;);</span>
<a href="#l27.46"></a><span id="l27.46" class="difflineminus">-    var textbox  = document.getElementById(&quot;header&quot; + i + &quot;Class&quot;);</span>
<a href="#l27.47"></a><span id="l27.47" class="difflineplus">+    var textbox = document.getElementById(&quot;header&quot; + i + &quot;Class&quot;);</span>
<a href="#l27.48"></a><span id="l27.48">     menulist.selectedItem = menuitem;</span>
<a href="#l27.49"></a><span id="l27.49">     textbox.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l27.50"></a><span id="l27.50">   }</span>
<a href="#l27.51"></a><span id="l27.51"> </span>
<a href="#l27.52"></a><span id="l27.52">   var theDocument = GetCurrentEditor().document;</span>
<a href="#l27.53"></a><span id="l27.53"> </span>
<a href="#l27.54"></a><span id="l27.54">   // do we already have a TOC in the document ? It should have &quot;mozToc&quot; ID</span>
<a href="#l27.55"></a><span id="l27.55">   var toc = theDocument.getElementById(kMozToc);</span>
<a href="#l27.56"></a><span id="l27.56" class="difflineat">@@ -67,67 +68,72 @@ function Startup() {</span>
<a href="#l27.57"></a><span id="l27.57">     if (toc.getAttribute(&quot;class&quot;) == &quot;readonly&quot;) {</span>
<a href="#l27.58"></a><span id="l27.58">       // and it's readonly</span>
<a href="#l27.59"></a><span id="l27.59">       var checkbox = document.getElementById(&quot;readOnlyCheckbox&quot;);</span>
<a href="#l27.60"></a><span id="l27.60">       checkbox.checked = true;</span>
<a href="#l27.61"></a><span id="l27.61">       readonly = true;</span>
<a href="#l27.62"></a><span id="l27.62">     }</span>
<a href="#l27.63"></a><span id="l27.63"> </span>
<a href="#l27.64"></a><span id="l27.64">     // let's see if it's an OL or an UL</span>
<a href="#l27.65"></a><span id="l27.65" class="difflineminus">-    orderedList = (toc.nodeName.toLowerCase() == &quot;ol&quot;);</span>
<a href="#l27.66"></a><span id="l27.66" class="difflineplus">+    orderedList = toc.nodeName.toLowerCase() == &quot;ol&quot;;</span>
<a href="#l27.67"></a><span id="l27.67">     orderedListCheckbox.checked = orderedList;</span>
<a href="#l27.68"></a><span id="l27.68"> </span>
<a href="#l27.69"></a><span id="l27.69">     var nodeList = toc.childNodes;</span>
<a href="#l27.70"></a><span id="l27.70">     // let's look at the children of the TOC ; if we find a comment beginning</span>
<a href="#l27.71"></a><span id="l27.71">     // with &quot;mozToc&quot;, it contains the TOC definition</span>
<a href="#l27.72"></a><span id="l27.72">     for (i = 0; i &lt; nodeList.length; ++i) {</span>
<a href="#l27.73"></a><span id="l27.73" class="difflineminus">-      if (nodeList.item(i).nodeType == Node.COMMENT_NODE &amp;&amp;</span>
<a href="#l27.74"></a><span id="l27.74" class="difflineminus">-          nodeList.item(i).data.startsWith(kMozToc)) {</span>
<a href="#l27.75"></a><span id="l27.75" class="difflineplus">+      if (</span>
<a href="#l27.76"></a><span id="l27.76" class="difflineplus">+        nodeList.item(i).nodeType == Node.COMMENT_NODE &amp;&amp;</span>
<a href="#l27.77"></a><span id="l27.77" class="difflineplus">+        nodeList.item(i).data.startsWith(kMozToc)</span>
<a href="#l27.78"></a><span id="l27.78" class="difflineplus">+      ) {</span>
<a href="#l27.79"></a><span id="l27.79">         // yep, there is already a definition here; parse it !</span>
<a href="#l27.80"></a><span id="l27.80" class="difflineminus">-        headers = nodeList.item(i).data.substr(kMozTocLength + 1,</span>
<a href="#l27.81"></a><span id="l27.81" class="difflineminus">-                                    nodeList.item(i).length - kMozTocLength - 1);</span>
<a href="#l27.82"></a><span id="l27.82" class="difflineplus">+        headers = nodeList</span>
<a href="#l27.83"></a><span id="l27.83" class="difflineplus">+          .item(i)</span>
<a href="#l27.84"></a><span id="l27.84" class="difflineplus">+          .data.substr(</span>
<a href="#l27.85"></a><span id="l27.85" class="difflineplus">+            kMozTocLength + 1,</span>
<a href="#l27.86"></a><span id="l27.86" class="difflineplus">+            nodeList.item(i).length - kMozTocLength - 1</span>
<a href="#l27.87"></a><span id="l27.87" class="difflineplus">+          );</span>
<a href="#l27.88"></a><span id="l27.88">         break;</span>
<a href="#l27.89"></a><span id="l27.89">       }</span>
<a href="#l27.90"></a><span id="l27.90">     }</span>
<a href="#l27.91"></a><span id="l27.91">   }</span>
<a href="#l27.92"></a><span id="l27.92"> </span>
<a href="#l27.93"></a><span id="l27.93">   // let's get an array filled with the (tag.class, index level) pairs</span>
<a href="#l27.94"></a><span id="l27.94">   var headersArray = headers.split(&quot; &quot;);</span>
<a href="#l27.95"></a><span id="l27.95"> </span>
<a href="#l27.96"></a><span id="l27.96">   for (i = 0; i &lt; headersArray.length; i += 2) {</span>
<a href="#l27.97"></a><span id="l27.97" class="difflineminus">-    var tag = headersArray[i], className = &quot;&quot;;</span>
<a href="#l27.98"></a><span id="l27.98" class="difflineplus">+    var tag = headersArray[i],</span>
<a href="#l27.99"></a><span id="l27.99" class="difflineplus">+      className = &quot;&quot;;</span>
<a href="#l27.100"></a><span id="l27.100">     var index = headersArray[i + 1];</span>
<a href="#l27.101"></a><span id="l27.101">     menulist = document.getElementById(&quot;header&quot; + index + &quot;Menulist&quot;);</span>
<a href="#l27.102"></a><span id="l27.102">     if (menulist) {</span>
<a href="#l27.103"></a><span id="l27.103">       var sep = tag.indexOf(&quot;.&quot;);</span>
<a href="#l27.104"></a><span id="l27.104">       if (sep != -1) {</span>
<a href="#l27.105"></a><span id="l27.105">         // the tag variable contains in fact &quot;tag.className&quot;, let's parse</span>
<a href="#l27.106"></a><span id="l27.106">         // the class and get the real tag name</span>
<a href="#l27.107"></a><span id="l27.107" class="difflineminus">-        var tmp   = tag.substr(0, sep);</span>
<a href="#l27.108"></a><span id="l27.108" class="difflineplus">+        var tmp = tag.substr(0, sep);</span>
<a href="#l27.109"></a><span id="l27.109">         className = tag.substr(sep + 1, tag.length - sep - 1);</span>
<a href="#l27.110"></a><span id="l27.110">         tag = tmp;</span>
<a href="#l27.111"></a><span id="l27.111">       }</span>
<a href="#l27.112"></a><span id="l27.112"> </span>
<a href="#l27.113"></a><span id="l27.113">       // update the dialog</span>
<a href="#l27.114"></a><span id="l27.114" class="difflineminus">-      menuitem = document.getElementById(&quot;header&quot; + index +</span>
<a href="#l27.115"></a><span id="l27.115" class="difflineminus">-                                         tag.toUpperCase());</span>
<a href="#l27.116"></a><span id="l27.116" class="difflineminus">-      textbox  = document.getElementById(&quot;header&quot; + index + &quot;Class&quot;);</span>
<a href="#l27.117"></a><span id="l27.117" class="difflineplus">+      menuitem = document.getElementById(&quot;header&quot; + index + tag.toUpperCase());</span>
<a href="#l27.118"></a><span id="l27.118" class="difflineplus">+      textbox = document.getElementById(&quot;header&quot; + index + &quot;Class&quot;);</span>
<a href="#l27.119"></a><span id="l27.119">       menulist.selectedItem = menuitem;</span>
<a href="#l27.120"></a><span id="l27.120">       if (tag != &quot;&quot;) {</span>
<a href="#l27.121"></a><span id="l27.121">         textbox.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l27.122"></a><span id="l27.122">       }</span>
<a href="#l27.123"></a><span id="l27.123">       if (className != &quot;&quot;) {</span>
<a href="#l27.124"></a><span id="l27.124">         textbox.value = className;</span>
<a href="#l27.125"></a><span id="l27.125">       }</span>
<a href="#l27.126"></a><span id="l27.126" class="difflineminus">-      tocHeadersArray[index - 1] = [ tag, className ];</span>
<a href="#l27.127"></a><span id="l27.127" class="difflineplus">+      tocHeadersArray[index - 1] = [tag, className];</span>
<a href="#l27.128"></a><span id="l27.128">     }</span>
<a href="#l27.129"></a><span id="l27.129">   }</span>
<a href="#l27.130"></a><span id="l27.130"> }</span>
<a href="#l27.131"></a><span id="l27.131"> </span>
<a href="#l27.132"></a><span id="l27.132" class="difflineminus">-</span>
<a href="#l27.133"></a><span id="l27.133"> function BuildTOC(update) {</span>
<a href="#l27.134"></a><span id="l27.134">   // controlClass() is a node filter that accepts a node if</span>
<a href="#l27.135"></a><span id="l27.135">   // (a) we don't look for a class (b) we look for a class and</span>
<a href="#l27.136"></a><span id="l27.136">   // node has it</span>
<a href="#l27.137"></a><span id="l27.137">   function controlClass(node, index) {</span>
<a href="#l27.138"></a><span id="l27.138">     currentHeaderLevel = index + 1;</span>
<a href="#l27.139"></a><span id="l27.139">     if (tocHeadersArray[index][1] == &quot;&quot;) {</span>
<a href="#l27.140"></a><span id="l27.140">       // we are not looking for a specific class, this node is ok</span>
<a href="#l27.141"></a><span id="l27.141" class="difflineat">@@ -167,55 +173,65 @@ function BuildTOC(update) {</span>
<a href="#l27.142"></a><span id="l27.142">       default:</span>
<a href="#l27.143"></a><span id="l27.143">         return NodeFilter.FILTER_SKIP;</span>
<a href="#l27.144"></a><span id="l27.144">     }</span>
<a href="#l27.145"></a><span id="l27.145">   }</span>
<a href="#l27.146"></a><span id="l27.146"> </span>
<a href="#l27.147"></a><span id="l27.147">   var editor = GetCurrentEditor();</span>
<a href="#l27.148"></a><span id="l27.148">   var theDocument = editor.document;</span>
<a href="#l27.149"></a><span id="l27.149">   // let's create a TreeWalker to look for our nodes</span>
<a href="#l27.150"></a><span id="l27.150" class="difflineminus">-  var treeWalker = theDocument.createTreeWalker(theDocument.documentElement,</span>
<a href="#l27.151"></a><span id="l27.151" class="difflineminus">-                                                NodeFilter.SHOW_ELEMENT,</span>
<a href="#l27.152"></a><span id="l27.152" class="difflineminus">-                                                acceptNode,</span>
<a href="#l27.153"></a><span id="l27.153" class="difflineminus">-                                                true);</span>
<a href="#l27.154"></a><span id="l27.154" class="difflineplus">+  var treeWalker = theDocument.createTreeWalker(</span>
<a href="#l27.155"></a><span id="l27.155" class="difflineplus">+    theDocument.documentElement,</span>
<a href="#l27.156"></a><span id="l27.156" class="difflineplus">+    NodeFilter.SHOW_ELEMENT,</span>
<a href="#l27.157"></a><span id="l27.157" class="difflineplus">+    acceptNode,</span>
<a href="#l27.158"></a><span id="l27.158" class="difflineplus">+    true</span>
<a href="#l27.159"></a><span id="l27.159" class="difflineplus">+  );</span>
<a href="#l27.160"></a><span id="l27.160">   // we need an array to store all TOC entries we find in the document</span>
<a href="#l27.161"></a><span id="l27.161">   var tocArray = [];</span>
<a href="#l27.162"></a><span id="l27.162">   if (treeWalker) {</span>
<a href="#l27.163"></a><span id="l27.163">     var tocSourceNode = treeWalker.nextNode();</span>
<a href="#l27.164"></a><span id="l27.164">     while (tocSourceNode) {</span>
<a href="#l27.165"></a><span id="l27.165">       var headerIndex = currentHeaderLevel;</span>
<a href="#l27.166"></a><span id="l27.166"> </span>
<a href="#l27.167"></a><span id="l27.167">       // we have a node, we need to get all its textual contents</span>
<a href="#l27.168"></a><span id="l27.168" class="difflineminus">-      var textTreeWalker = theDocument.createTreeWalker(tocSourceNode,</span>
<a href="#l27.169"></a><span id="l27.169" class="difflineminus">-                                                        NodeFilter.SHOW_TEXT,</span>
<a href="#l27.170"></a><span id="l27.170" class="difflineminus">-                                                        null,</span>
<a href="#l27.171"></a><span id="l27.171" class="difflineminus">-                                                        true);</span>
<a href="#l27.172"></a><span id="l27.172" class="difflineminus">-      var textNode = textTreeWalker.nextNode(), headerText = &quot;&quot;;</span>
<a href="#l27.173"></a><span id="l27.173" class="difflineplus">+      var textTreeWalker = theDocument.createTreeWalker(</span>
<a href="#l27.174"></a><span id="l27.174" class="difflineplus">+        tocSourceNode,</span>
<a href="#l27.175"></a><span id="l27.175" class="difflineplus">+        NodeFilter.SHOW_TEXT,</span>
<a href="#l27.176"></a><span id="l27.176" class="difflineplus">+        null,</span>
<a href="#l27.177"></a><span id="l27.177" class="difflineplus">+        true</span>
<a href="#l27.178"></a><span id="l27.178" class="difflineplus">+      );</span>
<a href="#l27.179"></a><span id="l27.179" class="difflineplus">+      var textNode = textTreeWalker.nextNode(),</span>
<a href="#l27.180"></a><span id="l27.180" class="difflineplus">+        headerText = &quot;&quot;;</span>
<a href="#l27.181"></a><span id="l27.181">       while (textNode) {</span>
<a href="#l27.182"></a><span id="l27.182">         headerText += textNode.data;</span>
<a href="#l27.183"></a><span id="l27.183">         textNode = textTreeWalker.nextNode();</span>
<a href="#l27.184"></a><span id="l27.184">       }</span>
<a href="#l27.185"></a><span id="l27.185"> </span>
<a href="#l27.186"></a><span id="l27.186" class="difflineminus">-      var anchor = tocSourceNode.firstChild, id;</span>
<a href="#l27.187"></a><span id="l27.187" class="difflineplus">+      var anchor = tocSourceNode.firstChild,</span>
<a href="#l27.188"></a><span id="l27.188" class="difflineplus">+        id;</span>
<a href="#l27.189"></a><span id="l27.189">       // do we have a named anchor as 1st child of our node ?</span>
<a href="#l27.190"></a><span id="l27.190" class="difflineminus">-      if (anchor.nodeName.toLowerCase() == &quot;a&quot; &amp;&amp;</span>
<a href="#l27.191"></a><span id="l27.191" class="difflineminus">-          anchor.hasAttribute(&quot;name&quot;) &amp;&amp;</span>
<a href="#l27.192"></a><span id="l27.192" class="difflineminus">-          anchor.getAttribute(&quot;name&quot;).startsWith(kMozTocIdPrefix)) {</span>
<a href="#l27.193"></a><span id="l27.193" class="difflineplus">+      if (</span>
<a href="#l27.194"></a><span id="l27.194" class="difflineplus">+        anchor.nodeName.toLowerCase() == &quot;a&quot; &amp;&amp;</span>
<a href="#l27.195"></a><span id="l27.195" class="difflineplus">+        anchor.hasAttribute(&quot;name&quot;) &amp;&amp;</span>
<a href="#l27.196"></a><span id="l27.196" class="difflineplus">+        anchor.getAttribute(&quot;name&quot;).startsWith(kMozTocIdPrefix)</span>
<a href="#l27.197"></a><span id="l27.197" class="difflineplus">+      ) {</span>
<a href="#l27.198"></a><span id="l27.198">         // yep, get its name</span>
<a href="#l27.199"></a><span id="l27.199">         id = anchor.getAttribute(&quot;name&quot;);</span>
<a href="#l27.200"></a><span id="l27.200">       } else {</span>
<a href="#l27.201"></a><span id="l27.201">         // no we don't and we need to create one</span>
<a href="#l27.202"></a><span id="l27.202">         anchor = theDocument.createElement(&quot;a&quot;);</span>
<a href="#l27.203"></a><span id="l27.203">         tocSourceNode.insertBefore(anchor, tocSourceNode.firstChild);</span>
<a href="#l27.204"></a><span id="l27.204">         // let's give it a random ID</span>
<a href="#l27.205"></a><span id="l27.205">         var c = 1000000 * Math.random();</span>
<a href="#l27.206"></a><span id="l27.206">         id = kMozTocIdPrefix + Math.round(c);</span>
<a href="#l27.207"></a><span id="l27.207">         anchor.setAttribute(&quot;name&quot;, id);</span>
<a href="#l27.208"></a><span id="l27.208" class="difflineminus">-        anchor.setAttribute(&quot;class&quot;, kMozTocClassPrefix +</span>
<a href="#l27.209"></a><span id="l27.209" class="difflineminus">-                                     tocSourceNode.nodeName.toUpperCase());</span>
<a href="#l27.210"></a><span id="l27.210" class="difflineplus">+        anchor.setAttribute(</span>
<a href="#l27.211"></a><span id="l27.211" class="difflineplus">+          &quot;class&quot;,</span>
<a href="#l27.212"></a><span id="l27.212" class="difflineplus">+          kMozTocClassPrefix + tocSourceNode.nodeName.toUpperCase()</span>
<a href="#l27.213"></a><span id="l27.213" class="difflineplus">+        );</span>
<a href="#l27.214"></a><span id="l27.214">       }</span>
<a href="#l27.215"></a><span id="l27.215">       // and store that new entry in our array</span>
<a href="#l27.216"></a><span id="l27.216">       tocArray.push(headerIndex, headerText, id);</span>
<a href="#l27.217"></a><span id="l27.217">       tocSourceNode = treeWalker.nextNode();</span>
<a href="#l27.218"></a><span id="l27.218">     }</span>
<a href="#l27.219"></a><span id="l27.219">   }</span>
<a href="#l27.220"></a><span id="l27.220"> </span>
<a href="#l27.221"></a><span id="l27.221">   /* generate the TOC itself */</span>
<a href="#l27.222"></a><span id="l27.222" class="difflineat">@@ -223,41 +239,46 @@ function BuildTOC(update) {</span>
<a href="#l27.223"></a><span id="l27.223">   var item, toc;</span>
<a href="#l27.224"></a><span id="l27.224">   for (var i = 0; i &lt; tocArray.length; i += 3) {</span>
<a href="#l27.225"></a><span id="l27.225">     if (!headerIndex) {</span>
<a href="#l27.226"></a><span id="l27.226">       // do we need to create an ol/ul container for the first entry ?</span>
<a href="#l27.227"></a><span id="l27.227">       ++headerIndex;</span>
<a href="#l27.228"></a><span id="l27.228">       toc = theDocument.getElementById(kMozToc);</span>
<a href="#l27.229"></a><span id="l27.229">       if (!toc || !update) {</span>
<a href="#l27.230"></a><span id="l27.230">         // we need to create a list container for the table of contents</span>
<a href="#l27.231"></a><span id="l27.231" class="difflineminus">-        toc = GetCurrentEditor().createElementWithDefaults(orderedList ? &quot;ol&quot; : &quot;ul&quot;);</span>
<a href="#l27.232"></a><span id="l27.232" class="difflineplus">+        toc = GetCurrentEditor().createElementWithDefaults(</span>
<a href="#l27.233"></a><span id="l27.233" class="difflineplus">+          orderedList ? &quot;ol&quot; : &quot;ul&quot;</span>
<a href="#l27.234"></a><span id="l27.234" class="difflineplus">+        );</span>
<a href="#l27.235"></a><span id="l27.235">         // grrr, we need to create a LI inside the list otherwise</span>
<a href="#l27.236"></a><span id="l27.236">         // Composer will refuse an empty list and will remove it !</span>
<a href="#l27.237"></a><span id="l27.237">         var pit = theDocument.createElement(&quot;li&quot;);</span>
<a href="#l27.238"></a><span id="l27.238">         toc.appendChild(pit);</span>
<a href="#l27.239"></a><span id="l27.239">         GetCurrentEditor().insertElementAtSelection(toc, true);</span>
<a href="#l27.240"></a><span id="l27.240">         // ah, now it's inserted so let's remove the useless list item...</span>
<a href="#l27.241"></a><span id="l27.241">         toc.removeChild(pit);</span>
<a href="#l27.242"></a><span id="l27.242">         // we need to recognize later that this list is our TOC</span>
<a href="#l27.243"></a><span id="l27.243">         toc.setAttribute(&quot;id&quot;, kMozToc);</span>
<a href="#l27.244"></a><span id="l27.244">       } else if (orderedList != (toc.nodeName.toLowerCase() == &quot;ol&quot;)) {</span>
<a href="#l27.245"></a><span id="l27.245">         // we have to update an existing TOC, is the existing TOC of the</span>
<a href="#l27.246"></a><span id="l27.246">         // desired type (ordered or not) ?</span>
<a href="#l27.247"></a><span id="l27.247"> </span>
<a href="#l27.248"></a><span id="l27.248">         // nope, we have to recreate the list</span>
<a href="#l27.249"></a><span id="l27.249" class="difflineminus">-        var newToc = GetCurrentEditor().createElementWithDefaults(orderedList ? &quot;ol&quot; : &quot;ul&quot;);</span>
<a href="#l27.250"></a><span id="l27.250" class="difflineplus">+        var newToc = GetCurrentEditor().createElementWithDefaults(</span>
<a href="#l27.251"></a><span id="l27.251" class="difflineplus">+          orderedList ? &quot;ol&quot; : &quot;ul&quot;</span>
<a href="#l27.252"></a><span id="l27.252" class="difflineplus">+        );</span>
<a href="#l27.253"></a><span id="l27.253">         toc.parentNode.insertBefore(newToc, toc);</span>
<a href="#l27.254"></a><span id="l27.254">         // and remove the old one</span>
<a href="#l27.255"></a><span id="l27.255">         toc.remove();</span>
<a href="#l27.256"></a><span id="l27.256">         toc = newToc;</span>
<a href="#l27.257"></a><span id="l27.257">         toc.setAttribute(&quot;id&quot;, kMozToc);</span>
<a href="#l27.258"></a><span id="l27.258">       } else {</span>
<a href="#l27.259"></a><span id="l27.259">         // we can keep the list itself but let's get rid of the TOC entries</span>
<a href="#l27.260"></a><span id="l27.260" class="difflineminus">-        while (toc.hasChildNodes())</span>
<a href="#l27.261"></a><span id="l27.261" class="difflineplus">+        while (toc.hasChildNodes()) {</span>
<a href="#l27.262"></a><span id="l27.262">           toc.lastChild.remove();</span>
<a href="#l27.263"></a><span id="l27.263" class="difflineplus">+        }</span>
<a href="#l27.264"></a><span id="l27.264">       }</span>
<a href="#l27.265"></a><span id="l27.265"> </span>
<a href="#l27.266"></a><span id="l27.266">       var commentText = &quot;mozToc &quot;;</span>
<a href="#l27.267"></a><span id="l27.267">       for (var j = 0; j &lt; 6; j++) {</span>
<a href="#l27.268"></a><span id="l27.268">         if (tocHeadersArray[j][0] != &quot;&quot;) {</span>
<a href="#l27.269"></a><span id="l27.269">           commentText += tocHeadersArray[j][0];</span>
<a href="#l27.270"></a><span id="l27.270">           if (tocHeadersArray[j][1] != &quot;&quot;) {</span>
<a href="#l27.271"></a><span id="l27.271">             commentText += &quot;.&quot; + tocHeadersArray[j][1];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdInsertTable.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdInsertTable.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -29,28 +29,33 @@ function Startup() {</span>
<a href="#l28.4"></a><span id="l28.4">     gTableElement = gActiveEditor.createElementWithDefaults(&quot;table&quot;);</span>
<a href="#l28.5"></a><span id="l28.5">   } catch (e) {}</span>
<a href="#l28.6"></a><span id="l28.6"> </span>
<a href="#l28.7"></a><span id="l28.7">   if (!gTableElement) {</span>
<a href="#l28.8"></a><span id="l28.8">     dump(&quot;Failed to create a new table!\n&quot;);</span>
<a href="#l28.9"></a><span id="l28.9">     window.close();</span>
<a href="#l28.10"></a><span id="l28.10">     return;</span>
<a href="#l28.11"></a><span id="l28.11">   }</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-  gDialog.rowsInput    = document.getElementById(&quot;rowsInput&quot;);</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+  gDialog.rowsInput = document.getElementById(&quot;rowsInput&quot;);</span>
<a href="#l28.14"></a><span id="l28.14">   gDialog.columnsInput = document.getElementById(&quot;columnsInput&quot;);</span>
<a href="#l28.15"></a><span id="l28.15">   gDialog.widthInput = document.getElementById(&quot;widthInput&quot;);</span>
<a href="#l28.16"></a><span id="l28.16">   gDialog.borderInput = document.getElementById(&quot;borderInput&quot;);</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineminus">-  gDialog.widthPixelOrPercentMenulist = document.getElementById(&quot;widthPixelOrPercentMenulist&quot;);</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineplus">+  gDialog.widthPixelOrPercentMenulist = document.getElementById(</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineplus">+    &quot;widthPixelOrPercentMenulist&quot;</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineplus">+  );</span>
<a href="#l28.21"></a><span id="l28.21">   gDialog.OkButton = document.documentElement.getButton(&quot;accept&quot;);</span>
<a href="#l28.22"></a><span id="l28.22"> </span>
<a href="#l28.23"></a><span id="l28.23">   // Make a copy to use for AdvancedEdit</span>
<a href="#l28.24"></a><span id="l28.24">   globalElement = gTableElement.cloneNode(false);</span>
<a href="#l28.25"></a><span id="l28.25">   try {</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineminus">-    if (Services.prefs.getBoolPref(&quot;editor.use_css&quot;) &amp;&amp; IsHTMLEditor()</span>
<a href="#l28.27"></a><span id="l28.27" class="difflineminus">-        &amp;&amp; !(gActiveEditor.flags &amp; Ci.nsIPlaintextEditor.eEditorMailMask)) {</span>
<a href="#l28.28"></a><span id="l28.28" class="difflineplus">+    if (</span>
<a href="#l28.29"></a><span id="l28.29" class="difflineplus">+      Services.prefs.getBoolPref(&quot;editor.use_css&quot;) &amp;&amp;</span>
<a href="#l28.30"></a><span id="l28.30" class="difflineplus">+      IsHTMLEditor() &amp;&amp;</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineplus">+      !(gActiveEditor.flags &amp; Ci.nsIPlaintextEditor.eEditorMailMask)</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineplus">+    ) {</span>
<a href="#l28.33"></a><span id="l28.33">       // only for Composer and not for htmlmail</span>
<a href="#l28.34"></a><span id="l28.34">       globalElement.setAttribute(&quot;style&quot;, &quot;text-align: left;&quot;);</span>
<a href="#l28.35"></a><span id="l28.35">     }</span>
<a href="#l28.36"></a><span id="l28.36">   } catch (e) {}</span>
<a href="#l28.37"></a><span id="l28.37"> </span>
<a href="#l28.38"></a><span id="l28.38">   // Initialize all widgets with image attributes</span>
<a href="#l28.39"></a><span id="l28.39">   InitDialog();</span>
<a href="#l28.40"></a><span id="l28.40"> </span>
<a href="#l28.41"></a><span id="l28.41" class="difflineat">@@ -76,60 +81,101 @@ function Startup() {</span>
<a href="#l28.42"></a><span id="l28.42"> // Set dialog widgets with attribute data</span>
<a href="#l28.43"></a><span id="l28.43"> // We get them from globalElement copy so this can be used</span>
<a href="#l28.44"></a><span id="l28.44"> //   by AdvancedEdit(), which is shared by all property dialogs</span>
<a href="#l28.45"></a><span id="l28.45"> function InitDialog() {</span>
<a href="#l28.46"></a><span id="l28.46">   // Get default attributes set on the created table:</span>
<a href="#l28.47"></a><span id="l28.47">   // Get the width attribute of the element, stripping out &quot;%&quot;</span>
<a href="#l28.48"></a><span id="l28.48">   // This sets contents of menu combobox list</span>
<a href="#l28.49"></a><span id="l28.49">   // 2nd param = null: Use current selection to find if parent is table cell or window</span>
<a href="#l28.50"></a><span id="l28.50" class="difflineminus">-  gDialog.widthInput.value = InitPixelOrPercentMenulist(globalElement, null, &quot;width&quot;, &quot;widthPixelOrPercentMenulist&quot;, gPercent);</span>
<a href="#l28.51"></a><span id="l28.51" class="difflineplus">+  gDialog.widthInput.value = InitPixelOrPercentMenulist(</span>
<a href="#l28.52"></a><span id="l28.52" class="difflineplus">+    globalElement,</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineplus">+    null,</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineplus">+    &quot;width&quot;,</span>
<a href="#l28.55"></a><span id="l28.55" class="difflineplus">+    &quot;widthPixelOrPercentMenulist&quot;,</span>
<a href="#l28.56"></a><span id="l28.56" class="difflineplus">+    gPercent</span>
<a href="#l28.57"></a><span id="l28.57" class="difflineplus">+  );</span>
<a href="#l28.58"></a><span id="l28.58">   gDialog.borderInput.value = globalElement.getAttribute(&quot;border&quot;);</span>
<a href="#l28.59"></a><span id="l28.59"> }</span>
<a href="#l28.60"></a><span id="l28.60"> </span>
<a href="#l28.61"></a><span id="l28.61"> function ChangeRowOrColumn(id) {</span>
<a href="#l28.62"></a><span id="l28.62">   // Allow only integers</span>
<a href="#l28.63"></a><span id="l28.63">   forceInteger(id);</span>
<a href="#l28.64"></a><span id="l28.64"> </span>
<a href="#l28.65"></a><span id="l28.65">   // Enable OK only if both rows and columns have a value &gt; 0</span>
<a href="#l28.66"></a><span id="l28.66" class="difflineminus">-  var enable = gDialog.rowsInput.value.length &gt; 0 &amp;&amp;</span>
<a href="#l28.67"></a><span id="l28.67" class="difflineminus">-                              gDialog.rowsInput.value &gt; 0 &amp;&amp;</span>
<a href="#l28.68"></a><span id="l28.68" class="difflineminus">-                              gDialog.columnsInput.value.length &gt; 0 &amp;&amp;</span>
<a href="#l28.69"></a><span id="l28.69" class="difflineminus">-                              gDialog.columnsInput.value &gt; 0;</span>
<a href="#l28.70"></a><span id="l28.70" class="difflineplus">+  var enable =</span>
<a href="#l28.71"></a><span id="l28.71" class="difflineplus">+    gDialog.rowsInput.value.length &gt; 0 &amp;&amp;</span>
<a href="#l28.72"></a><span id="l28.72" class="difflineplus">+    gDialog.rowsInput.value &gt; 0 &amp;&amp;</span>
<a href="#l28.73"></a><span id="l28.73" class="difflineplus">+    gDialog.columnsInput.value.length &gt; 0 &amp;&amp;</span>
<a href="#l28.74"></a><span id="l28.74" class="difflineplus">+    gDialog.columnsInput.value &gt; 0;</span>
<a href="#l28.75"></a><span id="l28.75"> </span>
<a href="#l28.76"></a><span id="l28.76">   SetElementEnabled(gDialog.OkButton, enable);</span>
<a href="#l28.77"></a><span id="l28.77">   SetElementEnabledById(&quot;AdvancedEditButton1&quot;, enable);</span>
<a href="#l28.78"></a><span id="l28.78"> }</span>
<a href="#l28.79"></a><span id="l28.79"> </span>
<a href="#l28.80"></a><span id="l28.80" class="difflineminus">-</span>
<a href="#l28.81"></a><span id="l28.81"> // Get and validate data from widgets.</span>
<a href="#l28.82"></a><span id="l28.82"> // Set attributes on globalElement so they can be accessed by AdvancedEdit()</span>
<a href="#l28.83"></a><span id="l28.83"> function ValidateData() {</span>
<a href="#l28.84"></a><span id="l28.84" class="difflineminus">-  gRows = ValidateNumber(gDialog.rowsInput, null, 1, gMaxRows, null, null, true);</span>
<a href="#l28.85"></a><span id="l28.85" class="difflineminus">-  if (gValidationError)</span>
<a href="#l28.86"></a><span id="l28.86" class="difflineplus">+  gRows = ValidateNumber(</span>
<a href="#l28.87"></a><span id="l28.87" class="difflineplus">+    gDialog.rowsInput,</span>
<a href="#l28.88"></a><span id="l28.88" class="difflineplus">+    null,</span>
<a href="#l28.89"></a><span id="l28.89" class="difflineplus">+    1,</span>
<a href="#l28.90"></a><span id="l28.90" class="difflineplus">+    gMaxRows,</span>
<a href="#l28.91"></a><span id="l28.91" class="difflineplus">+    null,</span>
<a href="#l28.92"></a><span id="l28.92" class="difflineplus">+    null,</span>
<a href="#l28.93"></a><span id="l28.93" class="difflineplus">+    true</span>
<a href="#l28.94"></a><span id="l28.94" class="difflineplus">+  );</span>
<a href="#l28.95"></a><span id="l28.95" class="difflineplus">+  if (gValidationError) {</span>
<a href="#l28.96"></a><span id="l28.96">     return false;</span>
<a href="#l28.97"></a><span id="l28.97" class="difflineplus">+  }</span>
<a href="#l28.98"></a><span id="l28.98"> </span>
<a href="#l28.99"></a><span id="l28.99" class="difflineminus">-  gColumns = ValidateNumber(gDialog.columnsInput, null, 1, gMaxColumns, null, null, true);</span>
<a href="#l28.100"></a><span id="l28.100" class="difflineminus">-  if (gValidationError)</span>
<a href="#l28.101"></a><span id="l28.101" class="difflineplus">+  gColumns = ValidateNumber(</span>
<a href="#l28.102"></a><span id="l28.102" class="difflineplus">+    gDialog.columnsInput,</span>
<a href="#l28.103"></a><span id="l28.103" class="difflineplus">+    null,</span>
<a href="#l28.104"></a><span id="l28.104" class="difflineplus">+    1,</span>
<a href="#l28.105"></a><span id="l28.105" class="difflineplus">+    gMaxColumns,</span>
<a href="#l28.106"></a><span id="l28.106" class="difflineplus">+    null,</span>
<a href="#l28.107"></a><span id="l28.107" class="difflineplus">+    null,</span>
<a href="#l28.108"></a><span id="l28.108" class="difflineplus">+    true</span>
<a href="#l28.109"></a><span id="l28.109" class="difflineplus">+  );</span>
<a href="#l28.110"></a><span id="l28.110" class="difflineplus">+  if (gValidationError) {</span>
<a href="#l28.111"></a><span id="l28.111">     return false;</span>
<a href="#l28.112"></a><span id="l28.112" class="difflineplus">+  }</span>
<a href="#l28.113"></a><span id="l28.113"> </span>
<a href="#l28.114"></a><span id="l28.114">   // Set attributes: NOTE: These may be empty strings (last param = false)</span>
<a href="#l28.115"></a><span id="l28.115" class="difflineminus">-  ValidateNumber(gDialog.borderInput, null, 0, gMaxPixels, globalElement, &quot;border&quot;, false);</span>
<a href="#l28.116"></a><span id="l28.116" class="difflineplus">+  ValidateNumber(</span>
<a href="#l28.117"></a><span id="l28.117" class="difflineplus">+    gDialog.borderInput,</span>
<a href="#l28.118"></a><span id="l28.118" class="difflineplus">+    null,</span>
<a href="#l28.119"></a><span id="l28.119" class="difflineplus">+    0,</span>
<a href="#l28.120"></a><span id="l28.120" class="difflineplus">+    gMaxPixels,</span>
<a href="#l28.121"></a><span id="l28.121" class="difflineplus">+    globalElement,</span>
<a href="#l28.122"></a><span id="l28.122" class="difflineplus">+    &quot;border&quot;,</span>
<a href="#l28.123"></a><span id="l28.123" class="difflineplus">+    false</span>
<a href="#l28.124"></a><span id="l28.124" class="difflineplus">+  );</span>
<a href="#l28.125"></a><span id="l28.125">   // TODO: Deal with &quot;BORDER&quot; without value issue</span>
<a href="#l28.126"></a><span id="l28.126" class="difflineminus">-  if (gValidationError) return false;</span>
<a href="#l28.127"></a><span id="l28.127" class="difflineplus">+  if (gValidationError) {</span>
<a href="#l28.128"></a><span id="l28.128" class="difflineplus">+    return false;</span>
<a href="#l28.129"></a><span id="l28.129" class="difflineplus">+  }</span>
<a href="#l28.130"></a><span id="l28.130"> </span>
<a href="#l28.131"></a><span id="l28.131" class="difflineminus">-  ValidateNumber(gDialog.widthInput, gDialog.widthPixelOrPercentMenulist,</span>
<a href="#l28.132"></a><span id="l28.132" class="difflineminus">-                 1, gMaxTableSize, globalElement, &quot;width&quot;, false);</span>
<a href="#l28.133"></a><span id="l28.133" class="difflineminus">-  if (gValidationError)</span>
<a href="#l28.134"></a><span id="l28.134" class="difflineplus">+  ValidateNumber(</span>
<a href="#l28.135"></a><span id="l28.135" class="difflineplus">+    gDialog.widthInput,</span>
<a href="#l28.136"></a><span id="l28.136" class="difflineplus">+    gDialog.widthPixelOrPercentMenulist,</span>
<a href="#l28.137"></a><span id="l28.137" class="difflineplus">+    1,</span>
<a href="#l28.138"></a><span id="l28.138" class="difflineplus">+    gMaxTableSize,</span>
<a href="#l28.139"></a><span id="l28.139" class="difflineplus">+    globalElement,</span>
<a href="#l28.140"></a><span id="l28.140" class="difflineplus">+    &quot;width&quot;,</span>
<a href="#l28.141"></a><span id="l28.141" class="difflineplus">+    false</span>
<a href="#l28.142"></a><span id="l28.142" class="difflineplus">+  );</span>
<a href="#l28.143"></a><span id="l28.143" class="difflineplus">+  if (gValidationError) {</span>
<a href="#l28.144"></a><span id="l28.144">     return false;</span>
<a href="#l28.145"></a><span id="l28.145" class="difflineplus">+  }</span>
<a href="#l28.146"></a><span id="l28.146"> </span>
<a href="#l28.147"></a><span id="l28.147">   return true;</span>
<a href="#l28.148"></a><span id="l28.148"> }</span>
<a href="#l28.149"></a><span id="l28.149"> </span>
<a href="#l28.150"></a><span id="l28.150" class="difflineminus">-</span>
<a href="#l28.151"></a><span id="l28.151"> function onAccept(event) {</span>
<a href="#l28.152"></a><span id="l28.152">   if (ValidateData()) {</span>
<a href="#l28.153"></a><span id="l28.153">     gActiveEditor.beginTransaction();</span>
<a href="#l28.154"></a><span id="l28.154">     try {</span>
<a href="#l28.155"></a><span id="l28.155">       gActiveEditor.cloneAttributes(gTableElement, globalElement);</span>
<a href="#l28.156"></a><span id="l28.156"> </span>
<a href="#l28.157"></a><span id="l28.157">       // Create necessary rows and cells for the table</span>
<a href="#l28.158"></a><span id="l28.158">       var tableBody = gActiveEditor.createElementWithDefaults(&quot;tbody&quot;);</span>
<a href="#l28.159"></a><span id="l28.159" class="difflineat">@@ -146,20 +192,23 @@ function onAccept(event) {</span>
<a href="#l28.160"></a><span id="l28.160">               if (newCell) {</span>
<a href="#l28.161"></a><span id="l28.161">                 newRow.appendChild(newCell);</span>
<a href="#l28.162"></a><span id="l28.162">               }</span>
<a href="#l28.163"></a><span id="l28.163">             }</span>
<a href="#l28.164"></a><span id="l28.164">           }</span>
<a href="#l28.165"></a><span id="l28.165">         }</span>
<a href="#l28.166"></a><span id="l28.166">       }</span>
<a href="#l28.167"></a><span id="l28.167">       // Detect when entire cells are selected:</span>
<a href="#l28.168"></a><span id="l28.168" class="difflineminus">-        // Get number of cells selected</span>
<a href="#l28.169"></a><span id="l28.169" class="difflineplus">+      // Get number of cells selected</span>
<a href="#l28.170"></a><span id="l28.170">       var tagNameObj = { value: &quot;&quot; };</span>
<a href="#l28.171"></a><span id="l28.171">       var countObj = { value: 0 };</span>
<a href="#l28.172"></a><span id="l28.172" class="difflineminus">-      var element = gActiveEditor.getSelectedOrParentTableElement(tagNameObj, countObj);</span>
<a href="#l28.173"></a><span id="l28.173" class="difflineplus">+      var element = gActiveEditor.getSelectedOrParentTableElement(</span>
<a href="#l28.174"></a><span id="l28.174" class="difflineplus">+        tagNameObj,</span>
<a href="#l28.175"></a><span id="l28.175" class="difflineplus">+        countObj</span>
<a href="#l28.176"></a><span id="l28.176" class="difflineplus">+      );</span>
<a href="#l28.177"></a><span id="l28.177">       var deletePlaceholder = false;</span>
<a href="#l28.178"></a><span id="l28.178"> </span>
<a href="#l28.179"></a><span id="l28.179">       if (tagNameObj.value == &quot;table&quot;) {</span>
<a href="#l28.180"></a><span id="l28.180">         // Replace entire selected table with new table, so delete the table</span>
<a href="#l28.181"></a><span id="l28.181">         gActiveEditor.deleteTable();</span>
<a href="#l28.182"></a><span id="l28.182">       } else if (tagNameObj.value == &quot;td&quot;) {</span>
<a href="#l28.183"></a><span id="l28.183">         if (countObj.value &gt;= 1) {</span>
<a href="#l28.184"></a><span id="l28.184">           if (countObj.value &gt; 1) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdLabelProps.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdLabelProps.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -35,19 +35,26 @@ function Startup() {</span>
<a href="#l29.4"></a><span id="l29.4">   var range = editor.document.createRange();</span>
<a href="#l29.5"></a><span id="l29.5">   range.selectNode(labelElement);</span>
<a href="#l29.6"></a><span id="l29.6">   gDialog.labelText.value = range.toString();</span>
<a href="#l29.7"></a><span id="l29.7"> </span>
<a href="#l29.8"></a><span id="l29.8">   if (labelElement.innerHTML.includes(&quot;&lt;&quot;)) {</span>
<a href="#l29.9"></a><span id="l29.9">     gDialog.editText.checked = false;</span>
<a href="#l29.10"></a><span id="l29.10">     gDialog.editText.disabled = false;</span>
<a href="#l29.11"></a><span id="l29.11">     gDialog.labelText.disabled = true;</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-    gDialog.editText.addEventListener(&quot;command&quot;,</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineminus">-      () =&gt; Services.prompt.alert(window, GetString(&quot;Alert&quot;), GetString(&quot;EditTextWarning&quot;)),</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineminus">-      {capture: false, once: true});</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineplus">+    gDialog.editText.addEventListener(</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineplus">+      &quot;command&quot;,</span>
<a href="#l29.17"></a><span id="l29.17" class="difflineplus">+      () =&gt;</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineplus">+        Services.prompt.alert(</span>
<a href="#l29.19"></a><span id="l29.19" class="difflineplus">+          window,</span>
<a href="#l29.20"></a><span id="l29.20" class="difflineplus">+          GetString(&quot;Alert&quot;),</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineplus">+          GetString(&quot;EditTextWarning&quot;)</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineplus">+        ),</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineplus">+      { capture: false, once: true }</span>
<a href="#l29.24"></a><span id="l29.24" class="difflineplus">+    );</span>
<a href="#l29.25"></a><span id="l29.25">     SetTextboxFocus(gDialog.labelFor);</span>
<a href="#l29.26"></a><span id="l29.26">   } else {</span>
<a href="#l29.27"></a><span id="l29.27">     SetTextboxFocus(gDialog.labelText);</span>
<a href="#l29.28"></a><span id="l29.28">   }</span>
<a href="#l29.29"></a><span id="l29.29"> </span>
<a href="#l29.30"></a><span id="l29.30">   SetWindowLocation();</span>
<a href="#l29.31"></a><span id="l29.31"> }</span>
<a href="#l29.32"></a><span id="l29.32"> </span>
<a href="#l29.33"></a><span id="l29.33" class="difflineat">@@ -58,47 +65,54 @@ function InitDialog() {</span>
<a href="#l29.34"></a><span id="l29.34"> </span>
<a href="#l29.35"></a><span id="l29.35"> function RemoveLabel() {</span>
<a href="#l29.36"></a><span id="l29.36">   RemoveContainer(labelElement);</span>
<a href="#l29.37"></a><span id="l29.37">   SaveWindowLocation();</span>
<a href="#l29.38"></a><span id="l29.38">   window.close();</span>
<a href="#l29.39"></a><span id="l29.39"> }</span>
<a href="#l29.40"></a><span id="l29.40"> </span>
<a href="#l29.41"></a><span id="l29.41"> function ValidateData() {</span>
<a href="#l29.42"></a><span id="l29.42" class="difflineminus">-  if (gDialog.labelFor.value)</span>
<a href="#l29.43"></a><span id="l29.43" class="difflineplus">+  if (gDialog.labelFor.value) {</span>
<a href="#l29.44"></a><span id="l29.44">     globalElement.setAttribute(&quot;for&quot;, gDialog.labelFor.value);</span>
<a href="#l29.45"></a><span id="l29.45" class="difflineminus">-  else</span>
<a href="#l29.46"></a><span id="l29.46" class="difflineplus">+  } else {</span>
<a href="#l29.47"></a><span id="l29.47">     globalElement.removeAttribute(&quot;for&quot;);</span>
<a href="#l29.48"></a><span id="l29.48" class="difflineminus">-  if (gDialog.labelAccessKey.value)</span>
<a href="#l29.49"></a><span id="l29.49" class="difflineplus">+  }</span>
<a href="#l29.50"></a><span id="l29.50" class="difflineplus">+  if (gDialog.labelAccessKey.value) {</span>
<a href="#l29.51"></a><span id="l29.51">     globalElement.setAttribute(&quot;accesskey&quot;, gDialog.labelAccessKey.value);</span>
<a href="#l29.52"></a><span id="l29.52" class="difflineminus">-  else</span>
<a href="#l29.53"></a><span id="l29.53" class="difflineplus">+  } else {</span>
<a href="#l29.54"></a><span id="l29.54">     globalElement.removeAttribute(&quot;accesskey&quot;);</span>
<a href="#l29.55"></a><span id="l29.55" class="difflineplus">+  }</span>
<a href="#l29.56"></a><span id="l29.56">   return true;</span>
<a href="#l29.57"></a><span id="l29.57"> }</span>
<a href="#l29.58"></a><span id="l29.58"> </span>
<a href="#l29.59"></a><span id="l29.59"> function onAccept() {</span>
<a href="#l29.60"></a><span id="l29.60">   // All values are valid - copy to actual element in doc</span>
<a href="#l29.61"></a><span id="l29.61">   ValidateData();</span>
<a href="#l29.62"></a><span id="l29.62"> </span>
<a href="#l29.63"></a><span id="l29.63">   var editor = GetCurrentEditor();</span>
<a href="#l29.64"></a><span id="l29.64"> </span>
<a href="#l29.65"></a><span id="l29.65">   editor.beginTransaction();</span>
<a href="#l29.66"></a><span id="l29.66"> </span>
<a href="#l29.67"></a><span id="l29.67">   try {</span>
<a href="#l29.68"></a><span id="l29.68">     if (gDialog.editText.checked) {</span>
<a href="#l29.69"></a><span id="l29.69">       editor.setShouldTxnSetSelection(false);</span>
<a href="#l29.70"></a><span id="l29.70"> </span>
<a href="#l29.71"></a><span id="l29.71" class="difflineminus">-      while (labelElement.firstChild)</span>
<a href="#l29.72"></a><span id="l29.72" class="difflineplus">+      while (labelElement.firstChild) {</span>
<a href="#l29.73"></a><span id="l29.73">         editor.deleteNode(labelElement.firstChild);</span>
<a href="#l29.74"></a><span id="l29.74" class="difflineminus">-      if (gDialog.labelText.value)</span>
<a href="#l29.75"></a><span id="l29.75" class="difflineminus">-        editor.insertNode(editor.document.createTextNode(gDialog.labelText.value), labelElement, 0);</span>
<a href="#l29.76"></a><span id="l29.76" class="difflineplus">+      }</span>
<a href="#l29.77"></a><span id="l29.77" class="difflineplus">+      if (gDialog.labelText.value) {</span>
<a href="#l29.78"></a><span id="l29.78" class="difflineplus">+        editor.insertNode(</span>
<a href="#l29.79"></a><span id="l29.79" class="difflineplus">+          editor.document.createTextNode(gDialog.labelText.value),</span>
<a href="#l29.80"></a><span id="l29.80" class="difflineplus">+          labelElement,</span>
<a href="#l29.81"></a><span id="l29.81" class="difflineplus">+          0</span>
<a href="#l29.82"></a><span id="l29.82" class="difflineplus">+        );</span>
<a href="#l29.83"></a><span id="l29.83" class="difflineplus">+      }</span>
<a href="#l29.84"></a><span id="l29.84"> </span>
<a href="#l29.85"></a><span id="l29.85">       editor.setShouldTxnSetSelection(true);</span>
<a href="#l29.86"></a><span id="l29.86">     }</span>
<a href="#l29.87"></a><span id="l29.87"> </span>
<a href="#l29.88"></a><span id="l29.88">     editor.cloneAttributes(labelElement, globalElement);</span>
<a href="#l29.89"></a><span id="l29.89">   } catch (e) {}</span>
<a href="#l29.90"></a><span id="l29.90"> </span>
<a href="#l29.91"></a><span id="l29.91">   editor.endTransaction();</span>
<a href="#l29.92"></a><span id="l29.92"> </span>
<a href="#l29.93"></a><span id="l29.93">   SaveWindowLocation();</span>
<a href="#l29.94"></a><span id="l29.94"> }</span>
<a href="#l29.95"></a><span id="l29.95" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdLinkProps.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdLinkProps.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -32,29 +32,32 @@ document.addEventListener(&quot;dialogcancel&quot;</span>
<a href="#l30.4"></a><span id="l30.4"> function Startup() {</span>
<a href="#l30.5"></a><span id="l30.5">   gActiveEditor = GetCurrentEditor();</span>
<a href="#l30.6"></a><span id="l30.6">   if (!gActiveEditor) {</span>
<a href="#l30.7"></a><span id="l30.7">     dump(&quot;Failed to get active editor!\n&quot;);</span>
<a href="#l30.8"></a><span id="l30.8">     window.close();</span>
<a href="#l30.9"></a><span id="l30.9">     return;</span>
<a href="#l30.10"></a><span id="l30.10">   }</span>
<a href="#l30.11"></a><span id="l30.11">   // Message was wrapped in a &lt;label&gt; or &lt;div&gt;, so actual text is a child text node</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-  gDialog.linkTextCaption     = document.getElementById(&quot;linkTextCaption&quot;);</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-  gDialog.linkTextMessage     = document.getElementById(&quot;linkTextMessage&quot;);</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineminus">-  gDialog.linkTextInput       = document.getElementById(&quot;linkTextInput&quot;);</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineminus">-  gDialog.hrefInput           = document.getElementById(&quot;hrefInput&quot;);</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineminus">-  gDialog.makeRelativeLink    = document.getElementById(&quot;MakeRelativeLink&quot;);</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineplus">+  gDialog.linkTextCaption = document.getElementById(&quot;linkTextCaption&quot;);</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineplus">+  gDialog.linkTextMessage = document.getElementById(&quot;linkTextMessage&quot;);</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineplus">+  gDialog.linkTextInput = document.getElementById(&quot;linkTextInput&quot;);</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineplus">+  gDialog.hrefInput = document.getElementById(&quot;hrefInput&quot;);</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineplus">+  gDialog.makeRelativeLink = document.getElementById(&quot;MakeRelativeLink&quot;);</span>
<a href="#l30.22"></a><span id="l30.22">   gDialog.AdvancedEditSection = document.getElementById(&quot;AdvancedEdit&quot;);</span>
<a href="#l30.23"></a><span id="l30.23"> </span>
<a href="#l30.24"></a><span id="l30.24">   // See if we have a single selected image</span>
<a href="#l30.25"></a><span id="l30.25">   imageElement = gActiveEditor.getSelectedElement(&quot;img&quot;);</span>
<a href="#l30.26"></a><span id="l30.26"> </span>
<a href="#l30.27"></a><span id="l30.27">   if (imageElement) {</span>
<a href="#l30.28"></a><span id="l30.28">     // Get the parent link if it exists -- more efficient than GetSelectedElement()</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineminus">-    anchorElement = gActiveEditor.getElementOrParentByTagName(&quot;href&quot;, imageElement);</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineplus">+    anchorElement = gActiveEditor.getElementOrParentByTagName(</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineplus">+      &quot;href&quot;,</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineplus">+      imageElement</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineplus">+    );</span>
<a href="#l30.34"></a><span id="l30.34">     if (anchorElement) {</span>
<a href="#l30.35"></a><span id="l30.35">       if (anchorElement.childNodes.length &gt; 1) {</span>
<a href="#l30.36"></a><span id="l30.36">         // If there are other children, then we want to break</span>
<a href="#l30.37"></a><span id="l30.37">         //  this image away by inserting a new link around it,</span>
<a href="#l30.38"></a><span id="l30.38">         //  so make a new node and copy existing attributes</span>
<a href="#l30.39"></a><span id="l30.39">         anchorElement = anchorElement.cloneNode(false);</span>
<a href="#l30.40"></a><span id="l30.40">         // insertNew = true;</span>
<a href="#l30.41"></a><span id="l30.41">         replaceExistingLink = true;</span>
<a href="#l30.42"></a><span id="l30.42" class="difflineat">@@ -71,19 +74,26 @@ function Startup() {</span>
<a href="#l30.43"></a><span id="l30.43">     } else {</span>
<a href="#l30.44"></a><span id="l30.44">       // If selection starts in a link, but extends beyond it,</span>
<a href="#l30.45"></a><span id="l30.45">       //   the user probably wants to extend existing link to new selection,</span>
<a href="#l30.46"></a><span id="l30.46">       //   so check if either end of selection is within a link</span>
<a href="#l30.47"></a><span id="l30.47">       // POTENTIAL PROBLEM: This prevents user from selecting text in an existing</span>
<a href="#l30.48"></a><span id="l30.48">       //   link and making 2 links.</span>
<a href="#l30.49"></a><span id="l30.49">       // Note that this isn't a problem with images, handled above</span>
<a href="#l30.50"></a><span id="l30.50"> </span>
<a href="#l30.51"></a><span id="l30.51" class="difflineminus">-      anchorElement = gActiveEditor.getElementOrParentByTagName(&quot;href&quot;, gActiveEditor.selection.anchorNode);</span>
<a href="#l30.52"></a><span id="l30.52" class="difflineminus">-      if (!anchorElement)</span>
<a href="#l30.53"></a><span id="l30.53" class="difflineminus">-        anchorElement = gActiveEditor.getElementOrParentByTagName(&quot;href&quot;, gActiveEditor.selection.focusNode);</span>
<a href="#l30.54"></a><span id="l30.54" class="difflineplus">+      anchorElement = gActiveEditor.getElementOrParentByTagName(</span>
<a href="#l30.55"></a><span id="l30.55" class="difflineplus">+        &quot;href&quot;,</span>
<a href="#l30.56"></a><span id="l30.56" class="difflineplus">+        gActiveEditor.selection.anchorNode</span>
<a href="#l30.57"></a><span id="l30.57" class="difflineplus">+      );</span>
<a href="#l30.58"></a><span id="l30.58" class="difflineplus">+      if (!anchorElement) {</span>
<a href="#l30.59"></a><span id="l30.59" class="difflineplus">+        anchorElement = gActiveEditor.getElementOrParentByTagName(</span>
<a href="#l30.60"></a><span id="l30.60" class="difflineplus">+          &quot;href&quot;,</span>
<a href="#l30.61"></a><span id="l30.61" class="difflineplus">+          gActiveEditor.selection.focusNode</span>
<a href="#l30.62"></a><span id="l30.62" class="difflineplus">+        );</span>
<a href="#l30.63"></a><span id="l30.63" class="difflineplus">+      }</span>
<a href="#l30.64"></a><span id="l30.64"> </span>
<a href="#l30.65"></a><span id="l30.65">       if (anchorElement) {</span>
<a href="#l30.66"></a><span id="l30.66">         // But clone it for reinserting/merging around existing</span>
<a href="#l30.67"></a><span id="l30.67">         //   link that only partially overlaps the selection</span>
<a href="#l30.68"></a><span id="l30.68">         anchorElement = anchorElement.cloneNode(false);</span>
<a href="#l30.69"></a><span id="l30.69">         // insertNew = true;</span>
<a href="#l30.70"></a><span id="l30.70">         replaceExistingLink = true;</span>
<a href="#l30.71"></a><span id="l30.71">       }</span>
<a href="#l30.72"></a><span id="l30.72" class="difflineat">@@ -108,17 +118,20 @@ function Startup() {</span>
<a href="#l30.73"></a><span id="l30.73"> </span>
<a href="#l30.74"></a><span id="l30.74">   var selectedText;</span>
<a href="#l30.75"></a><span id="l30.75">   if (insertLinkAtCaret) {</span>
<a href="#l30.76"></a><span id="l30.76">     // Groupbox caption:</span>
<a href="#l30.77"></a><span id="l30.77">     gDialog.linkTextCaption.setAttribute(&quot;label&quot;, GetString(&quot;LinkText&quot;));</span>
<a href="#l30.78"></a><span id="l30.78"> </span>
<a href="#l30.79"></a><span id="l30.79">     // Message above input field:</span>
<a href="#l30.80"></a><span id="l30.80">     gDialog.linkTextMessage.setAttribute(&quot;value&quot;, GetString(&quot;EnterLinkText&quot;));</span>
<a href="#l30.81"></a><span id="l30.81" class="difflineminus">-    gDialog.linkTextMessage.setAttribute(&quot;accesskey&quot;, GetString(&quot;EnterLinkTextAccessKey&quot;));</span>
<a href="#l30.82"></a><span id="l30.82" class="difflineplus">+    gDialog.linkTextMessage.setAttribute(</span>
<a href="#l30.83"></a><span id="l30.83" class="difflineplus">+      &quot;accesskey&quot;,</span>
<a href="#l30.84"></a><span id="l30.84" class="difflineplus">+      GetString(&quot;EnterLinkTextAccessKey&quot;)</span>
<a href="#l30.85"></a><span id="l30.85" class="difflineplus">+    );</span>
<a href="#l30.86"></a><span id="l30.86">   } else {</span>
<a href="#l30.87"></a><span id="l30.87">     if (!imageElement) {</span>
<a href="#l30.88"></a><span id="l30.88">       // We get here if selection is exactly around a link node</span>
<a href="#l30.89"></a><span id="l30.89">       // Check if selection has some text - use that first</span>
<a href="#l30.90"></a><span id="l30.90">       selectedText = GetSelectionAsText();</span>
<a href="#l30.91"></a><span id="l30.91">       if (!selectedText) {</span>
<a href="#l30.92"></a><span id="l30.92">         // No text, look for first image in the selection</span>
<a href="#l30.93"></a><span id="l30.93">         var children = anchorElement.childNodes;</span>
<a href="#l30.94"></a><span id="l30.94" class="difflineat">@@ -138,19 +151,29 @@ function Startup() {</span>
<a href="#l30.95"></a><span id="l30.95">       gDialog.linkTextCaption.setAttribute(&quot;label&quot;, GetString(&quot;LinkImage&quot;));</span>
<a href="#l30.96"></a><span id="l30.96">       // Link source string is the source URL of image</span>
<a href="#l30.97"></a><span id="l30.97">       // TODO: THIS DOESN'T HANDLE MULTIPLE SELECTED IMAGES!</span>
<a href="#l30.98"></a><span id="l30.98">       gDialog.linkTextMessage.setAttribute(&quot;value&quot;, imageElement.src);</span>
<a href="#l30.99"></a><span id="l30.99">     } else {</span>
<a href="#l30.100"></a><span id="l30.100">       gDialog.linkTextCaption.setAttribute(&quot;label&quot;, GetString(&quot;LinkText&quot;));</span>
<a href="#l30.101"></a><span id="l30.101">       if (selectedText) {</span>
<a href="#l30.102"></a><span id="l30.102">         // Use just the first 60 characters and add &quot;...&quot;</span>
<a href="#l30.103"></a><span id="l30.103" class="difflineminus">-        gDialog.linkTextMessage.setAttribute(&quot;value&quot;, TruncateStringAtWordEnd(ReplaceWhitespace(selectedText, &quot; &quot;), 60, true));</span>
<a href="#l30.104"></a><span id="l30.104" class="difflineplus">+        gDialog.linkTextMessage.setAttribute(</span>
<a href="#l30.105"></a><span id="l30.105" class="difflineplus">+          &quot;value&quot;,</span>
<a href="#l30.106"></a><span id="l30.106" class="difflineplus">+          TruncateStringAtWordEnd(</span>
<a href="#l30.107"></a><span id="l30.107" class="difflineplus">+            ReplaceWhitespace(selectedText, &quot; &quot;),</span>
<a href="#l30.108"></a><span id="l30.108" class="difflineplus">+            60,</span>
<a href="#l30.109"></a><span id="l30.109" class="difflineplus">+            true</span>
<a href="#l30.110"></a><span id="l30.110" class="difflineplus">+          )</span>
<a href="#l30.111"></a><span id="l30.111" class="difflineplus">+        );</span>
<a href="#l30.112"></a><span id="l30.112">       } else {</span>
<a href="#l30.113"></a><span id="l30.113" class="difflineminus">-        gDialog.linkTextMessage.setAttribute(&quot;value&quot;, GetString(&quot;MixedSelection&quot;));</span>
<a href="#l30.114"></a><span id="l30.114" class="difflineplus">+        gDialog.linkTextMessage.setAttribute(</span>
<a href="#l30.115"></a><span id="l30.115" class="difflineplus">+          &quot;value&quot;,</span>
<a href="#l30.116"></a><span id="l30.116" class="difflineplus">+          GetString(&quot;MixedSelection&quot;)</span>
<a href="#l30.117"></a><span id="l30.117" class="difflineplus">+        );</span>
<a href="#l30.118"></a><span id="l30.118">       }</span>
<a href="#l30.119"></a><span id="l30.119">     }</span>
<a href="#l30.120"></a><span id="l30.120">   }</span>
<a href="#l30.121"></a><span id="l30.121"> </span>
<a href="#l30.122"></a><span id="l30.122">   // Make a copy to use for AdvancedEdit and onSaveDefault</span>
<a href="#l30.123"></a><span id="l30.123">   globalElement = anchorElement.cloneNode(false);</span>
<a href="#l30.124"></a><span id="l30.124"> </span>
<a href="#l30.125"></a><span id="l30.125">   // Get the list of existing named anchors and headings</span>
<a href="#l30.126"></a><span id="l30.126" class="difflineat">@@ -160,18 +183,19 @@ function Startup() {</span>
<a href="#l30.127"></a><span id="l30.127">   gHaveDocumentUrl = GetDocumentBaseUrl();</span>
<a href="#l30.128"></a><span id="l30.128"> </span>
<a href="#l30.129"></a><span id="l30.129">   // Set data for the dialog controls</span>
<a href="#l30.130"></a><span id="l30.130">   InitDialog();</span>
<a href="#l30.131"></a><span id="l30.131"> </span>
<a href="#l30.132"></a><span id="l30.132">   // Search for a URI pattern in the selected text</span>
<a href="#l30.133"></a><span id="l30.133">   //  as candidate href</span>
<a href="#l30.134"></a><span id="l30.134">   selectedText = TrimString(selectedText);</span>
<a href="#l30.135"></a><span id="l30.135" class="difflineminus">-  if (!gDialog.hrefInput.value &amp;&amp; TextIsURI(selectedText))</span>
<a href="#l30.136"></a><span id="l30.136" class="difflineminus">-      gDialog.hrefInput.value = selectedText;</span>
<a href="#l30.137"></a><span id="l30.137" class="difflineplus">+  if (!gDialog.hrefInput.value &amp;&amp; TextIsURI(selectedText)) {</span>
<a href="#l30.138"></a><span id="l30.138" class="difflineplus">+    gDialog.hrefInput.value = selectedText;</span>
<a href="#l30.139"></a><span id="l30.139" class="difflineplus">+  }</span>
<a href="#l30.140"></a><span id="l30.140"> </span>
<a href="#l30.141"></a><span id="l30.141">   // Set initial focus</span>
<a href="#l30.142"></a><span id="l30.142">   if (insertLinkAtCaret) {</span>
<a href="#l30.143"></a><span id="l30.143">     // We will be using the HREF inputbox, so text message</span>
<a href="#l30.144"></a><span id="l30.144">     SetTextboxFocus(gDialog.linkTextInput);</span>
<a href="#l30.145"></a><span id="l30.145">   } else {</span>
<a href="#l30.146"></a><span id="l30.146">     SetTextboxFocus(gDialog.hrefInput);</span>
<a href="#l30.147"></a><span id="l30.147"> </span>
<a href="#l30.148"></a><span id="l30.148" class="difflineat">@@ -195,17 +219,19 @@ function InitDialog() {</span>
<a href="#l30.149"></a><span id="l30.149">   gDialog.hrefInput.value = globalElement.getAttribute(&quot;href&quot;);</span>
<a href="#l30.150"></a><span id="l30.150"> </span>
<a href="#l30.151"></a><span id="l30.151">   // Set &quot;Relativize&quot; checkbox according to current URL state</span>
<a href="#l30.152"></a><span id="l30.152">   SetRelativeCheckbox(gDialog.makeRelativeLink);</span>
<a href="#l30.153"></a><span id="l30.153"> }</span>
<a href="#l30.154"></a><span id="l30.154"> </span>
<a href="#l30.155"></a><span id="l30.155"> function doEnabling() {</span>
<a href="#l30.156"></a><span id="l30.156">   // We disable Ok button when there's no href text only if inserting a new link</span>
<a href="#l30.157"></a><span id="l30.157" class="difflineminus">-  var enable = insertNew ? (TrimString(gDialog.hrefInput.value).length &gt; 0) : true;</span>
<a href="#l30.158"></a><span id="l30.158" class="difflineplus">+  var enable = insertNew</span>
<a href="#l30.159"></a><span id="l30.159" class="difflineplus">+    ? TrimString(gDialog.hrefInput.value).length &gt; 0</span>
<a href="#l30.160"></a><span id="l30.160" class="difflineplus">+    : true;</span>
<a href="#l30.161"></a><span id="l30.161"> </span>
<a href="#l30.162"></a><span id="l30.162">   // anon. content, so can't use SetElementEnabledById here</span>
<a href="#l30.163"></a><span id="l30.163">   var dialogNode = document.getElementById(&quot;linkDlg&quot;);</span>
<a href="#l30.164"></a><span id="l30.164">   dialogNode.getButton(&quot;accept&quot;).disabled = !enable;</span>
<a href="#l30.165"></a><span id="l30.165"> </span>
<a href="#l30.166"></a><span id="l30.166">   SetElementEnabledById(&quot;AdvancedEditButton1&quot;, enable);</span>
<a href="#l30.167"></a><span id="l30.167"> }</span>
<a href="#l30.168"></a><span id="l30.168"> </span>
<a href="#l30.169"></a><span id="l30.169" class="difflineat">@@ -255,18 +281,19 @@ function onAccept(event) {</span>
<a href="#l30.170"></a><span id="l30.170">       // Coalesce into one undo transaction</span>
<a href="#l30.171"></a><span id="l30.171">       gActiveEditor.beginTransaction();</span>
<a href="#l30.172"></a><span id="l30.172"> </span>
<a href="#l30.173"></a><span id="l30.173">       // Get text to use for a new link</span>
<a href="#l30.174"></a><span id="l30.174">       if (insertLinkAtCaret) {</span>
<a href="#l30.175"></a><span id="l30.175">         // Append the link text as the last child node</span>
<a href="#l30.176"></a><span id="l30.176">         //   of the anchor node</span>
<a href="#l30.177"></a><span id="l30.177">         var textNode = gActiveEditor.document.createTextNode(newLinkText);</span>
<a href="#l30.178"></a><span id="l30.178" class="difflineminus">-        if (textNode)</span>
<a href="#l30.179"></a><span id="l30.179" class="difflineplus">+        if (textNode) {</span>
<a href="#l30.180"></a><span id="l30.180">           anchorElement.appendChild(textNode);</span>
<a href="#l30.181"></a><span id="l30.181" class="difflineplus">+        }</span>
<a href="#l30.182"></a><span id="l30.182">         try {</span>
<a href="#l30.183"></a><span id="l30.183">           gActiveEditor.insertElementAtSelection(anchorElement, false);</span>
<a href="#l30.184"></a><span id="l30.184">         } catch (e) {</span>
<a href="#l30.185"></a><span id="l30.185">           dump(&quot;Exception occurred in InsertElementAtSelection\n&quot;);</span>
<a href="#l30.186"></a><span id="l30.186">           return;</span>
<a href="#l30.187"></a><span id="l30.187">         }</span>
<a href="#l30.188"></a><span id="l30.188">       } else if (insertNew || replaceExistingLink) {</span>
<a href="#l30.189"></a><span id="l30.189">         //  Link source was supplied by the selection,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdListProps.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdListProps.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -11,19 +11,41 @@ var gNumberStyleType = &quot;&quot;;</span>
<a href="#l31.4"></a><span id="l31.4"> var gListElement;</span>
<a href="#l31.5"></a><span id="l31.5"> var gOriginalListType = &quot;&quot;;</span>
<a href="#l31.6"></a><span id="l31.6"> var gListType = &quot;&quot;;</span>
<a href="#l31.7"></a><span id="l31.7"> var gMixedListSelection = false;</span>
<a href="#l31.8"></a><span id="l31.8"> var gStyleType = &quot;&quot;;</span>
<a href="#l31.9"></a><span id="l31.9"> var gOriginalStyleType = &quot;&quot;;</span>
<a href="#l31.10"></a><span id="l31.10"> const gOnesArray = [&quot;&quot;, &quot;I&quot;, &quot;II&quot;, &quot;III&quot;, &quot;IV&quot;, &quot;V&quot;, &quot;VI&quot;, &quot;VII&quot;, &quot;VIII&quot;, &quot;IX&quot;];</span>
<a href="#l31.11"></a><span id="l31.11"> const gTensArray = [&quot;&quot;, &quot;X&quot;, &quot;XX&quot;, &quot;XXX&quot;, &quot;XL&quot;, &quot;L&quot;, &quot;LX&quot;, &quot;LXX&quot;, &quot;LXXX&quot;, &quot;XC&quot;];</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-const gHundredsArray = [&quot;&quot;, &quot;C&quot;, &quot;CC&quot;, &quot;CCC&quot;, &quot;CD&quot;, &quot;D&quot;, &quot;DC&quot;, &quot;DCC&quot;, &quot;DCCC&quot;, &quot;CM&quot;];</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineminus">-const gThousandsArray = [&quot;&quot;, &quot;M&quot;, &quot;MM&quot;, &quot;MMM&quot;, &quot;MMMM&quot;, &quot;MMMMM&quot;, &quot;MMMMMM&quot;, &quot;MMMMMMM&quot;, &quot;MMMMMMMM&quot;, &quot;MMMMMMMMM&quot;];</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineminus">-const gRomanDigits = {I: 1, V: 5, X: 10, L: 50, C: 100, D: 500, M: 1000};</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineplus">+const gHundredsArray = [</span>
<a href="#l31.16"></a><span id="l31.16" class="difflineplus">+  &quot;&quot;,</span>
<a href="#l31.17"></a><span id="l31.17" class="difflineplus">+  &quot;C&quot;,</span>
<a href="#l31.18"></a><span id="l31.18" class="difflineplus">+  &quot;CC&quot;,</span>
<a href="#l31.19"></a><span id="l31.19" class="difflineplus">+  &quot;CCC&quot;,</span>
<a href="#l31.20"></a><span id="l31.20" class="difflineplus">+  &quot;CD&quot;,</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineplus">+  &quot;D&quot;,</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineplus">+  &quot;DC&quot;,</span>
<a href="#l31.23"></a><span id="l31.23" class="difflineplus">+  &quot;DCC&quot;,</span>
<a href="#l31.24"></a><span id="l31.24" class="difflineplus">+  &quot;DCCC&quot;,</span>
<a href="#l31.25"></a><span id="l31.25" class="difflineplus">+  &quot;CM&quot;,</span>
<a href="#l31.26"></a><span id="l31.26" class="difflineplus">+];</span>
<a href="#l31.27"></a><span id="l31.27" class="difflineplus">+const gThousandsArray = [</span>
<a href="#l31.28"></a><span id="l31.28" class="difflineplus">+  &quot;&quot;,</span>
<a href="#l31.29"></a><span id="l31.29" class="difflineplus">+  &quot;M&quot;,</span>
<a href="#l31.30"></a><span id="l31.30" class="difflineplus">+  &quot;MM&quot;,</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineplus">+  &quot;MMM&quot;,</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineplus">+  &quot;MMMM&quot;,</span>
<a href="#l31.33"></a><span id="l31.33" class="difflineplus">+  &quot;MMMMM&quot;,</span>
<a href="#l31.34"></a><span id="l31.34" class="difflineplus">+  &quot;MMMMMM&quot;,</span>
<a href="#l31.35"></a><span id="l31.35" class="difflineplus">+  &quot;MMMMMMM&quot;,</span>
<a href="#l31.36"></a><span id="l31.36" class="difflineplus">+  &quot;MMMMMMMM&quot;,</span>
<a href="#l31.37"></a><span id="l31.37" class="difflineplus">+  &quot;MMMMMMMMM&quot;,</span>
<a href="#l31.38"></a><span id="l31.38" class="difflineplus">+];</span>
<a href="#l31.39"></a><span id="l31.39" class="difflineplus">+const gRomanDigits = { I: 1, V: 5, X: 10, L: 50, C: 100, D: 500, M: 1000 };</span>
<a href="#l31.40"></a><span id="l31.40"> const A = &quot;A&quot;.charCodeAt(0);</span>
<a href="#l31.41"></a><span id="l31.41"> const gArabic = &quot;1&quot;;</span>
<a href="#l31.42"></a><span id="l31.42"> const gUpperRoman = &quot;I&quot;;</span>
<a href="#l31.43"></a><span id="l31.43"> const gLowerRoman = &quot;i&quot;;</span>
<a href="#l31.44"></a><span id="l31.44"> const gUpperLetters = &quot;A&quot;;</span>
<a href="#l31.45"></a><span id="l31.45"> const gLowerLetters = &quot;a&quot;;</span>
<a href="#l31.46"></a><span id="l31.46"> const gDecimalCSS = &quot;decimal&quot;;</span>
<a href="#l31.47"></a><span id="l31.47"> const gUpperRomanCSS = &quot;upper-roman&quot;;</span>
<a href="#l31.48"></a><span id="l31.48" class="difflineat">@@ -60,52 +82,57 @@ function Startup() {</span>
<a href="#l31.49"></a><span id="l31.49">     // We may have mixed list and non-list, or &gt; 1 list type in selection</span>
<a href="#l31.50"></a><span id="l31.50">     gMixedListSelection = mixedObj.value;</span>
<a href="#l31.51"></a><span id="l31.51"> </span>
<a href="#l31.52"></a><span id="l31.52">     // Get the list element at the anchor node</span>
<a href="#l31.53"></a><span id="l31.53">     gListElement = editor.getElementOrParentByTagName(&quot;list&quot;, null);</span>
<a href="#l31.54"></a><span id="l31.54">   } catch (e) {}</span>
<a href="#l31.55"></a><span id="l31.55"> </span>
<a href="#l31.56"></a><span id="l31.56">   // The copy to use in AdvancedEdit</span>
<a href="#l31.57"></a><span id="l31.57" class="difflineminus">-  if (gListElement)</span>
<a href="#l31.58"></a><span id="l31.58" class="difflineplus">+  if (gListElement) {</span>
<a href="#l31.59"></a><span id="l31.59">     globalElement = gListElement.cloneNode(false);</span>
<a href="#l31.60"></a><span id="l31.60" class="difflineplus">+  }</span>
<a href="#l31.61"></a><span id="l31.61"> </span>
<a href="#l31.62"></a><span id="l31.62">   // Show extra options for changing entire list if we have one already.</span>
<a href="#l31.63"></a><span id="l31.63">   gDialog.RadioGroup.collapsed = !gListElement;</span>
<a href="#l31.64"></a><span id="l31.64">   if (gListElement) {</span>
<a href="#l31.65"></a><span id="l31.65">     // Radio button index is persistent</span>
<a href="#l31.66"></a><span id="l31.66" class="difflineminus">-    if (gDialog.RadioGroup.getAttribute(&quot;index&quot;) == &quot;1&quot;)</span>
<a href="#l31.67"></a><span id="l31.67" class="difflineplus">+    if (gDialog.RadioGroup.getAttribute(&quot;index&quot;) == &quot;1&quot;) {</span>
<a href="#l31.68"></a><span id="l31.68">       gDialog.RadioGroup.selectedItem = gDialog.ChangeSelectedRadio;</span>
<a href="#l31.69"></a><span id="l31.69" class="difflineminus">-    else</span>
<a href="#l31.70"></a><span id="l31.70" class="difflineplus">+    } else {</span>
<a href="#l31.71"></a><span id="l31.71">       gDialog.RadioGroup.selectedItem = gDialog.ChangeAllRadio;</span>
<a href="#l31.72"></a><span id="l31.72" class="difflineplus">+    }</span>
<a href="#l31.73"></a><span id="l31.73">   }</span>
<a href="#l31.74"></a><span id="l31.74"> </span>
<a href="#l31.75"></a><span id="l31.75">   InitDialog();</span>
<a href="#l31.76"></a><span id="l31.76"> </span>
<a href="#l31.77"></a><span id="l31.77">   gOriginalListType = gListType;</span>
<a href="#l31.78"></a><span id="l31.78"> </span>
<a href="#l31.79"></a><span id="l31.79">   gDialog.ListTypeList.focus();</span>
<a href="#l31.80"></a><span id="l31.80"> </span>
<a href="#l31.81"></a><span id="l31.81">   SetWindowLocation();</span>
<a href="#l31.82"></a><span id="l31.82"> }</span>
<a href="#l31.83"></a><span id="l31.83"> </span>
<a href="#l31.84"></a><span id="l31.84"> function InitDialog() {</span>
<a href="#l31.85"></a><span id="l31.85">   // Note that if mixed, we we pay attention</span>
<a href="#l31.86"></a><span id="l31.86">   //   only to the anchor node's list type</span>
<a href="#l31.87"></a><span id="l31.87">   // (i.e., don't confuse user with &quot;mixed&quot; designation)</span>
<a href="#l31.88"></a><span id="l31.88" class="difflineminus">-  if (gListElement)</span>
<a href="#l31.89"></a><span id="l31.89" class="difflineplus">+  if (gListElement) {</span>
<a href="#l31.90"></a><span id="l31.90">     gListType = gListElement.nodeName.toLowerCase();</span>
<a href="#l31.91"></a><span id="l31.91" class="difflineminus">-  else</span>
<a href="#l31.92"></a><span id="l31.92" class="difflineplus">+  } else {</span>
<a href="#l31.93"></a><span id="l31.93">     gListType = &quot;&quot;;</span>
<a href="#l31.94"></a><span id="l31.94" class="difflineplus">+  }</span>
<a href="#l31.95"></a><span id="l31.95"> </span>
<a href="#l31.96"></a><span id="l31.96">   gDialog.ListTypeList.value = gListType;</span>
<a href="#l31.97"></a><span id="l31.97">   gDialog.StartingNumberInput.value = &quot;&quot;;</span>
<a href="#l31.98"></a><span id="l31.98"> </span>
<a href="#l31.99"></a><span id="l31.99">   // Last param = true means attribute value is case-sensitive</span>
<a href="#l31.100"></a><span id="l31.100" class="difflineminus">-  var type = globalElement ? GetHTMLOrCSSStyleValue(globalElement, &quot;type&quot;, &quot;list-style-type&quot;) : null;</span>
<a href="#l31.101"></a><span id="l31.101" class="difflineplus">+  var type = globalElement</span>
<a href="#l31.102"></a><span id="l31.102" class="difflineplus">+    ? GetHTMLOrCSSStyleValue(globalElement, &quot;type&quot;, &quot;list-style-type&quot;)</span>
<a href="#l31.103"></a><span id="l31.103" class="difflineplus">+    : null;</span>
<a href="#l31.104"></a><span id="l31.104"> </span>
<a href="#l31.105"></a><span id="l31.105">   if (gListType == &quot;ul&quot;) {</span>
<a href="#l31.106"></a><span id="l31.106">     if (type) {</span>
<a href="#l31.107"></a><span id="l31.107">       type = type.toLowerCase();</span>
<a href="#l31.108"></a><span id="l31.108">       gBulletStyleType = type;</span>
<a href="#l31.109"></a><span id="l31.109">       gOriginalStyleType = type;</span>
<a href="#l31.110"></a><span id="l31.110">     }</span>
<a href="#l31.111"></a><span id="l31.111">   } else if (gListType == &quot;ol&quot;) {</span>
<a href="#l31.112"></a><span id="l31.112" class="difflineat">@@ -128,18 +155,20 @@ function InitDialog() {</span>
<a href="#l31.113"></a><span id="l31.113">         break;</span>
<a href="#l31.114"></a><span id="l31.114">     }</span>
<a href="#l31.115"></a><span id="l31.115">     if (type) {</span>
<a href="#l31.116"></a><span id="l31.116">       gNumberStyleType = type;</span>
<a href="#l31.117"></a><span id="l31.117">       gOriginalStyleType = type;</span>
<a href="#l31.118"></a><span id="l31.118">     }</span>
<a href="#l31.119"></a><span id="l31.119"> </span>
<a href="#l31.120"></a><span id="l31.120">     // Convert attribute number to appropriate letter or roman numeral</span>
<a href="#l31.121"></a><span id="l31.121" class="difflineminus">-    gDialog.StartingNumberInput.value =</span>
<a href="#l31.122"></a><span id="l31.122" class="difflineminus">-      ConvertStartAttrToUserString(globalElement.getAttribute(&quot;start&quot;), type);</span>
<a href="#l31.123"></a><span id="l31.123" class="difflineplus">+    gDialog.StartingNumberInput.value = ConvertStartAttrToUserString(</span>
<a href="#l31.124"></a><span id="l31.124" class="difflineplus">+      globalElement.getAttribute(&quot;start&quot;),</span>
<a href="#l31.125"></a><span id="l31.125" class="difflineplus">+      type</span>
<a href="#l31.126"></a><span id="l31.126" class="difflineplus">+    );</span>
<a href="#l31.127"></a><span id="l31.127">   }</span>
<a href="#l31.128"></a><span id="l31.128">   BuildBulletStyleList();</span>
<a href="#l31.129"></a><span id="l31.129"> }</span>
<a href="#l31.130"></a><span id="l31.130"> </span>
<a href="#l31.131"></a><span id="l31.131"> // Convert attribute number to appropriate letter or roman numeral</span>
<a href="#l31.132"></a><span id="l31.132"> function ConvertStartAttrToUserString(startAttr, type) {</span>
<a href="#l31.133"></a><span id="l31.133">   switch (type) {</span>
<a href="#l31.134"></a><span id="l31.134">     case gUpperRoman:</span>
<a href="#l31.135"></a><span id="l31.135" class="difflineat">@@ -194,39 +223,43 @@ function BuildBulletStyleList() {</span>
<a href="#l31.136"></a><span id="l31.136">   } else {</span>
<a href="#l31.137"></a><span id="l31.137">     gDialog.BulletStyleList.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l31.138"></a><span id="l31.138">     gDialog.BulletStyleLabel.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l31.139"></a><span id="l31.139">     gDialog.StartingNumberInput.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l31.140"></a><span id="l31.140">     gDialog.StartingNumberLabel.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l31.141"></a><span id="l31.141">   }</span>
<a href="#l31.142"></a><span id="l31.142"> </span>
<a href="#l31.143"></a><span id="l31.143">   // Disable advanced edit button if changing to &quot;normal&quot;</span>
<a href="#l31.144"></a><span id="l31.144" class="difflineminus">-  if (gListType)</span>
<a href="#l31.145"></a><span id="l31.145" class="difflineplus">+  if (gListType) {</span>
<a href="#l31.146"></a><span id="l31.146">     gDialog.AdvancedEditButton.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l31.147"></a><span id="l31.147" class="difflineminus">-  else</span>
<a href="#l31.148"></a><span id="l31.148" class="difflineplus">+  } else {</span>
<a href="#l31.149"></a><span id="l31.149">     gDialog.AdvancedEditButton.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l31.150"></a><span id="l31.150" class="difflineplus">+  }</span>
<a href="#l31.151"></a><span id="l31.151"> </span>
<a href="#l31.152"></a><span id="l31.152" class="difflineminus">-  if (label)</span>
<a href="#l31.153"></a><span id="l31.153" class="difflineplus">+  if (label) {</span>
<a href="#l31.154"></a><span id="l31.154">     gDialog.BulletStyleLabel.setAttribute(&quot;label&quot;, label);</span>
<a href="#l31.155"></a><span id="l31.155" class="difflineplus">+  }</span>
<a href="#l31.156"></a><span id="l31.156"> }</span>
<a href="#l31.157"></a><span id="l31.157"> </span>
<a href="#l31.158"></a><span id="l31.158"> function SelectListType() {</span>
<a href="#l31.159"></a><span id="l31.159">   // Each list type is stored in the &quot;value&quot; of each menuitem</span>
<a href="#l31.160"></a><span id="l31.160">   var NewType = gDialog.ListTypeList.value;</span>
<a href="#l31.161"></a><span id="l31.161"> </span>
<a href="#l31.162"></a><span id="l31.162" class="difflineminus">-  if (NewType == &quot;ol&quot;)</span>
<a href="#l31.163"></a><span id="l31.163" class="difflineplus">+  if (NewType == &quot;ol&quot;) {</span>
<a href="#l31.164"></a><span id="l31.164">     SetTextboxFocus(gDialog.StartingNumberInput);</span>
<a href="#l31.165"></a><span id="l31.165" class="difflineplus">+  }</span>
<a href="#l31.166"></a><span id="l31.166"> </span>
<a href="#l31.167"></a><span id="l31.167">   if (gListType != NewType) {</span>
<a href="#l31.168"></a><span id="l31.168">     gListType = NewType;</span>
<a href="#l31.169"></a><span id="l31.169"> </span>
<a href="#l31.170"></a><span id="l31.170">     // Create a newlist object for Advanced Editing</span>
<a href="#l31.171"></a><span id="l31.171">     try {</span>
<a href="#l31.172"></a><span id="l31.172" class="difflineminus">-      if (gListType)</span>
<a href="#l31.173"></a><span id="l31.173" class="difflineplus">+      if (gListType) {</span>
<a href="#l31.174"></a><span id="l31.174">         globalElement = GetCurrentEditor().createElementWithDefaults(gListType);</span>
<a href="#l31.175"></a><span id="l31.175" class="difflineplus">+      }</span>
<a href="#l31.176"></a><span id="l31.176">     } catch (e) {}</span>
<a href="#l31.177"></a><span id="l31.177"> </span>
<a href="#l31.178"></a><span id="l31.178">     BuildBulletStyleList();</span>
<a href="#l31.179"></a><span id="l31.179">   }</span>
<a href="#l31.180"></a><span id="l31.180"> }</span>
<a href="#l31.181"></a><span id="l31.181"> </span>
<a href="#l31.182"></a><span id="l31.182"> function SelectBulletStyle() {</span>
<a href="#l31.183"></a><span id="l31.183">   // Save the selected index so when user changes</span>
<a href="#l31.184"></a><span id="l31.184" class="difflineat">@@ -234,114 +267,126 @@ function SelectBulletStyle() {</span>
<a href="#l31.185"></a><span id="l31.185">   // Each bullet or number type is stored in the &quot;value&quot; of each menuitem</span>
<a href="#l31.186"></a><span id="l31.186">   if (gListType == &quot;ul&quot;) {</span>
<a href="#l31.187"></a><span id="l31.187">     gBulletStyleType = gDialog.BulletStyleList.value;</span>
<a href="#l31.188"></a><span id="l31.188">   } else if (gListType == &quot;ol&quot;) {</span>
<a href="#l31.189"></a><span id="l31.189">     var type = gDialog.BulletStyleList.value;</span>
<a href="#l31.190"></a><span id="l31.190">     if (gNumberStyleType != type) {</span>
<a href="#l31.191"></a><span id="l31.191">       // Convert existing input value to attr number first,</span>
<a href="#l31.192"></a><span id="l31.192">       //   then convert to the appropriate format for the newly-selected</span>
<a href="#l31.193"></a><span id="l31.193" class="difflineminus">-      gDialog.StartingNumberInput.value =</span>
<a href="#l31.194"></a><span id="l31.194" class="difflineminus">-        ConvertStartAttrToUserString(ConvertUserStringToStartAttr(gNumberStyleType), type);</span>
<a href="#l31.195"></a><span id="l31.195" class="difflineplus">+      gDialog.StartingNumberInput.value = ConvertStartAttrToUserString(</span>
<a href="#l31.196"></a><span id="l31.196" class="difflineplus">+        ConvertUserStringToStartAttr(gNumberStyleType),</span>
<a href="#l31.197"></a><span id="l31.197" class="difflineplus">+        type</span>
<a href="#l31.198"></a><span id="l31.198" class="difflineplus">+      );</span>
<a href="#l31.199"></a><span id="l31.199"> </span>
<a href="#l31.200"></a><span id="l31.200">       gNumberStyleType = type;</span>
<a href="#l31.201"></a><span id="l31.201">       SetTextboxFocus(gDialog.StartingNumberInput);</span>
<a href="#l31.202"></a><span id="l31.202">     }</span>
<a href="#l31.203"></a><span id="l31.203">   }</span>
<a href="#l31.204"></a><span id="l31.204"> }</span>
<a href="#l31.205"></a><span id="l31.205"> </span>
<a href="#l31.206"></a><span id="l31.206"> function ValidateData() {</span>
<a href="#l31.207"></a><span id="l31.207">   gBulletStyleType = gDialog.BulletStyleList.value;</span>
<a href="#l31.208"></a><span id="l31.208">   // globalElement should already be of the correct type</span>
<a href="#l31.209"></a><span id="l31.209"> </span>
<a href="#l31.210"></a><span id="l31.210">   if (globalElement) {</span>
<a href="#l31.211"></a><span id="l31.211">     var editor = GetCurrentEditor();</span>
<a href="#l31.212"></a><span id="l31.212">     if (gListType == &quot;ul&quot;) {</span>
<a href="#l31.213"></a><span id="l31.213" class="difflineminus">-      if (gBulletStyleType &amp;&amp; gDialog.ChangeAllRadio.selected)</span>
<a href="#l31.214"></a><span id="l31.214" class="difflineplus">+      if (gBulletStyleType &amp;&amp; gDialog.ChangeAllRadio.selected) {</span>
<a href="#l31.215"></a><span id="l31.215">         globalElement.setAttribute(&quot;type&quot;, gBulletStyleType);</span>
<a href="#l31.216"></a><span id="l31.216" class="difflineminus">-      else</span>
<a href="#l31.217"></a><span id="l31.217" class="difflineplus">+      } else {</span>
<a href="#l31.218"></a><span id="l31.218">         try {</span>
<a href="#l31.219"></a><span id="l31.219">           editor.removeAttributeOrEquivalent(globalElement, &quot;type&quot;, true);</span>
<a href="#l31.220"></a><span id="l31.220">         } catch (e) {}</span>
<a href="#l31.221"></a><span id="l31.221" class="difflineplus">+      }</span>
<a href="#l31.222"></a><span id="l31.222">     } else if (gListType == &quot;ol&quot;) {</span>
<a href="#l31.223"></a><span id="l31.223" class="difflineminus">-      if (gBulletStyleType)</span>
<a href="#l31.224"></a><span id="l31.224" class="difflineplus">+      if (gBulletStyleType) {</span>
<a href="#l31.225"></a><span id="l31.225">         globalElement.setAttribute(&quot;type&quot;, gBulletStyleType);</span>
<a href="#l31.226"></a><span id="l31.226" class="difflineminus">-      else</span>
<a href="#l31.227"></a><span id="l31.227" class="difflineplus">+      } else {</span>
<a href="#l31.228"></a><span id="l31.228">         try {</span>
<a href="#l31.229"></a><span id="l31.229">           editor.removeAttributeOrEquivalent(globalElement, &quot;type&quot;, true);</span>
<a href="#l31.230"></a><span id="l31.230">         } catch (e) {}</span>
<a href="#l31.231"></a><span id="l31.231" class="difflineplus">+      }</span>
<a href="#l31.232"></a><span id="l31.232"> </span>
<a href="#l31.233"></a><span id="l31.233">       var startingNumber = ConvertUserStringToStartAttr(gBulletStyleType);</span>
<a href="#l31.234"></a><span id="l31.234" class="difflineminus">-      if (startingNumber)</span>
<a href="#l31.235"></a><span id="l31.235" class="difflineplus">+      if (startingNumber) {</span>
<a href="#l31.236"></a><span id="l31.236">         globalElement.setAttribute(&quot;start&quot;, startingNumber);</span>
<a href="#l31.237"></a><span id="l31.237" class="difflineminus">-      else</span>
<a href="#l31.238"></a><span id="l31.238" class="difflineplus">+      } else {</span>
<a href="#l31.239"></a><span id="l31.239">         globalElement.removeAttribute(&quot;start&quot;);</span>
<a href="#l31.240"></a><span id="l31.240" class="difflineplus">+      }</span>
<a href="#l31.241"></a><span id="l31.241">     }</span>
<a href="#l31.242"></a><span id="l31.242">   }</span>
<a href="#l31.243"></a><span id="l31.243">   return true;</span>
<a href="#l31.244"></a><span id="l31.244"> }</span>
<a href="#l31.245"></a><span id="l31.245"> </span>
<a href="#l31.246"></a><span id="l31.246"> function ConvertUserStringToStartAttr(type) {</span>
<a href="#l31.247"></a><span id="l31.247">   var startingNumber = TrimString(gDialog.StartingNumberInput.value);</span>
<a href="#l31.248"></a><span id="l31.248"> </span>
<a href="#l31.249"></a><span id="l31.249">   switch (type) {</span>
<a href="#l31.250"></a><span id="l31.250">     case gUpperRoman:</span>
<a href="#l31.251"></a><span id="l31.251">     case gLowerRoman:</span>
<a href="#l31.252"></a><span id="l31.252">       // If the input isn't an integer, assume it's a roman numeral. Convert it.</span>
<a href="#l31.253"></a><span id="l31.253" class="difflineminus">-      if (!Number(startingNumber))</span>
<a href="#l31.254"></a><span id="l31.254" class="difflineplus">+      if (!Number(startingNumber)) {</span>
<a href="#l31.255"></a><span id="l31.255">         startingNumber = ConvertRomanToArabic(startingNumber);</span>
<a href="#l31.256"></a><span id="l31.256" class="difflineplus">+      }</span>
<a href="#l31.257"></a><span id="l31.257">       break;</span>
<a href="#l31.258"></a><span id="l31.258">     case gUpperLetters:</span>
<a href="#l31.259"></a><span id="l31.259">     case gLowerLetters:</span>
<a href="#l31.260"></a><span id="l31.260">       // Get the number equivalent of the letters</span>
<a href="#l31.261"></a><span id="l31.261" class="difflineminus">-      if (!Number(startingNumber))</span>
<a href="#l31.262"></a><span id="l31.262" class="difflineplus">+      if (!Number(startingNumber)) {</span>
<a href="#l31.263"></a><span id="l31.263">         startingNumber = ConvertLettersToArabic(startingNumber);</span>
<a href="#l31.264"></a><span id="l31.264" class="difflineplus">+      }</span>
<a href="#l31.265"></a><span id="l31.265">       break;</span>
<a href="#l31.266"></a><span id="l31.266">   }</span>
<a href="#l31.267"></a><span id="l31.267">   return startingNumber;</span>
<a href="#l31.268"></a><span id="l31.268"> }</span>
<a href="#l31.269"></a><span id="l31.269"> </span>
<a href="#l31.270"></a><span id="l31.270"> function ConvertRomanToArabic(num) {</span>
<a href="#l31.271"></a><span id="l31.271">   num = num.toUpperCase();</span>
<a href="#l31.272"></a><span id="l31.272">   if (num &amp;&amp; !/[^MDCLXVI]/i.test(num)) {</span>
<a href="#l31.273"></a><span id="l31.273">     var Arabic = 0;</span>
<a href="#l31.274"></a><span id="l31.274">     var last_digit = 1000;</span>
<a href="#l31.275"></a><span id="l31.275">     for (var i = 0; i &lt; num.length; i++) {</span>
<a href="#l31.276"></a><span id="l31.276">       var digit = gRomanDigits[num.charAt(i)];</span>
<a href="#l31.277"></a><span id="l31.277" class="difflineminus">-      if (last_digit &lt; digit)</span>
<a href="#l31.278"></a><span id="l31.278" class="difflineplus">+      if (last_digit &lt; digit) {</span>
<a href="#l31.279"></a><span id="l31.279">         Arabic -= 2 * last_digit;</span>
<a href="#l31.280"></a><span id="l31.280" class="difflineplus">+      }</span>
<a href="#l31.281"></a><span id="l31.281"> </span>
<a href="#l31.282"></a><span id="l31.282">       last_digit = digit;</span>
<a href="#l31.283"></a><span id="l31.283">       Arabic += last_digit;</span>
<a href="#l31.284"></a><span id="l31.284">     }</span>
<a href="#l31.285"></a><span id="l31.285">     return Arabic;</span>
<a href="#l31.286"></a><span id="l31.286">   }</span>
<a href="#l31.287"></a><span id="l31.287"> </span>
<a href="#l31.288"></a><span id="l31.288">   return &quot;&quot;;</span>
<a href="#l31.289"></a><span id="l31.289"> }</span>
<a href="#l31.290"></a><span id="l31.290"> </span>
<a href="#l31.291"></a><span id="l31.291"> function ConvertArabicToRoman(num) {</span>
<a href="#l31.292"></a><span id="l31.292">   if (/^\d{1,4}$/.test(num)) {</span>
<a href="#l31.293"></a><span id="l31.293">     var digits = (&quot;000&quot; + num).substr(-4);</span>
<a href="#l31.294"></a><span id="l31.294" class="difflineminus">-    return gThousandsArray[digits.charAt(0)] +</span>
<a href="#l31.295"></a><span id="l31.295" class="difflineminus">-           gHundredsArray[digits.charAt(1)] +</span>
<a href="#l31.296"></a><span id="l31.296" class="difflineminus">-           gTensArray[digits.charAt(2)] +</span>
<a href="#l31.297"></a><span id="l31.297" class="difflineminus">-           gOnesArray[digits.charAt(3)];</span>
<a href="#l31.298"></a><span id="l31.298" class="difflineplus">+    return (</span>
<a href="#l31.299"></a><span id="l31.299" class="difflineplus">+      gThousandsArray[digits.charAt(0)] +</span>
<a href="#l31.300"></a><span id="l31.300" class="difflineplus">+      gHundredsArray[digits.charAt(1)] +</span>
<a href="#l31.301"></a><span id="l31.301" class="difflineplus">+      gTensArray[digits.charAt(2)] +</span>
<a href="#l31.302"></a><span id="l31.302" class="difflineplus">+      gOnesArray[digits.charAt(3)]</span>
<a href="#l31.303"></a><span id="l31.303" class="difflineplus">+    );</span>
<a href="#l31.304"></a><span id="l31.304">   }</span>
<a href="#l31.305"></a><span id="l31.305">   return &quot;&quot;;</span>
<a href="#l31.306"></a><span id="l31.306"> }</span>
<a href="#l31.307"></a><span id="l31.307"> </span>
<a href="#l31.308"></a><span id="l31.308"> function ConvertLettersToArabic(letters) {</span>
<a href="#l31.309"></a><span id="l31.309">   letters = letters.toUpperCase();</span>
<a href="#l31.310"></a><span id="l31.310" class="difflineminus">-  if (!letters || /[^A-Z]/.test(letters))</span>
<a href="#l31.311"></a><span id="l31.311" class="difflineplus">+  if (!letters || /[^A-Z]/.test(letters)) {</span>
<a href="#l31.312"></a><span id="l31.312">     return &quot;&quot;;</span>
<a href="#l31.313"></a><span id="l31.313" class="difflineplus">+  }</span>
<a href="#l31.314"></a><span id="l31.314"> </span>
<a href="#l31.315"></a><span id="l31.315">   var num = 0;</span>
<a href="#l31.316"></a><span id="l31.316" class="difflineminus">-  for (var i = 0; i &lt; letters.length; i++)</span>
<a href="#l31.317"></a><span id="l31.317" class="difflineplus">+  for (var i = 0; i &lt; letters.length; i++) {</span>
<a href="#l31.318"></a><span id="l31.318">     num = num * 26 + letters.charCodeAt(i) - A + 1;</span>
<a href="#l31.319"></a><span id="l31.319" class="difflineplus">+  }</span>
<a href="#l31.320"></a><span id="l31.320">   return num;</span>
<a href="#l31.321"></a><span id="l31.321"> }</span>
<a href="#l31.322"></a><span id="l31.322"> </span>
<a href="#l31.323"></a><span id="l31.323"> function ConvertArabicToLetters(num) {</span>
<a href="#l31.324"></a><span id="l31.324">   var letters = &quot;&quot;;</span>
<a href="#l31.325"></a><span id="l31.325">   while (num) {</span>
<a href="#l31.326"></a><span id="l31.326">     num--;</span>
<a href="#l31.327"></a><span id="l31.327">     letters = String.fromCharCode(A + (num % 26)) + letters;</span>
<a href="#l31.328"></a><span id="l31.328" class="difflineat">@@ -352,43 +397,51 @@ function ConvertArabicToLetters(num) {</span>
<a href="#l31.329"></a><span id="l31.329"> </span>
<a href="#l31.330"></a><span id="l31.330"> function onAccept(event) {</span>
<a href="#l31.331"></a><span id="l31.331">   if (ValidateData()) {</span>
<a href="#l31.332"></a><span id="l31.332">     // Coalesce into one undo transaction</span>
<a href="#l31.333"></a><span id="l31.333">     var editor = GetCurrentEditor();</span>
<a href="#l31.334"></a><span id="l31.334"> </span>
<a href="#l31.335"></a><span id="l31.335">     editor.beginTransaction();</span>
<a href="#l31.336"></a><span id="l31.336"> </span>
<a href="#l31.337"></a><span id="l31.337" class="difflineminus">-    var changeEntireList = gDialog.RadioGroup.selectedItem == gDialog.ChangeAllRadio;</span>
<a href="#l31.338"></a><span id="l31.338" class="difflineplus">+    var changeEntireList =</span>
<a href="#l31.339"></a><span id="l31.339" class="difflineplus">+      gDialog.RadioGroup.selectedItem == gDialog.ChangeAllRadio;</span>
<a href="#l31.340"></a><span id="l31.340"> </span>
<a href="#l31.341"></a><span id="l31.341">     // Remember which radio button was selected</span>
<a href="#l31.342"></a><span id="l31.342" class="difflineminus">-    if (gListElement)</span>
<a href="#l31.343"></a><span id="l31.343" class="difflineplus">+    if (gListElement) {</span>
<a href="#l31.344"></a><span id="l31.344">       gDialog.RadioGroup.setAttribute(&quot;index&quot;, changeEntireList ? &quot;0&quot; : &quot;1&quot;);</span>
<a href="#l31.345"></a><span id="l31.345" class="difflineplus">+    }</span>
<a href="#l31.346"></a><span id="l31.346"> </span>
<a href="#l31.347"></a><span id="l31.347">     var changeList;</span>
<a href="#l31.348"></a><span id="l31.348">     if (gListElement &amp;&amp; gDialog.ChangeAllRadio.selected) {</span>
<a href="#l31.349"></a><span id="l31.349">       changeList = true;</span>
<a href="#l31.350"></a><span id="l31.350">     } else {</span>
<a href="#l31.351"></a><span id="l31.351" class="difflineminus">-      changeList = gMixedListSelection || gListType != gOriginalListType ||</span>
<a href="#l31.352"></a><span id="l31.352" class="difflineminus">-                   gBulletStyleType != gOriginalStyleType;</span>
<a href="#l31.353"></a><span id="l31.353" class="difflineplus">+      changeList =</span>
<a href="#l31.354"></a><span id="l31.354" class="difflineplus">+        gMixedListSelection ||</span>
<a href="#l31.355"></a><span id="l31.355" class="difflineplus">+        gListType != gOriginalListType ||</span>
<a href="#l31.356"></a><span id="l31.356" class="difflineplus">+        gBulletStyleType != gOriginalStyleType;</span>
<a href="#l31.357"></a><span id="l31.357">     }</span>
<a href="#l31.358"></a><span id="l31.358">     if (changeList) {</span>
<a href="#l31.359"></a><span id="l31.359">       try {</span>
<a href="#l31.360"></a><span id="l31.360">         if (gListType) {</span>
<a href="#l31.361"></a><span id="l31.361" class="difflineminus">-          editor.makeOrChangeList(gListType, changeEntireList,</span>
<a href="#l31.362"></a><span id="l31.362" class="difflineminus">-                     (gBulletStyleType != gOriginalStyleType) ? gBulletStyleType : null);</span>
<a href="#l31.363"></a><span id="l31.363" class="difflineplus">+          editor.makeOrChangeList(</span>
<a href="#l31.364"></a><span id="l31.364" class="difflineplus">+            gListType,</span>
<a href="#l31.365"></a><span id="l31.365" class="difflineplus">+            changeEntireList,</span>
<a href="#l31.366"></a><span id="l31.366" class="difflineplus">+            gBulletStyleType != gOriginalStyleType ? gBulletStyleType : null</span>
<a href="#l31.367"></a><span id="l31.367" class="difflineplus">+          );</span>
<a href="#l31.368"></a><span id="l31.368"> </span>
<a href="#l31.369"></a><span id="l31.369">           // Get the new list created:</span>
<a href="#l31.370"></a><span id="l31.370">           gListElement = editor.getElementOrParentByTagName(gListType, null);</span>
<a href="#l31.371"></a><span id="l31.371"> </span>
<a href="#l31.372"></a><span id="l31.372">           editor.cloneAttributes(gListElement, globalElement);</span>
<a href="#l31.373"></a><span id="l31.373">         } else {</span>
<a href="#l31.374"></a><span id="l31.374">           // Remove all existing lists</span>
<a href="#l31.375"></a><span id="l31.375" class="difflineminus">-          if (gListElement &amp;&amp; changeEntireList)</span>
<a href="#l31.376"></a><span id="l31.376" class="difflineplus">+          if (gListElement &amp;&amp; changeEntireList) {</span>
<a href="#l31.377"></a><span id="l31.377">             editor.selectElement(gListElement);</span>
<a href="#l31.378"></a><span id="l31.378" class="difflineplus">+          }</span>
<a href="#l31.379"></a><span id="l31.379"> </span>
<a href="#l31.380"></a><span id="l31.380">           editor.removeList(&quot;ol&quot;);</span>
<a href="#l31.381"></a><span id="l31.381">           editor.removeList(&quot;ul&quot;);</span>
<a href="#l31.382"></a><span id="l31.382">           editor.removeList(&quot;dl&quot;);</span>
<a href="#l31.383"></a><span id="l31.383">         }</span>
<a href="#l31.384"></a><span id="l31.384">       } catch (e) {}</span>
<a href="#l31.385"></a><span id="l31.385">     }</span>
<a href="#l31.386"></a><span id="l31.386"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdNamedAnchorProps.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdNamedAnchorProps.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -17,17 +17,17 @@ document.addEventListener(&quot;dialogcancel&quot;</span>
<a href="#l32.4"></a><span id="l32.4"> </span>
<a href="#l32.5"></a><span id="l32.5"> function Startup() {</span>
<a href="#l32.6"></a><span id="l32.6">   var editor = GetCurrentEditor();</span>
<a href="#l32.7"></a><span id="l32.7">   if (!editor) {</span>
<a href="#l32.8"></a><span id="l32.8">     window.close();</span>
<a href="#l32.9"></a><span id="l32.9">     return;</span>
<a href="#l32.10"></a><span id="l32.10">   }</span>
<a href="#l32.11"></a><span id="l32.11"> </span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-  gDialog.OkButton  = document.documentElement.getButton(&quot;accept&quot;);</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+  gDialog.OkButton = document.documentElement.getButton(&quot;accept&quot;);</span>
<a href="#l32.14"></a><span id="l32.14">   gDialog.NameInput = document.getElementById(&quot;nameInput&quot;);</span>
<a href="#l32.15"></a><span id="l32.15"> </span>
<a href="#l32.16"></a><span id="l32.16">   // Get a single selected element of the desired type</span>
<a href="#l32.17"></a><span id="l32.17">   gAnchorElement = editor.getSelectedElement(kTagName);</span>
<a href="#l32.18"></a><span id="l32.18"> </span>
<a href="#l32.19"></a><span id="l32.19">   if (gAnchorElement) {</span>
<a href="#l32.20"></a><span id="l32.20">     // We found an element and don't need to insert one</span>
<a href="#l32.21"></a><span id="l32.21">     gInsertNew = false;</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineat">@@ -42,18 +42,19 @@ function Startup() {</span>
<a href="#l32.23"></a><span id="l32.23">     gAnchorElement = editor.createElementWithDefaults(kTagName);</span>
<a href="#l32.24"></a><span id="l32.24">     if (gAnchorElement) {</span>
<a href="#l32.25"></a><span id="l32.25">       // Use the current selection as suggested name</span>
<a href="#l32.26"></a><span id="l32.26">       var name = GetSelectionAsText();</span>
<a href="#l32.27"></a><span id="l32.27">       // Get 40 characters of the selected text and don't add &quot;...&quot;,</span>
<a href="#l32.28"></a><span id="l32.28">       //  replace whitespace with &quot;_&quot; and strip non-word characters</span>
<a href="#l32.29"></a><span id="l32.29">       name = ConvertToCDATAString(TruncateStringAtWordEnd(name, 40, false));</span>
<a href="#l32.30"></a><span id="l32.30">       // Be sure the name is unique to the document</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineminus">-      if (AnchorNameExists(name))</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineplus">+      if (AnchorNameExists(name)) {</span>
<a href="#l32.33"></a><span id="l32.33">         name += &quot;_&quot;;</span>
<a href="#l32.34"></a><span id="l32.34" class="difflineplus">+      }</span>
<a href="#l32.35"></a><span id="l32.35"> </span>
<a href="#l32.36"></a><span id="l32.36">       // Make a copy to use for AdvancedEdit</span>
<a href="#l32.37"></a><span id="l32.37">       globalElement = gAnchorElement.cloneNode(false);</span>
<a href="#l32.38"></a><span id="l32.38">       globalElement.setAttribute(&quot;name&quot;, name);</span>
<a href="#l32.39"></a><span id="l32.39">     }</span>
<a href="#l32.40"></a><span id="l32.40">   }</span>
<a href="#l32.41"></a><span id="l32.41">   if (!gAnchorElement) {</span>
<a href="#l32.42"></a><span id="l32.42">     dump(&quot;Failed to get selected element or create a new one!\n&quot;);</span>
<a href="#l32.43"></a><span id="l32.43" class="difflineat">@@ -91,43 +92,46 @@ function DoEnabling() {</span>
<a href="#l32.44"></a><span id="l32.44"> function AnchorNameExists(name) {</span>
<a href="#l32.45"></a><span id="l32.45">   var anchorList;</span>
<a href="#l32.46"></a><span id="l32.46">   try {</span>
<a href="#l32.47"></a><span id="l32.47">     anchorList = GetCurrentEditor().document.anchors;</span>
<a href="#l32.48"></a><span id="l32.48">   } catch (e) {}</span>
<a href="#l32.49"></a><span id="l32.49"> </span>
<a href="#l32.50"></a><span id="l32.50">   if (anchorList) {</span>
<a href="#l32.51"></a><span id="l32.51">     for (var i = 0; i &lt; anchorList.length; i++) {</span>
<a href="#l32.52"></a><span id="l32.52" class="difflineminus">-      if (anchorList[i].name == name)</span>
<a href="#l32.53"></a><span id="l32.53" class="difflineplus">+      if (anchorList[i].name == name) {</span>
<a href="#l32.54"></a><span id="l32.54">         return true;</span>
<a href="#l32.55"></a><span id="l32.55" class="difflineplus">+      }</span>
<a href="#l32.56"></a><span id="l32.56">     }</span>
<a href="#l32.57"></a><span id="l32.57">   }</span>
<a href="#l32.58"></a><span id="l32.58">   return false;</span>
<a href="#l32.59"></a><span id="l32.59"> }</span>
<a href="#l32.60"></a><span id="l32.60"> </span>
<a href="#l32.61"></a><span id="l32.61"> // Get and validate data from widgets.</span>
<a href="#l32.62"></a><span id="l32.62"> // Set attributes on globalElement so they can be accessed by AdvancedEdit()</span>
<a href="#l32.63"></a><span id="l32.63"> function ValidateData() {</span>
<a href="#l32.64"></a><span id="l32.64">   var name = TrimString(gDialog.NameInput.value);</span>
<a href="#l32.65"></a><span id="l32.65">   if (!name) {</span>
<a href="#l32.66"></a><span id="l32.66" class="difflineminus">-      ShowInputErrorMessage(GetString(&quot;MissingAnchorNameError&quot;));</span>
<a href="#l32.67"></a><span id="l32.67" class="difflineminus">-      SetTextboxFocus(gDialog.NameInput);</span>
<a href="#l32.68"></a><span id="l32.68" class="difflineminus">-      return false;</span>
<a href="#l32.69"></a><span id="l32.69" class="difflineplus">+    ShowInputErrorMessage(GetString(&quot;MissingAnchorNameError&quot;));</span>
<a href="#l32.70"></a><span id="l32.70" class="difflineplus">+    SetTextboxFocus(gDialog.NameInput);</span>
<a href="#l32.71"></a><span id="l32.71" class="difflineplus">+    return false;</span>
<a href="#l32.72"></a><span id="l32.72">   }</span>
<a href="#l32.73"></a><span id="l32.73" class="difflineminus">-    // Replace spaces with &quot;_&quot; and strip other characters</span>
<a href="#l32.74"></a><span id="l32.74" class="difflineminus">-    // Note: we could use ConvertAndEscape, but then we'd</span>
<a href="#l32.75"></a><span id="l32.75" class="difflineminus">-    //  have to UnConverAndEscape beforehand - too messy!</span>
<a href="#l32.76"></a><span id="l32.76" class="difflineminus">-    name = ConvertToCDATAString(name);</span>
<a href="#l32.77"></a><span id="l32.77" class="difflineplus">+  // Replace spaces with &quot;_&quot; and strip other characters</span>
<a href="#l32.78"></a><span id="l32.78" class="difflineplus">+  // Note: we could use ConvertAndEscape, but then we'd</span>
<a href="#l32.79"></a><span id="l32.79" class="difflineplus">+  //  have to UnConverAndEscape beforehand - too messy!</span>
<a href="#l32.80"></a><span id="l32.80" class="difflineplus">+  name = ConvertToCDATAString(name);</span>
<a href="#l32.81"></a><span id="l32.81"> </span>
<a href="#l32.82"></a><span id="l32.82" class="difflineminus">-    if (gOriginalName != name &amp;&amp; AnchorNameExists(name)) {</span>
<a href="#l32.83"></a><span id="l32.83" class="difflineminus">-      ShowInputErrorMessage(GetString(&quot;DuplicateAnchorNameError&quot;).replace(/%name%/, name));</span>
<a href="#l32.84"></a><span id="l32.84" class="difflineminus">-      SetTextboxFocus(gDialog.NameInput);</span>
<a href="#l32.85"></a><span id="l32.85" class="difflineminus">-      return false;</span>
<a href="#l32.86"></a><span id="l32.86" class="difflineminus">-    }</span>
<a href="#l32.87"></a><span id="l32.87" class="difflineminus">-    globalElement.name = name;</span>
<a href="#l32.88"></a><span id="l32.88" class="difflineplus">+  if (gOriginalName != name &amp;&amp; AnchorNameExists(name)) {</span>
<a href="#l32.89"></a><span id="l32.89" class="difflineplus">+    ShowInputErrorMessage(</span>
<a href="#l32.90"></a><span id="l32.90" class="difflineplus">+      GetString(&quot;DuplicateAnchorNameError&quot;).replace(/%name%/, name)</span>
<a href="#l32.91"></a><span id="l32.91" class="difflineplus">+    );</span>
<a href="#l32.92"></a><span id="l32.92" class="difflineplus">+    SetTextboxFocus(gDialog.NameInput);</span>
<a href="#l32.93"></a><span id="l32.93" class="difflineplus">+    return false;</span>
<a href="#l32.94"></a><span id="l32.94" class="difflineplus">+  }</span>
<a href="#l32.95"></a><span id="l32.95" class="difflineplus">+  globalElement.name = name;</span>
<a href="#l32.96"></a><span id="l32.96"> </span>
<a href="#l32.97"></a><span id="l32.97">   return true;</span>
<a href="#l32.98"></a><span id="l32.98"> }</span>
<a href="#l32.99"></a><span id="l32.99"> </span>
<a href="#l32.100"></a><span id="l32.100"> function onAccept(event) {</span>
<a href="#l32.101"></a><span id="l32.101">   if (ValidateData()) {</span>
<a href="#l32.102"></a><span id="l32.102">     if (gOriginalName != globalElement.name) {</span>
<a href="#l32.103"></a><span id="l32.103">       var editor = GetCurrentEditor();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdPageProps.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdPageProps.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -24,42 +24,43 @@ document.addEventListener(&quot;dialogcancel&quot;</span>
<a href="#l33.4"></a><span id="l33.4"> </span>
<a href="#l33.5"></a><span id="l33.5"> function Startup() {</span>
<a href="#l33.6"></a><span id="l33.6">   var editor = GetCurrentEditor();</span>
<a href="#l33.7"></a><span id="l33.7">   if (!editor) {</span>
<a href="#l33.8"></a><span id="l33.8">     window.close();</span>
<a href="#l33.9"></a><span id="l33.9">     return;</span>
<a href="#l33.10"></a><span id="l33.10">   }</span>
<a href="#l33.11"></a><span id="l33.11"> </span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-  gDialog.PageLocation     = document.getElementById(&quot;PageLocation&quot;);</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineminus">-  gDialog.PageModDate      = document.getElementById(&quot;PageModDate&quot;);</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineminus">-  gDialog.TitleInput       = document.getElementById(&quot;TitleInput&quot;);</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineminus">-  gDialog.AuthorInput      = document.getElementById(&quot;AuthorInput&quot;);</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineplus">+  gDialog.PageLocation = document.getElementById(&quot;PageLocation&quot;);</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineplus">+  gDialog.PageModDate = document.getElementById(&quot;PageModDate&quot;);</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineplus">+  gDialog.TitleInput = document.getElementById(&quot;TitleInput&quot;);</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineplus">+  gDialog.AuthorInput = document.getElementById(&quot;AuthorInput&quot;);</span>
<a href="#l33.20"></a><span id="l33.20">   gDialog.DescriptionInput = document.getElementById(&quot;DescriptionInput&quot;);</span>
<a href="#l33.21"></a><span id="l33.21"> </span>
<a href="#l33.22"></a><span id="l33.22">   // Default string for new page is set from DTD string in XUL,</span>
<a href="#l33.23"></a><span id="l33.23">   //   so set only if not new doc URL</span>
<a href="#l33.24"></a><span id="l33.24">   var location = GetDocumentUrl();</span>
<a href="#l33.25"></a><span id="l33.25">   var lastmodString = GetString(&quot;Unknown&quot;);</span>
<a href="#l33.26"></a><span id="l33.26"> </span>
<a href="#l33.27"></a><span id="l33.27">   if (!IsUrlAboutBlank(location)) {</span>
<a href="#l33.28"></a><span id="l33.28">     // NEVER show username and password in clear text</span>
<a href="#l33.29"></a><span id="l33.29">     gDialog.PageLocation.setAttribute(&quot;value&quot;, StripPassword(location));</span>
<a href="#l33.30"></a><span id="l33.30"> </span>
<a href="#l33.31"></a><span id="l33.31">     // Get last-modified file date+time</span>
<a href="#l33.32"></a><span id="l33.32">     // TODO: Convert this to local time?</span>
<a href="#l33.33"></a><span id="l33.33">     var lastmod;</span>
<a href="#l33.34"></a><span id="l33.34">     try {</span>
<a href="#l33.35"></a><span id="l33.35" class="difflineminus">-      lastmod = editor.document.lastModified;  // get string of last modified date</span>
<a href="#l33.36"></a><span id="l33.36" class="difflineplus">+      lastmod = editor.document.lastModified; // get string of last modified date</span>
<a href="#l33.37"></a><span id="l33.37">     } catch (e) {}</span>
<a href="#l33.38"></a><span id="l33.38">     // Convert modified string to date (0 = unknown date or January 1, 1970 GMT)</span>
<a href="#l33.39"></a><span id="l33.39">     if (Date.parse(lastmod)) {</span>
<a href="#l33.40"></a><span id="l33.40">       try {</span>
<a href="#l33.41"></a><span id="l33.41">         const dateTimeFormatter = new Services.intl.DateTimeFormat(undefined, {</span>
<a href="#l33.42"></a><span id="l33.42" class="difflineminus">-          dateStyle: &quot;long&quot;, timeStyle: &quot;short&quot;,</span>
<a href="#l33.43"></a><span id="l33.43" class="difflineplus">+          dateStyle: &quot;long&quot;,</span>
<a href="#l33.44"></a><span id="l33.44" class="difflineplus">+          timeStyle: &quot;short&quot;,</span>
<a href="#l33.45"></a><span id="l33.45">         });</span>
<a href="#l33.46"></a><span id="l33.46"> </span>
<a href="#l33.47"></a><span id="l33.47">         var lastModDate = new Date();</span>
<a href="#l33.48"></a><span id="l33.48">         lastModDate.setTime(Date.parse(lastmod));</span>
<a href="#l33.49"></a><span id="l33.49">         lastmodString = dateTimeFormatter.format(lastModDate);</span>
<a href="#l33.50"></a><span id="l33.50">       } catch (e) {}</span>
<a href="#l33.51"></a><span id="l33.51">     }</span>
<a href="#l33.52"></a><span id="l33.52">   }</span>
<a href="#l33.53"></a><span id="l33.53" class="difflineat">@@ -73,18 +74,19 @@ function Startup() {</span>
<a href="#l33.54"></a><span id="l33.54">       return;</span>
<a href="#l33.55"></a><span id="l33.55">     }</span>
<a href="#l33.56"></a><span id="l33.56">     gInsertNewAuthor = true;</span>
<a href="#l33.57"></a><span id="l33.57">   }</span>
<a href="#l33.58"></a><span id="l33.58"> </span>
<a href="#l33.59"></a><span id="l33.59">   gDescriptionElement = GetMetaElementByAttribute(&quot;name&quot;, &quot;description&quot;);</span>
<a href="#l33.60"></a><span id="l33.60">   if (!gDescriptionElement) {</span>
<a href="#l33.61"></a><span id="l33.61">     gDescriptionElement = CreateMetaElementWithAttribute(&quot;name&quot;, &quot;description&quot;);</span>
<a href="#l33.62"></a><span id="l33.62" class="difflineminus">-    if (!gDescriptionElement)</span>
<a href="#l33.63"></a><span id="l33.63" class="difflineplus">+    if (!gDescriptionElement) {</span>
<a href="#l33.64"></a><span id="l33.64">       window.close();</span>
<a href="#l33.65"></a><span id="l33.65" class="difflineplus">+    }</span>
<a href="#l33.66"></a><span id="l33.66"> </span>
<a href="#l33.67"></a><span id="l33.67">     gInsertNewDescription = true;</span>
<a href="#l33.68"></a><span id="l33.68">   }</span>
<a href="#l33.69"></a><span id="l33.69"> </span>
<a href="#l33.70"></a><span id="l33.70">   InitDialog();</span>
<a href="#l33.71"></a><span id="l33.71"> </span>
<a href="#l33.72"></a><span id="l33.72">   SetTextboxFocus(gDialog.TitleInput);</span>
<a href="#l33.73"></a><span id="l33.73"> </span>
<a href="#l33.74"></a><span id="l33.74" class="difflineat">@@ -126,25 +128,32 @@ function ValidateData() {</span>
<a href="#l33.75"></a><span id="l33.75"> </span>
<a href="#l33.76"></a><span id="l33.76"> function onAccept(event) {</span>
<a href="#l33.77"></a><span id="l33.77">   if (ValidateData()) {</span>
<a href="#l33.78"></a><span id="l33.78">     var editor = GetCurrentEditor();</span>
<a href="#l33.79"></a><span id="l33.79">     editor.beginTransaction();</span>
<a href="#l33.80"></a><span id="l33.80"> </span>
<a href="#l33.81"></a><span id="l33.81">     // Set title contents even if string is empty</span>
<a href="#l33.82"></a><span id="l33.82">     //  because TITLE is a required HTML element</span>
<a href="#l33.83"></a><span id="l33.83" class="difflineminus">-    if (gTitleWasEdited)</span>
<a href="#l33.84"></a><span id="l33.84" class="difflineplus">+    if (gTitleWasEdited) {</span>
<a href="#l33.85"></a><span id="l33.85">       SetDocumentTitle(gNewTitle);</span>
<a href="#l33.86"></a><span id="l33.86" class="difflineplus">+    }</span>
<a href="#l33.87"></a><span id="l33.87" class="difflineplus">+</span>
<a href="#l33.88"></a><span id="l33.88" class="difflineplus">+    if (gAuthorWasEdited) {</span>
<a href="#l33.89"></a><span id="l33.89" class="difflineplus">+      SetMetaElementContent(gAuthorElement, gAuthor, gInsertNewAuthor, false);</span>
<a href="#l33.90"></a><span id="l33.90" class="difflineplus">+    }</span>
<a href="#l33.91"></a><span id="l33.91"> </span>
<a href="#l33.92"></a><span id="l33.92" class="difflineminus">-    if (gAuthorWasEdited)</span>
<a href="#l33.93"></a><span id="l33.93" class="difflineminus">-      SetMetaElementContent(gAuthorElement, gAuthor, gInsertNewAuthor, false);</span>
<a href="#l33.94"></a><span id="l33.94" class="difflineminus">-</span>
<a href="#l33.95"></a><span id="l33.95" class="difflineminus">-    if (gDescWasEdited)</span>
<a href="#l33.96"></a><span id="l33.96" class="difflineminus">-      SetMetaElementContent(gDescriptionElement, gDescription, gInsertNewDescription, false);</span>
<a href="#l33.97"></a><span id="l33.97" class="difflineplus">+    if (gDescWasEdited) {</span>
<a href="#l33.98"></a><span id="l33.98" class="difflineplus">+      SetMetaElementContent(</span>
<a href="#l33.99"></a><span id="l33.99" class="difflineplus">+        gDescriptionElement,</span>
<a href="#l33.100"></a><span id="l33.100" class="difflineplus">+        gDescription,</span>
<a href="#l33.101"></a><span id="l33.101" class="difflineplus">+        gInsertNewDescription,</span>
<a href="#l33.102"></a><span id="l33.102" class="difflineplus">+        false</span>
<a href="#l33.103"></a><span id="l33.103" class="difflineplus">+      );</span>
<a href="#l33.104"></a><span id="l33.104" class="difflineplus">+    }</span>
<a href="#l33.105"></a><span id="l33.105"> </span>
<a href="#l33.106"></a><span id="l33.106">     editor.endTransaction();</span>
<a href="#l33.107"></a><span id="l33.107"> </span>
<a href="#l33.108"></a><span id="l33.108">     SaveWindowLocation();</span>
<a href="#l33.109"></a><span id="l33.109">     return; // do close the window</span>
<a href="#l33.110"></a><span id="l33.110">   }</span>
<a href="#l33.111"></a><span id="l33.111">   event.preventDefault();</span>
<a href="#l33.112"></a><span id="l33.112"> }</span>
<a href="#l33.113"></a><span id="l33.113" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdReplace.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdReplace.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -2,57 +2,61 @@</span>
<a href="#l34.4"></a><span id="l34.4">  *</span>
<a href="#l34.5"></a><span id="l34.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l34.6"></a><span id="l34.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l34.7"></a><span id="l34.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l34.8"></a><span id="l34.8"> </span>
<a href="#l34.9"></a><span id="l34.9"> /* import-globals-from ../../composer/content/editorUtilities.js */</span>
<a href="#l34.10"></a><span id="l34.10"> /* import-globals-from EdDialogCommon.js */</span>
<a href="#l34.11"></a><span id="l34.11"> </span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-var gReplaceDialog;      // Quick access to document/form elements.</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineminus">-var gFindInst;           // nsIWebBrowserFind that we're going to use</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineminus">-var gFindService;        // Global service which remembers find params</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineminus">-var gEditor;             // the editor we're using</span>
<a href="#l34.16"></a><span id="l34.16" class="difflineplus">+var gReplaceDialog; // Quick access to document/form elements.</span>
<a href="#l34.17"></a><span id="l34.17" class="difflineplus">+var gFindInst; // nsIWebBrowserFind that we're going to use</span>
<a href="#l34.18"></a><span id="l34.18" class="difflineplus">+var gFindService; // Global service which remembers find params</span>
<a href="#l34.19"></a><span id="l34.19" class="difflineplus">+var gEditor; // the editor we're using</span>
<a href="#l34.20"></a><span id="l34.20"> </span>
<a href="#l34.21"></a><span id="l34.21" class="difflineminus">-document.addEventListener(&quot;dialogaccept&quot;, (event) =&gt; {</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineplus">+document.addEventListener(&quot;dialogaccept&quot;, event =&gt; {</span>
<a href="#l34.23"></a><span id="l34.23">   onFindNext();</span>
<a href="#l34.24"></a><span id="l34.24">   event.preventDefault();</span>
<a href="#l34.25"></a><span id="l34.25"> });</span>
<a href="#l34.26"></a><span id="l34.26"> </span>
<a href="#l34.27"></a><span id="l34.27"> function initDialogObject() {</span>
<a href="#l34.28"></a><span id="l34.28">   // Create gReplaceDialog object and initialize.</span>
<a href="#l34.29"></a><span id="l34.29">   gReplaceDialog = {};</span>
<a href="#l34.30"></a><span id="l34.30" class="difflineminus">-  gReplaceDialog.findInput       = document.getElementById(&quot;dialog.findInput&quot;);</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineminus">-  gReplaceDialog.replaceInput    = document.getElementById(&quot;dialog.replaceInput&quot;);</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineminus">-  gReplaceDialog.caseSensitive   = document.getElementById(&quot;dialog.caseSensitive&quot;);</span>
<a href="#l34.33"></a><span id="l34.33" class="difflineminus">-  gReplaceDialog.wrap            = document.getElementById(&quot;dialog.wrap&quot;);</span>
<a href="#l34.34"></a><span id="l34.34" class="difflineminus">-  gReplaceDialog.searchBackwards = document.getElementById(&quot;dialog.searchBackwards&quot;);</span>
<a href="#l34.35"></a><span id="l34.35" class="difflineminus">-  gReplaceDialog.findNext        = document.getElementById(&quot;findNext&quot;);</span>
<a href="#l34.36"></a><span id="l34.36" class="difflineminus">-  gReplaceDialog.replace         = document.getElementById(&quot;replace&quot;);</span>
<a href="#l34.37"></a><span id="l34.37" class="difflineminus">-  gReplaceDialog.replaceAndFind  = document.getElementById(&quot;replaceAndFind&quot;);</span>
<a href="#l34.38"></a><span id="l34.38" class="difflineminus">-  gReplaceDialog.replaceAll      = document.getElementById(&quot;replaceAll&quot;);</span>
<a href="#l34.39"></a><span id="l34.39" class="difflineplus">+  gReplaceDialog.findInput = document.getElementById(&quot;dialog.findInput&quot;);</span>
<a href="#l34.40"></a><span id="l34.40" class="difflineplus">+  gReplaceDialog.replaceInput = document.getElementById(&quot;dialog.replaceInput&quot;);</span>
<a href="#l34.41"></a><span id="l34.41" class="difflineplus">+  gReplaceDialog.caseSensitive = document.getElementById(</span>
<a href="#l34.42"></a><span id="l34.42" class="difflineplus">+    &quot;dialog.caseSensitive&quot;</span>
<a href="#l34.43"></a><span id="l34.43" class="difflineplus">+  );</span>
<a href="#l34.44"></a><span id="l34.44" class="difflineplus">+  gReplaceDialog.wrap = document.getElementById(&quot;dialog.wrap&quot;);</span>
<a href="#l34.45"></a><span id="l34.45" class="difflineplus">+  gReplaceDialog.searchBackwards = document.getElementById(</span>
<a href="#l34.46"></a><span id="l34.46" class="difflineplus">+    &quot;dialog.searchBackwards&quot;</span>
<a href="#l34.47"></a><span id="l34.47" class="difflineplus">+  );</span>
<a href="#l34.48"></a><span id="l34.48" class="difflineplus">+  gReplaceDialog.findNext = document.getElementById(&quot;findNext&quot;);</span>
<a href="#l34.49"></a><span id="l34.49" class="difflineplus">+  gReplaceDialog.replace = document.getElementById(&quot;replace&quot;);</span>
<a href="#l34.50"></a><span id="l34.50" class="difflineplus">+  gReplaceDialog.replaceAndFind = document.getElementById(&quot;replaceAndFind&quot;);</span>
<a href="#l34.51"></a><span id="l34.51" class="difflineplus">+  gReplaceDialog.replaceAll = document.getElementById(&quot;replaceAll&quot;);</span>
<a href="#l34.52"></a><span id="l34.52"> }</span>
<a href="#l34.53"></a><span id="l34.53"> </span>
<a href="#l34.54"></a><span id="l34.54"> function loadDialog() {</span>
<a href="#l34.55"></a><span id="l34.55">   // Set initial dialog field contents.</span>
<a href="#l34.56"></a><span id="l34.56">   // Set initial dialog field contents. Use the gFindInst attributes first,</span>
<a href="#l34.57"></a><span id="l34.57">   // this is necessary for window.find()</span>
<a href="#l34.58"></a><span id="l34.58" class="difflineminus">-  gReplaceDialog.findInput.value         = (gFindInst.searchString</span>
<a href="#l34.59"></a><span id="l34.59" class="difflineminus">-                                            ? gFindInst.searchString</span>
<a href="#l34.60"></a><span id="l34.60" class="difflineminus">-                                            : gFindService.searchString);</span>
<a href="#l34.61"></a><span id="l34.61" class="difflineplus">+  gReplaceDialog.findInput.value = gFindInst.searchString</span>
<a href="#l34.62"></a><span id="l34.62" class="difflineplus">+    ? gFindInst.searchString</span>
<a href="#l34.63"></a><span id="l34.63" class="difflineplus">+    : gFindService.searchString;</span>
<a href="#l34.64"></a><span id="l34.64">   gReplaceDialog.replaceInput.value = gFindService.replaceString;</span>
<a href="#l34.65"></a><span id="l34.65" class="difflineminus">-  gReplaceDialog.caseSensitive.checked   = (gFindInst.matchCase</span>
<a href="#l34.66"></a><span id="l34.66" class="difflineminus">-                                            ? gFindInst.matchCase</span>
<a href="#l34.67"></a><span id="l34.67" class="difflineminus">-                                            : gFindService.matchCase);</span>
<a href="#l34.68"></a><span id="l34.68" class="difflineminus">-  gReplaceDialog.wrap.checked            = (gFindInst.wrapFind</span>
<a href="#l34.69"></a><span id="l34.69" class="difflineminus">-                                            ? gFindInst.wrapFind</span>
<a href="#l34.70"></a><span id="l34.70" class="difflineminus">-                                            : gFindService.wrapFind);</span>
<a href="#l34.71"></a><span id="l34.71" class="difflineminus">-  gReplaceDialog.searchBackwards.checked = (gFindInst.findBackwards</span>
<a href="#l34.72"></a><span id="l34.72" class="difflineminus">-                                            ? gFindInst.findBackwards</span>
<a href="#l34.73"></a><span id="l34.73" class="difflineminus">-                                            : gFindService.findBackwards);</span>
<a href="#l34.74"></a><span id="l34.74" class="difflineplus">+  gReplaceDialog.caseSensitive.checked = gFindInst.matchCase</span>
<a href="#l34.75"></a><span id="l34.75" class="difflineplus">+    ? gFindInst.matchCase</span>
<a href="#l34.76"></a><span id="l34.76" class="difflineplus">+    : gFindService.matchCase;</span>
<a href="#l34.77"></a><span id="l34.77" class="difflineplus">+  gReplaceDialog.wrap.checked = gFindInst.wrapFind</span>
<a href="#l34.78"></a><span id="l34.78" class="difflineplus">+    ? gFindInst.wrapFind</span>
<a href="#l34.79"></a><span id="l34.79" class="difflineplus">+    : gFindService.wrapFind;</span>
<a href="#l34.80"></a><span id="l34.80" class="difflineplus">+  gReplaceDialog.searchBackwards.checked = gFindInst.findBackwards</span>
<a href="#l34.81"></a><span id="l34.81" class="difflineplus">+    ? gFindInst.findBackwards</span>
<a href="#l34.82"></a><span id="l34.82" class="difflineplus">+    : gFindService.findBackwards;</span>
<a href="#l34.83"></a><span id="l34.83"> </span>
<a href="#l34.84"></a><span id="l34.84">   doEnabling();</span>
<a href="#l34.85"></a><span id="l34.85"> }</span>
<a href="#l34.86"></a><span id="l34.86"> </span>
<a href="#l34.87"></a><span id="l34.87"> function onLoad() {</span>
<a href="#l34.88"></a><span id="l34.88">   // Get the xul &lt;editor&gt; element:</span>
<a href="#l34.89"></a><span id="l34.89">   var editorElement = window.arguments[0];</span>
<a href="#l34.90"></a><span id="l34.90"> </span>
<a href="#l34.91"></a><span id="l34.91" class="difflineat">@@ -62,79 +66,86 @@ function onLoad() {</span>
<a href="#l34.92"></a><span id="l34.92">     window.close();</span>
<a href="#l34.93"></a><span id="l34.93">     return;</span>
<a href="#l34.94"></a><span id="l34.94">   }</span>
<a href="#l34.95"></a><span id="l34.95"> </span>
<a href="#l34.96"></a><span id="l34.96">   // Get the nsIWebBrowserFind service:</span>
<a href="#l34.97"></a><span id="l34.97">   gFindInst = editorElement.webBrowserFind;</span>
<a href="#l34.98"></a><span id="l34.98"> </span>
<a href="#l34.99"></a><span id="l34.99">   try {</span>
<a href="#l34.100"></a><span id="l34.100" class="difflineminus">-  // get the find service, which stores global find state</span>
<a href="#l34.101"></a><span id="l34.101" class="difflineminus">-    gFindService = Cc[&quot;@mozilla.org/find/find_service;1&quot;]</span>
<a href="#l34.102"></a><span id="l34.102" class="difflineminus">-                         .getService(Ci.nsIFindService);</span>
<a href="#l34.103"></a><span id="l34.103" class="difflineplus">+    // get the find service, which stores global find state</span>
<a href="#l34.104"></a><span id="l34.104" class="difflineplus">+    gFindService = Cc[&quot;@mozilla.org/find/find_service;1&quot;].getService(</span>
<a href="#l34.105"></a><span id="l34.105" class="difflineplus">+      Ci.nsIFindService</span>
<a href="#l34.106"></a><span id="l34.106" class="difflineplus">+    );</span>
<a href="#l34.107"></a><span id="l34.107">   } catch (e) {</span>
<a href="#l34.108"></a><span id="l34.108">     dump(&quot;No find service!\n&quot;);</span>
<a href="#l34.109"></a><span id="l34.109">     gFindService = 0;</span>
<a href="#l34.110"></a><span id="l34.110">   }</span>
<a href="#l34.111"></a><span id="l34.111"> </span>
<a href="#l34.112"></a><span id="l34.112">   // Init gReplaceDialog.</span>
<a href="#l34.113"></a><span id="l34.113">   initDialogObject();</span>
<a href="#l34.114"></a><span id="l34.114"> </span>
<a href="#l34.115"></a><span id="l34.115">   // Change &quot;OK&quot; to &quot;Find&quot;.</span>
<a href="#l34.116"></a><span id="l34.116">   // dialog.find.label = document.getElementById(&quot;fBLT&quot;).getAttribute(&quot;label&quot;);</span>
<a href="#l34.117"></a><span id="l34.117"> </span>
<a href="#l34.118"></a><span id="l34.118">   // Fill dialog.</span>
<a href="#l34.119"></a><span id="l34.119">   loadDialog();</span>
<a href="#l34.120"></a><span id="l34.120"> </span>
<a href="#l34.121"></a><span id="l34.121" class="difflineminus">-  if (gReplaceDialog.findInput.value)</span>
<a href="#l34.122"></a><span id="l34.122" class="difflineplus">+  if (gReplaceDialog.findInput.value) {</span>
<a href="#l34.123"></a><span id="l34.123">     gReplaceDialog.findInput.select();</span>
<a href="#l34.124"></a><span id="l34.124" class="difflineminus">-  else</span>
<a href="#l34.125"></a><span id="l34.125" class="difflineplus">+  } else {</span>
<a href="#l34.126"></a><span id="l34.126">     gReplaceDialog.findInput.focus();</span>
<a href="#l34.127"></a><span id="l34.127" class="difflineplus">+  }</span>
<a href="#l34.128"></a><span id="l34.128"> }</span>
<a href="#l34.129"></a><span id="l34.129"> </span>
<a href="#l34.130"></a><span id="l34.130"> function saveFindData() {</span>
<a href="#l34.131"></a><span id="l34.131">   // Set data attributes per user input.</span>
<a href="#l34.132"></a><span id="l34.132">   if (gFindService) {</span>
<a href="#l34.133"></a><span id="l34.133" class="difflineminus">-    gFindService.searchString  = gReplaceDialog.findInput.value;</span>
<a href="#l34.134"></a><span id="l34.134" class="difflineminus">-    gFindService.matchCase     = gReplaceDialog.caseSensitive.checked;</span>
<a href="#l34.135"></a><span id="l34.135" class="difflineminus">-    gFindService.wrapFind      = gReplaceDialog.wrap.checked;</span>
<a href="#l34.136"></a><span id="l34.136" class="difflineplus">+    gFindService.searchString = gReplaceDialog.findInput.value;</span>
<a href="#l34.137"></a><span id="l34.137" class="difflineplus">+    gFindService.matchCase = gReplaceDialog.caseSensitive.checked;</span>
<a href="#l34.138"></a><span id="l34.138" class="difflineplus">+    gFindService.wrapFind = gReplaceDialog.wrap.checked;</span>
<a href="#l34.139"></a><span id="l34.139">     gFindService.findBackwards = gReplaceDialog.searchBackwards.checked;</span>
<a href="#l34.140"></a><span id="l34.140">   }</span>
<a href="#l34.141"></a><span id="l34.141"> }</span>
<a href="#l34.142"></a><span id="l34.142"> </span>
<a href="#l34.143"></a><span id="l34.143"> function setUpFindInst() {</span>
<a href="#l34.144"></a><span id="l34.144" class="difflineminus">-  gFindInst.searchString  = gReplaceDialog.findInput.value;</span>
<a href="#l34.145"></a><span id="l34.145" class="difflineminus">-  gFindInst.matchCase     = gReplaceDialog.caseSensitive.checked;</span>
<a href="#l34.146"></a><span id="l34.146" class="difflineminus">-  gFindInst.wrapFind      = gReplaceDialog.wrap.checked;</span>
<a href="#l34.147"></a><span id="l34.147" class="difflineplus">+  gFindInst.searchString = gReplaceDialog.findInput.value;</span>
<a href="#l34.148"></a><span id="l34.148" class="difflineplus">+  gFindInst.matchCase = gReplaceDialog.caseSensitive.checked;</span>
<a href="#l34.149"></a><span id="l34.149" class="difflineplus">+  gFindInst.wrapFind = gReplaceDialog.wrap.checked;</span>
<a href="#l34.150"></a><span id="l34.150">   gFindInst.findBackwards = gReplaceDialog.searchBackwards.checked;</span>
<a href="#l34.151"></a><span id="l34.151"> }</span>
<a href="#l34.152"></a><span id="l34.152"> </span>
<a href="#l34.153"></a><span id="l34.153"> function onFindNext() {</span>
<a href="#l34.154"></a><span id="l34.154">   // Transfer dialog contents to the find service.</span>
<a href="#l34.155"></a><span id="l34.155">   saveFindData();</span>
<a href="#l34.156"></a><span id="l34.156">   // set up the find instance</span>
<a href="#l34.157"></a><span id="l34.157">   setUpFindInst();</span>
<a href="#l34.158"></a><span id="l34.158"> </span>
<a href="#l34.159"></a><span id="l34.159">   // Search.</span>
<a href="#l34.160"></a><span id="l34.160">   var result = gFindInst.findNext();</span>
<a href="#l34.161"></a><span id="l34.161"> </span>
<a href="#l34.162"></a><span id="l34.162">   if (!result) {</span>
<a href="#l34.163"></a><span id="l34.163">     var bundle = document.getElementById(&quot;findBundle&quot;);</span>
<a href="#l34.164"></a><span id="l34.164" class="difflineminus">-    Services.prompt.alert(window, GetString(&quot;Alert&quot;), bundle.getString(&quot;notFoundWarning&quot;));</span>
<a href="#l34.165"></a><span id="l34.165" class="difflineplus">+    Services.prompt.alert(</span>
<a href="#l34.166"></a><span id="l34.166" class="difflineplus">+      window,</span>
<a href="#l34.167"></a><span id="l34.167" class="difflineplus">+      GetString(&quot;Alert&quot;),</span>
<a href="#l34.168"></a><span id="l34.168" class="difflineplus">+      bundle.getString(&quot;notFoundWarning&quot;)</span>
<a href="#l34.169"></a><span id="l34.169" class="difflineplus">+    );</span>
<a href="#l34.170"></a><span id="l34.170">     SetTextboxFocus(gReplaceDialog.findInput);</span>
<a href="#l34.171"></a><span id="l34.171">     gReplaceDialog.findInput.select();</span>
<a href="#l34.172"></a><span id="l34.172">     gReplaceDialog.findInput.focus();</span>
<a href="#l34.173"></a><span id="l34.173">     return false;</span>
<a href="#l34.174"></a><span id="l34.174">   }</span>
<a href="#l34.175"></a><span id="l34.175">   return true;</span>
<a href="#l34.176"></a><span id="l34.176"> }</span>
<a href="#l34.177"></a><span id="l34.177"> </span>
<a href="#l34.178"></a><span id="l34.178"> function onReplace() {</span>
<a href="#l34.179"></a><span id="l34.179" class="difflineminus">-  if (!gEditor)</span>
<a href="#l34.180"></a><span id="l34.180" class="difflineplus">+  if (!gEditor) {</span>
<a href="#l34.181"></a><span id="l34.181">     return false;</span>
<a href="#l34.182"></a><span id="l34.182" class="difflineplus">+  }</span>
<a href="#l34.183"></a><span id="l34.183"> </span>
<a href="#l34.184"></a><span id="l34.184">   // Does the current selection match the find string?</span>
<a href="#l34.185"></a><span id="l34.185">   var selection = gEditor.selection;</span>
<a href="#l34.186"></a><span id="l34.186"> </span>
<a href="#l34.187"></a><span id="l34.187">   var selStr = selection.toString();</span>
<a href="#l34.188"></a><span id="l34.188">   var specStr = gReplaceDialog.findInput.value;</span>
<a href="#l34.189"></a><span id="l34.189">   if (!gReplaceDialog.caseSensitive.checked) {</span>
<a href="#l34.190"></a><span id="l34.190">     selStr = selStr.toLowerCase();</span>
<a href="#l34.191"></a><span id="l34.191" class="difflineat">@@ -170,74 +181,80 @@ function onReplace() {</span>
<a href="#l34.192"></a><span id="l34.192">       }</span>
<a href="#l34.193"></a><span id="l34.193">     }</span>
<a href="#l34.194"></a><span id="l34.194">   }</span>
<a href="#l34.195"></a><span id="l34.195"> </span>
<a href="#l34.196"></a><span id="l34.196">   // If the current selection doesn't match the pattern,</span>
<a href="#l34.197"></a><span id="l34.197">   // then we want to find the next match, but not do the replace.</span>
<a href="#l34.198"></a><span id="l34.198">   // That's what most other apps seem to do.</span>
<a href="#l34.199"></a><span id="l34.199">   // So here, just return.</span>
<a href="#l34.200"></a><span id="l34.200" class="difflineminus">-  if (!matches)</span>
<a href="#l34.201"></a><span id="l34.201" class="difflineplus">+  if (!matches) {</span>
<a href="#l34.202"></a><span id="l34.202">     return false;</span>
<a href="#l34.203"></a><span id="l34.203" class="difflineplus">+  }</span>
<a href="#l34.204"></a><span id="l34.204"> </span>
<a href="#l34.205"></a><span id="l34.205">   // Transfer dialog contents to the find service.</span>
<a href="#l34.206"></a><span id="l34.206">   saveFindData();</span>
<a href="#l34.207"></a><span id="l34.207"> </span>
<a href="#l34.208"></a><span id="l34.208">   // For reverse finds, need to remember the caret position</span>
<a href="#l34.209"></a><span id="l34.209">   // before current selection</span>
<a href="#l34.210"></a><span id="l34.210">   var newRange;</span>
<a href="#l34.211"></a><span id="l34.211">   if (gReplaceDialog.searchBackwards.checked &amp;&amp; selection.rangeCount &gt; 0) {</span>
<a href="#l34.212"></a><span id="l34.212">     newRange = selection.getRangeAt(0).cloneRange();</span>
<a href="#l34.213"></a><span id="l34.213">     newRange.collapse(true);</span>
<a href="#l34.214"></a><span id="l34.214">   }</span>
<a href="#l34.215"></a><span id="l34.215"> </span>
<a href="#l34.216"></a><span id="l34.216">   // nsPlaintextEditor::InsertText fails if the string is empty,</span>
<a href="#l34.217"></a><span id="l34.217">   // so make that a special case:</span>
<a href="#l34.218"></a><span id="l34.218">   var replStr = gReplaceDialog.replaceInput.value;</span>
<a href="#l34.219"></a><span id="l34.219" class="difflineminus">-  if (replStr == &quot;&quot;)</span>
<a href="#l34.220"></a><span id="l34.220" class="difflineplus">+  if (replStr == &quot;&quot;) {</span>
<a href="#l34.221"></a><span id="l34.221">     gEditor.deleteSelection(gEditor.eNone, gEditor.eStrip);</span>
<a href="#l34.222"></a><span id="l34.222" class="difflineminus">-  else</span>
<a href="#l34.223"></a><span id="l34.223" class="difflineplus">+  } else {</span>
<a href="#l34.224"></a><span id="l34.224">     gEditor.insertText(replStr);</span>
<a href="#l34.225"></a><span id="l34.225" class="difflineplus">+  }</span>
<a href="#l34.226"></a><span id="l34.226"> </span>
<a href="#l34.227"></a><span id="l34.227">   // For reverse finds, need to move caret just before the replaced text</span>
<a href="#l34.228"></a><span id="l34.228">   if (gReplaceDialog.searchBackwards.checked &amp;&amp; newRange) {</span>
<a href="#l34.229"></a><span id="l34.229">     gEditor.selection.removeAllRanges();</span>
<a href="#l34.230"></a><span id="l34.230">     gEditor.selection.addRange(newRange);</span>
<a href="#l34.231"></a><span id="l34.231">   }</span>
<a href="#l34.232"></a><span id="l34.232"> </span>
<a href="#l34.233"></a><span id="l34.233">   return true;</span>
<a href="#l34.234"></a><span id="l34.234"> }</span>
<a href="#l34.235"></a><span id="l34.235"> </span>
<a href="#l34.236"></a><span id="l34.236"> function onReplaceAll() {</span>
<a href="#l34.237"></a><span id="l34.237" class="difflineminus">-  if (!gEditor)</span>
<a href="#l34.238"></a><span id="l34.238" class="difflineplus">+  if (!gEditor) {</span>
<a href="#l34.239"></a><span id="l34.239">     return;</span>
<a href="#l34.240"></a><span id="l34.240" class="difflineplus">+  }</span>
<a href="#l34.241"></a><span id="l34.241"> </span>
<a href="#l34.242"></a><span id="l34.242">   var findStr = gReplaceDialog.findInput.value;</span>
<a href="#l34.243"></a><span id="l34.243">   var repStr = gReplaceDialog.replaceInput.value;</span>
<a href="#l34.244"></a><span id="l34.244"> </span>
<a href="#l34.245"></a><span id="l34.245">   // Transfer dialog contents to the find service.</span>
<a href="#l34.246"></a><span id="l34.246">   saveFindData();</span>
<a href="#l34.247"></a><span id="l34.247"> </span>
<a href="#l34.248"></a><span id="l34.248" class="difflineminus">-  var finder = Cc[&quot;@mozilla.org/embedcomp/rangefind;1&quot;].createInstance().QueryInterface(Ci.nsIFind);</span>
<a href="#l34.249"></a><span id="l34.249" class="difflineplus">+  var finder = Cc[&quot;@mozilla.org/embedcomp/rangefind;1&quot;]</span>
<a href="#l34.250"></a><span id="l34.250" class="difflineplus">+    .createInstance()</span>
<a href="#l34.251"></a><span id="l34.251" class="difflineplus">+    .QueryInterface(Ci.nsIFind);</span>
<a href="#l34.252"></a><span id="l34.252"> </span>
<a href="#l34.253"></a><span id="l34.253">   finder.caseSensitive = gReplaceDialog.caseSensitive.checked;</span>
<a href="#l34.254"></a><span id="l34.254">   finder.findBackwards = gReplaceDialog.searchBackwards.checked;</span>
<a href="#l34.255"></a><span id="l34.255"> </span>
<a href="#l34.256"></a><span id="l34.256">   // We want the whole operation to be undoable in one swell foop,</span>
<a href="#l34.257"></a><span id="l34.257">   // so start a transaction:</span>
<a href="#l34.258"></a><span id="l34.258">   gEditor.beginTransaction();</span>
<a href="#l34.259"></a><span id="l34.259"> </span>
<a href="#l34.260"></a><span id="l34.260">   // and to make sure we close the transaction, guard against exceptions:</span>
<a href="#l34.261"></a><span id="l34.261">   try {</span>
<a href="#l34.262"></a><span id="l34.262">     // Make a range containing the current selection,</span>
<a href="#l34.263"></a><span id="l34.263">     // so we don't go past it when we wrap.</span>
<a href="#l34.264"></a><span id="l34.264">     var selection = gEditor.selection;</span>
<a href="#l34.265"></a><span id="l34.265">     var selecRange;</span>
<a href="#l34.266"></a><span id="l34.266" class="difflineminus">-    if (selection.rangeCount &gt; 0)</span>
<a href="#l34.267"></a><span id="l34.267" class="difflineplus">+    if (selection.rangeCount &gt; 0) {</span>
<a href="#l34.268"></a><span id="l34.268">       selecRange = selection.getRangeAt(0);</span>
<a href="#l34.269"></a><span id="l34.269" class="difflineplus">+    }</span>
<a href="#l34.270"></a><span id="l34.270">     var origRange = selecRange.cloneRange();</span>
<a href="#l34.271"></a><span id="l34.271"> </span>
<a href="#l34.272"></a><span id="l34.272">     // We'll need a range for the whole document:</span>
<a href="#l34.273"></a><span id="l34.273">     var wholeDocRange = gEditor.document.createRange();</span>
<a href="#l34.274"></a><span id="l34.274">     var rootNode = gEditor.rootElement;</span>
<a href="#l34.275"></a><span id="l34.275">     wholeDocRange.selectNodeContents(rootNode);</span>
<a href="#l34.276"></a><span id="l34.276"> </span>
<a href="#l34.277"></a><span id="l34.277">     // And start and end points:</span>
<a href="#l34.278"></a><span id="l34.278" class="difflineat">@@ -249,35 +266,38 @@ function onReplaceAll() {</span>
<a href="#l34.279"></a><span id="l34.279">     } else {</span>
<a href="#l34.280"></a><span id="l34.280">       endPt.setStart(wholeDocRange.endContainer, wholeDocRange.endOffset);</span>
<a href="#l34.281"></a><span id="l34.281">       endPt.setEnd(wholeDocRange.endContainer, wholeDocRange.endOffset);</span>
<a href="#l34.282"></a><span id="l34.282">     }</span>
<a href="#l34.283"></a><span id="l34.283"> </span>
<a href="#l34.284"></a><span id="l34.284">     // Find and replace from here to end (start) of document:</span>
<a href="#l34.285"></a><span id="l34.285">     var foundRange;</span>
<a href="#l34.286"></a><span id="l34.286">     var searchRange = wholeDocRange.cloneRange();</span>
<a href="#l34.287"></a><span id="l34.287" class="difflineminus">-    while ((foundRange = finder.Find(findStr, searchRange,</span>
<a href="#l34.288"></a><span id="l34.288" class="difflineminus">-                                     selecRange, endPt)) != null) {</span>
<a href="#l34.289"></a><span id="l34.289" class="difflineplus">+    while (</span>
<a href="#l34.290"></a><span id="l34.290" class="difflineplus">+      (foundRange = finder.Find(findStr, searchRange, selecRange, endPt)) !=</span>
<a href="#l34.291"></a><span id="l34.291" class="difflineplus">+      null</span>
<a href="#l34.292"></a><span id="l34.292" class="difflineplus">+    ) {</span>
<a href="#l34.293"></a><span id="l34.293">       gEditor.selection.removeAllRanges();</span>
<a href="#l34.294"></a><span id="l34.294">       gEditor.selection.addRange(foundRange);</span>
<a href="#l34.295"></a><span id="l34.295"> </span>
<a href="#l34.296"></a><span id="l34.296">       // The editor will leave the caret at the end of the replaced text.</span>
<a href="#l34.297"></a><span id="l34.297">       // For reverse finds, we need it at the beginning,</span>
<a href="#l34.298"></a><span id="l34.298">       // so save the next position now.</span>
<a href="#l34.299"></a><span id="l34.299">       if (gReplaceDialog.searchBackwards.checked) {</span>
<a href="#l34.300"></a><span id="l34.300">         selecRange = foundRange.cloneRange();</span>
<a href="#l34.301"></a><span id="l34.301">         selecRange.setEnd(selecRange.startContainer, selecRange.startOffset);</span>
<a href="#l34.302"></a><span id="l34.302">       }</span>
<a href="#l34.303"></a><span id="l34.303"> </span>
<a href="#l34.304"></a><span id="l34.304">       // nsPlaintextEditor::InsertText fails if the string is empty,</span>
<a href="#l34.305"></a><span id="l34.305">       // so make that a special case:</span>
<a href="#l34.306"></a><span id="l34.306" class="difflineminus">-      if (repStr == &quot;&quot;)</span>
<a href="#l34.307"></a><span id="l34.307" class="difflineplus">+      if (repStr == &quot;&quot;) {</span>
<a href="#l34.308"></a><span id="l34.308">         gEditor.deleteSelection(gEditor.eNone, gEditor.eStrip);</span>
<a href="#l34.309"></a><span id="l34.309" class="difflineminus">-      else</span>
<a href="#l34.310"></a><span id="l34.310" class="difflineplus">+      } else {</span>
<a href="#l34.311"></a><span id="l34.311">         gEditor.insertText(repStr);</span>
<a href="#l34.312"></a><span id="l34.312" class="difflineplus">+      }</span>
<a href="#l34.313"></a><span id="l34.313"> </span>
<a href="#l34.314"></a><span id="l34.314">       // If we're going forward, we didn't save selecRange before, so do it now:</span>
<a href="#l34.315"></a><span id="l34.315">       if (!gReplaceDialog.searchBackwards.checked) {</span>
<a href="#l34.316"></a><span id="l34.316">         selection = gEditor.selection;</span>
<a href="#l34.317"></a><span id="l34.317">         if (selection.rangeCount &lt;= 0) {</span>
<a href="#l34.318"></a><span id="l34.318">           gEditor.endTransaction();</span>
<a href="#l34.319"></a><span id="l34.319">           return;</span>
<a href="#l34.320"></a><span id="l34.320">         }</span>
<a href="#l34.321"></a><span id="l34.321" class="difflineat">@@ -297,38 +317,50 @@ function onReplaceAll() {</span>
<a href="#l34.322"></a><span id="l34.322">       origRange.setStart(origRange.endContainer, origRange.endOffset);</span>
<a href="#l34.323"></a><span id="l34.323">       // Set current position to document end</span>
<a href="#l34.324"></a><span id="l34.324">       selecRange.setEnd(wholeDocRange.endContainer, wholeDocRange.endOffset);</span>
<a href="#l34.325"></a><span id="l34.325">       selecRange.setStart(wholeDocRange.endContainer, wholeDocRange.endOffset);</span>
<a href="#l34.326"></a><span id="l34.326">     } else {</span>
<a href="#l34.327"></a><span id="l34.327">       // Collapse origRange to start</span>
<a href="#l34.328"></a><span id="l34.328">       origRange.setEnd(origRange.startContainer, origRange.startOffset);</span>
<a href="#l34.329"></a><span id="l34.329">       // Set current position to document start</span>
<a href="#l34.330"></a><span id="l34.330" class="difflineminus">-      selecRange.setStart(wholeDocRange.startContainer,</span>
<a href="#l34.331"></a><span id="l34.331" class="difflineminus">-                          wholeDocRange.startOffset);</span>
<a href="#l34.332"></a><span id="l34.332" class="difflineminus">-      selecRange.setEnd(wholeDocRange.startContainer, wholeDocRange.startOffset);</span>
<a href="#l34.333"></a><span id="l34.333" class="difflineplus">+      selecRange.setStart(</span>
<a href="#l34.334"></a><span id="l34.334" class="difflineplus">+        wholeDocRange.startContainer,</span>
<a href="#l34.335"></a><span id="l34.335" class="difflineplus">+        wholeDocRange.startOffset</span>
<a href="#l34.336"></a><span id="l34.336" class="difflineplus">+      );</span>
<a href="#l34.337"></a><span id="l34.337" class="difflineplus">+      selecRange.setEnd(</span>
<a href="#l34.338"></a><span id="l34.338" class="difflineplus">+        wholeDocRange.startContainer,</span>
<a href="#l34.339"></a><span id="l34.339" class="difflineplus">+        wholeDocRange.startOffset</span>
<a href="#l34.340"></a><span id="l34.340" class="difflineplus">+      );</span>
<a href="#l34.341"></a><span id="l34.341">     }</span>
<a href="#l34.342"></a><span id="l34.342"> </span>
<a href="#l34.343"></a><span id="l34.343" class="difflineminus">-    while ((foundRange = finder.Find(findStr, wholeDocRange,</span>
<a href="#l34.344"></a><span id="l34.344" class="difflineminus">-                                     selecRange, origRange)) != null) {</span>
<a href="#l34.345"></a><span id="l34.345" class="difflineplus">+    while (</span>
<a href="#l34.346"></a><span id="l34.346" class="difflineplus">+      (foundRange = finder.Find(</span>
<a href="#l34.347"></a><span id="l34.347" class="difflineplus">+        findStr,</span>
<a href="#l34.348"></a><span id="l34.348" class="difflineplus">+        wholeDocRange,</span>
<a href="#l34.349"></a><span id="l34.349" class="difflineplus">+        selecRange,</span>
<a href="#l34.350"></a><span id="l34.350" class="difflineplus">+        origRange</span>
<a href="#l34.351"></a><span id="l34.351" class="difflineplus">+      )) != null</span>
<a href="#l34.352"></a><span id="l34.352" class="difflineplus">+    ) {</span>
<a href="#l34.353"></a><span id="l34.353">       gEditor.selection.removeAllRanges();</span>
<a href="#l34.354"></a><span id="l34.354">       gEditor.selection.addRange(foundRange);</span>
<a href="#l34.355"></a><span id="l34.355"> </span>
<a href="#l34.356"></a><span id="l34.356">       // Save insert point for backward case</span>
<a href="#l34.357"></a><span id="l34.357">       if (gReplaceDialog.searchBackwards.checked) {</span>
<a href="#l34.358"></a><span id="l34.358">         selecRange = foundRange.cloneRange();</span>
<a href="#l34.359"></a><span id="l34.359">         selecRange.setEnd(selecRange.startContainer, selecRange.startOffset);</span>
<a href="#l34.360"></a><span id="l34.360">       }</span>
<a href="#l34.361"></a><span id="l34.361"> </span>
<a href="#l34.362"></a><span id="l34.362">       // nsPlaintextEditor::InsertText fails if the string is empty,</span>
<a href="#l34.363"></a><span id="l34.363">       // so make that a special case:</span>
<a href="#l34.364"></a><span id="l34.364" class="difflineminus">-      if (repStr == &quot;&quot;)</span>
<a href="#l34.365"></a><span id="l34.365" class="difflineplus">+      if (repStr == &quot;&quot;) {</span>
<a href="#l34.366"></a><span id="l34.366">         gEditor.deleteSelection(gEditor.eNone, gEditor.eStrip);</span>
<a href="#l34.367"></a><span id="l34.367" class="difflineminus">-      else</span>
<a href="#l34.368"></a><span id="l34.368" class="difflineplus">+      } else {</span>
<a href="#l34.369"></a><span id="l34.369">         gEditor.insertText(repStr);</span>
<a href="#l34.370"></a><span id="l34.370" class="difflineplus">+      }</span>
<a href="#l34.371"></a><span id="l34.371"> </span>
<a href="#l34.372"></a><span id="l34.372">       // Get insert point for forward case</span>
<a href="#l34.373"></a><span id="l34.373">       if (!gReplaceDialog.searchBackwards.checked) {</span>
<a href="#l34.374"></a><span id="l34.374">         selection = gEditor.selection;</span>
<a href="#l34.375"></a><span id="l34.375">         if (selection.rangeCount &lt;= 0) {</span>
<a href="#l34.376"></a><span id="l34.376">           gEditor.endTransaction();</span>
<a href="#l34.377"></a><span id="l34.377">           return;</span>
<a href="#l34.378"></a><span id="l34.378">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdSelectProps.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdSelectProps.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -20,20 +20,22 @@ var selectedOptionCount = 0;</span>
<a href="#l35.4"></a><span id="l35.4"> </span>
<a href="#l35.5"></a><span id="l35.5"> document.addEventListener(&quot;dialogaccept&quot;, onAccept);</span>
<a href="#l35.6"></a><span id="l35.6"> document.addEventListener(&quot;dialogcancel&quot;, onCancel);</span>
<a href="#l35.7"></a><span id="l35.7"> </span>
<a href="#l35.8"></a><span id="l35.8"> // Utility functions</span>
<a href="#l35.9"></a><span id="l35.9"> </span>
<a href="#l35.10"></a><span id="l35.10"> function getParentIndex(index) {</span>
<a href="#l35.11"></a><span id="l35.11">   switch (itemArray[index].level) {</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-  case 0: return -1;</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineminus">-  case 1: return 0;</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineplus">+    case 0:</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+      return -1;</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineplus">+    case 1:</span>
<a href="#l35.17"></a><span id="l35.17" class="difflineplus">+      return 0;</span>
<a href="#l35.18"></a><span id="l35.18">   }</span>
<a href="#l35.19"></a><span id="l35.19" class="difflineminus">-  while (itemArray[--index].level &gt; 1);</span>
<a href="#l35.20"></a><span id="l35.20" class="difflineplus">+  while (itemArray[--index].level &gt; 1) {}</span>
<a href="#l35.21"></a><span id="l35.21">   return index;</span>
<a href="#l35.22"></a><span id="l35.22"> }</span>
<a href="#l35.23"></a><span id="l35.23"> </span>
<a href="#l35.24"></a><span id="l35.24"> function UpdateSelectMultiple() {</span>
<a href="#l35.25"></a><span id="l35.25">   if (selectedOptionCount &gt; 1) {</span>
<a href="#l35.26"></a><span id="l35.26">     gDialog.selectMultiple.checked = true;</span>
<a href="#l35.27"></a><span id="l35.27">     gDialog.selectMultiple.disabled = true;</span>
<a href="#l35.28"></a><span id="l35.28">   } else {</span>
<a href="#l35.29"></a><span id="l35.29" class="difflineat">@@ -57,29 +59,32 @@ function UpdateSelectMultiple() {</span>
<a href="#l35.30"></a><span id="l35.30">  * void appendOption(newElement, currentIndex);</span>
<a href="#l35.31"></a><span id="l35.31">  */</span>
<a href="#l35.32"></a><span id="l35.32"> </span>
<a href="#l35.33"></a><span id="l35.33"> // OPTION element wrapper object</span>
<a href="#l35.34"></a><span id="l35.34"> </span>
<a href="#l35.35"></a><span id="l35.35"> // Create a wrapper for the given element at the given level</span>
<a href="#l35.36"></a><span id="l35.36"> function optionObject(option, level) {</span>
<a href="#l35.37"></a><span id="l35.37">   // select an added option (when loading from document)</span>
<a href="#l35.38"></a><span id="l35.38" class="difflineminus">-  if (option.hasAttribute(&quot;selected&quot;))</span>
<a href="#l35.39"></a><span id="l35.39" class="difflineplus">+  if (option.hasAttribute(&quot;selected&quot;)) {</span>
<a href="#l35.40"></a><span id="l35.40">     selectedOptionCount++;</span>
<a href="#l35.41"></a><span id="l35.41" class="difflineplus">+  }</span>
<a href="#l35.42"></a><span id="l35.42">   this.level = level;</span>
<a href="#l35.43"></a><span id="l35.43">   this.element = option;</span>
<a href="#l35.44"></a><span id="l35.44"> }</span>
<a href="#l35.45"></a><span id="l35.45"> </span>
<a href="#l35.46"></a><span id="l35.46"> optionObject.prototype.container = false;</span>
<a href="#l35.47"></a><span id="l35.47"> </span>
<a href="#l35.48"></a><span id="l35.48"> optionObject.prototype.getCellText = function(column) {</span>
<a href="#l35.49"></a><span id="l35.49" class="difflineminus">-  if (column.id == &quot;SelectSelCol&quot;)</span>
<a href="#l35.50"></a><span id="l35.50" class="difflineplus">+  if (column.id == &quot;SelectSelCol&quot;) {</span>
<a href="#l35.51"></a><span id="l35.51">     return &quot;&quot;;</span>
<a href="#l35.52"></a><span id="l35.52" class="difflineminus">-  if (column.id == &quot;SelectValCol&quot; &amp;&amp; this.element.hasAttribute(&quot;value&quot;))</span>
<a href="#l35.53"></a><span id="l35.53" class="difflineplus">+  }</span>
<a href="#l35.54"></a><span id="l35.54" class="difflineplus">+  if (column.id == &quot;SelectValCol&quot; &amp;&amp; this.element.hasAttribute(&quot;value&quot;)) {</span>
<a href="#l35.55"></a><span id="l35.55">     return this.element.getAttribute(&quot;value&quot;);</span>
<a href="#l35.56"></a><span id="l35.56" class="difflineplus">+  }</span>
<a href="#l35.57"></a><span id="l35.57">   return this.element.text;</span>
<a href="#l35.58"></a><span id="l35.58"> };</span>
<a href="#l35.59"></a><span id="l35.59"> </span>
<a href="#l35.60"></a><span id="l35.60"> optionObject.prototype.cycleCell = function(index) {</span>
<a href="#l35.61"></a><span id="l35.61">   if (this.element.hasAttribute(&quot;selected&quot;)) {</span>
<a href="#l35.62"></a><span id="l35.62">     this.element.removeAttribute(&quot;selected&quot;);</span>
<a href="#l35.63"></a><span id="l35.63">     selectedOptionCount--;</span>
<a href="#l35.64"></a><span id="l35.64">     selectedOption = null;</span>
<a href="#l35.65"></a><span id="l35.65" class="difflineat">@@ -93,52 +98,59 @@ optionObject.prototype.cycleCell = funct</span>
<a href="#l35.66"></a><span id="l35.66">       theTree.invalidateColumn(column);</span>
<a href="#l35.67"></a><span id="l35.67">       selectedOption = null;</span>
<a href="#l35.68"></a><span id="l35.68">     }</span>
<a href="#l35.69"></a><span id="l35.69">     this.element.setAttribute(&quot;selected&quot;, &quot;&quot;);</span>
<a href="#l35.70"></a><span id="l35.70">     selectedOption = this.element;</span>
<a href="#l35.71"></a><span id="l35.71">     let column = theTree.columns.SelectSelCol;</span>
<a href="#l35.72"></a><span id="l35.72">     theTree.invalidateCell(index, column);</span>
<a href="#l35.73"></a><span id="l35.73">   }</span>
<a href="#l35.74"></a><span id="l35.74" class="difflineminus">-  if (currentItem == this)</span>
<a href="#l35.75"></a><span id="l35.75" class="difflineplus">+  if (currentItem == this) {</span>
<a href="#l35.76"></a><span id="l35.76">     // Also update the deck</span>
<a href="#l35.77"></a><span id="l35.77" class="difflineminus">-    gDialog.optionSelected.setAttribute(&quot;checked&quot;, this.element.hasAttribute(&quot;selected&quot;));</span>
<a href="#l35.78"></a><span id="l35.78" class="difflineplus">+    gDialog.optionSelected.setAttribute(</span>
<a href="#l35.79"></a><span id="l35.79" class="difflineplus">+      &quot;checked&quot;,</span>
<a href="#l35.80"></a><span id="l35.80" class="difflineplus">+      this.element.hasAttribute(&quot;selected&quot;)</span>
<a href="#l35.81"></a><span id="l35.81" class="difflineplus">+    );</span>
<a href="#l35.82"></a><span id="l35.82" class="difflineplus">+  }</span>
<a href="#l35.83"></a><span id="l35.83">   UpdateSelectMultiple();</span>
<a href="#l35.84"></a><span id="l35.84"> };</span>
<a href="#l35.85"></a><span id="l35.85"> </span>
<a href="#l35.86"></a><span id="l35.86"> optionObject.prototype.onFocus = function() {</span>
<a href="#l35.87"></a><span id="l35.87">   gDialog.optionText.value = this.element.text;</span>
<a href="#l35.88"></a><span id="l35.88">   hasValue = this.element.hasAttribute(&quot;value&quot;);</span>
<a href="#l35.89"></a><span id="l35.89">   oldValue = this.element.value;</span>
<a href="#l35.90"></a><span id="l35.90">   gDialog.optionHasValue.checked = hasValue;</span>
<a href="#l35.91"></a><span id="l35.91">   gDialog.optionValue.value = hasValue ? this.element.value : this.element.text;</span>
<a href="#l35.92"></a><span id="l35.92">   gDialog.optionSelected.checked = this.element.hasAttribute(&quot;selected&quot;);</span>
<a href="#l35.93"></a><span id="l35.93">   gDialog.optionDisabled.checked = this.element.hasAttribute(&quot;disabled&quot;);</span>
<a href="#l35.94"></a><span id="l35.94">   gDialog.selectDeck.setAttribute(&quot;selectedIndex&quot;, &quot;2&quot;);</span>
<a href="#l35.95"></a><span id="l35.95"> };</span>
<a href="#l35.96"></a><span id="l35.96"> </span>
<a href="#l35.97"></a><span id="l35.97"> optionObject.prototype.onBlur = function() {</span>
<a href="#l35.98"></a><span id="l35.98">   this.element.text = gDialog.optionText.value;</span>
<a href="#l35.99"></a><span id="l35.99" class="difflineminus">-  if (gDialog.optionHasValue.checked)</span>
<a href="#l35.100"></a><span id="l35.100" class="difflineplus">+  if (gDialog.optionHasValue.checked) {</span>
<a href="#l35.101"></a><span id="l35.101">     this.element.value = gDialog.optionValue.value;</span>
<a href="#l35.102"></a><span id="l35.102" class="difflineminus">-  else</span>
<a href="#l35.103"></a><span id="l35.103" class="difflineplus">+  } else {</span>
<a href="#l35.104"></a><span id="l35.104">     this.element.removeAttribute(&quot;value&quot;);</span>
<a href="#l35.105"></a><span id="l35.105" class="difflineminus">-  if (gDialog.optionSelected.checked)</span>
<a href="#l35.106"></a><span id="l35.106" class="difflineplus">+  }</span>
<a href="#l35.107"></a><span id="l35.107" class="difflineplus">+  if (gDialog.optionSelected.checked) {</span>
<a href="#l35.108"></a><span id="l35.108">     this.element.setAttribute(&quot;selected&quot;, &quot;&quot;);</span>
<a href="#l35.109"></a><span id="l35.109" class="difflineminus">-  else</span>
<a href="#l35.110"></a><span id="l35.110" class="difflineplus">+  } else {</span>
<a href="#l35.111"></a><span id="l35.111">     this.element.removeAttribute(&quot;selected&quot;);</span>
<a href="#l35.112"></a><span id="l35.112" class="difflineminus">-  if (gDialog.optionDisabled.checked)</span>
<a href="#l35.113"></a><span id="l35.113" class="difflineplus">+  }</span>
<a href="#l35.114"></a><span id="l35.114" class="difflineplus">+  if (gDialog.optionDisabled.checked) {</span>
<a href="#l35.115"></a><span id="l35.115">     this.element.setAttribute(&quot;disabled&quot;, &quot;&quot;);</span>
<a href="#l35.116"></a><span id="l35.116" class="difflineminus">-  else</span>
<a href="#l35.117"></a><span id="l35.117" class="difflineplus">+  } else {</span>
<a href="#l35.118"></a><span id="l35.118">     this.element.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l35.119"></a><span id="l35.119" class="difflineplus">+  }</span>
<a href="#l35.120"></a><span id="l35.120"> };</span>
<a href="#l35.121"></a><span id="l35.121"> </span>
<a href="#l35.122"></a><span id="l35.122"> optionObject.prototype.canDestroy = function(prompt) {</span>
<a href="#l35.123"></a><span id="l35.123">   return true;</span>
<a href="#l35.124"></a><span id="l35.124" class="difflineminus">-/* return !prompt ||</span>
<a href="#l35.125"></a><span id="l35.125" class="difflineplus">+  /* return !prompt ||</span>
<a href="#l35.126"></a><span id="l35.126">     ConfirmWithTitle(GetString(&quot;DeleteOption&quot;),</span>
<a href="#l35.127"></a><span id="l35.127">                      GetString(&quot;DeleteOptionMsg&quot;),</span>
<a href="#l35.128"></a><span id="l35.128">                      GetString(&quot;DeleteOption&quot;));*/</span>
<a href="#l35.129"></a><span id="l35.129"> };</span>
<a href="#l35.130"></a><span id="l35.130"> </span>
<a href="#l35.131"></a><span id="l35.131"> optionObject.prototype.destroy = function() {</span>
<a href="#l35.132"></a><span id="l35.132">   // Deselect a removed option</span>
<a href="#l35.133"></a><span id="l35.133">   if (this.element.hasAttribute(&quot;selected&quot;)) {</span>
<a href="#l35.134"></a><span id="l35.134" class="difflineat">@@ -158,17 +170,20 @@ optionObject.prototype.destroy = functio</span>
<a href="#l35.135"></a><span id="l35.135">  * c) option</span>
<a href="#l35.136"></a><span id="l35.136">  *    option</span>
<a href="#l35.137"></a><span id="l35.137">  * d)   option</span>
<a href="#l35.138"></a><span id="l35.138">  *      option</span>
<a href="#l35.139"></a><span id="l35.139">  */</span>
<a href="#l35.140"></a><span id="l35.140"> </span>
<a href="#l35.141"></a><span id="l35.141"> optionObject.prototype.moveUp = function() {</span>
<a href="#l35.142"></a><span id="l35.142">   var index = treeSelection.currentIndex;</span>
<a href="#l35.143"></a><span id="l35.143" class="difflineminus">-  if (itemArray[index].level &lt; itemArray[index - 1].level + itemArray[index - 1].container) {</span>
<a href="#l35.144"></a><span id="l35.144" class="difflineplus">+  if (</span>
<a href="#l35.145"></a><span id="l35.145" class="difflineplus">+    itemArray[index].level &lt;</span>
<a href="#l35.146"></a><span id="l35.146" class="difflineplus">+    itemArray[index - 1].level + itemArray[index - 1].container</span>
<a href="#l35.147"></a><span id="l35.147" class="difflineplus">+  ) {</span>
<a href="#l35.148"></a><span id="l35.148">     // we need to repaint the tree's lines</span>
<a href="#l35.149"></a><span id="l35.149">     theTree.invalidateRange(getParentIndex(index), index);</span>
<a href="#l35.150"></a><span id="l35.150">     // a) option is just after an optgroup, so it becomes the last child</span>
<a href="#l35.151"></a><span id="l35.151">     itemArray[index].level = 2;</span>
<a href="#l35.152"></a><span id="l35.152">     theTree.view.selectionChanged();</span>
<a href="#l35.153"></a><span id="l35.153">   } else {</span>
<a href="#l35.154"></a><span id="l35.154">     // otherwise new option level is now the same as the previous item</span>
<a href="#l35.155"></a><span id="l35.155">     itemArray[index].level = itemArray[index - 1].level;</span>
<a href="#l35.156"></a><span id="l35.156" class="difflineat">@@ -180,35 +195,39 @@ optionObject.prototype.moveUp = function</span>
<a href="#l35.157"></a><span id="l35.157"> </span>
<a href="#l35.158"></a><span id="l35.158"> optionObject.prototype.canMoveDown = function() {</span>
<a href="#l35.159"></a><span id="l35.159">   // move down is not allowed on the last option if its level is 1</span>
<a href="#l35.160"></a><span id="l35.160">   return this.level &gt; 1 || itemArray.length - treeSelection.currentIndex &gt; 1;</span>
<a href="#l35.161"></a><span id="l35.161"> };</span>
<a href="#l35.162"></a><span id="l35.162"> </span>
<a href="#l35.163"></a><span id="l35.163"> optionObject.prototype.moveDown = function() {</span>
<a href="#l35.164"></a><span id="l35.164">   var index = treeSelection.currentIndex;</span>
<a href="#l35.165"></a><span id="l35.165" class="difflineminus">-  if (index + 1 == itemArray.length || itemArray[index].level &gt; itemArray[index + 1].level) {</span>
<a href="#l35.166"></a><span id="l35.166" class="difflineplus">+  if (</span>
<a href="#l35.167"></a><span id="l35.167" class="difflineplus">+    index + 1 == itemArray.length ||</span>
<a href="#l35.168"></a><span id="l35.168" class="difflineplus">+    itemArray[index].level &gt; itemArray[index + 1].level</span>
<a href="#l35.169"></a><span id="l35.169" class="difflineplus">+  ) {</span>
<a href="#l35.170"></a><span id="l35.170">     // we need to repaint the tree's lines</span>
<a href="#l35.171"></a><span id="l35.171">     theTree.invalidateRange(getParentIndex(index), index);</span>
<a href="#l35.172"></a><span id="l35.172">     // a) option is last child of an optgroup, so it moves just after</span>
<a href="#l35.173"></a><span id="l35.173">     itemArray[index].level = 1;</span>
<a href="#l35.174"></a><span id="l35.174">     theTree.view.selectionChanged();</span>
<a href="#l35.175"></a><span id="l35.175">   } else {</span>
<a href="#l35.176"></a><span id="l35.176">     // level increases if the option was preceding an optgroup</span>
<a href="#l35.177"></a><span id="l35.177">     itemArray[index].level += itemArray[index + 1].container;</span>
<a href="#l35.178"></a><span id="l35.178">     // swap the option with the next item</span>
<a href="#l35.179"></a><span id="l35.179">     itemArray.splice(index, 0, itemArray.splice(++index, 1)[0]);</span>
<a href="#l35.180"></a><span id="l35.180">   }</span>
<a href="#l35.181"></a><span id="l35.181">   selectTreeIndex(index, true);</span>
<a href="#l35.182"></a><span id="l35.182"> };</span>
<a href="#l35.183"></a><span id="l35.183"> </span>
<a href="#l35.184"></a><span id="l35.184"> optionObject.prototype.appendOption = function(child, parent) {</span>
<a href="#l35.185"></a><span id="l35.185">   // special case quick check</span>
<a href="#l35.186"></a><span id="l35.186" class="difflineminus">-  if (this.level == 1)</span>
<a href="#l35.187"></a><span id="l35.187" class="difflineplus">+  if (this.level == 1) {</span>
<a href="#l35.188"></a><span id="l35.188">     return gDialog.appendOption(child, 0);</span>
<a href="#l35.189"></a><span id="l35.189" class="difflineplus">+  }</span>
<a href="#l35.190"></a><span id="l35.190"> </span>
<a href="#l35.191"></a><span id="l35.191">   // append the option to the parent element</span>
<a href="#l35.192"></a><span id="l35.192">   parent = getParentIndex(parent);</span>
<a href="#l35.193"></a><span id="l35.193">   return itemArray[parent].appendOption(child, parent);</span>
<a href="#l35.194"></a><span id="l35.194"> };</span>
<a href="#l35.195"></a><span id="l35.195"> </span>
<a href="#l35.196"></a><span id="l35.196"> // OPTGROUP element wrapper object</span>
<a href="#l35.197"></a><span id="l35.197"> </span>
<a href="#l35.198"></a><span id="l35.198" class="difflineat">@@ -219,48 +238,50 @@ function optgroupObject(optgroup) {</span>
<a href="#l35.199"></a><span id="l35.199"> optgroupObject.prototype.level = 1;</span>
<a href="#l35.200"></a><span id="l35.200"> </span>
<a href="#l35.201"></a><span id="l35.201"> optgroupObject.prototype.container = true;</span>
<a href="#l35.202"></a><span id="l35.202"> </span>
<a href="#l35.203"></a><span id="l35.203"> optgroupObject.prototype.getCellText = function(column) {</span>
<a href="#l35.204"></a><span id="l35.204">   return column.id == &quot;SelectTextCol&quot; ? this.element.label : &quot;&quot;;</span>
<a href="#l35.205"></a><span id="l35.205"> };</span>
<a href="#l35.206"></a><span id="l35.206"> </span>
<a href="#l35.207"></a><span id="l35.207" class="difflineminus">-optgroupObject.prototype.cycleCell = function(index) {</span>
<a href="#l35.208"></a><span id="l35.208" class="difflineminus">-};</span>
<a href="#l35.209"></a><span id="l35.209" class="difflineplus">+optgroupObject.prototype.cycleCell = function(index) {};</span>
<a href="#l35.210"></a><span id="l35.210"> </span>
<a href="#l35.211"></a><span id="l35.211"> optgroupObject.prototype.onFocus = function() {</span>
<a href="#l35.212"></a><span id="l35.212">   gDialog.optgroupLabel.value = this.element.label;</span>
<a href="#l35.213"></a><span id="l35.213">   gDialog.optgroupDisabled.checked = this.element.disabled;</span>
<a href="#l35.214"></a><span id="l35.214">   gDialog.selectDeck.setAttribute(&quot;selectedIndex&quot;, &quot;1&quot;);</span>
<a href="#l35.215"></a><span id="l35.215"> };</span>
<a href="#l35.216"></a><span id="l35.216"> </span>
<a href="#l35.217"></a><span id="l35.217"> optgroupObject.prototype.onBlur = function() {</span>
<a href="#l35.218"></a><span id="l35.218">   this.element.label = gDialog.optgroupLabel.value;</span>
<a href="#l35.219"></a><span id="l35.219">   this.element.disabled = gDialog.optgroupDisabled.checked;</span>
<a href="#l35.220"></a><span id="l35.220"> };</span>
<a href="#l35.221"></a><span id="l35.221"> </span>
<a href="#l35.222"></a><span id="l35.222"> optgroupObject.prototype.canDestroy = function(prompt) {</span>
<a href="#l35.223"></a><span id="l35.223">   // Only removing empty option groups for now</span>
<a href="#l35.224"></a><span id="l35.224" class="difflineminus">-  return gDialog.nextChild(treeSelection.currentIndex) - treeSelection.currentIndex == 1;</span>
<a href="#l35.225"></a><span id="l35.225" class="difflineminus">-/* &amp;&amp; (!prompt ||</span>
<a href="#l35.226"></a><span id="l35.226" class="difflineplus">+  return (</span>
<a href="#l35.227"></a><span id="l35.227" class="difflineplus">+    gDialog.nextChild(treeSelection.currentIndex) -</span>
<a href="#l35.228"></a><span id="l35.228" class="difflineplus">+      treeSelection.currentIndex ==</span>
<a href="#l35.229"></a><span id="l35.229" class="difflineplus">+    1</span>
<a href="#l35.230"></a><span id="l35.230" class="difflineplus">+  );</span>
<a href="#l35.231"></a><span id="l35.231" class="difflineplus">+  /* &amp;&amp; (!prompt ||</span>
<a href="#l35.232"></a><span id="l35.232">     ConfirmWithTitle(GetString(&quot;DeleteOptGroup&quot;),</span>
<a href="#l35.233"></a><span id="l35.233">                      GetString(&quot;DeleteOptGroupMsg&quot;),</span>
<a href="#l35.234"></a><span id="l35.234">                      GetString(&quot;DeleteOptGroup&quot;)));</span>
<a href="#l35.235"></a><span id="l35.235"> */</span>
<a href="#l35.236"></a><span id="l35.236"> };</span>
<a href="#l35.237"></a><span id="l35.237"> </span>
<a href="#l35.238"></a><span id="l35.238" class="difflineminus">-optgroupObject.prototype.destroy = function() {</span>
<a href="#l35.239"></a><span id="l35.239" class="difflineminus">-};</span>
<a href="#l35.240"></a><span id="l35.240" class="difflineplus">+optgroupObject.prototype.destroy = function() {};</span>
<a href="#l35.241"></a><span id="l35.241"> </span>
<a href="#l35.242"></a><span id="l35.242"> optgroupObject.prototype.moveUp = function() {</span>
<a href="#l35.243"></a><span id="l35.243">   // Find the index of the previous and next elements at the same level</span>
<a href="#l35.244"></a><span id="l35.244">   var index = treeSelection.currentIndex;</span>
<a href="#l35.245"></a><span id="l35.245">   var i = index;</span>
<a href="#l35.246"></a><span id="l35.246" class="difflineminus">-  while (itemArray[--index].level &gt; 1);</span>
<a href="#l35.247"></a><span id="l35.247" class="difflineplus">+  while (itemArray[--index].level &gt; 1) {}</span>
<a href="#l35.248"></a><span id="l35.248">   var j = gDialog.nextChild(i);</span>
<a href="#l35.249"></a><span id="l35.249">   // Cut out the element, cut the array in two, then join together</span>
<a href="#l35.250"></a><span id="l35.250">   var movedItems = itemArray.splice(i, j - i);</span>
<a href="#l35.251"></a><span id="l35.251">   var endItems = itemArray.splice(index);</span>
<a href="#l35.252"></a><span id="l35.252">   itemArray = itemArray.concat(movedItems).concat(endItems);</span>
<a href="#l35.253"></a><span id="l35.253">   // Repaint the lot</span>
<a href="#l35.254"></a><span id="l35.254">   theTree.invalidateRange(index, j);</span>
<a href="#l35.255"></a><span id="l35.255">   selectTreeIndex(index, true);</span>
<a href="#l35.256"></a><span id="l35.256" class="difflineat">@@ -329,69 +350,75 @@ function Startup() {</span>
<a href="#l35.257"></a><span id="l35.257">       window.close();</span>
<a href="#l35.258"></a><span id="l35.258">       return;</span>
<a href="#l35.259"></a><span id="l35.259">     }</span>
<a href="#l35.260"></a><span id="l35.260">   }</span>
<a href="#l35.261"></a><span id="l35.261"> </span>
<a href="#l35.262"></a><span id="l35.262">   // SELECT element wrapper object</span>
<a href="#l35.263"></a><span id="l35.263">   gDialog = {</span>
<a href="#l35.264"></a><span id="l35.264">     // useful elements</span>
<a href="#l35.265"></a><span id="l35.265" class="difflineminus">-    accept:           document.documentElement.getButton(&quot;accept&quot;),</span>
<a href="#l35.266"></a><span id="l35.266" class="difflineminus">-    selectDeck:       document.getElementById(&quot;SelectDeck&quot;),</span>
<a href="#l35.267"></a><span id="l35.267" class="difflineminus">-    selectName:       document.getElementById(&quot;SelectName&quot;),</span>
<a href="#l35.268"></a><span id="l35.268" class="difflineminus">-    selectSize:       document.getElementById(&quot;SelectSize&quot;),</span>
<a href="#l35.269"></a><span id="l35.269" class="difflineminus">-    selectMultiple:   document.getElementById(&quot;SelectMultiple&quot;),</span>
<a href="#l35.270"></a><span id="l35.270" class="difflineminus">-    selectDisabled:   document.getElementById(&quot;SelectDisabled&quot;),</span>
<a href="#l35.271"></a><span id="l35.271" class="difflineminus">-    selectTabIndex:   document.getElementById(&quot;SelectTabIndex&quot;),</span>
<a href="#l35.272"></a><span id="l35.272" class="difflineminus">-    optgroupLabel:    document.getElementById(&quot;OptGroupLabel&quot;),</span>
<a href="#l35.273"></a><span id="l35.273" class="difflineplus">+    accept: document.documentElement.getButton(&quot;accept&quot;),</span>
<a href="#l35.274"></a><span id="l35.274" class="difflineplus">+    selectDeck: document.getElementById(&quot;SelectDeck&quot;),</span>
<a href="#l35.275"></a><span id="l35.275" class="difflineplus">+    selectName: document.getElementById(&quot;SelectName&quot;),</span>
<a href="#l35.276"></a><span id="l35.276" class="difflineplus">+    selectSize: document.getElementById(&quot;SelectSize&quot;),</span>
<a href="#l35.277"></a><span id="l35.277" class="difflineplus">+    selectMultiple: document.getElementById(&quot;SelectMultiple&quot;),</span>
<a href="#l35.278"></a><span id="l35.278" class="difflineplus">+    selectDisabled: document.getElementById(&quot;SelectDisabled&quot;),</span>
<a href="#l35.279"></a><span id="l35.279" class="difflineplus">+    selectTabIndex: document.getElementById(&quot;SelectTabIndex&quot;),</span>
<a href="#l35.280"></a><span id="l35.280" class="difflineplus">+    optgroupLabel: document.getElementById(&quot;OptGroupLabel&quot;),</span>
<a href="#l35.281"></a><span id="l35.281">     optgroupDisabled: document.getElementById(&quot;OptGroupDisabled&quot;),</span>
<a href="#l35.282"></a><span id="l35.282" class="difflineminus">-    optionText:       document.getElementById(&quot;OptionText&quot;),</span>
<a href="#l35.283"></a><span id="l35.283" class="difflineminus">-    optionHasValue:   document.getElementById(&quot;OptionHasValue&quot;),</span>
<a href="#l35.284"></a><span id="l35.284" class="difflineminus">-    optionValue:      document.getElementById(&quot;OptionValue&quot;),</span>
<a href="#l35.285"></a><span id="l35.285" class="difflineminus">-    optionSelected:   document.getElementById(&quot;OptionSelected&quot;),</span>
<a href="#l35.286"></a><span id="l35.286" class="difflineminus">-    optionDisabled:   document.getElementById(&quot;OptionDisabled&quot;),</span>
<a href="#l35.287"></a><span id="l35.287" class="difflineminus">-    removeButton:     document.getElementById(&quot;RemoveButton&quot;),</span>
<a href="#l35.288"></a><span id="l35.288" class="difflineminus">-    previousButton:   document.getElementById(&quot;PreviousButton&quot;),</span>
<a href="#l35.289"></a><span id="l35.289" class="difflineminus">-    nextButton:       document.getElementById(&quot;NextButton&quot;),</span>
<a href="#l35.290"></a><span id="l35.290" class="difflineminus">-    tree:             document.getElementById(&quot;SelectTree&quot;),</span>
<a href="#l35.291"></a><span id="l35.291" class="difflineplus">+    optionText: document.getElementById(&quot;OptionText&quot;),</span>
<a href="#l35.292"></a><span id="l35.292" class="difflineplus">+    optionHasValue: document.getElementById(&quot;OptionHasValue&quot;),</span>
<a href="#l35.293"></a><span id="l35.293" class="difflineplus">+    optionValue: document.getElementById(&quot;OptionValue&quot;),</span>
<a href="#l35.294"></a><span id="l35.294" class="difflineplus">+    optionSelected: document.getElementById(&quot;OptionSelected&quot;),</span>
<a href="#l35.295"></a><span id="l35.295" class="difflineplus">+    optionDisabled: document.getElementById(&quot;OptionDisabled&quot;),</span>
<a href="#l35.296"></a><span id="l35.296" class="difflineplus">+    removeButton: document.getElementById(&quot;RemoveButton&quot;),</span>
<a href="#l35.297"></a><span id="l35.297" class="difflineplus">+    previousButton: document.getElementById(&quot;PreviousButton&quot;),</span>
<a href="#l35.298"></a><span id="l35.298" class="difflineplus">+    nextButton: document.getElementById(&quot;NextButton&quot;),</span>
<a href="#l35.299"></a><span id="l35.299" class="difflineplus">+    tree: document.getElementById(&quot;SelectTree&quot;),</span>
<a href="#l35.300"></a><span id="l35.300">     // wrapper methods (except MoveUp and MoveDown)</span>
<a href="#l35.301"></a><span id="l35.301" class="difflineminus">-    element:          selectElement.cloneNode(false),</span>
<a href="#l35.302"></a><span id="l35.302" class="difflineminus">-    level:            0,</span>
<a href="#l35.303"></a><span id="l35.303" class="difflineminus">-    container:        true,</span>
<a href="#l35.304"></a><span id="l35.304" class="difflineplus">+    element: selectElement.cloneNode(false),</span>
<a href="#l35.305"></a><span id="l35.305" class="difflineplus">+    level: 0,</span>
<a href="#l35.306"></a><span id="l35.306" class="difflineplus">+    container: true,</span>
<a href="#l35.307"></a><span id="l35.307">     getCellText(column) {</span>
<a href="#l35.308"></a><span id="l35.308" class="difflineminus">-      return column.id == &quot;SelectTextCol&quot; ? this.element.getAttribute(&quot;name&quot;) : &quot;&quot;;</span>
<a href="#l35.309"></a><span id="l35.309" class="difflineplus">+      return column.id == &quot;SelectTextCol&quot;</span>
<a href="#l35.310"></a><span id="l35.310" class="difflineplus">+        ? this.element.getAttribute(&quot;name&quot;)</span>
<a href="#l35.311"></a><span id="l35.311" class="difflineplus">+        : &quot;&quot;;</span>
<a href="#l35.312"></a><span id="l35.312">     },</span>
<a href="#l35.313"></a><span id="l35.313">     cycleCell(index) {},</span>
<a href="#l35.314"></a><span id="l35.314">     onFocus() {</span>
<a href="#l35.315"></a><span id="l35.315">       gDialog.selectName.value = this.element.getAttribute(&quot;name&quot;);</span>
<a href="#l35.316"></a><span id="l35.316">       gDialog.selectSize.value = this.element.getAttribute(&quot;size&quot;);</span>
<a href="#l35.317"></a><span id="l35.317">       gDialog.selectMultiple.checked = this.element.hasAttribute(&quot;multiple&quot;);</span>
<a href="#l35.318"></a><span id="l35.318">       gDialog.selectDisabled.checked = this.element.hasAttribute(&quot;disabled&quot;);</span>
<a href="#l35.319"></a><span id="l35.319">       gDialog.selectTabIndex.value = this.element.getAttribute(&quot;tabindex&quot;);</span>
<a href="#l35.320"></a><span id="l35.320">       this.selectDeck.setAttribute(&quot;selectedIndex&quot;, &quot;0&quot;);</span>
<a href="#l35.321"></a><span id="l35.321">       onNameInput();</span>
<a href="#l35.322"></a><span id="l35.322">     },</span>
<a href="#l35.323"></a><span id="l35.323">     onBlur() {</span>
<a href="#l35.324"></a><span id="l35.324">       this.element.setAttribute(&quot;name&quot;, gDialog.selectName.value);</span>
<a href="#l35.325"></a><span id="l35.325" class="difflineminus">-      if (gDialog.selectSize.value)</span>
<a href="#l35.326"></a><span id="l35.326" class="difflineplus">+      if (gDialog.selectSize.value) {</span>
<a href="#l35.327"></a><span id="l35.327">         this.element.setAttribute(&quot;size&quot;, gDialog.selectSize.value);</span>
<a href="#l35.328"></a><span id="l35.328" class="difflineminus">-      else</span>
<a href="#l35.329"></a><span id="l35.329" class="difflineplus">+      } else {</span>
<a href="#l35.330"></a><span id="l35.330">         this.element.removeAttribute(&quot;size&quot;);</span>
<a href="#l35.331"></a><span id="l35.331" class="difflineminus">-      if (gDialog.selectMultiple.checked)</span>
<a href="#l35.332"></a><span id="l35.332" class="difflineplus">+      }</span>
<a href="#l35.333"></a><span id="l35.333" class="difflineplus">+      if (gDialog.selectMultiple.checked) {</span>
<a href="#l35.334"></a><span id="l35.334">         this.element.setAttribute(&quot;multiple&quot;, &quot;&quot;);</span>
<a href="#l35.335"></a><span id="l35.335" class="difflineminus">-      else</span>
<a href="#l35.336"></a><span id="l35.336" class="difflineplus">+      } else {</span>
<a href="#l35.337"></a><span id="l35.337">         this.element.removeAttribute(&quot;multiple&quot;);</span>
<a href="#l35.338"></a><span id="l35.338" class="difflineminus">-      if (gDialog.selectDisabled.checked)</span>
<a href="#l35.339"></a><span id="l35.339" class="difflineplus">+      }</span>
<a href="#l35.340"></a><span id="l35.340" class="difflineplus">+      if (gDialog.selectDisabled.checked) {</span>
<a href="#l35.341"></a><span id="l35.341">         this.element.setAttribute(&quot;disabled&quot;, &quot;&quot;);</span>
<a href="#l35.342"></a><span id="l35.342" class="difflineminus">-      else</span>
<a href="#l35.343"></a><span id="l35.343" class="difflineplus">+      } else {</span>
<a href="#l35.344"></a><span id="l35.344">         this.element.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l35.345"></a><span id="l35.345" class="difflineminus">-      if (gDialog.selectTabIndex.value)</span>
<a href="#l35.346"></a><span id="l35.346" class="difflineplus">+      }</span>
<a href="#l35.347"></a><span id="l35.347" class="difflineplus">+      if (gDialog.selectTabIndex.value) {</span>
<a href="#l35.348"></a><span id="l35.348">         this.element.setAttribute(&quot;tabindex&quot;, gDialog.selectTabIndex.value);</span>
<a href="#l35.349"></a><span id="l35.349" class="difflineminus">-      else</span>
<a href="#l35.350"></a><span id="l35.350" class="difflineplus">+      } else {</span>
<a href="#l35.351"></a><span id="l35.351">         this.element.removeAttribute(&quot;tabindex&quot;);</span>
<a href="#l35.352"></a><span id="l35.352" class="difflineplus">+      }</span>
<a href="#l35.353"></a><span id="l35.353">     },</span>
<a href="#l35.354"></a><span id="l35.354">     appendOption(child, parent) {</span>
<a href="#l35.355"></a><span id="l35.355">       var index = itemArray.length;</span>
<a href="#l35.356"></a><span id="l35.356">       // XXX need to repaint the lines, tree won't do this</span>
<a href="#l35.357"></a><span id="l35.357">       theTree.invalidateRange(this.lastChild(), index);</span>
<a href="#l35.358"></a><span id="l35.358">       // append the wrapped object</span>
<a href="#l35.359"></a><span id="l35.359">       itemArray.push(new optionObject(child, 1));</span>
<a href="#l35.360"></a><span id="l35.360">       theTree.rowCountChanged(index, 1);</span>
<a href="#l35.361"></a><span id="l35.361" class="difflineat">@@ -401,107 +428,157 @@ function Startup() {</span>
<a href="#l35.362"></a><span id="l35.362">       return false;</span>
<a href="#l35.363"></a><span id="l35.363">     },</span>
<a href="#l35.364"></a><span id="l35.364">     canMoveDown() {</span>
<a href="#l35.365"></a><span id="l35.365">       return false;</span>
<a href="#l35.366"></a><span id="l35.366">     },</span>
<a href="#l35.367"></a><span id="l35.367">     // helper methods</span>
<a href="#l35.368"></a><span id="l35.368">     // Find the index of the next immediate child of the select</span>
<a href="#l35.369"></a><span id="l35.369">     nextChild(index) {</span>
<a href="#l35.370"></a><span id="l35.370" class="difflineminus">-      while (++index &lt; itemArray.length &amp;&amp; itemArray[index].level &gt; 1);</span>
<a href="#l35.371"></a><span id="l35.371" class="difflineplus">+      while (++index &lt; itemArray.length &amp;&amp; itemArray[index].level &gt; 1) {}</span>
<a href="#l35.372"></a><span id="l35.372">       return index;</span>
<a href="#l35.373"></a><span id="l35.373">     },</span>
<a href="#l35.374"></a><span id="l35.374">     // Find the index of the last immediate child of the select</span>
<a href="#l35.375"></a><span id="l35.375">     lastChild() {</span>
<a href="#l35.376"></a><span id="l35.376">       var index = itemArray.length;</span>
<a href="#l35.377"></a><span id="l35.377" class="difflineminus">-      while (itemArray[--index].level &gt; 1);</span>
<a href="#l35.378"></a><span id="l35.378" class="difflineplus">+      while (itemArray[--index].level &gt; 1) {}</span>
<a href="#l35.379"></a><span id="l35.379">       return index;</span>
<a href="#l35.380"></a><span id="l35.380">     },</span>
<a href="#l35.381"></a><span id="l35.381">   };</span>
<a href="#l35.382"></a><span id="l35.382">   // Start with the &lt;select&gt; wrapper</span>
<a href="#l35.383"></a><span id="l35.383">   itemArray = [gDialog];</span>
<a href="#l35.384"></a><span id="l35.384"> </span>
<a href="#l35.385"></a><span id="l35.385">   // We modify the actual option and optgroup elements so clone them first</span>
<a href="#l35.386"></a><span id="l35.386">   for (var child = selectElement.firstChild; child; child = child.nextSibling) {</span>
<a href="#l35.387"></a><span id="l35.387">     if (child.tagName == &quot;OPTION&quot;) {</span>
<a href="#l35.388"></a><span id="l35.388">       itemArray.push(new optionObject(child.cloneNode(true), 1));</span>
<a href="#l35.389"></a><span id="l35.389">     } else if (child.tagName == &quot;OPTGROUP&quot;) {</span>
<a href="#l35.390"></a><span id="l35.390">       itemArray.push(new optgroupObject(child.cloneNode(false)));</span>
<a href="#l35.391"></a><span id="l35.391" class="difflineminus">-      for (var grandchild = child.firstChild; grandchild; grandchild = grandchild.nextSibling)</span>
<a href="#l35.392"></a><span id="l35.392" class="difflineminus">-        if (grandchild.tagName == &quot;OPTION&quot;)</span>
<a href="#l35.393"></a><span id="l35.393" class="difflineplus">+      for (</span>
<a href="#l35.394"></a><span id="l35.394" class="difflineplus">+        var grandchild = child.firstChild;</span>
<a href="#l35.395"></a><span id="l35.395" class="difflineplus">+        grandchild;</span>
<a href="#l35.396"></a><span id="l35.396" class="difflineplus">+        grandchild = grandchild.nextSibling</span>
<a href="#l35.397"></a><span id="l35.397" class="difflineplus">+      ) {</span>
<a href="#l35.398"></a><span id="l35.398" class="difflineplus">+        if (grandchild.tagName == &quot;OPTION&quot;) {</span>
<a href="#l35.399"></a><span id="l35.399">           itemArray.push(new optionObject(grandchild.cloneNode(true), 2));</span>
<a href="#l35.400"></a><span id="l35.400" class="difflineplus">+        }</span>
<a href="#l35.401"></a><span id="l35.401" class="difflineplus">+      }</span>
<a href="#l35.402"></a><span id="l35.402">     }</span>
<a href="#l35.403"></a><span id="l35.403">   }</span>
<a href="#l35.404"></a><span id="l35.404"> </span>
<a href="#l35.405"></a><span id="l35.405">   UpdateSelectMultiple();</span>
<a href="#l35.406"></a><span id="l35.406"> </span>
<a href="#l35.407"></a><span id="l35.407">   // Define a custom view for the tree</span>
<a href="#l35.408"></a><span id="l35.408">   theTree = gDialog.tree;</span>
<a href="#l35.409"></a><span id="l35.409">   theTree.view = {</span>
<a href="#l35.410"></a><span id="l35.410" class="difflineminus">-    QueryInterface: ChromeUtils.generateQI([&quot;nsITreeView&quot;,</span>
<a href="#l35.411"></a><span id="l35.411" class="difflineminus">-                                            &quot;nsISupportsWeakReference&quot;]),</span>
<a href="#l35.412"></a><span id="l35.412" class="difflineplus">+    QueryInterface: ChromeUtils.generateQI([</span>
<a href="#l35.413"></a><span id="l35.413" class="difflineplus">+      &quot;nsITreeView&quot;,</span>
<a href="#l35.414"></a><span id="l35.414" class="difflineplus">+      &quot;nsISupportsWeakReference&quot;,</span>
<a href="#l35.415"></a><span id="l35.415" class="difflineplus">+    ]),</span>
<a href="#l35.416"></a><span id="l35.416">     // useful for debugging</span>
<a href="#l35.417"></a><span id="l35.417" class="difflineminus">-    get wrappedJSObject() { return this; },</span>
<a href="#l35.418"></a><span id="l35.418" class="difflineminus">-    get rowCount() { return itemArray.length; },</span>
<a href="#l35.419"></a><span id="l35.419" class="difflineminus">-    get selection() { return treeSelection; },</span>
<a href="#l35.420"></a><span id="l35.420" class="difflineminus">-    set selection(selection) { return treeSelection = selection; },</span>
<a href="#l35.421"></a><span id="l35.421" class="difflineminus">-    getRowProperties(index) { return &quot;&quot;; },</span>
<a href="#l35.422"></a><span id="l35.422" class="difflineplus">+    get wrappedJSObject() {</span>
<a href="#l35.423"></a><span id="l35.423" class="difflineplus">+      return this;</span>
<a href="#l35.424"></a><span id="l35.424" class="difflineplus">+    },</span>
<a href="#l35.425"></a><span id="l35.425" class="difflineplus">+    get rowCount() {</span>
<a href="#l35.426"></a><span id="l35.426" class="difflineplus">+      return itemArray.length;</span>
<a href="#l35.427"></a><span id="l35.427" class="difflineplus">+    },</span>
<a href="#l35.428"></a><span id="l35.428" class="difflineplus">+    get selection() {</span>
<a href="#l35.429"></a><span id="l35.429" class="difflineplus">+      return treeSelection;</span>
<a href="#l35.430"></a><span id="l35.430" class="difflineplus">+    },</span>
<a href="#l35.431"></a><span id="l35.431" class="difflineplus">+    set selection(selection) {</span>
<a href="#l35.432"></a><span id="l35.432" class="difflineplus">+      return (treeSelection = selection);</span>
<a href="#l35.433"></a><span id="l35.433" class="difflineplus">+    },</span>
<a href="#l35.434"></a><span id="l35.434" class="difflineplus">+    getRowProperties(index) {</span>
<a href="#l35.435"></a><span id="l35.435" class="difflineplus">+      return &quot;&quot;;</span>
<a href="#l35.436"></a><span id="l35.436" class="difflineplus">+    },</span>
<a href="#l35.437"></a><span id="l35.437">     // could have used a wrapper for this</span>
<a href="#l35.438"></a><span id="l35.438">     getCellProperties(index, column) {</span>
<a href="#l35.439"></a><span id="l35.439" class="difflineminus">-      if (column.id == &quot;SelectSelCol&quot; &amp;&amp; !itemArray[index].container)</span>
<a href="#l35.440"></a><span id="l35.440" class="difflineplus">+      if (column.id == &quot;SelectSelCol&quot; &amp;&amp; !itemArray[index].container) {</span>
<a href="#l35.441"></a><span id="l35.441">         return &quot;checked-&quot; + itemArray[index].element.hasAttribute(&quot;selected&quot;);</span>
<a href="#l35.442"></a><span id="l35.442" class="difflineplus">+      }</span>
<a href="#l35.443"></a><span id="l35.443" class="difflineplus">+      return &quot;&quot;;</span>
<a href="#l35.444"></a><span id="l35.444" class="difflineplus">+    },</span>
<a href="#l35.445"></a><span id="l35.445" class="difflineplus">+    getColumnProperties(column) {</span>
<a href="#l35.446"></a><span id="l35.446">       return &quot;&quot;;</span>
<a href="#l35.447"></a><span id="l35.447">     },</span>
<a href="#l35.448"></a><span id="l35.448" class="difflineminus">-    getColumnProperties(column) { return &quot;&quot;; },</span>
<a href="#l35.449"></a><span id="l35.449">     // get info from wrapper</span>
<a href="#l35.450"></a><span id="l35.450" class="difflineminus">-    isContainer(index) { return itemArray[index].container; },</span>
<a href="#l35.451"></a><span id="l35.451" class="difflineminus">-    isContainerOpen(index) { return true; },</span>
<a href="#l35.452"></a><span id="l35.452" class="difflineminus">-    isContainerEmpty(index) { return true; },</span>
<a href="#l35.453"></a><span id="l35.453" class="difflineminus">-    isSeparator(index) { return false; },</span>
<a href="#l35.454"></a><span id="l35.454" class="difflineminus">-    isSorted() { return false; },</span>
<a href="#l35.455"></a><span id="l35.455" class="difflineplus">+    isContainer(index) {</span>
<a href="#l35.456"></a><span id="l35.456" class="difflineplus">+      return itemArray[index].container;</span>
<a href="#l35.457"></a><span id="l35.457" class="difflineplus">+    },</span>
<a href="#l35.458"></a><span id="l35.458" class="difflineplus">+    isContainerOpen(index) {</span>
<a href="#l35.459"></a><span id="l35.459" class="difflineplus">+      return true;</span>
<a href="#l35.460"></a><span id="l35.460" class="difflineplus">+    },</span>
<a href="#l35.461"></a><span id="l35.461" class="difflineplus">+    isContainerEmpty(index) {</span>
<a href="#l35.462"></a><span id="l35.462" class="difflineplus">+      return true;</span>
<a href="#l35.463"></a><span id="l35.463" class="difflineplus">+    },</span>
<a href="#l35.464"></a><span id="l35.464" class="difflineplus">+    isSeparator(index) {</span>
<a href="#l35.465"></a><span id="l35.465" class="difflineplus">+      return false;</span>
<a href="#l35.466"></a><span id="l35.466" class="difflineplus">+    },</span>
<a href="#l35.467"></a><span id="l35.467" class="difflineplus">+    isSorted() {</span>
<a href="#l35.468"></a><span id="l35.468" class="difflineplus">+      return false;</span>
<a href="#l35.469"></a><span id="l35.469" class="difflineplus">+    },</span>
<a href="#l35.470"></a><span id="l35.470">     // d&amp;d not implemented yet!</span>
<a href="#l35.471"></a><span id="l35.471" class="difflineminus">-    canDrop(index, orientation) { return false; },</span>
<a href="#l35.472"></a><span id="l35.472" class="difflineminus">-    drop(index, orientation) { alert(&quot;drop:&quot; + index + &quot;,&quot; + orientation); },</span>
<a href="#l35.473"></a><span id="l35.473" class="difflineplus">+    canDrop(index, orientation) {</span>
<a href="#l35.474"></a><span id="l35.474" class="difflineplus">+      return false;</span>
<a href="#l35.475"></a><span id="l35.475" class="difflineplus">+    },</span>
<a href="#l35.476"></a><span id="l35.476" class="difflineplus">+    drop(index, orientation) {</span>
<a href="#l35.477"></a><span id="l35.477" class="difflineplus">+      alert(&quot;drop:&quot; + index + &quot;,&quot; + orientation);</span>
<a href="#l35.478"></a><span id="l35.478" class="difflineplus">+    },</span>
<a href="#l35.479"></a><span id="l35.479">     // same as the global helper</span>
<a href="#l35.480"></a><span id="l35.480">     getParentIndex,</span>
<a href="#l35.481"></a><span id="l35.481">     // tree needs to know when to paint lines</span>
<a href="#l35.482"></a><span id="l35.482">     hasNextSibling(index, after) {</span>
<a href="#l35.483"></a><span id="l35.483" class="difflineminus">-      if (!index)</span>
<a href="#l35.484"></a><span id="l35.484" class="difflineplus">+      if (!index) {</span>
<a href="#l35.485"></a><span id="l35.485">         return false;</span>
<a href="#l35.486"></a><span id="l35.486" class="difflineplus">+      }</span>
<a href="#l35.487"></a><span id="l35.487">       var level = itemArray[index].level;</span>
<a href="#l35.488"></a><span id="l35.488" class="difflineminus">-      while (++after &lt; itemArray.length)</span>
<a href="#l35.489"></a><span id="l35.489" class="difflineplus">+      while (++after &lt; itemArray.length) {</span>
<a href="#l35.490"></a><span id="l35.490">         switch (level - itemArray[after].level) {</span>
<a href="#l35.491"></a><span id="l35.491" class="difflineminus">-        case 1: return false;</span>
<a href="#l35.492"></a><span id="l35.492" class="difflineminus">-        case 0: return true;</span>
<a href="#l35.493"></a><span id="l35.493" class="difflineplus">+          case 1:</span>
<a href="#l35.494"></a><span id="l35.494" class="difflineplus">+            return false;</span>
<a href="#l35.495"></a><span id="l35.495" class="difflineplus">+          case 0:</span>
<a href="#l35.496"></a><span id="l35.496" class="difflineplus">+            return true;</span>
<a href="#l35.497"></a><span id="l35.497">         }</span>
<a href="#l35.498"></a><span id="l35.498" class="difflineplus">+      }</span>
<a href="#l35.499"></a><span id="l35.499">       return false;</span>
<a href="#l35.500"></a><span id="l35.500">     },</span>
<a href="#l35.501"></a><span id="l35.501" class="difflineminus">-    getLevel(index) { return itemArray[index].level; },</span>
<a href="#l35.502"></a><span id="l35.502" class="difflineminus">-    getImageSrc(index, column) { },</span>
<a href="#l35.503"></a><span id="l35.503" class="difflineminus">-    getProgressMode(index, column) { },</span>
<a href="#l35.504"></a><span id="l35.504" class="difflineminus">-    getCellValue(index, column) { },</span>
<a href="#l35.505"></a><span id="l35.505" class="difflineminus">-    getCellText(index, column) { return itemArray[index].getCellText(column); },</span>
<a href="#l35.506"></a><span id="l35.506" class="difflineminus">-    setTree(tree) { this.tree = tree; },</span>
<a href="#l35.507"></a><span id="l35.507" class="difflineminus">-    toggleOpenState(index) { },</span>
<a href="#l35.508"></a><span id="l35.508" class="difflineminus">-    cycleHeader(col) { },</span>
<a href="#l35.509"></a><span id="l35.509" class="difflineplus">+    getLevel(index) {</span>
<a href="#l35.510"></a><span id="l35.510" class="difflineplus">+      return itemArray[index].level;</span>
<a href="#l35.511"></a><span id="l35.511" class="difflineplus">+    },</span>
<a href="#l35.512"></a><span id="l35.512" class="difflineplus">+    getImageSrc(index, column) {},</span>
<a href="#l35.513"></a><span id="l35.513" class="difflineplus">+    getProgressMode(index, column) {},</span>
<a href="#l35.514"></a><span id="l35.514" class="difflineplus">+    getCellValue(index, column) {},</span>
<a href="#l35.515"></a><span id="l35.515" class="difflineplus">+    getCellText(index, column) {</span>
<a href="#l35.516"></a><span id="l35.516" class="difflineplus">+      return itemArray[index].getCellText(column);</span>
<a href="#l35.517"></a><span id="l35.517" class="difflineplus">+    },</span>
<a href="#l35.518"></a><span id="l35.518" class="difflineplus">+    setTree(tree) {</span>
<a href="#l35.519"></a><span id="l35.519" class="difflineplus">+      this.tree = tree;</span>
<a href="#l35.520"></a><span id="l35.520" class="difflineplus">+    },</span>
<a href="#l35.521"></a><span id="l35.521" class="difflineplus">+    toggleOpenState(index) {},</span>
<a href="#l35.522"></a><span id="l35.522" class="difflineplus">+    cycleHeader(col) {},</span>
<a href="#l35.523"></a><span id="l35.523">     selectionChanged() {</span>
<a href="#l35.524"></a><span id="l35.524">       // Save current values and update buttons and deck</span>
<a href="#l35.525"></a><span id="l35.525" class="difflineminus">-      if (currentItem)</span>
<a href="#l35.526"></a><span id="l35.526" class="difflineplus">+      if (currentItem) {</span>
<a href="#l35.527"></a><span id="l35.527">         currentItem.onBlur();</span>
<a href="#l35.528"></a><span id="l35.528" class="difflineplus">+      }</span>
<a href="#l35.529"></a><span id="l35.529">       var currentIndex = treeSelection.currentIndex;</span>
<a href="#l35.530"></a><span id="l35.530">       currentItem = itemArray[currentIndex];</span>
<a href="#l35.531"></a><span id="l35.531">       gDialog.removeButton.disabled = !currentItem.canDestroy();</span>
<a href="#l35.532"></a><span id="l35.532">       gDialog.previousButton.disabled = currentIndex &lt; 2;</span>
<a href="#l35.533"></a><span id="l35.533">       gDialog.nextButton.disabled = !currentItem.canMoveDown();</span>
<a href="#l35.534"></a><span id="l35.534">       // For Advanced Edit</span>
<a href="#l35.535"></a><span id="l35.535">       globalElement = currentItem.element;</span>
<a href="#l35.536"></a><span id="l35.536">       currentItem.onFocus();</span>
<a href="#l35.537"></a><span id="l35.537">     },</span>
<a href="#l35.538"></a><span id="l35.538" class="difflineminus">-    cycleCell(index, column) { itemArray[index].cycleCell(index); },</span>
<a href="#l35.539"></a><span id="l35.539" class="difflineminus">-    isEditable(index, column) { return false; },</span>
<a href="#l35.540"></a><span id="l35.540" class="difflineplus">+    cycleCell(index, column) {</span>
<a href="#l35.541"></a><span id="l35.541" class="difflineplus">+      itemArray[index].cycleCell(index);</span>
<a href="#l35.542"></a><span id="l35.542" class="difflineplus">+    },</span>
<a href="#l35.543"></a><span id="l35.543" class="difflineplus">+    isEditable(index, column) {</span>
<a href="#l35.544"></a><span id="l35.544" class="difflineplus">+      return false;</span>
<a href="#l35.545"></a><span id="l35.545" class="difflineplus">+    },</span>
<a href="#l35.546"></a><span id="l35.546">   };</span>
<a href="#l35.547"></a><span id="l35.547">   treeSelection.select(0);</span>
<a href="#l35.548"></a><span id="l35.548">   currentItem = gDialog;</span>
<a href="#l35.549"></a><span id="l35.549">   // onNameInput();</span>
<a href="#l35.550"></a><span id="l35.550"> </span>
<a href="#l35.551"></a><span id="l35.551">   SetTextboxFocus(gDialog.selectName);</span>
<a href="#l35.552"></a><span id="l35.552"> </span>
<a href="#l35.553"></a><span id="l35.553">   SetWindowLocation();</span>
<a href="#l35.554"></a><span id="l35.554" class="difflineat">@@ -526,48 +603,57 @@ function onAccept() {</span>
<a href="#l35.555"></a><span id="l35.555">   var editor = GetCurrentEditor();</span>
<a href="#l35.556"></a><span id="l35.556"> </span>
<a href="#l35.557"></a><span id="l35.557">   // Coalesce into one undo transaction</span>
<a href="#l35.558"></a><span id="l35.558">   editor.beginTransaction();</span>
<a href="#l35.559"></a><span id="l35.559"> </span>
<a href="#l35.560"></a><span id="l35.560">   try {</span>
<a href="#l35.561"></a><span id="l35.561">     editor.cloneAttributes(selectElement, gDialog.element);</span>
<a href="#l35.562"></a><span id="l35.562"> </span>
<a href="#l35.563"></a><span id="l35.563" class="difflineminus">-    if (insertNew)</span>
<a href="#l35.564"></a><span id="l35.564" class="difflineplus">+    if (insertNew) {</span>
<a href="#l35.565"></a><span id="l35.565">       // 'true' means delete the selection before inserting</span>
<a href="#l35.566"></a><span id="l35.566">       editor.insertElementAtSelection(selectElement, true);</span>
<a href="#l35.567"></a><span id="l35.567" class="difflineplus">+    }</span>
<a href="#l35.568"></a><span id="l35.568"> </span>
<a href="#l35.569"></a><span id="l35.569">     editor.setShouldTxnSetSelection(false);</span>
<a href="#l35.570"></a><span id="l35.570"> </span>
<a href="#l35.571"></a><span id="l35.571" class="difflineminus">-    while (selectElement.lastChild)</span>
<a href="#l35.572"></a><span id="l35.572" class="difflineplus">+    while (selectElement.lastChild) {</span>
<a href="#l35.573"></a><span id="l35.573">       editor.deleteNode(selectElement.lastChild);</span>
<a href="#l35.574"></a><span id="l35.574" class="difflineplus">+    }</span>
<a href="#l35.575"></a><span id="l35.575"> </span>
<a href="#l35.576"></a><span id="l35.576">     var offset = 0;</span>
<a href="#l35.577"></a><span id="l35.577" class="difflineminus">-    for (var i = 1; i &lt; itemArray.length; i++)</span>
<a href="#l35.578"></a><span id="l35.578" class="difflineminus">-      if (itemArray[i].level &gt; 1)</span>
<a href="#l35.579"></a><span id="l35.579" class="difflineplus">+    for (var i = 1; i &lt; itemArray.length; i++) {</span>
<a href="#l35.580"></a><span id="l35.580" class="difflineplus">+      if (itemArray[i].level &gt; 1) {</span>
<a href="#l35.581"></a><span id="l35.581">         selectElement.lastChild.appendChild(itemArray[i].element);</span>
<a href="#l35.582"></a><span id="l35.582" class="difflineminus">-      else</span>
<a href="#l35.583"></a><span id="l35.583" class="difflineplus">+      } else {</span>
<a href="#l35.584"></a><span id="l35.584">         editor.insertNode(itemArray[i].element, selectElement, offset++, true);</span>
<a href="#l35.585"></a><span id="l35.585" class="difflineplus">+      }</span>
<a href="#l35.586"></a><span id="l35.586" class="difflineplus">+    }</span>
<a href="#l35.587"></a><span id="l35.587"> </span>
<a href="#l35.588"></a><span id="l35.588">     editor.setShouldTxnSetSelection(true);</span>
<a href="#l35.589"></a><span id="l35.589">   } finally {</span>
<a href="#l35.590"></a><span id="l35.590">     editor.endTransaction();</span>
<a href="#l35.591"></a><span id="l35.591">   }</span>
<a href="#l35.592"></a><span id="l35.592"> </span>
<a href="#l35.593"></a><span id="l35.593">   SaveWindowLocation();</span>
<a href="#l35.594"></a><span id="l35.594"> }</span>
<a href="#l35.595"></a><span id="l35.595"> </span>
<a href="#l35.596"></a><span id="l35.596"> // Button actions</span>
<a href="#l35.597"></a><span id="l35.597"> function AddOption() {</span>
<a href="#l35.598"></a><span id="l35.598" class="difflineminus">-  currentItem.appendOption(GetCurrentEditor().createElementWithDefaults(&quot;option&quot;), treeSelection.currentIndex);</span>
<a href="#l35.599"></a><span id="l35.599" class="difflineplus">+  currentItem.appendOption(</span>
<a href="#l35.600"></a><span id="l35.600" class="difflineplus">+    GetCurrentEditor().createElementWithDefaults(&quot;option&quot;),</span>
<a href="#l35.601"></a><span id="l35.601" class="difflineplus">+    treeSelection.currentIndex</span>
<a href="#l35.602"></a><span id="l35.602" class="difflineplus">+  );</span>
<a href="#l35.603"></a><span id="l35.603">   SetTextboxFocus(gDialog.optionText);</span>
<a href="#l35.604"></a><span id="l35.604"> }</span>
<a href="#l35.605"></a><span id="l35.605"> </span>
<a href="#l35.606"></a><span id="l35.606"> function AddOptGroup() {</span>
<a href="#l35.607"></a><span id="l35.607" class="difflineminus">-  var optgroupElement = GetCurrentEditor().createElementWithDefaults(&quot;optgroup&quot;);</span>
<a href="#l35.608"></a><span id="l35.608" class="difflineplus">+  var optgroupElement = GetCurrentEditor().createElementWithDefaults(</span>
<a href="#l35.609"></a><span id="l35.609" class="difflineplus">+    &quot;optgroup&quot;</span>
<a href="#l35.610"></a><span id="l35.610" class="difflineplus">+  );</span>
<a href="#l35.611"></a><span id="l35.611">   var index = itemArray.length;</span>
<a href="#l35.612"></a><span id="l35.612">   // XXX need to repaint the lines, tree won't do this</span>
<a href="#l35.613"></a><span id="l35.613">   theTree.invalidateRange(gDialog.lastChild(), index);</span>
<a href="#l35.614"></a><span id="l35.614">   // append the wrapped object</span>
<a href="#l35.615"></a><span id="l35.615">   itemArray.push(new optgroupObject(optgroupElement));</span>
<a href="#l35.616"></a><span id="l35.616">   theTree.rowCountChanged(index, 1);</span>
<a href="#l35.617"></a><span id="l35.617">   selectTreeIndex(index, false);</span>
<a href="#l35.618"></a><span id="l35.618">   SetTextboxFocus(gDialog.optgroupLabel);</span>
<a href="#l35.619"></a><span id="l35.619" class="difflineat">@@ -580,34 +666,37 @@ function RemoveElement() {</span>
<a href="#l35.620"></a><span id="l35.620">     var level = itemArray[index].level;</span>
<a href="#l35.621"></a><span id="l35.621">     // Perform necessary cleanup and remove the wrapper</span>
<a href="#l35.622"></a><span id="l35.622">     itemArray[index].destroy();</span>
<a href="#l35.623"></a><span id="l35.623">     itemArray.splice(index, 1);</span>
<a href="#l35.624"></a><span id="l35.624">     --index;</span>
<a href="#l35.625"></a><span id="l35.625">     // XXX need to repaint the lines, tree won't do this</span>
<a href="#l35.626"></a><span id="l35.626">     if (level == 1) {</span>
<a href="#l35.627"></a><span id="l35.627">       var last = gDialog.lastChild();</span>
<a href="#l35.628"></a><span id="l35.628" class="difflineminus">-      if (index &gt; last)</span>
<a href="#l35.629"></a><span id="l35.629" class="difflineplus">+      if (index &gt; last) {</span>
<a href="#l35.630"></a><span id="l35.630">         theTree.invalidateRange(last, index);</span>
<a href="#l35.631"></a><span id="l35.631" class="difflineplus">+      }</span>
<a href="#l35.632"></a><span id="l35.632">     }</span>
<a href="#l35.633"></a><span id="l35.633">     selectTreeIndex(index, true);</span>
<a href="#l35.634"></a><span id="l35.634">     theTree.rowCountChanged(++index, -1);</span>
<a href="#l35.635"></a><span id="l35.635">   }</span>
<a href="#l35.636"></a><span id="l35.636"> }</span>
<a href="#l35.637"></a><span id="l35.637"> </span>
<a href="#l35.638"></a><span id="l35.638"> // Event handler</span>
<a href="#l35.639"></a><span id="l35.639"> function onTreeKeyUp(event) {</span>
<a href="#l35.640"></a><span id="l35.640" class="difflineminus">-  if (event.keyCode == event.DOM_VK_SPACE)</span>
<a href="#l35.641"></a><span id="l35.641" class="difflineplus">+  if (event.keyCode == event.DOM_VK_SPACE) {</span>
<a href="#l35.642"></a><span id="l35.642">     currentItem.cycleCell();</span>
<a href="#l35.643"></a><span id="l35.643" class="difflineplus">+  }</span>
<a href="#l35.644"></a><span id="l35.644"> }</span>
<a href="#l35.645"></a><span id="l35.645"> </span>
<a href="#l35.646"></a><span id="l35.646"> function onNameInput() {</span>
<a href="#l35.647"></a><span id="l35.647">   var disabled = !gDialog.selectName.value;</span>
<a href="#l35.648"></a><span id="l35.648" class="difflineminus">-  if (gDialog.accept.disabled != disabled)</span>
<a href="#l35.649"></a><span id="l35.649" class="difflineplus">+  if (gDialog.accept.disabled != disabled) {</span>
<a href="#l35.650"></a><span id="l35.650">     gDialog.accept.disabled = disabled;</span>
<a href="#l35.651"></a><span id="l35.651" class="difflineplus">+  }</span>
<a href="#l35.652"></a><span id="l35.652">   gDialog.element.setAttribute(&quot;name&quot;, gDialog.selectName.value);</span>
<a href="#l35.653"></a><span id="l35.653">   // repaint the tree</span>
<a href="#l35.654"></a><span id="l35.654">   var primaryCol = theTree.columns.getPrimaryColumn();</span>
<a href="#l35.655"></a><span id="l35.655">   theTree.invalidateCell(treeSelection.currentIndex, primaryCol);</span>
<a href="#l35.656"></a><span id="l35.656"> }</span>
<a href="#l35.657"></a><span id="l35.657"> </span>
<a href="#l35.658"></a><span id="l35.658"> function onLabelInput() {</span>
<a href="#l35.659"></a><span id="l35.659">   currentItem.element.setAttribute(&quot;label&quot;, gDialog.optgroupLabel.value);</span>
<a href="#l35.660"></a><span id="l35.660" class="difflineat">@@ -649,18 +738,28 @@ function onHasValueClick() {</span>
<a href="#l35.661"></a><span id="l35.661">   }</span>
<a href="#l35.662"></a><span id="l35.662">   // repaint the tree</span>
<a href="#l35.663"></a><span id="l35.663">   var column = theTree.columns.SelectValCol;</span>
<a href="#l35.664"></a><span id="l35.664">   theTree.invalidateCell(treeSelection.currentIndex, column);</span>
<a href="#l35.665"></a><span id="l35.665"> }</span>
<a href="#l35.666"></a><span id="l35.666"> </span>
<a href="#l35.667"></a><span id="l35.667"> function onSelectMultipleClick() {</span>
<a href="#l35.668"></a><span id="l35.668">   // Recalculate the unique selected option if we need it and have lost it</span>
<a href="#l35.669"></a><span id="l35.669" class="difflineminus">-  if (!gDialog.selectMultiple.checked &amp;&amp; selectedOptionCount == 1 &amp;&amp; !selectedOption)</span>
<a href="#l35.670"></a><span id="l35.670" class="difflineminus">-    for (var i = 1; !(selectedOption = itemArray[i].element).hasAttribute(&quot;selected&quot;); i++);</span>
<a href="#l35.671"></a><span id="l35.671" class="difflineplus">+  if (</span>
<a href="#l35.672"></a><span id="l35.672" class="difflineplus">+    !gDialog.selectMultiple.checked &amp;&amp;</span>
<a href="#l35.673"></a><span id="l35.673" class="difflineplus">+    selectedOptionCount == 1 &amp;&amp;</span>
<a href="#l35.674"></a><span id="l35.674" class="difflineplus">+    !selectedOption</span>
<a href="#l35.675"></a><span id="l35.675" class="difflineplus">+  ) {</span>
<a href="#l35.676"></a><span id="l35.676" class="difflineplus">+    for (</span>
<a href="#l35.677"></a><span id="l35.677" class="difflineplus">+      var i = 1;</span>
<a href="#l35.678"></a><span id="l35.678" class="difflineplus">+      !(selectedOption = itemArray[i].element).hasAttribute(&quot;selected&quot;);</span>
<a href="#l35.679"></a><span id="l35.679" class="difflineplus">+      i++</span>
<a href="#l35.680"></a><span id="l35.680" class="difflineplus">+    ) {}</span>
<a href="#l35.681"></a><span id="l35.681" class="difflineplus">+  }</span>
<a href="#l35.682"></a><span id="l35.682"> }</span>
<a href="#l35.683"></a><span id="l35.683"> </span>
<a href="#l35.684"></a><span id="l35.684"> function selectTreeIndex(index, focus) {</span>
<a href="#l35.685"></a><span id="l35.685">   treeSelection.select(index);</span>
<a href="#l35.686"></a><span id="l35.686">   theTree.ensureRowIsVisible(index);</span>
<a href="#l35.687"></a><span id="l35.687" class="difflineminus">-  if (focus)</span>
<a href="#l35.688"></a><span id="l35.688" class="difflineplus">+  if (focus) {</span>
<a href="#l35.689"></a><span id="l35.689">     gDialog.tree.focus();</span>
<a href="#l35.690"></a><span id="l35.690" class="difflineplus">+  }</span>
<a href="#l35.691"></a><span id="l35.691"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdSpellCheck.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdSpellCheck.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -2,17 +2,19 @@</span>
<a href="#l36.4"></a><span id="l36.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l36.5"></a><span id="l36.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l36.6"></a><span id="l36.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l36.7"></a><span id="l36.7"> </span>
<a href="#l36.8"></a><span id="l36.8"> /* import-globals-from ../../../../mail/base/content/utilityOverlay.js */</span>
<a href="#l36.9"></a><span id="l36.9"> /* import-globals-from ../../composer/content/editorUtilities.js */</span>
<a href="#l36.10"></a><span id="l36.10"> /* import-globals-from EdDialogCommon.js */</span>
<a href="#l36.11"></a><span id="l36.11"> </span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-var {InlineSpellChecker} = ChromeUtils.import(&quot;resource://gre/modules/InlineSpellChecker.jsm&quot;);</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+var { InlineSpellChecker } = ChromeUtils.import(</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineplus">+  &quot;resource://gre/modules/InlineSpellChecker.jsm&quot;</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineplus">+);</span>
<a href="#l36.16"></a><span id="l36.16"> </span>
<a href="#l36.17"></a><span id="l36.17"> var gMisspelledWord;</span>
<a href="#l36.18"></a><span id="l36.18"> var gSpellChecker = null;</span>
<a href="#l36.19"></a><span id="l36.19"> var gAllowSelectWord = true;</span>
<a href="#l36.20"></a><span id="l36.20"> var gPreviousReplaceWord = &quot;&quot;;</span>
<a href="#l36.21"></a><span id="l36.21"> var gFirstTime = true;</span>
<a href="#l36.22"></a><span id="l36.22"> var gLastSelectedLang = null;</span>
<a href="#l36.23"></a><span id="l36.23"> var gDictCount = 0;</span>
<a href="#l36.24"></a><span id="l36.24" class="difflineat">@@ -35,36 +37,42 @@ function Startup() {</span>
<a href="#l36.25"></a><span id="l36.25">     return;</span>
<a href="#l36.26"></a><span id="l36.26">   }</span>
<a href="#l36.27"></a><span id="l36.27"> </span>
<a href="#l36.28"></a><span id="l36.28">   // Start the spell checker module.</span>
<a href="#l36.29"></a><span id="l36.29">   try {</span>
<a href="#l36.30"></a><span id="l36.30">     var skipBlockQuotes = window.arguments[1];</span>
<a href="#l36.31"></a><span id="l36.31">     var enableSelectionChecking = window.arguments[2];</span>
<a href="#l36.32"></a><span id="l36.32"> </span>
<a href="#l36.33"></a><span id="l36.33" class="difflineminus">-    gSpellChecker.setFilterType(skipBlockQuotes ?</span>
<a href="#l36.34"></a><span id="l36.34" class="difflineminus">-                                Ci.nsIEditorSpellCheck.FILTERTYPE_MAIL :</span>
<a href="#l36.35"></a><span id="l36.35" class="difflineminus">-                                Ci.nsIEditorSpellCheck.FILTERTYPE_NORMAL);</span>
<a href="#l36.36"></a><span id="l36.36" class="difflineminus">-    gSpellChecker.InitSpellChecker(editor, enableSelectionChecking, spellCheckStarted);</span>
<a href="#l36.37"></a><span id="l36.37" class="difflineplus">+    gSpellChecker.setFilterType(</span>
<a href="#l36.38"></a><span id="l36.38" class="difflineplus">+      skipBlockQuotes</span>
<a href="#l36.39"></a><span id="l36.39" class="difflineplus">+        ? Ci.nsIEditorSpellCheck.FILTERTYPE_MAIL</span>
<a href="#l36.40"></a><span id="l36.40" class="difflineplus">+        : Ci.nsIEditorSpellCheck.FILTERTYPE_NORMAL</span>
<a href="#l36.41"></a><span id="l36.41" class="difflineplus">+    );</span>
<a href="#l36.42"></a><span id="l36.42" class="difflineplus">+    gSpellChecker.InitSpellChecker(</span>
<a href="#l36.43"></a><span id="l36.43" class="difflineplus">+      editor,</span>
<a href="#l36.44"></a><span id="l36.44" class="difflineplus">+      enableSelectionChecking,</span>
<a href="#l36.45"></a><span id="l36.45" class="difflineplus">+      spellCheckStarted</span>
<a href="#l36.46"></a><span id="l36.46" class="difflineplus">+    );</span>
<a href="#l36.47"></a><span id="l36.47">   } catch (ex) {</span>
<a href="#l36.48"></a><span id="l36.48">     dump(&quot;*** Exception error: InitSpellChecker\n&quot;);</span>
<a href="#l36.49"></a><span id="l36.49">     window.close();</span>
<a href="#l36.50"></a><span id="l36.50">   }</span>
<a href="#l36.51"></a><span id="l36.51"> }</span>
<a href="#l36.52"></a><span id="l36.52"> </span>
<a href="#l36.53"></a><span id="l36.53"> function spellCheckStarted() {</span>
<a href="#l36.54"></a><span id="l36.54">   gDialog.MisspelledWordLabel = document.getElementById(&quot;MisspelledWordLabel&quot;);</span>
<a href="#l36.55"></a><span id="l36.55" class="difflineminus">-  gDialog.MisspelledWord      = document.getElementById(&quot;MisspelledWord&quot;);</span>
<a href="#l36.56"></a><span id="l36.56" class="difflineminus">-  gDialog.ReplaceButton       = document.getElementById(&quot;Replace&quot;);</span>
<a href="#l36.57"></a><span id="l36.57" class="difflineminus">-  gDialog.IgnoreButton        = document.getElementById(&quot;Ignore&quot;);</span>
<a href="#l36.58"></a><span id="l36.58" class="difflineminus">-  gDialog.StopButton          = document.getElementById(&quot;Stop&quot;);</span>
<a href="#l36.59"></a><span id="l36.59" class="difflineminus">-  gDialog.CloseButton         = document.getElementById(&quot;Close&quot;);</span>
<a href="#l36.60"></a><span id="l36.60" class="difflineminus">-  gDialog.ReplaceWordInput    = document.getElementById(&quot;ReplaceWordInput&quot;);</span>
<a href="#l36.61"></a><span id="l36.61" class="difflineminus">-  gDialog.SuggestedList       = document.getElementById(&quot;SuggestedList&quot;);</span>
<a href="#l36.62"></a><span id="l36.62" class="difflineminus">-  gDialog.LanguageMenulist    = document.getElementById(&quot;LanguageMenulist&quot;);</span>
<a href="#l36.63"></a><span id="l36.63" class="difflineplus">+  gDialog.MisspelledWord = document.getElementById(&quot;MisspelledWord&quot;);</span>
<a href="#l36.64"></a><span id="l36.64" class="difflineplus">+  gDialog.ReplaceButton = document.getElementById(&quot;Replace&quot;);</span>
<a href="#l36.65"></a><span id="l36.65" class="difflineplus">+  gDialog.IgnoreButton = document.getElementById(&quot;Ignore&quot;);</span>
<a href="#l36.66"></a><span id="l36.66" class="difflineplus">+  gDialog.StopButton = document.getElementById(&quot;Stop&quot;);</span>
<a href="#l36.67"></a><span id="l36.67" class="difflineplus">+  gDialog.CloseButton = document.getElementById(&quot;Close&quot;);</span>
<a href="#l36.68"></a><span id="l36.68" class="difflineplus">+  gDialog.ReplaceWordInput = document.getElementById(&quot;ReplaceWordInput&quot;);</span>
<a href="#l36.69"></a><span id="l36.69" class="difflineplus">+  gDialog.SuggestedList = document.getElementById(&quot;SuggestedList&quot;);</span>
<a href="#l36.70"></a><span id="l36.70" class="difflineplus">+  gDialog.LanguageMenulist = document.getElementById(&quot;LanguageMenulist&quot;);</span>
<a href="#l36.71"></a><span id="l36.71"> </span>
<a href="#l36.72"></a><span id="l36.72">   // Fill in the language menulist and sync it up</span>
<a href="#l36.73"></a><span id="l36.73">   // with the spellchecker's current language.</span>
<a href="#l36.74"></a><span id="l36.74"> </span>
<a href="#l36.75"></a><span id="l36.75">   var curLang;</span>
<a href="#l36.76"></a><span id="l36.76"> </span>
<a href="#l36.77"></a><span id="l36.77">   try {</span>
<a href="#l36.78"></a><span id="l36.78">     curLang = gSpellChecker.GetCurrentDictionary();</span>
<a href="#l36.79"></a><span id="l36.79" class="difflineat">@@ -114,54 +122,60 @@ function InitLanguageMenu(aCurLang) {</span>
<a href="#l36.80"></a><span id="l36.80">     dictList = gSpellChecker.GetDictionaryList();</span>
<a href="#l36.81"></a><span id="l36.81">   } catch (ex) {</span>
<a href="#l36.82"></a><span id="l36.82">     dump(&quot;Failed to get DictionaryList!\n&quot;);</span>
<a href="#l36.83"></a><span id="l36.83">     return;</span>
<a href="#l36.84"></a><span id="l36.84">   }</span>
<a href="#l36.85"></a><span id="l36.85"> </span>
<a href="#l36.86"></a><span id="l36.86">   // If we're not just starting up and dictionary count</span>
<a href="#l36.87"></a><span id="l36.87">   // hasn't changed then no need to update the menu.</span>
<a href="#l36.88"></a><span id="l36.88" class="difflineminus">-  if (gDictCount == dictList.length)</span>
<a href="#l36.89"></a><span id="l36.89" class="difflineplus">+  if (gDictCount == dictList.length) {</span>
<a href="#l36.90"></a><span id="l36.90">     return;</span>
<a href="#l36.91"></a><span id="l36.91" class="difflineplus">+  }</span>
<a href="#l36.92"></a><span id="l36.92"> </span>
<a href="#l36.93"></a><span id="l36.93">   // Store current dictionary count.</span>
<a href="#l36.94"></a><span id="l36.94">   gDictCount = dictList.length;</span>
<a href="#l36.95"></a><span id="l36.95"> </span>
<a href="#l36.96"></a><span id="l36.96">   var inlineSpellChecker = new InlineSpellChecker();</span>
<a href="#l36.97"></a><span id="l36.97">   var sortedList = inlineSpellChecker.sortDictionaryList(dictList);</span>
<a href="#l36.98"></a><span id="l36.98"> </span>
<a href="#l36.99"></a><span id="l36.99">   // Remove any languages from the list.</span>
<a href="#l36.100"></a><span id="l36.100">   var languageMenuPopup = gDialog.LanguageMenulist.menupopup;</span>
<a href="#l36.101"></a><span id="l36.101" class="difflineminus">-  while (languageMenuPopup.firstChild.localName != &quot;menuseparator&quot;)</span>
<a href="#l36.102"></a><span id="l36.102" class="difflineplus">+  while (languageMenuPopup.firstChild.localName != &quot;menuseparator&quot;) {</span>
<a href="#l36.103"></a><span id="l36.103">     languageMenuPopup.firstChild.remove();</span>
<a href="#l36.104"></a><span id="l36.104" class="difflineplus">+  }</span>
<a href="#l36.105"></a><span id="l36.105"> </span>
<a href="#l36.106"></a><span id="l36.106">   var defaultItem = null;</span>
<a href="#l36.107"></a><span id="l36.107"> </span>
<a href="#l36.108"></a><span id="l36.108">   for (var i = 0; i &lt; gDictCount; i++) {</span>
<a href="#l36.109"></a><span id="l36.109">     let item = document.createXULElement(&quot;menuitem&quot;);</span>
<a href="#l36.110"></a><span id="l36.110">     item.setAttribute(&quot;label&quot;, sortedList[i].displayName);</span>
<a href="#l36.111"></a><span id="l36.111">     item.setAttribute(&quot;value&quot;, sortedList[i].localeCode);</span>
<a href="#l36.112"></a><span id="l36.112">     let beforeItem = gDialog.LanguageMenulist.getItemAtIndex(i);</span>
<a href="#l36.113"></a><span id="l36.113">     languageMenuPopup.insertBefore(item, beforeItem);</span>
<a href="#l36.114"></a><span id="l36.114"> </span>
<a href="#l36.115"></a><span id="l36.115" class="difflineminus">-    if (aCurLang &amp;&amp; sortedList[i].localeCode == aCurLang)</span>
<a href="#l36.116"></a><span id="l36.116" class="difflineplus">+    if (aCurLang &amp;&amp; sortedList[i].localeCode == aCurLang) {</span>
<a href="#l36.117"></a><span id="l36.117">       defaultItem = item;</span>
<a href="#l36.118"></a><span id="l36.118" class="difflineplus">+    }</span>
<a href="#l36.119"></a><span id="l36.119">   }</span>
<a href="#l36.120"></a><span id="l36.120"> </span>
<a href="#l36.121"></a><span id="l36.121">   // Now make sure the correct item in the menu list is selected.</span>
<a href="#l36.122"></a><span id="l36.122">   if (defaultItem) {</span>
<a href="#l36.123"></a><span id="l36.123">     gDialog.LanguageMenulist.selectedItem = defaultItem;</span>
<a href="#l36.124"></a><span id="l36.124">     gLastSelectedLang = defaultItem;</span>
<a href="#l36.125"></a><span id="l36.125">   }</span>
<a href="#l36.126"></a><span id="l36.126"> }</span>
<a href="#l36.127"></a><span id="l36.127"> </span>
<a href="#l36.128"></a><span id="l36.128"> function DoEnabling() {</span>
<a href="#l36.129"></a><span id="l36.129">   if (!gMisspelledWord) {</span>
<a href="#l36.130"></a><span id="l36.130">     // No more misspelled words</span>
<a href="#l36.131"></a><span id="l36.131" class="difflineminus">-    gDialog.MisspelledWord.setAttribute(&quot;value&quot;, GetString(gFirstTime ? &quot;NoMisspelledWord&quot; : &quot;CheckSpellingDone&quot;));</span>
<a href="#l36.132"></a><span id="l36.132" class="difflineplus">+    gDialog.MisspelledWord.setAttribute(</span>
<a href="#l36.133"></a><span id="l36.133" class="difflineplus">+      &quot;value&quot;,</span>
<a href="#l36.134"></a><span id="l36.134" class="difflineplus">+      GetString(gFirstTime ? &quot;NoMisspelledWord&quot; : &quot;CheckSpellingDone&quot;)</span>
<a href="#l36.135"></a><span id="l36.135" class="difflineplus">+    );</span>
<a href="#l36.136"></a><span id="l36.136"> </span>
<a href="#l36.137"></a><span id="l36.137">     gDialog.ReplaceButton.removeAttribute(&quot;default&quot;);</span>
<a href="#l36.138"></a><span id="l36.138">     gDialog.IgnoreButton.removeAttribute(&quot;default&quot;);</span>
<a href="#l36.139"></a><span id="l36.139"> </span>
<a href="#l36.140"></a><span id="l36.140">     gDialog.CloseButton.setAttribute(&quot;default&quot;, &quot;true&quot;);</span>
<a href="#l36.141"></a><span id="l36.141">     // Shouldn't have to do this if &quot;default&quot; is true?</span>
<a href="#l36.142"></a><span id="l36.142">     gDialog.CloseButton.focus();</span>
<a href="#l36.143"></a><span id="l36.143"> </span>
<a href="#l36.144"></a><span id="l36.144" class="difflineat">@@ -195,40 +209,45 @@ function DoEnabling() {</span>
<a href="#l36.145"></a><span id="l36.145"> function NextWord() {</span>
<a href="#l36.146"></a><span id="l36.146">   gMisspelledWord = gSpellChecker.GetNextMisspelledWord();</span>
<a href="#l36.147"></a><span id="l36.147">   SetWidgetsForMisspelledWord();</span>
<a href="#l36.148"></a><span id="l36.148"> }</span>
<a href="#l36.149"></a><span id="l36.149"> </span>
<a href="#l36.150"></a><span id="l36.150"> function SetWidgetsForMisspelledWord() {</span>
<a href="#l36.151"></a><span id="l36.151">   gDialog.MisspelledWord.setAttribute(&quot;value&quot;, gMisspelledWord);</span>
<a href="#l36.152"></a><span id="l36.152"> </span>
<a href="#l36.153"></a><span id="l36.153" class="difflineminus">-</span>
<a href="#l36.154"></a><span id="l36.154">   // Initial replace word is misspelled word</span>
<a href="#l36.155"></a><span id="l36.155">   gDialog.ReplaceWordInput.value = gMisspelledWord;</span>
<a href="#l36.156"></a><span id="l36.156">   gPreviousReplaceWord = gMisspelledWord;</span>
<a href="#l36.157"></a><span id="l36.157"> </span>
<a href="#l36.158"></a><span id="l36.158">   // This sets gDialog.ReplaceWordInput to first suggested word in list</span>
<a href="#l36.159"></a><span id="l36.159">   FillSuggestedList(gMisspelledWord);</span>
<a href="#l36.160"></a><span id="l36.160"> </span>
<a href="#l36.161"></a><span id="l36.161">   DoEnabling();</span>
<a href="#l36.162"></a><span id="l36.162"> </span>
<a href="#l36.163"></a><span id="l36.163" class="difflineminus">-  if (gMisspelledWord)</span>
<a href="#l36.164"></a><span id="l36.164" class="difflineplus">+  if (gMisspelledWord) {</span>
<a href="#l36.165"></a><span id="l36.165">     SetTextboxFocus(gDialog.ReplaceWordInput);</span>
<a href="#l36.166"></a><span id="l36.166" class="difflineplus">+  }</span>
<a href="#l36.167"></a><span id="l36.167"> }</span>
<a href="#l36.168"></a><span id="l36.168"> </span>
<a href="#l36.169"></a><span id="l36.169"> function CheckWord() {</span>
<a href="#l36.170"></a><span id="l36.170">   var word = gDialog.ReplaceWordInput.value;</span>
<a href="#l36.171"></a><span id="l36.171">   if (word) {</span>
<a href="#l36.172"></a><span id="l36.172">     if (gSpellChecker.CheckCurrentWord(word)) {</span>
<a href="#l36.173"></a><span id="l36.173">       FillSuggestedList(word);</span>
<a href="#l36.174"></a><span id="l36.174">       SetReplaceEnable();</span>
<a href="#l36.175"></a><span id="l36.175">     } else {</span>
<a href="#l36.176"></a><span id="l36.176">       ClearListbox(gDialog.SuggestedList);</span>
<a href="#l36.177"></a><span id="l36.177" class="difflineminus">-      var item = gDialog.SuggestedList.appendItem(GetString(&quot;CorrectSpelling&quot;), &quot;&quot;);</span>
<a href="#l36.178"></a><span id="l36.178" class="difflineminus">-      if (item) item.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l36.179"></a><span id="l36.179" class="difflineplus">+      var item = gDialog.SuggestedList.appendItem(</span>
<a href="#l36.180"></a><span id="l36.180" class="difflineplus">+        GetString(&quot;CorrectSpelling&quot;),</span>
<a href="#l36.181"></a><span id="l36.181" class="difflineplus">+        &quot;&quot;</span>
<a href="#l36.182"></a><span id="l36.182" class="difflineplus">+      );</span>
<a href="#l36.183"></a><span id="l36.183" class="difflineplus">+      if (item) {</span>
<a href="#l36.184"></a><span id="l36.184" class="difflineplus">+        item.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l36.185"></a><span id="l36.185" class="difflineplus">+      }</span>
<a href="#l36.186"></a><span id="l36.186">       // Suppress being able to select the message text</span>
<a href="#l36.187"></a><span id="l36.187">       gAllowSelectWord = false;</span>
<a href="#l36.188"></a><span id="l36.188">     }</span>
<a href="#l36.189"></a><span id="l36.189">   }</span>
<a href="#l36.190"></a><span id="l36.190"> }</span>
<a href="#l36.191"></a><span id="l36.191"> </span>
<a href="#l36.192"></a><span id="l36.192"> function SelectSuggestedWord() {</span>
<a href="#l36.193"></a><span id="l36.193">   if (gAllowSelectWord) {</span>
<a href="#l36.194"></a><span id="l36.194" class="difflineat">@@ -278,18 +297,19 @@ function Ignore() {</span>
<a href="#l36.195"></a><span id="l36.195"> function IgnoreAll() {</span>
<a href="#l36.196"></a><span id="l36.196">   if (gMisspelledWord) {</span>
<a href="#l36.197"></a><span id="l36.197">     gSpellChecker.IgnoreWordAllOccurrences(gMisspelledWord);</span>
<a href="#l36.198"></a><span id="l36.198">   }</span>
<a href="#l36.199"></a><span id="l36.199">   NextWord();</span>
<a href="#l36.200"></a><span id="l36.200"> }</span>
<a href="#l36.201"></a><span id="l36.201"> </span>
<a href="#l36.202"></a><span id="l36.202"> function Replace(newWord) {</span>
<a href="#l36.203"></a><span id="l36.203" class="difflineminus">-  if (!newWord)</span>
<a href="#l36.204"></a><span id="l36.204" class="difflineplus">+  if (!newWord) {</span>
<a href="#l36.205"></a><span id="l36.205">     return;</span>
<a href="#l36.206"></a><span id="l36.206" class="difflineplus">+  }</span>
<a href="#l36.207"></a><span id="l36.207"> </span>
<a href="#l36.208"></a><span id="l36.208">   if (gMisspelledWord &amp;&amp; gMisspelledWord != newWord) {</span>
<a href="#l36.209"></a><span id="l36.209">     var editor = GetCurrentEditor();</span>
<a href="#l36.210"></a><span id="l36.210">     editor.beginTransaction();</span>
<a href="#l36.211"></a><span id="l36.211">     try {</span>
<a href="#l36.212"></a><span id="l36.212">       gSpellChecker.ReplaceWord(gMisspelledWord, newWord, false);</span>
<a href="#l36.213"></a><span id="l36.213">     } catch (e) {}</span>
<a href="#l36.214"></a><span id="l36.214">     editor.endTransaction();</span>
<a href="#l36.215"></a><span id="l36.215" class="difflineat">@@ -313,17 +333,23 @@ function ReplaceAll() {</span>
<a href="#l36.216"></a><span id="l36.216"> function AddToDictionary() {</span>
<a href="#l36.217"></a><span id="l36.217">   if (gMisspelledWord) {</span>
<a href="#l36.218"></a><span id="l36.218">     gSpellChecker.AddWordToDictionary(gMisspelledWord);</span>
<a href="#l36.219"></a><span id="l36.219">   }</span>
<a href="#l36.220"></a><span id="l36.220">   NextWord();</span>
<a href="#l36.221"></a><span id="l36.221"> }</span>
<a href="#l36.222"></a><span id="l36.222"> </span>
<a href="#l36.223"></a><span id="l36.223"> function EditDictionary() {</span>
<a href="#l36.224"></a><span id="l36.224" class="difflineminus">-  window.openDialog(&quot;chrome://editor/content/EdDictionary.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, &quot;&quot;, gMisspelledWord);</span>
<a href="#l36.225"></a><span id="l36.225" class="difflineplus">+  window.openDialog(</span>
<a href="#l36.226"></a><span id="l36.226" class="difflineplus">+    &quot;chrome://editor/content/EdDictionary.xul&quot;,</span>
<a href="#l36.227"></a><span id="l36.227" class="difflineplus">+    &quot;_blank&quot;,</span>
<a href="#l36.228"></a><span id="l36.228" class="difflineplus">+    &quot;chrome,close,titlebar,modal&quot;,</span>
<a href="#l36.229"></a><span id="l36.229" class="difflineplus">+    &quot;&quot;,</span>
<a href="#l36.230"></a><span id="l36.230" class="difflineplus">+    gMisspelledWord</span>
<a href="#l36.231"></a><span id="l36.231" class="difflineplus">+  );</span>
<a href="#l36.232"></a><span id="l36.232"> }</span>
<a href="#l36.233"></a><span id="l36.233"> </span>
<a href="#l36.234"></a><span id="l36.234"> function SelectLanguage() {</span>
<a href="#l36.235"></a><span id="l36.235">   var item = gDialog.LanguageMenulist.selectedItem;</span>
<a href="#l36.236"></a><span id="l36.236">   if (item.value != &quot;more-cmd&quot;) {</span>
<a href="#l36.237"></a><span id="l36.237">     gSpellChecker.SetCurrentDictionary(item.value);</span>
<a href="#l36.238"></a><span id="l36.238">     // For compose windows we need to set the &quot;lang&quot; attribute so the</span>
<a href="#l36.239"></a><span id="l36.239">     // core editor uses the correct dictionary for the inline spell check.</span>
<a href="#l36.240"></a><span id="l36.240" class="difflineat">@@ -334,18 +360,19 @@ function SelectLanguage() {</span>
<a href="#l36.241"></a><span id="l36.241">       } else {</span>
<a href="#l36.242"></a><span id="l36.242">         window.opener.document.documentElement.setAttribute(&quot;lang&quot;, item.value);</span>
<a href="#l36.243"></a><span id="l36.243">       }</span>
<a href="#l36.244"></a><span id="l36.244">     }</span>
<a href="#l36.245"></a><span id="l36.245">     gLastSelectedLang = item;</span>
<a href="#l36.246"></a><span id="l36.246">   } else {</span>
<a href="#l36.247"></a><span id="l36.247">     openDictionaryList();</span>
<a href="#l36.248"></a><span id="l36.248"> </span>
<a href="#l36.249"></a><span id="l36.249" class="difflineminus">-    if (gLastSelectedLang)</span>
<a href="#l36.250"></a><span id="l36.250" class="difflineplus">+    if (gLastSelectedLang) {</span>
<a href="#l36.251"></a><span id="l36.251">       gDialog.LanguageMenulist.selectedItem = gLastSelectedLang;</span>
<a href="#l36.252"></a><span id="l36.252" class="difflineplus">+    }</span>
<a href="#l36.253"></a><span id="l36.253">   }</span>
<a href="#l36.254"></a><span id="l36.254"> }</span>
<a href="#l36.255"></a><span id="l36.255"> </span>
<a href="#l36.256"></a><span id="l36.256"> function Recheck() {</span>
<a href="#l36.257"></a><span id="l36.257">   var recheckLanguage;</span>
<a href="#l36.258"></a><span id="l36.258"> </span>
<a href="#l36.259"></a><span id="l36.259">   function finishRecheck() {</span>
<a href="#l36.260"></a><span id="l36.260">     gSpellChecker.SetCurrentDictionary(recheckLanguage);</span>
<a href="#l36.261"></a><span id="l36.261" class="difflineat">@@ -384,27 +411,30 @@ function FillSuggestedList(misspelledWor</span>
<a href="#l36.262"></a><span id="l36.262">         list.appendItem(word, &quot;&quot;);</span>
<a href="#l36.263"></a><span id="l36.263">         count++;</span>
<a href="#l36.264"></a><span id="l36.264">       }</span>
<a href="#l36.265"></a><span id="l36.265">     } while (word.length &gt; 0);</span>
<a href="#l36.266"></a><span id="l36.266"> </span>
<a href="#l36.267"></a><span id="l36.267">     if (count == 0) {</span>
<a href="#l36.268"></a><span id="l36.268">       // No suggestions - show a message but don't let user select it</span>
<a href="#l36.269"></a><span id="l36.269">       item = list.appendItem(GetString(&quot;NoSuggestedWords&quot;));</span>
<a href="#l36.270"></a><span id="l36.270" class="difflineminus">-      if (item) item.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l36.271"></a><span id="l36.271" class="difflineplus">+      if (item) {</span>
<a href="#l36.272"></a><span id="l36.272" class="difflineplus">+        item.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l36.273"></a><span id="l36.273" class="difflineplus">+      }</span>
<a href="#l36.274"></a><span id="l36.274">       gAllowSelectWord = false;</span>
<a href="#l36.275"></a><span id="l36.275">     } else {</span>
<a href="#l36.276"></a><span id="l36.276">       gAllowSelectWord = true;</span>
<a href="#l36.277"></a><span id="l36.277">       // Initialize with first suggested list by selecting it</span>
<a href="#l36.278"></a><span id="l36.278">       gDialog.SuggestedList.selectedIndex = 0;</span>
<a href="#l36.279"></a><span id="l36.279">     }</span>
<a href="#l36.280"></a><span id="l36.280">   } else {</span>
<a href="#l36.281"></a><span id="l36.281">     item = list.appendItem(&quot;&quot;, &quot;&quot;);</span>
<a href="#l36.282"></a><span id="l36.282" class="difflineminus">-    if (item)</span>
<a href="#l36.283"></a><span id="l36.283" class="difflineplus">+    if (item) {</span>
<a href="#l36.284"></a><span id="l36.284">       item.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l36.285"></a><span id="l36.285" class="difflineplus">+    }</span>
<a href="#l36.286"></a><span id="l36.286">   }</span>
<a href="#l36.287"></a><span id="l36.287"> }</span>
<a href="#l36.288"></a><span id="l36.288"> </span>
<a href="#l36.289"></a><span id="l36.289"> function SetReplaceEnable() {</span>
<a href="#l36.290"></a><span id="l36.290">   // Enable &quot;Change...&quot; buttons only if new word is different than misspelled</span>
<a href="#l36.291"></a><span id="l36.291">   var newWord = gDialog.ReplaceWordInput.value;</span>
<a href="#l36.292"></a><span id="l36.292">   var enable = newWord.length &gt; 0 &amp;&amp; newWord != gMisspelledWord;</span>
<a href="#l36.293"></a><span id="l36.293">   SetElementEnabledById(&quot;Replace&quot;, enable);</span>
<a href="#l36.294"></a><span id="l36.294" class="difflineat">@@ -414,35 +444,41 @@ function SetReplaceEnable() {</span>
<a href="#l36.295"></a><span id="l36.295">     gDialog.IgnoreButton.removeAttribute(&quot;default&quot;);</span>
<a href="#l36.296"></a><span id="l36.296">   } else {</span>
<a href="#l36.297"></a><span id="l36.297">     gDialog.IgnoreButton.setAttribute(&quot;default&quot;, &quot;true&quot;);</span>
<a href="#l36.298"></a><span id="l36.298">     gDialog.ReplaceButton.removeAttribute(&quot;default&quot;);</span>
<a href="#l36.299"></a><span id="l36.299">   }</span>
<a href="#l36.300"></a><span id="l36.300"> }</span>
<a href="#l36.301"></a><span id="l36.301"> </span>
<a href="#l36.302"></a><span id="l36.302"> function doDefault(event) {</span>
<a href="#l36.303"></a><span id="l36.303" class="difflineminus">-  if (gDialog.ReplaceButton.getAttribute(&quot;default&quot;) == &quot;true&quot;)</span>
<a href="#l36.304"></a><span id="l36.304" class="difflineplus">+  if (gDialog.ReplaceButton.getAttribute(&quot;default&quot;) == &quot;true&quot;) {</span>
<a href="#l36.305"></a><span id="l36.305">     Replace(gDialog.ReplaceWordInput.value);</span>
<a href="#l36.306"></a><span id="l36.306" class="difflineminus">-  else if (gDialog.IgnoreButton.getAttribute(&quot;default&quot;) == &quot;true&quot;)</span>
<a href="#l36.307"></a><span id="l36.307" class="difflineplus">+  } else if (gDialog.IgnoreButton.getAttribute(&quot;default&quot;) == &quot;true&quot;) {</span>
<a href="#l36.308"></a><span id="l36.308">     Ignore();</span>
<a href="#l36.309"></a><span id="l36.309" class="difflineminus">-  else if (gDialog.CloseButton.getAttribute(&quot;default&quot;) == &quot;true&quot;)</span>
<a href="#l36.310"></a><span id="l36.310" class="difflineplus">+  } else if (gDialog.CloseButton.getAttribute(&quot;default&quot;) == &quot;true&quot;) {</span>
<a href="#l36.311"></a><span id="l36.311">     onClose();</span>
<a href="#l36.312"></a><span id="l36.312" class="difflineplus">+  }</span>
<a href="#l36.313"></a><span id="l36.313"> </span>
<a href="#l36.314"></a><span id="l36.314">   event.preventDefault();</span>
<a href="#l36.315"></a><span id="l36.315"> }</span>
<a href="#l36.316"></a><span id="l36.316"> </span>
<a href="#l36.317"></a><span id="l36.317"> function ExitSpellChecker() {</span>
<a href="#l36.318"></a><span id="l36.318">   if (gSpellChecker) {</span>
<a href="#l36.319"></a><span id="l36.319">     try {</span>
<a href="#l36.320"></a><span id="l36.320">       gSpellChecker.UninitSpellChecker();</span>
<a href="#l36.321"></a><span id="l36.321">       // now check the document over again with the new dictionary</span>
<a href="#l36.322"></a><span id="l36.322">       // if we have an inline spellchecker</span>
<a href="#l36.323"></a><span id="l36.323" class="difflineminus">-      if ((&quot;InlineSpellCheckerUI&quot; in window.opener) &amp;&amp;</span>
<a href="#l36.324"></a><span id="l36.324" class="difflineminus">-          window.opener.InlineSpellCheckerUI.enabled)</span>
<a href="#l36.325"></a><span id="l36.325" class="difflineminus">-        window.opener.InlineSpellCheckerUI.mInlineSpellChecker.spellCheckRange(null);</span>
<a href="#l36.326"></a><span id="l36.326" class="difflineplus">+      if (</span>
<a href="#l36.327"></a><span id="l36.327" class="difflineplus">+        &quot;InlineSpellCheckerUI&quot; in window.opener &amp;&amp;</span>
<a href="#l36.328"></a><span id="l36.328" class="difflineplus">+        window.opener.InlineSpellCheckerUI.enabled</span>
<a href="#l36.329"></a><span id="l36.329" class="difflineplus">+      ) {</span>
<a href="#l36.330"></a><span id="l36.330" class="difflineplus">+        window.opener.InlineSpellCheckerUI.mInlineSpellChecker.spellCheckRange(</span>
<a href="#l36.331"></a><span id="l36.331" class="difflineplus">+          null</span>
<a href="#l36.332"></a><span id="l36.332" class="difflineplus">+        );</span>
<a href="#l36.333"></a><span id="l36.333" class="difflineplus">+      }</span>
<a href="#l36.334"></a><span id="l36.334">     } finally {</span>
<a href="#l36.335"></a><span id="l36.335">       gSpellChecker = null;</span>
<a href="#l36.336"></a><span id="l36.336">     }</span>
<a href="#l36.337"></a><span id="l36.337">   }</span>
<a href="#l36.338"></a><span id="l36.338"> }</span>
<a href="#l36.339"></a><span id="l36.339"> </span>
<a href="#l36.340"></a><span id="l36.340"> function CancelSpellCheck() {</span>
<a href="#l36.341"></a><span id="l36.341">   ExitSpellChecker();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdTableProps.js</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdTableProps.js</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -8,24 +8,24 @@</span>
<a href="#l37.4"></a><span id="l37.4"> // Cancel() is in EdDialogCommon.js</span>
<a href="#l37.5"></a><span id="l37.5"> </span>
<a href="#l37.6"></a><span id="l37.6"> var gTableElement;</span>
<a href="#l37.7"></a><span id="l37.7"> var gCellElement;</span>
<a href="#l37.8"></a><span id="l37.8"> var gTableCaptionElement;</span>
<a href="#l37.9"></a><span id="l37.9"> var globalCellElement;</span>
<a href="#l37.10"></a><span id="l37.10"> var globalTableElement;</span>
<a href="#l37.11"></a><span id="l37.11"> var gValidateTab;</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-const defHAlign =   &quot;left&quot;;</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineminus">-const centerStr =   &quot;center&quot;;  // Index=1</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineminus">-const rightStr =    &quot;right&quot;;   // 2</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineminus">-const justifyStr =  &quot;justify&quot;; // 3</span>
<a href="#l37.16"></a><span id="l37.16" class="difflineminus">-const charStr =     &quot;char&quot;;    // 4</span>
<a href="#l37.17"></a><span id="l37.17" class="difflineminus">-const defVAlign =   &quot;middle&quot;;</span>
<a href="#l37.18"></a><span id="l37.18" class="difflineminus">-const topStr =      &quot;top&quot;;</span>
<a href="#l37.19"></a><span id="l37.19" class="difflineminus">-const bottomStr =   &quot;bottom&quot;;</span>
<a href="#l37.20"></a><span id="l37.20" class="difflineplus">+const defHAlign = &quot;left&quot;;</span>
<a href="#l37.21"></a><span id="l37.21" class="difflineplus">+const centerStr = &quot;center&quot;; // Index=1</span>
<a href="#l37.22"></a><span id="l37.22" class="difflineplus">+const rightStr = &quot;right&quot;; // 2</span>
<a href="#l37.23"></a><span id="l37.23" class="difflineplus">+const justifyStr = &quot;justify&quot;; // 3</span>
<a href="#l37.24"></a><span id="l37.24" class="difflineplus">+const charStr = &quot;char&quot;; // 4</span>
<a href="#l37.25"></a><span id="l37.25" class="difflineplus">+const defVAlign = &quot;middle&quot;;</span>
<a href="#l37.26"></a><span id="l37.26" class="difflineplus">+const topStr = &quot;top&quot;;</span>
<a href="#l37.27"></a><span id="l37.27" class="difflineplus">+const bottomStr = &quot;bottom&quot;;</span>
<a href="#l37.28"></a><span id="l37.28"> const bgcolor = &quot;bgcolor&quot;;</span>
<a href="#l37.29"></a><span id="l37.29"> var gTableColor;</span>
<a href="#l37.30"></a><span id="l37.30"> var gCellColor;</span>
<a href="#l37.31"></a><span id="l37.31"> </span>
<a href="#l37.32"></a><span id="l37.32"> const cssBackgroundColorStr = &quot;background-color&quot;;</span>
<a href="#l37.33"></a><span id="l37.33"> </span>
<a href="#l37.34"></a><span id="l37.34"> var gRowCount = 1;</span>
<a href="#l37.35"></a><span id="l37.35"> var gColCount = 1;</span>
<a href="#l37.36"></a><span id="l37.36" class="difflineat">@@ -36,19 +36,26 @@ var gNewColCount;</span>
<a href="#l37.37"></a><span id="l37.37"> var gCurRowIndex;</span>
<a href="#l37.38"></a><span id="l37.38"> var gCurColIndex;</span>
<a href="#l37.39"></a><span id="l37.39"> var gCurColSpan;</span>
<a href="#l37.40"></a><span id="l37.40"> var gSelectedCellsType = 1;</span>
<a href="#l37.41"></a><span id="l37.41"> const SELECT_CELL = 1;</span>
<a href="#l37.42"></a><span id="l37.42"> const SELECT_ROW = 2;</span>
<a href="#l37.43"></a><span id="l37.43"> const SELECT_COLUMN = 3;</span>
<a href="#l37.44"></a><span id="l37.44"> const RESET_SELECTION = 0;</span>
<a href="#l37.45"></a><span id="l37.45" class="difflineminus">-var gCellData = { value: null, startRowIndex: 0, startColIndex: 0, rowSpan: 0, colSpan: 0,</span>
<a href="#l37.46"></a><span id="l37.46" class="difflineminus">-                 actualRowSpan: 0, actualColSpan: 0, isSelected: false,</span>
<a href="#l37.47"></a><span id="l37.47" class="difflineminus">-               };</span>
<a href="#l37.48"></a><span id="l37.48" class="difflineplus">+var gCellData = {</span>
<a href="#l37.49"></a><span id="l37.49" class="difflineplus">+  value: null,</span>
<a href="#l37.50"></a><span id="l37.50" class="difflineplus">+  startRowIndex: 0,</span>
<a href="#l37.51"></a><span id="l37.51" class="difflineplus">+  startColIndex: 0,</span>
<a href="#l37.52"></a><span id="l37.52" class="difflineplus">+  rowSpan: 0,</span>
<a href="#l37.53"></a><span id="l37.53" class="difflineplus">+  colSpan: 0,</span>
<a href="#l37.54"></a><span id="l37.54" class="difflineplus">+  actualRowSpan: 0,</span>
<a href="#l37.55"></a><span id="l37.55" class="difflineplus">+  actualColSpan: 0,</span>
<a href="#l37.56"></a><span id="l37.56" class="difflineplus">+  isSelected: false,</span>
<a href="#l37.57"></a><span id="l37.57" class="difflineplus">+};</span>
<a href="#l37.58"></a><span id="l37.58"> var gAdvancedEditUsed;</span>
<a href="#l37.59"></a><span id="l37.59"> var gAlignWasChar = false;</span>
<a href="#l37.60"></a><span id="l37.60"> </span>
<a href="#l37.61"></a><span id="l37.61"> /*</span>
<a href="#l37.62"></a><span id="l37.62"> From C++:</span>
<a href="#l37.63"></a><span id="l37.63">  0 TABLESELECTION_TABLE</span>
<a href="#l37.64"></a><span id="l37.64">  1 TABLESELECTION_CELL   There are 1 or more cells selected</span>
<a href="#l37.65"></a><span id="l37.65">                           but complete rows or columns are not selected</span>
<a href="#l37.66"></a><span id="l37.66" class="difflineat">@@ -77,41 +84,46 @@ function Startup() {</span>
<a href="#l37.67"></a><span id="l37.67">   if (!gActiveEditor) {</span>
<a href="#l37.68"></a><span id="l37.68">     window.close();</span>
<a href="#l37.69"></a><span id="l37.69">     return;</span>
<a href="#l37.70"></a><span id="l37.70">   }</span>
<a href="#l37.71"></a><span id="l37.71"> </span>
<a href="#l37.72"></a><span id="l37.72">   try {</span>
<a href="#l37.73"></a><span id="l37.73">     gSelection = gActiveEditor.selection;</span>
<a href="#l37.74"></a><span id="l37.74">   } catch (e) {}</span>
<a href="#l37.75"></a><span id="l37.75" class="difflineminus">-  if (!gSelection) return;</span>
<a href="#l37.76"></a><span id="l37.76" class="difflineplus">+  if (!gSelection) {</span>
<a href="#l37.77"></a><span id="l37.77" class="difflineplus">+    return;</span>
<a href="#l37.78"></a><span id="l37.78" class="difflineplus">+  }</span>
<a href="#l37.79"></a><span id="l37.79"> </span>
<a href="#l37.80"></a><span id="l37.80">   // Get dialog widgets - Table Panel</span>
<a href="#l37.81"></a><span id="l37.81">   gDialog.TableRowsInput = document.getElementById(&quot;TableRowsInput&quot;);</span>
<a href="#l37.82"></a><span id="l37.82">   gDialog.TableColumnsInput = document.getElementById(&quot;TableColumnsInput&quot;);</span>
<a href="#l37.83"></a><span id="l37.83">   gDialog.TableWidthInput = document.getElementById(&quot;TableWidthInput&quot;);</span>
<a href="#l37.84"></a><span id="l37.84">   gDialog.TableWidthUnits = document.getElementById(&quot;TableWidthUnits&quot;);</span>
<a href="#l37.85"></a><span id="l37.85">   gDialog.TableHeightInput = document.getElementById(&quot;TableHeightInput&quot;);</span>
<a href="#l37.86"></a><span id="l37.86">   gDialog.TableHeightUnits = document.getElementById(&quot;TableHeightUnits&quot;);</span>
<a href="#l37.87"></a><span id="l37.87">   try {</span>
<a href="#l37.88"></a><span id="l37.88" class="difflineminus">-    if (!Services.prefs.getBoolPref(&quot;editor.use_css&quot;) || (gActiveEditor.flags &amp; 1)) {</span>
<a href="#l37.89"></a><span id="l37.89" class="difflineplus">+    if (</span>
<a href="#l37.90"></a><span id="l37.90" class="difflineplus">+      !Services.prefs.getBoolPref(&quot;editor.use_css&quot;) ||</span>
<a href="#l37.91"></a><span id="l37.91" class="difflineplus">+      gActiveEditor.flags &amp; 1</span>
<a href="#l37.92"></a><span id="l37.92" class="difflineplus">+    ) {</span>
<a href="#l37.93"></a><span id="l37.93">       gUseCSS = false;</span>
<a href="#l37.94"></a><span id="l37.94">       var tableHeightLabel = document.getElementById(&quot;TableHeightLabel&quot;);</span>
<a href="#l37.95"></a><span id="l37.95">       tableHeightLabel.remove();</span>
<a href="#l37.96"></a><span id="l37.96">       gDialog.TableHeightInput.remove();</span>
<a href="#l37.97"></a><span id="l37.97">       gDialog.TableHeightUnits.remove();</span>
<a href="#l37.98"></a><span id="l37.98">     }</span>
<a href="#l37.99"></a><span id="l37.99">   } catch (e) {}</span>
<a href="#l37.100"></a><span id="l37.100">   gDialog.BorderWidthInput = document.getElementById(&quot;BorderWidthInput&quot;);</span>
<a href="#l37.101"></a><span id="l37.101">   gDialog.SpacingInput = document.getElementById(&quot;SpacingInput&quot;);</span>
<a href="#l37.102"></a><span id="l37.102">   gDialog.PaddingInput = document.getElementById(&quot;PaddingInput&quot;);</span>
<a href="#l37.103"></a><span id="l37.103">   gDialog.TableAlignList = document.getElementById(&quot;TableAlignList&quot;);</span>
<a href="#l37.104"></a><span id="l37.104">   gDialog.TableCaptionList = document.getElementById(&quot;TableCaptionList&quot;);</span>
<a href="#l37.105"></a><span id="l37.105">   gDialog.TableInheritColor = document.getElementById(&quot;TableInheritColor&quot;);</span>
<a href="#l37.106"></a><span id="l37.106" class="difflineminus">-  gDialog.TabBox =  document.getElementById(&quot;TabBox&quot;);</span>
<a href="#l37.107"></a><span id="l37.107" class="difflineplus">+  gDialog.TabBox = document.getElementById(&quot;TabBox&quot;);</span>
<a href="#l37.108"></a><span id="l37.108"> </span>
<a href="#l37.109"></a><span id="l37.109">   // Cell Panel</span>
<a href="#l37.110"></a><span id="l37.110">   gDialog.SelectionList = document.getElementById(&quot;SelectionList&quot;);</span>
<a href="#l37.111"></a><span id="l37.111">   gDialog.PreviousButton = document.getElementById(&quot;PreviousButton&quot;);</span>
<a href="#l37.112"></a><span id="l37.112">   gDialog.NextButton = document.getElementById(&quot;NextButton&quot;);</span>
<a href="#l37.113"></a><span id="l37.113">   // Currently, we always apply changes and load new attributes when changing selection</span>
<a href="#l37.114"></a><span id="l37.114">   // (Let's keep this for possible future use)</span>
<a href="#l37.115"></a><span id="l37.115">   // gDialog.ApplyBeforeMove =  document.getElementById(&quot;ApplyBeforeMove&quot;);</span>
<a href="#l37.116"></a><span id="l37.116" class="difflineat">@@ -136,72 +148,84 @@ function Startup() {</span>
<a href="#l37.117"></a><span id="l37.117">   gDialog.CellVAlignCheckbox = document.getElementById(&quot;CellVAlignCheckbox&quot;);</span>
<a href="#l37.118"></a><span id="l37.118">   gDialog.CellStyleCheckbox = document.getElementById(&quot;CellStyleCheckbox&quot;);</span>
<a href="#l37.119"></a><span id="l37.119">   gDialog.TextWrapCheckbox = document.getElementById(&quot;TextWrapCheckbox&quot;);</span>
<a href="#l37.120"></a><span id="l37.120">   gDialog.CellColorCheckbox = document.getElementById(&quot;CellColorCheckbox&quot;);</span>
<a href="#l37.121"></a><span id="l37.121">   gDialog.TableTab = document.getElementById(&quot;TableTab&quot;);</span>
<a href="#l37.122"></a><span id="l37.122">   gDialog.CellTab = document.getElementById(&quot;CellTab&quot;);</span>
<a href="#l37.123"></a><span id="l37.123">   gDialog.AdvancedEditCell = document.getElementById(&quot;AdvancedEditButton2&quot;);</span>
<a href="#l37.124"></a><span id="l37.124">   // Save &quot;normal&quot; tooltip message for Advanced Edit button</span>
<a href="#l37.125"></a><span id="l37.125" class="difflineminus">-  gDialog.AdvancedEditCellToolTipText = gDialog.AdvancedEditCell.getAttribute(&quot;tooltiptext&quot;);</span>
<a href="#l37.126"></a><span id="l37.126" class="difflineplus">+  gDialog.AdvancedEditCellToolTipText = gDialog.AdvancedEditCell.getAttribute(</span>
<a href="#l37.127"></a><span id="l37.127" class="difflineplus">+    &quot;tooltiptext&quot;</span>
<a href="#l37.128"></a><span id="l37.128" class="difflineplus">+  );</span>
<a href="#l37.129"></a><span id="l37.129"> </span>
<a href="#l37.130"></a><span id="l37.130">   try {</span>
<a href="#l37.131"></a><span id="l37.131">     gTableElement = gActiveEditor.getElementOrParentByTagName(&quot;table&quot;, null);</span>
<a href="#l37.132"></a><span id="l37.132">   } catch (e) {}</span>
<a href="#l37.133"></a><span id="l37.133">   if (!gTableElement) {</span>
<a href="#l37.134"></a><span id="l37.134">     dump(&quot;Failed to get table element!\n&quot;);</span>
<a href="#l37.135"></a><span id="l37.135">     window.close();</span>
<a href="#l37.136"></a><span id="l37.136">     return;</span>
<a href="#l37.137"></a><span id="l37.137">   }</span>
<a href="#l37.138"></a><span id="l37.138">   globalTableElement = gTableElement.cloneNode(false);</span>
<a href="#l37.139"></a><span id="l37.139"> </span>
<a href="#l37.140"></a><span id="l37.140">   var tagNameObj = { value: &quot;&quot; };</span>
<a href="#l37.141"></a><span id="l37.141">   var countObj = { value: 0 };</span>
<a href="#l37.142"></a><span id="l37.142">   var tableOrCellElement;</span>
<a href="#l37.143"></a><span id="l37.143">   try {</span>
<a href="#l37.144"></a><span id="l37.144" class="difflineminus">-   tableOrCellElement = gActiveEditor.getSelectedOrParentTableElement(tagNameObj, countObj);</span>
<a href="#l37.145"></a><span id="l37.145" class="difflineplus">+    tableOrCellElement = gActiveEditor.getSelectedOrParentTableElement(</span>
<a href="#l37.146"></a><span id="l37.146" class="difflineplus">+      tagNameObj,</span>
<a href="#l37.147"></a><span id="l37.147" class="difflineplus">+      countObj</span>
<a href="#l37.148"></a><span id="l37.148" class="difflineplus">+    );</span>
<a href="#l37.149"></a><span id="l37.149">   } catch (e) {}</span>
<a href="#l37.150"></a><span id="l37.150"> </span>
<a href="#l37.151"></a><span id="l37.151">   if (tagNameObj.value == &quot;td&quot;) {</span>
<a href="#l37.152"></a><span id="l37.152">     // We are in a cell</span>
<a href="#l37.153"></a><span id="l37.153">     gSelectedCellCount = countObj.value;</span>
<a href="#l37.154"></a><span id="l37.154">     gCellElement = tableOrCellElement;</span>
<a href="#l37.155"></a><span id="l37.155">     globalCellElement = gCellElement.cloneNode(false);</span>
<a href="#l37.156"></a><span id="l37.156"> </span>
<a href="#l37.157"></a><span id="l37.157">     // Tells us whether cell, row, or column is selected</span>
<a href="#l37.158"></a><span id="l37.158">     try {</span>
<a href="#l37.159"></a><span id="l37.159">       gSelectedCellsType = gActiveEditor.getSelectedCellsType(gTableElement);</span>
<a href="#l37.160"></a><span id="l37.160">     } catch (e) {}</span>
<a href="#l37.161"></a><span id="l37.161"> </span>
<a href="#l37.162"></a><span id="l37.162">     // Ignore types except Cell, Row, and Column</span>
<a href="#l37.163"></a><span id="l37.163" class="difflineminus">-    if (gSelectedCellsType &lt; SELECT_CELL || gSelectedCellsType &gt; SELECT_COLUMN)</span>
<a href="#l37.164"></a><span id="l37.164" class="difflineplus">+    if (</span>
<a href="#l37.165"></a><span id="l37.165" class="difflineplus">+      gSelectedCellsType &lt; SELECT_CELL ||</span>
<a href="#l37.166"></a><span id="l37.166" class="difflineplus">+      gSelectedCellsType &gt; SELECT_COLUMN</span>
<a href="#l37.167"></a><span id="l37.167" class="difflineplus">+    ) {</span>
<a href="#l37.168"></a><span id="l37.168">       gSelectedCellsType = SELECT_CELL;</span>
<a href="#l37.169"></a><span id="l37.169" class="difflineplus">+    }</span>
<a href="#l37.170"></a><span id="l37.170"> </span>
<a href="#l37.171"></a><span id="l37.171">     // Be sure at least 1 cell is selected.</span>
<a href="#l37.172"></a><span id="l37.172">     // (If the count is 0, then we were inside the cell.)</span>
<a href="#l37.173"></a><span id="l37.173" class="difflineminus">-    if (gSelectedCellCount == 0)</span>
<a href="#l37.174"></a><span id="l37.174" class="difflineplus">+    if (gSelectedCellCount == 0) {</span>
<a href="#l37.175"></a><span id="l37.175">       DoCellSelection();</span>
<a href="#l37.176"></a><span id="l37.176" class="difflineplus">+    }</span>
<a href="#l37.177"></a><span id="l37.177"> </span>
<a href="#l37.178"></a><span id="l37.178">     // Get location in the cell map</span>
<a href="#l37.179"></a><span id="l37.179">     var rowIndexObj = { value: 0 };</span>
<a href="#l37.180"></a><span id="l37.180">     var colIndexObj = { value: 0 };</span>
<a href="#l37.181"></a><span id="l37.181">     try {</span>
<a href="#l37.182"></a><span id="l37.182">       gActiveEditor.getCellIndexes(gCellElement, rowIndexObj, colIndexObj);</span>
<a href="#l37.183"></a><span id="l37.183">     } catch (e) {}</span>
<a href="#l37.184"></a><span id="l37.184">     gCurRowIndex = rowIndexObj.value;</span>
<a href="#l37.185"></a><span id="l37.185">     gCurColIndex = colIndexObj.value;</span>
<a href="#l37.186"></a><span id="l37.186"> </span>
<a href="#l37.187"></a><span id="l37.187">     // We save the current colspan to quickly</span>
<a href="#l37.188"></a><span id="l37.188">     //  move selection from from cell to cell</span>
<a href="#l37.189"></a><span id="l37.189" class="difflineminus">-    if (GetCellData(gCurRowIndex, gCurColIndex))</span>
<a href="#l37.190"></a><span id="l37.190" class="difflineplus">+    if (GetCellData(gCurRowIndex, gCurColIndex)) {</span>
<a href="#l37.191"></a><span id="l37.191">       gCurColSpan = gCellData.colSpan;</span>
<a href="#l37.192"></a><span id="l37.192" class="difflineplus">+    }</span>
<a href="#l37.193"></a><span id="l37.193"> </span>
<a href="#l37.194"></a><span id="l37.194">     // Starting TabPanel name is passed in</span>
<a href="#l37.195"></a><span id="l37.195" class="difflineminus">-    if (window.arguments[1] == &quot;CellPanel&quot;)</span>
<a href="#l37.196"></a><span id="l37.196" class="difflineplus">+    if (window.arguments[1] == &quot;CellPanel&quot;) {</span>
<a href="#l37.197"></a><span id="l37.197">       gDialog.TabBox.selectedTab = gDialog.CellTab;</span>
<a href="#l37.198"></a><span id="l37.198" class="difflineplus">+    }</span>
<a href="#l37.199"></a><span id="l37.199">   }</span>
<a href="#l37.200"></a><span id="l37.200"> </span>
<a href="#l37.201"></a><span id="l37.201">   if (gDialog.TabBox.selectedTab == gDialog.TableTab) {</span>
<a href="#l37.202"></a><span id="l37.202">     // We may call this with table selected, but no cell,</span>
<a href="#l37.203"></a><span id="l37.203">     //  so disable the Cell Properties tab</span>
<a href="#l37.204"></a><span id="l37.204">     if (!gCellElement) {</span>
<a href="#l37.205"></a><span id="l37.205">       // XXX: Disabling of tabs is currently broken, so for</span>
<a href="#l37.206"></a><span id="l37.206">       //      now we'll just remove the tab completely.</span>
<a href="#l37.207"></a><span id="l37.207" class="difflineat">@@ -219,23 +243,23 @@ function Startup() {</span>
<a href="#l37.208"></a><span id="l37.208">     gActiveEditor.getTableSize(gTableElement, rowCountObj, colCountObj);</span>
<a href="#l37.209"></a><span id="l37.209">   } catch (e) {}</span>
<a href="#l37.210"></a><span id="l37.210"> </span>
<a href="#l37.211"></a><span id="l37.211">   gRowCount = rowCountObj.value;</span>
<a href="#l37.212"></a><span id="l37.212">   gLastRowIndex = gRowCount - 1;</span>
<a href="#l37.213"></a><span id="l37.213">   gColCount = colCountObj.value;</span>
<a href="#l37.214"></a><span id="l37.214">   gLastColIndex = gColCount - 1;</span>
<a href="#l37.215"></a><span id="l37.215"> </span>
<a href="#l37.216"></a><span id="l37.216" class="difflineminus">-</span>
<a href="#l37.217"></a><span id="l37.217">   // Set appropriate icons and enable state for the Previous/Next buttons</span>
<a href="#l37.218"></a><span id="l37.218">   SetSelectionButtons();</span>
<a href="#l37.219"></a><span id="l37.219"> </span>
<a href="#l37.220"></a><span id="l37.220">   // If only one cell in table, disable change-selection widgets</span>
<a href="#l37.221"></a><span id="l37.221" class="difflineminus">-  if (gRowCount == 1 &amp;&amp; gColCount == 1)</span>
<a href="#l37.222"></a><span id="l37.222" class="difflineplus">+  if (gRowCount == 1 &amp;&amp; gColCount == 1) {</span>
<a href="#l37.223"></a><span id="l37.223">     gDialog.SelectionList.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l37.224"></a><span id="l37.224" class="difflineplus">+  }</span>
<a href="#l37.225"></a><span id="l37.225"> </span>
<a href="#l37.226"></a><span id="l37.226">   // User can change these via textboxes</span>
<a href="#l37.227"></a><span id="l37.227">   gNewRowCount = gRowCount;</span>
<a href="#l37.228"></a><span id="l37.228">   gNewColCount = gColCount;</span>
<a href="#l37.229"></a><span id="l37.229"> </span>
<a href="#l37.230"></a><span id="l37.230">   // This flag is used to control whether set check state</span>
<a href="#l37.231"></a><span id="l37.231">   //  on &quot;set attribute&quot; checkboxes</span>
<a href="#l37.232"></a><span id="l37.232">   // (Advanced Edit dialog use calls  InitDialog when done)</span>
<a href="#l37.233"></a><span id="l37.233" class="difflineat">@@ -244,122 +268,189 @@ function Startup() {</span>
<a href="#l37.234"></a><span id="l37.234">   gAdvancedEditUsed = true;</span>
<a href="#l37.235"></a><span id="l37.235"> </span>
<a href="#l37.236"></a><span id="l37.236">   // If first initializing, we really aren't changing anything</span>
<a href="#l37.237"></a><span id="l37.237">   gCellDataChanged = false;</span>
<a href="#l37.238"></a><span id="l37.238"> </span>
<a href="#l37.239"></a><span id="l37.239">   SetWindowLocation();</span>
<a href="#l37.240"></a><span id="l37.240"> }</span>
<a href="#l37.241"></a><span id="l37.241"> </span>
<a href="#l37.242"></a><span id="l37.242" class="difflineminus">-</span>
<a href="#l37.243"></a><span id="l37.243"> function InitDialog() {</span>
<a href="#l37.244"></a><span id="l37.244">   // Get Table attributes</span>
<a href="#l37.245"></a><span id="l37.245">   gDialog.TableRowsInput.value = gRowCount;</span>
<a href="#l37.246"></a><span id="l37.246">   gDialog.TableColumnsInput.value = gColCount;</span>
<a href="#l37.247"></a><span id="l37.247" class="difflineminus">-  gDialog.TableWidthInput.value = InitPixelOrPercentMenulist(globalTableElement, gTableElement, &quot;width&quot;, &quot;TableWidthUnits&quot;, gPercent);</span>
<a href="#l37.248"></a><span id="l37.248" class="difflineplus">+  gDialog.TableWidthInput.value = InitPixelOrPercentMenulist(</span>
<a href="#l37.249"></a><span id="l37.249" class="difflineplus">+    globalTableElement,</span>
<a href="#l37.250"></a><span id="l37.250" class="difflineplus">+    gTableElement,</span>
<a href="#l37.251"></a><span id="l37.251" class="difflineplus">+    &quot;width&quot;,</span>
<a href="#l37.252"></a><span id="l37.252" class="difflineplus">+    &quot;TableWidthUnits&quot;,</span>
<a href="#l37.253"></a><span id="l37.253" class="difflineplus">+    gPercent</span>
<a href="#l37.254"></a><span id="l37.254" class="difflineplus">+  );</span>
<a href="#l37.255"></a><span id="l37.255">   if (gUseCSS) {</span>
<a href="#l37.256"></a><span id="l37.256" class="difflineminus">-    gDialog.TableHeightInput.value = InitPixelOrPercentMenulist(globalTableElement, gTableElement, &quot;height&quot;,</span>
<a href="#l37.257"></a><span id="l37.257" class="difflineminus">-                                                                &quot;TableHeightUnits&quot;, gPercent);</span>
<a href="#l37.258"></a><span id="l37.258" class="difflineplus">+    gDialog.TableHeightInput.value = InitPixelOrPercentMenulist(</span>
<a href="#l37.259"></a><span id="l37.259" class="difflineplus">+      globalTableElement,</span>
<a href="#l37.260"></a><span id="l37.260" class="difflineplus">+      gTableElement,</span>
<a href="#l37.261"></a><span id="l37.261" class="difflineplus">+      &quot;height&quot;,</span>
<a href="#l37.262"></a><span id="l37.262" class="difflineplus">+      &quot;TableHeightUnits&quot;,</span>
<a href="#l37.263"></a><span id="l37.263" class="difflineplus">+      gPercent</span>
<a href="#l37.264"></a><span id="l37.264" class="difflineplus">+    );</span>
<a href="#l37.265"></a><span id="l37.265">   }</span>
<a href="#l37.266"></a><span id="l37.266">   gDialog.BorderWidthInput.value = globalTableElement.border;</span>
<a href="#l37.267"></a><span id="l37.267">   gDialog.SpacingInput.value = globalTableElement.cellSpacing;</span>
<a href="#l37.268"></a><span id="l37.268">   gDialog.PaddingInput.value = globalTableElement.cellPadding;</span>
<a href="#l37.269"></a><span id="l37.269"> </span>
<a href="#l37.270"></a><span id="l37.270" class="difflineminus">-  var marginLeft  = GetHTMLOrCSSStyleValue(globalTableElement, &quot;align&quot;, &quot;margin-left&quot;);</span>
<a href="#l37.271"></a><span id="l37.271" class="difflineminus">-  var marginRight = GetHTMLOrCSSStyleValue(globalTableElement, &quot;align&quot;, &quot;margin-right&quot;);</span>
<a href="#l37.272"></a><span id="l37.272" class="difflineplus">+  var marginLeft = GetHTMLOrCSSStyleValue(</span>
<a href="#l37.273"></a><span id="l37.273" class="difflineplus">+    globalTableElement,</span>
<a href="#l37.274"></a><span id="l37.274" class="difflineplus">+    &quot;align&quot;,</span>
<a href="#l37.275"></a><span id="l37.275" class="difflineplus">+    &quot;margin-left&quot;</span>
<a href="#l37.276"></a><span id="l37.276" class="difflineplus">+  );</span>
<a href="#l37.277"></a><span id="l37.277" class="difflineplus">+  var marginRight = GetHTMLOrCSSStyleValue(</span>
<a href="#l37.278"></a><span id="l37.278" class="difflineplus">+    globalTableElement,</span>
<a href="#l37.279"></a><span id="l37.279" class="difflineplus">+    &quot;align&quot;,</span>
<a href="#l37.280"></a><span id="l37.280" class="difflineplus">+    &quot;margin-right&quot;</span>
<a href="#l37.281"></a><span id="l37.281" class="difflineplus">+  );</span>
<a href="#l37.282"></a><span id="l37.282">   var halign = marginLeft.toLowerCase() + &quot; &quot; + marginRight.toLowerCase();</span>
<a href="#l37.283"></a><span id="l37.283" class="difflineminus">-  if (halign == &quot;center center&quot; || halign == &quot;auto auto&quot;)</span>
<a href="#l37.284"></a><span id="l37.284" class="difflineplus">+  if (halign == &quot;center center&quot; || halign == &quot;auto auto&quot;) {</span>
<a href="#l37.285"></a><span id="l37.285">     gDialog.TableAlignList.value = &quot;center&quot;;</span>
<a href="#l37.286"></a><span id="l37.286" class="difflineminus">-  else if (halign == &quot;right right&quot; || halign == &quot;auto 0px&quot;)</span>
<a href="#l37.287"></a><span id="l37.287" class="difflineplus">+  } else if (halign == &quot;right right&quot; || halign == &quot;auto 0px&quot;) {</span>
<a href="#l37.288"></a><span id="l37.288">     gDialog.TableAlignList.value = &quot;right&quot;;</span>
<a href="#l37.289"></a><span id="l37.289" class="difflineminus">-  else // Default = left</span>
<a href="#l37.290"></a><span id="l37.290" class="difflineplus">+  } // Default = left</span>
<a href="#l37.291"></a><span id="l37.291" class="difflineplus">+  else {</span>
<a href="#l37.292"></a><span id="l37.292">     gDialog.TableAlignList.value = &quot;left&quot;;</span>
<a href="#l37.293"></a><span id="l37.293" class="difflineplus">+  }</span>
<a href="#l37.294"></a><span id="l37.294"> </span>
<a href="#l37.295"></a><span id="l37.295">   // Be sure to get caption from table in doc, not the copied &quot;globalTableElement&quot;</span>
<a href="#l37.296"></a><span id="l37.296">   gTableCaptionElement = gTableElement.caption;</span>
<a href="#l37.297"></a><span id="l37.297">   if (gTableCaptionElement) {</span>
<a href="#l37.298"></a><span id="l37.298" class="difflineminus">-    var align = GetHTMLOrCSSStyleValue(gTableCaptionElement, &quot;align&quot;, &quot;caption-side&quot;);</span>
<a href="#l37.299"></a><span id="l37.299" class="difflineminus">-    if (align != &quot;bottom&quot; &amp;&amp; align != &quot;left&quot; &amp;&amp; align != &quot;right&quot;)</span>
<a href="#l37.300"></a><span id="l37.300" class="difflineplus">+    var align = GetHTMLOrCSSStyleValue(</span>
<a href="#l37.301"></a><span id="l37.301" class="difflineplus">+      gTableCaptionElement,</span>
<a href="#l37.302"></a><span id="l37.302" class="difflineplus">+      &quot;align&quot;,</span>
<a href="#l37.303"></a><span id="l37.303" class="difflineplus">+      &quot;caption-side&quot;</span>
<a href="#l37.304"></a><span id="l37.304" class="difflineplus">+    );</span>
<a href="#l37.305"></a><span id="l37.305" class="difflineplus">+    if (align != &quot;bottom&quot; &amp;&amp; align != &quot;left&quot; &amp;&amp; align != &quot;right&quot;) {</span>
<a href="#l37.306"></a><span id="l37.306">       align = &quot;top&quot;;</span>
<a href="#l37.307"></a><span id="l37.307" class="difflineplus">+    }</span>
<a href="#l37.308"></a><span id="l37.308">     gDialog.TableCaptionList.value = align;</span>
<a href="#l37.309"></a><span id="l37.309">   }</span>
<a href="#l37.310"></a><span id="l37.310"> </span>
<a href="#l37.311"></a><span id="l37.311" class="difflineminus">-  gTableColor = GetHTMLOrCSSStyleValue(globalTableElement, bgcolor, cssBackgroundColorStr);</span>
<a href="#l37.312"></a><span id="l37.312" class="difflineplus">+  gTableColor = GetHTMLOrCSSStyleValue(</span>
<a href="#l37.313"></a><span id="l37.313" class="difflineplus">+    globalTableElement,</span>
<a href="#l37.314"></a><span id="l37.314" class="difflineplus">+    bgcolor,</span>
<a href="#l37.315"></a><span id="l37.315" class="difflineplus">+    cssBackgroundColorStr</span>
<a href="#l37.316"></a><span id="l37.316" class="difflineplus">+  );</span>
<a href="#l37.317"></a><span id="l37.317">   gTableColor = ConvertRGBColorIntoHEXColor(gTableColor);</span>
<a href="#l37.318"></a><span id="l37.318">   SetColor(&quot;tableBackgroundCW&quot;, gTableColor);</span>
<a href="#l37.319"></a><span id="l37.319"> </span>
<a href="#l37.320"></a><span id="l37.320">   InitCellPanel();</span>
<a href="#l37.321"></a><span id="l37.321"> }</span>
<a href="#l37.322"></a><span id="l37.322"> </span>
<a href="#l37.323"></a><span id="l37.323"> function InitCellPanel() {</span>
<a href="#l37.324"></a><span id="l37.324">   // Get cell attributes</span>
<a href="#l37.325"></a><span id="l37.325">   if (globalCellElement) {</span>
<a href="#l37.326"></a><span id="l37.326">     // This assumes order of items is Cell, Row, Column</span>
<a href="#l37.327"></a><span id="l37.327">     gDialog.SelectionList.value = gSelectedCellsType;</span>
<a href="#l37.328"></a><span id="l37.328"> </span>
<a href="#l37.329"></a><span id="l37.329">     var previousValue = gDialog.CellHeightInput.value;</span>
<a href="#l37.330"></a><span id="l37.330" class="difflineminus">-    gDialog.CellHeightInput.value = InitPixelOrPercentMenulist(globalCellElement, gCellElement, &quot;height&quot;, &quot;CellHeightUnits&quot;, gPixel);</span>
<a href="#l37.331"></a><span id="l37.331" class="difflineminus">-    gDialog.CellHeightCheckbox.checked = gAdvancedEditUsed &amp;&amp; previousValue != gDialog.CellHeightInput.value;</span>
<a href="#l37.332"></a><span id="l37.332" class="difflineplus">+    gDialog.CellHeightInput.value = InitPixelOrPercentMenulist(</span>
<a href="#l37.333"></a><span id="l37.333" class="difflineplus">+      globalCellElement,</span>
<a href="#l37.334"></a><span id="l37.334" class="difflineplus">+      gCellElement,</span>
<a href="#l37.335"></a><span id="l37.335" class="difflineplus">+      &quot;height&quot;,</span>
<a href="#l37.336"></a><span id="l37.336" class="difflineplus">+      &quot;CellHeightUnits&quot;,</span>
<a href="#l37.337"></a><span id="l37.337" class="difflineplus">+      gPixel</span>
<a href="#l37.338"></a><span id="l37.338" class="difflineplus">+    );</span>
<a href="#l37.339"></a><span id="l37.339" class="difflineplus">+    gDialog.CellHeightCheckbox.checked =</span>
<a href="#l37.340"></a><span id="l37.340" class="difflineplus">+      gAdvancedEditUsed &amp;&amp; previousValue != gDialog.CellHeightInput.value;</span>
<a href="#l37.341"></a><span id="l37.341"> </span>
<a href="#l37.342"></a><span id="l37.342">     previousValue = gDialog.CellWidthInput.value;</span>
<a href="#l37.343"></a><span id="l37.343" class="difflineminus">-    gDialog.CellWidthInput.value = InitPixelOrPercentMenulist(globalCellElement, gCellElement, &quot;width&quot;, &quot;CellWidthUnits&quot;, gPixel);</span>
<a href="#l37.344"></a><span id="l37.344" class="difflineminus">-    gDialog.CellWidthCheckbox.checked = gAdvancedEditUsed &amp;&amp; previousValue != gDialog.CellWidthInput.value;</span>
<a href="#l37.345"></a><span id="l37.345" class="difflineplus">+    gDialog.CellWidthInput.value = InitPixelOrPercentMenulist(</span>
<a href="#l37.346"></a><span id="l37.346" class="difflineplus">+      globalCellElement,</span>
<a href="#l37.347"></a><span id="l37.347" class="difflineplus">+      gCellElement,</span>
<a href="#l37.348"></a><span id="l37.348" class="difflineplus">+      &quot;width&quot;,</span>
<a href="#l37.349"></a><span id="l37.349" class="difflineplus">+      &quot;CellWidthUnits&quot;,</span>
<a href="#l37.350"></a><span id="l37.350" class="difflineplus">+      gPixel</span>
<a href="#l37.351"></a><span id="l37.351" class="difflineplus">+    );</span>
<a href="#l37.352"></a><span id="l37.352" class="difflineplus">+    gDialog.CellWidthCheckbox.checked =</span>
<a href="#l37.353"></a><span id="l37.353" class="difflineplus">+      gAdvancedEditUsed &amp;&amp; previousValue != gDialog.CellWidthInput.value;</span>
<a href="#l37.354"></a><span id="l37.354"> </span>
<a href="#l37.355"></a><span id="l37.355">     var previousIndex = gDialog.CellVAlignList.selectedIndex;</span>
<a href="#l37.356"></a><span id="l37.356" class="difflineminus">-    var valign = GetHTMLOrCSSStyleValue(globalCellElement, &quot;valign&quot;, &quot;vertical-align&quot;).toLowerCase();</span>
<a href="#l37.357"></a><span id="l37.357" class="difflineminus">-    if (valign == topStr || valign == bottomStr)</span>
<a href="#l37.358"></a><span id="l37.358" class="difflineplus">+    var valign = GetHTMLOrCSSStyleValue(</span>
<a href="#l37.359"></a><span id="l37.359" class="difflineplus">+      globalCellElement,</span>
<a href="#l37.360"></a><span id="l37.360" class="difflineplus">+      &quot;valign&quot;,</span>
<a href="#l37.361"></a><span id="l37.361" class="difflineplus">+      &quot;vertical-align&quot;</span>
<a href="#l37.362"></a><span id="l37.362" class="difflineplus">+    ).toLowerCase();</span>
<a href="#l37.363"></a><span id="l37.363" class="difflineplus">+    if (valign == topStr || valign == bottomStr) {</span>
<a href="#l37.364"></a><span id="l37.364">       gDialog.CellVAlignList.value = valign;</span>
<a href="#l37.365"></a><span id="l37.365" class="difflineminus">-    else // Default = middle</span>
<a href="#l37.366"></a><span id="l37.366" class="difflineplus">+    } // Default = middle</span>
<a href="#l37.367"></a><span id="l37.367" class="difflineplus">+    else {</span>
<a href="#l37.368"></a><span id="l37.368">       gDialog.CellVAlignList.value = defVAlign;</span>
<a href="#l37.369"></a><span id="l37.369" class="difflineplus">+    }</span>
<a href="#l37.370"></a><span id="l37.370"> </span>
<a href="#l37.371"></a><span id="l37.371" class="difflineminus">-    gDialog.CellVAlignCheckbox.checked = gAdvancedEditUsed &amp;&amp; previousIndex != gDialog.CellVAlignList.selectedIndex;</span>
<a href="#l37.372"></a><span id="l37.372" class="difflineplus">+    gDialog.CellVAlignCheckbox.checked =</span>
<a href="#l37.373"></a><span id="l37.373" class="difflineplus">+      gAdvancedEditUsed &amp;&amp;</span>
<a href="#l37.374"></a><span id="l37.374" class="difflineplus">+      previousIndex != gDialog.CellVAlignList.selectedIndex;</span>
<a href="#l37.375"></a><span id="l37.375"> </span>
<a href="#l37.376"></a><span id="l37.376">     previousIndex = gDialog.CellHAlignList.selectedIndex;</span>
<a href="#l37.377"></a><span id="l37.377"> </span>
<a href="#l37.378"></a><span id="l37.378">     gAlignWasChar = false;</span>
<a href="#l37.379"></a><span id="l37.379"> </span>
<a href="#l37.380"></a><span id="l37.380" class="difflineminus">-    var halign = GetHTMLOrCSSStyleValue(globalCellElement, &quot;align&quot;, &quot;text-align&quot;).toLowerCase();</span>
<a href="#l37.381"></a><span id="l37.381" class="difflineplus">+    var halign = GetHTMLOrCSSStyleValue(</span>
<a href="#l37.382"></a><span id="l37.382" class="difflineplus">+      globalCellElement,</span>
<a href="#l37.383"></a><span id="l37.383" class="difflineplus">+      &quot;align&quot;,</span>
<a href="#l37.384"></a><span id="l37.384" class="difflineplus">+      &quot;text-align&quot;</span>
<a href="#l37.385"></a><span id="l37.385" class="difflineplus">+    ).toLowerCase();</span>
<a href="#l37.386"></a><span id="l37.386">     switch (halign) {</span>
<a href="#l37.387"></a><span id="l37.387">       case centerStr:</span>
<a href="#l37.388"></a><span id="l37.388">       case rightStr:</span>
<a href="#l37.389"></a><span id="l37.389">       case justifyStr:</span>
<a href="#l37.390"></a><span id="l37.390">         gDialog.CellHAlignList.value = halign;</span>
<a href="#l37.391"></a><span id="l37.391">         break;</span>
<a href="#l37.392"></a><span id="l37.392">       case charStr:</span>
<a href="#l37.393"></a><span id="l37.393">         // We don't support UI for this because layout doesn't work: bug 2212.</span>
<a href="#l37.394"></a><span id="l37.394">         // Remember that's what they had so we don't change it</span>
<a href="#l37.395"></a><span id="l37.395">         //  unless they change the alignment by using the menulist</span>
<a href="#l37.396"></a><span id="l37.396">         gAlignWasChar = true;</span>
<a href="#l37.397"></a><span id="l37.397" class="difflineminus">-        // Fall through to use show default alignment in menu</span>
<a href="#l37.398"></a><span id="l37.398" class="difflineplus">+      // Fall through to use show default alignment in menu</span>
<a href="#l37.399"></a><span id="l37.399">       default:</span>
<a href="#l37.400"></a><span id="l37.400">         // Default depends on cell type (TH is &quot;center&quot;, TD is &quot;left&quot;)</span>
<a href="#l37.401"></a><span id="l37.401">         gDialog.CellHAlignList.value =</span>
<a href="#l37.402"></a><span id="l37.402" class="difflineminus">-          (globalCellElement.nodeName.toLowerCase() == &quot;th&quot;) ? &quot;center&quot; : &quot;left&quot;;</span>
<a href="#l37.403"></a><span id="l37.403" class="difflineplus">+          globalCellElement.nodeName.toLowerCase() == &quot;th&quot; ? &quot;center&quot; : &quot;left&quot;;</span>
<a href="#l37.404"></a><span id="l37.404">         break;</span>
<a href="#l37.405"></a><span id="l37.405">     }</span>
<a href="#l37.406"></a><span id="l37.406"> </span>
<a href="#l37.407"></a><span id="l37.407" class="difflineminus">-    gDialog.CellHAlignCheckbox.checked = gAdvancedEditUsed &amp;&amp;</span>
<a href="#l37.408"></a><span id="l37.408" class="difflineplus">+    gDialog.CellHAlignCheckbox.checked =</span>
<a href="#l37.409"></a><span id="l37.409" class="difflineplus">+      gAdvancedEditUsed &amp;&amp;</span>
<a href="#l37.410"></a><span id="l37.410">       previousIndex != gDialog.CellHAlignList.selectedIndex;</span>
<a href="#l37.411"></a><span id="l37.411"> </span>
<a href="#l37.412"></a><span id="l37.412">     previousIndex = gDialog.CellStyleList.selectedIndex;</span>
<a href="#l37.413"></a><span id="l37.413">     gDialog.CellStyleList.value = globalCellElement.nodeName.toLowerCase();</span>
<a href="#l37.414"></a><span id="l37.414" class="difflineminus">-    gDialog.CellStyleCheckbox.checked = gAdvancedEditUsed &amp;&amp; previousIndex != gDialog.CellStyleList.selectedIndex;</span>
<a href="#l37.415"></a><span id="l37.415" class="difflineplus">+    gDialog.CellStyleCheckbox.checked =</span>
<a href="#l37.416"></a><span id="l37.416" class="difflineplus">+      gAdvancedEditUsed &amp;&amp; previousIndex != gDialog.CellStyleList.selectedIndex;</span>
<a href="#l37.417"></a><span id="l37.417"> </span>
<a href="#l37.418"></a><span id="l37.418">     previousIndex = gDialog.TextWrapList.selectedIndex;</span>
<a href="#l37.419"></a><span id="l37.419" class="difflineminus">-    if (GetHTMLOrCSSStyleValue(globalCellElement, &quot;nowrap&quot;, &quot;white-space&quot;) == &quot;nowrap&quot;)</span>
<a href="#l37.420"></a><span id="l37.420" class="difflineplus">+    if (</span>
<a href="#l37.421"></a><span id="l37.421" class="difflineplus">+      GetHTMLOrCSSStyleValue(globalCellElement, &quot;nowrap&quot;, &quot;white-space&quot;) ==</span>
<a href="#l37.422"></a><span id="l37.422" class="difflineplus">+      &quot;nowrap&quot;</span>
<a href="#l37.423"></a><span id="l37.423" class="difflineplus">+    ) {</span>
<a href="#l37.424"></a><span id="l37.424">       gDialog.TextWrapList.value = &quot;nowrap&quot;;</span>
<a href="#l37.425"></a><span id="l37.425" class="difflineminus">-    else</span>
<a href="#l37.426"></a><span id="l37.426" class="difflineplus">+    } else {</span>
<a href="#l37.427"></a><span id="l37.427">       gDialog.TextWrapList.value = &quot;wrap&quot;;</span>
<a href="#l37.428"></a><span id="l37.428" class="difflineminus">-    gDialog.TextWrapCheckbox.checked = gAdvancedEditUsed &amp;&amp; previousIndex != gDialog.TextWrapList.selectedIndex;</span>
<a href="#l37.429"></a><span id="l37.429" class="difflineplus">+    }</span>
<a href="#l37.430"></a><span id="l37.430" class="difflineplus">+    gDialog.TextWrapCheckbox.checked =</span>
<a href="#l37.431"></a><span id="l37.431" class="difflineplus">+      gAdvancedEditUsed &amp;&amp; previousIndex != gDialog.TextWrapList.selectedIndex;</span>
<a href="#l37.432"></a><span id="l37.432"> </span>
<a href="#l37.433"></a><span id="l37.433">     previousValue = gCellColor;</span>
<a href="#l37.434"></a><span id="l37.434" class="difflineminus">-    gCellColor = GetHTMLOrCSSStyleValue(globalCellElement, bgcolor, cssBackgroundColorStr);</span>
<a href="#l37.435"></a><span id="l37.435" class="difflineplus">+    gCellColor = GetHTMLOrCSSStyleValue(</span>
<a href="#l37.436"></a><span id="l37.436" class="difflineplus">+      globalCellElement,</span>
<a href="#l37.437"></a><span id="l37.437" class="difflineplus">+      bgcolor,</span>
<a href="#l37.438"></a><span id="l37.438" class="difflineplus">+      cssBackgroundColorStr</span>
<a href="#l37.439"></a><span id="l37.439" class="difflineplus">+    );</span>
<a href="#l37.440"></a><span id="l37.440">     gCellColor = ConvertRGBColorIntoHEXColor(gCellColor);</span>
<a href="#l37.441"></a><span id="l37.441">     SetColor(&quot;cellBackgroundCW&quot;, gCellColor);</span>
<a href="#l37.442"></a><span id="l37.442" class="difflineminus">-    gDialog.CellColorCheckbox.checked = gAdvancedEditUsed &amp;&amp; previousValue != gCellColor;</span>
<a href="#l37.443"></a><span id="l37.443" class="difflineplus">+    gDialog.CellColorCheckbox.checked =</span>
<a href="#l37.444"></a><span id="l37.444" class="difflineplus">+      gAdvancedEditUsed &amp;&amp; previousValue != gCellColor;</span>
<a href="#l37.445"></a><span id="l37.445"> </span>
<a href="#l37.446"></a><span id="l37.446">     // We want to set this true in case changes came</span>
<a href="#l37.447"></a><span id="l37.447">     //   from Advanced Edit dialog session (must assume something changed)</span>
<a href="#l37.448"></a><span id="l37.448">     gCellDataChanged = true;</span>
<a href="#l37.449"></a><span id="l37.449">   }</span>
<a href="#l37.450"></a><span id="l37.450"> }</span>
<a href="#l37.451"></a><span id="l37.451"> </span>
<a href="#l37.452"></a><span id="l37.452"> function GetCellData(rowIndex, colIndex) {</span>
<a href="#l37.453"></a><span id="l37.453" class="difflineat">@@ -368,23 +459,33 @@ function GetCellData(rowIndex, colIndex)</span>
<a href="#l37.454"></a><span id="l37.454">   var startColIndexObj = { value: 0 };</span>
<a href="#l37.455"></a><span id="l37.455">   var rowSpanObj = { value: 0 };</span>
<a href="#l37.456"></a><span id="l37.456">   var colSpanObj = { value: 0 };</span>
<a href="#l37.457"></a><span id="l37.457">   var actualRowSpanObj = { value: 0 };</span>
<a href="#l37.458"></a><span id="l37.458">   var actualColSpanObj = { value: 0 };</span>
<a href="#l37.459"></a><span id="l37.459">   var isSelectedObj = { value: false };</span>
<a href="#l37.460"></a><span id="l37.460"> </span>
<a href="#l37.461"></a><span id="l37.461">   try {</span>
<a href="#l37.462"></a><span id="l37.462" class="difflineminus">-    gActiveEditor.getCellDataAt(gTableElement, rowIndex, colIndex,</span>
<a href="#l37.463"></a><span id="l37.463" class="difflineminus">-                         gCellData,</span>
<a href="#l37.464"></a><span id="l37.464" class="difflineminus">-                         startRowIndexObj, startColIndexObj,</span>
<a href="#l37.465"></a><span id="l37.465" class="difflineminus">-                         rowSpanObj, colSpanObj,</span>
<a href="#l37.466"></a><span id="l37.466" class="difflineminus">-                         actualRowSpanObj, actualColSpanObj, isSelectedObj);</span>
<a href="#l37.467"></a><span id="l37.467" class="difflineplus">+    gActiveEditor.getCellDataAt(</span>
<a href="#l37.468"></a><span id="l37.468" class="difflineplus">+      gTableElement,</span>
<a href="#l37.469"></a><span id="l37.469" class="difflineplus">+      rowIndex,</span>
<a href="#l37.470"></a><span id="l37.470" class="difflineplus">+      colIndex,</span>
<a href="#l37.471"></a><span id="l37.471" class="difflineplus">+      gCellData,</span>
<a href="#l37.472"></a><span id="l37.472" class="difflineplus">+      startRowIndexObj,</span>
<a href="#l37.473"></a><span id="l37.473" class="difflineplus">+      startColIndexObj,</span>
<a href="#l37.474"></a><span id="l37.474" class="difflineplus">+      rowSpanObj,</span>
<a href="#l37.475"></a><span id="l37.475" class="difflineplus">+      colSpanObj,</span>
<a href="#l37.476"></a><span id="l37.476" class="difflineplus">+      actualRowSpanObj,</span>
<a href="#l37.477"></a><span id="l37.477" class="difflineplus">+      actualColSpanObj,</span>
<a href="#l37.478"></a><span id="l37.478" class="difflineplus">+      isSelectedObj</span>
<a href="#l37.479"></a><span id="l37.479" class="difflineplus">+    );</span>
<a href="#l37.480"></a><span id="l37.480">     // We didn't find a cell</span>
<a href="#l37.481"></a><span id="l37.481" class="difflineminus">-    if (!gCellData.value) return false;</span>
<a href="#l37.482"></a><span id="l37.482" class="difflineplus">+    if (!gCellData.value) {</span>
<a href="#l37.483"></a><span id="l37.483" class="difflineplus">+      return false;</span>
<a href="#l37.484"></a><span id="l37.484" class="difflineplus">+    }</span>
<a href="#l37.485"></a><span id="l37.485">   } catch (ex) {</span>
<a href="#l37.486"></a><span id="l37.486">     return false;</span>
<a href="#l37.487"></a><span id="l37.487">   }</span>
<a href="#l37.488"></a><span id="l37.488"> </span>
<a href="#l37.489"></a><span id="l37.489">   gCellData.startRowIndex = startRowIndexObj.value;</span>
<a href="#l37.490"></a><span id="l37.490">   gCellData.startColIndex = startColIndexObj.value;</span>
<a href="#l37.491"></a><span id="l37.491">   gCellData.rowSpan = rowSpanObj.value;</span>
<a href="#l37.492"></a><span id="l37.492">   gCellData.colSpan = colSpanObj.value;</span>
<a href="#l37.493"></a><span id="l37.493" class="difflineat">@@ -398,35 +499,51 @@ function SelectCellHAlign() {</span>
<a href="#l37.494"></a><span id="l37.494">   SetCheckbox(&quot;CellHAlignCheckbox&quot;);</span>
<a href="#l37.495"></a><span id="l37.495">   // Once user changes the alignment,</span>
<a href="#l37.496"></a><span id="l37.496">   //  we lose their original &quot;CharAt&quot; alignment&quot;</span>
<a href="#l37.497"></a><span id="l37.497">   gAlignWasChar = false;</span>
<a href="#l37.498"></a><span id="l37.498"> }</span>
<a href="#l37.499"></a><span id="l37.499"> </span>
<a href="#l37.500"></a><span id="l37.500"> function GetColorAndUpdate(ColorWellID) {</span>
<a href="#l37.501"></a><span id="l37.501">   var colorWell = document.getElementById(ColorWellID);</span>
<a href="#l37.502"></a><span id="l37.502" class="difflineminus">-  if (!colorWell) return;</span>
<a href="#l37.503"></a><span id="l37.503" class="difflineplus">+  if (!colorWell) {</span>
<a href="#l37.504"></a><span id="l37.504" class="difflineplus">+    return;</span>
<a href="#l37.505"></a><span id="l37.505" class="difflineplus">+  }</span>
<a href="#l37.506"></a><span id="l37.506"> </span>
<a href="#l37.507"></a><span id="l37.507" class="difflineminus">-  var colorObj = { Type: &quot;&quot;, TableColor: 0, CellColor: 0, NoDefault: false, Cancel: false, BackgroundColor: 0 };</span>
<a href="#l37.508"></a><span id="l37.508" class="difflineplus">+  var colorObj = {</span>
<a href="#l37.509"></a><span id="l37.509" class="difflineplus">+    Type: &quot;&quot;,</span>
<a href="#l37.510"></a><span id="l37.510" class="difflineplus">+    TableColor: 0,</span>
<a href="#l37.511"></a><span id="l37.511" class="difflineplus">+    CellColor: 0,</span>
<a href="#l37.512"></a><span id="l37.512" class="difflineplus">+    NoDefault: false,</span>
<a href="#l37.513"></a><span id="l37.513" class="difflineplus">+    Cancel: false,</span>
<a href="#l37.514"></a><span id="l37.514" class="difflineplus">+    BackgroundColor: 0,</span>
<a href="#l37.515"></a><span id="l37.515" class="difflineplus">+  };</span>
<a href="#l37.516"></a><span id="l37.516"> </span>
<a href="#l37.517"></a><span id="l37.517">   switch (ColorWellID) {</span>
<a href="#l37.518"></a><span id="l37.518">     case &quot;tableBackgroundCW&quot;:</span>
<a href="#l37.519"></a><span id="l37.519">       colorObj.Type = &quot;Table&quot;;</span>
<a href="#l37.520"></a><span id="l37.520">       colorObj.TableColor = gTableColor;</span>
<a href="#l37.521"></a><span id="l37.521">       break;</span>
<a href="#l37.522"></a><span id="l37.522">     case &quot;cellBackgroundCW&quot;:</span>
<a href="#l37.523"></a><span id="l37.523">       colorObj.Type = &quot;Cell&quot;;</span>
<a href="#l37.524"></a><span id="l37.524">       colorObj.CellColor = gCellColor;</span>
<a href="#l37.525"></a><span id="l37.525">       break;</span>
<a href="#l37.526"></a><span id="l37.526">   }</span>
<a href="#l37.527"></a><span id="l37.527" class="difflineminus">-  window.openDialog(&quot;chrome://editor/content/EdColorPicker.xul&quot;, &quot;_blank&quot;, &quot;chrome,close,titlebar,modal&quot;, &quot;&quot;, colorObj);</span>
<a href="#l37.528"></a><span id="l37.528" class="difflineplus">+  window.openDialog(</span>
<a href="#l37.529"></a><span id="l37.529" class="difflineplus">+    &quot;chrome://editor/content/EdColorPicker.xul&quot;,</span>
<a href="#l37.530"></a><span id="l37.530" class="difflineplus">+    &quot;_blank&quot;,</span>
<a href="#l37.531"></a><span id="l37.531" class="difflineplus">+    &quot;chrome,close,titlebar,modal&quot;,</span>
<a href="#l37.532"></a><span id="l37.532" class="difflineplus">+    &quot;&quot;,</span>
<a href="#l37.533"></a><span id="l37.533" class="difflineplus">+    colorObj</span>
<a href="#l37.534"></a><span id="l37.534" class="difflineplus">+  );</span>
<a href="#l37.535"></a><span id="l37.535"> </span>
<a href="#l37.536"></a><span id="l37.536">   // User canceled the dialog</span>
<a href="#l37.537"></a><span id="l37.537" class="difflineminus">-  if (colorObj.Cancel)</span>
<a href="#l37.538"></a><span id="l37.538" class="difflineplus">+  if (colorObj.Cancel) {</span>
<a href="#l37.539"></a><span id="l37.539">     return;</span>
<a href="#l37.540"></a><span id="l37.540" class="difflineplus">+  }</span>
<a href="#l37.541"></a><span id="l37.541"> </span>
<a href="#l37.542"></a><span id="l37.542">   switch (ColorWellID) {</span>
<a href="#l37.543"></a><span id="l37.543">     case &quot;tableBackgroundCW&quot;:</span>
<a href="#l37.544"></a><span id="l37.544">       gTableColor = colorObj.BackgroundColor;</span>
<a href="#l37.545"></a><span id="l37.545">       SetColor(ColorWellID, gTableColor);</span>
<a href="#l37.546"></a><span id="l37.546">       break;</span>
<a href="#l37.547"></a><span id="l37.547">     case &quot;cellBackgroundCW&quot;:</span>
<a href="#l37.548"></a><span id="l37.548">       gCellColor = colorObj.BackgroundColor;</span>
<a href="#l37.549"></a><span id="l37.549" class="difflineat">@@ -436,37 +553,53 @@ function GetColorAndUpdate(ColorWellID) </span>
<a href="#l37.550"></a><span id="l37.550">   }</span>
<a href="#l37.551"></a><span id="l37.551"> }</span>
<a href="#l37.552"></a><span id="l37.552"> </span>
<a href="#l37.553"></a><span id="l37.553"> function SetColor(ColorWellID, color) {</span>
<a href="#l37.554"></a><span id="l37.554">   // Save the color</span>
<a href="#l37.555"></a><span id="l37.555">   if (ColorWellID == &quot;cellBackgroundCW&quot;) {</span>
<a href="#l37.556"></a><span id="l37.556">     if (color) {</span>
<a href="#l37.557"></a><span id="l37.557">       try {</span>
<a href="#l37.558"></a><span id="l37.558" class="difflineminus">-        gActiveEditor.setAttributeOrEquivalent(globalCellElement, bgcolor,</span>
<a href="#l37.559"></a><span id="l37.559" class="difflineminus">-                                               color, true);</span>
<a href="#l37.560"></a><span id="l37.560" class="difflineplus">+        gActiveEditor.setAttributeOrEquivalent(</span>
<a href="#l37.561"></a><span id="l37.561" class="difflineplus">+          globalCellElement,</span>
<a href="#l37.562"></a><span id="l37.562" class="difflineplus">+          bgcolor,</span>
<a href="#l37.563"></a><span id="l37.563" class="difflineplus">+          color,</span>
<a href="#l37.564"></a><span id="l37.564" class="difflineplus">+          true</span>
<a href="#l37.565"></a><span id="l37.565" class="difflineplus">+        );</span>
<a href="#l37.566"></a><span id="l37.566">       } catch (e) {}</span>
<a href="#l37.567"></a><span id="l37.567">       gDialog.CellInheritColor.collapsed = true;</span>
<a href="#l37.568"></a><span id="l37.568">     } else {</span>
<a href="#l37.569"></a><span id="l37.569">       try {</span>
<a href="#l37.570"></a><span id="l37.570" class="difflineminus">-        gActiveEditor.removeAttributeOrEquivalent(globalCellElement, bgcolor, true);</span>
<a href="#l37.571"></a><span id="l37.571" class="difflineplus">+        gActiveEditor.removeAttributeOrEquivalent(</span>
<a href="#l37.572"></a><span id="l37.572" class="difflineplus">+          globalCellElement,</span>
<a href="#l37.573"></a><span id="l37.573" class="difflineplus">+          bgcolor,</span>
<a href="#l37.574"></a><span id="l37.574" class="difflineplus">+          true</span>
<a href="#l37.575"></a><span id="l37.575" class="difflineplus">+        );</span>
<a href="#l37.576"></a><span id="l37.576">       } catch (e) {}</span>
<a href="#l37.577"></a><span id="l37.577">       // Reveal addition message explaining &quot;default&quot; color</span>
<a href="#l37.578"></a><span id="l37.578">       gDialog.CellInheritColor.collapsed = false;</span>
<a href="#l37.579"></a><span id="l37.579">     }</span>
<a href="#l37.580"></a><span id="l37.580">   } else {</span>
<a href="#l37.581"></a><span id="l37.581">     if (color) {</span>
<a href="#l37.582"></a><span id="l37.582">       try {</span>
<a href="#l37.583"></a><span id="l37.583" class="difflineminus">-        gActiveEditor.setAttributeOrEquivalent(globalTableElement, bgcolor,</span>
<a href="#l37.584"></a><span id="l37.584" class="difflineminus">-                                               color, true);</span>
<a href="#l37.585"></a><span id="l37.585" class="difflineplus">+        gActiveEditor.setAttributeOrEquivalent(</span>
<a href="#l37.586"></a><span id="l37.586" class="difflineplus">+          globalTableElement,</span>
<a href="#l37.587"></a><span id="l37.587" class="difflineplus">+          bgcolor,</span>
<a href="#l37.588"></a><span id="l37.588" class="difflineplus">+          color,</span>
<a href="#l37.589"></a><span id="l37.589" class="difflineplus">+          true</span>
<a href="#l37.590"></a><span id="l37.590" class="difflineplus">+        );</span>
<a href="#l37.591"></a><span id="l37.591">       } catch (e) {}</span>
<a href="#l37.592"></a><span id="l37.592">       gDialog.TableInheritColor.collapsed = true;</span>
<a href="#l37.593"></a><span id="l37.593">     } else {</span>
<a href="#l37.594"></a><span id="l37.594">       try {</span>
<a href="#l37.595"></a><span id="l37.595" class="difflineminus">-        gActiveEditor.removeAttributeOrEquivalent(globalTableElement, bgcolor, true);</span>
<a href="#l37.596"></a><span id="l37.596" class="difflineplus">+        gActiveEditor.removeAttributeOrEquivalent(</span>
<a href="#l37.597"></a><span id="l37.597" class="difflineplus">+          globalTableElement,</span>
<a href="#l37.598"></a><span id="l37.598" class="difflineplus">+          bgcolor,</span>
<a href="#l37.599"></a><span id="l37.599" class="difflineplus">+          true</span>
<a href="#l37.600"></a><span id="l37.600" class="difflineplus">+        );</span>
<a href="#l37.601"></a><span id="l37.601">       } catch (e) {}</span>
<a href="#l37.602"></a><span id="l37.602">       gDialog.TableInheritColor.collapsed = false;</span>
<a href="#l37.603"></a><span id="l37.603">     }</span>
<a href="#l37.604"></a><span id="l37.604">     SetCheckbox(&quot;CellColorCheckbox&quot;);</span>
<a href="#l37.605"></a><span id="l37.605">   }</span>
<a href="#l37.606"></a><span id="l37.606"> </span>
<a href="#l37.607"></a><span id="l37.607">   setColorWell(ColorWellID, color);</span>
<a href="#l37.608"></a><span id="l37.608"> }</span>
<a href="#l37.609"></a><span id="l37.609" class="difflineat">@@ -482,128 +615,142 @@ function ChangeSelectionToFirstCell() {</span>
<a href="#l37.610"></a><span id="l37.610">   gCurRowIndex = 0;</span>
<a href="#l37.611"></a><span id="l37.611">   gCurColIndex = 0;</span>
<a href="#l37.612"></a><span id="l37.612">   ChangeSelection(RESET_SELECTION);</span>
<a href="#l37.613"></a><span id="l37.613"> }</span>
<a href="#l37.614"></a><span id="l37.614"> </span>
<a href="#l37.615"></a><span id="l37.615"> function ChangeSelection(newType) {</span>
<a href="#l37.616"></a><span id="l37.616">   newType = Number(newType);</span>
<a href="#l37.617"></a><span id="l37.617"> </span>
<a href="#l37.618"></a><span id="l37.618" class="difflineminus">-  if (gSelectedCellsType == newType)</span>
<a href="#l37.619"></a><span id="l37.619" class="difflineplus">+  if (gSelectedCellsType == newType) {</span>
<a href="#l37.620"></a><span id="l37.620">     return;</span>
<a href="#l37.621"></a><span id="l37.621" class="difflineplus">+  }</span>
<a href="#l37.622"></a><span id="l37.622"> </span>
<a href="#l37.623"></a><span id="l37.623" class="difflineminus">-  if (newType == RESET_SELECTION)</span>
<a href="#l37.624"></a><span id="l37.624" class="difflineplus">+  if (newType == RESET_SELECTION) {</span>
<a href="#l37.625"></a><span id="l37.625">     // Restore selection to existing focus cell</span>
<a href="#l37.626"></a><span id="l37.626">     gSelection.collapse(gCellElement, 0);</span>
<a href="#l37.627"></a><span id="l37.627" class="difflineminus">-  else</span>
<a href="#l37.628"></a><span id="l37.628" class="difflineplus">+  } else {</span>
<a href="#l37.629"></a><span id="l37.629">     gSelectedCellsType = newType;</span>
<a href="#l37.630"></a><span id="l37.630" class="difflineplus">+  }</span>
<a href="#l37.631"></a><span id="l37.631"> </span>
<a href="#l37.632"></a><span id="l37.632">   // Keep the same focus gCellElement, just change the type</span>
<a href="#l37.633"></a><span id="l37.633">   DoCellSelection();</span>
<a href="#l37.634"></a><span id="l37.634">   SetSelectionButtons();</span>
<a href="#l37.635"></a><span id="l37.635"> </span>
<a href="#l37.636"></a><span id="l37.636">   // Note: globalCellElement should still be a clone of gCellElement</span>
<a href="#l37.637"></a><span id="l37.637"> }</span>
<a href="#l37.638"></a><span id="l37.638"> </span>
<a href="#l37.639"></a><span id="l37.639"> function MoveSelection(forward) {</span>
<a href="#l37.640"></a><span id="l37.640">   var newRowIndex = gCurRowIndex;</span>
<a href="#l37.641"></a><span id="l37.641">   var newColIndex = gCurColIndex;</span>
<a href="#l37.642"></a><span id="l37.642">   var inRow = false;</span>
<a href="#l37.643"></a><span id="l37.643"> </span>
<a href="#l37.644"></a><span id="l37.644">   if (gSelectedCellsType == SELECT_ROW) {</span>
<a href="#l37.645"></a><span id="l37.645" class="difflineminus">-    newRowIndex += (forward ? 1 : -1);</span>
<a href="#l37.646"></a><span id="l37.646" class="difflineplus">+    newRowIndex += forward ? 1 : -1;</span>
<a href="#l37.647"></a><span id="l37.647"> </span>
<a href="#l37.648"></a><span id="l37.648">     // Wrap around if before first or after last row</span>
<a href="#l37.649"></a><span id="l37.649" class="difflineminus">-    if (newRowIndex &lt; 0)</span>
<a href="#l37.650"></a><span id="l37.650" class="difflineplus">+    if (newRowIndex &lt; 0) {</span>
<a href="#l37.651"></a><span id="l37.651">       newRowIndex = gLastRowIndex;</span>
<a href="#l37.652"></a><span id="l37.652" class="difflineminus">-    else if (newRowIndex &gt; gLastRowIndex)</span>
<a href="#l37.653"></a><span id="l37.653" class="difflineplus">+    } else if (newRowIndex &gt; gLastRowIndex) {</span>
<a href="#l37.654"></a><span id="l37.654">       newRowIndex = 0;</span>
<a href="#l37.655"></a><span id="l37.655" class="difflineplus">+    }</span>
<a href="#l37.656"></a><span id="l37.656">     inRow = true;</span>
<a href="#l37.657"></a><span id="l37.657"> </span>
<a href="#l37.658"></a><span id="l37.658">     // Use first cell in row for focus cell</span>
<a href="#l37.659"></a><span id="l37.659">     newColIndex = 0;</span>
<a href="#l37.660"></a><span id="l37.660">   } else {</span>
<a href="#l37.661"></a><span id="l37.661">     // Cell or column:</span>
<a href="#l37.662"></a><span id="l37.662" class="difflineminus">-    if (!forward)</span>
<a href="#l37.663"></a><span id="l37.663" class="difflineplus">+    if (!forward) {</span>
<a href="#l37.664"></a><span id="l37.664">       newColIndex--;</span>
<a href="#l37.665"></a><span id="l37.665" class="difflineplus">+    }</span>
<a href="#l37.666"></a><span id="l37.666"> </span>
<a href="#l37.667"></a><span id="l37.667">     if (gSelectedCellsType == SELECT_CELL) {</span>
<a href="#l37.668"></a><span id="l37.668">       // Skip to next cell</span>
<a href="#l37.669"></a><span id="l37.669" class="difflineminus">-      if (forward)</span>
<a href="#l37.670"></a><span id="l37.670" class="difflineplus">+      if (forward) {</span>
<a href="#l37.671"></a><span id="l37.671">         newColIndex += gCurColSpan;</span>
<a href="#l37.672"></a><span id="l37.672" class="difflineminus">-    } else { // SELECT_COLUMN</span>
<a href="#l37.673"></a><span id="l37.673" class="difflineplus">+      }</span>
<a href="#l37.674"></a><span id="l37.674" class="difflineplus">+    } else {</span>
<a href="#l37.675"></a><span id="l37.675" class="difflineplus">+      // SELECT_COLUMN</span>
<a href="#l37.676"></a><span id="l37.676">       // Use first cell in column for focus cell</span>
<a href="#l37.677"></a><span id="l37.677">       newRowIndex = 0;</span>
<a href="#l37.678"></a><span id="l37.678"> </span>
<a href="#l37.679"></a><span id="l37.679">       // Don't skip by colspan,</span>
<a href="#l37.680"></a><span id="l37.680">       //  but find first cell in next cellmap column</span>
<a href="#l37.681"></a><span id="l37.681" class="difflineminus">-      if (forward)</span>
<a href="#l37.682"></a><span id="l37.682" class="difflineplus">+      if (forward) {</span>
<a href="#l37.683"></a><span id="l37.683">         newColIndex++;</span>
<a href="#l37.684"></a><span id="l37.684" class="difflineplus">+      }</span>
<a href="#l37.685"></a><span id="l37.685">     }</span>
<a href="#l37.686"></a><span id="l37.686"> </span>
<a href="#l37.687"></a><span id="l37.687">     if (newColIndex &lt; 0) {</span>
<a href="#l37.688"></a><span id="l37.688">       // Request is before the first cell in column</span>
<a href="#l37.689"></a><span id="l37.689"> </span>
<a href="#l37.690"></a><span id="l37.690">       // Wrap to last cell in column</span>
<a href="#l37.691"></a><span id="l37.691">       newColIndex = gLastColIndex;</span>
<a href="#l37.692"></a><span id="l37.692"> </span>
<a href="#l37.693"></a><span id="l37.693">       if (gSelectedCellsType == SELECT_CELL) {</span>
<a href="#l37.694"></a><span id="l37.694">         // If moving by cell, also wrap to previous...</span>
<a href="#l37.695"></a><span id="l37.695" class="difflineminus">-        if (newRowIndex &gt; 0)</span>
<a href="#l37.696"></a><span id="l37.696" class="difflineplus">+        if (newRowIndex &gt; 0) {</span>
<a href="#l37.697"></a><span id="l37.697">           newRowIndex -= 1;</span>
<a href="#l37.698"></a><span id="l37.698" class="difflineminus">-        else</span>
<a href="#l37.699"></a><span id="l37.699" class="difflineminus">-          // ...or the last row</span>
<a href="#l37.700"></a><span id="l37.700" class="difflineplus">+        }</span>
<a href="#l37.701"></a><span id="l37.701" class="difflineplus">+        // ...or the last row</span>
<a href="#l37.702"></a><span id="l37.702" class="difflineplus">+        else {</span>
<a href="#l37.703"></a><span id="l37.703">           newRowIndex = gLastRowIndex;</span>
<a href="#l37.704"></a><span id="l37.704" class="difflineplus">+        }</span>
<a href="#l37.705"></a><span id="l37.705"> </span>
<a href="#l37.706"></a><span id="l37.706">         inRow = true;</span>
<a href="#l37.707"></a><span id="l37.707">       }</span>
<a href="#l37.708"></a><span id="l37.708">     } else if (newColIndex &gt; gLastColIndex) {</span>
<a href="#l37.709"></a><span id="l37.709">       // Request is after the last cell in column</span>
<a href="#l37.710"></a><span id="l37.710"> </span>
<a href="#l37.711"></a><span id="l37.711">       // Wrap to first cell in column</span>
<a href="#l37.712"></a><span id="l37.712">       newColIndex = 0;</span>
<a href="#l37.713"></a><span id="l37.713"> </span>
<a href="#l37.714"></a><span id="l37.714">       if (gSelectedCellsType == SELECT_CELL) {</span>
<a href="#l37.715"></a><span id="l37.715">         // If moving by cell, also wrap to next...</span>
<a href="#l37.716"></a><span id="l37.716" class="difflineminus">-        if (newRowIndex &lt; gLastRowIndex)</span>
<a href="#l37.717"></a><span id="l37.717" class="difflineplus">+        if (newRowIndex &lt; gLastRowIndex) {</span>
<a href="#l37.718"></a><span id="l37.718">           newRowIndex++;</span>
<a href="#l37.719"></a><span id="l37.719" class="difflineminus">-        else</span>
<a href="#l37.720"></a><span id="l37.720" class="difflineminus">-          // ...or the first row</span>
<a href="#l37.721"></a><span id="l37.721" class="difflineplus">+        }</span>
<a href="#l37.722"></a><span id="l37.722" class="difflineplus">+        // ...or the first row</span>
<a href="#l37.723"></a><span id="l37.723" class="difflineplus">+        else {</span>
<a href="#l37.724"></a><span id="l37.724">           newRowIndex = 0;</span>
<a href="#l37.725"></a><span id="l37.725" class="difflineplus">+        }</span>
<a href="#l37.726"></a><span id="l37.726"> </span>
<a href="#l37.727"></a><span id="l37.727">         inRow = true;</span>
<a href="#l37.728"></a><span id="l37.728">       }</span>
<a href="#l37.729"></a><span id="l37.729">     }</span>
<a href="#l37.730"></a><span id="l37.730">   }</span>
<a href="#l37.731"></a><span id="l37.731"> </span>
<a href="#l37.732"></a><span id="l37.732">   // Get the cell at the new location</span>
<a href="#l37.733"></a><span id="l37.733">   do {</span>
<a href="#l37.734"></a><span id="l37.734">     if (!GetCellData(newRowIndex, newColIndex)) {</span>
<a href="#l37.735"></a><span id="l37.735">       dump(&quot;MoveSelection: CELL NOT FOUND\n&quot;);</span>
<a href="#l37.736"></a><span id="l37.736">       return;</span>
<a href="#l37.737"></a><span id="l37.737">     }</span>
<a href="#l37.738"></a><span id="l37.738">     if (inRow) {</span>
<a href="#l37.739"></a><span id="l37.739" class="difflineminus">-      if (gCellData.startRowIndex == newRowIndex)</span>
<a href="#l37.740"></a><span id="l37.740" class="difflineplus">+      if (gCellData.startRowIndex == newRowIndex) {</span>
<a href="#l37.741"></a><span id="l37.741">         break;</span>
<a href="#l37.742"></a><span id="l37.742" class="difflineminus">-      else</span>
<a href="#l37.743"></a><span id="l37.743" class="difflineminus">-        // Cell spans from a row above, look for the next cell in row</span>
<a href="#l37.744"></a><span id="l37.744" class="difflineplus">+      }</span>
<a href="#l37.745"></a><span id="l37.745" class="difflineplus">+      // Cell spans from a row above, look for the next cell in row</span>
<a href="#l37.746"></a><span id="l37.746" class="difflineplus">+      else {</span>
<a href="#l37.747"></a><span id="l37.747">         newRowIndex += gCellData.actualRowSpan;</span>
<a href="#l37.748"></a><span id="l37.748" class="difflineplus">+      }</span>
<a href="#l37.749"></a><span id="l37.749">     } else if (gCellData.startColIndex == newColIndex) {</span>
<a href="#l37.750"></a><span id="l37.750">       break;</span>
<a href="#l37.751"></a><span id="l37.751">     } else {</span>
<a href="#l37.752"></a><span id="l37.752">       // Cell spans from a Col above, look for the next cell in column</span>
<a href="#l37.753"></a><span id="l37.753">       newColIndex += gCellData.actualColSpan;</span>
<a href="#l37.754"></a><span id="l37.754">     }</span>
<a href="#l37.755"></a><span id="l37.755" class="difflineminus">-  }</span>
<a href="#l37.756"></a><span id="l37.756" class="difflineminus">-  while (true);</span>
<a href="#l37.757"></a><span id="l37.757" class="difflineplus">+  } while (true);</span>
<a href="#l37.758"></a><span id="l37.758"> </span>
<a href="#l37.759"></a><span id="l37.759">   // Save data for current selection before changing</span>
<a href="#l37.760"></a><span id="l37.760" class="difflineminus">-  if (gCellDataChanged) { // &amp;&amp; gDialog.ApplyBeforeMove.checked)</span>
<a href="#l37.761"></a><span id="l37.761" class="difflineminus">-    if (!ValidateCellData())</span>
<a href="#l37.762"></a><span id="l37.762" class="difflineplus">+  if (gCellDataChanged) {</span>
<a href="#l37.763"></a><span id="l37.763" class="difflineplus">+    // &amp;&amp; gDialog.ApplyBeforeMove.checked)</span>
<a href="#l37.764"></a><span id="l37.764" class="difflineplus">+    if (!ValidateCellData()) {</span>
<a href="#l37.765"></a><span id="l37.765">       return;</span>
<a href="#l37.766"></a><span id="l37.766" class="difflineplus">+    }</span>
<a href="#l37.767"></a><span id="l37.767"> </span>
<a href="#l37.768"></a><span id="l37.768">     gActiveEditor.beginTransaction();</span>
<a href="#l37.769"></a><span id="l37.769">     // Apply changes to all selected cells</span>
<a href="#l37.770"></a><span id="l37.770">     ApplyCellAttributes();</span>
<a href="#l37.771"></a><span id="l37.771">     gActiveEditor.endTransaction();</span>
<a href="#l37.772"></a><span id="l37.772"> </span>
<a href="#l37.773"></a><span id="l37.773">     SetCloseButton();</span>
<a href="#l37.774"></a><span id="l37.774">   }</span>
<a href="#l37.775"></a><span id="l37.775" class="difflineat">@@ -622,28 +769,31 @@ function MoveSelection(forward) {</span>
<a href="#l37.776"></a><span id="l37.776">   // Change the selection</span>
<a href="#l37.777"></a><span id="l37.777">   DoCellSelection();</span>
<a href="#l37.778"></a><span id="l37.778"> </span>
<a href="#l37.779"></a><span id="l37.779">   // Scroll page so new selection is visible</span>
<a href="#l37.780"></a><span id="l37.780">   // Using SELECTION_ANCHOR_REGION makes the upper-left corner of first selected cell</span>
<a href="#l37.781"></a><span id="l37.781">   //    the point to bring into view.</span>
<a href="#l37.782"></a><span id="l37.782">   try {</span>
<a href="#l37.783"></a><span id="l37.783">     var selectionController = gActiveEditor.selectionController;</span>
<a href="#l37.784"></a><span id="l37.784" class="difflineminus">-    selectionController.scrollSelectionIntoView(selectionController.SELECTION_NORMAL, selectionController.SELECTION_ANCHOR_REGION, true);</span>
<a href="#l37.785"></a><span id="l37.785" class="difflineplus">+    selectionController.scrollSelectionIntoView(</span>
<a href="#l37.786"></a><span id="l37.786" class="difflineplus">+      selectionController.SELECTION_NORMAL,</span>
<a href="#l37.787"></a><span id="l37.787" class="difflineplus">+      selectionController.SELECTION_ANCHOR_REGION,</span>
<a href="#l37.788"></a><span id="l37.788" class="difflineplus">+      true</span>
<a href="#l37.789"></a><span id="l37.789" class="difflineplus">+    );</span>
<a href="#l37.790"></a><span id="l37.790">   } catch (e) {}</span>
<a href="#l37.791"></a><span id="l37.791"> </span>
<a href="#l37.792"></a><span id="l37.792">   // Reinitialize dialog using new cell</span>
<a href="#l37.793"></a><span id="l37.793" class="difflineminus">-//  if (!gDialog.KeepCurrentData.checked)</span>
<a href="#l37.794"></a><span id="l37.794" class="difflineplus">+  //  if (!gDialog.KeepCurrentData.checked)</span>
<a href="#l37.795"></a><span id="l37.795">   // Setting this false unchecks all &quot;set attributes&quot; checkboxes</span>
<a href="#l37.796"></a><span id="l37.796">   gAdvancedEditUsed = false;</span>
<a href="#l37.797"></a><span id="l37.797">   InitCellPanel();</span>
<a href="#l37.798"></a><span id="l37.798">   gAdvancedEditUsed = true;</span>
<a href="#l37.799"></a><span id="l37.799"> }</span>
<a href="#l37.800"></a><span id="l37.800"> </span>
<a href="#l37.801"></a><span id="l37.801" class="difflineminus">-</span>
<a href="#l37.802"></a><span id="l37.802"> function DoCellSelection() {</span>
<a href="#l37.803"></a><span id="l37.803">   // Collapse selection into to the focus cell</span>
<a href="#l37.804"></a><span id="l37.804">   //  so editor uses that as start cell</span>
<a href="#l37.805"></a><span id="l37.805">   gSelection.collapse(gCellElement, 0);</span>
<a href="#l37.806"></a><span id="l37.806"> </span>
<a href="#l37.807"></a><span id="l37.807">   var tagNameObj = { value: &quot;&quot; };</span>
<a href="#l37.808"></a><span id="l37.808">   var countObj = { value: 0 };</span>
<a href="#l37.809"></a><span id="l37.809">   try {</span>
<a href="#l37.810"></a><span id="l37.810" class="difflineat">@@ -657,53 +807,60 @@ function DoCellSelection() {</span>
<a href="#l37.811"></a><span id="l37.811">       default:</span>
<a href="#l37.812"></a><span id="l37.812">         gActiveEditor.selectTableColumn();</span>
<a href="#l37.813"></a><span id="l37.813">         break;</span>
<a href="#l37.814"></a><span id="l37.814">     }</span>
<a href="#l37.815"></a><span id="l37.815">     // Get number of cells selected</span>
<a href="#l37.816"></a><span id="l37.816">     gActiveEditor.getSelectedOrParentTableElement(tagNameObj, countObj);</span>
<a href="#l37.817"></a><span id="l37.817">   } catch (e) {}</span>
<a href="#l37.818"></a><span id="l37.818"> </span>
<a href="#l37.819"></a><span id="l37.819" class="difflineminus">-  if (tagNameObj.value == &quot;td&quot;)</span>
<a href="#l37.820"></a><span id="l37.820" class="difflineplus">+  if (tagNameObj.value == &quot;td&quot;) {</span>
<a href="#l37.821"></a><span id="l37.821">     gSelectedCellCount = countObj.value;</span>
<a href="#l37.822"></a><span id="l37.822" class="difflineminus">-  else</span>
<a href="#l37.823"></a><span id="l37.823" class="difflineplus">+  } else {</span>
<a href="#l37.824"></a><span id="l37.824">     gSelectedCellCount = 0;</span>
<a href="#l37.825"></a><span id="l37.825" class="difflineplus">+  }</span>
<a href="#l37.826"></a><span id="l37.826"> </span>
<a href="#l37.827"></a><span id="l37.827">   // Currently, we can only allow advanced editing on ONE cell element at a time</span>
<a href="#l37.828"></a><span id="l37.828">   //   else we ignore CSS, JS, and HTML attributes not already in dialog</span>
<a href="#l37.829"></a><span id="l37.829">   SetElementEnabled(gDialog.AdvancedEditCell, gSelectedCellCount == 1);</span>
<a href="#l37.830"></a><span id="l37.830"> </span>
<a href="#l37.831"></a><span id="l37.831" class="difflineminus">-  gDialog.AdvancedEditCell.setAttribute(&quot;tooltiptext&quot;,</span>
<a href="#l37.832"></a><span id="l37.832" class="difflineminus">-    gSelectedCellCount &gt; 1 ? GetString(&quot;AdvancedEditForCellMsg&quot;) :</span>
<a href="#l37.833"></a><span id="l37.833" class="difflineminus">-                             gDialog.AdvancedEditCellToolTipText);</span>
<a href="#l37.834"></a><span id="l37.834" class="difflineplus">+  gDialog.AdvancedEditCell.setAttribute(</span>
<a href="#l37.835"></a><span id="l37.835" class="difflineplus">+    &quot;tooltiptext&quot;,</span>
<a href="#l37.836"></a><span id="l37.836" class="difflineplus">+    gSelectedCellCount &gt; 1</span>
<a href="#l37.837"></a><span id="l37.837" class="difflineplus">+      ? GetString(&quot;AdvancedEditForCellMsg&quot;)</span>
<a href="#l37.838"></a><span id="l37.838" class="difflineplus">+      : gDialog.AdvancedEditCellToolTipText</span>
<a href="#l37.839"></a><span id="l37.839" class="difflineplus">+  );</span>
<a href="#l37.840"></a><span id="l37.840"> }</span>
<a href="#l37.841"></a><span id="l37.841"> </span>
<a href="#l37.842"></a><span id="l37.842"> function SetSelectionButtons() {</span>
<a href="#l37.843"></a><span id="l37.843">   if (gSelectedCellsType == SELECT_ROW) {</span>
<a href="#l37.844"></a><span id="l37.844">     // Trigger CSS to set images of up and down arrows</span>
<a href="#l37.845"></a><span id="l37.845">     gDialog.PreviousButton.setAttribute(&quot;type&quot;, &quot;row&quot;);</span>
<a href="#l37.846"></a><span id="l37.846">     gDialog.NextButton.setAttribute(&quot;type&quot;, &quot;row&quot;);</span>
<a href="#l37.847"></a><span id="l37.847">   } else {</span>
<a href="#l37.848"></a><span id="l37.848">     // or images of left and right arrows</span>
<a href="#l37.849"></a><span id="l37.849">     gDialog.PreviousButton.setAttribute(&quot;type&quot;, &quot;col&quot;);</span>
<a href="#l37.850"></a><span id="l37.850">     gDialog.NextButton.setAttribute(&quot;type&quot;, &quot;col&quot;);</span>
<a href="#l37.851"></a><span id="l37.851">   }</span>
<a href="#l37.852"></a><span id="l37.852" class="difflineminus">-  DisableSelectionButtons((gSelectedCellsType == SELECT_ROW &amp;&amp; gRowCount == 1) ||</span>
<a href="#l37.853"></a><span id="l37.853" class="difflineminus">-                          (gSelectedCellsType == SELECT_COLUMN &amp;&amp; gColCount == 1) ||</span>
<a href="#l37.854"></a><span id="l37.854" class="difflineminus">-                          (gRowCount == 1 &amp;&amp; gColCount == 1));</span>
<a href="#l37.855"></a><span id="l37.855" class="difflineplus">+  DisableSelectionButtons(</span>
<a href="#l37.856"></a><span id="l37.856" class="difflineplus">+    (gSelectedCellsType == SELECT_ROW &amp;&amp; gRowCount == 1) ||</span>
<a href="#l37.857"></a><span id="l37.857" class="difflineplus">+      (gSelectedCellsType == SELECT_COLUMN &amp;&amp; gColCount == 1) ||</span>
<a href="#l37.858"></a><span id="l37.858" class="difflineplus">+      (gRowCount == 1 &amp;&amp; gColCount == 1)</span>
<a href="#l37.859"></a><span id="l37.859" class="difflineplus">+  );</span>
<a href="#l37.860"></a><span id="l37.860"> }</span>
<a href="#l37.861"></a><span id="l37.861"> </span>
<a href="#l37.862"></a><span id="l37.862"> function DisableSelectionButtons(disable) {</span>
<a href="#l37.863"></a><span id="l37.863">   gDialog.PreviousButton.setAttribute(&quot;disabled&quot;, disable ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l37.864"></a><span id="l37.864">   gDialog.NextButton.setAttribute(&quot;disabled&quot;, disable ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l37.865"></a><span id="l37.865"> }</span>
<a href="#l37.866"></a><span id="l37.866"> </span>
<a href="#l37.867"></a><span id="l37.867"> function SwitchToValidatePanel() {</span>
<a href="#l37.868"></a><span id="l37.868" class="difflineminus">-  if (gDialog.TabBox.selectedTab != gValidateTab)</span>
<a href="#l37.869"></a><span id="l37.869" class="difflineplus">+  if (gDialog.TabBox.selectedTab != gValidateTab) {</span>
<a href="#l37.870"></a><span id="l37.870">     gDialog.TabBox.selectedTab = gValidateTab;</span>
<a href="#l37.871"></a><span id="l37.871" class="difflineplus">+  }</span>
<a href="#l37.872"></a><span id="l37.872"> }</span>
<a href="#l37.873"></a><span id="l37.873"> </span>
<a href="#l37.874"></a><span id="l37.874"> function SetAlign(listID, defaultValue, element, attName) {</span>
<a href="#l37.875"></a><span id="l37.875">   var value = document.getElementById(listID).value;</span>
<a href="#l37.876"></a><span id="l37.876">   if (value == defaultValue) {</span>
<a href="#l37.877"></a><span id="l37.877">     try {</span>
<a href="#l37.878"></a><span id="l37.878">       gActiveEditor.removeAttributeOrEquivalent(element, attName, true);</span>
<a href="#l37.879"></a><span id="l37.879">     } catch (e) {}</span>
<a href="#l37.880"></a><span id="l37.880" class="difflineat">@@ -711,76 +868,157 @@ function SetAlign(listID, defaultValue, </span>
<a href="#l37.881"></a><span id="l37.881">     try {</span>
<a href="#l37.882"></a><span id="l37.882">       gActiveEditor.setAttributeOrEquivalent(element, attName, value, true);</span>
<a href="#l37.883"></a><span id="l37.883">     } catch (e) {}</span>
<a href="#l37.884"></a><span id="l37.884">   }</span>
<a href="#l37.885"></a><span id="l37.885"> }</span>
<a href="#l37.886"></a><span id="l37.886"> </span>
<a href="#l37.887"></a><span id="l37.887"> function ValidateTableData() {</span>
<a href="#l37.888"></a><span id="l37.888">   gValidateTab = gDialog.TableTab;</span>
<a href="#l37.889"></a><span id="l37.889" class="difflineminus">-  gNewRowCount = Number(ValidateNumber(gDialog.TableRowsInput, null, 1, gMaxRows, null, true, true));</span>
<a href="#l37.890"></a><span id="l37.890" class="difflineminus">-  if (gValidationError) return false;</span>
<a href="#l37.891"></a><span id="l37.891" class="difflineplus">+  gNewRowCount = Number(</span>
<a href="#l37.892"></a><span id="l37.892" class="difflineplus">+    ValidateNumber(gDialog.TableRowsInput, null, 1, gMaxRows, null, true, true)</span>
<a href="#l37.893"></a><span id="l37.893" class="difflineplus">+  );</span>
<a href="#l37.894"></a><span id="l37.894" class="difflineplus">+  if (gValidationError) {</span>
<a href="#l37.895"></a><span id="l37.895" class="difflineplus">+    return false;</span>
<a href="#l37.896"></a><span id="l37.896" class="difflineplus">+  }</span>
<a href="#l37.897"></a><span id="l37.897"> </span>
<a href="#l37.898"></a><span id="l37.898" class="difflineminus">-  gNewColCount = Number(ValidateNumber(gDialog.TableColumnsInput, null, 1, gMaxColumns, null, true, true));</span>
<a href="#l37.899"></a><span id="l37.899" class="difflineminus">-  if (gValidationError) return false;</span>
<a href="#l37.900"></a><span id="l37.900" class="difflineplus">+  gNewColCount = Number(</span>
<a href="#l37.901"></a><span id="l37.901" class="difflineplus">+    ValidateNumber(</span>
<a href="#l37.902"></a><span id="l37.902" class="difflineplus">+      gDialog.TableColumnsInput,</span>
<a href="#l37.903"></a><span id="l37.903" class="difflineplus">+      null,</span>
<a href="#l37.904"></a><span id="l37.904" class="difflineplus">+      1,</span>
<a href="#l37.905"></a><span id="l37.905" class="difflineplus">+      gMaxColumns,</span>
<a href="#l37.906"></a><span id="l37.906" class="difflineplus">+      null,</span>
<a href="#l37.907"></a><span id="l37.907" class="difflineplus">+      true,</span>
<a href="#l37.908"></a><span id="l37.908" class="difflineplus">+      true</span>
<a href="#l37.909"></a><span id="l37.909" class="difflineplus">+    )</span>
<a href="#l37.910"></a><span id="l37.910" class="difflineplus">+  );</span>
<a href="#l37.911"></a><span id="l37.911" class="difflineplus">+  if (gValidationError) {</span>
<a href="#l37.912"></a><span id="l37.912" class="difflineplus">+    return false;</span>
<a href="#l37.913"></a><span id="l37.913" class="difflineplus">+  }</span>
<a href="#l37.914"></a><span id="l37.914"> </span>
<a href="#l37.915"></a><span id="l37.915">   // If user is deleting any cells, get confirmation</span>
<a href="#l37.916"></a><span id="l37.916">   // (This is a global to the dialog and we ask only once per dialog session)</span>
<a href="#l37.917"></a><span id="l37.917" class="difflineminus">-  if (!gCanDelete &amp;&amp;</span>
<a href="#l37.918"></a><span id="l37.918" class="difflineminus">-        (gNewRowCount &lt; gRowCount ||</span>
<a href="#l37.919"></a><span id="l37.919" class="difflineminus">-         gNewColCount &lt; gColCount)) {</span>
<a href="#l37.920"></a><span id="l37.920" class="difflineminus">-    if (ConfirmWithTitle(GetString(&quot;DeleteTableTitle&quot;),</span>
<a href="#l37.921"></a><span id="l37.921" class="difflineminus">-                         GetString(&quot;DeleteTableMsg&quot;),</span>
<a href="#l37.922"></a><span id="l37.922" class="difflineminus">-                         GetString(&quot;DeleteCells&quot;))) {</span>
<a href="#l37.923"></a><span id="l37.923" class="difflineplus">+  if (!gCanDelete &amp;&amp; (gNewRowCount &lt; gRowCount || gNewColCount &lt; gColCount)) {</span>
<a href="#l37.924"></a><span id="l37.924" class="difflineplus">+    if (</span>
<a href="#l37.925"></a><span id="l37.925" class="difflineplus">+      ConfirmWithTitle(</span>
<a href="#l37.926"></a><span id="l37.926" class="difflineplus">+        GetString(&quot;DeleteTableTitle&quot;),</span>
<a href="#l37.927"></a><span id="l37.927" class="difflineplus">+        GetString(&quot;DeleteTableMsg&quot;),</span>
<a href="#l37.928"></a><span id="l37.928" class="difflineplus">+        GetString(&quot;DeleteCells&quot;)</span>
<a href="#l37.929"></a><span id="l37.929" class="difflineplus">+      )</span>
<a href="#l37.930"></a><span id="l37.930" class="difflineplus">+    ) {</span>
<a href="#l37.931"></a><span id="l37.931">       gCanDelete = true;</span>
<a href="#l37.932"></a><span id="l37.932">     } else {</span>
<a href="#l37.933"></a><span id="l37.933" class="difflineminus">-      SetTextboxFocus(gNewRowCount &lt; gRowCount ? gDialog.TableRowsInput : gDialog.TableColumnsInput);</span>
<a href="#l37.934"></a><span id="l37.934" class="difflineplus">+      SetTextboxFocus(</span>
<a href="#l37.935"></a><span id="l37.935" class="difflineplus">+        gNewRowCount &lt; gRowCount</span>
<a href="#l37.936"></a><span id="l37.936" class="difflineplus">+          ? gDialog.TableRowsInput</span>
<a href="#l37.937"></a><span id="l37.937" class="difflineplus">+          : gDialog.TableColumnsInput</span>
<a href="#l37.938"></a><span id="l37.938" class="difflineplus">+      );</span>
<a href="#l37.939"></a><span id="l37.939">       return false;</span>
<a href="#l37.940"></a><span id="l37.940">     }</span>
<a href="#l37.941"></a><span id="l37.941">   }</span>
<a href="#l37.942"></a><span id="l37.942"> </span>
<a href="#l37.943"></a><span id="l37.943" class="difflineminus">-  ValidateNumber(gDialog.TableWidthInput, gDialog.TableWidthUnits,</span>
<a href="#l37.944"></a><span id="l37.944" class="difflineminus">-                 1, gMaxTableSize, globalTableElement, &quot;width&quot;);</span>
<a href="#l37.945"></a><span id="l37.945" class="difflineminus">-  if (gValidationError) return false;</span>
<a href="#l37.946"></a><span id="l37.946" class="difflineplus">+  ValidateNumber(</span>
<a href="#l37.947"></a><span id="l37.947" class="difflineplus">+    gDialog.TableWidthInput,</span>
<a href="#l37.948"></a><span id="l37.948" class="difflineplus">+    gDialog.TableWidthUnits,</span>
<a href="#l37.949"></a><span id="l37.949" class="difflineplus">+    1,</span>
<a href="#l37.950"></a><span id="l37.950" class="difflineplus">+    gMaxTableSize,</span>
<a href="#l37.951"></a><span id="l37.951" class="difflineplus">+    globalTableElement,</span>
<a href="#l37.952"></a><span id="l37.952" class="difflineplus">+    &quot;width&quot;</span>
<a href="#l37.953"></a><span id="l37.953" class="difflineplus">+  );</span>
<a href="#l37.954"></a><span id="l37.954" class="difflineplus">+  if (gValidationError) {</span>
<a href="#l37.955"></a><span id="l37.955" class="difflineplus">+    return false;</span>
<a href="#l37.956"></a><span id="l37.956" class="difflineplus">+  }</span>
<a href="#l37.957"></a><span id="l37.957"> </span>
<a href="#l37.958"></a><span id="l37.958">   if (gUseCSS) {</span>
<a href="#l37.959"></a><span id="l37.959" class="difflineminus">-    ValidateNumber(gDialog.TableHeightInput, gDialog.TableHeightUnits,</span>
<a href="#l37.960"></a><span id="l37.960" class="difflineminus">-                   1, gMaxTableSize, globalTableElement, &quot;height&quot;);</span>
<a href="#l37.961"></a><span id="l37.961" class="difflineminus">-    if (gValidationError) return false;</span>
<a href="#l37.962"></a><span id="l37.962" class="difflineplus">+    ValidateNumber(</span>
<a href="#l37.963"></a><span id="l37.963" class="difflineplus">+      gDialog.TableHeightInput,</span>
<a href="#l37.964"></a><span id="l37.964" class="difflineplus">+      gDialog.TableHeightUnits,</span>
<a href="#l37.965"></a><span id="l37.965" class="difflineplus">+      1,</span>
<a href="#l37.966"></a><span id="l37.966" class="difflineplus">+      gMaxTableSize,</span>
<a href="#l37.967"></a><span id="l37.967" class="difflineplus">+      globalTableElement,</span>
<a href="#l37.968"></a><span id="l37.968" class="difflineplus">+      &quot;height&quot;</span>
<a href="#l37.969"></a><span id="l37.969" class="difflineplus">+    );</span>
<a href="#l37.970"></a><span id="l37.970" class="difflineplus">+    if (gValidationError) {</span>
<a href="#l37.971"></a><span id="l37.971" class="difflineplus">+      return false;</span>
<a href="#l37.972"></a><span id="l37.972" class="difflineplus">+    }</span>
<a href="#l37.973"></a><span id="l37.973">   }</span>
<a href="#l37.974"></a><span id="l37.974"> </span>
<a href="#l37.975"></a><span id="l37.975" class="difflineminus">-  ValidateNumber(gDialog.BorderWidthInput, null, 0, gMaxPixels, globalTableElement, &quot;border&quot;);</span>
<a href="#l37.976"></a><span id="l37.976" class="difflineplus">+  ValidateNumber(</span>
<a href="#l37.977"></a><span id="l37.977" class="difflineplus">+    gDialog.BorderWidthInput,</span>
<a href="#l37.978"></a><span id="l37.978" class="difflineplus">+    null,</span>
<a href="#l37.979"></a><span id="l37.979" class="difflineplus">+    0,</span>
<a href="#l37.980"></a><span id="l37.980" class="difflineplus">+    gMaxPixels,</span>
<a href="#l37.981"></a><span id="l37.981" class="difflineplus">+    globalTableElement,</span>
<a href="#l37.982"></a><span id="l37.982" class="difflineplus">+    &quot;border&quot;</span>
<a href="#l37.983"></a><span id="l37.983" class="difflineplus">+  );</span>
<a href="#l37.984"></a><span id="l37.984">   // TODO: Deal with &quot;BORDER&quot; without value issue</span>
<a href="#l37.985"></a><span id="l37.985" class="difflineminus">-  if (gValidationError) return false;</span>
<a href="#l37.986"></a><span id="l37.986" class="difflineplus">+  if (gValidationError) {</span>
<a href="#l37.987"></a><span id="l37.987" class="difflineplus">+    return false;</span>
<a href="#l37.988"></a><span id="l37.988" class="difflineplus">+  }</span>
<a href="#l37.989"></a><span id="l37.989"> </span>
<a href="#l37.990"></a><span id="l37.990" class="difflineminus">-  ValidateNumber(gDialog.SpacingInput, null, 0, gMaxPixels, globalTableElement, &quot;cellspacing&quot;);</span>
<a href="#l37.991"></a><span id="l37.991" class="difflineminus">-  if (gValidationError) return false;</span>
<a href="#l37.992"></a><span id="l37.992" class="difflineplus">+  ValidateNumber(</span>
<a href="#l37.993"></a><span id="l37.993" class="difflineplus">+    gDialog.SpacingInput,</span>
<a href="#l37.994"></a><span id="l37.994" class="difflineplus">+    null,</span>
<a href="#l37.995"></a><span id="l37.995" class="difflineplus">+    0,</span>
<a href="#l37.996"></a><span id="l37.996" class="difflineplus">+    gMaxPixels,</span>
<a href="#l37.997"></a><span id="l37.997" class="difflineplus">+    globalTableElement,</span>
<a href="#l37.998"></a><span id="l37.998" class="difflineplus">+    &quot;cellspacing&quot;</span>
<a href="#l37.999"></a><span id="l37.999" class="difflineplus">+  );</span>
<a href="#l37.1000"></a><span id="l37.1000" class="difflineplus">+  if (gValidationError) {</span>
<a href="#l37.1001"></a><span id="l37.1001" class="difflineplus">+    return false;</span>
<a href="#l37.1002"></a><span id="l37.1002" class="difflineplus">+  }</span>
<a href="#l37.1003"></a><span id="l37.1003"> </span>
<a href="#l37.1004"></a><span id="l37.1004" class="difflineminus">-  ValidateNumber(gDialog.PaddingInput, null, 0, gMaxPixels, globalTableElement, &quot;cellpadding&quot;);</span>
<a href="#l37.1005"></a><span id="l37.1005" class="difflineminus">-  if (gValidationError) return false;</span>
<a href="#l37.1006"></a><span id="l37.1006" class="difflineplus">+  ValidateNumber(</span>
<a href="#l37.1007"></a><span id="l37.1007" class="difflineplus">+    gDialog.PaddingInput,</span>
<a href="#l37.1008"></a><span id="l37.1008" class="difflineplus">+    null,</span>
<a href="#l37.1009"></a><span id="l37.1009" class="difflineplus">+    0,</span>
<a href="#l37.1010"></a><span id="l37.1010" class="difflineplus">+    gMaxPixels,</span>
<a href="#l37.1011"></a><span id="l37.1011" class="difflineplus">+    globalTableElement,</span>
<a href="#l37.1012"></a><span id="l37.1012" class="difflineplus">+    &quot;cellpadding&quot;</span>
<a href="#l37.1013"></a><span id="l37.1013" class="difflineplus">+  );</span>
<a href="#l37.1014"></a><span id="l37.1014" class="difflineplus">+  if (gValidationError) {</span>
<a href="#l37.1015"></a><span id="l37.1015" class="difflineplus">+    return false;</span>
<a href="#l37.1016"></a><span id="l37.1016" class="difflineplus">+  }</span>
<a href="#l37.1017"></a><span id="l37.1017"> </span>
<a href="#l37.1018"></a><span id="l37.1018">   SetAlign(&quot;TableAlignList&quot;, defHAlign, globalTableElement, &quot;align&quot;);</span>
<a href="#l37.1019"></a><span id="l37.1019"> </span>
<a href="#l37.1020"></a><span id="l37.1020">   // Color is set on globalCellElement immediately</span>
<a href="#l37.1021"></a><span id="l37.1021">   return true;</span>
<a href="#l37.1022"></a><span id="l37.1022"> }</span>
<a href="#l37.1023"></a><span id="l37.1023"> </span>
<a href="#l37.1024"></a><span id="l37.1024"> function ValidateCellData() {</span>
<a href="#l37.1025"></a><span id="l37.1025">   gValidateTab = gDialog.CellTab;</span>
<a href="#l37.1026"></a><span id="l37.1026"> </span>
<a href="#l37.1027"></a><span id="l37.1027">   if (gDialog.CellHeightCheckbox.checked) {</span>
<a href="#l37.1028"></a><span id="l37.1028" class="difflineminus">-    ValidateNumber(gDialog.CellHeightInput, gDialog.CellHeightUnits,</span>
<a href="#l37.1029"></a><span id="l37.1029" class="difflineminus">-                    1, gMaxTableSize, globalCellElement, &quot;height&quot;);</span>
<a href="#l37.1030"></a><span id="l37.1030" class="difflineminus">-    if (gValidationError) return false;</span>
<a href="#l37.1031"></a><span id="l37.1031" class="difflineplus">+    ValidateNumber(</span>
<a href="#l37.1032"></a><span id="l37.1032" class="difflineplus">+      gDialog.CellHeightInput,</span>
<a href="#l37.1033"></a><span id="l37.1033" class="difflineplus">+      gDialog.CellHeightUnits,</span>
<a href="#l37.1034"></a><span id="l37.1034" class="difflineplus">+      1,</span>
<a href="#l37.1035"></a><span id="l37.1035" class="difflineplus">+      gMaxTableSize,</span>
<a href="#l37.1036"></a><span id="l37.1036" class="difflineplus">+      globalCellElement,</span>
<a href="#l37.1037"></a><span id="l37.1037" class="difflineplus">+      &quot;height&quot;</span>
<a href="#l37.1038"></a><span id="l37.1038" class="difflineplus">+    );</span>
<a href="#l37.1039"></a><span id="l37.1039" class="difflineplus">+    if (gValidationError) {</span>
<a href="#l37.1040"></a><span id="l37.1040" class="difflineplus">+      return false;</span>
<a href="#l37.1041"></a><span id="l37.1041" class="difflineplus">+    }</span>
<a href="#l37.1042"></a><span id="l37.1042">   }</span>
<a href="#l37.1043"></a><span id="l37.1043"> </span>
<a href="#l37.1044"></a><span id="l37.1044">   if (gDialog.CellWidthCheckbox.checked) {</span>
<a href="#l37.1045"></a><span id="l37.1045" class="difflineminus">-    ValidateNumber(gDialog.CellWidthInput, gDialog.CellWidthUnits,</span>
<a href="#l37.1046"></a><span id="l37.1046" class="difflineminus">-                   1, gMaxTableSize, globalCellElement, &quot;width&quot;);</span>
<a href="#l37.1047"></a><span id="l37.1047" class="difflineminus">-    if (gValidationError) return false;</span>
<a href="#l37.1048"></a><span id="l37.1048" class="difflineplus">+    ValidateNumber(</span>
<a href="#l37.1049"></a><span id="l37.1049" class="difflineplus">+      gDialog.CellWidthInput,</span>
<a href="#l37.1050"></a><span id="l37.1050" class="difflineplus">+      gDialog.CellWidthUnits,</span>
<a href="#l37.1051"></a><span id="l37.1051" class="difflineplus">+      1,</span>
<a href="#l37.1052"></a><span id="l37.1052" class="difflineplus">+      gMaxTableSize,</span>
<a href="#l37.1053"></a><span id="l37.1053" class="difflineplus">+      globalCellElement,</span>
<a href="#l37.1054"></a><span id="l37.1054" class="difflineplus">+      &quot;width&quot;</span>
<a href="#l37.1055"></a><span id="l37.1055" class="difflineplus">+    );</span>
<a href="#l37.1056"></a><span id="l37.1056" class="difflineplus">+    if (gValidationError) {</span>
<a href="#l37.1057"></a><span id="l37.1057" class="difflineplus">+      return false;</span>
<a href="#l37.1058"></a><span id="l37.1058" class="difflineplus">+    }</span>
<a href="#l37.1059"></a><span id="l37.1059">   }</span>
<a href="#l37.1060"></a><span id="l37.1060"> </span>
<a href="#l37.1061"></a><span id="l37.1061">   if (gDialog.CellHAlignCheckbox.checked) {</span>
<a href="#l37.1062"></a><span id="l37.1062">     var hAlign = gDialog.CellHAlignList.value;</span>
<a href="#l37.1063"></a><span id="l37.1063"> </span>
<a href="#l37.1064"></a><span id="l37.1064">     // Horizontal alignment is complicated by &quot;char&quot; type</span>
<a href="#l37.1065"></a><span id="l37.1065">     // We don't change current values if user didn't edit alignment</span>
<a href="#l37.1066"></a><span id="l37.1066">     if (!gAlignWasChar) {</span>
<a href="#l37.1067"></a><span id="l37.1067" class="difflineat">@@ -796,60 +1034,75 @@ function ValidateCellData() {</span>
<a href="#l37.1068"></a><span id="l37.1068">   if (gDialog.CellVAlignCheckbox.checked) {</span>
<a href="#l37.1069"></a><span id="l37.1069">     // Always set valign (no default in 2nd param) so</span>
<a href="#l37.1070"></a><span id="l37.1070">     //  the default &quot;middle&quot; is effective in a cell</span>
<a href="#l37.1071"></a><span id="l37.1071">     //  when parent row has valign set.</span>
<a href="#l37.1072"></a><span id="l37.1072">     SetAlign(&quot;CellVAlignList&quot;, &quot;&quot;, globalCellElement, &quot;valign&quot;);</span>
<a href="#l37.1073"></a><span id="l37.1073">   }</span>
<a href="#l37.1074"></a><span id="l37.1074"> </span>
<a href="#l37.1075"></a><span id="l37.1075">   if (gDialog.TextWrapCheckbox.checked) {</span>
<a href="#l37.1076"></a><span id="l37.1076" class="difflineminus">-    if (gDialog.TextWrapList.value == &quot;nowrap&quot;)</span>
<a href="#l37.1077"></a><span id="l37.1077" class="difflineplus">+    if (gDialog.TextWrapList.value == &quot;nowrap&quot;) {</span>
<a href="#l37.1078"></a><span id="l37.1078">       try {</span>
<a href="#l37.1079"></a><span id="l37.1079" class="difflineminus">-        gActiveEditor.setAttributeOrEquivalent(globalCellElement, &quot;nowrap&quot;,</span>
<a href="#l37.1080"></a><span id="l37.1080" class="difflineminus">-                                               &quot;nowrap&quot;, true);</span>
<a href="#l37.1081"></a><span id="l37.1081" class="difflineplus">+        gActiveEditor.setAttributeOrEquivalent(</span>
<a href="#l37.1082"></a><span id="l37.1082" class="difflineplus">+          globalCellElement,</span>
<a href="#l37.1083"></a><span id="l37.1083" class="difflineplus">+          &quot;nowrap&quot;,</span>
<a href="#l37.1084"></a><span id="l37.1084" class="difflineplus">+          &quot;nowrap&quot;,</span>
<a href="#l37.1085"></a><span id="l37.1085" class="difflineplus">+          true</span>
<a href="#l37.1086"></a><span id="l37.1086" class="difflineplus">+        );</span>
<a href="#l37.1087"></a><span id="l37.1087">       } catch (e) {}</span>
<a href="#l37.1088"></a><span id="l37.1088" class="difflineminus">-    else</span>
<a href="#l37.1089"></a><span id="l37.1089" class="difflineplus">+    } else {</span>
<a href="#l37.1090"></a><span id="l37.1090">       try {</span>
<a href="#l37.1091"></a><span id="l37.1091" class="difflineminus">-        gActiveEditor.removeAttributeOrEquivalent(globalCellElement, &quot;nowrap&quot;, true);</span>
<a href="#l37.1092"></a><span id="l37.1092" class="difflineplus">+        gActiveEditor.removeAttributeOrEquivalent(</span>
<a href="#l37.1093"></a><span id="l37.1093" class="difflineplus">+          globalCellElement,</span>
<a href="#l37.1094"></a><span id="l37.1094" class="difflineplus">+          &quot;nowrap&quot;,</span>
<a href="#l37.1095"></a><span id="l37.1095" class="difflineplus">+          true</span>
<a href="#l37.1096"></a><span id="l37.1096" class="difflineplus">+        );</span>
<a href="#l37.1097"></a><span id="l37.1097">       } catch (e) {}</span>
<a href="#l37.1098"></a><span id="l37.1098" class="difflineplus">+    }</span>
<a href="#l37.1099"></a><span id="l37.1099">   }</span>
<a href="#l37.1100"></a><span id="l37.1100"> </span>
<a href="#l37.1101"></a><span id="l37.1101">   return true;</span>
<a href="#l37.1102"></a><span id="l37.1102"> }</span>
<a href="#l37.1103"></a><span id="l37.1103"> </span>
<a href="#l37.1104"></a><span id="l37.1104"> function ValidateData() {</span>
<a href="#l37.1105"></a><span id="l37.1105">   var result;</span>
<a href="#l37.1106"></a><span id="l37.1106"> </span>
<a href="#l37.1107"></a><span id="l37.1107">   // Validate current panel first</span>
<a href="#l37.1108"></a><span id="l37.1108">   if (gDialog.TabBox.selectedTab == gDialog.TableTab) {</span>
<a href="#l37.1109"></a><span id="l37.1109">     result = ValidateTableData();</span>
<a href="#l37.1110"></a><span id="l37.1110" class="difflineminus">-    if (result)</span>
<a href="#l37.1111"></a><span id="l37.1111" class="difflineplus">+    if (result) {</span>
<a href="#l37.1112"></a><span id="l37.1112">       result = ValidateCellData();</span>
<a href="#l37.1113"></a><span id="l37.1113" class="difflineplus">+    }</span>
<a href="#l37.1114"></a><span id="l37.1114">   } else {</span>
<a href="#l37.1115"></a><span id="l37.1115">     result = ValidateCellData();</span>
<a href="#l37.1116"></a><span id="l37.1116" class="difflineminus">-    if (result)</span>
<a href="#l37.1117"></a><span id="l37.1117" class="difflineplus">+    if (result) {</span>
<a href="#l37.1118"></a><span id="l37.1118">       result = ValidateTableData();</span>
<a href="#l37.1119"></a><span id="l37.1119" class="difflineplus">+    }</span>
<a href="#l37.1120"></a><span id="l37.1120">   }</span>
<a href="#l37.1121"></a><span id="l37.1121" class="difflineminus">-  if (!result) return false;</span>
<a href="#l37.1122"></a><span id="l37.1122" class="difflineplus">+  if (!result) {</span>
<a href="#l37.1123"></a><span id="l37.1123" class="difflineplus">+    return false;</span>
<a href="#l37.1124"></a><span id="l37.1124" class="difflineplus">+  }</span>
<a href="#l37.1125"></a><span id="l37.1125"> </span>
<a href="#l37.1126"></a><span id="l37.1126">   // Set global element for AdvancedEdit</span>
<a href="#l37.1127"></a><span id="l37.1127" class="difflineminus">-  if (gDialog.TabBox.selectedTab == gDialog.TableTab)</span>
<a href="#l37.1128"></a><span id="l37.1128" class="difflineplus">+  if (gDialog.TabBox.selectedTab == gDialog.TableTab) {</span>
<a href="#l37.1129"></a><span id="l37.1129">     globalElement = globalTableElement;</span>
<a href="#l37.1130"></a><span id="l37.1130" class="difflineminus">-  else</span>
<a href="#l37.1131"></a><span id="l37.1131" class="difflineplus">+  } else {</span>
<a href="#l37.1132"></a><span id="l37.1132">     globalElement = globalCellElement;</span>
<a href="#l37.1133"></a><span id="l37.1133" class="difflineplus">+  }</span>
<a href="#l37.1134"></a><span id="l37.1134"> </span>
<a href="#l37.1135"></a><span id="l37.1135">   return true;</span>
<a href="#l37.1136"></a><span id="l37.1136"> }</span>
<a href="#l37.1137"></a><span id="l37.1137"> </span>
<a href="#l37.1138"></a><span id="l37.1138"> function ChangeCellTextbox(textboxID) {</span>
<a href="#l37.1139"></a><span id="l37.1139">   // Filter input for just integers</span>
<a href="#l37.1140"></a><span id="l37.1140">   forceInteger(textboxID);</span>
<a href="#l37.1141"></a><span id="l37.1141"> </span>
<a href="#l37.1142"></a><span id="l37.1142" class="difflineminus">-  if (gDialog.TabBox.selectedTab == gDialog.CellTab)</span>
<a href="#l37.1143"></a><span id="l37.1143" class="difflineplus">+  if (gDialog.TabBox.selectedTab == gDialog.CellTab) {</span>
<a href="#l37.1144"></a><span id="l37.1144">     gCellDataChanged = true;</span>
<a href="#l37.1145"></a><span id="l37.1145" class="difflineplus">+  }</span>
<a href="#l37.1146"></a><span id="l37.1146"> }</span>
<a href="#l37.1147"></a><span id="l37.1147"> </span>
<a href="#l37.1148"></a><span id="l37.1148"> // Call this when a textbox or menulist is changed</span>
<a href="#l37.1149"></a><span id="l37.1149"> //   so the checkbox is automatically set</span>
<a href="#l37.1150"></a><span id="l37.1150"> function SetCheckbox(checkboxID) {</span>
<a href="#l37.1151"></a><span id="l37.1151">   if (checkboxID &amp;&amp; checkboxID.length &gt; 0) {</span>
<a href="#l37.1152"></a><span id="l37.1152">     // Set associated checkbox</span>
<a href="#l37.1153"></a><span id="l37.1153">     document.getElementById(checkboxID).checked = true;</span>
<a href="#l37.1154"></a><span id="l37.1154" class="difflineat">@@ -866,56 +1119,77 @@ function ChangeIntTextbox(textboxID, che</span>
<a href="#l37.1155"></a><span id="l37.1155"> }</span>
<a href="#l37.1156"></a><span id="l37.1156"> </span>
<a href="#l37.1157"></a><span id="l37.1157"> function CloneAttribute(destElement, srcElement, attr) {</span>
<a href="#l37.1158"></a><span id="l37.1158">   var value = srcElement.getAttribute(attr);</span>
<a href="#l37.1159"></a><span id="l37.1159">   // Use editor methods since we are always</span>
<a href="#l37.1160"></a><span id="l37.1160">   //  modifying a table in the document and</span>
<a href="#l37.1161"></a><span id="l37.1161">   //  we need transaction system for undo</span>
<a href="#l37.1162"></a><span id="l37.1162">   try {</span>
<a href="#l37.1163"></a><span id="l37.1163" class="difflineminus">-    if (!value || value.length == 0)</span>
<a href="#l37.1164"></a><span id="l37.1164" class="difflineplus">+    if (!value || value.length == 0) {</span>
<a href="#l37.1165"></a><span id="l37.1165">       gActiveEditor.removeAttributeOrEquivalent(destElement, attr, false);</span>
<a href="#l37.1166"></a><span id="l37.1166" class="difflineminus">-    else</span>
<a href="#l37.1167"></a><span id="l37.1167" class="difflineplus">+    } else {</span>
<a href="#l37.1168"></a><span id="l37.1168">       gActiveEditor.setAttributeOrEquivalent(destElement, attr, value, false);</span>
<a href="#l37.1169"></a><span id="l37.1169" class="difflineplus">+    }</span>
<a href="#l37.1170"></a><span id="l37.1170">   } catch (e) {}</span>
<a href="#l37.1171"></a><span id="l37.1171"> }</span>
<a href="#l37.1172"></a><span id="l37.1172"> </span>
<a href="#l37.1173"></a><span id="l37.1173"> /* eslint-disable complexity */</span>
<a href="#l37.1174"></a><span id="l37.1174"> function ApplyTableAttributes() {</span>
<a href="#l37.1175"></a><span id="l37.1175">   var newAlign = gDialog.TableCaptionList.value;</span>
<a href="#l37.1176"></a><span id="l37.1176" class="difflineminus">-  if (!newAlign) newAlign = &quot;&quot;;</span>
<a href="#l37.1177"></a><span id="l37.1177" class="difflineplus">+  if (!newAlign) {</span>
<a href="#l37.1178"></a><span id="l37.1178" class="difflineplus">+    newAlign = &quot;&quot;;</span>
<a href="#l37.1179"></a><span id="l37.1179" class="difflineplus">+  }</span>
<a href="#l37.1180"></a><span id="l37.1180"> </span>
<a href="#l37.1181"></a><span id="l37.1181">   if (gTableCaptionElement) {</span>
<a href="#l37.1182"></a><span id="l37.1182">     // Get current alignment</span>
<a href="#l37.1183"></a><span id="l37.1183" class="difflineminus">-    var align = GetHTMLOrCSSStyleValue(gTableCaptionElement, &quot;align&quot;, &quot;caption-side&quot;).toLowerCase();</span>
<a href="#l37.1184"></a><span id="l37.1184" class="difflineplus">+    var align = GetHTMLOrCSSStyleValue(</span>
<a href="#l37.1185"></a><span id="l37.1185" class="difflineplus">+      gTableCaptionElement,</span>
<a href="#l37.1186"></a><span id="l37.1186" class="difflineplus">+      &quot;align&quot;,</span>
<a href="#l37.1187"></a><span id="l37.1187" class="difflineplus">+      &quot;caption-side&quot;</span>
<a href="#l37.1188"></a><span id="l37.1188" class="difflineplus">+    ).toLowerCase();</span>
<a href="#l37.1189"></a><span id="l37.1189">     // This is the default</span>
<a href="#l37.1190"></a><span id="l37.1190" class="difflineminus">-    if (!align) align = &quot;top&quot;;</span>
<a href="#l37.1191"></a><span id="l37.1191" class="difflineplus">+    if (!align) {</span>
<a href="#l37.1192"></a><span id="l37.1192" class="difflineplus">+      align = &quot;top&quot;;</span>
<a href="#l37.1193"></a><span id="l37.1193" class="difflineplus">+    }</span>
<a href="#l37.1194"></a><span id="l37.1194"> </span>
<a href="#l37.1195"></a><span id="l37.1195">     if (newAlign == &quot;&quot;) {</span>
<a href="#l37.1196"></a><span id="l37.1196">       // Remove existing caption</span>
<a href="#l37.1197"></a><span id="l37.1197">       try {</span>
<a href="#l37.1198"></a><span id="l37.1198">         gActiveEditor.deleteNode(gTableCaptionElement);</span>
<a href="#l37.1199"></a><span id="l37.1199">       } catch (e) {}</span>
<a href="#l37.1200"></a><span id="l37.1200">       gTableCaptionElement = null;</span>
<a href="#l37.1201"></a><span id="l37.1201">     } else if (newAlign != align) {</span>
<a href="#l37.1202"></a><span id="l37.1202">       try {</span>
<a href="#l37.1203"></a><span id="l37.1203" class="difflineminus">-        if (newAlign == &quot;top&quot;) // This is default, so don't explicitly set it</span>
<a href="#l37.1204"></a><span id="l37.1204" class="difflineminus">-          gActiveEditor.removeAttributeOrEquivalent(gTableCaptionElement, &quot;align&quot;, false);</span>
<a href="#l37.1205"></a><span id="l37.1205" class="difflineminus">-        else</span>
<a href="#l37.1206"></a><span id="l37.1206" class="difflineminus">-          gActiveEditor.setAttributeOrEquivalent(gTableCaptionElement, &quot;align&quot;, newAlign, false);</span>
<a href="#l37.1207"></a><span id="l37.1207" class="difflineplus">+        if (newAlign == &quot;top&quot;) {</span>
<a href="#l37.1208"></a><span id="l37.1208" class="difflineplus">+          // This is default, so don't explicitly set it</span>
<a href="#l37.1209"></a><span id="l37.1209" class="difflineplus">+          gActiveEditor.removeAttributeOrEquivalent(</span>
<a href="#l37.1210"></a><span id="l37.1210" class="difflineplus">+            gTableCaptionElement,</span>
<a href="#l37.1211"></a><span id="l37.1211" class="difflineplus">+            &quot;align&quot;,</span>
<a href="#l37.1212"></a><span id="l37.1212" class="difflineplus">+            false</span>
<a href="#l37.1213"></a><span id="l37.1213" class="difflineplus">+          );</span>
<a href="#l37.1214"></a><span id="l37.1214" class="difflineplus">+        } else {</span>
<a href="#l37.1215"></a><span id="l37.1215" class="difflineplus">+          gActiveEditor.setAttributeOrEquivalent(</span>
<a href="#l37.1216"></a><span id="l37.1216" class="difflineplus">+            gTableCaptionElement,</span>
<a href="#l37.1217"></a><span id="l37.1217" class="difflineplus">+            &quot;align&quot;,</span>
<a href="#l37.1218"></a><span id="l37.1218" class="difflineplus">+            newAlign,</span>
<a href="#l37.1219"></a><span id="l37.1219" class="difflineplus">+            false</span>
<a href="#l37.1220"></a><span id="l37.1220" class="difflineplus">+          );</span>
<a href="#l37.1221"></a><span id="l37.1221" class="difflineplus">+        }</span>
<a href="#l37.1222"></a><span id="l37.1222">       } catch (e) {}</span>
<a href="#l37.1223"></a><span id="l37.1223">     }</span>
<a href="#l37.1224"></a><span id="l37.1224">   } else if (newAlign != &quot;&quot;) {</span>
<a href="#l37.1225"></a><span id="l37.1225">     // Create and insert a caption:</span>
<a href="#l37.1226"></a><span id="l37.1226">     try {</span>
<a href="#l37.1227"></a><span id="l37.1227">       gTableCaptionElement = gActiveEditor.createElementWithDefaults(&quot;caption&quot;);</span>
<a href="#l37.1228"></a><span id="l37.1228">     } catch (e) {}</span>
<a href="#l37.1229"></a><span id="l37.1229">     if (gTableCaptionElement) {</span>
<a href="#l37.1230"></a><span id="l37.1230" class="difflineminus">-      if (newAlign != &quot;top&quot;)</span>
<a href="#l37.1231"></a><span id="l37.1231" class="difflineplus">+      if (newAlign != &quot;top&quot;) {</span>
<a href="#l37.1232"></a><span id="l37.1232">         gTableCaptionElement.setAttribute(&quot;align&quot;, newAlign);</span>
<a href="#l37.1233"></a><span id="l37.1233" class="difflineplus">+      }</span>
<a href="#l37.1234"></a><span id="l37.1234"> </span>
<a href="#l37.1235"></a><span id="l37.1235">       // Insert it into the table - caption is always inserted as first child</span>
<a href="#l37.1236"></a><span id="l37.1236">       try {</span>
<a href="#l37.1237"></a><span id="l37.1237">         gActiveEditor.insertNode(gTableCaptionElement, gTableElement, 0);</span>
<a href="#l37.1238"></a><span id="l37.1238">       } catch (e) {}</span>
<a href="#l37.1239"></a><span id="l37.1239"> </span>
<a href="#l37.1240"></a><span id="l37.1240">       // Put selection back where it was</span>
<a href="#l37.1241"></a><span id="l37.1241">       ChangeSelection(RESET_SELECTION);</span>
<a href="#l37.1242"></a><span id="l37.1242" class="difflineat">@@ -940,43 +1214,47 @@ function ApplyTableAttributes() {</span>
<a href="#l37.1243"></a><span id="l37.1243">           gRowCount = gNewRowCount;</span>
<a href="#l37.1244"></a><span id="l37.1244">           gLastRowIndex = gRowCount - 1;</span>
<a href="#l37.1245"></a><span id="l37.1245">           // Put selection back where it was</span>
<a href="#l37.1246"></a><span id="l37.1246">           ChangeSelection(RESET_SELECTION);</span>
<a href="#l37.1247"></a><span id="l37.1247">         } catch (ex) {</span>
<a href="#l37.1248"></a><span id="l37.1248">           dump(&quot;FAILED TO FIND FIRST CELL IN LAST ROW\n&quot;);</span>
<a href="#l37.1249"></a><span id="l37.1249">         }</span>
<a href="#l37.1250"></a><span id="l37.1250">       }</span>
<a href="#l37.1251"></a><span id="l37.1251" class="difflineminus">-    } else if (gCanDelete) { // Delete rows</span>
<a href="#l37.1252"></a><span id="l37.1252" class="difflineplus">+    } else if (gCanDelete) {</span>
<a href="#l37.1253"></a><span id="l37.1253" class="difflineplus">+      // Delete rows</span>
<a href="#l37.1254"></a><span id="l37.1254">       // Find first cell starting in first row we delete</span>
<a href="#l37.1255"></a><span id="l37.1255">       var firstDeleteRow = gRowCount + countDelta;</span>
<a href="#l37.1256"></a><span id="l37.1256">       foundCell = false;</span>
<a href="#l37.1257"></a><span id="l37.1257">       for (i = 0; i &lt;= gLastColIndex; i++) {</span>
<a href="#l37.1258"></a><span id="l37.1258" class="difflineminus">-        if (!GetCellData(firstDeleteRow, i))</span>
<a href="#l37.1259"></a><span id="l37.1259" class="difflineminus">-          break; // We failed to find a cell</span>
<a href="#l37.1260"></a><span id="l37.1260" class="difflineplus">+        if (!GetCellData(firstDeleteRow, i)) {</span>
<a href="#l37.1261"></a><span id="l37.1261" class="difflineplus">+          break;</span>
<a href="#l37.1262"></a><span id="l37.1262" class="difflineplus">+        } // We failed to find a cell</span>
<a href="#l37.1263"></a><span id="l37.1263"> </span>
<a href="#l37.1264"></a><span id="l37.1264">         if (gCellData.startRowIndex == firstDeleteRow) {</span>
<a href="#l37.1265"></a><span id="l37.1265">           foundCell = true;</span>
<a href="#l37.1266"></a><span id="l37.1266">           break;</span>
<a href="#l37.1267"></a><span id="l37.1267">         }</span>
<a href="#l37.1268"></a><span id="l37.1268">       }</span>
<a href="#l37.1269"></a><span id="l37.1269">       if (foundCell) {</span>
<a href="#l37.1270"></a><span id="l37.1270">         try {</span>
<a href="#l37.1271"></a><span id="l37.1271">           // Move selection to the cell we found</span>
<a href="#l37.1272"></a><span id="l37.1272">           gSelection.collapse(gCellData.value, 0);</span>
<a href="#l37.1273"></a><span id="l37.1273">           gActiveEditor.deleteTableRow(-countDelta);</span>
<a href="#l37.1274"></a><span id="l37.1274">           gRowCount = gNewRowCount;</span>
<a href="#l37.1275"></a><span id="l37.1275">           gLastRowIndex = gRowCount - 1;</span>
<a href="#l37.1276"></a><span id="l37.1276" class="difflineminus">-          if (gCurRowIndex &gt; gLastRowIndex)</span>
<a href="#l37.1277"></a><span id="l37.1277" class="difflineplus">+          if (gCurRowIndex &gt; gLastRowIndex) {</span>
<a href="#l37.1278"></a><span id="l37.1278">             // We are deleting our selection</span>
<a href="#l37.1279"></a><span id="l37.1279">             // move it to start of table</span>
<a href="#l37.1280"></a><span id="l37.1280">             ChangeSelectionToFirstCell();</span>
<a href="#l37.1281"></a><span id="l37.1281" class="difflineminus">-          else</span>
<a href="#l37.1282"></a><span id="l37.1282" class="difflineminus">-            // Put selection back where it was</span>
<a href="#l37.1283"></a><span id="l37.1283" class="difflineplus">+          }</span>
<a href="#l37.1284"></a><span id="l37.1284" class="difflineplus">+          // Put selection back where it was</span>
<a href="#l37.1285"></a><span id="l37.1285" class="difflineplus">+          else {</span>
<a href="#l37.1286"></a><span id="l37.1286">             ChangeSelection(RESET_SELECTION);</span>
<a href="#l37.1287"></a><span id="l37.1287" class="difflineplus">+          }</span>
<a href="#l37.1288"></a><span id="l37.1288">         } catch (ex) {</span>
<a href="#l37.1289"></a><span id="l37.1289">           dump(&quot;FAILED TO FIND FIRST CELL IN LAST ROW\n&quot;);</span>
<a href="#l37.1290"></a><span id="l37.1290">         }</span>
<a href="#l37.1291"></a><span id="l37.1291">       }</span>
<a href="#l37.1292"></a><span id="l37.1292">     }</span>
<a href="#l37.1293"></a><span id="l37.1293">   }</span>
<a href="#l37.1294"></a><span id="l37.1294"> </span>
<a href="#l37.1295"></a><span id="l37.1295">   if (gNewColCount != gColCount) {</span>
<a href="#l37.1296"></a><span id="l37.1296" class="difflineat">@@ -993,40 +1271,43 @@ function ApplyTableAttributes() {</span>
<a href="#l37.1297"></a><span id="l37.1297">           gColCount = gNewColCount;</span>
<a href="#l37.1298"></a><span id="l37.1298">           gLastColIndex = gColCount - 1;</span>
<a href="#l37.1299"></a><span id="l37.1299">           // Restore selection</span>
<a href="#l37.1300"></a><span id="l37.1300">           ChangeSelection(RESET_SELECTION);</span>
<a href="#l37.1301"></a><span id="l37.1301">         } catch (ex) {</span>
<a href="#l37.1302"></a><span id="l37.1302">           dump(&quot;FAILED TO FIND FIRST CELL IN LAST COLUMN\n&quot;);</span>
<a href="#l37.1303"></a><span id="l37.1303">         }</span>
<a href="#l37.1304"></a><span id="l37.1304">       }</span>
<a href="#l37.1305"></a><span id="l37.1305" class="difflineminus">-    } else if (gCanDelete) { // Delete columns</span>
<a href="#l37.1306"></a><span id="l37.1306" class="difflineplus">+    } else if (gCanDelete) {</span>
<a href="#l37.1307"></a><span id="l37.1307" class="difflineplus">+      // Delete columns</span>
<a href="#l37.1308"></a><span id="l37.1308">       var firstDeleteCol = gColCount + countDelta;</span>
<a href="#l37.1309"></a><span id="l37.1309">       foundCell = false;</span>
<a href="#l37.1310"></a><span id="l37.1310">       for (i = 0; i &lt;= gLastRowIndex; i++) {</span>
<a href="#l37.1311"></a><span id="l37.1311">         // Find first cell starting in first column we delete</span>
<a href="#l37.1312"></a><span id="l37.1312" class="difflineminus">-        if (!GetCellData(i, firstDeleteCol))</span>
<a href="#l37.1313"></a><span id="l37.1313" class="difflineminus">-          break; // We failed to find a cell</span>
<a href="#l37.1314"></a><span id="l37.1314" class="difflineplus">+        if (!GetCellData(i, firstDeleteCol)) {</span>
<a href="#l37.1315"></a><span id="l37.1315" class="difflineplus">+          break;</span>
<a href="#l37.1316"></a><span id="l37.1316" class="difflineplus">+        } // We failed to find a cell</span>
<a href="#l37.1317"></a><span id="l37.1317"> </span>
<a href="#l37.1318"></a><span id="l37.1318">         if (gCellData.startColIndex == firstDeleteCol) {</span>
<a href="#l37.1319"></a><span id="l37.1319">           foundCell = true;</span>
<a href="#l37.1320"></a><span id="l37.1320">           break;</span>
<a href="#l37.1321"></a><span id="l37.1321">         }</span>
<a href="#l37.1322"></a><span id="l37.1322">       }</span>
<a href="#l37.1323"></a><span id="l37.1323">       if (foundCell) {</span>
<a href="#l37.1324"></a><span id="l37.1324">         try {</span>
<a href="#l37.1325"></a><span id="l37.1325">           // Move selection to the cell we found</span>
<a href="#l37.1326"></a><span id="l37.1326">           gSelection.collapse(gCellData.value, 0);</span>
<a href="#l37.1327"></a><span id="l37.1327">           gActiveEditor.deleteTableColumn(-countDelta);</span>
<a href="#l37.1328"></a><span id="l37.1328">           gColCount = gNewColCount;</span>
<a href="#l37.1329"></a><span id="l37.1329">           gLastColIndex = gColCount - 1;</span>
<a href="#l37.1330"></a><span id="l37.1330" class="difflineminus">-          if (gCurColIndex &gt; gLastColIndex)</span>
<a href="#l37.1331"></a><span id="l37.1331" class="difflineplus">+          if (gCurColIndex &gt; gLastColIndex) {</span>
<a href="#l37.1332"></a><span id="l37.1332">             ChangeSelectionToFirstCell();</span>
<a href="#l37.1333"></a><span id="l37.1333" class="difflineminus">-          else</span>
<a href="#l37.1334"></a><span id="l37.1334" class="difflineplus">+          } else {</span>
<a href="#l37.1335"></a><span id="l37.1335">             ChangeSelection(RESET_SELECTION);</span>
<a href="#l37.1336"></a><span id="l37.1336" class="difflineplus">+          }</span>
<a href="#l37.1337"></a><span id="l37.1337">         } catch (ex) {</span>
<a href="#l37.1338"></a><span id="l37.1338">           dump(&quot;FAILED TO FIND FIRST CELL IN LAST ROW\n&quot;);</span>
<a href="#l37.1339"></a><span id="l37.1339">         }</span>
<a href="#l37.1340"></a><span id="l37.1340">       }</span>
<a href="#l37.1341"></a><span id="l37.1341">     }</span>
<a href="#l37.1342"></a><span id="l37.1342">   }</span>
<a href="#l37.1343"></a><span id="l37.1343"> </span>
<a href="#l37.1344"></a><span id="l37.1344">   // Clone all remaining attributes to pick up</span>
<a href="#l37.1345"></a><span id="l37.1345" class="difflineat">@@ -1039,28 +1320,30 @@ function ApplyTableAttributes() {</span>
<a href="#l37.1346"></a><span id="l37.1346"> </span>
<a href="#l37.1347"></a><span id="l37.1347"> function ApplyCellAttributes() {</span>
<a href="#l37.1348"></a><span id="l37.1348">   var rangeObj = { value: null };</span>
<a href="#l37.1349"></a><span id="l37.1349">   var selectedCell;</span>
<a href="#l37.1350"></a><span id="l37.1350">   try {</span>
<a href="#l37.1351"></a><span id="l37.1351">     selectedCell = gActiveEditor.getFirstSelectedCell(rangeObj);</span>
<a href="#l37.1352"></a><span id="l37.1352">   } catch (e) {}</span>
<a href="#l37.1353"></a><span id="l37.1353"> </span>
<a href="#l37.1354"></a><span id="l37.1354" class="difflineminus">-  if (!selectedCell)</span>
<a href="#l37.1355"></a><span id="l37.1355" class="difflineplus">+  if (!selectedCell) {</span>
<a href="#l37.1356"></a><span id="l37.1356">     return;</span>
<a href="#l37.1357"></a><span id="l37.1357" class="difflineplus">+  }</span>
<a href="#l37.1358"></a><span id="l37.1358"> </span>
<a href="#l37.1359"></a><span id="l37.1359">   if (gSelectedCellCount == 1) {</span>
<a href="#l37.1360"></a><span id="l37.1360">     // When only one cell is selected, simply clone entire element,</span>
<a href="#l37.1361"></a><span id="l37.1361">     //  thus CSS and JS from Advanced edit is copied</span>
<a href="#l37.1362"></a><span id="l37.1362">     try {</span>
<a href="#l37.1363"></a><span id="l37.1363">       gActiveEditor.cloneAttributes(selectedCell, globalCellElement);</span>
<a href="#l37.1364"></a><span id="l37.1364">     } catch (e) {}</span>
<a href="#l37.1365"></a><span id="l37.1365"> </span>
<a href="#l37.1366"></a><span id="l37.1366">     if (gDialog.CellStyleCheckbox.checked) {</span>
<a href="#l37.1367"></a><span id="l37.1367" class="difflineminus">-      var currentStyleIndex = (selectedCell.nodeName.toLowerCase() == &quot;th&quot;) ? 1 : 0;</span>
<a href="#l37.1368"></a><span id="l37.1368" class="difflineplus">+      var currentStyleIndex =</span>
<a href="#l37.1369"></a><span id="l37.1369" class="difflineplus">+        selectedCell.nodeName.toLowerCase() == &quot;th&quot; ? 1 : 0;</span>
<a href="#l37.1370"></a><span id="l37.1370">       if (gDialog.CellStyleList.selectedIndex != currentStyleIndex) {</span>
<a href="#l37.1371"></a><span id="l37.1371">         // Switch cell types</span>
<a href="#l37.1372"></a><span id="l37.1372">         // (replaces with new cell and copies attributes and contents)</span>
<a href="#l37.1373"></a><span id="l37.1373">         try {</span>
<a href="#l37.1374"></a><span id="l37.1374">           selectedCell = gActiveEditor.switchTableCellHeaderType(selectedCell);</span>
<a href="#l37.1375"></a><span id="l37.1375">         } catch (e) {}</span>
<a href="#l37.1376"></a><span id="l37.1376">       }</span>
<a href="#l37.1377"></a><span id="l37.1377">     }</span>
<a href="#l37.1378"></a><span id="l37.1378" class="difflineat">@@ -1073,68 +1356,76 @@ function ApplyCellAttributes() {</span>
<a href="#l37.1379"></a><span id="l37.1379">         selectedCell = gActiveEditor.getNextSelectedCell(rangeObj);</span>
<a href="#l37.1380"></a><span id="l37.1380">       }</span>
<a href="#l37.1381"></a><span id="l37.1381">     } catch (e) {}</span>
<a href="#l37.1382"></a><span id="l37.1382">   }</span>
<a href="#l37.1383"></a><span id="l37.1383">   gCellDataChanged = false;</span>
<a href="#l37.1384"></a><span id="l37.1384"> }</span>
<a href="#l37.1385"></a><span id="l37.1385"> </span>
<a href="#l37.1386"></a><span id="l37.1386"> function ApplyAttributesToOneCell(destElement) {</span>
<a href="#l37.1387"></a><span id="l37.1387" class="difflineminus">-  if (gDialog.CellHeightCheckbox.checked)</span>
<a href="#l37.1388"></a><span id="l37.1388" class="difflineplus">+  if (gDialog.CellHeightCheckbox.checked) {</span>
<a href="#l37.1389"></a><span id="l37.1389">     CloneAttribute(destElement, globalCellElement, &quot;height&quot;);</span>
<a href="#l37.1390"></a><span id="l37.1390" class="difflineplus">+  }</span>
<a href="#l37.1391"></a><span id="l37.1391"> </span>
<a href="#l37.1392"></a><span id="l37.1392" class="difflineminus">-  if (gDialog.CellWidthCheckbox.checked)</span>
<a href="#l37.1393"></a><span id="l37.1393" class="difflineplus">+  if (gDialog.CellWidthCheckbox.checked) {</span>
<a href="#l37.1394"></a><span id="l37.1394">     CloneAttribute(destElement, globalCellElement, &quot;width&quot;);</span>
<a href="#l37.1395"></a><span id="l37.1395" class="difflineplus">+  }</span>
<a href="#l37.1396"></a><span id="l37.1396"> </span>
<a href="#l37.1397"></a><span id="l37.1397">   if (gDialog.CellHAlignCheckbox.checked) {</span>
<a href="#l37.1398"></a><span id="l37.1398">     CloneAttribute(destElement, globalCellElement, &quot;align&quot;);</span>
<a href="#l37.1399"></a><span id="l37.1399">     CloneAttribute(destElement, globalCellElement, charStr);</span>
<a href="#l37.1400"></a><span id="l37.1400">   }</span>
<a href="#l37.1401"></a><span id="l37.1401"> </span>
<a href="#l37.1402"></a><span id="l37.1402" class="difflineminus">-  if (gDialog.CellVAlignCheckbox.checked)</span>
<a href="#l37.1403"></a><span id="l37.1403" class="difflineplus">+  if (gDialog.CellVAlignCheckbox.checked) {</span>
<a href="#l37.1404"></a><span id="l37.1404">     CloneAttribute(destElement, globalCellElement, &quot;valign&quot;);</span>
<a href="#l37.1405"></a><span id="l37.1405" class="difflineplus">+  }</span>
<a href="#l37.1406"></a><span id="l37.1406"> </span>
<a href="#l37.1407"></a><span id="l37.1407" class="difflineminus">-  if (gDialog.TextWrapCheckbox.checked)</span>
<a href="#l37.1408"></a><span id="l37.1408" class="difflineplus">+  if (gDialog.TextWrapCheckbox.checked) {</span>
<a href="#l37.1409"></a><span id="l37.1409">     CloneAttribute(destElement, globalCellElement, &quot;nowrap&quot;);</span>
<a href="#l37.1410"></a><span id="l37.1410" class="difflineplus">+  }</span>
<a href="#l37.1411"></a><span id="l37.1411"> </span>
<a href="#l37.1412"></a><span id="l37.1412">   if (gDialog.CellStyleCheckbox.checked) {</span>
<a href="#l37.1413"></a><span id="l37.1413">     var newStyleIndex = gDialog.CellStyleList.selectedIndex;</span>
<a href="#l37.1414"></a><span id="l37.1414" class="difflineminus">-    var currentStyleIndex = (destElement.nodeName.toLowerCase() == &quot;th&quot;) ? 1 : 0;</span>
<a href="#l37.1415"></a><span id="l37.1415" class="difflineplus">+    var currentStyleIndex = destElement.nodeName.toLowerCase() == &quot;th&quot; ? 1 : 0;</span>
<a href="#l37.1416"></a><span id="l37.1416"> </span>
<a href="#l37.1417"></a><span id="l37.1417">     if (newStyleIndex != currentStyleIndex) {</span>
<a href="#l37.1418"></a><span id="l37.1418">       // Switch cell types</span>
<a href="#l37.1419"></a><span id="l37.1419">       // (replaces with new cell and copies attributes and contents)</span>
<a href="#l37.1420"></a><span id="l37.1420">       try {</span>
<a href="#l37.1421"></a><span id="l37.1421">         destElement = gActiveEditor.switchTableCellHeaderType(destElement);</span>
<a href="#l37.1422"></a><span id="l37.1422">       } catch (e) {}</span>
<a href="#l37.1423"></a><span id="l37.1423">     }</span>
<a href="#l37.1424"></a><span id="l37.1424">   }</span>
<a href="#l37.1425"></a><span id="l37.1425"> </span>
<a href="#l37.1426"></a><span id="l37.1426" class="difflineminus">-  if (gDialog.CellColorCheckbox.checked)</span>
<a href="#l37.1427"></a><span id="l37.1427" class="difflineplus">+  if (gDialog.CellColorCheckbox.checked) {</span>
<a href="#l37.1428"></a><span id="l37.1428">     CloneAttribute(destElement, globalCellElement, &quot;bgcolor&quot;);</span>
<a href="#l37.1429"></a><span id="l37.1429" class="difflineplus">+  }</span>
<a href="#l37.1430"></a><span id="l37.1430"> }</span>
<a href="#l37.1431"></a><span id="l37.1431"> </span>
<a href="#l37.1432"></a><span id="l37.1432"> function SetCloseButton() {</span>
<a href="#l37.1433"></a><span id="l37.1433">   // Change text on &quot;Cancel&quot; button after Apply is used</span>
<a href="#l37.1434"></a><span id="l37.1434">   if (!gApplyUsed) {</span>
<a href="#l37.1435"></a><span id="l37.1435" class="difflineminus">-    document.documentElement.setAttribute(&quot;buttonlabelcancel&quot;,</span>
<a href="#l37.1436"></a><span id="l37.1436" class="difflineminus">-      document.documentElement.getAttribute(&quot;buttonlabelclose&quot;));</span>
<a href="#l37.1437"></a><span id="l37.1437" class="difflineplus">+    document.documentElement.setAttribute(</span>
<a href="#l37.1438"></a><span id="l37.1438" class="difflineplus">+      &quot;buttonlabelcancel&quot;,</span>
<a href="#l37.1439"></a><span id="l37.1439" class="difflineplus">+      document.documentElement.getAttribute(&quot;buttonlabelclose&quot;)</span>
<a href="#l37.1440"></a><span id="l37.1440" class="difflineplus">+    );</span>
<a href="#l37.1441"></a><span id="l37.1441">     gApplyUsed = true;</span>
<a href="#l37.1442"></a><span id="l37.1442">   }</span>
<a href="#l37.1443"></a><span id="l37.1443"> }</span>
<a href="#l37.1444"></a><span id="l37.1444"> </span>
<a href="#l37.1445"></a><span id="l37.1445"> function Apply() {</span>
<a href="#l37.1446"></a><span id="l37.1446">   if (ValidateData()) {</span>
<a href="#l37.1447"></a><span id="l37.1447">     gActiveEditor.beginTransaction();</span>
<a href="#l37.1448"></a><span id="l37.1448"> </span>
<a href="#l37.1449"></a><span id="l37.1449">     ApplyTableAttributes();</span>
<a href="#l37.1450"></a><span id="l37.1450"> </span>
<a href="#l37.1451"></a><span id="l37.1451">     // We may have just a table, so check for cell element</span>
<a href="#l37.1452"></a><span id="l37.1452" class="difflineminus">-    if (globalCellElement)</span>
<a href="#l37.1453"></a><span id="l37.1453" class="difflineplus">+    if (globalCellElement) {</span>
<a href="#l37.1454"></a><span id="l37.1454">       ApplyCellAttributes();</span>
<a href="#l37.1455"></a><span id="l37.1455" class="difflineplus">+    }</span>
<a href="#l37.1456"></a><span id="l37.1456"> </span>
<a href="#l37.1457"></a><span id="l37.1457">     gActiveEditor.endTransaction();</span>
<a href="#l37.1458"></a><span id="l37.1458"> </span>
<a href="#l37.1459"></a><span id="l37.1459">     SetCloseButton();</span>
<a href="#l37.1460"></a><span id="l37.1460">     return true;</span>
<a href="#l37.1461"></a><span id="l37.1461">   }</span>
<a href="#l37.1462"></a><span id="l37.1462">   return false;</span>
<a href="#l37.1463"></a><span id="l37.1463"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/editor/ui/dialogs/content/EdTextAreaProps.js</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/editor/ui/dialogs/content/EdTextAreaProps.js</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -17,28 +17,28 @@ function Startup() {</span>
<a href="#l38.4"></a><span id="l38.4">   var editor = GetCurrentEditor();</span>
<a href="#l38.5"></a><span id="l38.5">   if (!editor) {</span>
<a href="#l38.6"></a><span id="l38.6">     dump(&quot;Failed to get active editor!\n&quot;);</span>
<a href="#l38.7"></a><span id="l38.7">     window.close();</span>
<a href="#l38.8"></a><span id="l38.8">     return;</span>
<a href="#l38.9"></a><span id="l38.9">   }</span>
<a href="#l38.10"></a><span id="l38.10"> </span>
<a href="#l38.11"></a><span id="l38.11">   gDialog = {</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-    accept:             document.documentElement.getButton(&quot;accept&quot;),</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineminus">-    textareaName:       document.getElementById(&quot;TextAreaName&quot;),</span>
<a href="#l38.14"></a><span id="l38.14" class="difflineminus">-    textareaRows:       document.getElementById(&quot;TextAreaRows&quot;),</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineminus">-    textareaCols:       document.getElementById(&quot;TextAreaCols&quot;),</span>
<a href="#l38.16"></a><span id="l38.16" class="difflineminus">-    textareaWrap:       document.getElementById(&quot;TextAreaWrap&quot;),</span>
<a href="#l38.17"></a><span id="l38.17" class="difflineminus">-    textareaReadOnly:   document.getElementById(&quot;TextAreaReadOnly&quot;),</span>
<a href="#l38.18"></a><span id="l38.18" class="difflineminus">-    textareaDisabled:   document.getElementById(&quot;TextAreaDisabled&quot;),</span>
<a href="#l38.19"></a><span id="l38.19" class="difflineminus">-    textareaTabIndex:   document.getElementById(&quot;TextAreaTabIndex&quot;),</span>
<a href="#l38.20"></a><span id="l38.20" class="difflineminus">-    textareaAccessKey:  document.getElementById(&quot;TextAreaAccessKey&quot;),</span>
<a href="#l38.21"></a><span id="l38.21" class="difflineminus">-    textareaValue:      document.getElementById(&quot;TextAreaValue&quot;),</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineminus">-    MoreSection:        document.getElementById(&quot;MoreSection&quot;),</span>
<a href="#l38.23"></a><span id="l38.23" class="difflineminus">-    MoreFewerButton:    document.getElementById(&quot;MoreFewerButton&quot;),</span>
<a href="#l38.24"></a><span id="l38.24" class="difflineplus">+    accept: document.documentElement.getButton(&quot;accept&quot;),</span>
<a href="#l38.25"></a><span id="l38.25" class="difflineplus">+    textareaName: document.getElementById(&quot;TextAreaName&quot;),</span>
<a href="#l38.26"></a><span id="l38.26" class="difflineplus">+    textareaRows: document.getElementById(&quot;TextAreaRows&quot;),</span>
<a href="#l38.27"></a><span id="l38.27" class="difflineplus">+    textareaCols: document.getElementById(&quot;TextAreaCols&quot;),</span>
<a href="#l38.28"></a><span id="l38.28" class="difflineplus">+    textareaWrap: document.getElementById(&quot;TextAreaWrap&quot;),</span>
<a href="#l38.29"></a><span id="l38.29" class="difflineplus">+    textareaReadOnly: document.getElementById(&quot;TextAreaReadOnly&quot;),</span>
<a href="#l38.30"></a><span id="l38.30" class="difflineplus">+    textareaDisabled: document.getElementById(&quot;TextAreaDisabled&quot;),</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineplus">+    textareaTabIndex: document.getElementById(&quot;TextAreaTabIndex&quot;),</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineplus">+    textareaAccessKey: document.getElementById(&quot;TextAreaAccessKey&quot;),</span>
<a href="#l38.33"></a><span id="l38.33" class="difflineplus">+    textareaValue: document.getElementById(&quot;TextAreaValue&quot;),</span>
<a href="#l38.34"></a><span id="l38.34" class="difflineplus">+    MoreSection: document.getElementById(&quot;MoreSection&quot;),</span>
<a href="#l38.35"></a><span id="l38.35" class="difflineplus">+    MoreFewerButton: document.getElementById(&quot;MoreFewerButton&quot;),</span>
<a href="#l38.36"></a><span id="l38.36">   };</span>
<a href="#l38.37"></a><span id="l38.37"> </span>
<a href="#l38.38"></a><span id="l38.38">   // Get a single selected text area element</span>
<a href="#l38.39"></a><span id="l38.39">   const kTagName = &quot;textarea&quot;;</span>
<a href="#l38.40"></a><span id="l38.40">   try {</span>
<a href="#l38.41"></a><span id="l38.41">     textareaElement = editor.getSelectedElement(kTagName);</span>
<a href="#l38.42"></a><span id="l38.42">   } catch (e) {}</span>
<a href="#l38.43"></a><span id="l38.43"> </span>
<a href="#l38.44"></a><span id="l38.44" class="difflineat">@@ -75,86 +75,97 @@ function Startup() {</span>
<a href="#l38.45"></a><span id="l38.45"> </span>
<a href="#l38.46"></a><span id="l38.46">   SetWindowLocation();</span>
<a href="#l38.47"></a><span id="l38.47"> }</span>
<a href="#l38.48"></a><span id="l38.48"> </span>
<a href="#l38.49"></a><span id="l38.49"> function InitDialog() {</span>
<a href="#l38.50"></a><span id="l38.50">   gDialog.textareaName.value = globalElement.getAttribute(&quot;name&quot;);</span>
<a href="#l38.51"></a><span id="l38.51">   gDialog.textareaRows.value = globalElement.getAttribute(&quot;rows&quot;);</span>
<a href="#l38.52"></a><span id="l38.52">   gDialog.textareaCols.value = globalElement.getAttribute(&quot;cols&quot;);</span>
<a href="#l38.53"></a><span id="l38.53" class="difflineminus">-  gDialog.textareaWrap.value = GetHTMLOrCSSStyleValue(globalElement, &quot;wrap&quot;, &quot;white-space&quot;);</span>
<a href="#l38.54"></a><span id="l38.54" class="difflineplus">+  gDialog.textareaWrap.value = GetHTMLOrCSSStyleValue(</span>
<a href="#l38.55"></a><span id="l38.55" class="difflineplus">+    globalElement,</span>
<a href="#l38.56"></a><span id="l38.56" class="difflineplus">+    &quot;wrap&quot;,</span>
<a href="#l38.57"></a><span id="l38.57" class="difflineplus">+    &quot;white-space&quot;</span>
<a href="#l38.58"></a><span id="l38.58" class="difflineplus">+  );</span>
<a href="#l38.59"></a><span id="l38.59">   gDialog.textareaReadOnly.checked = globalElement.hasAttribute(&quot;readonly&quot;);</span>
<a href="#l38.60"></a><span id="l38.60">   gDialog.textareaDisabled.checked = globalElement.hasAttribute(&quot;disabled&quot;);</span>
<a href="#l38.61"></a><span id="l38.61">   gDialog.textareaTabIndex.value = globalElement.getAttribute(&quot;tabindex&quot;);</span>
<a href="#l38.62"></a><span id="l38.62">   gDialog.textareaAccessKey.value = globalElement.getAttribute(&quot;accesskey&quot;);</span>
<a href="#l38.63"></a><span id="l38.63">   onInput();</span>
<a href="#l38.64"></a><span id="l38.64"> }</span>
<a href="#l38.65"></a><span id="l38.65"> </span>
<a href="#l38.66"></a><span id="l38.66"> function onInput() {</span>
<a href="#l38.67"></a><span id="l38.67" class="difflineminus">-  var disabled = !gDialog.textareaName.value || !gDialog.textareaRows.value || !gDialog.textareaCols.value;</span>
<a href="#l38.68"></a><span id="l38.68" class="difflineminus">-  if (gDialog.accept.disabled != disabled)</span>
<a href="#l38.69"></a><span id="l38.69" class="difflineplus">+  var disabled =</span>
<a href="#l38.70"></a><span id="l38.70" class="difflineplus">+    !gDialog.textareaName.value ||</span>
<a href="#l38.71"></a><span id="l38.71" class="difflineplus">+    !gDialog.textareaRows.value ||</span>
<a href="#l38.72"></a><span id="l38.72" class="difflineplus">+    !gDialog.textareaCols.value;</span>
<a href="#l38.73"></a><span id="l38.73" class="difflineplus">+  if (gDialog.accept.disabled != disabled) {</span>
<a href="#l38.74"></a><span id="l38.74">     gDialog.accept.disabled = disabled;</span>
<a href="#l38.75"></a><span id="l38.75" class="difflineplus">+  }</span>
<a href="#l38.76"></a><span id="l38.76"> }</span>
<a href="#l38.77"></a><span id="l38.77"> </span>
<a href="#l38.78"></a><span id="l38.78"> function ValidateData() {</span>
<a href="#l38.79"></a><span id="l38.79">   var attributes = {</span>
<a href="#l38.80"></a><span id="l38.80">     name: gDialog.textareaName.value,</span>
<a href="#l38.81"></a><span id="l38.81">     rows: gDialog.textareaRows.value,</span>
<a href="#l38.82"></a><span id="l38.82">     cols: gDialog.textareaCols.value,</span>
<a href="#l38.83"></a><span id="l38.83">     wrap: gDialog.textareaWrap.value,</span>
<a href="#l38.84"></a><span id="l38.84">     tabindex: gDialog.textareaTabIndex.value,</span>
<a href="#l38.85"></a><span id="l38.85">     accesskey: gDialog.textareaAccessKey.value,</span>
<a href="#l38.86"></a><span id="l38.86">   };</span>
<a href="#l38.87"></a><span id="l38.87">   var flags = {</span>
<a href="#l38.88"></a><span id="l38.88">     readonly: gDialog.textareaReadOnly.checked,</span>
<a href="#l38.89"></a><span id="l38.89">     disabled: gDialog.textareaDisabled.checked,</span>
<a href="#l38.90"></a><span id="l38.90">   };</span>
<a href="#l38.91"></a><span id="l38.91">   for (var a in attributes) {</span>
<a href="#l38.92"></a><span id="l38.92" class="difflineminus">-    if (attributes[a])</span>
<a href="#l38.93"></a><span id="l38.93" class="difflineplus">+    if (attributes[a]) {</span>
<a href="#l38.94"></a><span id="l38.94">       globalElement.setAttribute(a, attributes[a]);</span>
<a href="#l38.95"></a><span id="l38.95" class="difflineminus">-    else</span>
<a href="#l38.96"></a><span id="l38.96" class="difflineplus">+    } else {</span>
<a href="#l38.97"></a><span id="l38.97">       globalElement.removeAttribute(a);</span>
<a href="#l38.98"></a><span id="l38.98" class="difflineplus">+    }</span>
<a href="#l38.99"></a><span id="l38.99">   }</span>
<a href="#l38.100"></a><span id="l38.100">   for (var f in flags) {</span>
<a href="#l38.101"></a><span id="l38.101" class="difflineminus">-    if (flags[f])</span>
<a href="#l38.102"></a><span id="l38.102" class="difflineplus">+    if (flags[f]) {</span>
<a href="#l38.103"></a><span id="l38.103">       globalElement.setAttribute(f, &quot;&quot;);</span>
<a href="#l38.104"></a><span id="l38.104" class="difflineminus">-    else</span>
<a href="#l38.105"></a><span id="l38.105" class="difflineplus">+    } else {</span>
<a href="#l38.106"></a><span id="l38.106">       globalElement.removeAttribute(f);</span>
<a href="#l38.107"></a><span id="l38.107" class="difflineplus">+    }</span>
<a href="#l38.108"></a><span id="l38.108">   }</span>
<a href="#l38.109"></a><span id="l38.109">   return true;</span>
<a href="#l38.110"></a><span id="l38.110"> }</span>
<a href="#l38.111"></a><span id="l38.111"> </span>
<a href="#l38.112"></a><span id="l38.112"> function onAccept() {</span>
<a href="#l38.113"></a><span id="l38.113">   // All values are valid - copy to actual element in doc or</span>
<a href="#l38.114"></a><span id="l38.114">   //   element created to insert</span>
<a href="#l38.115"></a><span id="l38.115">   ValidateData();</span>
<a href="#l38.116"></a><span id="l38.116"> </span>
<a href="#l38.117"></a><span id="l38.117">   var editor = GetCurrentEditor();</span>
<a href="#l38.118"></a><span id="l38.118"> </span>
<a href="#l38.119"></a><span id="l38.119">   editor.beginTransaction();</span>
<a href="#l38.120"></a><span id="l38.120"> </span>
<a href="#l38.121"></a><span id="l38.121">   try {</span>
<a href="#l38.122"></a><span id="l38.122">     editor.cloneAttributes(textareaElement, globalElement);</span>
<a href="#l38.123"></a><span id="l38.123"> </span>
<a href="#l38.124"></a><span id="l38.124" class="difflineminus">-    if (insertNew)</span>
<a href="#l38.125"></a><span id="l38.125" class="difflineplus">+    if (insertNew) {</span>
<a href="#l38.126"></a><span id="l38.126">       editor.insertElementAtSelection(textareaElement, true);</span>
<a href="#l38.127"></a><span id="l38.127" class="difflineplus">+    }</span>
<a href="#l38.128"></a><span id="l38.128"> </span>
<a href="#l38.129"></a><span id="l38.129">     // undoably set value</span>
<a href="#l38.130"></a><span id="l38.130">     var initialText = gDialog.textareaValue.value;</span>
<a href="#l38.131"></a><span id="l38.131">     if (initialText != textareaElement.value) {</span>
<a href="#l38.132"></a><span id="l38.132">       editor.setShouldTxnSetSelection(false);</span>
<a href="#l38.133"></a><span id="l38.133"> </span>
<a href="#l38.134"></a><span id="l38.134" class="difflineminus">-      while (textareaElement.hasChildNodes())</span>
<a href="#l38.135"></a><span id="l38.135" class="difflineplus">+      while (textareaElement.hasChildNodes()) {</span>
<a href="#l38.136"></a><span id="l38.136">         editor.deleteNode(textareaElement.lastChild);</span>
<a href="#l38.137"></a><span id="l38.137" class="difflineplus">+      }</span>
<a href="#l38.138"></a><span id="l38.138">       if (initialText) {</span>
<a href="#l38.139"></a><span id="l38.139">         var textNode = editor.document.createTextNode(initialText);</span>
<a href="#l38.140"></a><span id="l38.140">         editor.insertNode(textNode, textareaElement, 0);</span>
<a href="#l38.141"></a><span id="l38.141">       }</span>
<a href="#l38.142"></a><span id="l38.142"> </span>
<a href="#l38.143"></a><span id="l38.143">       editor.setShouldTxnSetSelection(true);</span>
<a href="#l38.144"></a><span id="l38.144">     }</span>
<a href="#l38.145"></a><span id="l38.145">   } finally {</span>
<a href="#l38.146"></a><span id="l38.146">     editor.endTransaction();</span>
<a href="#l38.147"></a><span id="l38.147">   }</span>
<a href="#l38.148"></a><span id="l38.148"> </span>
<a href="#l38.149"></a><span id="l38.149">   SaveWindowLocation();</span>
<a href="#l38.150"></a><span id="l38.150"> }</span>
<a href="#l38.151"></a><span id="l38.151" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/editor/ui/nsComposerCmdLineHandler.js</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/editor/ui/nsComposerCmdLineHandler.js</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -1,53 +1,62 @@</span>
<a href="#l39.4"></a><span id="l39.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l39.5"></a><span id="l39.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l39.6"></a><span id="l39.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l39.7"></a><span id="l39.7"> </span>
<a href="#l39.8"></a><span id="l39.8" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l39.9"></a><span id="l39.9" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l39.10"></a><span id="l39.10" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l39.11"></a><span id="l39.11" class="difflineplus">+var { XPCOMUtils } = ChromeUtils.import(</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineplus">+  &quot;resource://gre/modules/XPCOMUtils.jsm&quot;</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineplus">+);</span>
<a href="#l39.14"></a><span id="l39.14"> </span>
<a href="#l39.15"></a><span id="l39.15"> const nsICommandLineHandler = Ci.nsICommandLineHandler;</span>
<a href="#l39.16"></a><span id="l39.16" class="difflineminus">-const nsISupportsString     = Ci.nsISupportsString;</span>
<a href="#l39.17"></a><span id="l39.17" class="difflineminus">-const nsIWindowWatcher      = Ci.nsIWindowWatcher;</span>
<a href="#l39.18"></a><span id="l39.18" class="difflineplus">+const nsISupportsString = Ci.nsISupportsString;</span>
<a href="#l39.19"></a><span id="l39.19" class="difflineplus">+const nsIWindowWatcher = Ci.nsIWindowWatcher;</span>
<a href="#l39.20"></a><span id="l39.20"> </span>
<a href="#l39.21"></a><span id="l39.21"> function nsComposerCmdLineHandler() {}</span>
<a href="#l39.22"></a><span id="l39.22"> nsComposerCmdLineHandler.prototype = {</span>
<a href="#l39.23"></a><span id="l39.23">   get wrappedJSObject() {</span>
<a href="#l39.24"></a><span id="l39.24">     return this;</span>
<a href="#l39.25"></a><span id="l39.25">   },</span>
<a href="#l39.26"></a><span id="l39.26"> </span>
<a href="#l39.27"></a><span id="l39.27">   /* nsISupports */</span>
<a href="#l39.28"></a><span id="l39.28">   QueryInterface: ChromeUtils.generateQI([nsICommandLineHandler]),</span>
<a href="#l39.29"></a><span id="l39.29"> </span>
<a href="#l39.30"></a><span id="l39.30">   /* nsICommandLineHandler */</span>
<a href="#l39.31"></a><span id="l39.31">   handle(cmdLine) {</span>
<a href="#l39.32"></a><span id="l39.32" class="difflineminus">-    var args = Cc[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l39.33"></a><span id="l39.33" class="difflineminus">-                 .createInstance(nsISupportsString);</span>
<a href="#l39.34"></a><span id="l39.34" class="difflineplus">+    var args = Cc[&quot;@mozilla.org/supports-string;1&quot;].createInstance(</span>
<a href="#l39.35"></a><span id="l39.35" class="difflineplus">+      nsISupportsString</span>
<a href="#l39.36"></a><span id="l39.36" class="difflineplus">+    );</span>
<a href="#l39.37"></a><span id="l39.37">     try {</span>
<a href="#l39.38"></a><span id="l39.38">       var uristr = cmdLine.handleFlagWithParam(&quot;edit&quot;, false);</span>
<a href="#l39.39"></a><span id="l39.39">       if (uristr == null) {</span>
<a href="#l39.40"></a><span id="l39.40">         // Try the editor flag (used for general.startup.* prefs)</span>
<a href="#l39.41"></a><span id="l39.41">         uristr = cmdLine.handleFlagWithParam(&quot;editor&quot;, false);</span>
<a href="#l39.42"></a><span id="l39.42" class="difflineminus">-        if (uristr == null)</span>
<a href="#l39.43"></a><span id="l39.43" class="difflineplus">+        if (uristr == null) {</span>
<a href="#l39.44"></a><span id="l39.44">           return;</span>
<a href="#l39.45"></a><span id="l39.45" class="difflineplus">+        }</span>
<a href="#l39.46"></a><span id="l39.46">       }</span>
<a href="#l39.47"></a><span id="l39.47"> </span>
<a href="#l39.48"></a><span id="l39.48">       try {</span>
<a href="#l39.49"></a><span id="l39.49">         args.data = cmdLine.resolveURI(uristr).spec;</span>
<a href="#l39.50"></a><span id="l39.50">       } catch (e) {</span>
<a href="#l39.51"></a><span id="l39.51">         return;</span>
<a href="#l39.52"></a><span id="l39.52">       }</span>
<a href="#l39.53"></a><span id="l39.53">     } catch (e) {</span>
<a href="#l39.54"></a><span id="l39.54">       // One of the flags is present but no data, so set default arg.</span>
<a href="#l39.55"></a><span id="l39.55">       args.data = &quot;about:blank&quot;;</span>
<a href="#l39.56"></a><span id="l39.56">     }</span>
<a href="#l39.57"></a><span id="l39.57"> </span>
<a href="#l39.58"></a><span id="l39.58" class="difflineminus">-    Services.ww.openWindow(null, &quot;chrome://editor/content&quot;, &quot;_blank&quot;,</span>
<a href="#l39.59"></a><span id="l39.59" class="difflineminus">-                           &quot;chrome,dialog=no,all&quot;, args);</span>
<a href="#l39.60"></a><span id="l39.60" class="difflineplus">+    Services.ww.openWindow(</span>
<a href="#l39.61"></a><span id="l39.61" class="difflineplus">+      null,</span>
<a href="#l39.62"></a><span id="l39.62" class="difflineplus">+      &quot;chrome://editor/content&quot;,</span>
<a href="#l39.63"></a><span id="l39.63" class="difflineplus">+      &quot;_blank&quot;,</span>
<a href="#l39.64"></a><span id="l39.64" class="difflineplus">+      &quot;chrome,dialog=no,all&quot;,</span>
<a href="#l39.65"></a><span id="l39.65" class="difflineplus">+      args</span>
<a href="#l39.66"></a><span id="l39.66" class="difflineplus">+    );</span>
<a href="#l39.67"></a><span id="l39.67">     cmdLine.preventDefault = true;</span>
<a href="#l39.68"></a><span id="l39.68">   },</span>
<a href="#l39.69"></a><span id="l39.69"> </span>
<a href="#l39.70"></a><span id="l39.70">   helpInfo: &quot;  -edit &lt;url&gt;        Open Composer.\n&quot;,</span>
<a href="#l39.71"></a><span id="l39.71"> </span>
<a href="#l39.72"></a><span id="l39.72">   /* XPCOMUtils */</span>
<a href="#l39.73"></a><span id="l39.73">   classID: Components.ID(&quot;{f7d8db95-ab5d-4393-a796-9112fe758cfa}&quot;),</span>
<a href="#l39.74"></a><span id="l39.74"> };</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

