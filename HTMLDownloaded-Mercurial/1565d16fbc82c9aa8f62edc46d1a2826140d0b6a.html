<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 14494:1565d16fbc82c9aa8f62edc46d1a2826140d0b6a</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 1565d16fbc82c9aa8f62edc46d1a2826140d0b6a" />
<meta property="og:url" content="/comm-central/rev/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a" />
<meta property="og:description" content="Bug 954133 - Provide a way to merge buddies into contacts, part 3: conversations handling changes." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 1565d16fbc82c9aa8f62edc46d1a2826140d0b6a 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a">shortlog</a> |
<a href="/comm-central/log/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a">files</a> |
changeset |
<a href="/comm-central/raw-rev/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a">raw</a>  | <a href="/comm-central/archive/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=954133">Bug 954133</a> - Provide a way to merge buddies into contacts, part 3: conversations handling changes.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#70;&#108;&#111;&#114;&#105;&#97;&#110;&#32;&#81;&#117;&#232;&#122;&#101;&#32;&#60;&#102;&#108;&#111;&#114;&#105;&#97;&#110;&#64;&#105;&#110;&#115;&#116;&#97;&#110;&#116;&#98;&#105;&#114;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 28 Mar 2011 22:30:31 +0200</td></tr>

<tr>
 <td>changeset 14494</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a">1565d16fbc82c9aa8f62edc46d1a2826140d0b6a</a></td>
</tr>



<tr>
<td>parent 14493</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/67244f867eae9ad68a76af20748fbec750c7a2ce">67244f867eae9ad68a76af20748fbec750c7a2ce</a>
</td>
</tr>

<tr>
<td>child 14495</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ac888c1bac5e941dcd21fb2be77c79ac262cc924">ac888c1bac5e941dcd21fb2be77c79ac262cc924</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=1565d16fbc82c9aa8f62edc46d1a2826140d0b6a">9778</a></td></tr>
<tr><td>push user</td><td>florian@queze.net</td></tr>
<tr><td>push date</td><td class="date age">Sun, 12 Jan 2014 18:25:45 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@f81a23bfefcd [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=954133">954133</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=954133">Bug 954133</a> - Provide a way to merge buddies into contacts, part 3: conversations handling changes.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/content/buddy.xml">im/content/buddy.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/content/buddy.xml">file</a> |
<a href="/comm-central/annotate/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/content/buddy.xml">annotate</a> |
<a href="/comm-central/diff/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/content/buddy.xml">diff</a> |
<a href="/comm-central/comparison/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/content/buddy.xml">comparison</a> |
<a href="/comm-central/log/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/content/buddy.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/content/conversation.xml">im/content/conversation.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/content/conversation.xml">file</a> |
<a href="/comm-central/annotate/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/content/conversation.xml">annotate</a> |
<a href="/comm-central/diff/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/content/conversation.xml">diff</a> |
<a href="/comm-central/comparison/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/content/conversation.xml">comparison</a> |
<a href="/comm-central/log/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/content/conversation.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/installer/package-manifest.in">im/installer/package-manifest.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/installer/package-manifest.in">file</a> |
<a href="/comm-central/annotate/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/installer/package-manifest.in">annotate</a> |
<a href="/comm-central/diff/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/installer/package-manifest.in">diff</a> |
<a href="/comm-central/comparison/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/installer/package-manifest.in">comparison</a> |
<a href="/comm-central/log/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/installer/package-manifest.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/modules/Makefile.in">im/modules/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/modules/Makefile.in">file</a> |
<a href="/comm-central/annotate/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/modules/Makefile.in">annotate</a> |
<a href="/comm-central/diff/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/modules/Makefile.in">diff</a> |
<a href="/comm-central/comparison/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/modules/Makefile.in">comparison</a> |
<a href="/comm-central/log/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/modules/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/modules/ibCore.jsm">im/modules/ibCore.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/modules/ibCore.jsm">file</a> |
<a href="/comm-central/annotate/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/modules/ibCore.jsm">annotate</a> |
<a href="/comm-central/diff/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/modules/ibCore.jsm">diff</a> |
<a href="/comm-central/comparison/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/modules/ibCore.jsm">comparison</a> |
<a href="/comm-central/log/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/modules/ibCore.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/modules/imServices.jsm">im/modules/imServices.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/modules/imServices.jsm">file</a> |
<a href="/comm-central/annotate/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/modules/imServices.jsm">annotate</a> |
<a href="/comm-central/diff/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/modules/imServices.jsm">diff</a> |
<a href="/comm-central/comparison/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/modules/imServices.jsm">comparison</a> |
<a href="/comm-central/log/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/modules/imServices.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/modules/imWindows.jsm">im/modules/imWindows.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/modules/imWindows.jsm">file</a> |
<a href="/comm-central/annotate/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/modules/imWindows.jsm">annotate</a> |
<a href="/comm-central/diff/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/modules/imWindows.jsm">diff</a> |
<a href="/comm-central/comparison/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/modules/imWindows.jsm">comparison</a> |
<a href="/comm-central/log/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/im/modules/imWindows.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/locales/en-US/conversations.properties">purple/locales/en-US/conversations.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/locales/en-US/conversations.properties">file</a> |
<a href="/comm-central/annotate/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/locales/en-US/conversations.properties">annotate</a> |
<a href="/comm-central/diff/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/locales/en-US/conversations.properties">diff</a> |
<a href="/comm-central/comparison/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/locales/en-US/conversations.properties">comparison</a> |
<a href="/comm-central/log/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/locales/en-US/conversations.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/purplexpcom/public/imIConversationsService.idl">purple/purplexpcom/public/imIConversationsService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/purplexpcom/public/imIConversationsService.idl">file</a> |
<a href="/comm-central/annotate/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/purplexpcom/public/imIConversationsService.idl">annotate</a> |
<a href="/comm-central/diff/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/purplexpcom/public/imIConversationsService.idl">diff</a> |
<a href="/comm-central/comparison/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/purplexpcom/public/imIConversationsService.idl">comparison</a> |
<a href="/comm-central/log/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/purplexpcom/public/imIConversationsService.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/purplexpcom/src/imContacts.js">purple/purplexpcom/src/imContacts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/purplexpcom/src/imContacts.js">file</a> |
<a href="/comm-central/annotate/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/purplexpcom/src/imContacts.js">annotate</a> |
<a href="/comm-central/diff/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/purplexpcom/src/imContacts.js">diff</a> |
<a href="/comm-central/comparison/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/purplexpcom/src/imContacts.js">comparison</a> |
<a href="/comm-central/log/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/purplexpcom/src/imContacts.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/purplexpcom/src/imConversations.js">purple/purplexpcom/src/imConversations.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/purplexpcom/src/imConversations.js">file</a> |
<a href="/comm-central/annotate/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/purplexpcom/src/imConversations.js">annotate</a> |
<a href="/comm-central/diff/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/purplexpcom/src/imConversations.js">diff</a> |
<a href="/comm-central/comparison/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/purplexpcom/src/imConversations.js">comparison</a> |
<a href="/comm-central/log/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/purplexpcom/src/imConversations.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/purplexpcom/src/imConversations.manifest">purple/purplexpcom/src/imConversations.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/purplexpcom/src/imConversations.manifest">file</a> |
<a href="/comm-central/annotate/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/purplexpcom/src/imConversations.manifest">annotate</a> |
<a href="/comm-central/diff/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/purplexpcom/src/imConversations.manifest">diff</a> |
<a href="/comm-central/comparison/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/purplexpcom/src/imConversations.manifest">comparison</a> |
<a href="/comm-central/log/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/purplexpcom/src/imConversations.manifest">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/purplexpcom/src/jsProtoHelper.jsm">purple/purplexpcom/src/jsProtoHelper.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/purplexpcom/src/jsProtoHelper.jsm">file</a> |
<a href="/comm-central/annotate/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/purplexpcom/src/jsProtoHelper.jsm">annotate</a> |
<a href="/comm-central/diff/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/purplexpcom/src/jsProtoHelper.jsm">diff</a> |
<a href="/comm-central/comparison/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/purplexpcom/src/jsProtoHelper.jsm">comparison</a> |
<a href="/comm-central/log/1565d16fbc82c9aa8f62edc46d1a2826140d0b6a/purple/purplexpcom/src/jsProtoHelper.jsm">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/im/content/buddy.xml</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/im/content/buddy.xml</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -181,16 +181,18 @@</span>
<a href="#l1.4"></a><span id="l1.4">          return this.buddy.canSendMessage;</span>
<a href="#l1.5"></a><span id="l1.5">        ]]&gt;</span>
<a href="#l1.6"></a><span id="l1.6">       &lt;/body&gt;</span>
<a href="#l1.7"></a><span id="l1.7">      &lt;/method&gt;</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9">      &lt;method name=&quot;openConversation&quot;&gt;</span>
<a href="#l1.10"></a><span id="l1.10">       &lt;body&gt;</span>
<a href="#l1.11"></a><span id="l1.11">        &lt;![CDATA[</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+         if (!(&quot;Conversations&quot; in window))</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+           Components.utils.import(&quot;resource:///modules/imWindows.jsm&quot;);</span>
<a href="#l1.14"></a><span id="l1.14">          Conversations.focusConversation(this.buddy.createConversation());</span>
<a href="#l1.15"></a><span id="l1.15">        ]]&gt;</span>
<a href="#l1.16"></a><span id="l1.16">       &lt;/body&gt;</span>
<a href="#l1.17"></a><span id="l1.17">      &lt;/method&gt;</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19">      &lt;method name=&quot;_DragOk&quot;&gt;</span>
<a href="#l1.20"></a><span id="l1.20">       &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l1.21"></a><span id="l1.21">       &lt;body&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/im/content/conversation.xml</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/im/content/conversation.xml</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -236,16 +236,21 @@</span>
<a href="#l2.4"></a><span id="l2.4">           let color;</span>
<a href="#l2.5"></a><span id="l2.5">           if (this.buddies.hasOwnProperty(name))</span>
<a href="#l2.6"></a><span id="l2.6">             color = this.buddies[name].color;</span>
<a href="#l2.7"></a><span id="l2.7">           else</span>
<a href="#l2.8"></a><span id="l2.8">             color = this._computeColor(name);</span>
<a href="#l2.9"></a><span id="l2.9">           aMsg.color = &quot;color: hsl(&quot; + color + &quot;, 100%, 40%);&quot;;</span>
<a href="#l2.10"></a><span id="l2.10">         }</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+        if (aMsg.incoming &amp;&amp; !aMsg.system &amp;&amp;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+            (!aMsg.conversation.isChat || aMsg.containsNick) &amp;&amp;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+            Services.prefs.getBoolPref(&quot;messenger.options.getAttentionOnNewMessages&quot;))</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+          window.getAttention();</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+</span>
<a href="#l2.17"></a><span id="l2.17">         this.browser.appendMessage(aMsg);</span>
<a href="#l2.18"></a><span id="l2.18">         if (this.tab &amp;&amp; aMsg.incoming &amp;&amp; !aMsg.system &amp;&amp;</span>
<a href="#l2.19"></a><span id="l2.19">             (!this.tab.selected || !document.hasFocus())) {</span>
<a href="#l2.20"></a><span id="l2.20">           if (conv.isChat &amp;&amp; aMsg.containsNick)</span>
<a href="#l2.21"></a><span id="l2.21">             this.tab.setAttribute(&quot;attention&quot;, &quot;true&quot;);</span>
<a href="#l2.22"></a><span id="l2.22">           else</span>
<a href="#l2.23"></a><span id="l2.23">             this.tab.setAttribute(&quot;unread&quot;, &quot;true&quot;);</span>
<a href="#l2.24"></a><span id="l2.24">         }</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineat">@@ -1044,29 +1049,31 @@</span>
<a href="#l2.26"></a><span id="l2.26">            setTimeout(function(aSelf) { aSelf._emptyMessageQueue(); }, 0, this);</span>
<a href="#l2.27"></a><span id="l2.27"> </span>
<a href="#l2.28"></a><span id="l2.28">            Services.obs.removeObserver(this, &quot;conversation-loaded&quot;);</span>
<a href="#l2.29"></a><span id="l2.29">            return;</span>
<a href="#l2.30"></a><span id="l2.30">          }</span>
<a href="#l2.31"></a><span id="l2.31"> </span>
<a href="#l2.32"></a><span id="l2.32">          switch(aTopic) {</span>
<a href="#l2.33"></a><span id="l2.33">          case &quot;new-text&quot;:</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-           if (this.loaded)</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-             this._addMsg(aSubject);</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+           this.addMsg(aSubject);</span>
<a href="#l2.37"></a><span id="l2.37">            break;</span>
<a href="#l2.38"></a><span id="l2.38"> </span>
<a href="#l2.39"></a><span id="l2.39">          case &quot;update-typing&quot;:</span>
<a href="#l2.40"></a><span id="l2.40">            this.updateTyping();</span>
<a href="#l2.41"></a><span id="l2.41">            break;</span>
<a href="#l2.42"></a><span id="l2.42"> </span>
<a href="#l2.43"></a><span id="l2.43">          case &quot;update-buddy-status&quot;:</span>
<a href="#l2.44"></a><span id="l2.44">          case &quot;update-conv-chatleft&quot;:</span>
<a href="#l2.45"></a><span id="l2.45">            this.updateConvStatus();</span>
<a href="#l2.46"></a><span id="l2.46">            break;</span>
<a href="#l2.47"></a><span id="l2.47"> </span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+         case &quot;target-purple-conversation-changed&quot;:</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+           this.updateConvStatus();</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+           // We want to update the tab title too, so no 'break' here.</span>
<a href="#l2.51"></a><span id="l2.51">          case &quot;update-conv-title&quot;:</span>
<a href="#l2.52"></a><span id="l2.52">            if (this.tab)</span>
<a href="#l2.53"></a><span id="l2.53">              this.tab.setAttribute(&quot;label&quot;, this.conv.title);</span>
<a href="#l2.54"></a><span id="l2.54">            break;</span>
<a href="#l2.55"></a><span id="l2.55"> </span>
<a href="#l2.56"></a><span id="l2.56">          case &quot;chat-buddy-add&quot;:</span>
<a href="#l2.57"></a><span id="l2.57">            aSubject.QueryInterface(Ci.nsISimpleEnumerator);</span>
<a href="#l2.58"></a><span id="l2.58">            while (aSubject.hasMoreElements())</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/im/installer/package-manifest.in</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/im/installer/package-manifest.in</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -401,16 +401,18 @@</span>
<a href="#l3.4"></a><span id="l3.4"> ; [libpurple]</span>
<a href="#l3.5"></a><span id="l3.5"> @BINPATH@/@DLL_PREFIX@purple@DLL_SUFFIX@</span>
<a href="#l3.6"></a><span id="l3.6"> @BINPATH@/components/@DLL_PREFIX@purplexpcom@DLL_SUFFIX@</span>
<a href="#l3.7"></a><span id="l3.7"> @BINPATH@/components/purplexpcom.xpt</span>
<a href="#l3.8"></a><span id="l3.8"> @BINPATH@/components/imCommands.js</span>
<a href="#l3.9"></a><span id="l3.9"> @BINPATH@/components/imCommands.manifest</span>
<a href="#l3.10"></a><span id="l3.10"> @BINPATH@/components/imContacts.js</span>
<a href="#l3.11"></a><span id="l3.11"> @BINPATH@/components/imContacts.manifest</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+@BINPATH@/components/imConversations.js</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+@BINPATH@/components/imConversations.manifest</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15"> #ifdef XP_MACOSX</span>
<a href="#l3.16"></a><span id="l3.16"> @BINPATH@/components/ibDockBadge.js</span>
<a href="#l3.17"></a><span id="l3.17"> @BINPATH@/components/ibDockBadge.manifest</span>
<a href="#l3.18"></a><span id="l3.18"> #else</span>
<a href="#l3.19"></a><span id="l3.19"> @BINPATH@/components/profileMigrator.js</span>
<a href="#l3.20"></a><span id="l3.20"> @BINPATH@/components/profileMigrator.manifest</span>
<a href="#l3.21"></a><span id="l3.21"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/im/modules/Makefile.in</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/im/modules/Makefile.in</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -43,17 +43,17 @@ include $(DEPTH)/config/autoconf.mk</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> EXTRA_JS_MODULES = \</span>
<a href="#l4.6"></a><span id="l4.6"> 	ibCore.jsm \</span>
<a href="#l4.7"></a><span id="l4.7"> 	ibNotifications.jsm \</span>
<a href="#l4.8"></a><span id="l4.8"> 	imContentSink.jsm \</span>
<a href="#l4.9"></a><span id="l4.9"> 	imServices.jsm \</span>
<a href="#l4.10"></a><span id="l4.10"> 	imSmileys.jsm \</span>
<a href="#l4.11"></a><span id="l4.11"> 	imStatusUtils.jsm \</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+	imWindows.jsm \</span>
<a href="#l4.13"></a><span id="l4.13"> 	$(NULL)</span>
<a href="#l4.14"></a><span id="l4.14"> </span>
<a href="#l4.15"></a><span id="l4.15"> EXTRA_PP_JS_MODULES = \</span>
<a href="#l4.16"></a><span id="l4.16"> 	imThemes.jsm \</span>
<a href="#l4.17"></a><span id="l4.17"> 	imTextboxUtils.jsm \</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-	imWindows.jsm \</span>
<a href="#l4.19"></a><span id="l4.19"> 	$(NULL)</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21"> include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/im/modules/ibCore.jsm</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/im/modules/ibCore.jsm</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -108,16 +108,17 @@ var Core = {</span>
<a href="#l5.4"></a><span id="l5.4">         priority: Ci.imICommand.PRIORITY_HIGH,</span>
<a href="#l5.5"></a><span id="l5.5">         run: function(aMsg) {</span>
<a href="#l5.6"></a><span id="l5.6">           Services.core.setStatus(statusValue, aMsg);</span>
<a href="#l5.7"></a><span id="l5.7">           return true;</span>
<a href="#l5.8"></a><span id="l5.8">         }</span>
<a href="#l5.9"></a><span id="l5.9">       });</span>
<a href="#l5.10"></a><span id="l5.10">     }</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+    Services.conversations.initConversations();</span>
<a href="#l5.13"></a><span id="l5.13">     Conversations.init();</span>
<a href="#l5.14"></a><span id="l5.14">     Notifications.init();</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16">     this._events.forEach(function (aTopic) {</span>
<a href="#l5.17"></a><span id="l5.17">       Services.obs.addObserver(Core, aTopic, false);</span>
<a href="#l5.18"></a><span id="l5.18">     });</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20">     this._showAccountManagerIfNeeded(true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/im/modules/imServices.jsm</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/im/modules/imServices.jsm</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -44,14 +44,17 @@ XPCOMUtils.defineLazyServiceGetter(Servi</span>
<a href="#l6.4"></a><span id="l6.4">                                    &quot;@instantbird.org/purple/core;1&quot;,</span>
<a href="#l6.5"></a><span id="l6.5">                                    &quot;purpleICoreService&quot;);</span>
<a href="#l6.6"></a><span id="l6.6"> XPCOMUtils.defineLazyServiceGetter(Services, &quot;cmd&quot;,</span>
<a href="#l6.7"></a><span id="l6.7">                                    &quot;@instantbird.org/purple/commands-service;1&quot;,</span>
<a href="#l6.8"></a><span id="l6.8">                                    &quot;imICommandsService&quot;);</span>
<a href="#l6.9"></a><span id="l6.9"> XPCOMUtils.defineLazyServiceGetter(Services, &quot;contacts&quot;,</span>
<a href="#l6.10"></a><span id="l6.10">                                    &quot;@instantbird.org/purple/contacts-service;1&quot;,</span>
<a href="#l6.11"></a><span id="l6.11">                                    &quot;imIContactsService&quot;);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(Services, &quot;conversations&quot;,</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+                                   &quot;@instantbird.org/purple/conversations-service;1&quot;,</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+                                   &quot;imIConversationsService&quot;);</span>
<a href="#l6.15"></a><span id="l6.15"> XPCOMUtils.defineLazyServiceGetter(Services, &quot;tags&quot;,</span>
<a href="#l6.16"></a><span id="l6.16">                                    &quot;@instantbird.org/purple/tags-service;1&quot;,</span>
<a href="#l6.17"></a><span id="l6.17">                                    &quot;imITagsService&quot;);</span>
<a href="#l6.18"></a><span id="l6.18"> XPCOMUtils.defineLazyServiceGetter(Services, &quot;logs&quot;,</span>
<a href="#l6.19"></a><span id="l6.19">                                    &quot;@instantbird.org/logger;1&quot;,</span>
<a href="#l6.20"></a><span id="l6.20">                                    &quot;ibILogger&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/im/modules/imWindows.jsm</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/im/modules/imWindows.jsm</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -45,66 +45,67 @@ var Conversations = {</span>
<a href="#l7.4"></a><span id="l7.4">   get unreadCount() this._unreadCount,</span>
<a href="#l7.5"></a><span id="l7.5">   set unreadCount(val) {</span>
<a href="#l7.6"></a><span id="l7.6">     if (val == this._unreadCount)</span>
<a href="#l7.7"></a><span id="l7.7">       return val;</span>
<a href="#l7.8"></a><span id="l7.8">     Services.obs.notifyObservers(null, &quot;unread-im-count-changed&quot;, val);</span>
<a href="#l7.9"></a><span id="l7.9">     return (this._unreadCount = val);</span>
<a href="#l7.10"></a><span id="l7.10">   },</span>
<a href="#l7.11"></a><span id="l7.11">   _windows: [],</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  _getAttentionPrefName: &quot;messenger.options.getAttentionOnNewMessages&quot;,</span>
<a href="#l7.13"></a><span id="l7.13">   registerWindow: function(aWindow) {</span>
<a href="#l7.14"></a><span id="l7.14">     if (this._windows.indexOf(aWindow) == -1)</span>
<a href="#l7.15"></a><span id="l7.15">       this._windows.unshift(aWindow);</span>
<a href="#l7.16"></a><span id="l7.16"> </span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-    if (this._pendingNotifications) {</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+    if (this._pendingConversations) {</span>
<a href="#l7.19"></a><span id="l7.19">       // Cache in a variable and delete the existing notification array</span>
<a href="#l7.20"></a><span id="l7.20">       // before redispatching the notifications so that the observe</span>
<a href="#l7.21"></a><span id="l7.21">       // method can recreate it.</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-      let notifications = this._pendingNotifications;</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-      delete this._pendingNotifications;</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-      notifications.forEach(function(aNotif) {</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-        this.observe(aNotif.object, aNotif.topic, aNotif.msg);</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-      }, this);</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+      let notifications = this._pendingConversations;</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+      this._pendingConversations = null;</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+      for each (let conv in notifications)</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+        this.observe(conv, &quot;new-ui-conversation&quot;);</span>
<a href="#l7.31"></a><span id="l7.31">     }</span>
<a href="#l7.32"></a><span id="l7.32">   },</span>
<a href="#l7.33"></a><span id="l7.33">   unregisterWindow: function(aWindow) {</span>
<a href="#l7.34"></a><span id="l7.34">     let index = this._windows.indexOf(aWindow);</span>
<a href="#l7.35"></a><span id="l7.35">     if (index != -1)</span>
<a href="#l7.36"></a><span id="l7.36">       this._windows.splice(index, 1);</span>
<a href="#l7.37"></a><span id="l7.37">   },</span>
<a href="#l7.38"></a><span id="l7.38"> </span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-  _purpleConv: {},</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+  _uiConv: {},</span>
<a href="#l7.41"></a><span id="l7.41">   _conversations: [],</span>
<a href="#l7.42"></a><span id="l7.42">   registerConversation: function(aConversation) {</span>
<a href="#l7.43"></a><span id="l7.43">     if (this._conversations.indexOf(aConversation) == -1)</span>
<a href="#l7.44"></a><span id="l7.44">       this._conversations.push(aConversation);</span>
<a href="#l7.45"></a><span id="l7.45"> </span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-    this._purpleConv[aConversation.conv.id] = aConversation;</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+    this._uiConv[aConversation.conv.id] = aConversation;</span>
<a href="#l7.48"></a><span id="l7.48">   },</span>
<a href="#l7.49"></a><span id="l7.49">   unregisterConversation: function(aConversation) {</span>
<a href="#l7.50"></a><span id="l7.50">     let index = this._conversations.indexOf(aConversation);</span>
<a href="#l7.51"></a><span id="l7.51">     if (index != -1)</span>
<a href="#l7.52"></a><span id="l7.52">       this._conversations.splice(index, 1);</span>
<a href="#l7.53"></a><span id="l7.53"> </span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-    if (this._purpleConv[aConversation.conv.id] == aConversation)</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-      delete this._purpleConv[aConversation.conv.id];</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+    if (this._uiConv[aConversation.conv.id] == aConversation)</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+      delete this._uiConv[aConversation.conv.id];</span>
<a href="#l7.58"></a><span id="l7.58">   },</span>
<a href="#l7.59"></a><span id="l7.59"> </span>
<a href="#l7.60"></a><span id="l7.60">   isConversationWindowFocused: function()</span>
<a href="#l7.61"></a><span id="l7.61">     this._windows.length &gt; 0 &amp;&amp; this._windows[0].document.hasFocus(),</span>
<a href="#l7.62"></a><span id="l7.62">   focusConversation: function(aConv) {</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-    let id = aConv.id;</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-    if (id in this._purpleConv) {</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-      let conv = this._purpleConv[id];</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+    let uiConv = Services.conversations.getUIConversation(aConv);</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+    uiConv.target = aConv;</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+    let id = uiConv.id;</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+    if (id in this._uiConv) {</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+      let conv = this._uiConv[id];</span>
<a href="#l7.71"></a><span id="l7.71">       let doc = conv.ownerDocument;</span>
<a href="#l7.72"></a><span id="l7.72">       doc.getElementById(&quot;conversations&quot;).selectedTab = conv.tab;</span>
<a href="#l7.73"></a><span id="l7.73">       conv.focus();</span>
<a href="#l7.74"></a><span id="l7.74">       doc.defaultView.focus();</span>
<a href="#l7.75"></a><span id="l7.75">     }</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+    return uiConv;</span>
<a href="#l7.77"></a><span id="l7.77">   },</span>
<a href="#l7.78"></a><span id="l7.78"> </span>
<a href="#l7.79"></a><span id="l7.79">   get unreadConvsCount() {</span>
<a href="#l7.80"></a><span id="l7.80">     return this._conversations.filter(function(conv) {</span>
<a href="#l7.81"></a><span id="l7.81">       let tab = conv.tab;</span>
<a href="#l7.82"></a><span id="l7.82">       return tab.hasAttribute(&quot;unread&quot;) &amp;&amp;</span>
<a href="#l7.83"></a><span id="l7.83">              (!tab.hasAttribute(&quot;chat&quot;) || tab.hasAttribute(&quot;attention&quot;));</span>
<a href="#l7.84"></a><span id="l7.84">     }).length;</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineat">@@ -117,60 +118,48 @@ var Conversations = {</span>
<a href="#l7.86"></a><span id="l7.86">       this._windows.unshift(aWindow);</span>
<a href="#l7.87"></a><span id="l7.87">     }</span>
<a href="#l7.88"></a><span id="l7.88">     this.unreadCount = 0;</span>
<a href="#l7.89"></a><span id="l7.89">   },</span>
<a href="#l7.90"></a><span id="l7.90"> </span>
<a href="#l7.91"></a><span id="l7.91">   init: function() {</span>
<a href="#l7.92"></a><span id="l7.92">     let os = Services.obs;</span>
<a href="#l7.93"></a><span id="l7.93">     [&quot;new-text&quot;,</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-     &quot;new-conversation&quot;,</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineminus">-     &quot;purple-quit&quot;].forEach(function (aTopic) {</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineminus">-      os.addObserver(Conversations, aTopic, false);</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineminus">-    });</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+     &quot;new-ui-conversation&quot;].forEach(function (aTopic) {</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+      os.addObserver(this, aTopic, false);</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+    }, this);</span>
<a href="#l7.101"></a><span id="l7.101">   },</span>
<a href="#l7.102"></a><span id="l7.102"> </span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+  _pendingConversations: null,</span>
<a href="#l7.104"></a><span id="l7.104">   observe: function(aSubject, aTopic, aMsg) {</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineminus">-    if (aTopic == &quot;purple-quit&quot;) {</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineminus">-      for (let id in this._purpleConv)</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineminus">-        this._purpleConv[id].unInit();</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+    if (aTopic == &quot;new-text&quot;) {</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+      if (aSubject.incoming &amp;&amp; !aSubject.system &amp;&amp;</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+          (!aSubject.conversation.isChat || aSubject.containsNick) &amp;&amp;</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+          !this.isConversationWindowFocused())</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+        ++this.unreadCount;</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+      return;</span>
<a href="#l7.114"></a><span id="l7.114">     }</span>
<a href="#l7.115"></a><span id="l7.115"> </span>
<a href="#l7.116"></a><span id="l7.116" class="difflineminus">-    if (aTopic != &quot;new-text&quot; &amp;&amp; aTopic != &quot;new-conversation&quot;)</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+    if (aTopic != &quot;new-ui-conversation&quot;)</span>
<a href="#l7.118"></a><span id="l7.118">       return;</span>
<a href="#l7.119"></a><span id="l7.119"> </span>
<a href="#l7.120"></a><span id="l7.120" class="difflineminus">-    let conv = aTopic == &quot;new-conversation&quot; ? aSubject : aSubject.conversation;</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-    if (!(conv.id in this._purpleConv)) {</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+    let conv = aSubject;</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+    if (!(aSubject.id in this._uiConv)) {</span>
<a href="#l7.124"></a><span id="l7.124">       // The conversation is not displayed anywhere yet.</span>
<a href="#l7.125"></a><span id="l7.125">       // First, check if an existing conversation window can accept it.</span>
<a href="#l7.126"></a><span id="l7.126">       for each (let win in this._windows)</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineminus">-        if (win.document.getElementById(&quot;conversations&quot;).addConversation(conv))</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+        if (win.document.getElementById(&quot;conversations&quot;).addConversation(aSubject))</span>
<a href="#l7.129"></a><span id="l7.129">           return;</span>
<a href="#l7.130"></a><span id="l7.130"> </span>
<a href="#l7.131"></a><span id="l7.131">       // At this point, no existing registered window can accept the conversation.</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-      // If we are already creating a window, append the notification.</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-      if (this._pendingNotifications) {</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineminus">-        this._pendingNotifications.push({object: aSubject, topic: aTopic,</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-                                         msg: aMsg});</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineminus">-        return;</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+      if (this._pendingConversations) {</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+        // If we are already creating a window, append the notification.</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+        this._pendingConversations.push(aSubject);</span>
<a href="#l7.140"></a><span id="l7.140">       }</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineminus">-</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineminus">-      // We need to create a new window.</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineminus">-      Services.ww.openWindow(null, CONVERSATION_WINDOW_URI, &quot;_blank&quot;,</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineminus">-                             &quot;chrome,toolbar,resizable&quot;, null);</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineminus">-      this._pendingNotifications = [{object: aSubject, topic: aTopic, msg: aMsg}];</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineminus">-      return;</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineminus">-    }</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineminus">-</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineminus">-    if (aTopic == &quot;new-text&quot;) {</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-      let conv = this._purpleConv[aSubject.conversation.id];</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-      if (!conv.loaded)</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineminus">-        conv.addMsg(aSubject);</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineminus">-      if (aSubject.incoming &amp;&amp; !aSubject.system &amp;&amp;</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineminus">-          (!aSubject.conversation.isChat || aSubject.containsNick)) {</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-        if (Services.prefs.getBoolPref(this._getAttentionPrefName))</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-          conv.ownerDocument.defaultView.getAttention();</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineminus">-        if (!this.isConversationWindowFocused())</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineminus">-          ++this.unreadCount;</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+      else {</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+        // We need to create a new window.</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+        this._pendingConversations = [aSubject];</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+        Services.ww.openWindow(null, CONVERSATION_WINDOW_URI, &quot;_blank&quot;,</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+                               &quot;chrome,toolbar,resizable&quot;, null);</span>
<a href="#l7.164"></a><span id="l7.164">       }</span>
<a href="#l7.165"></a><span id="l7.165">     }</span>
<a href="#l7.166"></a><span id="l7.166">   }</span>
<a href="#l7.167"></a><span id="l7.167"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/purple/locales/en-US/conversations.properties</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,4 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+# LOCALIZATION NOTE (targetChanged):</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+#  %1$S is the new conversation title (display name of the new target),</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+#  %2$S is the protocol name used for the new target.</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+targetChanged=The conversation will continue with %1$S, using %2$S.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/purple/purplexpcom/public/imIConversationsService.idl</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,64 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+ *</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+ *</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+ * License.</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+ *</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+ * The Original Code is the Instantbird messenging client.</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+ *</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+ * Florian QUEZE &lt;florian@instantbird.org&gt;.</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+ *</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+ *</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+ *</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+#include &quot;purpleIConversation.idl&quot;</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+#include &quot;imIContactsService.idl&quot;</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+[scriptable, uuid(a09faf46-bb9d-402f-b460-89f8d7827ff1)]</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+interface imIConversation: purpleIConversation {</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+  // Will be null for MUCs and IMs from people not in the contacts list.</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+  readonly attribute imIContact contact;</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+  attribute purpleIConversation target;</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+};</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+[scriptable, uuid(984e182c-d395-4fba-ba6e-cc80c71f57bf)]</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+interface imIConversationsService: nsISupports {</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+  void initConversations();</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+  void unInitConversations();</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+  // register a conversation. This will create a unique id for the</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+  // conversation and set it.</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+  void addConversation(in purpleIConversation aConversation);</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+  void removeConversation(in purpleIConversation aConversation);</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+  imIConversation getUIConversation(in purpleIConversation aConversation);</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+  imIConversation getUIConversationByContactId(in unsigned long aId);</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+  nsISimpleEnumerator getConversations();</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+  purpleIConversation getConversationById(in unsigned long aId);</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/purple/purplexpcom/src/imContacts.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/purple/purplexpcom/src/imContacts.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -30,41 +30,31 @@</span>
<a href="#l10.4"></a><span id="l10.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l10.5"></a><span id="l10.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l10.6"></a><span id="l10.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l10.7"></a><span id="l10.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l10.8"></a><span id="l10.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l10.9"></a><span id="l10.9">  *</span>
<a href="#l10.10"></a><span id="l10.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-const Cc = Components.classes;</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-const Ci = Components.interfaces;</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+const {classes: Cc, interfaces: Ci, utils: Cu} = Components;</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+Cu.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+Cu.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l10.19"></a><span id="l10.19"> </span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(this, &quot;obs&quot;,</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-                                   &quot;@mozilla.org/observer-service;1&quot;,</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-                                   &quot;nsIObserverService&quot;);</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(this, &quot;prefs&quot;,</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-                                   &quot;@mozilla.org/preferences-service;1&quot;,</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-                                   &quot;nsIPrefBranch&quot;);</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(this, &quot;pcs&quot;,</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-                                   &quot;@instantbird.org/purple/core;1&quot;,</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-                                   &quot;purpleICoreService&quot;);</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;DBConn&quot;, function() pcs.storageConnection);</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;DBConn&quot;,</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+                            function() Services.core.storageConnection);</span>
<a href="#l10.33"></a><span id="l10.33"> </span>
<a href="#l10.34"></a><span id="l10.34"> var AccountsById = { };</span>
<a href="#l10.35"></a><span id="l10.35"> function getAccountById(aId) {</span>
<a href="#l10.36"></a><span id="l10.36">   if (AccountsById.hasOwnProperty(aId))</span>
<a href="#l10.37"></a><span id="l10.37">     return AccountsById[aId];</span>
<a href="#l10.38"></a><span id="l10.38"> </span>
<a href="#l10.39"></a><span id="l10.39">   let account = null;</span>
<a href="#l10.40"></a><span id="l10.40">   try {</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-    account = pcs.getAccountByNumericId(aId);</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+    account = Services.core.getAccountByNumericId(aId);</span>
<a href="#l10.43"></a><span id="l10.43">   } catch (x) { /* Not found */ }</span>
<a href="#l10.44"></a><span id="l10.44"> </span>
<a href="#l10.45"></a><span id="l10.45">   AccountsById[aId] = account;</span>
<a href="#l10.46"></a><span id="l10.46">   return account;</span>
<a href="#l10.47"></a><span id="l10.47"> }</span>
<a href="#l10.48"></a><span id="l10.48"> </span>
<a href="#l10.49"></a><span id="l10.49"> function TagsService() { }</span>
<a href="#l10.50"></a><span id="l10.50"> TagsService.prototype = {</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineat">@@ -243,17 +233,17 @@ Contact.prototype = {</span>
<a href="#l10.52"></a><span id="l10.52"> </span>
<a href="#l10.53"></a><span id="l10.53">     aTag = TagsById[aTag.id];</span>
<a href="#l10.54"></a><span id="l10.54">     this._tags.push(aTag);</span>
<a href="#l10.55"></a><span id="l10.55">     aTag._addContact(this);</span>
<a href="#l10.56"></a><span id="l10.56"> </span>
<a href="#l10.57"></a><span id="l10.57">     aTag.notifyObservers(this, &quot;contact-moved-in&quot;);</span>
<a href="#l10.58"></a><span id="l10.58">     for each (let observer in this._observers)</span>
<a href="#l10.59"></a><span id="l10.59">       observer.observe(aTag, &quot;contact-moved-in&quot;);</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-    obs.notifyObservers(this, &quot;contact-tagged&quot;, aTag.id);</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+    Services.obs.notifyObservers(this, &quot;contact-tagged&quot;, aTag.id);</span>
<a href="#l10.62"></a><span id="l10.62">   },</span>
<a href="#l10.63"></a><span id="l10.63">   /* Remove a tag from the local tags of the contact. */</span>
<a href="#l10.64"></a><span id="l10.64">   _removeTag: function(aTag) {</span>
<a href="#l10.65"></a><span id="l10.65">     if (!this.hasTag(aTag) || this._isTagInherited(aTag))</span>
<a href="#l10.66"></a><span id="l10.66">       return;</span>
<a href="#l10.67"></a><span id="l10.67"> </span>
<a href="#l10.68"></a><span id="l10.68">     let statement = DBConn.createStatement(&quot;DELETE FROM contact_tag &quot; +</span>
<a href="#l10.69"></a><span id="l10.69">                                            &quot;WHERE contact_id = :contactId &quot; +</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineat">@@ -349,17 +339,17 @@ Contact.prototype = {</span>
<a href="#l10.71"></a><span id="l10.71">       for each (let observer in this._observers)</span>
<a href="#l10.72"></a><span id="l10.72">         observer.observe(aOldTag, &quot;contact-moved-out&quot;);</span>
<a href="#l10.73"></a><span id="l10.73">     }</span>
<a href="#l10.74"></a><span id="l10.74">     if (shouldAdd) {</span>
<a href="#l10.75"></a><span id="l10.75">       aNewTag.notifyObservers(this, &quot;contact-moved-in&quot;);</span>
<a href="#l10.76"></a><span id="l10.76">       for each (let observer in this._observers)</span>
<a href="#l10.77"></a><span id="l10.77">         observer.observe(aNewTag, &quot;contact-moved-in&quot;);</span>
<a href="#l10.78"></a><span id="l10.78">     }</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineminus">-    obs.notifyObservers(this, &quot;contact-moved&quot;, null);</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+    Services.obs.notifyObservers(this, &quot;contact-moved&quot;, null);</span>
<a href="#l10.81"></a><span id="l10.81">   },</span>
<a href="#l10.82"></a><span id="l10.82"> </span>
<a href="#l10.83"></a><span id="l10.83">   getBuddies: function(aBuddyCount) {</span>
<a href="#l10.84"></a><span id="l10.84">     if (aBuddyCount)</span>
<a href="#l10.85"></a><span id="l10.85">       aBuddyCount.value = this._buddies.length;</span>
<a href="#l10.86"></a><span id="l10.86">     return this._buddies;</span>
<a href="#l10.87"></a><span id="l10.87">   },</span>
<a href="#l10.88"></a><span id="l10.88">   get _empty() this._buddies.length == 0 ||</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineat">@@ -603,17 +593,22 @@ Contact.prototype = {</span>
<a href="#l10.90"></a><span id="l10.90">   get mobile() this.statusType == Ci.imIStatusInfo.STATUS_MOBILE,</span>
<a href="#l10.91"></a><span id="l10.91">   _statusText: &quot;&quot;,</span>
<a href="#l10.92"></a><span id="l10.92">   get statusText() this._statusText,</span>
<a href="#l10.93"></a><span id="l10.93">   _availabilityDetails: 0,</span>
<a href="#l10.94"></a><span id="l10.94">   get availabilityDetails() this._availabilityDetails,</span>
<a href="#l10.95"></a><span id="l10.95">   get canSendMessage() this.preferredBuddy.canSendMessage,</span>
<a href="#l10.96"></a><span id="l10.96">   //XXX should we list the buddies in the tooltip?</span>
<a href="#l10.97"></a><span id="l10.97">   getTooltipInfo: function() this.preferredBuddy.getTooltipInfo(),</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineminus">-  createConversation: function() this.preferredBuddy.createConversation(),</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineplus">+  createConversation: function() {</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+    let uiConv = Services.conversations.getUIConversationByContactId(this.id);</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+    if (uiConv)</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+      return uiConv.target;</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+    return this.preferredBuddy.createConversation();</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+  },</span>
<a href="#l10.105"></a><span id="l10.105"> </span>
<a href="#l10.106"></a><span id="l10.106">   addObserver: function(aObserver) {</span>
<a href="#l10.107"></a><span id="l10.107">     if (this._observers.indexOf(aObserver) == -1)</span>
<a href="#l10.108"></a><span id="l10.108">       this._observers.push(aObserver);</span>
<a href="#l10.109"></a><span id="l10.109">   },</span>
<a href="#l10.110"></a><span id="l10.110">   removeObserver: function(aObserver) {</span>
<a href="#l10.111"></a><span id="l10.111">     if (!this.hasOwnProperty(&quot;_observers&quot;))</span>
<a href="#l10.112"></a><span id="l10.112">       return;</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineat">@@ -623,17 +618,17 @@ Contact.prototype = {</span>
<a href="#l10.114"></a><span id="l10.114">       this._observers.splice(index, 1);</span>
<a href="#l10.115"></a><span id="l10.115">   },</span>
<a href="#l10.116"></a><span id="l10.116">   // internal calls + calls from add-ons</span>
<a href="#l10.117"></a><span id="l10.117">   notifyObservers: function(aSubject, aTopic, aData) {</span>
<a href="#l10.118"></a><span id="l10.118">     for each (let observer in this._observers)</span>
<a href="#l10.119"></a><span id="l10.119">       observer.observe(aSubject, aTopic, aData);</span>
<a href="#l10.120"></a><span id="l10.120">     for each (let tag in this._tags)</span>
<a href="#l10.121"></a><span id="l10.121">       tag.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineminus">-    obs.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineplus">+    Services.obs.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l10.124"></a><span id="l10.124">   },</span>
<a href="#l10.125"></a><span id="l10.125">   _notifyObservers: function(aTopic, aData) {</span>
<a href="#l10.126"></a><span id="l10.126">     this.notifyObservers(this, &quot;contact-&quot; + aTopic, aData);</span>
<a href="#l10.127"></a><span id="l10.127">   },</span>
<a href="#l10.128"></a><span id="l10.128"> </span>
<a href="#l10.129"></a><span id="l10.129">   // This is called by the imIBuddy implementations.</span>
<a href="#l10.130"></a><span id="l10.130">   _observe: function(aSubject, aTopic, aData) {</span>
<a href="#l10.131"></a><span id="l10.131">     // Forward the notification.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- /dev/null</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ b/purple/purplexpcom/src/imConversations.js</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -0,0 +1,268 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+ *</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+ *</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+ * License.</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+ *</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+ * The Original Code is the Instantbird messenging client, released</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+ * 2009.</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+ *</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+ * Florian QUEZE &lt;florian@instantbird.org&gt;.</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+ *</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+ *</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+ *</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+const {classes: Cc, interfaces: Ci, utils: Cu} = Components;</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+Cu.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+Cu.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+Cu.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+var gLastUIConvId = 0;</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+var gLastPurpleConvId = 0;</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;bundle&quot;, function()</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+  Services.strings.createBundle(&quot;chrome://purple/locale/conversations.properties&quot;)</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+);</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+function UIConversation(aPurpleConversation, aContactId)</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+{</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+  this._purpleConv = {};</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+  this.id = ++gLastUIConvId;</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+  this._observers = [];</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+  this._pendingMessages = [];</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+  this.changeTargetTo(aPurpleConversation);</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+  if (aContactId)</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+    this.contactId = aContactId;</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+  let iface = Ci[&quot;purpleIConv&quot; + (aPurpleConversation.isChat ? &quot;Chat&quot; : &quot;IM&quot;)];</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+  this._interfaces = this._interfaces.concat(iface);</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+  Services.obs.notifyObservers(this, &quot;new-ui-conversation&quot;, null);</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+}</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+UIConversation.prototype = {</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+  __proto__: ClassInfo([&quot;imIConversation&quot;, &quot;purpleIConversation&quot;, &quot;nsIObserver&quot;],</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+                       &quot;UI conversation&quot;),</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+  contactId: null,</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+  get contact() {</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+    let target = this.target;</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+    if (!target.isChat &amp;&amp; target.buddy)</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+      return target.buddy.contact;</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+    return null;</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+  },</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+  get target() this._purpleConv[this._currentTargetId],</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+  set target(aPurpleConversation) {</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+    this.changeTargetTo(aPurpleConversation);</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+  },</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+  _currentTargetId: 0,</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+  changeTargetTo: function(aPurpleConversation) {</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+    let id = aPurpleConversation.id;</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+    if (this._currentTargetId == id)</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineplus">+      return;</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+    if (!(id in this._purpleConv)) {</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+      this._purpleConv[id] = aPurpleConversation;</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+      aPurpleConversation.addObserver(this.observeConv.bind(this, id));</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+    }</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+    let shouldNotify = this._currentTargetId;</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+    this._currentTargetId = id;</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+    if (shouldNotify) {</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+      this.notifyObservers(this, &quot;target-purple-conversation-changed&quot;);</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+      let target = this.target;</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+      let params = [target.title, target.account.protocol.name];</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineplus">+      this.systemMessage(bundle.formatStringFromName(&quot;targetChanged&quot;,</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineplus">+                                                     params, params.length));</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+    }</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineplus">+  },</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineplus">+  // Returns a boolean indicating if the ui-conversation was closed.</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+  removeTarget: function(aPurpleConversation) {</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+    let id = aPurpleConversation.id;</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineplus">+    if (!(id in this._purpleConv))</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+      throw &quot;unknown purple conversation&quot;;</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineplus">+</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineplus">+    delete this._purpleConv[id];</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+    if (this._currentTargetId == id) {</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineplus">+      for (let newId in this._purpleConv) {</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineplus">+        this.changeTargetTo(this._purpleConv[newId]);</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+        return false;</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+      }</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineplus">+      this.notifyObservers(this, &quot;ui-conversation-closed&quot;);</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineplus">+      Services.obs.notifyObservers(this, &quot;ui-conversation-closed&quot;, null);</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineplus">+      return true;</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineplus">+    }</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineplus">+  },</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineplus">+</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineplus">+  observeConv: function(aTargetId, aSubject, aTopic, aData) {</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineplus">+    if (aTargetId != this._currentTargetId &amp;&amp;</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineplus">+        (aTopic == &quot;new-text&quot; ||</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineplus">+         (aTopic == &quot;update-typing&quot; &amp;&amp;</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineplus">+          this._purpleConv[aTargetId].typingState == Ci.purpleIConvIM.TYPING)))</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+      this.target = this._purpleConv[aTargetId];</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineplus">+    this.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineplus">+  },</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineplus">+</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineplus">+  systemMessage: function(aText) {</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineplus">+    (new Message(&quot;system&quot;, aText, {system: true})).conversation = this;</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineplus">+  },</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineplus">+</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineplus">+  // purpleIConversation</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineplus">+  get isChat() this.target.isChat,</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineplus">+  get account() this.target.account,</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineplus">+  get name() this.target.name,</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineplus">+  get normalizedName() this.target.normalizedName,</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineplus">+  get title() this.target.title,</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineplus">+  sendMsg: function (aMsg) { this.target.sendMsg(aMsg); },</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineplus">+  unInit: function() {</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineplus">+    for each (let conv in this._purpleConv)</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineplus">+      conv.unInit();</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineplus">+  },</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineplus">+  close: function() {</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineplus">+    for each (let conv in this._purpleConv)</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineplus">+      conv.close();</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineplus">+  },</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineplus">+  addObserver: function(aObserver) {</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineplus">+    if (this._observers.indexOf(aObserver) == -1) {</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineplus">+      this._observers.push(aObserver);</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineplus">+      if (this._observers.length == 1)</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineplus">+        while (this._pendingMessages.length)</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineplus">+          this.notifyObservers(this._pendingMessages.shift(), &quot;new-text&quot;);</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineplus">+    }</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineplus">+  },</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineplus">+  removeObserver: function(aObserver) {</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineplus">+    let index = this._observers.indexOf(aObserver);</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineplus">+    if (index != -1)</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineplus">+      this._observers.splice(index, 1);</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineplus">+  },</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineplus">+  notifyObservers: function(aSubject, aTopic, aData) {</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineplus">+    for each (let observer in this._observers)</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineplus">+      observer.observe(aSubject, aTopic, aData);</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineplus">+    if (!this._observers.length &amp;&amp; aTopic == &quot;new-text&quot;)</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineplus">+      this._pendingMessages.push(aSubject);</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineplus">+  },</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineplus">+</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineplus">+  // purpleIConvIM</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineplus">+  get buddy() this.target.buddy,</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineplus">+  get typingState() this.target.typingState,</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineplus">+  sendTyping: function(aLength) { this.target.sendTyping(aLength); },</span>
<a href="#l11.173"></a><span id="l11.173" class="difflineplus">+</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineplus">+  // Chat only</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineplus">+  getParticipants: function() this.target.getParticipants(),</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineplus">+  get topic() this.target.topic,</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineplus">+  get topicSetter() this.target.topicSetter,</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineplus">+  get nick() this.target.nick,</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineplus">+  get left() this.target.left</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineplus">+};</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineplus">+</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineplus">+function ConversationsService() { }</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineplus">+ConversationsService.prototype = {</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineplus">+  initConversations: function() {</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineplus">+    this._uiConv = {};</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineplus">+    this._uiConvByContactId = {};</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineplus">+    this._purpleConversations = [];</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineplus">+  },</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineplus">+</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineplus">+  unInitConversations: function() {</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineplus">+    for each (let UIConv in this._uiConv)</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineplus">+      UIConv.unInit();</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineplus">+    delete this._uiConv;</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineplus">+    delete this._uiConvByContactId;</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineplus">+    // This should already be empty, but just to be sure...</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineplus">+    for each (let purpleConv in this._purpleConversations)</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineplus">+      purpleConv.unInit();</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineplus">+    delete this._purpleConversations;</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineplus">+  },</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineplus">+</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineplus">+  addConversation: function(aPurpleConversation) {</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineplus">+    // Give an id to the new conversation.</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineplus">+    aPurpleConversation.id = ++gLastPurpleConvId;</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineplus">+    this._purpleConversations.push(aPurpleConversation);</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineplus">+</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineplus">+    // Notify observers.</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineplus">+    Services.obs.notifyObservers(aPurpleConversation, &quot;new-conversation&quot;, null);</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineplus">+</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineplus">+    // Update or create the corresponding UI conversation.</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineplus">+    let contactId;</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineplus">+    if (!aPurpleConversation.isChat) {</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineplus">+      let accountBuddy = aPurpleConversation.buddy;</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineplus">+      if (accountBuddy)</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineplus">+        contactId = accountBuddy.buddy.contact.id;</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineplus">+    }</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineplus">+</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineplus">+    if (contactId) {</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineplus">+      if (contactId in this._uiConvByContactId) {</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineplus">+        let uiConv = this._uiConvByContactId[contactId];</span>
<a href="#l11.220"></a><span id="l11.220" class="difflineplus">+        uiConv.target = aPurpleConversation;</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineplus">+        this._uiConv[aPurpleConversation.id] = uiConv;</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineplus">+        return;</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineplus">+      }</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineplus">+    }</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineplus">+</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineplus">+    // We store the contactId in the UIConversation because we can't reliably</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineplus">+    // get it from purpleIConvIM objects during removeConversation calls.</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineplus">+    let newUIConv = new UIConversation(aPurpleConversation, contactId);</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineplus">+    this._uiConv[aPurpleConversation.id] = newUIConv;</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineplus">+    if (contactId)</span>
<a href="#l11.231"></a><span id="l11.231" class="difflineplus">+      this._uiConvByContactId[contactId] = newUIConv;</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineplus">+  },</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineplus">+  removeConversation: function(aPurpleConversation) {</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineplus">+    Services.obs.notifyObservers(aPurpleConversation, &quot;conversation-closed&quot;, null);</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineplus">+</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineplus">+    let uiConv = this.getUIConversation(aPurpleConversation);</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineplus">+    if (uiConv.removeTarget(aPurpleConversation)) {</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineplus">+      delete this._uiConv[aPurpleConversation.id];</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineplus">+      if (uiConv.contactId)</span>
<a href="#l11.240"></a><span id="l11.240" class="difflineplus">+        delete this._uiConvByContactId[uiConv.contactId];</span>
<a href="#l11.241"></a><span id="l11.241" class="difflineplus">+    }</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineplus">+    aPurpleConversation.unInit();</span>
<a href="#l11.243"></a><span id="l11.243" class="difflineplus">+</span>
<a href="#l11.244"></a><span id="l11.244" class="difflineplus">+    let index = this._purpleConversations.indexOf(aPurpleConversation);</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineplus">+    if (index != -1)</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineplus">+      this._purpleConversations.splice(index, 1);</span>
<a href="#l11.247"></a><span id="l11.247" class="difflineplus">+  },</span>
<a href="#l11.248"></a><span id="l11.248" class="difflineplus">+</span>
<a href="#l11.249"></a><span id="l11.249" class="difflineplus">+  getUIConversation: function(aPurpleConversation) {</span>
<a href="#l11.250"></a><span id="l11.250" class="difflineplus">+    let id = aPurpleConversation.id;</span>
<a href="#l11.251"></a><span id="l11.251" class="difflineplus">+    if (id in this._uiConv)</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineplus">+      return this._uiConv[id];</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineplus">+    throw &quot;Unknown conversation&quot;;</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineplus">+  },</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineplus">+  getUIConversationByContactId: function(aId)</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineplus">+    (aId in this._uiConvByContactId) ? this._uiConvByContactId[aId] : null,</span>
<a href="#l11.257"></a><span id="l11.257" class="difflineplus">+</span>
<a href="#l11.258"></a><span id="l11.258" class="difflineplus">+  getConversations: function() nsSimpleEnumerator(this._purpleConversations),</span>
<a href="#l11.259"></a><span id="l11.259" class="difflineplus">+  getConversationById: function(aId) {</span>
<a href="#l11.260"></a><span id="l11.260" class="difflineplus">+    for (let i = 0; i &lt; this._purpleConversations.length; ++i)</span>
<a href="#l11.261"></a><span id="l11.261" class="difflineplus">+      if (this._purpleConversations[i].id == aId)</span>
<a href="#l11.262"></a><span id="l11.262" class="difflineplus">+        return this._purpleConversations[i];</span>
<a href="#l11.263"></a><span id="l11.263" class="difflineplus">+    return null;</span>
<a href="#l11.264"></a><span id="l11.264" class="difflineplus">+  },</span>
<a href="#l11.265"></a><span id="l11.265" class="difflineplus">+</span>
<a href="#l11.266"></a><span id="l11.266" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI([Ci.imIConversationsService]),</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineplus">+  classDescription: &quot;Conversations&quot;,</span>
<a href="#l11.268"></a><span id="l11.268" class="difflineplus">+  classID: Components.ID(&quot;{b2397cd5-c76d-4618-8410-f344c7c6443a}&quot;),</span>
<a href="#l11.269"></a><span id="l11.269" class="difflineplus">+  contractID: &quot;@instantbird.org/purple/conversations-service;1&quot;</span>
<a href="#l11.270"></a><span id="l11.270" class="difflineplus">+};</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineplus">+</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineplus">+const NSGetFactory = XPCOMUtils.generateNSGetFactory([ConversationsService]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/purple/purplexpcom/src/imConversations.manifest</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,2 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+component {b2397cd5-c76d-4618-8410-f344c7c6443a} imConversations.js</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+contract @instantbird.org/purple/conversations-service;1 {b2397cd5-c76d-4618-8410-f344c7c6443a}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/purple/purplexpcom/src/jsProtoHelper.jsm</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/purple/purplexpcom/src/jsProtoHelper.jsm</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -36,16 +36,17 @@</span>
<a href="#l13.4"></a><span id="l13.4">  *</span>
<a href="#l13.5"></a><span id="l13.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l13.6"></a><span id="l13.6"> </span>
<a href="#l13.7"></a><span id="l13.7"> var EXPORTED_SYMBOLS = [</span>
<a href="#l13.8"></a><span id="l13.8">   &quot;setTimeout&quot;,</span>
<a href="#l13.9"></a><span id="l13.9">   &quot;clearTimeout&quot;,</span>
<a href="#l13.10"></a><span id="l13.10">   &quot;nsSimpleEnumerator&quot;,</span>
<a href="#l13.11"></a><span id="l13.11">   &quot;EmptyEnumerator&quot;,</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+  &quot;ClassInfo&quot;,</span>
<a href="#l13.13"></a><span id="l13.13">   &quot;GenericAccountPrototype&quot;,</span>
<a href="#l13.14"></a><span id="l13.14">   &quot;GenericAccountBuddyPrototype&quot;,</span>
<a href="#l13.15"></a><span id="l13.15">   &quot;GenericConvIMPrototype&quot;,</span>
<a href="#l13.16"></a><span id="l13.16">   &quot;GenericConvChatPrototype&quot;,</span>
<a href="#l13.17"></a><span id="l13.17">   &quot;GenericConvChatBuddyPrototype&quot;,</span>
<a href="#l13.18"></a><span id="l13.18">   &quot;GenericProtocolPrototype&quot;,</span>
<a href="#l13.19"></a><span id="l13.19">   &quot;ForwardProtocolPrototype&quot;,</span>
<a href="#l13.20"></a><span id="l13.20">   &quot;Message&quot;,</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineat">@@ -91,17 +92,17 @@ function normalize(aString) aString.repl</span>
<a href="#l13.22"></a><span id="l13.22"> </span>
<a href="#l13.23"></a><span id="l13.23"> /* Common nsIClassInfo and QueryInterface implementation</span>
<a href="#l13.24"></a><span id="l13.24">  * shared by all generic objects implemented in this file. */</span>
<a href="#l13.25"></a><span id="l13.25"> function ClassInfo(aInterfaces, aDescription)</span>
<a href="#l13.26"></a><span id="l13.26"> {</span>
<a href="#l13.27"></a><span id="l13.27">   if (!(this instanceof ClassInfo))</span>
<a href="#l13.28"></a><span id="l13.28">     return new ClassInfo(aInterfaces, aDescription);</span>
<a href="#l13.29"></a><span id="l13.29"> </span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-  if (!(aInterfaces instanceof Array))</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+  if (!Array.isArray(aInterfaces))</span>
<a href="#l13.32"></a><span id="l13.32">     aInterfaces = [aInterfaces];</span>
<a href="#l13.33"></a><span id="l13.33">   this._interfaces =</span>
<a href="#l13.34"></a><span id="l13.34">     aInterfaces.map(function (i) typeof i == &quot;string&quot; ? Ci[i] : i);</span>
<a href="#l13.35"></a><span id="l13.35"> </span>
<a href="#l13.36"></a><span id="l13.36">   this.classDescription = aDescription || &quot;JS Proto Object&quot;;</span>
<a href="#l13.37"></a><span id="l13.37"> }</span>
<a href="#l13.38"></a><span id="l13.38"> ClassInfo.prototype = {</span>
<a href="#l13.39"></a><span id="l13.39">   QueryInterface: function ClassInfo_QueryInterface(iid) {</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineat">@@ -464,17 +465,17 @@ Message.prototype = {</span>
<a href="#l13.41"></a><span id="l13.41"> const GenericConversationPrototype = {</span>
<a href="#l13.42"></a><span id="l13.42">   __proto__: ClassInfo(&quot;purpleIConversation&quot;, &quot;generic conversation object&quot;),</span>
<a href="#l13.43"></a><span id="l13.43">   flags: Ci.nsIClassInfo.DOM_OBJECT,</span>
<a href="#l13.44"></a><span id="l13.44"> </span>
<a href="#l13.45"></a><span id="l13.45">   _init: function(aAccount, aName) {</span>
<a href="#l13.46"></a><span id="l13.46">     this.account = aAccount;</span>
<a href="#l13.47"></a><span id="l13.47">     this._name = aName;</span>
<a href="#l13.48"></a><span id="l13.48">     this._observers = [];</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineminus">-    Services.core.addConversation(this);</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+    Services.conversations.addConversation(this);</span>
<a href="#l13.51"></a><span id="l13.51">   },</span>
<a href="#l13.52"></a><span id="l13.52"> </span>
<a href="#l13.53"></a><span id="l13.53">   _id: 0,</span>
<a href="#l13.54"></a><span id="l13.54">   get id() this._id,</span>
<a href="#l13.55"></a><span id="l13.55">   set id(aId) {</span>
<a href="#l13.56"></a><span id="l13.56">     if (this._id)</span>
<a href="#l13.57"></a><span id="l13.57">       throw Cr.NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l13.58"></a><span id="l13.58">     this._id = aId;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

