<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 7809:45c1585e47a2640830de35c5ac168e9a02eaae4b</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 45c1585e47a2640830de35c5ac168e9a02eaae4b" />
<meta property="og:url" content="/comm-central/rev/45c1585e47a2640830de35c5ac168e9a02eaae4b" />
<meta property="og:description" content="Merge commit" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 45c1585e47a2640830de35c5ac168e9a02eaae4b 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/45c1585e47a2640830de35c5ac168e9a02eaae4b">shortlog</a> |
<a href="/comm-central/log/45c1585e47a2640830de35c5ac168e9a02eaae4b">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/45c1585e47a2640830de35c5ac168e9a02eaae4b">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/45c1585e47a2640830de35c5ac168e9a02eaae4b">files</a> |
changeset |
<a href="/comm-central/raw-rev/45c1585e47a2640830de35c5ac168e9a02eaae4b">raw</a>  | <a href="/comm-central/archive/45c1585e47a2640830de35c5ac168e9a02eaae4b.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Merge commit
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#117;&#115;&#116;&#105;&#110;&#32;&#87;&#111;&#111;&#100;&#32;&#60;&#67;&#97;&#108;&#108;&#101;&#107;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 24 May 2011 00:49:15 -0400</td></tr>

<tr>
 <td>changeset 7809</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/45c1585e47a2640830de35c5ac168e9a02eaae4b">45c1585e47a2640830de35c5ac168e9a02eaae4b</a></td>
</tr>



<tr>
<td>parent 7808</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/330096d716951bd243dbe8f0b4829000a1cdec69">330096d716951bd243dbe8f0b4829000a1cdec69</a> (current diff)
</td>
</tr>
<tr>
<td>parent 7807</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f5cf5a4445409724abba0976dd1cae7ae3ccaa5f">f5cf5a4445409724abba0976dd1cae7ae3ccaa5f</a> (<a href="/comm-central/rev/f5cf5a4445409724abba0976dd1cae7ae3ccaa5f:45c1585e47a2">diff</a>)
</td>
</tr>

<tr>
<td>child 7810</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0d1c875f3997f86ab5c26a351303bfe5c05867b6">0d1c875f3997f86ab5c26a351303bfe5c05867b6</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=45c1585e47a2640830de35c5ac168e9a02eaae4b">6000</a></td></tr>
<tr><td>push user</td><td>Callek@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 24 May 2011 04:48:39 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@45c1585e47a2 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=45c1585e47a2640830de35c5ac168e9a02eaae4b">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=45c1585e47a2640830de35c5ac168e9a02eaae4b&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=45c1585e47a2640830de35c5ac168e9a02eaae4b&newProject=comm-central&newRevision=330096d716951bd243dbe8f0b4829000a1cdec69&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=45c1585e47a2640830de35c5ac168e9a02eaae4b&newProject=comm-central&newRevision=330096d716951bd243dbe8f0b4829000a1cdec69&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=45c1585e47a2640830de35c5ac168e9a02eaae4b&newProject=comm-central&newRevision=330096d716951bd243dbe8f0b4829000a1cdec69&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>






</table></div>

<div class="page_body description">Merge commit</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/modules/calUtils.jsm</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/modules/calUtils.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -85,35 +85,26 @@ let cal = {</span>
<a href="#l1.4"></a><span id="l1.4">             } catch (exc) {</span>
<a href="#l1.5"></a><span id="l1.5">                 Components.utils.reportError(exc + &quot; (&quot; + scriptUrlSpec + &quot;)&quot;);</span>
<a href="#l1.6"></a><span id="l1.6">             }</span>
<a href="#l1.7"></a><span id="l1.7">         }</span>
<a href="#l1.8"></a><span id="l1.8">     },</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10">     /**</span>
<a href="#l1.11"></a><span id="l1.11">      * Schedules execution of the passed function to the current thread's queue.</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-     * Do this to work around re-entrancy problems w.r.t. processPendingEvent(), e.g. on chrome startup.</span>
<a href="#l1.13"></a><span id="l1.13">      */</span>
<a href="#l1.14"></a><span id="l1.14">     postPone: function cal_postPone(func) {</span>
<a href="#l1.15"></a><span id="l1.15">         if (this.threadingEnabled) {</span>
<a href="#l1.16"></a><span id="l1.16">             cal.getThreadManager().currentThread.dispatch({ run: func },</span>
<a href="#l1.17"></a><span id="l1.17">                                                           Components.interfaces.nsIEventTarget.DISPATCH_NORMAL);</span>
<a href="#l1.18"></a><span id="l1.18">         } else {</span>
<a href="#l1.19"></a><span id="l1.19">             func();</span>
<a href="#l1.20"></a><span id="l1.20">         }</span>
<a href="#l1.21"></a><span id="l1.21">     },</span>
<a href="#l1.22"></a><span id="l1.22"> </span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-    /**</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-     * Call this function regularly to process a pending event, e.g. UI.</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-     */</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-    processPendingEvent: function cal_processPendingEvent() {</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-        let thread = cal.getThreadManager().currentThread;</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-        thread.processNextEvent(false /* don't wait */);</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-    },</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-</span>
<a href="#l1.31"></a><span id="l1.31">     get threadingEnabled() {</span>
<a href="#l1.32"></a><span id="l1.32">         if (gCalThreadingEnabled === undefined) {</span>
<a href="#l1.33"></a><span id="l1.33">             gCalThreadingEnabled = !cal.getPrefSafe(&quot;calendar.threading.disabled&quot;, false);</span>
<a href="#l1.34"></a><span id="l1.34">         }</span>
<a href="#l1.35"></a><span id="l1.35">         return gCalThreadingEnabled;</span>
<a href="#l1.36"></a><span id="l1.36">     },</span>
<a href="#l1.37"></a><span id="l1.37"> </span>
<a href="#l1.38"></a><span id="l1.38">     /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/src/calIcsParser.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/src/calIcsParser.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -165,18 +165,16 @@ calIcsParser.prototype = {</span>
<a href="#l2.4"></a><span id="l2.4">                             uid2parent[item.id] = item;</span>
<a href="#l2.5"></a><span id="l2.5">                         }</span>
<a href="#l2.6"></a><span id="l2.6">                     } else {</span>
<a href="#l2.7"></a><span id="l2.7">                         excItems.push(item);</span>
<a href="#l2.8"></a><span id="l2.8">                     }</span>
<a href="#l2.9"></a><span id="l2.9">                 }</span>
<a href="#l2.10"></a><span id="l2.10">             }</span>
<a href="#l2.11"></a><span id="l2.11">             calComp = rootComp.getNextSubcomponent(&quot;VCALENDAR&quot;);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-            cal.processPendingEvent();</span>
<a href="#l2.14"></a><span id="l2.14">         }</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16">         // tag &quot;exceptions&quot;, i.e. items with rid:</span>
<a href="#l2.17"></a><span id="l2.17">         for each (let item in excItems) {</span>
<a href="#l2.18"></a><span id="l2.18">             let parent = uid2parent[item.id];</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20">             if (!parent) { // a parentless one, fake a master and override it's occurrence</span>
<a href="#l2.21"></a><span id="l2.21">                 parent = isEvent(item) ? createEvent() : createTodo();</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -193,18 +191,16 @@ calIcsParser.prototype = {</span>
<a href="#l2.23"></a><span id="l2.23">                                       .createInstance(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l2.24"></a><span id="l2.24">                 rdate.date = item.recurrenceId;</span>
<a href="#l2.25"></a><span id="l2.25">                 parent.recurrenceInfo.appendRecurrenceItem(rdate);</span>
<a href="#l2.26"></a><span id="l2.26">                 // we'll keep the parentless-API until we switch over using itip-process for import (e.g. in dnd code)</span>
<a href="#l2.27"></a><span id="l2.27">                 this.mParentlessItems.push(item);</span>
<a href="#l2.28"></a><span id="l2.28">             }</span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30">             parent.recurrenceInfo.modifyException(item, true);</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-            cal.processPendingEvent();</span>
<a href="#l2.33"></a><span id="l2.33">         }</span>
<a href="#l2.34"></a><span id="l2.34"> </span>
<a href="#l2.35"></a><span id="l2.35">         for (let e in tzErrors) { // if any error has occurred</span>
<a href="#l2.36"></a><span id="l2.36">             // Use an alert rather than a prompt because problems may appear in</span>
<a href="#l2.37"></a><span id="l2.37">             // remote subscribed calendars the user cannot change.</span>
<a href="#l2.38"></a><span id="l2.38">             if (Components.classes[&quot;@mozilla.org/alerts-service;1&quot;]) {</span>
<a href="#l2.39"></a><span id="l2.39">                 let notifier = Components.classes[&quot;@mozilla.org/alerts-service;1&quot;]</span>
<a href="#l2.40"></a><span id="l2.40">                                          .getService(Components.interfaces.nsIAlertsService);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/providers/caldav/calDavRequestHandlers.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavRequestHandlers.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -568,17 +568,16 @@ webDavSyncHandler.prototype = {</span>
<a href="#l3.4"></a><span id="l3.4">         }</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6">     },</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8">     endElement: function wH_endElement(aUri, aLocalName, aQName) {</span>
<a href="#l3.9"></a><span id="l3.9">         switch (aLocalName) {</span>
<a href="#l3.10"></a><span id="l3.10">             case &quot;response&quot;: // WebDAV Sync draft 3</span>
<a href="#l3.11"></a><span id="l3.11">             case &quot;sync-response&quot;: // WebDAV Sync draft 0,1,2</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-                cal.processPendingEvent();</span>
<a href="#l3.13"></a><span id="l3.13">                 let r = this.currentResponse;</span>
<a href="#l3.14"></a><span id="l3.14">                 if (r.href &amp;&amp;</span>
<a href="#l3.15"></a><span id="l3.15">                     r.href.length) {</span>
<a href="#l3.16"></a><span id="l3.16">                     r.href = this.calendar.ensureDecodedPath(r.href);</span>
<a href="#l3.17"></a><span id="l3.17">                 }</span>
<a href="#l3.18"></a><span id="l3.18">                 // Deleted item</span>
<a href="#l3.19"></a><span id="l3.19">                 if (r.href &amp;&amp; r.href.length &amp;&amp;</span>
<a href="#l3.20"></a><span id="l3.20">                     r.status &amp;&amp;</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineat">@@ -881,17 +880,16 @@ multigetSyncHandler.prototype = {</span>
<a href="#l3.22"></a><span id="l3.22">             this.logXML += &quot;&lt;&quot; + aQName + &quot;&gt;&quot;;</span>
<a href="#l3.23"></a><span id="l3.23">         }</span>
<a href="#l3.24"></a><span id="l3.24"> </span>
<a href="#l3.25"></a><span id="l3.25">     },</span>
<a href="#l3.26"></a><span id="l3.26"> </span>
<a href="#l3.27"></a><span id="l3.27">     endElement: function mg_endElement(aUri, aLocalName, aQName) {</span>
<a href="#l3.28"></a><span id="l3.28">         switch (aLocalName) {</span>
<a href="#l3.29"></a><span id="l3.29">             case &quot;response&quot;:</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-                cal.processPendingEvent();</span>
<a href="#l3.31"></a><span id="l3.31">                 let r = this.currentResponse;</span>
<a href="#l3.32"></a><span id="l3.32">                 if (r.href &amp;&amp;</span>
<a href="#l3.33"></a><span id="l3.33">                     r.href.length) {</span>
<a href="#l3.34"></a><span id="l3.34">                     r.href = this.calendar.ensureDecodedPath(r.href);</span>
<a href="#l3.35"></a><span id="l3.35">                 }</span>
<a href="#l3.36"></a><span id="l3.36">                 if (r.href &amp;&amp; r.href.length &amp;&amp;</span>
<a href="#l3.37"></a><span id="l3.37">                     r.status &amp;&amp;</span>
<a href="#l3.38"></a><span id="l3.38">                     r.status.length &amp;&amp;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleCalendar.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleCalendar.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -954,18 +954,16 @@ calGoogleCalendar.prototype = {</span>
<a href="#l4.4"></a><span id="l4.4">                 // get listener about the item.</span>
<a href="#l4.5"></a><span id="l4.5">                 var expandedItems = expandItems(item, aOperation);</span>
<a href="#l4.6"></a><span id="l4.6">                 listener.onGetResult(this.superCalendar,</span>
<a href="#l4.7"></a><span id="l4.7">                                      Components.results.NS_OK,</span>
<a href="#l4.8"></a><span id="l4.8">                                      Components.interfaces.calIEvent,</span>
<a href="#l4.9"></a><span id="l4.9">                                      null,</span>
<a href="#l4.10"></a><span id="l4.10">                                      expandedItems.length,</span>
<a href="#l4.11"></a><span id="l4.11">                                      expandedItems);</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-                cal.processPendingEvent();</span>
<a href="#l4.14"></a><span id="l4.14">             }</span>
<a href="#l4.15"></a><span id="l4.15">             // Operation Completed successfully.</span>
<a href="#l4.16"></a><span id="l4.16">             this.notifyOperationComplete(listener,</span>
<a href="#l4.17"></a><span id="l4.17">                                          Components.results.NS_OK,</span>
<a href="#l4.18"></a><span id="l4.18">                                          Components.interfaces.calIOperationListener.GET,</span>
<a href="#l4.19"></a><span id="l4.19">                                          null,</span>
<a href="#l4.20"></a><span id="l4.20">                                          null);</span>
<a href="#l4.21"></a><span id="l4.21">         } catch (e) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/providers/memory/calMemoryCalendar.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/providers/memory/calMemoryCalendar.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -470,18 +470,16 @@ calMemoryCalendar.prototype = {</span>
<a href="#l5.4"></a><span id="l5.4">                        cal.checkIfInRange(item, aRangeStart, aRangeEnd)) {</span>
<a href="#l5.5"></a><span id="l5.5">                 // This needs fixing for recurring items, e.g. DTSTART of parent may occur before aRangeStart.</span>
<a href="#l5.6"></a><span id="l5.6">                 // This will be changed with bug 416975.</span>
<a href="#l5.7"></a><span id="l5.7">                 itemsFound.push(item);</span>
<a href="#l5.8"></a><span id="l5.8">             }</span>
<a href="#l5.9"></a><span id="l5.9">             if (aCount &amp;&amp; itemsFound.length &gt;= aCount) {</span>
<a href="#l5.10"></a><span id="l5.10">                 break;</span>
<a href="#l5.11"></a><span id="l5.11">             }</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-            cal.processPendingEvent();</span>
<a href="#l5.14"></a><span id="l5.14">         }</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16">         aListener.onGetResult (this.superCalendar,</span>
<a href="#l5.17"></a><span id="l5.17">                                Components.results.NS_OK,</span>
<a href="#l5.18"></a><span id="l5.18">                                typeIID,</span>
<a href="#l5.19"></a><span id="l5.19">                                null,</span>
<a href="#l5.20"></a><span id="l5.20">                                itemsFound.length,</span>
<a href="#l5.21"></a><span id="l5.21">                                itemsFound);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -752,17 +752,16 @@ calStorageCalendar.prototype = {</span>
<a href="#l6.4"></a><span id="l6.4">                 expandedItems = [ item ];</span>
<a href="#l6.5"></a><span id="l6.5">             }</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7">             if (expandedItems.length &amp;&amp; optionalFilterFunc) {</span>
<a href="#l6.8"></a><span id="l6.8">                 expandedItems = expandedItems.filter(optionalFilterFunc);</span>
<a href="#l6.9"></a><span id="l6.9">             }</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11">             queueItems (expandedItems, theIID);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-            cal.processPendingEvent();</span>
<a href="#l6.13"></a><span id="l6.13">             return expandedItems.length;</span>
<a href="#l6.14"></a><span id="l6.14">         }</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16">         // check the count and send end if count is exceeded</span>
<a href="#l6.17"></a><span id="l6.17">         function checkCount() {</span>
<a href="#l6.18"></a><span id="l6.18">             if (aCount &amp;&amp; count &gt;= aCount) {</span>
<a href="#l6.19"></a><span id="l6.19">                 // flush queue</span>
<a href="#l6.20"></a><span id="l6.20">                 queueItems(null);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/config/rules.mk</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/config/rules.mk</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -165,19 +165,20 @@ define _INSTALL_TESTS</span>
<a href="#l7.4"></a><span id="l7.4"> $(TEST_INSTALLER) $(wildcard $(srcdir)/$(dir)/*) $(testxpcobjdir)/$(relativesrcdir)/$(dir)</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> endef # do not remove the blank line!</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8"> SOLO_FILE ?= $(error Specify a test filename in SOLO_FILE when using check-interactive or check-one)</span>
<a href="#l7.9"></a><span id="l7.9"> </span>
<a href="#l7.10"></a><span id="l7.10"> libs::</span>
<a href="#l7.11"></a><span id="l7.11"> 	$(foreach dir,$(XPCSHELL_TESTS),$(_INSTALL_TESTS))</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-	$(PYTHON) $(MOZILLA_DIR)/config/buildlist.py \</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-	  $(testxpcobjdir)/all-test-dirs.list \</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-	  $(addprefix $(relativesrcdir)/,$(XPCSHELL_TESTS))</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+	$(PYTHON) $(MOZILLA_DIR)/build/xpccheck.py \</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+	  $(topsrcdir) \</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+	  $(topsrcdir)/$(MOZ_BUILD_APP)/test/xpcshell.ini \</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+	  $(addprefix $(topsrcdir)/$(relativesrcdir)/,$(XPCSHELL_TESTS))</span>
<a href="#l7.19"></a><span id="l7.19"> </span>
<a href="#l7.20"></a><span id="l7.20"> testxpcsrcdir = $(MOZILLA_SRCDIR)/testing/xpcshell</span>
<a href="#l7.21"></a><span id="l7.21"> </span>
<a href="#l7.22"></a><span id="l7.22"> # Execute all tests in the $(XPCSHELL_TESTS) directories.</span>
<a href="#l7.23"></a><span id="l7.23"> # See also $(MOZILLA_DIR)/testing/testsuite-targets.mk 'xpcshell-tests' target for global execution.</span>
<a href="#l7.24"></a><span id="l7.24"> xpcshell-tests:</span>
<a href="#l7.25"></a><span id="l7.25"> 	$(PYTHON) -u $(MOZILLA_DIR)/config/pythonpath.py \</span>
<a href="#l7.26"></a><span id="l7.26"> 	  -I$(MOZILLA_DIR)/build \</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPURL.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPURL.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -679,8 +679,30 @@ NS_IMETHODIMP nsLDAPURL::SetOptions(PRUi</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5">   mOptions = aOptions;</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7">   if (aOptions &amp; OPT_SECURE == OPT_SECURE)</span>
<a href="#l8.8"></a><span id="l8.8">     return SetScheme(LDAP_SSL_SCHEME);</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10">   return SetScheme(LDAP_SCHEME);</span>
<a href="#l8.11"></a><span id="l8.11"> }</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+NS_IMETHODIMP nsLDAPURL::SetRef(const nsACString &amp;aRef)</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+{</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+  return mBaseURL-&gt;SetRef(aRef);</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+}</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+nsLDAPURL::GetRef(nsACString &amp;result)</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+{</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+  return mBaseURL-&gt;GetRef(result);</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+}</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+NS_IMETHODIMP nsLDAPURL::EqualsExceptRef(nsIURI *other, PRBool *result)</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+{</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+  return mBaseURL-&gt;EqualsExceptRef(other, result);</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+}</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+nsLDAPURL::CloneIgnoringRef(nsIURI** result)</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+{</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+  return mBaseURL-&gt;CloneIgnoringRef(result);</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/ldap/xpcom/tests/unit/xpcshell.ini</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,5 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+head =</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+tail =</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+[test_nsLDAPURL.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/app/Makefile.in</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/app/Makefile.in</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -336,16 +336,23 @@ LIBS += -lphexlib</span>
<a href="#l10.4"></a><span id="l10.4"> endif</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6"> libs:: $(srcdir)/profile/prefs.js</span>
<a href="#l10.7"></a><span id="l10.7"> 	$(INSTALL) $(IFLAGS1) $^ $(DIST)/bin/defaults/profile</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9"> libs:: blocklist.xml</span>
<a href="#l10.10"></a><span id="l10.10"> 	$(INSTALL) $(IFLAGS1) $^ $(DIST)/bin</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+# XXX This is a hack to ensure that we get the right xpcshell.ini for our tests.</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+# mozilla-central does this in testing/xpcshell-tests which means that it is very</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+# hard for anyone to specify anything else.</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+libs::</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+	$(INSTALL) $(topsrcdir)/mail/test/xpcshell.ini $(MOZDEPTH)/_tests/xpcshell</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+	cp $(topsrcdir)/mail/test/xpcshell.ini $(MOZDEPTH)/_tests/xpcshell/all-test-dirs.list</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+</span>
<a href="#l10.19"></a><span id="l10.19"> ifeq (cocoa,$(MOZ_WIDGET_TOOLKIT))</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21"> AB := $(firstword $(subst -, ,$(AB_CD)))</span>
<a href="#l10.22"></a><span id="l10.22"> </span>
<a href="#l10.23"></a><span id="l10.23"> APP_NAME = $(MOZ_APP_DISPLAYNAME)</span>
<a href="#l10.24"></a><span id="l10.24"> </span>
<a href="#l10.25"></a><span id="l10.25"> LOWER_APP_NAME = $(shell echo $(APP_NAME) | tr '[A-Z]' '[a-z]')</span>
<a href="#l10.26"></a><span id="l10.26"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/app/profile/all-thunderbird.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/app/profile/all-thunderbird.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -678,8 +678,14 @@ pref(&quot;dom.ipc.plugins.enabled.i386.javap</span>
<a href="#l11.4"></a><span id="l11.4"> pref(&quot;dom.ipc.plugins.enabled.i386.javaappletplugin.plugin&quot;, true);</span>
<a href="#l11.5"></a><span id="l11.5"> // x86_64 ipc preferences</span>
<a href="#l11.6"></a><span id="l11.6"> pref(&quot;dom.ipc.plugins.enabled.x86_64&quot;, true);</span>
<a href="#l11.7"></a><span id="l11.7"> #elifdef MOZ_IPC</span>
<a href="#l11.8"></a><span id="l11.8"> pref(&quot;dom.ipc.plugins.enabled&quot;, true);</span>
<a href="#l11.9"></a><span id="l11.9"> #else</span>
<a href="#l11.10"></a><span id="l11.10"> pref(&quot;dom.ipc.plugins.enabled&quot;, false);</span>
<a href="#l11.11"></a><span id="l11.11"> #endif</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+// Windows taskbar support</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+#ifdef XP_WIN</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+pref(&quot;mail.taskbar.lists.enabled&quot;, true);</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+pref(&quot;mail.taskbar.lists.tasks.enabled&quot;, true);</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/mail/base/test/unit/xpcshell.ini</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,13 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+head = head_mailbase.js</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+tail = tail_base.js</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+[test_alertHook.js]</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+[test_attachmentChecker.js]</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+[test_emptyTrash_dbViewWrapper.js]</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+[test_viewWrapper_imapFolder.js]</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+[test_viewWrapper_logic.js]</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+[test_viewWrapper_realFolder.js]</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+[test_viewWrapper_virtualFolder.js]</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+[test_viewWrapper_virtualFolderCustomTerm.js]</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+[test_windows_font_migration.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/components/Makefile.in</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/components/Makefile.in</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -39,17 +39,17 @@ DEPTH   = ../..</span>
<a href="#l13.4"></a><span id="l13.4"> topsrcdir = @top_srcdir@</span>
<a href="#l13.5"></a><span id="l13.5"> srcdir    = @srcdir@</span>
<a href="#l13.6"></a><span id="l13.6"> VPATH   = @srcdir@</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l13.9"></a><span id="l13.9"> </span>
<a href="#l13.10"></a><span id="l13.10"> # Only Mac and Windows have search integration components, but we include at</span>
<a href="#l13.11"></a><span id="l13.11"> # least one module from search/ on all platforms</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-DIRS    = compose preferences addrbook migration activity search about-support</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+DIRS    = compose preferences addrbook migration activity search about-support wintaskbar</span>
<a href="#l13.14"></a><span id="l13.14"> </span>
<a href="#l13.15"></a><span id="l13.15"> ifneq (,$(filter windows gtk2 cocoa, $(MOZ_WIDGET_TOOLKIT)))</span>
<a href="#l13.16"></a><span id="l13.16"> DIRS += shell</span>
<a href="#l13.17"></a><span id="l13.17"> endif</span>
<a href="#l13.18"></a><span id="l13.18"> </span>
<a href="#l13.19"></a><span id="l13.19"> ifdef MOZ_SAFE_BROWSING</span>
<a href="#l13.20"></a><span id="l13.20"> DIRS += phishing </span>
<a href="#l13.21"></a><span id="l13.21"> endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/components/mailGlue.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/components/mailGlue.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -53,43 +53,58 @@ function MailGlue() {</span>
<a href="#l14.4"></a><span id="l14.4">   this._init();</span>
<a href="#l14.5"></a><span id="l14.5"> }</span>
<a href="#l14.6"></a><span id="l14.6"> </span>
<a href="#l14.7"></a><span id="l14.7"> MailGlue.prototype = {</span>
<a href="#l14.8"></a><span id="l14.8">   // init (called at app startup)</span>
<a href="#l14.9"></a><span id="l14.9">   _init: function MailGlue__init() {</span>
<a href="#l14.10"></a><span id="l14.10">     Services.obs.addObserver(this, &quot;xpcom-shutdown&quot;, false);</span>
<a href="#l14.11"></a><span id="l14.11">     Services.obs.addObserver(this, &quot;final-ui-startup&quot;, false);</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+    Services.obs.addObserver(this, &quot;mail-startup-done&quot;, false);</span>
<a href="#l14.13"></a><span id="l14.13">   },</span>
<a href="#l14.14"></a><span id="l14.14"> </span>
<a href="#l14.15"></a><span id="l14.15">   // cleanup (called at shutdown)</span>
<a href="#l14.16"></a><span id="l14.16">   _dispose: function MailGlue__dispose() {</span>
<a href="#l14.17"></a><span id="l14.17">     Services.obs.removeObserver(this, &quot;xpcom-shutdown&quot;);</span>
<a href="#l14.18"></a><span id="l14.18">     Services.obs.removeObserver(this, &quot;final-ui-startup&quot;);</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+    Services.obs.removeObserver(this, &quot;mail-startup-done&quot;);</span>
<a href="#l14.20"></a><span id="l14.20">   },</span>
<a href="#l14.21"></a><span id="l14.21"> </span>
<a href="#l14.22"></a><span id="l14.22">   // nsIObserver implementation</span>
<a href="#l14.23"></a><span id="l14.23">   observe: function MailGlue_observe(aSubject, aTopic, aData) {</span>
<a href="#l14.24"></a><span id="l14.24">     switch (aTopic) {</span>
<a href="#l14.25"></a><span id="l14.25">     case &quot;xpcom-shutdown&quot;:</span>
<a href="#l14.26"></a><span id="l14.26">       this._dispose();</span>
<a href="#l14.27"></a><span id="l14.27">       break;</span>
<a href="#l14.28"></a><span id="l14.28">     case &quot;final-ui-startup&quot;:</span>
<a href="#l14.29"></a><span id="l14.29">       this._onProfileStartup();</span>
<a href="#l14.30"></a><span id="l14.30">       break;</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+    case &quot;mail-startup-done&quot;:</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+      this._onMailStartupDone();</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+      break;</span>
<a href="#l14.34"></a><span id="l14.34">     }</span>
<a href="#l14.35"></a><span id="l14.35">   },</span>
<a href="#l14.36"></a><span id="l14.36"> </span>
<a href="#l14.37"></a><span id="l14.37">   _onProfileStartup: function MailGlue__onProfileStartup() {</span>
<a href="#l14.38"></a><span id="l14.38">     // check if we're in safe mode</span>
<a href="#l14.39"></a><span id="l14.39">     if (Services.appinfo.inSafeMode) {</span>
<a href="#l14.40"></a><span id="l14.40">       Services.ww.openWindow(null, &quot;chrome://messenger/content/safeMode.xul&quot;, </span>
<a href="#l14.41"></a><span id="l14.41">                              &quot;_blank&quot;, &quot;chrome,centerscreen,modal,resizable=no&quot;, null);</span>
<a href="#l14.42"></a><span id="l14.42">     }</span>
<a href="#l14.43"></a><span id="l14.43">   },</span>
<a href="#l14.44"></a><span id="l14.44"> </span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+  _onMailStartupDone: function MailGlue__onMailStartupDone() {</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+    // On Windows 7 and above, initialize the jump list module.</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+    const WINTASKBAR_CONTRACTID = &quot;@mozilla.org/windows-taskbar;1&quot;;</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+    if (WINTASKBAR_CONTRACTID in Cc &amp;&amp;</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+        Cc[WINTASKBAR_CONTRACTID].getService(Ci.nsIWinTaskbar).available) {</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+      Cu.import(&quot;resource:///modules/windowsJumpLists.js&quot;);</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+      WinTaskbarJumpList.startup();</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+    }</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+  },</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+</span>
<a href="#l14.55"></a><span id="l14.55">   // for XPCOM</span>
<a href="#l14.56"></a><span id="l14.56">   classID: Components.ID(&quot;{eb239c82-fac9-431e-98d7-11cacd0f71b8}&quot;),</span>
<a href="#l14.57"></a><span id="l14.57">   QueryInterface: XPCOMUtils.generateQI([Ci.nsIObserver]),</span>
<a href="#l14.58"></a><span id="l14.58"> };</span>
<a href="#l14.59"></a><span id="l14.59"> </span>
<a href="#l14.60"></a><span id="l14.60"> var components = [MailGlue];</span>
<a href="#l14.61"></a><span id="l14.61"> var NSGetFactory = XPCOMUtils.generateNSGetFactory(components);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">new file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- /dev/null</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ b/mail/components/test/unit/xpcshell.ini</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -0,0 +1,5 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineplus">+head = head_mailcomponents.js</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineplus">+tail = tail_mailcomponents.js</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineplus">+</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineplus">+[test_about_support.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">new file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- /dev/null</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ b/mail/components/wintaskbar/Makefile.in</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -0,0 +1,51 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineplus">+# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineplus">+# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineplus">+#</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineplus">+# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineplus">+# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineplus">+# the License. You may obtain a copy of the License at</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineplus">+# http://www.mozilla.org/MPL/</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+#</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+# for the specific language governing rights and limitations under the</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+# License.</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+#</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+# The Original Code is Aero Peek</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+#</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+# The Initial Developer of the Original Code is</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+# Mozilla Corporation</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+# Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+# the Initial Developer. All Rights Reserved.</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineplus">+#</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+# Contributor(s):</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineplus">+#   Rob Arnold &lt;tellrob@gmail.com&gt;</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineplus">+#</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineplus">+# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineplus">+# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+# the provisions above, a recipient may use your version of this file under</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+#</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+# ***** END LICENSE BLOCK *****</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+DEPTH		= ../../..</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+topsrcdir	= @top_srcdir@</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+srcdir		= @srcdir@</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineplus">+VPATH		= @srcdir@</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineplus">+include $(DEPTH)/config/autoconf.mk</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+MODULE = wintaskbar</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+EXTRA_JS_MODULES = \</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+	windowsJumpLists.js \</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineplus">+	$(NULL)</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineplus">+include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">new file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- /dev/null</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ b/mail/components/wintaskbar/windowsJumpLists.js</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -0,0 +1,270 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineplus">+/* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineplus">+ *</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+ *</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+ * License.</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+ *</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+ *</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+ * the Mozilla Foundation.</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+ *</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+ *   Jim Mathies &lt;jmathies@mozilla.com&gt; (Original author)</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+ *   Marco Bonardo &lt;mak77@bonardo.net&gt;</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineplus">+ *   Siddharth Agarwal &lt;sid.bugzilla@gmail.com&gt;</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+ *</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+ *</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+let EXPORTED_SYMBOLS = [&quot;WinTaskbarJumpList&quot;];</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineplus">+Components.utils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineplus">+</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineplus">+// Prefs</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineplus">+const PREF_TASKBAR_BRANCH    = &quot;mail.taskbar.lists.&quot;;</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineplus">+const PREF_TASKBAR_ENABLED   = &quot;enabled&quot;;</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineplus">+const PREF_TASKBAR_TASKS     = &quot;tasks.enabled&quot;;</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineplus">+</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_stringBundle&quot;, function () {</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineplus">+  return Services.strings</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineplus">+                 .createBundle(&quot;chrome://messenger/locale/taskbar.properties&quot;);</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineplus">+});</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineplus">+</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(this, &quot;_taskbarService&quot;,</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineplus">+                                   &quot;@mozilla.org/windows-taskbar;1&quot;,</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineplus">+                                   &quot;nsIWinTaskbar&quot;);</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineplus">+</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_prefs&quot;, function() {</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineplus">+  return Services.prefs.getBranch(PREF_TASKBAR_BRANCH)</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineplus">+                       .QueryInterface(Ci.nsIPrefBranch2);</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineplus">+});</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineplus">+</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+function _getString(aName) {</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+  return _stringBundle.GetStringFromName(aName);</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineplus">+}</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineplus">+</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineplus">+/**</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineplus">+ * Task list</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineplus">+ */</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineplus">+let gTasks = [</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineplus">+  // Write new message</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineplus">+  {</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineplus">+    get title()       _getString(&quot;taskbar.tasks.composeMessage.label&quot;),</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineplus">+    get description() _getString(&quot;taskbar.tasks.composeMessage.description&quot;),</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineplus">+    args:             &quot;-compose&quot;,</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineplus">+    iconIndex:        0, // Tb app icon</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineplus">+  },</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineplus">+</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineplus">+  // Open address book</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineplus">+  {</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineplus">+    get title()       _getString(&quot;taskbar.tasks.openAddressBook.label&quot;),</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineplus">+    get description() _getString(&quot;taskbar.tasks.openAddressBook.description&quot;),</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineplus">+    args:             &quot;-addressbook&quot;,</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineplus">+    iconIndex:        0, // Tb app icon</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineplus">+  },</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineplus">+];</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineplus">+</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineplus">+</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineplus">+let WinTaskbarJumpList = {</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineplus">+</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineplus">+  /**</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineplus">+   * Startup, shutdown, and update</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineplus">+   */</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineplus">+</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineplus">+  startup: function WTBJL_startup() {</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineplus">+    // exit if this isn't win7 or higher.</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineplus">+    if (!this._initTaskbar())</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineplus">+      return;</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineplus">+</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineplus">+    // Store our task list config data</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineplus">+    this._tasks = gTasks;</span>
<a href="#l17.112"></a><span id="l17.112" class="difflineplus">+</span>
<a href="#l17.113"></a><span id="l17.113" class="difflineplus">+    // retrieve taskbar related prefs.</span>
<a href="#l17.114"></a><span id="l17.114" class="difflineplus">+    this._refreshPrefs();</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineplus">+</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineplus">+    // observer for our prefs branch</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineplus">+    this._initObs();</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineplus">+</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineplus">+    this.update();</span>
<a href="#l17.120"></a><span id="l17.120" class="difflineplus">+  },</span>
<a href="#l17.121"></a><span id="l17.121" class="difflineplus">+</span>
<a href="#l17.122"></a><span id="l17.122" class="difflineplus">+  update: function WTBJL_update() {</span>
<a href="#l17.123"></a><span id="l17.123" class="difflineplus">+    // are we disabled via prefs? don't do anything!</span>
<a href="#l17.124"></a><span id="l17.124" class="difflineplus">+    if (!this._enabled)</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineplus">+      return;</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineplus">+</span>
<a href="#l17.127"></a><span id="l17.127" class="difflineplus">+    // do what we came here to do, update the taskbar jumplist</span>
<a href="#l17.128"></a><span id="l17.128" class="difflineplus">+    this._buildList();</span>
<a href="#l17.129"></a><span id="l17.129" class="difflineplus">+  },</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineplus">+</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineplus">+  _shutdown: function WTBJL__shutdown() {</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineplus">+    this._shuttingDown = true;</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineplus">+</span>
<a href="#l17.134"></a><span id="l17.134" class="difflineplus">+    this._free();</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineplus">+  },</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineplus">+</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineplus">+  /**</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineplus">+   * List building</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineplus">+   */</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineplus">+</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineplus">+  _buildList: function WTBJL__buildList() {</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineplus">+    // anything to build?</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineplus">+    if (!this._showTasks) {</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineplus">+      // don't leave the last list hanging on the taskbar.</span>
<a href="#l17.145"></a><span id="l17.145" class="difflineplus">+      this._deleteActiveJumpList();</span>
<a href="#l17.146"></a><span id="l17.146" class="difflineplus">+      return;</span>
<a href="#l17.147"></a><span id="l17.147" class="difflineplus">+    }</span>
<a href="#l17.148"></a><span id="l17.148" class="difflineplus">+</span>
<a href="#l17.149"></a><span id="l17.149" class="difflineplus">+    if (!this._startBuild())</span>
<a href="#l17.150"></a><span id="l17.150" class="difflineplus">+      return;</span>
<a href="#l17.151"></a><span id="l17.151" class="difflineplus">+</span>
<a href="#l17.152"></a><span id="l17.152" class="difflineplus">+    if (this._showTasks)</span>
<a href="#l17.153"></a><span id="l17.153" class="difflineplus">+      this._buildTasks();</span>
<a href="#l17.154"></a><span id="l17.154" class="difflineplus">+</span>
<a href="#l17.155"></a><span id="l17.155" class="difflineplus">+    this._commitBuild();</span>
<a href="#l17.156"></a><span id="l17.156" class="difflineplus">+  },</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineplus">+</span>
<a href="#l17.158"></a><span id="l17.158" class="difflineplus">+  /**</span>
<a href="#l17.159"></a><span id="l17.159" class="difflineplus">+   * Taskbar api wrappers</span>
<a href="#l17.160"></a><span id="l17.160" class="difflineplus">+   */</span>
<a href="#l17.161"></a><span id="l17.161" class="difflineplus">+</span>
<a href="#l17.162"></a><span id="l17.162" class="difflineplus">+  _startBuild: function WTBJL__startBuild() {</span>
<a href="#l17.163"></a><span id="l17.163" class="difflineplus">+    // This is useful if there are any async tasks pending. Since we don't right</span>
<a href="#l17.164"></a><span id="l17.164" class="difflineplus">+    // now, it's just harmless.</span>
<a href="#l17.165"></a><span id="l17.165" class="difflineplus">+    this._builder.abortListBuild();</span>
<a href="#l17.166"></a><span id="l17.166" class="difflineplus">+    // Since our list is static right now, we won't actually get back any</span>
<a href="#l17.167"></a><span id="l17.167" class="difflineplus">+    // removed items.</span>
<a href="#l17.168"></a><span id="l17.168" class="difflineplus">+    let removedItems = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l17.169"></a><span id="l17.169" class="difflineplus">+                         .createInstance(Ci.nsIMutableArray);</span>
<a href="#l17.170"></a><span id="l17.170" class="difflineplus">+    return this._builder.initListBuild(removedItems);</span>
<a href="#l17.171"></a><span id="l17.171" class="difflineplus">+  },</span>
<a href="#l17.172"></a><span id="l17.172" class="difflineplus">+</span>
<a href="#l17.173"></a><span id="l17.173" class="difflineplus">+  _commitBuild: function WTBJL__commitBuild() {</span>
<a href="#l17.174"></a><span id="l17.174" class="difflineplus">+    if (!this._builder.commitListBuild()) {</span>
<a href="#l17.175"></a><span id="l17.175" class="difflineplus">+      this._builder.abortListBuild();</span>
<a href="#l17.176"></a><span id="l17.176" class="difflineplus">+    }</span>
<a href="#l17.177"></a><span id="l17.177" class="difflineplus">+  },</span>
<a href="#l17.178"></a><span id="l17.178" class="difflineplus">+</span>
<a href="#l17.179"></a><span id="l17.179" class="difflineplus">+  _buildTasks: function WTBJL__buildTasks() {</span>
<a href="#l17.180"></a><span id="l17.180" class="difflineplus">+    if (this._tasks.length &gt; 0) {</span>
<a href="#l17.181"></a><span id="l17.181" class="difflineplus">+      let items = toXPCOMArray([this._createHandlerAppItem(task)</span>
<a href="#l17.182"></a><span id="l17.182" class="difflineplus">+                                for ([, task] in Iterator(this._tasks))],</span>
<a href="#l17.183"></a><span id="l17.183" class="difflineplus">+                               Ci.nsIMutableArray);</span>
<a href="#l17.184"></a><span id="l17.184" class="difflineplus">+      this._builder.addListToBuild(this._builder.JUMPLIST_CATEGORY_TASKS, items);</span>
<a href="#l17.185"></a><span id="l17.185" class="difflineplus">+    }</span>
<a href="#l17.186"></a><span id="l17.186" class="difflineplus">+  },</span>
<a href="#l17.187"></a><span id="l17.187" class="difflineplus">+</span>
<a href="#l17.188"></a><span id="l17.188" class="difflineplus">+  _deleteActiveJumpList: function WTBJL__deleteAJL() {</span>
<a href="#l17.189"></a><span id="l17.189" class="difflineplus">+    this._builder.deleteActiveList();</span>
<a href="#l17.190"></a><span id="l17.190" class="difflineplus">+  },</span>
<a href="#l17.191"></a><span id="l17.191" class="difflineplus">+</span>
<a href="#l17.192"></a><span id="l17.192" class="difflineplus">+  /**</span>
<a href="#l17.193"></a><span id="l17.193" class="difflineplus">+   * Jump list item creation helpers</span>
<a href="#l17.194"></a><span id="l17.194" class="difflineplus">+   */</span>
<a href="#l17.195"></a><span id="l17.195" class="difflineplus">+</span>
<a href="#l17.196"></a><span id="l17.196" class="difflineplus">+  _createHandlerAppItem: function WTBJL__createHandlerAppItem(aTask) {</span>
<a href="#l17.197"></a><span id="l17.197" class="difflineplus">+    let file = Services.dirsvc.get(&quot;XCurProcD&quot;, Ci.nsILocalFile);</span>
<a href="#l17.198"></a><span id="l17.198" class="difflineplus">+</span>
<a href="#l17.199"></a><span id="l17.199" class="difflineplus">+    // XXX where can we grab this from in the build? Do we need to?</span>
<a href="#l17.200"></a><span id="l17.200" class="difflineplus">+    file.append(&quot;thunderbird.exe&quot;);</span>
<a href="#l17.201"></a><span id="l17.201" class="difflineplus">+</span>
<a href="#l17.202"></a><span id="l17.202" class="difflineplus">+    let handlerApp = Cc[&quot;@mozilla.org/uriloader/local-handler-app;1&quot;]</span>
<a href="#l17.203"></a><span id="l17.203" class="difflineplus">+                       .createInstance(Ci.nsILocalHandlerApp);</span>
<a href="#l17.204"></a><span id="l17.204" class="difflineplus">+    handlerApp.executable = file;</span>
<a href="#l17.205"></a><span id="l17.205" class="difflineplus">+    // handlers default to the leaf name if a name is not specified</span>
<a href="#l17.206"></a><span id="l17.206" class="difflineplus">+    let title = aTask.title;</span>
<a href="#l17.207"></a><span id="l17.207" class="difflineplus">+    if (title &amp;&amp; title.length != 0)</span>
<a href="#l17.208"></a><span id="l17.208" class="difflineplus">+      handlerApp.name = title;</span>
<a href="#l17.209"></a><span id="l17.209" class="difflineplus">+    handlerApp.detailedDescription = aTask.description;</span>
<a href="#l17.210"></a><span id="l17.210" class="difflineplus">+    handlerApp.appendParameter(aTask.args);</span>
<a href="#l17.211"></a><span id="l17.211" class="difflineplus">+</span>
<a href="#l17.212"></a><span id="l17.212" class="difflineplus">+    let item = Cc[&quot;@mozilla.org/windows-jumplistshortcut;1&quot;]</span>
<a href="#l17.213"></a><span id="l17.213" class="difflineplus">+                 .createInstance(Ci.nsIJumpListShortcut);</span>
<a href="#l17.214"></a><span id="l17.214" class="difflineplus">+    item.app = handlerApp;</span>
<a href="#l17.215"></a><span id="l17.215" class="difflineplus">+    item.iconIndex = aTask.iconIndex;</span>
<a href="#l17.216"></a><span id="l17.216" class="difflineplus">+    return item;</span>
<a href="#l17.217"></a><span id="l17.217" class="difflineplus">+  },</span>
<a href="#l17.218"></a><span id="l17.218" class="difflineplus">+</span>
<a href="#l17.219"></a><span id="l17.219" class="difflineplus">+  _createSeparatorItem: function WTBJL__createSeparatorItem() {</span>
<a href="#l17.220"></a><span id="l17.220" class="difflineplus">+    return Cc[&quot;@mozilla.org/windows-jumplistseparator;1&quot;]</span>
<a href="#l17.221"></a><span id="l17.221" class="difflineplus">+             .createInstance(Ci.nsIJumpListSeparator);</span>
<a href="#l17.222"></a><span id="l17.222" class="difflineplus">+  },</span>
<a href="#l17.223"></a><span id="l17.223" class="difflineplus">+</span>
<a href="#l17.224"></a><span id="l17.224" class="difflineplus">+  /**</span>
<a href="#l17.225"></a><span id="l17.225" class="difflineplus">+   * Prefs utilities</span>
<a href="#l17.226"></a><span id="l17.226" class="difflineplus">+   */</span>
<a href="#l17.227"></a><span id="l17.227" class="difflineplus">+</span>
<a href="#l17.228"></a><span id="l17.228" class="difflineplus">+  _refreshPrefs: function WTBJL__refreshPrefs() {</span>
<a href="#l17.229"></a><span id="l17.229" class="difflineplus">+    this._enabled = _prefs.getBoolPref(PREF_TASKBAR_ENABLED);</span>
<a href="#l17.230"></a><span id="l17.230" class="difflineplus">+    this._showTasks = _prefs.getBoolPref(PREF_TASKBAR_TASKS);</span>
<a href="#l17.231"></a><span id="l17.231" class="difflineplus">+  },</span>
<a href="#l17.232"></a><span id="l17.232" class="difflineplus">+</span>
<a href="#l17.233"></a><span id="l17.233" class="difflineplus">+  /**</span>
<a href="#l17.234"></a><span id="l17.234" class="difflineplus">+   * Init and shutdown utilities</span>
<a href="#l17.235"></a><span id="l17.235" class="difflineplus">+   */</span>
<a href="#l17.236"></a><span id="l17.236" class="difflineplus">+</span>
<a href="#l17.237"></a><span id="l17.237" class="difflineplus">+  _initTaskbar: function WTBJL__initTaskbar() {</span>
<a href="#l17.238"></a><span id="l17.238" class="difflineplus">+    this._builder = _taskbarService.createJumpListBuilder();</span>
<a href="#l17.239"></a><span id="l17.239" class="difflineplus">+    if (!this._builder || !this._builder.available)</span>
<a href="#l17.240"></a><span id="l17.240" class="difflineplus">+      return false;</span>
<a href="#l17.241"></a><span id="l17.241" class="difflineplus">+</span>
<a href="#l17.242"></a><span id="l17.242" class="difflineplus">+    return true;</span>
<a href="#l17.243"></a><span id="l17.243" class="difflineplus">+  },</span>
<a href="#l17.244"></a><span id="l17.244" class="difflineplus">+</span>
<a href="#l17.245"></a><span id="l17.245" class="difflineplus">+  _initObs: function WTBJL__initObs() {</span>
<a href="#l17.246"></a><span id="l17.246" class="difflineplus">+    Services.obs.addObserver(this, &quot;profile-before-change&quot;, false);</span>
<a href="#l17.247"></a><span id="l17.247" class="difflineplus">+    _prefs.addObserver(&quot;&quot;, this, false);</span>
<a href="#l17.248"></a><span id="l17.248" class="difflineplus">+  },</span>
<a href="#l17.249"></a><span id="l17.249" class="difflineplus">+</span>
<a href="#l17.250"></a><span id="l17.250" class="difflineplus">+  _freeObs: function WTBJL__freeObs() {</span>
<a href="#l17.251"></a><span id="l17.251" class="difflineplus">+    Services.obs.removeObserver(this, &quot;profile-before-change&quot;);</span>
<a href="#l17.252"></a><span id="l17.252" class="difflineplus">+    _prefs.removeObserver(&quot;&quot;, this);</span>
<a href="#l17.253"></a><span id="l17.253" class="difflineplus">+  },</span>
<a href="#l17.254"></a><span id="l17.254" class="difflineplus">+</span>
<a href="#l17.255"></a><span id="l17.255" class="difflineplus">+  observe: function WTBJL_observe(aSubject, aTopic, aData) {</span>
<a href="#l17.256"></a><span id="l17.256" class="difflineplus">+    switch (aTopic) {</span>
<a href="#l17.257"></a><span id="l17.257" class="difflineplus">+      case &quot;nsPref:changed&quot;:</span>
<a href="#l17.258"></a><span id="l17.258" class="difflineplus">+        if (this._enabled == true &amp;&amp; !_prefs.getBoolPref(PREF_TASKBAR_ENABLED))</span>
<a href="#l17.259"></a><span id="l17.259" class="difflineplus">+          this._deleteActiveJumpList();</span>
<a href="#l17.260"></a><span id="l17.260" class="difflineplus">+        this._refreshPrefs();</span>
<a href="#l17.261"></a><span id="l17.261" class="difflineplus">+        this.update();</span>
<a href="#l17.262"></a><span id="l17.262" class="difflineplus">+      break;</span>
<a href="#l17.263"></a><span id="l17.263" class="difflineplus">+</span>
<a href="#l17.264"></a><span id="l17.264" class="difflineplus">+      case &quot;profile-before-change&quot;:</span>
<a href="#l17.265"></a><span id="l17.265" class="difflineplus">+        this._shutdown();</span>
<a href="#l17.266"></a><span id="l17.266" class="difflineplus">+      break;</span>
<a href="#l17.267"></a><span id="l17.267" class="difflineplus">+    }</span>
<a href="#l17.268"></a><span id="l17.268" class="difflineplus">+  },</span>
<a href="#l17.269"></a><span id="l17.269" class="difflineplus">+</span>
<a href="#l17.270"></a><span id="l17.270" class="difflineplus">+  _free: function WTBJL__free() {</span>
<a href="#l17.271"></a><span id="l17.271" class="difflineplus">+    this._freeObs();</span>
<a href="#l17.272"></a><span id="l17.272" class="difflineplus">+    delete this._builder;</span>
<a href="#l17.273"></a><span id="l17.273" class="difflineplus">+  },</span>
<a href="#l17.274"></a><span id="l17.274" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">new file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineminus">--- /dev/null</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/taskbar.properties</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineat">@@ -0,0 +1,4 @@</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineplus">+taskbar.tasks.composeMessage.label=Write new message</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineplus">+taskbar.tasks.composeMessage.description=Write a new message.</span>
<a href="#l18.7"></a><span id="l18.7" class="difflineplus">+taskbar.tasks.openAddressBook.label=Open address book</span>
<a href="#l18.8"></a><span id="l18.8" class="difflineplus">+taskbar.tasks.openAddressBook.description=Open your address book.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mail/locales/jar.mn</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mail/locales/jar.mn</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -102,16 +102,17 @@</span>
<a href="#l19.4"></a><span id="l19.4">   locale/@AB_CD@/messenger/configEditorOverlay.dtd                      (%chrome/messenger/configEditorOverlay.dtd)</span>
<a href="#l19.5"></a><span id="l19.5">   locale/@AB_CD@/messenger/gloda.properties                             (%chrome/messenger/gloda.properties)</span>
<a href="#l19.6"></a><span id="l19.6">   locale/@AB_CD@/messenger/glodaComplete.properties                     (%chrome/messenger/glodaComplete.properties)</span>
<a href="#l19.7"></a><span id="l19.7">   locale/@AB_CD@/messenger/templateUtils.properties                     (%chrome/messenger/templateUtils.properties)</span>
<a href="#l19.8"></a><span id="l19.8">   locale/@AB_CD@/messenger/glodaFacetView.properties                    (%chrome/messenger/glodaFacetView.properties)</span>
<a href="#l19.9"></a><span id="l19.9">   locale/@AB_CD@/messenger/glodaFacetView.dtd                           (%chrome/messenger/glodaFacetView.dtd)</span>
<a href="#l19.10"></a><span id="l19.10">   locale/@AB_CD@/messenger/quickFilterBar.dtd                           (%chrome/messenger/quickFilterBar.dtd)</span>
<a href="#l19.11"></a><span id="l19.11">   locale/@AB_CD@/messenger/safeMode.dtd                                 (%chrome/messenger/safeMode.dtd)</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+  locale/@AB_CD@/messenger/taskbar.properties                           (%chrome/messenger/taskbar.properties)</span>
<a href="#l19.13"></a><span id="l19.13">   locale/@AB_CD@/messenger/addressbook/abMainWindow.dtd                 (%chrome/messenger/addressbook/abMainWindow.dtd)</span>
<a href="#l19.14"></a><span id="l19.14">   locale/@AB_CD@/messenger/addressbook/abNewCardDialog.dtd              (%chrome/messenger/addressbook/abNewCardDialog.dtd)</span>
<a href="#l19.15"></a><span id="l19.15">   locale/@AB_CD@/messenger/addressbook/abContactsPanel.dtd              (%chrome/messenger/addressbook/abContactsPanel.dtd)</span>
<a href="#l19.16"></a><span id="l19.16">   locale/@AB_CD@/messenger/addressbook/abAddressBookNameDialog.dtd      (%chrome/messenger/addressbook/abAddressBookNameDialog.dtd)</span>
<a href="#l19.17"></a><span id="l19.17">   locale/@AB_CD@/messenger/addressbook/abCardOverlay.dtd                (%chrome/messenger/addressbook/abCardOverlay.dtd)</span>
<a href="#l19.18"></a><span id="l19.18">   locale/@AB_CD@/messenger/addressbook/abCardViewOverlay.dtd            (%chrome/messenger/addressbook/abCardViewOverlay.dtd)</span>
<a href="#l19.19"></a><span id="l19.19">   locale/@AB_CD@/messenger/addressbook/abDirTreeOverlay.dtd             (%chrome/messenger/addressbook/abDirTreeOverlay.dtd)</span>
<a href="#l19.20"></a><span id="l19.20">   locale/@AB_CD@/messenger/addressbook/abResultsPaneOverlay.dtd         (%chrome/messenger/addressbook/abResultsPaneOverlay.dtd)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1">new file mode 100644</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineminus">--- /dev/null</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineplus">+++ b/mail/steel/mac/xpcshell.ini</span>
<a href="#l20.4"></a><span id="l20.4" class="difflineat">@@ -0,0 +1,5 @@</span>
<a href="#l20.5"></a><span id="l20.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l20.6"></a><span id="l20.6" class="difflineplus">+head =</span>
<a href="#l20.7"></a><span id="l20.7" class="difflineplus">+tail =</span>
<a href="#l20.8"></a><span id="l20.8" class="difflineplus">+</span>
<a href="#l20.9"></a><span id="l20.9" class="difflineplus">+[test_platform.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1">new file mode 100644</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineminus">--- /dev/null</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineplus">+++ b/mail/steel/notmac/xpcshell.ini</span>
<a href="#l21.4"></a><span id="l21.4" class="difflineat">@@ -0,0 +1,5 @@</span>
<a href="#l21.5"></a><span id="l21.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l21.6"></a><span id="l21.6" class="difflineplus">+head =</span>
<a href="#l21.7"></a><span id="l21.7" class="difflineplus">+tail =</span>
<a href="#l21.8"></a><span id="l21.8" class="difflineplus">+</span>
<a href="#l21.9"></a><span id="l21.9" class="difflineplus">+[test_platform.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mail/test/mozmill/attachment/test-attachment.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mail/test/mozmill/attachment/test-attachment.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -92,23 +92,16 @@ var setupModule = function (module) {</span>
<a href="#l22.4"></a><span id="l22.4">     { attachments: [{ body: textAttachment,</span>
<a href="#l22.5"></a><span id="l22.5">                       filename: 'ubik.txt',</span>
<a href="#l22.6"></a><span id="l22.6">                       format: '' },</span>
<a href="#l22.7"></a><span id="l22.7">                     { body: binaryAttachment,</span>
<a href="#l22.8"></a><span id="l22.8">                       contentType: 'application/octet-stream',</span>
<a href="#l22.9"></a><span id="l22.9">                       filename: 'ubik.xxyyzz',</span>
<a href="#l22.10"></a><span id="l22.10">                       format: '' }],</span>
<a href="#l22.11"></a><span id="l22.11">     },</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-    // cert attachment (make sure Mime doesn't swallow this, which</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-    // test_attachment_view_expanded does for us.</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">-    { attachments: [{ body: binaryAttachment,</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineminus">-                      contentType: 'application/pkcs7-mime',</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineminus">-                      filename: 'cert.p7m',</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineminus">-                      format: '' }],</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineminus">-    },</span>
<a href="#l22.19"></a><span id="l22.19">   ];</span>
<a href="#l22.20"></a><span id="l22.20"> </span>
<a href="#l22.21"></a><span id="l22.21">   for (let i = 0; i &lt; messages.length; i++)</span>
<a href="#l22.22"></a><span id="l22.22">     add_message_to_folder(folder, create_message(messages[i]));</span>
<a href="#l22.23"></a><span id="l22.23"> };</span>
<a href="#l22.24"></a><span id="l22.24"> </span>
<a href="#l22.25"></a><span id="l22.25"> function test_attachment_view_collapsed() {</span>
<a href="#l22.26"></a><span id="l22.26">   be_in_folder(folder);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mail/test/mozmill/content-tabs/test-addons-mgr.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/test-addons-mgr.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -49,22 +49,22 @@ var setupModule = function (module) {</span>
<a href="#l23.4"></a><span id="l23.4"> </span>
<a href="#l23.5"></a><span id="l23.5"> function test_open_addons_with_url() {</span>
<a href="#l23.6"></a><span id="l23.6">   mc.window.openAddonsMgr('addons://list/theme');</span>
<a href="#l23.7"></a><span id="l23.7">   mc.sleep(0);</span>
<a href="#l23.8"></a><span id="l23.8"> </span>
<a href="#l23.9"></a><span id="l23.9">   let tab = mc.tabmail.currentTabInfo;</span>
<a href="#l23.10"></a><span id="l23.10">   wait_for_content_tab_load(tab);</span>
<a href="#l23.11"></a><span id="l23.11">   assert_content_tab_has_url(tab, 'about:addons');</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-  assert_true(content_tab_e(tab, 'category-themes').selected,</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+  assert_true(content_tab_e(tab, 'category-theme').selected,</span>
<a href="#l23.14"></a><span id="l23.14">               &quot;Themes category should be selected!&quot;);</span>
<a href="#l23.15"></a><span id="l23.15"> </span>
<a href="#l23.16"></a><span id="l23.16">   mc.tabmail.switchToTab(0); // switch to 3pane</span>
<a href="#l23.17"></a><span id="l23.17"> </span>
<a href="#l23.18"></a><span id="l23.18">   mc.window.openAddonsMgr('addons://list/plugin');</span>
<a href="#l23.19"></a><span id="l23.19">   mc.sleep(0);</span>
<a href="#l23.20"></a><span id="l23.20"> </span>
<a href="#l23.21"></a><span id="l23.21">   tab = mc.tabmail.currentTabInfo;</span>
<a href="#l23.22"></a><span id="l23.22">   wait_for_content_tab_load(tab);</span>
<a href="#l23.23"></a><span id="l23.23">   assert_content_tab_has_url(tab, 'about:addons');</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineminus">-  assert_true(content_tab_e(tab, 'category-plugins').selected,</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineplus">+  assert_true(content_tab_e(tab, 'category-plugin').selected,</span>
<a href="#l23.26"></a><span id="l23.26">               &quot;Plugins category should be selected!&quot;);</span>
<a href="#l23.27"></a><span id="l23.27"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1">new file mode 100644</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineminus">--- /dev/null</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineplus">+++ b/mail/test/xpcshell.ini</span>
<a href="#l24.4"></a><span id="l24.4" class="difflineat">@@ -0,0 +1,139 @@</span>
<a href="#l24.5"></a><span id="l24.5" class="difflineplus">+# XXX Included here because bug 658671 means we can't nest includes.</span>
<a href="#l24.6"></a><span id="l24.6" class="difflineplus">+[include:mailnews/addrbook/test/unit/xpcshell.ini]</span>
<a href="#l24.7"></a><span id="l24.7" class="difflineplus">+[include:mailnews/base/test/unit/xpcshell.ini]</span>
<a href="#l24.8"></a><span id="l24.8" class="difflineplus">+[include:mailnews/compose/test/unit/xpcshell.ini]</span>
<a href="#l24.9"></a><span id="l24.9" class="difflineplus">+[include:mailnews/db/gloda/test/unit/xpcshell.ini]</span>
<a href="#l24.10"></a><span id="l24.10" class="difflineplus">+[include:mailnews/db/msgdb/test/unit/xpcshell.ini]</span>
<a href="#l24.11"></a><span id="l24.11" class="difflineplus">+[include:mailnews/extensions/mdn/test/unit/xpcshell.ini]</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+[include:mailnews/extensions/bayesian-spam-filter/test/unit/xpcshell.ini]</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+[include:mailnews/imap/test/unit/xpcshell.ini]</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+[include:mailnews/import/test/unit/xpcshell.ini]</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineplus">+[include:mailnews/local/test/unit/xpcshell.ini]</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineplus">+[include:mailnews/mime/test/unit/xpcshell.ini]</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineplus">+[include:mailnews/news/test/unit/xpcshell.ini]</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineplus">+[include:mail/base/test/unit/xpcshell.ini]</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineplus">+[include:mail/steel/mac/xpcshell.ini]</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineplus">+run-if.os = mac</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineplus">+</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineplus">+[include:mail/steel/notmac/xpcshell.ini]</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineplus">+skip-if.os = mac</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineplus">+</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineplus">+[include:mail/components/test/unit/xpcshell.ini]</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineplus">+[include:ldap/xpcom/tests/unit/xpcshell.ini]</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineplus">+</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineplus">+# XXX Included here because bug 658671 means we can't nest includes.</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineplus">+[include:mozilla/chrome/test/unit/xpcshell.ini]</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineplus">+[include:mozilla/intl/locale/tests/unit/xpcshell.ini]</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineplus">+[include:mozilla/netwerk/cookie/test/unit/xpcshell.ini]</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineplus">+[include:mozilla/modules/libjar/zipwriter/test/unit/xpcshell.ini]</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineplus">+[include:mozilla/uriloader/exthandler/tests/unit/xpcshell.ini]</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineplus">+[include:mozilla/parser/xml/test/unit/xpcshell.ini]</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineplus">+[include:mozilla/modules/libpr0n/test/unit/xpcshell.ini]</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineplus">+[include:mozilla/modules/plugin/test/unit/xpcshell.ini]</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineplus">+[include:mozilla/dom/plugins/test/unit/xpcshell.ini]</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineplus">+[include:mozilla/dom/src/json/test/unit/xpcshell.ini]</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineplus">+[include:mozilla/dom/tests/unit/xpcshell.ini]</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineplus">+[include:mozilla/content/xtf/test/unit/xpcshell.ini]</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineplus">+[include:mozilla/docshell/test/unit/xpcshell.ini]</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineplus">+[include:mozilla/embedding/tests/unit/xpcshell.ini]</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineplus">+[include:mozilla/toolkit/components/commandlines/test/unit/xpcshell.ini]</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineplus">+[include:mozilla/toolkit/components/contentprefs/tests/unit/xpcshell.ini]</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineplus">+[include:mozilla/toolkit/components/passwordmgr/test/unit/xpcshell.ini]</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineplus">+[include:mozilla/toolkit/components/places/tests/migration/xpcshell.ini]</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineplus">+[include:mozilla/toolkit/components/places/tests/autocomplete/xpcshell.ini]</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineplus">+[include:mozilla/toolkit/components/places/tests/expiration/xpcshell.ini]</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineplus">+[include:mozilla/toolkit/components/places/tests/sync/xpcshell.ini]</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineplus">+[include:mozilla/toolkit/components/places/tests/bookmarks/xpcshell.ini]</span>
<a href="#l24.51"></a><span id="l24.51" class="difflineplus">+[include:mozilla/toolkit/components/places/tests/queries/xpcshell.ini]</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineplus">+[include:mozilla/toolkit/components/places/tests/unit/xpcshell.ini]</span>
<a href="#l24.53"></a><span id="l24.53" class="difflineplus">+[include:mozilla/toolkit/components/places/tests/network/xpcshell.ini]</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineplus">+[include:mozilla/toolkit/components/urlformatter/tests/unit/xpcshell.ini]</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineplus">+[include:mozilla/toolkit/components/ctypes/tests/unit/xpcshell.ini]</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineplus">+[include:mozilla/toolkit/components/autocomplete/tests/unit/xpcshell.ini]</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineplus">+[include:mozilla/toolkit/components/satchel/test/unit/xpcshell.ini]</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineplus">+[include:mozilla/toolkit/components/downloads/test/unit/xpcshell.ini]</span>
<a href="#l24.59"></a><span id="l24.59" class="difflineplus">+[include:mozilla/toolkit/components/downloads/test/schema_migration/xpcshell.ini]</span>
<a href="#l24.60"></a><span id="l24.60" class="difflineplus">+[include:mozilla/toolkit/components/telemetry/tests/unit/xpcshell.ini]</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineplus">+[include:mozilla/toolkit/content/tests/unit/xpcshell.ini]</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineplus">+[include:mozilla/toolkit/mozapps/downloads/tests/unit/xpcshell.ini]</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineplus">+[include:mozilla/toolkit/mozapps/extensions/test/xpcshell/xpcshell.ini]</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineplus">+[include:mozilla/toolkit/mozapps/extensions/test/xpcshell-unpack/xpcshell.ini]</span>
<a href="#l24.65"></a><span id="l24.65" class="difflineplus">+[include:mozilla/toolkit/mozapps/update/test_timermanager/unit/xpcshell.ini]</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineplus">+[include:mozilla/toolkit/mozapps/update/test/unit/xpcshell.ini]</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineplus">+[include:mozilla/security/manager/ssl/tests/unit/xpcshell.ini]</span>
<a href="#l24.68"></a><span id="l24.68" class="difflineplus">+[include:mozilla/testing/xpcshell/example/unit/xpcshell.ini]</span>
<a href="#l24.69"></a><span id="l24.69" class="difflineplus">+[include:mozilla/xpcom/tests/unit/xpcshell.ini]</span>
<a href="#l24.70"></a><span id="l24.70" class="difflineplus">+[include:mozilla/modules/libpref/test/unit/xpcshell.ini]</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineplus">+[include:mozilla/intl/strres/tests/unit/xpcshell.ini]</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineplus">+[include:mozilla/intl/unicharutil/tests/unit/xpcshell.ini]</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineplus">+[include:mozilla/intl/uconv/tests/unit/xpcshell.ini]</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineplus">+[include:mozilla/netwerk/test/unit/xpcshell.ini]</span>
<a href="#l24.75"></a><span id="l24.75" class="difflineplus">+[include:mozilla/netwerk/test/httpserver/test/xpcshell.ini]</span>
<a href="#l24.76"></a><span id="l24.76" class="difflineplus">+[include:mozilla/js/jetpack/tests/unit/xpcshell.ini]</span>
<a href="#l24.77"></a><span id="l24.77" class="difflineplus">+[include:mozilla/js/src/xpconnect/tests/unit/xpcshell.ini]</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineplus">+[include:mozilla/modules/libjar/test/unit/xpcshell.ini]</span>
<a href="#l24.79"></a><span id="l24.79" class="difflineplus">+[include:mozilla/extensions/cookie/test/unit/xpcshell.ini]</span>
<a href="#l24.80"></a><span id="l24.80" class="difflineplus">+[include:mozilla/storage/test/unit/xpcshell.ini]</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineplus">+[include:mozilla/rdf/tests/unit/xpcshell.ini]</span>
<a href="#l24.82"></a><span id="l24.82" class="difflineplus">+[include:mozilla/gfx/tests/unit/xpcshell.ini]</span>
<a href="#l24.83"></a><span id="l24.83" class="difflineplus">+[include:mozilla/widget/tests/unit/xpcshell.ini]</span>
<a href="#l24.84"></a><span id="l24.84" class="difflineplus">+[include:mozilla/content/base/test/unit/xpcshell.ini]</span>
<a href="#l24.85"></a><span id="l24.85" class="difflineplus">+[include:mozilla/content/test/unit/xpcshell.ini]</span>
<a href="#l24.86"></a><span id="l24.86" class="difflineplus">+[include:mozilla/toolkit/components/url-classifier/tests/unit/xpcshell.ini]</span>
<a href="#l24.87"></a><span id="l24.87" class="difflineplus">+[include:mozilla/services/crypto/tests/unit/xpcshell.ini]</span>
<a href="#l24.88"></a><span id="l24.88" class="difflineplus">+[include:mozilla/services/crypto/components/tests/unit/xpcshell.ini]</span>
<a href="#l24.89"></a><span id="l24.89" class="difflineplus">+[include:mozilla/services/sync/tests/unit/xpcshell.ini]</span>
<a href="#l24.90"></a><span id="l24.90" class="difflineplus">+[include:mozilla/browser/components/dirprovider/tests/unit/xpcshell.ini]</span>
<a href="#l24.91"></a><span id="l24.91" class="difflineplus">+[include:mozilla/browser/components/feeds/test/unit/xpcshell.ini]</span>
<a href="#l24.92"></a><span id="l24.92" class="difflineplus">+[include:mozilla/browser/components/places/tests/unit/xpcshell.ini]</span>
<a href="#l24.93"></a><span id="l24.93" class="difflineplus">+[include:mozilla/browser/components/privatebrowsing/test/unit/xpcshell.ini]</span>
<a href="#l24.94"></a><span id="l24.94" class="difflineplus">+[include:mozilla/browser/components/shell/test/unit/xpcshell.ini]</span>
<a href="#l24.95"></a><span id="l24.95" class="difflineplus">+[include:mozilla/extensions/spellcheck/hunspell/tests/unit/xpcshell.ini]</span>
<a href="#l24.96"></a><span id="l24.96" class="difflineplus">+[include:mozilla/toolkit/components/search/tests/xpcshell/xpcshell.ini]</span>
<a href="#l24.97"></a><span id="l24.97" class="difflineplus">+[include:mozilla/toolkit/mozapps/shared/test/unit/xpcshell.ini]</span>
<a href="#l24.98"></a><span id="l24.98" class="difflineplus">+[include:mozilla/services/crypto/component/tests/unit/xpcshell.ini]</span>
<a href="#l24.99"></a><span id="l24.99" class="difflineplus">+[include:mozilla/layout/tools/layout-debug/tests/unit/xpcshell.ini]</span>
<a href="#l24.100"></a><span id="l24.100" class="difflineplus">+run-if.config = debug</span>
<a href="#l24.101"></a><span id="l24.101" class="difflineplus">+</span>
<a href="#l24.102"></a><span id="l24.102" class="difflineplus">+[include:mozilla/intl/locale/tests_multilocale/unit/xpcshell.ini]</span>
<a href="#l24.103"></a><span id="l24.103" class="difflineplus">+run-if.toolkit = windows</span>
<a href="#l24.104"></a><span id="l24.104" class="difflineplus">+</span>
<a href="#l24.105"></a><span id="l24.105" class="difflineplus">+[include:mozilla/intl/locale/tests_multilocale/unit/xpcshell.ini]</span>
<a href="#l24.106"></a><span id="l24.106" class="difflineplus">+run-if.toolkit = cocoa</span>
<a href="#l24.107"></a><span id="l24.107" class="difflineplus">+</span>
<a href="#l24.108"></a><span id="l24.108" class="difflineplus">+[include:mozilla/toolkit/crashreporter/test/unit/xpcshell.ini]</span>
<a href="#l24.109"></a><span id="l24.109" class="difflineplus">+skip-if.os = linux</span>
<a href="#l24.110"></a><span id="l24.110" class="difflineplus">+run-if.config = mozcrashreporter</span>
<a href="#l24.111"></a><span id="l24.111" class="difflineplus">+</span>
<a href="#l24.112"></a><span id="l24.112" class="difflineplus">+[include:mozilla/intl/locale/src/unix/tests/unit/xpcshell.ini]</span>
<a href="#l24.113"></a><span id="l24.113" class="difflineplus">+skip-if.toolkit = windows cocoa os2</span>
<a href="#l24.114"></a><span id="l24.114" class="difflineplus">+</span>
<a href="#l24.115"></a><span id="l24.115" class="difflineplus">+[include:mozilla/toolkit/components/commandlines/test/unit_win/xpcshell.ini]</span>
<a href="#l24.116"></a><span id="l24.116" class="difflineplus">+run-if.os = windows</span>
<a href="#l24.117"></a><span id="l24.117" class="difflineplus">+</span>
<a href="#l24.118"></a><span id="l24.118" class="difflineplus">+[include:mozilla/toolkit/components/commandlines/test/unit_unix/xpcshell.ini]</span>
<a href="#l24.119"></a><span id="l24.119" class="difflineplus">+skip-if.os = windows mac os2</span>
<a href="#l24.120"></a><span id="l24.120" class="difflineplus">+</span>
<a href="#l24.121"></a><span id="l24.121" class="difflineplus">+[include:mozilla/chrome/test/unit_ipc/xpcshell.ini]</span>
<a href="#l24.122"></a><span id="l24.122" class="difflineplus">+run-if.config = ipc</span>
<a href="#l24.123"></a><span id="l24.123" class="difflineplus">+</span>
<a href="#l24.124"></a><span id="l24.124" class="difflineplus">+[include:mozilla/extensions/cookie/test/unit_ipc/xpcshell.ini]</span>
<a href="#l24.125"></a><span id="l24.125" class="difflineplus">+run-if.config = ipc</span>
<a href="#l24.126"></a><span id="l24.126" class="difflineplus">+</span>
<a href="#l24.127"></a><span id="l24.127" class="difflineplus">+[include:mozilla/ipc/testshell/tests/xpcshell.ini]</span>
<a href="#l24.128"></a><span id="l24.128" class="difflineplus">+run-if.config = ipc</span>
<a href="#l24.129"></a><span id="l24.129" class="difflineplus">+</span>
<a href="#l24.130"></a><span id="l24.130" class="difflineplus">+[include:mozilla/modules/libpref/test/unit_ipc/xpcshell.ini]</span>
<a href="#l24.131"></a><span id="l24.131" class="difflineplus">+run-if.config = ipc</span>
<a href="#l24.132"></a><span id="l24.132" class="difflineplus">+</span>
<a href="#l24.133"></a><span id="l24.133" class="difflineplus">+[include:mozilla/netwerk/test/unit_ipc/xpcshell.ini]</span>
<a href="#l24.134"></a><span id="l24.134" class="difflineplus">+run-if.config = ipc</span>
<a href="#l24.135"></a><span id="l24.135" class="difflineplus">+</span>
<a href="#l24.136"></a><span id="l24.136" class="difflineplus">+[include:mozilla/netwerk/cookie/test/unit_ipc/xpcshell.ini]</span>
<a href="#l24.137"></a><span id="l24.137" class="difflineplus">+run-if.config = ipc</span>
<a href="#l24.138"></a><span id="l24.138" class="difflineplus">+</span>
<a href="#l24.139"></a><span id="l24.139" class="difflineplus">+[include:mozilla/toolkit/components/contentprefs/tests/unit_ipc/xpcshell.ini]</span>
<a href="#l24.140"></a><span id="l24.140" class="difflineplus">+run-if.config = ipc</span>
<a href="#l24.141"></a><span id="l24.141" class="difflineplus">+</span>
<a href="#l24.142"></a><span id="l24.142" class="difflineplus">+[include:mozilla/uriloader/exthandler/tests/unit_ipc/xpcshell.ini]</span>
<a href="#l24.143"></a><span id="l24.143" class="difflineplus">+run-if.config = ipc</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAddbookUrl.cpp</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAddbookUrl.cpp</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -212,16 +212,39 @@ NS_IMETHODIMP nsAddbookUrl::Clone(nsIURI</span>
<a href="#l25.4"></a><span id="l25.4"> 	return m_baseURL-&gt;Clone(_retval);</span>
<a href="#l25.5"></a><span id="l25.5"> }	</span>
<a href="#l25.6"></a><span id="l25.6"> </span>
<a href="#l25.7"></a><span id="l25.7"> NS_IMETHODIMP nsAddbookUrl::Resolve(const nsACString &amp;relativePath, nsACString &amp;result) </span>
<a href="#l25.8"></a><span id="l25.8"> {</span>
<a href="#l25.9"></a><span id="l25.9"> 	return m_baseURL-&gt;Resolve(relativePath, result);</span>
<a href="#l25.10"></a><span id="l25.10"> }</span>
<a href="#l25.11"></a><span id="l25.11"> </span>
<a href="#l25.12"></a><span id="l25.12" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+nsAddbookUrl::GetRef(nsACString &amp;result)</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+{</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+  return m_baseURL-&gt;GetRef(result);</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineplus">+}</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineplus">+</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineplus">+nsAddbookUrl::SetRef(const nsACString &amp;aRef)</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineplus">+{</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineplus">+  return m_baseURL-&gt;SetRef(aRef);</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineplus">+}</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineplus">+</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineplus">+NS_IMETHODIMP nsAddbookUrl::EqualsExceptRef(nsIURI *other, PRBool *result)</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineplus">+{</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineplus">+  return m_baseURL-&gt;EqualsExceptRef(other, result);</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineplus">+}</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineplus">+</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineplus">+nsAddbookUrl::CloneIgnoringRef(nsIURI** result)</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineplus">+{</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineplus">+  return m_baseURL-&gt;CloneIgnoringRef(result);</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineplus">+}</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineplus">+</span>
<a href="#l25.35"></a><span id="l25.35"> //</span>
<a href="#l25.36"></a><span id="l25.36"> // Specific nsAddbookUrl operations</span>
<a href="#l25.37"></a><span id="l25.37"> //</span>
<a href="#l25.38"></a><span id="l25.38"> NS_IMETHODIMP </span>
<a href="#l25.39"></a><span id="l25.39"> nsAddbookUrl::GetAddbookOperation(PRInt32 *_retval)</span>
<a href="#l25.40"></a><span id="l25.40"> {</span>
<a href="#l25.41"></a><span id="l25.41">   *_retval = mOperationType;</span>
<a href="#l25.42"></a><span id="l25.42">   return NS_OK;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1">new file mode 100644</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineminus">--- /dev/null</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineplus">+++ b/mailnews/addrbook/test/unit/xpcshell.ini</span>
<a href="#l26.4"></a><span id="l26.4" class="difflineat">@@ -0,0 +1,28 @@</span>
<a href="#l26.5"></a><span id="l26.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l26.6"></a><span id="l26.6" class="difflineplus">+head = head_addrbook.js</span>
<a href="#l26.7"></a><span id="l26.7" class="difflineplus">+tail = tail_addrbook.js</span>
<a href="#l26.8"></a><span id="l26.8" class="difflineplus">+</span>
<a href="#l26.9"></a><span id="l26.9" class="difflineplus">+[test_basic_nsIAbCard.js]</span>
<a href="#l26.10"></a><span id="l26.10" class="difflineplus">+[test_basic_nsIAbDirectory.js]</span>
<a href="#l26.11"></a><span id="l26.11" class="difflineplus">+[test_bug387403.js]</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineplus">+[test_bug534822.js]</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+[test_bug_448165.js]</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+[test_cardForEmail.js]</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+[test_collection.js]</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineplus">+[test_collection_2.js]</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineplus">+[test_db_enumerator.js]</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineplus">+[test_ldap1.js]</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineplus">+[test_ldap2.js]</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineplus">+[test_ldapOffline.js]</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineplus">+[test_mailList1.js]</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineplus">+[test_notifications.js]</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineplus">+[test_nsAbAutoCompleteMyDomain.js]</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineplus">+[test_nsAbAutoCompleteSearch1.js]</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineplus">+[test_nsAbAutoCompleteSearch2.js]</span>
<a href="#l26.26"></a><span id="l26.26" class="difflineplus">+[test_nsAbAutoCompleteSearch3.js]</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineplus">+[test_nsAbAutoCompleteSearch4.js]</span>
<a href="#l26.28"></a><span id="l26.28" class="difflineplus">+[test_nsAbAutoCompleteSearch5.js]</span>
<a href="#l26.29"></a><span id="l26.29" class="difflineplus">+[test_nsAbManager1.js]</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineplus">+[test_nsAbManager2.js]</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineplus">+[test_nsIAbCard.js]</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineplus">+[test_uuid.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/base/src/nsMsgFolderCompactor.cpp</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgFolderCompactor.cpp</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -992,17 +992,17 @@ nsOfflineStoreCompactState::OnStopReques</span>
<a href="#l27.4"></a><span id="l27.4">     if (statusFeedback)</span>
<a href="#l27.5"></a><span id="l27.5">       statusFeedback-&gt;ShowProgress (100 * m_curIndex / m_size);</span>
<a href="#l27.6"></a><span id="l27.6">   }</span>
<a href="#l27.7"></a><span id="l27.7">     // advance to next message </span>
<a href="#l27.8"></a><span id="l27.8">   m_curIndex++;</span>
<a href="#l27.9"></a><span id="l27.9">   rv = CopyNextMessage(done);</span>
<a href="#l27.10"></a><span id="l27.10">   if (done)</span>
<a href="#l27.11"></a><span id="l27.11">   {</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-    m_db-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+    m_db-&gt;Commit(nsMsgDBCommitType::kCompressCommit);</span>
<a href="#l27.14"></a><span id="l27.14">     msgHdr = nsnull;</span>
<a href="#l27.15"></a><span id="l27.15">     newMsgHdr = nsnull;</span>
<a href="#l27.16"></a><span id="l27.16">     // no more to copy finish it up</span>
<a href="#l27.17"></a><span id="l27.17">     ReleaseFolderLock();</span>
<a href="#l27.18"></a><span id="l27.18">     FinishCompact();</span>
<a href="#l27.19"></a><span id="l27.19">     Release(); // kill self</span>
<a href="#l27.20"></a><span id="l27.20">   }</span>
<a href="#l27.21"></a><span id="l27.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1">new file mode 100644</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineminus">--- /dev/null</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineplus">+++ b/mailnews/base/test/unit/xpcshell.ini</span>
<a href="#l28.4"></a><span id="l28.4" class="difflineat">@@ -0,0 +1,59 @@</span>
<a href="#l28.5"></a><span id="l28.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l28.6"></a><span id="l28.6" class="difflineplus">+head = head_mailbase.js</span>
<a href="#l28.7"></a><span id="l28.7" class="difflineplus">+tail = tail_base.js</span>
<a href="#l28.8"></a><span id="l28.8" class="difflineplus">+</span>
<a href="#l28.9"></a><span id="l28.9" class="difflineplus">+[test_accountMgr.js]</span>
<a href="#l28.10"></a><span id="l28.10" class="difflineplus">+[test_accountMigration.js]</span>
<a href="#l28.11"></a><span id="l28.11" class="difflineplus">+[test_acctRepair.js]</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineplus">+[test_autoconfigFetchDisk.js]</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+[test_autoconfigUtils.js]</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineplus">+[test_autoconfigXML.js]</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineplus">+[test_bccInDatabase.js]</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineplus">+[test_bug366491.js]</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineplus">+[test_bug404489.js]</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineplus">+[test_bug428427.js]</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineplus">+[test_bug434810.js]</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineplus">+[test_bug465805.js]</span>
<a href="#l28.21"></a><span id="l28.21" class="difflineplus">+[test_bug471682.js]</span>
<a href="#l28.22"></a><span id="l28.22" class="difflineplus">+[test_bug514945.js]</span>
<a href="#l28.23"></a><span id="l28.23" class="difflineplus">+[test_copyChaining.js]</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineplus">+[test_copyThenMoveManual.js]</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineplus">+[test_detachToFile.js]</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineplus">+[test_dictUtils.js]</span>
<a href="#l28.27"></a><span id="l28.27" class="difflineplus">+[test_emptyTrash.js]</span>
<a href="#l28.28"></a><span id="l28.28" class="difflineplus">+[test_fix_deferred_accounts.js]</span>
<a href="#l28.29"></a><span id="l28.29" class="difflineplus">+[test_folderCompact.js]</span>
<a href="#l28.30"></a><span id="l28.30" class="difflineplus">+[test_getMsgTextFromStream.js]</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineplus">+[test_imapPump.js]</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineplus">+[test_inheritedFolderProperties.js]</span>
<a href="#l28.33"></a><span id="l28.33" class="difflineplus">+[test_iteratorUtils.js]</span>
<a href="#l28.34"></a><span id="l28.34" class="difflineplus">+[test_jsTreeSelection.js]</span>
<a href="#l28.35"></a><span id="l28.35" class="difflineplus">+[test_junkingWhenDisabled.js]</span>
<a href="#l28.36"></a><span id="l28.36" class="difflineplus">+[test_junkWhitelisting.js]</span>
<a href="#l28.37"></a><span id="l28.37" class="difflineplus">+[test_loadVirtualFolders.js]</span>
<a href="#l28.38"></a><span id="l28.38" class="difflineplus">+[test_mailServices.js]</span>
<a href="#l28.39"></a><span id="l28.39" class="difflineplus">+[test_mimemaltdetach.js]</span>
<a href="#l28.40"></a><span id="l28.40" class="difflineplus">+[test_nsIMsgFolder.js]</span>
<a href="#l28.41"></a><span id="l28.41" class="difflineplus">+[test_nsIMsgFolderListener.js]</span>
<a href="#l28.42"></a><span id="l28.42" class="difflineplus">+[test_nsIMsgFolderListenerLocal.js]</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineplus">+[test_nsIMsgTagService.js]</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineplus">+[test_nsMailDirProvider.js]</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineplus">+[test_nsMsgDBView.js]</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineplus">+[test_nsMsgMailSession_Alerts.js]</span>
<a href="#l28.47"></a><span id="l28.47" class="difflineplus">+[test_nsMsgMailSession_Listeners.js]</span>
<a href="#l28.48"></a><span id="l28.48" class="difflineplus">+[test_nsMsgTraitService.js]</span>
<a href="#l28.49"></a><span id="l28.49" class="difflineplus">+[test_postPluginFilters.js]</span>
<a href="#l28.50"></a><span id="l28.50" class="difflineplus">+[test_quarantineFilterMove.js]</span>
<a href="#l28.51"></a><span id="l28.51" class="difflineplus">+[test_retention.js]</span>
<a href="#l28.52"></a><span id="l28.52" class="difflineplus">+[test_search.js]</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineplus">+[test_searchAddressInAb.js]</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineplus">+[test_searchBody.js]</span>
<a href="#l28.55"></a><span id="l28.55" class="difflineplus">+[test_searchBoolean.js]</span>
<a href="#l28.56"></a><span id="l28.56" class="difflineplus">+[test_searchChaining.js]</span>
<a href="#l28.57"></a><span id="l28.57" class="difflineplus">+[test_searchCustomTerm.js]</span>
<a href="#l28.58"></a><span id="l28.58" class="difflineplus">+[test_searchJunk.js]</span>
<a href="#l28.59"></a><span id="l28.59" class="difflineplus">+[test_searchLocalizationStrings.js]</span>
<a href="#l28.60"></a><span id="l28.60" class="difflineplus">+[test_searchTag.js]</span>
<a href="#l28.61"></a><span id="l28.61" class="difflineplus">+[test_searchUint32HdrProperty.js]</span>
<a href="#l28.62"></a><span id="l28.62" class="difflineplus">+[test_testsuite_base64.js]</span>
<a href="#l28.63"></a><span id="l28.63" class="difflineplus">+[test_testsuite_fakeserverAuth.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/base/util/nsMsgMailNewsUrl.cpp</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgMailNewsUrl.cpp</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -62,17 +62,16 @@ nsMsgMailNewsUrl::nsMsgMailNewsUrl()</span>
<a href="#l29.4"></a><span id="l29.4">   // nsIURI specific state</span>
<a href="#l29.5"></a><span id="l29.5">   m_errorMessage = nsnull;</span>
<a href="#l29.6"></a><span id="l29.6">   m_runningUrl = PR_FALSE;</span>
<a href="#l29.7"></a><span id="l29.7">   m_updatingFolder = PR_FALSE;</span>
<a href="#l29.8"></a><span id="l29.8">   m_addContentToCache = PR_FALSE;</span>
<a href="#l29.9"></a><span id="l29.9">   m_msgIsInLocalCache = PR_FALSE;</span>
<a href="#l29.10"></a><span id="l29.10">   m_suppressErrorMsgs = PR_FALSE;</span>
<a href="#l29.11"></a><span id="l29.11">   mMaxProgress = -1;</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-  </span>
<a href="#l29.13"></a><span id="l29.13">   m_baseURL = do_CreateInstance(NS_STANDARDURL_CONTRACTID);</span>
<a href="#l29.14"></a><span id="l29.14"> }</span>
<a href="#l29.15"></a><span id="l29.15"> </span>
<a href="#l29.16"></a><span id="l29.16"> #define NOTIFY_URL_LISTENERS(propertyfunc_, params_)                   \</span>
<a href="#l29.17"></a><span id="l29.17">   PR_BEGIN_MACRO                                                       \</span>
<a href="#l29.18"></a><span id="l29.18">   nsTObserverArray&lt;nsCOMPtr&lt;nsIUrlListener&gt; &gt;::ForwardIterator iter(mUrlListeners); \</span>
<a href="#l29.19"></a><span id="l29.19">   while (iter.HasMore()) {                                             \</span>
<a href="#l29.20"></a><span id="l29.20">     nsCOMPtr&lt;nsIUrlListener&gt; listener = iter.GetNext();                \</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineat">@@ -511,16 +510,34 @@ NS_IMETHODIMP nsMsgMailNewsUrl::GetOrigi</span>
<a href="#l29.22"></a><span id="l29.22"> NS_IMETHODIMP nsMsgMailNewsUrl::GetBaseURI(nsIURI **aBaseURI)</span>
<a href="#l29.23"></a><span id="l29.23"> {</span>
<a href="#l29.24"></a><span id="l29.24">   NS_ENSURE_ARG_POINTER(aBaseURI);</span>
<a href="#l29.25"></a><span id="l29.25">   return m_baseURL-&gt;QueryInterface(NS_GET_IID(nsIURI), (void**) aBaseURI);</span>
<a href="#l29.26"></a><span id="l29.26"> }</span>
<a href="#l29.27"></a><span id="l29.27"> </span>
<a href="#l29.28"></a><span id="l29.28"> NS_IMETHODIMP nsMsgMailNewsUrl::Equals(nsIURI *other, PRBool *_retval)</span>
<a href="#l29.29"></a><span id="l29.29"> {</span>
<a href="#l29.30"></a><span id="l29.30" class="difflineplus">+  return EqualsInternal(other, eIgnoreRef, _retval);</span>
<a href="#l29.31"></a><span id="l29.31" class="difflineplus">+}</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineplus">+</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::EqualsExceptRef(nsIURI *other, PRBool *result)</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineplus">+{</span>
<a href="#l29.35"></a><span id="l29.35" class="difflineplus">+  return EqualsInternal(other, eIgnoreRef, result);</span>
<a href="#l29.36"></a><span id="l29.36" class="difflineplus">+}</span>
<a href="#l29.37"></a><span id="l29.37" class="difflineplus">+</span>
<a href="#l29.38"></a><span id="l29.38" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l29.39"></a><span id="l29.39" class="difflineplus">+nsMsgMailNewsUrl::CloneIgnoringRef(nsIURI** result)</span>
<a href="#l29.40"></a><span id="l29.40" class="difflineplus">+{</span>
<a href="#l29.41"></a><span id="l29.41" class="difflineplus">+  return m_baseURL-&gt;CloneIgnoringRef(result);</span>
<a href="#l29.42"></a><span id="l29.42" class="difflineplus">+}</span>
<a href="#l29.43"></a><span id="l29.43" class="difflineplus">+</span>
<a href="#l29.44"></a><span id="l29.44" class="difflineplus">+nsresult nsMsgMailNewsUrl::EqualsInternal(nsIURI *other,</span>
<a href="#l29.45"></a><span id="l29.45" class="difflineplus">+                                          RefHandlingEnum refHandlingMode,</span>
<a href="#l29.46"></a><span id="l29.46" class="difflineplus">+                                          PRBool *_retval)</span>
<a href="#l29.47"></a><span id="l29.47" class="difflineplus">+{</span>
<a href="#l29.48"></a><span id="l29.48">   nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailUrl = do_QueryInterface(other);</span>
<a href="#l29.49"></a><span id="l29.49">   // we really want to compare the base uris to each other, not our base URI</span>
<a href="#l29.50"></a><span id="l29.50">   // with the other's real URI.</span>
<a href="#l29.51"></a><span id="l29.51">   if (mailUrl)</span>
<a href="#l29.52"></a><span id="l29.52">   {</span>
<a href="#l29.53"></a><span id="l29.53">     nsCOMPtr &lt;nsIURI&gt; baseURI;</span>
<a href="#l29.54"></a><span id="l29.54">     mailUrl-&gt;GetBaseURI(getter_AddRefs(baseURI));</span>
<a href="#l29.55"></a><span id="l29.55">     if (baseURI)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/base/util/nsMsgMailNewsUrl.h</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgMailNewsUrl.h</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -75,16 +75,22 @@ public:</span>
<a href="#l30.4"></a><span id="l30.4"> </span>
<a href="#l30.5"></a><span id="l30.5">     NS_DECL_ISUPPORTS</span>
<a href="#l30.6"></a><span id="l30.6">     NS_DECL_NSIMSGMAILNEWSURL</span>
<a href="#l30.7"></a><span id="l30.7">     NS_DECL_NSIURI</span>
<a href="#l30.8"></a><span id="l30.8">     NS_DECL_NSIURL</span>
<a href="#l30.9"></a><span id="l30.9"> </span>
<a href="#l30.10"></a><span id="l30.10"> protected:</span>
<a href="#l30.11"></a><span id="l30.11">   virtual ~nsMsgMailNewsUrl();</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineplus">+  enum RefHandlingEnum {</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+    eIgnoreRef,</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineplus">+    eHonorRef</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineplus">+  };</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineplus">+  nsresult EqualsInternal(nsIURI *other, RefHandlingEnum refHandlingMode,</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineplus">+                          PRBool *_retval);</span>
<a href="#l30.18"></a><span id="l30.18"> </span>
<a href="#l30.19"></a><span id="l30.19">   nsCOMPtr&lt;nsIURL&gt; m_baseURL;</span>
<a href="#l30.20"></a><span id="l30.20">   nsWeakPtr m_statusFeedbackWeak;</span>
<a href="#l30.21"></a><span id="l30.21">   nsWeakPtr m_msgWindowWeak;</span>
<a href="#l30.22"></a><span id="l30.22">   nsWeakPtr m_loadGroupWeak;</span>
<a href="#l30.23"></a><span id="l30.23">   nsCOMPtr&lt;nsIMimeHeaders&gt; mMimeHeaders;</span>
<a href="#l30.24"></a><span id="l30.24">   nsCOMPtr&lt;nsIMsgSearchSession&gt; m_searchSession;</span>
<a href="#l30.25"></a><span id="l30.25">   nsCOMPtr&lt;nsICacheEntryDescriptor&gt; m_memCacheEntry;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/base/util/nsMsgProtocol.cpp</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgProtocol.cpp</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -659,24 +659,24 @@ NS_IMETHODIMP nsMsgProtocol::GetContentT</span>
<a href="#l31.4"></a><span id="l31.4"> NS_IMETHODIMP nsMsgProtocol::SetContentType(const nsACString &amp;aContentType)</span>
<a href="#l31.5"></a><span id="l31.5"> {</span>
<a href="#l31.6"></a><span id="l31.6">     nsCAutoString charset;</span>
<a href="#l31.7"></a><span id="l31.7">     return NS_ParseContentType(aContentType, m_ContentType, charset);</span>
<a href="#l31.8"></a><span id="l31.8"> }</span>
<a href="#l31.9"></a><span id="l31.9"> </span>
<a href="#l31.10"></a><span id="l31.10"> NS_IMETHODIMP nsMsgProtocol::GetContentCharset(nsACString &amp;aContentCharset)</span>
<a href="#l31.11"></a><span id="l31.11"> {</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-  aContentCharset.Truncate();</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+  aContentCharset = m_contentCharset;</span>
<a href="#l31.14"></a><span id="l31.14">   return NS_OK;</span>
<a href="#l31.15"></a><span id="l31.15"> }</span>
<a href="#l31.16"></a><span id="l31.16"> </span>
<a href="#l31.17"></a><span id="l31.17"> NS_IMETHODIMP nsMsgProtocol::SetContentCharset(const nsACString &amp;aContentCharset)</span>
<a href="#l31.18"></a><span id="l31.18"> {</span>
<a href="#l31.19"></a><span id="l31.19" class="difflineminus">-  NS_WARNING(&quot;nsMsgProtocol::SetContentCharset() not implemented&quot;);</span>
<a href="#l31.20"></a><span id="l31.20" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineplus">+  m_contentCharset = aContentCharset;</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineplus">+  return NS_OK;</span>
<a href="#l31.23"></a><span id="l31.23"> }</span>
<a href="#l31.24"></a><span id="l31.24"> </span>
<a href="#l31.25"></a><span id="l31.25"> NS_IMETHODIMP nsMsgProtocol::GetContentLength(PRInt32 *aContentLength)</span>
<a href="#l31.26"></a><span id="l31.26"> {</span>
<a href="#l31.27"></a><span id="l31.27">   *aContentLength = mContentLength;</span>
<a href="#l31.28"></a><span id="l31.28">   return NS_OK;</span>
<a href="#l31.29"></a><span id="l31.29"> }</span>
<a href="#l31.30"></a><span id="l31.30"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/base/util/nsMsgProtocol.h</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgProtocol.h</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -186,16 +186,17 @@ protected:</span>
<a href="#l32.4"></a><span id="l32.4">   nsCOMPtr&lt;nsISupports&gt;        m_channelContext;</span>
<a href="#l32.5"></a><span id="l32.5">   nsCOMPtr&lt;nsILoadGroup&gt;      m_loadGroup;</span>
<a href="#l32.6"></a><span id="l32.6">   nsLoadFlags                 mLoadFlags;</span>
<a href="#l32.7"></a><span id="l32.7">   nsCOMPtr&lt;nsIProgressEventSink&gt; mProgressEventSink;</span>
<a href="#l32.8"></a><span id="l32.8">   nsCOMPtr&lt;nsIInterfaceRequestor&gt; mCallbacks;</span>
<a href="#l32.9"></a><span id="l32.9">   nsCOMPtr&lt;nsISupports&gt;       mOwner;</span>
<a href="#l32.10"></a><span id="l32.10">   nsCString                   m_ContentType;</span>
<a href="#l32.11"></a><span id="l32.11">   PRInt32                     mContentLength;</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineplus">+  nsCString                   m_contentCharset;</span>
<a href="#l32.13"></a><span id="l32.13"> </span>
<a href="#l32.14"></a><span id="l32.14">   nsCString m_lastPasswordSent; // used to prefill the password prompt</span>
<a href="#l32.15"></a><span id="l32.15"> </span>
<a href="#l32.16"></a><span id="l32.16">   // private helper routine used by subclasses to quickly get a reference to the correct prompt dialog</span>
<a href="#l32.17"></a><span id="l32.17">   // for a mailnews url. </span>
<a href="#l32.18"></a><span id="l32.18">   nsresult GetPromptDialogFromUrl(nsIMsgMailNewsUrl * aMsgUrl, nsIPrompt ** aPromptDialog);</span>
<a href="#l32.19"></a><span id="l32.19"> </span>
<a href="#l32.20"></a><span id="l32.20">   // if a url isn't going to result in any content then we want to suppress calls to</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpUrl.cpp</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpUrl.cpp</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -660,18 +660,37 @@ NS_IMETHODIMP nsMailtoUrl::Clone(nsIURI </span>
<a href="#l33.4"></a><span id="l33.4"> 	return m_baseURL-&gt;Clone(_retval);</span>
<a href="#l33.5"></a><span id="l33.5"> }	</span>
<a href="#l33.6"></a><span id="l33.6"> </span>
<a href="#l33.7"></a><span id="l33.7"> NS_IMETHODIMP nsMailtoUrl::Resolve(const nsACString &amp;relativePath, nsACString &amp;result) </span>
<a href="#l33.8"></a><span id="l33.8"> {</span>
<a href="#l33.9"></a><span id="l33.9"> 	return m_baseURL-&gt;Resolve(relativePath, result);</span>
<a href="#l33.10"></a><span id="l33.10"> }</span>
<a href="#l33.11"></a><span id="l33.11"> </span>
<a href="#l33.12"></a><span id="l33.12" class="difflineplus">+NS_IMETHODIMP nsMailtoUrl::SetRef(const nsACString &amp;aRef)</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+{</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineplus">+  return m_baseURL-&gt;SetRef(aRef);</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineplus">+}</span>
<a href="#l33.16"></a><span id="l33.16"> </span>
<a href="#l33.17"></a><span id="l33.17" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineplus">+nsMailtoUrl::GetRef(nsACString &amp;result)</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineplus">+{</span>
<a href="#l33.20"></a><span id="l33.20" class="difflineplus">+  return m_baseURL-&gt;GetRef(result);</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineplus">+}</span>
<a href="#l33.22"></a><span id="l33.22"> </span>
<a href="#l33.23"></a><span id="l33.23" class="difflineplus">+NS_IMETHODIMP nsMailtoUrl::EqualsExceptRef(nsIURI *other, PRBool *result)</span>
<a href="#l33.24"></a><span id="l33.24" class="difflineplus">+{</span>
<a href="#l33.25"></a><span id="l33.25" class="difflineplus">+  return m_baseURL-&gt;EqualsExceptRef(other, result);</span>
<a href="#l33.26"></a><span id="l33.26" class="difflineplus">+}</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineplus">+</span>
<a href="#l33.28"></a><span id="l33.28" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l33.29"></a><span id="l33.29" class="difflineplus">+nsMailtoUrl::CloneIgnoringRef(nsIURI** result)</span>
<a href="#l33.30"></a><span id="l33.30" class="difflineplus">+{</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineplus">+  return m_baseURL-&gt;CloneIgnoringRef(result);</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineplus">+}</span>
<a href="#l33.33"></a><span id="l33.33"> </span>
<a href="#l33.34"></a><span id="l33.34"> /////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l33.35"></a><span id="l33.35"> // smtp url definition</span>
<a href="#l33.36"></a><span id="l33.36"> /////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l33.37"></a><span id="l33.37"> </span>
<a href="#l33.38"></a><span id="l33.38"> nsSmtpUrl::nsSmtpUrl() : nsMsgMailNewsUrl()</span>
<a href="#l33.39"></a><span id="l33.39"> {</span>
<a href="#l33.40"></a><span id="l33.40">   // nsISmtpUrl specific state...</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1">new file mode 100644</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineminus">--- /dev/null</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineplus">+++ b/mailnews/compose/test/unit/xpcshell.ini</span>
<a href="#l34.4"></a><span id="l34.4" class="difflineat">@@ -0,0 +1,30 @@</span>
<a href="#l34.5"></a><span id="l34.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l34.6"></a><span id="l34.6" class="difflineplus">+head = head_compose.js</span>
<a href="#l34.7"></a><span id="l34.7" class="difflineplus">+tail = tail_compose.js</span>
<a href="#l34.8"></a><span id="l34.8" class="difflineplus">+</span>
<a href="#l34.9"></a><span id="l34.9" class="difflineplus">+[test_attachment.js]</span>
<a href="#l34.10"></a><span id="l34.10" class="difflineplus">+[test_attachment_intl.js]</span>
<a href="#l34.11"></a><span id="l34.11" class="difflineplus">+[test_bug155172.js]</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineplus">+[test_bug474774.js]</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+[test_detectAttachmentCharset.js]</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineplus">+[test_mailtoURL.js]</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineplus">+[test_nsMsgCompose1.js]</span>
<a href="#l34.16"></a><span id="l34.16" class="difflineplus">+[test_nsMsgCompose2.js]</span>
<a href="#l34.17"></a><span id="l34.17" class="difflineplus">+[test_nsMsgCompose3.js]</span>
<a href="#l34.18"></a><span id="l34.18" class="difflineplus">+[test_nsSmtpService1.js]</span>
<a href="#l34.19"></a><span id="l34.19" class="difflineplus">+[test_saveDraft.js]</span>
<a href="#l34.20"></a><span id="l34.20" class="difflineplus">+[test_sendBackground.js]</span>
<a href="#l34.21"></a><span id="l34.21" class="difflineplus">+[test_sendMailMessage.js]</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineplus">+[test_sendMessageFile.js]</span>
<a href="#l34.23"></a><span id="l34.23" class="difflineplus">+[test_sendMessageLater.js]</span>
<a href="#l34.24"></a><span id="l34.24" class="difflineplus">+[test_sendMessageLater2.js]</span>
<a href="#l34.25"></a><span id="l34.25" class="difflineplus">+[test_sendMessageLater3.js]</span>
<a href="#l34.26"></a><span id="l34.26" class="difflineplus">+[test_smtpAuthMethods.js]</span>
<a href="#l34.27"></a><span id="l34.27" class="difflineplus">+[test_smtpPassword.js]</span>
<a href="#l34.28"></a><span id="l34.28" class="difflineplus">+[test_smtpPassword2.js]</span>
<a href="#l34.29"></a><span id="l34.29" class="difflineplus">+[test_smtpPasswordFailure1.js]</span>
<a href="#l34.30"></a><span id="l34.30" class="difflineplus">+[test_smtpPasswordFailure2.js]</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineplus">+[test_smtpPasswordFailure3.js]</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineplus">+[test_smtpProtocols.js]</span>
<a href="#l34.33"></a><span id="l34.33" class="difflineplus">+[test_smtpURL.js]</span>
<a href="#l34.34"></a><span id="l34.34" class="difflineplus">+[test_splitRecipients.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1">new file mode 100644</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineminus">--- /dev/null</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/xpcshell.ini</span>
<a href="#l35.4"></a><span id="l35.4" class="difflineat">@@ -0,0 +1,31 @@</span>
<a href="#l35.5"></a><span id="l35.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l35.6"></a><span id="l35.6" class="difflineplus">+head = head_gloda.js</span>
<a href="#l35.7"></a><span id="l35.7" class="difflineplus">+tail = tail_gloda.js</span>
<a href="#l35.8"></a><span id="l35.8" class="difflineplus">+</span>
<a href="#l35.9"></a><span id="l35.9" class="difflineplus">+[test_cleanup_msf_databases.js]</span>
<a href="#l35.10"></a><span id="l35.10" class="difflineplus">+[test_corrupt_database.js]</span>
<a href="#l35.11"></a><span id="l35.11" class="difflineplus">+[test_folder_logic.js]</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineplus">+[test_gloda_content_imap_offline.js]</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+[test_gloda_content_local.js]</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineplus">+[test_index_addressbook.js]</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+[test_index_bad_messages.js]</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineplus">+[test_index_compaction.js]</span>
<a href="#l35.17"></a><span id="l35.17" class="difflineplus">+[test_index_junk_imap_offline.js]</span>
<a href="#l35.18"></a><span id="l35.18" class="difflineplus">+[test_index_junk_imap_online.js]</span>
<a href="#l35.19"></a><span id="l35.19" class="difflineplus">+[test_index_junk_local.js]</span>
<a href="#l35.20"></a><span id="l35.20" class="difflineplus">+[test_index_messages_imap_offline.js]</span>
<a href="#l35.21"></a><span id="l35.21" class="difflineplus">+[test_index_messages_imap_online.js]</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineplus">+[test_index_messages_imap_online_to_offline.js]</span>
<a href="#l35.23"></a><span id="l35.23" class="difflineplus">+[test_index_messages_local.js]</span>
<a href="#l35.24"></a><span id="l35.24" class="difflineplus">+[test_index_sweep_folder.js]</span>
<a href="#l35.25"></a><span id="l35.25" class="difflineplus">+[test_intl.js]</span>
<a href="#l35.26"></a><span id="l35.26" class="difflineplus">+[test_mime_attachments_size.js]</span>
<a href="#l35.27"></a><span id="l35.27" class="difflineplus">+[test_mime_emitter.js]</span>
<a href="#l35.28"></a><span id="l35.28" class="difflineplus">+[test_msg_search.js]</span>
<a href="#l35.29"></a><span id="l35.29" class="difflineplus">+[test_noun_mimetype.js]</span>
<a href="#l35.30"></a><span id="l35.30" class="difflineplus">+[test_query_core.js]</span>
<a href="#l35.31"></a><span id="l35.31" class="difflineplus">+[test_query_messages_imap_offline.js]</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineplus">+[test_query_messages_imap_online.js]</span>
<a href="#l35.33"></a><span id="l35.33" class="difflineplus">+[test_query_messages_imap_online_to_offline.js]</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineplus">+[test_query_messages_local.js]</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineplus">+[test_startup_offline.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1">new file mode 100644</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineminus">--- /dev/null</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineplus">+++ b/mailnews/db/msgdb/test/unit/xpcshell.ini</span>
<a href="#l36.4"></a><span id="l36.4" class="difflineat">@@ -0,0 +1,9 @@</span>
<a href="#l36.5"></a><span id="l36.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l36.6"></a><span id="l36.6" class="difflineplus">+head = head_maildb.js</span>
<a href="#l36.7"></a><span id="l36.7" class="difflineplus">+tail = tail_msgdb.js</span>
<a href="#l36.8"></a><span id="l36.8" class="difflineplus">+</span>
<a href="#l36.9"></a><span id="l36.9" class="difflineplus">+[test_enumerator_cleanup.js]</span>
<a href="#l36.10"></a><span id="l36.10" class="difflineplus">+[test_filter_enumerator.js]</span>
<a href="#l36.11"></a><span id="l36.11" class="difflineplus">+[test_maildb.js]</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineplus">+[test_propertyEnumerator.js]</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+[test_references_parsing.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1">new file mode 100644</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineminus">--- /dev/null</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineplus">+++ b/mailnews/extensions/bayesian-spam-filter/test/unit/xpcshell.ini</span>
<a href="#l37.4"></a><span id="l37.4" class="difflineat">@@ -0,0 +1,10 @@</span>
<a href="#l37.5"></a><span id="l37.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l37.6"></a><span id="l37.6" class="difflineplus">+head = head_bayes.js</span>
<a href="#l37.7"></a><span id="l37.7" class="difflineplus">+tail = tail_bayesian.js</span>
<a href="#l37.8"></a><span id="l37.8" class="difflineplus">+</span>
<a href="#l37.9"></a><span id="l37.9" class="difflineplus">+[test_bug228675.js]</span>
<a href="#l37.10"></a><span id="l37.10" class="difflineplus">+[test_customTokenization.js]</span>
<a href="#l37.11"></a><span id="l37.11" class="difflineplus">+[test_junkAsTraits.js]</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineplus">+[test_msgCorpus.js]</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+[test_traitAliases.js]</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineplus">+[test_traits.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1">new file mode 100644</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineminus">--- /dev/null</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineplus">+++ b/mailnews/extensions/mdn/test/unit/xpcshell.ini</span>
<a href="#l38.4"></a><span id="l38.4" class="difflineat">@@ -0,0 +1,6 @@</span>
<a href="#l38.5"></a><span id="l38.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l38.6"></a><span id="l38.6" class="difflineplus">+head = </span>
<a href="#l38.7"></a><span id="l38.7" class="difflineplus">+tail =</span>
<a href="#l38.8"></a><span id="l38.8" class="difflineplus">+</span>
<a href="#l38.9"></a><span id="l38.9" class="difflineplus">+[test_askuser.js]</span>
<a href="#l38.10"></a><span id="l38.10" class="difflineplus">+[test_mdnFlags.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mailnews/imap/public/nsIImapMailFolderSink.idl</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mailnews/imap/public/nsIImapMailFolderSink.idl</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -59,17 +59,17 @@ interface ImapOnlineCopyStateType</span>
<a href="#l39.4"></a><span id="l39.4">    const long kFailedDelete = 4;</span>
<a href="#l39.5"></a><span id="l39.5">    const long kReadyForAppendData = 5;</span>
<a href="#l39.6"></a><span id="l39.6">    const long kFailedAppend = 6;</span>
<a href="#l39.7"></a><span id="l39.7">    const long kInterruptedState = 7;</span>
<a href="#l39.8"></a><span id="l39.8">    const long kFailedCopy = 8;</span>
<a href="#l39.9"></a><span id="l39.9">    const long kFailedMove = 9;</span>
<a href="#l39.10"></a><span id="l39.10"> };</span>
<a href="#l39.11"></a><span id="l39.11"> </span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-[scriptable, uuid(531d4a3a-4921-4b7d-a46d-c66be8bec781)]</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineplus">+[scriptable, uuid(e16c3399-285a-4e1b-8940-c3352200aa9c)]</span>
<a href="#l39.14"></a><span id="l39.14"> interface nsIImapMailFolderSink : nsISupports {</span>
<a href="#l39.15"></a><span id="l39.15">   attribute boolean folderNeedsACLListed;</span>
<a href="#l39.16"></a><span id="l39.16">   attribute boolean folderNeedsSubscribing;</span>
<a href="#l39.17"></a><span id="l39.17">   attribute boolean folderNeedsAdded;</span>
<a href="#l39.18"></a><span id="l39.18">   attribute unsigned long aclFlags;</span>
<a href="#l39.19"></a><span id="l39.19">   attribute long uidValidity;</span>
<a href="#l39.20"></a><span id="l39.20">   /**</span>
<a href="#l39.21"></a><span id="l39.21">    * Whether we have asked the server for this folder's quota information.</span>
<a href="#l39.22"></a><span id="l39.22" class="difflineat">@@ -82,36 +82,49 @@ interface nsIImapMailFolderSink : nsISup</span>
<a href="#l39.23"></a><span id="l39.23">    * @param aFolderQuotaRoot    The IMAP quota root for this folder, </span>
<a href="#l39.24"></a><span id="l39.24">    *                            as returned by the GETQUOTAROOT IMAP command.</span>
<a href="#l39.25"></a><span id="l39.25">    * @param aFolderQuotaUsedKB  Used space, in KB, on this folder's quota root.</span>
<a href="#l39.26"></a><span id="l39.26">    * @param aFolderQuotaMaxKB   Size, in KB, of this folder's quota root.</span>
<a href="#l39.27"></a><span id="l39.27">    **/</span>
<a href="#l39.28"></a><span id="l39.28">   void setFolderQuotaData(in ACString aFolderQuotaRoot, in unsigned long aFolderQuotaUsedKB, </span>
<a href="#l39.29"></a><span id="l39.29">                           in unsigned long aFolderQuotaMaxKB);</span>
<a href="#l39.30"></a><span id="l39.30"> </span>
<a href="#l39.31"></a><span id="l39.31" class="difflineplus">+  /// Should we download all the rfc822 headers of messages, instead of subset.</span>
<a href="#l39.32"></a><span id="l39.32">   readonly attribute boolean shouldDownloadAllHeaders;</span>
<a href="#l39.33"></a><span id="l39.33">   string GetOnlineDelimiter();</span>
<a href="#l39.34"></a><span id="l39.34">   void OnNewIdleMessages();</span>
<a href="#l39.35"></a><span id="l39.35">   // Tell mail master about the newly selected mailbox</span>
<a href="#l39.36"></a><span id="l39.36">   void UpdateImapMailboxInfo(in nsIImapProtocol aProtocol,</span>
<a href="#l39.37"></a><span id="l39.37" class="difflineminus">-                                   in nsIMailboxSpec aSpec);</span>
<a href="#l39.38"></a><span id="l39.38" class="difflineplus">+                             in nsIMailboxSpec aSpec);</span>
<a href="#l39.39"></a><span id="l39.39">   void UpdateImapMailboxStatus(in nsIImapProtocol aProtocol,</span>
<a href="#l39.40"></a><span id="l39.40" class="difflineminus">-                                     in nsIMailboxSpec aSpec);</span>
<a href="#l39.41"></a><span id="l39.41" class="difflineplus">+                               in nsIMailboxSpec aSpec);</span>
<a href="#l39.42"></a><span id="l39.42" class="difflineplus">+  /**</span>
<a href="#l39.43"></a><span id="l39.43" class="difflineplus">+   * Used when downloading headers in chunks.</span>
<a href="#l39.44"></a><span id="l39.44" class="difflineplus">+   * @param aSpec Mailbox spec of folder we're downloading headers for.</span>
<a href="#l39.45"></a><span id="l39.45" class="difflineplus">+   * @returns true if more to download, false otherwise.</span>
<a href="#l39.46"></a><span id="l39.46" class="difflineplus">+   * @returns total count of headers to download (across all chunks)</span>
<a href="#l39.47"></a><span id="l39.47" class="difflineplus">+   * @returns an array of msg keys to download, array size is this chunk's size</span>
<a href="#l39.48"></a><span id="l39.48" class="difflineplus">+   */</span>
<a href="#l39.49"></a><span id="l39.49" class="difflineplus">+  void getMsgHdrsToDownload(out boolean aMore, out long aTotalCount,</span>
<a href="#l39.50"></a><span id="l39.50" class="difflineplus">+                            out unsigned long aCount,</span>
<a href="#l39.51"></a><span id="l39.51" class="difflineplus">+                            [retval, array, size_is(aCount)] out nsMsgKey aKeys);</span>
<a href="#l39.52"></a><span id="l39.52">   void parseMsgHdrs(in nsIImapProtocol aProtocol, in nsIImapHeaderXferInfo aHdrXferInfo);</span>
<a href="#l39.53"></a><span id="l39.53">   void AbortHeaderParseStream(in nsIImapProtocol aProtocol) ;</span>
<a href="#l39.54"></a><span id="l39.54">   </span>
<a href="#l39.55"></a><span id="l39.55">   void OnlineCopyCompleted(in nsIImapProtocol aProtocol, in ImapOnlineCopyState aCopyState);</span>
<a href="#l39.56"></a><span id="l39.56">   void StartMessage(in nsIMsgMailNewsUrl aUrl);</span>
<a href="#l39.57"></a><span id="l39.57">   void EndMessage(in nsIMsgMailNewsUrl aUrl, in nsMsgKey uidOfMessage);</span>
<a href="#l39.58"></a><span id="l39.58"> </span>
<a href="#l39.59"></a><span id="l39.59">   void NotifySearchHit(in nsIMsgMailNewsUrl aUrl, in string hitLine);</span>
<a href="#l39.60"></a><span id="l39.60"> </span>
<a href="#l39.61"></a><span id="l39.61">   void copyNextStreamMessage(in boolean copySucceeded, in nsISupports copyState);</span>
<a href="#l39.62"></a><span id="l39.62">   void closeMockChannel(in nsIImapMockChannel aChannel);</span>
<a href="#l39.63"></a><span id="l39.63" class="difflineminus">-  void setUrlState(in nsIImapProtocol aProtocol, in nsIMsgMailNewsUrl aUrl, in boolean isRunning, in nsresult status);</span>
<a href="#l39.64"></a><span id="l39.64" class="difflineplus">+  void setUrlState(in nsIImapProtocol aProtocol, in nsIMsgMailNewsUrl aUrl,</span>
<a href="#l39.65"></a><span id="l39.65" class="difflineplus">+                   in boolean isRunning, in boolean aSuspend,</span>
<a href="#l39.66"></a><span id="l39.66" class="difflineplus">+                   in nsresult status);</span>
<a href="#l39.67"></a><span id="l39.67">   void releaseUrlCacheEntry(in nsIMsgMailNewsUrl aUrl);</span>
<a href="#l39.68"></a><span id="l39.68"> </span>
<a href="#l39.69"></a><span id="l39.69">   void headerFetchCompleted(in nsIImapProtocol aProtocol);</span>
<a href="#l39.70"></a><span id="l39.70">   void setBiffStateAndUpdate(in long biffState);</span>
<a href="#l39.71"></a><span id="l39.71">   void progressStatus(in nsIImapProtocol aProtocol, in unsigned long aMsgId, in wstring extraInfo);</span>
<a href="#l39.72"></a><span id="l39.72">   void percentProgress(in nsIImapProtocol aProtocol, in wstring aMessage, </span>
<a href="#l39.73"></a><span id="l39.73">                        in long long aCurrentProgress, in long long aMaxProgressProgressInfo);</span>
<a href="#l39.74"></a><span id="l39.74"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mailnews/imap/public/nsIImapProtocol.idl</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mailnews/imap/public/nsIImapProtocol.idl</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -43,17 +43,17 @@ interface nsIURI;</span>
<a href="#l40.4"></a><span id="l40.4"> interface nsIImapUrl;</span>
<a href="#l40.5"></a><span id="l40.5"> interface nsIEventTarget;</span>
<a href="#l40.6"></a><span id="l40.6"> interface nsIImapProtocol;</span>
<a href="#l40.7"></a><span id="l40.7"> interface nsIImapIncomingServer;</span>
<a href="#l40.8"></a><span id="l40.8"> interface nsIMsgFolder;</span>
<a href="#l40.9"></a><span id="l40.9"> interface nsIImapHostSessionList;</span>
<a href="#l40.10"></a><span id="l40.10"> interface nsIMsgWindow;</span>
<a href="#l40.11"></a><span id="l40.11"> </span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-[scriptable, uuid(49816377-9319-48f8-8c90-7efadff8e628)]</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineplus">+[scriptable, uuid(1c3bbfa9-69f7-4716-8986-2dba10cefb09)]</span>
<a href="#l40.14"></a><span id="l40.14"> interface nsIImapProtocol : nsISupports {</span>
<a href="#l40.15"></a><span id="l40.15">   void LoadImapUrl(in nsIURI aUrl, in nsISupports aConsumer);</span>
<a href="#l40.16"></a><span id="l40.16"> </span>
<a href="#l40.17"></a><span id="l40.17">   /**</span>
<a href="#l40.18"></a><span id="l40.18">    * IsBusy returns true if the connection is currently processing a url</span>
<a href="#l40.19"></a><span id="l40.19">    * and false otherwise.</span>
<a href="#l40.20"></a><span id="l40.20">    */</span>
<a href="#l40.21"></a><span id="l40.21">   void IsBusy(out boolean aIsConnectionBusy,</span>
<a href="#l40.22"></a><span id="l40.22" class="difflineat">@@ -71,17 +71,16 @@ interface nsIImapProtocol : nsISupports </span>
<a href="#l40.23"></a><span id="l40.23">   /**</span>
<a href="#l40.24"></a><span id="l40.24">    * Right now, initialize requires the event queue of the UI thread,</span>
<a href="#l40.25"></a><span id="l40.25">    * or more importantly the event queue of the consumer of the imap</span>
<a href="#l40.26"></a><span id="l40.26">    * protocol data. The protocol also needs a host session list.</span>
<a href="#l40.27"></a><span id="l40.27">    */</span>
<a href="#l40.28"></a><span id="l40.28">   void Initialize(in nsIImapHostSessionList aHostSessionList, in nsIImapIncomingServer aServer,</span>
<a href="#l40.29"></a><span id="l40.29">                   in nsIEventTarget aSinkEventTarget);</span>
<a href="#l40.30"></a><span id="l40.30"> </span>
<a href="#l40.31"></a><span id="l40.31" class="difflineminus">-  void NotifyHdrsToDownload(out unsigned long keys, in unsigned long keyCount);</span>
<a href="#l40.32"></a><span id="l40.32">   void NotifyBodysToDownload(out unsigned long keys, in unsigned long count);</span>
<a href="#l40.33"></a><span id="l40.33">   // methods to get data from the imap parser flag state.</span>
<a href="#l40.34"></a><span id="l40.34">   void GetFlagsForUID(in unsigned long uid, out boolean foundIt, out unsigned short flags, out string customFlags);</span>
<a href="#l40.35"></a><span id="l40.35">   void GetSupportedUserFlags(out unsigned short flags);</span>
<a href="#l40.36"></a><span id="l40.36"> </span>
<a href="#l40.37"></a><span id="l40.37">   void GetRunningImapURL(out nsIImapUrl aImapUrl);</span>
<a href="#l40.38"></a><span id="l40.38"> </span>
<a href="#l40.39"></a><span id="l40.39">   void GetRunningUrl(out nsIURI aUrl);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mailnews/imap/public/nsIImapServerSink.idl</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mailnews/imap/public/nsIImapServerSink.idl</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -43,17 +43,17 @@ interface nsIMsgMailNewsUrl;</span>
<a href="#l41.4"></a><span id="l41.4"> interface nsIImapProtocol;</span>
<a href="#l41.5"></a><span id="l41.5"> interface nsIImapUrl;</span>
<a href="#l41.6"></a><span id="l41.6"> interface nsIImapMockChannel;</span>
<a href="#l41.7"></a><span id="l41.7"> </span>
<a href="#l41.8"></a><span id="l41.8"> /**</span>
<a href="#l41.9"></a><span id="l41.9">  * nsIImapServerSink is designed to be used as a proxy to the application's UI</span>
<a href="#l41.10"></a><span id="l41.10">  * thread from the running IMAP threads.</span>
<a href="#l41.11"></a><span id="l41.11">  */</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-[scriptable, uuid(596cbacd-53d2-468e-9ea3-fe2512cb3997)]</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+[scriptable, uuid(24136ca7-0000-4731-8d5f-fc0908aa7c75)]</span>
<a href="#l41.14"></a><span id="l41.14"> interface nsIImapServerSink : nsISupports {</span>
<a href="#l41.15"></a><span id="l41.15">   /**</span>
<a href="#l41.16"></a><span id="l41.16">    * Check if the given folder path is a possible IMAP mailbox.</span>
<a href="#l41.17"></a><span id="l41.17">    * @param folderPath folder path to check</span>
<a href="#l41.18"></a><span id="l41.18">    * @param hierarchyDelimiter IMAP hierarchy delimiter in canonical format,</span>
<a href="#l41.19"></a><span id="l41.19">    *                           i.e., hierarchy delimiter has been replaced</span>
<a href="#l41.20"></a><span id="l41.20">    *                           with '/'</span>
<a href="#l41.21"></a><span id="l41.21">    * @param boxFlags IMAP folder flags (for subscription, namespaces etc.)</span>
<a href="#l41.22"></a><span id="l41.22" class="difflineat">@@ -81,16 +81,25 @@ interface nsIImapServerSink : nsISupport</span>
<a href="#l41.23"></a><span id="l41.23">    * Prepare to retry the given URL.</span>
<a href="#l41.24"></a><span id="l41.24">    * @param imapUrl the url we're going to retry</span>
<a href="#l41.25"></a><span id="l41.25">    * @return channel to associate with the url. We return this because access</span>
<a href="#l41.26"></a><span id="l41.26">    *         to the channel should only happen on the ui thread.</span>
<a href="#l41.27"></a><span id="l41.27">    */</span>
<a href="#l41.28"></a><span id="l41.28">   nsIImapMockChannel prepareToRetryUrl(in nsIImapUrl imapUrl);</span>
<a href="#l41.29"></a><span id="l41.29"> </span>
<a href="#l41.30"></a><span id="l41.30">   /**</span>
<a href="#l41.31"></a><span id="l41.31" class="difflineplus">+   * Suspend the url. This puts it at the end of the queue. If the queue is</span>
<a href="#l41.32"></a><span id="l41.32" class="difflineplus">+   * empty, the url will get resumed immediately. Currently, the plan is</span>
<a href="#l41.33"></a><span id="l41.33" class="difflineplus">+   * do this when we have to download a lot of headers in chunks, though we</span>
<a href="#l41.34"></a><span id="l41.34" class="difflineplus">+   * could find other uses for it.</span>
<a href="#l41.35"></a><span id="l41.35" class="difflineplus">+   * @param imapUrl url to suspend</span>
<a href="#l41.36"></a><span id="l41.36" class="difflineplus">+   */</span>
<a href="#l41.37"></a><span id="l41.37" class="difflineplus">+  void suspendUrl(in nsIImapUrl aImapUrl);</span>
<a href="#l41.38"></a><span id="l41.38" class="difflineplus">+</span>
<a href="#l41.39"></a><span id="l41.39" class="difflineplus">+  /**</span>
<a href="#l41.40"></a><span id="l41.40">    * Retry the given URL.</span>
<a href="#l41.41"></a><span id="l41.41">    * @param imapUrl url to retry</span>
<a href="#l41.42"></a><span id="l41.42">    * @param channel the channel to associate with the url</span>
<a href="#l41.43"></a><span id="l41.43">    */</span>
<a href="#l41.44"></a><span id="l41.44">   void retryUrl(in nsIImapUrl imapUrl, in nsIImapMockChannel channel);</span>
<a href="#l41.45"></a><span id="l41.45"> </span>
<a href="#l41.46"></a><span id="l41.46">   /**</span>
<a href="#l41.47"></a><span id="l41.47">    * If previous URL failed, this gives server chance to abort URLs with same</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/mailnews/imap/public/nsIImapUrl.idl</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/mailnews/imap/public/nsIImapUrl.idl</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -55,17 +55,17 @@ typedef long nsImapContentModifiedType;</span>
<a href="#l42.4"></a><span id="l42.4"> interface nsImapContentModifiedTypes</span>
<a href="#l42.5"></a><span id="l42.5"> {</span>
<a href="#l42.6"></a><span id="l42.6">   const long IMAP_CONTENT_NOT_MODIFIED = 0;</span>
<a href="#l42.7"></a><span id="l42.7">   const long IMAP_CONTENT_MODIFIED_VIEW_INLINE = 1;</span>
<a href="#l42.8"></a><span id="l42.8">   const long IMAP_CONTENT_MODIFIED_VIEW_AS_LINKS = 2;</span>
<a href="#l42.9"></a><span id="l42.9">   const long IMAP_CONTENT_FORCE_CONTENT_NOT_MODIFIED = 3;</span>
<a href="#l42.10"></a><span id="l42.10"> } ;</span>
<a href="#l42.11"></a><span id="l42.11"> </span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-[scriptable, uuid(efd92a5f-a4fe-4093-ac9c-d23fae3950cd)]</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+[scriptable, uuid(fe2a8f9e-2886-4146-9896-27fff660c69f)]</span>
<a href="#l42.14"></a><span id="l42.14"> interface nsIImapUrl : nsISupports</span>
<a href="#l42.15"></a><span id="l42.15"> {</span>
<a href="#l42.16"></a><span id="l42.16">   ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l42.17"></a><span id="l42.17">   // Getters and Setters for the imap specific event sinks to bind to to the url</span>
<a href="#l42.18"></a><span id="l42.18">   ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l42.19"></a><span id="l42.19">   attribute nsIImapMailFolderSink imapMailFolderSink;</span>
<a href="#l42.20"></a><span id="l42.20">   attribute nsIImapMessageSink imapMessageSink;</span>
<a href="#l42.21"></a><span id="l42.21">   attribute nsIImapServerSink imapServerSink;</span>
<a href="#l42.22"></a><span id="l42.22" class="difflineat">@@ -126,16 +126,24 @@ interface nsIImapUrl : nsISupports</span>
<a href="#l42.23"></a><span id="l42.23">    * this to true. Currently, nsIMsgMessageService.streamMessage does this.</span>
<a href="#l42.24"></a><span id="l42.24">    */</span>
<a href="#l42.25"></a><span id="l42.25">   attribute boolean localFetchOnly;</span>
<a href="#l42.26"></a><span id="l42.26"> </span>
<a href="#l42.27"></a><span id="l42.27">   /// Server disconnected first time so we're retrying.</span>
<a href="#l42.28"></a><span id="l42.28">   attribute boolean rerunningUrl;</span>
<a href="#l42.29"></a><span id="l42.29"> </span>
<a href="#l42.30"></a><span id="l42.30">   /**</span>
<a href="#l42.31"></a><span id="l42.31" class="difflineplus">+   * Do we have more headers to download? This is set when we decide to</span>
<a href="#l42.32"></a><span id="l42.32" class="difflineplus">+   * download newest headers first, followed by older headers in a subsequent</span>
<a href="#l42.33"></a><span id="l42.33" class="difflineplus">+   * run of the url, which allows other urls to run against the folder in the</span>
<a href="#l42.34"></a><span id="l42.34" class="difflineplus">+   * meantime.</span>
<a href="#l42.35"></a><span id="l42.35" class="difflineplus">+   */</span>
<a href="#l42.36"></a><span id="l42.36" class="difflineplus">+  attribute boolean moreHeadersToDownload;</span>
<a href="#l42.37"></a><span id="l42.37" class="difflineplus">+</span>
<a href="#l42.38"></a><span id="l42.38" class="difflineplus">+  /**</span>
<a href="#l42.39"></a><span id="l42.39">    * @{</span>
<a href="#l42.40"></a><span id="l42.40">    * This is used to tell the runner of the url more about the status of</span>
<a href="#l42.41"></a><span id="l42.41">    * the command, beyond whether it was successful or not. For example,</span>
<a href="#l42.42"></a><span id="l42.42">    * subtracting flags from a UID that doesn't exist isn't an error</span>
<a href="#l42.43"></a><span id="l42.43">    * (the server returns OK), but the backend code may want to know about it.</span>
<a href="#l42.44"></a><span id="l42.44">    */</span>
<a href="#l42.45"></a><span id="l42.45">   attribute long extraStatus;</span>
<a href="#l42.46"></a><span id="l42.46"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -461,16 +461,28 @@ nsImapIncomingServer::PrepareToRetryUrl(</span>
<a href="#l43.4"></a><span id="l43.4"> {</span>
<a href="#l43.5"></a><span id="l43.5">   NS_ENSURE_ARG_POINTER(aChannel);</span>
<a href="#l43.6"></a><span id="l43.6">   NS_ENSURE_ARG_POINTER(aImapUrl);</span>
<a href="#l43.7"></a><span id="l43.7">   // maybe there's more we could do here, but this is all we need now.</span>
<a href="#l43.8"></a><span id="l43.8">   return aImapUrl-&gt;GetMockChannel(aChannel);</span>
<a href="#l43.9"></a><span id="l43.9"> }</span>
<a href="#l43.10"></a><span id="l43.10"> </span>
<a href="#l43.11"></a><span id="l43.11"> NS_IMETHODIMP</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineplus">+nsImapIncomingServer::SuspendUrl(nsIImapUrl *aImapUrl)</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+{</span>
<a href="#l43.14"></a><span id="l43.14" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aImapUrl);</span>
<a href="#l43.15"></a><span id="l43.15" class="difflineplus">+  nsImapProtocol::LogImapUrl(&quot;suspending url&quot;, aImapUrl);</span>
<a href="#l43.16"></a><span id="l43.16" class="difflineplus">+  PR_CEnterMonitor(this);</span>
<a href="#l43.17"></a><span id="l43.17" class="difflineplus">+  m_urlQueue.AppendObject(aImapUrl);</span>
<a href="#l43.18"></a><span id="l43.18" class="difflineplus">+  m_urlConsumers.AppendElement(nsnull);</span>
<a href="#l43.19"></a><span id="l43.19" class="difflineplus">+  PR_CExitMonitor(this);</span>
<a href="#l43.20"></a><span id="l43.20" class="difflineplus">+  return NS_OK;</span>
<a href="#l43.21"></a><span id="l43.21" class="difflineplus">+}</span>
<a href="#l43.22"></a><span id="l43.22" class="difflineplus">+</span>
<a href="#l43.23"></a><span id="l43.23" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l43.24"></a><span id="l43.24"> nsImapIncomingServer::RetryUrl(nsIImapUrl *aImapUrl, nsIImapMockChannel *aChannel)</span>
<a href="#l43.25"></a><span id="l43.25"> {</span>
<a href="#l43.26"></a><span id="l43.26">   nsresult rv;</span>
<a href="#l43.27"></a><span id="l43.27">   // Get current thread envent queue</span>
<a href="#l43.28"></a><span id="l43.28">   aImapUrl-&gt;SetMockChannel(aChannel);</span>
<a href="#l43.29"></a><span id="l43.29">   nsCOMPtr &lt;nsIImapProtocol&gt; protocolInstance;</span>
<a href="#l43.30"></a><span id="l43.30">   nsImapProtocol::LogImapUrl(&quot;creating protocol instance to retry queued url&quot;, aImapUrl);</span>
<a href="#l43.31"></a><span id="l43.31">   nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -2706,17 +2706,16 @@ NS_IMETHODIMP nsImapMailFolder::UpdateIm</span>
<a href="#l44.4"></a><span id="l44.4">   if (!mDatabase)</span>
<a href="#l44.5"></a><span id="l44.5">     GetDatabase();</span>
<a href="#l44.6"></a><span id="l44.6"> </span>
<a href="#l44.7"></a><span id="l44.7">   PRBool folderSelected;</span>
<a href="#l44.8"></a><span id="l44.8">   rv = aSpec-&gt;GetFolderSelected(&amp;folderSelected);</span>
<a href="#l44.9"></a><span id="l44.9">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l44.10"></a><span id="l44.10">   nsTArray&lt;nsMsgKey&gt; existingKeys;</span>
<a href="#l44.11"></a><span id="l44.11">   nsTArray&lt;nsMsgKey&gt; keysToDelete;</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-  nsTArray&lt;nsMsgKey&gt; keysToFetch;</span>
<a href="#l44.13"></a><span id="l44.13">   PRUint32 numNewUnread;</span>
<a href="#l44.14"></a><span id="l44.14">   nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l44.15"></a><span id="l44.15">   PRInt32 imapUIDValidity = 0;</span>
<a href="#l44.16"></a><span id="l44.16">   if (mDatabase)</span>
<a href="#l44.17"></a><span id="l44.17">   {</span>
<a href="#l44.18"></a><span id="l44.18">     rv = mDatabase-&gt;GetDBFolderInfo(getter_AddRefs(dbFolderInfo));</span>
<a href="#l44.19"></a><span id="l44.19">     if (NS_SUCCEEDED(rv) &amp;&amp; dbFolderInfo)</span>
<a href="#l44.20"></a><span id="l44.20">     {</span>
<a href="#l44.21"></a><span id="l44.21" class="difflineat">@@ -2822,33 +2821,34 @@ NS_IMETHODIMP nsImapMailFolder::UpdateIm</span>
<a href="#l44.22"></a><span id="l44.22">     // delete all my msgs, the keys are bogus now</span>
<a href="#l44.23"></a><span id="l44.23">     // add every message in this folder</span>
<a href="#l44.24"></a><span id="l44.24">     existingKeys.Clear();</span>
<a href="#l44.25"></a><span id="l44.25">     //      keysToDelete.CopyArray(&amp;existingKeys);</span>
<a href="#l44.26"></a><span id="l44.26"> </span>
<a href="#l44.27"></a><span id="l44.27">     if (flagState)</span>
<a href="#l44.28"></a><span id="l44.28">     {</span>
<a href="#l44.29"></a><span id="l44.29">       nsTArray&lt;nsMsgKey&gt; no_existingKeys;</span>
<a href="#l44.30"></a><span id="l44.30" class="difflineminus">-      FindKeysToAdd(no_existingKeys, keysToFetch, numNewUnread, flagState);</span>
<a href="#l44.31"></a><span id="l44.31" class="difflineplus">+      FindKeysToAdd(no_existingKeys, m_keysToFetch, numNewUnread, flagState);</span>
<a href="#l44.32"></a><span id="l44.32">     }</span>
<a href="#l44.33"></a><span id="l44.33">     if (NS_FAILED(rv))</span>
<a href="#l44.34"></a><span id="l44.34">       pathFile-&gt;Remove(PR_FALSE);</span>
<a href="#l44.35"></a><span id="l44.35"> </span>
<a href="#l44.36"></a><span id="l44.36">   }</span>
<a href="#l44.37"></a><span id="l44.37">   else if (!flagState /*&amp;&amp; !NET_IsOffline() */) // if there are no messages on the server</span>
<a href="#l44.38"></a><span id="l44.38">     keysToDelete = existingKeys;</span>
<a href="#l44.39"></a><span id="l44.39">   else /* if ( !NET_IsOffline()) */</span>
<a href="#l44.40"></a><span id="l44.40">   {</span>
<a href="#l44.41"></a><span id="l44.41">     PRUint32 boxFlags;</span>
<a href="#l44.42"></a><span id="l44.42">     aSpec-&gt;GetBox_flags(&amp;boxFlags);</span>
<a href="#l44.43"></a><span id="l44.43">     FindKeysToDelete(existingKeys, keysToDelete, flagState, boxFlags);</span>
<a href="#l44.44"></a><span id="l44.44">     // if this is the result of an expunge then don't grab headers</span>
<a href="#l44.45"></a><span id="l44.45">     if (!(boxFlags &amp; kJustExpunged))</span>
<a href="#l44.46"></a><span id="l44.46" class="difflineminus">-      FindKeysToAdd(existingKeys, keysToFetch, numNewUnread, flagState);</span>
<a href="#l44.47"></a><span id="l44.47" class="difflineminus">-  }</span>
<a href="#l44.48"></a><span id="l44.48" class="difflineplus">+      FindKeysToAdd(existingKeys, m_keysToFetch, numNewUnread, flagState);</span>
<a href="#l44.49"></a><span id="l44.49" class="difflineplus">+  }</span>
<a href="#l44.50"></a><span id="l44.50" class="difflineplus">+  m_totalKeysToFetch = m_keysToFetch.Length();</span>
<a href="#l44.51"></a><span id="l44.51">   if (!keysToDelete.IsEmpty() &amp;&amp; mDatabase)</span>
<a href="#l44.52"></a><span id="l44.52">   {</span>
<a href="#l44.53"></a><span id="l44.53">     nsCOMPtr&lt;nsIMutableArray&gt; hdrsToDelete(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l44.54"></a><span id="l44.54">     MsgGetHeadersFromKeys(mDatabase, keysToDelete, hdrsToDelete);</span>
<a href="#l44.55"></a><span id="l44.55">     // Notify nsIMsgFolderListeners of a mass delete, but only if we actually have headers</span>
<a href="#l44.56"></a><span id="l44.56">     PRUint32 numHdrs;</span>
<a href="#l44.57"></a><span id="l44.57">     hdrsToDelete-&gt;GetLength(&amp;numHdrs);</span>
<a href="#l44.58"></a><span id="l44.58">     if (numHdrs)</span>
<a href="#l44.59"></a><span id="l44.59" class="difflineat">@@ -2877,26 +2877,23 @@ NS_IMETHODIMP nsImapMailFolder::UpdateIm</span>
<a href="#l44.60"></a><span id="l44.60">     // We must ensure that the server knows that we are performing biff.</span>
<a href="#l44.61"></a><span id="l44.61">     // Otherwise the stand-alone biff won't fire.</span>
<a href="#l44.62"></a><span id="l44.62">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l44.63"></a><span id="l44.63">     if (NS_SUCCEEDED(GetServer(getter_AddRefs(server))) &amp;&amp; server)</span>
<a href="#l44.64"></a><span id="l44.64">       server-&gt;SetPerformingBiff(PR_TRUE);</span>
<a href="#l44.65"></a><span id="l44.65">      SetNumNewMessages(numNewUnread);</span>
<a href="#l44.66"></a><span id="l44.66">   }</span>
<a href="#l44.67"></a><span id="l44.67">   SyncFlags(flagState);</span>
<a href="#l44.68"></a><span id="l44.68" class="difflineminus">-  if (mDatabase &amp;&amp; mNumUnreadMessages + keysToFetch.Length() &gt; numUnreadFromServer)</span>
<a href="#l44.69"></a><span id="l44.69" class="difflineplus">+  if (mDatabase &amp;&amp; mNumUnreadMessages + m_keysToFetch.Length() &gt; numUnreadFromServer)</span>
<a href="#l44.70"></a><span id="l44.70">     mDatabase-&gt;SyncCounts();</span>
<a href="#l44.71"></a><span id="l44.71"> </span>
<a href="#l44.72"></a><span id="l44.72" class="difflineminus">-  if (!keysToFetch.IsEmpty())</span>
<a href="#l44.73"></a><span id="l44.73" class="difflineminus">-    PrepareToAddHeadersToMailDB(aProtocol, keysToFetch, aSpec);</span>
<a href="#l44.74"></a><span id="l44.74" class="difflineplus">+  if (!m_keysToFetch.IsEmpty() &amp;&amp; aProtocol)</span>
<a href="#l44.75"></a><span id="l44.75" class="difflineplus">+    PrepareToAddHeadersToMailDB(aProtocol);</span>
<a href="#l44.76"></a><span id="l44.76">   else</span>
<a href="#l44.77"></a><span id="l44.77">   {</span>
<a href="#l44.78"></a><span id="l44.78" class="difflineminus">-    // let the imap libnet module know that we don't need headers</span>
<a href="#l44.79"></a><span id="l44.79" class="difflineminus">-    if (aProtocol)</span>
<a href="#l44.80"></a><span id="l44.80" class="difflineminus">-      aProtocol-&gt;NotifyHdrsToDownload(nsnull, 0);</span>
<a href="#l44.81"></a><span id="l44.81">     PRBool gettingNewMessages;</span>
<a href="#l44.82"></a><span id="l44.82">     GetGettingNewMessages(&amp;gettingNewMessages);</span>
<a href="#l44.83"></a><span id="l44.83">     if (gettingNewMessages)</span>
<a href="#l44.84"></a><span id="l44.84">       ProgressStatus(aProtocol, IMAP_NO_NEW_MESSAGES, nsnull);</span>
<a href="#l44.85"></a><span id="l44.85">     SetPerformingBiff(PR_FALSE);</span>
<a href="#l44.86"></a><span id="l44.86">   }</span>
<a href="#l44.87"></a><span id="l44.87">   aSpec-&gt;GetNumMessages(&amp;m_numServerTotalMessages);</span>
<a href="#l44.88"></a><span id="l44.88">   aSpec-&gt;GetNumUnseenMessages(&amp;m_numServerUnseenMessages);</span>
<a href="#l44.89"></a><span id="l44.89" class="difflineat">@@ -3300,20 +3297,18 @@ NS_IMETHODIMP nsImapMailFolder::BeginCop</span>
<a href="#l44.90"></a><span id="l44.90"> }</span>
<a href="#l44.91"></a><span id="l44.91"> </span>
<a href="#l44.92"></a><span id="l44.92"> NS_IMETHODIMP nsImapMailFolder::CopyDataToOutputStreamForAppend(nsIInputStream *aIStream,</span>
<a href="#l44.93"></a><span id="l44.93">                      PRInt32 aLength, nsIOutputStream *outputStream)</span>
<a href="#l44.94"></a><span id="l44.94"> {</span>
<a href="#l44.95"></a><span id="l44.95">   PRUint32 readCount;</span>
<a href="#l44.96"></a><span id="l44.96">   PRUint32 writeCount;</span>
<a href="#l44.97"></a><span id="l44.97">   if (!m_copyState)</span>
<a href="#l44.98"></a><span id="l44.98" class="difflineminus">-  {</span>
<a href="#l44.99"></a><span id="l44.99" class="difflineminus">-    nsImapMailCopyState* copyState = new nsImapMailCopyState();</span>
<a href="#l44.100"></a><span id="l44.100" class="difflineminus">-    m_copyState = do_QueryInterface(copyState);</span>
<a href="#l44.101"></a><span id="l44.101" class="difflineminus">-  }</span>
<a href="#l44.102"></a><span id="l44.102" class="difflineplus">+    m_copyState = new nsImapMailCopyState();</span>
<a href="#l44.103"></a><span id="l44.103" class="difflineplus">+</span>
<a href="#l44.104"></a><span id="l44.104">   if ( aLength + m_copyState-&gt;m_leftOver &gt; m_copyState-&gt;m_dataBufferSize )</span>
<a href="#l44.105"></a><span id="l44.105">   {</span>
<a href="#l44.106"></a><span id="l44.106">     m_copyState-&gt;m_dataBuffer = (char *) PR_REALLOC(m_copyState-&gt;m_dataBuffer, aLength + m_copyState-&gt;m_leftOver+ 1);</span>
<a href="#l44.107"></a><span id="l44.107">     NS_ENSURE_TRUE(m_copyState-&gt;m_dataBuffer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l44.108"></a><span id="l44.108">     m_copyState-&gt;m_dataBufferSize = aLength + m_copyState-&gt;m_leftOver;</span>
<a href="#l44.109"></a><span id="l44.109">   }</span>
<a href="#l44.110"></a><span id="l44.110"> </span>
<a href="#l44.111"></a><span id="l44.111">   char *start, *end;</span>
<a href="#l44.112"></a><span id="l44.112" class="difflineat">@@ -4347,35 +4342,73 @@ void nsImapMailFolder::FindKeysToAdd(con</span>
<a href="#l44.113"></a><span id="l44.113">         keysToFetch.AppendElement(uidOfMessage);</span>
<a href="#l44.114"></a><span id="l44.114">         if (! (flags &amp; kImapMsgSeenFlag))</span>
<a href="#l44.115"></a><span id="l44.115">           numNewUnread++;</span>
<a href="#l44.116"></a><span id="l44.116">       }</span>
<a href="#l44.117"></a><span id="l44.117">     }</span>
<a href="#l44.118"></a><span id="l44.118">   }</span>
<a href="#l44.119"></a><span id="l44.119"> }</span>
<a href="#l44.120"></a><span id="l44.120"> </span>
<a href="#l44.121"></a><span id="l44.121" class="difflineminus">-void nsImapMailFolder::PrepareToAddHeadersToMailDB(nsIImapProtocol* aProtocol, const nsTArray&lt;nsMsgKey&gt; &amp;keysToFetch,</span>
<a href="#l44.122"></a><span id="l44.122" class="difflineminus">-                                                nsIMailboxSpec *boxSpec)</span>
<a href="#l44.123"></a><span id="l44.123" class="difflineminus">-{</span>
<a href="#l44.124"></a><span id="l44.124" class="difflineminus">-  PRUint32 *theKeys = (PRUint32 *) PR_Malloc( keysToFetch.Length() * sizeof(PRUint32) );</span>
<a href="#l44.125"></a><span id="l44.125" class="difflineminus">-  if (theKeys)</span>
<a href="#l44.126"></a><span id="l44.126" class="difflineminus">-  {</span>
<a href="#l44.127"></a><span id="l44.127" class="difflineminus">-    PRUint32 total = keysToFetch.Length();</span>
<a href="#l44.128"></a><span id="l44.128" class="difflineminus">-    for (PRUint32 keyIndex=0; keyIndex &lt; total; keyIndex++)</span>
<a href="#l44.129"></a><span id="l44.129" class="difflineminus">-      theKeys[keyIndex] = keysToFetch[keyIndex];</span>
<a href="#l44.130"></a><span id="l44.130" class="difflineminus">-    // tell the imap thread which hdrs to download</span>
<a href="#l44.131"></a><span id="l44.131" class="difflineminus">-    if (aProtocol)</span>
<a href="#l44.132"></a><span id="l44.132" class="difflineminus">-    {</span>
<a href="#l44.133"></a><span id="l44.133" class="difflineminus">-      aProtocol-&gt;NotifyHdrsToDownload(theKeys, total /*keysToFetch.Length() */);</span>
<a href="#l44.134"></a><span id="l44.134" class="difflineminus">-      // now, tell it we don't need any bodies.</span>
<a href="#l44.135"></a><span id="l44.135" class="difflineminus">-      aProtocol-&gt;NotifyBodysToDownload(nsnull, 0);</span>
<a href="#l44.136"></a><span id="l44.136" class="difflineminus">-    }</span>
<a href="#l44.137"></a><span id="l44.137" class="difflineminus">-  }</span>
<a href="#l44.138"></a><span id="l44.138" class="difflineminus">-  else if (aProtocol)</span>
<a href="#l44.139"></a><span id="l44.139" class="difflineminus">-    aProtocol-&gt;NotifyHdrsToDownload(nsnull, 0);</span>
<a href="#l44.140"></a><span id="l44.140" class="difflineplus">+NS_IMETHODIMP nsImapMailFolder::GetMsgHdrsToDownload(PRBool *aMoreToDownload,</span>
<a href="#l44.141"></a><span id="l44.141" class="difflineplus">+                                                     PRInt32 *aTotalCount,</span>
<a href="#l44.142"></a><span id="l44.142" class="difflineplus">+                                                     PRUint32 *aLength,</span>
<a href="#l44.143"></a><span id="l44.143" class="difflineplus">+                                                     nsMsgKey **aKeys)</span>
<a href="#l44.144"></a><span id="l44.144" class="difflineplus">+{</span>
<a href="#l44.145"></a><span id="l44.145" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMoreToDownload);</span>
<a href="#l44.146"></a><span id="l44.146" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aTotalCount);</span>
<a href="#l44.147"></a><span id="l44.147" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aLength);</span>
<a href="#l44.148"></a><span id="l44.148" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aKeys);</span>
<a href="#l44.149"></a><span id="l44.149" class="difflineplus">+</span>
<a href="#l44.150"></a><span id="l44.150" class="difflineplus">+  *aMoreToDownload = PR_FALSE;</span>
<a href="#l44.151"></a><span id="l44.151" class="difflineplus">+  *aTotalCount = m_totalKeysToFetch;</span>
<a href="#l44.152"></a><span id="l44.152" class="difflineplus">+  if (m_keysToFetch.IsEmpty())</span>
<a href="#l44.153"></a><span id="l44.153" class="difflineplus">+  {</span>
<a href="#l44.154"></a><span id="l44.154" class="difflineplus">+    *aLength = 0;</span>
<a href="#l44.155"></a><span id="l44.155" class="difflineplus">+    return NS_OK;</span>
<a href="#l44.156"></a><span id="l44.156" class="difflineplus">+  }</span>
<a href="#l44.157"></a><span id="l44.157" class="difflineplus">+</span>
<a href="#l44.158"></a><span id="l44.158" class="difflineplus">+  // if folder isn't open in a window, no reason to limit the number of headers</span>
<a href="#l44.159"></a><span id="l44.159" class="difflineplus">+  // we download.</span>
<a href="#l44.160"></a><span id="l44.160" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailSession&gt; session = do_GetService(NS_MSGMAILSESSION_CONTRACTID);</span>
<a href="#l44.161"></a><span id="l44.161" class="difflineplus">+  PRBool folderOpen = PR_FALSE;</span>
<a href="#l44.162"></a><span id="l44.162" class="difflineplus">+  if (session)</span>
<a href="#l44.163"></a><span id="l44.163" class="difflineplus">+    session-&gt;IsFolderOpenInWindow(this, &amp;folderOpen);</span>
<a href="#l44.164"></a><span id="l44.164" class="difflineplus">+</span>
<a href="#l44.165"></a><span id="l44.165" class="difflineplus">+  PRInt32 hdrChunkSize = 200;</span>
<a href="#l44.166"></a><span id="l44.166" class="difflineplus">+  if (folderOpen)</span>
<a href="#l44.167"></a><span id="l44.167" class="difflineplus">+  {</span>
<a href="#l44.168"></a><span id="l44.168" class="difflineplus">+    nsresult rv;</span>
<a href="#l44.169"></a><span id="l44.169" class="difflineplus">+    nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l44.170"></a><span id="l44.170" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l44.171"></a><span id="l44.171" class="difflineplus">+    if (prefBranch)</span>
<a href="#l44.172"></a><span id="l44.172" class="difflineplus">+      prefBranch-&gt;GetIntPref(&quot;mail.imap.hdr_chunk_size&quot;, &amp;hdrChunkSize);</span>
<a href="#l44.173"></a><span id="l44.173" class="difflineplus">+  }</span>
<a href="#l44.174"></a><span id="l44.174" class="difflineplus">+  PRInt32 numKeysToFetch = m_keysToFetch.Length();</span>
<a href="#l44.175"></a><span id="l44.175" class="difflineplus">+  PRInt32 startIndex = 0;</span>
<a href="#l44.176"></a><span id="l44.176" class="difflineplus">+  if (folderOpen &amp;&amp; hdrChunkSize &gt; 0 &amp;&amp; m_keysToFetch.Length() &gt; hdrChunkSize)</span>
<a href="#l44.177"></a><span id="l44.177" class="difflineplus">+  {</span>
<a href="#l44.178"></a><span id="l44.178" class="difflineplus">+    numKeysToFetch = hdrChunkSize;</span>
<a href="#l44.179"></a><span id="l44.179" class="difflineplus">+    *aMoreToDownload = PR_TRUE;</span>
<a href="#l44.180"></a><span id="l44.180" class="difflineplus">+    startIndex = m_keysToFetch.Length() - hdrChunkSize;</span>
<a href="#l44.181"></a><span id="l44.181" class="difflineplus">+  }</span>
<a href="#l44.182"></a><span id="l44.182" class="difflineplus">+  *aKeys = (nsMsgKey *) nsMemory::Clone(&amp;m_keysToFetch[startIndex],</span>
<a href="#l44.183"></a><span id="l44.183" class="difflineplus">+                                       numKeysToFetch * sizeof(nsMsgKey));</span>
<a href="#l44.184"></a><span id="l44.184" class="difflineplus">+  NS_ENSURE_TRUE(*aKeys, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l44.185"></a><span id="l44.185" class="difflineplus">+  // Remove these for the incremental header download case, so that</span>
<a href="#l44.186"></a><span id="l44.186" class="difflineplus">+  // we know we don't have to download them again.</span>
<a href="#l44.187"></a><span id="l44.187" class="difflineplus">+  m_keysToFetch.RemoveElementsAt(startIndex, numKeysToFetch);</span>
<a href="#l44.188"></a><span id="l44.188" class="difflineplus">+  *aLength = numKeysToFetch;</span>
<a href="#l44.189"></a><span id="l44.189" class="difflineplus">+</span>
<a href="#l44.190"></a><span id="l44.190" class="difflineplus">+  return NS_OK;</span>
<a href="#l44.191"></a><span id="l44.191" class="difflineplus">+}</span>
<a href="#l44.192"></a><span id="l44.192" class="difflineplus">+</span>
<a href="#l44.193"></a><span id="l44.193" class="difflineplus">+void nsImapMailFolder::PrepareToAddHeadersToMailDB(nsIImapProtocol* aProtocol)</span>
<a href="#l44.194"></a><span id="l44.194" class="difflineplus">+{</span>
<a href="#l44.195"></a><span id="l44.195" class="difflineplus">+  // now, tell it we don't need any bodies.</span>
<a href="#l44.196"></a><span id="l44.196" class="difflineplus">+  aProtocol-&gt;NotifyBodysToDownload(nsnull, 0);</span>
<a href="#l44.197"></a><span id="l44.197"> }</span>
<a href="#l44.198"></a><span id="l44.198"> </span>
<a href="#l44.199"></a><span id="l44.199"> void nsImapMailFolder::TweakHeaderFlags(nsIImapProtocol* aProtocol, nsIMsgDBHdr *tweakMe)</span>
<a href="#l44.200"></a><span id="l44.200"> {</span>
<a href="#l44.201"></a><span id="l44.201">   if (mDatabase &amp;&amp; aProtocol &amp;&amp; tweakMe)</span>
<a href="#l44.202"></a><span id="l44.202">   {</span>
<a href="#l44.203"></a><span id="l44.203">     tweakMe-&gt;SetMessageKey(m_curMsgUid);</span>
<a href="#l44.204"></a><span id="l44.204">     tweakMe-&gt;SetMessageSize(m_nextMessageByteLength);</span>
<a href="#l44.205"></a><span id="l44.205" class="difflineat">@@ -5702,17 +5735,20 @@ nsImapMailFolder::SetAppendMsgUid(nsMsgK</span>
<a href="#l44.206"></a><span id="l44.206">     if (mailCopyState-&gt;m_undoMsgTxn) // CopyMessages()</span>
<a href="#l44.207"></a><span id="l44.207">     {</span>
<a href="#l44.208"></a><span id="l44.208">         nsRefPtr&lt;nsImapMoveCopyMsgTxn&gt; msgTxn;</span>
<a href="#l44.209"></a><span id="l44.209">         msgTxn = mailCopyState-&gt;m_undoMsgTxn;</span>
<a href="#l44.210"></a><span id="l44.210">         msgTxn-&gt;AddDstKey(aKey);</span>
<a href="#l44.211"></a><span id="l44.211">     }</span>
<a href="#l44.212"></a><span id="l44.212">     else if (mailCopyState-&gt;m_listener) // CopyFileMessage();</span>
<a href="#l44.213"></a><span id="l44.213">                                         // Draft/Template goes here</span>
<a href="#l44.214"></a><span id="l44.214" class="difflineplus">+    {</span>
<a href="#l44.215"></a><span id="l44.215" class="difflineplus">+      mailCopyState-&gt;m_appendUID = aKey;</span>
<a href="#l44.216"></a><span id="l44.216">       mailCopyState-&gt;m_listener-&gt;SetMessageKey(aKey);</span>
<a href="#l44.217"></a><span id="l44.217" class="difflineplus">+    }</span>
<a href="#l44.218"></a><span id="l44.218">   }</span>
<a href="#l44.219"></a><span id="l44.219">   return NS_OK;</span>
<a href="#l44.220"></a><span id="l44.220"> }</span>
<a href="#l44.221"></a><span id="l44.221"> </span>
<a href="#l44.222"></a><span id="l44.222"> NS_IMETHODIMP</span>
<a href="#l44.223"></a><span id="l44.223"> nsImapMailFolder::GetMessageId(nsIImapUrl * aUrl,</span>
<a href="#l44.224"></a><span id="l44.224">                                nsACString &amp;messageId)</span>
<a href="#l44.225"></a><span id="l44.225"> {</span>
<a href="#l44.226"></a><span id="l44.226" class="difflineat">@@ -6753,16 +6789,17 @@ nsImapMailFolder::CopyNextStreamMessage(</span>
<a href="#l44.227"></a><span id="l44.227"> </span>
<a href="#l44.228"></a><span id="l44.228">   return rv;</span>
<a href="#l44.229"></a><span id="l44.229"> }</span>
<a href="#l44.230"></a><span id="l44.230"> </span>
<a href="#l44.231"></a><span id="l44.231"> NS_IMETHODIMP</span>
<a href="#l44.232"></a><span id="l44.232"> nsImapMailFolder::SetUrlState(nsIImapProtocol* aProtocol,</span>
<a href="#l44.233"></a><span id="l44.233">                               nsIMsgMailNewsUrl* aUrl,</span>
<a href="#l44.234"></a><span id="l44.234">                               PRBool isRunning,</span>
<a href="#l44.235"></a><span id="l44.235" class="difflineplus">+                              PRBool aSuspend,</span>
<a href="#l44.236"></a><span id="l44.236">                               nsresult statusCode)</span>
<a href="#l44.237"></a><span id="l44.237"> {</span>
<a href="#l44.238"></a><span id="l44.238">   if (!isRunning)</span>
<a href="#l44.239"></a><span id="l44.239">   {</span>
<a href="#l44.240"></a><span id="l44.240">     ProgressStatus(aProtocol, IMAP_DONE, nsnull);</span>
<a href="#l44.241"></a><span id="l44.241">     m_urlRunning = PR_FALSE;</span>
<a href="#l44.242"></a><span id="l44.242">     // if no protocol, then we're reading from the mem or disk cache</span>
<a href="#l44.243"></a><span id="l44.243">     // and we don't want to end the offline download just yet.</span>
<a href="#l44.244"></a><span id="l44.244" class="difflineat">@@ -6782,17 +6819,17 @@ nsImapMailFolder::SetUrlState(nsIImapPro</span>
<a href="#l44.245"></a><span id="l44.245">       imapUrl-&gt;GetImapAction(&amp;imapAction);</span>
<a href="#l44.246"></a><span id="l44.246">       // if the server doesn't support copyUID, then SetCopyResponseUid won't</span>
<a href="#l44.247"></a><span id="l44.247">       // get called, so we need to clear m_pendingOfflineMoves when the online</span>
<a href="#l44.248"></a><span id="l44.248">       // move operation has finished.</span>
<a href="#l44.249"></a><span id="l44.249">       if (imapAction == nsIImapUrl::nsImapOnlineMove)</span>
<a href="#l44.250"></a><span id="l44.250">         m_pendingOfflineMoves.Clear();</span>
<a href="#l44.251"></a><span id="l44.251">     }</span>
<a href="#l44.252"></a><span id="l44.252">   }</span>
<a href="#l44.253"></a><span id="l44.253" class="difflineminus">-  if (aUrl)</span>
<a href="#l44.254"></a><span id="l44.254" class="difflineplus">+  if (aUrl &amp;&amp; !aSuspend)</span>
<a href="#l44.255"></a><span id="l44.255">       return aUrl-&gt;SetUrlState(isRunning, statusCode);</span>
<a href="#l44.256"></a><span id="l44.256">   return statusCode;</span>
<a href="#l44.257"></a><span id="l44.257"> }</span>
<a href="#l44.258"></a><span id="l44.258"> </span>
<a href="#l44.259"></a><span id="l44.259"> // used when copying from local mail folder, or other imap server)</span>
<a href="#l44.260"></a><span id="l44.260"> nsresult</span>
<a href="#l44.261"></a><span id="l44.261"> nsImapMailFolder::CopyMessagesWithStream(nsIMsgFolder* srcFolder,</span>
<a href="#l44.262"></a><span id="l44.262">                                 nsIArray* messages,</span>
<a href="#l44.263"></a><span id="l44.263" class="difflineat">@@ -8084,17 +8121,17 @@ nsImapMailFolder::CopyStreamMessage(nsIM</span>
<a href="#l44.264"></a><span id="l44.264">   return rv;</span>
<a href="#l44.265"></a><span id="l44.265"> }</span>
<a href="#l44.266"></a><span id="l44.266"> </span>
<a href="#l44.267"></a><span id="l44.267"> nsImapMailCopyState::nsImapMailCopyState() :</span>
<a href="#l44.268"></a><span id="l44.268">     m_isMove(PR_FALSE), m_selectedState(PR_FALSE),</span>
<a href="#l44.269"></a><span id="l44.269">     m_isCrossServerOp(PR_FALSE), m_curIndex(0),</span>
<a href="#l44.270"></a><span id="l44.270">     m_totalCount(0), m_streamCopy(PR_FALSE), m_dataBuffer(nsnull),</span>
<a href="#l44.271"></a><span id="l44.271">     m_dataBufferSize(0), m_leftOver(0), m_allowUndo(PR_FALSE),</span>
<a href="#l44.272"></a><span id="l44.272" class="difflineminus">-    m_eatLF(PR_FALSE), m_newMsgFlags(0)</span>
<a href="#l44.273"></a><span id="l44.273" class="difflineplus">+    m_eatLF(PR_FALSE), m_newMsgFlags(0), m_appendUID(nsMsgKey_None)</span>
<a href="#l44.274"></a><span id="l44.274"> {</span>
<a href="#l44.275"></a><span id="l44.275"> }</span>
<a href="#l44.276"></a><span id="l44.276"> </span>
<a href="#l44.277"></a><span id="l44.277"> nsImapMailCopyState::~nsImapMailCopyState()</span>
<a href="#l44.278"></a><span id="l44.278"> {</span>
<a href="#l44.279"></a><span id="l44.279">   PR_Free(m_dataBuffer);</span>
<a href="#l44.280"></a><span id="l44.280">   if (m_msgService &amp;&amp; m_message)</span>
<a href="#l44.281"></a><span id="l44.281">   {</span>
<a href="#l44.282"></a><span id="l44.282" class="difflineat">@@ -8123,18 +8160,17 @@ nsImapMailFolder::InitCopyState(nsISuppo</span>
<a href="#l44.283"></a><span id="l44.283">                                 nsIMsgCopyServiceListener* listener,</span>
<a href="#l44.284"></a><span id="l44.284">                                 nsIMsgWindow *msgWindow,</span>
<a href="#l44.285"></a><span id="l44.285">                                 PRBool allowUndo)</span>
<a href="#l44.286"></a><span id="l44.286"> {</span>
<a href="#l44.287"></a><span id="l44.287">   NS_ENSURE_ARG_POINTER(srcSupport);</span>
<a href="#l44.288"></a><span id="l44.288">   NS_ENSURE_TRUE(!m_copyState, NS_ERROR_FAILURE);</span>
<a href="#l44.289"></a><span id="l44.289">   nsresult rv;</span>
<a href="#l44.290"></a><span id="l44.290"> </span>
<a href="#l44.291"></a><span id="l44.291" class="difflineminus">-  nsImapMailCopyState* copyState = new nsImapMailCopyState();</span>
<a href="#l44.292"></a><span id="l44.292" class="difflineminus">-  m_copyState = do_QueryInterface(copyState);</span>
<a href="#l44.293"></a><span id="l44.293" class="difflineplus">+  m_copyState = new nsImapMailCopyState();</span>
<a href="#l44.294"></a><span id="l44.294">   NS_ENSURE_TRUE(m_copyState,NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l44.295"></a><span id="l44.295"> </span>
<a href="#l44.296"></a><span id="l44.296">   m_copyState-&gt;m_isCrossServerOp = acrossServers;</span>
<a href="#l44.297"></a><span id="l44.297">   m_copyState-&gt;m_srcSupport = do_QueryInterface(srcSupport, &amp;rv);</span>
<a href="#l44.298"></a><span id="l44.298">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l44.299"></a><span id="l44.299"> </span>
<a href="#l44.300"></a><span id="l44.300">   m_copyState-&gt;m_messages = messages;</span>
<a href="#l44.301"></a><span id="l44.301">   if (messages)</span>
<a href="#l44.302"></a><span id="l44.302" class="difflineat">@@ -8184,29 +8220,29 @@ nsImapMailFolder::InitCopyState(nsISuppo</span>
<a href="#l44.303"></a><span id="l44.303">   m_copyState-&gt;m_selectedState = selectedState;</span>
<a href="#l44.304"></a><span id="l44.304">   m_copyState-&gt;m_msgWindow = msgWindow;</span>
<a href="#l44.305"></a><span id="l44.305">   if (listener)</span>
<a href="#l44.306"></a><span id="l44.306">     m_copyState-&gt;m_listener = do_QueryInterface(listener, &amp;rv);</span>
<a href="#l44.307"></a><span id="l44.307">   return rv;</span>
<a href="#l44.308"></a><span id="l44.308"> }</span>
<a href="#l44.309"></a><span id="l44.309"> </span>
<a href="#l44.310"></a><span id="l44.310"> nsresult</span>
<a href="#l44.311"></a><span id="l44.311" class="difflineminus">-nsImapMailFolder::CopyFileToOfflineStore(nsILocalFile *srcFile)</span>
<a href="#l44.312"></a><span id="l44.312" class="difflineplus">+nsImapMailFolder::CopyFileToOfflineStore(nsILocalFile *srcFile, nsMsgKey msgKey)</span>
<a href="#l44.313"></a><span id="l44.313"> {</span>
<a href="#l44.314"></a><span id="l44.314">   nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l44.315"></a><span id="l44.315">   nsresult rv = GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l44.316"></a><span id="l44.316"> </span>
<a href="#l44.317"></a><span id="l44.317">   if (mDatabase)</span>
<a href="#l44.318"></a><span id="l44.318">   {</span>
<a href="#l44.319"></a><span id="l44.319" class="difflineminus">-    nsMsgKey fakeKey;</span>
<a href="#l44.320"></a><span id="l44.320" class="difflineminus">-    mDatabase-&gt;GetNextFakeOfflineMsgKey(&amp;fakeKey);</span>
<a href="#l44.321"></a><span id="l44.321" class="difflineplus">+    if (msgKey == nsMsgKey_None)</span>
<a href="#l44.322"></a><span id="l44.322" class="difflineplus">+      mDatabase-&gt;GetNextFakeOfflineMsgKey(&amp;msgKey);</span>
<a href="#l44.323"></a><span id="l44.323">     nsCOMPtr&lt;nsIMutableArray&gt; messages(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l44.324"></a><span id="l44.324"> </span>
<a href="#l44.325"></a><span id="l44.325">     nsCOMPtr&lt;nsIMsgOfflineImapOperation&gt; op;</span>
<a href="#l44.326"></a><span id="l44.326" class="difflineminus">-    rv = mDatabase-&gt;GetOfflineOpForKey(fakeKey, PR_TRUE, getter_AddRefs(op));</span>
<a href="#l44.327"></a><span id="l44.327" class="difflineplus">+    rv = mDatabase-&gt;GetOfflineOpForKey(msgKey, PR_TRUE, getter_AddRefs(op));</span>
<a href="#l44.328"></a><span id="l44.328">     if (NS_SUCCEEDED(rv) &amp;&amp; op)</span>
<a href="#l44.329"></a><span id="l44.329">     {</span>
<a href="#l44.330"></a><span id="l44.330">       nsCString destFolderUri;</span>
<a href="#l44.331"></a><span id="l44.331">       GetURI(destFolderUri);</span>
<a href="#l44.332"></a><span id="l44.332">       op-&gt;SetOperation(nsIMsgOfflineImapOperation::kMoveResult);</span>
<a href="#l44.333"></a><span id="l44.333">       op-&gt;SetDestinationFolderURI(destFolderUri.get());</span>
<a href="#l44.334"></a><span id="l44.334">       nsCOMPtr&lt;nsIOutputStream&gt; offlineStore;</span>
<a href="#l44.335"></a><span id="l44.335">       rv = GetOfflineStoreOutputStream(getter_AddRefs(offlineStore));</span>
<a href="#l44.336"></a><span id="l44.336" class="difflineat">@@ -8237,17 +8273,17 @@ nsImapMailFolder::CopyFileToOfflineStore</span>
<a href="#l44.337"></a><span id="l44.337">           nsMsgLineStreamBuffer *inputStreamBuffer =</span>
<a href="#l44.338"></a><span id="l44.338">             new nsMsgLineStreamBuffer(inputBufferSize, PR_TRUE, PR_FALSE);</span>
<a href="#l44.339"></a><span id="l44.339">           PRInt64 fileSize;</span>
<a href="#l44.340"></a><span id="l44.340">           srcFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l44.341"></a><span id="l44.341">           PRUint32 bytesWritten;</span>
<a href="#l44.342"></a><span id="l44.342">           rv = NS_OK;</span>
<a href="#l44.343"></a><span id="l44.343">           msgParser-&gt;SetState(nsIMsgParseMailMsgState::ParseHeadersState);</span>
<a href="#l44.344"></a><span id="l44.344">           // set the env pos to fake key so the msg hdr will have that for a key</span>
<a href="#l44.345"></a><span id="l44.345" class="difflineminus">-          msgParser-&gt;SetEnvelopePos(fakeKey);</span>
<a href="#l44.346"></a><span id="l44.346" class="difflineplus">+          msgParser-&gt;SetEnvelopePos(msgKey);</span>
<a href="#l44.347"></a><span id="l44.347">           PRBool needMoreData = PR_FALSE;</span>
<a href="#l44.348"></a><span id="l44.348">           char * newLine = nsnull;</span>
<a href="#l44.349"></a><span id="l44.349">           PRUint32 numBytesInLine = 0;</span>
<a href="#l44.350"></a><span id="l44.350">           const char *envelope = &quot;From &quot;CRLF;</span>
<a href="#l44.351"></a><span id="l44.351">           offlineStore-&gt;Write(envelope, strlen(envelope), &amp;bytesWritten);</span>
<a href="#l44.352"></a><span id="l44.352">           fileSize += bytesWritten;</span>
<a href="#l44.353"></a><span id="l44.353">           do</span>
<a href="#l44.354"></a><span id="l44.354">           {</span>
<a href="#l44.355"></a><span id="l44.355" class="difflineat">@@ -8297,17 +8333,17 @@ nsresult</span>
<a href="#l44.356"></a><span id="l44.356"> nsImapMailFolder::OnCopyCompleted(nsISupports *srcSupport, nsresult rv)</span>
<a href="#l44.357"></a><span id="l44.357"> {</span>
<a href="#l44.358"></a><span id="l44.358">   // if it's a file, and the copy succeeded, then fcc the offline</span>
<a href="#l44.359"></a><span id="l44.359">   // store, and add a kMoveResult offline op.</span>
<a href="#l44.360"></a><span id="l44.360">   if (NS_SUCCEEDED(rv) &amp;&amp; m_copyState)</span>
<a href="#l44.361"></a><span id="l44.361">   {</span>
<a href="#l44.362"></a><span id="l44.362">     nsCOMPtr&lt;nsILocalFile&gt; srcFile(do_QueryInterface(srcSupport));</span>
<a href="#l44.363"></a><span id="l44.363">     if (srcFile &amp;&amp; (mFlags &amp; nsMsgFolderFlags::Offline) &amp;&amp; !WeAreOffline())</span>
<a href="#l44.364"></a><span id="l44.364" class="difflineminus">-      (void) CopyFileToOfflineStore(srcFile);</span>
<a href="#l44.365"></a><span id="l44.365" class="difflineplus">+      (void) CopyFileToOfflineStore(srcFile, m_copyState-&gt;m_appendUID);</span>
<a href="#l44.366"></a><span id="l44.366">   }</span>
<a href="#l44.367"></a><span id="l44.367">   m_copyState = nsnull;</span>
<a href="#l44.368"></a><span id="l44.368">   nsresult result;</span>
<a href="#l44.369"></a><span id="l44.369">   nsCOMPtr&lt;nsIMsgCopyService&gt; copyService = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;result);</span>
<a href="#l44.370"></a><span id="l44.370">   NS_ENSURE_SUCCESS(result, result);</span>
<a href="#l44.371"></a><span id="l44.371">   return copyService-&gt;NotifyCompletion(srcSupport, this, rv);</span>
<a href="#l44.372"></a><span id="l44.372"> }</span>
<a href="#l44.373"></a><span id="l44.373"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -109,16 +109,19 @@ public:</span>
<a href="#l45.4"></a><span id="l45.4">     char *m_dataBuffer; // temporary buffer for this copy operation</span>
<a href="#l45.5"></a><span id="l45.5">     nsCOMPtr&lt;nsIOutputStream&gt; m_msgFileStream;         // temporary file (processed mail)</span>
<a href="#l45.6"></a><span id="l45.6">     PRUint32 m_dataBufferSize;</span>
<a href="#l45.7"></a><span id="l45.7">     PRUint32 m_leftOver;</span>
<a href="#l45.8"></a><span id="l45.8">     PRBool m_allowUndo;</span>
<a href="#l45.9"></a><span id="l45.9">     PRBool m_eatLF;</span>
<a href="#l45.10"></a><span id="l45.10">     PRBool m_newMsgFlags; // only used if there's no m_message</span>
<a href="#l45.11"></a><span id="l45.11">     nsCString m_newMsgKeywords; // ditto </span>
<a href="#l45.12"></a><span id="l45.12" class="difflineplus">+    // If the server supports UIDPLUS, this is the UID for the append,</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineplus">+    // if we're doing an append.</span>
<a href="#l45.14"></a><span id="l45.14" class="difflineplus">+    nsMsgKey m_appendUID;</span>
<a href="#l45.15"></a><span id="l45.15"> };</span>
<a href="#l45.16"></a><span id="l45.16"> </span>
<a href="#l45.17"></a><span id="l45.17"> NS_DEFINE_STATIC_IID_ACCESSOR(nsImapMailCopyState, NS_IMAPMAILCOPYSTATE_IID)</span>
<a href="#l45.18"></a><span id="l45.18"> </span>
<a href="#l45.19"></a><span id="l45.19"> // ACLs for this folder.</span>
<a href="#l45.20"></a><span id="l45.20"> // Generally, we will try to always query this class when performing</span>
<a href="#l45.21"></a><span id="l45.21"> // an operation on the folder.</span>
<a href="#l45.22"></a><span id="l45.22"> // If the server doesn't support ACLs, none of this data will be filled in.</span>
<a href="#l45.23"></a><span id="l45.23" class="difflineat">@@ -359,32 +362,30 @@ public:</span>
<a href="#l45.24"></a><span id="l45.24"> protected:</span>
<a href="#l45.25"></a><span id="l45.25">   // Helper methods</span>
<a href="#l45.26"></a><span id="l45.26"> </span>
<a href="#l45.27"></a><span id="l45.27">   virtual nsresult CreateChildFromURI(const nsCString &amp;uri, nsIMsgFolder **folder);</span>
<a href="#l45.28"></a><span id="l45.28">   void FindKeysToAdd(const nsTArray&lt;nsMsgKey&gt; &amp;existingKeys, nsTArray&lt;nsMsgKey&gt;</span>
<a href="#l45.29"></a><span id="l45.29">     &amp;keysToFetch, PRUint32 &amp;numNewUnread, nsIImapFlagAndUidState *flagState);</span>
<a href="#l45.30"></a><span id="l45.30">   void FindKeysToDelete(const nsTArray&lt;nsMsgKey&gt; &amp;existingKeys, nsTArray&lt;nsMsgKey&gt;</span>
<a href="#l45.31"></a><span id="l45.31">     &amp;keysToFetch, nsIImapFlagAndUidState *flagState, PRUint32 boxFlags);</span>
<a href="#l45.32"></a><span id="l45.32" class="difflineminus">-  void PrepareToAddHeadersToMailDB(nsIImapProtocol* aProtocol, const</span>
<a href="#l45.33"></a><span id="l45.33" class="difflineminus">-    nsTArray&lt;nsMsgKey&gt; &amp;keysToFetch,</span>
<a href="#l45.34"></a><span id="l45.34" class="difflineminus">-    nsIMailboxSpec *boxSpec);</span>
<a href="#l45.35"></a><span id="l45.35" class="difflineplus">+  void PrepareToAddHeadersToMailDB(nsIImapProtocol* aProtocol);</span>
<a href="#l45.36"></a><span id="l45.36">   void TweakHeaderFlags(nsIImapProtocol* aProtocol, nsIMsgDBHdr *tweakMe);</span>
<a href="#l45.37"></a><span id="l45.37"> </span>
<a href="#l45.38"></a><span id="l45.38">   nsresult SyncFlags(nsIImapFlagAndUidState *flagState);</span>
<a href="#l45.39"></a><span id="l45.39">   nsresult HandleCustomFlags(nsMsgKey uidOfMessage, nsIMsgDBHdr *dbHdr,</span>
<a href="#l45.40"></a><span id="l45.40">                              PRUint16 userFlags, nsCString&amp; keywords);</span>
<a href="#l45.41"></a><span id="l45.41">   nsresult NotifyMessageFlagsFromHdr(nsIMsgDBHdr *dbHdr, nsMsgKey msgKey, PRUint32 flags);</span>
<a href="#l45.42"></a><span id="l45.42"> </span>
<a href="#l45.43"></a><span id="l45.43">   nsresult SetupHeaderParseStream(PRUint32 size, const nsACString&amp; content_type, nsIMailboxSpec *boxSpec);</span>
<a href="#l45.44"></a><span id="l45.44">   nsresult  ParseAdoptedHeaderLine(const char *messageLine, PRUint32 msgKey);</span>
<a href="#l45.45"></a><span id="l45.45">   nsresult  NormalEndHeaderParseStream(nsIImapProtocol *aProtocol, nsIImapUrl *imapUrl);</span>
<a href="#l45.46"></a><span id="l45.46"> </span>
<a href="#l45.47"></a><span id="l45.47">   void EndOfflineDownload();</span>
<a href="#l45.48"></a><span id="l45.48" class="difflineminus">-  nsresult CopyFileToOfflineStore(nsILocalFile *srcFile);</span>
<a href="#l45.49"></a><span id="l45.49" class="difflineplus">+  nsresult CopyFileToOfflineStore(nsILocalFile *srcFile, nsMsgKey msgKey);</span>
<a href="#l45.50"></a><span id="l45.50"> </span>
<a href="#l45.51"></a><span id="l45.51">   nsresult MarkMessagesImapDeleted(nsTArray&lt;nsMsgKey&gt; *keyArray, PRBool deleted, nsIMsgDatabase *db);</span>
<a href="#l45.52"></a><span id="l45.52"> </span>
<a href="#l45.53"></a><span id="l45.53">   // Notifies imap autosync that it should update this folder when it</span>
<a href="#l45.54"></a><span id="l45.54">   // gets a chance.</span>
<a href="#l45.55"></a><span id="l45.55">   void NotifyHasPendingMsgs();</span>
<a href="#l45.56"></a><span id="l45.56">   void UpdatePendingCounts();</span>
<a href="#l45.57"></a><span id="l45.57">   void SetIMAPDeletedFlag(nsIMsgDatabase *mailDB, const nsTArray&lt;nsMsgKey&gt; &amp;msgids, PRBool markDeleted);</span>
<a href="#l45.58"></a><span id="l45.58" class="difflineat">@@ -445,22 +446,21 @@ protected:</span>
<a href="#l45.59"></a><span id="l45.59">   nsresult CopyOfflineMsgBody(nsIMsgFolder *srcFolder, nsIMsgDBHdr *destHdr,</span>
<a href="#l45.60"></a><span id="l45.60">                               nsIMsgDBHdr *origHdr, nsIInputStream *inputStream,</span>
<a href="#l45.61"></a><span id="l45.61">                               nsIOutputStream *outputStream);</span>
<a href="#l45.62"></a><span id="l45.62"> </span>
<a href="#l45.63"></a><span id="l45.63">   void GetTrashFolderName(nsAString &amp;aFolderName);</span>
<a href="#l45.64"></a><span id="l45.64">   PRBool ShowPreviewText();</span>
<a href="#l45.65"></a><span id="l45.65"> </span>
<a href="#l45.66"></a><span id="l45.66">   // Pseudo-Offline operation playback timer</span>
<a href="#l45.67"></a><span id="l45.67" class="difflineminus">-  static </span>
<a href="#l45.68"></a><span id="l45.68" class="difflineminus">-  void PlaybackTimerCallback(nsITimer *aTimer, void *aClosure);</span>
<a href="#l45.69"></a><span id="l45.69" class="difflineminus">-  </span>
<a href="#l45.70"></a><span id="l45.70" class="difflineplus">+  static void PlaybackTimerCallback(nsITimer *aTimer, void *aClosure);</span>
<a href="#l45.71"></a><span id="l45.71" class="difflineplus">+</span>
<a href="#l45.72"></a><span id="l45.72">   nsresult CreatePlaybackTimer();</span>
<a href="#l45.73"></a><span id="l45.73" class="difflineminus">-  </span>
<a href="#l45.74"></a><span id="l45.74" class="difflineminus">-  // Allocate and initialize associated auto-sync state object </span>
<a href="#l45.75"></a><span id="l45.75" class="difflineplus">+</span>
<a href="#l45.76"></a><span id="l45.76" class="difflineplus">+  // Allocate and initialize associated auto-sync state object.</span>
<a href="#l45.77"></a><span id="l45.77">   void InitAutoSyncState();</span>
<a href="#l45.78"></a><span id="l45.78"> </span>
<a href="#l45.79"></a><span id="l45.79">   PRBool m_initialized;</span>
<a href="#l45.80"></a><span id="l45.80">   PRBool m_haveDiscoveredAllFolders;</span>
<a href="#l45.81"></a><span id="l45.81">   nsCOMPtr&lt;nsIMsgParseMailMsgState&gt; m_msgParser;</span>
<a href="#l45.82"></a><span id="l45.82">   nsCOMPtr&lt;nsIMsgFilterList&gt; m_filterList;</span>
<a href="#l45.83"></a><span id="l45.83">   nsCOMPtr&lt;nsIMsgFilterPlugin&gt; m_filterPlugin;  // XXX should be a list</span>
<a href="#l45.84"></a><span id="l45.84">   // used with filter plugins to know when we've finished classifying and can playback moves</span>
<a href="#l45.85"></a><span id="l45.85" class="difflineat">@@ -472,30 +472,30 @@ protected:</span>
<a href="#l45.86"></a><span id="l45.86">   /// the junk destination folder</span>
<a href="#l45.87"></a><span id="l45.87">   nsCOMPtr&lt;nsIMsgFolder&gt; mSpamFolder;</span>
<a href="#l45.88"></a><span id="l45.88">   nsMsgKey m_curMsgUid;</span>
<a href="#l45.89"></a><span id="l45.89">   PRUint32 m_uidValidity;</span>
<a href="#l45.90"></a><span id="l45.90"> </span>
<a href="#l45.91"></a><span id="l45.91">   // These three vars are used to store counts from STATUS or SELECT command</span>
<a href="#l45.92"></a><span id="l45.92">   // They include deleted messages, so they can differ from the generic</span>
<a href="#l45.93"></a><span id="l45.93">   // folder total and unread counts.</span>
<a href="#l45.94"></a><span id="l45.94" class="difflineminus">-  PRInt32 m_numServerRecentMessages; </span>
<a href="#l45.95"></a><span id="l45.95" class="difflineplus">+  PRInt32 m_numServerRecentMessages;</span>
<a href="#l45.96"></a><span id="l45.96">   PRInt32 m_numServerUnseenMessages;</span>
<a href="#l45.97"></a><span id="l45.97">   PRInt32 m_numServerTotalMessages;</span>
<a href="#l45.98"></a><span id="l45.98">   // if server supports UIDNEXT, we store it here.</span>
<a href="#l45.99"></a><span id="l45.99">   PRInt32 m_nextUID;</span>
<a href="#l45.100"></a><span id="l45.100"> </span>
<a href="#l45.101"></a><span id="l45.101">   PRInt32  m_nextMessageByteLength;</span>
<a href="#l45.102"></a><span id="l45.102">   nsCOMPtr&lt;nsIThread&gt; m_thread;</span>
<a href="#l45.103"></a><span id="l45.103">   nsCOMPtr&lt;nsIUrlListener&gt; m_urlListener;</span>
<a href="#l45.104"></a><span id="l45.104">   PRBool m_urlRunning;</span>
<a href="#l45.105"></a><span id="l45.105"> </span>
<a href="#l45.106"></a><span id="l45.106" class="difflineminus">-  // *** jt - undo move/copy trasaction support</span>
<a href="#l45.107"></a><span id="l45.107" class="difflineplus">+  // undo move/copy transaction support</span>
<a href="#l45.108"></a><span id="l45.108">   nsRefPtr&lt;nsMsgTxn&gt; m_pendingUndoTxn;</span>
<a href="#l45.109"></a><span id="l45.109" class="difflineminus">-  nsCOMPtr&lt;nsImapMailCopyState&gt; m_copyState;</span>
<a href="#l45.110"></a><span id="l45.110" class="difflineplus">+  nsRefPtr&lt;nsImapMailCopyState&gt; m_copyState;</span>
<a href="#l45.111"></a><span id="l45.111">   char m_hierarchyDelimiter;</span>
<a href="#l45.112"></a><span id="l45.112">   PRInt32 m_boxFlags;</span>
<a href="#l45.113"></a><span id="l45.113">   nsCString m_onlineFolderName;</span>
<a href="#l45.114"></a><span id="l45.114">   nsCString m_ownerUserName;  // username of the &quot;other user,&quot; as in</span>
<a href="#l45.115"></a><span id="l45.115">   // &quot;Other Users' Mailboxes&quot;</span>
<a href="#l45.116"></a><span id="l45.116"> </span>
<a href="#l45.117"></a><span id="l45.117">   nsCString m_adminUrl;   // url to run to set admin privileges for this folder</span>
<a href="#l45.118"></a><span id="l45.118">   nsIMAPNamespace  *m_namespace;</span>
<a href="#l45.119"></a><span id="l45.119" class="difflineat">@@ -517,25 +517,29 @@ protected:</span>
<a href="#l45.120"></a><span id="l45.120">   nsMsgIMAPFolderACL *m_folderACL;</span>
<a href="#l45.121"></a><span id="l45.121">   PRUint32     m_aclFlags;</span>
<a href="#l45.122"></a><span id="l45.122">   PRUint32     m_supportedUserFlags;</span>
<a href="#l45.123"></a><span id="l45.123"> </span>
<a href="#l45.124"></a><span id="l45.124">   // offline imap support</span>
<a href="#l45.125"></a><span id="l45.125">   PRBool m_downloadingFolderForOfflineUse;</span>
<a href="#l45.126"></a><span id="l45.126">   PRBool m_filterListRequiresBody;</span>
<a href="#l45.127"></a><span id="l45.127"> </span>
<a href="#l45.128"></a><span id="l45.128" class="difflineminus">-  // auto-sync (preemptive download) support</span>
<a href="#l45.129"></a><span id="l45.129" class="difflineplus">+  // auto-sync (automatic message download) support</span>
<a href="#l45.130"></a><span id="l45.130">   nsRefPtr&lt;nsAutoSyncState&gt; m_autoSyncStateObj;</span>
<a href="#l45.131"></a><span id="l45.131"> </span>
<a href="#l45.132"></a><span id="l45.132">   // Quota support</span>
<a href="#l45.133"></a><span id="l45.133">   nsCString m_folderQuotaRoot;</span>
<a href="#l45.134"></a><span id="l45.134">   PRUint32 m_folderQuotaUsedKB;</span>
<a href="#l45.135"></a><span id="l45.135">   PRUint32 m_folderQuotaMaxKB;</span>
<a href="#l45.136"></a><span id="l45.136"> </span>
<a href="#l45.137"></a><span id="l45.137">   // Pseudo-Offline Playback support</span>
<a href="#l45.138"></a><span id="l45.138">   nsPlaybackRequest *m_pendingPlaybackReq;</span>
<a href="#l45.139"></a><span id="l45.139">   nsCOMPtr&lt;nsITimer&gt; m_playbackTimer;</span>
<a href="#l45.140"></a><span id="l45.140">   nsTArray&lt;nsRefPtr&lt;nsImapMoveCopyMsgTxn&gt; &gt; m_pendingOfflineMoves;</span>
<a href="#l45.141"></a><span id="l45.141">   // hash table of mapping between messageids and message keys</span>
<a href="#l45.142"></a><span id="l45.142">   // for pseudo hdrs.</span>
<a href="#l45.143"></a><span id="l45.143">   nsDataHashtable&lt;nsCStringHashKey, nsMsgKey&gt; m_pseudoHdrs;</span>
<a href="#l45.144"></a><span id="l45.144" class="difflineplus">+</span>
<a href="#l45.145"></a><span id="l45.145" class="difflineplus">+  nsTArray&lt;nsMsgKey&gt; m_keysToFetch;</span>
<a href="#l45.146"></a><span id="l45.146" class="difflineplus">+  PRUint32 m_totalKeysToFetch;</span>
<a href="#l45.147"></a><span id="l45.147" class="difflineplus">+</span>
<a href="#l45.148"></a><span id="l45.148"> };</span>
<a href="#l45.149"></a><span id="l45.149"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -386,17 +386,16 @@ nsresult nsImapProtocol::GlobalInitializ</span>
<a href="#l46.4"></a><span id="l46.4"> nsImapProtocol::nsImapProtocol() : nsMsgProtocol(nsnull),</span>
<a href="#l46.5"></a><span id="l46.5">     mLock(&quot;nsImapProtocol.mLock&quot;),</span>
<a href="#l46.6"></a><span id="l46.6">     m_dataAvailableMonitor(&quot;imapDataAvailable&quot;),</span>
<a href="#l46.7"></a><span id="l46.7">     m_urlReadyToRunMonitor(&quot;imapUrlReadyToRun&quot;),</span>
<a href="#l46.8"></a><span id="l46.8">     m_pseudoInterruptMonitor(&quot;imapPseudoInterrupt&quot;),</span>
<a href="#l46.9"></a><span id="l46.9">     m_dataMemberMonitor(&quot;imapDataMember&quot;),</span>
<a href="#l46.10"></a><span id="l46.10">     m_threadDeathMonitor(&quot;imapThreadDeath&quot;),</span>
<a href="#l46.11"></a><span id="l46.11">     m_waitForBodyIdsMonitor(&quot;imapWaitForBodyIds&quot;),</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-    m_fetchMsgListMonitor(&quot;imapFetchMsgList&quot;),</span>
<a href="#l46.13"></a><span id="l46.13">     m_fetchBodyListMonitor(&quot;imapFetchBodyList&quot;),</span>
<a href="#l46.14"></a><span id="l46.14">     m_passwordReadyMonitor(&quot;imapPasswordReady&quot;),</span>
<a href="#l46.15"></a><span id="l46.15">     m_parser(*this)</span>
<a href="#l46.16"></a><span id="l46.16"> {</span>
<a href="#l46.17"></a><span id="l46.17">   m_urlInProgress = PR_FALSE;</span>
<a href="#l46.18"></a><span id="l46.18">   m_idle = PR_FALSE;</span>
<a href="#l46.19"></a><span id="l46.19">   m_retryUrlOnError = PR_FALSE;</span>
<a href="#l46.20"></a><span id="l46.20">   m_useIdle = PR_TRUE; // by default, use it</span>
<a href="#l46.21"></a><span id="l46.21" class="difflineat">@@ -462,17 +461,16 @@ nsImapProtocol::nsImapProtocol() : nsMsg</span>
<a href="#l46.22"></a><span id="l46.22">   m_fetchByChunks = PR_TRUE;</span>
<a href="#l46.23"></a><span id="l46.23">   m_sendID = PR_TRUE;</span>
<a href="#l46.24"></a><span id="l46.24">   m_chunkSize = 0;</span>
<a href="#l46.25"></a><span id="l46.25">   m_chunkThreshold = 0;</span>
<a href="#l46.26"></a><span id="l46.26">   m_fromHeaderSeen = PR_FALSE;</span>
<a href="#l46.27"></a><span id="l46.27">   m_closeNeededBeforeSelect = PR_FALSE;</span>
<a href="#l46.28"></a><span id="l46.28">   m_needNoop = PR_FALSE;</span>
<a href="#l46.29"></a><span id="l46.29">   m_noopCount = 0;</span>
<a href="#l46.30"></a><span id="l46.30" class="difflineminus">-  m_fetchMsgListIsNew = PR_FALSE;</span>
<a href="#l46.31"></a><span id="l46.31">   m_fetchBodyListIsNew = PR_FALSE;</span>
<a href="#l46.32"></a><span id="l46.32">   m_flagChangeCount = 0;</span>
<a href="#l46.33"></a><span id="l46.33">   m_lastCheckTime = PR_Now();</span>
<a href="#l46.34"></a><span id="l46.34"> </span>
<a href="#l46.35"></a><span id="l46.35">   m_checkForNewMailDownloadsHeaders = PR_TRUE;  // this should be on by default</span>
<a href="#l46.36"></a><span id="l46.36">   m_hierarchyNameState = kNoOperationInProgress;</span>
<a href="#l46.37"></a><span id="l46.37">   m_discoveryStatus = eContinue;</span>
<a href="#l46.38"></a><span id="l46.38"> </span>
<a href="#l46.39"></a><span id="l46.39" class="difflineat">@@ -1612,17 +1610,18 @@ PRBool nsImapProtocol::ProcessCurrentURL</span>
<a href="#l46.40"></a><span id="l46.40">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_runningUrl, &amp;rv);</span>
<a href="#l46.41"></a><span id="l46.41">   nsCAutoString urlSpec;</span>
<a href="#l46.42"></a><span id="l46.42">   mailnewsurl-&gt;GetSpec(urlSpec);</span>
<a href="#l46.43"></a><span id="l46.43">   Log(&quot;ProcessCurrentURL&quot;, urlSpec.get(), (validUrl) ? &quot; = currentUrl\n&quot; : &quot; is not valid\n&quot;);</span>
<a href="#l46.44"></a><span id="l46.44">   if (!validUrl)</span>
<a href="#l46.45"></a><span id="l46.45">     return PR_FALSE;</span>
<a href="#l46.46"></a><span id="l46.46"> </span>
<a href="#l46.47"></a><span id="l46.47">   if (NS_SUCCEEDED(rv) &amp;&amp; mailnewsurl &amp;&amp; m_imapMailFolderSink &amp;&amp; !rerunningUrl)</span>
<a href="#l46.48"></a><span id="l46.48" class="difflineminus">-    m_imapMailFolderSink-&gt;SetUrlState(this, mailnewsurl, PR_TRUE, NS_OK);</span>
<a href="#l46.49"></a><span id="l46.49" class="difflineplus">+    m_imapMailFolderSink-&gt;SetUrlState(this, mailnewsurl, PR_TRUE, PR_FALSE,</span>
<a href="#l46.50"></a><span id="l46.50" class="difflineplus">+                                      NS_OK);</span>
<a href="#l46.51"></a><span id="l46.51"> </span>
<a href="#l46.52"></a><span id="l46.52">   // if we are set up as a channel, we should notify our channel listener that we are starting...</span>
<a href="#l46.53"></a><span id="l46.53">   // so pass in ourself as the channel and not the underlying socket or file channel the protocol</span>
<a href="#l46.54"></a><span id="l46.54">   // happens to be using</span>
<a href="#l46.55"></a><span id="l46.55">   if (m_channelListener) // ### not sure we want to do this if rerunning url...</span>
<a href="#l46.56"></a><span id="l46.56">   {</span>
<a href="#l46.57"></a><span id="l46.57">     nsCOMPtr&lt;nsIRequest&gt; request = do_QueryInterface(m_mockChannel);</span>
<a href="#l46.58"></a><span id="l46.58">     m_channelListener-&gt;OnStartRequest(request, m_channelContext);</span>
<a href="#l46.59"></a><span id="l46.59" class="difflineat">@@ -1768,26 +1767,29 @@ PRBool nsImapProtocol::ProcessCurrentURL</span>
<a href="#l46.60"></a><span id="l46.60">       nsCOMPtr&lt;nsIRequest&gt; request = do_QueryInterface(m_mockChannel);</span>
<a href="#l46.61"></a><span id="l46.61">       NS_ASSERTION(request, &quot;no request&quot;);</span>
<a href="#l46.62"></a><span id="l46.62">       if (request) {</span>
<a href="#l46.63"></a><span id="l46.63">         nsresult status;</span>
<a href="#l46.64"></a><span id="l46.64">         request-&gt;GetStatus(&amp;status);</span>
<a href="#l46.65"></a><span id="l46.65">         rv = m_channelListener-&gt;OnStopRequest(request, m_channelContext, status);</span>
<a href="#l46.66"></a><span id="l46.66">       }</span>
<a href="#l46.67"></a><span id="l46.67">   }</span>
<a href="#l46.68"></a><span id="l46.68" class="difflineplus">+  PRBool suspendUrl = PR_FALSE;</span>
<a href="#l46.69"></a><span id="l46.69" class="difflineplus">+  m_runningUrl-&gt;GetMoreHeadersToDownload(&amp;suspendUrl);</span>
<a href="#l46.70"></a><span id="l46.70">   if (mailnewsurl &amp;&amp; m_imapMailFolderSink)</span>
<a href="#l46.71"></a><span id="l46.71">   {</span>
<a href="#l46.72"></a><span id="l46.72">     if (logonFailed)</span>
<a href="#l46.73"></a><span id="l46.73">       rv = NS_ERROR_FAILURE;</span>
<a href="#l46.74"></a><span id="l46.74">     else if (GetServerStateParser().CommandFailed())</span>
<a href="#l46.75"></a><span id="l46.75">       rv = NS_MSG_ERROR_IMAP_COMMAND_FAILED;</span>
<a href="#l46.76"></a><span id="l46.76">     else</span>
<a href="#l46.77"></a><span id="l46.77">       rv = GetConnectionStatus();</span>
<a href="#l46.78"></a><span id="l46.78">     // we are done with this url.</span>
<a href="#l46.79"></a><span id="l46.79" class="difflineminus">-    m_imapMailFolderSink-&gt;SetUrlState(this, mailnewsurl, PR_FALSE, rv);</span>
<a href="#l46.80"></a><span id="l46.80" class="difflineplus">+    m_imapMailFolderSink-&gt;SetUrlState(this, mailnewsurl, PR_FALSE, suspendUrl,</span>
<a href="#l46.81"></a><span id="l46.81" class="difflineplus">+                                      rv);</span>
<a href="#l46.82"></a><span id="l46.82">      // doom the cache entry</span>
<a href="#l46.83"></a><span id="l46.83">     if (NS_FAILED(rv) &amp;&amp; DeathSignalReceived() &amp;&amp; m_mockChannel)</span>
<a href="#l46.84"></a><span id="l46.84">       DoomCacheEntry(mailnewsurl);</span>
<a href="#l46.85"></a><span id="l46.85">   }</span>
<a href="#l46.86"></a><span id="l46.86">   else</span>
<a href="#l46.87"></a><span id="l46.87">     NS_ERROR(&quot;missing url or sink&quot;);</span>
<a href="#l46.88"></a><span id="l46.88"> </span>
<a href="#l46.89"></a><span id="l46.89">   // disable timeouts before caching connection.</span>
<a href="#l46.90"></a><span id="l46.90" class="difflineat">@@ -1798,16 +1800,18 @@ PRBool nsImapProtocol::ProcessCurrentURL</span>
<a href="#l46.91"></a><span id="l46.91"> </span>
<a href="#l46.92"></a><span id="l46.92">   nsCOMPtr &lt;nsISupports&gt; copyState;</span>
<a href="#l46.93"></a><span id="l46.93">   if (m_runningUrl)</span>
<a href="#l46.94"></a><span id="l46.94">     m_runningUrl-&gt;GetCopyState(getter_AddRefs(copyState));</span>
<a href="#l46.95"></a><span id="l46.95">   // this is so hokey...we MUST clear any local references to the url</span>
<a href="#l46.96"></a><span id="l46.96">   // BEFORE calling ReleaseUrlState</span>
<a href="#l46.97"></a><span id="l46.97">   mailnewsurl = nsnull;</span>
<a href="#l46.98"></a><span id="l46.98"> </span>
<a href="#l46.99"></a><span id="l46.99" class="difflineplus">+  if (suspendUrl)</span>
<a href="#l46.100"></a><span id="l46.100" class="difflineplus">+    m_imapServerSink-&gt;SuspendUrl(m_runningUrl);</span>
<a href="#l46.101"></a><span id="l46.101">   // save the imap folder sink since we need it to do the CopyNextStreamMessage</span>
<a href="#l46.102"></a><span id="l46.102">   nsCOMPtr&lt;nsIImapMailFolderSink&gt; imapMailFolderSink = m_imapMailFolderSink;</span>
<a href="#l46.103"></a><span id="l46.103">   // release the url as we are done with it...</span>
<a href="#l46.104"></a><span id="l46.104">   ReleaseUrlState(PR_FALSE);</span>
<a href="#l46.105"></a><span id="l46.105">   ResetProgressInfo();</span>
<a href="#l46.106"></a><span id="l46.106"> </span>
<a href="#l46.107"></a><span id="l46.107">   ClearFlag(IMAP_CLEAN_UP_URL_STATE);</span>
<a href="#l46.108"></a><span id="l46.108"> </span>
<a href="#l46.109"></a><span id="l46.109" class="difflineat">@@ -2016,18 +2020,18 @@ public:</span>
<a href="#l46.110"></a><span id="l46.110">   {</span>
<a href="#l46.111"></a><span id="l46.111">     if (mUrl)</span>
<a href="#l46.112"></a><span id="l46.112">     {</span>
<a href="#l46.113"></a><span id="l46.113">       nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l46.114"></a><span id="l46.114">       mUrl-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l46.115"></a><span id="l46.115">       NS_ENSURE_TRUE(folder, NS_OK);</span>
<a href="#l46.116"></a><span id="l46.116">       nsCOMPtr&lt;nsIImapMailFolderSink&gt; folderSink(do_QueryInterface(folder));</span>
<a href="#l46.117"></a><span id="l46.117">       // This causes the url listener to get OnStart and Stop notifications.</span>
<a href="#l46.118"></a><span id="l46.118" class="difflineminus">-      folderSink-&gt;SetUrlState(mProtocol, mUrl, PR_TRUE, NS_OK);</span>
<a href="#l46.119"></a><span id="l46.119" class="difflineminus">-      folderSink-&gt;SetUrlState(mProtocol, mUrl, PR_FALSE, NS_OK);</span>
<a href="#l46.120"></a><span id="l46.120" class="difflineplus">+      folderSink-&gt;SetUrlState(mProtocol, mUrl, PR_TRUE, PR_FALSE, NS_OK);</span>
<a href="#l46.121"></a><span id="l46.121" class="difflineplus">+      folderSink-&gt;SetUrlState(mProtocol, mUrl, PR_FALSE, PR_FALSE, NS_OK);</span>
<a href="#l46.122"></a><span id="l46.122">     }</span>
<a href="#l46.123"></a><span id="l46.123">     return NS_OK;</span>
<a href="#l46.124"></a><span id="l46.124">   }</span>
<a href="#l46.125"></a><span id="l46.125"> </span>
<a href="#l46.126"></a><span id="l46.126"> private:</span>
<a href="#l46.127"></a><span id="l46.127">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mUrl;</span>
<a href="#l46.128"></a><span id="l46.128">   nsCOMPtr&lt;nsIImapProtocol&gt; mProtocol;</span>
<a href="#l46.129"></a><span id="l46.129"> };</span>
<a href="#l46.130"></a><span id="l46.130" class="difflineat">@@ -2384,34 +2388,34 @@ void nsImapProtocol::IncrementCommandTag</span>
<a href="#l46.131"></a><span id="l46.131"> const char *nsImapProtocol::GetServerCommandTag()</span>
<a href="#l46.132"></a><span id="l46.132"> {</span>
<a href="#l46.133"></a><span id="l46.133">     return m_currentServerCommandTag;</span>
<a href="#l46.134"></a><span id="l46.134"> }</span>
<a href="#l46.135"></a><span id="l46.135"> </span>
<a href="#l46.136"></a><span id="l46.136"> void nsImapProtocol::ProcessSelectedStateURL()</span>
<a href="#l46.137"></a><span id="l46.137"> {</span>
<a href="#l46.138"></a><span id="l46.138">   nsCString mailboxName;</span>
<a href="#l46.139"></a><span id="l46.139" class="difflineminus">-  PRBool          bMessageIdsAreUids = PR_TRUE;</span>
<a href="#l46.140"></a><span id="l46.140" class="difflineplus">+  PRBool bMessageIdsAreUids = PR_TRUE;</span>
<a href="#l46.141"></a><span id="l46.141" class="difflineplus">+  PRBool moreHeadersToDownload;</span>
<a href="#l46.142"></a><span id="l46.142">   imapMessageFlagsType  msgFlags = 0;</span>
<a href="#l46.143"></a><span id="l46.143">   nsCString       urlHost;</span>
<a href="#l46.144"></a><span id="l46.144"> </span>
<a href="#l46.145"></a><span id="l46.145">   // this can't fail, can it?</span>
<a href="#l46.146"></a><span id="l46.146">   nsresult res;</span>
<a href="#l46.147"></a><span id="l46.147">   res = m_runningUrl-&gt;GetImapAction(&amp;m_imapAction);</span>
<a href="#l46.148"></a><span id="l46.148">   m_runningUrl-&gt;MessageIdsAreUids(&amp;bMessageIdsAreUids);</span>
<a href="#l46.149"></a><span id="l46.149">   m_runningUrl-&gt;GetMsgFlags(&amp;msgFlags);</span>
<a href="#l46.150"></a><span id="l46.150" class="difflineplus">+  m_runningUrl-&gt;GetMoreHeadersToDownload(&amp;moreHeadersToDownload);</span>
<a href="#l46.151"></a><span id="l46.151"> </span>
<a href="#l46.152"></a><span id="l46.152">   res = CreateServerSourceFolderPathString(getter_Copies(mailboxName));</span>
<a href="#l46.153"></a><span id="l46.153">   if (NS_FAILED(res))</span>
<a href="#l46.154"></a><span id="l46.154">     Log(&quot;ProcessSelectedStateURL&quot;, nsnull, &quot;error getting source folder path string&quot;);</span>
<a href="#l46.155"></a><span id="l46.155"> </span>
<a href="#l46.156"></a><span id="l46.156">   if (NS_SUCCEEDED(res) &amp;&amp; !DeathSignalReceived())</span>
<a href="#l46.157"></a><span id="l46.157">   {</span>
<a href="#l46.158"></a><span id="l46.158" class="difflineminus">-    // OK, code here used to check explicitly for multiple connections to the inbox,</span>
<a href="#l46.159"></a><span id="l46.159" class="difflineminus">-    // but the connection pool stuff should handle this now.</span>
<a href="#l46.160"></a><span id="l46.160">     PRBool selectIssued = PR_FALSE;</span>
<a href="#l46.161"></a><span id="l46.161">     if (GetServerStateParser().GetIMAPstate() == nsImapServerResponseParser::kFolderSelected)</span>
<a href="#l46.162"></a><span id="l46.162">     {</span>
<a href="#l46.163"></a><span id="l46.163">       if (GetServerStateParser().GetSelectedMailboxName() &amp;&amp;</span>
<a href="#l46.164"></a><span id="l46.164">         PL_strcmp(GetServerStateParser().GetSelectedMailboxName(),</span>
<a href="#l46.165"></a><span id="l46.165">         mailboxName.get()))</span>
<a href="#l46.166"></a><span id="l46.166">       {       // we are selected in another folder</span>
<a href="#l46.167"></a><span id="l46.167">         if (m_closeNeededBeforeSelect)</span>
<a href="#l46.168"></a><span id="l46.168" class="difflineat">@@ -2423,16 +2427,34 @@ void nsImapProtocol::ProcessSelectedStat</span>
<a href="#l46.169"></a><span id="l46.169">           SelectMailbox(mailboxName.get());</span>
<a href="#l46.170"></a><span id="l46.170">         }</span>
<a href="#l46.171"></a><span id="l46.171">       }</span>
<a href="#l46.172"></a><span id="l46.172">       else if (!GetServerStateParser().GetSelectedMailboxName())</span>
<a href="#l46.173"></a><span id="l46.173">       {       // why are we in the selected state with no box name?</span>
<a href="#l46.174"></a><span id="l46.174">         SelectMailbox(mailboxName.get());</span>
<a href="#l46.175"></a><span id="l46.175">         selectIssued = PR_TRUE;</span>
<a href="#l46.176"></a><span id="l46.176">       }</span>
<a href="#l46.177"></a><span id="l46.177" class="difflineplus">+      else if (moreHeadersToDownload &amp;&amp; m_imapMailFolderSink) // we need to fetch older headers</span>
<a href="#l46.178"></a><span id="l46.178" class="difflineplus">+      {</span>
<a href="#l46.179"></a><span id="l46.179" class="difflineplus">+        nsMsgKey *msgIdList = nsnull;</span>
<a href="#l46.180"></a><span id="l46.180" class="difflineplus">+        PRUint32 msgCount = 0;</span>
<a href="#l46.181"></a><span id="l46.181" class="difflineplus">+        PRBool more;</span>
<a href="#l46.182"></a><span id="l46.182" class="difflineplus">+        m_imapMailFolderSink-&gt;GetMsgHdrsToDownload(&amp;more, &amp;m_progressCount,</span>
<a href="#l46.183"></a><span id="l46.183" class="difflineplus">+                                                   &amp;msgCount, &amp;msgIdList);</span>
<a href="#l46.184"></a><span id="l46.184" class="difflineplus">+        if (msgIdList)</span>
<a href="#l46.185"></a><span id="l46.185" class="difflineplus">+        {</span>
<a href="#l46.186"></a><span id="l46.186" class="difflineplus">+          FolderHeaderDump(msgIdList, msgCount);</span>
<a href="#l46.187"></a><span id="l46.187" class="difflineplus">+          NS_Free(msgIdList);</span>
<a href="#l46.188"></a><span id="l46.188" class="difflineplus">+          m_runningUrl-&gt;SetMoreHeadersToDownload(more);</span>
<a href="#l46.189"></a><span id="l46.189" class="difflineplus">+          // We're going to be re-running this url.</span>
<a href="#l46.190"></a><span id="l46.190" class="difflineplus">+          if (more)</span>
<a href="#l46.191"></a><span id="l46.191" class="difflineplus">+            m_runningUrl-&gt;SetRerunningUrl(PR_TRUE);</span>
<a href="#l46.192"></a><span id="l46.192" class="difflineplus">+        }</span>
<a href="#l46.193"></a><span id="l46.193" class="difflineplus">+        HeaderFetchCompleted();</span>
<a href="#l46.194"></a><span id="l46.194" class="difflineplus">+      }</span>
<a href="#l46.195"></a><span id="l46.195">       else</span>
<a href="#l46.196"></a><span id="l46.196">       {</span>
<a href="#l46.197"></a><span id="l46.197">         // get new message counts, if any, from server</span>
<a href="#l46.198"></a><span id="l46.198">         if (m_needNoop)</span>
<a href="#l46.199"></a><span id="l46.199">         {</span>
<a href="#l46.200"></a><span id="l46.200">           m_noopCount++;</span>
<a href="#l46.201"></a><span id="l46.201">           if ((gPromoteNoopToCheckCount &gt; 0 &amp;&amp; (m_noopCount % gPromoteNoopToCheckCount) == 0) ||</span>
<a href="#l46.202"></a><span id="l46.202">             CheckNeeded())</span>
<a href="#l46.203"></a><span id="l46.203" class="difflineat">@@ -2499,21 +2521,20 @@ void nsImapProtocol::ProcessSelectedStat</span>
<a href="#l46.204"></a><span id="l46.204">         }</span>
<a href="#l46.205"></a><span id="l46.205">         if (m_imapAction == nsIImapUrl::nsImapExpungeFolder || m_imapAction == nsIImapUrl::nsImapDeleteMsg ||</span>
<a href="#l46.206"></a><span id="l46.206">           m_imapAction == nsIImapUrl::nsImapDeleteAllMsgs)</span>
<a href="#l46.207"></a><span id="l46.207">           return;</span>
<a href="#l46.208"></a><span id="l46.208">       }</span>
<a href="#l46.209"></a><span id="l46.209">       switch (m_imapAction)</span>
<a href="#l46.210"></a><span id="l46.210">       {</span>
<a href="#l46.211"></a><span id="l46.211">       case nsIImapUrl::nsImapLiteSelectFolder:</span>
<a href="#l46.212"></a><span id="l46.212" class="difflineminus">-        if (GetServerStateParser().LastCommandSuccessful() &amp;&amp; m_imapMailFolderSink)</span>
<a href="#l46.213"></a><span id="l46.213" class="difflineplus">+        if (GetServerStateParser().LastCommandSuccessful() &amp;&amp;</span>
<a href="#l46.214"></a><span id="l46.214" class="difflineplus">+            m_imapMailFolderSink &amp;&amp; !moreHeadersToDownload)</span>
<a href="#l46.215"></a><span id="l46.215">         {</span>
<a href="#l46.216"></a><span id="l46.216">           m_imapMailFolderSink-&gt;SetUidValidity(GetServerStateParser().FolderUID());</span>
<a href="#l46.217"></a><span id="l46.217" class="difflineminus">-</span>
<a href="#l46.218"></a><span id="l46.218" class="difflineminus">-          // need to update the mailbox count - is this a good place?</span>
<a href="#l46.219"></a><span id="l46.219">           ProcessMailboxUpdate(PR_FALSE); // handle uidvalidity change</span>
<a href="#l46.220"></a><span id="l46.220">         }</span>
<a href="#l46.221"></a><span id="l46.221">         break;</span>
<a href="#l46.222"></a><span id="l46.222">       case nsIImapUrl::nsImapSaveMessageToDisk:</span>
<a href="#l46.223"></a><span id="l46.223">       case nsIImapUrl::nsImapMsgFetch:</span>
<a href="#l46.224"></a><span id="l46.224">       case nsIImapUrl::nsImapMsgFetchPeek:</span>
<a href="#l46.225"></a><span id="l46.225">       case nsIImapUrl::nsImapMsgDownloadForOffline:</span>
<a href="#l46.226"></a><span id="l46.226">       case nsIImapUrl::nsImapMsgPreview:</span>
<a href="#l46.227"></a><span id="l46.227" class="difflineat">@@ -2539,18 +2560,18 @@ void nsImapProtocol::ProcessSelectedStat</span>
<a href="#l46.228"></a><span id="l46.228">               ? kBodyStart : kEveryThingRFC822Peek);</span>
<a href="#l46.229"></a><span id="l46.229">             if (m_imapAction == nsIImapUrl::nsImapMsgPreview)</span>
<a href="#l46.230"></a><span id="l46.230">               HeaderFetchCompleted();</span>
<a href="#l46.231"></a><span id="l46.231">             SetProgressString(0);</span>
<a href="#l46.232"></a><span id="l46.232">           }</span>
<a href="#l46.233"></a><span id="l46.233">           else</span>
<a href="#l46.234"></a><span id="l46.234">           {</span>
<a href="#l46.235"></a><span id="l46.235">             // A single message ID</span>
<a href="#l46.236"></a><span id="l46.236" class="difflineminus">-		    nsIMAPeFetchFields whatToFetch = kEveryThingRFC822;</span>
<a href="#l46.237"></a><span id="l46.237" class="difflineminus">-	        if(m_imapAction == nsIImapUrl::nsImapMsgFetchPeek)</span>
<a href="#l46.238"></a><span id="l46.238" class="difflineplus">+            nsIMAPeFetchFields whatToFetch = kEveryThingRFC822;</span>
<a href="#l46.239"></a><span id="l46.239" class="difflineplus">+            if(m_imapAction == nsIImapUrl::nsImapMsgFetchPeek)</span>
<a href="#l46.240"></a><span id="l46.240">               whatToFetch = kEveryThingRFC822Peek;</span>
<a href="#l46.241"></a><span id="l46.241"> </span>
<a href="#l46.242"></a><span id="l46.242">             // First, let's see if we're requesting a specific MIME part</span>
<a href="#l46.243"></a><span id="l46.243">             char *imappart = nsnull;</span>
<a href="#l46.244"></a><span id="l46.244">             m_runningUrl-&gt;GetImapPartToFetch(&amp;imappart);</span>
<a href="#l46.245"></a><span id="l46.245">             if (imappart)</span>
<a href="#l46.246"></a><span id="l46.246">             {</span>
<a href="#l46.247"></a><span id="l46.247">               if (bMessageIdsAreUids)</span>
<a href="#l46.248"></a><span id="l46.248" class="difflineat">@@ -2685,17 +2706,18 @@ void nsImapProtocol::ProcessSelectedStat</span>
<a href="#l46.249"></a><span id="l46.249">           }</span>
<a href="#l46.250"></a><span id="l46.250">         }</span>
<a href="#l46.251"></a><span id="l46.251">         break;</span>
<a href="#l46.252"></a><span id="l46.252">       case nsIImapUrl::nsImapExpungeFolder:</span>
<a href="#l46.253"></a><span id="l46.253">         Expunge();</span>
<a href="#l46.254"></a><span id="l46.254">         // note fall through to next cases.</span>
<a href="#l46.255"></a><span id="l46.255">       case nsIImapUrl::nsImapSelectFolder:</span>
<a href="#l46.256"></a><span id="l46.256">       case nsIImapUrl::nsImapSelectNoopFolder:</span>
<a href="#l46.257"></a><span id="l46.257" class="difflineminus">-        ProcessMailboxUpdate(PR_TRUE);</span>
<a href="#l46.258"></a><span id="l46.258" class="difflineplus">+        if (!moreHeadersToDownload)</span>
<a href="#l46.259"></a><span id="l46.259" class="difflineplus">+          ProcessMailboxUpdate(PR_TRUE);</span>
<a href="#l46.260"></a><span id="l46.260">         break;</span>
<a href="#l46.261"></a><span id="l46.261">       case nsIImapUrl::nsImapMsgHeader:</span>
<a href="#l46.262"></a><span id="l46.262">         {</span>
<a href="#l46.263"></a><span id="l46.263">           nsCString messageIds;</span>
<a href="#l46.264"></a><span id="l46.264">           m_runningUrl-&gt;GetListOfMessageIds(messageIds);</span>
<a href="#l46.265"></a><span id="l46.265"> </span>
<a href="#l46.266"></a><span id="l46.266">           FetchMessage(messageIds,</span>
<a href="#l46.267"></a><span id="l46.267">             kHeadersRFC822andUid);</span>
<a href="#l46.268"></a><span id="l46.268" class="difflineat">@@ -4128,48 +4150,54 @@ void nsImapProtocol::ProcessMailboxUpdat</span>
<a href="#l46.269"></a><span id="l46.269">     nsImapAction imapAction;</span>
<a href="#l46.270"></a><span id="l46.270">     nsresult res = m_runningUrl-&gt;GetImapAction(&amp;imapAction);</span>
<a href="#l46.271"></a><span id="l46.271">     if (NS_SUCCEEDED(res) &amp;&amp; imapAction == nsIImapUrl::nsImapLiteSelectFolder)</span>
<a href="#l46.272"></a><span id="l46.272">       return;</span>
<a href="#l46.273"></a><span id="l46.273">   }</span>
<a href="#l46.274"></a><span id="l46.274"> </span>
<a href="#l46.275"></a><span id="l46.275">   PRBool entered_waitForBodyIdsMonitor = PR_FALSE;</span>
<a href="#l46.276"></a><span id="l46.276"> </span>
<a href="#l46.277"></a><span id="l46.277" class="difflineplus">+  PRUint32 *msgIdList = nsnull;</span>
<a href="#l46.278"></a><span id="l46.278" class="difflineplus">+  PRUint32 msgCount = 0;</span>
<a href="#l46.279"></a><span id="l46.279" class="difflineplus">+</span>
<a href="#l46.280"></a><span id="l46.280">   nsImapMailboxSpec *new_spec = GetServerStateParser().CreateCurrentMailboxSpec();</span>
<a href="#l46.281"></a><span id="l46.281">   if (new_spec &amp;&amp; !DeathSignalReceived())</span>
<a href="#l46.282"></a><span id="l46.282">   {</span>
<a href="#l46.283"></a><span id="l46.283" class="difflineminus">-    if (!DeathSignalReceived())</span>
<a href="#l46.284"></a><span id="l46.284" class="difflineminus">-    {</span>
<a href="#l46.285"></a><span id="l46.285" class="difflineminus">-      nsImapAction imapAction;</span>
<a href="#l46.286"></a><span id="l46.286" class="difflineminus">-      nsresult res = m_runningUrl-&gt;GetImapAction(&amp;imapAction);</span>
<a href="#l46.287"></a><span id="l46.287" class="difflineminus">-      if (NS_SUCCEEDED(res) &amp;&amp; imapAction == nsIImapUrl::nsImapExpungeFolder)</span>
<a href="#l46.288"></a><span id="l46.288" class="difflineminus">-        new_spec-&gt;mBoxFlags |= kJustExpunged;</span>
<a href="#l46.289"></a><span id="l46.289" class="difflineminus">-      m_waitForBodyIdsMonitor.Enter();</span>
<a href="#l46.290"></a><span id="l46.290" class="difflineminus">-      entered_waitForBodyIdsMonitor = PR_TRUE;</span>
<a href="#l46.291"></a><span id="l46.291" class="difflineminus">-      UpdatedMailboxSpec(new_spec);</span>
<a href="#l46.292"></a><span id="l46.292" class="difflineplus">+    nsImapAction imapAction;</span>
<a href="#l46.293"></a><span id="l46.293" class="difflineplus">+    nsresult res = m_runningUrl-&gt;GetImapAction(&amp;imapAction);</span>
<a href="#l46.294"></a><span id="l46.294" class="difflineplus">+    if (NS_SUCCEEDED(res) &amp;&amp; imapAction == nsIImapUrl::nsImapExpungeFolder)</span>
<a href="#l46.295"></a><span id="l46.295" class="difflineplus">+      new_spec-&gt;mBoxFlags |= kJustExpunged;</span>
<a href="#l46.296"></a><span id="l46.296" class="difflineplus">+    m_waitForBodyIdsMonitor.Enter();</span>
<a href="#l46.297"></a><span id="l46.297" class="difflineplus">+    entered_waitForBodyIdsMonitor = PR_TRUE;</span>
<a href="#l46.298"></a><span id="l46.298" class="difflineplus">+</span>
<a href="#l46.299"></a><span id="l46.299" class="difflineplus">+    if (m_imapMailFolderSink)</span>
<a href="#l46.300"></a><span id="l46.300" class="difflineplus">+    {</span>
<a href="#l46.301"></a><span id="l46.301" class="difflineplus">+      PRBool more;</span>
<a href="#l46.302"></a><span id="l46.302" class="difflineplus">+      m_imapMailFolderSink-&gt;UpdateImapMailboxInfo(this, new_spec);</span>
<a href="#l46.303"></a><span id="l46.303" class="difflineplus">+      m_imapMailFolderSink-&gt;GetMsgHdrsToDownload(&amp;more, &amp;m_progressCount,</span>
<a href="#l46.304"></a><span id="l46.304" class="difflineplus">+                                                 &amp;msgCount, &amp;msgIdList);</span>
<a href="#l46.305"></a><span id="l46.305" class="difflineplus">+      m_progressIndex = 0;</span>
<a href="#l46.306"></a><span id="l46.306" class="difflineplus">+      m_runningUrl-&gt;SetMoreHeadersToDownload(more);</span>
<a href="#l46.307"></a><span id="l46.307" class="difflineplus">+      // We're going to be re-running this url if there are more headers.</span>
<a href="#l46.308"></a><span id="l46.308" class="difflineplus">+      if (more)</span>
<a href="#l46.309"></a><span id="l46.309" class="difflineplus">+        m_runningUrl-&gt;SetRerunningUrl(PR_TRUE);</span>
<a href="#l46.310"></a><span id="l46.310">     }</span>
<a href="#l46.311"></a><span id="l46.311">   }</span>
<a href="#l46.312"></a><span id="l46.312">   else if (!new_spec)</span>
<a href="#l46.313"></a><span id="l46.313">     HandleMemoryFailure();</span>
<a href="#l46.314"></a><span id="l46.314"> </span>
<a href="#l46.315"></a><span id="l46.315" class="difflineminus">-  // Block until libmsg decides whether to download headers or not.</span>
<a href="#l46.316"></a><span id="l46.316" class="difflineminus">-  PRUint32 *msgIdList = nsnull;</span>
<a href="#l46.317"></a><span id="l46.317" class="difflineminus">-  PRUint32 msgCount = 0;</span>
<a href="#l46.318"></a><span id="l46.318" class="difflineminus">-</span>
<a href="#l46.319"></a><span id="l46.319">   if (!DeathSignalReceived())</span>
<a href="#l46.320"></a><span id="l46.320">   {</span>
<a href="#l46.321"></a><span id="l46.321" class="difflineminus">-    WaitForPotentialListOfMsgsToFetch(&amp;msgIdList, msgCount);</span>
<a href="#l46.322"></a><span id="l46.322" class="difflineminus">-</span>
<a href="#l46.323"></a><span id="l46.323">     if (entered_waitForBodyIdsMonitor)</span>
<a href="#l46.324"></a><span id="l46.324">       m_waitForBodyIdsMonitor.Exit();</span>
<a href="#l46.325"></a><span id="l46.325"> </span>
<a href="#l46.326"></a><span id="l46.326">     if (msgIdList &amp;&amp; !DeathSignalReceived() &amp;&amp; GetServerStateParser().LastCommandSuccessful())</span>
<a href="#l46.327"></a><span id="l46.327">     {</span>
<a href="#l46.328"></a><span id="l46.328">       FolderHeaderDump(msgIdList, msgCount);</span>
<a href="#l46.329"></a><span id="l46.329" class="difflineminus">-      PR_Free( msgIdList);</span>
<a href="#l46.330"></a><span id="l46.330" class="difflineplus">+      NS_Free( msgIdList);</span>
<a href="#l46.331"></a><span id="l46.331">     }</span>
<a href="#l46.332"></a><span id="l46.332">     HeaderFetchCompleted();</span>
<a href="#l46.333"></a><span id="l46.333">       // this might be bogus, how are we going to do pane notification and stuff when we fetch bodies without</span>
<a href="#l46.334"></a><span id="l46.334">       // headers!</span>
<a href="#l46.335"></a><span id="l46.335">   }</span>
<a href="#l46.336"></a><span id="l46.336">   else if (entered_waitForBodyIdsMonitor) // need to exit this monitor if death signal received</span>
<a href="#l46.337"></a><span id="l46.337">     m_waitForBodyIdsMonitor.Exit();</span>
<a href="#l46.338"></a><span id="l46.338"> </span>
<a href="#l46.339"></a><span id="l46.339" class="difflineat">@@ -4179,32 +4207,28 @@ void nsImapProtocol::ProcessMailboxUpdat</span>
<a href="#l46.340"></a><span id="l46.340">     WaitForPotentialListOfBodysToFetch(&amp;msgIdList, msgCount);</span>
<a href="#l46.341"></a><span id="l46.341">     if ( msgCount &amp;&amp; !DeathSignalReceived() &amp;&amp; GetServerStateParser().LastCommandSuccessful())</span>
<a href="#l46.342"></a><span id="l46.342">     {</span>
<a href="#l46.343"></a><span id="l46.343">       // Tell the url that it should store the msg fetch results offline,</span>
<a href="#l46.344"></a><span id="l46.344">       // while we're dumping the messages, and then restore the setting.</span>
<a href="#l46.345"></a><span id="l46.345">       PRBool wasStoringOffline;</span>
<a href="#l46.346"></a><span id="l46.346">       m_runningUrl-&gt;GetStoreResultsOffline(&amp;wasStoringOffline);</span>
<a href="#l46.347"></a><span id="l46.347">       m_runningUrl-&gt;SetStoreResultsOffline(PR_TRUE);</span>
<a href="#l46.348"></a><span id="l46.348" class="difflineplus">+      m_progressIndex = 0;</span>
<a href="#l46.349"></a><span id="l46.349" class="difflineplus">+      m_progressCount = msgCount;</span>
<a href="#l46.350"></a><span id="l46.350">       FolderMsgDump(msgIdList, msgCount, kEveryThingRFC822Peek);</span>
<a href="#l46.351"></a><span id="l46.351">       m_runningUrl-&gt;SetStoreResultsOffline(wasStoringOffline);</span>
<a href="#l46.352"></a><span id="l46.352">     }</span>
<a href="#l46.353"></a><span id="l46.353">   }</span>
<a href="#l46.354"></a><span id="l46.354">   if (DeathSignalReceived())</span>
<a href="#l46.355"></a><span id="l46.355">     GetServerStateParser().ResetFlagInfo();</span>
<a href="#l46.356"></a><span id="l46.356"> </span>
<a href="#l46.357"></a><span id="l46.357">   NS_IF_RELEASE(new_spec);</span>
<a href="#l46.358"></a><span id="l46.358"> }</span>
<a href="#l46.359"></a><span id="l46.359"> </span>
<a href="#l46.360"></a><span id="l46.360" class="difflineminus">-void nsImapProtocol::UpdatedMailboxSpec(nsImapMailboxSpec *aSpec)</span>
<a href="#l46.361"></a><span id="l46.361" class="difflineminus">-{</span>
<a href="#l46.362"></a><span id="l46.362" class="difflineminus">-  if (m_imapMailFolderSink)</span>
<a href="#l46.363"></a><span id="l46.363" class="difflineminus">-    m_imapMailFolderSink-&gt;UpdateImapMailboxInfo(this, aSpec);</span>
<a href="#l46.364"></a><span id="l46.364" class="difflineminus">-}</span>
<a href="#l46.365"></a><span id="l46.365" class="difflineminus">-</span>
<a href="#l46.366"></a><span id="l46.366"> void nsImapProtocol::FolderHeaderDump(PRUint32 *msgUids, PRUint32 msgCount)</span>
<a href="#l46.367"></a><span id="l46.367"> {</span>
<a href="#l46.368"></a><span id="l46.368">   FolderMsgDump(msgUids, msgCount, kHeadersRFC822andUid);</span>
<a href="#l46.369"></a><span id="l46.369"> }</span>
<a href="#l46.370"></a><span id="l46.370"> </span>
<a href="#l46.371"></a><span id="l46.371"> void nsImapProtocol::FolderMsgDump(PRUint32 *msgUids, PRUint32 msgCount, nsIMAPeFetchFields fields)</span>
<a href="#l46.372"></a><span id="l46.372"> {</span>
<a href="#l46.373"></a><span id="l46.373">   // lets worry about this progress stuff later.</span>
<a href="#l46.374"></a><span id="l46.374" class="difflineat">@@ -4215,62 +4239,34 @@ void nsImapProtocol::FolderMsgDump(PRUin</span>
<a href="#l46.375"></a><span id="l46.375">   case kFlags:</span>
<a href="#l46.376"></a><span id="l46.376">     SetProgressString(IMAP_RECEIVING_MESSAGE_FLAGS_OF);</span>
<a href="#l46.377"></a><span id="l46.377">     break;</span>
<a href="#l46.378"></a><span id="l46.378">   default:</span>
<a href="#l46.379"></a><span id="l46.379">     SetProgressString(IMAP_FOLDER_RECEIVING_MESSAGE_OF);</span>
<a href="#l46.380"></a><span id="l46.380">     break;</span>
<a href="#l46.381"></a><span id="l46.381">   }</span>
<a href="#l46.382"></a><span id="l46.382"> </span>
<a href="#l46.383"></a><span id="l46.383" class="difflineminus">-  m_progressIndex = 0;</span>
<a href="#l46.384"></a><span id="l46.384" class="difflineminus">-  m_progressCount = msgCount;</span>
<a href="#l46.385"></a><span id="l46.385">   FolderMsgDumpLoop(msgUids, msgCount, fields);</span>
<a href="#l46.386"></a><span id="l46.386"> </span>
<a href="#l46.387"></a><span id="l46.387">   SetProgressString(0);</span>
<a href="#l46.388"></a><span id="l46.388"> }</span>
<a href="#l46.389"></a><span id="l46.389"> </span>
<a href="#l46.390"></a><span id="l46.390" class="difflineminus">-void nsImapProtocol::WaitForPotentialListOfMsgsToFetch(PRUint32 **msgIdList, PRUint32 &amp;msgCount)</span>
<a href="#l46.391"></a><span id="l46.391" class="difflineminus">-{</span>
<a href="#l46.392"></a><span id="l46.392" class="difflineminus">-  PRIntervalTime sleepTime = kImapSleepTime;</span>
<a href="#l46.393"></a><span id="l46.393" class="difflineminus">-</span>
<a href="#l46.394"></a><span id="l46.394" class="difflineminus">-  ReentrantMonitorAutoEnter fetchListMon(m_fetchMsgListMonitor);</span>
<a href="#l46.395"></a><span id="l46.395" class="difflineminus">-  while(!m_fetchMsgListIsNew &amp;&amp; !DeathSignalReceived())</span>
<a href="#l46.396"></a><span id="l46.396" class="difflineminus">-    fetchListMon.Wait(sleepTime);</span>
<a href="#l46.397"></a><span id="l46.397" class="difflineminus">-  m_fetchMsgListIsNew = PR_FALSE;</span>
<a href="#l46.398"></a><span id="l46.398" class="difflineminus">-</span>
<a href="#l46.399"></a><span id="l46.399" class="difflineminus">-  *msgIdList = m_fetchMsgIdList;</span>
<a href="#l46.400"></a><span id="l46.400" class="difflineminus">-  msgCount   = m_fetchCount;</span>
<a href="#l46.401"></a><span id="l46.401" class="difflineminus">-}</span>
<a href="#l46.402"></a><span id="l46.402" class="difflineminus">-</span>
<a href="#l46.403"></a><span id="l46.403"> void nsImapProtocol::WaitForPotentialListOfBodysToFetch(PRUint32 **msgIdList, PRUint32 &amp;msgCount)</span>
<a href="#l46.404"></a><span id="l46.404"> {</span>
<a href="#l46.405"></a><span id="l46.405">   PRIntervalTime sleepTime = kImapSleepTime;</span>
<a href="#l46.406"></a><span id="l46.406"> </span>
<a href="#l46.407"></a><span id="l46.407" class="difflineminus">-  ReentrantMonitorAutoEnter fetchListMon(m_fetchMsgListMonitor);</span>
<a href="#l46.408"></a><span id="l46.408" class="difflineplus">+  ReentrantMonitorAutoEnter fetchListMon(m_fetchBodyListMonitor);</span>
<a href="#l46.409"></a><span id="l46.409">   while(!m_fetchBodyListIsNew &amp;&amp; !DeathSignalReceived())</span>
<a href="#l46.410"></a><span id="l46.410">     fetchListMon.Wait(sleepTime);</span>
<a href="#l46.411"></a><span id="l46.411">   m_fetchBodyListIsNew = PR_FALSE;</span>
<a href="#l46.412"></a><span id="l46.412"> </span>
<a href="#l46.413"></a><span id="l46.413">   *msgIdList = m_fetchBodyIdList;</span>
<a href="#l46.414"></a><span id="l46.414">   msgCount   = m_fetchBodyCount;</span>
<a href="#l46.415"></a><span id="l46.415"> }</span>
<a href="#l46.416"></a><span id="l46.416"> </span>
<a href="#l46.417"></a><span id="l46.417" class="difflineminus">-// libmsg uses this to notify a running imap url about the message headers it should</span>
<a href="#l46.418"></a><span id="l46.418" class="difflineminus">-// download while opening a folder. Generally, the imap thread will be blocked</span>
<a href="#l46.419"></a><span id="l46.419" class="difflineminus">-// in WaitForPotentialListOfMsgsToFetch waiting for this notification.</span>
<a href="#l46.420"></a><span id="l46.420" class="difflineminus">-NS_IMETHODIMP nsImapProtocol::NotifyHdrsToDownload(PRUint32 *keys, PRUint32 keyCount)</span>
<a href="#l46.421"></a><span id="l46.421" class="difflineminus">-{</span>
<a href="#l46.422"></a><span id="l46.422" class="difflineminus">-  ReentrantMonitorAutoEnter fetchListMon(m_fetchMsgListMonitor);</span>
<a href="#l46.423"></a><span id="l46.423" class="difflineminus">-  m_fetchMsgIdList = keys;</span>
<a href="#l46.424"></a><span id="l46.424" class="difflineminus">-  m_fetchCount    = keyCount;</span>
<a href="#l46.425"></a><span id="l46.425" class="difflineminus">-  m_fetchMsgListIsNew = PR_TRUE;</span>
<a href="#l46.426"></a><span id="l46.426" class="difflineminus">-  fetchListMon.Notify();</span>
<a href="#l46.427"></a><span id="l46.427" class="difflineminus">-  return NS_OK;</span>
<a href="#l46.428"></a><span id="l46.428" class="difflineminus">-}</span>
<a href="#l46.429"></a><span id="l46.429" class="difflineminus">-</span>
<a href="#l46.430"></a><span id="l46.430"> // libmsg uses this to notify a running imap url about message bodies it should download.</span>
<a href="#l46.431"></a><span id="l46.431"> // why not just have libmsg explicitly download the message bodies?</span>
<a href="#l46.432"></a><span id="l46.432"> NS_IMETHODIMP nsImapProtocol::NotifyBodysToDownload(PRUint32 *keys, PRUint32 keyCount)</span>
<a href="#l46.433"></a><span id="l46.433"> {</span>
<a href="#l46.434"></a><span id="l46.434">   ReentrantMonitorAutoEnter fetchListMon(m_fetchBodyListMonitor);</span>
<a href="#l46.435"></a><span id="l46.435">   PR_FREEIF(m_fetchBodyIdList);</span>
<a href="#l46.436"></a><span id="l46.436">   m_fetchBodyIdList = (PRUint32 *) PR_MALLOC(keyCount * sizeof(PRUint32));</span>
<a href="#l46.437"></a><span id="l46.437">   if (m_fetchBodyIdList)</span>
<a href="#l46.438"></a><span id="l46.438" class="difflineat">@@ -4377,28 +4373,24 @@ void nsImapProtocol::PeriodicBiff()</span>
<a href="#l46.439"></a><span id="l46.439"> }</span>
<a href="#l46.440"></a><span id="l46.440"> </span>
<a href="#l46.441"></a><span id="l46.441"> void nsImapProtocol::SendSetBiffIndicatorEvent(nsMsgBiffState newState)</span>
<a href="#l46.442"></a><span id="l46.442"> {</span>
<a href="#l46.443"></a><span id="l46.443">     if (m_imapMailFolderSink)</span>
<a href="#l46.444"></a><span id="l46.444">       m_imapMailFolderSink-&gt;SetBiffStateAndUpdate(newState);</span>
<a href="#l46.445"></a><span id="l46.445"> }</span>
<a href="#l46.446"></a><span id="l46.446"> </span>
<a href="#l46.447"></a><span id="l46.447" class="difflineminus">-</span>
<a href="#l46.448"></a><span id="l46.448" class="difflineminus">-</span>
<a href="#l46.449"></a><span id="l46.449"> // We get called to see if there is mail waiting for us at the server, even if it may have been</span>
<a href="#l46.450"></a><span id="l46.450"> // read elsewhere. We just want to know if we should download headers or not.</span>
<a href="#l46.451"></a><span id="l46.451"> </span>
<a href="#l46.452"></a><span id="l46.452"> PRBool nsImapProtocol::CheckNewMail()</span>
<a href="#l46.453"></a><span id="l46.453"> {</span>
<a href="#l46.454"></a><span id="l46.454">   return m_checkForNewMailDownloadsHeaders;</span>
<a href="#l46.455"></a><span id="l46.455"> }</span>
<a href="#l46.456"></a><span id="l46.456"> </span>
<a href="#l46.457"></a><span id="l46.457" class="difflineminus">-</span>
<a href="#l46.458"></a><span id="l46.458" class="difflineminus">-</span>
<a href="#l46.459"></a><span id="l46.459"> /* static */ void nsImapProtocol::LogImapUrl(const char *logMsg, nsIImapUrl *imapUrl)</span>
<a href="#l46.460"></a><span id="l46.460"> {</span>
<a href="#l46.461"></a><span id="l46.461">   // nsImapProtocol is not always constructed before this static method is called</span>
<a href="#l46.462"></a><span id="l46.462">   if (!IMAP)</span>
<a href="#l46.463"></a><span id="l46.463">     IMAP = PR_NewLogModule(&quot;IMAP&quot;);</span>
<a href="#l46.464"></a><span id="l46.464"> </span>
<a href="#l46.465"></a><span id="l46.465">   if (PR_LOG_TEST(IMAP, PR_LOG_ALWAYS))</span>
<a href="#l46.466"></a><span id="l46.466">   {</span>
<a href="#l46.467"></a><span id="l46.467" class="difflineat">@@ -5340,37 +5332,18 @@ nsImapProtocol::HandleMemoryFailure()</span>
<a href="#l46.468"></a><span id="l46.468">     // **** jefft fix me!!!!!! ******</span>
<a href="#l46.469"></a><span id="l46.469">     // m_imapThreadIsRunning = PR_FALSE;</span>
<a href="#l46.470"></a><span id="l46.470">     // SetConnectionStatus(-1);</span>
<a href="#l46.471"></a><span id="l46.471">     PR_CExitMonitor(this);</span>
<a href="#l46.472"></a><span id="l46.472"> }</span>
<a href="#l46.473"></a><span id="l46.473"> </span>
<a href="#l46.474"></a><span id="l46.474"> void nsImapProtocol::HandleCurrentUrlError()</span>
<a href="#l46.475"></a><span id="l46.475"> {</span>
<a href="#l46.476"></a><span id="l46.476" class="difflineminus">-#ifdef UNREADY_CODE</span>
<a href="#l46.477"></a><span id="l46.477" class="difflineminus">-  if (fCurrentUrl-&gt;GetIMAPurlType() == TIMAPUrl::kSelectFolder)</span>
<a href="#l46.478"></a><span id="l46.478" class="difflineminus">-  {</span>
<a href="#l46.479"></a><span id="l46.479" class="difflineminus">-    // let the front end know the select failed so they</span>
<a href="#l46.480"></a><span id="l46.480" class="difflineminus">-    // don't leave the view without a database.</span>
<a href="#l46.481"></a><span id="l46.481" class="difflineminus">-    nsImapMailboxSpec *notSelectedSpec = new nsImapMailboxSpec;</span>
<a href="#l46.482"></a><span id="l46.482" class="difflineminus">-    if (notSelectedSpec)</span>
<a href="#l46.483"></a><span id="l46.483" class="difflineminus">-    {</span>
<a href="#l46.484"></a><span id="l46.484" class="difflineminus">-      NS_ADDREF(notSelectedSpec);</span>
<a href="#l46.485"></a><span id="l46.485" class="difflineminus">-      notSelectedSpec-&gt;mAllocatedPathName = fCurrentUrl-&gt;CreateCanonicalSourceFolderPathString();</span>
<a href="#l46.486"></a><span id="l46.486" class="difflineminus">-      notSelectedSpec-&gt;mHostName = fCurrentUrl-&gt;GetUrlHost();</span>
<a href="#l46.487"></a><span id="l46.487" class="difflineminus">-      notSelectedSpec-&gt;mFolderSelected = PR_FALSE;</span>
<a href="#l46.488"></a><span id="l46.488" class="difflineminus">-      notSelectedSpec-&gt;mFlagState = nsnull;</span>
<a href="#l46.489"></a><span id="l46.489" class="difflineminus">-      notSelectedSpec-&gt;mOnlineVerified = PR_FALSE;</span>
<a href="#l46.490"></a><span id="l46.490" class="difflineminus">-      UpdatedMailboxSpec(notSelectedSpec);</span>
<a href="#l46.491"></a><span id="l46.491" class="difflineminus">-    }</span>
<a href="#l46.492"></a><span id="l46.492" class="difflineminus">-  }</span>
<a href="#l46.493"></a><span id="l46.493" class="difflineminus">-  else</span>
<a href="#l46.494"></a><span id="l46.494" class="difflineminus">-#endif</span>
<a href="#l46.495"></a><span id="l46.495" class="difflineminus">-    // this is to handle a move/copy failing, especially because the user</span>
<a href="#l46.496"></a><span id="l46.496" class="difflineminus">-    // cancelled the password prompt.</span>
<a href="#l46.497"></a><span id="l46.497" class="difflineplus">+  // This is to handle a move/copy failing, especially because the user</span>
<a href="#l46.498"></a><span id="l46.498" class="difflineplus">+  // cancelled the password prompt.</span>
<a href="#l46.499"></a><span id="l46.499">   nsresult res;</span>
<a href="#l46.500"></a><span id="l46.500">   res = m_runningUrl-&gt;GetImapAction(&amp;m_imapAction);</span>
<a href="#l46.501"></a><span id="l46.501">     if (m_imapAction == nsIImapUrl::nsImapOfflineToOnlineMove || m_imapAction == nsIImapUrl::nsImapAppendMsgFromFile</span>
<a href="#l46.502"></a><span id="l46.502">       || m_imapAction == nsIImapUrl::nsImapAppendDraftFromFile)</span>
<a href="#l46.503"></a><span id="l46.503">   {</span>
<a href="#l46.504"></a><span id="l46.504">     if (m_imapMailFolderSink)</span>
<a href="#l46.505"></a><span id="l46.505">       m_imapMailFolderSink-&gt;OnlineCopyCompleted(this, ImapOnlineCopyStateType::kFailedCopy);</span>
<a href="#l46.506"></a><span id="l46.506">   }</span>
<a href="#l46.507"></a><span id="l46.507" class="difflineat">@@ -8735,17 +8708,17 @@ nsresult nsImapMockChannel::NotifyStartE</span>
<a href="#l46.508"></a><span id="l46.508">   if (imapUrl)</span>
<a href="#l46.509"></a><span id="l46.509">   {</span>
<a href="#l46.510"></a><span id="l46.510">     nsCOMPtr&lt;nsIImapMailFolderSink&gt; folderSink;</span>
<a href="#l46.511"></a><span id="l46.511">     rv = imapUrl-&gt;GetImapMailFolderSink(getter_AddRefs(folderSink));</span>
<a href="#l46.512"></a><span id="l46.512">     if (folderSink)</span>
<a href="#l46.513"></a><span id="l46.513">     {</span>
<a href="#l46.514"></a><span id="l46.514">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailUrl = do_QueryInterface(m_url);</span>
<a href="#l46.515"></a><span id="l46.515">       rv = folderSink-&gt;SetUrlState(nsnull /* we don't know the protocol */,</span>
<a href="#l46.516"></a><span id="l46.516" class="difflineminus">-                                   mailUrl, start, m_cancelStatus);</span>
<a href="#l46.517"></a><span id="l46.517" class="difflineplus">+                                   mailUrl, start, PR_FALSE, m_cancelStatus);</span>
<a href="#l46.518"></a><span id="l46.518"> </span>
<a href="#l46.519"></a><span id="l46.519">       // Required for killing ImapProtocol thread</span>
<a href="#l46.520"></a><span id="l46.520">       if (m_cancelStatus != NS_OK &amp;&amp; imapProtocol)</span>
<a href="#l46.521"></a><span id="l46.521">         imapProtocol-&gt;TellThreadToDie(PR_FALSE);</span>
<a href="#l46.522"></a><span id="l46.522">     }</span>
<a href="#l46.523"></a><span id="l46.523">   }</span>
<a href="#l46.524"></a><span id="l46.524">   return rv;</span>
<a href="#l46.525"></a><span id="l46.525"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.h</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.h</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -389,17 +389,16 @@ private:</span>
<a href="#l47.4"></a><span id="l47.4">   typedef mozilla::Monitor ReentrantMonitor;</span>
<a href="#l47.5"></a><span id="l47.5"> #endif</span>
<a href="#l47.6"></a><span id="l47.6">   ReentrantMonitor m_dataAvailableMonitor;   // used to notify the arrival of data from the server</span>
<a href="#l47.7"></a><span id="l47.7">   ReentrantMonitor m_urlReadyToRunMonitor;   // used to notify the arrival of a new url to be processed</span>
<a href="#l47.8"></a><span id="l47.8">   ReentrantMonitor m_pseudoInterruptMonitor;</span>
<a href="#l47.9"></a><span id="l47.9">   ReentrantMonitor m_dataMemberMonitor;</span>
<a href="#l47.10"></a><span id="l47.10">   ReentrantMonitor m_threadDeathMonitor;</span>
<a href="#l47.11"></a><span id="l47.11">   ReentrantMonitor m_waitForBodyIdsMonitor;</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineminus">-  ReentrantMonitor m_fetchMsgListMonitor;</span>
<a href="#l47.13"></a><span id="l47.13">   ReentrantMonitor m_fetchBodyListMonitor;</span>
<a href="#l47.14"></a><span id="l47.14">   ReentrantMonitor m_passwordReadyMonitor;</span>
<a href="#l47.15"></a><span id="l47.15">   mozilla::Mutex mLock;</span>
<a href="#l47.16"></a><span id="l47.16">   // If we get an async password prompt, this is where the UI thread</span>
<a href="#l47.17"></a><span id="l47.17">   // stores the password, before notifying the imap thread of the password</span>
<a href="#l47.18"></a><span id="l47.18">   // via the m_passwordReadyMonitor.</span>
<a href="#l47.19"></a><span id="l47.19">   nsCString m_password;</span>
<a href="#l47.20"></a><span id="l47.20">   // Set to the result of nsImapServer::PromptPassword</span>
<a href="#l47.21"></a><span id="l47.21" class="difflineat">@@ -434,36 +433,31 @@ private:</span>
<a href="#l47.22"></a><span id="l47.22">   virtual void ParseIMAPandCheckForNewMail(const char* commandString =</span>
<a href="#l47.23"></a><span id="l47.23">     nsnull, PRBool ignoreBadNOResponses = PR_FALSE);</span>
<a href="#l47.24"></a><span id="l47.24">   // biff</span>
<a href="#l47.25"></a><span id="l47.25">   void  PeriodicBiff();</span>
<a href="#l47.26"></a><span id="l47.26">   void  SendSetBiffIndicatorEvent(nsMsgBiffState newState);</span>
<a href="#l47.27"></a><span id="l47.27">   PRBool  CheckNewMail();</span>
<a href="#l47.28"></a><span id="l47.28"> </span>
<a href="#l47.29"></a><span id="l47.29">   // folder opening and listing header functions</span>
<a href="#l47.30"></a><span id="l47.30" class="difflineminus">-  void UpdatedMailboxSpec(nsImapMailboxSpec *aSpec);</span>
<a href="#l47.31"></a><span id="l47.31">   void FolderHeaderDump(PRUint32 *msgUids, PRUint32 msgCount);</span>
<a href="#l47.32"></a><span id="l47.32">   void FolderMsgDump(PRUint32 *msgUids, PRUint32 msgCount, nsIMAPeFetchFields fields);</span>
<a href="#l47.33"></a><span id="l47.33">   void FolderMsgDumpLoop(PRUint32 *msgUids, PRUint32 msgCount, nsIMAPeFetchFields fields);</span>
<a href="#l47.34"></a><span id="l47.34" class="difflineminus">-  void WaitForPotentialListOfMsgsToFetch(PRUint32 **msgIdList, PRUint32 &amp;msgCount);</span>
<a href="#l47.35"></a><span id="l47.35">   void WaitForPotentialListOfBodysToFetch(PRUint32 **msgIdList, PRUint32 &amp;msgCount);</span>
<a href="#l47.36"></a><span id="l47.36">   void HeaderFetchCompleted();</span>
<a href="#l47.37"></a><span id="l47.37">   void UploadMessageFromFile(nsIFile* file, const char* mailboxName, PRTime date,</span>
<a href="#l47.38"></a><span id="l47.38">     imapMessageFlagsType flags, nsCString &amp;keywords);</span>
<a href="#l47.39"></a><span id="l47.39"> </span>
<a href="#l47.40"></a><span id="l47.40">   // mailbox name utilities.</span>
<a href="#l47.41"></a><span id="l47.41">   void CreateEscapedMailboxName(const char *rawName, nsCString &amp;escapedName);</span>
<a href="#l47.42"></a><span id="l47.42">   void SetupMessageFlagsString(nsCString &amp; flagString,</span>
<a href="#l47.43"></a><span id="l47.43">     imapMessageFlagsType flags,</span>
<a href="#l47.44"></a><span id="l47.44">     PRUint16 userFlags);</span>
<a href="#l47.45"></a><span id="l47.45"> </span>
<a href="#l47.46"></a><span id="l47.46" class="difflineminus">-  // header listing data</span>
<a href="#l47.47"></a><span id="l47.47" class="difflineminus">-  PRBool    m_fetchMsgListIsNew;</span>
<a href="#l47.48"></a><span id="l47.48" class="difflineminus">-  PRUint32  m_fetchCount;</span>
<a href="#l47.49"></a><span id="l47.49" class="difflineminus">-  PRUint32  *m_fetchMsgIdList;</span>
<a href="#l47.50"></a><span id="l47.50" class="difflineplus">+  // body fetching listing data</span>
<a href="#l47.51"></a><span id="l47.51">   PRBool    m_fetchBodyListIsNew;</span>
<a href="#l47.52"></a><span id="l47.52">   PRUint32  m_fetchBodyCount;</span>
<a href="#l47.53"></a><span id="l47.53">   PRUint32  *m_fetchBodyIdList;</span>
<a href="#l47.54"></a><span id="l47.54"> </span>
<a href="#l47.55"></a><span id="l47.55">   // initialization function given a new url and transport layer</span>
<a href="#l47.56"></a><span id="l47.56">   nsresult  SetupWithUrl(nsIURI * aURL, nsISupports* aConsumer);</span>
<a href="#l47.57"></a><span id="l47.57">   void ReleaseUrlState(PRBool rerunningUrl); // release any state that is stored on a per action basis.</span>
<a href="#l47.58"></a><span id="l47.58">   /**</span>
<a href="#l47.59"></a><span id="l47.59" class="difflineat">@@ -771,21 +765,21 @@ protected:</span>
<a href="#l47.60"></a><span id="l47.60"> </span>
<a href="#l47.61"></a><span id="l47.61"> // This class contains the name of a mailbox and whether or not</span>
<a href="#l47.62"></a><span id="l47.62"> // its children have been listed.</span>
<a href="#l47.63"></a><span id="l47.63"> class nsIMAPMailboxInfo</span>
<a href="#l47.64"></a><span id="l47.64"> {</span>
<a href="#l47.65"></a><span id="l47.65"> public:</span>
<a href="#l47.66"></a><span id="l47.66">   nsIMAPMailboxInfo(const nsACString &amp;aName, char aDelimiter);</span>
<a href="#l47.67"></a><span id="l47.67">   virtual ~nsIMAPMailboxInfo();</span>
<a href="#l47.68"></a><span id="l47.68" class="difflineminus">-  </span>
<a href="#l47.69"></a><span id="l47.69" class="difflineplus">+</span>
<a href="#l47.70"></a><span id="l47.70">   void   SetChildrenListed(PRBool childrenListed);</span>
<a href="#l47.71"></a><span id="l47.71">   PRBool GetChildrenListed();</span>
<a href="#l47.72"></a><span id="l47.72">   const  nsACString&amp; GetMailboxName();</span>
<a href="#l47.73"></a><span id="l47.73">   char   GetDelimiter();</span>
<a href="#l47.74"></a><span id="l47.74" class="difflineminus">-  </span>
<a href="#l47.75"></a><span id="l47.75" class="difflineplus">+</span>
<a href="#l47.76"></a><span id="l47.76"> protected:</span>
<a href="#l47.77"></a><span id="l47.77">   nsCString mMailboxName;</span>
<a href="#l47.78"></a><span id="l47.78">   PRBool   mChildrenListed;</span>
<a href="#l47.79"></a><span id="l47.79">   char     mDelimiter;</span>
<a href="#l47.80"></a><span id="l47.80"> };</span>
<a href="#l47.81"></a><span id="l47.81"> </span>
<a href="#l47.82"></a><span id="l47.82"> #endif  // nsImapProtocol_h___</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/mailnews/imap/src/nsImapUrl.cpp</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapUrl.cpp</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -81,16 +81,17 @@ nsImapUrl::nsImapUrl() : mLock(&quot;nsImapUr</span>
<a href="#l48.4"></a><span id="l48.4">   m_mimePartSelectorDetected = PR_FALSE;</span>
<a href="#l48.5"></a><span id="l48.5">   m_allowContentChange = PR_TRUE;  // assume we can do MPOD.</span>
<a href="#l48.6"></a><span id="l48.6">   m_fetchPartsOnDemand = PR_FALSE; // but assume we're not doing it :-)</span>
<a href="#l48.7"></a><span id="l48.7">   m_msgLoadingFromCache = PR_FALSE;</span>
<a href="#l48.8"></a><span id="l48.8">   m_storeResultsOffline = PR_FALSE;</span>
<a href="#l48.9"></a><span id="l48.9">   m_storeOfflineOnFallback = PR_FALSE;</span>
<a href="#l48.10"></a><span id="l48.10">   m_localFetchOnly = PR_FALSE;</span>
<a href="#l48.11"></a><span id="l48.11">   m_rerunningUrl = PR_FALSE;</span>
<a href="#l48.12"></a><span id="l48.12" class="difflineplus">+  m_moreHeadersToDownload = PR_FALSE;</span>
<a href="#l48.13"></a><span id="l48.13">   m_externalLinkUrl = PR_TRUE; // we'll start this at true, and set it false in nsImapService::CreateStartOfImapUrl</span>
<a href="#l48.14"></a><span id="l48.14">   m_contentModified = IMAP_CONTENT_NOT_MODIFIED;</span>
<a href="#l48.15"></a><span id="l48.15">   m_validUrl = PR_TRUE;  // assume the best.</span>
<a href="#l48.16"></a><span id="l48.16">   m_flags = 0;</span>
<a href="#l48.17"></a><span id="l48.17">   m_extraStatus = ImapStatusNone;</span>
<a href="#l48.18"></a><span id="l48.18">   m_onlineSubDirSeparator = '/';</span>
<a href="#l48.19"></a><span id="l48.19"> </span>
<a href="#l48.20"></a><span id="l48.20">   // ** jt - the following are not ref counted</span>
<a href="#l48.21"></a><span id="l48.21" class="difflineat">@@ -1252,16 +1253,17 @@ NS_IMETHODIMP nsImapUrl::GetUri(char** a</span>
<a href="#l48.22"></a><span id="l48.22"> </span>
<a href="#l48.23"></a><span id="l48.23"> NS_IMPL_GETSET(nsImapUrl, AddDummyEnvelope, PRBool, m_addDummyEnvelope)</span>
<a href="#l48.24"></a><span id="l48.24"> NS_IMPL_GETSET(nsImapUrl, CanonicalLineEnding, PRBool, m_canonicalLineEnding)</span>
<a href="#l48.25"></a><span id="l48.25"> NS_IMPL_GETTER(nsImapUrl::GetMsgLoadingFromCache, PRBool, m_msgLoadingFromCache)</span>
<a href="#l48.26"></a><span id="l48.26"> NS_IMPL_GETSET(nsImapUrl, LocalFetchOnly, PRBool, m_localFetchOnly)</span>
<a href="#l48.27"></a><span id="l48.27"> NS_IMPL_GETSET(nsImapUrl, ExternalLinkUrl, PRBool, m_externalLinkUrl)</span>
<a href="#l48.28"></a><span id="l48.28"> NS_IMPL_GETSET(nsImapUrl, RerunningUrl, PRBool, m_rerunningUrl)</span>
<a href="#l48.29"></a><span id="l48.29"> NS_IMPL_GETSET(nsImapUrl, ValidUrl, PRBool, m_validUrl)</span>
<a href="#l48.30"></a><span id="l48.30" class="difflineplus">+NS_IMPL_GETSET(nsImapUrl, MoreHeadersToDownload, PRBool, m_moreHeadersToDownload)</span>
<a href="#l48.31"></a><span id="l48.31"> </span>
<a href="#l48.32"></a><span id="l48.32"> NS_IMETHODIMP nsImapUrl::SetMsgLoadingFromCache(PRBool loadingFromCache)</span>
<a href="#l48.33"></a><span id="l48.33"> {</span>
<a href="#l48.34"></a><span id="l48.34">   nsresult rv = NS_OK;</span>
<a href="#l48.35"></a><span id="l48.35">   m_msgLoadingFromCache = loadingFromCache;</span>
<a href="#l48.36"></a><span id="l48.36">   return rv;</span>
<a href="#l48.37"></a><span id="l48.37"> }</span>
<a href="#l48.38"></a><span id="l48.38"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/mailnews/imap/src/nsImapUrl.h</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapUrl.h</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -123,16 +123,17 @@ protected:</span>
<a href="#l49.4"></a><span id="l49.4">   PRPackedBool m_fetchPartsOnDemand; // if PR_TRUE, we should fetch leave parts on server.</span>
<a href="#l49.5"></a><span id="l49.5">   PRPackedBool m_msgLoadingFromCache; // if PR_TRUE, we might need to mark read on server</span>
<a href="#l49.6"></a><span id="l49.6">   PRPackedBool m_externalLinkUrl; // if PR_TRUE, we're running this url because the user</span>
<a href="#l49.7"></a><span id="l49.7">   // True if the fetch results should be put in the offline store.</span>
<a href="#l49.8"></a><span id="l49.8">   PRPackedBool m_storeResultsOffline;</span>
<a href="#l49.9"></a><span id="l49.9">   PRPackedBool m_storeOfflineOnFallback;</span>
<a href="#l49.10"></a><span id="l49.10">   PRPackedBool m_localFetchOnly;</span>
<a href="#l49.11"></a><span id="l49.11">   PRPackedBool m_rerunningUrl; // first attempt running this failed with connection error; retrying</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineplus">+  PRPackedBool m_moreHeadersToDownload;</span>
<a href="#l49.13"></a><span id="l49.13">   nsImapContentModifiedType  m_contentModified;</span>
<a href="#l49.14"></a><span id="l49.14"> </span>
<a href="#l49.15"></a><span id="l49.15">   PRInt32    m_extraStatus;</span>
<a href="#l49.16"></a><span id="l49.16"> </span>
<a href="#l49.17"></a><span id="l49.17">   nsCString  m_userName;</span>
<a href="#l49.18"></a><span id="l49.18">   nsCString  m_serverKey;</span>
<a href="#l49.19"></a><span id="l49.19">   // event sinks</span>
<a href="#l49.20"></a><span id="l49.20">   imapMessageFlagsType  m_flags;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1">new file mode 100644</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineminus">--- /dev/null</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapHdrChunking.js</span>
<a href="#l50.4"></a><span id="l50.4" class="difflineat">@@ -0,0 +1,171 @@</span>
<a href="#l50.5"></a><span id="l50.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l50.6"></a><span id="l50.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l50.7"></a><span id="l50.7" class="difflineplus">+ *</span>
<a href="#l50.8"></a><span id="l50.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l50.9"></a><span id="l50.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l50.10"></a><span id="l50.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l50.11"></a><span id="l50.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l50.12"></a><span id="l50.12" class="difflineplus">+ *</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l50.14"></a><span id="l50.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l50.15"></a><span id="l50.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l50.16"></a><span id="l50.16" class="difflineplus">+ * License.</span>
<a href="#l50.17"></a><span id="l50.17" class="difflineplus">+ *</span>
<a href="#l50.18"></a><span id="l50.18" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l50.19"></a><span id="l50.19" class="difflineplus">+ *</span>
<a href="#l50.20"></a><span id="l50.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l50.21"></a><span id="l50.21" class="difflineplus">+ *   The Mozilla Foundation</span>
<a href="#l50.22"></a><span id="l50.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l50.23"></a><span id="l50.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l50.24"></a><span id="l50.24" class="difflineplus">+ *</span>
<a href="#l50.25"></a><span id="l50.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l50.26"></a><span id="l50.26" class="difflineplus">+ * David Bienvenu &lt;bienvenu@mozilla.com&gt;</span>
<a href="#l50.27"></a><span id="l50.27" class="difflineplus">+ *</span>
<a href="#l50.28"></a><span id="l50.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l50.29"></a><span id="l50.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l50.30"></a><span id="l50.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l50.31"></a><span id="l50.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l50.32"></a><span id="l50.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l50.33"></a><span id="l50.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l50.34"></a><span id="l50.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l50.35"></a><span id="l50.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l50.36"></a><span id="l50.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l50.37"></a><span id="l50.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l50.38"></a><span id="l50.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l50.39"></a><span id="l50.39" class="difflineplus">+ *</span>
<a href="#l50.40"></a><span id="l50.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l50.41"></a><span id="l50.41" class="difflineplus">+</span>
<a href="#l50.42"></a><span id="l50.42" class="difflineplus">+/*</span>
<a href="#l50.43"></a><span id="l50.43" class="difflineplus">+ * Tests imap msg header download chunking</span>
<a href="#l50.44"></a><span id="l50.44" class="difflineplus">+ */</span>
<a href="#l50.45"></a><span id="l50.45" class="difflineplus">+</span>
<a href="#l50.46"></a><span id="l50.46" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l50.47"></a><span id="l50.47" class="difflineplus">+load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l50.48"></a><span id="l50.48" class="difflineplus">+load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l50.49"></a><span id="l50.49" class="difflineplus">+load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l50.50"></a><span id="l50.50" class="difflineplus">+</span>
<a href="#l50.51"></a><span id="l50.51" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l50.52"></a><span id="l50.52" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l50.53"></a><span id="l50.53" class="difflineplus">+// javascript mime emitter functions</span>
<a href="#l50.54"></a><span id="l50.54" class="difflineplus">+</span>
<a href="#l50.55"></a><span id="l50.55" class="difflineplus">+// IMAP pump</span>
<a href="#l50.56"></a><span id="l50.56" class="difflineplus">+load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l50.57"></a><span id="l50.57" class="difflineplus">+</span>
<a href="#l50.58"></a><span id="l50.58" class="difflineplus">+setupIMAPPump();</span>
<a href="#l50.59"></a><span id="l50.59" class="difflineplus">+</span>
<a href="#l50.60"></a><span id="l50.60" class="difflineplus">+// Dummy message window so we can say the inbox is open in a window.</span>
<a href="#l50.61"></a><span id="l50.61" class="difflineplus">+var dummyMsgWindow =</span>
<a href="#l50.62"></a><span id="l50.62" class="difflineplus">+{</span>
<a href="#l50.63"></a><span id="l50.63" class="difflineplus">+  openFolder : gIMAPInbox,</span>
<a href="#l50.64"></a><span id="l50.64" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI([Ci.nsIMsgWindow,</span>
<a href="#l50.65"></a><span id="l50.65" class="difflineplus">+                                         Ci.nsISupportsWeakReference])</span>
<a href="#l50.66"></a><span id="l50.66" class="difflineplus">+};</span>
<a href="#l50.67"></a><span id="l50.67" class="difflineplus">+</span>
<a href="#l50.68"></a><span id="l50.68" class="difflineplus">+var mfnListener =</span>
<a href="#l50.69"></a><span id="l50.69" class="difflineplus">+{</span>
<a href="#l50.70"></a><span id="l50.70" class="difflineplus">+  _msgStreamed: false,</span>
<a href="#l50.71"></a><span id="l50.71" class="difflineplus">+  msgAdded: function msgAdded(aMsg)</span>
<a href="#l50.72"></a><span id="l50.72" class="difflineplus">+  {</span>
<a href="#l50.73"></a><span id="l50.73" class="difflineplus">+    if (!this._msgStreamed) {</span>
<a href="#l50.74"></a><span id="l50.74" class="difflineplus">+      // Try to fetch the message with UID 8. This will be the first header </span>
<a href="#l50.75"></a><span id="l50.75" class="difflineplus">+      // downloaded iff we fetch the newest hdrs first.</span>
<a href="#l50.76"></a><span id="l50.76" class="difflineplus">+      let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l50.77"></a><span id="l50.77" class="difflineplus">+      let msgURI = gIMAPInbox.getUriForMsg(aMsg);</span>
<a href="#l50.78"></a><span id="l50.78" class="difflineplus">+      do_check_eq(aMsg.messageKey, 8);</span>
<a href="#l50.79"></a><span id="l50.79" class="difflineplus">+      let msgServ = messenger.messageServiceFromURI(msgURI);</span>
<a href="#l50.80"></a><span id="l50.80" class="difflineplus">+      msgServ.streamMessage(msgURI, gStreamListener, null, null, false, &quot;&quot;, false);</span>
<a href="#l50.81"></a><span id="l50.81" class="difflineplus">+      this._msgStreamed = true;</span>
<a href="#l50.82"></a><span id="l50.82" class="difflineplus">+    }</span>
<a href="#l50.83"></a><span id="l50.83" class="difflineplus">+  }</span>
<a href="#l50.84"></a><span id="l50.84" class="difflineplus">+};</span>
<a href="#l50.85"></a><span id="l50.85" class="difflineplus">+</span>
<a href="#l50.86"></a><span id="l50.86" class="difflineplus">+gStreamListener = {</span>
<a href="#l50.87"></a><span id="l50.87" class="difflineplus">+  QueryInterface : XPCOMUtils.generateQI([Ci.nsIStreamListener]),</span>
<a href="#l50.88"></a><span id="l50.88" class="difflineplus">+  _stream : null,</span>
<a href="#l50.89"></a><span id="l50.89" class="difflineplus">+  _gotStartRequest : false,</span>
<a href="#l50.90"></a><span id="l50.90" class="difflineplus">+  onStartRequest : function (aRequest, aContext) {</span>
<a href="#l50.91"></a><span id="l50.91" class="difflineplus">+    this._gotStartRequest = true;</span>
<a href="#l50.92"></a><span id="l50.92" class="difflineplus">+  },</span>
<a href="#l50.93"></a><span id="l50.93" class="difflineplus">+  onStopRequest : function (aRequest, aContext, aStatusCode) {</span>
<a href="#l50.94"></a><span id="l50.94" class="difflineplus">+    async_driver();</span>
<a href="#l50.95"></a><span id="l50.95" class="difflineplus">+  },</span>
<a href="#l50.96"></a><span id="l50.96" class="difflineplus">+  onDataAvailable : function (aRequest, aContext, aInputStream, aOff, aCount) {</span>
<a href="#l50.97"></a><span id="l50.97" class="difflineplus">+    if (this._stream == null) {</span>
<a href="#l50.98"></a><span id="l50.98" class="difflineplus">+      this._stream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l50.99"></a><span id="l50.99" class="difflineplus">+      this._stream.init(aInputStream);</span>
<a href="#l50.100"></a><span id="l50.100" class="difflineplus">+    }</span>
<a href="#l50.101"></a><span id="l50.101" class="difflineplus">+    this._data += this._stream.read(aCount);</span>
<a href="#l50.102"></a><span id="l50.102" class="difflineplus">+  },</span>
<a href="#l50.103"></a><span id="l50.103" class="difflineplus">+};</span>
<a href="#l50.104"></a><span id="l50.104" class="difflineplus">+</span>
<a href="#l50.105"></a><span id="l50.105" class="difflineplus">+</span>
<a href="#l50.106"></a><span id="l50.106" class="difflineplus">+var tests = [</span>
<a href="#l50.107"></a><span id="l50.107" class="difflineplus">+  uploadImapMessages,</span>
<a href="#l50.108"></a><span id="l50.108" class="difflineplus">+  testMessageFetched,</span>
<a href="#l50.109"></a><span id="l50.109" class="difflineplus">+  testHdrsDownloaded,</span>
<a href="#l50.110"></a><span id="l50.110" class="difflineplus">+  endTest</span>
<a href="#l50.111"></a><span id="l50.111" class="difflineplus">+]</span>
<a href="#l50.112"></a><span id="l50.112" class="difflineplus">+</span>
<a href="#l50.113"></a><span id="l50.113" class="difflineplus">+// upload messages to the imap fake server Inbox</span>
<a href="#l50.114"></a><span id="l50.114" class="difflineplus">+function uploadImapMessages()</span>
<a href="#l50.115"></a><span id="l50.115" class="difflineplus">+{</span>
<a href="#l50.116"></a><span id="l50.116" class="difflineplus">+  // make 10 messges</span>
<a href="#l50.117"></a><span id="l50.117" class="difflineplus">+  let messageGenerator = new MessageGenerator();</span>
<a href="#l50.118"></a><span id="l50.118" class="difflineplus">+  let scenarioFactory = new MessageScenarioFactory(messageGenerator);</span>
<a href="#l50.119"></a><span id="l50.119" class="difflineplus">+</span>
<a href="#l50.120"></a><span id="l50.120" class="difflineplus">+  // build up a list of messages</span>
<a href="#l50.121"></a><span id="l50.121" class="difflineplus">+  let messages = [];</span>
<a href="#l50.122"></a><span id="l50.122" class="difflineplus">+  messages = messages.concat(scenarioFactory.directReply(10));</span>
<a href="#l50.123"></a><span id="l50.123" class="difflineplus">+</span>
<a href="#l50.124"></a><span id="l50.124" class="difflineplus">+  // Add 10 messages with uids 1-10.</span>
<a href="#l50.125"></a><span id="l50.125" class="difflineplus">+  let imapInbox = gIMAPDaemon.getMailbox(&quot;INBOX&quot;)</span>
<a href="#l50.126"></a><span id="l50.126" class="difflineplus">+  // Create the imapMessages and store them on the mailbox</span>
<a href="#l50.127"></a><span id="l50.127" class="difflineplus">+  messages.forEach(function (message)</span>
<a href="#l50.128"></a><span id="l50.128" class="difflineplus">+  {</span>
<a href="#l50.129"></a><span id="l50.129" class="difflineplus">+    let dataUri = Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l50.130"></a><span id="l50.130" class="difflineplus">+                                      btoa(message.toMessageString()),</span>
<a href="#l50.131"></a><span id="l50.131" class="difflineplus">+                                     null, null);</span>
<a href="#l50.132"></a><span id="l50.132" class="difflineplus">+    imapInbox.addMessage(new imapMessage(dataUri.spec, imapInbox.uidnext++, []));</span>
<a href="#l50.133"></a><span id="l50.133" class="difflineplus">+  });</span>
<a href="#l50.134"></a><span id="l50.134" class="difflineplus">+  gIMAPInbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l50.135"></a><span id="l50.135" class="difflineplus">+  yield false;</span>
<a href="#l50.136"></a><span id="l50.136" class="difflineplus">+}</span>
<a href="#l50.137"></a><span id="l50.137" class="difflineplus">+</span>
<a href="#l50.138"></a><span id="l50.138" class="difflineplus">+function testMessageFetched() {</span>
<a href="#l50.139"></a><span id="l50.139" class="difflineplus">+  // If we're really chunking, then the message fetch should have started before</span>
<a href="#l50.140"></a><span id="l50.140" class="difflineplus">+  // we finished the updateFolder URL.</span>
<a href="#l50.141"></a><span id="l50.141" class="difflineplus">+  do_check_true(gStreamListener._gotStartRequest);</span>
<a href="#l50.142"></a><span id="l50.142" class="difflineplus">+  // Should have only downloaded first chunk of headers when message</span>
<a href="#l50.143"></a><span id="l50.143" class="difflineplus">+  // has finished streaming.</span>
<a href="#l50.144"></a><span id="l50.144" class="difflineplus">+  do_check_eq(gIMAPInbox.msgDatabase.dBFolderInfo.numMessages, 3);</span>
<a href="#l50.145"></a><span id="l50.145" class="difflineplus">+  yield false;</span>
<a href="#l50.146"></a><span id="l50.146" class="difflineplus">+}</span>
<a href="#l50.147"></a><span id="l50.147" class="difflineplus">+</span>
<a href="#l50.148"></a><span id="l50.148" class="difflineplus">+function testHdrsDownloaded() {</span>
<a href="#l50.149"></a><span id="l50.149" class="difflineplus">+  // Make sure we got all 10 headers.</span>
<a href="#l50.150"></a><span id="l50.150" class="difflineplus">+  do_check_eq(gIMAPInbox.msgDatabase.dBFolderInfo.numMessages, 10);</span>
<a href="#l50.151"></a><span id="l50.151" class="difflineplus">+  yield true;</span>
<a href="#l50.152"></a><span id="l50.152" class="difflineplus">+}</span>
<a href="#l50.153"></a><span id="l50.153" class="difflineplus">+</span>
<a href="#l50.154"></a><span id="l50.154" class="difflineplus">+// Cleanup</span>
<a href="#l50.155"></a><span id="l50.155" class="difflineplus">+function endTest() {</span>
<a href="#l50.156"></a><span id="l50.156" class="difflineplus">+  teardownIMAPPump();</span>
<a href="#l50.157"></a><span id="l50.157" class="difflineplus">+}</span>
<a href="#l50.158"></a><span id="l50.158" class="difflineplus">+</span>
<a href="#l50.159"></a><span id="l50.159" class="difflineplus">+function run_test()</span>
<a href="#l50.160"></a><span id="l50.160" class="difflineplus">+{</span>
<a href="#l50.161"></a><span id="l50.161" class="difflineplus">+  // We need to register the dummyMsgWindow so that we'll think the</span>
<a href="#l50.162"></a><span id="l50.162" class="difflineplus">+  // Inbox is open in a folder and fetch headers in chunks.</span>
<a href="#l50.163"></a><span id="l50.163" class="difflineplus">+  MailServices.mailSession.AddMsgWindow(dummyMsgWindow);</span>
<a href="#l50.164"></a><span id="l50.164" class="difflineplus">+  MailServices.mfn.addListener(mfnListener, MailServices.mfn.msgAdded);</span>
<a href="#l50.165"></a><span id="l50.165" class="difflineplus">+</span>
<a href="#l50.166"></a><span id="l50.166" class="difflineplus">+  // Set chunk size to 3, so we'll have to chain 4 requests to get</span>
<a href="#l50.167"></a><span id="l50.167" class="difflineplus">+  // 10 headers.</span>
<a href="#l50.168"></a><span id="l50.168" class="difflineplus">+  Services.prefs.setIntPref(&quot;mail.imap.hdr_chunk_size&quot;, 3);</span>
<a href="#l50.169"></a><span id="l50.169" class="difflineplus">+  // Turn off offline sync to avoid complications in verifying that we can</span>
<a href="#l50.170"></a><span id="l50.170" class="difflineplus">+  // run a url after the first header chunk.</span>
<a href="#l50.171"></a><span id="l50.171" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l50.172"></a><span id="l50.172" class="difflineplus">+</span>
<a href="#l50.173"></a><span id="l50.173" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l50.174"></a><span id="l50.174" class="difflineplus">+}</span>
<a href="#l50.175"></a><span id="l50.175" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1">new file mode 100644</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineminus">--- /dev/null</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineplus">+++ b/mailnews/imap/test/unit/xpcshell.ini</span>
<a href="#l51.4"></a><span id="l51.4" class="difflineat">@@ -0,0 +1,46 @@</span>
<a href="#l51.5"></a><span id="l51.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l51.6"></a><span id="l51.6" class="difflineplus">+head = head_server.js</span>
<a href="#l51.7"></a><span id="l51.7" class="difflineplus">+tail = tail_imap.js</span>
<a href="#l51.8"></a><span id="l51.8" class="difflineplus">+</span>
<a href="#l51.9"></a><span id="l51.9" class="difflineplus">+[test_autosync_date_constraints.js]</span>
<a href="#l51.10"></a><span id="l51.10" class="difflineplus">+[test_bccProperty.js]</span>
<a href="#l51.11"></a><span id="l51.11" class="difflineplus">+[test_bug460636.js]</span>
<a href="#l51.12"></a><span id="l51.12" class="difflineplus">+[test_compactOfflineStore.js]</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineplus">+[test_copyThenMove.js]</span>
<a href="#l51.14"></a><span id="l51.14" class="difflineplus">+[test_dod.js]</span>
<a href="#l51.15"></a><span id="l51.15" class="difflineplus">+[test_dontStatNoSelect.js]</span>
<a href="#l51.16"></a><span id="l51.16" class="difflineplus">+[test_downloadOffline.js]</span>
<a href="#l51.17"></a><span id="l51.17" class="difflineplus">+[test_filterNeedsBody.js]</span>
<a href="#l51.18"></a><span id="l51.18" class="difflineplus">+[test_imapAttachmentSaves.js]</span>
<a href="#l51.19"></a><span id="l51.19" class="difflineplus">+[test_imapAuthMethods.js]</span>
<a href="#l51.20"></a><span id="l51.20" class="difflineplus">+[test_imapAutoSync.js]</span>
<a href="#l51.21"></a><span id="l51.21" class="difflineplus">+[test_imapContentLength.js]</span>
<a href="#l51.22"></a><span id="l51.22" class="difflineplus">+[test_imapCopyTimeout.js]</span>
<a href="#l51.23"></a><span id="l51.23" class="difflineplus">+[test_imapFilterActions.js]</span>
<a href="#l51.24"></a><span id="l51.24" class="difflineplus">+[test_imapFlagChange.js]</span>
<a href="#l51.25"></a><span id="l51.25" class="difflineplus">+[test_imapFolderCopy.js]</span>
<a href="#l51.26"></a><span id="l51.26" class="difflineplus">+[test_imapHdrChunking.js]</span>
<a href="#l51.27"></a><span id="l51.27" class="difflineplus">+[test_imapHighWater.js]</span>
<a href="#l51.28"></a><span id="l51.28" class="difflineplus">+[test_imapID.js]</span>
<a href="#l51.29"></a><span id="l51.29" class="difflineplus">+[test_imapMove.js]</span>
<a href="#l51.30"></a><span id="l51.30" class="difflineplus">+[test_imapPasswordFailure.js]</span>
<a href="#l51.31"></a><span id="l51.31" class="difflineplus">+[test_imapProtocols.js]</span>
<a href="#l51.32"></a><span id="l51.32" class="difflineplus">+[test_imapStatusCloseDBs.js]</span>
<a href="#l51.33"></a><span id="l51.33" class="difflineplus">+[test_imapStoreMsgOffline.js]</span>
<a href="#l51.34"></a><span id="l51.34" class="difflineplus">+[test_imapUndo.js]</span>
<a href="#l51.35"></a><span id="l51.35" class="difflineplus">+[test_imapUrls.js]</span>
<a href="#l51.36"></a><span id="l51.36" class="difflineplus">+[test_largeOfflineStore.js]</span>
<a href="#l51.37"></a><span id="l51.37" class="difflineplus">+[test_listClosesDB.js]</span>
<a href="#l51.38"></a><span id="l51.38" class="difflineplus">+[test_localToImapFilter.js]</span>
<a href="#l51.39"></a><span id="l51.39" class="difflineplus">+[test_localToImapFilterQuarantine.js]</span>
<a href="#l51.40"></a><span id="l51.40" class="difflineplus">+[test_mailboxes.js]</span>
<a href="#l51.41"></a><span id="l51.41" class="difflineplus">+[test_nsIMsgFolderListenerIMAP.js]</span>
<a href="#l51.42"></a><span id="l51.42" class="difflineplus">+[test_offlinePlayback.js]</span>
<a href="#l51.43"></a><span id="l51.43" class="difflineplus">+[test_offlineStoreLocking.js]</span>
<a href="#l51.44"></a><span id="l51.44" class="difflineplus">+[test_partsOnDemand.js]</span>
<a href="#l51.45"></a><span id="l51.45" class="difflineplus">+[test_preserveDataOnMove.js]</span>
<a href="#l51.46"></a><span id="l51.46" class="difflineplus">+[test_saveImapDraft.js]</span>
<a href="#l51.47"></a><span id="l51.47" class="difflineplus">+[test_saveTemplate.js]</span>
<a href="#l51.48"></a><span id="l51.48" class="difflineplus">+[test_starttlsFailure.js]</span>
<a href="#l51.49"></a><span id="l51.49" class="difflineplus">+[test_syncChanges.js]</span>
<a href="#l51.50"></a><span id="l51.50" class="difflineplus">+[test_trustSpamAssassin.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1">new file mode 100644</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineminus">--- /dev/null</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineplus">+++ b/mailnews/import/test/unit/xpcshell.ini</span>
<a href="#l52.4"></a><span id="l52.4" class="difflineat">@@ -0,0 +1,8 @@</span>
<a href="#l52.5"></a><span id="l52.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l52.6"></a><span id="l52.6" class="difflineplus">+head = head_import.js</span>
<a href="#l52.7"></a><span id="l52.7" class="difflineplus">+tail = tail_import.js</span>
<a href="#l52.8"></a><span id="l52.8" class="difflineplus">+</span>
<a href="#l52.9"></a><span id="l52.9" class="difflineplus">+[test_bug_263304.js]</span>
<a href="#l52.10"></a><span id="l52.10" class="difflineplus">+[test_bug_437556.js]</span>
<a href="#l52.11"></a><span id="l52.11" class="difflineplus">+[test_ldif_import.js]</span>
<a href="#l52.12"></a><span id="l52.12" class="difflineplus">+[test_winmail.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1">new file mode 100644</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineminus">--- /dev/null</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineplus">+++ b/mailnews/local/test/unit/xpcshell.ini</span>
<a href="#l53.4"></a><span id="l53.4" class="difflineat">@@ -0,0 +1,26 @@</span>
<a href="#l53.5"></a><span id="l53.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l53.6"></a><span id="l53.6" class="difflineplus">+head = head_maillocal.js</span>
<a href="#l53.7"></a><span id="l53.7" class="difflineplus">+tail = tail_local.js</span>
<a href="#l53.8"></a><span id="l53.8" class="difflineplus">+</span>
<a href="#l53.9"></a><span id="l53.9" class="difflineplus">+[test_bug457168.js]</span>
<a href="#l53.10"></a><span id="l53.10" class="difflineplus">+[test_fileName.js]</span>
<a href="#l53.11"></a><span id="l53.11" class="difflineplus">+[test_localSubFolders.js]</span>
<a href="#l53.12"></a><span id="l53.12" class="difflineplus">+[test_mailboxContentLength.js]</span>
<a href="#l53.13"></a><span id="l53.13" class="difflineplus">+[test_mailboxProtocol.js]</span>
<a href="#l53.14"></a><span id="l53.14" class="difflineplus">+[test_msgCopy.js]</span>
<a href="#l53.15"></a><span id="l53.15" class="difflineplus">+[test_over2GBMailboxes.js]</span>
<a href="#l53.16"></a><span id="l53.16" class="difflineplus">+[test_over4GBMailboxes.js]</span>
<a href="#l53.17"></a><span id="l53.17" class="difflineplus">+[test_pop3AuthMethods.js]</span>
<a href="#l53.18"></a><span id="l53.18" class="difflineplus">+[test_pop3GSSAPIFail.js]</span>
<a href="#l53.19"></a><span id="l53.19" class="difflineplus">+[test_pop3GetNewMail.js]</span>
<a href="#l53.20"></a><span id="l53.20" class="difflineplus">+[test_pop3Password.js]</span>
<a href="#l53.21"></a><span id="l53.21" class="difflineplus">+[test_pop3Password2.js]</span>
<a href="#l53.22"></a><span id="l53.22" class="difflineplus">+[test_pop3Password3.js]</span>
<a href="#l53.23"></a><span id="l53.23" class="difflineplus">+[test_pop3PasswordFailure.js]</span>
<a href="#l53.24"></a><span id="l53.24" class="difflineplus">+[test_pop3PasswordFailure2.js]</span>
<a href="#l53.25"></a><span id="l53.25" class="difflineplus">+[test_pop3Pump.js]</span>
<a href="#l53.26"></a><span id="l53.26" class="difflineplus">+[test_pop3ServerBrokenCRAMDisconnect.js]</span>
<a href="#l53.27"></a><span id="l53.27" class="difflineplus">+[test_pop3ServerBrokenCRAMFail.js]</span>
<a href="#l53.28"></a><span id="l53.28" class="difflineplus">+[test_preview.js]</span>
<a href="#l53.29"></a><span id="l53.29" class="difflineplus">+[test_verifyLogon.js]</span>
<a href="#l53.30"></a><span id="l53.30" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/mailnews/mailnews.js</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/mailnews/mailnews.js</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -119,16 +119,18 @@ pref(&quot;mail.imap.hide_unused_namespaces&quot;,</span>
<a href="#l54.4"></a><span id="l54.4"> pref(&quot;mail.imap.auto_unsubscribe_from_noselect_folders&quot;,    true);</span>
<a href="#l54.5"></a><span id="l54.5"> pref(&quot;mail.imap.mime_parts_on_demand&quot;,      true);</span>
<a href="#l54.6"></a><span id="l54.6"> pref(&quot;mail.imap.mime_parts_on_demand_threshold&quot;, 30000);</span>
<a href="#l54.7"></a><span id="l54.7"> pref(&quot;mail.imap.use_literal_plus&quot;,          true);</span>
<a href="#l54.8"></a><span id="l54.8"> pref(&quot;mail.imap.expunge_after_delete&quot;,      false);</span>
<a href="#l54.9"></a><span id="l54.9"> pref(&quot;mail.imap.check_deleted_before_expunge&quot;, false);</span>
<a href="#l54.10"></a><span id="l54.10"> pref(&quot;mail.imap.expunge_option&quot;,            0);</span>
<a href="#l54.11"></a><span id="l54.11"> pref(&quot;mail.imap.expunge_threshold_number&quot;,  20);</span>
<a href="#l54.12"></a><span id="l54.12" class="difflineplus">+pref(&quot;mail.imap.hdr_chunk_size&quot;, 200);</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineplus">+</span>
<a href="#l54.14"></a><span id="l54.14"> // if true, we assume that a user access a folder in the other users namespace</span>
<a href="#l54.15"></a><span id="l54.15"> // is acting as a delegate for that folder, and wishes to use the other users</span>
<a href="#l54.16"></a><span id="l54.16"> // identity when acting on messages in other users folders.</span>
<a href="#l54.17"></a><span id="l54.17"> pref(&quot;mail.imap.delegateOtherUsersFolders&quot;, false);</span>
<a href="#l54.18"></a><span id="l54.18"> pref(&quot;mail.thread_without_re&quot;,              false); // if false, only thread by subject if Re:</span>
<a href="#l54.19"></a><span id="l54.19"> pref(&quot;mail.strict_threading&quot;,               true);  // if true, don't thread by subject at all</span>
<a href="#l54.20"></a><span id="l54.20"> pref(&quot;mail.correct_threading&quot;,              true);  // if true, makes sure threading works correctly always (see bug 181446)</span>
<a href="#l54.21"></a><span id="l54.21"> pref(&quot;mail.pop3.deleteFromServerOnMove&quot;,    false);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1" class="difflineminus">--- a/mailnews/mime/src/mimei.cpp</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineplus">+++ b/mailnews/mime/src/mimei.cpp</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineat">@@ -746,22 +746,20 @@ mime_find_class (const char *content_typ</span>
<a href="#l55.4"></a><span id="l55.4">                                            PR_FALSE, PR_FALSE)</span>
<a href="#l55.5"></a><span id="l55.5">                            : nsnull);</span>
<a href="#l55.6"></a><span id="l55.6">         char *st = (ct ? MimeHeaders_get_parameter(ct, &quot;smime-type&quot;, NULL, NULL)</span>
<a href="#l55.7"></a><span id="l55.7">                          : nsnull);</span>
<a href="#l55.8"></a><span id="l55.8"> </span>
<a href="#l55.9"></a><span id="l55.9">         /* by default, assume that it is an encrypted message */</span>
<a href="#l55.10"></a><span id="l55.10">         clazz = (MimeObjectClass *)&amp;mimeEncryptedCMSClass;</span>
<a href="#l55.11"></a><span id="l55.11"> </span>
<a href="#l55.12"></a><span id="l55.12" class="difflineminus">-        if (opts-&gt;state-&gt;multParent)</span>
<a href="#l55.13"></a><span id="l55.13" class="difflineminus">-          clazz = (MimeObjectClass *)&amp;mimeExternalObjectClass;</span>
<a href="#l55.14"></a><span id="l55.14">         /* if the smime-type parameter says that it's a certs-only or</span>
<a href="#l55.15"></a><span id="l55.15">            compressed file, then show it as an attachment, however</span>
<a href="#l55.16"></a><span id="l55.16">            (MimeEncryptedCMS doesn't handle these correctly) */</span>
<a href="#l55.17"></a><span id="l55.17" class="difflineminus">-        else if (st &amp;&amp;</span>
<a href="#l55.18"></a><span id="l55.18" class="difflineplus">+        if (st &amp;&amp;</span>
<a href="#l55.19"></a><span id="l55.19">             (!PL_strcasecmp(st, &quot;certs-only&quot;) ||</span>
<a href="#l55.20"></a><span id="l55.20">              !PL_strcasecmp(st, &quot;compressed-data&quot;)))</span>
<a href="#l55.21"></a><span id="l55.21">           clazz = (MimeObjectClass *)&amp;mimeExternalObjectClass;</span>
<a href="#l55.22"></a><span id="l55.22">         else {</span>
<a href="#l55.23"></a><span id="l55.23">           /* look at the file extension... less reliable, but still covered</span>
<a href="#l55.24"></a><span id="l55.24">              by the S/MIME specification (RFC 3851, section 3.2.1)  */</span>
<a href="#l55.25"></a><span id="l55.25">           char *name = (hdrs ? MimeHeaders_get_name(hdrs, opts) : nsnull);</span>
<a href="#l55.26"></a><span id="l55.26">           if (name) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1" class="difflineminus">--- a/mailnews/mime/src/mimei.h</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineplus">+++ b/mailnews/mime/src/mimei.h</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineat">@@ -373,17 +373,17 @@ extern void mime_set_crypto_stamp(MimeOb</span>
<a href="#l56.4"></a><span id="l56.4"> #endif // ENABLE_SMIME</span>
<a href="#l56.5"></a><span id="l56.5"> </span>
<a href="#l56.6"></a><span id="l56.6"> class MimeParseStateObject {</span>
<a href="#l56.7"></a><span id="l56.7"> public:</span>
<a href="#l56.8"></a><span id="l56.8"> </span>
<a href="#l56.9"></a><span id="l56.9">   MimeParseStateObject()</span>
<a href="#l56.10"></a><span id="l56.10">       {root = 0; separator_queued_p = PR_FALSE; separator_suppressed_p = PR_FALSE;</span>
<a href="#l56.11"></a><span id="l56.11">         first_part_written_p = PR_FALSE; post_header_html_run_p = PR_FALSE; first_data_written_p = PR_FALSE;</span>
<a href="#l56.12"></a><span id="l56.12" class="difflineminus">-        decrypted_p = PR_FALSE; strippingPart = PR_FALSE; multParent = PR_FALSE;</span>
<a href="#l56.13"></a><span id="l56.13" class="difflineplus">+        decrypted_p = PR_FALSE; strippingPart = PR_FALSE;</span>
<a href="#l56.14"></a><span id="l56.14">       }</span>
<a href="#l56.15"></a><span id="l56.15">   MimeObject *root;        /* The outermost parser object. */</span>
<a href="#l56.16"></a><span id="l56.16"> </span>
<a href="#l56.17"></a><span id="l56.17">   PRBool separator_queued_p;  /* Whether a separator should be written out</span>
<a href="#l56.18"></a><span id="l56.18">                    before the next text is written (this lets</span>
<a href="#l56.19"></a><span id="l56.19">                    us write separators lazily, so that one</span>
<a href="#l56.20"></a><span id="l56.20">                    doesn't appear at the end, and so that more</span>
<a href="#l56.21"></a><span id="l56.21">                    than one don't appear in a row.) */</span>
<a href="#l56.22"></a><span id="l56.22" class="difflineat">@@ -401,17 +401,16 @@ public:</span>
<a href="#l56.23"></a><span id="l56.23"> </span>
<a href="#l56.24"></a><span id="l56.24">   PRBool first_data_written_p;  /* State used for Mozilla lazy-stream-</span>
<a href="#l56.25"></a><span id="l56.25">                    creation evilness. */</span>
<a href="#l56.26"></a><span id="l56.26"> </span>
<a href="#l56.27"></a><span id="l56.27">   PRBool decrypted_p; /* If options-&gt;dexlate_p is true, then this</span>
<a href="#l56.28"></a><span id="l56.28">                         will be set to indicate whether any</span>
<a href="#l56.29"></a><span id="l56.29">                         dexlateion did in fact occur.</span>
<a href="#l56.30"></a><span id="l56.30">                       */</span>
<a href="#l56.31"></a><span id="l56.31" class="difflineminus">-  PRBool multParent; // When creating a mime object, is our parent multipart?</span>
<a href="#l56.32"></a><span id="l56.32">   nsTArray&lt;nsCString&gt; partsToStrip; /* if we're stripping parts, what parts to strip */</span>
<a href="#l56.33"></a><span id="l56.33">   nsTArray&lt;nsCString&gt; detachToFiles; /* if we're detaching parts, where each part was detached to */</span>
<a href="#l56.34"></a><span id="l56.34">   PRBool strippingPart;</span>
<a href="#l56.35"></a><span id="l56.35">   nsCString detachedFilePath;       /* if we've detached this part, filepath of detached part */</span>
<a href="#l56.36"></a><span id="l56.36"> };</span>
<a href="#l56.37"></a><span id="l56.37"> </span>
<a href="#l56.38"></a><span id="l56.38"> </span>
<a href="#l56.39"></a><span id="l56.39"> /* Some output-generation utility functions...</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/mailnews/mime/src/mimemult.cpp</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/mailnews/mime/src/mimemult.cpp</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -462,20 +462,18 @@ MimeMultipart_create_child(MimeObject *o</span>
<a href="#l57.4"></a><span id="l57.4">   const char *dct = (((MimeMultipartClass *) obj-&gt;clazz)-&gt;default_part_type);</span>
<a href="#l57.5"></a><span id="l57.5">   MimeObject *body = NULL;</span>
<a href="#l57.6"></a><span id="l57.6"> </span>
<a href="#l57.7"></a><span id="l57.7">   mult-&gt;state = MimeMultipartPartFirstLine;</span>
<a href="#l57.8"></a><span id="l57.8">   /* Don't pass in NULL as the content-type (this means that the</span>
<a href="#l57.9"></a><span id="l57.9">    auto-uudecode-hack won't ever be done for subparts of a</span>
<a href="#l57.10"></a><span id="l57.10">    multipart, but only for untyped children of message/rfc822.</span>
<a href="#l57.11"></a><span id="l57.11">    */</span>
<a href="#l57.12"></a><span id="l57.12" class="difflineminus">-  obj-&gt;options-&gt;state-&gt;multParent = PR_TRUE;</span>
<a href="#l57.13"></a><span id="l57.13">   body = mime_create(((ct &amp;&amp; *ct) ? ct : (dct ? dct: TEXT_PLAIN)),</span>
<a href="#l57.14"></a><span id="l57.14">            mult-&gt;hdrs, obj-&gt;options);</span>
<a href="#l57.15"></a><span id="l57.15" class="difflineminus">-  obj-&gt;options-&gt;state-&gt;multParent = PR_FALSE;</span>
<a href="#l57.16"></a><span id="l57.16">   PR_FREEIF(ct);</span>
<a href="#l57.17"></a><span id="l57.17">   if (!body) return MIME_OUT_OF_MEMORY;</span>
<a href="#l57.18"></a><span id="l57.18">   status = ((MimeContainerClass *) obj-&gt;clazz)-&gt;add_child(obj, body);</span>
<a href="#l57.19"></a><span id="l57.19">   if (status &lt; 0)</span>
<a href="#l57.20"></a><span id="l57.20">   {</span>
<a href="#l57.21"></a><span id="l57.21">     mime_free(body);</span>
<a href="#l57.22"></a><span id="l57.22">     return status;</span>
<a href="#l57.23"></a><span id="l57.23">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1">new file mode 100644</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineminus">--- /dev/null</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineplus">+++ b/mailnews/mime/test/unit/xpcshell.ini</span>
<a href="#l58.4"></a><span id="l58.4" class="difflineat">@@ -0,0 +1,12 @@</span>
<a href="#l58.5"></a><span id="l58.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l58.6"></a><span id="l58.6" class="difflineplus">+head = head_mime.js</span>
<a href="#l58.7"></a><span id="l58.7" class="difflineplus">+tail = tail_mime.js</span>
<a href="#l58.8"></a><span id="l58.8" class="difflineplus">+</span>
<a href="#l58.9"></a><span id="l58.9" class="difflineplus">+[test_EncodeMimePartIIStr_UTF8.js]</span>
<a href="#l58.10"></a><span id="l58.10" class="difflineplus">+[test_attachment_size.js]</span>
<a href="#l58.11"></a><span id="l58.11" class="difflineplus">+[test_mimeContentType.js]</span>
<a href="#l58.12"></a><span id="l58.12" class="difflineplus">+[test_mimeStreaming.js]</span>
<a href="#l58.13"></a><span id="l58.13" class="difflineplus">+[test_nsIMsgHeaderParser1.js]</span>
<a href="#l58.14"></a><span id="l58.14" class="difflineplus">+[test_nsIMsgHeaderParser2.js]</span>
<a href="#l58.15"></a><span id="l58.15" class="difflineplus">+[test_nsIMsgHeaderParser3.js]</span>
<a href="#l58.16"></a><span id="l58.16" class="difflineplus">+[test_text_attachment.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1">new file mode 100644</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineminus">--- /dev/null</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineplus">+++ b/mailnews/news/test/unit/xpcshell.ini</span>
<a href="#l59.4"></a><span id="l59.4" class="difflineat">@@ -0,0 +1,18 @@</span>
<a href="#l59.5"></a><span id="l59.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l59.6"></a><span id="l59.6" class="difflineplus">+head = head_server_setup.js</span>
<a href="#l59.7"></a><span id="l59.7" class="difflineplus">+tail = tail_news.js</span>
<a href="#l59.8"></a><span id="l59.8" class="difflineplus">+</span>
<a href="#l59.9"></a><span id="l59.9" class="difflineplus">+[test_biff.js]</span>
<a href="#l59.10"></a><span id="l59.10" class="difflineplus">+[test_bug540288.js]</span>
<a href="#l59.11"></a><span id="l59.11" class="difflineplus">+[test_filter.js]</span>
<a href="#l59.12"></a><span id="l59.12" class="difflineplus">+[test_getNewsMessage.js]</span>
<a href="#l59.13"></a><span id="l59.13" class="difflineplus">+[test_internalUris.js]</span>
<a href="#l59.14"></a><span id="l59.14" class="difflineplus">+[test_nntpContentLength.js]</span>
<a href="#l59.15"></a><span id="l59.15" class="difflineplus">+[test_nntpPassword.js]</span>
<a href="#l59.16"></a><span id="l59.16" class="difflineplus">+[test_nntpPassword2.js]</span>
<a href="#l59.17"></a><span id="l59.17" class="difflineplus">+[test_nntpPassword3.js]</span>
<a href="#l59.18"></a><span id="l59.18" class="difflineplus">+[test_nntpPost.js]</span>
<a href="#l59.19"></a><span id="l59.19" class="difflineplus">+[test_nntpProtocols.js]</span>
<a href="#l59.20"></a><span id="l59.20" class="difflineplus">+[test_nntpUrl.js]</span>
<a href="#l59.21"></a><span id="l59.21" class="difflineplus">+[test_server.js]</span>
<a href="#l59.22"></a><span id="l59.22" class="difflineplus">+[test_uriParser.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1" class="difflineminus">--- a/suite/app/Makefile.in</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineplus">+++ b/suite/app/Makefile.in</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineat">@@ -295,16 +295,23 @@ ifeq ($(OS_ARCH),WINNT)</span>
<a href="#l60.4"></a><span id="l60.4"> 	$(PERL) -pe 's/(?&lt;!\r)\n/\r\n/g;' &lt; $(topsrcdir)/suite/installer/license.txt &gt; $(DIST)/bin/license.txt</span>
<a href="#l60.5"></a><span id="l60.5"> else</span>
<a href="#l60.6"></a><span id="l60.6"> 	$(INSTALL) $(topsrcdir)/suite/installer/license.txt $(DIST)/bin/</span>
<a href="#l60.7"></a><span id="l60.7"> endif</span>
<a href="#l60.8"></a><span id="l60.8"> </span>
<a href="#l60.9"></a><span id="l60.9"> libs:: blocklist.xml</span>
<a href="#l60.10"></a><span id="l60.10"> 	$(INSTALL) $(IFLAGS1) $^ $(DIST)/bin</span>
<a href="#l60.11"></a><span id="l60.11"> </span>
<a href="#l60.12"></a><span id="l60.12" class="difflineplus">+# XXX This is a hack to ensure that we get the right xpcshell.ini for our tests.</span>
<a href="#l60.13"></a><span id="l60.13" class="difflineplus">+# mozilla-central does this in testing/xpcshell-tests which means that it is</span>
<a href="#l60.14"></a><span id="l60.14" class="difflineplus">+# very hard for anyone to specify anything else.</span>
<a href="#l60.15"></a><span id="l60.15" class="difflineplus">+libs::</span>
<a href="#l60.16"></a><span id="l60.16" class="difflineplus">+	$(INSTALL) $(topsrcdir)/suite/test/xpcshell.ini $(MOZDEPTH)/_tests/xpcshell</span>
<a href="#l60.17"></a><span id="l60.17" class="difflineplus">+	cp $(topsrcdir)/suite/test/xpcshell.ini $(MOZDEPTH)/_tests/xpcshell/all-test-dirs.list</span>
<a href="#l60.18"></a><span id="l60.18" class="difflineplus">+</span>
<a href="#l60.19"></a><span id="l60.19"> ifdef MOZ_OMNIJAR</span>
<a href="#l60.20"></a><span id="l60.20"> # Make extensions end up as XPIs instead of flat chrome when doing omni.jar.</span>
<a href="#l60.21"></a><span id="l60.21"> # APP_EXTENSIONS exist only bundled with the application,</span>
<a href="#l60.22"></a><span id="l60.22"> # PROFILE_EXTENSIONS will be copied to the profile in installed builds.</span>
<a href="#l60.23"></a><span id="l60.23"> # NOTE: This is a hack to run this at the end of compilation, would be nicer</span>
<a href="#l60.24"></a><span id="l60.24"> # if this was done right away for built-in extensions in omnijar mode.</span>
<a href="#l60.25"></a><span id="l60.25"> # Listed extension GUIDs:</span>
<a href="#l60.26"></a><span id="l60.26"> # 972ce4c6-... Classic Theme, 59c81df5-... ChatZilla, f13b157f-... Venkman</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1">new file mode 100644</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineminus">--- /dev/null</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineplus">+++ b/suite/common/places/tests/unit/xpcshell.ini</span>
<a href="#l61.4"></a><span id="l61.4" class="difflineat">@@ -0,0 +1,23 @@</span>
<a href="#l61.5"></a><span id="l61.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l61.6"></a><span id="l61.6" class="difflineplus">+head = head_bookmarks.js</span>
<a href="#l61.7"></a><span id="l61.7" class="difflineplus">+tail = </span>
<a href="#l61.8"></a><span id="l61.8" class="difflineplus">+</span>
<a href="#l61.9"></a><span id="l61.9" class="difflineplus">+[test_384370.js]</span>
<a href="#l61.10"></a><span id="l61.10" class="difflineplus">+[test_398914.js]</span>
<a href="#l61.11"></a><span id="l61.11" class="difflineplus">+[test_421483.js]</span>
<a href="#l61.12"></a><span id="l61.12" class="difflineplus">+[test_457441-import-export-corrupt-bookmarks-html.js]</span>
<a href="#l61.13"></a><span id="l61.13" class="difflineplus">+[test_bookmarks_html.js]</span>
<a href="#l61.14"></a><span id="l61.14" class="difflineplus">+[test_bookmarksRestoreNotification.js]</span>
<a href="#l61.15"></a><span id="l61.15" class="difflineplus">+[test_browserGlue_corrupt.js]</span>
<a href="#l61.16"></a><span id="l61.16" class="difflineplus">+[test_browserGlue_corrupt_nobackup_default.js]</span>
<a href="#l61.17"></a><span id="l61.17" class="difflineplus">+[test_browserGlue_corrupt_nobackup.js]</span>
<a href="#l61.18"></a><span id="l61.18" class="difflineplus">+[test_browserGlue_distribution.js]</span>
<a href="#l61.19"></a><span id="l61.19" class="difflineplus">+[test_browserGlue_migrate.js]</span>
<a href="#l61.20"></a><span id="l61.20" class="difflineplus">+[test_browserGlue_prefs.js]</span>
<a href="#l61.21"></a><span id="l61.21" class="difflineplus">+[test_browserGlue_restore.js]</span>
<a href="#l61.22"></a><span id="l61.22" class="difflineplus">+[test_browserGlue_shutdown.js]</span>
<a href="#l61.23"></a><span id="l61.23" class="difflineplus">+[test_browserGlue_smartBookmarks.js]</span>
<a href="#l61.24"></a><span id="l61.24" class="difflineplus">+[test_clearHistory_shutdown.js]</span>
<a href="#l61.25"></a><span id="l61.25" class="difflineplus">+[test_leftpane_corruption_handling.js]</span>
<a href="#l61.26"></a><span id="l61.26" class="difflineplus">+[test_placesTxn.js]</span>
<a href="#l61.27"></a><span id="l61.27" class="difflineplus">+[test_txnGUIDs.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1">new file mode 100644</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineminus">--- /dev/null</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineplus">+++ b/suite/test/xpcshell.ini</span>
<a href="#l62.4"></a><span id="l62.4" class="difflineat">@@ -0,0 +1,132 @@</span>
<a href="#l62.5"></a><span id="l62.5" class="difflineplus">+# XXX Included here because bug 658671 means we can't nest includes.</span>
<a href="#l62.6"></a><span id="l62.6" class="difflineplus">+[include:suite/common/places/tests/unit/xpcshell.ini]</span>
<a href="#l62.7"></a><span id="l62.7" class="difflineplus">+[include:mailnews/addrbook/test/unit/xpcshell.ini]</span>
<a href="#l62.8"></a><span id="l62.8" class="difflineplus">+[include:mailnews/base/test/unit/xpcshell.ini]</span>
<a href="#l62.9"></a><span id="l62.9" class="difflineplus">+[include:mailnews/compose/test/unit/xpcshell.ini]</span>
<a href="#l62.10"></a><span id="l62.10" class="difflineplus">+[include:mailnews/db/gloda/test/unit/xpcshell.ini]</span>
<a href="#l62.11"></a><span id="l62.11" class="difflineplus">+[include:mailnews/db/msgdb/test/unit/xpcshell.ini]</span>
<a href="#l62.12"></a><span id="l62.12" class="difflineplus">+[include:mailnews/extensions/mdn/test/unit/xpcshell.ini]</span>
<a href="#l62.13"></a><span id="l62.13" class="difflineplus">+[include:mailnews/extensions/bayesian-spam-filter/test/unit/xpcshell.ini]</span>
<a href="#l62.14"></a><span id="l62.14" class="difflineplus">+[include:mailnews/imap/test/unit/xpcshell.ini]</span>
<a href="#l62.15"></a><span id="l62.15" class="difflineplus">+[include:mailnews/import/test/unit/xpcshell.ini]</span>
<a href="#l62.16"></a><span id="l62.16" class="difflineplus">+[include:mailnews/local/test/unit/xpcshell.ini]</span>
<a href="#l62.17"></a><span id="l62.17" class="difflineplus">+[include:mailnews/mime/test/unit/xpcshell.ini]</span>
<a href="#l62.18"></a><span id="l62.18" class="difflineplus">+[include:mailnews/news/test/unit/xpcshell.ini]</span>
<a href="#l62.19"></a><span id="l62.19" class="difflineplus">+[include:ldap/xpcom/tests/unit/xpcshell.ini]</span>
<a href="#l62.20"></a><span id="l62.20" class="difflineplus">+</span>
<a href="#l62.21"></a><span id="l62.21" class="difflineplus">+# XXX Included here because bug 658671 means we can't nest includes.</span>
<a href="#l62.22"></a><span id="l62.22" class="difflineplus">+[include:mozilla/chrome/test/unit/xpcshell.ini]</span>
<a href="#l62.23"></a><span id="l62.23" class="difflineplus">+[include:mozilla/intl/locale/tests/unit/xpcshell.ini]</span>
<a href="#l62.24"></a><span id="l62.24" class="difflineplus">+[include:mozilla/netwerk/cookie/test/unit/xpcshell.ini]</span>
<a href="#l62.25"></a><span id="l62.25" class="difflineplus">+[include:mozilla/modules/libjar/zipwriter/test/unit/xpcshell.ini]</span>
<a href="#l62.26"></a><span id="l62.26" class="difflineplus">+[include:mozilla/uriloader/exthandler/tests/unit/xpcshell.ini]</span>
<a href="#l62.27"></a><span id="l62.27" class="difflineplus">+[include:mozilla/parser/xml/test/unit/xpcshell.ini]</span>
<a href="#l62.28"></a><span id="l62.28" class="difflineplus">+[include:mozilla/modules/libpr0n/test/unit/xpcshell.ini]</span>
<a href="#l62.29"></a><span id="l62.29" class="difflineplus">+[include:mozilla/modules/plugin/test/unit/xpcshell.ini]</span>
<a href="#l62.30"></a><span id="l62.30" class="difflineplus">+[include:mozilla/dom/plugins/test/unit/xpcshell.ini]</span>
<a href="#l62.31"></a><span id="l62.31" class="difflineplus">+[include:mozilla/dom/src/json/test/unit/xpcshell.ini]</span>
<a href="#l62.32"></a><span id="l62.32" class="difflineplus">+[include:mozilla/dom/tests/unit/xpcshell.ini]</span>
<a href="#l62.33"></a><span id="l62.33" class="difflineplus">+[include:mozilla/content/xtf/test/unit/xpcshell.ini]</span>
<a href="#l62.34"></a><span id="l62.34" class="difflineplus">+[include:mozilla/docshell/test/unit/xpcshell.ini]</span>
<a href="#l62.35"></a><span id="l62.35" class="difflineplus">+[include:mozilla/embedding/tests/unit/xpcshell.ini]</span>
<a href="#l62.36"></a><span id="l62.36" class="difflineplus">+[include:mozilla/toolkit/components/commandlines/test/unit/xpcshell.ini]</span>
<a href="#l62.37"></a><span id="l62.37" class="difflineplus">+[include:mozilla/toolkit/components/contentprefs/tests/unit/xpcshell.ini]</span>
<a href="#l62.38"></a><span id="l62.38" class="difflineplus">+[include:mozilla/toolkit/components/passwordmgr/test/unit/xpcshell.ini]</span>
<a href="#l62.39"></a><span id="l62.39" class="difflineplus">+[include:mozilla/toolkit/components/places/tests/migration/xpcshell.ini]</span>
<a href="#l62.40"></a><span id="l62.40" class="difflineplus">+[include:mozilla/toolkit/components/places/tests/autocomplete/xpcshell.ini]</span>
<a href="#l62.41"></a><span id="l62.41" class="difflineplus">+[include:mozilla/toolkit/components/places/tests/expiration/xpcshell.ini]</span>
<a href="#l62.42"></a><span id="l62.42" class="difflineplus">+[include:mozilla/toolkit/components/places/tests/sync/xpcshell.ini]</span>
<a href="#l62.43"></a><span id="l62.43" class="difflineplus">+[include:mozilla/toolkit/components/places/tests/bookmarks/xpcshell.ini]</span>
<a href="#l62.44"></a><span id="l62.44" class="difflineplus">+[include:mozilla/toolkit/components/places/tests/queries/xpcshell.ini]</span>
<a href="#l62.45"></a><span id="l62.45" class="difflineplus">+[include:mozilla/toolkit/components/places/tests/unit/xpcshell.ini]</span>
<a href="#l62.46"></a><span id="l62.46" class="difflineplus">+[include:mozilla/toolkit/components/places/tests/network/xpcshell.ini]</span>
<a href="#l62.47"></a><span id="l62.47" class="difflineplus">+[include:mozilla/toolkit/components/urlformatter/tests/unit/xpcshell.ini]</span>
<a href="#l62.48"></a><span id="l62.48" class="difflineplus">+[include:mozilla/toolkit/components/ctypes/tests/unit/xpcshell.ini]</span>
<a href="#l62.49"></a><span id="l62.49" class="difflineplus">+[include:mozilla/toolkit/components/autocomplete/tests/unit/xpcshell.ini]</span>
<a href="#l62.50"></a><span id="l62.50" class="difflineplus">+[include:mozilla/toolkit/components/satchel/test/unit/xpcshell.ini]</span>
<a href="#l62.51"></a><span id="l62.51" class="difflineplus">+[include:mozilla/toolkit/components/downloads/test/unit/xpcshell.ini]</span>
<a href="#l62.52"></a><span id="l62.52" class="difflineplus">+[include:mozilla/toolkit/components/downloads/test/schema_migration/xpcshell.ini]</span>
<a href="#l62.53"></a><span id="l62.53" class="difflineplus">+[include:mozilla/toolkit/components/telemetry/tests/unit/xpcshell.ini]</span>
<a href="#l62.54"></a><span id="l62.54" class="difflineplus">+[include:mozilla/toolkit/content/tests/unit/xpcshell.ini]</span>
<a href="#l62.55"></a><span id="l62.55" class="difflineplus">+[include:mozilla/toolkit/mozapps/downloads/tests/unit/xpcshell.ini]</span>
<a href="#l62.56"></a><span id="l62.56" class="difflineplus">+[include:mozilla/toolkit/mozapps/extensions/test/xpcshell/xpcshell.ini]</span>
<a href="#l62.57"></a><span id="l62.57" class="difflineplus">+[include:mozilla/toolkit/mozapps/extensions/test/xpcshell-unpack/xpcshell.ini]</span>
<a href="#l62.58"></a><span id="l62.58" class="difflineplus">+[include:mozilla/toolkit/mozapps/update/test_timermanager/unit/xpcshell.ini]</span>
<a href="#l62.59"></a><span id="l62.59" class="difflineplus">+[include:mozilla/toolkit/mozapps/update/test/unit/xpcshell.ini]</span>
<a href="#l62.60"></a><span id="l62.60" class="difflineplus">+[include:mozilla/security/manager/ssl/tests/unit/xpcshell.ini]</span>
<a href="#l62.61"></a><span id="l62.61" class="difflineplus">+[include:mozilla/testing/xpcshell/example/unit/xpcshell.ini]</span>
<a href="#l62.62"></a><span id="l62.62" class="difflineplus">+[include:mozilla/xpcom/tests/unit/xpcshell.ini]</span>
<a href="#l62.63"></a><span id="l62.63" class="difflineplus">+[include:mozilla/modules/libpref/test/unit/xpcshell.ini]</span>
<a href="#l62.64"></a><span id="l62.64" class="difflineplus">+[include:mozilla/intl/strres/tests/unit/xpcshell.ini]</span>
<a href="#l62.65"></a><span id="l62.65" class="difflineplus">+[include:mozilla/intl/unicharutil/tests/unit/xpcshell.ini]</span>
<a href="#l62.66"></a><span id="l62.66" class="difflineplus">+[include:mozilla/intl/uconv/tests/unit/xpcshell.ini]</span>
<a href="#l62.67"></a><span id="l62.67" class="difflineplus">+[include:mozilla/netwerk/test/unit/xpcshell.ini]</span>
<a href="#l62.68"></a><span id="l62.68" class="difflineplus">+[include:mozilla/netwerk/test/httpserver/test/xpcshell.ini]</span>
<a href="#l62.69"></a><span id="l62.69" class="difflineplus">+[include:mozilla/js/jetpack/tests/unit/xpcshell.ini]</span>
<a href="#l62.70"></a><span id="l62.70" class="difflineplus">+[include:mozilla/js/src/xpconnect/tests/unit/xpcshell.ini]</span>
<a href="#l62.71"></a><span id="l62.71" class="difflineplus">+[include:mozilla/modules/libjar/test/unit/xpcshell.ini]</span>
<a href="#l62.72"></a><span id="l62.72" class="difflineplus">+[include:mozilla/extensions/cookie/test/unit/xpcshell.ini]</span>
<a href="#l62.73"></a><span id="l62.73" class="difflineplus">+[include:mozilla/storage/test/unit/xpcshell.ini]</span>
<a href="#l62.74"></a><span id="l62.74" class="difflineplus">+[include:mozilla/rdf/tests/unit/xpcshell.ini]</span>
<a href="#l62.75"></a><span id="l62.75" class="difflineplus">+[include:mozilla/gfx/tests/unit/xpcshell.ini]</span>
<a href="#l62.76"></a><span id="l62.76" class="difflineplus">+[include:mozilla/widget/tests/unit/xpcshell.ini]</span>
<a href="#l62.77"></a><span id="l62.77" class="difflineplus">+[include:mozilla/content/base/test/unit/xpcshell.ini]</span>
<a href="#l62.78"></a><span id="l62.78" class="difflineplus">+[include:mozilla/content/test/unit/xpcshell.ini]</span>
<a href="#l62.79"></a><span id="l62.79" class="difflineplus">+[include:mozilla/toolkit/components/url-classifier/tests/unit/xpcshell.ini]</span>
<a href="#l62.80"></a><span id="l62.80" class="difflineplus">+[include:mozilla/services/crypto/tests/unit/xpcshell.ini]</span>
<a href="#l62.81"></a><span id="l62.81" class="difflineplus">+[include:mozilla/services/crypto/components/tests/unit/xpcshell.ini]</span>
<a href="#l62.82"></a><span id="l62.82" class="difflineplus">+[include:mozilla/services/sync/tests/unit/xpcshell.ini]</span>
<a href="#l62.83"></a><span id="l62.83" class="difflineplus">+[include:mozilla/browser/components/dirprovider/tests/unit/xpcshell.ini]</span>
<a href="#l62.84"></a><span id="l62.84" class="difflineplus">+[include:mozilla/browser/components/feeds/test/unit/xpcshell.ini]</span>
<a href="#l62.85"></a><span id="l62.85" class="difflineplus">+[include:mozilla/browser/components/places/tests/unit/xpcshell.ini]</span>
<a href="#l62.86"></a><span id="l62.86" class="difflineplus">+[include:mozilla/browser/components/privatebrowsing/test/unit/xpcshell.ini]</span>
<a href="#l62.87"></a><span id="l62.87" class="difflineplus">+[include:mozilla/browser/components/shell/test/unit/xpcshell.ini]</span>
<a href="#l62.88"></a><span id="l62.88" class="difflineplus">+[include:mozilla/extensions/spellcheck/hunspell/tests/unit/xpcshell.ini]</span>
<a href="#l62.89"></a><span id="l62.89" class="difflineplus">+[include:mozilla/toolkit/components/search/tests/xpcshell/xpcshell.ini]</span>
<a href="#l62.90"></a><span id="l62.90" class="difflineplus">+[include:mozilla/toolkit/mozapps/shared/test/unit/xpcshell.ini]</span>
<a href="#l62.91"></a><span id="l62.91" class="difflineplus">+[include:mozilla/services/crypto/component/tests/unit/xpcshell.ini]</span>
<a href="#l62.92"></a><span id="l62.92" class="difflineplus">+[include:mozilla/layout/tools/layout-debug/tests/unit/xpcshell.ini]</span>
<a href="#l62.93"></a><span id="l62.93" class="difflineplus">+run-if.config = debug</span>
<a href="#l62.94"></a><span id="l62.94" class="difflineplus">+</span>
<a href="#l62.95"></a><span id="l62.95" class="difflineplus">+[include:mozilla/intl/locale/tests_multilocale/unit/xpcshell.ini]</span>
<a href="#l62.96"></a><span id="l62.96" class="difflineplus">+run-if.toolkit = windows</span>
<a href="#l62.97"></a><span id="l62.97" class="difflineplus">+</span>
<a href="#l62.98"></a><span id="l62.98" class="difflineplus">+[include:mozilla/intl/locale/tests_multilocale/unit/xpcshell.ini]</span>
<a href="#l62.99"></a><span id="l62.99" class="difflineplus">+run-if.toolkit = cocoa</span>
<a href="#l62.100"></a><span id="l62.100" class="difflineplus">+</span>
<a href="#l62.101"></a><span id="l62.101" class="difflineplus">+[include:mozilla/toolkit/crashreporter/test/unit/xpcshell.ini]</span>
<a href="#l62.102"></a><span id="l62.102" class="difflineplus">+skip-if.os = linux</span>
<a href="#l62.103"></a><span id="l62.103" class="difflineplus">+run-if.config = mozcrashreporter</span>
<a href="#l62.104"></a><span id="l62.104" class="difflineplus">+</span>
<a href="#l62.105"></a><span id="l62.105" class="difflineplus">+[include:mozilla/intl/locale/src/unix/tests/unit/xpcshell.ini]</span>
<a href="#l62.106"></a><span id="l62.106" class="difflineplus">+skip-if.toolkit = windows cocoa os2</span>
<a href="#l62.107"></a><span id="l62.107" class="difflineplus">+</span>
<a href="#l62.108"></a><span id="l62.108" class="difflineplus">+[include:mozilla/toolkit/components/commandlines/test/unit_win/xpcshell.ini]</span>
<a href="#l62.109"></a><span id="l62.109" class="difflineplus">+run-if.os = windows</span>
<a href="#l62.110"></a><span id="l62.110" class="difflineplus">+</span>
<a href="#l62.111"></a><span id="l62.111" class="difflineplus">+[include:mozilla/toolkit/components/commandlines/test/unit_unix/xpcshell.ini]</span>
<a href="#l62.112"></a><span id="l62.112" class="difflineplus">+skip-if.os = windows mac os2</span>
<a href="#l62.113"></a><span id="l62.113" class="difflineplus">+</span>
<a href="#l62.114"></a><span id="l62.114" class="difflineplus">+[include:mozilla/chrome/test/unit_ipc/xpcshell.ini]</span>
<a href="#l62.115"></a><span id="l62.115" class="difflineplus">+run-if.config = ipc</span>
<a href="#l62.116"></a><span id="l62.116" class="difflineplus">+</span>
<a href="#l62.117"></a><span id="l62.117" class="difflineplus">+[include:mozilla/extensions/cookie/test/unit_ipc/xpcshell.ini]</span>
<a href="#l62.118"></a><span id="l62.118" class="difflineplus">+run-if.config = ipc</span>
<a href="#l62.119"></a><span id="l62.119" class="difflineplus">+</span>
<a href="#l62.120"></a><span id="l62.120" class="difflineplus">+[include:mozilla/ipc/testshell/tests/xpcshell.ini]</span>
<a href="#l62.121"></a><span id="l62.121" class="difflineplus">+run-if.config = ipc</span>
<a href="#l62.122"></a><span id="l62.122" class="difflineplus">+</span>
<a href="#l62.123"></a><span id="l62.123" class="difflineplus">+[include:mozilla/modules/libpref/test/unit_ipc/xpcshell.ini]</span>
<a href="#l62.124"></a><span id="l62.124" class="difflineplus">+run-if.config = ipc</span>
<a href="#l62.125"></a><span id="l62.125" class="difflineplus">+</span>
<a href="#l62.126"></a><span id="l62.126" class="difflineplus">+[include:mozilla/netwerk/test/unit_ipc/xpcshell.ini]</span>
<a href="#l62.127"></a><span id="l62.127" class="difflineplus">+run-if.config = ipc</span>
<a href="#l62.128"></a><span id="l62.128" class="difflineplus">+</span>
<a href="#l62.129"></a><span id="l62.129" class="difflineplus">+[include:mozilla/netwerk/cookie/test/unit_ipc/xpcshell.ini]</span>
<a href="#l62.130"></a><span id="l62.130" class="difflineplus">+run-if.config = ipc</span>
<a href="#l62.131"></a><span id="l62.131" class="difflineplus">+</span>
<a href="#l62.132"></a><span id="l62.132" class="difflineplus">+[include:mozilla/toolkit/components/contentprefs/tests/unit_ipc/xpcshell.ini]</span>
<a href="#l62.133"></a><span id="l62.133" class="difflineplus">+run-if.config = ipc</span>
<a href="#l62.134"></a><span id="l62.134" class="difflineplus">+</span>
<a href="#l62.135"></a><span id="l62.135" class="difflineplus">+[include:mozilla/uriloader/exthandler/tests/unit_ipc/xpcshell.ini]</span>
<a href="#l62.136"></a><span id="l62.136" class="difflineplus">+run-if.config = ipc</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

