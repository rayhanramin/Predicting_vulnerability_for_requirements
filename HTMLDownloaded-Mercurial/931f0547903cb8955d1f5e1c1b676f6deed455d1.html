<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 11583:931f0547903cb8955d1f5e1c1b676f6deed455d1</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 931f0547903cb8955d1f5e1c1b676f6deed455d1" />
<meta property="og:url" content="/comm-central/rev/931f0547903cb8955d1f5e1c1b676f6deed455d1" />
<meta property="og:description" content="[Bug 250187] Reply all automatically converts multiple TO recipients to CC (should preserve original destination fields). r=irving, sr=standard8, ui-r=bwinton" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 931f0547903cb8955d1f5e1c1b676f6deed455d1 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/931f0547903cb8955d1f5e1c1b676f6deed455d1">shortlog</a> |
<a href="/comm-central/log/931f0547903cb8955d1f5e1c1b676f6deed455d1">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/931f0547903cb8955d1f5e1c1b676f6deed455d1">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/931f0547903cb8955d1f5e1c1b676f6deed455d1">files</a> |
changeset |
<a href="/comm-central/raw-rev/931f0547903cb8955d1f5e1c1b676f6deed455d1">raw</a>  | <a href="/comm-central/archive/931f0547903cb8955d1f5e1c1b676f6deed455d1.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
[<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=250187">Bug 250187</a>] Reply all automatically converts multiple TO recipients to CC (should preserve original destination fields). r=irving, sr=standard8, ui-r=bwinton
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#97;&#103;&#110;&#117;&#115;&#32;&#77;&#101;&#108;&#105;&#110;&#32;&#60;&#109;&#107;&#109;&#101;&#108;&#105;&#110;&#43;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#105;&#107;&#105;&#46;&#102;&#105;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 19 Nov 2012 20:58:44 +0200</td></tr>

<tr>
 <td>changeset 11583</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/931f0547903cb8955d1f5e1c1b676f6deed455d1">931f0547903cb8955d1f5e1c1b676f6deed455d1</a></td>
</tr>



<tr>
<td>parent 11582</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/73ac92981a1be2ea5c6f4a0d77f70b956d4e9b55">73ac92981a1be2ea5c6f4a0d77f70b956d4e9b55</a>
</td>
</tr>

<tr>
<td>child 11584</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7b25c50ce21323b25ad142c37b6b833607bf102a">7b25c50ce21323b25ad142c37b6b833607bf102a</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=931f0547903cb8955d1f5e1c1b676f6deed455d1">8632</a></td></tr>
<tr><td>push user</td><td>mkmelin@iki.fi</td></tr>
<tr><td>push date</td><td class="date age">Mon, 19 Nov 2012 18:59:16 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@931f0547903c [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=931f0547903cb8955d1f5e1c1b676f6deed455d1">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=931f0547903cb8955d1f5e1c1b676f6deed455d1&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=931f0547903cb8955d1f5e1c1b676f6deed455d1&newProject=comm-central&newRevision=931f0547903cb8955d1f5e1c1b676f6deed455d1&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=931f0547903cb8955d1f5e1c1b676f6deed455d1&newProject=comm-central&newRevision=931f0547903cb8955d1f5e1c1b676f6deed455d1&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=931f0547903cb8955d1f5e1c1b676f6deed455d1&newProject=comm-central&newRevision=931f0547903cb8955d1f5e1c1b676f6deed455d1&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28irving%29&revcount=50">irving</a>, <a href="/comm-central/log?rev=reviewer%28standard8%29&revcount=50">standard8</a>, <a href="/comm-central/log?rev=reviewer%28bwinton%29&revcount=50">bwinton</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=250187">250187</a></td></tr>




</table></div>

<div class="page_body description">[<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=250187">Bug 250187</a>] Reply all automatically converts multiple TO recipients to CC (should preserve original destination fields). r=irving, sr=standard8, ui-r=bwinton</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/931f0547903cb8955d1f5e1c1b676f6deed455d1/mail/test/mozmill/composition/test-attachment-reminder.js">mail/test/mozmill/composition/test-attachment-reminder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/931f0547903cb8955d1f5e1c1b676f6deed455d1/mail/test/mozmill/composition/test-attachment-reminder.js">file</a> |
<a href="/comm-central/annotate/931f0547903cb8955d1f5e1c1b676f6deed455d1/mail/test/mozmill/composition/test-attachment-reminder.js">annotate</a> |
<a href="/comm-central/diff/931f0547903cb8955d1f5e1c1b676f6deed455d1/mail/test/mozmill/composition/test-attachment-reminder.js">diff</a> |
<a href="/comm-central/comparison/931f0547903cb8955d1f5e1c1b676f6deed455d1/mail/test/mozmill/composition/test-attachment-reminder.js">comparison</a> |
<a href="/comm-central/log/931f0547903cb8955d1f5e1c1b676f6deed455d1/mail/test/mozmill/composition/test-attachment-reminder.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/931f0547903cb8955d1f5e1c1b676f6deed455d1/mail/test/mozmill/composition/test-reply-addresses.js">mail/test/mozmill/composition/test-reply-addresses.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/931f0547903cb8955d1f5e1c1b676f6deed455d1/mail/test/mozmill/composition/test-reply-addresses.js">file</a> |
<a href="/comm-central/annotate/931f0547903cb8955d1f5e1c1b676f6deed455d1/mail/test/mozmill/composition/test-reply-addresses.js">annotate</a> |
<a href="/comm-central/diff/931f0547903cb8955d1f5e1c1b676f6deed455d1/mail/test/mozmill/composition/test-reply-addresses.js">diff</a> |
<a href="/comm-central/comparison/931f0547903cb8955d1f5e1c1b676f6deed455d1/mail/test/mozmill/composition/test-reply-addresses.js">comparison</a> |
<a href="/comm-central/log/931f0547903cb8955d1f5e1c1b676f6deed455d1/mail/test/mozmill/composition/test-reply-addresses.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/931f0547903cb8955d1f5e1c1b676f6deed455d1/mail/test/mozmill/composition/test-signature-updating.js">mail/test/mozmill/composition/test-signature-updating.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/931f0547903cb8955d1f5e1c1b676f6deed455d1/mail/test/mozmill/composition/test-signature-updating.js">file</a> |
<a href="/comm-central/annotate/931f0547903cb8955d1f5e1c1b676f6deed455d1/mail/test/mozmill/composition/test-signature-updating.js">annotate</a> |
<a href="/comm-central/diff/931f0547903cb8955d1f5e1c1b676f6deed455d1/mail/test/mozmill/composition/test-signature-updating.js">diff</a> |
<a href="/comm-central/comparison/931f0547903cb8955d1f5e1c1b676f6deed455d1/mail/test/mozmill/composition/test-signature-updating.js">comparison</a> |
<a href="/comm-central/log/931f0547903cb8955d1f5e1c1b676f6deed455d1/mail/test/mozmill/composition/test-signature-updating.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/931f0547903cb8955d1f5e1c1b676f6deed455d1/mail/test/mozmill/shared-modules/test-compose-helpers.js">mail/test/mozmill/shared-modules/test-compose-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/931f0547903cb8955d1f5e1c1b676f6deed455d1/mail/test/mozmill/shared-modules/test-compose-helpers.js">file</a> |
<a href="/comm-central/annotate/931f0547903cb8955d1f5e1c1b676f6deed455d1/mail/test/mozmill/shared-modules/test-compose-helpers.js">annotate</a> |
<a href="/comm-central/diff/931f0547903cb8955d1f5e1c1b676f6deed455d1/mail/test/mozmill/shared-modules/test-compose-helpers.js">diff</a> |
<a href="/comm-central/comparison/931f0547903cb8955d1f5e1c1b676f6deed455d1/mail/test/mozmill/shared-modules/test-compose-helpers.js">comparison</a> |
<a href="/comm-central/log/931f0547903cb8955d1f5e1c1b676f6deed455d1/mail/test/mozmill/shared-modules/test-compose-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/931f0547903cb8955d1f5e1c1b676f6deed455d1/mailnews/compose/public/nsIMsgCompFields.idl">mailnews/compose/public/nsIMsgCompFields.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/931f0547903cb8955d1f5e1c1b676f6deed455d1/mailnews/compose/public/nsIMsgCompFields.idl">file</a> |
<a href="/comm-central/annotate/931f0547903cb8955d1f5e1c1b676f6deed455d1/mailnews/compose/public/nsIMsgCompFields.idl">annotate</a> |
<a href="/comm-central/diff/931f0547903cb8955d1f5e1c1b676f6deed455d1/mailnews/compose/public/nsIMsgCompFields.idl">diff</a> |
<a href="/comm-central/comparison/931f0547903cb8955d1f5e1c1b676f6deed455d1/mailnews/compose/public/nsIMsgCompFields.idl">comparison</a> |
<a href="/comm-central/log/931f0547903cb8955d1f5e1c1b676f6deed455d1/mailnews/compose/public/nsIMsgCompFields.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/931f0547903cb8955d1f5e1c1b676f6deed455d1/mailnews/compose/src/nsMsgCompFields.cpp">mailnews/compose/src/nsMsgCompFields.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/931f0547903cb8955d1f5e1c1b676f6deed455d1/mailnews/compose/src/nsMsgCompFields.cpp">file</a> |
<a href="/comm-central/annotate/931f0547903cb8955d1f5e1c1b676f6deed455d1/mailnews/compose/src/nsMsgCompFields.cpp">annotate</a> |
<a href="/comm-central/diff/931f0547903cb8955d1f5e1c1b676f6deed455d1/mailnews/compose/src/nsMsgCompFields.cpp">diff</a> |
<a href="/comm-central/comparison/931f0547903cb8955d1f5e1c1b676f6deed455d1/mailnews/compose/src/nsMsgCompFields.cpp">comparison</a> |
<a href="/comm-central/log/931f0547903cb8955d1f5e1c1b676f6deed455d1/mailnews/compose/src/nsMsgCompFields.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/931f0547903cb8955d1f5e1c1b676f6deed455d1/mailnews/compose/src/nsMsgCompFields.h">mailnews/compose/src/nsMsgCompFields.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/931f0547903cb8955d1f5e1c1b676f6deed455d1/mailnews/compose/src/nsMsgCompFields.h">file</a> |
<a href="/comm-central/annotate/931f0547903cb8955d1f5e1c1b676f6deed455d1/mailnews/compose/src/nsMsgCompFields.h">annotate</a> |
<a href="/comm-central/diff/931f0547903cb8955d1f5e1c1b676f6deed455d1/mailnews/compose/src/nsMsgCompFields.h">diff</a> |
<a href="/comm-central/comparison/931f0547903cb8955d1f5e1c1b676f6deed455d1/mailnews/compose/src/nsMsgCompFields.h">comparison</a> |
<a href="/comm-central/log/931f0547903cb8955d1f5e1c1b676f6deed455d1/mailnews/compose/src/nsMsgCompFields.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/931f0547903cb8955d1f5e1c1b676f6deed455d1/mailnews/compose/src/nsMsgCompose.cpp">mailnews/compose/src/nsMsgCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/931f0547903cb8955d1f5e1c1b676f6deed455d1/mailnews/compose/src/nsMsgCompose.cpp">file</a> |
<a href="/comm-central/annotate/931f0547903cb8955d1f5e1c1b676f6deed455d1/mailnews/compose/src/nsMsgCompose.cpp">annotate</a> |
<a href="/comm-central/diff/931f0547903cb8955d1f5e1c1b676f6deed455d1/mailnews/compose/src/nsMsgCompose.cpp">diff</a> |
<a href="/comm-central/comparison/931f0547903cb8955d1f5e1c1b676f6deed455d1/mailnews/compose/src/nsMsgCompose.cpp">comparison</a> |
<a href="/comm-central/log/931f0547903cb8955d1f5e1c1b676f6deed455d1/mailnews/compose/src/nsMsgCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/931f0547903cb8955d1f5e1c1b676f6deed455d1/mailnews/compose/src/nsMsgCompose.h">mailnews/compose/src/nsMsgCompose.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/931f0547903cb8955d1f5e1c1b676f6deed455d1/mailnews/compose/src/nsMsgCompose.h">file</a> |
<a href="/comm-central/annotate/931f0547903cb8955d1f5e1c1b676f6deed455d1/mailnews/compose/src/nsMsgCompose.h">annotate</a> |
<a href="/comm-central/diff/931f0547903cb8955d1f5e1c1b676f6deed455d1/mailnews/compose/src/nsMsgCompose.h">diff</a> |
<a href="/comm-central/comparison/931f0547903cb8955d1f5e1c1b676f6deed455d1/mailnews/compose/src/nsMsgCompose.h">comparison</a> |
<a href="/comm-central/log/931f0547903cb8955d1f5e1c1b676f6deed455d1/mailnews/compose/src/nsMsgCompose.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-attachment-reminder.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-attachment-reminder.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -20,18 +20,17 @@ const kNotificationID = &quot;1&quot;;</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> function setupModule(module) {</span>
<a href="#l1.6"></a><span id="l1.6">   collector.getModule(&quot;folder-display-helpers&quot;).installInto(module);</span>
<a href="#l1.7"></a><span id="l1.7">   collector.getModule(&quot;compose-helpers&quot;).installInto(module);</span>
<a href="#l1.8"></a><span id="l1.8">   collector.getModule(&quot;window-helpers&quot;).installInto(module);</span>
<a href="#l1.9"></a><span id="l1.9"> };</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> function setupComposeWin(aCwc, toAddr, subj, body) {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  aCwc.type(aCwc.a(&quot;addressingWidget&quot;,</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-           {class: &quot;addressingWidgetCell&quot;, crazyDeck: 1}), toAddr);</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+  aCwc.type(null, toAddr);</span>
<a href="#l1.15"></a><span id="l1.15">   aCwc.type(aCwc.eid(&quot;msgSubject&quot;), subj)</span>
<a href="#l1.16"></a><span id="l1.16">   aCwc.type(aCwc.eid(&quot;content-frame&quot;), body);</span>
<a href="#l1.17"></a><span id="l1.17"> }</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19"> /**</span>
<a href="#l1.20"></a><span id="l1.20">  * Test that the attachment works, in general.</span>
<a href="#l1.21"></a><span id="l1.21">  */</span>
<a href="#l1.22"></a><span id="l1.22"> function test_attachment_reminder_appears_properly() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/mail/test/mozmill/composition/test-reply-addresses.js</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,561 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+ * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+/**</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+ * Tests that we get correct adressees for different type of replies:</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+ * reply to sender, reply to all, reply to list, mail-followup-tp,</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+ * mail-reply-to, and reply to self.</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+ */</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+// make SOLO_TEST=composition/test-reply-addresses.js mozmill-one</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+const MODULE_NAME = &quot;test-reply-addresses&quot;;</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+const RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+const MODULE_REQUIRES = [&quot;folder-display-helpers&quot;,</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+                         &quot;window-helpers&quot;, &quot;compose-helpers&quot;];</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+var folder;</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+var i = 0;</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+const myEmail1 = &quot;me@example.com&quot;;</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+const myEmail2 = &quot;otherme@example.com&quot;;</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+Cu.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+function setupModule(module) {</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+  collector.getModule(&quot;folder-display-helpers&quot;).installInto(module);</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+  collector.getModule(&quot;window-helpers&quot;).installInto(module);</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+  collector.getModule(&quot;compose-helpers&quot;).installInto(module);</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+  // Now set up an account with some identities.</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+  let acctMgr = MailServices.accounts;</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+  let account = acctMgr.createAccount();</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+  account.incomingServer = acctMgr.createIncomingServer(</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+    &quot;nobody&quot;, &quot;Reply Addresses Testing&quot;, &quot;pop3&quot;);</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+  folder = account.incomingServer.rootFolder</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+                  .QueryInterface(Ci.nsIMsgLocalMailFolder)</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+                  .createLocalSubfolder(&quot;Msgs4Reply&quot;);</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+  let identity1 = acctMgr.createIdentity();</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+  identity1.email = myEmail1;</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+  account.addIdentity(identity1);</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+  let identity2 = acctMgr.createIdentity();</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+  identity2.email = myEmail2;</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+  account.addIdentity(identity2);</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+  // Let's add messages to the folder later as we go, it's hard to read</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+  // out of context what the expected results should be.</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+}</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+function checkToAddresses(replyWinController, expectedFields) {</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+  let addressingWidgetItems = replyWinController.window.document</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+    .querySelectorAll(&quot;#addressingWidget .addressingWidgetItem&quot;);</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+  let obtainedFields = [];</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+  for (let i = 0; i &lt; addressingWidgetItems.length; i++) {</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+    let addrTypePopup = addressingWidgetItems[i].querySelector(&quot;menupopup&quot;);</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+    let addrTextbox = addressingWidgetItems[i].querySelector(&quot;textbox&quot;);</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+    let selectedIndex = addrTypePopup.parentNode.selectedIndex;</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+    let typeMenuitems = addrTypePopup.childNodes;</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+    let addrType = (selectedIndex != -1) ?</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+      typeMenuitems[selectedIndex].value : typeMenuitems[0].value;</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+    let addresses = obtainedFields[addrType];</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+    if (addresses)</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+      addresses.push(addrTextbox.value);</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+    else</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+      addresses = [addrTextbox.value];</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+    obtainedFields[addrType] = addresses;</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+  }</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+  // Check what we expect is there.</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+  for (let type in expectedFields) {</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+    let expected = expectedFields[type];</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+    let obtained = obtainedFields[type];</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+    for (let i = 0; i &lt; expected.length; i++) {</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+      if (!obtained || obtained.indexOf(expected[i]) == -1) {</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+        throw new Error(expected[i] + &quot; is not in &quot; + type + &quot; fields; &quot; +</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+                        &quot;obtained=&quot; + obtained);</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+      }</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+    }</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+    assert_equals(obtained.length, expected.length,</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+                  &quot;Unexpected number of fields obtained for type=&quot; + type +</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+                  &quot;; obtained=&quot; + obtained + &quot;; expected=&quot; + expected);</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+  }</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+  // Check there's no &quot;extra&quot; fields either.</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+  for (let type in obtainedFields) {</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+    let expected = expectedFields[type];</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+    let obtained = obtainedFields[type];</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+    if (!expected) {</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineplus">+      throw new Error(&quot;Didn't expect a field for type=&quot; + type +</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+                      &quot;; obtained=&quot; + obtained);</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+    }</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+  }</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+}</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineplus">+/**</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+ * Tests that addresses get set properly when doing a normal reply.</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+ */</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+function testToCcReply() {</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+  let msg0 = create_message({</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+    from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+    to: &quot;Mr Burns &lt;mrburns@example.com&gt;, workers@example.com, &quot; +</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+        myEmail1,</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+    cc: &quot;Lisa &lt;lisa@example.com&gt;&quot;,</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineplus">+    subject: &quot;testToCcReply - normal mail with to and cc (me in To)&quot;</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+  });</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+  add_message_to_folder(folder, msg0);</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+  let msg = select_click_row(i++);</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+  assert_selected_and_displayed(mc, msg);</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineplus">+</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+  let rwc = open_compose_with_reply();</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+  // To: From</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+  checkToAddresses(rwc, {&quot;addr_to&quot;: [&quot;Homer &lt;homer@example.com&gt;&quot;]});</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+  close_compose_window(rwc);</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+}</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineplus">+/**</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineplus">+ * Tests that addresses get set properly when doing a normal reply to all.</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+ */</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+function testToCcReplyAll() {</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+  let msg0 = create_message({</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+    from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+    to: &quot;Mr Burns &lt;mrburns@example.com&gt;, workers@example.com, &quot; +</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineplus">+        myEmail1,</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+    cc: &quot;Lisa &lt;lisa@example.com&gt;&quot;,</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineplus">+    subject: &quot;testToCcReplyAll - normal mail with to and cc (me in To)&quot;</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineplus">+  });</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineplus">+  add_message_to_folder(folder, msg0);</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineplus">+</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineplus">+  let msg = select_click_row(i++);</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineplus">+  assert_selected_and_displayed(mc, msg);</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineplus">+</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+  let rwc = open_compose_with_reply_to_all();</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+  checkToAddresses(rwc,</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+    // To: From + Tos without me.</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+    // Cc: original Ccs</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+    {</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+    &quot;addr_to&quot;: [&quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+                &quot;Mr Burns &lt;mrburns@example.com&gt;&quot;,</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+                &quot;workers@example.com&quot;],</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineplus">+    &quot;addr_cc&quot;: [&quot;Lisa &lt;lisa@example.com&gt;&quot;]</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineplus">+    }</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineplus">+  );</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineplus">+  close_compose_window(rwc);</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+}</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineplus">+</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineplus">+/**</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineplus">+ * Tests that that addresses get set properly when doing a normal reply to all</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+ * where when recipients aren't all ascii.</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineplus">+ */</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+function testToCcReplyAllInternational() {</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineplus">+  let msg0 = create_message({</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+    from: &quot;Hideaki / =?iso-2022-jp?B?GyRCNUhGIzFRTEAbKEI=?= &lt;hideaki@example.com&gt;&quot;,</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineplus">+    to: &quot;Mr Burns &lt;mrburns@example.com&gt;, =?UTF-8?B?w4VrZQ==?= &lt;ake@example.com&gt;, &quot; +</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineplus">+        &quot;=?KOI8-R?Q?=E9=D7=C1=CE?= &lt;ivan@example.com&gt;, &quot; + myEmail1,</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineplus">+    cc: &quot;=?Big5?B?pP2oca1e?= &lt;xiuying@example.com&gt;&quot;,</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineplus">+    subject: &quot;testToCcReplyAllInternational - non-ascii people mail with to and cc (me in To)&quot;,</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+    clobberHeaders: { 'Content-Transfer-Encoding': 'quoted-printable' },</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+    // Content-Transfer-Encoding ^^^ should be set from the body encoding below,</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineplus">+    //but that doesn't seem to work. (No Content-Transfer-Encoding header is</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineplus">+    // generated).</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineplus">+    body: {charset: &quot;windows-1251&quot;, encoding: &quot;quoted-printable&quot;, body: &quot;=CF=F0=E8=E2=E5=F2 =E8=E7 =CC=EE=F1=EA=E2=FB&quot;}</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineplus">+  });</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineplus">+  add_message_to_folder(folder, msg0);</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineplus">+</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineplus">+  let msg = select_click_row(i++);</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineplus">+  assert_selected_and_displayed(mc, msg);</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineplus">+</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineplus">+  let rwc = open_compose_with_reply_to_all();</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineplus">+</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineplus">+  checkToAddresses(rwc,</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineplus">+    // To: From + Tos without me.</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineplus">+    // Cc: original Ccs</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineplus">+    {</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineplus">+    &quot;addr_to&quot;: [&quot;Hideaki / 吉藤英明 &lt;hideaki@example.com&gt;&quot;,</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineplus">+                &quot;Mr Burns &lt;mrburns@example.com&gt;&quot;,</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineplus">+                &quot;Åke &lt;ake@example.com&gt;&quot;,</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineplus">+                &quot;Иван &lt;ivan@example.com&gt;&quot;],</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineplus">+    &quot;addr_cc&quot;: [&quot;王秀英 &lt;xiuying@example.com&gt;&quot;]</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineplus">+    }</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineplus">+  );</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineplus">+  close_compose_window(rwc);</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineplus">+}</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineplus">+</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineplus">+/**</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineplus">+ * Tests that that addresses get set properly when doing a reply to a mail with</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineplus">+ * reply-to set.</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineplus">+ */</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineplus">+function testToCcReplyWhenReplyToSet() {</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineplus">+  let msg0 = create_message({</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineplus">+    from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineplus">+    to: &quot;workers@example.com&quot;,</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineplus">+    cc: &quot;Lisa &lt;lisa@example.com&gt;, &quot; + myEmail1,</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineplus">+    subject: &quot;testToCcReplyWhenReplyToSet - to/cc mail with reply-to set (me in Cc)&quot;,</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineplus">+    clobberHeaders: {</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineplus">+      &quot;Reply-To&quot;: &quot;marge@example.com&quot;</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineplus">+    }</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineplus">+  });</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineplus">+  add_message_to_folder(folder, msg0);</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineplus">+</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineplus">+  let msg = select_click_row(i++);</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineplus">+  assert_selected_and_displayed(mc, msg);</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineplus">+</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineplus">+  let rwc = open_compose_with_reply();</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineplus">+</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineplus">+  // To: reply-to</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineplus">+  checkToAddresses(rwc, {&quot;addr_to&quot;: [&quot;marge@example.com&quot;]});</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineplus">+  close_compose_window(rwc);</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineplus">+}</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineplus">+</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineplus">+/**</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineplus">+ * Tests that addresses get set properly when doing a reply to all for a mail</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineplus">+ * w/ Reply-To.</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineplus">+ */</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineplus">+function testToCcReplyAllWhenReplyToSet() {</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineplus">+  let msg0 = create_message({</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineplus">+    from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineplus">+    to: &quot;workers@example.com&quot;,</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineplus">+    cc: &quot;Lisa &lt;lisa@example.com&gt;, &quot; + myEmail1,</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineplus">+    subject: &quot;testToCcReplyAllWhenReplyToSet - to/cc mail with reply-to set (me in Cc)&quot;,</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineplus">+    clobberHeaders: {</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineplus">+      &quot;Reply-To&quot;: &quot;marge@example.com&quot;</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineplus">+    }</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+  });</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineplus">+  add_message_to_folder(folder, msg0);</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineplus">+</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineplus">+  let msg = select_click_row(i++);</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineplus">+  assert_selected_and_displayed(mc, msg);</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineplus">+</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineplus">+  let rwc = open_compose_with_reply_to_all();</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineplus">+</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineplus">+  checkToAddresses(rwc,</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineplus">+    // To: Reply-To + Tos</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineplus">+    // Cc: original Ccs without me.</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineplus">+    {</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineplus">+    &quot;addr_to&quot;: [&quot;marge@example.com&quot;,</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineplus">+                &quot;workers@example.com&quot;],</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineplus">+    &quot;addr_cc&quot;: [&quot;Lisa &lt;lisa@example.com&gt;&quot;]</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineplus">+    }</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineplus">+  );</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineplus">+  close_compose_window(rwc);</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineplus">+}</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineplus">+</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineplus">+/**</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineplus">+ * Tests that addresses get set properly when doing a reply to list.</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineplus">+ */</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineplus">+function testReplyToList() {</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineplus">+  let msg0 = create_message({</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineplus">+    from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineplus">+    to: &quot;workers-list@example.com&quot;,</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineplus">+    cc: &quot;Lisa &lt;lisa@example.com&gt;, &quot; + myEmail1,</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineplus">+    subject: &quot;testReplyToList - mailing list message (me in Cc)&quot;,</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineplus">+    clobberHeaders: {</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineplus">+      &quot;List-Post&quot;: &quot;&lt;mailto:workers-list@example.com&gt;&quot;</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineplus">+    }</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineplus">+  });</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineplus">+  add_message_to_folder(folder, msg0);</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineplus">+</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineplus">+  let msg = select_click_row(i++);</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineplus">+  assert_selected_and_displayed(mc, msg);</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineplus">+</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineplus">+  let rwc = open_compose_with_reply_to_list();</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineplus">+</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineplus">+  checkToAddresses(rwc, {&quot;addr_to&quot;: [&quot;workers-list@example.com&quot;]});</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineplus">+  close_compose_window(rwc);</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineplus">+}</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineplus">+</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineplus">+/**</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineplus">+ * Tests that addresses get set properly when doing a reply to sender for a</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineplus">+ * list post.</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineplus">+ */</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineplus">+function testReplySenderForListPost() {</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineplus">+  let msg0 = create_message({</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineplus">+    from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineplus">+    to: &quot;workers-list@example.com&quot;,</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineplus">+    cc: &quot;Lisa &lt;lisa@example.com&gt;, &quot; + myEmail1,</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineplus">+    subject: &quot;testReplySenderForListPost - mailing list message (me in Cc)&quot;,</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineplus">+    clobberHeaders: {</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineplus">+      &quot;List-Post&quot;: &quot;&lt;mailto:workers-list@example.com&gt;&quot;</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineplus">+    }</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineplus">+  });</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineplus">+  add_message_to_folder(folder, msg0);</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineplus">+</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineplus">+  let msg = select_click_row(i++);</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineplus">+  assert_selected_and_displayed(mc, msg);</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineplus">+</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineplus">+  let rwc = open_compose_with_reply();</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineplus">+</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineplus">+  // To: From</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineplus">+  checkToAddresses(rwc, {&quot;addr_to&quot;: [&quot;Homer &lt;homer@example.com&gt;&quot;]});</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineplus">+  close_compose_window(rwc);</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineplus">+}</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineplus">+</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineplus">+/**</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineplus">+ * Tests that addresses get set properly when doing a reply all to a list post.</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineplus">+ */</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineplus">+function testReplyToAllForListPost() {</span>
<a href="#l2.319"></a><span id="l2.319" class="difflineplus">+  let msg0 = create_message({</span>
<a href="#l2.320"></a><span id="l2.320" class="difflineplus">+    from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineplus">+    to: &quot;workers-list@example.com&quot;,</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineplus">+    cc: &quot;Lisa &lt;lisa@example.com&gt;, &quot; + myEmail1,</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineplus">+    subject: &quot;testReplyToAllForListPost - mailing list message (me in Cc)&quot;,</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineplus">+    clobberHeaders: {</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineplus">+      &quot;List-Post&quot;: &quot;&lt;mailto:workers-list@example.com&gt;&quot;</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineplus">+    }</span>
<a href="#l2.327"></a><span id="l2.327" class="difflineplus">+  });</span>
<a href="#l2.328"></a><span id="l2.328" class="difflineplus">+  add_message_to_folder(folder, msg0);</span>
<a href="#l2.329"></a><span id="l2.329" class="difflineplus">+</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineplus">+  let msg = select_click_row(i++);</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineplus">+  assert_selected_and_displayed(mc, msg);</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineplus">+</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineplus">+  let rwc = open_compose_with_reply_to_all();</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineplus">+</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineplus">+  // To: From + original To</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineplus">+  // Cc: original CC without me</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineplus">+  checkToAddresses(rwc,</span>
<a href="#l2.339"></a><span id="l2.339" class="difflineplus">+    {</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineplus">+    &quot;addr_to&quot;: [&quot;Homer &lt;homer@example.com&gt;&quot;, &quot;workers-list@example.com&quot;],</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineplus">+    &quot;addr_cc&quot;: [&quot;Lisa &lt;lisa@example.com&gt;&quot;]</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineplus">+    }</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineplus">+  );</span>
<a href="#l2.344"></a><span id="l2.344" class="difflineplus">+  close_compose_window(rwc);</span>
<a href="#l2.345"></a><span id="l2.345" class="difflineplus">+}</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineplus">+</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineplus">+/**</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineplus">+ * Tests that addresses get set properly when doing a reply to all for a list</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineplus">+ * post when also reply-to is set.</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineplus">+ */</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineplus">+function testReplyToListWhenReplyToSet() {</span>
<a href="#l2.352"></a><span id="l2.352" class="difflineplus">+  let msg0 = create_message({</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineplus">+    from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineplus">+    to: &quot;workers-list@example.com, &quot; + myEmail1,</span>
<a href="#l2.355"></a><span id="l2.355" class="difflineplus">+    cc: &quot;Lisa &lt;lisa@example.com&gt;&quot;,</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineplus">+    subject: &quot;testReplyToListWhenReplyToSet - mailing list message w/ cc, reply-to (me in To)&quot;,</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineplus">+    clobberHeaders: {</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineplus">+      &quot;Reply-To&quot;: &quot;marge@example.com&quot;,</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineplus">+      &quot;List-Post&quot;: &quot;&lt;mailto:workers-list@example.com&gt;&quot;</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineplus">+    }</span>
<a href="#l2.361"></a><span id="l2.361" class="difflineplus">+  });</span>
<a href="#l2.362"></a><span id="l2.362" class="difflineplus">+  add_message_to_folder(folder, msg0);</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineplus">+</span>
<a href="#l2.364"></a><span id="l2.364" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineplus">+  let msg = select_click_row(i++);</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineplus">+  assert_selected_and_displayed(mc, msg);</span>
<a href="#l2.367"></a><span id="l2.367" class="difflineplus">+</span>
<a href="#l2.368"></a><span id="l2.368" class="difflineplus">+  let rwc = open_compose_with_reply_to_all();</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineplus">+</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineplus">+  // To: Reply-To, oringinal Tos</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineplus">+  // Cc: original Cc</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineplus">+  checkToAddresses(rwc,</span>
<a href="#l2.373"></a><span id="l2.373" class="difflineplus">+    {</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineplus">+    &quot;addr_to&quot;: [&quot;marge@example.com&quot;, &quot;workers-list@example.com&quot;],</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineplus">+    &quot;addr_cc&quot;: [&quot;Lisa &lt;lisa@example.com&gt;&quot;]</span>
<a href="#l2.376"></a><span id="l2.376" class="difflineplus">+    }</span>
<a href="#l2.377"></a><span id="l2.377" class="difflineplus">+  );</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineplus">+  close_compose_window(rwc);</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineplus">+}</span>
<a href="#l2.380"></a><span id="l2.380" class="difflineplus">+</span>
<a href="#l2.381"></a><span id="l2.381" class="difflineplus">+/**</span>
<a href="#l2.382"></a><span id="l2.382" class="difflineplus">+ * Test that addresses get set properly for Mail-Reply-To. Mail-Reply-To should</span>
<a href="#l2.383"></a><span id="l2.383" class="difflineplus">+ * be used for reply to author, if present.</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineplus">+ * @see http://cr.yp.to/proto/replyto.html</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineplus">+ */</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineplus">+function testMailReplyTo() {</span>
<a href="#l2.387"></a><span id="l2.387" class="difflineplus">+  let msg0 = create_message({</span>
<a href="#l2.388"></a><span id="l2.388" class="difflineplus">+    from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l2.389"></a><span id="l2.389" class="difflineplus">+    to: &quot;workers-list@example.com&quot;,</span>
<a href="#l2.390"></a><span id="l2.390" class="difflineplus">+    cc: &quot;Lisa &lt;lisa@example.com&gt;&quot;,</span>
<a href="#l2.391"></a><span id="l2.391" class="difflineplus">+    subject: &quot;testMailReplyTo - mail with Mail-Reply-To header&quot;,</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineplus">+    clobberHeaders: {</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineplus">+      &quot;Reply-To&quot;: &quot;workers-list@example.com&quot;, // reply-to munging</span>
<a href="#l2.394"></a><span id="l2.394" class="difflineplus">+      &quot;Mail-Reply-To&quot;: &quot;Homer S. &lt;homer@example.com&gt;&quot;</span>
<a href="#l2.395"></a><span id="l2.395" class="difflineplus">+    }</span>
<a href="#l2.396"></a><span id="l2.396" class="difflineplus">+  });</span>
<a href="#l2.397"></a><span id="l2.397" class="difflineplus">+  add_message_to_folder(folder, msg0);</span>
<a href="#l2.398"></a><span id="l2.398" class="difflineplus">+</span>
<a href="#l2.399"></a><span id="l2.399" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l2.400"></a><span id="l2.400" class="difflineplus">+  let msg = select_click_row(i++);</span>
<a href="#l2.401"></a><span id="l2.401" class="difflineplus">+  assert_selected_and_displayed(mc, msg);</span>
<a href="#l2.402"></a><span id="l2.402" class="difflineplus">+</span>
<a href="#l2.403"></a><span id="l2.403" class="difflineplus">+  let rwc = open_compose_with_reply();</span>
<a href="#l2.404"></a><span id="l2.404" class="difflineplus">+</span>
<a href="#l2.405"></a><span id="l2.405" class="difflineplus">+  // To: Mail-Reply-To</span>
<a href="#l2.406"></a><span id="l2.406" class="difflineplus">+  checkToAddresses(rwc, {&quot;addr_to&quot;: [&quot;Homer S. &lt;homer@example.com&gt;&quot;]});</span>
<a href="#l2.407"></a><span id="l2.407" class="difflineplus">+  close_compose_window(rwc);</span>
<a href="#l2.408"></a><span id="l2.408" class="difflineplus">+}</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineplus">+</span>
<a href="#l2.410"></a><span id="l2.410" class="difflineplus">+/**</span>
<a href="#l2.411"></a><span id="l2.411" class="difflineplus">+ * Test that addresses get set properly Mail-Followup-To. Mail-Followup-To</span>
<a href="#l2.412"></a><span id="l2.412" class="difflineplus">+ * should be the default recipent list for reply-all, if present.</span>
<a href="#l2.413"></a><span id="l2.413" class="difflineplus">+ * @see http://cr.yp.to/proto/replyto.html</span>
<a href="#l2.414"></a><span id="l2.414" class="difflineplus">+ */</span>
<a href="#l2.415"></a><span id="l2.415" class="difflineplus">+function testMailFollowupTo() {</span>
<a href="#l2.416"></a><span id="l2.416" class="difflineplus">+  let msg0 = create_message({</span>
<a href="#l2.417"></a><span id="l2.417" class="difflineplus">+    from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l2.418"></a><span id="l2.418" class="difflineplus">+    to: &quot;workers-list@example.com, &quot; + myEmail1,</span>
<a href="#l2.419"></a><span id="l2.419" class="difflineplus">+    cc: &quot;Lisa &lt;lisa@example.com&gt;&quot;,</span>
<a href="#l2.420"></a><span id="l2.420" class="difflineplus">+    subject: &quot;testMailFollowupTo - mail with Mail-Followup-To header&quot;,</span>
<a href="#l2.421"></a><span id="l2.421" class="difflineplus">+    clobberHeaders: {</span>
<a href="#l2.422"></a><span id="l2.422" class="difflineplus">+      // Homer is on the list, and don't want extra copies, so he has</span>
<a href="#l2.423"></a><span id="l2.423" class="difflineplus">+      // set the Mail-Followup-To header so followups go to the list.</span>
<a href="#l2.424"></a><span id="l2.424" class="difflineplus">+      &quot;Mail-Followup-To&quot;: &quot;workers-list@example.com&quot;</span>
<a href="#l2.425"></a><span id="l2.425" class="difflineplus">+    }</span>
<a href="#l2.426"></a><span id="l2.426" class="difflineplus">+  });</span>
<a href="#l2.427"></a><span id="l2.427" class="difflineplus">+  add_message_to_folder(folder, msg0);</span>
<a href="#l2.428"></a><span id="l2.428" class="difflineplus">+</span>
<a href="#l2.429"></a><span id="l2.429" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l2.430"></a><span id="l2.430" class="difflineplus">+  let msg = select_click_row(i++);</span>
<a href="#l2.431"></a><span id="l2.431" class="difflineplus">+  assert_selected_and_displayed(mc, msg);</span>
<a href="#l2.432"></a><span id="l2.432" class="difflineplus">+</span>
<a href="#l2.433"></a><span id="l2.433" class="difflineplus">+  let rwc = open_compose_with_reply_to_all();</span>
<a href="#l2.434"></a><span id="l2.434" class="difflineplus">+</span>
<a href="#l2.435"></a><span id="l2.435" class="difflineplus">+  // To: Mail-Followup-To</span>
<a href="#l2.436"></a><span id="l2.436" class="difflineplus">+  checkToAddresses(rwc, {&quot;addr_to&quot;: [&quot;workers-list@example.com&quot;]});</span>
<a href="#l2.437"></a><span id="l2.437" class="difflineplus">+  close_compose_window(rwc);</span>
<a href="#l2.438"></a><span id="l2.438" class="difflineplus">+}</span>
<a href="#l2.439"></a><span id="l2.439" class="difflineplus">+</span>
<a href="#l2.440"></a><span id="l2.440" class="difflineplus">+/**</span>
<a href="#l2.441"></a><span id="l2.441" class="difflineplus">+ * Tests that addresses get set properly for reply to self.</span>
<a href="#l2.442"></a><span id="l2.442" class="difflineplus">+ */</span>
<a href="#l2.443"></a><span id="l2.443" class="difflineplus">+function testReplyToSelfReply() {</span>
<a href="#l2.444"></a><span id="l2.444" class="difflineplus">+  let msg0 = create_message({</span>
<a href="#l2.445"></a><span id="l2.445" class="difflineplus">+    from: myEmail1,</span>
<a href="#l2.446"></a><span id="l2.446" class="difflineplus">+    to: &quot;Bart &lt;bart@example.com&gt;, Maggie &lt;maggie@example.com&gt;&quot;,</span>
<a href="#l2.447"></a><span id="l2.447" class="difflineplus">+    cc: &quot;Lisa &lt;lisa@example.com&gt;&quot;,</span>
<a href="#l2.448"></a><span id="l2.448" class="difflineplus">+    subject: &quot;testReplyToSelfReply - reply to self&quot;,</span>
<a href="#l2.449"></a><span id="l2.449" class="difflineplus">+    clobberHeaders: {</span>
<a href="#l2.450"></a><span id="l2.450" class="difflineplus">+      &quot;Bcc&quot;: &quot;Moe &lt;moe@example.com&gt;&quot;</span>
<a href="#l2.451"></a><span id="l2.451" class="difflineplus">+    }</span>
<a href="#l2.452"></a><span id="l2.452" class="difflineplus">+  });</span>
<a href="#l2.453"></a><span id="l2.453" class="difflineplus">+  add_message_to_folder(folder, msg0);</span>
<a href="#l2.454"></a><span id="l2.454" class="difflineplus">+</span>
<a href="#l2.455"></a><span id="l2.455" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l2.456"></a><span id="l2.456" class="difflineplus">+  let msg = select_click_row(i++);</span>
<a href="#l2.457"></a><span id="l2.457" class="difflineplus">+  assert_selected_and_displayed(mc, msg);</span>
<a href="#l2.458"></a><span id="l2.458" class="difflineplus">+</span>
<a href="#l2.459"></a><span id="l2.459" class="difflineplus">+  let rwc = open_compose_with_reply();</span>
<a href="#l2.460"></a><span id="l2.460" class="difflineplus">+</span>
<a href="#l2.461"></a><span id="l2.461" class="difflineplus">+  // To: original To</span>
<a href="#l2.462"></a><span id="l2.462" class="difflineplus">+  checkToAddresses(rwc, {&quot;addr_to&quot;: [&quot;Bart &lt;bart@example.com&gt;&quot;,</span>
<a href="#l2.463"></a><span id="l2.463" class="difflineplus">+                                     &quot;Maggie &lt;maggie@example.com&gt;&quot;]});</span>
<a href="#l2.464"></a><span id="l2.464" class="difflineplus">+  close_compose_window(rwc);</span>
<a href="#l2.465"></a><span id="l2.465" class="difflineplus">+}</span>
<a href="#l2.466"></a><span id="l2.466" class="difflineplus">+</span>
<a href="#l2.467"></a><span id="l2.467" class="difflineplus">+/**</span>
<a href="#l2.468"></a><span id="l2.468" class="difflineplus">+ * Tests that addresses get set properly for a reply all to self - this should</span>
<a href="#l2.469"></a><span id="l2.469" class="difflineplus">+ * be treated as a followup.</span>
<a href="#l2.470"></a><span id="l2.470" class="difflineplus">+ */</span>
<a href="#l2.471"></a><span id="l2.471" class="difflineplus">+function testReplyToSelfReplyAll() {</span>
<a href="#l2.472"></a><span id="l2.472" class="difflineplus">+  let msg0 = create_message({</span>
<a href="#l2.473"></a><span id="l2.473" class="difflineplus">+    from: myEmail1,</span>
<a href="#l2.474"></a><span id="l2.474" class="difflineplus">+    to: &quot;Bart &lt;bart@example.com&gt;, Maggie &lt;maggie@example.com&gt;&quot;,</span>
<a href="#l2.475"></a><span id="l2.475" class="difflineplus">+    cc: &quot;Lisa &lt;lisa@example.com&gt;&quot;,</span>
<a href="#l2.476"></a><span id="l2.476" class="difflineplus">+    subject: &quot;testReplyToSelfReplyAll - reply to self&quot;,</span>
<a href="#l2.477"></a><span id="l2.477" class="difflineplus">+    clobberHeaders: {</span>
<a href="#l2.478"></a><span id="l2.478" class="difflineplus">+      &quot;Bcc&quot;: &quot;Moe &lt;moe@example.com&gt;&quot;</span>
<a href="#l2.479"></a><span id="l2.479" class="difflineplus">+    }</span>
<a href="#l2.480"></a><span id="l2.480" class="difflineplus">+  });</span>
<a href="#l2.481"></a><span id="l2.481" class="difflineplus">+  add_message_to_folder(folder, msg0);</span>
<a href="#l2.482"></a><span id="l2.482" class="difflineplus">+</span>
<a href="#l2.483"></a><span id="l2.483" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l2.484"></a><span id="l2.484" class="difflineplus">+  let msg = select_click_row(i++);</span>
<a href="#l2.485"></a><span id="l2.485" class="difflineplus">+  assert_selected_and_displayed(mc, msg);</span>
<a href="#l2.486"></a><span id="l2.486" class="difflineplus">+</span>
<a href="#l2.487"></a><span id="l2.487" class="difflineplus">+  let rwc = open_compose_with_reply_to_all();</span>
<a href="#l2.488"></a><span id="l2.488" class="difflineplus">+</span>
<a href="#l2.489"></a><span id="l2.489" class="difflineplus">+  checkToAddresses(rwc,</span>
<a href="#l2.490"></a><span id="l2.490" class="difflineplus">+    // To: original To</span>
<a href="#l2.491"></a><span id="l2.491" class="difflineplus">+    // Cc: original Cc</span>
<a href="#l2.492"></a><span id="l2.492" class="difflineplus">+    // Bcc: original Bcc</span>
<a href="#l2.493"></a><span id="l2.493" class="difflineplus">+    {</span>
<a href="#l2.494"></a><span id="l2.494" class="difflineplus">+    &quot;addr_to&quot;: [&quot;Bart &lt;bart@example.com&gt;&quot;,</span>
<a href="#l2.495"></a><span id="l2.495" class="difflineplus">+                &quot;Maggie &lt;maggie@example.com&gt;&quot;],</span>
<a href="#l2.496"></a><span id="l2.496" class="difflineplus">+    &quot;addr_cc&quot;: [&quot;Lisa &lt;lisa@example.com&gt;&quot;],</span>
<a href="#l2.497"></a><span id="l2.497" class="difflineplus">+    &quot;addr_bcc&quot;: [&quot;Moe &lt;moe@example.com&gt;&quot;]</span>
<a href="#l2.498"></a><span id="l2.498" class="difflineplus">+    }</span>
<a href="#l2.499"></a><span id="l2.499" class="difflineplus">+  );</span>
<a href="#l2.500"></a><span id="l2.500" class="difflineplus">+  close_compose_window(rwc);</span>
<a href="#l2.501"></a><span id="l2.501" class="difflineplus">+}</span>
<a href="#l2.502"></a><span id="l2.502" class="difflineplus">+</span>
<a href="#l2.503"></a><span id="l2.503" class="difflineplus">+/**</span>
<a href="#l2.504"></a><span id="l2.504" class="difflineplus">+ * Tests that addresses get set properly for a nntp reply-all.</span>
<a href="#l2.505"></a><span id="l2.505" class="difflineplus">+ */</span>
<a href="#l2.506"></a><span id="l2.506" class="difflineplus">+function testNewsgroupsReplyAll() {</span>
<a href="#l2.507"></a><span id="l2.507" class="difflineplus">+  let msg0 = create_message({</span>
<a href="#l2.508"></a><span id="l2.508" class="difflineplus">+    from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l2.509"></a><span id="l2.509" class="difflineplus">+    to: &quot;test1-list@example.org&quot;,</span>
<a href="#l2.510"></a><span id="l2.510" class="difflineplus">+    subject: &quot;testNewsgroupsReplyAll - sent to two newsgroups and a list&quot;,</span>
<a href="#l2.511"></a><span id="l2.511" class="difflineplus">+    clobberHeaders: {</span>
<a href="#l2.512"></a><span id="l2.512" class="difflineplus">+      &quot;Newsgroups&quot;: &quot;example.test1, example.test2&quot;</span>
<a href="#l2.513"></a><span id="l2.513" class="difflineplus">+    }</span>
<a href="#l2.514"></a><span id="l2.514" class="difflineplus">+  });</span>
<a href="#l2.515"></a><span id="l2.515" class="difflineplus">+  add_message_to_folder(folder, msg0);</span>
<a href="#l2.516"></a><span id="l2.516" class="difflineplus">+</span>
<a href="#l2.517"></a><span id="l2.517" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l2.518"></a><span id="l2.518" class="difflineplus">+  let msg = select_click_row(i++);</span>
<a href="#l2.519"></a><span id="l2.519" class="difflineplus">+  assert_selected_and_displayed(mc, msg);</span>
<a href="#l2.520"></a><span id="l2.520" class="difflineplus">+</span>
<a href="#l2.521"></a><span id="l2.521" class="difflineplus">+  let rwc = open_compose_with_reply_to_all();</span>
<a href="#l2.522"></a><span id="l2.522" class="difflineplus">+</span>
<a href="#l2.523"></a><span id="l2.523" class="difflineplus">+  checkToAddresses(rwc,</span>
<a href="#l2.524"></a><span id="l2.524" class="difflineplus">+    // To: From, original To</span>
<a href="#l2.525"></a><span id="l2.525" class="difflineplus">+    // Newsgroups: original Ccs</span>
<a href="#l2.526"></a><span id="l2.526" class="difflineplus">+    {</span>
<a href="#l2.527"></a><span id="l2.527" class="difflineplus">+    &quot;addr_to&quot;: [&quot;Homer &lt;homer@example.com&gt;&quot;, &quot;test1-list@example.org&quot;],</span>
<a href="#l2.528"></a><span id="l2.528" class="difflineplus">+    &quot;addr_newsgroups&quot;: [&quot;example.test1&quot;, &quot;example.test2&quot;]</span>
<a href="#l2.529"></a><span id="l2.529" class="difflineplus">+    }</span>
<a href="#l2.530"></a><span id="l2.530" class="difflineplus">+  );</span>
<a href="#l2.531"></a><span id="l2.531" class="difflineplus">+  close_compose_window(rwc);</span>
<a href="#l2.532"></a><span id="l2.532" class="difflineplus">+}</span>
<a href="#l2.533"></a><span id="l2.533" class="difflineplus">+</span>
<a href="#l2.534"></a><span id="l2.534" class="difflineplus">+/**</span>
<a href="#l2.535"></a><span id="l2.535" class="difflineplus">+ * Tests that addresses get set properly for an nntp followup, when Followup-To</span>
<a href="#l2.536"></a><span id="l2.536" class="difflineplus">+ * is set.</span>
<a href="#l2.537"></a><span id="l2.537" class="difflineplus">+ */</span>
<a href="#l2.538"></a><span id="l2.538" class="difflineplus">+function testNewsgroupsReplyAllFollowupTo() {</span>
<a href="#l2.539"></a><span id="l2.539" class="difflineplus">+  let msg0 = create_message({</span>
<a href="#l2.540"></a><span id="l2.540" class="difflineplus">+    from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l2.541"></a><span id="l2.541" class="difflineplus">+    to: &quot;test1-list@example.org&quot;,</span>
<a href="#l2.542"></a><span id="l2.542" class="difflineplus">+    subject: &quot;testNewsgroupsReplyAllFollowupTo - Followup-To set&quot;,</span>
<a href="#l2.543"></a><span id="l2.543" class="difflineplus">+    clobberHeaders: {</span>
<a href="#l2.544"></a><span id="l2.544" class="difflineplus">+      &quot;Newsgroups&quot;: &quot;example.test1, example.test2&quot;,</span>
<a href="#l2.545"></a><span id="l2.545" class="difflineplus">+      &quot;Followup-To&quot;: &quot;example.test2&quot;</span>
<a href="#l2.546"></a><span id="l2.546" class="difflineplus">+    }</span>
<a href="#l2.547"></a><span id="l2.547" class="difflineplus">+  });</span>
<a href="#l2.548"></a><span id="l2.548" class="difflineplus">+  add_message_to_folder(folder, msg0);</span>
<a href="#l2.549"></a><span id="l2.549" class="difflineplus">+</span>
<a href="#l2.550"></a><span id="l2.550" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l2.551"></a><span id="l2.551" class="difflineplus">+  let msg = select_click_row(i++);</span>
<a href="#l2.552"></a><span id="l2.552" class="difflineplus">+  assert_selected_and_displayed(mc, msg);</span>
<a href="#l2.553"></a><span id="l2.553" class="difflineplus">+</span>
<a href="#l2.554"></a><span id="l2.554" class="difflineplus">+  let rwc = open_compose_with_reply_to_all();</span>
<a href="#l2.555"></a><span id="l2.555" class="difflineplus">+</span>
<a href="#l2.556"></a><span id="l2.556" class="difflineplus">+  checkToAddresses(rwc,</span>
<a href="#l2.557"></a><span id="l2.557" class="difflineplus">+    // Newsgroups: &lt;Followup-To&gt;</span>
<a href="#l2.558"></a><span id="l2.558" class="difflineplus">+    {</span>
<a href="#l2.559"></a><span id="l2.559" class="difflineplus">+    &quot;addr_to&quot;: [&quot;Homer &lt;homer@example.com&gt;&quot;, &quot;test1-list@example.org&quot;],</span>
<a href="#l2.560"></a><span id="l2.560" class="difflineplus">+    &quot;addr_newsgroups&quot;: [&quot;example.test2&quot;]</span>
<a href="#l2.561"></a><span id="l2.561" class="difflineplus">+    }</span>
<a href="#l2.562"></a><span id="l2.562" class="difflineplus">+  );</span>
<a href="#l2.563"></a><span id="l2.563" class="difflineplus">+  close_compose_window(rwc);</span>
<a href="#l2.564"></a><span id="l2.564" class="difflineplus">+}</span>
<a href="#l2.565"></a><span id="l2.565" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-signature-updating.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-signature-updating.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -41,17 +41,17 @@ var setupModule = function (module) {</span>
<a href="#l3.4"></a><span id="l3.4">   let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l3.5"></a><span id="l3.5">                   .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l3.6"></a><span id="l3.6">   let server = acctMgr.FindServer(&quot;tinderbox&quot;, &quot;tinderbox&quot;, &quot;pop3&quot;);</span>
<a href="#l3.7"></a><span id="l3.7">   let inbox = server.rootFolder.getChildNamed(&quot;Inbox&quot;);</span>
<a href="#l3.8"></a><span id="l3.8">   be_in_folder(inbox);</span>
<a href="#l3.9"></a><span id="l3.9"> };</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11"> function setupComposeWin(toAddr, subj, body) {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  cwc.type(cwc.a(&quot;addressingWidget&quot;, {class: &quot;addressingWidgetCell&quot;, crazyDeck: 1}), toAddr);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  cwc.type(null, toAddr);</span>
<a href="#l3.14"></a><span id="l3.14">   cwc.type(cwc.eid(&quot;msgSubject&quot;), subj);</span>
<a href="#l3.15"></a><span id="l3.15">   cwc.type(cwc.eid(&quot;content-frame&quot;), body);</span>
<a href="#l3.16"></a><span id="l3.16"> }</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18"> /**</span>
<a href="#l3.19"></a><span id="l3.19">  * Test that the plaintext compose window has a signature initially,</span>
<a href="#l3.20"></a><span id="l3.20">  * and has the correct signature after switching to another identity.</span>
<a href="#l3.21"></a><span id="l3.21">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-compose-helpers.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-compose-helpers.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -35,16 +35,17 @@ function setupModule() {</span>
<a href="#l4.4"></a><span id="l4.4"> }</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> function installInto(module) {</span>
<a href="#l4.7"></a><span id="l4.7">   setupModule();</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9">   // Now copy helper functions</span>
<a href="#l4.10"></a><span id="l4.10">   module.open_compose_new_mail = open_compose_new_mail;</span>
<a href="#l4.11"></a><span id="l4.11">   module.open_compose_with_reply = open_compose_with_reply;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+  module.open_compose_with_reply_to_all = open_compose_with_reply_to_all;</span>
<a href="#l4.13"></a><span id="l4.13">   module.open_compose_with_reply_to_list = open_compose_with_reply_to_list;</span>
<a href="#l4.14"></a><span id="l4.14">   module.open_compose_with_forward = open_compose_with_forward;</span>
<a href="#l4.15"></a><span id="l4.15">   module.open_compose_with_forward_as_attachments = open_compose_with_forward_as_attachments;</span>
<a href="#l4.16"></a><span id="l4.16">   module.open_compose_with_element_click = open_compose_with_element_click;</span>
<a href="#l4.17"></a><span id="l4.17">   module.close_compose_window = close_compose_window;</span>
<a href="#l4.18"></a><span id="l4.18">   module.wait_for_compose_window = wait_for_compose_window;</span>
<a href="#l4.19"></a><span id="l4.19">   module.create_msg_attachment = create_msg_attachment;</span>
<a href="#l4.20"></a><span id="l4.20">   module.add_attachments = add_attachments;</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineat">@@ -92,16 +93,33 @@ function open_compose_with_reply(aContro</span>
<a href="#l4.22"></a><span id="l4.22"> </span>
<a href="#l4.23"></a><span id="l4.23">   windowHelper.plan_for_new_window(&quot;msgcompose&quot;);</span>
<a href="#l4.24"></a><span id="l4.24">   aController.keypress(null, &quot;r&quot;, {shiftKey: false, accelKey: true});</span>
<a href="#l4.25"></a><span id="l4.25"> </span>
<a href="#l4.26"></a><span id="l4.26">   return wait_for_compose_window();</span>
<a href="#l4.27"></a><span id="l4.27"> }</span>
<a href="#l4.28"></a><span id="l4.28"> </span>
<a href="#l4.29"></a><span id="l4.29"> /**</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+ * Opens the compose window by replying to all for a selected message and waits</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+ * for it to load.</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+ *</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+ * @return The loaded window of type &quot;msgcompose&quot; wrapped in a MozmillController</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+ *         that is augmented using augment_controller.</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+ */</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+function open_compose_with_reply_to_all(aController) {</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+  if (aController === undefined)</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+    aController = mc;</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+  windowHelper.plan_for_new_window(&quot;msgcompose&quot;);</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+  aController.keypress(null, &quot;R&quot;, {shiftKey: true, accelKey: true});</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+  return wait_for_compose_window();</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+}</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+/**</span>
<a href="#l4.47"></a><span id="l4.47">  * Opens the compose window by replying to list for a selected message and waits for it</span>
<a href="#l4.48"></a><span id="l4.48">  * to load.</span>
<a href="#l4.49"></a><span id="l4.49">  *</span>
<a href="#l4.50"></a><span id="l4.50">  * @return The loaded window of type &quot;msgcompose&quot; wrapped in a MozmillController</span>
<a href="#l4.51"></a><span id="l4.51">  *         that is augmented using augment_controller.</span>
<a href="#l4.52"></a><span id="l4.52">  */</span>
<a href="#l4.53"></a><span id="l4.53"> function open_compose_with_reply_to_list(aController) {</span>
<a href="#l4.54"></a><span id="l4.54">   if (aController === undefined)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/compose/public/nsIMsgCompFields.idl</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/compose/public/nsIMsgCompFields.idl</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -2,17 +2,17 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.5"></a><span id="l5.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.6"></a><span id="l5.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> #include &quot;nsIMsgAttachment.idl&quot;</span>
<a href="#l5.10"></a><span id="l5.10"> #include &quot;nsISimpleEnumerator.idl&quot;</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-[scriptable, uuid(a58cd120-ba9b-11de-8a39-0800200c9a66)]</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+[scriptable, uuid(bb793677-87c1-4125-b929-252bd9177793)]</span>
<a href="#l5.14"></a><span id="l5.14"> interface nsIMsgCompFields : nsISupports {</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16">   attribute AString from;</span>
<a href="#l5.17"></a><span id="l5.17">   attribute AString replyTo;</span>
<a href="#l5.18"></a><span id="l5.18">   attribute AString to;</span>
<a href="#l5.19"></a><span id="l5.19">   attribute AString cc;</span>
<a href="#l5.20"></a><span id="l5.20">   attribute AString bcc;</span>
<a href="#l5.21"></a><span id="l5.21"> </span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -42,23 +42,16 @@ interface nsIMsgCompFields : nsISupports</span>
<a href="#l5.23"></a><span id="l5.23">   attribute boolean forcePlainText;</span>
<a href="#l5.24"></a><span id="l5.24">   attribute boolean useMultipartAlternative;</span>
<a href="#l5.25"></a><span id="l5.25">   attribute boolean bodyIsAsciiOnly;</span>
<a href="#l5.26"></a><span id="l5.26">   attribute boolean forceMsgEncoding;</span>
<a href="#l5.27"></a><span id="l5.27"> </span>
<a href="#l5.28"></a><span id="l5.28">   attribute AString otherRandomHeaders;</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30">   /**</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-   * Addresses for the other forms of reply.</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-   */</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-  attribute AString senderReply;</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-  attribute AString allReply;</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-  attribute AString listReply;</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-  /**</span>
<a href="#l5.38"></a><span id="l5.38">    * Beware that when setting this property, your body must be properly wrapped,</span>
<a href="#l5.39"></a><span id="l5.39">    * and the line endings must match MSG_LINEBREAK, namely &quot;\r\n&quot; on Windows</span>
<a href="#l5.40"></a><span id="l5.40">    * and &quot;\n&quot; on Linux and OSX.</span>
<a href="#l5.41"></a><span id="l5.41">    */</span>
<a href="#l5.42"></a><span id="l5.42">   attribute AString body;</span>
<a href="#l5.43"></a><span id="l5.43"> </span>
<a href="#l5.44"></a><span id="l5.44">   /**</span>
<a href="#l5.45"></a><span id="l5.45">    * temporaryFiles</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompFields.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompFields.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -240,46 +240,16 @@ NS_IMETHODIMP nsMsgCompFields::SetOtherR</span>
<a href="#l6.4"></a><span id="l6.4">   return SetUnicodeHeader(MSG_OTHERRANDOMHEADERS_HEADER_ID, value);</span>
<a href="#l6.5"></a><span id="l6.5"> }</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7"> NS_IMETHODIMP nsMsgCompFields::GetOtherRandomHeaders(nsAString &amp;_retval)</span>
<a href="#l6.8"></a><span id="l6.8"> {</span>
<a href="#l6.9"></a><span id="l6.9">   return GetUnicodeHeader(MSG_OTHERRANDOMHEADERS_HEADER_ID, _retval);</span>
<a href="#l6.10"></a><span id="l6.10"> }</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetSenderReply(const nsAString &amp;value)</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-{</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-  return SetUnicodeHeader(MSG_SENDERREPLY_HEADER_ID, value);</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-}</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetSenderReply(nsAString &amp;_retval)</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-{</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-  return GetUnicodeHeader(MSG_SENDERREPLY_HEADER_ID, _retval);</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-}</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetAllReply(const nsAString &amp;value)</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-{</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-  return SetUnicodeHeader(MSG_ALLREPLY_HEADER_ID, value);</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-}</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetAllReply(nsAString &amp;_retval)</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">-{</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-  return GetUnicodeHeader(MSG_ALLREPLY_HEADER_ID, _retval);</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-}</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetListReply(const nsAString &amp;value)</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-{</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-  return SetUnicodeHeader(MSG_LISTREPLY_HEADER_ID, value);</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-}</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetListReply(nsAString &amp;_retval)</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-{</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-  return GetUnicodeHeader(MSG_LISTREPLY_HEADER_ID, _retval);</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-}</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-</span>
<a href="#l6.42"></a><span id="l6.42"> NS_IMETHODIMP nsMsgCompFields::SetNewspostUrl(const char *value)</span>
<a href="#l6.43"></a><span id="l6.43"> {</span>
<a href="#l6.44"></a><span id="l6.44">   return SetAsciiHeader(MSG_NEWSPOSTURL_HEADER_ID, value);</span>
<a href="#l6.45"></a><span id="l6.45"> }</span>
<a href="#l6.46"></a><span id="l6.46"> </span>
<a href="#l6.47"></a><span id="l6.47"> NS_IMETHODIMP nsMsgCompFields::GetNewspostUrl(char **_retval)</span>
<a href="#l6.48"></a><span id="l6.48"> {</span>
<a href="#l6.49"></a><span id="l6.49">   *_retval = strdup(GetAsciiHeader(MSG_NEWSPOSTURL_HEADER_ID));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompFields.h</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompFields.h</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -66,19 +66,16 @@ public:</span>
<a href="#l7.4"></a><span id="l7.4">     MSG_OTHERRANDOMHEADERS_HEADER_ID,</span>
<a href="#l7.5"></a><span id="l7.5">     MSG_NEWSPOSTURL_HEADER_ID,</span>
<a href="#l7.6"></a><span id="l7.6">     MSG_PRIORITY_HEADER_ID,</span>
<a href="#l7.7"></a><span id="l7.7">     MSG_CHARACTER_SET_HEADER_ID,</span>
<a href="#l7.8"></a><span id="l7.8">     MSG_MESSAGE_ID_HEADER_ID,</span>
<a href="#l7.9"></a><span id="l7.9">     MSG_X_TEMPLATE_HEADER_ID,</span>
<a href="#l7.10"></a><span id="l7.10">     MSG_DRAFT_ID_HEADER_ID,</span>
<a href="#l7.11"></a><span id="l7.11">     MSG_TEMPORARY_FILES_HEADER_ID,</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    MSG_SENDERREPLY_HEADER_ID,</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-    MSG_ALLREPLY_HEADER_ID,</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-    MSG_LISTREPLY_HEADER_ID,</span>
<a href="#l7.15"></a><span id="l7.15"> </span>
<a href="#l7.16"></a><span id="l7.16">     MSG_MAX_HEADERS   //Must be the last one.</span>
<a href="#l7.17"></a><span id="l7.17">   } MsgHeaderID;</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19">   nsresult SetAsciiHeader(MsgHeaderID header, const char *value);</span>
<a href="#l7.20"></a><span id="l7.20">   const char* GetAsciiHeader(MsgHeaderID header); //just return the address of the internal header variable, don't dispose it</span>
<a href="#l7.21"></a><span id="l7.21"> </span>
<a href="#l7.22"></a><span id="l7.22">   nsresult SetUnicodeHeader(MsgHeaderID header, const nsAString &amp;value);</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineat">@@ -133,25 +130,16 @@ public:</span>
<a href="#l7.24"></a><span id="l7.24">   nsresult SetOrganization(const char *value) {return SetAsciiHeader(MSG_ORGANIZATION_HEADER_ID, value);}</span>
<a href="#l7.25"></a><span id="l7.25">   const char* GetOrganization() {return GetAsciiHeader(MSG_ORGANIZATION_HEADER_ID);}</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27">   const char* GetReferences() {return GetAsciiHeader(MSG_REFERENCES_HEADER_ID);}</span>
<a href="#l7.28"></a><span id="l7.28"> </span>
<a href="#l7.29"></a><span id="l7.29">   nsresult SetOtherRandomHeaders(const char *value) {return SetAsciiHeader(MSG_OTHERRANDOMHEADERS_HEADER_ID, value);}</span>
<a href="#l7.30"></a><span id="l7.30">   const char* GetOtherRandomHeaders() {return GetAsciiHeader(MSG_OTHERRANDOMHEADERS_HEADER_ID);}</span>
<a href="#l7.31"></a><span id="l7.31"> </span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-  nsresult SetSenderReply(const char *value) {return SetAsciiHeader(MSG_SENDERREPLY_HEADER_ID, value);}</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-  const char* GetSenderReply() {return GetAsciiHeader(MSG_SENDERREPLY_HEADER_ID);}</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-  nsresult SetAllReply(const char *value) {return SetAsciiHeader(MSG_ALLREPLY_HEADER_ID, value);}</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-  const char* GetAllReply() {return GetAsciiHeader(MSG_ALLREPLY_HEADER_ID);}</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-  nsresult SetListReply(const char *value) {return SetAsciiHeader(MSG_LISTREPLY_HEADER_ID, value);}</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-  const char* GetListReply() {return GetAsciiHeader(MSG_LISTREPLY_HEADER_ID);}</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-</span>
<a href="#l7.41"></a><span id="l7.41">   const char* GetNewspostUrl() {return GetAsciiHeader(MSG_NEWSPOSTURL_HEADER_ID);}</span>
<a href="#l7.42"></a><span id="l7.42"> </span>
<a href="#l7.43"></a><span id="l7.43">   const char* GetPriority() {return GetAsciiHeader(MSG_PRIORITY_HEADER_ID);}</span>
<a href="#l7.44"></a><span id="l7.44"> </span>
<a href="#l7.45"></a><span id="l7.45">   const char* GetCharacterSet() {return GetAsciiHeader(MSG_CHARACTER_SET_HEADER_ID);}</span>
<a href="#l7.46"></a><span id="l7.46"> </span>
<a href="#l7.47"></a><span id="l7.47">   const char* GetMessageId() {return GetAsciiHeader(MSG_MESSAGE_ID_HEADER_ID);}</span>
<a href="#l7.48"></a><span id="l7.48"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -2009,137 +2009,16 @@ nsresult nsMsgCompose::CreateMessage(con</span>
<a href="#l8.4"></a><span id="l8.4">               PR_Free(uriList);</span>
<a href="#l8.5"></a><span id="l8.5">               return rv;</span>
<a href="#l8.6"></a><span id="l8.6">             }</span>
<a href="#l8.7"></a><span id="l8.7">             mQuotingToFollow = true;</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9">             subject.Insert(NS_LITERAL_STRING(&quot;Re: &quot;), 0);</span>
<a href="#l8.10"></a><span id="l8.10">             m_compFields-&gt;SetSubject(subject);</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-            nsCString author, authorEmailAddress;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-            msgHdr-&gt;GetAuthor(getter_Copies(author));</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-            nsCString recipients, recipientsEmailAddresses;</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-            msgHdr-&gt;GetRecipients(getter_Copies(recipients));</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-            nsCString ccList, ccListEmailAddresses;</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-            msgHdr-&gt;GetCcList(getter_Copies(ccList));</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-            nsCOMPtr&lt;nsIMsgHeaderParser&gt; parser (do_GetService(NS_MAILNEWS_MIME_HEADER_PARSER_CONTRACTID));</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-            if (parser) {</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-              // convert to UTF8 before passing to MakeFullAddress</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">-              rv = parser-&gt;ExtractHeaderAddressMailboxes(author,</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineminus">-                                                         authorEmailAddress);</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-              NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-              rv = parser-&gt;ExtractHeaderAddressMailboxes(recipients,</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-                                                         recipientsEmailAddresses);</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-              NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-              rv = parser-&gt;ExtractHeaderAddressMailboxes(ccList,</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-                                                         ccListEmailAddresses);</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-              NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-            }</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-            bool replyToSelfCheckAll = false;</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-            prefs-&gt;GetBoolPref(&quot;mailnews.reply_to_self_check_all_ident&quot;,</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-                               &amp;replyToSelfCheckAll);</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-            nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-            NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-            nsCOMPtr&lt;nsISupportsArray&gt; identities;</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-            nsCString accountKey;</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-            msgHdr-&gt;GetAccountKey(getter_Copies(accountKey));</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-            if(replyToSelfCheckAll)</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-            {</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-              // check all avaliable identities if the pref was set</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-              accountManager-&gt;GetAllIdentities(getter_AddRefs(identities));</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-            }</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-            else if (!accountKey.IsEmpty())</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-            {</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-               // check headers to see which account the message came in from (only works for pop3)</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-              nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-              accountManager-&gt;GetAccount(accountKey, getter_AddRefs(account));</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-              if(account)</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-                account-&gt;GetIdentities(getter_AddRefs(identities));</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-            }</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineminus">-            else</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineminus">-            {</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineminus">-              // check identities only for the server of the folder that the message is in</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-              nsCOMPtr &lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-              rv = msgHdr-&gt;GetFolder(getter_AddRefs(msgFolder));</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineminus">-              if (NS_SUCCEEDED(rv) &amp;&amp; msgFolder){</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-                nsCOMPtr&lt;nsIMsgIncomingServer&gt; nsIMsgIncomingServer;</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-                rv = msgFolder-&gt;GetServer(getter_AddRefs(nsIMsgIncomingServer));</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-                if(NS_SUCCEEDED(rv) &amp;&amp; nsIMsgIncomingServer)</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-                  accountManager-&gt;GetIdentitiesForServer(nsIMsgIncomingServer, getter_AddRefs(identities));</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-              }</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-            }</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-            bool isReplyToOwnMsg = false;</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-            if(identities)</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineminus">-            {</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-              // go through the identities to see if any of them is the author of the email</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-              nsCOMPtr&lt;nsIMsgIdentity&gt; lookupIdentity;</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">-              uint32_t count = 0;</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-              identities-&gt;Count(&amp;count);</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineminus">-              for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineminus">-              {</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-                rv = identities-&gt;QueryElementAt(i, NS_GET_IID(nsIMsgIdentity),</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-                                          getter_AddRefs(lookupIdentity));</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineminus">-                if (NS_FAILED(rv))</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineminus">-                  continue;</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineminus">-</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineminus">-                nsCString curIdentityEmail;</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineminus">-                lookupIdentity-&gt;GetEmail(curIdentityEmail);</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineminus">-</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineminus">-                // See if it's a reply to own message, but not a reply between identities.</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineminus">-                if (curIdentityEmail.Equals(authorEmailAddress))</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineminus">-                {</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineminus">-                  isReplyToOwnMsg = true;</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineminus">-                  // For a true reply-to-self, none of your identities are in To or CC.</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineminus">-                  for (uint32_t j = 0; j &lt; count; j++)</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineminus">-                  {</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineminus">-                    nsCOMPtr&lt;nsIMsgIdentity&gt; lookupIdentity2;</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineminus">-                    rv = identities-&gt;QueryElementAt(j, NS_GET_IID(nsIMsgIdentity),</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineminus">-                                                    getter_AddRefs(lookupIdentity2));</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineminus">-                    if (NS_FAILED(rv))</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineminus">-                      continue;</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineminus">-</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineminus">-                    nsCString curIdentityEmail2;</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineminus">-                    lookupIdentity2-&gt;GetEmail(curIdentityEmail2);</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineminus">-                    if (recipientsEmailAddresses.Find(curIdentityEmail2) != kNotFound ||</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineminus">-                        ccListEmailAddresses.Find(curIdentityEmail2) != kNotFound)</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineminus">-                    {</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineminus">-                      // An identity among the recipients -&gt; not reply-to-self.</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineminus">-                      isReplyToOwnMsg = false;</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineminus">-                      break;</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineminus">-                    }</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineminus">-                  }</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineminus">-                  break;</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-                }</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineminus">-              }</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineminus">-            }</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineminus">-</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineminus">-            nsCString toField;</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineminus">-            if (isReplyToOwnMsg)</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineminus">-              msgHdr-&gt;GetRecipients(getter_Copies(toField));</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineminus">-            else</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineminus">-              toField.Assign(author);</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineminus">-</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-            ConvertRawBytesToUTF8(toField, originCharset.get(), decodedCString);</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineminus">-            m_compFields-&gt;SetSenderReply(decodedCString.get());</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineminus">-            m_compFields-&gt;SetTo(decodedCString.get());</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineminus">-</span>
<a href="#l8.133"></a><span id="l8.133">             // Setup quoting callbacks for later...</span>
<a href="#l8.134"></a><span id="l8.134">             mWhatHolder = 1;</span>
<a href="#l8.135"></a><span id="l8.135">             break;</span>
<a href="#l8.136"></a><span id="l8.136">           }</span>
<a href="#l8.137"></a><span id="l8.137">         case nsIMsgCompType::ForwardAsAttachment:</span>
<a href="#l8.138"></a><span id="l8.138">           {</span>
<a href="#l8.139"></a><span id="l8.139">             // Add the forwarded message in the references, first</span>
<a href="#l8.140"></a><span id="l8.140">             nsAutoCString messageId;</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineat">@@ -2320,16 +2199,17 @@ QuotingOutputStreamListener::QuotingOutp</span>
<a href="#l8.142"></a><span id="l8.142">                                                          bool charetOverride,</span>
<a href="#l8.143"></a><span id="l8.143">                                                          bool quoteOriginal,</span>
<a href="#l8.144"></a><span id="l8.144">                                                          const nsACString&amp; htmlToQuote)</span>
<a href="#l8.145"></a><span id="l8.145"> {</span>
<a href="#l8.146"></a><span id="l8.146">   nsresult rv;</span>
<a href="#l8.147"></a><span id="l8.147">   mQuoteHeaders = quoteHeaders;</span>
<a href="#l8.148"></a><span id="l8.148">   mHeadersOnly = headersOnly;</span>
<a href="#l8.149"></a><span id="l8.149">   mIdentity = identity;</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+  mOrigMsgHdr = originalMsgHdr;</span>
<a href="#l8.151"></a><span id="l8.151">   mUnicodeBufferCharacterLength = 0;</span>
<a href="#l8.152"></a><span id="l8.152">   mUnicodeConversionBuffer = nullptr;</span>
<a href="#l8.153"></a><span id="l8.153">   mQuoteOriginal = quoteOriginal;</span>
<a href="#l8.154"></a><span id="l8.154">   mHtmlToQuote = htmlToQuote;</span>
<a href="#l8.155"></a><span id="l8.155"> </span>
<a href="#l8.156"></a><span id="l8.156">   if (!mHeadersOnly || !mHtmlToQuote.IsEmpty())</span>
<a href="#l8.157"></a><span id="l8.157">   {</span>
<a href="#l8.158"></a><span id="l8.158">     nsString replyHeaderOriginalmessage;</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineat">@@ -2554,386 +2434,489 @@ NS_IMETHODIMP QuotingOutputStreamListene</span>
<a href="#l8.160"></a><span id="l8.160">     // If we had a selection in the original message to quote, we can add</span>
<a href="#l8.161"></a><span id="l8.161">     // it now that we are done ignoring the original body of the message</span>
<a href="#l8.162"></a><span id="l8.162">     mHeadersOnly = false;</span>
<a href="#l8.163"></a><span id="l8.163">     rv = AppendToMsgBody(mHtmlToQuote);</span>
<a href="#l8.164"></a><span id="l8.164">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.165"></a><span id="l8.165">   }</span>
<a href="#l8.166"></a><span id="l8.166"> </span>
<a href="#l8.167"></a><span id="l8.167">   nsCOMPtr&lt;nsIMsgCompose&gt; compose = do_QueryReferent(mWeakComposeObj);</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineminus">-  if (compose)</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+  NS_ENSURE_TRUE(compose, NS_ERROR_NULL_POINTER);</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+  MSG_ComposeType type;</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+  compose-&gt;GetType(&amp;type);</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+  // Assign cite information if available...</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+  if (!mCiteReference.IsEmpty())</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+    compose-&gt;SetCiteReference(mCiteReference);</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+  if (mHeaders &amp;&amp; (type == nsIMsgCompType::Reply ||</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineplus">+                   type == nsIMsgCompType::ReplyAll ||</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineplus">+                   type == nsIMsgCompType::ReplyToList ||</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineplus">+                   type == nsIMsgCompType::ReplyToSender ||</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineplus">+                   type == nsIMsgCompType::ReplyToGroup ||</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineplus">+                   type == nsIMsgCompType::ReplyToSenderAndGroup) &amp;&amp;</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineplus">+      mQuoteOriginal)</span>
<a href="#l8.185"></a><span id="l8.185">   {</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineminus">-    MSG_ComposeType type;</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineminus">-    compose-&gt;GetType(&amp;type);</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineminus">-</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineminus">-    // Assign cite information if available...</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineminus">-    if (!mCiteReference.IsEmpty())</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineminus">-      compose-&gt;SetCiteReference(mCiteReference);</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineminus">-</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineminus">-    if (mHeaders &amp;&amp; (type == nsIMsgCompType::Reply ||</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineminus">-                     type == nsIMsgCompType::ReplyAll ||</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineminus">-                     type == nsIMsgCompType::ReplyToList ||</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineminus">-                     type == nsIMsgCompType::ReplyToSender ||</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineminus">-                     type == nsIMsgCompType::ReplyToGroup ||</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineminus">-                     type == nsIMsgCompType::ReplyToSenderAndGroup) &amp;&amp;</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineminus">-        mQuoteOriginal)</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineplus">+    nsCOMPtr&lt;nsIMsgCompFields&gt; compFields;</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineplus">+    compose-&gt;GetCompFields(getter_AddRefs(compFields));</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineplus">+    if (compFields)</span>
<a href="#l8.203"></a><span id="l8.203">     {</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineminus">-      nsCOMPtr&lt;nsIMsgCompFields&gt; compFields;</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineminus">-      compose-&gt;GetCompFields(getter_AddRefs(compFields));</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineminus">-      if (compFields)</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineplus">+      aCharset.AssignLiteral(&quot;UTF-8&quot;);</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineplus">+      nsAutoString from;</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineplus">+      nsAutoString to;</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineplus">+      nsAutoString cc;</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineplus">+      nsAutoString replyTo;</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineplus">+      nsAutoString mailReplyTo;</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineplus">+      nsAutoString mailFollowupTo;</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineplus">+      nsAutoString newgroups;</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineplus">+      nsAutoString followUpTo;</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineplus">+      nsAutoString messageId;</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineplus">+      nsAutoString references;</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineplus">+      nsAutoString listPost;</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineplus">+</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineplus">+      nsCString outCString; // Temp helper string.</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineplus">+</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineplus">+      bool needToRemoveDup = false;</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineplus">+      if (!mMimeConverter)</span>
<a href="#l8.224"></a><span id="l8.224">       {</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineminus">-        aCharset.AssignLiteral(&quot;UTF-8&quot;);</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineminus">-        nsAutoString recipient;</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineminus">-        nsAutoString cc;</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineminus">-        nsAutoString replyTo;</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineminus">-        nsAutoString mailReplyTo;</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineminus">-        nsAutoString mailFollowupTo;</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineminus">-        nsAutoString newgroups;</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineminus">-        nsAutoString followUpTo;</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineminus">-        nsAutoString messageId;</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineminus">-        nsAutoString references;</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineminus">-        nsAutoString listPost;</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineminus">-        nsAutoString replyCompValue;</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineminus">-        nsCString outCString;</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineminus">-        bool needToRemoveDup = false;</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineminus">-        if (!mMimeConverter)</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineminus">-        {</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineminus">-          mMimeConverter = do_GetService(NS_MIME_CONVERTER_CONTRACTID, &amp;rv);</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineminus">-          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineplus">+        mMimeConverter = do_GetService(NS_MIME_CONVERTER_CONTRACTID, &amp;rv);</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineplus">+      }</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineplus">+      nsCString charset;</span>
<a href="#l8.247"></a><span id="l8.247" class="difflineplus">+      compFields-&gt;GetCharacterSet(getter_Copies(charset));</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineplus">+</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineplus">+      mHeaders-&gt;ExtractHeader(HEADER_FROM, true, getter_Copies(outCString));</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineplus">+      ConvertRawBytesToUTF16(outCString, charset.get(), from);</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineplus">+</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineplus">+      mHeaders-&gt;ExtractHeader(HEADER_TO, true, getter_Copies(outCString));</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineplus">+      ConvertRawBytesToUTF16(outCString, charset.get(), to);</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineplus">+</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineplus">+      mHeaders-&gt;ExtractHeader(HEADER_CC, true, getter_Copies(outCString));</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineplus">+      ConvertRawBytesToUTF16(outCString, charset.get(), cc);</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineplus">+</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineplus">+      mHeaders-&gt;ExtractHeader(HEADER_MAIL_FOLLOWUP_TO, true,</span>
<a href="#l8.259"></a><span id="l8.259" class="difflineplus">+                              getter_Copies(outCString));</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineplus">+      ConvertRawBytesToUTF16(outCString, charset.get(), mailFollowupTo);</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineplus">+</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineplus">+      mHeaders-&gt;ExtractHeader(HEADER_REPLY_TO, false, getter_Copies(outCString));</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineplus">+      ConvertRawBytesToUTF16(outCString, charset.get(), replyTo);</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineplus">+</span>
<a href="#l8.265"></a><span id="l8.265" class="difflineplus">+      mHeaders-&gt;ExtractHeader(HEADER_MAIL_REPLY_TO, true, getter_Copies(outCString));</span>
<a href="#l8.266"></a><span id="l8.266" class="difflineplus">+      ConvertRawBytesToUTF16(outCString, charset.get(), mailReplyTo);</span>
<a href="#l8.267"></a><span id="l8.267" class="difflineplus">+</span>
<a href="#l8.268"></a><span id="l8.268" class="difflineplus">+      mHeaders-&gt;ExtractHeader(HEADER_NEWSGROUPS, false, getter_Copies(outCString));</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineplus">+      if (!outCString.IsEmpty())</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineplus">+        mMimeConverter-&gt;DecodeMimeHeader(outCString.get(), charset.get(),</span>
<a href="#l8.271"></a><span id="l8.271" class="difflineplus">+                                         false, true, newgroups);</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineplus">+</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineplus">+      mHeaders-&gt;ExtractHeader(HEADER_FOLLOWUP_TO, false, getter_Copies(outCString));</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineplus">+      if (!outCString.IsEmpty())</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineplus">+        mMimeConverter-&gt;DecodeMimeHeader(outCString.get(), charset.get(),</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineplus">+                                         false, true, followUpTo);</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineplus">+</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineplus">+      mHeaders-&gt;ExtractHeader(HEADER_MESSAGE_ID, false, getter_Copies(outCString));</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineplus">+      if (!outCString.IsEmpty())</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineplus">+        mMimeConverter-&gt;DecodeMimeHeader(outCString.get(), charset.get(),</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineplus">+                                         false, true, messageId);</span>
<a href="#l8.282"></a><span id="l8.282" class="difflineplus">+</span>
<a href="#l8.283"></a><span id="l8.283" class="difflineplus">+      mHeaders-&gt;ExtractHeader(HEADER_REFERENCES, false, getter_Copies(outCString));</span>
<a href="#l8.284"></a><span id="l8.284" class="difflineplus">+      if (!outCString.IsEmpty())</span>
<a href="#l8.285"></a><span id="l8.285" class="difflineplus">+        mMimeConverter-&gt;DecodeMimeHeader(outCString.get(), charset.get(),</span>
<a href="#l8.286"></a><span id="l8.286" class="difflineplus">+                                         false, true, references);</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineplus">+</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineplus">+      nsCOMPtr&lt;nsIMsgHeaderParser&gt; parser =</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineplus">+        do_GetService(NS_MAILNEWS_MIME_HEADER_PARSER_CONTRACTID, &amp;rv);</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.291"></a><span id="l8.291" class="difflineplus">+</span>
<a href="#l8.292"></a><span id="l8.292" class="difflineplus">+      nsCString fromEmailAddress;</span>
<a href="#l8.293"></a><span id="l8.293" class="difflineplus">+      rv = parser-&gt;ExtractHeaderAddressMailboxes(NS_ConvertUTF16toUTF8(from),</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineplus">+                                                 fromEmailAddress);</span>
<a href="#l8.295"></a><span id="l8.295" class="difflineplus">+      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineplus">+</span>
<a href="#l8.297"></a><span id="l8.297" class="difflineplus">+      nsCString toEmailAddresses;</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineplus">+      rv = parser-&gt;ExtractHeaderAddressMailboxes(NS_ConvertUTF16toUTF8(to),</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineplus">+                                                 toEmailAddresses);</span>
<a href="#l8.300"></a><span id="l8.300" class="difflineplus">+      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.301"></a><span id="l8.301" class="difflineplus">+</span>
<a href="#l8.302"></a><span id="l8.302" class="difflineplus">+      nsCString  ccEmailAddresses;</span>
<a href="#l8.303"></a><span id="l8.303" class="difflineplus">+      rv = parser-&gt;ExtractHeaderAddressMailboxes(NS_ConvertUTF16toUTF8(cc),</span>
<a href="#l8.304"></a><span id="l8.304" class="difflineplus">+                                                 ccEmailAddresses);</span>
<a href="#l8.305"></a><span id="l8.305" class="difflineplus">+      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.306"></a><span id="l8.306" class="difflineplus">+</span>
<a href="#l8.307"></a><span id="l8.307" class="difflineplus">+      nsCOMPtr&lt;nsIPrefBranch&gt; prefs (do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l8.308"></a><span id="l8.308" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.309"></a><span id="l8.309" class="difflineplus">+      bool replyToSelfCheckAll = false;</span>
<a href="#l8.310"></a><span id="l8.310" class="difflineplus">+      prefs-&gt;GetBoolPref(&quot;mailnews.reply_to_self_check_all_ident&quot;,</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineplus">+                         &amp;replyToSelfCheckAll);</span>
<a href="#l8.312"></a><span id="l8.312" class="difflineplus">+</span>
<a href="#l8.313"></a><span id="l8.313" class="difflineplus">+      nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l8.314"></a><span id="l8.314" class="difflineplus">+        do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l8.315"></a><span id="l8.315" class="difflineplus">+      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.316"></a><span id="l8.316" class="difflineplus">+</span>
<a href="#l8.317"></a><span id="l8.317" class="difflineplus">+      nsCOMPtr&lt;nsISupportsArray&gt; identities;</span>
<a href="#l8.318"></a><span id="l8.318" class="difflineplus">+      nsCString accountKey;</span>
<a href="#l8.319"></a><span id="l8.319" class="difflineplus">+      mOrigMsgHdr-&gt;GetAccountKey(getter_Copies(accountKey));</span>
<a href="#l8.320"></a><span id="l8.320" class="difflineplus">+      if (replyToSelfCheckAll)</span>
<a href="#l8.321"></a><span id="l8.321" class="difflineplus">+      {</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineplus">+        // Check all avaliable identities if the pref was set.</span>
<a href="#l8.323"></a><span id="l8.323" class="difflineplus">+        accountManager-&gt;GetAllIdentities(getter_AddRefs(identities));</span>
<a href="#l8.324"></a><span id="l8.324" class="difflineplus">+      }</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineplus">+      else if (!accountKey.IsEmpty())</span>
<a href="#l8.326"></a><span id="l8.326" class="difflineplus">+      {</span>
<a href="#l8.327"></a><span id="l8.327" class="difflineplus">+         // Check headers to see which account the message came in from</span>
<a href="#l8.328"></a><span id="l8.328" class="difflineplus">+         // (only works for pop3).</span>
<a href="#l8.329"></a><span id="l8.329" class="difflineplus">+        nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l8.330"></a><span id="l8.330" class="difflineplus">+        accountManager-&gt;GetAccount(accountKey, getter_AddRefs(account));</span>
<a href="#l8.331"></a><span id="l8.331" class="difflineplus">+</span>
<a href="#l8.332"></a><span id="l8.332" class="difflineplus">+        if (account)</span>
<a href="#l8.333"></a><span id="l8.333" class="difflineplus">+          account-&gt;GetIdentities(getter_AddRefs(identities));</span>
<a href="#l8.334"></a><span id="l8.334" class="difflineplus">+      }</span>
<a href="#l8.335"></a><span id="l8.335" class="difflineplus">+      else</span>
<a href="#l8.336"></a><span id="l8.336" class="difflineplus">+      {</span>
<a href="#l8.337"></a><span id="l8.337" class="difflineplus">+        // Check identities only for the server of the folder that the message</span>
<a href="#l8.338"></a><span id="l8.338" class="difflineplus">+        // is in.</span>
<a href="#l8.339"></a><span id="l8.339" class="difflineplus">+        nsCOMPtr &lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l8.340"></a><span id="l8.340" class="difflineplus">+        rv = mOrigMsgHdr-&gt;GetFolder(getter_AddRefs(msgFolder));</span>
<a href="#l8.341"></a><span id="l8.341" class="difflineplus">+</span>
<a href="#l8.342"></a><span id="l8.342" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; msgFolder){</span>
<a href="#l8.343"></a><span id="l8.343" class="difflineplus">+          nsCOMPtr&lt;nsIMsgIncomingServer&gt; nsIMsgIncomingServer;</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineplus">+          rv = msgFolder-&gt;GetServer(getter_AddRefs(nsIMsgIncomingServer));</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineplus">+</span>
<a href="#l8.346"></a><span id="l8.346" class="difflineplus">+          if (NS_SUCCEEDED(rv) &amp;&amp; nsIMsgIncomingServer)</span>
<a href="#l8.347"></a><span id="l8.347" class="difflineplus">+            accountManager-&gt;GetIdentitiesForServer(nsIMsgIncomingServer, getter_AddRefs(identities));</span>
<a href="#l8.348"></a><span id="l8.348">         }</span>
<a href="#l8.349"></a><span id="l8.349" class="difflineminus">-        nsCString charset;</span>
<a href="#l8.350"></a><span id="l8.350" class="difflineminus">-        compFields-&gt;GetCharacterSet(getter_Copies(charset));</span>
<a href="#l8.351"></a><span id="l8.351" class="difflineminus">-</span>
<a href="#l8.352"></a><span id="l8.352" class="difflineminus">-        // Populate the AllReply compField.</span>
<a href="#l8.353"></a><span id="l8.353" class="difflineminus">-        mHeaders-&gt;ExtractHeader(HEADER_TO, true, getter_Copies(outCString));</span>
<a href="#l8.354"></a><span id="l8.354" class="difflineminus">-        ConvertRawBytesToUTF16(outCString, charset.get(), recipient);</span>
<a href="#l8.355"></a><span id="l8.355" class="difflineminus">-</span>
<a href="#l8.356"></a><span id="l8.356" class="difflineminus">-        mHeaders-&gt;ExtractHeader(HEADER_CC, true, getter_Copies(outCString));</span>
<a href="#l8.357"></a><span id="l8.357" class="difflineminus">-        ConvertRawBytesToUTF16(outCString, charset.get(), cc);</span>
<a href="#l8.358"></a><span id="l8.358" class="difflineminus">-</span>
<a href="#l8.359"></a><span id="l8.359" class="difflineminus">-        mHeaders-&gt;ExtractHeader(HEADER_MAIL_FOLLOWUP_TO, true,</span>
<a href="#l8.360"></a><span id="l8.360" class="difflineminus">-                                getter_Copies(outCString));</span>
<a href="#l8.361"></a><span id="l8.361" class="difflineminus">-        ConvertRawBytesToUTF16(outCString, charset.get(), mailFollowupTo);</span>
<a href="#l8.362"></a><span id="l8.362" class="difflineminus">-        if (! mailFollowupTo.IsEmpty())</span>
<a href="#l8.363"></a><span id="l8.363" class="difflineplus">+      }</span>
<a href="#l8.364"></a><span id="l8.364" class="difflineplus">+</span>
<a href="#l8.365"></a><span id="l8.365" class="difflineplus">+      bool isReplyToSelf = false;</span>
<a href="#l8.366"></a><span id="l8.366" class="difflineplus">+      if (identities)</span>
<a href="#l8.367"></a><span id="l8.367" class="difflineplus">+      {</span>
<a href="#l8.368"></a><span id="l8.368" class="difflineplus">+        // Go through the identities to see if any of them is the author of</span>
<a href="#l8.369"></a><span id="l8.369" class="difflineplus">+        // the email.</span>
<a href="#l8.370"></a><span id="l8.370" class="difflineplus">+        nsCOMPtr&lt;nsIMsgIdentity&gt; lookupIdentity;</span>
<a href="#l8.371"></a><span id="l8.371" class="difflineplus">+</span>
<a href="#l8.372"></a><span id="l8.372" class="difflineplus">+        uint32_t count = 0;</span>
<a href="#l8.373"></a><span id="l8.373" class="difflineplus">+        identities-&gt;Count(&amp;count);</span>
<a href="#l8.374"></a><span id="l8.374" class="difflineplus">+</span>
<a href="#l8.375"></a><span id="l8.375" class="difflineplus">+        for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l8.376"></a><span id="l8.376">         {</span>
<a href="#l8.377"></a><span id="l8.377" class="difflineminus">-          // handle Mail-Followup-To (http://cr.yp.to/proto/replyto.html)</span>
<a href="#l8.378"></a><span id="l8.378" class="difflineminus">-          compFields-&gt;SetAllReply(mailFollowupTo);</span>
<a href="#l8.379"></a><span id="l8.379" class="difflineplus">+          rv = identities-&gt;QueryElementAt(i, NS_GET_IID(nsIMsgIdentity),</span>
<a href="#l8.380"></a><span id="l8.380" class="difflineplus">+                                    getter_AddRefs(lookupIdentity));</span>
<a href="#l8.381"></a><span id="l8.381" class="difflineplus">+          if (NS_FAILED(rv))</span>
<a href="#l8.382"></a><span id="l8.382" class="difflineplus">+            continue;</span>
<a href="#l8.383"></a><span id="l8.383" class="difflineplus">+</span>
<a href="#l8.384"></a><span id="l8.384" class="difflineplus">+          nsCString curIdentityEmail;</span>
<a href="#l8.385"></a><span id="l8.385" class="difflineplus">+          lookupIdentity-&gt;GetEmail(curIdentityEmail);</span>
<a href="#l8.386"></a><span id="l8.386" class="difflineplus">+</span>
<a href="#l8.387"></a><span id="l8.387" class="difflineplus">+          // See if it's a reply to own message, but not a reply between identities.</span>
<a href="#l8.388"></a><span id="l8.388" class="difflineplus">+          if (curIdentityEmail.Equals(fromEmailAddress))</span>
<a href="#l8.389"></a><span id="l8.389" class="difflineplus">+          {</span>
<a href="#l8.390"></a><span id="l8.390" class="difflineplus">+            isReplyToSelf = true;</span>
<a href="#l8.391"></a><span id="l8.391" class="difflineplus">+            // For a true reply-to-self, none of your identities are in To or CC.</span>
<a href="#l8.392"></a><span id="l8.392" class="difflineplus">+            for (uint32_t j = 0; j &lt; count; j++)</span>
<a href="#l8.393"></a><span id="l8.393" class="difflineplus">+            {</span>
<a href="#l8.394"></a><span id="l8.394" class="difflineplus">+              nsCOMPtr&lt;nsIMsgIdentity&gt; lookupIdentity2;</span>
<a href="#l8.395"></a><span id="l8.395" class="difflineplus">+              rv = identities-&gt;QueryElementAt(j, NS_GET_IID(nsIMsgIdentity),</span>
<a href="#l8.396"></a><span id="l8.396" class="difflineplus">+                                              getter_AddRefs(lookupIdentity2));</span>
<a href="#l8.397"></a><span id="l8.397" class="difflineplus">+              if (NS_FAILED(rv))</span>
<a href="#l8.398"></a><span id="l8.398" class="difflineplus">+                continue;</span>
<a href="#l8.399"></a><span id="l8.399" class="difflineplus">+</span>
<a href="#l8.400"></a><span id="l8.400" class="difflineplus">+              nsCString curIdentityEmail2;</span>
<a href="#l8.401"></a><span id="l8.401" class="difflineplus">+              lookupIdentity2-&gt;GetEmail(curIdentityEmail2);</span>
<a href="#l8.402"></a><span id="l8.402" class="difflineplus">+              if (toEmailAddresses.Find(curIdentityEmail2) != kNotFound ||</span>
<a href="#l8.403"></a><span id="l8.403" class="difflineplus">+                  ccEmailAddresses.Find(curIdentityEmail2) != kNotFound)</span>
<a href="#l8.404"></a><span id="l8.404" class="difflineplus">+              {</span>
<a href="#l8.405"></a><span id="l8.405" class="difflineplus">+                // An identity among the recipients -&gt; not reply-to-self.</span>
<a href="#l8.406"></a><span id="l8.406" class="difflineplus">+                isReplyToSelf = false;</span>
<a href="#l8.407"></a><span id="l8.407" class="difflineplus">+                break;</span>
<a href="#l8.408"></a><span id="l8.408" class="difflineplus">+              }</span>
<a href="#l8.409"></a><span id="l8.409" class="difflineplus">+            }</span>
<a href="#l8.410"></a><span id="l8.410" class="difflineplus">+            break;</span>
<a href="#l8.411"></a><span id="l8.411" class="difflineplus">+          }</span>
<a href="#l8.412"></a><span id="l8.412">         }</span>
<a href="#l8.413"></a><span id="l8.413" class="difflineminus">-        else</span>
<a href="#l8.414"></a><span id="l8.414" class="difflineplus">+      }</span>
<a href="#l8.415"></a><span id="l8.415" class="difflineplus">+</span>
<a href="#l8.416"></a><span id="l8.416" class="difflineplus">+      if (type == nsIMsgCompType::ReplyToSender || type == nsIMsgCompType::Reply)</span>
<a href="#l8.417"></a><span id="l8.417" class="difflineplus">+      {</span>
<a href="#l8.418"></a><span id="l8.418" class="difflineplus">+        if (isReplyToSelf)</span>
<a href="#l8.419"></a><span id="l8.419" class="difflineplus">+        {</span>
<a href="#l8.420"></a><span id="l8.420" class="difflineplus">+          compFields-&gt;SetTo(to);</span>
<a href="#l8.421"></a><span id="l8.421" class="difflineplus">+        }</span>
<a href="#l8.422"></a><span id="l8.422" class="difflineplus">+        else if (!mailReplyTo.IsEmpty())</span>
<a href="#l8.423"></a><span id="l8.423" class="difflineplus">+        {</span>
<a href="#l8.424"></a><span id="l8.424" class="difflineplus">+          // handle Mail-Reply-To (http://cr.yp.to/proto/replyto.html)</span>
<a href="#l8.425"></a><span id="l8.425" class="difflineplus">+          compFields-&gt;SetTo(mailReplyTo);</span>
<a href="#l8.426"></a><span id="l8.426" class="difflineplus">+          needToRemoveDup = true;</span>
<a href="#l8.427"></a><span id="l8.427" class="difflineplus">+        }</span>
<a href="#l8.428"></a><span id="l8.428" class="difflineplus">+        else if (!replyTo.IsEmpty())</span>
<a href="#l8.429"></a><span id="l8.429">         {</span>
<a href="#l8.430"></a><span id="l8.430" class="difflineplus">+          // default behaviour for messages without Mail-Reply-To</span>
<a href="#l8.431"></a><span id="l8.431" class="difflineplus">+          compFields-&gt;SetTo(replyTo);</span>
<a href="#l8.432"></a><span id="l8.432" class="difflineplus">+          needToRemoveDup = true;</span>
<a href="#l8.433"></a><span id="l8.433" class="difflineplus">+        }</span>
<a href="#l8.434"></a><span id="l8.434" class="difflineplus">+        else {</span>
<a href="#l8.435"></a><span id="l8.435" class="difflineplus">+          compFields-&gt;SetTo(from);</span>
<a href="#l8.436"></a><span id="l8.436" class="difflineplus">+        }</span>
<a href="#l8.437"></a><span id="l8.437" class="difflineplus">+      }</span>
<a href="#l8.438"></a><span id="l8.438" class="difflineplus">+      else if (type == nsIMsgCompType::ReplyAll)</span>
<a href="#l8.439"></a><span id="l8.439" class="difflineplus">+      {</span>
<a href="#l8.440"></a><span id="l8.440" class="difflineplus">+        if (isReplyToSelf)</span>
<a href="#l8.441"></a><span id="l8.441" class="difflineplus">+        {</span>
<a href="#l8.442"></a><span id="l8.442" class="difflineplus">+          compFields-&gt;SetTo(to);</span>
<a href="#l8.443"></a><span id="l8.443" class="difflineplus">+         compFields-&gt;SetCc(cc);</span>
<a href="#l8.444"></a><span id="l8.444" class="difflineplus">+        }</span>
<a href="#l8.445"></a><span id="l8.445" class="difflineplus">+        else if (mailFollowupTo.IsEmpty()) {</span>
<a href="#l8.446"></a><span id="l8.446">           // default behaviour for messages without Mail-Followup-To</span>
<a href="#l8.447"></a><span id="l8.447" class="difflineminus">-          compFields-&gt;GetTo(replyCompValue);</span>
<a href="#l8.448"></a><span id="l8.448" class="difflineminus">-          if (!replyCompValue.IsEmpty() &amp;&amp; !recipient.IsEmpty())</span>
<a href="#l8.449"></a><span id="l8.449" class="difflineminus">-            replyCompValue.AppendLiteral(&quot;, &quot;);</span>
<a href="#l8.450"></a><span id="l8.450" class="difflineminus">-          replyCompValue.Append(recipient);</span>
<a href="#l8.451"></a><span id="l8.451" class="difflineminus">-          if (!replyCompValue.IsEmpty() &amp;&amp; !cc.IsEmpty())</span>
<a href="#l8.452"></a><span id="l8.452" class="difflineminus">-            replyCompValue.AppendLiteral(&quot;, &quot;);</span>
<a href="#l8.453"></a><span id="l8.453" class="difflineminus">-          replyCompValue.Append(cc);</span>
<a href="#l8.454"></a><span id="l8.454" class="difflineminus">-          compFields-&gt;SetAllReply(replyCompValue);</span>
<a href="#l8.455"></a><span id="l8.455" class="difflineminus">-        }</span>
<a href="#l8.456"></a><span id="l8.456" class="difflineminus">-</span>
<a href="#l8.457"></a><span id="l8.457" class="difflineminus">-        if (type == nsIMsgCompType::ReplyAll)</span>
<a href="#l8.458"></a><span id="l8.458" class="difflineminus">-        {</span>
<a href="#l8.459"></a><span id="l8.459" class="difflineminus">-          // preserve BCC for the reply-to-self case</span>
<a href="#l8.460"></a><span id="l8.460" class="difflineminus">-          mHeaders-&gt;ExtractHeader(HEADER_BCC, true, getter_Copies(outCString));</span>
<a href="#l8.461"></a><span id="l8.461" class="difflineminus">-          if (!outCString.IsEmpty())</span>
<a href="#l8.462"></a><span id="l8.462" class="difflineplus">+</span>
<a href="#l8.463"></a><span id="l8.463" class="difflineplus">+          nsAutoString allTo;</span>
<a href="#l8.464"></a><span id="l8.464" class="difflineplus">+          if (!replyTo.IsEmpty())</span>
<a href="#l8.465"></a><span id="l8.465">           {</span>
<a href="#l8.466"></a><span id="l8.466" class="difflineminus">-            nsAutoString bcc;</span>
<a href="#l8.467"></a><span id="l8.467" class="difflineminus">-            ConvertRawBytesToUTF16(outCString, charset.get(), bcc);</span>
<a href="#l8.468"></a><span id="l8.468" class="difflineminus">-            compFields-&gt;SetBcc(bcc);</span>
<a href="#l8.469"></a><span id="l8.469" class="difflineminus">-          }</span>
<a href="#l8.470"></a><span id="l8.470" class="difflineminus">-</span>
<a href="#l8.471"></a><span id="l8.471" class="difflineminus">-          if (! mailFollowupTo.IsEmpty())</span>
<a href="#l8.472"></a><span id="l8.472" class="difflineminus">-          {</span>
<a href="#l8.473"></a><span id="l8.473" class="difflineminus">-            // handle Mail-Followup-To (http://cr.yp.to/proto/replyto.html)</span>
<a href="#l8.474"></a><span id="l8.474" class="difflineminus">-            compFields-&gt;SetTo(mailFollowupTo);</span>
<a href="#l8.475"></a><span id="l8.475" class="difflineplus">+            // default behaviour for messages without Mail-Reply-To</span>
<a href="#l8.476"></a><span id="l8.476" class="difflineplus">+            allTo.Assign(replyTo);</span>
<a href="#l8.477"></a><span id="l8.477" class="difflineplus">+            needToRemoveDup = true;</span>
<a href="#l8.478"></a><span id="l8.478">           }</span>
<a href="#l8.479"></a><span id="l8.479">           else</span>
<a href="#l8.480"></a><span id="l8.480">           {</span>
<a href="#l8.481"></a><span id="l8.481" class="difflineminus">-            // default behaviour for messages without Mail-Followup-To</span>
<a href="#l8.482"></a><span id="l8.482" class="difflineminus">-            nsAutoString outCCListString;</span>
<a href="#l8.483"></a><span id="l8.483" class="difflineminus">-            compFields-&gt;GetCc(outCCListString);</span>
<a href="#l8.484"></a><span id="l8.484" class="difflineminus">-</span>
<a href="#l8.485"></a><span id="l8.485" class="difflineminus">-            if (!replyCompValue.IsEmpty() &amp;&amp; !outCCListString.IsEmpty())</span>
<a href="#l8.486"></a><span id="l8.486" class="difflineminus">-              replyCompValue.AppendLiteral(&quot;, &quot;);</span>
<a href="#l8.487"></a><span id="l8.487" class="difflineminus">-</span>
<a href="#l8.488"></a><span id="l8.488" class="difflineminus">-            replyCompValue.Append(outCCListString);</span>
<a href="#l8.489"></a><span id="l8.489" class="difflineminus">-            compFields-&gt;SetCc(replyCompValue);</span>
<a href="#l8.490"></a><span id="l8.490" class="difflineplus">+            allTo.Assign(from);</span>
<a href="#l8.491"></a><span id="l8.491">           }</span>
<a href="#l8.492"></a><span id="l8.492"> </span>
<a href="#l8.493"></a><span id="l8.493" class="difflineplus">+          allTo.AppendLiteral(&quot;, &quot;);</span>
<a href="#l8.494"></a><span id="l8.494" class="difflineplus">+          allTo.Append(to);</span>
<a href="#l8.495"></a><span id="l8.495" class="difflineplus">+          compFields-&gt;SetTo(allTo);</span>
<a href="#l8.496"></a><span id="l8.496" class="difflineplus">+</span>
<a href="#l8.497"></a><span id="l8.497" class="difflineplus">+          nsAutoString allCc;</span>
<a href="#l8.498"></a><span id="l8.498" class="difflineplus">+          compFields-&gt;GetCc(allCc); // auto-cc</span>
<a href="#l8.499"></a><span id="l8.499" class="difflineplus">+          if (!allCc.IsEmpty())</span>
<a href="#l8.500"></a><span id="l8.500" class="difflineplus">+            allCc.AppendLiteral(&quot;, &quot;);</span>
<a href="#l8.501"></a><span id="l8.501" class="difflineplus">+          allCc.Append(cc);</span>
<a href="#l8.502"></a><span id="l8.502" class="difflineplus">+          compFields-&gt;SetCc(allCc);</span>
<a href="#l8.503"></a><span id="l8.503" class="difflineplus">+</span>
<a href="#l8.504"></a><span id="l8.504">           needToRemoveDup = true;</span>
<a href="#l8.505"></a><span id="l8.505">         }</span>
<a href="#l8.506"></a><span id="l8.506" class="difflineminus">-</span>
<a href="#l8.507"></a><span id="l8.507" class="difflineminus">-        mHeaders-&gt;ExtractHeader(HEADER_LIST_POST, true, getter_Copies(outCString));</span>
<a href="#l8.508"></a><span id="l8.508" class="difflineminus">-        if (!outCString.IsEmpty())</span>
<a href="#l8.509"></a><span id="l8.509" class="difflineminus">-          mMimeConverter-&gt;DecodeMimeHeader(outCString.get(), charset.get(),</span>
<a href="#l8.510"></a><span id="l8.510" class="difflineminus">-                                           false, true, listPost);</span>
<a href="#l8.511"></a><span id="l8.511" class="difflineminus">-</span>
<a href="#l8.512"></a><span id="l8.512" class="difflineminus">-        if (!listPost.IsEmpty())</span>
<a href="#l8.513"></a><span id="l8.513" class="difflineplus">+        else</span>
<a href="#l8.514"></a><span id="l8.514">         {</span>
<a href="#l8.515"></a><span id="l8.515" class="difflineminus">-          int32_t startPos = listPost.Find(&quot;&lt;mailto:&quot;);</span>
<a href="#l8.516"></a><span id="l8.516" class="difflineminus">-          int32_t endPos = listPost.FindChar('&gt;', startPos);</span>
<a href="#l8.517"></a><span id="l8.517" class="difflineminus">-          // Extract the e-mail address.</span>
<a href="#l8.518"></a><span id="l8.518" class="difflineminus">-          if (endPos &gt; startPos)</span>
<a href="#l8.519"></a><span id="l8.519" class="difflineminus">-          {</span>
<a href="#l8.520"></a><span id="l8.520" class="difflineminus">-            const uint32_t mailtoLen = strlen(&quot;&lt;mailto:&quot;);</span>
<a href="#l8.521"></a><span id="l8.521" class="difflineminus">-            listPost = Substring(listPost, startPos + mailtoLen, endPos - (startPos + mailtoLen));</span>
<a href="#l8.522"></a><span id="l8.522" class="difflineminus">-            compFields-&gt;SetListReply(listPost);</span>
<a href="#l8.523"></a><span id="l8.523" class="difflineminus">-            if (type == nsIMsgCompType::ReplyToList)</span>
<a href="#l8.524"></a><span id="l8.524" class="difflineminus">-              compFields-&gt;SetTo(listPost);</span>
<a href="#l8.525"></a><span id="l8.525" class="difflineminus">-          }</span>
<a href="#l8.526"></a><span id="l8.526" class="difflineplus">+          // handle Mail-Followup-To (http://cr.yp.to/proto/replyto.html)</span>
<a href="#l8.527"></a><span id="l8.527" class="difflineplus">+</span>
<a href="#l8.528"></a><span id="l8.528" class="difflineplus">+          compFields-&gt;SetTo(mailFollowupTo);</span>
<a href="#l8.529"></a><span id="l8.529" class="difflineplus">+          compFields-&gt;SetCc(EmptyString());</span>
<a href="#l8.530"></a><span id="l8.530">         }</span>
<a href="#l8.531"></a><span id="l8.531"> </span>
<a href="#l8.532"></a><span id="l8.532" class="difflineminus">-        mHeaders-&gt;ExtractHeader(HEADER_REPLY_TO, false, getter_Copies(outCString));</span>
<a href="#l8.533"></a><span id="l8.533" class="difflineminus">-        ConvertRawBytesToUTF16(outCString, charset.get(), replyTo);</span>
<a href="#l8.534"></a><span id="l8.534" class="difflineminus">-        mHeaders-&gt;ExtractHeader(HEADER_MAIL_REPLY_TO, true, getter_Copies(outCString));</span>
<a href="#l8.535"></a><span id="l8.535" class="difflineminus">-        ConvertRawBytesToUTF16(outCString, charset.get(), mailReplyTo);</span>
<a href="#l8.536"></a><span id="l8.536" class="difflineminus">-</span>
<a href="#l8.537"></a><span id="l8.537" class="difflineminus">-        mHeaders-&gt;ExtractHeader(HEADER_NEWSGROUPS, false, getter_Copies(outCString));</span>
<a href="#l8.538"></a><span id="l8.538" class="difflineplus">+        // Preserve BCC for the reply-to-self case (can be known if replying</span>
<a href="#l8.539"></a><span id="l8.539" class="difflineplus">+        // from the Sent folder).</span>
<a href="#l8.540"></a><span id="l8.540" class="difflineplus">+        mHeaders-&gt;ExtractHeader(HEADER_BCC, true, getter_Copies(outCString));</span>
<a href="#l8.541"></a><span id="l8.541">         if (!outCString.IsEmpty())</span>
<a href="#l8.542"></a><span id="l8.542" class="difflineminus">-          mMimeConverter-&gt;DecodeMimeHeader(outCString.get(), charset.get(),</span>
<a href="#l8.543"></a><span id="l8.543" class="difflineminus">-                                           false, true, newgroups);</span>
<a href="#l8.544"></a><span id="l8.544" class="difflineminus">-</span>
<a href="#l8.545"></a><span id="l8.545" class="difflineminus">-        mHeaders-&gt;ExtractHeader(HEADER_FOLLOWUP_TO, false, getter_Copies(outCString));</span>
<a href="#l8.546"></a><span id="l8.546" class="difflineminus">-        if (!outCString.IsEmpty())</span>
<a href="#l8.547"></a><span id="l8.547" class="difflineminus">-          mMimeConverter-&gt;DecodeMimeHeader(outCString.get(), charset.get(),</span>
<a href="#l8.548"></a><span id="l8.548" class="difflineminus">-                                           false, true, followUpTo);</span>
<a href="#l8.549"></a><span id="l8.549" class="difflineminus">-</span>
<a href="#l8.550"></a><span id="l8.550" class="difflineminus">-        mHeaders-&gt;ExtractHeader(HEADER_MESSAGE_ID, false, getter_Copies(outCString));</span>
<a href="#l8.551"></a><span id="l8.551" class="difflineminus">-        if (!outCString.IsEmpty())</span>
<a href="#l8.552"></a><span id="l8.552" class="difflineminus">-          mMimeConverter-&gt;DecodeMimeHeader(outCString.get(), charset.get(),</span>
<a href="#l8.553"></a><span id="l8.553" class="difflineminus">-                                           false, true, messageId);</span>
<a href="#l8.554"></a><span id="l8.554" class="difflineminus">-</span>
<a href="#l8.555"></a><span id="l8.555" class="difflineminus">-        mHeaders-&gt;ExtractHeader(HEADER_REFERENCES, false, getter_Copies(outCString));</span>
<a href="#l8.556"></a><span id="l8.556" class="difflineminus">-        if (!outCString.IsEmpty())</span>
<a href="#l8.557"></a><span id="l8.557" class="difflineminus">-          mMimeConverter-&gt;DecodeMimeHeader(outCString.get(), charset.get(),</span>
<a href="#l8.558"></a><span id="l8.558" class="difflineminus">-                                           false, true, references);</span>
<a href="#l8.559"></a><span id="l8.559" class="difflineminus">-</span>
<a href="#l8.560"></a><span id="l8.560" class="difflineminus">-        if (! mailReplyTo.IsEmpty())</span>
<a href="#l8.561"></a><span id="l8.561" class="difflineplus">+        {</span>
<a href="#l8.562"></a><span id="l8.562" class="difflineplus">+          nsAutoString bcc;</span>
<a href="#l8.563"></a><span id="l8.563" class="difflineplus">+          ConvertRawBytesToUTF16(outCString, charset.get(), bcc);</span>
<a href="#l8.564"></a><span id="l8.564" class="difflineplus">+          compFields-&gt;SetBcc(bcc);</span>
<a href="#l8.565"></a><span id="l8.565" class="difflineplus">+        }</span>
<a href="#l8.566"></a><span id="l8.566" class="difflineplus">+      }</span>
<a href="#l8.567"></a><span id="l8.567" class="difflineplus">+      else if (type == nsIMsgCompType::ReplyToList)</span>
<a href="#l8.568"></a><span id="l8.568" class="difflineplus">+      {</span>
<a href="#l8.569"></a><span id="l8.569" class="difflineplus">+        if (isReplyToSelf)</span>
<a href="#l8.570"></a><span id="l8.570">         {</span>
<a href="#l8.571"></a><span id="l8.571" class="difflineminus">-          // handle Mail-Reply-To (http://cr.yp.to/proto/replyto.html)</span>
<a href="#l8.572"></a><span id="l8.572" class="difflineminus">-          compFields-&gt;SetSenderReply(mailReplyTo);</span>
<a href="#l8.573"></a><span id="l8.573" class="difflineminus">-          needToRemoveDup = true;</span>
<a href="#l8.574"></a><span id="l8.574" class="difflineplus">+          compFields-&gt;SetTo(to);</span>
<a href="#l8.575"></a><span id="l8.575">         }</span>
<a href="#l8.576"></a><span id="l8.576" class="difflineminus">-        else if (! replyTo.IsEmpty())</span>
<a href="#l8.577"></a><span id="l8.577" class="difflineminus">-        {</span>
<a href="#l8.578"></a><span id="l8.578" class="difflineminus">-          // default behaviour for messages without Mail-Reply-To</span>
<a href="#l8.579"></a><span id="l8.579" class="difflineminus">-          compFields-&gt;SetSenderReply(replyTo);</span>
<a href="#l8.580"></a><span id="l8.580" class="difflineminus">-        }</span>
<a href="#l8.581"></a><span id="l8.581" class="difflineminus">-</span>
<a href="#l8.582"></a><span id="l8.582" class="difflineminus">-        if (! ((type == nsIMsgCompType::ReplyAll) &amp;&amp; ! mailFollowupTo.IsEmpty()) &amp;&amp;</span>
<a href="#l8.583"></a><span id="l8.583" class="difflineminus">-            ! ((type == nsIMsgCompType::ReplyToList) &amp;&amp; ! listPost.IsEmpty()))</span>
<a href="#l8.584"></a><span id="l8.584" class="difflineminus">-        {</span>
<a href="#l8.585"></a><span id="l8.585" class="difflineminus">-          if (! mailReplyTo.IsEmpty())</span>
<a href="#l8.586"></a><span id="l8.586" class="difflineplus">+        else {</span>
<a href="#l8.587"></a><span id="l8.587" class="difflineplus">+          mHeaders-&gt;ExtractHeader(HEADER_LIST_POST, true, getter_Copies(outCString));</span>
<a href="#l8.588"></a><span id="l8.588" class="difflineplus">+          if (!outCString.IsEmpty())</span>
<a href="#l8.589"></a><span id="l8.589" class="difflineplus">+            mMimeConverter-&gt;DecodeMimeHeader(outCString.get(), charset.get(),</span>
<a href="#l8.590"></a><span id="l8.590" class="difflineplus">+                                             false, true, listPost);</span>
<a href="#l8.591"></a><span id="l8.591" class="difflineplus">+</span>
<a href="#l8.592"></a><span id="l8.592" class="difflineplus">+          if (!listPost.IsEmpty())</span>
<a href="#l8.593"></a><span id="l8.593">           {</span>
<a href="#l8.594"></a><span id="l8.594" class="difflineminus">-            // handle Mail-Reply-To (http://cr.yp.to/proto/replyto.html)</span>
<a href="#l8.595"></a><span id="l8.595" class="difflineminus">-            compFields-&gt;SetTo(mailReplyTo);</span>
<a href="#l8.596"></a><span id="l8.596" class="difflineminus">-            needToRemoveDup = true;</span>
<a href="#l8.597"></a><span id="l8.597" class="difflineminus">-          }</span>
<a href="#l8.598"></a><span id="l8.598" class="difflineminus">-          else if (! replyTo.IsEmpty())</span>
<a href="#l8.599"></a><span id="l8.599" class="difflineminus">-          {</span>
<a href="#l8.600"></a><span id="l8.600" class="difflineminus">-            // default behaviour for messages without Mail-Reply-To</span>
<a href="#l8.601"></a><span id="l8.601" class="difflineminus">-            compFields-&gt;SetTo(replyTo);</span>
<a href="#l8.602"></a><span id="l8.602" class="difflineminus">-            needToRemoveDup = true;</span>
<a href="#l8.603"></a><span id="l8.603" class="difflineminus">-          }</span>
<a href="#l8.604"></a><span id="l8.604" class="difflineminus">-        }</span>
<a href="#l8.605"></a><span id="l8.605" class="difflineminus">-</span>
<a href="#l8.606"></a><span id="l8.606" class="difflineminus">-        if (! newgroups.IsEmpty())</span>
<a href="#l8.607"></a><span id="l8.607" class="difflineminus">-        {</span>
<a href="#l8.608"></a><span id="l8.608" class="difflineminus">-          if ((type != nsIMsgCompType::Reply) &amp;&amp; (type != nsIMsgCompType::ReplyToSender))</span>
<a href="#l8.609"></a><span id="l8.609" class="difflineminus">-            compFields-&gt;SetNewsgroups(newgroups);</span>
<a href="#l8.610"></a><span id="l8.610" class="difflineminus">-          if (type == nsIMsgCompType::ReplyToGroup)</span>
<a href="#l8.611"></a><span id="l8.611" class="difflineminus">-          {</span>
<a href="#l8.612"></a><span id="l8.612" class="difflineminus">-            compFields-&gt;SetSenderReply(EmptyString());</span>
<a href="#l8.613"></a><span id="l8.613" class="difflineminus">-            compFields-&gt;SetTo(EmptyString());</span>
<a href="#l8.614"></a><span id="l8.614" class="difflineminus">-          }</span>
<a href="#l8.615"></a><span id="l8.615" class="difflineminus">-        }</span>
<a href="#l8.616"></a><span id="l8.616" class="difflineminus">-</span>
<a href="#l8.617"></a><span id="l8.617" class="difflineminus">-        if (! followUpTo.IsEmpty())</span>
<a href="#l8.618"></a><span id="l8.618" class="difflineminus">-        {</span>
<a href="#l8.619"></a><span id="l8.619" class="difflineminus">-          // Handle &quot;followup-to: poster&quot; magic keyword here</span>
<a href="#l8.620"></a><span id="l8.620" class="difflineminus">-          if (followUpTo.EqualsLiteral(&quot;poster&quot;))</span>
<a href="#l8.621"></a><span id="l8.621" class="difflineminus">-          {</span>
<a href="#l8.622"></a><span id="l8.622" class="difflineminus">-            nsCOMPtr&lt;nsIDOMWindow&gt; composeWindow;</span>
<a href="#l8.623"></a><span id="l8.623" class="difflineminus">-            nsCOMPtr&lt;nsIPrompt&gt; prompt;</span>
<a href="#l8.624"></a><span id="l8.624" class="difflineminus">-            compose-&gt;GetDomWindow(getter_AddRefs(composeWindow));</span>
<a href="#l8.625"></a><span id="l8.625" class="difflineminus">-            if (composeWindow)</span>
<a href="#l8.626"></a><span id="l8.626" class="difflineminus">-              composeWindow-&gt;GetPrompter(getter_AddRefs(prompt));</span>
<a href="#l8.627"></a><span id="l8.627" class="difflineminus">-            nsMsgDisplayMessageByName(prompt, NS_LITERAL_STRING(&quot;followupToSenderMessage&quot;));</span>
<a href="#l8.628"></a><span id="l8.628" class="difflineminus">-</span>
<a href="#l8.629"></a><span id="l8.629" class="difflineminus">-            // If reply-to is empty, use the from header to fetch</span>
<a href="#l8.630"></a><span id="l8.630" class="difflineminus">-            // the original sender's email</span>
<a href="#l8.631"></a><span id="l8.631" class="difflineminus">-            if (!replyTo.IsEmpty())</span>
<a href="#l8.632"></a><span id="l8.632" class="difflineplus">+            int32_t startPos = listPost.Find(&quot;&lt;mailto:&quot;);</span>
<a href="#l8.633"></a><span id="l8.633" class="difflineplus">+            int32_t endPos = listPost.FindChar('&gt;', startPos);</span>
<a href="#l8.634"></a><span id="l8.634" class="difflineplus">+            // Extract the e-mail address.</span>
<a href="#l8.635"></a><span id="l8.635" class="difflineplus">+            if (endPos &gt; startPos)</span>
<a href="#l8.636"></a><span id="l8.636">             {</span>
<a href="#l8.637"></a><span id="l8.637" class="difflineminus">-              compFields-&gt;SetSenderReply(replyTo);</span>
<a href="#l8.638"></a><span id="l8.638" class="difflineminus">-              compFields-&gt;SetTo(replyTo);</span>
<a href="#l8.639"></a><span id="l8.639" class="difflineminus">-            }</span>
<a href="#l8.640"></a><span id="l8.640" class="difflineminus">-            else</span>
<a href="#l8.641"></a><span id="l8.641" class="difflineminus">-            {</span>
<a href="#l8.642"></a><span id="l8.642" class="difflineminus">-              mHeaders-&gt;ExtractHeader(HEADER_FROM, false, getter_Copies(outCString));</span>
<a href="#l8.643"></a><span id="l8.643" class="difflineminus">-              if (!outCString.IsEmpty())</span>
<a href="#l8.644"></a><span id="l8.644" class="difflineminus">-              {</span>
<a href="#l8.645"></a><span id="l8.645" class="difflineminus">-                nsAutoString from;</span>
<a href="#l8.646"></a><span id="l8.646" class="difflineminus">-                ConvertRawBytesToUTF16(outCString, charset.get(), from);</span>
<a href="#l8.647"></a><span id="l8.647" class="difflineminus">-                compFields-&gt;SetSenderReply(from);</span>
<a href="#l8.648"></a><span id="l8.648" class="difflineminus">-                compFields-&gt;SetTo(from);</span>
<a href="#l8.649"></a><span id="l8.649" class="difflineminus">-              }</span>
<a href="#l8.650"></a><span id="l8.650" class="difflineminus">-            }</span>
<a href="#l8.651"></a><span id="l8.651" class="difflineminus">-</span>
<a href="#l8.652"></a><span id="l8.652" class="difflineminus">-            // Clear the newsgroup: header field, because followup-to: poster</span>
<a href="#l8.653"></a><span id="l8.653" class="difflineminus">-            // only follows up to the original sender</span>
<a href="#l8.654"></a><span id="l8.654" class="difflineminus">-            if (! newgroups.IsEmpty())</span>
<a href="#l8.655"></a><span id="l8.655" class="difflineminus">-              compFields-&gt;SetNewsgroups(EmptyString());</span>
<a href="#l8.656"></a><span id="l8.656" class="difflineminus">-          }</span>
<a href="#l8.657"></a><span id="l8.657" class="difflineminus">-          else // Process &quot;followup-to: newsgroup-content&quot; here</span>
<a href="#l8.658"></a><span id="l8.658" class="difflineminus">-          {</span>
<a href="#l8.659"></a><span id="l8.659" class="difflineminus">-            if (type != nsIMsgCompType::ReplyToSender)</span>
<a href="#l8.660"></a><span id="l8.660" class="difflineminus">-              compFields-&gt;SetNewsgroups(followUpTo);</span>
<a href="#l8.661"></a><span id="l8.661" class="difflineminus">-            if (type == nsIMsgCompType::Reply)</span>
<a href="#l8.662"></a><span id="l8.662" class="difflineminus">-            {</span>
<a href="#l8.663"></a><span id="l8.663" class="difflineminus">-              compFields-&gt;SetSenderReply(EmptyString());</span>
<a href="#l8.664"></a><span id="l8.664" class="difflineminus">-              compFields-&gt;SetTo(EmptyString());</span>
<a href="#l8.665"></a><span id="l8.665" class="difflineplus">+              const uint32_t mailtoLen = strlen(&quot;&lt;mailto:&quot;);</span>
<a href="#l8.666"></a><span id="l8.666" class="difflineplus">+              listPost = Substring(listPost, startPos + mailtoLen, endPos - (startPos + mailtoLen));</span>
<a href="#l8.667"></a><span id="l8.667" class="difflineplus">+              compFields-&gt;SetTo(listPost);</span>
<a href="#l8.668"></a><span id="l8.668">             }</span>
<a href="#l8.669"></a><span id="l8.669">           }</span>
<a href="#l8.670"></a><span id="l8.670">         }</span>
<a href="#l8.671"></a><span id="l8.671" class="difflineminus">-</span>
<a href="#l8.672"></a><span id="l8.672" class="difflineminus">-        if (! references.IsEmpty())</span>
<a href="#l8.673"></a><span id="l8.673" class="difflineminus">-          references.Append(PRUnichar(' '));</span>
<a href="#l8.674"></a><span id="l8.674" class="difflineminus">-        references += messageId;</span>
<a href="#l8.675"></a><span id="l8.675" class="difflineminus">-        compFields-&gt;SetReferences(NS_LossyConvertUTF16toASCII(references).get());</span>
<a href="#l8.676"></a><span id="l8.676" class="difflineminus">-</span>
<a href="#l8.677"></a><span id="l8.677" class="difflineminus">-        // Remove my address from Reply fields.</span>
<a href="#l8.678"></a><span id="l8.678" class="difflineminus">-        nsCString resultStr;</span>
<a href="#l8.679"></a><span id="l8.679" class="difflineminus">-        nsCOMPtr&lt;nsIMsgHeaderParser&gt; parser =</span>
<a href="#l8.680"></a><span id="l8.680" class="difflineminus">-          do_GetService(NS_MAILNEWS_MIME_HEADER_PARSER_CONTRACTID, &amp;rv);</span>
<a href="#l8.681"></a><span id="l8.681" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.682"></a><span id="l8.682" class="difflineminus">-</span>
<a href="#l8.683"></a><span id="l8.683" class="difflineminus">-        nsMsgCompFields* _compFields = static_cast&lt;nsMsgCompFields*&gt;(compFields.get());  // XXX what is this?</span>
<a href="#l8.684"></a><span id="l8.684" class="difflineplus">+      }</span>
<a href="#l8.685"></a><span id="l8.685" class="difflineplus">+</span>
<a href="#l8.686"></a><span id="l8.686" class="difflineplus">+      if (!newgroups.IsEmpty())</span>
<a href="#l8.687"></a><span id="l8.687" class="difflineplus">+      {</span>
<a href="#l8.688"></a><span id="l8.688" class="difflineplus">+        if ((type != nsIMsgCompType::Reply) &amp;&amp; (type != nsIMsgCompType::ReplyToSender))</span>
<a href="#l8.689"></a><span id="l8.689" class="difflineplus">+          compFields-&gt;SetNewsgroups(newgroups);</span>
<a href="#l8.690"></a><span id="l8.690" class="difflineplus">+        if (type == nsIMsgCompType::ReplyToGroup)</span>
<a href="#l8.691"></a><span id="l8.691" class="difflineplus">+          compFields-&gt;SetTo(EmptyString());</span>
<a href="#l8.692"></a><span id="l8.692" class="difflineplus">+      }</span>
<a href="#l8.693"></a><span id="l8.693" class="difflineplus">+</span>
<a href="#l8.694"></a><span id="l8.694" class="difflineplus">+      if (!followUpTo.IsEmpty())</span>
<a href="#l8.695"></a><span id="l8.695" class="difflineplus">+      {</span>
<a href="#l8.696"></a><span id="l8.696" class="difflineplus">+        // Handle &quot;followup-to: poster&quot; magic keyword here</span>
<a href="#l8.697"></a><span id="l8.697" class="difflineplus">+        if (followUpTo.EqualsLiteral(&quot;poster&quot;))</span>
<a href="#l8.698"></a><span id="l8.698" class="difflineplus">+        {</span>
<a href="#l8.699"></a><span id="l8.699" class="difflineplus">+          nsCOMPtr&lt;nsIDOMWindow&gt; composeWindow;</span>
<a href="#l8.700"></a><span id="l8.700" class="difflineplus">+          nsCOMPtr&lt;nsIPrompt&gt; prompt;</span>
<a href="#l8.701"></a><span id="l8.701" class="difflineplus">+          compose-&gt;GetDomWindow(getter_AddRefs(composeWindow));</span>
<a href="#l8.702"></a><span id="l8.702" class="difflineplus">+          if (composeWindow)</span>
<a href="#l8.703"></a><span id="l8.703" class="difflineplus">+            composeWindow-&gt;GetPrompter(getter_AddRefs(prompt));</span>
<a href="#l8.704"></a><span id="l8.704" class="difflineplus">+          nsMsgDisplayMessageByName(prompt, NS_LITERAL_STRING(&quot;followupToSenderMessage&quot;));</span>
<a href="#l8.705"></a><span id="l8.705" class="difflineplus">+</span>
<a href="#l8.706"></a><span id="l8.706" class="difflineplus">+          if (!replyTo.IsEmpty())</span>
<a href="#l8.707"></a><span id="l8.707" class="difflineplus">+          {</span>
<a href="#l8.708"></a><span id="l8.708" class="difflineplus">+            compFields-&gt;SetTo(replyTo);</span>
<a href="#l8.709"></a><span id="l8.709" class="difflineplus">+          }</span>
<a href="#l8.710"></a><span id="l8.710" class="difflineplus">+          else</span>
<a href="#l8.711"></a><span id="l8.711" class="difflineplus">+          {</span>
<a href="#l8.712"></a><span id="l8.712" class="difflineplus">+            // If reply-to is empty, use the From header to fetch the original</span>
<a href="#l8.713"></a><span id="l8.713" class="difflineplus">+            // sender's email.</span>
<a href="#l8.714"></a><span id="l8.714" class="difflineplus">+            compFields-&gt;SetTo(from);</span>
<a href="#l8.715"></a><span id="l8.715" class="difflineplus">+          }</span>
<a href="#l8.716"></a><span id="l8.716" class="difflineplus">+</span>
<a href="#l8.717"></a><span id="l8.717" class="difflineplus">+          // Clear the newsgroup: header field, because followup-to: poster</span>
<a href="#l8.718"></a><span id="l8.718" class="difflineplus">+          // only follows up to the original sender</span>
<a href="#l8.719"></a><span id="l8.719" class="difflineplus">+          if (!newgroups.IsEmpty())</span>
<a href="#l8.720"></a><span id="l8.720" class="difflineplus">+            compFields-&gt;SetNewsgroups(EmptyString());</span>
<a href="#l8.721"></a><span id="l8.721" class="difflineplus">+        }</span>
<a href="#l8.722"></a><span id="l8.722" class="difflineplus">+        else // Process &quot;followup-to: newsgroup-content&quot; here</span>
<a href="#l8.723"></a><span id="l8.723" class="difflineplus">+        {</span>
<a href="#l8.724"></a><span id="l8.724" class="difflineplus">+          if (type != nsIMsgCompType::ReplyToSender)</span>
<a href="#l8.725"></a><span id="l8.725" class="difflineplus">+            compFields-&gt;SetNewsgroups(followUpTo);</span>
<a href="#l8.726"></a><span id="l8.726" class="difflineplus">+          if (type == nsIMsgCompType::Reply)</span>
<a href="#l8.727"></a><span id="l8.727" class="difflineplus">+          {</span>
<a href="#l8.728"></a><span id="l8.728" class="difflineplus">+            compFields-&gt;SetTo(EmptyString());</span>
<a href="#l8.729"></a><span id="l8.729" class="difflineplus">+          }</span>
<a href="#l8.730"></a><span id="l8.730" class="difflineplus">+        }</span>
<a href="#l8.731"></a><span id="l8.731" class="difflineplus">+      }</span>
<a href="#l8.732"></a><span id="l8.732" class="difflineplus">+</span>
<a href="#l8.733"></a><span id="l8.733" class="difflineplus">+      if (!references.IsEmpty())</span>
<a href="#l8.734"></a><span id="l8.734" class="difflineplus">+        references.Append(PRUnichar(' '));</span>
<a href="#l8.735"></a><span id="l8.735" class="difflineplus">+      references += messageId;</span>
<a href="#l8.736"></a><span id="l8.736" class="difflineplus">+      compFields-&gt;SetReferences(NS_LossyConvertUTF16toASCII(references).get());</span>
<a href="#l8.737"></a><span id="l8.737" class="difflineplus">+</span>
<a href="#l8.738"></a><span id="l8.738" class="difflineplus">+      // Remove my address from Reply fields.</span>
<a href="#l8.739"></a><span id="l8.739" class="difflineplus">+      nsAutoCString resultStr;</span>
<a href="#l8.740"></a><span id="l8.740" class="difflineplus">+</span>
<a href="#l8.741"></a><span id="l8.741" class="difflineplus">+      // Cast interface to concrete class that has direct field getters etc.</span>
<a href="#l8.742"></a><span id="l8.742" class="difflineplus">+      nsMsgCompFields* _compFields = static_cast&lt;nsMsgCompFields*&gt;(compFields.get());</span>
<a href="#l8.743"></a><span id="l8.743" class="difflineplus">+      if (mIdentity)</span>
<a href="#l8.744"></a><span id="l8.744" class="difflineplus">+      {</span>
<a href="#l8.745"></a><span id="l8.745" class="difflineplus">+        nsCString email;</span>
<a href="#l8.746"></a><span id="l8.746" class="difflineplus">+        mIdentity-&gt;GetEmail(email);</span>
<a href="#l8.747"></a><span id="l8.747" class="difflineplus">+        // We need to remove dups for the Reply fields.</span>
<a href="#l8.748"></a><span id="l8.748" class="difflineplus">+</span>
<a href="#l8.749"></a><span id="l8.749" class="difflineplus">+        // If it's a reply to self, self should not be removed.</span>
<a href="#l8.750"></a><span id="l8.750" class="difflineplus">+        if (NS_ConvertUTF16toUTF8(from).Find(email) == kNotFound) {</span>
<a href="#l8.751"></a><span id="l8.751" class="difflineplus">+          parser-&gt;RemoveDuplicateAddresses(nsDependentCString(_compFields-&gt;GetTo()),</span>
<a href="#l8.752"></a><span id="l8.752" class="difflineplus">+                                           email, resultStr);</span>
<a href="#l8.753"></a><span id="l8.753" class="difflineplus">+          _compFields-&gt;SetTo(resultStr.get());</span>
<a href="#l8.754"></a><span id="l8.754" class="difflineplus">+        }</span>
<a href="#l8.755"></a><span id="l8.755" class="difflineplus">+</span>
<a href="#l8.756"></a><span id="l8.756" class="difflineplus">+        parser-&gt;RemoveDuplicateAddresses(nsDependentCString(_compFields-&gt;GetCc()),</span>
<a href="#l8.757"></a><span id="l8.757" class="difflineplus">+                                         email, resultStr);</span>
<a href="#l8.758"></a><span id="l8.758" class="difflineplus">+        _compFields-&gt;SetCc(resultStr.get());</span>
<a href="#l8.759"></a><span id="l8.759" class="difflineplus">+      }</span>
<a href="#l8.760"></a><span id="l8.760" class="difflineplus">+</span>
<a href="#l8.761"></a><span id="l8.761" class="difflineplus">+      // Remove duplicate addresses between TO &amp;&amp; CC</span>
<a href="#l8.762"></a><span id="l8.762" class="difflineplus">+      if (needToRemoveDup)</span>
<a href="#l8.763"></a><span id="l8.763" class="difflineplus">+      {</span>
<a href="#l8.764"></a><span id="l8.764" class="difflineplus">+        nsCString addressToBeRemoved(_compFields-&gt;GetTo());</span>
<a href="#l8.765"></a><span id="l8.765" class="difflineplus">+        // Remove my own address if using Mail-Followup-To (see bug 325429)</span>
<a href="#l8.766"></a><span id="l8.766">         if (mIdentity)</span>
<a href="#l8.767"></a><span id="l8.767">         {</span>
<a href="#l8.768"></a><span id="l8.768" class="difflineminus">-          nsCString email;</span>
<a href="#l8.769"></a><span id="l8.769" class="difflineminus">-          mIdentity-&gt;GetEmail(email);</span>
<a href="#l8.770"></a><span id="l8.770" class="difflineminus">-          // We always need to remove dups for the Reply fields.</span>
<a href="#l8.771"></a><span id="l8.771" class="difflineminus">-          rv = parser-&gt;RemoveDuplicateAddresses(nsDependentCString(_compFields-&gt;GetSenderReply()),</span>
<a href="#l8.772"></a><span id="l8.772" class="difflineminus">-                                                email, resultStr);</span>
<a href="#l8.773"></a><span id="l8.773" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l8.774"></a><span id="l8.774" class="difflineminus">-            _compFields-&gt;SetSenderReply(resultStr.get());</span>
<a href="#l8.775"></a><span id="l8.775" class="difflineminus">-          rv = parser-&gt;RemoveDuplicateAddresses(nsDependentCString(_compFields-&gt;GetAllReply()),</span>
<a href="#l8.776"></a><span id="l8.776" class="difflineminus">-                                                email, resultStr);</span>
<a href="#l8.777"></a><span id="l8.777" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l8.778"></a><span id="l8.778" class="difflineminus">-            _compFields-&gt;SetAllReply(resultStr.get());</span>
<a href="#l8.779"></a><span id="l8.779" class="difflineminus">-          rv = parser-&gt;RemoveDuplicateAddresses(nsDependentCString(_compFields-&gt;GetListReply()),</span>
<a href="#l8.780"></a><span id="l8.780" class="difflineminus">-                                                email, resultStr);</span>
<a href="#l8.781"></a><span id="l8.781" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l8.782"></a><span id="l8.782" class="difflineminus">-            _compFields-&gt;SetListReply(resultStr.get());</span>
<a href="#l8.783"></a><span id="l8.783" class="difflineminus">-        }</span>
<a href="#l8.784"></a><span id="l8.784" class="difflineminus">-</span>
<a href="#l8.785"></a><span id="l8.785" class="difflineminus">-        // Remove duplicate addresses between TO &amp;&amp; CC</span>
<a href="#l8.786"></a><span id="l8.786" class="difflineminus">-        if (needToRemoveDup)</span>
<a href="#l8.787"></a><span id="l8.787" class="difflineminus">-        {</span>
<a href="#l8.788"></a><span id="l8.788" class="difflineminus">-          nsCString addressToBeRemoved(_compFields-&gt;GetTo());</span>
<a href="#l8.789"></a><span id="l8.789" class="difflineminus">-          // Remove my own address if using Mail-Followup-To (see bug 325429)</span>
<a href="#l8.790"></a><span id="l8.790" class="difflineminus">-          if (mIdentity)</span>
<a href="#l8.791"></a><span id="l8.791" class="difflineplus">+          bool removeMyEmailInCc = true;</span>
<a href="#l8.792"></a><span id="l8.792" class="difflineplus">+          nsCString myEmail;</span>
<a href="#l8.793"></a><span id="l8.793" class="difflineplus">+          mIdentity-&gt;GetEmail(myEmail);</span>
<a href="#l8.794"></a><span id="l8.794" class="difflineplus">+</span>
<a href="#l8.795"></a><span id="l8.795" class="difflineplus">+          // Remove own address from CC unless we want it in there</span>
<a href="#l8.796"></a><span id="l8.796" class="difflineplus">+          // through the automatic-CC-to-self (see bug 584962). There are</span>
<a href="#l8.797"></a><span id="l8.797" class="difflineplus">+          // three cases:</span>
<a href="#l8.798"></a><span id="l8.798" class="difflineplus">+          // - user has no automatic CC</span>
<a href="#l8.799"></a><span id="l8.799" class="difflineplus">+          // - user has automatic CC but own email is not in it</span>
<a href="#l8.800"></a><span id="l8.800" class="difflineplus">+          // - user has automatic CC and own email in it</span>
<a href="#l8.801"></a><span id="l8.801" class="difflineplus">+          // Only in the last case do we want our own email address to stay</span>
<a href="#l8.802"></a><span id="l8.802" class="difflineplus">+          // in the CC list.</span>
<a href="#l8.803"></a><span id="l8.803" class="difflineplus">+          bool automaticCc;</span>
<a href="#l8.804"></a><span id="l8.804" class="difflineplus">+          mIdentity-&gt;GetDoCc(&amp;automaticCc);</span>
<a href="#l8.805"></a><span id="l8.805" class="difflineplus">+          if (automaticCc)</span>
<a href="#l8.806"></a><span id="l8.806">           {</span>
<a href="#l8.807"></a><span id="l8.807" class="difflineminus">-            bool removeMyEmailInCc = true;</span>
<a href="#l8.808"></a><span id="l8.808" class="difflineminus">-            nsCString myEmail;</span>
<a href="#l8.809"></a><span id="l8.809" class="difflineminus">-            mIdentity-&gt;GetEmail(myEmail);</span>
<a href="#l8.810"></a><span id="l8.810" class="difflineminus">-</span>
<a href="#l8.811"></a><span id="l8.811" class="difflineminus">-            // Remove own address from CC unless we want it in there</span>
<a href="#l8.812"></a><span id="l8.812" class="difflineminus">-            // through the automatic-CC-to-self (see bug 584962). There are</span>
<a href="#l8.813"></a><span id="l8.813" class="difflineminus">-            // three cases:</span>
<a href="#l8.814"></a><span id="l8.814" class="difflineminus">-            // - user has no automatic CC</span>
<a href="#l8.815"></a><span id="l8.815" class="difflineminus">-            // - user has automatic CC but own email is not in it</span>
<a href="#l8.816"></a><span id="l8.816" class="difflineminus">-            // - user has automatic CC and own email in it</span>
<a href="#l8.817"></a><span id="l8.817" class="difflineminus">-            // Only in the last case do we want our own email address to stay</span>
<a href="#l8.818"></a><span id="l8.818" class="difflineminus">-            // in the CC list.</span>
<a href="#l8.819"></a><span id="l8.819" class="difflineminus">-            bool automaticCc;</span>
<a href="#l8.820"></a><span id="l8.820" class="difflineminus">-            mIdentity-&gt;GetDoCc(&amp;automaticCc);</span>
<a href="#l8.821"></a><span id="l8.821" class="difflineminus">-            if (automaticCc)</span>
<a href="#l8.822"></a><span id="l8.822" class="difflineminus">-            {</span>
<a href="#l8.823"></a><span id="l8.823" class="difflineminus">-              nsCString ccList, ccListEmailAddresses;</span>
<a href="#l8.824"></a><span id="l8.824" class="difflineminus">-              mIdentity-&gt;GetDoCcList(ccList);</span>
<a href="#l8.825"></a><span id="l8.825" class="difflineminus">-              rv = parser-&gt;ExtractHeaderAddressMailboxes(ccList,</span>
<a href="#l8.826"></a><span id="l8.826" class="difflineminus">-                                                         ccListEmailAddresses);</span>
<a href="#l8.827"></a><span id="l8.827" class="difflineminus">-              if (NS_SUCCEEDED(rv) &amp;&amp;</span>
<a href="#l8.828"></a><span id="l8.828" class="difflineminus">-                  ccListEmailAddresses.Find(myEmail) != kNotFound)</span>
<a href="#l8.829"></a><span id="l8.829" class="difflineminus">-                removeMyEmailInCc = false;</span>
<a href="#l8.830"></a><span id="l8.830" class="difflineminus">-            }</span>
<a href="#l8.831"></a><span id="l8.831" class="difflineminus">-</span>
<a href="#l8.832"></a><span id="l8.832" class="difflineminus">-            if (removeMyEmailInCc)</span>
<a href="#l8.833"></a><span id="l8.833" class="difflineminus">-            {</span>
<a href="#l8.834"></a><span id="l8.834" class="difflineminus">-              addressToBeRemoved.AppendLiteral(&quot;, &quot;);</span>
<a href="#l8.835"></a><span id="l8.835" class="difflineminus">-              addressToBeRemoved.Append(myEmail);</span>
<a href="#l8.836"></a><span id="l8.836" class="difflineminus">-            }</span>
<a href="#l8.837"></a><span id="l8.837" class="difflineminus">-</span>
<a href="#l8.838"></a><span id="l8.838" class="difflineminus">-            rv = parser-&gt;RemoveDuplicateAddresses(nsDependentCString(_compFields-&gt;GetTo()),</span>
<a href="#l8.839"></a><span id="l8.839" class="difflineminus">-                                                  myEmail, resultStr);</span>
<a href="#l8.840"></a><span id="l8.840" class="difflineminus">-            if (NS_SUCCEEDED(rv))</span>
<a href="#l8.841"></a><span id="l8.841" class="difflineminus">-            {</span>
<a href="#l8.842"></a><span id="l8.842" class="difflineminus">-              if (type == nsIMsgCompType::ReplyAll &amp;&amp; !mailFollowupTo.IsEmpty())</span>
<a href="#l8.843"></a><span id="l8.843" class="difflineminus">-                _compFields-&gt;SetTo(resultStr.get());</span>
<a href="#l8.844"></a><span id="l8.844" class="difflineminus">-            }</span>
<a href="#l8.845"></a><span id="l8.845" class="difflineplus">+            nsCString ccList, ccEmailAddresses;</span>
<a href="#l8.846"></a><span id="l8.846" class="difflineplus">+            mIdentity-&gt;GetDoCcList(ccList);</span>
<a href="#l8.847"></a><span id="l8.847" class="difflineplus">+            rv = parser-&gt;ExtractHeaderAddressMailboxes(ccList,</span>
<a href="#l8.848"></a><span id="l8.848" class="difflineplus">+                                                       ccEmailAddresses);</span>
<a href="#l8.849"></a><span id="l8.849" class="difflineplus">+            if (NS_SUCCEEDED(rv) &amp;&amp;</span>
<a href="#l8.850"></a><span id="l8.850" class="difflineplus">+                ccEmailAddresses.Find(myEmail) != kNotFound)</span>
<a href="#l8.851"></a><span id="l8.851" class="difflineplus">+              removeMyEmailInCc = false;</span>
<a href="#l8.852"></a><span id="l8.852" class="difflineplus">+          }</span>
<a href="#l8.853"></a><span id="l8.853" class="difflineplus">+</span>
<a href="#l8.854"></a><span id="l8.854" class="difflineplus">+          if (removeMyEmailInCc)</span>
<a href="#l8.855"></a><span id="l8.855" class="difflineplus">+          {</span>
<a href="#l8.856"></a><span id="l8.856" class="difflineplus">+            addressToBeRemoved.AppendLiteral(&quot;, &quot;);</span>
<a href="#l8.857"></a><span id="l8.857" class="difflineplus">+            addressToBeRemoved.Append(myEmail);</span>
<a href="#l8.858"></a><span id="l8.858">           }</span>
<a href="#l8.859"></a><span id="l8.859" class="difflineminus">-          rv = parser-&gt;RemoveDuplicateAddresses(nsDependentCString(_compFields-&gt;GetCc()),</span>
<a href="#l8.860"></a><span id="l8.860" class="difflineminus">-                                                addressToBeRemoved, resultStr);</span>
<a href="#l8.861"></a><span id="l8.861" class="difflineplus">+</span>
<a href="#l8.862"></a><span id="l8.862" class="difflineplus">+          rv = parser-&gt;RemoveDuplicateAddresses(nsDependentCString(_compFields-&gt;GetTo()),</span>
<a href="#l8.863"></a><span id="l8.863" class="difflineplus">+                                                myEmail, resultStr);</span>
<a href="#l8.864"></a><span id="l8.864">           if (NS_SUCCEEDED(rv))</span>
<a href="#l8.865"></a><span id="l8.865" class="difflineminus">-            _compFields-&gt;SetCc(resultStr.get());</span>
<a href="#l8.866"></a><span id="l8.866" class="difflineplus">+          {</span>
<a href="#l8.867"></a><span id="l8.867" class="difflineplus">+            if (type == nsIMsgCompType::ReplyAll &amp;&amp; !mailFollowupTo.IsEmpty())</span>
<a href="#l8.868"></a><span id="l8.868" class="difflineplus">+              _compFields-&gt;SetTo(resultStr.get());</span>
<a href="#l8.869"></a><span id="l8.869" class="difflineplus">+          }</span>
<a href="#l8.870"></a><span id="l8.870">         }</span>
<a href="#l8.871"></a><span id="l8.871" class="difflineminus">-</span>
<a href="#l8.872"></a><span id="l8.872" class="difflineplus">+        rv = parser-&gt;RemoveDuplicateAddresses(nsDependentCString(_compFields-&gt;GetCc()),</span>
<a href="#l8.873"></a><span id="l8.873" class="difflineplus">+                                              addressToBeRemoved, resultStr);</span>
<a href="#l8.874"></a><span id="l8.874" class="difflineplus">+        if (NS_SUCCEEDED(rv))</span>
<a href="#l8.875"></a><span id="l8.875" class="difflineplus">+          _compFields-&gt;SetCc(resultStr.get());</span>
<a href="#l8.876"></a><span id="l8.876">       }</span>
<a href="#l8.877"></a><span id="l8.877">     }</span>
<a href="#l8.878"></a><span id="l8.878" class="difflineplus">+  }</span>
<a href="#l8.879"></a><span id="l8.879"> </span>
<a href="#l8.880"></a><span id="l8.880"> #ifdef MSGCOMP_TRACE_PERFORMANCE</span>
<a href="#l8.881"></a><span id="l8.881" class="difflineminus">-    nsCOMPtr&lt;nsIMsgComposeService&gt; composeService (do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID));</span>
<a href="#l8.882"></a><span id="l8.882" class="difflineminus">-    composeService-&gt;TimeStamp(&quot;Done with MIME. Now we're updating the UI elements&quot;, false);</span>
<a href="#l8.883"></a><span id="l8.883" class="difflineplus">+  nsCOMPtr&lt;nsIMsgComposeService&gt; composeService (do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID));</span>
<a href="#l8.884"></a><span id="l8.884" class="difflineplus">+  composeService-&gt;TimeStamp(&quot;Done with MIME. Now we're updating the UI elements&quot;, false);</span>
<a href="#l8.885"></a><span id="l8.885"> #endif</span>
<a href="#l8.886"></a><span id="l8.886"> </span>
<a href="#l8.887"></a><span id="l8.887" class="difflineminus">-    if (mQuoteOriginal)</span>
<a href="#l8.888"></a><span id="l8.888" class="difflineminus">-      compose-&gt;NotifyStateListeners(nsIMsgComposeNotificationType::ComposeFieldsReady, NS_OK);</span>
<a href="#l8.889"></a><span id="l8.889" class="difflineplus">+  if (mQuoteOriginal)</span>
<a href="#l8.890"></a><span id="l8.890" class="difflineplus">+    compose-&gt;NotifyStateListeners(nsIMsgComposeNotificationType::ComposeFieldsReady, NS_OK);</span>
<a href="#l8.891"></a><span id="l8.891"> </span>
<a href="#l8.892"></a><span id="l8.892"> #ifdef MSGCOMP_TRACE_PERFORMANCE</span>
<a href="#l8.893"></a><span id="l8.893" class="difflineminus">-    composeService-&gt;TimeStamp(&quot;Addressing widget, window title and focus are now set, time to insert the body&quot;, false);</span>
<a href="#l8.894"></a><span id="l8.894" class="difflineplus">+  composeService-&gt;TimeStamp(&quot;Addressing widget, window title and focus are now set, time to insert the body&quot;, false);</span>
<a href="#l8.895"></a><span id="l8.895"> #endif</span>
<a href="#l8.896"></a><span id="l8.896"> </span>
<a href="#l8.897"></a><span id="l8.897" class="difflineminus">-    if (! mHeadersOnly)</span>
<a href="#l8.898"></a><span id="l8.898" class="difflineminus">-      mMsgBody.AppendLiteral(&quot;&lt;/html&gt;&quot;);</span>
<a href="#l8.899"></a><span id="l8.899" class="difflineminus">-</span>
<a href="#l8.900"></a><span id="l8.900" class="difflineminus">-    // Now we have an HTML representation of the quoted message.</span>
<a href="#l8.901"></a><span id="l8.901" class="difflineminus">-    // If we are in plain text mode, we need to convert this to plain</span>
<a href="#l8.902"></a><span id="l8.902" class="difflineminus">-    // text before we try to insert it into the editor. If we don't, we</span>
<a href="#l8.903"></a><span id="l8.903" class="difflineminus">-    // just get lots of HTML text in the message...not good.</span>
<a href="#l8.904"></a><span id="l8.904" class="difflineminus">-    //</span>
<a href="#l8.905"></a><span id="l8.905" class="difflineminus">-    // XXX not m_composeHTML? /BenB</span>
<a href="#l8.906"></a><span id="l8.906" class="difflineminus">-    bool composeHTML = true;</span>
<a href="#l8.907"></a><span id="l8.907" class="difflineminus">-    compose-&gt;GetComposeHTML(&amp;composeHTML);</span>
<a href="#l8.908"></a><span id="l8.908" class="difflineminus">-    if (!composeHTML)</span>
<a href="#l8.909"></a><span id="l8.909" class="difflineminus">-    {</span>
<a href="#l8.910"></a><span id="l8.910" class="difflineminus">-      // Downsampling. The charset should only consist of ascii.</span>
<a href="#l8.911"></a><span id="l8.911" class="difflineminus">-</span>
<a href="#l8.912"></a><span id="l8.912" class="difflineminus">-      bool formatflowed =</span>
<a href="#l8.913"></a><span id="l8.913" class="difflineminus">-        UseFormatFlowed(NS_LossyConvertUTF16toASCII(aCharset).get());</span>
<a href="#l8.914"></a><span id="l8.914" class="difflineminus">-      ConvertToPlainText(formatflowed);</span>
<a href="#l8.915"></a><span id="l8.915" class="difflineminus">-    }</span>
<a href="#l8.916"></a><span id="l8.916" class="difflineminus">-</span>
<a href="#l8.917"></a><span id="l8.917" class="difflineminus">-    compose-&gt;ProcessSignature(mIdentity, true, &amp;mSignature);</span>
<a href="#l8.918"></a><span id="l8.918" class="difflineminus">-</span>
<a href="#l8.919"></a><span id="l8.919" class="difflineminus">-    nsCOMPtr&lt;nsIEditor&gt; editor;</span>
<a href="#l8.920"></a><span id="l8.920" class="difflineminus">-    if (NS_SUCCEEDED(compose-&gt;GetEditor(getter_AddRefs(editor))) &amp;&amp; editor)</span>
<a href="#l8.921"></a><span id="l8.921" class="difflineminus">-    {</span>
<a href="#l8.922"></a><span id="l8.922" class="difflineminus">-      if (mQuoteOriginal)</span>
<a href="#l8.923"></a><span id="l8.923" class="difflineminus">-        compose-&gt;ConvertAndLoadComposeWindow(mCitePrefix,</span>
<a href="#l8.924"></a><span id="l8.924" class="difflineminus">-                                             mMsgBody, mSignature,</span>
<a href="#l8.925"></a><span id="l8.925" class="difflineminus">-                                             true, composeHTML);</span>
<a href="#l8.926"></a><span id="l8.926" class="difflineminus">-      else</span>
<a href="#l8.927"></a><span id="l8.927" class="difflineminus">-        InsertToCompose(editor, composeHTML);</span>
<a href="#l8.928"></a><span id="l8.928" class="difflineminus">-    }</span>
<a href="#l8.929"></a><span id="l8.929" class="difflineminus">-</span>
<a href="#l8.930"></a><span id="l8.930" class="difflineplus">+  if (! mHeadersOnly)</span>
<a href="#l8.931"></a><span id="l8.931" class="difflineplus">+    mMsgBody.AppendLiteral(&quot;&lt;/html&gt;&quot;);</span>
<a href="#l8.932"></a><span id="l8.932" class="difflineplus">+</span>
<a href="#l8.933"></a><span id="l8.933" class="difflineplus">+  // Now we have an HTML representation of the quoted message.</span>
<a href="#l8.934"></a><span id="l8.934" class="difflineplus">+  // If we are in plain text mode, we need to convert this to plain</span>
<a href="#l8.935"></a><span id="l8.935" class="difflineplus">+  // text before we try to insert it into the editor. If we don't, we</span>
<a href="#l8.936"></a><span id="l8.936" class="difflineplus">+  // just get lots of HTML text in the message...not good.</span>
<a href="#l8.937"></a><span id="l8.937" class="difflineplus">+  //</span>
<a href="#l8.938"></a><span id="l8.938" class="difflineplus">+  // XXX not m_composeHTML? /BenB</span>
<a href="#l8.939"></a><span id="l8.939" class="difflineplus">+  bool composeHTML = true;</span>
<a href="#l8.940"></a><span id="l8.940" class="difflineplus">+  compose-&gt;GetComposeHTML(&amp;composeHTML);</span>
<a href="#l8.941"></a><span id="l8.941" class="difflineplus">+  if (!composeHTML)</span>
<a href="#l8.942"></a><span id="l8.942" class="difflineplus">+  {</span>
<a href="#l8.943"></a><span id="l8.943" class="difflineplus">+    // Downsampling. The charset should only consist of ascii.</span>
<a href="#l8.944"></a><span id="l8.944" class="difflineplus">+</span>
<a href="#l8.945"></a><span id="l8.945" class="difflineplus">+    bool formatflowed =</span>
<a href="#l8.946"></a><span id="l8.946" class="difflineplus">+      UseFormatFlowed(NS_LossyConvertUTF16toASCII(aCharset).get());</span>
<a href="#l8.947"></a><span id="l8.947" class="difflineplus">+    ConvertToPlainText(formatflowed);</span>
<a href="#l8.948"></a><span id="l8.948" class="difflineplus">+  }</span>
<a href="#l8.949"></a><span id="l8.949" class="difflineplus">+</span>
<a href="#l8.950"></a><span id="l8.950" class="difflineplus">+  compose-&gt;ProcessSignature(mIdentity, true, &amp;mSignature);</span>
<a href="#l8.951"></a><span id="l8.951" class="difflineplus">+</span>
<a href="#l8.952"></a><span id="l8.952" class="difflineplus">+  nsCOMPtr&lt;nsIEditor&gt; editor;</span>
<a href="#l8.953"></a><span id="l8.953" class="difflineplus">+  if (NS_SUCCEEDED(compose-&gt;GetEditor(getter_AddRefs(editor))) &amp;&amp; editor)</span>
<a href="#l8.954"></a><span id="l8.954" class="difflineplus">+  {</span>
<a href="#l8.955"></a><span id="l8.955">     if (mQuoteOriginal)</span>
<a href="#l8.956"></a><span id="l8.956" class="difflineminus">-      compose-&gt;NotifyStateListeners(nsIMsgComposeNotificationType::ComposeBodyReady, NS_OK);</span>
<a href="#l8.957"></a><span id="l8.957" class="difflineplus">+      compose-&gt;ConvertAndLoadComposeWindow(mCitePrefix,</span>
<a href="#l8.958"></a><span id="l8.958" class="difflineplus">+                                           mMsgBody, mSignature,</span>
<a href="#l8.959"></a><span id="l8.959" class="difflineplus">+                                           true, composeHTML);</span>
<a href="#l8.960"></a><span id="l8.960" class="difflineplus">+    else</span>
<a href="#l8.961"></a><span id="l8.961" class="difflineplus">+      InsertToCompose(editor, composeHTML);</span>
<a href="#l8.962"></a><span id="l8.962">   }</span>
<a href="#l8.963"></a><span id="l8.963" class="difflineplus">+</span>
<a href="#l8.964"></a><span id="l8.964" class="difflineplus">+  if (mQuoteOriginal)</span>
<a href="#l8.965"></a><span id="l8.965" class="difflineplus">+    compose-&gt;NotifyStateListeners(nsIMsgComposeNotificationType::ComposeBodyReady, NS_OK);</span>
<a href="#l8.966"></a><span id="l8.966">   return rv;</span>
<a href="#l8.967"></a><span id="l8.967"> }</span>
<a href="#l8.968"></a><span id="l8.968"> </span>
<a href="#l8.969"></a><span id="l8.969"> NS_IMETHODIMP QuotingOutputStreamListener::OnDataAvailable(nsIRequest *request,</span>
<a href="#l8.970"></a><span id="l8.970">                               nsISupports *ctxt, nsIInputStream *inStr,</span>
<a href="#l8.971"></a><span id="l8.971">                               uint64_t sourceOffset, uint32_t count)</span>
<a href="#l8.972"></a><span id="l8.972"> {</span>
<a href="#l8.973"></a><span id="l8.973">   nsresult rv = NS_OK;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.h</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.h</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -161,16 +161,17 @@ private:</span>
<a href="#l9.4"></a><span id="l9.4">     nsWeakPtr                 mWeakComposeObj;</span>
<a href="#l9.5"></a><span id="l9.5">     nsString       				    mMsgBody;</span>
<a href="#l9.6"></a><span id="l9.6">     nsString       				    mCitePrefix;</span>
<a href="#l9.7"></a><span id="l9.7">     nsString       				    mSignature;</span>
<a href="#l9.8"></a><span id="l9.8">     bool						        mQuoteHeaders;</span>
<a href="#l9.9"></a><span id="l9.9">     bool						        mHeadersOnly;</span>
<a href="#l9.10"></a><span id="l9.10">     nsCOMPtr&lt;nsIMimeHeaders&gt;	mHeaders;</span>
<a href="#l9.11"></a><span id="l9.11">     nsCOMPtr&lt;nsIMsgIdentity&gt;  mIdentity;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt;     mOrigMsgHdr;</span>
<a href="#l9.13"></a><span id="l9.13">     nsString                  mCiteReference;</span>
<a href="#l9.14"></a><span id="l9.14">     nsCOMPtr&lt;nsIMimeConverter&gt; mMimeConverter;</span>
<a href="#l9.15"></a><span id="l9.15">     nsCOMPtr&lt;nsIUnicodeDecoder&gt; mUnicodeDecoder;</span>
<a href="#l9.16"></a><span id="l9.16">     int32_t                   mUnicodeBufferCharacterLength;</span>
<a href="#l9.17"></a><span id="l9.17">     PRUnichar*                mUnicodeConversionBuffer;</span>
<a href="#l9.18"></a><span id="l9.18">     bool                      mQuoteOriginal;</span>
<a href="#l9.19"></a><span id="l9.19">     nsCString                 mHtmlToQuote;</span>
<a href="#l9.20"></a><span id="l9.20"> };</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

