<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 1658:a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22" />
<meta property="og:url" content="/comm-central/rev/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22" />
<meta property="og:description" content="Fix bug 471973 - Make use of alarm interface in backend code. r=dbo" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22">shortlog</a> |
<a href="/comm-central/log/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22">files</a> |
changeset |
<a href="/comm-central/raw-rev/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22">raw</a>  | <a href="/comm-central/archive/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=471973">bug 471973</a> - Make use of alarm interface in backend code. r=dbo
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 16 Jan 2009 11:17:20 +0100</td></tr>

<tr>
 <td>changeset 1658</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22">a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22</a></td>
</tr>



<tr>
<td>parent 1657</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5d42e53ff9b12d9bccf8567d95b3e848d5ce6d6b">5d42e53ff9b12d9bccf8567d95b3e848d5ce6d6b</a>
</td>
</tr>

<tr>
<td>child 1659</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/926804509a09fa3cfeac157bae7163d1b8151242">926804509a09fa3cfeac157bae7163d1b8151242</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22">1324</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Fri, 16 Jan 2009 10:18:20 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a41dd9c8e51c [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22&newProject=comm-central&newRevision=a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22&newProject=comm-central&newRevision=a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22&newProject=comm-central&newRevision=a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28dbo%29&revcount=50">dbo</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=471973">471973</a></td></tr>




</table></div>

<div class="page_body description">Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=471973">bug 471973</a> - Make use of alarm interface in backend code. r=dbo</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-dialog-utils.js">calendar/base/content/calendar-dialog-utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-dialog-utils.js">file</a> |
<a href="/comm-central/annotate/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-dialog-utils.js">annotate</a> |
<a href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-dialog-utils.js">diff</a> |
<a href="/comm-central/comparison/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-dialog-utils.js">comparison</a> |
<a href="/comm-central/log/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-dialog-utils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-dnd-listener.js">calendar/base/content/calendar-dnd-listener.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-dnd-listener.js">file</a> |
<a href="/comm-central/annotate/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-dnd-listener.js">annotate</a> |
<a href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-dnd-listener.js">diff</a> |
<a href="/comm-central/comparison/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-dnd-listener.js">comparison</a> |
<a href="/comm-central/log/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-dnd-listener.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-item-editing.js">calendar/base/content/calendar-item-editing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-item-editing.js">file</a> |
<a href="/comm-central/annotate/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-item-editing.js">annotate</a> |
<a href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-item-editing.js">diff</a> |
<a href="/comm-central/comparison/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-item-editing.js">comparison</a> |
<a href="/comm-central/log/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-item-editing.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-summary-dialog.js">calendar/base/content/calendar-summary-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-summary-dialog.js">file</a> |
<a href="/comm-central/annotate/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-summary-dialog.js">annotate</a> |
<a href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-summary-dialog.js">diff</a> |
<a href="/comm-central/comparison/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-summary-dialog.js">comparison</a> |
<a href="/comm-central/log/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-summary-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-task-editing.js">calendar/base/content/calendar-task-editing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-task-editing.js">file</a> |
<a href="/comm-central/annotate/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-task-editing.js">annotate</a> |
<a href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-task-editing.js">diff</a> |
<a href="/comm-central/comparison/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-task-editing.js">comparison</a> |
<a href="/comm-central/log/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-task-editing.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-task-tree.xml">calendar/base/content/calendar-task-tree.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-task-tree.xml">file</a> |
<a href="/comm-central/annotate/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-task-tree.xml">annotate</a> |
<a href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-task-tree.xml">diff</a> |
<a href="/comm-central/comparison/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-task-tree.xml">comparison</a> |
<a href="/comm-central/log/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-task-tree.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-unifinder.js">calendar/base/content/calendar-unifinder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-unifinder.js">file</a> |
<a href="/comm-central/annotate/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-unifinder.js">annotate</a> |
<a href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-unifinder.js">diff</a> |
<a href="/comm-central/comparison/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-unifinder.js">comparison</a> |
<a href="/comm-central/log/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-unifinder.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-view-core.xml">calendar/base/content/calendar-view-core.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-view-core.xml">file</a> |
<a href="/comm-central/annotate/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-view-core.xml">annotate</a> |
<a href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-view-core.xml">diff</a> |
<a href="/comm-central/comparison/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-view-core.xml">comparison</a> |
<a href="/comm-central/log/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-view-core.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-views.js">calendar/base/content/calendar-views.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-views.js">file</a> |
<a href="/comm-central/annotate/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-views.js">annotate</a> |
<a href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-views.js">diff</a> |
<a href="/comm-central/comparison/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-views.js">comparison</a> |
<a href="/comm-central/log/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/calendar-views.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/dialogs/calendar-invitations-dialog.js">calendar/base/content/dialogs/calendar-invitations-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/dialogs/calendar-invitations-dialog.js">file</a> |
<a href="/comm-central/annotate/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/dialogs/calendar-invitations-dialog.js">annotate</a> |
<a href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/dialogs/calendar-invitations-dialog.js">diff</a> |
<a href="/comm-central/comparison/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/dialogs/calendar-invitations-dialog.js">comparison</a> |
<a href="/comm-central/log/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/content/dialogs/calendar-invitations-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/modules/Makefile.in">calendar/base/modules/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/modules/Makefile.in">file</a> |
<a href="/comm-central/annotate/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/modules/Makefile.in">annotate</a> |
<a href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/modules/Makefile.in">diff</a> |
<a href="/comm-central/comparison/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/modules/Makefile.in">comparison</a> |
<a href="/comm-central/log/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/modules/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/modules/calAlarmUtils.jsm">calendar/base/modules/calAlarmUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/modules/calAlarmUtils.jsm">file</a> |
<a href="/comm-central/annotate/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/modules/calAlarmUtils.jsm">annotate</a> |
<a href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/modules/calAlarmUtils.jsm">diff</a> |
<a href="/comm-central/comparison/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/modules/calAlarmUtils.jsm">comparison</a> |
<a href="/comm-central/log/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/modules/calAlarmUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/modules/calItipUtils.jsm">calendar/base/modules/calItipUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/modules/calItipUtils.jsm">file</a> |
<a href="/comm-central/annotate/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/modules/calItipUtils.jsm">annotate</a> |
<a href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/modules/calItipUtils.jsm">diff</a> |
<a href="/comm-central/comparison/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/modules/calItipUtils.jsm">comparison</a> |
<a href="/comm-central/log/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/modules/calItipUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/public/calIItemBase.idl">calendar/base/public/calIItemBase.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/public/calIItemBase.idl">file</a> |
<a href="/comm-central/annotate/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/public/calIItemBase.idl">annotate</a> |
<a href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/public/calIItemBase.idl">diff</a> |
<a href="/comm-central/comparison/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/public/calIItemBase.idl">comparison</a> |
<a href="/comm-central/log/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/public/calIItemBase.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/src/calAlarmService.js">calendar/base/src/calAlarmService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/src/calAlarmService.js">file</a> |
<a href="/comm-central/annotate/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/src/calAlarmService.js">annotate</a> |
<a href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/src/calAlarmService.js">diff</a> |
<a href="/comm-central/comparison/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/src/calAlarmService.js">comparison</a> |
<a href="/comm-central/log/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/src/calAlarmService.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/src/calItemBase.js">calendar/base/src/calItemBase.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/src/calItemBase.js">file</a> |
<a href="/comm-central/annotate/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/src/calItemBase.js">annotate</a> |
<a href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/src/calItemBase.js">diff</a> |
<a href="/comm-central/comparison/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/src/calItemBase.js">comparison</a> |
<a href="/comm-central/log/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/src/calItemBase.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/src/calItipItem.js">calendar/base/src/calItipItem.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/src/calItipItem.js">file</a> |
<a href="/comm-central/annotate/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/src/calItipItem.js">annotate</a> |
<a href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/src/calItipItem.js">diff</a> |
<a href="/comm-central/comparison/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/src/calItipItem.js">comparison</a> |
<a href="/comm-central/log/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/src/calItipItem.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/src/calUtils.js">calendar/base/src/calUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/src/calUtils.js">file</a> |
<a href="/comm-central/annotate/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/src/calUtils.js">annotate</a> |
<a href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/src/calUtils.js">diff</a> |
<a href="/comm-central/comparison/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/src/calUtils.js">comparison</a> |
<a href="/comm-central/log/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/base/src/calUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/import-export/calOutlookCSVImportExport.js">calendar/import-export/calOutlookCSVImportExport.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/import-export/calOutlookCSVImportExport.js">file</a> |
<a href="/comm-central/annotate/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/import-export/calOutlookCSVImportExport.js">annotate</a> |
<a href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/import-export/calOutlookCSVImportExport.js">diff</a> |
<a href="/comm-central/comparison/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/import-export/calOutlookCSVImportExport.js">comparison</a> |
<a href="/comm-central/log/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/import-export/calOutlookCSVImportExport.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/providers/gdata/components/calGoogleUtils.js">calendar/providers/gdata/components/calGoogleUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/providers/gdata/components/calGoogleUtils.js">file</a> |
<a href="/comm-central/annotate/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/providers/gdata/components/calGoogleUtils.js">annotate</a> |
<a href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/providers/gdata/components/calGoogleUtils.js">diff</a> |
<a href="/comm-central/comparison/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/providers/gdata/components/calGoogleUtils.js">comparison</a> |
<a href="/comm-central/log/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/providers/gdata/components/calGoogleUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/providers/storage/calStorageCalendar.js">calendar/providers/storage/calStorageCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/providers/storage/calStorageCalendar.js">file</a> |
<a href="/comm-central/annotate/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/providers/storage/calStorageCalendar.js">annotate</a> |
<a href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/providers/storage/calStorageCalendar.js">diff</a> |
<a href="/comm-central/comparison/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/providers/storage/calStorageCalendar.js">comparison</a> |
<a href="/comm-central/log/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/providers/storage/calStorageCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/providers/wcap/calWcapCalendarItems.js">calendar/providers/wcap/calWcapCalendarItems.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/providers/wcap/calWcapCalendarItems.js">file</a> |
<a href="/comm-central/annotate/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/providers/wcap/calWcapCalendarItems.js">annotate</a> |
<a href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/providers/wcap/calWcapCalendarItems.js">diff</a> |
<a href="/comm-central/comparison/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/providers/wcap/calWcapCalendarItems.js">comparison</a> |
<a href="/comm-central/log/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/providers/wcap/calWcapCalendarItems.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/test/unit/head_consts.js">calendar/test/unit/head_consts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/test/unit/head_consts.js">file</a> |
<a href="/comm-central/annotate/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/test/unit/head_consts.js">annotate</a> |
<a href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/test/unit/head_consts.js">diff</a> |
<a href="/comm-central/comparison/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/test/unit/head_consts.js">comparison</a> |
<a href="/comm-central/log/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/test/unit/head_consts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/test/unit/test_alarm.js">calendar/test/unit/test_alarm.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/test/unit/test_alarm.js">file</a> |
<a href="/comm-central/annotate/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/test/unit/test_alarm.js">annotate</a> |
<a href="/comm-central/diff/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/test/unit/test_alarm.js">diff</a> |
<a href="/comm-central/comparison/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/test/unit/test_alarm.js">comparison</a> |
<a href="/comm-central/log/a41dd9c8e51c03504ae72d24cf8e9d1767aa0e22/calendar/test/unit/test_alarm.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/content/calendar-dialog-utils.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/content/calendar-dialog-utils.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -611,45 +611,53 @@ var gLastAlarmSelection = 0;</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> /**</span>
<a href="#l1.6"></a><span id="l1.6">  * Load an item's reminders into the dialog</span>
<a href="#l1.7"></a><span id="l1.7">  *</span>
<a href="#l1.8"></a><span id="l1.8">  * @param item      The item to load.</span>
<a href="#l1.9"></a><span id="l1.9">  */</span>
<a href="#l1.10"></a><span id="l1.10"> function loadReminder(item) {</span>
<a href="#l1.11"></a><span id="l1.11">     // select 'no reminder' by default</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    var reminderPopup = document.getElementById(&quot;item-alarm&quot;);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    let reminderPopup = document.getElementById(&quot;item-alarm&quot;);</span>
<a href="#l1.14"></a><span id="l1.14">     reminderPopup.selectedIndex = 0;</span>
<a href="#l1.15"></a><span id="l1.15">     gLastAlarmSelection = 0;</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-    if (!item.alarmOffset) {</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+    // TODO ALARMSUPPORT right now, just consider the first relative alarm. This</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+    // should change as soon as the UI supports multiple alarms.</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+    let alarms = item.getAlarms({})</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+                     .filter(function(x) x.related != x.ALARM_RELATED_ABSOLUTE);</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+    let alarm = alarms[0];</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+    if (!alarm) {</span>
<a href="#l1.24"></a><span id="l1.24">         return;</span>
<a href="#l1.25"></a><span id="l1.25">     }</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+    // END TODO ALARMSUPPORT</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+        </span>
<a href="#l1.28"></a><span id="l1.28"> </span>
<a href="#l1.29"></a><span id="l1.29">     // try to match the reminder setting with the available popup items</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-    var origin = &quot;1&quot;;</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-    if (item.alarmRelated == Components.interfaces.calIItemBase.ALARM_RELATED_END) {</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+    let origin = &quot;1&quot;;</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+    if (alarm.related == Components.interfaces.calIAlarm.ALARM_RELATED_END) {</span>
<a href="#l1.34"></a><span id="l1.34">         origin = &quot;-1&quot;;</span>
<a href="#l1.35"></a><span id="l1.35">     }</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-    var duration = item.alarmOffset.clone();</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-    var relation = &quot;END&quot;;</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+    let duration = alarm.offset.clone();</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+    let relation = &quot;END&quot;;</span>
<a href="#l1.40"></a><span id="l1.40">     if (duration.isNegative) {</span>
<a href="#l1.41"></a><span id="l1.41">         duration.isNegative = false;</span>
<a href="#l1.42"></a><span id="l1.42">         duration.normalize();</span>
<a href="#l1.43"></a><span id="l1.43">         relation = &quot;START&quot;;</span>
<a href="#l1.44"></a><span id="l1.44">     }</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-    var matchingItem = null;</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-    var menuItems = reminderPopup.getElementsByTagName(&quot;menuitem&quot;);</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-    var numItems = menuItems.length;</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-    for (var i=0; i&lt;numItems; i++) {</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-        var menuitem = menuItems[i];</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+    let matchingItem = null;</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+    let menuItems = reminderPopup.getElementsByTagName(&quot;menuitem&quot;);</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+    let numItems = menuItems.length;</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+    for (let i = 0; i &lt; numItems; i++) {</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+        let menuitem = menuItems[i];</span>
<a href="#l1.55"></a><span id="l1.55">         if (menuitem.hasAttribute(&quot;length&quot;)) {</span>
<a href="#l1.56"></a><span id="l1.56">             if (menuitem.getAttribute(&quot;origin&quot;) == origin &amp;&amp;</span>
<a href="#l1.57"></a><span id="l1.57">                 menuitem.getAttribute(&quot;relation&quot;) == relation) {</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-                var unit = menuitem.getAttribute(&quot;unit&quot;);</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-                var length = menuitem.getAttribute(&quot;length&quot;);</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+                let unit = menuitem.getAttribute(&quot;unit&quot;);</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+                let length = menuitem.getAttribute(&quot;length&quot;);</span>
<a href="#l1.62"></a><span id="l1.62">                 if (unit == &quot;days&quot;) {</span>
<a href="#l1.63"></a><span id="l1.63">                     length = length * 60 * 60 * 24;</span>
<a href="#l1.64"></a><span id="l1.64">                 } else if (unit == &quot;hours&quot;) {</span>
<a href="#l1.65"></a><span id="l1.65">                     length = length * 60 * 60;</span>
<a href="#l1.66"></a><span id="l1.66">                 } else if (unit == &quot;minutes&quot;) {</span>
<a href="#l1.67"></a><span id="l1.67">                     length = length * 60;</span>
<a href="#l1.68"></a><span id="l1.68">                 } else {</span>
<a href="#l1.69"></a><span id="l1.69">                     continue;</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineat">@@ -671,31 +679,31 @@ function loadReminder(item) {</span>
<a href="#l1.71"></a><span id="l1.71">                 break;</span>
<a href="#l1.72"></a><span id="l1.72">             }</span>
<a href="#l1.73"></a><span id="l1.73">         }</span>
<a href="#l1.74"></a><span id="l1.74">     } else {</span>
<a href="#l1.75"></a><span id="l1.75">         reminderPopup.value = 'custom';</span>
<a href="#l1.76"></a><span id="l1.76">         var customReminder =</span>
<a href="#l1.77"></a><span id="l1.77">             document.getElementById(&quot;reminder-custom-menuitem&quot;);</span>
<a href="#l1.78"></a><span id="l1.78">         var reminder = {};</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-        if (item.alarmRelated == Components.interfaces.calIItemBase.ALARM_RELATED_START) {</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+        if (alarm.related == Components.interfaces.calIAlarm.ALARM_RELATED_START) {</span>
<a href="#l1.81"></a><span id="l1.81">             reminder.origin = &quot;1&quot;;</span>
<a href="#l1.82"></a><span id="l1.82">         } else {</span>
<a href="#l1.83"></a><span id="l1.83">             reminder.origin = &quot;-1&quot;;</span>
<a href="#l1.84"></a><span id="l1.84">         }</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineminus">-        var offset = item.alarmOffset.clone();</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-        var relation = &quot;END&quot;;</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+        let offset = alarm.offset.clone();</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+        relation = &quot;END&quot;;</span>
<a href="#l1.89"></a><span id="l1.89">         if (offset.isNegative) {</span>
<a href="#l1.90"></a><span id="l1.90">             offset.isNegative = false;</span>
<a href="#l1.91"></a><span id="l1.91">             offset.normalize();</span>
<a href="#l1.92"></a><span id="l1.92">             relation = &quot;START&quot;;</span>
<a href="#l1.93"></a><span id="l1.93">         }</span>
<a href="#l1.94"></a><span id="l1.94">         reminder.relation = relation;</span>
<a href="#l1.95"></a><span id="l1.95">         if (offset.minutes) {</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineminus">-            var minutes = offset.minutes +</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineplus">+            let minutes = offset.minutes +</span>
<a href="#l1.98"></a><span id="l1.98">                           offset.hours * 60 +</span>
<a href="#l1.99"></a><span id="l1.99">                           offset.days * 24 * 60 +</span>
<a href="#l1.100"></a><span id="l1.100">                           offset.weeks * 60 * 24 * 7;</span>
<a href="#l1.101"></a><span id="l1.101">             reminder.unit = 'minutes';</span>
<a href="#l1.102"></a><span id="l1.102">             reminder.length = minutes;</span>
<a href="#l1.103"></a><span id="l1.103">         } else if (offset.hours) {</span>
<a href="#l1.104"></a><span id="l1.104">             var hours = offset.hours + offset.days * 24 + offset.weeks * 24 * 7;</span>
<a href="#l1.105"></a><span id="l1.105">             reminder.unit = 'hours';</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineat">@@ -713,21 +721,20 @@ function loadReminder(item) {</span>
<a href="#l1.107"></a><span id="l1.107"> }</span>
<a href="#l1.108"></a><span id="l1.108"> </span>
<a href="#l1.109"></a><span id="l1.109"> /**</span>
<a href="#l1.110"></a><span id="l1.110">  * Save the selected reminder into the passed item.</span>
<a href="#l1.111"></a><span id="l1.111">  *</span>
<a href="#l1.112"></a><span id="l1.112">  * @param item      The item save the reminder into.</span>
<a href="#l1.113"></a><span id="l1.113">  */</span>
<a href="#l1.114"></a><span id="l1.114"> function saveReminder(item) {</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+    item.clearAlarms();</span>
<a href="#l1.116"></a><span id="l1.116">     var reminderPopup = document.getElementById(&quot;item-alarm&quot;);</span>
<a href="#l1.117"></a><span id="l1.117">     if (reminderPopup.value == 'none') {</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineminus">-        item.alarmOffset = null;</span>
<a href="#l1.119"></a><span id="l1.119">         item.alarmLastAck = null;</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineminus">-        item.alarmRelated = null;</span>
<a href="#l1.121"></a><span id="l1.121">     } else {</span>
<a href="#l1.122"></a><span id="l1.122">         var menuitem = reminderPopup.selectedItem;</span>
<a href="#l1.123"></a><span id="l1.123"> </span>
<a href="#l1.124"></a><span id="l1.124">         // custom reminder entries carry their own reminder object</span>
<a href="#l1.125"></a><span id="l1.125">         // with them, pre-defined entries specify the necessary information</span>
<a href="#l1.126"></a><span id="l1.126">         // as attributes attached to the menuitem elements.</span>
<a href="#l1.127"></a><span id="l1.127">         var reminder = menuitem.reminder;</span>
<a href="#l1.128"></a><span id="l1.128">         if (!reminder) {</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineat">@@ -741,23 +748,26 @@ function saveReminder(item) {</span>
<a href="#l1.130"></a><span id="l1.130">         var duration = Components.classes[&quot;@mozilla.org/calendar/duration;1&quot;]</span>
<a href="#l1.131"></a><span id="l1.131">                        .createInstance(Components.interfaces.calIDuration);</span>
<a href="#l1.132"></a><span id="l1.132"> </span>
<a href="#l1.133"></a><span id="l1.133">         duration[reminder.unit] = Number(reminder.length);</span>
<a href="#l1.134"></a><span id="l1.134">         if (reminder.relation != &quot;END&quot;) {</span>
<a href="#l1.135"></a><span id="l1.135">             duration.isNegative = true;</span>
<a href="#l1.136"></a><span id="l1.136">         }</span>
<a href="#l1.137"></a><span id="l1.137">         duration.normalize();</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-        item.alarmOffset = duration;</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+        let alarm = cal.createAlarm();</span>
<a href="#l1.140"></a><span id="l1.140"> </span>
<a href="#l1.141"></a><span id="l1.141">         if (Number(reminder.origin) &gt;= 0) {</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineminus">-            item.alarmRelated = Components.interfaces.calIItemBase.ALARM_RELATED_START;</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+            alarm.related = Components.interfaces.calIAlarm.ALARM_RELATED_START;</span>
<a href="#l1.144"></a><span id="l1.144">         } else {</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineminus">-            item.alarmRelated = Components.interfaces.calIItemBase.ALARM_RELATED_END;</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineplus">+            alarm.related = Components.interfaces.calIAlarm.ALARM_RELATED_END;</span>
<a href="#l1.147"></a><span id="l1.147">         }</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+        alarm.offset = duration;</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+        item.addAlarm(alarm);</span>
<a href="#l1.151"></a><span id="l1.151">     }</span>
<a href="#l1.152"></a><span id="l1.152"> }</span>
<a href="#l1.153"></a><span id="l1.153"> </span>
<a href="#l1.154"></a><span id="l1.154"> /**</span>
<a href="#l1.155"></a><span id="l1.155">  * Common update functions for both event dialogs. Called when a reminder has</span>
<a href="#l1.156"></a><span id="l1.156">  * been selected from the menulist.</span>
<a href="#l1.157"></a><span id="l1.157">  */</span>
<a href="#l1.158"></a><span id="l1.158"> function commonUpdateReminder() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/content/calendar-dnd-listener.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/content/calendar-dnd-listener.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -32,33 +32,35 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l2.5"></a><span id="l2.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l2.6"></a><span id="l2.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l2.7"></a><span id="l2.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l2.8"></a><span id="l2.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l2.9"></a><span id="l2.9">  *</span>
<a href="#l2.10"></a><span id="l2.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calAlarmUtils.jsm&quot;);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+</span>
<a href="#l2.14"></a><span id="l2.14"> var itemConversion = {</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16">     /**</span>
<a href="#l2.17"></a><span id="l2.17">      * Converts an email message to a calendar item.</span>
<a href="#l2.18"></a><span id="l2.18">      *</span>
<a href="#l2.19"></a><span id="l2.19">      * XXX Currently, only the title is taken from the passed message. Aside</span>
<a href="#l2.20"></a><span id="l2.20">      * from that, the currently visible message in the preview pane is used.</span>
<a href="#l2.21"></a><span id="l2.21">      *</span>
<a href="#l2.22"></a><span id="l2.22">      * @param aItem     The target calIItemBase.</span>
<a href="#l2.23"></a><span id="l2.23">      * @param aMessage  The message  to convert from</span>
<a href="#l2.24"></a><span id="l2.24">      */</span>
<a href="#l2.25"></a><span id="l2.25">     calendarItemFromMessage: function iC_calendarItemFromMessage(aItem, aMessage) {</span>
<a href="#l2.26"></a><span id="l2.26">         aItem.calendar = getSelectedCalendar();</span>
<a href="#l2.27"></a><span id="l2.27">         aItem.title = aMessage.mime2DecodedSubject;</span>
<a href="#l2.28"></a><span id="l2.28"> </span>
<a href="#l2.29"></a><span id="l2.29">         setDefaultStartEndHour(aItem);</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-        setDefaultAlarmValues(aItem);</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+        cal.alarms.setDefaultValues(aItem);</span>
<a href="#l2.32"></a><span id="l2.32"> </span>
<a href="#l2.33"></a><span id="l2.33">         // XXX It would be great if nsPlainTextParser could take care of this.</span>
<a href="#l2.34"></a><span id="l2.34">         function htmlToPlainText(html) {</span>
<a href="#l2.35"></a><span id="l2.35">           var texts = html.split(/(&lt;\/?[^&gt;]+&gt;)/);</span>
<a href="#l2.36"></a><span id="l2.36">           var text = texts.map(function hTPT_map(string) {</span>
<a href="#l2.37"></a><span id="l2.37">               if (string.length &gt; 0 &amp;&amp; string[0] == '&lt;') {</span>
<a href="#l2.38"></a><span id="l2.38">                   var regExpRes = string.match(/^&lt;img.*?alt\s*=\s*['&quot;](.*)[&quot;']/i)</span>
<a href="#l2.39"></a><span id="l2.39">                   if (regExpRes) {</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineat">@@ -151,20 +153,19 @@ var itemConversion = {</span>
<a href="#l2.41"></a><span id="l2.41"> </span>
<a href="#l2.42"></a><span id="l2.42">         // Dates and alarms</span>
<a href="#l2.43"></a><span id="l2.43">         if (!aEvent.startDate.isDate &amp;&amp; !aEvent.endDate.isDate) {</span>
<a href="#l2.44"></a><span id="l2.44">             // Dates</span>
<a href="#l2.45"></a><span id="l2.45">             item.entryDate = aEvent.startDate.clone();</span>
<a href="#l2.46"></a><span id="l2.46">             item.dueDate = aEvent.endDate.clone();</span>
<a href="#l2.47"></a><span id="l2.47"> </span>
<a href="#l2.48"></a><span id="l2.48">             // Alarms</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-            item.alarmOffset = (aEvent.alarmOffset ?</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-                                aEvent.alarmOffset.clone() :</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-                                null);</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-            item.alarmRelated = aEvent.alarmRelated;</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+            for each (let alarm in aEvent.getAlarms({})) {</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+                item.addAlarm(alarm.clone());</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+            }</span>
<a href="#l2.56"></a><span id="l2.56">             item.alarmLastAck = (aEvent.alarmLastAck ?</span>
<a href="#l2.57"></a><span id="l2.57">                                  aEvent.alarmLastAck.clone() :</span>
<a href="#l2.58"></a><span id="l2.58">                                  null);</span>
<a href="#l2.59"></a><span id="l2.59">         }</span>
<a href="#l2.60"></a><span id="l2.60">         return item;</span>
<a href="#l2.61"></a><span id="l2.61">     },</span>
<a href="#l2.62"></a><span id="l2.62"> </span>
<a href="#l2.63"></a><span id="l2.63">     /**</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineat">@@ -190,20 +191,19 @@ var itemConversion = {</span>
<a href="#l2.65"></a><span id="l2.65">         if (!item.endDate) {</span>
<a href="#l2.66"></a><span id="l2.66">             // Make the event be the default event length if no due date was</span>
<a href="#l2.67"></a><span id="l2.67">             // specified.</span>
<a href="#l2.68"></a><span id="l2.68">             item.endDate = item.startDate.clone();</span>
<a href="#l2.69"></a><span id="l2.69">             item.endDate.minute += getPrefSafe(&quot;calendar.event.defaultlength&quot;, 60);</span>
<a href="#l2.70"></a><span id="l2.70">         }</span>
<a href="#l2.71"></a><span id="l2.71"> </span>
<a href="#l2.72"></a><span id="l2.72">         // Alarms</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-        item.alarmOffset = (aTask.alarmOffset ?</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-                            aTask.alarmOffset.clone() :</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-                            null);</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-        item.alarmRelated = aTask.alarmRelated;</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+        for each (let alarm in aEvent.getAlarms({})) {</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+            item.addAlarm(alarm.clone());</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+        }</span>
<a href="#l2.80"></a><span id="l2.80">         item.alarmLastAck = (aTask.alarmLastAck ?</span>
<a href="#l2.81"></a><span id="l2.81">                              aTask.alarmLastAck.clone() :</span>
<a href="#l2.82"></a><span id="l2.82">                              null);</span>
<a href="#l2.83"></a><span id="l2.83">         return item;</span>
<a href="#l2.84"></a><span id="l2.84">     }</span>
<a href="#l2.85"></a><span id="l2.85"> };</span>
<a href="#l2.86"></a><span id="l2.86"> </span>
<a href="#l2.87"></a><span id="l2.87"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/content/calendar-item-editing.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/content/calendar-item-editing.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -32,16 +32,18 @@</span>
<a href="#l3.4"></a><span id="l3.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l3.5"></a><span id="l3.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l3.6"></a><span id="l3.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l3.7"></a><span id="l3.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l3.8"></a><span id="l3.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l3.9"></a><span id="l3.9">  *</span>
<a href="#l3.10"></a><span id="l3.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calAlarmUtils.jsm&quot;);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+</span>
<a href="#l3.14"></a><span id="l3.14"> /**</span>
<a href="#l3.15"></a><span id="l3.15">  * Creates an event with the calendar event dialog.</span>
<a href="#l3.16"></a><span id="l3.16">  *</span>
<a href="#l3.17"></a><span id="l3.17">  * @param calendar      (optional) The calendar to create the event in</span>
<a href="#l3.18"></a><span id="l3.18">  * @param startDate     (optional) The event's start date.</span>
<a href="#l3.19"></a><span id="l3.19">  * @param endDate       (optional) The event's end date.</span>
<a href="#l3.20"></a><span id="l3.20">  * @param summary       (optional) The event's title.</span>
<a href="#l3.21"></a><span id="l3.21">  * @param event         (optional) A template event to show in the dialog</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -129,17 +131,17 @@ function createEventWithDialog(calendar,</span>
<a href="#l3.23"></a><span id="l3.23">         }</span>
<a href="#l3.24"></a><span id="l3.24"> </span>
<a href="#l3.25"></a><span id="l3.25">         event.calendar = calendar || getSelectedCalendar();</span>
<a href="#l3.26"></a><span id="l3.26"> </span>
<a href="#l3.27"></a><span id="l3.27">         if (summary) {</span>
<a href="#l3.28"></a><span id="l3.28">             event.title = summary;</span>
<a href="#l3.29"></a><span id="l3.29">         }</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-        setDefaultAlarmValues(event);</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+        cal.alarms.setDefaultValues(event);</span>
<a href="#l3.33"></a><span id="l3.33">     }</span>
<a href="#l3.34"></a><span id="l3.34">     openEventDialog(event, calendar, &quot;new&quot;, onNewEvent, null);</span>
<a href="#l3.35"></a><span id="l3.35"> }</span>
<a href="#l3.36"></a><span id="l3.36"> </span>
<a href="#l3.37"></a><span id="l3.37"> /**</span>
<a href="#l3.38"></a><span id="l3.38">  * Creates a task with the calendar event dialog.</span>
<a href="#l3.39"></a><span id="l3.39">  *</span>
<a href="#l3.40"></a><span id="l3.40">  * @param calendar      (optional) The calendar to create the task in</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineat">@@ -178,17 +180,17 @@ function createTodoWithDialog(calendar, </span>
<a href="#l3.42"></a><span id="l3.42">         todo.calendar = calendar || getSelectedCalendar();</span>
<a href="#l3.43"></a><span id="l3.43"> </span>
<a href="#l3.44"></a><span id="l3.44">         if (summary)</span>
<a href="#l3.45"></a><span id="l3.45">             todo.title = summary;</span>
<a href="#l3.46"></a><span id="l3.46"> </span>
<a href="#l3.47"></a><span id="l3.47">         if (dueDate)</span>
<a href="#l3.48"></a><span id="l3.48">             todo.dueDate = dueDate;</span>
<a href="#l3.49"></a><span id="l3.49"> </span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-        setDefaultAlarmValues(todo);</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+        cal.alarms.setDefaultValues(todo);</span>
<a href="#l3.52"></a><span id="l3.52">     }</span>
<a href="#l3.53"></a><span id="l3.53"> </span>
<a href="#l3.54"></a><span id="l3.54">     openEventDialog(todo, calendar, &quot;new&quot;, onNewItem, null);</span>
<a href="#l3.55"></a><span id="l3.55"> }</span>
<a href="#l3.56"></a><span id="l3.56"> </span>
<a href="#l3.57"></a><span id="l3.57"> </span>
<a href="#l3.58"></a><span id="l3.58"> </span>
<a href="#l3.59"></a><span id="l3.59"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/content/calendar-summary-dialog.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/content/calendar-summary-dialog.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -33,16 +33,17 @@</span>
<a href="#l4.4"></a><span id="l4.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l4.5"></a><span id="l4.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l4.6"></a><span id="l4.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.7"></a><span id="l4.7">  *</span>
<a href="#l4.8"></a><span id="l4.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l4.11"></a><span id="l4.11"> Components.utils.import(&quot;resource://calendar/modules/calItipUtils.jsm&quot;);</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calAlarmUtils.jsm&quot;);</span>
<a href="#l4.13"></a><span id="l4.13"> </span>
<a href="#l4.14"></a><span id="l4.14"> /**</span>
<a href="#l4.15"></a><span id="l4.15">  * Sets up the summary dialog, setting all needed fields on the dialog from the</span>
<a href="#l4.16"></a><span id="l4.16">  * item received in the window arguments.</span>
<a href="#l4.17"></a><span id="l4.17">  */</span>
<a href="#l4.18"></a><span id="l4.18"> function onLoad() {</span>
<a href="#l4.19"></a><span id="l4.19">     var args = window.arguments[0];</span>
<a href="#l4.20"></a><span id="l4.20">     var item = args.calendarEvent;</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineat">@@ -76,18 +77,19 @@ function onLoad() {</span>
<a href="#l4.22"></a><span id="l4.22">         }</span>
<a href="#l4.23"></a><span id="l4.23">     }</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25">     window.readOnly = calendar.readOnly;</span>
<a href="#l4.26"></a><span id="l4.26">     if (!window.readOnly &amp;&amp; calInstanceOf(calendar, Components.interfaces.calISchedulingSupport)) {</span>
<a href="#l4.27"></a><span id="l4.27">         var attendee = calendar.getInvitedAttendee(item);</span>
<a href="#l4.28"></a><span id="l4.28">         if (attendee) {</span>
<a href="#l4.29"></a><span id="l4.29">             // if this is an unresponded invitation, preset our default alarm values:</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-            if (!item.alarmOffset &amp;&amp; (attendee.participationStatus == &quot;NEEDS-ACTION&quot;)) {</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-                cal.setDefaultAlarmValues(item);</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+            if (!item.getAlarms({}).length &amp;&amp;</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+                (attendee.participationStatus == &quot;NEEDS-ACTION&quot;)) {</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+                cal.alarms.setDefaultValues(item);</span>
<a href="#l4.35"></a><span id="l4.35">             }</span>
<a href="#l4.36"></a><span id="l4.36"> </span>
<a href="#l4.37"></a><span id="l4.37">             window.attendee = attendee.clone();</span>
<a href="#l4.38"></a><span id="l4.38">             // Since we don't have API to update an attendee in place, remove</span>
<a href="#l4.39"></a><span id="l4.39">             // and add again. Also, this is needed if the attendee doesn't exist</span>
<a href="#l4.40"></a><span id="l4.40">             // (i.e REPLY on a mailing list)</span>
<a href="#l4.41"></a><span id="l4.41">             item.removeAttendee(attendee);</span>
<a href="#l4.42"></a><span id="l4.42">             item.addAttendee(window.attendee);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/content/calendar-task-editing.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-editing.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -30,16 +30,18 @@</span>
<a href="#l5.4"></a><span id="l5.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l5.5"></a><span id="l5.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l5.6"></a><span id="l5.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l5.7"></a><span id="l5.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l5.8"></a><span id="l5.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l5.9"></a><span id="l5.9">  *</span>
<a href="#l5.10"></a><span id="l5.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calAlarmUtils.jsm&quot;);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+</span>
<a href="#l5.14"></a><span id="l5.14"> /**</span>
<a href="#l5.15"></a><span id="l5.15">  * Used by the &quot;quick add&quot; feature for tasks, for example in the task view or</span>
<a href="#l5.16"></a><span id="l5.16">  * the uniinder-todo.</span>
<a href="#l5.17"></a><span id="l5.17">  *</span>
<a href="#l5.18"></a><span id="l5.18">  * NOTE: many of the following methods are called without taskEdit being the</span>
<a href="#l5.19"></a><span id="l5.19">  * |this| object.</span>
<a href="#l5.20"></a><span id="l5.20">  */</span>
<a href="#l5.21"></a><span id="l5.21"> </span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -156,17 +158,17 @@ var taskEdit = {</span>
<a href="#l5.23"></a><span id="l5.23">     onKeyPress: function tE_onKeyPress(aEvent) {</span>
<a href="#l5.24"></a><span id="l5.24">         if (aEvent.keyCode == Components.interfaces.nsIDOMKeyEvent.DOM_VK_RETURN) {</span>
<a href="#l5.25"></a><span id="l5.25">             var edit = aEvent.target;</span>
<a href="#l5.26"></a><span id="l5.26">             if (edit.value &amp;&amp; edit.value.length &gt; 0) {</span>
<a href="#l5.27"></a><span id="l5.27">                 var item = createTodo();</span>
<a href="#l5.28"></a><span id="l5.28">                 item.calendar = getSelectedCalendar();</span>
<a href="#l5.29"></a><span id="l5.29">                 item.title = edit.value;</span>
<a href="#l5.30"></a><span id="l5.30">                 edit.value = &quot;&quot;;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-                setDefaultAlarmValues(item);</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+                cal.alarms.setDefaultValues(item);</span>
<a href="#l5.33"></a><span id="l5.33">                 doTransaction('add', item, item.calendar, null, null);</span>
<a href="#l5.34"></a><span id="l5.34">             }</span>
<a href="#l5.35"></a><span id="l5.35">         }</span>
<a href="#l5.36"></a><span id="l5.36">     },</span>
<a href="#l5.37"></a><span id="l5.37"> </span>
<a href="#l5.38"></a><span id="l5.38">     /**</span>
<a href="#l5.39"></a><span id="l5.39">      * Window load function to set up all quick-add textboxes. The texbox must</span>
<a href="#l5.40"></a><span id="l5.40">      * have the class &quot;task-edit-field&quot;.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/base/content/calendar-task-tree.xml</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-tree.xml</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -487,17 +487,17 @@</span>
<a href="#l6.4"></a><span id="l6.4">               aProps.AppendElement(getAtomFromService(calendarIdAtom));</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6">               // Add item status atom</span>
<a href="#l6.7"></a><span id="l6.7">               if (item.status) {</span>
<a href="#l6.8"></a><span id="l6.8">                   aProps.AppendElement(getAtomFromService(&quot;status-&quot; + item.status.toLowerCase()));</span>
<a href="#l6.9"></a><span id="l6.9">               }</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11">               // Alarm status atom</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-              if (item.alarmOffset) {</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+              if (item.getAlarms({}).length) {</span>
<a href="#l6.14"></a><span id="l6.14">                   aProps.AppendElement(getAtomFromService(&quot;alarm&quot;));</span>
<a href="#l6.15"></a><span id="l6.15">               }</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17">               // Task categories</span>
<a href="#l6.18"></a><span id="l6.18">               var categories = item.getCategories({});</span>
<a href="#l6.19"></a><span id="l6.19">               categories.map(formatStringForCSSRule)</span>
<a href="#l6.20"></a><span id="l6.20">                         .map(getAtomFromService)</span>
<a href="#l6.21"></a><span id="l6.21">                         .forEach(aProps.AppendElement, aProps);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/base/content/calendar-unifinder.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/base/content/calendar-unifinder.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -699,17 +699,17 @@ var unifinderTreeView = {</span>
<a href="#l7.4"></a><span id="l7.4">         aProps.AppendElement(getAtomFromService(calendarAtom));</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6">         // Add item status atom</span>
<a href="#l7.7"></a><span id="l7.7">         if (item.status) {</span>
<a href="#l7.8"></a><span id="l7.8">             aProps.AppendElement(getAtomFromService(&quot;status-&quot; + item.status.toLowerCase()));</span>
<a href="#l7.9"></a><span id="l7.9">         }</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11">         // Alarm status atom</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-        if (item.alarmOffset) {</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+        if (item.getAlarms({}).length) {</span>
<a href="#l7.14"></a><span id="l7.14">             aProps.AppendElement(getAtomFromService(&quot;alarm&quot;));</span>
<a href="#l7.15"></a><span id="l7.15">         }</span>
<a href="#l7.16"></a><span id="l7.16"> </span>
<a href="#l7.17"></a><span id="l7.17">         // Task categories</span>
<a href="#l7.18"></a><span id="l7.18">         item.getCategories({}).map(formatStringForCSSRule)</span>
<a href="#l7.19"></a><span id="l7.19">                               .map(getAtomFromService)</span>
<a href="#l7.20"></a><span id="l7.20">                               .forEach(aProps.AppendElement, aProps);</span>
<a href="#l7.21"></a><span id="l7.21">     },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/base/content/calendar-view-core.xml</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/base/content/calendar-view-core.xml</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -186,17 +186,17 @@</span>
<a href="#l8.4"></a><span id="l8.4">           var item = this.mOccurrence;          </span>
<a href="#l8.5"></a><span id="l8.5">           this.setAttribute(&quot;item-calendar&quot;, item.calendar.uri.spec);</span>
<a href="#l8.6"></a><span id="l8.6">           var categoriesArray = item.getCategories({});</span>
<a href="#l8.7"></a><span id="l8.7">           if (categoriesArray.length &gt; 0) {</span>
<a href="#l8.8"></a><span id="l8.8">             var cssClassesArray = categoriesArray.map(formatStringForCSSRule);</span>
<a href="#l8.9"></a><span id="l8.9">             this.setAttribute(&quot;categories&quot;, cssClassesArray.join(&quot; &quot;));</span>
<a href="#l8.10"></a><span id="l8.10">           }</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-          if (item.alarmOffset &amp;&amp; getPrefSafe(&quot;calendar.alarms.indicator.show&quot;, true)) {</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+          if (item.getAlarms({}).length &amp;&amp; getPrefSafe(&quot;calendar.alarms.indicator.show&quot;, true)) {</span>
<a href="#l8.14"></a><span id="l8.14">               var alarmImage = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;alarm-image&quot;);</span>
<a href="#l8.15"></a><span id="l8.15">               if (item.calendar.getProperty(&quot;suppressAlarms&quot;) &amp;&amp;</span>
<a href="#l8.16"></a><span id="l8.16">                   item.calendar.getProperty(&quot;capabilities.alarms.popup.supported&quot;) !== false) {</span>
<a href="#l8.17"></a><span id="l8.17">                   // Only show the suppressed icon if alarms are suppressed and</span>
<a href="#l8.18"></a><span id="l8.18">                   // popup alarms are supported. This keeps us from making the</span>
<a href="#l8.19"></a><span id="l8.19">                   // alarm look disabled when the server supports only email</span>
<a href="#l8.20"></a><span id="l8.20">                   // alarms (e.g. currently WCAP).</span>
<a href="#l8.21"></a><span id="l8.21">                   alarmImage.setAttribute(&quot;suppressed&quot;, &quot;true&quot;);</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -218,17 +218,17 @@</span>
<a href="#l8.23"></a><span id="l8.23">               this.setAttribute(&quot;progress&quot;, getProgressAtom(item));</span>
<a href="#l8.24"></a><span id="l8.24">           }</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26">           if (this.calendarView &amp;&amp;</span>
<a href="#l8.27"></a><span id="l8.27">               item.hashId in this.calendarView.mFlashingEvents) {</span>
<a href="#l8.28"></a><span id="l8.28">               this.setAttribute(&quot;flashing&quot;, &quot;true&quot;);</span>
<a href="#l8.29"></a><span id="l8.29">           }</span>
<a href="#l8.30"></a><span id="l8.30"> </span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-          if (item.alarmOffset) {</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+          if (item.getAlarms({}).length) {</span>
<a href="#l8.33"></a><span id="l8.33">               this.setAttribute(&quot;alarm&quot;, &quot;true&quot;)</span>
<a href="#l8.34"></a><span id="l8.34">           }</span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36">           // priority</span>
<a href="#l8.37"></a><span id="l8.37">           if (item.priority &gt; 0 &amp;&amp; item.priority &lt; 5) {</span>
<a href="#l8.38"></a><span id="l8.38">               this.setAttribute(&quot;priority&quot;, &quot;high&quot;);</span>
<a href="#l8.39"></a><span id="l8.39">           } else if (item.priority &gt; 5 &amp;&amp; item.priority &lt; 10) {</span>
<a href="#l8.40"></a><span id="l8.40">               this.setAttribute(&quot;priority&quot;, &quot;low&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/base/content/calendar-views.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/base/content/calendar-views.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -37,16 +37,18 @@</span>
<a href="#l9.4"></a><span id="l9.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l9.5"></a><span id="l9.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l9.6"></a><span id="l9.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l9.7"></a><span id="l9.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l9.8"></a><span id="l9.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l9.9"></a><span id="l9.9">  *</span>
<a href="#l9.10"></a><span id="l9.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calAlarmUtils.jsm&quot;);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+</span>
<a href="#l9.14"></a><span id="l9.14"> /**</span>
<a href="#l9.15"></a><span id="l9.15">  * Controller for the views</span>
<a href="#l9.16"></a><span id="l9.16">  * @see calIcalendarViewController</span>
<a href="#l9.17"></a><span id="l9.17">  */</span>
<a href="#l9.18"></a><span id="l9.18"> var calendarViewController = {</span>
<a href="#l9.19"></a><span id="l9.19">     QueryInterface: function(aIID) {</span>
<a href="#l9.20"></a><span id="l9.20">         if (!aIID.equals(Components.interfaces.calICalendarViewController) &amp;&amp;</span>
<a href="#l9.21"></a><span id="l9.21">             !aIID.equals(Components.interfaces.nsISupports)) {</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineat">@@ -67,17 +69,17 @@ var calendarViewController = {</span>
<a href="#l9.23"></a><span id="l9.23">         if (aStartTime &amp;&amp; aEndTime &amp;&amp; !aStartTime.isDate &amp;&amp; !aEndTime.isDate) {</span>
<a href="#l9.24"></a><span id="l9.24">             var event = createEvent();</span>
<a href="#l9.25"></a><span id="l9.25">             event.startDate = aStartTime;</span>
<a href="#l9.26"></a><span id="l9.26">             event.endDate = aEndTime;</span>
<a href="#l9.27"></a><span id="l9.27">             var sbs = Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l9.28"></a><span id="l9.28">                                 .getService(Components.interfaces.nsIStringBundleService);</span>
<a href="#l9.29"></a><span id="l9.29">             var props = sbs.createBundle(&quot;chrome://calendar/locale/calendar.properties&quot;);</span>
<a href="#l9.30"></a><span id="l9.30">             event.title = props.GetStringFromName(&quot;newEvent&quot;);</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-            setDefaultAlarmValues(event);</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+            cal.alarms.setDefaultValues(event);</span>
<a href="#l9.33"></a><span id="l9.33">             doTransaction('add', event, aCalendar, null, null);</span>
<a href="#l9.34"></a><span id="l9.34">         } else {</span>
<a href="#l9.35"></a><span id="l9.35">             createEventWithDialog(aCalendar, aStartTime, null, null, null, aForceAllday);</span>
<a href="#l9.36"></a><span id="l9.36">         }</span>
<a href="#l9.37"></a><span id="l9.37">     },</span>
<a href="#l9.38"></a><span id="l9.38"> </span>
<a href="#l9.39"></a><span id="l9.39">     pendingJobs: [],</span>
<a href="#l9.40"></a><span id="l9.40"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-invitations-dialog.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-invitations-dialog.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -15,32 +15,34 @@</span>
<a href="#l10.4"></a><span id="l10.4">  *</span>
<a href="#l10.5"></a><span id="l10.5">  * The Initial Developer of the Original Code is Sun Microsystems.</span>
<a href="#l10.6"></a><span id="l10.6">  * Portions created by the Initial Developer are Copyright (C) 2006</span>
<a href="#l10.7"></a><span id="l10.7">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l10.8"></a><span id="l10.8">  *</span>
<a href="#l10.9"></a><span id="l10.9">  * Contributor(s):</span>
<a href="#l10.10"></a><span id="l10.10">  *   Thomas Benisch &lt;thomas.benisch@sun.com&gt;</span>
<a href="#l10.11"></a><span id="l10.11">  *   Daniel Boelzle &lt;daniel.boelzle@sun.com&gt;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+ *   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l10.13"></a><span id="l10.13">  *</span>
<a href="#l10.14"></a><span id="l10.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l10.15"></a><span id="l10.15">  * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l10.16"></a><span id="l10.16">  * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l10.17"></a><span id="l10.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l10.18"></a><span id="l10.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l10.19"></a><span id="l10.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l10.20"></a><span id="l10.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l10.21"></a><span id="l10.21">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l10.22"></a><span id="l10.22">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l10.23"></a><span id="l10.23">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l10.24"></a><span id="l10.24">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l10.25"></a><span id="l10.25">  *</span>
<a href="#l10.26"></a><span id="l10.26">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l10.27"></a><span id="l10.27"> </span>
<a href="#l10.28"></a><span id="l10.28"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calAlarmUtils.jsm&quot;);</span>
<a href="#l10.30"></a><span id="l10.30"> </span>
<a href="#l10.31"></a><span id="l10.31"> /**</span>
<a href="#l10.32"></a><span id="l10.32">  * Sets up the invitations dialog from the window arguments, retrieves the</span>
<a href="#l10.33"></a><span id="l10.33">  * invitations from the invitations manager.</span>
<a href="#l10.34"></a><span id="l10.34">  */</span>
<a href="#l10.35"></a><span id="l10.35"> function onLoad() {</span>
<a href="#l10.36"></a><span id="l10.36">     var operationListener = {</span>
<a href="#l10.37"></a><span id="l10.37">         onOperationComplete: function oL_onOperationComplete(aCalendar,</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineat">@@ -132,18 +134,20 @@ function fillJobQueue(queue) {</span>
<a href="#l10.39"></a><span id="l10.39">         var newStatus = richListItem.participationStatus;</span>
<a href="#l10.40"></a><span id="l10.40">         var oldStatus = richListItem.initialParticipationStatus;</span>
<a href="#l10.41"></a><span id="l10.41">         if (newStatus != oldStatus) {</span>
<a href="#l10.42"></a><span id="l10.42">             var actionString = &quot;modify&quot;;</span>
<a href="#l10.43"></a><span id="l10.43">             var oldCalendarItem = richListItem.calendarItem;</span>
<a href="#l10.44"></a><span id="l10.44">             var newCalendarItem = oldCalendarItem.clone();</span>
<a href="#l10.45"></a><span id="l10.45"> </span>
<a href="#l10.46"></a><span id="l10.46">             // set default alarm on unresponded items that have not been declined:</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-            if (!newCalendarItem.alarmOffset &amp;&amp; (oldStatus == &quot;NEEDS-ACTION&quot;) &amp;&amp; (newStatus != &quot;DECLINED&quot;)) {</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-                cal.setDefaultAlarmValues(newCalendarItem);</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+            if (!newCalendarItem.getAlarms({}).length &amp;&amp;</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+                (oldStatus == &quot;NEEDS-ACTION&quot;) &amp;&amp;</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+                (newStatus != &quot;DECLINED&quot;)) {</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+                cal.alarms.setDefaultValues(newCalendarItem);</span>
<a href="#l10.53"></a><span id="l10.53">             }</span>
<a href="#l10.54"></a><span id="l10.54"> </span>
<a href="#l10.55"></a><span id="l10.55">             richListItem.setCalendarItemParticipationStatus(newCalendarItem,</span>
<a href="#l10.56"></a><span id="l10.56">                 newStatus);</span>
<a href="#l10.57"></a><span id="l10.57">             var job = {</span>
<a href="#l10.58"></a><span id="l10.58">                 action: actionString,</span>
<a href="#l10.59"></a><span id="l10.59">                 oldItem: oldCalendarItem,</span>
<a href="#l10.60"></a><span id="l10.60">                 newItem: newCalendarItem</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/calendar/base/modules/Makefile.in</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/calendar/base/modules/Makefile.in</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -15,16 +15,17 @@</span>
<a href="#l11.4"></a><span id="l11.4"> #</span>
<a href="#l11.5"></a><span id="l11.5"> # The Initial Developer of the Original Code is</span>
<a href="#l11.6"></a><span id="l11.6"> #   Sun Microsystems, Inc.</span>
<a href="#l11.7"></a><span id="l11.7"> # Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l11.8"></a><span id="l11.8"> # the Initial Developer. All Rights Reserved.</span>
<a href="#l11.9"></a><span id="l11.9"> #</span>
<a href="#l11.10"></a><span id="l11.10"> # Contributor(s):</span>
<a href="#l11.11"></a><span id="l11.11"> #   Daniel Boelzle &lt;daniel.boelzle@sun.com&gt;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+#   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l11.13"></a><span id="l11.13"> #</span>
<a href="#l11.14"></a><span id="l11.14"> # Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l11.15"></a><span id="l11.15"> # either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l11.16"></a><span id="l11.16"> # the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l11.17"></a><span id="l11.17"> # in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l11.18"></a><span id="l11.18"> # of those above. If you wish to allow use of your version of this file only</span>
<a href="#l11.19"></a><span id="l11.19"> # under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l11.20"></a><span id="l11.20"> # use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineat">@@ -40,16 +41,17 @@ topsrcdir = @top_srcdir@</span>
<a href="#l11.22"></a><span id="l11.22"> srcdir    = @srcdir@</span>
<a href="#l11.23"></a><span id="l11.23"> VPATH     = @srcdir@</span>
<a href="#l11.24"></a><span id="l11.24"> </span>
<a href="#l11.25"></a><span id="l11.25"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l11.26"></a><span id="l11.26"> </span>
<a href="#l11.27"></a><span id="l11.27"> MODULE = calbase</span>
<a href="#l11.28"></a><span id="l11.28"> </span>
<a href="#l11.29"></a><span id="l11.29"> EXTRA_JS_MODULES = \</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+    calAlarmUtils.jsm \</span>
<a href="#l11.31"></a><span id="l11.31">     calUtils.jsm \</span>
<a href="#l11.32"></a><span id="l11.32">     calIteratorUtils.jsm \</span>
<a href="#l11.33"></a><span id="l11.33">     calItipUtils.jsm \</span>
<a href="#l11.34"></a><span id="l11.34">     calProviderUtils.jsm \</span>
<a href="#l11.35"></a><span id="l11.35">     calAuthUtils.jsm \</span>
<a href="#l11.36"></a><span id="l11.36">     $(NULL)</span>
<a href="#l11.37"></a><span id="l11.37"> </span>
<a href="#l11.38"></a><span id="l11.38"> include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/calendar/base/modules/calAlarmUtils.jsm</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,122 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+ *</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+ *</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+ * License.</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+ *</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+ * The Original Code is Sun Microsystems code.</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+ *</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+ *   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+ *</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+ *</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+ *</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even though it's defined in calUtils.jsm, import needs this</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+cal.alarms = {</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+    /**</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+     * Read default alarm settings from user preferences and apply them to the</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+     * event/todo passed in.</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+     *</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+     * @param aItem     The item to apply the default alarm values to.</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+     */</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+    setDefaultValues: function cal_alarm_setDefaultValues(aItem) {</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+        let type = cal.isEvent(aItem) ? &quot;event&quot; : &quot;todo&quot;;</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+        if (cal.getPrefSafe(&quot;calendar.alarms.onfor&quot; + type + &quot;s&quot;, 0) == 1) {</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+            let alarmOffset = cal.createDuration();</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+            let alarm = cal.createAlarm();</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+            let units = cal.getPrefSafe(&quot;calendar.alarms.&quot; + type + &quot;alarmunit&quot;, &quot;minute&quot;);</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+            alarmOffset[units] = cal.getPrefSafe(&quot;calendar.alarms.&quot; + type + &quot;alarmlen&quot;, 0);</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+            alarmOffset.normalize();</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+            alarmOffset.isNegative = true;</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+            if (type == &quot;todo&quot; &amp;&amp; !aItem.entryDate) {</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+                // You can't have an alarm if the entryDate doesn't exist.</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+                aItem.entryDate = cal.now();</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+            }</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+            alarm.related = Components.interfaces.calIAlarm.ALARM_RELATED_START;</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+            alarm.offset = alarmOffset;</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+            aItem.addAlarm(alarm);</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+        }</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+    },</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineplus">+    /**</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineplus">+     * Calculate the alarm date for a calIAlarm.</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+     *</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+     * @param aItem     The item used to calculate the alarm date.</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+     * @param aAlarm    The alarm to calculate the date for.</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+     * @return          The alarm offset.</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+     */</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+    calculateAlarmDate: function cal_alarm_calculateAlarmDate(aItem, aAlarm) {</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+        if (aAlarm.related == aAlarm.ALARM_RELATED_ABSOLUTE) {</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+            return aAlarm.alarmDate;</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+        } else {</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+            let returnDate;</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+            if (aAlarm.related == aAlarm.ALARM_RELATED_START) {</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+                let startDate = aItem[cal.calGetStartDateProp(aItem)];</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+                returnDate = startDate &amp;&amp; startDate.clone();</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+            } else if (aAlarm.related = aAlarm.ALARM_RELATED_END) {</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+                let endDate = aItem[cal.calGetEndDateProp(aItem)];</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+                returnDate = endDate &amp;&amp; endDate.clone();</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+            }</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+            if (returnDate &amp;&amp; aAlarm.offset) {</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+                returnDate.addDuration(aAlarm.offset);</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+                return returnDate;</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+            }</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+        }</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+        return null;</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+    },</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineplus">+    /**</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineplus">+     * Calculate the alarm offset for a calIAlarm. The resulting offset is</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineplus">+     * related to either start or end of the event, depending on the aRelated</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineplus">+     * parameter.</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineplus">+     *</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineplus">+     * @param aItem     The item to calculate the offset for.</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+     * @param aAlarm    The alarm to calculate the offset for.</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineplus">+     * @param aRelated  (optional) A relation constant from calIAlarm. If not</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+     *                    passed, ALARM_RELATED_START will be assumed.</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+     * @return          The alarm offset.</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+     */</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineplus">+    calculateAlarmOffset: function cal_alarms_calculateAlarmOffset(aItem, aAlarm, aRelated) {</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineplus">+        if (aAlarm.related == aAlarm.ALARM_RELATED_ABSOLUTE) {</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineplus">+            let returnDate;</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+            if (aRelated === undefined || aRelated == aAlarm.ALARM_RELATED_START) {</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineplus">+                returnDate = aItem[cal.calGetStartDateProp(aItem)];</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineplus">+            } else if (aRelated == aAlarm.ALARM_RELATED_END) {</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineplus">+                returnDate = aItem[cal.calGetEndDateProp(aItem)];</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineplus">+            }</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineplus">+            if (returnDate &amp;&amp; aAlarm.alarmDate) {</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+                return returnDate.subtractDate(aAlarm.alarmDate);</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineplus">+            }</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineplus">+                </span>
<a href="#l12.121"></a><span id="l12.121" class="difflineplus">+            return offset;</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineplus">+        } else {</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineplus">+            return aAlarm.offset;</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineplus">+        }</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineplus">+    }</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/calendar/base/modules/calItipUtils.jsm</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/calendar/base/modules/calItipUtils.jsm</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -34,16 +34,17 @@</span>
<a href="#l13.4"></a><span id="l13.4">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l13.5"></a><span id="l13.5">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l13.6"></a><span id="l13.6">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l13.7"></a><span id="l13.7">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l13.8"></a><span id="l13.8">  *</span>
<a href="#l13.9"></a><span id="l13.9">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calAlarmUtils.jsm&quot;);</span>
<a href="#l13.13"></a><span id="l13.13"> Components.utils.import(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;);</span>
<a href="#l13.14"></a><span id="l13.14"> </span>
<a href="#l13.15"></a><span id="l13.15"> /*</span>
<a href="#l13.16"></a><span id="l13.16">  * Scheduling and iTIP helper code;</span>
<a href="#l13.17"></a><span id="l13.17">  * don't use deliberately, because it'll be moved into interfaces/components.</span>
<a href="#l13.18"></a><span id="l13.18">  *</span>
<a href="#l13.19"></a><span id="l13.19">  * May replace the current calItipProcessor.js code soon.</span>
<a href="#l13.20"></a><span id="l13.20">  */</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineat">@@ -429,17 +430,17 @@ function setReceivedInfo(item, itipItemI</span>
<a href="#l13.22"></a><span id="l13.22"> </span>
<a href="#l13.23"></a><span id="l13.23"> /**</span>
<a href="#l13.24"></a><span id="l13.24">  * Strips user specific data, e.g. categories and alarm settings and returns the stripped item.</span>
<a href="#l13.25"></a><span id="l13.25">  */</span>
<a href="#l13.26"></a><span id="l13.26"> function stripUserData(item_) {</span>
<a href="#l13.27"></a><span id="l13.27">     let item = item_.clone();</span>
<a href="#l13.28"></a><span id="l13.28">     let stamp = item.stampTime;</span>
<a href="#l13.29"></a><span id="l13.29">     let lastModified = item.lastModifiedTime;</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-    item.alarmOffset = null;</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+    item.clearAlarms();</span>
<a href="#l13.32"></a><span id="l13.32">     item.alarmLastAck = null;</span>
<a href="#l13.33"></a><span id="l13.33">     item.setCategories(0, []);</span>
<a href="#l13.34"></a><span id="l13.34">     item.deleteProperty(&quot;RECEIVED-SEQUENCE&quot;);</span>
<a href="#l13.35"></a><span id="l13.35">     item.deleteProperty(&quot;RECEIVED-DTSTAMP&quot;);</span>
<a href="#l13.36"></a><span id="l13.36">     let propEnum = item.propertyEnumerator;</span>
<a href="#l13.37"></a><span id="l13.37">     while (propEnum.hasMoreElements()) {</span>
<a href="#l13.38"></a><span id="l13.38">         let prop = propEnum.getNext().QueryInterface(Components.interfaces.nsIProperty);</span>
<a href="#l13.39"></a><span id="l13.39">         let pname = prop.name;</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineat">@@ -462,18 +463,20 @@ function stripUserData(item_) {</span>
<a href="#l13.41"></a><span id="l13.41">  *</span>
<a href="#l13.42"></a><span id="l13.42">  * @param item         the stored calendar item to update</span>
<a href="#l13.43"></a><span id="l13.43">  * @param itipItemItem the received item</span>
<a href="#l13.44"></a><span id="l13.44">  */</span>
<a href="#l13.45"></a><span id="l13.45"> function updateItem(item, itipItemItem) {</span>
<a href="#l13.46"></a><span id="l13.46">     function updateUserData(newItem, item) {</span>
<a href="#l13.47"></a><span id="l13.47">         // preserve user settings:</span>
<a href="#l13.48"></a><span id="l13.48">         newItem.generation = item.generation;</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineminus">-        newItem.alarmOffset = item.alarmOffset;</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineminus">-        newItem.alarmRelated = item.alarmRelated;</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+        newItem.clearAlarms();</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+        for each (let alarm in item.getAlarms({})) {</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+            newItem.addAlarm(alarm);</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+        }</span>
<a href="#l13.55"></a><span id="l13.55">         newItem.alarmLastAck = item.alarmLastAck;</span>
<a href="#l13.56"></a><span id="l13.56">         let cats = item.getCategories({});</span>
<a href="#l13.57"></a><span id="l13.57">         newItem.setCategories(cats.length, cats);</span>
<a href="#l13.58"></a><span id="l13.58">     }</span>
<a href="#l13.59"></a><span id="l13.59"> </span>
<a href="#l13.60"></a><span id="l13.60">     let newItem = item.clone();</span>
<a href="#l13.61"></a><span id="l13.61">     newItem.icalComponent = itipItemItem.icalComponent;</span>
<a href="#l13.62"></a><span id="l13.62">     setReceivedInfo(newItem, itipItemItem);</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineat">@@ -790,17 +793,17 @@ ItipFindItemListener.prototype = {</span>
<a href="#l13.64"></a><span id="l13.64">                     case &quot;PUBLISH&quot;: {</span>
<a href="#l13.65"></a><span id="l13.65">                         let this_ = this;</span>
<a href="#l13.66"></a><span id="l13.66">                         let action = function(opListener, partStat) {</span>
<a href="#l13.67"></a><span id="l13.67">                             let newItem = itipItemItem.clone();</span>
<a href="#l13.68"></a><span id="l13.68">                             setReceivedInfo(newItem, itipItemItem);</span>
<a href="#l13.69"></a><span id="l13.69">                             newItem.parentItem.calendar = this_.mItipItem.targetCalendar;</span>
<a href="#l13.70"></a><span id="l13.70">                             if (partStat) {</span>
<a href="#l13.71"></a><span id="l13.71">                                 if (partStat != &quot;DECLINED&quot;) {</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineminus">-                                    cal.setDefaultAlarmValues(newItem);</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+                                    cal.alarms.setDefaultValues(newItem);</span>
<a href="#l13.74"></a><span id="l13.74">                                 }</span>
<a href="#l13.75"></a><span id="l13.75">                                 let att = cal.getInvitedAttendee(newItem);</span>
<a href="#l13.76"></a><span id="l13.76">                                 if (!att) { // fall back to using configured organizer</span>
<a href="#l13.77"></a><span id="l13.77">                                     att = createOrganizer(newItem.calendar);</span>
<a href="#l13.78"></a><span id="l13.78">                                     if (att) {</span>
<a href="#l13.79"></a><span id="l13.79">                                         att.isOrganizer = false;</span>
<a href="#l13.80"></a><span id="l13.80">                                         newItem.addAttendee(att);</span>
<a href="#l13.81"></a><span id="l13.81">                                     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/calendar/base/public/calIItemBase.idl</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/calendar/base/public/calIItemBase.idl</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -39,38 +39,33 @@</span>
<a href="#l14.4"></a><span id="l14.4"> </span>
<a href="#l14.5"></a><span id="l14.5"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l14.6"></a><span id="l14.6"> </span>
<a href="#l14.7"></a><span id="l14.7"> interface nsISimpleEnumerator;</span>
<a href="#l14.8"></a><span id="l14.8"> interface nsIVariant;</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> interface nsIPropertyBag;</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+interface calIAlarm;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+interface calIAttachment;</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+interface calIAttendee;</span>
<a href="#l14.15"></a><span id="l14.15"> interface calICalendar;</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-</span>
<a href="#l14.17"></a><span id="l14.17"> interface calIDateTime;</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-</span>
<a href="#l14.19"></a><span id="l14.19"> interface calIDuration;</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+interface calIIcalComponent;</span>
<a href="#l14.22"></a><span id="l14.22"> interface calIRecurrenceInfo;</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+interface calIRelation;</span>
<a href="#l14.24"></a><span id="l14.24"> </span>
<a href="#l14.25"></a><span id="l14.25" class="difflineminus">-interface calIAttendee;</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">-interface calIAttachment;</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-interface calIIcalComponent;</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-interface calIRelation;</span>
<a href="#l14.32"></a><span id="l14.32"> //</span>
<a href="#l14.33"></a><span id="l14.33"> // calIItemBase</span>
<a href="#l14.34"></a><span id="l14.34"> //</span>
<a href="#l14.35"></a><span id="l14.35"> // Base for Events, Todos, Journals, etc.</span>
<a href="#l14.36"></a><span id="l14.36"> //</span>
<a href="#l14.37"></a><span id="l14.37"> </span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">-[scriptable, uuid(c2a21f8c-9de6-47d5-912b-d1c423ea5f2e)]</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+[scriptable, uuid(9c988b8d-af45-4046-b05e-34417bba9058)]</span>
<a href="#l14.40"></a><span id="l14.40"> interface calIItemBase : nsISupports</span>
<a href="#l14.41"></a><span id="l14.41"> {</span>
<a href="#l14.42"></a><span id="l14.42">   // returns true if this thing is able to be modified;</span>
<a href="#l14.43"></a><span id="l14.43">   // if the item is not mutable, attempts to modify</span>
<a href="#l14.44"></a><span id="l14.44">   // any data will throw CAL_ERROR_ITEM_IS_IMMUTABLE</span>
<a href="#l14.45"></a><span id="l14.45">   readonly attribute boolean isMutable;</span>
<a href="#l14.46"></a><span id="l14.46"> </span>
<a href="#l14.47"></a><span id="l14.47">   // makes this item immutable</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineat">@@ -139,37 +134,41 @@ interface calIItemBase : nsISupports</span>
<a href="#l14.49"></a><span id="l14.49">   // item will not be reflected in the other.</span>
<a href="#l14.50"></a><span id="l14.50">   attribute calIIcalComponent icalComponent;</span>
<a href="#l14.51"></a><span id="l14.51"> </span>
<a href="#l14.52"></a><span id="l14.52">   //</span>
<a href="#l14.53"></a><span id="l14.53">   // alarms</span>
<a href="#l14.54"></a><span id="l14.54">   //</span>
<a href="#l14.55"></a><span id="l14.55"> </span>
<a href="#l14.56"></a><span id="l14.56">   /**</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineminus">-   * The amount of time from the date (specified by alarmRelated) to offset</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineminus">-   * the alarm's firing time by</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+   * Get all alarms assigned to this item</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+   *</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+   * @param count       The number of alarms</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+   * @param aAlarms     The array of calIAlarms</span>
<a href="#l14.63"></a><span id="l14.63">    */</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineminus">-  attribute calIDuration alarmOffset;</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+  void getAlarms(out PRUint32 count, [array, size_is(count), retval] out calIAlarm aAlarms);</span>
<a href="#l14.66"></a><span id="l14.66"> </span>
<a href="#l14.67"></a><span id="l14.67" class="difflineminus">-  /**</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineminus">-   * One of the ALARM_RELATED constants below.  </span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+   /**</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+   * Add an alarm to the item</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+   *</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+   * @param aAlarm      The calIAlarm to add</span>
<a href="#l14.73"></a><span id="l14.73">    */</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineminus">-  attribute unsigned long alarmRelated;</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+  void addAlarm(in calIAlarm aAlarm);</span>
<a href="#l14.76"></a><span id="l14.76"> </span>
<a href="#l14.77"></a><span id="l14.77">   /**</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineminus">-   * Corresponds to an alarmOffset that should be based off of the startDate or</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineminus">-   * entryDate (for events and tasks, respectively)</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+   * Delete an alarm from the item</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+   *</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+   * @param aAlarm      The calIAlarm to delete</span>
<a href="#l14.83"></a><span id="l14.83">    */</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineminus">-  const unsigned long ALARM_RELATED_START = 0;</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+  void deleteAlarm(in calIAlarm aAlarm);</span>
<a href="#l14.86"></a><span id="l14.86"> </span>
<a href="#l14.87"></a><span id="l14.87">   /**</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineminus">-   * Corresponds to an alarmOffset that should be based off of the endDate or</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineminus">-   * dueDate (for events and tasks, respectively)</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+   * Clear all alarms from the item</span>
<a href="#l14.91"></a><span id="l14.91">    */</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineminus">-  const unsigned long ALARM_RELATED_END = 1;</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+  void clearAlarms();</span>
<a href="#l14.94"></a><span id="l14.94"> </span>
<a href="#l14.95"></a><span id="l14.95">   // The last time this alarm was fired and acknowledged by the user; coerced to UTC.</span>
<a href="#l14.96"></a><span id="l14.96">   attribute calIDateTime alarmLastAck;</span>
<a href="#l14.97"></a><span id="l14.97"> </span>
<a href="#l14.98"></a><span id="l14.98">   //</span>
<a href="#l14.99"></a><span id="l14.99">   // recurrence</span>
<a href="#l14.100"></a><span id="l14.100">   //</span>
<a href="#l14.101"></a><span id="l14.101">   attribute calIRecurrenceInfo recurrenceInfo;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/calendar/base/src/calAlarmService.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/calendar/base/src/calAlarmService.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -370,39 +370,49 @@ calAlarmService.prototype = {</span>
<a href="#l15.4"></a><span id="l15.4">     unobserveCalendar: function cas_unobserveCalendar(calendar) {</span>
<a href="#l15.5"></a><span id="l15.5">         calendar.removeObserver(this.calendarObserver);</span>
<a href="#l15.6"></a><span id="l15.6">         this.disposeCalendarTimers([calendar]);</span>
<a href="#l15.7"></a><span id="l15.7">         this.notifyObservers(&quot;onRemoveAlarmsByCalendar&quot;, [calendar]);</span>
<a href="#l15.8"></a><span id="l15.8">     },</span>
<a href="#l15.9"></a><span id="l15.9"> </span>
<a href="#l15.10"></a><span id="l15.10">     getAlarmDate: function cas_getAlarmTime(aItem) {</span>
<a href="#l15.11"></a><span id="l15.11">         var alarmDate = null;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-        if (aItem.alarmRelated == Components.interfaces.calIItemBase.ALARM_RELATED_START) {</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+        // TODO ALARMSUPPORT This will change as soon as we support multiple</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+        // alarms.</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+        let alarms = aItem.getAlarms({}).filter(function(x) x.related != x.ALARM_RELATED_ABSOLUTE);</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+        let alarm = alarms[0]</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+        if (!alarm) {</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+            // No relative alarm available.</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+            return null;</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+        }</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+        // END TODO ALARMSUPPORT</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+        if (alarm.related == Components.interfaces.calIAlarm.ALARM_RELATED_START) {</span>
<a href="#l15.24"></a><span id="l15.24">             alarmDate = aItem.startDate || aItem.entryDate || aItem.dueDate;</span>
<a href="#l15.25"></a><span id="l15.25">         } else {</span>
<a href="#l15.26"></a><span id="l15.26">             alarmDate = aItem.endDate || aItem.dueDate || aItem.entryDate;</span>
<a href="#l15.27"></a><span id="l15.27">         }</span>
<a href="#l15.28"></a><span id="l15.28"> </span>
<a href="#l15.29"></a><span id="l15.29" class="difflineminus">-        if (!aItem.alarmOffset || !alarmDate) {</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+        if (!alarmDate) {</span>
<a href="#l15.31"></a><span id="l15.31">             // If there is no alarm offset, or no date the alarm offset could be</span>
<a href="#l15.32"></a><span id="l15.32">             // relative to, then there is no valid alarm.</span>
<a href="#l15.33"></a><span id="l15.33">             return null;</span>
<a href="#l15.34"></a><span id="l15.34">         }</span>
<a href="#l15.35"></a><span id="l15.35"> </span>
<a href="#l15.36"></a><span id="l15.36">         alarmDate = alarmDate.clone();</span>
<a href="#l15.37"></a><span id="l15.37"> </span>
<a href="#l15.38"></a><span id="l15.38">         // Handle all day events.  This is kinda weird, because they don't have</span>
<a href="#l15.39"></a><span id="l15.39">         // a well defined startTime.  We just consider the start/end to be</span>
<a href="#l15.40"></a><span id="l15.40">         // midnight in the user's timezone.</span>
<a href="#l15.41"></a><span id="l15.41">         if (alarmDate.isDate) {</span>
<a href="#l15.42"></a><span id="l15.42">             alarmDate = alarmDate.getInTimezone(this.timezone);</span>
<a href="#l15.43"></a><span id="l15.43">             alarmDate.isDate = false;</span>
<a href="#l15.44"></a><span id="l15.44">         }</span>
<a href="#l15.45"></a><span id="l15.45"> </span>
<a href="#l15.46"></a><span id="l15.46" class="difflineminus">-        var offset = aItem.alarmOffset;</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+        let offset = alarm.offset;</span>
<a href="#l15.48"></a><span id="l15.48"> </span>
<a href="#l15.49"></a><span id="l15.49">         alarmDate.addDuration(offset);</span>
<a href="#l15.50"></a><span id="l15.50">         alarmDate = alarmDate.getInTimezone(UTC());</span>
<a href="#l15.51"></a><span id="l15.51"> </span>
<a href="#l15.52"></a><span id="l15.52">         return alarmDate;</span>
<a href="#l15.53"></a><span id="l15.53">     },</span>
<a href="#l15.54"></a><span id="l15.54"> </span>
<a href="#l15.55"></a><span id="l15.55">     addAlarm: function cas_addAlarm(aItem) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/calendar/base/src/calItemBase.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/calendar/base/src/calItemBase.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -49,23 +49,25 @@ Components.utils.import(&quot;resource://cale</span>
<a href="#l16.4"></a><span id="l16.4"> </span>
<a href="#l16.5"></a><span id="l16.5"> function calItemBase() {</span>
<a href="#l16.6"></a><span id="l16.6">     cal.ASSERT(false, &quot;Inheriting objects call initItemBase()!&quot;);</span>
<a href="#l16.7"></a><span id="l16.7"> }</span>
<a href="#l16.8"></a><span id="l16.8"> </span>
<a href="#l16.9"></a><span id="l16.9"> calItemBase.prototype = {</span>
<a href="#l16.10"></a><span id="l16.10">     mPropertyParams: null,</span>
<a href="#l16.11"></a><span id="l16.11">     mIsProxy: false,</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+    mAlarms: null,</span>
<a href="#l16.13"></a><span id="l16.13"> </span>
<a href="#l16.14"></a><span id="l16.14">     // initialize this class's members</span>
<a href="#l16.15"></a><span id="l16.15">     initItemBase: function cib_initItemBase() {</span>
<a href="#l16.16"></a><span id="l16.16">         this.wrappedJSObject = this;</span>
<a href="#l16.17"></a><span id="l16.17">         this.mProperties = new calPropertyBag();</span>
<a href="#l16.18"></a><span id="l16.18">         this.mPropertyParams = {};</span>
<a href="#l16.19"></a><span id="l16.19">         this.mProperties.setProperty(&quot;CREATED&quot;, jsDateToDateTime(new Date()));</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+        this.mAlarms = [];</span>
<a href="#l16.21"></a><span id="l16.21">     },</span>
<a href="#l16.22"></a><span id="l16.22"> </span>
<a href="#l16.23"></a><span id="l16.23">     QueryInterface: function (aIID) {</span>
<a href="#l16.24"></a><span id="l16.24">         return doQueryInterface(this, calItemBase.prototype, aIID,</span>
<a href="#l16.25"></a><span id="l16.25">                                 [Components.interfaces.calIItemBase]);</span>
<a href="#l16.26"></a><span id="l16.26">     },</span>
<a href="#l16.27"></a><span id="l16.27"> </span>
<a href="#l16.28"></a><span id="l16.28">     mHashId: null,</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineat">@@ -166,19 +168,20 @@ calItemBase.prototype = {</span>
<a href="#l16.30"></a><span id="l16.30"> </span>
<a href="#l16.31"></a><span id="l16.31">         for each (let [propKey, propValue] in this.mProperties) {</span>
<a href="#l16.32"></a><span id="l16.32">             if (propValue instanceof Components.interfaces.calIDateTime &amp;&amp;</span>
<a href="#l16.33"></a><span id="l16.33">                 propValue.isMutable) {</span>
<a href="#l16.34"></a><span id="l16.34">                 propValue.makeImmutable();</span>
<a href="#l16.35"></a><span id="l16.35">             }</span>
<a href="#l16.36"></a><span id="l16.36">         }</span>
<a href="#l16.37"></a><span id="l16.37"> </span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-        if (this.mAlarmOffset) {</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">-            this.mAlarmOffset.makeImmutable();</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+        for (let i = 0; i &lt; this.mAlarms.length; i++) {</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+            this.mAlarms[i].makeImmutable();</span>
<a href="#l16.42"></a><span id="l16.42">         }</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+</span>
<a href="#l16.44"></a><span id="l16.44">         if (this.mAlarmLastAck) {</span>
<a href="#l16.45"></a><span id="l16.45">             this.mAlarmLastAck.makeImmutable();</span>
<a href="#l16.46"></a><span id="l16.46">         }</span>
<a href="#l16.47"></a><span id="l16.47"> </span>
<a href="#l16.48"></a><span id="l16.48">         this.ensureNotDirty();</span>
<a href="#l16.49"></a><span id="l16.49">         this.mImmutable = true;</span>
<a href="#l16.50"></a><span id="l16.50">     },</span>
<a href="#l16.51"></a><span id="l16.51"> </span>
<a href="#l16.52"></a><span id="l16.52" class="difflineat">@@ -238,55 +241,39 @@ calItemBase.prototype = {</span>
<a href="#l16.53"></a><span id="l16.53">         // xxx todo: the below two need proper cloning,</span>
<a href="#l16.54"></a><span id="l16.54">         //           calIAttachment::item, calIRelation::item are wrong</span>
<a href="#l16.55"></a><span id="l16.55">         //           bug 466439</span>
<a href="#l16.56"></a><span id="l16.56">         m.mAttachments = this.getAttachments({});</span>
<a href="#l16.57"></a><span id="l16.57">         m.mRelations = this.getRelations({});</span>
<a href="#l16.58"></a><span id="l16.58"> </span>
<a href="#l16.59"></a><span id="l16.59">         m.mCategories = this.getCategories({});</span>
<a href="#l16.60"></a><span id="l16.60"> </span>
<a href="#l16.61"></a><span id="l16.61" class="difflineminus">-        // Clone any alarm info that exists, set it to null if it doesn't</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineminus">-        let alarmOffset = this.alarmOffset;</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineminus">-        if (alarmOffset) {</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineminus">-            alarmOffset = alarmOffset.clone();</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineplus">+        for each (let alarm in this.mAlarms) {</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+            // Clone alarms into new item, assume the alarms from the old item</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineplus">+            // are valid and don't need validation.</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineplus">+            m.addAlarm(alarm.clone(), true);</span>
<a href="#l16.69"></a><span id="l16.69">         }</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineminus">-        m.mAlarmOffset = alarmOffset;</span>
<a href="#l16.71"></a><span id="l16.71"> </span>
<a href="#l16.72"></a><span id="l16.72">         let alarmLastAck = this.alarmLastAck;</span>
<a href="#l16.73"></a><span id="l16.73">         if (alarmLastAck) {</span>
<a href="#l16.74"></a><span id="l16.74">             alarmLastAck = alarmLastAck.clone();</span>
<a href="#l16.75"></a><span id="l16.75">         }</span>
<a href="#l16.76"></a><span id="l16.76">         m.mAlarmLastAck = alarmLastAck;</span>
<a href="#l16.77"></a><span id="l16.77"> </span>
<a href="#l16.78"></a><span id="l16.78" class="difflineminus">-        m.alarmRelated = this.alarmRelated;</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineminus">-</span>
<a href="#l16.80"></a><span id="l16.80">         m.mDirty = this.mDirty;</span>
<a href="#l16.81"></a><span id="l16.81"> </span>
<a href="#l16.82"></a><span id="l16.82">         return m;</span>
<a href="#l16.83"></a><span id="l16.83">     },</span>
<a href="#l16.84"></a><span id="l16.84"> </span>
<a href="#l16.85"></a><span id="l16.85" class="difflineminus">-    get alarmOffset() {</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineminus">-        if (this.mIsProxy &amp;&amp; (this.mAlarmOffset === undefined)) {</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineminus">-            return this.parentItem.alarmOffset;</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineminus">-        } else {</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineminus">-            return this.mAlarmOffset;</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineminus">-        }</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineminus">-    },</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineminus">-</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineminus">-    set alarmOffset(aValue) {</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineminus">-        this.modify();</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineminus">-        return (this.mAlarmOffset = aValue);</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineminus">-    },</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineminus">-</span>
<a href="#l16.98"></a><span id="l16.98">     mAlarmLastAck: null,</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineminus">-    get alarmLastAck cib_get_alarmLastAck() {</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineplus">+    get alarmLastAck cIB_get_alarmLastAck() {</span>
<a href="#l16.101"></a><span id="l16.101">         return this.mAlarmLastAck;</span>
<a href="#l16.102"></a><span id="l16.102">     },</span>
<a href="#l16.103"></a><span id="l16.103"> </span>
<a href="#l16.104"></a><span id="l16.104" class="difflineminus">-    set alarmLastAck cib_set_alarmLastAck(aValue) {</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineplus">+    set alarmLastAck cIB_set_alarmLastAck(aValue) {</span>
<a href="#l16.106"></a><span id="l16.106">         this.modify();</span>
<a href="#l16.107"></a><span id="l16.107">         if (aValue &amp;&amp; !aValue.timezone.isUTC) {</span>
<a href="#l16.108"></a><span id="l16.108">             aValue = aValue.getInTimezone(UTC());</span>
<a href="#l16.109"></a><span id="l16.109">         }</span>
<a href="#l16.110"></a><span id="l16.110">         return (this.mAlarmLastAck = aValue);</span>
<a href="#l16.111"></a><span id="l16.111">     },</span>
<a href="#l16.112"></a><span id="l16.112"> </span>
<a href="#l16.113"></a><span id="l16.113">     get lastModifiedTime() {</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineat">@@ -693,45 +680,40 @@ calItemBase.prototype = {</span>
<a href="#l16.115"></a><span id="l16.115">                     rec = new calRecurrenceInfo();</span>
<a href="#l16.116"></a><span id="l16.116">                     rec.item = this;</span>
<a href="#l16.117"></a><span id="l16.117">                 }</span>
<a href="#l16.118"></a><span id="l16.118">                 rec.appendRecurrenceItem(ritem);</span>
<a href="#l16.119"></a><span id="l16.119">             }</span>
<a href="#l16.120"></a><span id="l16.120">         }</span>
<a href="#l16.121"></a><span id="l16.121">         this.mRecurrenceInfo = rec;</span>
<a href="#l16.122"></a><span id="l16.122"> </span>
<a href="#l16.123"></a><span id="l16.123" class="difflineminus">-        this.mAlarmOffset = null;</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineminus">-        this.alarmRelated = Components.interfaces.calIItemBase.ALARM_RELATED_START;</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineminus">-        this.mAlarmLastAck = null;</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineminus">-</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineminus">-        let alarmComp = icalcomp.getFirstSubcomponent(&quot;VALARM&quot;);</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineminus">-        if (alarmComp) {</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineminus">-            let triggerProp = alarmComp.getFirstProperty(&quot;TRIGGER&quot;);</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineminus">-            if (triggerProp) {</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineminus">-                this.mAlarmOffset = cal.createDuration(triggerProp.valueAsIcalString);</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineminus">-</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineminus">-                let related = triggerProp.getParameter(&quot;RELATED&quot;);</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineminus">-                if (related &amp;&amp; related == &quot;END&quot;) {</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineminus">-                    this.alarmRelated = Components.interfaces.calIItemBase.ALARM_RELATED_END;</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineplus">+        for (let alarmComp in cal.ical.subcomponentIterator(icalcomp, &quot;VALARM&quot;)) {</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineplus">+            let alarm = cal.createAlarm();</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineplus">+            try {</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineplus">+                alarm.icalComponent = alarmComp;</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineplus">+                if (alarm.related != Components.interfaces.calIAlarm.ALARM_RELATED_ABSOLUTE) {</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineplus">+                    // TODO ALARMSUPPORT unconditionally add alarm when we</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineplus">+                    // support multiple alarms.</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineplus">+                    this.addAlarm(alarm, true);</span>
<a href="#l16.144"></a><span id="l16.144">                 }</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineminus">-</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineminus">-                let email = alarmComp.getFirstProperty(&quot;X-EMAILADDRESS&quot;);</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineminus">-                if (email) {</span>
<a href="#l16.148"></a><span id="l16.148" class="difflineminus">-                    this.setProperty(&quot;alarmEmailAddress&quot;, email.value);</span>
<a href="#l16.149"></a><span id="l16.149" class="difflineminus">-                }</span>
<a href="#l16.150"></a><span id="l16.150" class="difflineminus">-            } else {</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineminus">-                // Really, really old Sunbird/Calendar versions didn't give us a</span>
<a href="#l16.152"></a><span id="l16.152" class="difflineminus">-                // trigger.</span>
<a href="#l16.153"></a><span id="l16.153" class="difflineminus">-                cal.ERROR(&quot;No trigger property for alarm on item: &quot; + this.id);</span>
<a href="#l16.154"></a><span id="l16.154" class="difflineplus">+            } catch (e) {</span>
<a href="#l16.155"></a><span id="l16.155" class="difflineplus">+                Components.utils.reportError(&quot;Invalid alarm for item: &quot; +</span>
<a href="#l16.156"></a><span id="l16.156" class="difflineplus">+                                             this.id + &quot; (&quot; +</span>
<a href="#l16.157"></a><span id="l16.157" class="difflineplus">+                                             alarmComp.serializeToICS() + &quot;)&quot;);</span>
<a href="#l16.158"></a><span id="l16.158">             }</span>
<a href="#l16.159"></a><span id="l16.159"> </span>
<a href="#l16.160"></a><span id="l16.160" class="difflineminus">-            let lastAck = icalcomp.getFirstProperty(&quot;X-MOZ-LASTACK&quot;);</span>
<a href="#l16.161"></a><span id="l16.161" class="difflineminus">-            if (lastAck) {</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineminus">-                this.mAlarmLastAck = cal.createDateTime(lastAck.value);</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineminus">-            }</span>
<a href="#l16.164"></a><span id="l16.164" class="difflineplus">+            // TODO ALARMSUPPORT remove break when we fully support multiple</span>
<a href="#l16.165"></a><span id="l16.165" class="difflineplus">+            // alarms</span>
<a href="#l16.166"></a><span id="l16.166" class="difflineplus">+            break;</span>
<a href="#l16.167"></a><span id="l16.167" class="difflineplus">+        }</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineplus">+</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineplus">+        let lastAck = icalcomp.getFirstProperty(&quot;X-MOZ-LASTACK&quot;);</span>
<a href="#l16.170"></a><span id="l16.170" class="difflineplus">+        this.mAlarmLastAck = null;</span>
<a href="#l16.171"></a><span id="l16.171" class="difflineplus">+        if (lastAck) {</span>
<a href="#l16.172"></a><span id="l16.172" class="difflineplus">+            this.mAlarmLastAck = cal.createDateTime(lastAck.value);</span>
<a href="#l16.173"></a><span id="l16.173">         }</span>
<a href="#l16.174"></a><span id="l16.174"> </span>
<a href="#l16.175"></a><span id="l16.175">         this.mDirty = false;</span>
<a href="#l16.176"></a><span id="l16.176">     },</span>
<a href="#l16.177"></a><span id="l16.177"> </span>
<a href="#l16.178"></a><span id="l16.178">     importUnpromotedProperties: function (icalcomp, promoted) {</span>
<a href="#l16.179"></a><span id="l16.179">         for (let prop in cal.ical.propertyIterator(icalcomp)) {</span>
<a href="#l16.180"></a><span id="l16.180">             let propName = prop.propertyName;</span>
<a href="#l16.181"></a><span id="l16.181" class="difflineat">@@ -761,16 +743,17 @@ calItemBase.prototype = {</span>
<a href="#l16.182"></a><span id="l16.182">         return (gen ? parseInt(gen, 10) : 0);</span>
<a href="#l16.183"></a><span id="l16.183">     },</span>
<a href="#l16.184"></a><span id="l16.184">     set generation(aValue) {</span>
<a href="#l16.185"></a><span id="l16.185">         return this.setProperty(&quot;X-MOZ-GENERATION&quot;, String(aValue));</span>
<a href="#l16.186"></a><span id="l16.186">     },</span>
<a href="#l16.187"></a><span id="l16.187"> </span>
<a href="#l16.188"></a><span id="l16.188">     fillIcalComponentFromBase: function (icalcomp) {</span>
<a href="#l16.189"></a><span id="l16.189">         this.ensureNotDirty();</span>
<a href="#l16.190"></a><span id="l16.190" class="difflineplus">+        let icssvc = cal.getIcsService();</span>
<a href="#l16.191"></a><span id="l16.191"> </span>
<a href="#l16.192"></a><span id="l16.192">         this.mapPropsToICS(icalcomp, this.icsBasePropMap);</span>
<a href="#l16.193"></a><span id="l16.193"> </span>
<a href="#l16.194"></a><span id="l16.194">         let org = this.organizer;</span>
<a href="#l16.195"></a><span id="l16.195">         if (org) {</span>
<a href="#l16.196"></a><span id="l16.196">             icalcomp.addProperty(org.icalProperty);</span>
<a href="#l16.197"></a><span id="l16.197">         }</span>
<a href="#l16.198"></a><span id="l16.198"> </span>
<a href="#l16.199"></a><span id="l16.199" class="difflineat">@@ -788,65 +771,79 @@ calItemBase.prototype = {</span>
<a href="#l16.200"></a><span id="l16.200"> </span>
<a href="#l16.201"></a><span id="l16.201">         if (this.mRecurrenceInfo) {</span>
<a href="#l16.202"></a><span id="l16.202">             for each (let ritem in this.mRecurrenceInfo.getRecurrenceItems({})) {</span>
<a href="#l16.203"></a><span id="l16.203">                 icalcomp.addProperty(ritem.icalProperty);</span>
<a href="#l16.204"></a><span id="l16.204">             }</span>
<a href="#l16.205"></a><span id="l16.205">         }</span>
<a href="#l16.206"></a><span id="l16.206"> </span>
<a href="#l16.207"></a><span id="l16.207">         for each (let cat in this.getCategories({})) {</span>
<a href="#l16.208"></a><span id="l16.208" class="difflineminus">-            let catprop = getIcsService().createIcalProperty(&quot;CATEGORIES&quot;);</span>
<a href="#l16.209"></a><span id="l16.209" class="difflineplus">+            let catprop = icssvc.createIcalProperty(&quot;CATEGORIES&quot;);</span>
<a href="#l16.210"></a><span id="l16.210">             catprop.value = cat;</span>
<a href="#l16.211"></a><span id="l16.211">             icalcomp.addProperty(catprop);</span>
<a href="#l16.212"></a><span id="l16.212">         }</span>
<a href="#l16.213"></a><span id="l16.213"> </span>
<a href="#l16.214"></a><span id="l16.214" class="difflineminus">-        let alarmOffset = this.alarmOffset;</span>
<a href="#l16.215"></a><span id="l16.215" class="difflineminus">-        if (alarmOffset) {</span>
<a href="#l16.216"></a><span id="l16.216" class="difflineminus">-            let icssvc = cal.getIcsService();</span>
<a href="#l16.217"></a><span id="l16.217" class="difflineminus">-            let alarmComp = icssvc.createIcalComponent(&quot;VALARM&quot;);</span>
<a href="#l16.218"></a><span id="l16.218" class="difflineminus">-</span>
<a href="#l16.219"></a><span id="l16.219" class="difflineminus">-            let triggerProp = icssvc.createIcalProperty(&quot;TRIGGER&quot;);</span>
<a href="#l16.220"></a><span id="l16.220" class="difflineminus">-            triggerProp.valueAsIcalString = alarmOffset.icalString;</span>
<a href="#l16.221"></a><span id="l16.221" class="difflineminus">-</span>
<a href="#l16.222"></a><span id="l16.222" class="difflineminus">-            if (this.alarmRelated == Components.interfaces.calIItemBase.ALARM_RELATED_END) {</span>
<a href="#l16.223"></a><span id="l16.223" class="difflineminus">-                triggerProp.setParameter(&quot;RELATED&quot;, &quot;END&quot;);</span>
<a href="#l16.224"></a><span id="l16.224" class="difflineminus">-            }</span>
<a href="#l16.225"></a><span id="l16.225" class="difflineminus">-</span>
<a href="#l16.226"></a><span id="l16.226" class="difflineminus">-            alarmComp.addProperty(triggerProp);</span>
<a href="#l16.227"></a><span id="l16.227" class="difflineminus">-</span>
<a href="#l16.228"></a><span id="l16.228" class="difflineminus">-            // We don't use this, but the ics-spec requires it</span>
<a href="#l16.229"></a><span id="l16.229" class="difflineminus">-            let descProp = icssvc.createIcalProperty(&quot;DESCRIPTION&quot;);</span>
<a href="#l16.230"></a><span id="l16.230" class="difflineminus">-            descProp.value = &quot;Mozilla Alarm: &quot;+ this.title;</span>
<a href="#l16.231"></a><span id="l16.231" class="difflineminus">-            alarmComp.addProperty(descProp);</span>
<a href="#l16.232"></a><span id="l16.232" class="difflineminus">-</span>
<a href="#l16.233"></a><span id="l16.233" class="difflineminus">-            let actionProp = icssvc.createIcalProperty(&quot;ACTION&quot;);</span>
<a href="#l16.234"></a><span id="l16.234" class="difflineminus">-            actionProp.value = &quot;DISPLAY&quot;;</span>
<a href="#l16.235"></a><span id="l16.235" class="difflineminus">-</span>
<a href="#l16.236"></a><span id="l16.236" class="difflineminus">-            let alarmEmailAddress = this.getProperty(&quot;alarmEmailAddress&quot;);</span>
<a href="#l16.237"></a><span id="l16.237" class="difflineminus">-            if (alarmEmailAddress) {</span>
<a href="#l16.238"></a><span id="l16.238" class="difflineminus">-                let emailProp = icssvc.createIcalProperty(&quot;X-EMAILADDRESS&quot;);</span>
<a href="#l16.239"></a><span id="l16.239" class="difflineminus">-                emailProp.value = alarmEmailAddress;</span>
<a href="#l16.240"></a><span id="l16.240" class="difflineminus">-                actionProp.value = &quot;EMAIL&quot;;</span>
<a href="#l16.241"></a><span id="l16.241" class="difflineminus">-                alarmComp.addProperty(emailProp);</span>
<a href="#l16.242"></a><span id="l16.242" class="difflineminus">-            }</span>
<a href="#l16.243"></a><span id="l16.243" class="difflineminus">-</span>
<a href="#l16.244"></a><span id="l16.244" class="difflineminus">-            alarmComp.addProperty(actionProp);</span>
<a href="#l16.245"></a><span id="l16.245" class="difflineminus">-</span>
<a href="#l16.246"></a><span id="l16.246" class="difflineminus">-            icalcomp.addSubcomponent(alarmComp);</span>
<a href="#l16.247"></a><span id="l16.247" class="difflineplus">+        for each (let alarm in this.mAlarms) {</span>
<a href="#l16.248"></a><span id="l16.248" class="difflineplus">+            icalcomp.addSubcomponent(alarm.icalComponent);</span>
<a href="#l16.249"></a><span id="l16.249">         }</span>
<a href="#l16.250"></a><span id="l16.250"> </span>
<a href="#l16.251"></a><span id="l16.251">         let alarmLastAck = this.alarmLastAck;</span>
<a href="#l16.252"></a><span id="l16.252">         if (alarmLastAck) {</span>
<a href="#l16.253"></a><span id="l16.253">             let lastAck = cal.getIcsService().createIcalProperty(&quot;X-MOZ-LASTACK&quot;);</span>
<a href="#l16.254"></a><span id="l16.254">             // - should we further ensure that those are UTC or rely on calAlarmService doing so?</span>
<a href="#l16.255"></a><span id="l16.255">             lastAck.value = alarmLastAck.icalString;</span>
<a href="#l16.256"></a><span id="l16.256">             icalcomp.addProperty(lastAck);</span>
<a href="#l16.257"></a><span id="l16.257">         }</span>
<a href="#l16.258"></a><span id="l16.258">     },</span>
<a href="#l16.259"></a><span id="l16.259"> </span>
<a href="#l16.260"></a><span id="l16.260" class="difflineplus">+    getAlarms: function cIB_getAlarms(aCount) {</span>
<a href="#l16.261"></a><span id="l16.261" class="difflineplus">+        if (typeof aCount != &quot;object&quot;) {</span>
<a href="#l16.262"></a><span id="l16.262" class="difflineplus">+            throw Components.results.NS_ERROR_XPC_NEED_OUT_OBJECT;</span>
<a href="#l16.263"></a><span id="l16.263" class="difflineplus">+        }</span>
<a href="#l16.264"></a><span id="l16.264" class="difflineplus">+</span>
<a href="#l16.265"></a><span id="l16.265" class="difflineplus">+        aCount.value = this.mAlarms.length;</span>
<a href="#l16.266"></a><span id="l16.266" class="difflineplus">+        return this.mAlarms;</span>
<a href="#l16.267"></a><span id="l16.267" class="difflineplus">+    },</span>
<a href="#l16.268"></a><span id="l16.268" class="difflineplus">+</span>
<a href="#l16.269"></a><span id="l16.269" class="difflineplus">+    /**</span>
<a href="#l16.270"></a><span id="l16.270" class="difflineplus">+     * Adds an alarm. The second parameter is for internal use only, i.e not</span>
<a href="#l16.271"></a><span id="l16.271" class="difflineplus">+     * provided on the interface.</span>
<a href="#l16.272"></a><span id="l16.272" class="difflineplus">+     *</span>
<a href="#l16.273"></a><span id="l16.273" class="difflineplus">+     * @parm aDoNotValidate     Don't serialize the component to check for</span>
<a href="#l16.274"></a><span id="l16.274" class="difflineplus">+     *                            errors.</span>
<a href="#l16.275"></a><span id="l16.275" class="difflineplus">+     */</span>
<a href="#l16.276"></a><span id="l16.276" class="difflineplus">+    addAlarm: function cIB_addAlarm(aAlarm, aDoNotValidate) {</span>
<a href="#l16.277"></a><span id="l16.277" class="difflineplus">+        if (!aDoNotValidate) {</span>
<a href="#l16.278"></a><span id="l16.278" class="difflineplus">+            try {</span>
<a href="#l16.279"></a><span id="l16.279" class="difflineplus">+                // Trigger the icalComponent getter to make sure the alarm is valid.</span>
<a href="#l16.280"></a><span id="l16.280" class="difflineplus">+                aAlarm.icalComponent;</span>
<a href="#l16.281"></a><span id="l16.281" class="difflineplus">+            } catch (e) {</span>
<a href="#l16.282"></a><span id="l16.282" class="difflineplus">+                throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l16.283"></a><span id="l16.283" class="difflineplus">+            }</span>
<a href="#l16.284"></a><span id="l16.284" class="difflineplus">+        }</span>
<a href="#l16.285"></a><span id="l16.285" class="difflineplus">+</span>
<a href="#l16.286"></a><span id="l16.286" class="difflineplus">+        this.modify();</span>
<a href="#l16.287"></a><span id="l16.287" class="difflineplus">+        this.mAlarms.push(aAlarm);</span>
<a href="#l16.288"></a><span id="l16.288" class="difflineplus">+    },</span>
<a href="#l16.289"></a><span id="l16.289" class="difflineplus">+</span>
<a href="#l16.290"></a><span id="l16.290" class="difflineplus">+    deleteAlarm: function cIB_deleteAlarm(aAlarm) {</span>
<a href="#l16.291"></a><span id="l16.291" class="difflineplus">+        this.modify();</span>
<a href="#l16.292"></a><span id="l16.292" class="difflineplus">+        for (let i = 0; i &lt; this.mAlarms.length; i++) {</span>
<a href="#l16.293"></a><span id="l16.293" class="difflineplus">+            if (compareObjects(this.mAlarms[i], aAlarm, Components.interfaces.calIAlarm)) {</span>
<a href="#l16.294"></a><span id="l16.294" class="difflineplus">+                this.mAlarms.splice(i, 1);</span>
<a href="#l16.295"></a><span id="l16.295" class="difflineplus">+                break;</span>
<a href="#l16.296"></a><span id="l16.296" class="difflineplus">+            }</span>
<a href="#l16.297"></a><span id="l16.297" class="difflineplus">+        }</span>
<a href="#l16.298"></a><span id="l16.298" class="difflineplus">+    },</span>
<a href="#l16.299"></a><span id="l16.299" class="difflineplus">+</span>
<a href="#l16.300"></a><span id="l16.300" class="difflineplus">+    clearAlarms: function cIB_clearAlarms() {</span>
<a href="#l16.301"></a><span id="l16.301" class="difflineplus">+        this.modify();</span>
<a href="#l16.302"></a><span id="l16.302" class="difflineplus">+        this.mAlarms = [];</span>
<a href="#l16.303"></a><span id="l16.303" class="difflineplus">+    },</span>
<a href="#l16.304"></a><span id="l16.304" class="difflineplus">+</span>
<a href="#l16.305"></a><span id="l16.305">     getOccurrencesBetween: function cIB_getOccurrencesBetween(aStartDate, aEndDate, aCount) {</span>
<a href="#l16.306"></a><span id="l16.306">         if (this.recurrenceInfo) {</span>
<a href="#l16.307"></a><span id="l16.307">             return this.recurrenceInfo.getOccurrences(aStartDate, aEndDate, 0, aCount);</span>
<a href="#l16.308"></a><span id="l16.308">         }</span>
<a href="#l16.309"></a><span id="l16.309"> </span>
<a href="#l16.310"></a><span id="l16.310">         if (checkIfInRange(this, aStartDate, aEndDate)) {</span>
<a href="#l16.311"></a><span id="l16.311">             aCount.value = 1;</span>
<a href="#l16.312"></a><span id="l16.312">             return [this];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/calendar/base/src/calItipItem.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/calendar/base/src/calItipItem.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -146,17 +146,17 @@ calItipItem.prototype = {</span>
<a href="#l17.4"></a><span id="l17.4">         //   should not be sent out and should not be relevant for incoming messages</span>
<a href="#l17.5"></a><span id="l17.5">         // - faked master items</span>
<a href="#l17.6"></a><span id="l17.6">         // so clean them out:</span>
<a href="#l17.7"></a><span id="l17.7"> </span>
<a href="#l17.8"></a><span id="l17.8">         function cleanItem(item) {</span>
<a href="#l17.9"></a><span id="l17.9">             // the following changes will bump LAST-MODIFIED/DTSTAMP, we want to preserve the originals:</span>
<a href="#l17.10"></a><span id="l17.10">             let stamp = item.stampTime;</span>
<a href="#l17.11"></a><span id="l17.11">             let lastModified = item.lastModifiedTime;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-            item.alarmOffset = null;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+            item.clearAlarms();</span>
<a href="#l17.14"></a><span id="l17.14">             item.alarmLastAck = null;</span>
<a href="#l17.15"></a><span id="l17.15">             item.deleteProperty(&quot;RECEIVED-SEQUENCE&quot;);</span>
<a href="#l17.16"></a><span id="l17.16">             item.deleteProperty(&quot;RECEIVED-DTSTAMP&quot;);</span>
<a href="#l17.17"></a><span id="l17.17">             let propEnum = item.propertyEnumerator;</span>
<a href="#l17.18"></a><span id="l17.18">             while (propEnum.hasMoreElements()) {</span>
<a href="#l17.19"></a><span id="l17.19">                 let prop = propEnum.getNext().QueryInterface(Components.interfaces.nsIProperty);</span>
<a href="#l17.20"></a><span id="l17.20">                 let pname = prop.name;</span>
<a href="#l17.21"></a><span id="l17.21">                 if (pname != &quot;X-MOZ-FAKED-MASTER&quot; &amp;&amp; pname.substr(0, &quot;X-MOZ-&quot;.length) == &quot;X-MOZ-&quot;) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/calendar/base/src/calUtils.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/calendar/base/src/calUtils.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1832,64 +1832,16 @@ function binaryInsert(itemArray, item, c</span>
<a href="#l18.4"></a><span id="l18.4">                 comptor(itemArray[Math.min(newIndex, itemArray.length - 1)], item) != 0) {</span>
<a href="#l18.5"></a><span id="l18.5">         // Only add the item if duplicates should not be discarded, or if</span>
<a href="#l18.6"></a><span id="l18.6">         // they should and itemArray[newIndex] == item.</span>
<a href="#l18.7"></a><span id="l18.7">         itemArray.splice(newIndex, 0, item);</span>
<a href="#l18.8"></a><span id="l18.8">     }</span>
<a href="#l18.9"></a><span id="l18.9">     return newIndex;</span>
<a href="#l18.10"></a><span id="l18.10"> }</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-/**</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">- * Read default alarm settings from user preferences and apply them to</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">- * the event/todo passed in.</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">- *</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineminus">- * @param aItem   The event or todo the settings should be applied to.</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineminus">- */</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineminus">-function setDefaultAlarmValues(aItem)</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineminus">-{</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineminus">-    var prefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineminus">-                                .getService(Components.interfaces.nsIPrefService);</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineminus">-    var alarmsBranch = prefService.getBranch(&quot;calendar.alarms.&quot;);</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineminus">-</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineminus">-    if (isEvent(aItem)) {</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineminus">-        try {</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineminus">-            if (alarmsBranch.getIntPref(&quot;onforevents&quot;) == 1) {</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineminus">-                let alarmOffset = createDuration();</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineminus">-                let units = alarmsBranch.getCharPref(&quot;eventalarmunit&quot;);</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineminus">-                alarmOffset[units] = alarmsBranch.getIntPref(&quot;eventalarmlen&quot;);</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineminus">-                alarmOffset.isNegative = true;</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-                aItem.alarmOffset = alarmOffset;</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineminus">-                aItem.alarmRelated = Components.interfaces.calIItemBase.ALARM_RELATED_START;</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-            }</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineminus">-        } catch (ex) {</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineminus">-            Components.utils.reportError(</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineminus">-                &quot;Failed to apply default alarm settings to event: &quot; + ex);</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineminus">-        }</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineminus">-    } else if (isToDo(aItem)) {</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineminus">-        try {</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineminus">-            if (alarmsBranch.getIntPref(&quot;onfortodos&quot;) == 1) {</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineminus">-                // You can't have an alarm if the entryDate doesn't exist.</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineminus">-                if (!aItem.entryDate) {</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineminus">-                    aItem.entryDate = getSelectedDay() &amp;&amp;</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineminus">-                                      getSelectedDay().clone() || now();</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineminus">-                }</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineminus">-                let alarmOffset = createDuration();</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineminus">-                let units = alarmsBranch.getCharPref(&quot;todoalarmunit&quot;);</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineminus">-                alarmOffset[units] = alarmsBranch.getIntPref(&quot;todoalarmlen&quot;);</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineminus">-                alarmOffset.isNegative = true;</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineminus">-                aItem.alarmOffset = alarmOffset;</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineminus">-                aItem.alarmRelated = Components.interfaces.calIItemBase.ALARM_RELATED_START;</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineminus">-            }</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineminus">-        } catch (ex) {</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineminus">-            Components.utils.reportError(</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineminus">-                &quot;Failed to apply default alarm settings to task: &quot; + ex);</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineminus">-        }</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineminus">-    }</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineminus">-}</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineminus">-</span>
<a href="#l18.60"></a><span id="l18.60"> function getCompositeCalendar() {</span>
<a href="#l18.61"></a><span id="l18.61">     if (getCompositeCalendar.mObject === undefined) {</span>
<a href="#l18.62"></a><span id="l18.62">         getCompositeCalendar.mObject = Components.classes[&quot;@mozilla.org/calendar/calendar;1?type=composite&quot;]</span>
<a href="#l18.63"></a><span id="l18.63">                                                  .createInstance(Components.interfaces.calICompositeCalendar);</span>
<a href="#l18.64"></a><span id="l18.64">         getCompositeCalendar.mObject.prefPrefix = 'calendar-main';</span>
<a href="#l18.65"></a><span id="l18.65"> </span>
<a href="#l18.66"></a><span id="l18.66">         try {</span>
<a href="#l18.67"></a><span id="l18.67">             if (gCalendarStatusFeedback) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/calendar/import-export/calOutlookCSVImportExport.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/calendar/import-export/calOutlookCSVImportExport.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -17,16 +17,17 @@</span>
<a href="#l19.4"></a><span id="l19.4">  * The Initial Developer of the Original Code is</span>
<a href="#l19.5"></a><span id="l19.5">  * Jussi Kukkonen &lt;jussi.kukkonen@welho.com&gt;.</span>
<a href="#l19.6"></a><span id="l19.6">  * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l19.7"></a><span id="l19.7">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l19.8"></a><span id="l19.8">  *</span>
<a href="#l19.9"></a><span id="l19.9">  * Contributor(s):</span>
<a href="#l19.10"></a><span id="l19.10">  *   Michiel van Leeuwen &lt;mvl@exedo.nl&gt;</span>
<a href="#l19.11"></a><span id="l19.11">  *   Ernst Herbst &lt;hb@calen.de&gt;</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+ *   Philipp Kewisch &lt;mozilla@kewis.ch&gt;</span>
<a href="#l19.13"></a><span id="l19.13">  *</span>
<a href="#l19.14"></a><span id="l19.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l19.15"></a><span id="l19.15">  * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l19.16"></a><span id="l19.16">  * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l19.17"></a><span id="l19.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l19.18"></a><span id="l19.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l19.19"></a><span id="l19.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l19.20"></a><span id="l19.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineat">@@ -330,37 +331,30 @@ function csv_importFromStream(aStream, a</span>
<a href="#l19.22"></a><span id="l19.22">                 }</span>
<a href="#l19.23"></a><span id="l19.23">                 event.startDate = sDate;</span>
<a href="#l19.24"></a><span id="l19.24">                 event.endDate = eDate;</span>
<a href="#l19.25"></a><span id="l19.25"> </span>
<a href="#l19.26"></a><span id="l19.26">                 // Exists an alarm true/false column?</span>
<a href="#l19.27"></a><span id="l19.27">                 if (&quot;alarmIndex&quot; in args) {</span>
<a href="#l19.28"></a><span id="l19.28">                     // Is an alarm wanted for this event?</span>
<a href="#l19.29"></a><span id="l19.29">                     if (locale.valueTrue == eventFields[args.alarmIndex]) {</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineminus">-                        var alarmDate =</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineplus">+                        let alarmDate =</span>
<a href="#l19.32"></a><span id="l19.32">                                 parseDateTime(eventFields[args.alarmDateIndex],</span>
<a href="#l19.33"></a><span id="l19.33">                                               eventFields[args.alarmTimeIndex],</span>
<a href="#l19.34"></a><span id="l19.34">                                               locale);</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineminus">-                        // Set to default if non valid alarmDate was achieved</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineplus">+                        // Only set the alarm if a date was parsed</span>
<a href="#l19.37"></a><span id="l19.37">                         if (alarmDate) {</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineminus">-                            event.alarmOffset = alarmDate.subtractDate(sDate);</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineplus">+                            let alarm = cal.createAlarm();</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+                            alarm.related = alarm.ALARM_RELATED_ABSOLUTE;</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineplus">+                            alarm.alarmDate = alarmDate;</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+                            event.addAlarm(alarm);</span>
<a href="#l19.43"></a><span id="l19.43">                         } else {</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineminus">-                            var alarmOffset = Components</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineminus">-                                              .classes[&quot;@mozilla.org/calendar/duration;1&quot;]</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineminus">-                                              .createInstance(Components</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineminus">-                                              .interfaces.calIDuration);</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineminus">-                            var units = getPrefSafe(&quot;calendar.alarms.eventalarmunit&quot;,</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineminus">-                                                    &quot;minutes&quot;);</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineminus">-                            alarmOffset[units] = getPrefSafe(&quot;calendar.alarms.eventalarmlen&quot;,</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineminus">-                                                             15);</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineminus">-                            alarmOffset.isNegative = true;</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineminus">-                            event.alarmOffset = alarmOffset;</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineplus">+                            // XXX Is this really wanted here?</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineplus">+                            cal.alarms.setDefaultValues(event);</span>
<a href="#l19.56"></a><span id="l19.56">                         }</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineminus">-                        event.alarmRelated = Components.interfaces.calIItemBase</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineminus">-                                                       .ALARM_RELATED_START;</span>
<a href="#l19.59"></a><span id="l19.59">                     }</span>
<a href="#l19.60"></a><span id="l19.60">                 }</span>
<a href="#l19.61"></a><span id="l19.61"> </span>
<a href="#l19.62"></a><span id="l19.62">                 // Using the &quot;Private&quot; field only for getting privacy status.</span>
<a href="#l19.63"></a><span id="l19.63">                 // &quot;Sensitivity&quot; is neglected for now.</span>
<a href="#l19.64"></a><span id="l19.64">                 if (&quot;privateIndex&quot; in args) {</span>
<a href="#l19.65"></a><span id="l19.65">                     if (locale.valueTrue == eventFields[args.privateIndex]) {</span>
<a href="#l19.66"></a><span id="l19.66">                         event.privacy = &quot;PRIVATE&quot;;</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineat">@@ -508,31 +502,28 @@ function csv_exportToStream(aStream, aCo</span>
<a href="#l19.68"></a><span id="l19.68">         }</span>
<a href="#l19.69"></a><span id="l19.69">         var line = [];</span>
<a href="#l19.70"></a><span id="l19.70">         line.push(item.title);</span>
<a href="#l19.71"></a><span id="l19.71">         line.push(dateString(item.startDate));</span>
<a href="#l19.72"></a><span id="l19.72">         line.push(timeString(item.startDate));</span>
<a href="#l19.73"></a><span id="l19.73">         line.push(dateString(item.endDate));</span>
<a href="#l19.74"></a><span id="l19.74">         line.push(timeString(item.endDate));</span>
<a href="#l19.75"></a><span id="l19.75">         line.push(item.startDate.isDate ? localeEn.valueTrue : localeEn.valueFalse);</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineminus">-        if (item.alarmOffset) {</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineminus">-            line.push(localeEn.valueTrue);</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineminus">-            var fireTime;</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineminus">-            if (item.alarmRelated == Components.interfaces.calIItemBase.ALARM_RELATED_START) {</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineminus">-                fireTime = item.startDate.clone();</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineplus">+        let alarms = item.getAlarms({});</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineplus">+        if (alarms.length) {</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineplus">+            let alarmDate = cal.alarms.calculateAlarmDate(item, alarms[0]);</span>
<a href="#l19.84"></a><span id="l19.84" class="difflineplus">+            if (alarmDate) {</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineplus">+                line.push(localeEn.valueTrue);</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineplus">+                line.push(dateString(alarmDate));</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineplus">+                line.push(timeString(alarmDate));</span>
<a href="#l19.88"></a><span id="l19.88">             } else {</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineminus">-                fireTime = item.endDate.clone();</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineplus">+                line.push(localeEn.valueFalse);</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineplus">+                line.push(&quot;&quot;);</span>
<a href="#l19.92"></a><span id="l19.92" class="difflineplus">+                line.push(&quot;&quot;);</span>
<a href="#l19.93"></a><span id="l19.93">             }</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineminus">-            fireTime.addDuration(item.alarmOffset);</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineminus">-            line.push(dateString(fireTime));</span>
<a href="#l19.96"></a><span id="l19.96" class="difflineminus">-            line.push(timeString(fireTime));</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineminus">-        } else {</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineminus">-            line.push(localeEn.valueFalse);</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineminus">-            line.push(&quot;&quot;);</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineminus">-            line.push(&quot;&quot;);</span>
<a href="#l19.101"></a><span id="l19.101">         }</span>
<a href="#l19.102"></a><span id="l19.102">         line.push(txtString(categoriesArrayToString(item.getCategories({})))); // xxx todo: what's the correct way to encode ',' in csv?, how are multi-values expressed?</span>
<a href="#l19.103"></a><span id="l19.103">         line.push(txtString(item.getProperty(&quot;DESCRIPTION&quot;)));</span>
<a href="#l19.104"></a><span id="l19.104">         line.push(txtString(item.getProperty(&quot;LOCATION&quot;)));</span>
<a href="#l19.105"></a><span id="l19.105">         line.push((item.privacy==&quot;PRIVATE&quot;) ? localeEn.valueTrue : localeEn.valueFalse);</span>
<a href="#l19.106"></a><span id="l19.106"> </span>
<a href="#l19.107"></a><span id="l19.107">         line = line.map(function(v) {</span>
<a href="#l19.108"></a><span id="l19.108">             v = String(v).replace(/&quot;/g,'&quot;&quot;');</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleUtils.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleUtils.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -493,44 +493,55 @@ function ItemToXMLEntry(aItem, aAuthorEm</span>
<a href="#l20.4"></a><span id="l20.4">     entry.gCal::sendEventNotifications.@value = (notify ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l20.5"></a><span id="l20.5"> </span>
<a href="#l20.6"></a><span id="l20.6">     // gd:when</span>
<a href="#l20.7"></a><span id="l20.7">     var duration = aItem.endDate.subtractDate(aItem.startDate);</span>
<a href="#l20.8"></a><span id="l20.8">     entry.gd::when.@startTime = toRFC3339(aItem.startDate);</span>
<a href="#l20.9"></a><span id="l20.9">     entry.gd::when.@endTime = toRFC3339(aItem.endDate);</span>
<a href="#l20.10"></a><span id="l20.10"> </span>
<a href="#l20.11"></a><span id="l20.11">     // gd:reminder</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-    if (aItem.alarmOffset &amp;&amp; selfIsOrganizer) {</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-        var gdReminder = &lt;gd:reminder xmlns:gd={gd}/&gt;;</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-        var alarmOffset = aItem.alarmOffset.clone();</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">-</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineminus">-        if (aItem.alarmRelated == Components.interfaces.calIItemBase.ALARM_RELATED_END) {</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-            // Google always uses an alarm offset related to the start time</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-            alarmOffset.addDuration(duration);</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-        }</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineminus">-</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineminus">-        gdReminder.@minutes = -aItem.alarmOffset.inSeconds / 60;</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineminus">-        gdReminder.@method = &quot;alert&quot;;</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineplus">+    let alarms = aItem.getAlarms({});</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineplus">+    let actionMap = {</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineplus">+        DISPLAY: &quot;alert&quot;,</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineplus">+        EMAIL: &quot;email&quot;,</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineplus">+        SMS: &quot;sms&quot;</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineplus">+    };</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineplus">+    if (selfIsOrganizer) {</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineplus">+        for (let i = 0; i &lt; 5 &amp;&amp; i &lt; alarms.length; i++) {</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+            let alarm = alarms[i];</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+            let gdReminder = &lt;gd:reminder xmlns:gd={gd}/&gt;;</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+            if (alarm.related == alarm.ALARM_RELATED_ABSOLUTE) {</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+                // Setting an absolute date can be done directly. Google will take</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineplus">+                // care of calculating the offset.</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineplus">+                gdReminder.@absoluteTime = toRFC3339(alarm.alarmDate);</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+            } else {</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+                let alarmOffset = alarm.offset;</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+                if (alarm.related == alarm.ALARM_RELATED_END) {</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineplus">+                    // Google always uses an alarm offset related to the start time</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+                    // for relative alarms.</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+                    alarmOffset = alarmOffset.clone();</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineplus">+                    alarmOffset.addDuration(duration);</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineplus">+                }</span>
<a href="#l20.45"></a><span id="l20.45"> </span>
<a href="#l20.46"></a><span id="l20.46" class="difflineminus">-        if (aItem.recurrenceInfo) {</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineminus">-            // On recurring items, set the reminder directly in the &lt;entry&gt; tag.</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineminus">-            entry.gd::reminder += gdReminder;</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineminus">-        } else {</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineminus">-            // Otherwise, its a child of the gd:when element</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineminus">-            entry.gd::when.gd::reminder += gdReminder;</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineplus">+                gdReminder.@minutes = -alarmOffset.inSeconds / 60;</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineplus">+                gdReminder.@method = actionMap[alarm.action] || &quot;alert&quot;;</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineplus">+            }</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineplus">+</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineplus">+</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+            if (aItem.recurrenceInfo) {</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineplus">+                // On recurring items, set the reminder directly in the &lt;entry&gt; tag.</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineplus">+                entry.gd::reminder += gdReminder;</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineplus">+            } else {</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineplus">+                // Otherwise, its a child of the gd:when element</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineplus">+                entry.gd::when.gd::reminder += gdReminder;</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineplus">+            }</span>
<a href="#l20.64"></a><span id="l20.64">         }</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineminus">-    } else if (aItem.alarmOffset) {</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineplus">+    } else if (alarms.length) {</span>
<a href="#l20.67"></a><span id="l20.67">         // We need to reset this so the item gets returned correctly.</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineminus">-        aItem.alarmOffset = null;</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineminus">-    }</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineminus">-</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineminus">-    // saved alarms</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineminus">-    var otherAlarms = aItem.getProperty(&quot;X-GOOGLE-OTHERALARMS&quot;);</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineminus">-    for each (var alarm in otherAlarms) {</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineminus">-        entry.gd::when.gd::reminder += new XML(alarm);</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineplus">+        aItem.clearAlarms();</span>
<a href="#l20.76"></a><span id="l20.76">     }</span>
<a href="#l20.77"></a><span id="l20.77"> </span>
<a href="#l20.78"></a><span id="l20.78">     // gd:extendedProperty (alarmLastAck)</span>
<a href="#l20.79"></a><span id="l20.79">     addExtendedProperty(&quot;X-MOZ-LASTACK&quot;, toRFC3339(aItem.alarmLastAck));</span>
<a href="#l20.80"></a><span id="l20.80"> </span>
<a href="#l20.81"></a><span id="l20.81">     // XXX While Google now supports multiple alarms and alarm values, we still</span>
<a href="#l20.82"></a><span id="l20.82">     // need to fix bug 353492 first so we can better take care of finding out</span>
<a href="#l20.83"></a><span id="l20.83">     // what alarm is used for snoozing.</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineat">@@ -646,93 +657,114 @@ function relevantFieldsMatch(a, b) {</span>
<a href="#l20.85"></a><span id="l20.85">     if (a.id != b.id ||</span>
<a href="#l20.86"></a><span id="l20.86">         a.title != b.title ||</span>
<a href="#l20.87"></a><span id="l20.87">         a.status != b.status ||</span>
<a href="#l20.88"></a><span id="l20.88">         a.privacy != b.privacy) {</span>
<a href="#l20.89"></a><span id="l20.89">         return false;</span>
<a href="#l20.90"></a><span id="l20.90">     }</span>
<a href="#l20.91"></a><span id="l20.91"> </span>
<a href="#l20.92"></a><span id="l20.92">     function compareNotNull(prop) {</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineminus">-        var ap = a[prop];</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineminus">-        var bp = b[prop];</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineplus">+        let ap = a[prop];</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineplus">+        let bp = b[prop];</span>
<a href="#l20.97"></a><span id="l20.97">         return (ap &amp;&amp; !bp || !ap &amp;&amp; bp ||</span>
<a href="#l20.98"></a><span id="l20.98">                 (typeof(ap) == 'object' &amp;&amp; ap &amp;&amp; bp &amp;&amp;</span>
<a href="#l20.99"></a><span id="l20.99">                  ap.compare &amp;&amp; ap.compare(bp)));</span>
<a href="#l20.100"></a><span id="l20.100">     }</span>
<a href="#l20.101"></a><span id="l20.101"> </span>
<a href="#l20.102"></a><span id="l20.102">     // Object flat values</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineminus">-    if (compareNotNull(&quot;alarmOffset&quot;) ||</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineminus">-        compareNotNull(&quot;alarmLastAck&quot;) ||</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineminus">-        compareNotNull(&quot;recurrenceInfo&quot;) ||</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineplus">+    if (compareNotNull(&quot;recurrenceInfo&quot;) ||</span>
<a href="#l20.107"></a><span id="l20.107">         /* Compare startDate and endDate */</span>
<a href="#l20.108"></a><span id="l20.108">         compareNotNull(&quot;startDate&quot;) ||</span>
<a href="#l20.109"></a><span id="l20.109">         compareNotNull(&quot;endDate&quot;) ||</span>
<a href="#l20.110"></a><span id="l20.110">         (a.startDate.isDate != b.startDate.isDate) ||</span>
<a href="#l20.111"></a><span id="l20.111">         (a.endDate.isDate != b.endDate.isDate)) {</span>
<a href="#l20.112"></a><span id="l20.112">         return false;</span>
<a href="#l20.113"></a><span id="l20.113">     }</span>
<a href="#l20.114"></a><span id="l20.114"> </span>
<a href="#l20.115"></a><span id="l20.115">     // Properties</span>
<a href="#l20.116"></a><span id="l20.116">     const kPROPERTIES = [&quot;DESCRIPTION&quot;, &quot;TRANSP&quot;, &quot;X-GOOGLE-EDITURL&quot;,</span>
<a href="#l20.117"></a><span id="l20.117">                          &quot;LOCATION&quot;, &quot;X-MOZ-SNOOZE-TIME&quot;];</span>
<a href="#l20.118"></a><span id="l20.118"> </span>
<a href="#l20.119"></a><span id="l20.119" class="difflineminus">-    for each (var p in kPROPERTIES) {</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineplus">+    for each (let p in kPROPERTIES) {</span>
<a href="#l20.121"></a><span id="l20.121">         // null and an empty string should be handled as non-relevant</span>
<a href="#l20.122"></a><span id="l20.122">         if ((a.getProperty(p) || &quot;&quot;) != (b.getProperty(p) || &quot;&quot;)) {</span>
<a href="#l20.123"></a><span id="l20.123">             return false;</span>
<a href="#l20.124"></a><span id="l20.124">         }</span>
<a href="#l20.125"></a><span id="l20.125">     }</span>
<a href="#l20.126"></a><span id="l20.126"> </span>
<a href="#l20.127"></a><span id="l20.127">     // categories</span>
<a href="#l20.128"></a><span id="l20.128" class="difflineminus">-    var aCat = a.getCategories({});</span>
<a href="#l20.129"></a><span id="l20.129" class="difflineminus">-    var bCat = b.getCategories({});</span>
<a href="#l20.130"></a><span id="l20.130" class="difflineplus">+    let aCat = a.getCategories({});</span>
<a href="#l20.131"></a><span id="l20.131" class="difflineplus">+    let bCat = b.getCategories({});</span>
<a href="#l20.132"></a><span id="l20.132">     if ((aCat.length != bCat.length) ||</span>
<a href="#l20.133"></a><span id="l20.133">         aCat.some(function notIn(cat) { return (bCat.indexOf(cat) == -1); })) {</span>
<a href="#l20.134"></a><span id="l20.134">         return false;</span>
<a href="#l20.135"></a><span id="l20.135">     }</span>
<a href="#l20.136"></a><span id="l20.136"> </span>
<a href="#l20.137"></a><span id="l20.137">     // attendees and organzier</span>
<a href="#l20.138"></a><span id="l20.138" class="difflineminus">-    var aa = a.getAttendees({});</span>
<a href="#l20.139"></a><span id="l20.139" class="difflineminus">-    var ab = b.getAttendees({});</span>
<a href="#l20.140"></a><span id="l20.140" class="difflineplus">+    let aa = a.getAttendees({});</span>
<a href="#l20.141"></a><span id="l20.141" class="difflineplus">+    let ab = b.getAttendees({});</span>
<a href="#l20.142"></a><span id="l20.142">     if (aa.length != ab.length) {</span>
<a href="#l20.143"></a><span id="l20.143">         return false;</span>
<a href="#l20.144"></a><span id="l20.144">     }</span>
<a href="#l20.145"></a><span id="l20.145"> </span>
<a href="#l20.146"></a><span id="l20.146">     if ((a.organizer &amp;&amp; !b.organizer) ||</span>
<a href="#l20.147"></a><span id="l20.147">         (!a.organizer &amp;&amp; b.organizer) ||</span>
<a href="#l20.148"></a><span id="l20.148">         (a.organizer &amp;&amp; b.organizer &amp;&amp; a.organizer.id != b.organizer.id)) {</span>
<a href="#l20.149"></a><span id="l20.149">         return false;</span>
<a href="#l20.150"></a><span id="l20.150">     }</span>
<a href="#l20.151"></a><span id="l20.151"> </span>
<a href="#l20.152"></a><span id="l20.152">     // go through attendees in a, check if its id is in b</span>
<a href="#l20.153"></a><span id="l20.153" class="difflineminus">-    for each (var attendee in aa) {</span>
<a href="#l20.154"></a><span id="l20.154" class="difflineminus">-        var ba = b.getAttendeeById(attendee.id);</span>
<a href="#l20.155"></a><span id="l20.155" class="difflineplus">+    for each (let attendee in aa) {</span>
<a href="#l20.156"></a><span id="l20.156" class="difflineplus">+        let ba = b.getAttendeeById(attendee.id);</span>
<a href="#l20.157"></a><span id="l20.157">         if (!ba ||</span>
<a href="#l20.158"></a><span id="l20.158">             ba.participationStatus != attendee.participationStatus ||</span>
<a href="#l20.159"></a><span id="l20.159">             ba.commonName != attendee.commonName ||</span>
<a href="#l20.160"></a><span id="l20.160">             ba.isOrganizer != attendee.isOrganizer ||</span>
<a href="#l20.161"></a><span id="l20.161">             ba.role != attendee.role) {</span>
<a href="#l20.162"></a><span id="l20.162">             return false;</span>
<a href="#l20.163"></a><span id="l20.163">         }</span>
<a href="#l20.164"></a><span id="l20.164">     }</span>
<a href="#l20.165"></a><span id="l20.165"> </span>
<a href="#l20.166"></a><span id="l20.166" class="difflineplus">+    // Alarms</span>
<a href="#l20.167"></a><span id="l20.167" class="difflineplus">+    aa = a.getAlarms({});</span>
<a href="#l20.168"></a><span id="l20.168" class="difflineplus">+    ab = b.getAlarms({});</span>
<a href="#l20.169"></a><span id="l20.169" class="difflineplus">+</span>
<a href="#l20.170"></a><span id="l20.170" class="difflineplus">+    if (aa.length != ab.length) {</span>
<a href="#l20.171"></a><span id="l20.171" class="difflineplus">+        return false;</span>
<a href="#l20.172"></a><span id="l20.172" class="difflineplus">+    }</span>
<a href="#l20.173"></a><span id="l20.173" class="difflineplus">+</span>
<a href="#l20.174"></a><span id="l20.174" class="difflineplus">+    let alarmMap = {};</span>
<a href="#l20.175"></a><span id="l20.175" class="difflineplus">+    for each (let alarm in aa) {</span>
<a href="#l20.176"></a><span id="l20.176" class="difflineplus">+        alarmMap[alarm.icalString] = true;</span>
<a href="#l20.177"></a><span id="l20.177" class="difflineplus">+    }</span>
<a href="#l20.178"></a><span id="l20.178" class="difflineplus">+    let found = 0;</span>
<a href="#l20.179"></a><span id="l20.179" class="difflineplus">+    for each (let alarm in ab) {</span>
<a href="#l20.180"></a><span id="l20.180" class="difflineplus">+        if (alarm.icalString in alarmMap) {</span>
<a href="#l20.181"></a><span id="l20.181" class="difflineplus">+            found++;</span>
<a href="#l20.182"></a><span id="l20.182" class="difflineplus">+        }</span>
<a href="#l20.183"></a><span id="l20.183" class="difflineplus">+    }</span>
<a href="#l20.184"></a><span id="l20.184" class="difflineplus">+</span>
<a href="#l20.185"></a><span id="l20.185" class="difflineplus">+    if (found != ab.length) {</span>
<a href="#l20.186"></a><span id="l20.186" class="difflineplus">+        return false;</span>
<a href="#l20.187"></a><span id="l20.187" class="difflineplus">+    }</span>
<a href="#l20.188"></a><span id="l20.188" class="difflineplus">+</span>
<a href="#l20.189"></a><span id="l20.189">     // Recurrence Items</span>
<a href="#l20.190"></a><span id="l20.190">     if (a.recurrenceInfo) {</span>
<a href="#l20.191"></a><span id="l20.191" class="difflineminus">-        var ra = a.recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l20.192"></a><span id="l20.192" class="difflineminus">-        var rb = b.recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l20.193"></a><span id="l20.193" class="difflineplus">+        let ra = a.recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l20.194"></a><span id="l20.194" class="difflineplus">+        let rb = b.recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l20.195"></a><span id="l20.195"> </span>
<a href="#l20.196"></a><span id="l20.196">         // If we have more or less, it definitly changed.</span>
<a href="#l20.197"></a><span id="l20.197">         if (ra.length != rb.length) {</span>
<a href="#l20.198"></a><span id="l20.198">             return false;</span>
<a href="#l20.199"></a><span id="l20.199">         }</span>
<a href="#l20.200"></a><span id="l20.200"> </span>
<a href="#l20.201"></a><span id="l20.201">         // I assume that if the recurrence pattern has not changed, the order</span>
<a href="#l20.202"></a><span id="l20.202">         // of the recurrence items should not change. Anything more will be</span>
<a href="#l20.203"></a><span id="l20.203">         // very expensive.</span>
<a href="#l20.204"></a><span id="l20.204" class="difflineminus">-        for (var i=0; i &lt; ra.length; i++) {</span>
<a href="#l20.205"></a><span id="l20.205" class="difflineplus">+        for (let i = 0; i &lt; ra.length; i++) {</span>
<a href="#l20.206"></a><span id="l20.206">             if (ra[i].icalProperty.icalString !=</span>
<a href="#l20.207"></a><span id="l20.207">                 rb[i].icalProperty.icalString) {</span>
<a href="#l20.208"></a><span id="l20.208">                 return false;</span>
<a href="#l20.209"></a><span id="l20.209">             }</span>
<a href="#l20.210"></a><span id="l20.210">         }</span>
<a href="#l20.211"></a><span id="l20.211">     }</span>
<a href="#l20.212"></a><span id="l20.212"> </span>
<a href="#l20.213"></a><span id="l20.213">     return true;</span>
<a href="#l20.214"></a><span id="l20.214" class="difflineat">@@ -833,86 +865,64 @@ function XMLEntryToItem(aXMLEntry, aTime</span>
<a href="#l20.215"></a><span id="l20.215">                          aXMLEntry.gd::transparency.@value.toString()</span>
<a href="#l20.216"></a><span id="l20.216">                                   .substring(39).toUpperCase());</span>
<a href="#l20.217"></a><span id="l20.217"> </span>
<a href="#l20.218"></a><span id="l20.218">         // gd:eventStatus</span>
<a href="#l20.219"></a><span id="l20.219">         item.status = aXMLEntry.gd::eventStatus.@value.toString()</span>
<a href="#l20.220"></a><span id="l20.220">                                .substring(39).toUpperCase();</span>
<a href="#l20.221"></a><span id="l20.221"> </span>
<a href="#l20.222"></a><span id="l20.222">         // gd:reminder (preparation)</span>
<a href="#l20.223"></a><span id="l20.223" class="difflineminus">-        // Google's alarms are always related to the start</span>
<a href="#l20.224"></a><span id="l20.224" class="difflineminus">-        item.alarmRelated = Components.interfaces.calIItemBase.ALARM_RELATED_START;</span>
<a href="#l20.225"></a><span id="l20.225" class="difflineplus">+        // If a reference item was passed, it may already contain alarms. Since</span>
<a href="#l20.226"></a><span id="l20.226" class="difflineplus">+        // we have no alarm id or such and the alarms are contained in every</span>
<a href="#l20.227"></a><span id="l20.227" class="difflineplus">+        // feed, we can go ahead and clear the alarms here.</span>
<a href="#l20.228"></a><span id="l20.228" class="difflineplus">+        item.clearAlarms();</span>
<a href="#l20.229"></a><span id="l20.229"> </span>
<a href="#l20.230"></a><span id="l20.230">         /**</span>
<a href="#l20.231"></a><span id="l20.231" class="difflineminus">-         * Helper function to parse all reminders in a tagset. This sets the</span>
<a href="#l20.232"></a><span id="l20.232" class="difflineminus">-         * item's alarm, and also saves all other alarms using the</span>
<a href="#l20.233"></a><span id="l20.233" class="difflineminus">-         * X-GOOGLE-OTHERALARMS property.</span>
<a href="#l20.234"></a><span id="l20.234" class="difflineplus">+         * Helper function to parse all reminders in a tagset.</span>
<a href="#l20.235"></a><span id="l20.235">          *</span>
<a href="#l20.236"></a><span id="l20.236">          * @param reminderTags      The tagset to parse.</span>
<a href="#l20.237"></a><span id="l20.237">          */</span>
<a href="#l20.238"></a><span id="l20.238">         function parseReminders(reminderTags) {</span>
<a href="#l20.239"></a><span id="l20.239">             if (aXMLEntry.gd::who.(@rel.substring(33) == &quot;event.organizer&quot;)</span>
<a href="#l20.240"></a><span id="l20.240">                          .@email.toString() != aCalendar.googleCalendarName) {</span>
<a href="#l20.241"></a><span id="l20.241">                 // We are not the organizer, so its not smart to set alarms on</span>
<a href="#l20.242"></a><span id="l20.242">                 // this event.</span>
<a href="#l20.243"></a><span id="l20.243">                 return;</span>
<a href="#l20.244"></a><span id="l20.244">             }</span>
<a href="#l20.245"></a><span id="l20.245" class="difflineminus">-            var lastAlarm;</span>
<a href="#l20.246"></a><span id="l20.246" class="difflineminus">-            var otherAlarms = [];</span>
<a href="#l20.247"></a><span id="l20.247" class="difflineminus">-            // Go through all reminder tags given and pick the best alarm.</span>
<a href="#l20.248"></a><span id="l20.248" class="difflineminus">-            for each (var reminder in reminderTags) {</span>
<a href="#l20.249"></a><span id="l20.249" class="difflineminus">-                // We are only intrested in &quot;alert&quot; reminders. Other types</span>
<a href="#l20.250"></a><span id="l20.250" class="difflineminus">-                // include sms and email alerts, but thats not the point here.</span>
<a href="#l20.251"></a><span id="l20.251" class="difflineminus">-                if (reminder.@method == &quot;alert&quot;) {</span>
<a href="#l20.252"></a><span id="l20.252" class="difflineplus">+            const actionMap = {</span>
<a href="#l20.253"></a><span id="l20.253" class="difflineplus">+                email: &quot;EMAIL&quot;,</span>
<a href="#l20.254"></a><span id="l20.254" class="difflineplus">+                alert: &quot;DISPLAY&quot;,</span>
<a href="#l20.255"></a><span id="l20.255" class="difflineplus">+                sms: &quot;SMS&quot;</span>
<a href="#l20.256"></a><span id="l20.256" class="difflineplus">+            };</span>
<a href="#l20.257"></a><span id="l20.257" class="difflineplus">+            for each (let reminderTag in reminderTags) {</span>
<a href="#l20.258"></a><span id="l20.258" class="difflineplus">+                let alarm = cal.createAlarm();</span>
<a href="#l20.259"></a><span id="l20.259" class="difflineplus">+                alarm.action = actionMap[reminderTag.@method] || &quot;DISPLAY&quot;;</span>
<a href="#l20.260"></a><span id="l20.260" class="difflineplus">+                if (reminderTag.@absoluteTime.toString()) {</span>
<a href="#l20.261"></a><span id="l20.261" class="difflineplus">+                    alarm.related = Components.interfaces.calIAlarm.ALARM_RELATED_ABSOLUTE;</span>
<a href="#l20.262"></a><span id="l20.262" class="difflineplus">+                    let absolute = fromRFC3339(reminderTag.@absoluteTime,</span>
<a href="#l20.263"></a><span id="l20.263" class="difflineplus">+                                               aTimezone);</span>
<a href="#l20.264"></a><span id="l20.264" class="difflineplus">+                    alarm.alarmDate = absolute;</span>
<a href="#l20.265"></a><span id="l20.265" class="difflineplus">+                } else {</span>
<a href="#l20.266"></a><span id="l20.266" class="difflineplus">+                    alarm.related = Components.interfaces.calIAlarm.ALARM_RELATED_START;</span>
<a href="#l20.267"></a><span id="l20.267">                     let alarmOffset = cal.createDuration();</span>
<a href="#l20.268"></a><span id="l20.268" class="difflineminus">-</span>
<a href="#l20.269"></a><span id="l20.269" class="difflineminus">-                    if (reminder.@absoluteTime.toString()) {</span>
<a href="#l20.270"></a><span id="l20.270" class="difflineminus">-                        var absolute = fromRFC3339(reminder.@absoluteTime,</span>
<a href="#l20.271"></a><span id="l20.271" class="difflineminus">-                                                   aTimezone);</span>
<a href="#l20.272"></a><span id="l20.272" class="difflineminus">-                        alarmOffset = startDate.subtractDate(absolute);</span>
<a href="#l20.273"></a><span id="l20.273" class="difflineminus">-                    } else if (reminder.@days.toString()) {</span>
<a href="#l20.274"></a><span id="l20.274" class="difflineminus">-                        alarmOffset.days = -reminder.@days;</span>
<a href="#l20.275"></a><span id="l20.275" class="difflineminus">-                    } else if (reminder.@hours.toString()) {</span>
<a href="#l20.276"></a><span id="l20.276" class="difflineminus">-                        alarmOffset.hours = -reminder.@hours;</span>
<a href="#l20.277"></a><span id="l20.277" class="difflineminus">-                    } else if (reminder.@minutes.toString()) {</span>
<a href="#l20.278"></a><span id="l20.278" class="difflineminus">-                        alarmOffset.minutes = -reminder.@minutes;</span>
<a href="#l20.279"></a><span id="l20.279" class="difflineplus">+                    if (reminderTag.@days.toString()) {</span>
<a href="#l20.280"></a><span id="l20.280" class="difflineplus">+                        alarmOffset.days = -reminderTag.@days;</span>
<a href="#l20.281"></a><span id="l20.281" class="difflineplus">+                    } else if (reminderTag.@hours.toString()) {</span>
<a href="#l20.282"></a><span id="l20.282" class="difflineplus">+                        alarmOffset.hours = -reminderTag.@hours;</span>
<a href="#l20.283"></a><span id="l20.283" class="difflineplus">+                    } else if (reminderTag.@minutes.toString()) {</span>
<a href="#l20.284"></a><span id="l20.284" class="difflineplus">+                        alarmOffset.minutes = -reminderTag.@minutes;</span>
<a href="#l20.285"></a><span id="l20.285">                     } else {</span>
<a href="#l20.286"></a><span id="l20.286">                         // Invalid alarm, skip it</span>
<a href="#l20.287"></a><span id="l20.287">                         continue;</span>
<a href="#l20.288"></a><span id="l20.288">                     }</span>
<a href="#l20.289"></a><span id="l20.289">                     alarmOffset.normalize();</span>
<a href="#l20.290"></a><span id="l20.290" class="difflineminus">-</span>
<a href="#l20.291"></a><span id="l20.291" class="difflineminus">-                    // If there is more than one alarm, we could either take the</span>
<a href="#l20.292"></a><span id="l20.292" class="difflineminus">-                    // alarm closest to the event or the alarm furthest to the</span>
<a href="#l20.293"></a><span id="l20.293" class="difflineminus">-                    // event. Let the user decide (use a property)</span>
<a href="#l20.294"></a><span id="l20.294" class="difflineminus">-                    var useClosest = getPrefSafe(&quot;calendar.google.alarmClosest&quot;,</span>
<a href="#l20.295"></a><span id="l20.295" class="difflineminus">-                                                 true);</span>
<a href="#l20.296"></a><span id="l20.296" class="difflineminus">-                    if (!item.alarmOffset ||</span>
<a href="#l20.297"></a><span id="l20.297" class="difflineminus">-                        (useClosest &amp;&amp;</span>
<a href="#l20.298"></a><span id="l20.298" class="difflineminus">-                         alarmOffset.compare(item.alarmOffset) &gt; 0) ||</span>
<a href="#l20.299"></a><span id="l20.299" class="difflineminus">-                        (!useClosest &amp;&amp;</span>
<a href="#l20.300"></a><span id="l20.300" class="difflineminus">-                         alarmOffset.compare(item.alarmOffset) &lt; 0)) {</span>
<a href="#l20.301"></a><span id="l20.301" class="difflineminus">-</span>
<a href="#l20.302"></a><span id="l20.302" class="difflineminus">-                        item.alarmOffset = alarmOffset;</span>
<a href="#l20.303"></a><span id="l20.303" class="difflineminus">-                        if (lastAlarm) {</span>
<a href="#l20.304"></a><span id="l20.304" class="difflineminus">-                            // If there was already an alarm, then it is now one</span>
<a href="#l20.305"></a><span id="l20.305" class="difflineminus">-                            // of the other alarms.</span>
<a href="#l20.306"></a><span id="l20.306" class="difflineminus">-                            otherAlarms.push(lastAlarm.toXMLString());</span>
<a href="#l20.307"></a><span id="l20.307" class="difflineminus">-                        }</span>
<a href="#l20.308"></a><span id="l20.308" class="difflineminus">-                        lastAlarm = reminder;</span>
<a href="#l20.309"></a><span id="l20.309" class="difflineminus">-                        // Don't push the reminder below, since we might be</span>
<a href="#l20.310"></a><span id="l20.310" class="difflineminus">-                        // keeping this one as our item's alarmOffset.</span>
<a href="#l20.311"></a><span id="l20.311" class="difflineminus">-                        continue;</span>
<a href="#l20.312"></a><span id="l20.312" class="difflineminus">-                    }</span>
<a href="#l20.313"></a><span id="l20.313" class="difflineplus">+                    alarm.offset = alarmOffset;</span>
<a href="#l20.314"></a><span id="l20.314">                 }</span>
<a href="#l20.315"></a><span id="l20.315" class="difflineminus">-                otherAlarms.push(reminder.toXMLString());</span>
<a href="#l20.316"></a><span id="l20.316" class="difflineplus">+                item.addAlarm(alarm);</span>
<a href="#l20.317"></a><span id="l20.317">             }</span>
<a href="#l20.318"></a><span id="l20.318" class="difflineminus">-</span>
<a href="#l20.319"></a><span id="l20.319" class="difflineminus">-            // Save other alarms that were set so we don't loose them</span>
<a href="#l20.320"></a><span id="l20.320" class="difflineminus">-            item.setProperty(&quot;X-GOOGLE-OTHERALARMS&quot;, otherAlarms);</span>
<a href="#l20.321"></a><span id="l20.321">         }</span>
<a href="#l20.322"></a><span id="l20.322"> </span>
<a href="#l20.323"></a><span id="l20.323">         // gd:when</span>
<a href="#l20.324"></a><span id="l20.324">         var recurrenceInfo = aXMLEntry.gd::recurrence.toString();</span>
<a href="#l20.325"></a><span id="l20.325">         if (recurrenceInfo.length == 0) {</span>
<a href="#l20.326"></a><span id="l20.326">             // If no recurrence information is given, then there will only be</span>
<a href="#l20.327"></a><span id="l20.327">             // one gd:when tag. Otherwise, we will be parsing the startDate from</span>
<a href="#l20.328"></a><span id="l20.328">             // the recurrence information.</span>
<a href="#l20.329"></a><span id="l20.329" class="difflineat">@@ -1207,48 +1217,79 @@ function LOGitem(item) {</span>
<a href="#l20.330"></a><span id="l20.330"> </span>
<a href="#l20.331"></a><span id="l20.331">         rstr += &quot;\tExceptions:\n&quot;;</span>
<a href="#l20.332"></a><span id="l20.332">         var exids = item.recurrenceInfo.getExceptionIds({});</span>
<a href="#l20.333"></a><span id="l20.333">         for each (var exc in exids) {</span>
<a href="#l20.334"></a><span id="l20.334">             rstr += &quot;\t\t&quot; + exc + &quot;\n&quot;;</span>
<a href="#l20.335"></a><span id="l20.335">         }</span>
<a href="#l20.336"></a><span id="l20.336">     }</span>
<a href="#l20.337"></a><span id="l20.337"> </span>
<a href="#l20.338"></a><span id="l20.338" class="difflineplus">+    let astr = &quot;\n&quot;;</span>
<a href="#l20.339"></a><span id="l20.339" class="difflineplus">+    let alarms = item.getAlarms({});</span>
<a href="#l20.340"></a><span id="l20.340" class="difflineplus">+    for each (let alarm in alarms) {</span>
<a href="#l20.341"></a><span id="l20.341" class="difflineplus">+        astr += &quot;\t\t&quot; + LOGalarm(alarm) + &quot;\n&quot;;</span>
<a href="#l20.342"></a><span id="l20.342" class="difflineplus">+    }</span>
<a href="#l20.343"></a><span id="l20.343" class="difflineplus">+</span>
<a href="#l20.344"></a><span id="l20.344" class="difflineplus">+</span>
<a href="#l20.345"></a><span id="l20.345">     LOG(&quot;Logging calIEvent:&quot; +</span>
<a href="#l20.346"></a><span id="l20.346">         &quot;\n\tid:&quot; + item.id +</span>
<a href="#l20.347"></a><span id="l20.347">         &quot;\n\tediturl:&quot; + item.getProperty(&quot;X-GOOGLE-EDITURL&quot;) +</span>
<a href="#l20.348"></a><span id="l20.348">         &quot;\n\tcreated:&quot; + item.getProperty(&quot;CREATED&quot;) +</span>
<a href="#l20.349"></a><span id="l20.349">         &quot;\n\tupdated:&quot; + item.getProperty(&quot;LAST-MODIFIED&quot;) +</span>
<a href="#l20.350"></a><span id="l20.350">         &quot;\n\ttitle:&quot; + item.title +</span>
<a href="#l20.351"></a><span id="l20.351">         &quot;\n\tcontent:&quot; + item.getProperty(&quot;DESCRIPTION&quot;) +</span>
<a href="#l20.352"></a><span id="l20.352">         &quot;\n\ttransparency:&quot; + item.getProperty(&quot;TRANSP&quot;) +</span>
<a href="#l20.353"></a><span id="l20.353">         &quot;\n\tstatus:&quot; + item.status +</span>
<a href="#l20.354"></a><span id="l20.354">         &quot;\n\tstartTime:&quot; + item.startDate.toString() +</span>
<a href="#l20.355"></a><span id="l20.355">         &quot;\n\tendTime:&quot; + item.endDate.toString() +</span>
<a href="#l20.356"></a><span id="l20.356">         &quot;\n\tlocation:&quot; + item.getProperty(&quot;LOCATION&quot;) +</span>
<a href="#l20.357"></a><span id="l20.357">         &quot;\n\tprivacy:&quot; + item.privacy +</span>
<a href="#l20.358"></a><span id="l20.358" class="difflineminus">-        &quot;\n\talarmOffset:&quot; + item.alarmOffset +</span>
<a href="#l20.359"></a><span id="l20.359">         &quot;\n\talarmLastAck:&quot; + item.alarmLastAck +</span>
<a href="#l20.360"></a><span id="l20.360">         &quot;\n\tsnoozeTime:&quot; + item.getProperty(&quot;X-MOZ-SNOOZE-TIME&quot;) +</span>
<a href="#l20.361"></a><span id="l20.361">         &quot;\n\tisOccurrence: &quot; + (item.recurrenceId != null) +</span>
<a href="#l20.362"></a><span id="l20.362">         &quot;\n\tOrganizer: &quot; + LOGattendee(item.organizer) +</span>
<a href="#l20.363"></a><span id="l20.363">         &quot;\n\tAttendees: &quot; + attendeeString +</span>
<a href="#l20.364"></a><span id="l20.364" class="difflineminus">-        &quot;\n\trecurrence: &quot; + (rstr.length &gt; 1 ? &quot;yes: &quot; + rstr : &quot;no&quot;));</span>
<a href="#l20.365"></a><span id="l20.365" class="difflineplus">+        &quot;\n\trecurrence: &quot; + (rstr.length &gt; 1 ? &quot;yes: &quot; + rstr : &quot;no&quot;) +</span>
<a href="#l20.366"></a><span id="l20.366" class="difflineplus">+        &quot;\n\talarms: &quot; + (astr.length &gt; 1 ? &quot;yes: &quot; + astr : &quot;no&quot;));</span>
<a href="#l20.367"></a><span id="l20.367"> }</span>
<a href="#l20.368"></a><span id="l20.368"> </span>
<a href="#l20.369"></a><span id="l20.369"> function LOGattendee(aAttendee, asString) {</span>
<a href="#l20.370"></a><span id="l20.370">     return aAttendee &amp;&amp;</span>
<a href="#l20.371"></a><span id="l20.371">         (&quot;\n\t\tID: &quot; + aAttendee.id +</span>
<a href="#l20.372"></a><span id="l20.372">          &quot;\n\t\t\tName: &quot; + aAttendee.commonName +</span>
<a href="#l20.373"></a><span id="l20.373">          &quot;\n\t\t\tRsvp: &quot; + aAttendee.rsvp +</span>
<a href="#l20.374"></a><span id="l20.374">          &quot;\n\t\t\tIs Organizer: &quot; +  (aAttendee.isOrganizer ? &quot;yes&quot; : &quot;no&quot;) +</span>
<a href="#l20.375"></a><span id="l20.375">          &quot;\n\t\t\tRole: &quot; + aAttendee.role +</span>
<a href="#l20.376"></a><span id="l20.376">          &quot;\n\t\t\tStatus: &quot; + aAttendee.participationStatus);</span>
<a href="#l20.377"></a><span id="l20.377"> }</span>
<a href="#l20.378"></a><span id="l20.378"> </span>
<a href="#l20.379"></a><span id="l20.379" class="difflineplus">+function LOGalarm(aAlarm) {</span>
<a href="#l20.380"></a><span id="l20.380" class="difflineplus">+    if (!aAlarm) {</span>
<a href="#l20.381"></a><span id="l20.381" class="difflineplus">+        return &quot;&quot;;</span>
<a href="#l20.382"></a><span id="l20.382" class="difflineplus">+    }</span>
<a href="#l20.383"></a><span id="l20.383" class="difflineplus">+</span>
<a href="#l20.384"></a><span id="l20.384" class="difflineplus">+    let enumerator = aAlarm.propertyEnumerator;</span>
<a href="#l20.385"></a><span id="l20.385" class="difflineplus">+    let xpropstr = &quot;&quot;;</span>
<a href="#l20.386"></a><span id="l20.386" class="difflineplus">+    while (enumerator.hasMoreElements()) {</span>
<a href="#l20.387"></a><span id="l20.387" class="difflineplus">+        let el = enumerator.getNext();</span>
<a href="#l20.388"></a><span id="l20.388" class="difflineplus">+        xpropstr += &quot;\n\t\t\t&quot; + el.key + &quot;:&quot; + el.value;</span>
<a href="#l20.389"></a><span id="l20.389" class="difflineplus">+    }</span>
<a href="#l20.390"></a><span id="l20.390" class="difflineplus">+</span>
<a href="#l20.391"></a><span id="l20.391" class="difflineplus">+    return (&quot;\n\t\tAction: &quot; +  aAlarm.action +</span>
<a href="#l20.392"></a><span id="l20.392" class="difflineplus">+            &quot;\n\t\tOffset: &quot; + (aAlarm.offset &amp;&amp; aAlarm.offset.toString()) +</span>
<a href="#l20.393"></a><span id="l20.393" class="difflineplus">+            &quot;\n\t\talarmDate: &quot; + (aAlarm.alarmDate &amp;&amp; aAlarm.alarmDate.toString()) +</span>
<a href="#l20.394"></a><span id="l20.394" class="difflineplus">+            &quot;\n\t\trelated: &quot; + aAlarm.related +</span>
<a href="#l20.395"></a><span id="l20.395" class="difflineplus">+            &quot;\n\t\trepeat: &quot; + aAlarm.repeat +</span>
<a href="#l20.396"></a><span id="l20.396" class="difflineplus">+            &quot;\n\t\trepeatOffset: &quot; + (aAlarm.repeatOffset &amp;&amp; aAlarm.repeatOffset.toString()) +</span>
<a href="#l20.397"></a><span id="l20.397" class="difflineplus">+            &quot;\n\t\trepeatDate: &quot; + (aAlarm.repeatDate &amp;&amp; aAlarm.repeatDate.toString()) +</span>
<a href="#l20.398"></a><span id="l20.398" class="difflineplus">+            &quot;\n\t\tdescription: &quot; + aAlarm.description +</span>
<a href="#l20.399"></a><span id="l20.399" class="difflineplus">+            &quot;\n\t\tsummary: &quot; + aAlarm.summary +</span>
<a href="#l20.400"></a><span id="l20.400" class="difflineplus">+            &quot;\n\t\tproperties: &quot; + (xpropstr.length &gt; 0 ? &quot;yes:&quot; + xpropstr : &quot;no&quot;));</span>
<a href="#l20.401"></a><span id="l20.401" class="difflineplus">+}</span>
<a href="#l20.402"></a><span id="l20.402" class="difflineplus">+</span>
<a href="#l20.403"></a><span id="l20.403"> function LOGinterval(aInterval) {</span>
<a href="#l20.404"></a><span id="l20.404">     const fbtypes = Components.interfaces.calIFreeBusyInterval;</span>
<a href="#l20.405"></a><span id="l20.405">     if (aInterval.freeBusyType == fbtypes.FREE) {</span>
<a href="#l20.406"></a><span id="l20.406">         type = &quot;FREE&quot;;</span>
<a href="#l20.407"></a><span id="l20.407">     } else if (aInterval.freeBusyType == fbtypes.BUSY) {</span>
<a href="#l20.408"></a><span id="l20.408">         type = &quot;BUSY&quot;;</span>
<a href="#l20.409"></a><span id="l20.409">     } else {</span>
<a href="#l20.410"></a><span id="l20.410">         type = aInterval.freeBusyType + &quot;(UNKNOWN)&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -40,16 +40,18 @@</span>
<a href="#l21.4"></a><span id="l21.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l21.5"></a><span id="l21.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l21.6"></a><span id="l21.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l21.7"></a><span id="l21.7">  *</span>
<a href="#l21.8"></a><span id="l21.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l21.9"></a><span id="l21.9"> </span>
<a href="#l21.10"></a><span id="l21.10"> Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+</span>
<a href="#l21.14"></a><span id="l21.14"> const kStorageServiceContractID = &quot;@mozilla.org/storage/service;1&quot;;</span>
<a href="#l21.15"></a><span id="l21.15"> const kStorageServiceIID = Components.interfaces.mozIStorageService;</span>
<a href="#l21.16"></a><span id="l21.16"> </span>
<a href="#l21.17"></a><span id="l21.17"> const kCalICalendar = Components.interfaces.calICalendar;</span>
<a href="#l21.18"></a><span id="l21.18"> </span>
<a href="#l21.19"></a><span id="l21.19"> const kCalAttendeeContractID = &quot;@mozilla.org/calendar/attendee;1&quot;;</span>
<a href="#l21.20"></a><span id="l21.20"> const kCalIAttendee = Components.interfaces.calIAttendee;</span>
<a href="#l21.21"></a><span id="l21.21"> var CalAttendee;</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineat">@@ -1728,48 +1730,56 @@ calStorageCalendar.prototype = {</span>
<a href="#l21.23"></a><span id="l21.23">             item.status = row.ical_status;</span>
<a href="#l21.24"></a><span id="l21.24"> </span>
<a href="#l21.25"></a><span id="l21.25">         if (row.alarm_time) {</span>
<a href="#l21.26"></a><span id="l21.26">             // Old (schema version 4) data, need to convert this nicely to the</span>
<a href="#l21.27"></a><span id="l21.27">             // new alarm interface.  Eventually, we're going to want to be able</span>
<a href="#l21.28"></a><span id="l21.28">             // to deal with both types of data in a calIAlarm interface, but</span>
<a href="#l21.29"></a><span id="l21.29">             // not yet.  Leaving this column around though may help ease that</span>
<a href="#l21.30"></a><span id="l21.30">             // transition in the future.</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-            var alarmTime = newDateTime(row.alarm_time, row.alarm_time_tz);</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-            var time;</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineminus">-            var related = Components.interfaces.calIItemBase.ALARM_RELATED_START;</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineplus">+            let alarmTime = newDateTime(row.alarm_time, row.alarm_time_tz);</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineplus">+            let time;</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineplus">+            let related = Components.interfaces.calIAlarm.ALARM_RELATED_START;</span>
<a href="#l21.37"></a><span id="l21.37">             if (isEvent(item)) {</span>
<a href="#l21.38"></a><span id="l21.38">                 time = newDateTime(row.event_start, row.event_start_tz);</span>
<a href="#l21.39"></a><span id="l21.39">             } else { //tasks</span>
<a href="#l21.40"></a><span id="l21.40">                 if (row.todo_entry) {</span>
<a href="#l21.41"></a><span id="l21.41">                     time = newDateTime(row.todo_entry, row.todo_entry_tz);</span>
<a href="#l21.42"></a><span id="l21.42">                 } else if (row.todo_due) {</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineminus">-                    related = Components.interfaces.calIItemBase.ALARM_RELATED_END;</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineplus">+                    related = Components.interfaces.calIAlarm.ALARM_RELATED_END;</span>
<a href="#l21.45"></a><span id="l21.45">                     time = newDateTime(row.todo_due, row.todo_due_tz);</span>
<a href="#l21.46"></a><span id="l21.46">                 }</span>
<a href="#l21.47"></a><span id="l21.47">             }</span>
<a href="#l21.48"></a><span id="l21.48">             if (time) {</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineminus">-                var duration = alarmTime.subtractDate(time);</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineminus">-                item.alarmOffset = duration;</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineminus">-                item.alarmRelated = related;</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineplus">+                // TODO ALARMSUPPORT for now just convert this to a relative</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineplus">+                // alarm. Will change when supporting multiple alarms.</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineplus">+                item.clearAlarms();</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineplus">+                let alarm = cal.createAlarm();</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineplus">+                let duration = alarmTime.subtractDate(time);</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineplus">+                alarm.related = related;</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineplus">+                alarm.offset = duration;</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineplus">+                item.addAlarm(alarm);</span>
<a href="#l21.60"></a><span id="l21.60">             } else {</span>
<a href="#l21.61"></a><span id="l21.61">                 Components.utils.reportError(&quot;WARNING! Couldn't do alarm conversion for item:&quot;+</span>
<a href="#l21.62"></a><span id="l21.62">                                              item.title+','+item.id+&quot;!\n&quot;);</span>
<a href="#l21.63"></a><span id="l21.63">             }</span>
<a href="#l21.64"></a><span id="l21.64">         }</span>
<a href="#l21.65"></a><span id="l21.65"> </span>
<a href="#l21.66"></a><span id="l21.66">         // Alarm offset could be 0, but this is ok, so compare with null</span>
<a href="#l21.67"></a><span id="l21.67">         if (row.alarm_offset != null) {</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineminus">-            var duration = Components.classes[&quot;@mozilla.org/calendar/duration;1&quot;]</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineminus">-                                     .createInstance(Components.interfaces.calIDuration);</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineplus">+            let duration = cal.createDuration(); </span>
<a href="#l21.71"></a><span id="l21.71">             duration.inSeconds = row.alarm_offset;</span>
<a href="#l21.72"></a><span id="l21.72">             duration.normalize();</span>
<a href="#l21.73"></a><span id="l21.73"> </span>
<a href="#l21.74"></a><span id="l21.74" class="difflineminus">-            item.alarmOffset = duration;</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineminus">-            item.alarmRelated = row.alarm_related;</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineplus">+            // TODO ALARMSUPPORT for now just use the one relative alarm. Will</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineplus">+            // change when supporting multiple alarms.</span>
<a href="#l21.78"></a><span id="l21.78" class="difflineplus">+            item.clearAlarms();</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineplus">+            let alarm = cal.createAlarm();</span>
<a href="#l21.80"></a><span id="l21.80" class="difflineplus">+            alarm.related = row.alarm_related + 1;</span>
<a href="#l21.81"></a><span id="l21.81" class="difflineplus">+            alarm.offset = duration;</span>
<a href="#l21.82"></a><span id="l21.82">         }</span>
<a href="#l21.83"></a><span id="l21.83">         if (row.alarm_last_ack) {</span>
<a href="#l21.84"></a><span id="l21.84">             // alarm acks are always in utc</span>
<a href="#l21.85"></a><span id="l21.85">             item.alarmLastAck = newDateTime(row.alarm_last_ack, &quot;UTC&quot;);</span>
<a href="#l21.86"></a><span id="l21.86">         }</span>
<a href="#l21.87"></a><span id="l21.87"> </span>
<a href="#l21.88"></a><span id="l21.88">         if (row.recurrence_id)</span>
<a href="#l21.89"></a><span id="l21.89">             item.recurrenceId = newDateTime(row.recurrence_id, row.recurrence_id_tz);</span>
<a href="#l21.90"></a><span id="l21.90" class="difflineat">@@ -2369,19 +2379,23 @@ calStorageCalendar.prototype = {</span>
<a href="#l21.91"></a><span id="l21.91">         if ((tmp = item.getProperty(&quot;LAST-MODIFIED&quot;)))</span>
<a href="#l21.92"></a><span id="l21.92">             ip.last_modified = tmp.nativeTime;</span>
<a href="#l21.93"></a><span id="l21.93"> </span>
<a href="#l21.94"></a><span id="l21.94">         ip.title = item.getProperty(&quot;SUMMARY&quot;);</span>
<a href="#l21.95"></a><span id="l21.95">         ip.priority = item.getProperty(&quot;PRIORITY&quot;);</span>
<a href="#l21.96"></a><span id="l21.96">         ip.privacy = item.getProperty(&quot;CLASS&quot;);</span>
<a href="#l21.97"></a><span id="l21.97">         ip.ical_status = item.getProperty(&quot;STATUS&quot;);</span>
<a href="#l21.98"></a><span id="l21.98"> </span>
<a href="#l21.99"></a><span id="l21.99" class="difflineminus">-        if (item.alarmOffset) {</span>
<a href="#l21.100"></a><span id="l21.100" class="difflineminus">-            ip.alarm_offset = item.alarmOffset.inSeconds;</span>
<a href="#l21.101"></a><span id="l21.101" class="difflineminus">-            ip.alarm_related = item.alarmRelated;</span>
<a href="#l21.102"></a><span id="l21.102" class="difflineplus">+        // TODO ALARMSUPPORT for now, just use the first relative alarm. This</span>
<a href="#l21.103"></a><span id="l21.103" class="difflineplus">+        // will change when supporting multiple alarms.</span>
<a href="#l21.104"></a><span id="l21.104" class="difflineplus">+        let alarms = item.getAlarms({})</span>
<a href="#l21.105"></a><span id="l21.105" class="difflineplus">+                         .filter(function(x) x.related != x.ALARM_RELATED_ABSOLUTE);</span>
<a href="#l21.106"></a><span id="l21.106" class="difflineplus">+        if (alarms.length) {</span>
<a href="#l21.107"></a><span id="l21.107" class="difflineplus">+            ip.alarm_offset = alarms[0].offset.inSeconds;</span>
<a href="#l21.108"></a><span id="l21.108" class="difflineplus">+            ip.alarm_related = alarms[0].related - 1;</span>
<a href="#l21.109"></a><span id="l21.109">         }</span>
<a href="#l21.110"></a><span id="l21.110">         if (item.alarmLastAck) {</span>
<a href="#l21.111"></a><span id="l21.111">             ip.alarm_last_ack = item.alarmLastAck.nativeTime;</span>
<a href="#l21.112"></a><span id="l21.112">         }</span>
<a href="#l21.113"></a><span id="l21.113">     },</span>
<a href="#l21.114"></a><span id="l21.114"> </span>
<a href="#l21.115"></a><span id="l21.115">     writeAttendees: function (item, olditem) {</span>
<a href="#l21.116"></a><span id="l21.116">         var attendees = item.getAttendees({});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapCalendarItems.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapCalendarItems.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -175,30 +175,37 @@ calWcapCalendar.prototype.encodeRecurren</span>
<a href="#l22.4"></a><span id="l22.4">     // rchange=1: expand recurrences,</span>
<a href="#l22.5"></a><span id="l22.5">     // or whether to replace the rrule, ambiguous documentation!!!</span>
<a href="#l22.6"></a><span id="l22.6">     // check with store(with no uid) upon adoptItem() which behaves strange</span>
<a href="#l22.7"></a><span id="l22.7">     // if rchange=0 is set!</span>
<a href="#l22.8"></a><span id="l22.8"> };</span>
<a href="#l22.9"></a><span id="l22.9"> </span>
<a href="#l22.10"></a><span id="l22.10"> calWcapCalendar.prototype.getAlarmParams =</span>
<a href="#l22.11"></a><span id="l22.11"> function calWcapCalendar_getAlarmParams(item) {</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-    var params = null;</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-    var alarmStart = item.alarmOffset;</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">-    if (alarmStart) {</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineminus">-        if (item.alarmRelated == calIItemBase.ALARM_RELATED_END) {</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+    let params = null;</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineplus">+    // TODO ALARMSUPPORT This will change as soon as email alarms are supported</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+    // by the UI.</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineplus">+    let alarms = item.getAlarms({})</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineplus">+                     .filter(function(x) x.related != x.ALARM_RELATED_ABSOLUTE);</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineplus">+    let alarm = alarms[0];</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineplus">+    // END TODO ALARMSUPPORT</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineplus">+</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineplus">+    if (alarm &amp;&amp; alarm.offset) {</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineplus">+        let alarmStart = alarm.offset;</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineplus">+        if (alarm.related == alarm.ALARM_RELATED_END) {</span>
<a href="#l22.27"></a><span id="l22.27">             // cs does not support explicit RELATED=END when</span>
<a href="#l22.28"></a><span id="l22.28">             // both start|entry and end|due are written</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineminus">-            var dur = item.duration;</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineplus">+            let dur = item.duration;</span>
<a href="#l22.31"></a><span id="l22.31">             if (dur) { // both given</span>
<a href="#l22.32"></a><span id="l22.32">                 alarmStart = alarmStart.clone();</span>
<a href="#l22.33"></a><span id="l22.33">                 alarmStart.addDuration(dur);</span>
<a href="#l22.34"></a><span id="l22.34">             } // else only end|due is set, alarm makes little sense though</span>
<a href="#l22.35"></a><span id="l22.35">         }</span>
<a href="#l22.36"></a><span id="l22.36">         </span>
<a href="#l22.37"></a><span id="l22.37" class="difflineminus">-        var emails = &quot;&quot;;</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineplus">+        let emails = &quot;&quot;;</span>
<a href="#l22.39"></a><span id="l22.39">         if (item.hasProperty(&quot;alarmEmailAddress&quot;)) {</span>
<a href="#l22.40"></a><span id="l22.40">             emails = encodeURIComponent(item.getProperty(&quot;alarmEmailAddress&quot;));</span>
<a href="#l22.41"></a><span id="l22.41">         } else {</span>
<a href="#l22.42"></a><span id="l22.42">             emails = this.session.getDefaultAlarmEmails({}).map(encodeURIComponent).join(&quot;;&quot;);</span>
<a href="#l22.43"></a><span id="l22.43">         }</span>
<a href="#l22.44"></a><span id="l22.44">         if (emails.length &gt; 0) {</span>
<a href="#l22.45"></a><span id="l22.45">             params = (&quot;&amp;alarmStart=&quot; + alarmStart.icalString);</span>
<a href="#l22.46"></a><span id="l22.46">             params += (&quot;&amp;alarmEmails=&quot; + emails);</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineat">@@ -365,17 +372,17 @@ function calWcapCalendar_storeItem(bAddI</span>
<a href="#l22.48"></a><span id="l22.48">             }</span>
<a href="#l22.49"></a><span id="l22.49">         } else { // calITodo</span>
<a href="#l22.50"></a><span id="l22.50">             // xxx todo: dtstart is mandatory for cs, so if this is</span>
<a href="#l22.51"></a><span id="l22.51">             //           undefined, assume an allDay todo???</span>
<a href="#l22.52"></a><span id="l22.52">             var dtstart = item.entryDate;</span>
<a href="#l22.53"></a><span id="l22.53">             var dtend = item.dueDate;</span>
<a href="#l22.54"></a><span id="l22.54"> </span>
<a href="#l22.55"></a><span id="l22.55">             // cs bug: enforce DUE (set to DTSTART) if alarm is set</span>
<a href="#l22.56"></a><span id="l22.56" class="difflineminus">-            if (!dtend &amp;&amp; item.alarmOffset) {</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineplus">+            if (!dtend &amp;&amp; item.getAlarms({}).length) {</span>
<a href="#l22.58"></a><span id="l22.58">                 dtend = dtstart;</span>
<a href="#l22.59"></a><span id="l22.59">             }</span>
<a href="#l22.60"></a><span id="l22.60"> </span>
<a href="#l22.61"></a><span id="l22.61">             bIsAllDay = (dtstart &amp;&amp; dtstart.isDate);</span>
<a href="#l22.62"></a><span id="l22.62">             if (!oldItem || !identicalDatetimes(dtstart, oldItem.entryDate)</span>
<a href="#l22.63"></a><span id="l22.63">                          || !identicalDatetimes(dtend, oldItem.dueDate)) {</span>
<a href="#l22.64"></a><span id="l22.64">                 params += (&quot;&amp;dtstart=&quot; + getIcalUTC(dtstart)); // timezone will be set with tzid param</span>
<a href="#l22.65"></a><span id="l22.65">                 params += (&quot;&amp;due=&quot; + getIcalUTC(dtend)); // timezone will be set with tzid param</span>
<a href="#l22.66"></a><span id="l22.66" class="difflineat">@@ -639,27 +646,27 @@ function calWcapCalendar_storeItem(bAddI</span>
<a href="#l22.67"></a><span id="l22.67"> </span>
<a href="#l22.68"></a><span id="l22.68"> calWcapCalendar.prototype.tunnelXProps =</span>
<a href="#l22.69"></a><span id="l22.69"> function calWcapCalendar_tunnelXProps(destItem, srcItem) {</span>
<a href="#l22.70"></a><span id="l22.70">     // xxx todo: temp workaround for bug in calItemBase.js</span>
<a href="#l22.71"></a><span id="l22.71">     if (!isParent(srcItem)) {</span>
<a href="#l22.72"></a><span id="l22.72">         return;</span>
<a href="#l22.73"></a><span id="l22.73">     }</span>
<a href="#l22.74"></a><span id="l22.74">     // tunnel alarm X-MOZ-SNOOZE only if alarm is still set:</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineminus">-    var alarmOffset = destItem.alarmOffset;</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineminus">-    var enumerator = srcItem.propertyEnumerator;</span>
<a href="#l22.77"></a><span id="l22.77" class="difflineplus">+    let hasAlarms = destItem.getAlarms({}).length;</span>
<a href="#l22.78"></a><span id="l22.78" class="difflineplus">+    let enumerator = srcItem.propertyEnumerator;</span>
<a href="#l22.79"></a><span id="l22.79">     while (enumerator.hasMoreElements()) {</span>
<a href="#l22.80"></a><span id="l22.80">         try {</span>
<a href="#l22.81"></a><span id="l22.81">             var prop = enumerator.getNext().QueryInterface(Components.interfaces.nsIProperty);</span>
<a href="#l22.82"></a><span id="l22.82">             var name = prop.name;</span>
<a href="#l22.83"></a><span id="l22.83">             if (name.indexOf(&quot;X-MOZ-&quot;) == 0) {</span>
<a href="#l22.84"></a><span id="l22.84">                 switch (name) {</span>
<a href="#l22.85"></a><span id="l22.85">                     // keep snooze stamps for occurrences only and if alarm is still set:</span>
<a href="#l22.86"></a><span id="l22.86">                     case &quot;X-MOZ-SNOOZE-TIME&quot;:</span>
<a href="#l22.87"></a><span id="l22.87" class="difflineminus">-                        if (!alarmOffset) {</span>
<a href="#l22.88"></a><span id="l22.88" class="difflineplus">+                        if (!hasAlarms) {</span>
<a href="#l22.89"></a><span id="l22.89">                             break; // alarm has been reset</span>
<a href="#l22.90"></a><span id="l22.90">                         }</span>
<a href="#l22.91"></a><span id="l22.91">                         // fallthru intended</span>
<a href="#l22.92"></a><span id="l22.92">                     default:</span>
<a href="#l22.93"></a><span id="l22.93">                         if (LOG_LEVEL &gt; 1) {</span>
<a href="#l22.94"></a><span id="l22.94">                             log(&quot;tunneling &quot; + name + &quot;=&quot; + prop.value, this);</span>
<a href="#l22.95"></a><span id="l22.95">                         }</span>
<a href="#l22.96"></a><span id="l22.96">                         destItem.setProperty(name, prop.value);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/calendar/test/unit/head_consts.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/calendar/test/unit/head_consts.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -132,17 +132,16 @@ function getStorageCal() {</span>
<a href="#l23.4"></a><span id="l23.4"> </span>
<a href="#l23.5"></a><span id="l23.5"> /**</span>
<a href="#l23.6"></a><span id="l23.6">  * Return an item property as string.</span>
<a href="#l23.7"></a><span id="l23.7">  * @param aItem</span>
<a href="#l23.8"></a><span id="l23.8">  * @param string aProp possible item properties: start, end, duration,</span>
<a href="#l23.9"></a><span id="l23.9">  *                     generation, title,</span>
<a href="#l23.10"></a><span id="l23.10">  *                     id, calendar, creationDate, lastModifiedTime,</span>
<a href="#l23.11"></a><span id="l23.11">  *                     stampTime, priority, privacy, status,</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">- *                     alarmOffset, alarmRelated,</span>
<a href="#l23.13"></a><span id="l23.13">  *                     alarmLastAck, recurrenceStartDate</span>
<a href="#l23.14"></a><span id="l23.14">  *                     and any property that can be obtained using getProperty()</span>
<a href="#l23.15"></a><span id="l23.15">  */</span>
<a href="#l23.16"></a><span id="l23.16"> function getProps(aItem, aProp) {</span>
<a href="#l23.17"></a><span id="l23.17">     var value = null;</span>
<a href="#l23.18"></a><span id="l23.18">     switch (aProp) {</span>
<a href="#l23.19"></a><span id="l23.19">         case &quot;start&quot;:</span>
<a href="#l23.20"></a><span id="l23.20">             value = aItem.startDate || aItem.entryDate || null;</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineat">@@ -178,22 +177,16 @@ function getProps(aItem, aProp) {</span>
<a href="#l23.22"></a><span id="l23.22">             value = aItem.priority;</span>
<a href="#l23.23"></a><span id="l23.23">             break;</span>
<a href="#l23.24"></a><span id="l23.24">         case &quot;privacy&quot;:</span>
<a href="#l23.25"></a><span id="l23.25">             value = aItem.privacy;</span>
<a href="#l23.26"></a><span id="l23.26">             break;</span>
<a href="#l23.27"></a><span id="l23.27">         case &quot;status&quot;:</span>
<a href="#l23.28"></a><span id="l23.28">             value = aItem.status;</span>
<a href="#l23.29"></a><span id="l23.29">             break;</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineminus">-        case &quot;alarmOffset&quot;:</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">-            value = aItem.alarmOffset;</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineminus">-            break;</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineminus">-        case &quot;alarmRelated&quot;:</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineminus">-            value = aItem.alarmRelated;</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineminus">-            break;</span>
<a href="#l23.36"></a><span id="l23.36">         case &quot;alarmLastAck&quot;:</span>
<a href="#l23.37"></a><span id="l23.37">             value = aItem.alarmLastAck;</span>
<a href="#l23.38"></a><span id="l23.38">             break;</span>
<a href="#l23.39"></a><span id="l23.39">         case &quot;recurrenceStartDate&quot;:</span>
<a href="#l23.40"></a><span id="l23.40">             value = aItem.recurrenceStartDate;</span>
<a href="#l23.41"></a><span id="l23.41">             break;</span>
<a href="#l23.42"></a><span id="l23.42">         default:</span>
<a href="#l23.43"></a><span id="l23.43">             value = aItem.getProperty(aProp);</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineat">@@ -206,17 +199,17 @@ function getProps(aItem, aProp) {</span>
<a href="#l23.45"></a><span id="l23.45"> }</span>
<a href="#l23.46"></a><span id="l23.46"> </span>
<a href="#l23.47"></a><span id="l23.47"> function compareItemsSpecific(aLeftItem, aRightItem, aPropArray) {</span>
<a href="#l23.48"></a><span id="l23.48">     if (!aPropArray) {</span>
<a href="#l23.49"></a><span id="l23.49">         // left out:  &quot;id&quot;, &quot;calendar&quot;, &quot;lastModifiedTime&quot;, &quot;generation&quot;,</span>
<a href="#l23.50"></a><span id="l23.50">         // &quot;stampTime&quot; as these are expected to change</span>
<a href="#l23.51"></a><span id="l23.51">         aPropArray = [&quot;start&quot;, &quot;end&quot;, &quot;duration&quot;,</span>
<a href="#l23.52"></a><span id="l23.52">                       &quot;title&quot;, &quot;priority&quot;, &quot;privacy&quot;, &quot;creationDate&quot;,</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineminus">-                      &quot;status&quot;, &quot;alarmOffset&quot;, &quot;alarmRelated&quot;, &quot;alarmLastAck&quot;,</span>
<a href="#l23.54"></a><span id="l23.54" class="difflineplus">+                      &quot;status&quot;, &quot;alarmLastAck&quot;,</span>
<a href="#l23.55"></a><span id="l23.55">                       &quot;recurrenceStartDate&quot;];</span>
<a href="#l23.56"></a><span id="l23.56">     }</span>
<a href="#l23.57"></a><span id="l23.57">     for (var i = 0; i &lt; aPropArray.length; i++) {</span>
<a href="#l23.58"></a><span id="l23.58">         do_check_eq(getProps(aLeftItem, aPropArray[i]),</span>
<a href="#l23.59"></a><span id="l23.59">                     getProps(aRightItem,</span>
<a href="#l23.60"></a><span id="l23.60">                     aPropArray[i]));</span>
<a href="#l23.61"></a><span id="l23.61">     }</span>
<a href="#l23.62"></a><span id="l23.62"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/calendar/test/unit/test_alarm.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/calendar/test/unit/test_alarm.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -47,34 +47,34 @@ function run_test() {</span>
<a href="#l24.4"></a><span id="l24.4">     test_dates();</span>
<a href="#l24.5"></a><span id="l24.5"> </span>
<a href="#l24.6"></a><span id="l24.6">     test_clone();</span>
<a href="#l24.7"></a><span id="l24.7">     test_immutable();</span>
<a href="#l24.8"></a><span id="l24.8"> }</span>
<a href="#l24.9"></a><span id="l24.9"> </span>
<a href="#l24.10"></a><span id="l24.10"> function test_initial_creation() {</span>
<a href="#l24.11"></a><span id="l24.11">     dump(&quot;Testing initial creation...&quot;);</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-    alarm = createAlarm();</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+    alarm = cal.createAlarm();</span>
<a href="#l24.14"></a><span id="l24.14"> </span>
<a href="#l24.15"></a><span id="l24.15">     let passed;</span>
<a href="#l24.16"></a><span id="l24.16">     try {</span>
<a href="#l24.17"></a><span id="l24.17">         alarm.icalString;</span>
<a href="#l24.18"></a><span id="l24.18">         passed = false;</span>
<a href="#l24.19"></a><span id="l24.19">     } catch (e) {</span>
<a href="#l24.20"></a><span id="l24.20">         passed = true;</span>
<a href="#l24.21"></a><span id="l24.21">     }</span>
<a href="#l24.22"></a><span id="l24.22">     if (!passed) {</span>
<a href="#l24.23"></a><span id="l24.23">         do_throw(&quot;Fresh calIAlarm should not produce a valid icalString&quot;);</span>
<a href="#l24.24"></a><span id="l24.24">     }</span>
<a href="#l24.25"></a><span id="l24.25">     dump(&quot;Done\n&quot;);</span>
<a href="#l24.26"></a><span id="l24.26"> }</span>
<a href="#l24.27"></a><span id="l24.27"> </span>
<a href="#l24.28"></a><span id="l24.28"> function test_display_alarm() {</span>
<a href="#l24.29"></a><span id="l24.29">     dump(&quot;Testing DISPLAY alarms...&quot;);</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineminus">-    let alarm = createAlarm();</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineplus">+    let alarm = cal.createAlarm();</span>
<a href="#l24.32"></a><span id="l24.32">     // Set ACTION to DISPLAY, make sure this was not rejected</span>
<a href="#l24.33"></a><span id="l24.33">     alarm.action = &quot;DISPLAY&quot;;</span>
<a href="#l24.34"></a><span id="l24.34">     do_check_eq(alarm.action, &quot;DISPLAY&quot;);</span>
<a href="#l24.35"></a><span id="l24.35"> </span>
<a href="#l24.36"></a><span id="l24.36">     // Set a Description, REQUIRED for ACTION:DISPLAY</span>
<a href="#l24.37"></a><span id="l24.37">     alarm.description = &quot;test&quot;;</span>
<a href="#l24.38"></a><span id="l24.38">     do_check_eq(alarm.description, &quot;test&quot;);</span>
<a href="#l24.39"></a><span id="l24.39"> </span>
<a href="#l24.40"></a><span id="l24.40" class="difflineat">@@ -83,17 +83,17 @@ function test_display_alarm() {</span>
<a href="#l24.41"></a><span id="l24.41">     do_check_eq(alarm.summary, null);</span>
<a href="#l24.42"></a><span id="l24.42"> </span>
<a href="#l24.43"></a><span id="l24.43">     // TODO No attendees</span>
<a href="#l24.44"></a><span id="l24.44">     dump(&quot;Done\n&quot;);</span>
<a href="#l24.45"></a><span id="l24.45"> }</span>
<a href="#l24.46"></a><span id="l24.46"> </span>
<a href="#l24.47"></a><span id="l24.47"> function test_email_alarm() {</span>
<a href="#l24.48"></a><span id="l24.48">     dump(&quot;Testing EMAIL alarms...&quot;);</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineminus">-    let alarm = createAlarm();</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineplus">+    let alarm = cal.createAlarm();</span>
<a href="#l24.51"></a><span id="l24.51">     // Set ACTION to DISPLAY, make sure this was not rejected</span>
<a href="#l24.52"></a><span id="l24.52">     alarm.action = &quot;EMAIL&quot;;</span>
<a href="#l24.53"></a><span id="l24.53">     do_check_eq(alarm.action, &quot;EMAIL&quot;);</span>
<a href="#l24.54"></a><span id="l24.54"> </span>
<a href="#l24.55"></a><span id="l24.55">     // Set a Description, REQUIRED for ACTION:EMAIL</span>
<a href="#l24.56"></a><span id="l24.56">     alarm.description = &quot;description&quot;;</span>
<a href="#l24.57"></a><span id="l24.57">     do_check_eq(alarm.description, &quot;description&quot;);</span>
<a href="#l24.58"></a><span id="l24.58"> </span>
<a href="#l24.59"></a><span id="l24.59" class="difflineat">@@ -104,17 +104,17 @@ function test_email_alarm() {</span>
<a href="#l24.60"></a><span id="l24.60">     // TODO check for at least one attendee</span>
<a href="#l24.61"></a><span id="l24.61"> </span>
<a href="#l24.62"></a><span id="l24.62">     // TODO test attachments</span>
<a href="#l24.63"></a><span id="l24.63">     dump(&quot;Done\n&quot;);</span>
<a href="#l24.64"></a><span id="l24.64"> }</span>
<a href="#l24.65"></a><span id="l24.65"> </span>
<a href="#l24.66"></a><span id="l24.66"> function test_audio_alarm() {</span>
<a href="#l24.67"></a><span id="l24.67">     dump(&quot;Testing AUDIO alarms...&quot;);</span>
<a href="#l24.68"></a><span id="l24.68" class="difflineminus">-    let alarm = createAlarm();</span>
<a href="#l24.69"></a><span id="l24.69" class="difflineplus">+    let alarm = cal.createAlarm();</span>
<a href="#l24.70"></a><span id="l24.70">     // Set ACTION to AUDIO, make sure this was not rejected</span>
<a href="#l24.71"></a><span id="l24.71">     alarm.action = &quot;AUDIO&quot;;</span>
<a href="#l24.72"></a><span id="l24.72">     do_check_eq(alarm.action, &quot;AUDIO&quot;);</span>
<a href="#l24.73"></a><span id="l24.73"> </span>
<a href="#l24.74"></a><span id="l24.74">     // No Description for ACTION:AUDIO</span>
<a href="#l24.75"></a><span id="l24.75">     alarm.description = &quot;description&quot;;</span>
<a href="#l24.76"></a><span id="l24.76">     do_check_eq(alarm.description, null);</span>
<a href="#l24.77"></a><span id="l24.77"> </span>
<a href="#l24.78"></a><span id="l24.78" class="difflineat">@@ -124,17 +124,17 @@ function test_audio_alarm() {</span>
<a href="#l24.79"></a><span id="l24.79"> </span>
<a href="#l24.80"></a><span id="l24.80">     // TODO No attendees</span>
<a href="#l24.81"></a><span id="l24.81">     // TODO test for one attachment</span>
<a href="#l24.82"></a><span id="l24.82">     dump(&quot;Done\n&quot;);</span>
<a href="#l24.83"></a><span id="l24.83"> }</span>
<a href="#l24.84"></a><span id="l24.84"> </span>
<a href="#l24.85"></a><span id="l24.85"> function test_custom_alarm() {</span>
<a href="#l24.86"></a><span id="l24.86">     dump(&quot;Testing X-SMS (custom) alarms...&quot;);</span>
<a href="#l24.87"></a><span id="l24.87" class="difflineminus">-    let alarm = createAlarm();</span>
<a href="#l24.88"></a><span id="l24.88" class="difflineplus">+    let alarm = cal.createAlarm();</span>
<a href="#l24.89"></a><span id="l24.89">     // Set ACTION to a custom value, make sure this was not rejected</span>
<a href="#l24.90"></a><span id="l24.90">     alarm.action = &quot;X-SMS&quot;</span>
<a href="#l24.91"></a><span id="l24.91">     do_check_eq(alarm.action, &quot;X-SMS&quot;);</span>
<a href="#l24.92"></a><span id="l24.92"> </span>
<a href="#l24.93"></a><span id="l24.93">     // There is no restriction on DESCRIPTION for custom alarms</span>
<a href="#l24.94"></a><span id="l24.94">     alarm.description = &quot;description&quot;;</span>
<a href="#l24.95"></a><span id="l24.95">     do_check_eq(alarm.description, &quot;description&quot;);</span>
<a href="#l24.96"></a><span id="l24.96"> </span>
<a href="#l24.97"></a><span id="l24.97" class="difflineat">@@ -146,17 +146,17 @@ function test_custom_alarm() {</span>
<a href="#l24.98"></a><span id="l24.98">     // TODO test for attachments</span>
<a href="#l24.99"></a><span id="l24.99">     dump(&quot;Done\n&quot;);</span>
<a href="#l24.100"></a><span id="l24.100"> }</span>
<a href="#l24.101"></a><span id="l24.101"> </span>
<a href="#l24.102"></a><span id="l24.102"> // Check if any combination of REPEAT and DURATION work as expected.</span>
<a href="#l24.103"></a><span id="l24.103"> function test_repeat() {</span>
<a href="#l24.104"></a><span id="l24.104">     dump(&quot;Testing REPEAT and DURATION properties...&quot;);</span>
<a href="#l24.105"></a><span id="l24.105">     let message;</span>
<a href="#l24.106"></a><span id="l24.106" class="difflineminus">-    let alarm = createAlarm();</span>
<a href="#l24.107"></a><span id="l24.107" class="difflineplus">+    let alarm = cal.createAlarm();</span>
<a href="#l24.108"></a><span id="l24.108"> </span>
<a href="#l24.109"></a><span id="l24.109">     // Check initial value</span>
<a href="#l24.110"></a><span id="l24.110">     do_check_eq(alarm.repeat, 0);</span>
<a href="#l24.111"></a><span id="l24.111">     do_check_eq(alarm.repeatOffset, null);</span>
<a href="#l24.112"></a><span id="l24.112">     do_check_eq(alarm.repeatDate, null);</span>
<a href="#l24.113"></a><span id="l24.113"> </span>
<a href="#l24.114"></a><span id="l24.114">     // Should not be able to get REPEAT when DURATION is not set</span>
<a href="#l24.115"></a><span id="l24.115">     alarm.repeat = 1;</span>
<a href="#l24.116"></a><span id="l24.116" class="difflineat">@@ -181,31 +181,31 @@ function test_repeat() {</span>
<a href="#l24.117"></a><span id="l24.117">     // Check final value</span>
<a href="#l24.118"></a><span id="l24.118">     do_check_eq(alarm.repeat, 0);</span>
<a href="#l24.119"></a><span id="l24.119">     do_check_eq(alarm.repeatOffset, null);</span>
<a href="#l24.120"></a><span id="l24.120">     dump(&quot;Done\n&quot;);</span>
<a href="#l24.121"></a><span id="l24.121"> }</span>
<a href="#l24.122"></a><span id="l24.122"> </span>
<a href="#l24.123"></a><span id="l24.123"> function test_xprop() {</span>
<a href="#l24.124"></a><span id="l24.124">     dump(&quot;Testing X-Props...&quot;);</span>
<a href="#l24.125"></a><span id="l24.125" class="difflineminus">-    let alarm = createAlarm();</span>
<a href="#l24.126"></a><span id="l24.126" class="difflineplus">+    let alarm = cal.createAlarm();</span>
<a href="#l24.127"></a><span id="l24.127">     alarm.setProperty(&quot;X-PROP&quot;, &quot;X-VALUE&quot;);</span>
<a href="#l24.128"></a><span id="l24.128">     do_check_true(alarm.hasProperty(&quot;X-PROP&quot;));</span>
<a href="#l24.129"></a><span id="l24.129">     do_check_eq(alarm.getProperty(&quot;X-PROP&quot;), &quot;X-VALUE&quot;);</span>
<a href="#l24.130"></a><span id="l24.130">     alarm.deleteProperty(&quot;X-PROP&quot;);</span>
<a href="#l24.131"></a><span id="l24.131">     do_check_false(alarm.hasProperty(&quot;X-PROP&quot;));</span>
<a href="#l24.132"></a><span id="l24.132">     do_check_eq(alarm.getProperty(&quot;X-PROP&quot;), null);</span>
<a href="#l24.133"></a><span id="l24.133">     dump(&quot;Done\n&quot;);</span>
<a href="#l24.134"></a><span id="l24.134"> }</span>
<a href="#l24.135"></a><span id="l24.135"> </span>
<a href="#l24.136"></a><span id="l24.136"> function test_dates() {</span>
<a href="#l24.137"></a><span id="l24.137">     dump(&quot;Testing alarm dates...&quot;);</span>
<a href="#l24.138"></a><span id="l24.138">     let passed;</span>
<a href="#l24.139"></a><span id="l24.139">     // Initial value</span>
<a href="#l24.140"></a><span id="l24.140" class="difflineminus">-    let alarm = createAlarm();</span>
<a href="#l24.141"></a><span id="l24.141" class="difflineplus">+    let alarm = cal.createAlarm();</span>
<a href="#l24.142"></a><span id="l24.142">     do_check_eq(alarm.alarmDate, null);</span>
<a href="#l24.143"></a><span id="l24.143">     do_check_eq(alarm.offset, null);</span>
<a href="#l24.144"></a><span id="l24.144"> </span>
<a href="#l24.145"></a><span id="l24.145">     // Set an offset and check it</span>
<a href="#l24.146"></a><span id="l24.146">     alarm.related = Ci.calIAlarm.ALARM_RELATED_START</span>
<a href="#l24.147"></a><span id="l24.147">     let offset = createDuration(&quot;-PT5M&quot;);</span>
<a href="#l24.148"></a><span id="l24.148">     alarm.offset = offset;</span>
<a href="#l24.149"></a><span id="l24.149">     do_check_eq(alarm.alarmDate, null);</span>
<a href="#l24.150"></a><span id="l24.150" class="difflineat">@@ -297,17 +297,17 @@ function test_immutable() {</span>
<a href="#l24.151"></a><span id="l24.151">     if (!passed) {</span>
<a href="#l24.152"></a><span id="l24.152">         do_throw(&quot;setProperty succeeded while item was immutable&quot;);</span>
<a href="#l24.153"></a><span id="l24.153">     }</span>
<a href="#l24.154"></a><span id="l24.154">     dump(&quot;Done\n&quot;);</span>
<a href="#l24.155"></a><span id="l24.155"> }</span>
<a href="#l24.156"></a><span id="l24.156"> </span>
<a href="#l24.157"></a><span id="l24.157"> function test_clone() {</span>
<a href="#l24.158"></a><span id="l24.158">     dump(&quot;Testing cloning alarms...&quot;);</span>
<a href="#l24.159"></a><span id="l24.159" class="difflineminus">-    let alarm = createAlarm();</span>
<a href="#l24.160"></a><span id="l24.160" class="difflineplus">+    let alarm = cal.createAlarm();</span>
<a href="#l24.161"></a><span id="l24.161">     // Set up each attribute</span>
<a href="#l24.162"></a><span id="l24.162">     for (let prop in propMap) {</span>
<a href="#l24.163"></a><span id="l24.163">         alarm[prop] = propMap[prop];</span>
<a href="#l24.164"></a><span id="l24.164">     }</span>
<a href="#l24.165"></a><span id="l24.165">     // Make a copy</span>
<a href="#l24.166"></a><span id="l24.166">     let newAlarm = alarm.clone();</span>
<a href="#l24.167"></a><span id="l24.167">     newAlarm.makeImmutable();</span>
<a href="#l24.168"></a><span id="l24.168">     newAlarm = newAlarm.clone();</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

