<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 23964:96fab4a2b81189101231b12106823748c9a70a94</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 96fab4a2b81189101231b12106823748c9a70a94" />
<meta property="og:url" content="/comm-central/rev/96fab4a2b81189101231b12106823748c9a70a94" />
<meta property="og:description" content="Bug 1419417 - Parse HTML to make sure that tags and attributes are properly closed. r=mkmelin,jorgk" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 96fab4a2b81189101231b12106823748c9a70a94 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/96fab4a2b81189101231b12106823748c9a70a94">shortlog</a> |
<a href="/comm-central/log/96fab4a2b81189101231b12106823748c9a70a94">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/96fab4a2b81189101231b12106823748c9a70a94">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/96fab4a2b81189101231b12106823748c9a70a94">files</a> |
changeset |
<a href="/comm-central/raw-rev/96fab4a2b81189101231b12106823748c9a70a94">raw</a>  | <a href="/comm-central/archive/96fab4a2b81189101231b12106823748c9a70a94.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1419417">Bug 1419417</a> - Parse HTML to make sure that tags and attributes are properly closed. r=mkmelin,jorgk
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#66;&#101;&#110;&#32;&#66;&#117;&#99;&#107;&#115;&#99;&#104;&#32;&#60;&#98;&#101;&#110;&#46;&#98;&#117;&#99;&#107;&#115;&#99;&#104;&#64;&#98;&#101;&#111;&#110;&#101;&#120;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 21 May 2018 18:44:41 +0200</td></tr>

<tr>
 <td>changeset 23964</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/96fab4a2b81189101231b12106823748c9a70a94">96fab4a2b81189101231b12106823748c9a70a94</a></td>
</tr>



<tr>
<td>parent 23963</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/148c2d27abc3daa72f3cb3c3e2f8404e2f018f48">148c2d27abc3daa72f3cb3c3e2f8404e2f018f48</a>
</td>
</tr>

<tr>
<td>child 23965</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a2472fbf9a2c07e95419cfefa1eb5dd3cd396d88">a2472fbf9a2c07e95419cfefa1eb5dd3cd396d88</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=96fab4a2b81189101231b12106823748c9a70a94">14450</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 21 May 2018 16:57:08 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@d16fff497d40 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=d16fff497d408a3ece7f9eb58874e8151bec70c5">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=d16fff497d408a3ece7f9eb58874e8151bec70c5&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d16fff497d408a3ece7f9eb58874e8151bec70c5&newProject=comm-central&newRevision=96fab4a2b81189101231b12106823748c9a70a94&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d16fff497d408a3ece7f9eb58874e8151bec70c5&newProject=comm-central&newRevision=96fab4a2b81189101231b12106823748c9a70a94&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d16fff497d408a3ece7f9eb58874e8151bec70c5&newProject=comm-central&newRevision=96fab4a2b81189101231b12106823748c9a70a94&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a>, <a href="/comm-central/log?rev=reviewer%28jorgk%29&revcount=50">jorgk</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1419417">1419417</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1419417">Bug 1419417</a> - Parse HTML to make sure that tags and attributes are properly closed. r=mkmelin,jorgk

This fixes the efail &lt;http://efail.de&gt; security bug, which opens a HTML
tag or attribute in an HTML MIME part, then puts in a PGP-encrypted part,
and then another HTML part with the closing quote or tag. This could be
e.g. &lt;img src=' or &lt;form&gt;&lt;textarea&gt;, CSS URL or similar features that send
out the following text as URL and therefore leak it to the attacker who
crafted the email. The PGP part will then be decrypted and leak.

The bug was that we just passed HTML through verbatim. The frontend does
not have any further precautions, either.

The correct solution here is to jail each MIME part into a separate
&lt;iframe type=&quot;content&quot;&gt; in the UI. However, we don't want one scrollbar
for each MIME part, but one scroll for the entire body. &lt;iframe seamless&gt;
would allow that, but it was never implemented in Firefox and is now dead.
We might later find a workaround, but this is more work and can't be done
short term.

The fix here in libmime first parses the HTML that we get in the
HTML MIME part, and then immediately serialized it again. That ensures
that the HTML document is complete, syntactically correct, and all
tags and attributes are properly closed, before we start with the next
MIME part.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/96fab4a2b81189101231b12106823748c9a70a94/mailnews/mime/src/mimeTextHTMLParsed.cpp">mailnews/mime/src/mimeTextHTMLParsed.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96fab4a2b81189101231b12106823748c9a70a94/mailnews/mime/src/mimeTextHTMLParsed.cpp">file</a> |
<a href="/comm-central/annotate/96fab4a2b81189101231b12106823748c9a70a94/mailnews/mime/src/mimeTextHTMLParsed.cpp">annotate</a> |
<a href="/comm-central/diff/96fab4a2b81189101231b12106823748c9a70a94/mailnews/mime/src/mimeTextHTMLParsed.cpp">diff</a> |
<a href="/comm-central/comparison/96fab4a2b81189101231b12106823748c9a70a94/mailnews/mime/src/mimeTextHTMLParsed.cpp">comparison</a> |
<a href="/comm-central/log/96fab4a2b81189101231b12106823748c9a70a94/mailnews/mime/src/mimeTextHTMLParsed.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/96fab4a2b81189101231b12106823748c9a70a94/mailnews/mime/src/mimeTextHTMLParsed.h">mailnews/mime/src/mimeTextHTMLParsed.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96fab4a2b81189101231b12106823748c9a70a94/mailnews/mime/src/mimeTextHTMLParsed.h">file</a> |
<a href="/comm-central/annotate/96fab4a2b81189101231b12106823748c9a70a94/mailnews/mime/src/mimeTextHTMLParsed.h">annotate</a> |
<a href="/comm-central/diff/96fab4a2b81189101231b12106823748c9a70a94/mailnews/mime/src/mimeTextHTMLParsed.h">diff</a> |
<a href="/comm-central/comparison/96fab4a2b81189101231b12106823748c9a70a94/mailnews/mime/src/mimeTextHTMLParsed.h">comparison</a> |
<a href="/comm-central/log/96fab4a2b81189101231b12106823748c9a70a94/mailnews/mime/src/mimeTextHTMLParsed.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/96fab4a2b81189101231b12106823748c9a70a94/mailnews/mime/src/mimei.cpp">mailnews/mime/src/mimei.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96fab4a2b81189101231b12106823748c9a70a94/mailnews/mime/src/mimei.cpp">file</a> |
<a href="/comm-central/annotate/96fab4a2b81189101231b12106823748c9a70a94/mailnews/mime/src/mimei.cpp">annotate</a> |
<a href="/comm-central/diff/96fab4a2b81189101231b12106823748c9a70a94/mailnews/mime/src/mimei.cpp">diff</a> |
<a href="/comm-central/comparison/96fab4a2b81189101231b12106823748c9a70a94/mailnews/mime/src/mimei.cpp">comparison</a> |
<a href="/comm-central/log/96fab4a2b81189101231b12106823748c9a70a94/mailnews/mime/src/mimei.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/96fab4a2b81189101231b12106823748c9a70a94/mailnews/mime/src/mimei.h">mailnews/mime/src/mimei.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96fab4a2b81189101231b12106823748c9a70a94/mailnews/mime/src/mimei.h">file</a> |
<a href="/comm-central/annotate/96fab4a2b81189101231b12106823748c9a70a94/mailnews/mime/src/mimei.h">annotate</a> |
<a href="/comm-central/diff/96fab4a2b81189101231b12106823748c9a70a94/mailnews/mime/src/mimei.h">diff</a> |
<a href="/comm-central/comparison/96fab4a2b81189101231b12106823748c9a70a94/mailnews/mime/src/mimei.h">comparison</a> |
<a href="/comm-central/log/96fab4a2b81189101231b12106823748c9a70a94/mailnews/mime/src/mimei.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/96fab4a2b81189101231b12106823748c9a70a94/mailnews/mime/src/moz.build">mailnews/mime/src/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/96fab4a2b81189101231b12106823748c9a70a94/mailnews/mime/src/moz.build">file</a> |
<a href="/comm-central/annotate/96fab4a2b81189101231b12106823748c9a70a94/mailnews/mime/src/moz.build">annotate</a> |
<a href="/comm-central/diff/96fab4a2b81189101231b12106823748c9a70a94/mailnews/mime/src/moz.build">diff</a> |
<a href="/comm-central/comparison/96fab4a2b81189101231b12106823748c9a70a94/mailnews/mime/src/moz.build">comparison</a> |
<a href="/comm-central/log/96fab4a2b81189101231b12106823748c9a70a94/mailnews/mime/src/moz.build">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1">new file mode 100644</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineminus">--- /dev/null</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineplus">+++ b/mailnews/mime/src/mimeTextHTMLParsed.cpp</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineat">@@ -0,0 +1,169 @@</span>
<a href="#l1.5"></a><span id="l1.5" class="difflineplus">+/* -*- Mode: C; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.7"></a><span id="l1.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.8"></a><span id="l1.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineplus">+</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineplus">+/* Most of this code is copied from mimethsa. If you find a bug here, check that class, too. */</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineplus">+</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+/* This runs the entire HTML document through the Mozilla HTML parser, and</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+   then outputs it as string again. This ensures that the HTML document is</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+   syntactically correct and complete and all tags and attributes are closed.</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+   That prevents &quot;MIME in the middle&quot; attacks like efail.de.</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+   The base problem is that we concatenate different MIME parts in the output</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+   and render them all together as a single HTML document in the display.</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+   The better solution would be to put each MIME part into its own &lt;iframe type=&quot;content&quot;&gt;.</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+   during rendering. Unfortunately, we'd need &lt;iframe seamless&gt; for that.</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+   That would remove the need for this workaround, and stop even more attack classes.</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+*/</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+#include &quot;mimeTextHTMLParsed.h&quot;</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+#include &quot;prmem.h&quot;</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+#include &quot;prlog.h&quot;</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+#include &quot;msgCore.h&quot;</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+#include &quot;mozilla/dom/DOMParser.h&quot;</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+#include &quot;nsIDocument.h&quot;</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+#include &quot;nsIDocumentEncoder.h&quot;</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+#include &quot;mozilla/ErrorResult.h&quot;</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+#include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+#define MIME_SUPERCLASS mimeInlineTextHTMLClass</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+MimeDefClass(MimeInlineTextHTMLParsed, MimeInlineTextHTMLParsedClass,</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+             mimeInlineTextHTMLParsedClass, &amp;MIME_SUPERCLASS);</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+static int MimeInlineTextHTMLParsed_parse_line(const char *, int32_t,</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+                                               MimeObject *);</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+static int MimeInlineTextHTMLParsed_parse_begin(MimeObject *obj);</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+static int MimeInlineTextHTMLParsed_parse_eof(MimeObject *, bool);</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+static void MimeInlineTextHTMLParsed_finalize(MimeObject *obj);</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+static int</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+MimeInlineTextHTMLParsedClassInitialize(MimeInlineTextHTMLParsedClass *clazz)</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+{</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+  MimeObjectClass *oclass = (MimeObjectClass *)clazz;</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+  NS_ASSERTION(!oclass-&gt;class_initialized, &quot;problem with superclass&quot;);</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+  oclass-&gt;parse_line  = MimeInlineTextHTMLParsed_parse_line;</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+  oclass-&gt;parse_begin = MimeInlineTextHTMLParsed_parse_begin;</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+  oclass-&gt;parse_eof   = MimeInlineTextHTMLParsed_parse_eof;</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+  oclass-&gt;finalize    = MimeInlineTextHTMLParsed_finalize;</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+  return 0;</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+}</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+static int</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+MimeInlineTextHTMLParsed_parse_begin(MimeObject *obj)</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+{</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+  MimeInlineTextHTMLParsed *me = (MimeInlineTextHTMLParsed *)obj;</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+  me-&gt;complete_buffer = new nsString();</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+  int status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+  if (status &lt; 0)</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+    return status;</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+  // Dump the charset we get from the mime headers into a HTML &lt;meta http-equiv&gt;.</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+  char *content_type = obj-&gt;headers ?</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+    MimeHeaders_get(obj-&gt;headers, HEADER_CONTENT_TYPE, false, false) : 0;</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+  if (content_type)</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+  {</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+    char* charset = MimeHeaders_get_parameter(content_type,</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+                                              HEADER_PARM_CHARSET,</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+                                              NULL, NULL);</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+    PR_Free(content_type);</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+    if (charset)</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+    {</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+      nsAutoCString charsetline(</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+        &quot;\n&lt;meta http-equiv=\&quot;content-type\&quot; content=\&quot;text/html; charset=&quot;);</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+      charsetline += charset;</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+      charsetline += &quot;\&quot;&gt;\n&quot;;</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+      int status = MimeObject_write(obj,</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+                                    charsetline.get(),</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+                                    charsetline.Length(),</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+                                    true);</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+      PR_Free(charset);</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+      if (status &lt; 0)</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+        return status;</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+    }</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+  }</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+  return 0;</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+}</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineplus">+static int</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineplus">+MimeInlineTextHTMLParsed_parse_eof(MimeObject *obj, bool abort_p)</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineplus">+{</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineplus">+</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+  if (obj-&gt;closed_p)</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+    return 0;</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+  int status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+  if (status &lt; 0)</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+    return status;</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+  MimeInlineTextHTMLParsed *me = (MimeInlineTextHTMLParsed *)obj;</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineplus">+  // We have to cache all lines and parse the whole document at once.</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineplus">+  // There's a useful sounding function parseFromStream(), but it only allows XML</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+  // mimetypes, not HTML. Methinks that's because the HTML soup parser</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+  // needs the entire doc to make sense of the gibberish that people write.</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+  if (!me || !me-&gt;complete_buffer)</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+    return 0;</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineplus">+  nsString&amp; rawHTML = *(me-&gt;complete_buffer);</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+  nsString parsed;</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+  nsresult rv;</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+  // Parse the HTML source.</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineplus">+  mozilla::ErrorResult rv2;</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+  RefPtr&lt;mozilla::dom::DOMParser&gt; parser =</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+    mozilla::dom::DOMParser::CreateWithoutGlobal(rv2);</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+  nsCOMPtr&lt;nsIDocument&gt; document = parser-&gt;ParseFromString(</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineplus">+    rawHTML, mozilla::dom::SupportedType::Text_html, rv2);</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+  if (rv2.Failed())</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+    return -1;</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineplus">+  // Serialize it back to HTML source again.</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+  nsCOMPtr&lt;nsIDocumentEncoder&gt; encoder = do_CreateInstance(</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+    &quot;@mozilla.org/layout/documentEncoder;1?type=text/html&quot;);</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineplus">+  uint32_t aFlags = 0;</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+  rv = encoder-&gt;Init(document, NS_LITERAL_STRING(&quot;text/html&quot;), aFlags);</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineplus">+  rv = encoder-&gt;EncodeToString(parsed);</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineplus">+</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineplus">+  // Write it out.</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineplus">+  NS_ConvertUTF16toUTF8 resultCStr(parsed);</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineplus">+  status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_line(</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineplus">+    resultCStr.BeginWriting(), resultCStr.Length(), obj);</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineplus">+  rawHTML.Truncate();</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+  return status;</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineplus">+}</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineplus">+</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+void</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+MimeInlineTextHTMLParsed_finalize(MimeObject *obj)</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+{</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineplus">+  MimeInlineTextHTMLParsed *me = (MimeInlineTextHTMLParsed *)obj;</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineplus">+</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+  if (me &amp;&amp; me-&gt;complete_buffer)</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+  {</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+    obj-&gt;clazz-&gt;parse_eof(obj, false);</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+    delete me-&gt;complete_buffer;</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineplus">+    me-&gt;complete_buffer = NULL;</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineplus">+  }</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineplus">+</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineplus">+  ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;finalize(obj);</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineplus">+}</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineplus">+</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineplus">+static int</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+MimeInlineTextHTMLParsed_parse_line(const char *line, int32_t length,</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+                                    MimeObject *obj)</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+{</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+  MimeInlineTextHTMLParsed *me = (MimeInlineTextHTMLParsed *)obj;</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineplus">+</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineplus">+  if (!me || !(me-&gt;complete_buffer))</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineplus">+    return -1;</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineplus">+  nsCString linestr(line, length);</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineplus">+  NS_ConvertUTF8toUTF16 line_ucs2(linestr.get());</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineplus">+  if (length &amp;&amp; line_ucs2.IsEmpty())</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineplus">+    CopyASCIItoUTF16(linestr, line_ucs2);</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineplus">+  (me-&gt;complete_buffer)-&gt;Append(line_ucs2);</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineplus">+</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineplus">+  return 0;</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/mailnews/mime/src/mimeTextHTMLParsed.h</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,28 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+/* -*- Mode: C; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+#ifndef _MIMETEXTHTMLPARSED_H_</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+#define _MIMETEXTHTMLPARSED_H_</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+#include &quot;mimethtm.h&quot;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+typedef struct MimeInlineTextHTMLParsedClass MimeInlineTextHTMLParsedClass;</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+typedef struct MimeInlineTextHTMLParsed      MimeInlineTextHTMLParsed;</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+struct MimeInlineTextHTMLParsedClass {</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+  MimeInlineTextHTMLClass html;</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+};</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+extern MimeInlineTextHTMLParsedClass mimeInlineTextHTMLParsedClass;</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+struct MimeInlineTextHTMLParsed {</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+  MimeInlineTextHTML    html;</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+  nsString             *complete_buffer;  // Gecko parser expects wide strings</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+};</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+#define MimeInlineTextHTMLParsedClassInitializer(ITYPE,CSUPER) \</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+  { MimeInlineTextHTMLClassInitializer(ITYPE,CSUPER) }</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+#endif /* _MIMETEXTHTMLPARSED_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/mime/src/mimei.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/mime/src/mimei.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -34,16 +34,17 @@</span>
<a href="#l3.4"></a><span id="l3.4"> #include &quot;mimeunty.h&quot;  /*   |     |--- MimeUntypedText            */</span>
<a href="#l3.5"></a><span id="l3.5"> #include &quot;mimeleaf.h&quot;  /*   |--- MimeLeaf (abstract)            */</span>
<a href="#l3.6"></a><span id="l3.6"> #include &quot;mimetext.h&quot;  /*   |     |--- MimeInlineText (abstract)      */</span>
<a href="#l3.7"></a><span id="l3.7"> #include &quot;mimetpla.h&quot;  /*   |     |     |--- MimeInlineTextPlain      */</span>
<a href="#l3.8"></a><span id="l3.8"> #include &quot;mimethpl.h&quot;  /*   |     |     |     |--- M.I.TextHTMLAsPlaintext */</span>
<a href="#l3.9"></a><span id="l3.9"> #include &quot;mimetpfl.h&quot;   /*   |     |     |--- MimeInlineTextPlainFlowed     */</span>
<a href="#l3.10"></a><span id="l3.10"> #include &quot;mimethtm.h&quot;  /*   |     |     |--- MimeInlineTextHTML      */</span>
<a href="#l3.11"></a><span id="l3.11"> #include &quot;mimethsa.h&quot;  /*   |     |     |     |--- M.I.TextHTMLSanitized   */</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+#include &quot;mimeTextHTMLParsed.h&quot; /*|     |     |--- M.I.TextHTMLParsed   */</span>
<a href="#l3.13"></a><span id="l3.13"> #include &quot;mimetric.h&quot;  /*   |     |     |--- MimeInlineTextRichtext    */</span>
<a href="#l3.14"></a><span id="l3.14"> #include &quot;mimetenr.h&quot;  /*   |     |     |     |--- MimeInlineTextEnriched  */</span>
<a href="#l3.15"></a><span id="l3.15"> /* SUPPORTED VIA PLUGIN      |     |     |--- MimeInlineTextVCard           */</span>
<a href="#l3.16"></a><span id="l3.16"> #include &quot;mimeiimg.h&quot;  /*   |     |--- MimeInlineImage            */</span>
<a href="#l3.17"></a><span id="l3.17"> #include &quot;mimeeobj.h&quot;  /*   |     |--- MimeExternalObject          */</span>
<a href="#l3.18"></a><span id="l3.18"> #include &quot;mimeebod.h&quot;  /*   |--- MimeExternalBody              */</span>
<a href="#l3.19"></a><span id="l3.19">                         /* If you add classes here,also add them to mimei.h */</span>
<a href="#l3.20"></a><span id="l3.20"> #include &quot;prlog.h&quot;</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineat">@@ -322,17 +323,17 @@ bool mime_is_allowed_class(const MimeObj</span>
<a href="#l3.22"></a><span id="l3.22">       );</span>
<a href="#l3.23"></a><span id="l3.23"> </span>
<a href="#l3.24"></a><span id="l3.24">   /* Contrairy to above, the below code is a &quot;blacklist&quot;, i.e. it</span>
<a href="#l3.25"></a><span id="l3.25">      *excludes* some &quot;bad&quot; classes. */</span>
<a href="#l3.26"></a><span id="l3.26">   return</span>
<a href="#l3.27"></a><span id="l3.27">      !(</span>
<a href="#l3.28"></a><span id="l3.28">         (avoid_html</span>
<a href="#l3.29"></a><span id="l3.29">          &amp;&amp; (</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-              clazz == (MimeObjectClass *)&amp;mimeInlineTextHTMLClass</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+              clazz == (MimeObjectClass *)&amp;mimeInlineTextHTMLParsedClass</span>
<a href="#l3.32"></a><span id="l3.32">                          /* Should not happen - we protect against that in</span>
<a href="#l3.33"></a><span id="l3.33">                             mime_find_class(). Still for safety... */</span>
<a href="#l3.34"></a><span id="l3.34">             )) ||</span>
<a href="#l3.35"></a><span id="l3.35">         (avoid_images</span>
<a href="#l3.36"></a><span id="l3.36">          &amp;&amp; (</span>
<a href="#l3.37"></a><span id="l3.37">               clazz == (MimeObjectClass *)&amp;mimeInlineImageClass</span>
<a href="#l3.38"></a><span id="l3.38">             )) ||</span>
<a href="#l3.39"></a><span id="l3.39">         (avoid_strange_content</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineat">@@ -503,21 +504,21 @@ mime_find_class (const char *content_typ</span>
<a href="#l3.41"></a><span id="l3.41">     else if (!PL_strncasecmp(content_type,      &quot;text/&quot;, 5))</span>
<a href="#l3.42"></a><span id="l3.42">     {</span>
<a href="#l3.43"></a><span id="l3.43">       if      (!PL_strcasecmp(content_type+5,    &quot;html&quot;))</span>
<a href="#l3.44"></a><span id="l3.44">       {</span>
<a href="#l3.45"></a><span id="l3.45">         if (opts</span>
<a href="#l3.46"></a><span id="l3.46">             &amp;&amp; opts-&gt;format_out == nsMimeOutput::nsMimeMessageSaveAs)</span>
<a href="#l3.47"></a><span id="l3.47">           // SaveAs in new modes doesn't work yet.</span>
<a href="#l3.48"></a><span id="l3.48">         {</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-          clazz = (MimeObjectClass *)&amp;mimeInlineTextHTMLClass;</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+          clazz = (MimeObjectClass *)&amp;mimeInlineTextHTMLParsedClass;</span>
<a href="#l3.51"></a><span id="l3.51">           types_of_classes_to_disallow = 0;</span>
<a href="#l3.52"></a><span id="l3.52">         }</span>
<a href="#l3.53"></a><span id="l3.53">         else if (html_as == 0 || html_as == 4) // Render sender's HTML</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-          clazz = (MimeObjectClass *)&amp;mimeInlineTextHTMLClass;</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+          clazz = (MimeObjectClass *)&amp;mimeInlineTextHTMLParsedClass;</span>
<a href="#l3.56"></a><span id="l3.56">         else if (html_as == 1) // convert HTML to plaintext</span>
<a href="#l3.57"></a><span id="l3.57">           // Do a HTML-&gt;TXT-&gt;HTML conversion, see mimethpl.h.</span>
<a href="#l3.58"></a><span id="l3.58">           clazz = (MimeObjectClass *)&amp;mimeInlineTextHTMLAsPlaintextClass;</span>
<a href="#l3.59"></a><span id="l3.59">         else if (html_as == 2) // display HTML source</span>
<a href="#l3.60"></a><span id="l3.60">           /* This is for the freaks. Treat HTML as plaintext,</span>
<a href="#l3.61"></a><span id="l3.61">              which will cause the HTML source to be displayed.</span>
<a href="#l3.62"></a><span id="l3.62">              Not very user-friendly, but some seem to want this. */</span>
<a href="#l3.63"></a><span id="l3.63">           clazz = (MimeObjectClass *)&amp;mimeInlineTextPlainClass;</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineat">@@ -909,32 +910,30 @@ mime_create (const char *content_type, M</span>
<a href="#l3.65"></a><span id="l3.65">                  ? MimeHeaders_get(hdrs, HEADER_CONTENT_DISPOSITION, true, false)</span>
<a href="#l3.66"></a><span id="l3.66">                  : 0);</span>
<a href="#l3.67"></a><span id="l3.67">   }</span>
<a href="#l3.68"></a><span id="l3.68"> </span>
<a href="#l3.69"></a><span id="l3.69">   if (!content_disposition || !PL_strcasecmp(content_disposition, &quot;inline&quot;))</span>
<a href="#l3.70"></a><span id="l3.70">     ;  /* Use the class we've got. */</span>
<a href="#l3.71"></a><span id="l3.71">   else</span>
<a href="#l3.72"></a><span id="l3.72">   {</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-    //</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-    // rhp: Ok, this is a modification to try to deal with messages</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-    //      that have content disposition set to &quot;attachment&quot; even though</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-    //      we probably should show them inline.</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-    //</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-    if (  (clazz != (MimeObjectClass *)&amp;mimeInlineTextHTMLClass) &amp;&amp;</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-          (clazz != (MimeObjectClass *)&amp;mimeInlineTextClass) &amp;&amp;</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+    // override messages that have content disposition set to &quot;attachment&quot;</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+    // even though we probably should show them inline.</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+    if (  (clazz != (MimeObjectClass *)&amp;mimeInlineTextClass) &amp;&amp;</span>
<a href="#l3.83"></a><span id="l3.83">           (clazz != (MimeObjectClass *)&amp;mimeInlineTextPlainClass) &amp;&amp;</span>
<a href="#l3.84"></a><span id="l3.84">           (clazz != (MimeObjectClass *)&amp;mimeInlineTextPlainFlowedClass) &amp;&amp;</span>
<a href="#l3.85"></a><span id="l3.85">           (clazz != (MimeObjectClass *)&amp;mimeInlineTextHTMLClass) &amp;&amp;</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+          (clazz != (MimeObjectClass *)&amp;mimeInlineTextHTMLParsedClass) &amp;&amp;</span>
<a href="#l3.87"></a><span id="l3.87">           (clazz != (MimeObjectClass *)&amp;mimeInlineTextHTMLSanitizedClass) &amp;&amp;</span>
<a href="#l3.88"></a><span id="l3.88">           (clazz != (MimeObjectClass *)&amp;mimeInlineTextHTMLAsPlaintextClass) &amp;&amp;</span>
<a href="#l3.89"></a><span id="l3.89">           (clazz != (MimeObjectClass *)&amp;mimeInlineTextRichtextClass) &amp;&amp;</span>
<a href="#l3.90"></a><span id="l3.90">           (clazz != (MimeObjectClass *)&amp;mimeInlineTextEnrichedClass) &amp;&amp;</span>
<a href="#l3.91"></a><span id="l3.91">           (clazz != (MimeObjectClass *)&amp;mimeMessageClass) &amp;&amp;</span>
<a href="#l3.92"></a><span id="l3.92">           (clazz != (MimeObjectClass *)&amp;mimeInlineImageClass) )</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+      // not a special inline type, so show as attachment</span>
<a href="#l3.94"></a><span id="l3.94">       clazz = (MimeObjectClass *)&amp;mimeExternalObjectClass;</span>
<a href="#l3.95"></a><span id="l3.95">   }</span>
<a href="#l3.96"></a><span id="l3.96"> </span>
<a href="#l3.97"></a><span id="l3.97">   /* If the option `Show Attachments Inline' is off, now would be the time to change our mind... */</span>
<a href="#l3.98"></a><span id="l3.98">   /* Also, if we're doing a reply (i.e. quoting the body), then treat that according to preference. */</span>
<a href="#l3.99"></a><span id="l3.99">   if (opts &amp;&amp; ((!opts-&gt;show_attachment_inline_p &amp;&amp; !forceInline) ||</span>
<a href="#l3.100"></a><span id="l3.100">                (!opts-&gt;quote_attachment_inline_p &amp;&amp;</span>
<a href="#l3.101"></a><span id="l3.101">                 (opts-&gt;format_out == nsMimeOutput::nsMimeMessageQuoting ||</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/mime/src/mimei.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/mime/src/mimei.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -66,16 +66,18 @@</span>
<a href="#l4.4"></a><span id="l4.4">       |     |     +--- MimeInlineTextPlain</span>
<a href="#l4.5"></a><span id="l4.5">       |     |     |     |</span>
<a href="#l4.6"></a><span id="l4.6">       |     |     |     \--- MimeInlineTextHTMLAsPlaintext</span>
<a href="#l4.7"></a><span id="l4.7">       |     |     |</span>
<a href="#l4.8"></a><span id="l4.8">       |     |     +--- MimeInlineTextPlainFlowed</span>
<a href="#l4.9"></a><span id="l4.9">       |     |     |</span>
<a href="#l4.10"></a><span id="l4.10">       |     |     +--- MimeInlineTextHTML</span>
<a href="#l4.11"></a><span id="l4.11">       |     |     |     |</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+      |     |     |     +--- MimeInlineTextHTMLParsed</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+      |     |     |     |</span>
<a href="#l4.14"></a><span id="l4.14">       |     |     |     \--- MimeInlineTextHTMLSanitized</span>
<a href="#l4.15"></a><span id="l4.15">       |     |     |</span>
<a href="#l4.16"></a><span id="l4.16">       |     |     +--- MimeInlineTextRichtext</span>
<a href="#l4.17"></a><span id="l4.17">       |     |     |     |</span>
<a href="#l4.18"></a><span id="l4.18">       |     |     |     \--- MimeInlineTextEnriched</span>
<a href="#l4.19"></a><span id="l4.19">       |     |    |</span>
<a href="#l4.20"></a><span id="l4.20">       |     |    +--- MimeInlineTextVCard</span>
<a href="#l4.21"></a><span id="l4.21">       |     |</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/mime/src/moz.build</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/mime/src/moz.build</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -50,16 +50,17 @@ SOURCES += [</span>
<a href="#l5.4"></a><span id="l5.4">     'mimemsg.cpp',</span>
<a href="#l5.5"></a><span id="l5.5">     'mimemsig.cpp',</span>
<a href="#l5.6"></a><span id="l5.6">     'mimemult.cpp',</span>
<a href="#l5.7"></a><span id="l5.7">     'mimeobj.cpp',</span>
<a href="#l5.8"></a><span id="l5.8">     'mimepbuf.cpp',</span>
<a href="#l5.9"></a><span id="l5.9">     'mimesun.cpp',</span>
<a href="#l5.10"></a><span id="l5.10">     'mimetenr.cpp',</span>
<a href="#l5.11"></a><span id="l5.11">     'mimetext.cpp',</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+    'mimeTextHTMLParsed.cpp',</span>
<a href="#l5.13"></a><span id="l5.13">     'mimethpl.cpp',</span>
<a href="#l5.14"></a><span id="l5.14">     'mimethsa.cpp',</span>
<a href="#l5.15"></a><span id="l5.15">     'mimethtm.cpp',</span>
<a href="#l5.16"></a><span id="l5.16">     'mimetpfl.cpp',</span>
<a href="#l5.17"></a><span id="l5.17">     'mimetpla.cpp',</span>
<a href="#l5.18"></a><span id="l5.18">     'mimetric.cpp',</span>
<a href="#l5.19"></a><span id="l5.19">     'mimeunty.cpp',</span>
<a href="#l5.20"></a><span id="l5.20">     'nsCMS.cpp',</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

