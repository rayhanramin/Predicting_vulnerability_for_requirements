<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 24946:20ab2d2a45b10f321dd12987349df4c97c7171c7</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 20ab2d2a45b10f321dd12987349df4c97c7171c7" />
<meta property="og:url" content="/comm-central/rev/20ab2d2a45b10f321dd12987349df4c97c7171c7" />
<meta property="og:description" content="Bug 1491593 [mozmill] fix and enhance shared-module calendar-utils &quot;setData()&quot;-Function. r=darktrojan" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 20ab2d2a45b10f321dd12987349df4c97c7171c7 &#x2620;
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/20ab2d2a45b10f321dd12987349df4c97c7171c7">shortlog</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/20ab2d2a45b10f321dd12987349df4c97c7171c7">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7">files</a> |
changeset |
<a href="/comm-central/raw-rev/20ab2d2a45b10f321dd12987349df4c97c7171c7">raw</a>  | <a href="/comm-central/archive/20ab2d2a45b10f321dd12987349df4c97c7171c7.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1491593">Bug 1491593</a> [mozmill] fix and enhance shared-module calendar-utils &quot;setData()&quot;-Function. r=darktrojan
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">
<tr><td colspan="2" style="background:#ff3333;"><strong>&#x2620;&#x2620; backed out by <a style="font-family: monospace" href="/comm-central/rev/78ca133d04d6">78ca133d04d6</a> &#x2620; &#x2620;</strong></td></tr>
<tr><td>author</td><td>&#77;&#97;&#114;&#107;&#117;&#115;&#32;&#65;&#100;&#114;&#97;&#114;&#105;&#111;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#97;&#100;&#114;&#97;&#114;&#105;&#111;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 13 Oct 2018 22:43:51 +0200</td></tr>

<tr>
 <td>changeset 24946</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/20ab2d2a45b10f321dd12987349df4c97c7171c7">20ab2d2a45b10f321dd12987349df4c97c7171c7</a></td>
</tr>



<tr>
<td>parent 24945</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7dbabf78da029efe0b7f5d723837e9ebd84d058d">7dbabf78da029efe0b7f5d723837e9ebd84d058d</a>
</td>
</tr>

<tr>
<td>child 24947</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/78ca133d04d61a08ddc78412ca75037011dcb03b">78ca133d04d61a08ddc78412ca75037011dcb03b</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=20ab2d2a45b10f321dd12987349df4c97c7171c7">15003</a></td></tr>
<tr><td>push user</td><td>Mozilla@Adrario.de</td></tr>
<tr><td>push date</td><td class="date age">Sat, 13 Oct 2018 20:50:26 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@20ab2d2a45b1 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=20ab2d2a45b10f321dd12987349df4c97c7171c7">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=20ab2d2a45b10f321dd12987349df4c97c7171c7&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=20ab2d2a45b10f321dd12987349df4c97c7171c7&newProject=comm-central&newRevision=20ab2d2a45b10f321dd12987349df4c97c7171c7&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=20ab2d2a45b10f321dd12987349df4c97c7171c7&newProject=comm-central&newRevision=20ab2d2a45b10f321dd12987349df4c97c7171c7&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=20ab2d2a45b10f321dd12987349df4c97c7171c7&newProject=comm-central&newRevision=20ab2d2a45b10f321dd12987349df4c97c7171c7&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28darktrojan%29&revcount=50">darktrojan</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1491593">1491593</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1491593">Bug 1491593</a> [mozmill] fix and enhance shared-module calendar-utils &quot;setData()&quot;-Function. r=darktrojan</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/.eslintrc.js">calendar/test/mozmill/.eslintrc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/.eslintrc.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/.eslintrc.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/.eslintrc.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/.eslintrc.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/.eslintrc.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testAnnualRecurrence.js">calendar/test/mozmill/cal-recurrence/testAnnualRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testAnnualRecurrence.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testAnnualRecurrence.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testAnnualRecurrence.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testAnnualRecurrence.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testAnnualRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testBiweeklyRecurrence.js">calendar/test/mozmill/cal-recurrence/testBiweeklyRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testBiweeklyRecurrence.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testBiweeklyRecurrence.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testBiweeklyRecurrence.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testBiweeklyRecurrence.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testBiweeklyRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testDailyRecurrence.js">calendar/test/mozmill/cal-recurrence/testDailyRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testDailyRecurrence.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testDailyRecurrence.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testDailyRecurrence.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testDailyRecurrence.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testDailyRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testLastDayOfMonthRecurrence.js">calendar/test/mozmill/cal-recurrence/testLastDayOfMonthRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testLastDayOfMonthRecurrence.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testLastDayOfMonthRecurrence.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testLastDayOfMonthRecurrence.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testLastDayOfMonthRecurrence.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testLastDayOfMonthRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testWeeklyNRecurrence.js">calendar/test/mozmill/cal-recurrence/testWeeklyNRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testWeeklyNRecurrence.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testWeeklyNRecurrence.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testWeeklyNRecurrence.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testWeeklyNRecurrence.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testWeeklyNRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testWeeklyUntilRecurrence.js">calendar/test/mozmill/cal-recurrence/testWeeklyUntilRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testWeeklyUntilRecurrence.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testWeeklyUntilRecurrence.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testWeeklyUntilRecurrence.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testWeeklyUntilRecurrence.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testWeeklyUntilRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testWeeklyWithExceptionRecurrence.js">calendar/test/mozmill/cal-recurrence/testWeeklyWithExceptionRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testWeeklyWithExceptionRecurrence.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testWeeklyWithExceptionRecurrence.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testWeeklyWithExceptionRecurrence.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testWeeklyWithExceptionRecurrence.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/cal-recurrence/testWeeklyWithExceptionRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/eventDialog/testEventDialog.js">calendar/test/mozmill/eventDialog/testEventDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/eventDialog/testEventDialog.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/eventDialog/testEventDialog.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/eventDialog/testEventDialog.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/eventDialog/testEventDialog.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/eventDialog/testEventDialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/eventDialog/testEventDialogModificationPrompt.js">calendar/test/mozmill/eventDialog/testEventDialogModificationPrompt.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/eventDialog/testEventDialogModificationPrompt.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/eventDialog/testEventDialogModificationPrompt.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/eventDialog/testEventDialogModificationPrompt.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/eventDialog/testEventDialogModificationPrompt.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/eventDialog/testEventDialogModificationPrompt.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/eventDialog/testEventDialogSize.js">calendar/test/mozmill/eventDialog/testEventDialogSize.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/eventDialog/testEventDialogSize.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/eventDialog/testEventDialogSize.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/eventDialog/testEventDialogSize.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/eventDialog/testEventDialogSize.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/eventDialog/testEventDialogSize.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/eventDialog/testUTF8.js">calendar/test/mozmill/eventDialog/testUTF8.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/eventDialog/testUTF8.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/eventDialog/testUTF8.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/eventDialog/testUTF8.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/eventDialog/testUTF8.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/eventDialog/testUTF8.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/invitations/test-imip-bar-eml.js">calendar/test/mozmill/invitations/test-imip-bar-eml.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/invitations/test-imip-bar-eml.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/invitations/test-imip-bar-eml.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/invitations/test-imip-bar-eml.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/invitations/test-imip-bar-eml.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/invitations/test-imip-bar-eml.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testAnnualRecurrence.js">calendar/test/mozmill/recurrenceRotated/testAnnualRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testAnnualRecurrence.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testAnnualRecurrence.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testAnnualRecurrence.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testAnnualRecurrence.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testAnnualRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testBiweeklyRecurrence.js">calendar/test/mozmill/recurrenceRotated/testBiweeklyRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testBiweeklyRecurrence.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testBiweeklyRecurrence.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testBiweeklyRecurrence.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testBiweeklyRecurrence.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testBiweeklyRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testDailyRecurrence.js">calendar/test/mozmill/recurrenceRotated/testDailyRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testDailyRecurrence.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testDailyRecurrence.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testDailyRecurrence.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testDailyRecurrence.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testDailyRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testLastDayOfMonthRecurrence.js">calendar/test/mozmill/recurrenceRotated/testLastDayOfMonthRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testLastDayOfMonthRecurrence.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testLastDayOfMonthRecurrence.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testLastDayOfMonthRecurrence.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testLastDayOfMonthRecurrence.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testLastDayOfMonthRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testWeeklyNRecurrence.js">calendar/test/mozmill/recurrenceRotated/testWeeklyNRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testWeeklyNRecurrence.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testWeeklyNRecurrence.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testWeeklyNRecurrence.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testWeeklyNRecurrence.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testWeeklyNRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testWeeklyUntilRecurrence.js">calendar/test/mozmill/recurrenceRotated/testWeeklyUntilRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testWeeklyUntilRecurrence.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testWeeklyUntilRecurrence.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testWeeklyUntilRecurrence.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testWeeklyUntilRecurrence.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testWeeklyUntilRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testWeeklyWithExceptionRecurrence.js">calendar/test/mozmill/recurrenceRotated/testWeeklyWithExceptionRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testWeeklyWithExceptionRecurrence.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testWeeklyWithExceptionRecurrence.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testWeeklyWithExceptionRecurrence.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testWeeklyWithExceptionRecurrence.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/recurrenceRotated/testWeeklyWithExceptionRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/shared-modules/test-calendar-utils.js">calendar/test/mozmill/shared-modules/test-calendar-utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/shared-modules/test-calendar-utils.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/shared-modules/test-calendar-utils.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/shared-modules/test-calendar-utils.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/shared-modules/test-calendar-utils.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/shared-modules/test-calendar-utils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/shared-modules/test-item-editing-helpers.js">calendar/test/mozmill/shared-modules/test-item-editing-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/shared-modules/test-item-editing-helpers.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/shared-modules/test-item-editing-helpers.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/shared-modules/test-item-editing-helpers.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/shared-modules/test-item-editing-helpers.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/shared-modules/test-item-editing-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/testAlarmDefaultValue.js">calendar/test/mozmill/testAlarmDefaultValue.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/testAlarmDefaultValue.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/testAlarmDefaultValue.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/testAlarmDefaultValue.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/testAlarmDefaultValue.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/testAlarmDefaultValue.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/testBasicFunctionality.js">calendar/test/mozmill/testBasicFunctionality.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/testBasicFunctionality.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/testBasicFunctionality.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/testBasicFunctionality.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/testBasicFunctionality.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/testBasicFunctionality.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/testLocalICS.js">calendar/test/mozmill/testLocalICS.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/testLocalICS.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/testLocalICS.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/testLocalICS.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/testLocalICS.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/testLocalICS.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/testTimezones.js">calendar/test/mozmill/testTimezones.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/testTimezones.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/testTimezones.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/testTimezones.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/testTimezones.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/testTimezones.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/testTodayPane.js">calendar/test/mozmill/testTodayPane.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/testTodayPane.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/testTodayPane.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/testTodayPane.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/testTodayPane.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/testTodayPane.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/views/testDayView.js">calendar/test/mozmill/views/testDayView.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/views/testDayView.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/views/testDayView.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/views/testDayView.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/views/testDayView.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/views/testDayView.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/views/testMonthView.js">calendar/test/mozmill/views/testMonthView.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/views/testMonthView.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/views/testMonthView.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/views/testMonthView.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/views/testMonthView.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/views/testMonthView.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/views/testMultiweekView.js">calendar/test/mozmill/views/testMultiweekView.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/views/testMultiweekView.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/views/testMultiweekView.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/views/testMultiweekView.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/views/testMultiweekView.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/views/testMultiweekView.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/views/testTaskView.js">calendar/test/mozmill/views/testTaskView.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/views/testTaskView.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/views/testTaskView.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/views/testTaskView.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/views/testTaskView.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/views/testTaskView.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/views/testWeekView.js">calendar/test/mozmill/views/testWeekView.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/views/testWeekView.js">file</a> |
<a href="/comm-central/annotate/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/views/testWeekView.js">annotate</a> |
<a href="/comm-central/diff/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/views/testWeekView.js">diff</a> |
<a href="/comm-central/comparison/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/views/testWeekView.js">comparison</a> |
<a href="/comm-central/log/20ab2d2a45b10f321dd12987349df4c97c7171c7/calendar/test/mozmill/views/testWeekView.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/test/mozmill/.eslintrc.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/test/mozmill/.eslintrc.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -14,16 +14,18 @@ module.exports = {</span>
<a href="#l1.4"></a><span id="l1.4">         persisted: true,</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6">         lookup: true,</span>
<a href="#l1.7"></a><span id="l1.7">         eid: true,</span>
<a href="#l1.8"></a><span id="l1.8">         xpath: true,</span>
<a href="#l1.9"></a><span id="l1.9">         sleep: true,</span>
<a href="#l1.10"></a><span id="l1.10">         getEventBoxPath: true,</span>
<a href="#l1.11"></a><span id="l1.11">         lookupEventBox: true,</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+        iframeLookup: true,</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+        getDateTimePicker: true,</span>
<a href="#l1.14"></a><span id="l1.14">     },</span>
<a href="#l1.15"></a><span id="l1.15">     rules: {</span>
<a href="#l1.16"></a><span id="l1.16">         // Allow mozmill test methods to be used without warning</span>
<a href="#l1.17"></a><span id="l1.17">         &quot;no-unused-vars&quot;: [2, {</span>
<a href="#l1.18"></a><span id="l1.18">             vars: &quot;all&quot;,</span>
<a href="#l1.19"></a><span id="l1.19">             args: &quot;none&quot;,</span>
<a href="#l1.20"></a><span id="l1.20">             varsIgnorePattern: &quot;(MODULE_NAME|MODULE_REQUIRES|RELATIVE_ROOT|setupModule|installInto|teardownTest|^test[A-Z_].*)&quot;</span>
<a href="#l1.21"></a><span id="l1.21">         }]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/test/mozmill/cal-recurrence/testAnnualRecurrence.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/test/mozmill/cal-recurrence/testAnnualRecurrence.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -23,73 +23,61 @@ function setupModule(module) {</span>
<a href="#l2.4"></a><span id="l2.4">         handleOccurrencePrompt,</span>
<a href="#l2.5"></a><span id="l2.5">         switchToView,</span>
<a href="#l2.6"></a><span id="l2.6">         goToDate,</span>
<a href="#l2.7"></a><span id="l2.7">         invokeEventDialog,</span>
<a href="#l2.8"></a><span id="l2.8">         deleteCalendars,</span>
<a href="#l2.9"></a><span id="l2.9">         createCalendar,</span>
<a href="#l2.10"></a><span id="l2.10">         menulistSelect</span>
<a href="#l2.11"></a><span id="l2.11">     } = collector.getModule(&quot;calendar-utils&quot;));</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    collector.getModule(&quot;calendar-utils&quot;).setupModule();</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    collector.getModule(&quot;calendar-utils&quot;).setupModule(controller);</span>
<a href="#l2.14"></a><span id="l2.14">     Object.assign(module, helpersForController(controller));</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16">     createCalendar(controller, CALENDARNAME);</span>
<a href="#l2.17"></a><span id="l2.17"> }</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19"> function testAnnualRecurrence() {</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-    controller.click(eid(&quot;calendar-tab-button&quot;));</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-    sleep();</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-    switchToView(controller, &quot;day&quot;);</span>
<a href="#l2.24"></a><span id="l2.24">     goToDate(controller, STARTYEAR, 1, 1);</span>
<a href="#l2.25"></a><span id="l2.25"> </span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-    // create yearly recurring all-day event</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+    // Create yearly recurring all-day event.</span>
<a href="#l2.28"></a><span id="l2.28">     let eventBox = lookupEventBox(&quot;day&quot;, ALLDAY, null, 1, null);</span>
<a href="#l2.29"></a><span id="l2.29">     invokeEventDialog(controller, eventBox, (event, iframe) =&gt; {</span>
<a href="#l2.30"></a><span id="l2.30">         let { eid: eventid } = helpersForController(event);</span>
<a href="#l2.31"></a><span id="l2.31"> </span>
<a href="#l2.32"></a><span id="l2.32">         menulistSelect(eventid(&quot;item-repeat&quot;), &quot;yearly&quot;, event);</span>
<a href="#l2.33"></a><span id="l2.33">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l2.34"></a><span id="l2.34">     });</span>
<a href="#l2.35"></a><span id="l2.35"> </span>
<a href="#l2.36"></a><span id="l2.36">     let checkYears = [STARTYEAR, STARTYEAR + 1, EPOCH - 1, EPOCH, EPOCH + 1];</span>
<a href="#l2.37"></a><span id="l2.37">     for (let year of checkYears) {</span>
<a href="#l2.38"></a><span id="l2.38">         goToDate(controller, year, 1, 1);</span>
<a href="#l2.39"></a><span id="l2.39">         let date = new Date(year, 0, 1);</span>
<a href="#l2.40"></a><span id="l2.40">         let column = date.getDay() + 1;</span>
<a href="#l2.41"></a><span id="l2.41"> </span>
<a href="#l2.42"></a><span id="l2.42">         // day view</span>
<a href="#l2.43"></a><span id="l2.43">         switchToView(controller, &quot;day&quot;);</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-            lookupEventBox(&quot;day&quot;, ALLDAY, null, 1, null, EVENTPATH)</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-        );</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;day&quot;, ALLDAY, null, 1, null, EVENTPATH));</span>
<a href="#l2.48"></a><span id="l2.48"> </span>
<a href="#l2.49"></a><span id="l2.49">         // week view</span>
<a href="#l2.50"></a><span id="l2.50">         switchToView(controller, &quot;week&quot;);</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-            lookupEventBox(&quot;week&quot;, ALLDAY, null, column, null, EVENTPATH)</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-        );</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;week&quot;, ALLDAY, null, column, null, EVENTPATH));</span>
<a href="#l2.55"></a><span id="l2.55"> </span>
<a href="#l2.56"></a><span id="l2.56">         // multiweek view</span>
<a href="#l2.57"></a><span id="l2.57">         switchToView(controller, &quot;multiweek&quot;);</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-            lookupEventBox(&quot;multiweek&quot;, ALLDAY, 1, column, null, EVENTPATH)</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-        );</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;multiweek&quot;, ALLDAY, 1, column, null, EVENTPATH));</span>
<a href="#l2.62"></a><span id="l2.62"> </span>
<a href="#l2.63"></a><span id="l2.63">         // month view</span>
<a href="#l2.64"></a><span id="l2.64">         switchToView(controller, &quot;month&quot;);</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-            lookupEventBox(&quot;month&quot;, ALLDAY, 1, column, null, EVENTPATH)</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-        );</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;month&quot;, ALLDAY, 1, column, null, EVENTPATH));</span>
<a href="#l2.69"></a><span id="l2.69">     }</span>
<a href="#l2.70"></a><span id="l2.70"> </span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-    // delete event</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+    // Delete event.</span>
<a href="#l2.73"></a><span id="l2.73">     goToDate(controller, checkYears[0], 1, 1);</span>
<a href="#l2.74"></a><span id="l2.74">     switchToView(controller, &quot;day&quot;);</span>
<a href="#l2.75"></a><span id="l2.75">     let box = getEventBoxPath(&quot;day&quot;, ALLDAY, null, 1, null) + EVENTPATH;</span>
<a href="#l2.76"></a><span id="l2.76">     controller.click(lookup(box));</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-    handleOccurrencePrompt(controller, eid(&quot;day-view&quot;), &quot;delete&quot;, true, false);</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+    handleOccurrencePrompt(controller, eid(&quot;day-view&quot;), &quot;delete&quot;, true);</span>
<a href="#l2.79"></a><span id="l2.79">     controller.waitForElementNotPresent(lookup(box));</span>
<a href="#l2.80"></a><span id="l2.80"> }</span>
<a href="#l2.81"></a><span id="l2.81"> </span>
<a href="#l2.82"></a><span id="l2.82"> function teardownTest(module) {</span>
<a href="#l2.83"></a><span id="l2.83">     deleteCalendars(controller, CALENDARNAME);</span>
<a href="#l2.84"></a><span id="l2.84"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/test/mozmill/cal-recurrence/testBiweeklyRecurrence.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/test/mozmill/cal-recurrence/testBiweeklyRecurrence.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -24,89 +24,83 @@ function setupModule(module) {</span>
<a href="#l3.4"></a><span id="l3.4">         switchToView,</span>
<a href="#l3.5"></a><span id="l3.5">         goToDate,</span>
<a href="#l3.6"></a><span id="l3.6">         invokeEventDialog,</span>
<a href="#l3.7"></a><span id="l3.7">         viewForward,</span>
<a href="#l3.8"></a><span id="l3.8">         deleteCalendars,</span>
<a href="#l3.9"></a><span id="l3.9">         createCalendar,</span>
<a href="#l3.10"></a><span id="l3.10">         menulistSelect</span>
<a href="#l3.11"></a><span id="l3.11">     } = collector.getModule(&quot;calendar-utils&quot;));</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    collector.getModule(&quot;calendar-utils&quot;).setupModule();</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+    collector.getModule(&quot;calendar-utils&quot;).setupModule(controller);</span>
<a href="#l3.14"></a><span id="l3.14">     Object.assign(module, helpersForController(controller));</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16">     createCalendar(controller, CALENDARNAME);</span>
<a href="#l3.17"></a><span id="l3.17"> }</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19"> function testBiweeklyRecurrence() {</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-    controller.click(eid(&quot;calendar-tab-button&quot;));</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-    switchToView(controller, &quot;day&quot;);</span>
<a href="#l3.22"></a><span id="l3.22">     goToDate(controller, 2009, 1, 31);</span>
<a href="#l3.23"></a><span id="l3.23"> </span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-    // create biweekly event</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+    // Create biweekly event.</span>
<a href="#l3.26"></a><span id="l3.26">     let eventBox = lookupEventBox(&quot;day&quot;, CANVAS_BOX, null, 1, HOUR);</span>
<a href="#l3.27"></a><span id="l3.27">     invokeEventDialog(controller, eventBox, (event, iframe) =&gt; {</span>
<a href="#l3.28"></a><span id="l3.28">         let { eid: eventid } = helpersForController(event);</span>
<a href="#l3.29"></a><span id="l3.29"> </span>
<a href="#l3.30"></a><span id="l3.30">         menulistSelect(eventid(&quot;item-repeat&quot;), &quot;bi.weekly&quot;, event);</span>
<a href="#l3.31"></a><span id="l3.31">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l3.32"></a><span id="l3.32">     });</span>
<a href="#l3.33"></a><span id="l3.33"> </span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-    // check day view</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+    // Check day view.</span>
<a href="#l3.36"></a><span id="l3.36">     for (let i = 0; i &lt; 4; i++) {</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-            lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, HOUR, EVENTPATH)</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-        );</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, EVENTPATH));</span>
<a href="#l3.41"></a><span id="l3.41">         viewForward(controller, 14);</span>
<a href="#l3.42"></a><span id="l3.42">     }</span>
<a href="#l3.43"></a><span id="l3.43"> </span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-    // check week view</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+    // Check week view.</span>
<a href="#l3.46"></a><span id="l3.46">     switchToView(controller, &quot;week&quot;);</span>
<a href="#l3.47"></a><span id="l3.47">     goToDate(controller, 2009, 1, 31);</span>
<a href="#l3.48"></a><span id="l3.48"> </span>
<a href="#l3.49"></a><span id="l3.49">     for (let i = 0; i &lt; 4; i++) {</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-            lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 7, HOUR, EVENTPATH)</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-        );</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 7, null, EVENTPATH));</span>
<a href="#l3.54"></a><span id="l3.54">         viewForward(controller, 2);</span>
<a href="#l3.55"></a><span id="l3.55">     }</span>
<a href="#l3.56"></a><span id="l3.56"> </span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-    // check multiweek view</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+    // Check multiweek view.</span>
<a href="#l3.59"></a><span id="l3.59">     switchToView(controller, &quot;multiweek&quot;);</span>
<a href="#l3.60"></a><span id="l3.60">     goToDate(controller, 2009, 1, 31);</span>
<a href="#l3.61"></a><span id="l3.61"> </span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-    // always two occurrences in view, 1st and 3rd or 2nd and 4th week</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+    // Always two occurrences in view, 1st and 3rd or 2nd and 4th week.</span>
<a href="#l3.64"></a><span id="l3.64">     for (let i = 0; i &lt; 5; i++) {</span>
<a href="#l3.65"></a><span id="l3.65">         controller.waitForElement(</span>
<a href="#l3.66"></a><span id="l3.66">             lookupEventBox(&quot;multiweek&quot;, EVENT_BOX, i % 2 + 1, 7, null, EVENTPATH)</span>
<a href="#l3.67"></a><span id="l3.67">         );</span>
<a href="#l3.68"></a><span id="l3.68">         controller.assertNode(</span>
<a href="#l3.69"></a><span id="l3.69">             lookupEventBox(&quot;multiweek&quot;, EVENT_BOX, i % 2 + 3, 7, null, EVENTPATH)</span>
<a href="#l3.70"></a><span id="l3.70">         );</span>
<a href="#l3.71"></a><span id="l3.71">         viewForward(controller, 1);</span>
<a href="#l3.72"></a><span id="l3.72">     }</span>
<a href="#l3.73"></a><span id="l3.73"> </span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-    // check month view</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+    // Check month view.</span>
<a href="#l3.76"></a><span id="l3.76">     switchToView(controller, &quot;month&quot;);</span>
<a href="#l3.77"></a><span id="l3.77">     goToDate(controller, 2009, 1, 31);</span>
<a href="#l3.78"></a><span id="l3.78"> </span>
<a href="#l3.79"></a><span id="l3.79">     // January</span>
<a href="#l3.80"></a><span id="l3.80">     controller.waitForElement(lookupEventBox(&quot;month&quot;, EVENT_BOX, 5, 7, null, EVENTPATH));</span>
<a href="#l3.81"></a><span id="l3.81">     viewForward(controller, 1);</span>
<a href="#l3.82"></a><span id="l3.82"> </span>
<a href="#l3.83"></a><span id="l3.83">     // February</span>
<a href="#l3.84"></a><span id="l3.84">     controller.waitForElement(lookupEventBox(&quot;month&quot;, EVENT_BOX, 2, 7, null, EVENTPATH));</span>
<a href="#l3.85"></a><span id="l3.85">     controller.assertNode(lookupEventBox(&quot;month&quot;, EVENT_BOX, 4, 7, null, EVENTPATH));</span>
<a href="#l3.86"></a><span id="l3.86">     viewForward(controller, 1);</span>
<a href="#l3.87"></a><span id="l3.87"> </span>
<a href="#l3.88"></a><span id="l3.88">     // March</span>
<a href="#l3.89"></a><span id="l3.89">     controller.waitForElement(lookupEventBox(&quot;month&quot;, EVENT_BOX, 2, 7, null, EVENTPATH));</span>
<a href="#l3.90"></a><span id="l3.90">     controller.assertNode(lookupEventBox(&quot;month&quot;, EVENT_BOX, 4, 7, null, EVENTPATH));</span>
<a href="#l3.91"></a><span id="l3.91"> </span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-    // delete event</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+    // Delete event.</span>
<a href="#l3.94"></a><span id="l3.94">     let box = lookupEventBox(&quot;month&quot;, EVENT_BOX, 4, 7, null, EVENTPATH);</span>
<a href="#l3.95"></a><span id="l3.95">     controller.click(box);</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-    handleOccurrencePrompt(controller, eid(&quot;month-view&quot;), &quot;delete&quot;, true, false);</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+    handleOccurrencePrompt(controller, eid(&quot;month-view&quot;), &quot;delete&quot;, true);</span>
<a href="#l3.98"></a><span id="l3.98">     controller.waitForElementNotPresent(box);</span>
<a href="#l3.99"></a><span id="l3.99"> }</span>
<a href="#l3.100"></a><span id="l3.100"> </span>
<a href="#l3.101"></a><span id="l3.101"> function teardownTest(module) {</span>
<a href="#l3.102"></a><span id="l3.102">     deleteCalendars(controller, CALENDARNAME);</span>
<a href="#l3.103"></a><span id="l3.103"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/test/mozmill/cal-recurrence/testDailyRecurrence.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/test/mozmill/cal-recurrence/testDailyRecurrence.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,20 +1,21 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.5"></a><span id="l4.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.6"></a><span id="l4.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> var MODULE_NAME = &quot;testDailyRecurrence&quot;;</span>
<a href="#l4.9"></a><span id="l4.9"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineminus">-var MODULE_REQUIRES = [&quot;calendar-utils&quot;];</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;item-editing-helpers&quot;];</span>
<a href="#l4.12"></a><span id="l4.12"> </span>
<a href="#l4.13"></a><span id="l4.13"> var CALENDARNAME, EVENTPATH, EVENT_BOX, CANVAS_BOX;</span>
<a href="#l4.14"></a><span id="l4.14"> var helpersForController, invokeEventDialog, createCalendar, deleteCalendars;</span>
<a href="#l4.15"></a><span id="l4.15"> var switchToView, goToDate, viewForward, viewBack, handleOccurrencePrompt;</span>
<a href="#l4.16"></a><span id="l4.16"> var menulistSelect;</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+var setData;</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19"> const HOUR = 8;</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21"> function setupModule(module) {</span>
<a href="#l4.22"></a><span id="l4.22">     controller = mozmill.getMail3PaneController();</span>
<a href="#l4.23"></a><span id="l4.23">     ({</span>
<a href="#l4.24"></a><span id="l4.24">         CALENDARNAME,</span>
<a href="#l4.25"></a><span id="l4.25">         EVENTPATH,</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineat">@@ -26,188 +27,169 @@ function setupModule(module) {</span>
<a href="#l4.27"></a><span id="l4.27">         goToDate,</span>
<a href="#l4.28"></a><span id="l4.28">         invokeEventDialog,</span>
<a href="#l4.29"></a><span id="l4.29">         viewForward,</span>
<a href="#l4.30"></a><span id="l4.30">         viewBack,</span>
<a href="#l4.31"></a><span id="l4.31">         deleteCalendars,</span>
<a href="#l4.32"></a><span id="l4.32">         createCalendar,</span>
<a href="#l4.33"></a><span id="l4.33">         menulistSelect</span>
<a href="#l4.34"></a><span id="l4.34">     } = collector.getModule(&quot;calendar-utils&quot;));</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-    collector.getModule(&quot;calendar-utils&quot;).setupModule();</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+    collector.getModule(&quot;calendar-utils&quot;).setupModule(controller);</span>
<a href="#l4.37"></a><span id="l4.37">     Object.assign(module, helpersForController(controller));</span>
<a href="#l4.38"></a><span id="l4.38"> </span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+    ({ setData } = collector.getModule(&quot;item-editing-helpers&quot;));</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+    collector.getModule(&quot;item-editing-helpers&quot;).setupModule(module);</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+</span>
<a href="#l4.42"></a><span id="l4.42">     createCalendar(controller, CALENDARNAME);</span>
<a href="#l4.43"></a><span id="l4.43"> }</span>
<a href="#l4.44"></a><span id="l4.44"> </span>
<a href="#l4.45"></a><span id="l4.45"> function testDailyRecurrence() {</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-    controller.click(eid(&quot;calendar-tab-button&quot;));</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-    switchToView(controller, &quot;day&quot;);</span>
<a href="#l4.48"></a><span id="l4.48">     goToDate(controller, 2009, 1, 1);</span>
<a href="#l4.49"></a><span id="l4.49"> </span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-    // create daily event</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+    // Create daily event.</span>
<a href="#l4.52"></a><span id="l4.52">     let eventBox = lookupEventBox(&quot;day&quot;, CANVAS_BOX, null, 1, HOUR);</span>
<a href="#l4.53"></a><span id="l4.53">     invokeEventDialog(controller, eventBox, (event, iframe) =&gt; {</span>
<a href="#l4.54"></a><span id="l4.54">         let { eid: eventid } = helpersForController(event);</span>
<a href="#l4.55"></a><span id="l4.55"> </span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-        menulistSelect(eventid(&quot;item-repeat&quot;), &quot;daily&quot;, event);</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+        setData(event, iframe, { repeat: &quot;daily&quot;, repeatuntil: new Date(2009, 2, 20) });</span>
<a href="#l4.58"></a><span id="l4.58">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l4.59"></a><span id="l4.59">     });</span>
<a href="#l4.60"></a><span id="l4.60"> </span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-    // check day view for 7 days</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineminus">-    let daybox = getEventBoxPath(&quot;day&quot;, EVENT_BOX, null, 1, HOUR, null) + EVENTPATH;</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineminus">-    controller.waitForElement(lookup(daybox));</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+    // Check day view for 7 days.</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+    let daybox = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, EVENTPATH);</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+    controller.waitForElement(daybox);</span>
<a href="#l4.67"></a><span id="l4.67"> </span>
<a href="#l4.68"></a><span id="l4.68">     for (let day = 1; day &lt;= 7; day++) {</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineminus">-        controller.waitForElement(lookup(daybox));</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+        controller.waitForElement(daybox);</span>
<a href="#l4.71"></a><span id="l4.71">         viewForward(controller, 1);</span>
<a href="#l4.72"></a><span id="l4.72">     }</span>
<a href="#l4.73"></a><span id="l4.73"> </span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-    // check week view for 2 weeks</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+    // Check week view for 2 weeks.</span>
<a href="#l4.76"></a><span id="l4.76">     switchToView(controller, &quot;week&quot;);</span>
<a href="#l4.77"></a><span id="l4.77">     goToDate(controller, 2009, 1, 1);</span>
<a href="#l4.78"></a><span id="l4.78"> </span>
<a href="#l4.79"></a><span id="l4.79">     for (let day = 5; day &lt;= 7; day++) {</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-            lookupEventBox(&quot;week&quot;, EVENT_BOX, 1, day, HOUR, EVENTPATH)</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-        );</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;week&quot;, EVENT_BOX, 1, day, null, EVENTPATH));</span>
<a href="#l4.84"></a><span id="l4.84">     }</span>
<a href="#l4.85"></a><span id="l4.85"> </span>
<a href="#l4.86"></a><span id="l4.86">     viewForward(controller, 1);</span>
<a href="#l4.87"></a><span id="l4.87"> </span>
<a href="#l4.88"></a><span id="l4.88">     for (let day = 1; day &lt;= 7; day++) {</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineminus">-            lookupEventBox(&quot;week&quot;, EVENT_BOX, 2, day, HOUR, EVENTPATH)</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineminus">-        );</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;week&quot;, EVENT_BOX, 2, day, null, EVENTPATH));</span>
<a href="#l4.93"></a><span id="l4.93">     }</span>
<a href="#l4.94"></a><span id="l4.94"> </span>
<a href="#l4.95"></a><span id="l4.95" class="difflineminus">-    // check multiweek view for 4 weeks</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+    // Check multiweek view for 4 weeks.</span>
<a href="#l4.97"></a><span id="l4.97">     switchToView(controller, &quot;multiweek&quot;);</span>
<a href="#l4.98"></a><span id="l4.98">     goToDate(controller, 2009, 1, 1);</span>
<a href="#l4.99"></a><span id="l4.99"> </span>
<a href="#l4.100"></a><span id="l4.100">     for (let day = 5; day &lt;= 7; day++) {</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineminus">-            lookupEventBox(&quot;multiweek&quot;, EVENT_BOX, 1, day, HOUR, EVENTPATH)</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineminus">-        );</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;multiweek&quot;, EVENT_BOX, 1, day, null, EVENTPATH));</span>
<a href="#l4.105"></a><span id="l4.105">     }</span>
<a href="#l4.106"></a><span id="l4.106"> </span>
<a href="#l4.107"></a><span id="l4.107">     for (let week = 2; week &lt;= 4; week++) {</span>
<a href="#l4.108"></a><span id="l4.108">         for (let day = 1; day &lt;= 7; day++) {</span>
<a href="#l4.109"></a><span id="l4.109">             controller.waitForElement(</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineminus">-                lookupEventBox(&quot;multiweek&quot;, EVENT_BOX, week, day, HOUR, EVENTPATH)</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineminus">-            );</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineminus">-        }</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineminus">-    }</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineminus">-</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineminus">-    // check month view for all 5 weeks</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineminus">-    switchToView(controller, &quot;month&quot;);</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineminus">-    goToDate(controller, 2009, 1, 1);</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineminus">-</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineminus">-    for (let day = 5; day &lt;= 7; day++) {</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineminus">-            lookupEventBox(&quot;month&quot;, EVENT_BOX, 1, day, null, EVENTPATH)</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineminus">-        );</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineminus">-    }</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineminus">-</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineminus">-    for (let week = 2; week &lt;= 5; week++) {</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineminus">-        for (let day = 1; day &lt;= 7; day++) {</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineminus">-            controller.assertNode(</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineminus">-                lookupEventBox(&quot;month&quot;, EVENT_BOX, week, day, null, EVENTPATH)</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+                lookupEventBox(&quot;multiweek&quot;, EVENT_BOX, week, day, null, EVENTPATH)</span>
<a href="#l4.130"></a><span id="l4.130">             );</span>
<a href="#l4.131"></a><span id="l4.131">         }</span>
<a href="#l4.132"></a><span id="l4.132">     }</span>
<a href="#l4.133"></a><span id="l4.133"> </span>
<a href="#l4.134"></a><span id="l4.134" class="difflineminus">-    // delete 3rd January occurrence</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineminus">-    let saturday = getEventBoxPath(&quot;month&quot;, EVENT_BOX, 1, 7, null) + EVENTPATH;</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineminus">-    controller.click(lookup(saturday));</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineminus">-    handleOccurrencePrompt(controller, eid(&quot;month-view&quot;), &quot;delete&quot;, false, false);</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+    // Check month view for all 5 weeks.</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+    switchToView(controller, &quot;month&quot;);</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineplus">+    goToDate(controller, 2009, 1, 1);</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+    for (let day = 5; day &lt;= 7; day++) {</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;month&quot;, EVENT_BOX, 1, day, null, EVENTPATH));</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+    }</span>
<a href="#l4.145"></a><span id="l4.145"> </span>
<a href="#l4.146"></a><span id="l4.146" class="difflineminus">-    // verify in all views</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineminus">-    controller.waitForElementNotPresent(lookup(saturday));</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+    for (let week = 2; week &lt;= 5; week++) {</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+        for (let day = 1; day &lt;= 7; day++) {</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+            controller.assertNode(lookupEventBox(&quot;month&quot;, EVENT_BOX, week, day, null, EVENTPATH));</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+        }</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+    }</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+    // Delete 3rd January occurrence.</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+    let saturday = lookupEventBox(&quot;month&quot;, EVENT_BOX, 1, 7, null, EVENTPATH);</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+    controller.click(saturday);</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+    handleOccurrencePrompt(controller, eid(&quot;month-view&quot;), &quot;delete&quot;, false);</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineplus">+</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineplus">+    // Verify in all views.</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+    controller.waitForElementNotPresent(saturday);</span>
<a href="#l4.161"></a><span id="l4.161"> </span>
<a href="#l4.162"></a><span id="l4.162">     switchToView(controller, &quot;multiweek&quot;);</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineminus">-    controller.assertNodeNotExist(</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineminus">-        lookupEventBox(&quot;multiweek&quot;, EVENT_BOX, 1, 7, null, EVENTPATH)</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineminus">-    );</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineplus">+    controller.assertNodeNotExist(lookupEventBox(&quot;multiweek&quot;, EVENT_BOX, 1, 7, null, EVENTPATH));</span>
<a href="#l4.167"></a><span id="l4.167"> </span>
<a href="#l4.168"></a><span id="l4.168">     switchToView(controller, &quot;week&quot;);</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineminus">-    controller.assertNodeNotExist(</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineminus">-        lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 7, null, EVENTPATH)</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineminus">-    );</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineplus">+    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 7, null, EVENTPATH));</span>
<a href="#l4.173"></a><span id="l4.173"> </span>
<a href="#l4.174"></a><span id="l4.174">     switchToView(controller, &quot;day&quot;);</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineminus">-    controller.assertNodeNotExist(</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineminus">-        lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, EVENTPATH)</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineminus">-    );</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+    controller.assertNodeNotExist(lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, EVENTPATH));</span>
<a href="#l4.179"></a><span id="l4.179"> </span>
<a href="#l4.180"></a><span id="l4.180" class="difflineminus">-    // go to previous day to edit event to occur only on weekdays</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+    // Go to previous day to edit event to occur only on weekdays.</span>
<a href="#l4.182"></a><span id="l4.182">     viewBack(controller, 1);</span>
<a href="#l4.183"></a><span id="l4.183"> </span>
<a href="#l4.184"></a><span id="l4.184" class="difflineminus">-    eventBox = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, HOUR, EVENTPATH);</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineminus">-    handleOccurrencePrompt(controller, eventBox, &quot;modify&quot;, true, false);</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineplus">+    eventBox = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, EVENTPATH);</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineplus">+    handleOccurrencePrompt(controller, eventBox, &quot;modify&quot;, true);</span>
<a href="#l4.188"></a><span id="l4.188">     invokeEventDialog(controller, null, (event, iframe) =&gt; {</span>
<a href="#l4.189"></a><span id="l4.189">         let { eid: eventid, sleep: eventsleep } = helpersForController(event);</span>
<a href="#l4.190"></a><span id="l4.190"> </span>
<a href="#l4.191"></a><span id="l4.191">         menulistSelect(eventid(&quot;item-repeat&quot;), &quot;every.weekday&quot;, event);</span>
<a href="#l4.192"></a><span id="l4.192">         eventsleep();</span>
<a href="#l4.193"></a><span id="l4.193">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l4.194"></a><span id="l4.194">     });</span>
<a href="#l4.195"></a><span id="l4.195"> </span>
<a href="#l4.196"></a><span id="l4.196" class="difflineminus">-    // check day view for 7 days</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineminus">-    let day = getEventBoxPath(&quot;day&quot;, EVENT_BOX, null, 1, null) + EVENTPATH;</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineplus">+    // Check day view for 7 days.</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineplus">+    let day = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, EVENTPATH);</span>
<a href="#l4.200"></a><span id="l4.200">     let dates = [</span>
<a href="#l4.201"></a><span id="l4.201">         [2009, 1, 3],</span>
<a href="#l4.202"></a><span id="l4.202">         [2009, 1, 4]</span>
<a href="#l4.203"></a><span id="l4.203">     ];</span>
<a href="#l4.204"></a><span id="l4.204">     for (let [y, m, d] of dates) {</span>
<a href="#l4.205"></a><span id="l4.205">         goToDate(controller, y, m, d);</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineminus">-        controller.assertNodeNotExist(lookup(day));</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineplus">+        controller.assertNodeNotExist(day);</span>
<a href="#l4.208"></a><span id="l4.208">     }</span>
<a href="#l4.209"></a><span id="l4.209"> </span>
<a href="#l4.210"></a><span id="l4.210" class="difflineminus">-    // check week view for 2 weeks</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineplus">+    // Check week view for 2 weeks.</span>
<a href="#l4.212"></a><span id="l4.212">     switchToView(controller, &quot;week&quot;);</span>
<a href="#l4.213"></a><span id="l4.213">     goToDate(controller, 2009, 1, 1);</span>
<a href="#l4.214"></a><span id="l4.214"> </span>
<a href="#l4.215"></a><span id="l4.215">     for (let i = 0; i &lt;= 1; i++) {</span>
<a href="#l4.216"></a><span id="l4.216">         controller.waitForElementNotPresent(</span>
<a href="#l4.217"></a><span id="l4.217">             lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 1, null, EVENTPATH)</span>
<a href="#l4.218"></a><span id="l4.218">         );</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineminus">-        controller.assertNodeNotExist(</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineminus">-            lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 7, null, EVENTPATH)</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineminus">-        );</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineplus">+        controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 7, null, EVENTPATH));</span>
<a href="#l4.223"></a><span id="l4.223">         viewForward(controller, 1);</span>
<a href="#l4.224"></a><span id="l4.224">     }</span>
<a href="#l4.225"></a><span id="l4.225"> </span>
<a href="#l4.226"></a><span id="l4.226" class="difflineminus">-    // check multiweek view for 4 weeks</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineplus">+    // Check multiweek view for 4 weeks.</span>
<a href="#l4.228"></a><span id="l4.228">     switchToView(controller, &quot;multiweek&quot;);</span>
<a href="#l4.229"></a><span id="l4.229">     goToDate(controller, 2009, 1, 1);</span>
<a href="#l4.230"></a><span id="l4.230"> </span>
<a href="#l4.231"></a><span id="l4.231">     for (let i = 1; i &lt;= 4; i++) {</span>
<a href="#l4.232"></a><span id="l4.232">         controller.waitForElementNotPresent(</span>
<a href="#l4.233"></a><span id="l4.233">             lookupEventBox(&quot;multiweek&quot;, EVENT_BOX, i, 1, null, EVENTPATH)</span>
<a href="#l4.234"></a><span id="l4.234">         );</span>
<a href="#l4.235"></a><span id="l4.235">         controller.assertNodeNotExist(</span>
<a href="#l4.236"></a><span id="l4.236">             lookupEventBox(&quot;multiweek&quot;, EVENT_BOX, i, 7, null, EVENTPATH)</span>
<a href="#l4.237"></a><span id="l4.237">         );</span>
<a href="#l4.238"></a><span id="l4.238">     }</span>
<a href="#l4.239"></a><span id="l4.239"> </span>
<a href="#l4.240"></a><span id="l4.240" class="difflineminus">-    // check month view for all 5 weeks</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineplus">+    // Check month view for all 5 weeks.</span>
<a href="#l4.242"></a><span id="l4.242">     switchToView(controller, &quot;month&quot;);</span>
<a href="#l4.243"></a><span id="l4.243">     goToDate(controller, 2009, 1, 1);</span>
<a href="#l4.244"></a><span id="l4.244"> </span>
<a href="#l4.245"></a><span id="l4.245">     for (let i = 1; i &lt;= 5; i++) {</span>
<a href="#l4.246"></a><span id="l4.246">         controller.waitForElementNotPresent(</span>
<a href="#l4.247"></a><span id="l4.247">             lookupEventBox(&quot;month&quot;, EVENT_BOX, i, 1, null, EVENTPATH)</span>
<a href="#l4.248"></a><span id="l4.248">         );</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineminus">-        controller.assertNodeNotExist(</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineminus">-            lookupEventBox(&quot;month&quot;, EVENT_BOX, i, 7, null, EVENTPATH)</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineminus">-        );</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineplus">+        controller.assertNodeNotExist(lookupEventBox(&quot;month&quot;, EVENT_BOX, i, 7, null, EVENTPATH));</span>
<a href="#l4.253"></a><span id="l4.253">     }</span>
<a href="#l4.254"></a><span id="l4.254"> </span>
<a href="#l4.255"></a><span id="l4.255" class="difflineminus">-    // delete event</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineminus">-    day = getEventBoxPath(&quot;month&quot;, EVENT_BOX, 1, 5, null) + EVENTPATH;</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineminus">-    controller.click(lookup(day));</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineminus">-    handleOccurrencePrompt(controller, eid(&quot;month-view&quot;), &quot;delete&quot;, true, false);</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineminus">-    controller.waitForElementNotPresent(lookup(day));</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineplus">+    // Delete event.</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineplus">+    day = lookupEventBox(&quot;month&quot;, EVENT_BOX, 1, 5, null, EVENTPATH);</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineplus">+    controller.click(day);</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineplus">+    handleOccurrencePrompt(controller, eid(&quot;month-view&quot;), &quot;delete&quot;, true);</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineplus">+    controller.waitForElementNotPresent(day);</span>
<a href="#l4.265"></a><span id="l4.265"> }</span>
<a href="#l4.266"></a><span id="l4.266"> </span>
<a href="#l4.267"></a><span id="l4.267"> function teardownTest(module) {</span>
<a href="#l4.268"></a><span id="l4.268">     deleteCalendars(controller, CALENDARNAME);</span>
<a href="#l4.269"></a><span id="l4.269"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/test/mozmill/cal-recurrence/testLastDayOfMonthRecurrence.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/test/mozmill/cal-recurrence/testLastDayOfMonthRecurrence.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,125 +1,121 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.5"></a><span id="l5.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.6"></a><span id="l5.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> var MODULE_NAME = &quot;testLastDayOfMonthRecurrence&quot;;</span>
<a href="#l5.9"></a><span id="l5.9"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineminus">-var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;window-helpers&quot;];</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;item-editing-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l5.12"></a><span id="l5.12"> </span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-var TIMEOUT_MODAL_DIALOG, CALENDARNAME, EVENTPATH, EVENT_BOX;</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-var CANVAS_BOX, REC_DLG_ACCEPT;</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+var TIMEOUT_MODAL_DIALOG, CALENDARNAME, EVENTPATH, EVENT_BOX, CANVAS_BOX;</span>
<a href="#l5.16"></a><span id="l5.16"> var helpersForController, handleOccurrencePrompt, switchToView, goToDate;</span>
<a href="#l5.17"></a><span id="l5.17"> var invokeEventDialog, deleteCalendars, createCalendar, menulistSelect;</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+var REC_DLG_ACCEPT;</span>
<a href="#l5.19"></a><span id="l5.19"> var plan_for_modal_dialog, wait_for_modal_dialog;</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21"> const HOUR = 8;</span>
<a href="#l5.22"></a><span id="l5.22"> </span>
<a href="#l5.23"></a><span id="l5.23"> function setupModule(module) {</span>
<a href="#l5.24"></a><span id="l5.24">     controller = mozmill.getMail3PaneController();</span>
<a href="#l5.25"></a><span id="l5.25">     ({</span>
<a href="#l5.26"></a><span id="l5.26">         TIMEOUT_MODAL_DIALOG,</span>
<a href="#l5.27"></a><span id="l5.27">         CALENDARNAME,</span>
<a href="#l5.28"></a><span id="l5.28">         EVENTPATH,</span>
<a href="#l5.29"></a><span id="l5.29">         EVENT_BOX,</span>
<a href="#l5.30"></a><span id="l5.30">         CANVAS_BOX,</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-        REC_DLG_ACCEPT,</span>
<a href="#l5.32"></a><span id="l5.32">         helpersForController,</span>
<a href="#l5.33"></a><span id="l5.33">         invokeEventDialog,</span>
<a href="#l5.34"></a><span id="l5.34">         createCalendar,</span>
<a href="#l5.35"></a><span id="l5.35">         deleteCalendars,</span>
<a href="#l5.36"></a><span id="l5.36">         switchToView,</span>
<a href="#l5.37"></a><span id="l5.37">         goToDate,</span>
<a href="#l5.38"></a><span id="l5.38">         handleOccurrencePrompt,</span>
<a href="#l5.39"></a><span id="l5.39">         menulistSelect</span>
<a href="#l5.40"></a><span id="l5.40">     } = collector.getModule(&quot;calendar-utils&quot;));</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-    collector.getModule(&quot;calendar-utils&quot;).setupModule();</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+    collector.getModule(&quot;calendar-utils&quot;).setupModule(controller);</span>
<a href="#l5.43"></a><span id="l5.43">     Object.assign(module, helpersForController(controller));</span>
<a href="#l5.44"></a><span id="l5.44"> </span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+    ({ REC_DLG_ACCEPT } = collector.getModule(&quot;item-editing-helpers&quot;));</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+    collector.getModule(&quot;item-editing-helpers&quot;).setupModule(module);</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+</span>
<a href="#l5.48"></a><span id="l5.48">     ({ plan_for_modal_dialog, wait_for_modal_dialog } =</span>
<a href="#l5.49"></a><span id="l5.49">         collector.getModule(&quot;window-helpers&quot;)</span>
<a href="#l5.50"></a><span id="l5.50">     );</span>
<a href="#l5.51"></a><span id="l5.51"> </span>
<a href="#l5.52"></a><span id="l5.52">     createCalendar(controller, CALENDARNAME);</span>
<a href="#l5.53"></a><span id="l5.53"> }</span>
<a href="#l5.54"></a><span id="l5.54"> </span>
<a href="#l5.55"></a><span id="l5.55"> function testLastDayOfMonthRecurrence() {</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-    controller.click(eid(&quot;calendar-tab-button&quot;));</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-    switchToView(controller, &quot;day&quot;);</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-    goToDate(controller, 2008, 1, 31); // start with a leap year</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+    goToDate(controller, 2008, 1, 31); // Start with a leap year.</span>
<a href="#l5.60"></a><span id="l5.60"> </span>
<a href="#l5.61"></a><span id="l5.61" class="difflineminus">-    // create monthly recurring event</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+    // Create monthly recurring event.</span>
<a href="#l5.63"></a><span id="l5.63">     let eventBox = lookupEventBox(&quot;day&quot;, CANVAS_BOX, null, 1, HOUR);</span>
<a href="#l5.64"></a><span id="l5.64">     invokeEventDialog(controller, eventBox, (event, iframe) =&gt; {</span>
<a href="#l5.65"></a><span id="l5.65">         let { eid: eventid } = helpersForController(event);</span>
<a href="#l5.66"></a><span id="l5.66"> </span>
<a href="#l5.67"></a><span id="l5.67">         plan_for_modal_dialog(&quot;Calendar:EventDialog:Recurrence&quot;, setRecurrence);</span>
<a href="#l5.68"></a><span id="l5.68">         menulistSelect(eventid(&quot;item-repeat&quot;), &quot;custom&quot;, event);</span>
<a href="#l5.69"></a><span id="l5.69">         wait_for_modal_dialog(&quot;Calendar:EventDialog:Recurrence&quot;, TIMEOUT_MODAL_DIALOG);</span>
<a href="#l5.70"></a><span id="l5.70"> </span>
<a href="#l5.71"></a><span id="l5.71">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l5.72"></a><span id="l5.72">     });</span>
<a href="#l5.73"></a><span id="l5.73"> </span>
<a href="#l5.74"></a><span id="l5.74">     // data tuple: [year, month, day, row in month view]</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineminus">-    // note: month starts here with 1 for January</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+    // note: Month starts here with 1 for January.</span>
<a href="#l5.77"></a><span id="l5.77">     let checkingData = [[2008, 1, 31, 5],</span>
<a href="#l5.78"></a><span id="l5.78">                         [2008, 2, 29, 5],</span>
<a href="#l5.79"></a><span id="l5.79">                         [2008, 3, 31, 6],</span>
<a href="#l5.80"></a><span id="l5.80">                         [2008, 4, 30, 5],</span>
<a href="#l5.81"></a><span id="l5.81">                         [2008, 5, 31, 5],</span>
<a href="#l5.82"></a><span id="l5.82">                         [2008, 6, 30, 5],</span>
<a href="#l5.83"></a><span id="l5.83">                         [2008, 7, 31, 5],</span>
<a href="#l5.84"></a><span id="l5.84">                         [2008, 8, 31, 6],</span>
<a href="#l5.85"></a><span id="l5.85">                         [2008, 9, 30, 5],</span>
<a href="#l5.86"></a><span id="l5.86">                         [2008, 10, 31, 5],</span>
<a href="#l5.87"></a><span id="l5.87">                         [2008, 11, 30, 6],</span>
<a href="#l5.88"></a><span id="l5.88">                         [2008, 12, 31, 5],</span>
<a href="#l5.89"></a><span id="l5.89">                         [2009, 1, 31, 5],</span>
<a href="#l5.90"></a><span id="l5.90">                         [2009, 2, 28, 4],</span>
<a href="#l5.91"></a><span id="l5.91">                         [2009, 3, 31, 5]];</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineminus">-    // check all dates</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+    // Check all dates.</span>
<a href="#l5.94"></a><span id="l5.94">     for (let [y, m, d, correctRow] of checkingData) {</span>
<a href="#l5.95"></a><span id="l5.95">         let date = new Date(y, m - 1, d);</span>
<a href="#l5.96"></a><span id="l5.96">         let column = date.getDay() + 1;</span>
<a href="#l5.97"></a><span id="l5.97"> </span>
<a href="#l5.98"></a><span id="l5.98">         goToDate(controller, y, m, d);</span>
<a href="#l5.99"></a><span id="l5.99"> </span>
<a href="#l5.100"></a><span id="l5.100">         // day view</span>
<a href="#l5.101"></a><span id="l5.101">         switchToView(controller, &quot;day&quot;);</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineminus">-            lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, HOUR, EVENTPATH)</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineminus">-        );</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, EVENTPATH));</span>
<a href="#l5.106"></a><span id="l5.106"> </span>
<a href="#l5.107"></a><span id="l5.107">         // week view</span>
<a href="#l5.108"></a><span id="l5.108">         switchToView(controller, &quot;week&quot;);</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineminus">-            lookupEventBox(&quot;week&quot;, EVENT_BOX, null, column, HOUR, EVENTPATH)</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineminus">-        );</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, column, null, EVENTPATH));</span>
<a href="#l5.113"></a><span id="l5.113"> </span>
<a href="#l5.114"></a><span id="l5.114">         // multiweek view</span>
<a href="#l5.115"></a><span id="l5.115">         switchToView(controller, &quot;multiweek&quot;);</span>
<a href="#l5.116"></a><span id="l5.116">         controller.waitForElement(</span>
<a href="#l5.117"></a><span id="l5.117">             lookupEventBox(&quot;multiweek&quot;, EVENT_BOX, 1, column, null, EVENTPATH)</span>
<a href="#l5.118"></a><span id="l5.118">         );</span>
<a href="#l5.119"></a><span id="l5.119"> </span>
<a href="#l5.120"></a><span id="l5.120">         // month view</span>
<a href="#l5.121"></a><span id="l5.121">         switchToView(controller, &quot;month&quot;);</span>
<a href="#l5.122"></a><span id="l5.122">         controller.waitForElement(</span>
<a href="#l5.123"></a><span id="l5.123">             lookupEventBox(&quot;month&quot;, EVENT_BOX, correctRow, column, null, EVENTPATH)</span>
<a href="#l5.124"></a><span id="l5.124">         );</span>
<a href="#l5.125"></a><span id="l5.125">     }</span>
<a href="#l5.126"></a><span id="l5.126"> </span>
<a href="#l5.127"></a><span id="l5.127" class="difflineminus">-    // delete event</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+    // Delete event.</span>
<a href="#l5.129"></a><span id="l5.129">     goToDate(controller, checkingData[0][0], checkingData[0][1], checkingData[0][2]);</span>
<a href="#l5.130"></a><span id="l5.130">     switchToView(controller, &quot;day&quot;);</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineminus">-    let box = getEventBoxPath(&quot;day&quot;, EVENT_BOX, null, 1, HOUR) + EVENTPATH;</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineminus">-    controller.waitThenClick(lookup(box));</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineminus">-    handleOccurrencePrompt(controller, eid(&quot;day-view&quot;), &quot;delete&quot;, true, false);</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineminus">-    controller.waitForElementNotPresent(lookup(box));</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+    let box = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, EVENTPATH);</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+    controller.waitThenClick(box);</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+    handleOccurrencePrompt(controller, eid(&quot;day-view&quot;), &quot;delete&quot;, true);</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+    controller.waitForElementNotPresent(box);</span>
<a href="#l5.139"></a><span id="l5.139"> }</span>
<a href="#l5.140"></a><span id="l5.140"> </span>
<a href="#l5.141"></a><span id="l5.141"> function setRecurrence(recurrence) {</span>
<a href="#l5.142"></a><span id="l5.142">     let {</span>
<a href="#l5.143"></a><span id="l5.143">         sleep: recsleep,</span>
<a href="#l5.144"></a><span id="l5.144">         lookup: reclookup,</span>
<a href="#l5.145"></a><span id="l5.145">         eid: recid</span>
<a href="#l5.146"></a><span id="l5.146">     } = helpersForController(recurrence);</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineat">@@ -128,15 +124,15 @@ function setRecurrence(recurrence) {</span>
<a href="#l5.148"></a><span id="l5.148">     menulistSelect(recid(&quot;period-list&quot;), &quot;2&quot;, recurrence);</span>
<a href="#l5.149"></a><span id="l5.149"> </span>
<a href="#l5.150"></a><span id="l5.150">     // last day of month</span>
<a href="#l5.151"></a><span id="l5.151">     recurrence.radio(recid(&quot;montly-period-relative-date-radio&quot;));</span>
<a href="#l5.152"></a><span id="l5.152">     menulistSelect(recid(&quot;monthly-ordinal&quot;), &quot;-1&quot;, recurrence);</span>
<a href="#l5.153"></a><span id="l5.153">     menulistSelect(recid(&quot;monthly-weekday&quot;), &quot;-1&quot;, recurrence);</span>
<a href="#l5.154"></a><span id="l5.154">     recsleep();</span>
<a href="#l5.155"></a><span id="l5.155"> </span>
<a href="#l5.156"></a><span id="l5.156" class="difflineminus">-    // close dialog</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+    // Close dialog.</span>
<a href="#l5.158"></a><span id="l5.158">     recurrence.click(reclookup(REC_DLG_ACCEPT));</span>
<a href="#l5.159"></a><span id="l5.159"> }</span>
<a href="#l5.160"></a><span id="l5.160"> </span>
<a href="#l5.161"></a><span id="l5.161"> function teardownTest(module) {</span>
<a href="#l5.162"></a><span id="l5.162">     deleteCalendars(controller, CALENDARNAME);</span>
<a href="#l5.163"></a><span id="l5.163"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/test/mozmill/cal-recurrence/testWeeklyNRecurrence.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/test/mozmill/cal-recurrence/testWeeklyNRecurrence.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,174 +1,159 @@</span>
<a href="#l6.4"></a><span id="l6.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.5"></a><span id="l6.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.6"></a><span id="l6.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8"> var MODULE_NAME = &quot;testWeeklyNRecurrence&quot;;</span>
<a href="#l6.9"></a><span id="l6.9"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineminus">-var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;window-helpers&quot;];</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;item-editing-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l6.12"></a><span id="l6.12"> </span>
<a href="#l6.13"></a><span id="l6.13"> var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;, null);</span>
<a href="#l6.14"></a><span id="l6.14"> </span>
<a href="#l6.15"></a><span id="l6.15"> var TIMEOUT_MODAL_DIALOG, CALENDARNAME, EVENTPATH, EVENT_BOX, CANVAS_BOX;</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-var REC_DLG_ACCEPT, REC_DLG_DAYS;</span>
<a href="#l6.17"></a><span id="l6.17"> var helpersForController, handleOccurrencePrompt, switchToView, goToDate;</span>
<a href="#l6.18"></a><span id="l6.18"> var invokeEventDialog, viewForward, deleteCalendars, createCalendar, menulistSelect;</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+var REC_DLG_ACCEPT, REC_DLG_DAYS;</span>
<a href="#l6.20"></a><span id="l6.20"> var plan_for_modal_dialog, wait_for_modal_dialog;</span>
<a href="#l6.21"></a><span id="l6.21"> </span>
<a href="#l6.22"></a><span id="l6.22"> const HOUR = 8;</span>
<a href="#l6.23"></a><span id="l6.23"> </span>
<a href="#l6.24"></a><span id="l6.24"> function setupModule(module) {</span>
<a href="#l6.25"></a><span id="l6.25">     controller = mozmill.getMail3PaneController();</span>
<a href="#l6.26"></a><span id="l6.26">     ({</span>
<a href="#l6.27"></a><span id="l6.27">         TIMEOUT_MODAL_DIALOG,</span>
<a href="#l6.28"></a><span id="l6.28">         CALENDARNAME,</span>
<a href="#l6.29"></a><span id="l6.29">         EVENTPATH,</span>
<a href="#l6.30"></a><span id="l6.30">         EVENT_BOX,</span>
<a href="#l6.31"></a><span id="l6.31">         CANVAS_BOX,</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-        REC_DLG_ACCEPT,</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-        REC_DLG_DAYS,</span>
<a href="#l6.34"></a><span id="l6.34">         helpersForController,</span>
<a href="#l6.35"></a><span id="l6.35">         handleOccurrencePrompt,</span>
<a href="#l6.36"></a><span id="l6.36">         switchToView,</span>
<a href="#l6.37"></a><span id="l6.37">         goToDate,</span>
<a href="#l6.38"></a><span id="l6.38">         invokeEventDialog,</span>
<a href="#l6.39"></a><span id="l6.39">         viewForward,</span>
<a href="#l6.40"></a><span id="l6.40">         deleteCalendars,</span>
<a href="#l6.41"></a><span id="l6.41">         createCalendar,</span>
<a href="#l6.42"></a><span id="l6.42">         menulistSelect</span>
<a href="#l6.43"></a><span id="l6.43">     } = collector.getModule(&quot;calendar-utils&quot;));</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-    collector.getModule(&quot;calendar-utils&quot;).setupModule();</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+    collector.getModule(&quot;calendar-utils&quot;).setupModule(controller);</span>
<a href="#l6.46"></a><span id="l6.46">     Object.assign(module, helpersForController(controller));</span>
<a href="#l6.47"></a><span id="l6.47"> </span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+    ({</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+        REC_DLG_ACCEPT,</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+        REC_DLG_DAYS</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+    } = collector.getModule(&quot;item-editing-helpers&quot;));</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+    collector.getModule(&quot;item-editing-helpers&quot;).setupModule(module);</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+</span>
<a href="#l6.54"></a><span id="l6.54">     ({ plan_for_modal_dialog, wait_for_modal_dialog } =</span>
<a href="#l6.55"></a><span id="l6.55">         collector.getModule(&quot;window-helpers&quot;)</span>
<a href="#l6.56"></a><span id="l6.56">     );</span>
<a href="#l6.57"></a><span id="l6.57"> </span>
<a href="#l6.58"></a><span id="l6.58">     createCalendar(controller, CALENDARNAME);</span>
<a href="#l6.59"></a><span id="l6.59"> }</span>
<a href="#l6.60"></a><span id="l6.60"> </span>
<a href="#l6.61"></a><span id="l6.61"> function testWeeklyNRecurrence() {</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-    controller.click(eid(&quot;calendar-tab-button&quot;));</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-    switchToView(controller, &quot;day&quot;);</span>
<a href="#l6.64"></a><span id="l6.64">     goToDate(controller, 2009, 1, 5);</span>
<a href="#l6.65"></a><span id="l6.65"> </span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-    // create weekly recurring event</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+    // Create weekly recurring event.</span>
<a href="#l6.68"></a><span id="l6.68">     let eventBox = lookupEventBox(&quot;day&quot;, CANVAS_BOX, null, 1, HOUR);</span>
<a href="#l6.69"></a><span id="l6.69">     invokeEventDialog(controller, eventBox, (event, iframe) =&gt; {</span>
<a href="#l6.70"></a><span id="l6.70">         let { eid: eventid } = helpersForController(event);</span>
<a href="#l6.71"></a><span id="l6.71"> </span>
<a href="#l6.72"></a><span id="l6.72">         plan_for_modal_dialog(&quot;Calendar:EventDialog:Recurrence&quot;, setRecurrence);</span>
<a href="#l6.73"></a><span id="l6.73">         event.waitForElement(eventid(&quot;item-repeat&quot;));</span>
<a href="#l6.74"></a><span id="l6.74">         menulistSelect(eventid(&quot;item-repeat&quot;), &quot;custom&quot;, event);</span>
<a href="#l6.75"></a><span id="l6.75">         wait_for_modal_dialog(&quot;Calendar:EventDialog:Recurrence&quot;, TIMEOUT_MODAL_DIALOG);</span>
<a href="#l6.76"></a><span id="l6.76"> </span>
<a href="#l6.77"></a><span id="l6.77">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l6.78"></a><span id="l6.78">     });</span>
<a href="#l6.79"></a><span id="l6.79"> </span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-    // check day view</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-    let box = getEventBoxPath(&quot;day&quot;, EVENT_BOX, undefined, 1, HOUR) + EVENTPATH;</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+    // Check day view.</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+    let box = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, EVENTPATH);</span>
<a href="#l6.84"></a><span id="l6.84">     // Monday, Tuesday, Wednesday, Thursday</span>
<a href="#l6.85"></a><span id="l6.85">     for (let i = 0; i &lt; 4; i++) {</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-        controller.waitForElement(lookup(box));</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+        controller.waitForElement(box);</span>
<a href="#l6.88"></a><span id="l6.88">         viewForward(controller, 1);</span>
<a href="#l6.89"></a><span id="l6.89">     }</span>
<a href="#l6.90"></a><span id="l6.90"> </span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-    // Not Friday</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-    sleep();</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-    controller.assertNodeNotExist(lookup(box));</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+    // Not Friday.</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+    controller.waitForElementNotPresent(box);</span>
<a href="#l6.96"></a><span id="l6.96">     viewForward(controller, 1);</span>
<a href="#l6.97"></a><span id="l6.97"> </span>
<a href="#l6.98"></a><span id="l6.98">     // Not Saturday as only 4 occurrences are set.</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineminus">-    sleep();</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineminus">-    controller.assertNodeNotExist(lookup(box));</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+    controller.waitForElementNotPresent(box);</span>
<a href="#l6.102"></a><span id="l6.102"> </span>
<a href="#l6.103"></a><span id="l6.103" class="difflineminus">-    // check week view</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+    // Check week view.</span>
<a href="#l6.105"></a><span id="l6.105">     switchToView(controller, &quot;week&quot;);</span>
<a href="#l6.106"></a><span id="l6.106"> </span>
<a href="#l6.107"></a><span id="l6.107">     // Monday, Tuesday, Wednesday, Thursday</span>
<a href="#l6.108"></a><span id="l6.108">     for (let i = 2; i &lt; 6; i++) {</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineminus">-            lookupEventBox(&quot;week&quot;, EVENT_BOX, null, i, HOUR, EVENTPATH)</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineminus">-        );</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, i, null, EVENTPATH));</span>
<a href="#l6.113"></a><span id="l6.113">     }</span>
<a href="#l6.114"></a><span id="l6.114"> </span>
<a href="#l6.115"></a><span id="l6.115">     // Saturday</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">-    controller.assertNodeNotExist(</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">-        lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 7, HOUR, EVENTPATH)</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineminus">-    );</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineplus">+    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 7, null, EVENTPATH));</span>
<a href="#l6.120"></a><span id="l6.120"> </span>
<a href="#l6.121"></a><span id="l6.121" class="difflineminus">-    // check multiweek view</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+    // Check multiweek view.</span>
<a href="#l6.123"></a><span id="l6.123">     switchToView(controller, &quot;multiweek&quot;);</span>
<a href="#l6.124"></a><span id="l6.124">     checkMultiWeekView(&quot;multiweek&quot;);</span>
<a href="#l6.125"></a><span id="l6.125"> </span>
<a href="#l6.126"></a><span id="l6.126" class="difflineminus">-    // check month view</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineplus">+    // Check month view.</span>
<a href="#l6.128"></a><span id="l6.128">     switchToView(controller, &quot;month&quot;);</span>
<a href="#l6.129"></a><span id="l6.129">     checkMultiWeekView(&quot;month&quot;);</span>
<a href="#l6.130"></a><span id="l6.130"> </span>
<a href="#l6.131"></a><span id="l6.131" class="difflineminus">-    // delete event</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineminus">-    box = getEventBoxPath(&quot;month&quot;, EVENT_BOX, 2, 2, HOUR) + EVENTPATH;</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineminus">-    controller.click(lookup(box));</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineminus">-    handleOccurrencePrompt(controller, eid(&quot;month-view&quot;), &quot;delete&quot;, true, false);</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineminus">-    controller.waitForElementNotPresent(lookup(box));</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineplus">+    // Delete event.</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineplus">+    box = lookupEventBox(&quot;month&quot;, EVENT_BOX, 2, 2, null, EVENTPATH);</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineplus">+    controller.click(box);</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+    handleOccurrencePrompt(controller, eid(&quot;month-view&quot;), &quot;delete&quot;, true);</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+    controller.waitForElementNotPresent(box);</span>
<a href="#l6.141"></a><span id="l6.141"> }</span>
<a href="#l6.142"></a><span id="l6.142"> </span>
<a href="#l6.143"></a><span id="l6.143"> function setRecurrence(recurrence) {</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineminus">-    let {</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineminus">-        sleep: recsleep,</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineminus">-        lookup: reclookup,</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineminus">-        eid: recid,</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">-    } = helpersForController(recurrence);</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+    let { sleep: recsleep, lookup: reclookup, eid: recid } = helpersForController(recurrence);</span>
<a href="#l6.150"></a><span id="l6.150"> </span>
<a href="#l6.151"></a><span id="l6.151">     // weekly</span>
<a href="#l6.152"></a><span id="l6.152">     recurrence.waitForElement(recid(&quot;period-list&quot;));</span>
<a href="#l6.153"></a><span id="l6.153">     menulistSelect(recid(&quot;period-list&quot;), &quot;1&quot;, recurrence);</span>
<a href="#l6.154"></a><span id="l6.154">     recsleep();</span>
<a href="#l6.155"></a><span id="l6.155"> </span>
<a href="#l6.156"></a><span id="l6.156">     let mon = cal.l10n.getDateFmtString(&quot;day.2.Mmm&quot;);</span>
<a href="#l6.157"></a><span id="l6.157">     let tue = cal.l10n.getDateFmtString(&quot;day.3.Mmm&quot;);</span>
<a href="#l6.158"></a><span id="l6.158">     let wed = cal.l10n.getDateFmtString(&quot;day.4.Mmm&quot;);</span>
<a href="#l6.159"></a><span id="l6.159">     let thu = cal.l10n.getDateFmtString(&quot;day.5.Mmm&quot;);</span>
<a href="#l6.160"></a><span id="l6.160">     let sat = cal.l10n.getDateFmtString(&quot;day.7.Mmm&quot;);</span>
<a href="#l6.161"></a><span id="l6.161"> </span>
<a href="#l6.162"></a><span id="l6.162" class="difflineminus">-    // starting from Monday so it should be checked. We have to wait a little,</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineplus">+    // Starting from Monday so it should be checked. We have to wait a little,</span>
<a href="#l6.164"></a><span id="l6.164">     // because the checkedstate is set in background by JS.</span>
<a href="#l6.165"></a><span id="l6.165">     recurrence.waitFor(() =&gt; {</span>
<a href="#l6.166"></a><span id="l6.166">         return recurrence.assertChecked(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${mon}&quot;}`));</span>
<a href="#l6.167"></a><span id="l6.167">     }, 30000);</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineminus">-    // check Tuesday, Wednesday, Thursday and Saturday too</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineplus">+    // Check Tuesday, Wednesday, Thursday and Saturday too.</span>
<a href="#l6.170"></a><span id="l6.170">     recurrence.click(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${tue}&quot;}`));</span>
<a href="#l6.171"></a><span id="l6.171">     recurrence.click(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${wed}&quot;}`));</span>
<a href="#l6.172"></a><span id="l6.172">     recurrence.click(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${thu}&quot;}`));</span>
<a href="#l6.173"></a><span id="l6.173">     recurrence.click(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${sat}&quot;}`));</span>
<a href="#l6.174"></a><span id="l6.174"> </span>
<a href="#l6.175"></a><span id="l6.175" class="difflineminus">-    // set number of occurrences</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineplus">+    // Set number of recurrences.</span>
<a href="#l6.177"></a><span id="l6.177">     recurrence.click(recid(&quot;recurrence-range-for&quot;));</span>
<a href="#l6.178"></a><span id="l6.178">     let ntimesField = recid(&quot;repeat-ntimes-count&quot;);</span>
<a href="#l6.179"></a><span id="l6.179">     ntimesField.getNode().value = &quot;4&quot;;</span>
<a href="#l6.180"></a><span id="l6.180"> </span>
<a href="#l6.181"></a><span id="l6.181" class="difflineminus">-    // close dialog</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineplus">+    // Close dialog.</span>
<a href="#l6.183"></a><span id="l6.183">     recurrence.click(reclookup(REC_DLG_ACCEPT));</span>
<a href="#l6.184"></a><span id="l6.184"> }</span>
<a href="#l6.185"></a><span id="l6.185"> </span>
<a href="#l6.186"></a><span id="l6.186"> function checkMultiWeekView(view) {</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineminus">-    // make sure, the view has time to load</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineminus">-    sleep();</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineminus">-</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineminus">-    // In month view event starts from 2nd row</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineplus">+    // In month view event starts from 2nd row.</span>
<a href="#l6.192"></a><span id="l6.192">     let week = view == &quot;month&quot; ? 2 : 1;</span>
<a href="#l6.193"></a><span id="l6.193"> </span>
<a href="#l6.194"></a><span id="l6.194">     // Monday, Tuesday, Wednesday, Thursday</span>
<a href="#l6.195"></a><span id="l6.195">     for (let i = 2; i &lt; 6; i++) {</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineminus">-        controller.assertNode(</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineminus">-            lookupEventBox(view, EVENT_BOX, week, i, null, EVENTPATH)</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineminus">-        );</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineplus">+        controller.assertNode(lookupEventBox(view, EVENT_BOX, week, i, null, EVENTPATH));</span>
<a href="#l6.200"></a><span id="l6.200">     }</span>
<a href="#l6.201"></a><span id="l6.201"> </span>
<a href="#l6.202"></a><span id="l6.202">     // Saturday</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineminus">-    controller.assertNodeNotExist(</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineminus">-        getEventBoxPath(view, EVENT_BOX, week, 7, null, EVENTPATH)</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineminus">-    );</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineplus">+    controller.assertNodeNotExist(lookupEventBox(view, EVENT_BOX, week, 7, null, EVENTPATH));</span>
<a href="#l6.207"></a><span id="l6.207"> }</span>
<a href="#l6.208"></a><span id="l6.208"> </span>
<a href="#l6.209"></a><span id="l6.209"> function teardownTest(module) {</span>
<a href="#l6.210"></a><span id="l6.210">     deleteCalendars(controller, CALENDARNAME);</span>
<a href="#l6.211"></a><span id="l6.211"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/test/mozmill/cal-recurrence/testWeeklyUntilRecurrence.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/test/mozmill/cal-recurrence/testWeeklyUntilRecurrence.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,216 +1,201 @@</span>
<a href="#l7.4"></a><span id="l7.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.5"></a><span id="l7.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.6"></a><span id="l7.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8"> var MODULE_NAME = &quot;testWeeklyUntilRecurrence&quot;;</span>
<a href="#l7.9"></a><span id="l7.9"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineminus">-var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;window-helpers&quot;];</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;item-editing-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l7.12"></a><span id="l7.12"> </span>
<a href="#l7.13"></a><span id="l7.13"> var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;, null);</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-var SHORT_SLEEP, TIMEOUT_MODAL_DIALOG, CALENDARNAME, EVENTPATH, EVENT_BOX;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-var CANVAS_BOX, REC_DLG_DAYS, REC_DLG_ACCEPT, REC_DLG_UNTIL_INPUT;</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+var SHORT_SLEEP, TIMEOUT_MODAL_DIALOG, CALENDARNAME, EVENTPATH, EVENT_BOX, CANVAS_BOX;</span>
<a href="#l7.18"></a><span id="l7.18"> var helpersForController, handleOccurrencePrompt, switchToView, goToDate;</span>
<a href="#l7.19"></a><span id="l7.19"> var invokeEventDialog, viewForward, deleteCalendars, createCalendar, menulistSelect;</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+var REC_DLG_DAYS, REC_DLG_ACCEPT, REC_DLG_UNTIL_INPUT;</span>
<a href="#l7.21"></a><span id="l7.21"> var plan_for_modal_dialog, wait_for_modal_dialog;</span>
<a href="#l7.22"></a><span id="l7.22"> </span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-const ENDDATE = new Date(2009, 0, 26); // last Monday in month</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+const ENDDATE = new Date(2009, 0, 26); // Last Monday in month.</span>
<a href="#l7.25"></a><span id="l7.25"> const HOUR = 8;</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27"> function setupModule(module) {</span>
<a href="#l7.28"></a><span id="l7.28">     controller = mozmill.getMail3PaneController();</span>
<a href="#l7.29"></a><span id="l7.29">     ({</span>
<a href="#l7.30"></a><span id="l7.30">         SHORT_SLEEP,</span>
<a href="#l7.31"></a><span id="l7.31">         TIMEOUT_MODAL_DIALOG,</span>
<a href="#l7.32"></a><span id="l7.32">         CALENDARNAME,</span>
<a href="#l7.33"></a><span id="l7.33">         EVENTPATH,</span>
<a href="#l7.34"></a><span id="l7.34">         EVENT_BOX,</span>
<a href="#l7.35"></a><span id="l7.35">         CANVAS_BOX,</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-        REC_DLG_DAYS,</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-        REC_DLG_ACCEPT,</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-        REC_DLG_UNTIL_INPUT,</span>
<a href="#l7.39"></a><span id="l7.39">         helpersForController,</span>
<a href="#l7.40"></a><span id="l7.40">         handleOccurrencePrompt,</span>
<a href="#l7.41"></a><span id="l7.41">         switchToView,</span>
<a href="#l7.42"></a><span id="l7.42">         goToDate,</span>
<a href="#l7.43"></a><span id="l7.43">         invokeEventDialog,</span>
<a href="#l7.44"></a><span id="l7.44">         viewForward,</span>
<a href="#l7.45"></a><span id="l7.45">         deleteCalendars,</span>
<a href="#l7.46"></a><span id="l7.46">         createCalendar,</span>
<a href="#l7.47"></a><span id="l7.47">         menulistSelect</span>
<a href="#l7.48"></a><span id="l7.48">     } = collector.getModule(&quot;calendar-utils&quot;));</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-    collector.getModule(&quot;calendar-utils&quot;).setupModule();</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+    collector.getModule(&quot;calendar-utils&quot;).setupModule(controller);</span>
<a href="#l7.51"></a><span id="l7.51">     Object.assign(module, helpersForController(controller));</span>
<a href="#l7.52"></a><span id="l7.52"> </span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+    ({</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+        REC_DLG_DAYS,</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+        REC_DLG_ACCEPT,</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+        REC_DLG_UNTIL_INPUT</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+    } = collector.getModule(&quot;item-editing-helpers&quot;));</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+    collector.getModule(&quot;item-editing-helpers&quot;).setupModule(module);</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+</span>
<a href="#l7.60"></a><span id="l7.60">     ({ plan_for_modal_dialog, wait_for_modal_dialog } =</span>
<a href="#l7.61"></a><span id="l7.61">         collector.getModule(&quot;window-helpers&quot;)</span>
<a href="#l7.62"></a><span id="l7.62">     );</span>
<a href="#l7.63"></a><span id="l7.63"> </span>
<a href="#l7.64"></a><span id="l7.64">     createCalendar(controller, CALENDARNAME);</span>
<a href="#l7.65"></a><span id="l7.65"> }</span>
<a href="#l7.66"></a><span id="l7.66"> </span>
<a href="#l7.67"></a><span id="l7.67"> function testWeeklyUntilRecurrence() {</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-    controller.click(eid(&quot;calendar-tab-button&quot;));</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-    switchToView(controller, &quot;day&quot;);</span>
<a href="#l7.70"></a><span id="l7.70">     goToDate(controller, 2009, 1, 5); // Monday</span>
<a href="#l7.71"></a><span id="l7.71"> </span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-    // create weekly recurring event</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+    // Create weekly recurring event.</span>
<a href="#l7.74"></a><span id="l7.74">     let eventBox = lookupEventBox(&quot;day&quot;, CANVAS_BOX, null, 1, HOUR);</span>
<a href="#l7.75"></a><span id="l7.75">     invokeEventDialog(controller, eventBox, (event, iframe) =&gt; {</span>
<a href="#l7.76"></a><span id="l7.76">         let { eid: eventid } = helpersForController(event);</span>
<a href="#l7.77"></a><span id="l7.77"> </span>
<a href="#l7.78"></a><span id="l7.78">         plan_for_modal_dialog(&quot;Calendar:EventDialog:Recurrence&quot;, setRecurrence);</span>
<a href="#l7.79"></a><span id="l7.79">         event.waitForElement(eventid(&quot;item-repeat&quot;));</span>
<a href="#l7.80"></a><span id="l7.80">         menulistSelect(eventid(&quot;item-repeat&quot;), &quot;custom&quot;, event);</span>
<a href="#l7.81"></a><span id="l7.81">         wait_for_modal_dialog(&quot;Calendar:EventDialog:Recurrence&quot;, TIMEOUT_MODAL_DIALOG);</span>
<a href="#l7.82"></a><span id="l7.82"> </span>
<a href="#l7.83"></a><span id="l7.83">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l7.84"></a><span id="l7.84">     });</span>
<a href="#l7.85"></a><span id="l7.85"> </span>
<a href="#l7.86"></a><span id="l7.86" class="difflineminus">-    let box = getEventBoxPath(&quot;day&quot;, EVENT_BOX, null, 1, HOUR) + EVENTPATH;</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+    let box = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, EVENTPATH);</span>
<a href="#l7.88"></a><span id="l7.88"> </span>
<a href="#l7.89"></a><span id="l7.89" class="difflineminus">-    // check day view</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+    // Check day view.</span>
<a href="#l7.91"></a><span id="l7.91">     for (let week = 0; week &lt; 3; week++) {</span>
<a href="#l7.92"></a><span id="l7.92">         // Monday</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-        controller.waitForElement(lookup(box));</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+        controller.waitForElement(box);</span>
<a href="#l7.95"></a><span id="l7.95">         viewForward(controller, 2);</span>
<a href="#l7.96"></a><span id="l7.96"> </span>
<a href="#l7.97"></a><span id="l7.97">         // Wednesday</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineminus">-        controller.waitForElement(lookup(box));</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+        controller.waitForElement(box);</span>
<a href="#l7.100"></a><span id="l7.100">         viewForward(controller, 2);</span>
<a href="#l7.101"></a><span id="l7.101"> </span>
<a href="#l7.102"></a><span id="l7.102">         // Friday</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineminus">-        controller.waitForElement(lookup(box));</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+        controller.waitForElement(box);</span>
<a href="#l7.105"></a><span id="l7.105">         viewForward(controller, 3);</span>
<a href="#l7.106"></a><span id="l7.106">     }</span>
<a href="#l7.107"></a><span id="l7.107"> </span>
<a href="#l7.108"></a><span id="l7.108">     // Monday, last occurrence</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-    controller.waitForElement(lookup(box));</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+    controller.waitForElement(box);</span>
<a href="#l7.111"></a><span id="l7.111">     viewForward(controller, 2);</span>
<a href="#l7.112"></a><span id="l7.112"> </span>
<a href="#l7.113"></a><span id="l7.113">     // Wednesday</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineminus">-    controller.waitForElementNotPresent(lookup(box));</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+    controller.waitForElementNotPresent(box);</span>
<a href="#l7.116"></a><span id="l7.116"> </span>
<a href="#l7.117"></a><span id="l7.117" class="difflineminus">-    // check week view</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+    // Check week view.</span>
<a href="#l7.119"></a><span id="l7.119">     switchToView(controller, &quot;week&quot;);</span>
<a href="#l7.120"></a><span id="l7.120">     goToDate(controller, 2009, 1, 5);</span>
<a href="#l7.121"></a><span id="l7.121">     for (let week = 0; week &lt; 3; week++) {</span>
<a href="#l7.122"></a><span id="l7.122">         // Monday</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineminus">-            lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 2, HOUR, EVENTPATH)</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineminus">-        );</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 2, null, EVENTPATH));</span>
<a href="#l7.127"></a><span id="l7.127"> </span>
<a href="#l7.128"></a><span id="l7.128">         // Wednesday</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-            lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 4, HOUR, EVENTPATH)</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineminus">-        );</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 4, null, EVENTPATH));</span>
<a href="#l7.133"></a><span id="l7.133"> </span>
<a href="#l7.134"></a><span id="l7.134">         // Friday</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineminus">-            lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 6, HOUR, EVENTPATH)</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineminus">-        );</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 6, null, EVENTPATH));</span>
<a href="#l7.139"></a><span id="l7.139"> </span>
<a href="#l7.140"></a><span id="l7.140">         viewForward(controller, 1);</span>
<a href="#l7.141"></a><span id="l7.141">     }</span>
<a href="#l7.142"></a><span id="l7.142"> </span>
<a href="#l7.143"></a><span id="l7.143">     // Monday, last occurrence</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineminus">-    controller.waitForElement(</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineminus">-        lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 2, HOUR, EVENTPATH)</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineminus">-    );</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+    controller.waitForElement(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 2, null, EVENTPATH));</span>
<a href="#l7.148"></a><span id="l7.148">     // Wednesday</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineminus">-    controller.assertNodeNotExist(</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-        lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 4, HOUR, EVENTPATH)</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-    );</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 4, null, EVENTPATH));</span>
<a href="#l7.153"></a><span id="l7.153"> </span>
<a href="#l7.154"></a><span id="l7.154" class="difflineminus">-    // check multiweek view</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineplus">+    // Check multiweek view.</span>
<a href="#l7.156"></a><span id="l7.156">     switchToView(controller, &quot;multiweek&quot;);</span>
<a href="#l7.157"></a><span id="l7.157">     goToDate(controller, 2009, 1, 5);</span>
<a href="#l7.158"></a><span id="l7.158">     checkMultiWeekView(&quot;multiweek&quot;);</span>
<a href="#l7.159"></a><span id="l7.159"> </span>
<a href="#l7.160"></a><span id="l7.160" class="difflineminus">-    // check month view</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+    // Check month view.</span>
<a href="#l7.162"></a><span id="l7.162">     switchToView(controller, &quot;month&quot;);</span>
<a href="#l7.163"></a><span id="l7.163">     goToDate(controller, 2009, 1, 5);</span>
<a href="#l7.164"></a><span id="l7.164">     checkMultiWeekView(&quot;month&quot;);</span>
<a href="#l7.165"></a><span id="l7.165"> </span>
<a href="#l7.166"></a><span id="l7.166" class="difflineminus">-    // delete event</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineminus">-    box = getEventBoxPath(&quot;month&quot;, EVENT_BOX, 2, 2, null) + EVENTPATH;</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineminus">-    controller.click(lookup(box));</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineminus">-    handleOccurrencePrompt(controller, eid(&quot;month-view&quot;), &quot;delete&quot;, true, false);</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineminus">-    controller.waitForElementNotPresent(lookup(box));</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineplus">+    // Delete event.</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+    box = lookupEventBox(&quot;month&quot;, EVENT_BOX, 2, 2, null, EVENTPATH);</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+    controller.click(box);</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineplus">+    handleOccurrencePrompt(controller, eid(&quot;month-view&quot;), &quot;delete&quot;, true);</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+    controller.waitForElementNotPresent(box);</span>
<a href="#l7.176"></a><span id="l7.176"> }</span>
<a href="#l7.177"></a><span id="l7.177"> </span>
<a href="#l7.178"></a><span id="l7.178"> function setRecurrence(recurrence) {</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineminus">-    let { sleep: recsleep, lookup: reclookup, eid: recid } =</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineminus">-        helpersForController(recurrence);</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineplus">+    let { sleep: recsleep, lookup: reclookup, eid: recid } = helpersForController(recurrence);</span>
<a href="#l7.182"></a><span id="l7.182"> </span>
<a href="#l7.183"></a><span id="l7.183">     // weekly</span>
<a href="#l7.184"></a><span id="l7.184">     recurrence.waitForElement(recid(&quot;period-list&quot;));</span>
<a href="#l7.185"></a><span id="l7.185">     menulistSelect(recid(&quot;period-list&quot;), &quot;1&quot;, recurrence);</span>
<a href="#l7.186"></a><span id="l7.186"> </span>
<a href="#l7.187"></a><span id="l7.187">     let mon = cal.l10n.getDateFmtString(&quot;day.2.Mmm&quot;);</span>
<a href="#l7.188"></a><span id="l7.188">     let wed = cal.l10n.getDateFmtString(&quot;day.4.Mmm&quot;);</span>
<a href="#l7.189"></a><span id="l7.189">     let fri = cal.l10n.getDateFmtString(&quot;day.6.Mmm&quot;);</span>
<a href="#l7.190"></a><span id="l7.190"> </span>
<a href="#l7.191"></a><span id="l7.191" class="difflineminus">-    // starting from Monday so it should be checked. We have to wait a little,</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineplus">+    // Starting from Monday so it should be checked. We have to wait a little,</span>
<a href="#l7.193"></a><span id="l7.193">     // because the checkedstate is set in background by JS.</span>
<a href="#l7.194"></a><span id="l7.194">     recurrence.waitFor(() =&gt; {</span>
<a href="#l7.195"></a><span id="l7.195">         return recurrence.assertChecked(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${mon}&quot;}`));</span>
<a href="#l7.196"></a><span id="l7.196">     }, 30000);</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineminus">-    // starting from Monday so it should be checked</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+    // Starting from Monday so it should be checked.</span>
<a href="#l7.199"></a><span id="l7.199">     recurrence.assertChecked(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${mon}&quot;}`));</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineminus">-    // check Wednesday and Friday too</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+    // Check Wednesday and Friday too.</span>
<a href="#l7.202"></a><span id="l7.202">     recurrence.click(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${wed}&quot;}`));</span>
<a href="#l7.203"></a><span id="l7.203">     recurrence.click(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${fri}&quot;}`));</span>
<a href="#l7.204"></a><span id="l7.204"> </span>
<a href="#l7.205"></a><span id="l7.205" class="difflineminus">-    // set until date</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineplus">+    // Set until date.</span>
<a href="#l7.207"></a><span id="l7.207">     recurrence.radio(recid(&quot;recurrence-range-until&quot;));</span>
<a href="#l7.208"></a><span id="l7.208"> </span>
<a href="#l7.209"></a><span id="l7.209" class="difflineminus">-    // delete previous date</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineplus">+    // Delete previous date.</span>
<a href="#l7.211"></a><span id="l7.211">     let untilInput = reclookup(REC_DLG_UNTIL_INPUT);</span>
<a href="#l7.212"></a><span id="l7.212">     recurrence.keypress(untilInput, &quot;a&quot;, { accelKey: true });</span>
<a href="#l7.213"></a><span id="l7.213">     recurrence.keypress(untilInput, &quot;VK_DELETE&quot;, {});</span>
<a href="#l7.214"></a><span id="l7.214"> </span>
<a href="#l7.215"></a><span id="l7.215">     let dateFormatter = cal.getDateFormatter();</span>
<a href="#l7.216"></a><span id="l7.216"> </span>
<a href="#l7.217"></a><span id="l7.217" class="difflineminus">-    let endDateString = dateFormatter.formatDateShort(cal.dtz.jsDateToDateTime(ENDDATE, cal.dtz.floating));</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineplus">+    let endDateString = dateFormatter.formatDateShort(</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineplus">+        cal.dtz.jsDateToDateTime(ENDDATE, cal.dtz.floating)</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineplus">+    );</span>
<a href="#l7.221"></a><span id="l7.221">     recsleep(SHORT_SLEEP);</span>
<a href="#l7.222"></a><span id="l7.222">     recurrence.type(untilInput, endDateString);</span>
<a href="#l7.223"></a><span id="l7.223"> </span>
<a href="#l7.224"></a><span id="l7.224">     recsleep(SHORT_SLEEP);</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineminus">-    // Move focus to ensure the date is selected</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineplus">+    // Move focus to ensure the date is selected.</span>
<a href="#l7.227"></a><span id="l7.227">     recurrence.keypress(untilInput, &quot;VK_TAB&quot;, {});</span>
<a href="#l7.228"></a><span id="l7.228"> </span>
<a href="#l7.229"></a><span id="l7.229" class="difflineminus">-    // close dialog</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineplus">+    // Close dialog.</span>
<a href="#l7.231"></a><span id="l7.231">     recurrence.click(reclookup(REC_DLG_ACCEPT));</span>
<a href="#l7.232"></a><span id="l7.232"> }</span>
<a href="#l7.233"></a><span id="l7.233"> </span>
<a href="#l7.234"></a><span id="l7.234"> function checkMultiWeekView(view) {</span>
<a href="#l7.235"></a><span id="l7.235">     let startWeek = view == &quot;month&quot; ? 2 : 1;</span>
<a href="#l7.236"></a><span id="l7.236"> </span>
<a href="#l7.237"></a><span id="l7.237">     for (let week = startWeek; week &lt; startWeek + 3; week++) {</span>
<a href="#l7.238"></a><span id="l7.238">         // Monday</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineminus">-            lookupEventBox(view, EVENT_BOX, week, 2, null, EVENTPATH)</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineminus">-        );</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineplus">+        controller.waitForElement(lookupEventBox(view, EVENT_BOX, week, 2, null, EVENTPATH));</span>
<a href="#l7.243"></a><span id="l7.243">         // Wednesday</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineminus">-        controller.assertNode(</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineminus">-            lookupEventBox(view, EVENT_BOX, week, 4, null, EVENTPATH)</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineminus">-        );</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineplus">+        controller.assertNode(lookupEventBox(view, EVENT_BOX, week, 4, null, EVENTPATH));</span>
<a href="#l7.248"></a><span id="l7.248">         // Friday</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineminus">-        controller.assertNode(</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineminus">-            lookupEventBox(view, EVENT_BOX, week, 6, null, EVENTPATH)</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineminus">-        );</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineplus">+        controller.assertNode(lookupEventBox(view, EVENT_BOX, week, 6, null, EVENTPATH));</span>
<a href="#l7.253"></a><span id="l7.253">     }</span>
<a href="#l7.254"></a><span id="l7.254"> </span>
<a href="#l7.255"></a><span id="l7.255">     // Monday, last occurrence</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineminus">-    controller.assertNode(</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineminus">-        lookupEventBox(view, EVENT_BOX, startWeek + 3, 2, null, EVENTPATH)</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineminus">-    );</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineplus">+    controller.assertNode(lookupEventBox(view, EVENT_BOX, startWeek + 3, 2, null, EVENTPATH));</span>
<a href="#l7.260"></a><span id="l7.260"> </span>
<a href="#l7.261"></a><span id="l7.261">     // Wednesday</span>
<a href="#l7.262"></a><span id="l7.262">     controller.assertNodeNotExist(</span>
<a href="#l7.263"></a><span id="l7.263">         lookupEventBox(view, EVENT_BOX, startWeek + 3, 4, null, EVENTPATH)</span>
<a href="#l7.264"></a><span id="l7.264">     );</span>
<a href="#l7.265"></a><span id="l7.265"> }</span>
<a href="#l7.266"></a><span id="l7.266"> </span>
<a href="#l7.267"></a><span id="l7.267"> function teardownTest(module) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/test/mozmill/cal-recurrence/testWeeklyWithExceptionRecurrence.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/test/mozmill/cal-recurrence/testWeeklyWithExceptionRecurrence.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,296 +1,285 @@</span>
<a href="#l8.4"></a><span id="l8.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.5"></a><span id="l8.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.6"></a><span id="l8.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8"> var MODULE_NAME = &quot;testWeeklyWithExceptionRecurrence&quot;;</span>
<a href="#l8.9"></a><span id="l8.9"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineminus">-var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;window-helpers&quot;];</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;item-editing-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l8.12"></a><span id="l8.12"> </span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-var TIMEOUT_MODAL_DIALOG, CALENDARNAME, EVENTPATH, EVENT_BOX;</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-var CANVAS_BOX, REC_DLG_ACCEPT, REC_DLG_DAYS;</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+var TIMEOUT_MODAL_DIALOG, CALENDARNAME, EVENT_BOX, CANVAS_BOX;</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+var DAY_VIEW, WEEK_VIEW, EVENTPATH;</span>
<a href="#l8.17"></a><span id="l8.17"> var helpersForController, handleOccurrencePrompt, switchToView, goToDate;</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-var invokeEventDialog, viewForward, deleteCalendars, createCalendar, setData;</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+var invokeEventDialog, viewForward, deleteCalendars, createCalendar;</span>
<a href="#l8.20"></a><span id="l8.20"> var menulistSelect;</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+var REPEAT_DETAILS, REC_DLG_ACCEPT, REC_DLG_DAYS;</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+var helpersForEditUI, setData;</span>
<a href="#l8.23"></a><span id="l8.23"> var plan_for_modal_dialog, wait_for_modal_dialog;</span>
<a href="#l8.24"></a><span id="l8.24"> </span>
<a href="#l8.25"></a><span id="l8.25"> var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;, null);</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27"> const HOUR = 8;</span>
<a href="#l8.28"></a><span id="l8.28"> const STARTDATE = new Date(2009, 0, 6);</span>
<a href="#l8.29"></a><span id="l8.29"> </span>
<a href="#l8.30"></a><span id="l8.30"> function setupModule(module) {</span>
<a href="#l8.31"></a><span id="l8.31">     controller = mozmill.getMail3PaneController();</span>
<a href="#l8.32"></a><span id="l8.32">     ({</span>
<a href="#l8.33"></a><span id="l8.33">         TIMEOUT_MODAL_DIALOG,</span>
<a href="#l8.34"></a><span id="l8.34">         CALENDARNAME,</span>
<a href="#l8.35"></a><span id="l8.35">         EVENT_BOX,</span>
<a href="#l8.36"></a><span id="l8.36">         CANVAS_BOX,</span>
<a href="#l8.37"></a><span id="l8.37">         EVENTPATH,</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-        REC_DLG_ACCEPT,</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-        REC_DLG_DAYS,</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+        DAY_VIEW,</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+        WEEK_VIEW,</span>
<a href="#l8.42"></a><span id="l8.42">         helpersForController,</span>
<a href="#l8.43"></a><span id="l8.43">         handleOccurrencePrompt,</span>
<a href="#l8.44"></a><span id="l8.44">         switchToView,</span>
<a href="#l8.45"></a><span id="l8.45">         goToDate,</span>
<a href="#l8.46"></a><span id="l8.46">         invokeEventDialog,</span>
<a href="#l8.47"></a><span id="l8.47">         viewForward,</span>
<a href="#l8.48"></a><span id="l8.48">         deleteCalendars,</span>
<a href="#l8.49"></a><span id="l8.49">         createCalendar,</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-        setData,</span>
<a href="#l8.51"></a><span id="l8.51">         menulistSelect</span>
<a href="#l8.52"></a><span id="l8.52">     } = collector.getModule(&quot;calendar-utils&quot;));</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-    collector.getModule(&quot;calendar-utils&quot;).setupModule();</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+    collector.getModule(&quot;calendar-utils&quot;).setupModule(controller);</span>
<a href="#l8.55"></a><span id="l8.55">     Object.assign(module, helpersForController(controller));</span>
<a href="#l8.56"></a><span id="l8.56"> </span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+    ({</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+        REPEAT_DETAILS,</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+        REC_DLG_ACCEPT,</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+        REC_DLG_DAYS,</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+        helpersForEditUI,</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+        setData</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+    } = collector.getModule(&quot;item-editing-helpers&quot;));</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+    collector.getModule(&quot;item-editing-helpers&quot;).setupModule(module);</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+</span>
<a href="#l8.66"></a><span id="l8.66">     ({ plan_for_modal_dialog, wait_for_modal_dialog } =</span>
<a href="#l8.67"></a><span id="l8.67">         collector.getModule(&quot;window-helpers&quot;)</span>
<a href="#l8.68"></a><span id="l8.68">     );</span>
<a href="#l8.69"></a><span id="l8.69"> </span>
<a href="#l8.70"></a><span id="l8.70">     createCalendar(controller, CALENDARNAME);</span>
<a href="#l8.71"></a><span id="l8.71"> }</span>
<a href="#l8.72"></a><span id="l8.72"> </span>
<a href="#l8.73"></a><span id="l8.73"> function testWeeklyWithExceptionRecurrence() {</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-    controller.click(eid(&quot;calendar-tab-button&quot;));</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-    switchToView(controller, &quot;day&quot;);</span>
<a href="#l8.76"></a><span id="l8.76">     goToDate(controller, 2009, 1, 5);</span>
<a href="#l8.77"></a><span id="l8.77"> </span>
<a href="#l8.78"></a><span id="l8.78" class="difflineminus">-    // create weekly recurring event</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+    // Create weekly recurring event.</span>
<a href="#l8.80"></a><span id="l8.80">     let eventBox = lookupEventBox(&quot;day&quot;, CANVAS_BOX, null, 1, HOUR);</span>
<a href="#l8.81"></a><span id="l8.81">     invokeEventDialog(controller, eventBox, (event, iframe) =&gt; {</span>
<a href="#l8.82"></a><span id="l8.82">         let { eid: eventid } = helpersForController(event);</span>
<a href="#l8.83"></a><span id="l8.83"> </span>
<a href="#l8.84"></a><span id="l8.84">         event.waitForElement(eventid(&quot;item-repeat&quot;));</span>
<a href="#l8.85"></a><span id="l8.85">         plan_for_modal_dialog(&quot;Calendar:EventDialog:Recurrence&quot;, setRecurrence);</span>
<a href="#l8.86"></a><span id="l8.86">         menulistSelect(eventid(&quot;item-repeat&quot;), &quot;custom&quot;, event);</span>
<a href="#l8.87"></a><span id="l8.87">         wait_for_modal_dialog(&quot;Calendar:EventDialog:Recurrence&quot;, TIMEOUT_MODAL_DIALOG);</span>
<a href="#l8.88"></a><span id="l8.88"> </span>
<a href="#l8.89"></a><span id="l8.89">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l8.90"></a><span id="l8.90">     });</span>
<a href="#l8.91"></a><span id="l8.91"> </span>
<a href="#l8.92"></a><span id="l8.92" class="difflineminus">-    // move 5th January occurrence to 6th January</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineminus">-    eventBox = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, HOUR, EVENTPATH);</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineminus">-    handleOccurrencePrompt(controller, eventBox, &quot;modify&quot;, false, false);</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+    // Move 5th January occurrence to 6th January.</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+    eventBox = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, EVENTPATH);</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+    handleOccurrencePrompt(controller, eventBox, &quot;modify&quot;, false);</span>
<a href="#l8.98"></a><span id="l8.98">     invokeEventDialog(controller, null, (event, iframe) =&gt; {</span>
<a href="#l8.99"></a><span id="l8.99">         let { eid: eventid } = helpersForController(event);</span>
<a href="#l8.100"></a><span id="l8.100"> </span>
<a href="#l8.101"></a><span id="l8.101">         setData(event, iframe, { startdate: STARTDATE, enddate: STARTDATE });</span>
<a href="#l8.102"></a><span id="l8.102">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l8.103"></a><span id="l8.103">     });</span>
<a href="#l8.104"></a><span id="l8.104"> </span>
<a href="#l8.105"></a><span id="l8.105" class="difflineminus">-    // change recurrence rule</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+    // Change recurrence rule.</span>
<a href="#l8.107"></a><span id="l8.107">     goToDate(controller, 2009, 1, 7);</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineminus">-    eventBox = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, HOUR, EVENTPATH);</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineminus">-    handleOccurrencePrompt(controller, eventBox, &quot;modify&quot;, true, false);</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+    eventBox = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, EVENTPATH);</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+    handleOccurrencePrompt(controller, eventBox, &quot;modify&quot;, true);</span>
<a href="#l8.112"></a><span id="l8.112">     invokeEventDialog(controller, null, (event, iframe) =&gt; {</span>
<a href="#l8.113"></a><span id="l8.113">         let { eid: eventid } = helpersForController(event);</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineminus">-        let { lookup: iframelookup } = helpersForController(iframe);</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+        let { iframeLookup } = helpersForEditUI(iframe);</span>
<a href="#l8.116"></a><span id="l8.116"> </span>
<a href="#l8.117"></a><span id="l8.117">         event.waitForElement(eventid(&quot;item-repeat&quot;));</span>
<a href="#l8.118"></a><span id="l8.118">         plan_for_modal_dialog(&quot;Calendar:EventDialog:Recurrence&quot;, changeRecurrence);</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-        event.click(iframelookup(`</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineminus">-            /id(&quot;calendar-event-dialog-inner&quot;)/id(&quot;event-grid&quot;)/</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineminus">-            id(&quot;event-grid-rows&quot;)/id(&quot;event-grid-recurrence-row&quot;)/</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineminus">-            id(&quot;event-grid-recurrence-picker-box&quot;)/id(&quot;repeat-deck&quot;)/</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineminus">-            id(&quot;repeat-details&quot;)/[0]</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineminus">-        `));</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+        event.click(iframeLookup(REPEAT_DETAILS));</span>
<a href="#l8.126"></a><span id="l8.126">         wait_for_modal_dialog(&quot;Calendar:EventDialog:Recurrence&quot;, TIMEOUT_MODAL_DIALOG);</span>
<a href="#l8.127"></a><span id="l8.127"> </span>
<a href="#l8.128"></a><span id="l8.128">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l8.129"></a><span id="l8.129">     });</span>
<a href="#l8.130"></a><span id="l8.130"> </span>
<a href="#l8.131"></a><span id="l8.131" class="difflineminus">-    // check two weeks</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+    // Check two weeks.</span>
<a href="#l8.133"></a><span id="l8.133">     // day view</span>
<a href="#l8.134"></a><span id="l8.134">     switchToView(controller, &quot;day&quot;);</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineminus">-    let path = getEventBoxPath(&quot;day&quot;, EVENT_BOX, null, 1, HOUR) + EVENTPATH;</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+    let path = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, EVENTPATH);</span>
<a href="#l8.137"></a><span id="l8.137"> </span>
<a href="#l8.138"></a><span id="l8.138">     goToDate(controller, 2009, 1, 5);</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineminus">-    controller.waitForElementNotPresent(lookup(path));</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+    controller.waitForElementNotPresent(path);</span>
<a href="#l8.141"></a><span id="l8.141"> </span>
<a href="#l8.142"></a><span id="l8.142">     viewForward(controller, 1);</span>
<a href="#l8.143"></a><span id="l8.143">     let tuesPath = `</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;tabmail&quot;)/id(&quot;tabmail-tabbox&quot;)/</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineminus">-        id(&quot;tabpanelcontainer&quot;)/id(&quot;calendarTabPanel&quot;)/id(&quot;calendarContent&quot;)/</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineminus">-        id(&quot;calendarDisplayDeck&quot;)/id(&quot;calendar-view-box&quot;)/id(&quot;view-deck&quot;)/</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineminus">-        id(&quot;day-view&quot;)/anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;scrollbox&quot;})/</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+        ${DAY_VIEW}/anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;scrollbox&quot;})/</span>
<a href="#l8.149"></a><span id="l8.149">         anon({&quot;anonid&quot;:&quot;daybox&quot;})/[0]/anon({&quot;anonid&quot;:&quot;boxstack&quot;})/</span>
<a href="#l8.150"></a><span id="l8.150">         anon({&quot;anonid&quot;:&quot;topbox&quot;})/{&quot;flex&quot;:&quot;1&quot;}/{&quot;flex&quot;:&quot;1&quot;}/[eventIndex]</span>
<a href="#l8.151"></a><span id="l8.151">     `;</span>
<a href="#l8.152"></a><span id="l8.152"> </span>
<a href="#l8.153"></a><span id="l8.153" class="difflineminus">-    // assert exactly two</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+    // Assert exactly two.</span>
<a href="#l8.155"></a><span id="l8.155">     controller.waitForElement(lookup(tuesPath.replace(&quot;eventIndex&quot;, &quot;0&quot;) + EVENTPATH));</span>
<a href="#l8.156"></a><span id="l8.156">     controller.assertNode(lookup(tuesPath.replace(&quot;eventIndex&quot;, &quot;1&quot;) + EVENTPATH));</span>
<a href="#l8.157"></a><span id="l8.157">     controller.assertNodeNotExist(lookup(tuesPath.replace(&quot;eventIndex&quot;, &quot;2&quot;) + EVENTPATH));</span>
<a href="#l8.158"></a><span id="l8.158"> </span>
<a href="#l8.159"></a><span id="l8.159">     viewForward(controller, 1);</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineminus">-    controller.waitForElement(lookup(path));</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineplus">+    controller.waitForElement(path);</span>
<a href="#l8.162"></a><span id="l8.162">     viewForward(controller, 1);</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineminus">-    controller.waitForElementNotPresent(lookup(path));</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+    controller.waitForElementNotPresent(path);</span>
<a href="#l8.165"></a><span id="l8.165">     viewForward(controller, 1);</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineminus">-    controller.waitForElement(lookup(path));</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineplus">+    controller.waitForElement(path);</span>
<a href="#l8.168"></a><span id="l8.168">     viewForward(controller, 1);</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineminus">-    controller.waitForElementNotPresent(lookup(path));</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+    controller.waitForElementNotPresent(path);</span>
<a href="#l8.171"></a><span id="l8.171">     viewForward(controller, 1);</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineminus">-    controller.waitForElementNotPresent(lookup(path));</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+    controller.waitForElementNotPresent(path);</span>
<a href="#l8.174"></a><span id="l8.174"> </span>
<a href="#l8.175"></a><span id="l8.175">     // next week</span>
<a href="#l8.176"></a><span id="l8.176">     viewForward(controller, 1);</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineminus">-    controller.waitForElement(lookup(path));</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+    controller.waitForElement(path);</span>
<a href="#l8.179"></a><span id="l8.179">     viewForward(controller, 1);</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineminus">-    controller.waitForElement(lookup(path));</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineplus">+    controller.waitForElement(path);</span>
<a href="#l8.182"></a><span id="l8.182">     viewForward(controller, 1);</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineminus">-    controller.waitForElement(lookup(path));</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineplus">+    controller.waitForElement(path);</span>
<a href="#l8.185"></a><span id="l8.185">     viewForward(controller, 1);</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineminus">-    controller.waitForElementNotPresent(lookup(path));</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineplus">+    controller.waitForElementNotPresent(path);</span>
<a href="#l8.188"></a><span id="l8.188">     viewForward(controller, 1);</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineminus">-    controller.waitForElement(lookup(path));</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineplus">+    controller.waitForElement(path);</span>
<a href="#l8.191"></a><span id="l8.191">     viewForward(controller, 1);</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineminus">-    controller.waitForElementNotPresent(lookup(path));</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineplus">+    controller.waitForElementNotPresent(path);</span>
<a href="#l8.194"></a><span id="l8.194"> </span>
<a href="#l8.195"></a><span id="l8.195">     // week view</span>
<a href="#l8.196"></a><span id="l8.196">     switchToView(controller, &quot;week&quot;);</span>
<a href="#l8.197"></a><span id="l8.197">     goToDate(controller, 2009, 1, 5);</span>
<a href="#l8.198"></a><span id="l8.198"> </span>
<a href="#l8.199"></a><span id="l8.199">     tuesPath = `</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;tabmail&quot;)/id(&quot;tabmail-tabbox&quot;)/</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineminus">-        id(&quot;tabpanelcontainer&quot;)/id(&quot;calendarTabPanel&quot;)/id(&quot;calendarContent&quot;)/</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineminus">-        id(&quot;calendarDisplayDeck&quot;)/id(&quot;calendar-view-box&quot;)/id(&quot;view-deck&quot;)/</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineminus">-        id(&quot;week-view&quot;)/anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;scrollbox&quot;})/</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;daybox&quot;})/[dayIndex]/anon({&quot;anonid&quot;:&quot;boxstack&quot;})/</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineplus">+        ${WEEK_VIEW}/anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;scrollbox&quot;})/</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineplus">+        anon({&quot;anonid&quot;:&quot;daybox&quot;})/[2]/anon({&quot;anonid&quot;:&quot;boxstack&quot;})/</span>
<a href="#l8.207"></a><span id="l8.207">         anon({&quot;anonid&quot;:&quot;topbox&quot;})/{&quot;flex&quot;:&quot;1&quot;}/{&quot;flex&quot;:&quot;1&quot;}/[eventIndex]</span>
<a href="#l8.208"></a><span id="l8.208">     `;</span>
<a href="#l8.209"></a><span id="l8.209"> </span>
<a href="#l8.210"></a><span id="l8.210" class="difflineminus">-    // assert exactly two</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineminus">-    controller.waitForElement(lookup(</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineminus">-        tuesPath.replace(&quot;dayIndex&quot;, &quot;2&quot;).replace(&quot;eventIndex&quot;, &quot;0&quot;) + EVENTPATH</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineminus">-    ));</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineminus">-    controller.assertNode(lookup(</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineminus">-        tuesPath.replace(&quot;dayIndex&quot;, &quot;2&quot;).replace(&quot;eventIndex&quot;, &quot;1&quot;) + EVENTPATH</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineminus">-    ));</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineminus">-    controller.assertNodeNotExist(lookup(</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineminus">-        tuesPath.replace(&quot;dayIndex&quot;, &quot;2&quot;).replace(&quot;eventIndex&quot;, &quot;2&quot;) + EVENTPATH</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineminus">-    ));</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineplus">+    // Assert exactly two.</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineplus">+    controller.waitForElement(lookup(tuesPath.replace(&quot;eventIndex&quot;, &quot;0&quot;) + EVENTPATH));</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineplus">+    controller.assertNode(lookup(tuesPath.replace(&quot;eventIndex&quot;, &quot;1&quot;) + EVENTPATH));</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineplus">+    controller.assertNodeNotExist(lookup(tuesPath.replace(&quot;eventIndex&quot;, &quot;2&quot;) + EVENTPATH));</span>
<a href="#l8.224"></a><span id="l8.224"> </span>
<a href="#l8.225"></a><span id="l8.225" class="difflineminus">-    // wait for the last occurrence because this appears latest.</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineminus">-    controller.waitForElement(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 6, HOUR));</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineminus">-    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 1, HOUR));</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineminus">-    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 2, HOUR));</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineminus">-    controller.assertNode(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 4, HOUR));</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineminus">-    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 5, HOUR));</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineminus">-    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 7, HOUR));</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineplus">+    // Wait for the last occurrence because this appears last.</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineplus">+    controller.waitForElement(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 6, null));</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineplus">+    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 1, null));</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineplus">+    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 2, null));</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineplus">+    controller.assertNode(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 4, null));</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineplus">+    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 5, null));</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineplus">+    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 7, null));</span>
<a href="#l8.239"></a><span id="l8.239"> </span>
<a href="#l8.240"></a><span id="l8.240">     viewForward(controller, 1);</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineminus">-    controller.waitForElement(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 6, HOUR));</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineminus">-    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 1, HOUR));</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineminus">-    controller.assertNode(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 2, HOUR));</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineminus">-    controller.assertNode(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 3, HOUR));</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineminus">-    controller.assertNode(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 4, HOUR));</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineminus">-    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 5, HOUR));</span>
<a href="#l8.247"></a><span id="l8.247" class="difflineminus">-    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 7, HOUR));</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineplus">+    controller.waitForElement(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 6, null));</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineplus">+    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 1, null));</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineplus">+    controller.assertNode(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 2, null));</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineplus">+    controller.assertNode(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 3, null));</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineplus">+    controller.assertNode(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 4, null));</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineplus">+    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 5, null));</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineplus">+    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 7, null));</span>
<a href="#l8.255"></a><span id="l8.255"> </span>
<a href="#l8.256"></a><span id="l8.256">     // multiweek view</span>
<a href="#l8.257"></a><span id="l8.257">     switchToView(controller, &quot;multiweek&quot;);</span>
<a href="#l8.258"></a><span id="l8.258">     goToDate(controller, 2009, 1, 5);</span>
<a href="#l8.259"></a><span id="l8.259">     checkMultiWeekView(&quot;multiweek&quot;);</span>
<a href="#l8.260"></a><span id="l8.260"> </span>
<a href="#l8.261"></a><span id="l8.261">     // month view</span>
<a href="#l8.262"></a><span id="l8.262">     switchToView(controller, &quot;month&quot;);</span>
<a href="#l8.263"></a><span id="l8.263">     checkMultiWeekView(&quot;month&quot;);</span>
<a href="#l8.264"></a><span id="l8.264"> </span>
<a href="#l8.265"></a><span id="l8.265">     // delete event</span>
<a href="#l8.266"></a><span id="l8.266">     switchToView(controller, &quot;day&quot;);</span>
<a href="#l8.267"></a><span id="l8.267">     goToDate(controller, 2009, 1, 12);</span>
<a href="#l8.268"></a><span id="l8.268" class="difflineminus">-    path = getEventBoxPath(&quot;day&quot;, EVENT_BOX, null, 1, HOUR) + EVENTPATH;</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineminus">-    controller.click(lookup(path));</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineminus">-    handleOccurrencePrompt(controller, eid(&quot;day-view&quot;), &quot;delete&quot;, true, false);</span>
<a href="#l8.271"></a><span id="l8.271" class="difflineminus">-    controller.waitForElementNotPresent(lookup(path));</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineplus">+    path = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, EVENTPATH);</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineplus">+    controller.click(path);</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineplus">+    handleOccurrencePrompt(controller, eid(&quot;day-view&quot;), &quot;delete&quot;, true);</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineplus">+    controller.waitForElementNotPresent(path);</span>
<a href="#l8.276"></a><span id="l8.276"> }</span>
<a href="#l8.277"></a><span id="l8.277"> </span>
<a href="#l8.278"></a><span id="l8.278"> function setRecurrence(recurrence) {</span>
<a href="#l8.279"></a><span id="l8.279">     let { lookup: reclookup, eid: recid } = helpersForController(recurrence);</span>
<a href="#l8.280"></a><span id="l8.280"> </span>
<a href="#l8.281"></a><span id="l8.281">     // weekly</span>
<a href="#l8.282"></a><span id="l8.282">     menulistSelect(recid(&quot;period-list&quot;), &quot;1&quot;, recurrence);</span>
<a href="#l8.283"></a><span id="l8.283"> </span>
<a href="#l8.284"></a><span id="l8.284">     let mon = cal.l10n.getDateFmtString(&quot;day.2.Mmm&quot;);</span>
<a href="#l8.285"></a><span id="l8.285">     let wed = cal.l10n.getDateFmtString(&quot;day.4.Mmm&quot;);</span>
<a href="#l8.286"></a><span id="l8.286">     let fri = cal.l10n.getDateFmtString(&quot;day.6.Mmm&quot;);</span>
<a href="#l8.287"></a><span id="l8.287"> </span>
<a href="#l8.288"></a><span id="l8.288" class="difflineminus">-    // starting from Monday so it should be checked. We have to wait a little,</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineplus">+    // Starting from Monday so it should be checked. We have to wait a little,</span>
<a href="#l8.290"></a><span id="l8.290">     // because the checkedstate is set in background by JS.</span>
<a href="#l8.291"></a><span id="l8.291">     recurrence.waitFor(() =&gt; {</span>
<a href="#l8.292"></a><span id="l8.292">         return recurrence.assertChecked(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${mon}&quot;}`));</span>
<a href="#l8.293"></a><span id="l8.293">     }, 10000);</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineminus">-    // check Wednesday and Friday too</span>
<a href="#l8.295"></a><span id="l8.295" class="difflineplus">+    // Check Wednesday and Friday too.</span>
<a href="#l8.296"></a><span id="l8.296">     recurrence.click(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${wed}&quot;}`));</span>
<a href="#l8.297"></a><span id="l8.297">     recurrence.assertChecked(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${wed}&quot;}`));</span>
<a href="#l8.298"></a><span id="l8.298">     recurrence.click(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${fri}&quot;}`));</span>
<a href="#l8.299"></a><span id="l8.299">     recurrence.assertChecked(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${fri}&quot;}`));</span>
<a href="#l8.300"></a><span id="l8.300"> </span>
<a href="#l8.301"></a><span id="l8.301" class="difflineminus">-    // close dialog</span>
<a href="#l8.302"></a><span id="l8.302" class="difflineplus">+    // Close dialog.</span>
<a href="#l8.303"></a><span id="l8.303">     recurrence.click(reclookup(REC_DLG_ACCEPT));</span>
<a href="#l8.304"></a><span id="l8.304"> }</span>
<a href="#l8.305"></a><span id="l8.305"> </span>
<a href="#l8.306"></a><span id="l8.306"> function changeRecurrence(recurrence) {</span>
<a href="#l8.307"></a><span id="l8.307">     let { lookup: reclookup, eid: recid } = helpersForController(recurrence);</span>
<a href="#l8.308"></a><span id="l8.308"> </span>
<a href="#l8.309"></a><span id="l8.309">     // weekly</span>
<a href="#l8.310"></a><span id="l8.310">     menulistSelect(recid(&quot;period-list&quot;), &quot;1&quot;, recurrence);</span>
<a href="#l8.311"></a><span id="l8.311"> </span>
<a href="#l8.312"></a><span id="l8.312">     let mon = cal.l10n.getDateFmtString(&quot;day.2.Mmm&quot;);</span>
<a href="#l8.313"></a><span id="l8.313">     let tue = cal.l10n.getDateFmtString(&quot;day.3.Mmm&quot;);</span>
<a href="#l8.314"></a><span id="l8.314">     let wed = cal.l10n.getDateFmtString(&quot;day.4.Mmm&quot;);</span>
<a href="#l8.315"></a><span id="l8.315">     let fri = cal.l10n.getDateFmtString(&quot;day.6.Mmm&quot;);</span>
<a href="#l8.316"></a><span id="l8.316"> </span>
<a href="#l8.317"></a><span id="l8.317" class="difflineminus">-    // check old rule</span>
<a href="#l8.318"></a><span id="l8.318" class="difflineminus">-    // starting from Monday so it should be checked. We have to wait a little,</span>
<a href="#l8.319"></a><span id="l8.319" class="difflineplus">+    // Check old rule.</span>
<a href="#l8.320"></a><span id="l8.320" class="difflineplus">+    // Starting from Monday so it should be checked. We have to wait a little,</span>
<a href="#l8.321"></a><span id="l8.321">     // because the checkedstate is set in background by JS.</span>
<a href="#l8.322"></a><span id="l8.322">     recurrence.waitFor(() =&gt; {</span>
<a href="#l8.323"></a><span id="l8.323">         return recurrence.assertChecked(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${mon}&quot;}`));</span>
<a href="#l8.324"></a><span id="l8.324">     }, 10000);</span>
<a href="#l8.325"></a><span id="l8.325">     recurrence.assertChecked(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${wed}&quot;}`));</span>
<a href="#l8.326"></a><span id="l8.326">     recurrence.assertChecked(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${fri}&quot;}`));</span>
<a href="#l8.327"></a><span id="l8.327"> </span>
<a href="#l8.328"></a><span id="l8.328" class="difflineminus">-    // check Tuesday</span>
<a href="#l8.329"></a><span id="l8.329" class="difflineplus">+    // Check Tuesday.</span>
<a href="#l8.330"></a><span id="l8.330">     recurrence.click(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${tue}&quot;}`));</span>
<a href="#l8.331"></a><span id="l8.331">     recurrence.assertChecked(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${tue}&quot;}`));</span>
<a href="#l8.332"></a><span id="l8.332"> </span>
<a href="#l8.333"></a><span id="l8.333" class="difflineminus">-    // close dialog</span>
<a href="#l8.334"></a><span id="l8.334" class="difflineplus">+    // Close dialog.</span>
<a href="#l8.335"></a><span id="l8.335">     recurrence.click(reclookup(REC_DLG_ACCEPT));</span>
<a href="#l8.336"></a><span id="l8.336"> }</span>
<a href="#l8.337"></a><span id="l8.337"> </span>
<a href="#l8.338"></a><span id="l8.338"> function checkMultiWeekView(view) {</span>
<a href="#l8.339"></a><span id="l8.339">     let startWeek = view == &quot;multiweek&quot; ? 1 : 2;</span>
<a href="#l8.340"></a><span id="l8.340">     let assertNodeLookup = (...args) =&gt; {</span>
<a href="#l8.341"></a><span id="l8.341">         return controller.assertNode(lookupEventBox(...args));</span>
<a href="#l8.342"></a><span id="l8.342">     };</span>
<a href="#l8.343"></a><span id="l8.343">     let assertNodeNotExistLookup = (...args) =&gt; {</span>
<a href="#l8.344"></a><span id="l8.344">         return controller.assertNodeNotExist(lookupEventBox(...args));</span>
<a href="#l8.345"></a><span id="l8.345">     };</span>
<a href="#l8.346"></a><span id="l8.346"> </span>
<a href="#l8.347"></a><span id="l8.347" class="difflineminus">-    // wait for the first items, then check the ones not to be present</span>
<a href="#l8.348"></a><span id="l8.348" class="difflineminus">-    // assert exactly two</span>
<a href="#l8.349"></a><span id="l8.349" class="difflineminus">-    controller.waitForElement(</span>
<a href="#l8.350"></a><span id="l8.350" class="difflineminus">-        lookupEventBox(view, EVENT_BOX, startWeek, 3, HOUR, &quot;/[0]&quot;)</span>
<a href="#l8.351"></a><span id="l8.351" class="difflineminus">-    );</span>
<a href="#l8.352"></a><span id="l8.352" class="difflineminus">-    assertNodeLookup(view, EVENT_BOX, startWeek, 3, HOUR, &quot;/[1]&quot;);</span>
<a href="#l8.353"></a><span id="l8.353" class="difflineminus">-    assertNodeNotExistLookup(view, EVENT_BOX, startWeek, 3, HOUR, &quot;/[2]&quot;);</span>
<a href="#l8.354"></a><span id="l8.354" class="difflineplus">+    // Wait for the first items, then check the ones not to be present.</span>
<a href="#l8.355"></a><span id="l8.355" class="difflineplus">+    // ASssert exactly two.</span>
<a href="#l8.356"></a><span id="l8.356" class="difflineplus">+    controller.waitForElement(lookupEventBox(view, EVENT_BOX, startWeek, 3, null, &quot;/[0]&quot;));</span>
<a href="#l8.357"></a><span id="l8.357" class="difflineplus">+    assertNodeLookup(view, EVENT_BOX, startWeek, 3, null, &quot;/[1]&quot;);</span>
<a href="#l8.358"></a><span id="l8.358" class="difflineplus">+    assertNodeNotExistLookup(view, EVENT_BOX, startWeek, 3, null, &quot;/[2]&quot;);</span>
<a href="#l8.359"></a><span id="l8.359">     // Then check no item on the 5th.</span>
<a href="#l8.360"></a><span id="l8.360" class="difflineminus">-    assertNodeNotExistLookup(view, EVENT_BOX, startWeek, 2, HOUR, EVENTPATH);</span>
<a href="#l8.361"></a><span id="l8.361" class="difflineminus">-    assertNodeNotExistLookup(view, EVENT_BOX, startWeek, 3, HOUR, &quot;/[2]&quot;);</span>
<a href="#l8.362"></a><span id="l8.362" class="difflineminus">-    assertNodeLookup(view, EVENT_BOX, startWeek, 4, HOUR, EVENTPATH);</span>
<a href="#l8.363"></a><span id="l8.363" class="difflineminus">-    assertNodeNotExistLookup(view, EVENT_BOX, startWeek, 5, HOUR, EVENTPATH);</span>
<a href="#l8.364"></a><span id="l8.364" class="difflineminus">-    assertNodeLookup(view, EVENT_BOX, startWeek, 6, HOUR, EVENTPATH);</span>
<a href="#l8.365"></a><span id="l8.365" class="difflineminus">-    assertNodeNotExistLookup(view, EVENT_BOX, startWeek, 7, HOUR, EVENTPATH);</span>
<a href="#l8.366"></a><span id="l8.366" class="difflineplus">+    assertNodeNotExistLookup(view, EVENT_BOX, startWeek, 2, null, EVENTPATH);</span>
<a href="#l8.367"></a><span id="l8.367" class="difflineplus">+    assertNodeNotExistLookup(view, EVENT_BOX, startWeek, 3, null, &quot;/[2]&quot;);</span>
<a href="#l8.368"></a><span id="l8.368" class="difflineplus">+    assertNodeLookup(view, EVENT_BOX, startWeek, 4, null, EVENTPATH);</span>
<a href="#l8.369"></a><span id="l8.369" class="difflineplus">+    assertNodeNotExistLookup(view, EVENT_BOX, startWeek, 5, null, EVENTPATH);</span>
<a href="#l8.370"></a><span id="l8.370" class="difflineplus">+    assertNodeLookup(view, EVENT_BOX, startWeek, 6, null, EVENTPATH);</span>
<a href="#l8.371"></a><span id="l8.371" class="difflineplus">+    assertNodeNotExistLookup(view, EVENT_BOX, startWeek, 7, null, EVENTPATH);</span>
<a href="#l8.372"></a><span id="l8.372"> </span>
<a href="#l8.373"></a><span id="l8.373" class="difflineminus">-    assertNodeNotExistLookup(view, EVENT_BOX, startWeek + 1, 1, HOUR, EVENTPATH);</span>
<a href="#l8.374"></a><span id="l8.374" class="difflineminus">-    assertNodeLookup(view, EVENT_BOX, startWeek + 1, 2, HOUR, EVENTPATH);</span>
<a href="#l8.375"></a><span id="l8.375" class="difflineminus">-    assertNodeLookup(view, EVENT_BOX, startWeek + 1, 3, HOUR, EVENTPATH);</span>
<a href="#l8.376"></a><span id="l8.376" class="difflineminus">-    assertNodeLookup(view, EVENT_BOX, startWeek + 1, 4, HOUR, EVENTPATH);</span>
<a href="#l8.377"></a><span id="l8.377" class="difflineminus">-    assertNodeNotExistLookup(view, EVENT_BOX, startWeek + 1, 5, HOUR, EVENTPATH);</span>
<a href="#l8.378"></a><span id="l8.378" class="difflineminus">-    assertNodeLookup(view, EVENT_BOX, startWeek + 1, 6, HOUR, EVENTPATH);</span>
<a href="#l8.379"></a><span id="l8.379" class="difflineminus">-    assertNodeNotExistLookup(view, EVENT_BOX, startWeek + 1, 7, HOUR, EVENTPATH);</span>
<a href="#l8.380"></a><span id="l8.380" class="difflineplus">+    assertNodeNotExistLookup(view, EVENT_BOX, startWeek + 1, 1, null, EVENTPATH);</span>
<a href="#l8.381"></a><span id="l8.381" class="difflineplus">+    assertNodeLookup(view, EVENT_BOX, startWeek + 1, 2, null, EVENTPATH);</span>
<a href="#l8.382"></a><span id="l8.382" class="difflineplus">+    assertNodeLookup(view, EVENT_BOX, startWeek + 1, 3, null, EVENTPATH);</span>
<a href="#l8.383"></a><span id="l8.383" class="difflineplus">+    assertNodeLookup(view, EVENT_BOX, startWeek + 1, 4, null, EVENTPATH);</span>
<a href="#l8.384"></a><span id="l8.384" class="difflineplus">+    assertNodeNotExistLookup(view, EVENT_BOX, startWeek + 1, 5, null, EVENTPATH);</span>
<a href="#l8.385"></a><span id="l8.385" class="difflineplus">+    assertNodeLookup(view, EVENT_BOX, startWeek + 1, 6, null, EVENTPATH);</span>
<a href="#l8.386"></a><span id="l8.386" class="difflineplus">+    assertNodeNotExistLookup(view, EVENT_BOX, startWeek + 1, 7, null, EVENTPATH);</span>
<a href="#l8.387"></a><span id="l8.387"> }</span>
<a href="#l8.388"></a><span id="l8.388"> </span>
<a href="#l8.389"></a><span id="l8.389"> function teardownTest(module) {</span>
<a href="#l8.390"></a><span id="l8.390">     deleteCalendars(controller, CALENDARNAME);</span>
<a href="#l8.391"></a><span id="l8.391"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/test/mozmill/eventDialog/testEventDialog.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/test/mozmill/eventDialog/testEventDialog.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,309 +1,234 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.5"></a><span id="l9.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.6"></a><span id="l9.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+var MODULE_NAME = &quot;testEventDialog&quot;;</span>
<a href="#l9.9"></a><span id="l9.9"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineminus">-var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;window-helpers&quot;];</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;item-editing-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l9.12"></a><span id="l9.12"> </span>
<a href="#l9.13"></a><span id="l9.13"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l9.14"></a><span id="l9.14"> var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;, null);</span>
<a href="#l9.15"></a><span id="l9.15"> </span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+var TIMEOUT_MODAL_DIALOG, CALENDARNAME, EVENTPATH, EVENT_BOX;</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+var helpersForController, handleOccurrencePrompt, goToDate, lookupEventBox;</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+var invokeEventDialog, checkAlarmIcon, deleteCalendars, createCalendar;</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+var EVENT_TABPANELS, ATTENDEES_ROW;</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+var helpersForEditUI, setData;</span>
<a href="#l9.21"></a><span id="l9.21"> var plan_for_modal_dialog, wait_for_modal_dialog;</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-var helpersForController, invokeEventDialog, createCalendar, deleteCalendars;</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-var handleAddingAttachment, handleOccurrencePrompt;</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-var goToDate, setData, lookupEventBox;</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-var CALENDARNAME, TIMEOUT_MODAL_DIALOG;</span>
<a href="#l9.26"></a><span id="l9.26"> </span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-var eventTitle = &quot;Event&quot;;</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-var eventLocation = &quot;Location&quot;;</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-var eventDescription = &quot;Event Description&quot;;</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-var eventAttendee = &quot;foo@bar.com&quot;;</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-var eventUrl = &quot;http://mozilla.org&quot;;</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+const EVENTTITLE = &quot;Event&quot;;</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+const EVENTLOCATION = &quot;Location&quot;;</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+const EVENTDESCRIPTION = &quot;Event Description&quot;;</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+const EVENTATTENDEE = &quot;foo@bar.com&quot;;</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+const EVENTURL = &quot;http://mozilla.org/&quot;;</span>
<a href="#l9.37"></a><span id="l9.37"> </span>
<a href="#l9.38"></a><span id="l9.38"> function setupModule(module) {</span>
<a href="#l9.39"></a><span id="l9.39">     controller = mozmill.getMail3PaneController();</span>
<a href="#l9.40"></a><span id="l9.40">     ({ plan_for_modal_dialog, wait_for_modal_dialog } =</span>
<a href="#l9.41"></a><span id="l9.41">         collector.getModule(&quot;window-helpers&quot;));</span>
<a href="#l9.42"></a><span id="l9.42">     ({</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+        TIMEOUT_MODAL_DIALOG,</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+        CALENDARNAME,</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+        EVENTPATH,</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+        EVENT_BOX,</span>
<a href="#l9.47"></a><span id="l9.47">         helpersForController,</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-        invokeEventDialog,</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-        createCalendar,</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-        deleteCalendars,</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-        handleAddingAttachment,</span>
<a href="#l9.52"></a><span id="l9.52">         handleOccurrencePrompt,</span>
<a href="#l9.53"></a><span id="l9.53">         goToDate,</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-        setData,</span>
<a href="#l9.55"></a><span id="l9.55">         lookupEventBox,</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-        CALENDARNAME,</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-        TIMEOUT_MODAL_DIALOG</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+        invokeEventDialog,</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+        checkAlarmIcon,</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+        deleteCalendars,</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+        createCalendar</span>
<a href="#l9.62"></a><span id="l9.62">     } = collector.getModule(&quot;calendar-utils&quot;));</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-    collector.getModule(&quot;calendar-utils&quot;).setupModule();</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+    collector.getModule(&quot;calendar-utils&quot;).setupModule(controller);</span>
<a href="#l9.65"></a><span id="l9.65">     Object.assign(module, helpersForController(controller));</span>
<a href="#l9.66"></a><span id="l9.66"> </span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+    ({</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+        EVENT_TABPANELS,</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+        ATTENDEES_ROW,</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+        helpersForEditUI,</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+        setData</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+    } = collector.getModule(&quot;item-editing-helpers&quot;));</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+    collector.getModule(&quot;item-editing-helpers&quot;).setupModule(module);</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineplus">+</span>
<a href="#l9.75"></a><span id="l9.75">     createCalendar(controller, CALENDARNAME);</span>
<a href="#l9.76"></a><span id="l9.76"> }</span>
<a href="#l9.77"></a><span id="l9.77"> </span>
<a href="#l9.78"></a><span id="l9.78"> function testEventDialog() {</span>
<a href="#l9.79"></a><span id="l9.79">     let dateFormatter = cal.getDateFormatter();</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineminus">-    // paths</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineminus">-    let monthView = `</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;tabmail&quot;)/id(&quot;tabmail-tabbox&quot;)/</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-        id(&quot;tabpanelcontainer&quot;)/id(&quot;calendarTabPanel&quot;)/id(&quot;calendarContent&quot;)/</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineminus">-        id(&quot;calendarDisplayDeck&quot;)/id(&quot;calendar-view-box&quot;)/id(&quot;view-deck&quot;)/</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-        id(&quot;month-view&quot;)</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineminus">-    `;</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineminus">-    let eventDialog = `</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-        /id(&quot;calendar-event-dialog-inner&quot;)/id(&quot;event-grid&quot;)/id(&quot;event-grid-rows&quot;)/</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">-    `;</span>
<a href="#l9.90"></a><span id="l9.90"> </span>
<a href="#l9.91"></a><span id="l9.91" class="difflineminus">-    let eventBox = `</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineminus">-        ${monthView}/anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;monthgrid&quot;})/</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;monthgridrows&quot;})/[rowNumber]/[columnNumber]/</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">-        {&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;${CALENDARNAME.toLowerCase()}&quot;}/</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-        anon({&quot;flex&quot;:&quot;1&quot;})/[0]/anon({&quot;anonid&quot;:&quot;event-container&quot;})/</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-        {&quot;class&quot;:&quot;calendar-event-selection&quot;}/anon({&quot;anonid&quot;:&quot;eventbox&quot;})/</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-        {&quot;class&quot;:&quot;calendar-event-details&quot;}</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineminus">-    `;</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineminus">-</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineminus">-    // open month view</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineminus">-    controller.click(eid(&quot;calendar-tab-button&quot;));</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineplus">+    // Open month view.</span>
<a href="#l9.103"></a><span id="l9.103">     controller.waitThenClick(eid(&quot;calendar-month-view-button&quot;));</span>
<a href="#l9.104"></a><span id="l9.104"> </span>
<a href="#l9.105"></a><span id="l9.105">     goToDate(controller, 2009, 1, 1);</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineminus">-    sleep();</span>
<a href="#l9.107"></a><span id="l9.107"> </span>
<a href="#l9.108"></a><span id="l9.108" class="difflineminus">-    // create new event</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineplus">+    // Create new event.</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineplus">+    controller.mainMenu.click(&quot;#ltnNewEvent&quot;);</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineplus">+</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineplus">+    // Check that the start time is correct -</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineplus">+    // next full hour except last hour of the day.</span>
<a href="#l9.114"></a><span id="l9.114">     let now = new Date();</span>
<a href="#l9.115"></a><span id="l9.115">     let hour = now.getHours();</span>
<a href="#l9.116"></a><span id="l9.116">     let startHour = hour == 23 ? hour : (hour + 1) % 24;</span>
<a href="#l9.117"></a><span id="l9.117"> </span>
<a href="#l9.118"></a><span id="l9.118">     let nextHour = cal.dtz.now();</span>
<a href="#l9.119"></a><span id="l9.119">     nextHour.resetTo(2009, 0, 1, startHour, 0, 0, cal.dtz.floating);</span>
<a href="#l9.120"></a><span id="l9.120">     let startTime = dateFormatter.formatTime(nextHour);</span>
<a href="#l9.121"></a><span id="l9.121">     nextHour.resetTo(2009, 0, 1, (startHour + 1) % 24, 0, 0, cal.dtz.floating);</span>
<a href="#l9.122"></a><span id="l9.122">     let endTime = dateFormatter.formatTime(nextHour);</span>
<a href="#l9.123"></a><span id="l9.123"> </span>
<a href="#l9.124"></a><span id="l9.124" class="difflineminus">-    controller.mainMenu.click(&quot;#ltnNewEvent&quot;);</span>
<a href="#l9.125"></a><span id="l9.125">     invokeEventDialog(controller, null, (event, iframe) =&gt; {</span>
<a href="#l9.126"></a><span id="l9.126">         let { eid: eventid } = helpersForController(event);</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineminus">-        let { lookup: iframeLookup, eid: iframeId } = helpersForController(iframe);</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineplus">+        let { eid: iframeId } = helpersForController(iframe);</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineplus">+        let { iframeLookup, getDateTimePicker } = helpersForEditUI(iframe);</span>
<a href="#l9.130"></a><span id="l9.130"> </span>
<a href="#l9.131"></a><span id="l9.131" class="difflineminus">-        let timeInput = `</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineminus">-            anon({&quot;anonid&quot;:&quot;hbox&quot;})/anon({&quot;anonid&quot;:&quot;time-picker&quot;})/</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineminus">-            anon({&quot;class&quot;:&quot;timepicker-box-class&quot;})/</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineminus">-            anon({&quot;class&quot;:&quot;timepicker-text-class&quot;})/anon({&quot;flex&quot;:&quot;1&quot;})/</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineminus">-            anon({&quot;anonid&quot;:&quot;input&quot;})</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineminus">-        `;</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineminus">-        let startTimeInput = iframeLookup(`</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineminus">-            /id(&quot;calendar-event-dialog-inner&quot;)/id(&quot;event-grid&quot;)/id(&quot;event-grid-rows&quot;)/</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineminus">-            id(&quot;event-grid-startdate-row&quot;)/</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineminus">-            id(&quot;event-grid-startdate-picker-box&quot;)/id(&quot;event-starttime&quot;)/${timeInput}</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineminus">-        `);</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineplus">+        // First check all standard-values are set correctly.</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineplus">+        let startTimeInput = getDateTimePicker(&quot;STARTTIME&quot;);</span>
<a href="#l9.144"></a><span id="l9.144"> </span>
<a href="#l9.145"></a><span id="l9.145">         event.waitForElement(startTimeInput);</span>
<a href="#l9.146"></a><span id="l9.146">         event.assertValue(startTimeInput, startTime);</span>
<a href="#l9.147"></a><span id="l9.147"> </span>
<a href="#l9.148"></a><span id="l9.148" class="difflineminus">-        // check selected calendar</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineplus">+        // Check selected calendar.</span>
<a href="#l9.150"></a><span id="l9.150">         event.assertValue(iframeId(&quot;item-calendar&quot;), CALENDARNAME);</span>
<a href="#l9.151"></a><span id="l9.151"> </span>
<a href="#l9.152"></a><span id="l9.152" class="difflineminus">-        // fill in name, location, description</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineminus">-        setData(event, iframe, {</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineminus">-            title: eventTitle,</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineminus">-            location: eventLocation,</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineminus">-            description: eventDescription,</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineminus">-            category: &quot;Clients&quot;,</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineminus">-            repeat: &quot;daily&quot;</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineminus">-        });</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineminus">-        event.click(iframeId(&quot;item-alarm&quot;));</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineminus">-        event.click(iframeId(&quot;reminder-5minutes-menuitem&quot;));</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineminus">-        event.waitFor(() =&gt; iframeId(&quot;item-alarm&quot;).getNode().label == &quot;5 minutes before&quot;);</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineminus">-        iframeId(&quot;item-alarm-menupopup&quot;).getNode().hidePopup();</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineplus">+        // Check standard title.</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineplus">+        let defTitle = cal.calGetString(&quot;calendar&quot;, &quot;newEvent&quot;);</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineplus">+        event.assertValue(eventid(&quot;item-title&quot;), defTitle);</span>
<a href="#l9.167"></a><span id="l9.167" class="difflineplus">+</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineplus">+        // Prepare category.</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineplus">+        let categories = cal.calGetString(&quot;categories&quot;, &quot;categories2&quot;);</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineplus">+        // Pick 4th value in a comma-separated list.</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineplus">+        let category = categories.split(&quot;,&quot;)[4];</span>
<a href="#l9.172"></a><span id="l9.172"> </span>
<a href="#l9.173"></a><span id="l9.173" class="difflineminus">-        // add an attendee and verify added</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineminus">-        event.click(iframeId(&quot;event-grid-tab-attendees&quot;));</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineplus">+        // Fill in the rest of the values.</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineplus">+        setData(event, iframe, {</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineplus">+            title: EVENTTITLE,</span>
<a href="#l9.178"></a><span id="l9.178" class="difflineplus">+            location: EVENTLOCATION,</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineplus">+            description: EVENTDESCRIPTION,</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineplus">+            categories: [category],</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineplus">+            repeat: &quot;daily&quot;,</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineplus">+            reminder: &quot;5minutes&quot;,</span>
<a href="#l9.183"></a><span id="l9.183" class="difflineplus">+            privacy: &quot;private&quot;,</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineplus">+            attachment: { add: EVENTURL },</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineplus">+            attendees: { add: EVENTATTENDEE }</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineplus">+        });</span>
<a href="#l9.187"></a><span id="l9.187"> </span>
<a href="#l9.188"></a><span id="l9.188" class="difflineminus">-        plan_for_modal_dialog(&quot;Calendar:EventDialog:Attendees&quot;, handleAttendees);</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineminus">-        event.click(eventid(&quot;options-attendees-menuitem&quot;));</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineminus">-        wait_for_modal_dialog(&quot;Calendar:EventDialog:Recurrence&quot;, TIMEOUT_MODAL_DIALOG);</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineminus">-        event.assertNode(iframeLookup(`</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineminus">-            ${eventDialog}/id(&quot;event-grid-tabbox&quot;)/id(&quot;event-grid-tabpanels&quot;)/</span>
<a href="#l9.193"></a><span id="l9.193" class="difflineminus">-            id(&quot;event-grid-tabpanel-attendees&quot;)/[0]/[1]/id(&quot;item-attendees-box&quot;)/</span>
<a href="#l9.194"></a><span id="l9.194" class="difflineminus">-            {&quot;class&quot;:&quot;item-attendees-row&quot;}/{&quot;class&quot;:&quot;item-attendees-cell&quot;}/</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineminus">-            {&quot;class&quot;:&quot;item-attendees-cell-label&quot;,&quot;value&quot;:&quot;${eventAttendee}&quot;}</span>
<a href="#l9.196"></a><span id="l9.196" class="difflineminus">-        `));</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineminus">-        event.click(iframeId(&quot;notify-attendees-checkbox&quot;));</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineplus">+        // Verify attendee added.</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineplus">+        let attendeeLabel = iframeLookup(`</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineplus">+            ${ATTENDEES_ROW}/{&quot;class&quot;:&quot;item-attendees-cell&quot;}/{&quot;class&quot;:&quot;item-attendees-cell-label&quot;}</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineplus">+        `);</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineplus">+</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineplus">+        event.click(eventid(&quot;event-grid-tab-attendees&quot;));</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineplus">+        event.assertValue(attendeeLabel, EVENTATTENDEE);</span>
<a href="#l9.205"></a><span id="l9.205">         event.waitFor(() =&gt; !iframeId(&quot;notify-attendees-checkbox&quot;).getNode().checked);</span>
<a href="#l9.206"></a><span id="l9.206"> </span>
<a href="#l9.207"></a><span id="l9.207" class="difflineminus">-        // make it private and verify label visible</span>
<a href="#l9.208"></a><span id="l9.208" class="difflineminus">-        let toolbarbutton = eventid(&quot;button-privacy&quot;);</span>
<a href="#l9.209"></a><span id="l9.209" class="difflineminus">-        let rect = toolbarbutton.getNode().getBoundingClientRect();</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineminus">-        event.click(toolbarbutton, rect.width - 5, 5);</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineminus">-        event.click(eventid(&quot;event-privacy-private-menuitem&quot;));</span>
<a href="#l9.212"></a><span id="l9.212" class="difflineminus">-        event.waitFor(() =&gt; !eventid(&quot;status-privacy-private-box&quot;).getNode().hasAttribute(&quot;collapsed&quot;));</span>
<a href="#l9.213"></a><span id="l9.213" class="difflineplus">+        // Verify private label visible.</span>
<a href="#l9.214"></a><span id="l9.214" class="difflineplus">+        event.waitFor(</span>
<a href="#l9.215"></a><span id="l9.215" class="difflineplus">+            () =&gt; !eventid(&quot;status-privacy-private-box&quot;).getNode().hasAttribute(&quot;collapsed&quot;)</span>
<a href="#l9.216"></a><span id="l9.216" class="difflineplus">+        );</span>
<a href="#l9.217"></a><span id="l9.217">         eventid(&quot;event-privacy-menupopup&quot;).getNode().hidePopup();</span>
<a href="#l9.218"></a><span id="l9.218"> </span>
<a href="#l9.219"></a><span id="l9.219" class="difflineminus">-        // add attachment and verify added</span>
<a href="#l9.220"></a><span id="l9.220" class="difflineplus">+        // Add attachment and verify added.</span>
<a href="#l9.221"></a><span id="l9.221">         event.click(iframeId(&quot;event-grid-tab-attachments&quot;));</span>
<a href="#l9.222"></a><span id="l9.222" class="difflineminus">-</span>
<a href="#l9.223"></a><span id="l9.223" class="difflineminus">-        handleAddingAttachment(event, eventUrl);</span>
<a href="#l9.224"></a><span id="l9.224" class="difflineminus">-        event.click(eventid(&quot;button-url&quot;));</span>
<a href="#l9.225"></a><span id="l9.225" class="difflineminus">-        wait_for_modal_dialog(&quot;commonDialog&quot;);</span>
<a href="#l9.226"></a><span id="l9.226">         event.assertNode(iframeLookup(`</span>
<a href="#l9.227"></a><span id="l9.227" class="difflineminus">-            ${eventDialog}/id(&quot;event-grid-tabbox&quot;)/id(&quot;event-grid-tabpanels&quot;)/</span>
<a href="#l9.228"></a><span id="l9.228" class="difflineminus">-            id(&quot;event-grid-tabpanel-attachments&quot;)/{&quot;flex&quot;:&quot;1&quot;}/</span>
<a href="#l9.229"></a><span id="l9.229" class="difflineplus">+            ${EVENT_TABPANELS}/id(&quot;event-grid-tabpanel-attachments&quot;)/{&quot;flex&quot;:&quot;1&quot;}/</span>
<a href="#l9.230"></a><span id="l9.230">             id(&quot;attachment-link&quot;)/[0]/{&quot;value&quot;:&quot;mozilla.org&quot;}</span>
<a href="#l9.231"></a><span id="l9.231">         `));</span>
<a href="#l9.232"></a><span id="l9.232"> </span>
<a href="#l9.233"></a><span id="l9.233">         // save</span>
<a href="#l9.234"></a><span id="l9.234">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l9.235"></a><span id="l9.235">     });</span>
<a href="#l9.236"></a><span id="l9.236"> </span>
<a href="#l9.237"></a><span id="l9.237" class="difflineminus">-    // catch and dismiss alarm</span>
<a href="#l9.238"></a><span id="l9.238" class="difflineplus">+    // Catch and dismiss alarm.</span>
<a href="#l9.239"></a><span id="l9.239">     plan_for_modal_dialog(&quot;Calendar:AlarmWindow&quot;, alarm =&gt; {</span>
<a href="#l9.240"></a><span id="l9.240">         let { lookup: alarmlookup } = helpersForController(alarm);</span>
<a href="#l9.241"></a><span id="l9.241" class="difflineminus">-        alarm.waitThenClick(alarmlookup('/id(&quot;calendar-alarm-dialog&quot;)/id(&quot;alarm-actionbar&quot;)/[1]'));</span>
<a href="#l9.242"></a><span id="l9.242" class="difflineplus">+        alarm.waitThenClick(alarmlookup(`</span>
<a href="#l9.243"></a><span id="l9.243" class="difflineplus">+            /id(&quot;calendar-alarm-dialog&quot;)/id(&quot;alarm-actionbar&quot;)/[1]`</span>
<a href="#l9.244"></a><span id="l9.244" class="difflineplus">+        ));</span>
<a href="#l9.245"></a><span id="l9.245">     });</span>
<a href="#l9.246"></a><span id="l9.246" class="difflineminus">-    wait_for_modal_dialog(&quot;Calendar:AlarmWindow&quot;);</span>
<a href="#l9.247"></a><span id="l9.247" class="difflineminus">-</span>
<a href="#l9.248"></a><span id="l9.248" class="difflineminus">-    // verify event and alarm icon visible every day of the month and check tooltip</span>
<a href="#l9.249"></a><span id="l9.249" class="difflineminus">-    // 1st January is Thursday so there's three days to check in the first row</span>
<a href="#l9.250"></a><span id="l9.250" class="difflineminus">-    controller.assertNode(lookup(</span>
<a href="#l9.251"></a><span id="l9.251" class="difflineminus">-        eventBox.replace(&quot;rowNumber&quot;, &quot;0&quot;).replace(&quot;columnNumber&quot;, &quot;4&quot;)</span>
<a href="#l9.252"></a><span id="l9.252" class="difflineminus">-    ));</span>
<a href="#l9.253"></a><span id="l9.253" class="difflineminus">-    checkIcon(eventBox, &quot;0&quot;, &quot;4&quot;);</span>
<a href="#l9.254"></a><span id="l9.254" class="difflineminus">-    checkTooltip(monthView, 0, 4, 1, startTime, endTime);</span>
<a href="#l9.255"></a><span id="l9.255" class="difflineplus">+    wait_for_modal_dialog(&quot;Calendar:AlarmWindow&quot;, TIMEOUT_MODAL_DIALOG);</span>
<a href="#l9.256"></a><span id="l9.256"> </span>
<a href="#l9.257"></a><span id="l9.257" class="difflineminus">-    controller.assertNode(lookup(</span>
<a href="#l9.258"></a><span id="l9.258" class="difflineminus">-        eventBox.replace(&quot;rowNumber&quot;, &quot;0&quot;).replace(&quot;columnNumber&quot;, &quot;5&quot;)</span>
<a href="#l9.259"></a><span id="l9.259" class="difflineminus">-    ));</span>
<a href="#l9.260"></a><span id="l9.260" class="difflineminus">-    checkIcon(eventBox, &quot;0&quot;, &quot;5&quot;);</span>
<a href="#l9.261"></a><span id="l9.261" class="difflineminus">-    checkTooltip(monthView, 0, 5, 2, startTime, endTime);</span>
<a href="#l9.262"></a><span id="l9.262" class="difflineplus">+    // Verify event and alarm icon visible every day of the month and check tooltip.</span>
<a href="#l9.263"></a><span id="l9.263" class="difflineplus">+    // 1st January is Thursday so there's three days to check in the first row.</span>
<a href="#l9.264"></a><span id="l9.264" class="difflineplus">+    let date = 1;</span>
<a href="#l9.265"></a><span id="l9.265" class="difflineplus">+    for (col = 5; col &lt;= 7; col++) {</span>
<a href="#l9.266"></a><span id="l9.266" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;month&quot;, EVENT_BOX, 1, col, null, EVENTPATH));</span>
<a href="#l9.267"></a><span id="l9.267" class="difflineplus">+        checkAlarmIcon(controller, &quot;month&quot;, 1, col);</span>
<a href="#l9.268"></a><span id="l9.268" class="difflineplus">+        checkTooltip(1, col, date, startTime, endTime);</span>
<a href="#l9.269"></a><span id="l9.269" class="difflineplus">+        date++;</span>
<a href="#l9.270"></a><span id="l9.270" class="difflineplus">+    }</span>
<a href="#l9.271"></a><span id="l9.271"> </span>
<a href="#l9.272"></a><span id="l9.272" class="difflineminus">-    controller.assertNode(lookup(</span>
<a href="#l9.273"></a><span id="l9.273" class="difflineminus">-        eventBox.replace(&quot;rowNumber&quot;, &quot;0&quot;).replace(&quot;columnNumber&quot;, &quot;6&quot;)</span>
<a href="#l9.274"></a><span id="l9.274" class="difflineminus">-    ));</span>
<a href="#l9.275"></a><span id="l9.275" class="difflineminus">-    checkIcon(eventBox, &quot;0&quot;, &quot;6&quot;);</span>
<a href="#l9.276"></a><span id="l9.276" class="difflineminus">-    checkTooltip(monthView, 0, 6, 3, startTime, endTime);</span>
<a href="#l9.277"></a><span id="l9.277" class="difflineminus">-</span>
<a href="#l9.278"></a><span id="l9.278" class="difflineminus">-    // 31st of January is Saturday so there's four more full rows to check</span>
<a href="#l9.279"></a><span id="l9.279" class="difflineminus">-    let date = 4;</span>
<a href="#l9.280"></a><span id="l9.280" class="difflineminus">-    for (let row = 1; row &lt; 5; row++) {</span>
<a href="#l9.281"></a><span id="l9.281" class="difflineminus">-        for (let col = 0; col &lt; 7; col++) {</span>
<a href="#l9.282"></a><span id="l9.282" class="difflineminus">-            controller.assertNode(lookup(</span>
<a href="#l9.283"></a><span id="l9.283" class="difflineminus">-                eventBox.replace(&quot;rowNumber&quot;, row).replace(&quot;columnNumber&quot;, col)</span>
<a href="#l9.284"></a><span id="l9.284" class="difflineminus">-            ));</span>
<a href="#l9.285"></a><span id="l9.285" class="difflineminus">-            checkIcon(eventBox, row, col);</span>
<a href="#l9.286"></a><span id="l9.286" class="difflineminus">-            checkTooltip(monthView, row, col, date, startTime, endTime);</span>
<a href="#l9.287"></a><span id="l9.287" class="difflineplus">+    // 31st of January is Saturday so there's four more full rows to check.</span>
<a href="#l9.288"></a><span id="l9.288" class="difflineplus">+    for (let row = 2; row &lt;= 5; row++) {</span>
<a href="#l9.289"></a><span id="l9.289" class="difflineplus">+        for (let col = 1; col &lt;= 7; col++) {</span>
<a href="#l9.290"></a><span id="l9.290" class="difflineplus">+            controller.assertNode(lookupEventBox(&quot;month&quot;, EVENT_BOX, row, col, null, EVENTPATH));</span>
<a href="#l9.291"></a><span id="l9.291" class="difflineplus">+            checkAlarmIcon(controller, &quot;month&quot;, row, col);</span>
<a href="#l9.292"></a><span id="l9.292" class="difflineplus">+            checkTooltip(row, col, date, startTime, endTime);</span>
<a href="#l9.293"></a><span id="l9.293">             date++;</span>
<a href="#l9.294"></a><span id="l9.294">         }</span>
<a href="#l9.295"></a><span id="l9.295">     }</span>
<a href="#l9.296"></a><span id="l9.296"> </span>
<a href="#l9.297"></a><span id="l9.297" class="difflineminus">-    // delete and verify deleted 2nd Jan</span>
<a href="#l9.298"></a><span id="l9.298" class="difflineminus">-    controller.click(lookup(</span>
<a href="#l9.299"></a><span id="l9.299" class="difflineminus">-        eventBox.replace(&quot;rowNumber&quot;, &quot;0&quot;).replace(&quot;columnNumber&quot;, &quot;5&quot;)</span>
<a href="#l9.300"></a><span id="l9.300" class="difflineminus">-    ));</span>
<a href="#l9.301"></a><span id="l9.301" class="difflineplus">+    // Delete and verify deleted 2nd Jan.</span>
<a href="#l9.302"></a><span id="l9.302" class="difflineplus">+    controller.click(lookupEventBox(&quot;month&quot;, EVENT_BOX, 1, 6, null, EVENTPATH));</span>
<a href="#l9.303"></a><span id="l9.303">     let elemToDelete = eid(&quot;month-view&quot;);</span>
<a href="#l9.304"></a><span id="l9.304" class="difflineminus">-    handleOccurrencePrompt(controller, elemToDelete, &quot;delete&quot;, false, false);</span>
<a href="#l9.305"></a><span id="l9.305" class="difflineminus">-    controller.waitForElementNotPresent(lookup(</span>
<a href="#l9.306"></a><span id="l9.306" class="difflineminus">-        eventBox.replace(&quot;rowNumber&quot;, &quot;0&quot;).replace(&quot;columnNumber&quot;, &quot;5&quot;)</span>
<a href="#l9.307"></a><span id="l9.307" class="difflineminus">-    ));</span>
<a href="#l9.308"></a><span id="l9.308" class="difflineplus">+    handleOccurrencePrompt(controller, elemToDelete, &quot;delete&quot;, false);</span>
<a href="#l9.309"></a><span id="l9.309" class="difflineplus">+    controller.waitForElementNotPresent(lookupEventBox(&quot;month&quot;, EVENT_BOX, 1, 6, null, EVENTPATH));</span>
<a href="#l9.310"></a><span id="l9.310"> </span>
<a href="#l9.311"></a><span id="l9.311" class="difflineminus">-    // verify all others still exist</span>
<a href="#l9.312"></a><span id="l9.312" class="difflineminus">-    controller.assertNode(lookup(</span>
<a href="#l9.313"></a><span id="l9.313" class="difflineminus">-        eventBox.replace(&quot;rowNumber&quot;, &quot;0&quot;).replace(&quot;columnNumber&quot;, &quot;4&quot;)</span>
<a href="#l9.314"></a><span id="l9.314" class="difflineminus">-    ));</span>
<a href="#l9.315"></a><span id="l9.315" class="difflineminus">-    controller.assertNode(lookup(</span>
<a href="#l9.316"></a><span id="l9.316" class="difflineminus">-        eventBox.replace(&quot;rowNumber&quot;, &quot;0&quot;).replace(&quot;columnNumber&quot;, &quot;6&quot;)</span>
<a href="#l9.317"></a><span id="l9.317" class="difflineminus">-    ));</span>
<a href="#l9.318"></a><span id="l9.318" class="difflineplus">+    // Verify all others still exist.</span>
<a href="#l9.319"></a><span id="l9.319" class="difflineplus">+    controller.assertNode(lookupEventBox(&quot;month&quot;, EVENT_BOX, 1, 5, null, EVENTPATH));</span>
<a href="#l9.320"></a><span id="l9.320" class="difflineplus">+    controller.assertNode(lookupEventBox(&quot;month&quot;, EVENT_BOX, 1, 7, null, EVENTPATH));</span>
<a href="#l9.321"></a><span id="l9.321"> </span>
<a href="#l9.322"></a><span id="l9.322" class="difflineminus">-    for (let row = 1; row &lt; 5; row++) {</span>
<a href="#l9.323"></a><span id="l9.323" class="difflineminus">-        for (let col = 0; col &lt; 7; col++) {</span>
<a href="#l9.324"></a><span id="l9.324" class="difflineminus">-            controller.assertNode(lookup(</span>
<a href="#l9.325"></a><span id="l9.325" class="difflineminus">-                eventBox.replace(&quot;rowNumber&quot;, row).replace(&quot;columnNumber&quot;, col)</span>
<a href="#l9.326"></a><span id="l9.326" class="difflineminus">-            ));</span>
<a href="#l9.327"></a><span id="l9.327" class="difflineplus">+    for (let row = 2; row &lt;= 5; row++) {</span>
<a href="#l9.328"></a><span id="l9.328" class="difflineplus">+        for (let col = 1; col &lt;= 7; col++) {</span>
<a href="#l9.329"></a><span id="l9.329" class="difflineplus">+            controller.assertNode(lookupEventBox(&quot;month&quot;, EVENT_BOX, row, col, null, EVENTPATH));</span>
<a href="#l9.330"></a><span id="l9.330">         }</span>
<a href="#l9.331"></a><span id="l9.331">     }</span>
<a href="#l9.332"></a><span id="l9.332"> </span>
<a href="#l9.333"></a><span id="l9.333" class="difflineminus">-    // delete series by deleting 3rd January and confirming to delete all</span>
<a href="#l9.334"></a><span id="l9.334" class="difflineminus">-    controller.click(lookup(</span>
<a href="#l9.335"></a><span id="l9.335" class="difflineminus">-        eventBox.replace(&quot;rowNumber&quot;, &quot;0&quot;).replace(&quot;columnNumber&quot;, &quot;6&quot;)</span>
<a href="#l9.336"></a><span id="l9.336" class="difflineminus">-    ));</span>
<a href="#l9.337"></a><span id="l9.337" class="difflineplus">+    // Delete series by deleting 3rd January and confirming to delete all.</span>
<a href="#l9.338"></a><span id="l9.338" class="difflineplus">+    controller.click(lookupEventBox(&quot;month&quot;, EVENT_BOX, 1, 7, null, EVENTPATH));</span>
<a href="#l9.339"></a><span id="l9.339">     elemToDelete = eid(&quot;month-view&quot;);</span>
<a href="#l9.340"></a><span id="l9.340" class="difflineminus">-    handleOccurrencePrompt(controller, elemToDelete, &quot;delete&quot;, true, false);</span>
<a href="#l9.341"></a><span id="l9.341" class="difflineplus">+    handleOccurrencePrompt(controller, elemToDelete, &quot;delete&quot;, true);</span>
<a href="#l9.342"></a><span id="l9.342"> </span>
<a href="#l9.343"></a><span id="l9.343" class="difflineminus">-    // verify all deleted</span>
<a href="#l9.344"></a><span id="l9.344" class="difflineminus">-    controller.waitForElementNotPresent(lookup(</span>
<a href="#l9.345"></a><span id="l9.345" class="difflineminus">-        eventBox.replace(&quot;rowNumber&quot;, &quot;0&quot;).replace(&quot;columnNumber&quot;, &quot;4&quot;)</span>
<a href="#l9.346"></a><span id="l9.346" class="difflineminus">-    ));</span>
<a href="#l9.347"></a><span id="l9.347" class="difflineminus">-    controller.assertNodeNotExist(lookup(</span>
<a href="#l9.348"></a><span id="l9.348" class="difflineminus">-        eventBox.replace(&quot;rowNumber&quot;, &quot;0&quot;).replace(&quot;columnNumber&quot;, &quot;5&quot;)</span>
<a href="#l9.349"></a><span id="l9.349" class="difflineminus">-    ));</span>
<a href="#l9.350"></a><span id="l9.350" class="difflineminus">-    controller.assertNodeNotExist(lookup(</span>
<a href="#l9.351"></a><span id="l9.351" class="difflineminus">-        eventBox.replace(&quot;rowNumber&quot;, &quot;0&quot;).replace(&quot;columnNumber&quot;, &quot;6&quot;)</span>
<a href="#l9.352"></a><span id="l9.352" class="difflineminus">-    ));</span>
<a href="#l9.353"></a><span id="l9.353" class="difflineplus">+    // Verify all deleted.</span>
<a href="#l9.354"></a><span id="l9.354" class="difflineplus">+    controller.waitForElementNotPresent(lookupEventBox(&quot;month&quot;, EVENT_BOX, 1, 5, null, EVENTPATH));</span>
<a href="#l9.355"></a><span id="l9.355" class="difflineplus">+    controller.assertNodeNotExist(lookupEventBox(&quot;month&quot;, EVENT_BOX, 1, 6, null, EVENTPATH));</span>
<a href="#l9.356"></a><span id="l9.356" class="difflineplus">+    controller.assertNodeNotExist(lookupEventBox(&quot;month&quot;, EVENT_BOX, 1, 7, null, EVENTPATH));</span>
<a href="#l9.357"></a><span id="l9.357"> </span>
<a href="#l9.358"></a><span id="l9.358" class="difflineminus">-    for (let row = 1; row &lt; 5; row++) {</span>
<a href="#l9.359"></a><span id="l9.359" class="difflineminus">-        for (let col = 0; col &lt; 7; col++) {</span>
<a href="#l9.360"></a><span id="l9.360" class="difflineminus">-            controller.assertNodeNotExist(lookup(</span>
<a href="#l9.361"></a><span id="l9.361" class="difflineminus">-                eventBox.replace(&quot;rowNumber&quot;, row).replace(&quot;columnNumber&quot;, col)</span>
<a href="#l9.362"></a><span id="l9.362" class="difflineplus">+    for (let row = 2; row &lt;= 5; row++) {</span>
<a href="#l9.363"></a><span id="l9.363" class="difflineplus">+        for (let col = 1; col &lt;= 7; col++) {</span>
<a href="#l9.364"></a><span id="l9.364" class="difflineplus">+            controller.assertNodeNotExist(lookupEventBox(</span>
<a href="#l9.365"></a><span id="l9.365" class="difflineplus">+                &quot;month&quot;, EVENT_BOX, row, col, null, EVENTPATH</span>
<a href="#l9.366"></a><span id="l9.366">             ));</span>
<a href="#l9.367"></a><span id="l9.367">         }</span>
<a href="#l9.368"></a><span id="l9.368">     }</span>
<a href="#l9.369"></a><span id="l9.369"> }</span>
<a href="#l9.370"></a><span id="l9.370"> </span>
<a href="#l9.371"></a><span id="l9.371" class="difflineminus">-function handleAttendees(attendees) {</span>
<a href="#l9.372"></a><span id="l9.372" class="difflineminus">-    let { lookup: attendeeslookup } = helpersForController(attendees);</span>
<a href="#l9.373"></a><span id="l9.373" class="difflineminus">-</span>
<a href="#l9.374"></a><span id="l9.374" class="difflineminus">-    let input = attendeeslookup(`</span>
<a href="#l9.375"></a><span id="l9.375" class="difflineminus">-        /id(&quot;calendar-event-dialog-attendees-v2&quot;)/{&quot;flex&quot;:&quot;1&quot;}/</span>
<a href="#l9.376"></a><span id="l9.376" class="difflineminus">-        id(&quot;attendees-container&quot;)/id(&quot;attendees-list&quot;)/[1]/[2]/[0]</span>
<a href="#l9.377"></a><span id="l9.377" class="difflineminus">-    `);</span>
<a href="#l9.378"></a><span id="l9.378" class="difflineminus">-    attendees.waitForElement(input);</span>
<a href="#l9.379"></a><span id="l9.379" class="difflineminus">-    attendees.type(input, eventAttendee);</span>
<a href="#l9.380"></a><span id="l9.380" class="difflineminus">-    attendees.click(attendeeslookup(`</span>
<a href="#l9.381"></a><span id="l9.381" class="difflineminus">-        /id(&quot;calendar-event-dialog-attendees-v2&quot;)/anon({&quot;anonid&quot;:&quot;buttons&quot;})/</span>
<a href="#l9.382"></a><span id="l9.382" class="difflineminus">-        {&quot;dlgtype&quot;:&quot;accept&quot;}</span>
<a href="#l9.383"></a><span id="l9.383" class="difflineminus">-    `));</span>
<a href="#l9.384"></a><span id="l9.384" class="difflineminus">-}</span>
<a href="#l9.385"></a><span id="l9.385" class="difflineminus">-</span>
<a href="#l9.386"></a><span id="l9.386" class="difflineminus">-function checkIcon(eventBox, row, col) {</span>
<a href="#l9.387"></a><span id="l9.387" class="difflineminus">-    let icon = lookup((`</span>
<a href="#l9.388"></a><span id="l9.388" class="difflineminus">-        ${eventBox}/anon({&quot;anonid&quot;:&quot;category-box-stack&quot;})/</span>
<a href="#l9.389"></a><span id="l9.389" class="difflineminus">-        anon({&quot;align&quot;: &quot;center&quot;})/anon({&quot;class&quot;:&quot;alarm-icons-box&quot;})/</span>
<a href="#l9.390"></a><span id="l9.390" class="difflineminus">-        anon({&quot;class&quot;: &quot;reminder-icon&quot;})</span>
<a href="#l9.391"></a><span id="l9.391" class="difflineminus">-    `).replace(&quot;rowNumber&quot;, row).replace(&quot;columnNumber&quot;, col));</span>
<a href="#l9.392"></a><span id="l9.392" class="difflineminus">-</span>
<a href="#l9.393"></a><span id="l9.393" class="difflineminus">-    controller.assertJS(icon.getNode().getAttribute(&quot;value&quot;) == &quot;DISPLAY&quot;);</span>
<a href="#l9.394"></a><span id="l9.394" class="difflineminus">-}</span>
<a href="#l9.395"></a><span id="l9.395" class="difflineminus">-</span>
<a href="#l9.396"></a><span id="l9.396" class="difflineminus">-function checkTooltip(monthView, row, col, date, startTime, endTime) {</span>
<a href="#l9.397"></a><span id="l9.397" class="difflineminus">-    let item = lookupEventBox(</span>
<a href="#l9.398"></a><span id="l9.398" class="difflineminus">-        &quot;month&quot;, null, row + 1, col + 1, null,</span>
<a href="#l9.399"></a><span id="l9.399" class="difflineminus">-        `/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;${CALENDARNAME.toLowerCase()}&quot;}`</span>
<a href="#l9.400"></a><span id="l9.400" class="difflineminus">-    );</span>
<a href="#l9.401"></a><span id="l9.401" class="difflineplus">+function checkTooltip(row, col, date, startTime, endTime) {</span>
<a href="#l9.402"></a><span id="l9.402" class="difflineplus">+    let item = lookupEventBox(&quot;month&quot;, null, row, col, null, EVENTPATH);</span>
<a href="#l9.403"></a><span id="l9.403"> </span>
<a href="#l9.404"></a><span id="l9.404">     let toolTip = '/id(&quot;messengerWindow&quot;)/id(&quot;calendar-popupset&quot;)/id(&quot;itemTooltip&quot;)';</span>
<a href="#l9.405"></a><span id="l9.405">     let toolTipNode = lookup(toolTip).getNode();</span>
<a href="#l9.406"></a><span id="l9.406">     toolTipNode.ownerGlobal.onMouseOverItem({ currentTarget: item.getNode() });</span>
<a href="#l9.407"></a><span id="l9.407"> </span>
<a href="#l9.408"></a><span id="l9.408" class="difflineminus">-    // check title</span>
<a href="#l9.409"></a><span id="l9.409" class="difflineplus">+    // Check title.</span>
<a href="#l9.410"></a><span id="l9.410">     let toolTipGrid = toolTip + '/{&quot;class&quot;:&quot;tooltipBox&quot;}/{&quot;class&quot;:&quot;tooltipHeaderGrid&quot;}/';</span>
<a href="#l9.411"></a><span id="l9.411">     let eventName = lookup(`${toolTipGrid}/[1]/[0]/[1]`);</span>
<a href="#l9.412"></a><span id="l9.412" class="difflineminus">-    controller.assert(() =&gt; eventName.getNode().textContent == eventTitle);</span>
<a href="#l9.413"></a><span id="l9.413" class="difflineplus">+    controller.assert(() =&gt; eventName.getNode().textContent == EVENTTITLE);</span>
<a href="#l9.414"></a><span id="l9.414"> </span>
<a href="#l9.415"></a><span id="l9.415" class="difflineminus">-    // check date and time</span>
<a href="#l9.416"></a><span id="l9.416" class="difflineplus">+    // Check date and time.</span>
<a href="#l9.417"></a><span id="l9.417">     let dateTime = lookup(`${toolTipGrid}/[1]/[2]/[1]`);</span>
<a href="#l9.418"></a><span id="l9.418"> </span>
<a href="#l9.419"></a><span id="l9.419">     let formatter = new Services.intl.DateTimeFormat(undefined, { dateStyle: &quot;full&quot; });</span>
<a href="#l9.420"></a><span id="l9.420">     let startDate = formatter.format(new Date(2009, 0, date));</span>
<a href="#l9.421"></a><span id="l9.421"> </span>
<a href="#l9.422"></a><span id="l9.422">     controller.assert(() =&gt; {</span>
<a href="#l9.423"></a><span id="l9.423">         let text = dateTime.getNode().textContent;</span>
<a href="#l9.424"></a><span id="l9.424" class="difflineplus">+        dump(`${text} / ${startDate} ${startTime} -\n`);</span>
<a href="#l9.425"></a><span id="l9.425">         return text.includes(`${startDate} ${startTime} – `);</span>
<a href="#l9.426"></a><span id="l9.426">     });</span>
<a href="#l9.427"></a><span id="l9.427"> </span>
<a href="#l9.428"></a><span id="l9.428">     // This could be on the next day if it is 00:00.</span>
<a href="#l9.429"></a><span id="l9.429">     controller.assert(() =&gt; dateTime.getNode().textContent.endsWith(endTime));</span>
<a href="#l9.430"></a><span id="l9.430"> }</span>
<a href="#l9.431"></a><span id="l9.431"> </span>
<a href="#l9.432"></a><span id="l9.432"> function teardownTest(module) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/test/mozmill/eventDialog/testEventDialogModificationPrompt.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/test/mozmill/eventDialog/testEventDialogModificationPrompt.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1,153 +1,216 @@</span>
<a href="#l10.4"></a><span id="l10.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.5"></a><span id="l10.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.6"></a><span id="l10.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+var MODULE_NAME = &quot;testEventDialogModificationPrompt&quot;;</span>
<a href="#l10.9"></a><span id="l10.9"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineminus">-var MODULE_REQUIRES = [&quot;calendar-utils&quot;];</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;item-editing-helpers&quot;,</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+    &quot;window-helpers&quot;, &quot;folder-display-helpers&quot;];</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;, null);</span>
<a href="#l10.15"></a><span id="l10.15"> </span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-var helpersForController, invokeEventDialog, createCalendar;</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-var deleteCalendars, switchToView, goToDate, setData;</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-var CALENDARNAME, EVENT_BOX, CANVAS_BOX;</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+var CALENDARNAME, EVENT_BOX, CANVAS_BOX, EVENTPATH;</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+var helpersForController, invokeEventDialog, createCalendar, deleteCalendars, goToDate;</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+var setData;</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+var plan_for_modal_dialog, wait_for_modal_dialog;</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+var mark_failure;</span>
<a href="#l10.24"></a><span id="l10.24"> </span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+const TIMEOUT_COMMON_DIALOG = 3000;</span>
<a href="#l10.26"></a><span id="l10.26"> var savePromptAppeared = false;</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+var failPoints = {</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+    first: &quot;no change&quot;,</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+    second: &quot;change all and back&quot;,</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+    third: [&quot;1st pass&quot;, &quot;2nd pass&quot;, &quot;3rd pass&quot;, &quot;4th pass&quot;, &quot;5th pass&quot;]</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+};</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+</span>
<a href="#l10.33"></a><span id="l10.33"> var { date1, date2, date3, data, newlines } = setupData();</span>
<a href="#l10.34"></a><span id="l10.34"> </span>
<a href="#l10.35"></a><span id="l10.35"> function setupModule(module) {</span>
<a href="#l10.36"></a><span id="l10.36">     controller = mozmill.getMail3PaneController();</span>
<a href="#l10.37"></a><span id="l10.37">     ({</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+        CALENDARNAME,</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+        EVENT_BOX,</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+        CANVAS_BOX,</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+        EVENTPATH,</span>
<a href="#l10.42"></a><span id="l10.42">         helpersForController,</span>
<a href="#l10.43"></a><span id="l10.43">         invokeEventDialog,</span>
<a href="#l10.44"></a><span id="l10.44">         createCalendar,</span>
<a href="#l10.45"></a><span id="l10.45">         deleteCalendars,</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-        switchToView,</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-        goToDate,</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-        setData,</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-        CALENDARNAME,</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-        EVENT_BOX,</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-        CANVAS_BOX,</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+        goToDate</span>
<a href="#l10.53"></a><span id="l10.53">     } = collector.getModule(&quot;calendar-utils&quot;));</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-    collector.getModule(&quot;calendar-utils&quot;).setupModule();</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+    collector.getModule(&quot;calendar-utils&quot;).setupModule(controller);</span>
<a href="#l10.56"></a><span id="l10.56">     Object.assign(module, helpersForController(controller));</span>
<a href="#l10.57"></a><span id="l10.57"> </span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+    ({ setData } = collector.getModule(&quot;item-editing-helpers&quot;));</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+    collector.getModule(&quot;item-editing-helpers&quot;).setupModule(module);</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+    ({ plan_for_modal_dialog, wait_for_modal_dialog } =</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+        collector.getModule(&quot;window-helpers&quot;));</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+    ({ mark_failure } =</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+        collector.getModule(&quot;folder-display-helpers&quot;));</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+</span>
<a href="#l10.67"></a><span id="l10.67">     createCalendar(controller, CALENDARNAME);</span>
<a href="#l10.68"></a><span id="l10.68"> }</span>
<a href="#l10.69"></a><span id="l10.69"> </span>
<a href="#l10.70"></a><span id="l10.70" class="difflineminus">-// Test that closing an event dialog with no changes does not prompt for save</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+// Test that closing an event dialog with no changes does not prompt for save.</span>
<a href="#l10.72"></a><span id="l10.72"> function testEventDialogModificationPrompt() {</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineminus">-    controller.click(eid(&quot;calendar-tab-button&quot;));</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineminus">-    switchToView(controller, &quot;day&quot;);</span>
<a href="#l10.75"></a><span id="l10.75">     goToDate(controller, 2009, 1, 1);</span>
<a href="#l10.76"></a><span id="l10.76"> </span>
<a href="#l10.77"></a><span id="l10.77" class="difflineminus">-    // create new event</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineminus">-    let eventbox = lookupEventBox(&quot;day&quot;, CANVAS_BOX, null, 1, 8);</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineminus">-    invokeEventDialog(controller, eventbox, (event, iframe) =&gt; {</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+    let createbox = lookupEventBox(&quot;day&quot;, CANVAS_BOX, null, 1, 8);</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+    let eventbox = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, EVENTPATH);</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+    // Create new event.</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+    invokeEventDialog(controller, createbox, (event, iframe) =&gt; {</span>
<a href="#l10.85"></a><span id="l10.85">         let { eid: eventid } = helpersForController(event);</span>
<a href="#l10.86"></a><span id="l10.86"> </span>
<a href="#l10.87"></a><span id="l10.87" class="difflineminus">-        // enter first set of data</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+        let categories = cal.calGetString(&quot;categories&quot;, &quot;categories2&quot;).split(&quot;,&quot;);</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+        data[0].categories.push(categories[0]);</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+        data[1].categories.push(categories[1], categories[2]);</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+        // Enter first set of data.</span>
<a href="#l10.93"></a><span id="l10.93">         setData(event, iframe, data[0]);</span>
<a href="#l10.94"></a><span id="l10.94"> </span>
<a href="#l10.95"></a><span id="l10.95">         // save</span>
<a href="#l10.96"></a><span id="l10.96">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l10.97"></a><span id="l10.97">     });</span>
<a href="#l10.98"></a><span id="l10.98"> </span>
<a href="#l10.99"></a><span id="l10.99" class="difflineminus">-    eventbox = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, 8, '/{&quot;tooltip&quot;:&quot;itemTooltip&quot;}');</span>
<a href="#l10.100"></a><span id="l10.100">     invokeEventDialog(controller, eventbox, (event, iframe) =&gt; {</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineminus">-        // open, but change nothing</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineminus">-        // escape the event window, there should be no prompt to save event</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+        // Open, but change nothing.</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+        plan_for_modal_dialog(&quot;commonDialog&quot;, handleSavePrompt);</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineplus">+        // Escape the event window, there should be no prompt to save event.</span>
<a href="#l10.107"></a><span id="l10.107">         event.keypress(null, &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+        try {</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineplus">+            wait_for_modal_dialog(&quot;commonDialog&quot;, TIMEOUT_COMMON_DIALOG);</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineplus">+        } catch (e) {</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+            failPoints.first = &quot;&quot;;</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineplus">+        }</span>
<a href="#l10.113"></a><span id="l10.113">     });</span>
<a href="#l10.114"></a><span id="l10.114"> </span>
<a href="#l10.115"></a><span id="l10.115">     // open</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineminus">-    eventbox = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, 8, '/{&quot;tooltip&quot;:&quot;itemTooltip&quot;}');</span>
<a href="#l10.117"></a><span id="l10.117">     invokeEventDialog(controller, eventbox, (event, iframe) =&gt; {</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineminus">-        // change all values</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineplus">+        // Change all values.</span>
<a href="#l10.120"></a><span id="l10.120">         setData(event, iframe, data[1]);</span>
<a href="#l10.121"></a><span id="l10.121"> </span>
<a href="#l10.122"></a><span id="l10.122" class="difflineminus">-        // edit all values back to original</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineplus">+        // Edit all values back to original.</span>
<a href="#l10.124"></a><span id="l10.124">         setData(event, iframe, data[0]);</span>
<a href="#l10.125"></a><span id="l10.125"> </span>
<a href="#l10.126"></a><span id="l10.126" class="difflineminus">-        // escape the event window, there should be no prompt to save event</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineplus">+        plan_for_modal_dialog(&quot;commonDialog&quot;, handleSavePrompt);</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineplus">+</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineplus">+        // Escape the event window, there should be no prompt to save event.</span>
<a href="#l10.130"></a><span id="l10.130">         event.keypress(null, &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineplus">+        try {</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineplus">+            wait_for_modal_dialog(&quot;commonDialog&quot;, TIMEOUT_COMMON_DIALOG);</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineplus">+        } catch (e) {</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineplus">+            failPoints.second = &quot;&quot;;</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+        }</span>
<a href="#l10.136"></a><span id="l10.136">     });</span>
<a href="#l10.137"></a><span id="l10.137"> </span>
<a href="#l10.138"></a><span id="l10.138" class="difflineminus">-    // delete event</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineminus">-    controller.click(lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, 8, '/{&quot;tooltip&quot;:&quot;itemTooltip&quot;}'));</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+    // Delete event.</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+    controller.click(eventbox);</span>
<a href="#l10.142"></a><span id="l10.142">     controller.keypress(eid(&quot;day-view&quot;), &quot;VK_DELETE&quot;, {});</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineminus">-    controller.waitForElementNotPresent(lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, 8));</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineplus">+    controller.waitForElementNotPresent(eventbox);</span>
<a href="#l10.145"></a><span id="l10.145"> </span>
<a href="#l10.146"></a><span id="l10.146">     for (let i = 0; i &lt; newlines.length; i++) {</span>
<a href="#l10.147"></a><span id="l10.147">         // test set i</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineminus">-        eventbox = lookupEventBox(&quot;day&quot;, CANVAS_BOX, null, 1, 8);</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineminus">-        invokeEventDialog(controller, eventbox, (event, iframe) =&gt; {</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineplus">+        invokeEventDialog(controller, createbox, (event, iframe) =&gt; {</span>
<a href="#l10.151"></a><span id="l10.151">             let { eid: eventid } = helpersForController(event);</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineplus">+</span>
<a href="#l10.153"></a><span id="l10.153">             setData(event, iframe, newlines[i]);</span>
<a href="#l10.154"></a><span id="l10.154">             event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l10.155"></a><span id="l10.155">         });</span>
<a href="#l10.156"></a><span id="l10.156"> </span>
<a href="#l10.157"></a><span id="l10.157" class="difflineminus">-        // open and close</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineminus">-        eventbox = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, 8, '/{&quot;tooltip&quot;:&quot;itemTooltip&quot;}');</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineplus">+        // Open and close.</span>
<a href="#l10.160"></a><span id="l10.160">         invokeEventDialog(controller, eventbox, (event, iframe) =&gt; {</span>
<a href="#l10.161"></a><span id="l10.161">             setData(event, iframe, newlines[i]);</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineplus">+            plan_for_modal_dialog(&quot;commonDialog&quot;, handleSavePrompt);</span>
<a href="#l10.163"></a><span id="l10.163">             event.keypress(null, &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineplus">+            try {</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineplus">+                wait_for_modal_dialog(&quot;commonDialog&quot;, TIMEOUT_COMMON_DIALOG);</span>
<a href="#l10.166"></a><span id="l10.166" class="difflineplus">+            } catch (e) {</span>
<a href="#l10.167"></a><span id="l10.167" class="difflineplus">+                failPoints.third[i] = &quot;&quot;;</span>
<a href="#l10.168"></a><span id="l10.168" class="difflineplus">+            }</span>
<a href="#l10.169"></a><span id="l10.169">         });</span>
<a href="#l10.170"></a><span id="l10.170"> </span>
<a href="#l10.171"></a><span id="l10.171" class="difflineminus">-        // delete it</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineminus">-        // XXX somehow the event is selected at this point, this didn't use to</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineminus">-        // be the case and can't be reproduced manually</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineplus">+        // Delete it.</span>
<a href="#l10.175"></a><span id="l10.175" class="difflineplus">+        // XXX Somehow the event is selected at this point, this didn't use to</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineplus">+        // be the case and can't be reproduced manually.</span>
<a href="#l10.177"></a><span id="l10.177">         controller.keypress(eid(&quot;day-view&quot;), &quot;VK_DELETE&quot;, {});</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineminus">-        controller.waitForElementNotPresent(lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, 8));</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineplus">+        controller.waitForElementNotPresent(eventbox);</span>
<a href="#l10.180"></a><span id="l10.180">     }</span>
<a href="#l10.181"></a><span id="l10.181"> }</span>
<a href="#l10.182"></a><span id="l10.182"> </span>
<a href="#l10.183"></a><span id="l10.183"> function teardownTest(module) {</span>
<a href="#l10.184"></a><span id="l10.184">     deleteCalendars(controller, CALENDARNAME);</span>
<a href="#l10.185"></a><span id="l10.185">     if (savePromptAppeared) {</span>
<a href="#l10.186"></a><span id="l10.186" class="difflineminus">-        controller.assertJS('&quot;Prompt appeared&quot; == &quot;Prompt didn\'t appear.&quot;');</span>
<a href="#l10.187"></a><span id="l10.187" class="difflineplus">+        mark_failure([&quot;Save Prompt unexpectedly appeared on: &quot;, failPoints.first,</span>
<a href="#l10.188"></a><span id="l10.188" class="difflineplus">+            failPoints.second, failPoints.third]);</span>
<a href="#l10.189"></a><span id="l10.189">     }</span>
<a href="#l10.190"></a><span id="l10.190"> }</span>
<a href="#l10.191"></a><span id="l10.191"> </span>
<a href="#l10.192"></a><span id="l10.192" class="difflineplus">+function handleSavePrompt(controller) {</span>
<a href="#l10.193"></a><span id="l10.193" class="difflineplus">+    let { lookup: cdlglookup } = helpersForController(controller);</span>
<a href="#l10.194"></a><span id="l10.194" class="difflineplus">+    // Unexpected prompt, thus the test has already failed.</span>
<a href="#l10.195"></a><span id="l10.195" class="difflineplus">+    // Can't trigger a failure though, because the following click wouldn't</span>
<a href="#l10.196"></a><span id="l10.196" class="difflineplus">+    // be executed. So remembering it.</span>
<a href="#l10.197"></a><span id="l10.197" class="difflineplus">+    savePromptAppeared = true;</span>
<a href="#l10.198"></a><span id="l10.198" class="difflineplus">+</span>
<a href="#l10.199"></a><span id="l10.199" class="difflineplus">+    // application close is blocked without it</span>
<a href="#l10.200"></a><span id="l10.200" class="difflineplus">+    controller.waitThenClick(cdlglookup(`</span>
<a href="#l10.201"></a><span id="l10.201" class="difflineplus">+        /id(&quot;commonDialog&quot;)/anon({&quot;anonid&quot;:&quot;buttons&quot;})/{&quot;dlgtype&quot;:&quot;extra1&quot;}</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineplus">+    `));</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineplus">+}</span>
<a href="#l10.204"></a><span id="l10.204" class="difflineplus">+</span>
<a href="#l10.205"></a><span id="l10.205"> function setupData() {</span>
<a href="#l10.206"></a><span id="l10.206">     return {</span>
<a href="#l10.207"></a><span id="l10.207">         date1: new Date(2009, 0, 1, 8, 0),</span>
<a href="#l10.208"></a><span id="l10.208">         date2: new Date(2009, 0, 2, 9, 0),</span>
<a href="#l10.209"></a><span id="l10.209">         date3: new Date(2009, 0, 3, 10, 0),</span>
<a href="#l10.210"></a><span id="l10.210">         data: [{</span>
<a href="#l10.211"></a><span id="l10.211">             title: &quot;title1&quot;,</span>
<a href="#l10.212"></a><span id="l10.212">             location: &quot;location1&quot;,</span>
<a href="#l10.213"></a><span id="l10.213" class="difflineminus">-            category: &quot;Anniversary&quot;,</span>
<a href="#l10.214"></a><span id="l10.214">             description: &quot;description1&quot;,</span>
<a href="#l10.215"></a><span id="l10.215" class="difflineplus">+            categories: [],</span>
<a href="#l10.216"></a><span id="l10.216">             allday: false,</span>
<a href="#l10.217"></a><span id="l10.217">             startdate: date1,</span>
<a href="#l10.218"></a><span id="l10.218">             starttime: date1,</span>
<a href="#l10.219"></a><span id="l10.219">             enddate: date2,</span>
<a href="#l10.220"></a><span id="l10.220">             endtime: date2,</span>
<a href="#l10.221"></a><span id="l10.221">             repeat: &quot;none&quot;,</span>
<a href="#l10.222"></a><span id="l10.222" class="difflineplus">+            reminder: &quot;none&quot;,</span>
<a href="#l10.223"></a><span id="l10.223">             priority: &quot;normal&quot;,</span>
<a href="#l10.224"></a><span id="l10.224">             privacy: &quot;public&quot;,</span>
<a href="#l10.225"></a><span id="l10.225">             status: &quot;confirmed&quot;,</span>
<a href="#l10.226"></a><span id="l10.226">             freebusy: &quot;busy&quot;,</span>
<a href="#l10.227"></a><span id="l10.227" class="difflineminus">-            timezone: true,</span>
<a href="#l10.228"></a><span id="l10.228" class="difflineplus">+            timezonedisplay: true,</span>
<a href="#l10.229"></a><span id="l10.229" class="difflineplus">+            attachment: { add: &quot;http://mozilla.org&quot; },</span>
<a href="#l10.230"></a><span id="l10.230" class="difflineplus">+            // Test fails when changing attendees, therefore leaving out for now.</span>
<a href="#l10.231"></a><span id="l10.231" class="difflineplus">+            // attendees: { add: &quot;foo@bar.de,foo@bar.com&quot; }</span>
<a href="#l10.232"></a><span id="l10.232">         }, {</span>
<a href="#l10.233"></a><span id="l10.233">             title: &quot;title2&quot;,</span>
<a href="#l10.234"></a><span id="l10.234">             location: &quot;location2&quot;,</span>
<a href="#l10.235"></a><span id="l10.235" class="difflineminus">-            category: &quot;Birthday&quot;,</span>
<a href="#l10.236"></a><span id="l10.236">             description: &quot;description2&quot;,</span>
<a href="#l10.237"></a><span id="l10.237" class="difflineplus">+            categories: [],</span>
<a href="#l10.238"></a><span id="l10.238">             allday: true,</span>
<a href="#l10.239"></a><span id="l10.239">             startdate: date2,</span>
<a href="#l10.240"></a><span id="l10.240">             starttime: date2,</span>
<a href="#l10.241"></a><span id="l10.241">             enddate: date3,</span>
<a href="#l10.242"></a><span id="l10.242">             endtime: date3,</span>
<a href="#l10.243"></a><span id="l10.243">             repeat: &quot;daily&quot;,</span>
<a href="#l10.244"></a><span id="l10.244" class="difflineplus">+            reminder: &quot;5minutes&quot;,</span>
<a href="#l10.245"></a><span id="l10.245">             priority: &quot;high&quot;,</span>
<a href="#l10.246"></a><span id="l10.246">             privacy: &quot;private&quot;,</span>
<a href="#l10.247"></a><span id="l10.247">             status: &quot;tentative&quot;,</span>
<a href="#l10.248"></a><span id="l10.248">             freebusy: &quot;free&quot;,</span>
<a href="#l10.249"></a><span id="l10.249" class="difflineminus">-            timezone: true,</span>
<a href="#l10.250"></a><span id="l10.250" class="difflineplus">+            timezonedisplay: false,</span>
<a href="#l10.251"></a><span id="l10.251" class="difflineplus">+            attachment: { remove: &quot;mozilla.org&quot; },</span>
<a href="#l10.252"></a><span id="l10.252" class="difflineplus">+            // attendees: { remove: &quot;foo@bar.de,foo@bar.com&quot; }</span>
<a href="#l10.253"></a><span id="l10.253">         }],</span>
<a href="#l10.254"></a><span id="l10.254">         newlines: [</span>
<a href="#l10.255"></a><span id="l10.255">             { title: &quot;title&quot;, description: &quot;  test spaces  &quot; },</span>
<a href="#l10.256"></a><span id="l10.256">             { title: &quot;title&quot;, description: &quot;\ntest newline\n&quot; },</span>
<a href="#l10.257"></a><span id="l10.257">             { title: &quot;title&quot;, description: &quot;\rtest \\r\r&quot; },</span>
<a href="#l10.258"></a><span id="l10.258">             { title: &quot;title&quot;, description: &quot;\r\ntest \\r\\n\r\n&quot; },</span>
<a href="#l10.259"></a><span id="l10.259">             { title: &quot;title&quot;, description: &quot;\ttest \\t\t&quot; }</span>
<a href="#l10.260"></a><span id="l10.260">         ]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">old mode 100644</span>
<a href="#l11.2"></a><span id="l11.2">new mode 100755</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineminus">--- a/calendar/test/mozmill/eventDialog/testEventDialogSize.js</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineplus">+++ b/calendar/test/mozmill/eventDialog/testEventDialogSize.js</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineat">@@ -1,12 +1,13 @@</span>
<a href="#l11.6"></a><span id="l11.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.7"></a><span id="l11.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.8"></a><span id="l11.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+var MODULE_NAME = &quot;testEventDialogSize&quot;;</span>
<a href="#l11.11"></a><span id="l11.11"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l11.12"></a><span id="l11.12"> var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;window-helpers&quot;];</span>
<a href="#l11.13"></a><span id="l11.13"> </span>
<a href="#l11.14"></a><span id="l11.14"> var helpersForController, invokeEventDialog, createCalendar, deleteCalendars;</span>
<a href="#l11.15"></a><span id="l11.15"> var CALENDARNAME;</span>
<a href="#l11.16"></a><span id="l11.16"> </span>
<a href="#l11.17"></a><span id="l11.17"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19" class="difflineat">@@ -16,17 +17,17 @@ function setupModule(module) {</span>
<a href="#l11.20"></a><span id="l11.20">     controller = mozmill.getMail3PaneController();</span>
<a href="#l11.21"></a><span id="l11.21">     ({</span>
<a href="#l11.22"></a><span id="l11.22">         helpersForController,</span>
<a href="#l11.23"></a><span id="l11.23">         invokeEventDialog,</span>
<a href="#l11.24"></a><span id="l11.24">         createCalendar,</span>
<a href="#l11.25"></a><span id="l11.25">         deleteCalendars,</span>
<a href="#l11.26"></a><span id="l11.26">         CALENDARNAME,</span>
<a href="#l11.27"></a><span id="l11.27">     } = collector.getModule(&quot;calendar-utils&quot;));</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-    collector.getModule(&quot;calendar-utils&quot;).setupModule();</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+    collector.getModule(&quot;calendar-utils&quot;).setupModule(controller);</span>
<a href="#l11.30"></a><span id="l11.30">     Object.assign(module, helpersForController(controller));</span>
<a href="#l11.31"></a><span id="l11.31"> </span>
<a href="#l11.32"></a><span id="l11.32">     createCalendar(controller, CALENDARNAME);</span>
<a href="#l11.33"></a><span id="l11.33"> }</span>
<a href="#l11.34"></a><span id="l11.34"> </span>
<a href="#l11.35"></a><span id="l11.35"> function testEventDialog() {</span>
<a href="#l11.36"></a><span id="l11.36">     dump(&quot;#ltnNewEvent click\n&quot;);</span>
<a href="#l11.37"></a><span id="l11.37">     controller.mainMenu.click(&quot;#ltnNewEvent&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/calendar/test/mozmill/eventDialog/testUTF8.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/calendar/test/mozmill/eventDialog/testUTF8.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1,85 +1,77 @@</span>
<a href="#l12.4"></a><span id="l12.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.5"></a><span id="l12.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.6"></a><span id="l12.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+var MODULE_NAME = &quot;testUTF8&quot;;</span>
<a href="#l12.9"></a><span id="l12.9"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineminus">-var MODULE_REQUIRES = [&quot;calendar-utils&quot;];</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineminus">-</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-var helpersForController, invokeEventDialog, createCalendar;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-var deleteCalendars, switchToView, setData;</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-var EVENT_BOX, CANVAS_BOX;</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;item-editing-helpers&quot;];</span>
<a href="#l12.16"></a><span id="l12.16"> </span>
<a href="#l12.17"></a><span id="l12.17"> ChromeUtils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l12.18"></a><span id="l12.18"> </span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+var EVENT_BOX, CANVAS_BOX;</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+var helpersForController, invokeEventDialog, createCalendar, deleteCalendars;</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+var setData;</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+</span>
<a href="#l12.23"></a><span id="l12.23"> var UTF8STRING = &quot; 💣 💥  ☣  &quot;;</span>
<a href="#l12.24"></a><span id="l12.24"> </span>
<a href="#l12.25"></a><span id="l12.25"> function setupModule(module) {</span>
<a href="#l12.26"></a><span id="l12.26">     controller = mozmill.getMail3PaneController();</span>
<a href="#l12.27"></a><span id="l12.27">     ({</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+        EVENT_BOX,</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+        CANVAS_BOX,</span>
<a href="#l12.30"></a><span id="l12.30">         helpersForController,</span>
<a href="#l12.31"></a><span id="l12.31">         invokeEventDialog,</span>
<a href="#l12.32"></a><span id="l12.32">         createCalendar,</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-        deleteCalendars,</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-        switchToView,</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-        setData,</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">-        EVENT_BOX,</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-        CANVAS_BOX</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+        deleteCalendars</span>
<a href="#l12.39"></a><span id="l12.39">     } = collector.getModule(&quot;calendar-utils&quot;));</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineminus">-    collector.getModule(&quot;calendar-utils&quot;).setupModule();</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+    collector.getModule(&quot;calendar-utils&quot;).setupModule(controller);</span>
<a href="#l12.42"></a><span id="l12.42">     Object.assign(module, helpersForController(controller));</span>
<a href="#l12.43"></a><span id="l12.43"> </span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+    ({ setData } = collector.getModule(&quot;item-editing-helpers&quot;));</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+    collector.getModule(&quot;item-editing-helpers&quot;).setupModule(module);</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+</span>
<a href="#l12.47"></a><span id="l12.47">     createCalendar(controller, UTF8STRING);</span>
<a href="#l12.48"></a><span id="l12.48">     Preferences.set(&quot;calendar.categories.names&quot;, UTF8STRING);</span>
<a href="#l12.49"></a><span id="l12.49"> }</span>
<a href="#l12.50"></a><span id="l12.50"> </span>
<a href="#l12.51"></a><span id="l12.51"> function testUTF8() {</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineminus">-    controller.click(eid(&quot;calendar-tab-button&quot;));</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineminus">-    switchToView(controller, &quot;day&quot;);</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineminus">-</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineminus">-    // create new event</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+    // Create new event.</span>
<a href="#l12.57"></a><span id="l12.57">     let eventBox = lookupEventBox(&quot;day&quot;, CANVAS_BOX, null, 1, 8);</span>
<a href="#l12.58"></a><span id="l12.58">     invokeEventDialog(controller, eventBox, (event, iframe) =&gt; {</span>
<a href="#l12.59"></a><span id="l12.59">         let { eid: eventid } = helpersForController(event);</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineminus">-        let { lookup: iframeLookup, eid: iframeId } = helpersForController(iframe);</span>
<a href="#l12.61"></a><span id="l12.61"> </span>
<a href="#l12.62"></a><span id="l12.62" class="difflineminus">-        // fill in name, location, description</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineminus">-        setData(event, iframe, { title: UTF8STRING, location: UTF8STRING, description: UTF8STRING });</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineminus">-</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineminus">-        let menuitem = iframeLookup(`</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineminus">-            /id(&quot;calendar-event-dialog-inner&quot;)/id(&quot;event-grid&quot;)/</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineminus">-            id(&quot;event-grid-rows&quot;)/id(&quot;event-grid-category-color-row&quot;)/</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineminus">-            id(&quot;event-grid-category-box&quot;)/id(&quot;item-categories&quot;)/</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineminus">-            id(&quot;item-categories-popup&quot;)/[2]</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineminus">-        `);</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineminus">-</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineminus">-        event.click(iframeId(&quot;item-categories&quot;));</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineminus">-        menuitem.getNode().click();</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineminus">-        menuitem.getNode().setAttribute(&quot;checked&quot;, &quot;true&quot;); // When in doubt, cheat.</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineminus">-        event.waitFor(() =&gt; iframeId(&quot;item-categories&quot;).getNode().label == UTF8STRING);</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineminus">-        iframeId(&quot;item-categories-popup&quot;).getNode().hidePopup();</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+        // Fill in name, location, description.</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+        setData(event, iframe, {</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+            title: UTF8STRING,</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+            location: UTF8STRING,</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+            description: UTF8STRING,</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+            categories: [UTF8STRING]</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+        });</span>
<a href="#l12.84"></a><span id="l12.84"> </span>
<a href="#l12.85"></a><span id="l12.85">         // save</span>
<a href="#l12.86"></a><span id="l12.86">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l12.87"></a><span id="l12.87">     });</span>
<a href="#l12.88"></a><span id="l12.88"> </span>
<a href="#l12.89"></a><span id="l12.89">     // open</span>
<a href="#l12.90"></a><span id="l12.90">     let eventPath = `/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;${UTF8STRING.toLowerCase()}&quot;}`;</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineminus">-    eventBox = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, 8, eventPath);</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+    eventBox = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, eventPath);</span>
<a href="#l12.93"></a><span id="l12.93">     invokeEventDialog(controller, eventBox, (event, iframe) =&gt; {</span>
<a href="#l12.94"></a><span id="l12.94">         let { eid: iframeId } = helpersForController(iframe);</span>
<a href="#l12.95"></a><span id="l12.95"> </span>
<a href="#l12.96"></a><span id="l12.96" class="difflineminus">-        // check values</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+        // Check values.</span>
<a href="#l12.98"></a><span id="l12.98">         event.assertValue(iframeId(&quot;item-title&quot;), UTF8STRING);</span>
<a href="#l12.99"></a><span id="l12.99">         event.assertValue(iframeId(&quot;item-location&quot;), UTF8STRING);</span>
<a href="#l12.100"></a><span id="l12.100">         event.assertValue(iframeId(&quot;item-description&quot;), UTF8STRING);</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineminus">-        event.assert(() =&gt; iframeId(&quot;item-categories&quot;).getNode().querySelector(`menuitem[label=&quot;${UTF8STRING}&quot;][checked]`));</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineplus">+        event.assert(() =&gt; iframeId(&quot;item-categories&quot;).getNode().querySelector(`</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineplus">+            menuitem[label=&quot;${UTF8STRING}&quot;][checked]</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+        `));</span>
<a href="#l12.105"></a><span id="l12.105"> </span>
<a href="#l12.106"></a><span id="l12.106" class="difflineminus">-        // escape the event window</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+        // Escape the event window.</span>
<a href="#l12.108"></a><span id="l12.108">         event.keypress(null, &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l12.109"></a><span id="l12.109">     });</span>
<a href="#l12.110"></a><span id="l12.110"> }</span>
<a href="#l12.111"></a><span id="l12.111"> </span>
<a href="#l12.112"></a><span id="l12.112"> function teardownTest(module) {</span>
<a href="#l12.113"></a><span id="l12.113">     deleteCalendars(controller, UTF8STRING);</span>
<a href="#l12.114"></a><span id="l12.114">     Preferences.reset(&quot;calendar.categories.names&quot;);</span>
<a href="#l12.115"></a><span id="l12.115"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">old mode 100644</span>
<a href="#l13.2"></a><span id="l13.2">new mode 100755</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineminus">--- a/calendar/test/mozmill/invitations/test-imip-bar-eml.js</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineplus">+++ b/calendar/test/mozmill/invitations/test-imip-bar-eml.js</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineat">@@ -3,24 +3,20 @@</span>
<a href="#l13.6"></a><span id="l13.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8"> /**</span>
<a href="#l13.9"></a><span id="l13.9">  * Test that the IMIP bar behaves properly for eml files.</span>
<a href="#l13.10"></a><span id="l13.10">  */</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12"> // make -C calendar/test/mozmill SOLO_TEST=invitations/test-imip-bar-eml.js mozmill-one</span>
<a href="#l13.13"></a><span id="l13.13"> </span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-var MODULE_NAME = &quot;invitations&quot;;</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+var MODULE_NAME = &quot;testInvitations&quot;;</span>
<a href="#l13.16"></a><span id="l13.16"> </span>
<a href="#l13.17"></a><span id="l13.17"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">-var MODULE_REQUIRES = [</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">-    &quot;folder-display-helpers&quot;,</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-    &quot;window-helpers&quot;,</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-    &quot;notificationbox-helpers&quot;</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-];</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;notificationbox-helpers&quot;];</span>
<a href="#l13.24"></a><span id="l13.24"> </span>
<a href="#l13.25"></a><span id="l13.25"> var os = {};</span>
<a href="#l13.26"></a><span id="l13.26"> ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;, os);</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28"> function setupModule(module) {</span>
<a href="#l13.29"></a><span id="l13.29">     for (let dep of MODULE_REQUIRES) {</span>
<a href="#l13.30"></a><span id="l13.30">         collector.getModule(dep).installInto(module);</span>
<a href="#l13.31"></a><span id="l13.31">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/calendar/test/mozmill/recurrenceRotated/testAnnualRecurrence.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/calendar/test/mozmill/recurrenceRotated/testAnnualRecurrence.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -1,13 +1,13 @@</span>
<a href="#l14.4"></a><span id="l14.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.5"></a><span id="l14.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.6"></a><span id="l14.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8" class="difflineminus">-var MODULE_NAME = &quot;testAnnualRecurrence&quot;;</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineplus">+var MODULE_NAME = &quot;testAnnualRecurrenceRotated&quot;;</span>
<a href="#l14.10"></a><span id="l14.10"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l14.11"></a><span id="l14.11"> var MODULE_REQUIRES = [&quot;calendar-utils&quot;];</span>
<a href="#l14.12"></a><span id="l14.12"> </span>
<a href="#l14.13"></a><span id="l14.13"> var CALENDARNAME, EVENTPATH, ALLDAY;</span>
<a href="#l14.14"></a><span id="l14.14"> var helpersForController, handleOccurrencePrompt, switchToView, goToDate;</span>
<a href="#l14.15"></a><span id="l14.15"> var invokeEventDialog, deleteCalendars, createCalendar, menulistSelect;</span>
<a href="#l14.16"></a><span id="l14.16"> </span>
<a href="#l14.17"></a><span id="l14.17"> const STARTYEAR = 1950;</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineat">@@ -23,81 +23,69 @@ function setupModule(module) {</span>
<a href="#l14.19"></a><span id="l14.19">         handleOccurrencePrompt,</span>
<a href="#l14.20"></a><span id="l14.20">         switchToView,</span>
<a href="#l14.21"></a><span id="l14.21">         goToDate,</span>
<a href="#l14.22"></a><span id="l14.22">         invokeEventDialog,</span>
<a href="#l14.23"></a><span id="l14.23">         deleteCalendars,</span>
<a href="#l14.24"></a><span id="l14.24">         createCalendar,</span>
<a href="#l14.25"></a><span id="l14.25">         menulistSelect</span>
<a href="#l14.26"></a><span id="l14.26">     } = collector.getModule(&quot;calendar-utils&quot;));</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">-    collector.getModule(&quot;calendar-utils&quot;).setupModule();</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+    collector.getModule(&quot;calendar-utils&quot;).setupModule(controller);</span>
<a href="#l14.29"></a><span id="l14.29">     Object.assign(module, helpersForController(controller));</span>
<a href="#l14.30"></a><span id="l14.30"> </span>
<a href="#l14.31"></a><span id="l14.31">     createCalendar(controller, CALENDARNAME);</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+    // Rotate view.</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+    controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+    controller.waitFor(() =&gt; eid(&quot;day-view&quot;).getNode().orient == &quot;horizontal&quot;);</span>
<a href="#l14.35"></a><span id="l14.35"> }</span>
<a href="#l14.36"></a><span id="l14.36"> </span>
<a href="#l14.37"></a><span id="l14.37"> function testAnnualRecurrence() {</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">-    controller.click(eid(&quot;calendar-tab-button&quot;));</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-    sleep();</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-    switchToView(controller, &quot;day&quot;);</span>
<a href="#l14.42"></a><span id="l14.42">     goToDate(controller, STARTYEAR, 1, 1);</span>
<a href="#l14.43"></a><span id="l14.43"> </span>
<a href="#l14.44"></a><span id="l14.44" class="difflineminus">-    // rotate view</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">-    controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-    controller.waitFor(() =&gt; eid(&quot;day-view&quot;).getNode().orient == &quot;horizontal&quot;);</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-    // create yearly recurring all-day event</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+    // Create yearly recurring all-day event.</span>
<a href="#l14.50"></a><span id="l14.50">     let eventBox = lookupEventBox(&quot;day&quot;, ALLDAY, null, 1, null);</span>
<a href="#l14.51"></a><span id="l14.51">     invokeEventDialog(controller, eventBox, (event, iframe) =&gt; {</span>
<a href="#l14.52"></a><span id="l14.52">         let { eid: eventid } = helpersForController(event);</span>
<a href="#l14.53"></a><span id="l14.53"> </span>
<a href="#l14.54"></a><span id="l14.54">         menulistSelect(eventid(&quot;item-repeat&quot;), &quot;yearly&quot;, event);</span>
<a href="#l14.55"></a><span id="l14.55">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l14.56"></a><span id="l14.56">     });</span>
<a href="#l14.57"></a><span id="l14.57"> </span>
<a href="#l14.58"></a><span id="l14.58">     let checkYears = [STARTYEAR, STARTYEAR + 1, EPOCH - 1, EPOCH, EPOCH + 1];</span>
<a href="#l14.59"></a><span id="l14.59">     for (let year of checkYears) {</span>
<a href="#l14.60"></a><span id="l14.60">         goToDate(controller, year, 1, 1);</span>
<a href="#l14.61"></a><span id="l14.61">         let date = new Date(year, 0, 1);</span>
<a href="#l14.62"></a><span id="l14.62">         let column = date.getDay() + 1;</span>
<a href="#l14.63"></a><span id="l14.63"> </span>
<a href="#l14.64"></a><span id="l14.64">         // day view</span>
<a href="#l14.65"></a><span id="l14.65">         switchToView(controller, &quot;day&quot;);</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineminus">-            lookupEventBox(&quot;day&quot;, ALLDAY, null, 1, null, EVENTPATH)</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineminus">-        );</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;day&quot;, ALLDAY, null, 1, null, EVENTPATH));</span>
<a href="#l14.70"></a><span id="l14.70"> </span>
<a href="#l14.71"></a><span id="l14.71">         // week view</span>
<a href="#l14.72"></a><span id="l14.72">         switchToView(controller, &quot;week&quot;);</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineminus">-            lookupEventBox(&quot;week&quot;, ALLDAY, null, column, null, EVENTPATH)</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineminus">-        );</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;week&quot;, ALLDAY, null, column, null, EVENTPATH));</span>
<a href="#l14.77"></a><span id="l14.77"> </span>
<a href="#l14.78"></a><span id="l14.78">         // multiweek view</span>
<a href="#l14.79"></a><span id="l14.79">         switchToView(controller, &quot;multiweek&quot;);</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineminus">-            lookupEventBox(&quot;multiweek&quot;, ALLDAY, 1, column, null, EVENTPATH)</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineminus">-        );</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;multiweek&quot;, ALLDAY, 1, column, null, EVENTPATH));</span>
<a href="#l14.84"></a><span id="l14.84"> </span>
<a href="#l14.85"></a><span id="l14.85">         // month view</span>
<a href="#l14.86"></a><span id="l14.86">         switchToView(controller, &quot;month&quot;);</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineminus">-            lookupEventBox(&quot;month&quot;, ALLDAY, 1, column, null, EVENTPATH)</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineminus">-        );</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;month&quot;, ALLDAY, 1, column, null, EVENTPATH));</span>
<a href="#l14.91"></a><span id="l14.91">     }</span>
<a href="#l14.92"></a><span id="l14.92"> </span>
<a href="#l14.93"></a><span id="l14.93" class="difflineminus">-    // delete event</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+    // Delete event.</span>
<a href="#l14.95"></a><span id="l14.95">     goToDate(controller, checkYears[0], 1, 1);</span>
<a href="#l14.96"></a><span id="l14.96">     switchToView(controller, &quot;day&quot;);</span>
<a href="#l14.97"></a><span id="l14.97">     let box = getEventBoxPath(&quot;day&quot;, ALLDAY, null, 1, null) + EVENTPATH;</span>
<a href="#l14.98"></a><span id="l14.98">     controller.click(lookup(box));</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineminus">-    handleOccurrencePrompt(controller, eid(&quot;day-view&quot;), &quot;delete&quot;, true, false);</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineplus">+    handleOccurrencePrompt(controller, eid(&quot;day-view&quot;), &quot;delete&quot;, true);</span>
<a href="#l14.101"></a><span id="l14.101">     controller.waitForElementNotPresent(lookup(box));</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineminus">-</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineminus">-    // reset view</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineminus">-    controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineminus">-    controller.waitFor(() =&gt; eid(&quot;day-view&quot;).getNode().orient == &quot;vertical&quot;);</span>
<a href="#l14.106"></a><span id="l14.106"> }</span>
<a href="#l14.107"></a><span id="l14.107"> </span>
<a href="#l14.108"></a><span id="l14.108"> function teardownTest(module) {</span>
<a href="#l14.109"></a><span id="l14.109">     deleteCalendars(controller, CALENDARNAME);</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineplus">+    // Reset view.</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+    if (eid(&quot;day-view&quot;).getNode().orient == &quot;horizontal&quot;) {</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineplus">+        controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineplus">+    }</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+    controller.waitFor(() =&gt; eid(&quot;day-view&quot;).getNode().orient == &quot;vertical&quot;);</span>
<a href="#l14.115"></a><span id="l14.115"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/calendar/test/mozmill/recurrenceRotated/testBiweeklyRecurrence.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/calendar/test/mozmill/recurrenceRotated/testBiweeklyRecurrence.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1,13 +1,13 @@</span>
<a href="#l15.4"></a><span id="l15.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.5"></a><span id="l15.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.6"></a><span id="l15.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.7"></a><span id="l15.7"> </span>
<a href="#l15.8"></a><span id="l15.8" class="difflineminus">-var MODULE_NAME = &quot;testBiweeklyRecurrence&quot;;</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineplus">+var MODULE_NAME = &quot;testBiweeklyRecurrenceRotated&quot;;</span>
<a href="#l15.10"></a><span id="l15.10"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l15.11"></a><span id="l15.11"> var MODULE_REQUIRES = [&quot;calendar-utils&quot;];</span>
<a href="#l15.12"></a><span id="l15.12"> </span>
<a href="#l15.13"></a><span id="l15.13"> var CALENDARNAME, EVENTPATH, EVENT_BOX, CANVAS_BOX;</span>
<a href="#l15.14"></a><span id="l15.14"> var helpersForController, handleOccurrencePrompt, switchToView, goToDate;</span>
<a href="#l15.15"></a><span id="l15.15"> var invokeEventDialog, viewForward, createCalendar, deleteCalendars, menulistSelect;</span>
<a href="#l15.16"></a><span id="l15.16"> </span>
<a href="#l15.17"></a><span id="l15.17"> const HOUR = 8;</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineat">@@ -24,98 +24,92 @@ function setupModule(module) {</span>
<a href="#l15.19"></a><span id="l15.19">         switchToView,</span>
<a href="#l15.20"></a><span id="l15.20">         goToDate,</span>
<a href="#l15.21"></a><span id="l15.21">         invokeEventDialog,</span>
<a href="#l15.22"></a><span id="l15.22">         viewForward,</span>
<a href="#l15.23"></a><span id="l15.23">         deleteCalendars,</span>
<a href="#l15.24"></a><span id="l15.24">         createCalendar,</span>
<a href="#l15.25"></a><span id="l15.25">         menulistSelect</span>
<a href="#l15.26"></a><span id="l15.26">     } = collector.getModule(&quot;calendar-utils&quot;));</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineminus">-    collector.getModule(&quot;calendar-utils&quot;).setupModule();</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+    collector.getModule(&quot;calendar-utils&quot;).setupModule(controller);</span>
<a href="#l15.29"></a><span id="l15.29">     Object.assign(module, helpersForController(controller));</span>
<a href="#l15.30"></a><span id="l15.30"> </span>
<a href="#l15.31"></a><span id="l15.31">     createCalendar(controller, CALENDARNAME);</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+    // rotate view</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+    controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+    controller.waitFor(() =&gt; eid(&quot;day-view&quot;).getNode().orient == &quot;horizontal&quot;);</span>
<a href="#l15.35"></a><span id="l15.35"> }</span>
<a href="#l15.36"></a><span id="l15.36"> </span>
<a href="#l15.37"></a><span id="l15.37"> function testBiweeklyRecurrence() {</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineminus">-    controller.click(eid(&quot;calendar-tab-button&quot;));</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineminus">-    switchToView(controller, &quot;day&quot;);</span>
<a href="#l15.40"></a><span id="l15.40">     goToDate(controller, 2009, 1, 31);</span>
<a href="#l15.41"></a><span id="l15.41"> </span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">-    // rotate view</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineminus">-    controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineminus">-    controller.waitFor(() =&gt; eid(&quot;day-view&quot;).getNode().orient == &quot;horizontal&quot;);</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineminus">-</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineminus">-    // create biweekly event</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+    // Create biweekly event.</span>
<a href="#l15.48"></a><span id="l15.48">     let eventBox = lookupEventBox(&quot;day&quot;, CANVAS_BOX, null, 1, HOUR);</span>
<a href="#l15.49"></a><span id="l15.49">     invokeEventDialog(controller, eventBox, (event, iframe) =&gt; {</span>
<a href="#l15.50"></a><span id="l15.50">         let { eid: eventid } = helpersForController(event);</span>
<a href="#l15.51"></a><span id="l15.51"> </span>
<a href="#l15.52"></a><span id="l15.52">         menulistSelect(eventid(&quot;item-repeat&quot;), &quot;bi.weekly&quot;, event);</span>
<a href="#l15.53"></a><span id="l15.53">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l15.54"></a><span id="l15.54">     });</span>
<a href="#l15.55"></a><span id="l15.55"> </span>
<a href="#l15.56"></a><span id="l15.56" class="difflineminus">-    // check day view</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+    // Check day view.</span>
<a href="#l15.58"></a><span id="l15.58">     for (let i = 0; i &lt; 4; i++) {</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineminus">-            lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, HOUR, EVENTPATH)</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineminus">-        );</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, EVENTPATH));</span>
<a href="#l15.63"></a><span id="l15.63">         viewForward(controller, 14);</span>
<a href="#l15.64"></a><span id="l15.64">     }</span>
<a href="#l15.65"></a><span id="l15.65"> </span>
<a href="#l15.66"></a><span id="l15.66" class="difflineminus">-    // check week view</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineplus">+    // Check week view.</span>
<a href="#l15.68"></a><span id="l15.68">     switchToView(controller, &quot;week&quot;);</span>
<a href="#l15.69"></a><span id="l15.69">     goToDate(controller, 2009, 1, 31);</span>
<a href="#l15.70"></a><span id="l15.70"> </span>
<a href="#l15.71"></a><span id="l15.71">     for (let i = 0; i &lt; 4; i++) {</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineminus">-            lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 7, HOUR, EVENTPATH)</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineminus">-        );</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 7, null, EVENTPATH));</span>
<a href="#l15.76"></a><span id="l15.76">         viewForward(controller, 2);</span>
<a href="#l15.77"></a><span id="l15.77">     }</span>
<a href="#l15.78"></a><span id="l15.78"> </span>
<a href="#l15.79"></a><span id="l15.79" class="difflineminus">-    // check multiweek view</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineplus">+    // Check multiweek view.</span>
<a href="#l15.81"></a><span id="l15.81">     switchToView(controller, &quot;multiweek&quot;);</span>
<a href="#l15.82"></a><span id="l15.82">     goToDate(controller, 2009, 1, 31);</span>
<a href="#l15.83"></a><span id="l15.83"> </span>
<a href="#l15.84"></a><span id="l15.84" class="difflineminus">-    // always two occurrences in view, 1st and 3rd or 2nd and 4th week</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineplus">+    // Always two occurrences in view, 1st and 3rd or 2nd and 4th week.</span>
<a href="#l15.86"></a><span id="l15.86">     for (let i = 0; i &lt; 5; i++) {</span>
<a href="#l15.87"></a><span id="l15.87">         controller.waitForElement(</span>
<a href="#l15.88"></a><span id="l15.88">             lookupEventBox(&quot;multiweek&quot;, EVENT_BOX, i % 2 + 1, 7, null, EVENTPATH)</span>
<a href="#l15.89"></a><span id="l15.89">         );</span>
<a href="#l15.90"></a><span id="l15.90">         controller.assertNode(</span>
<a href="#l15.91"></a><span id="l15.91">             lookupEventBox(&quot;multiweek&quot;, EVENT_BOX, i % 2 + 3, 7, null, EVENTPATH)</span>
<a href="#l15.92"></a><span id="l15.92">         );</span>
<a href="#l15.93"></a><span id="l15.93">         viewForward(controller, 1);</span>
<a href="#l15.94"></a><span id="l15.94">     }</span>
<a href="#l15.95"></a><span id="l15.95"> </span>
<a href="#l15.96"></a><span id="l15.96" class="difflineminus">-    // check month view</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineplus">+    // Check month view.</span>
<a href="#l15.98"></a><span id="l15.98">     switchToView(controller, &quot;month&quot;);</span>
<a href="#l15.99"></a><span id="l15.99">     goToDate(controller, 2009, 1, 31);</span>
<a href="#l15.100"></a><span id="l15.100"> </span>
<a href="#l15.101"></a><span id="l15.101">     // January</span>
<a href="#l15.102"></a><span id="l15.102">     controller.waitForElement(lookupEventBox(&quot;month&quot;, EVENT_BOX, 5, 7, null, EVENTPATH));</span>
<a href="#l15.103"></a><span id="l15.103">     viewForward(controller, 1);</span>
<a href="#l15.104"></a><span id="l15.104"> </span>
<a href="#l15.105"></a><span id="l15.105">     // February</span>
<a href="#l15.106"></a><span id="l15.106">     controller.waitForElement(lookupEventBox(&quot;month&quot;, EVENT_BOX, 2, 7, null, EVENTPATH));</span>
<a href="#l15.107"></a><span id="l15.107">     controller.assertNode(lookupEventBox(&quot;month&quot;, EVENT_BOX, 4, 7, null, EVENTPATH));</span>
<a href="#l15.108"></a><span id="l15.108">     viewForward(controller, 1);</span>
<a href="#l15.109"></a><span id="l15.109"> </span>
<a href="#l15.110"></a><span id="l15.110">     // March</span>
<a href="#l15.111"></a><span id="l15.111">     controller.waitForElement(lookupEventBox(&quot;month&quot;, EVENT_BOX, 2, 7, null, EVENTPATH));</span>
<a href="#l15.112"></a><span id="l15.112">     controller.assertNode(lookupEventBox(&quot;month&quot;, EVENT_BOX, 4, 7, null, EVENTPATH));</span>
<a href="#l15.113"></a><span id="l15.113"> </span>
<a href="#l15.114"></a><span id="l15.114" class="difflineminus">-    // delete event</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineplus">+    // Delete event.</span>
<a href="#l15.116"></a><span id="l15.116">     let box = lookupEventBox(&quot;month&quot;, EVENT_BOX, 4, 7, null, EVENTPATH);</span>
<a href="#l15.117"></a><span id="l15.117">     controller.click(box);</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineminus">-    handleOccurrencePrompt(controller, eid(&quot;month-view&quot;), &quot;delete&quot;, true, false);</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineplus">+    handleOccurrencePrompt(controller, eid(&quot;month-view&quot;), &quot;delete&quot;, true);</span>
<a href="#l15.120"></a><span id="l15.120">     controller.waitForElementNotPresent(box);</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineminus">-</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineminus">-    // reset view</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineminus">-    switchToView(controller, &quot;day&quot;);</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineminus">-    controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineminus">-    controller.waitFor(() =&gt; eid(&quot;day-view&quot;).getNode().orient == &quot;vertical&quot;);</span>
<a href="#l15.126"></a><span id="l15.126"> }</span>
<a href="#l15.127"></a><span id="l15.127"> </span>
<a href="#l15.128"></a><span id="l15.128"> function teardownTest(module) {</span>
<a href="#l15.129"></a><span id="l15.129">     deleteCalendars(controller, CALENDARNAME);</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineplus">+    // Reset view.</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineplus">+    switchToView(controller, &quot;day&quot;);</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineplus">+    if (eid(&quot;day-view&quot;).getNode().orient == &quot;horizontal&quot;) {</span>
<a href="#l15.133"></a><span id="l15.133" class="difflineplus">+        controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l15.134"></a><span id="l15.134" class="difflineplus">+    }</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineplus">+    controller.waitFor(() =&gt; eid(&quot;day-view&quot;).getNode().orient == &quot;vertical&quot;);</span>
<a href="#l15.136"></a><span id="l15.136"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/calendar/test/mozmill/recurrenceRotated/testDailyRecurrence.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/calendar/test/mozmill/recurrenceRotated/testDailyRecurrence.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -1,20 +1,21 @@</span>
<a href="#l16.4"></a><span id="l16.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.5"></a><span id="l16.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.6"></a><span id="l16.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.7"></a><span id="l16.7"> </span>
<a href="#l16.8"></a><span id="l16.8" class="difflineminus">-var MODULE_NAME = &quot;testDailyRecurrence&quot;;</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineplus">+var MODULE_NAME = &quot;testDailyRecurrenceRotated&quot;;</span>
<a href="#l16.10"></a><span id="l16.10"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineminus">-var MODULE_REQUIRES = [&quot;calendar-utils&quot;];</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;item-editing-helpers&quot;];</span>
<a href="#l16.13"></a><span id="l16.13"> </span>
<a href="#l16.14"></a><span id="l16.14"> var CALENDARNAME, EVENTPATH, EVENT_BOX, CANVAS_BOX;</span>
<a href="#l16.15"></a><span id="l16.15"> var helpersForController, invokeEventDialog, createCalendar, deleteCalendars;</span>
<a href="#l16.16"></a><span id="l16.16"> var switchToView, goToDate, viewForward, viewBack, handleOccurrencePrompt;</span>
<a href="#l16.17"></a><span id="l16.17"> var menulistSelect;</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+var setData;</span>
<a href="#l16.19"></a><span id="l16.19"> </span>
<a href="#l16.20"></a><span id="l16.20"> const HOUR = 8;</span>
<a href="#l16.21"></a><span id="l16.21"> </span>
<a href="#l16.22"></a><span id="l16.22"> function setupModule(module) {</span>
<a href="#l16.23"></a><span id="l16.23">     controller = mozmill.getMail3PaneController();</span>
<a href="#l16.24"></a><span id="l16.24">     ({</span>
<a href="#l16.25"></a><span id="l16.25">         CALENDARNAME,</span>
<a href="#l16.26"></a><span id="l16.26">         EVENTPATH,</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineat">@@ -26,197 +27,178 @@ function setupModule(module) {</span>
<a href="#l16.28"></a><span id="l16.28">         goToDate,</span>
<a href="#l16.29"></a><span id="l16.29">         invokeEventDialog,</span>
<a href="#l16.30"></a><span id="l16.30">         viewForward,</span>
<a href="#l16.31"></a><span id="l16.31">         viewBack,</span>
<a href="#l16.32"></a><span id="l16.32">         deleteCalendars,</span>
<a href="#l16.33"></a><span id="l16.33">         createCalendar,</span>
<a href="#l16.34"></a><span id="l16.34">         menulistSelect</span>
<a href="#l16.35"></a><span id="l16.35">     } = collector.getModule(&quot;calendar-utils&quot;));</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineminus">-    collector.getModule(&quot;calendar-utils&quot;).setupModule();</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+    collector.getModule(&quot;calendar-utils&quot;).setupModule(controller);</span>
<a href="#l16.38"></a><span id="l16.38">     Object.assign(module, helpersForController(controller));</span>
<a href="#l16.39"></a><span id="l16.39"> </span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+    ({ setData } = collector.getModule(&quot;item-editing-helpers&quot;));</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+    collector.getModule(&quot;item-editing-helpers&quot;).setupModule(module);</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+</span>
<a href="#l16.43"></a><span id="l16.43">     createCalendar(controller, CALENDARNAME);</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineplus">+    // Rotate view.</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+    controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineplus">+    controller.waitFor(() =&gt; eid(&quot;day-view&quot;).getNode().orient == &quot;horizontal&quot;);</span>
<a href="#l16.48"></a><span id="l16.48"> }</span>
<a href="#l16.49"></a><span id="l16.49"> </span>
<a href="#l16.50"></a><span id="l16.50"> function testDailyRecurrence() {</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineminus">-    controller.click(eid(&quot;calendar-tab-button&quot;));</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineminus">-    switchToView(controller, &quot;day&quot;);</span>
<a href="#l16.53"></a><span id="l16.53">     goToDate(controller, 2009, 1, 1);</span>
<a href="#l16.54"></a><span id="l16.54"> </span>
<a href="#l16.55"></a><span id="l16.55" class="difflineminus">-    // rotate view</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineminus">-    controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineminus">-    controller.waitFor(() =&gt; eid(&quot;day-view&quot;).getNode().orient == &quot;horizontal&quot;);</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineminus">-</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineminus">-    // create daily event</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+    // Create daily event.</span>
<a href="#l16.61"></a><span id="l16.61">     let eventBox = lookupEventBox(&quot;day&quot;, CANVAS_BOX, null, 1, HOUR);</span>
<a href="#l16.62"></a><span id="l16.62">     invokeEventDialog(controller, eventBox, (event, iframe) =&gt; {</span>
<a href="#l16.63"></a><span id="l16.63">         let { eid: eventid } = helpersForController(event);</span>
<a href="#l16.64"></a><span id="l16.64"> </span>
<a href="#l16.65"></a><span id="l16.65" class="difflineminus">-        menulistSelect(eventid(&quot;item-repeat&quot;), &quot;daily&quot;, event);</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+        setData(event, iframe, { repeat: &quot;daily&quot;, repeatuntil: new Date(2009, 2, 20) });</span>
<a href="#l16.67"></a><span id="l16.67">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l16.68"></a><span id="l16.68">     });</span>
<a href="#l16.69"></a><span id="l16.69"> </span>
<a href="#l16.70"></a><span id="l16.70" class="difflineminus">-    // check day view for 7 days</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineminus">-    let daybox = getEventBoxPath(&quot;day&quot;, EVENT_BOX, null, 1, HOUR, null) + EVENTPATH;</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineminus">-    controller.waitForElement(lookup(daybox));</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineplus">+    // Check day view for 7 days.</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineplus">+    let daybox = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, EVENTPATH);</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+    controller.waitForElement(daybox);</span>
<a href="#l16.76"></a><span id="l16.76"> </span>
<a href="#l16.77"></a><span id="l16.77">     for (let day = 1; day &lt;= 7; day++) {</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineminus">-        controller.waitForElement(lookup(daybox));</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+        controller.waitForElement(daybox);</span>
<a href="#l16.80"></a><span id="l16.80">         viewForward(controller, 1);</span>
<a href="#l16.81"></a><span id="l16.81">     }</span>
<a href="#l16.82"></a><span id="l16.82"> </span>
<a href="#l16.83"></a><span id="l16.83" class="difflineminus">-    // check week view for 2 weeks</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineplus">+    // Check week view for 2 weeks.</span>
<a href="#l16.85"></a><span id="l16.85">     switchToView(controller, &quot;week&quot;);</span>
<a href="#l16.86"></a><span id="l16.86">     goToDate(controller, 2009, 1, 1);</span>
<a href="#l16.87"></a><span id="l16.87"> </span>
<a href="#l16.88"></a><span id="l16.88">     for (let day = 5; day &lt;= 7; day++) {</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineminus">-            lookupEventBox(&quot;week&quot;, EVENT_BOX, 1, day, HOUR, EVENTPATH)</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineminus">-        );</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;week&quot;, EVENT_BOX, 1, day, null, EVENTPATH));</span>
<a href="#l16.93"></a><span id="l16.93">     }</span>
<a href="#l16.94"></a><span id="l16.94"> </span>
<a href="#l16.95"></a><span id="l16.95">     viewForward(controller, 1);</span>
<a href="#l16.96"></a><span id="l16.96"> </span>
<a href="#l16.97"></a><span id="l16.97">     for (let day = 1; day &lt;= 7; day++) {</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineminus">-            lookupEventBox(&quot;week&quot;, EVENT_BOX, 2, day, HOUR, EVENTPATH)</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineminus">-        );</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;week&quot;, EVENT_BOX, 2, day, null, EVENTPATH));</span>
<a href="#l16.102"></a><span id="l16.102">     }</span>
<a href="#l16.103"></a><span id="l16.103"> </span>
<a href="#l16.104"></a><span id="l16.104" class="difflineminus">-    // check multiweek view for 4 weeks</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineplus">+    // Check multiweek view for 4 weeks.</span>
<a href="#l16.106"></a><span id="l16.106">     switchToView(controller, &quot;multiweek&quot;);</span>
<a href="#l16.107"></a><span id="l16.107">     goToDate(controller, 2009, 1, 1);</span>
<a href="#l16.108"></a><span id="l16.108"> </span>
<a href="#l16.109"></a><span id="l16.109">     for (let day = 5; day &lt;= 7; day++) {</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineminus">-            lookupEventBox(&quot;multiweek&quot;, EVENT_BOX, 1, day, HOUR, EVENTPATH)</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineminus">-        );</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;multiweek&quot;, EVENT_BOX, 1, day, null, EVENTPATH));</span>
<a href="#l16.114"></a><span id="l16.114">     }</span>
<a href="#l16.115"></a><span id="l16.115"> </span>
<a href="#l16.116"></a><span id="l16.116">     for (let week = 2; week &lt;= 4; week++) {</span>
<a href="#l16.117"></a><span id="l16.117">         for (let day = 1; day &lt;= 7; day++) {</span>
<a href="#l16.118"></a><span id="l16.118">             controller.waitForElement(</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineminus">-                lookupEventBox(&quot;multiweek&quot;, EVENT_BOX, week, day, HOUR, EVENTPATH)</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineplus">+                lookupEventBox(&quot;multiweek&quot;, EVENT_BOX, week, day, null, EVENTPATH)</span>
<a href="#l16.121"></a><span id="l16.121">             );</span>
<a href="#l16.122"></a><span id="l16.122">         }</span>
<a href="#l16.123"></a><span id="l16.123">     }</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineminus">-</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineminus">-    // check month view for all 5 weeks</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineplus">+    // Check month view for all 5 weeks.</span>
<a href="#l16.127"></a><span id="l16.127">     switchToView(controller, &quot;month&quot;);</span>
<a href="#l16.128"></a><span id="l16.128">     goToDate(controller, 2009, 1, 1);</span>
<a href="#l16.129"></a><span id="l16.129"> </span>
<a href="#l16.130"></a><span id="l16.130">     for (let day = 5; day &lt;= 7; day++) {</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineminus">-            lookupEventBox(&quot;month&quot;, EVENT_BOX, 1, day, null, EVENTPATH)</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineminus">-        );</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;month&quot;, EVENT_BOX, 1, day, null, EVENTPATH));</span>
<a href="#l16.135"></a><span id="l16.135">     }</span>
<a href="#l16.136"></a><span id="l16.136"> </span>
<a href="#l16.137"></a><span id="l16.137">     for (let week = 2; week &lt;= 5; week++) {</span>
<a href="#l16.138"></a><span id="l16.138">         for (let day = 1; day &lt;= 7; day++) {</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineminus">-            controller.assertNode(</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineminus">-                lookupEventBox(&quot;month&quot;, EVENT_BOX, week, day, null, EVENTPATH)</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineminus">-            );</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineplus">+            controller.assertNode(lookupEventBox(&quot;month&quot;, EVENT_BOX, week, day, null, EVENTPATH));</span>
<a href="#l16.143"></a><span id="l16.143">         }</span>
<a href="#l16.144"></a><span id="l16.144">     }</span>
<a href="#l16.145"></a><span id="l16.145"> </span>
<a href="#l16.146"></a><span id="l16.146" class="difflineminus">-    // delete 3rd January occurrence</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineminus">-    let saturday = getEventBoxPath(&quot;month&quot;, EVENT_BOX, 1, 7, null) + EVENTPATH;</span>
<a href="#l16.148"></a><span id="l16.148" class="difflineminus">-    controller.click(lookup(saturday));</span>
<a href="#l16.149"></a><span id="l16.149" class="difflineminus">-    handleOccurrencePrompt(controller, eid(&quot;month-view&quot;), &quot;delete&quot;, false, false);</span>
<a href="#l16.150"></a><span id="l16.150" class="difflineplus">+    // Delete 3rd January occurrence.</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineplus">+    let saturday = lookupEventBox(&quot;month&quot;, EVENT_BOX, 1, 7, null, EVENTPATH);</span>
<a href="#l16.152"></a><span id="l16.152" class="difflineplus">+    controller.click(saturday);</span>
<a href="#l16.153"></a><span id="l16.153" class="difflineplus">+    handleOccurrencePrompt(controller, eid(&quot;month-view&quot;), &quot;delete&quot;, false);</span>
<a href="#l16.154"></a><span id="l16.154"> </span>
<a href="#l16.155"></a><span id="l16.155" class="difflineminus">-    // verify in all views</span>
<a href="#l16.156"></a><span id="l16.156" class="difflineminus">-    controller.waitForElementNotPresent(lookup(saturday));</span>
<a href="#l16.157"></a><span id="l16.157" class="difflineplus">+    // Verify in all views.</span>
<a href="#l16.158"></a><span id="l16.158" class="difflineplus">+    controller.waitForElementNotPresent(saturday);</span>
<a href="#l16.159"></a><span id="l16.159"> </span>
<a href="#l16.160"></a><span id="l16.160">     switchToView(controller, &quot;multiweek&quot;);</span>
<a href="#l16.161"></a><span id="l16.161" class="difflineminus">-    controller.assertNodeNotExist(</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineminus">-        lookupEventBox(&quot;multiweek&quot;, EVENT_BOX, 1, 7, null, EVENTPATH)</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineminus">-    );</span>
<a href="#l16.164"></a><span id="l16.164" class="difflineplus">+    controller.assertNodeNotExist(lookupEventBox(&quot;multiweek&quot;, EVENT_BOX, 1, 7, null, EVENTPATH));</span>
<a href="#l16.165"></a><span id="l16.165"> </span>
<a href="#l16.166"></a><span id="l16.166">     switchToView(controller, &quot;week&quot;);</span>
<a href="#l16.167"></a><span id="l16.167" class="difflineminus">-    controller.assertNodeNotExist(</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineminus">-        lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 7, null, EVENTPATH)</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineminus">-    );</span>
<a href="#l16.170"></a><span id="l16.170" class="difflineplus">+    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 7, null, EVENTPATH));</span>
<a href="#l16.171"></a><span id="l16.171"> </span>
<a href="#l16.172"></a><span id="l16.172">     switchToView(controller, &quot;day&quot;);</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineminus">-    controller.assertNodeNotExist(</span>
<a href="#l16.174"></a><span id="l16.174" class="difflineminus">-        lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, EVENTPATH)</span>
<a href="#l16.175"></a><span id="l16.175" class="difflineminus">-    );</span>
<a href="#l16.176"></a><span id="l16.176" class="difflineplus">+    controller.assertNodeNotExist(lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, EVENTPATH));</span>
<a href="#l16.177"></a><span id="l16.177"> </span>
<a href="#l16.178"></a><span id="l16.178" class="difflineminus">-    // go to previous day to edit event to occur only on weekdays</span>
<a href="#l16.179"></a><span id="l16.179" class="difflineplus">+    // Go to previous day to edit event to occur only on weekdays.</span>
<a href="#l16.180"></a><span id="l16.180">     viewBack(controller, 1);</span>
<a href="#l16.181"></a><span id="l16.181"> </span>
<a href="#l16.182"></a><span id="l16.182" class="difflineminus">-    eventBox = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, HOUR, EVENTPATH);</span>
<a href="#l16.183"></a><span id="l16.183" class="difflineminus">-    handleOccurrencePrompt(controller, eventBox, &quot;modify&quot;, true, false);</span>
<a href="#l16.184"></a><span id="l16.184" class="difflineplus">+    eventBox = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, EVENTPATH);</span>
<a href="#l16.185"></a><span id="l16.185" class="difflineplus">+    handleOccurrencePrompt(controller, eventBox, &quot;modify&quot;, true);</span>
<a href="#l16.186"></a><span id="l16.186">     invokeEventDialog(controller, null, (event, iframe) =&gt; {</span>
<a href="#l16.187"></a><span id="l16.187">         let { eid: eventid, sleep: eventsleep } = helpersForController(event);</span>
<a href="#l16.188"></a><span id="l16.188"> </span>
<a href="#l16.189"></a><span id="l16.189">         menulistSelect(eventid(&quot;item-repeat&quot;), &quot;every.weekday&quot;, event);</span>
<a href="#l16.190"></a><span id="l16.190">         eventsleep();</span>
<a href="#l16.191"></a><span id="l16.191">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l16.192"></a><span id="l16.192">     });</span>
<a href="#l16.193"></a><span id="l16.193"> </span>
<a href="#l16.194"></a><span id="l16.194" class="difflineminus">-    // check day view for 7 days</span>
<a href="#l16.195"></a><span id="l16.195" class="difflineminus">-    let day = getEventBoxPath(&quot;day&quot;, EVENT_BOX, null, 1, null) + EVENTPATH;</span>
<a href="#l16.196"></a><span id="l16.196" class="difflineplus">+    // Check day view for 7 days.</span>
<a href="#l16.197"></a><span id="l16.197" class="difflineplus">+    let day = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, EVENTPATH);</span>
<a href="#l16.198"></a><span id="l16.198">     let dates = [</span>
<a href="#l16.199"></a><span id="l16.199">         [2009, 1, 3],</span>
<a href="#l16.200"></a><span id="l16.200">         [2009, 1, 4]</span>
<a href="#l16.201"></a><span id="l16.201">     ];</span>
<a href="#l16.202"></a><span id="l16.202">     for (let [y, m, d] of dates) {</span>
<a href="#l16.203"></a><span id="l16.203">         goToDate(controller, y, m, d);</span>
<a href="#l16.204"></a><span id="l16.204" class="difflineminus">-        controller.assertNodeNotExist(lookup(day));</span>
<a href="#l16.205"></a><span id="l16.205" class="difflineplus">+        controller.assertNodeNotExist(day);</span>
<a href="#l16.206"></a><span id="l16.206">     }</span>
<a href="#l16.207"></a><span id="l16.207"> </span>
<a href="#l16.208"></a><span id="l16.208" class="difflineminus">-    // check week view for 2 weeks</span>
<a href="#l16.209"></a><span id="l16.209" class="difflineplus">+    // Check week view for 2 weeks.</span>
<a href="#l16.210"></a><span id="l16.210">     switchToView(controller, &quot;week&quot;);</span>
<a href="#l16.211"></a><span id="l16.211">     goToDate(controller, 2009, 1, 1);</span>
<a href="#l16.212"></a><span id="l16.212"> </span>
<a href="#l16.213"></a><span id="l16.213">     for (let i = 0; i &lt;= 1; i++) {</span>
<a href="#l16.214"></a><span id="l16.214">         controller.waitForElementNotPresent(</span>
<a href="#l16.215"></a><span id="l16.215">             lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 1, null, EVENTPATH)</span>
<a href="#l16.216"></a><span id="l16.216">         );</span>
<a href="#l16.217"></a><span id="l16.217" class="difflineminus">-        controller.assertNodeNotExist(</span>
<a href="#l16.218"></a><span id="l16.218" class="difflineminus">-            lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 7, null, EVENTPATH)</span>
<a href="#l16.219"></a><span id="l16.219" class="difflineminus">-        );</span>
<a href="#l16.220"></a><span id="l16.220" class="difflineplus">+        controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 7, null, EVENTPATH));</span>
<a href="#l16.221"></a><span id="l16.221">         viewForward(controller, 1);</span>
<a href="#l16.222"></a><span id="l16.222">     }</span>
<a href="#l16.223"></a><span id="l16.223"> </span>
<a href="#l16.224"></a><span id="l16.224" class="difflineminus">-    // check multiweek view for 4 weeks</span>
<a href="#l16.225"></a><span id="l16.225" class="difflineplus">+    // Check multiweek view for 4 weeks.</span>
<a href="#l16.226"></a><span id="l16.226">     switchToView(controller, &quot;multiweek&quot;);</span>
<a href="#l16.227"></a><span id="l16.227">     goToDate(controller, 2009, 1, 1);</span>
<a href="#l16.228"></a><span id="l16.228"> </span>
<a href="#l16.229"></a><span id="l16.229">     for (let i = 1; i &lt;= 4; i++) {</span>
<a href="#l16.230"></a><span id="l16.230">         controller.waitForElementNotPresent(</span>
<a href="#l16.231"></a><span id="l16.231">             lookupEventBox(&quot;multiweek&quot;, EVENT_BOX, i, 1, null, EVENTPATH)</span>
<a href="#l16.232"></a><span id="l16.232">         );</span>
<a href="#l16.233"></a><span id="l16.233">         controller.assertNodeNotExist(</span>
<a href="#l16.234"></a><span id="l16.234">             lookupEventBox(&quot;multiweek&quot;, EVENT_BOX, i, 7, null, EVENTPATH)</span>
<a href="#l16.235"></a><span id="l16.235">         );</span>
<a href="#l16.236"></a><span id="l16.236">     }</span>
<a href="#l16.237"></a><span id="l16.237"> </span>
<a href="#l16.238"></a><span id="l16.238" class="difflineminus">-    // check month view for all 5 weeks</span>
<a href="#l16.239"></a><span id="l16.239" class="difflineplus">+    // Check month view for all 5 weeks.</span>
<a href="#l16.240"></a><span id="l16.240">     switchToView(controller, &quot;month&quot;);</span>
<a href="#l16.241"></a><span id="l16.241">     goToDate(controller, 2009, 1, 1);</span>
<a href="#l16.242"></a><span id="l16.242"> </span>
<a href="#l16.243"></a><span id="l16.243">     for (let i = 1; i &lt;= 5; i++) {</span>
<a href="#l16.244"></a><span id="l16.244">         controller.waitForElementNotPresent(</span>
<a href="#l16.245"></a><span id="l16.245">             lookupEventBox(&quot;month&quot;, EVENT_BOX, i, 1, null, EVENTPATH)</span>
<a href="#l16.246"></a><span id="l16.246">         );</span>
<a href="#l16.247"></a><span id="l16.247" class="difflineminus">-        controller.assertNodeNotExist(</span>
<a href="#l16.248"></a><span id="l16.248" class="difflineminus">-            lookupEventBox(&quot;month&quot;, EVENT_BOX, i, 7, null, EVENTPATH)</span>
<a href="#l16.249"></a><span id="l16.249" class="difflineminus">-        );</span>
<a href="#l16.250"></a><span id="l16.250" class="difflineplus">+        controller.assertNodeNotExist(lookupEventBox(&quot;month&quot;, EVENT_BOX, i, 7, null, EVENTPATH));</span>
<a href="#l16.251"></a><span id="l16.251">     }</span>
<a href="#l16.252"></a><span id="l16.252"> </span>
<a href="#l16.253"></a><span id="l16.253" class="difflineminus">-    // delete event</span>
<a href="#l16.254"></a><span id="l16.254" class="difflineminus">-    day = getEventBoxPath(&quot;month&quot;, EVENT_BOX, 1, 5, null) + EVENTPATH;</span>
<a href="#l16.255"></a><span id="l16.255" class="difflineminus">-    controller.click(lookup(day));</span>
<a href="#l16.256"></a><span id="l16.256" class="difflineminus">-    handleOccurrencePrompt(controller, eid(&quot;month-view&quot;), &quot;delete&quot;, true, false);</span>
<a href="#l16.257"></a><span id="l16.257" class="difflineminus">-    controller.waitForElementNotPresent(lookup(day));</span>
<a href="#l16.258"></a><span id="l16.258" class="difflineminus">-</span>
<a href="#l16.259"></a><span id="l16.259" class="difflineminus">-    // reset view</span>
<a href="#l16.260"></a><span id="l16.260" class="difflineminus">-    switchToView(controller, &quot;day&quot;);</span>
<a href="#l16.261"></a><span id="l16.261" class="difflineminus">-    controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l16.262"></a><span id="l16.262" class="difflineminus">-    controller.waitFor(() =&gt; eid(&quot;day-view&quot;).getNode().orient == &quot;vertical&quot;);</span>
<a href="#l16.263"></a><span id="l16.263" class="difflineplus">+    // Delete event.</span>
<a href="#l16.264"></a><span id="l16.264" class="difflineplus">+    day = lookupEventBox(&quot;month&quot;, EVENT_BOX, 1, 5, null, EVENTPATH);</span>
<a href="#l16.265"></a><span id="l16.265" class="difflineplus">+    controller.click(day);</span>
<a href="#l16.266"></a><span id="l16.266" class="difflineplus">+    handleOccurrencePrompt(controller, eid(&quot;month-view&quot;), &quot;delete&quot;, true);</span>
<a href="#l16.267"></a><span id="l16.267" class="difflineplus">+    controller.waitForElementNotPresent(day);</span>
<a href="#l16.268"></a><span id="l16.268"> }</span>
<a href="#l16.269"></a><span id="l16.269"> </span>
<a href="#l16.270"></a><span id="l16.270"> function teardownTest(module) {</span>
<a href="#l16.271"></a><span id="l16.271">     deleteCalendars(controller, CALENDARNAME);</span>
<a href="#l16.272"></a><span id="l16.272" class="difflineplus">+    // Reset view.</span>
<a href="#l16.273"></a><span id="l16.273" class="difflineplus">+    switchToView(controller, &quot;day&quot;);</span>
<a href="#l16.274"></a><span id="l16.274" class="difflineplus">+    if (eid(&quot;day-view&quot;).getNode().orient == &quot;horizontal&quot;) {</span>
<a href="#l16.275"></a><span id="l16.275" class="difflineplus">+        controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l16.276"></a><span id="l16.276" class="difflineplus">+    }</span>
<a href="#l16.277"></a><span id="l16.277" class="difflineplus">+    controller.waitFor(() =&gt; eid(&quot;day-view&quot;).getNode().orient == &quot;vertical&quot;);</span>
<a href="#l16.278"></a><span id="l16.278"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/calendar/test/mozmill/recurrenceRotated/testLastDayOfMonthRecurrence.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/calendar/test/mozmill/recurrenceRotated/testLastDayOfMonthRecurrence.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -1,133 +1,124 @@</span>
<a href="#l17.4"></a><span id="l17.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.5"></a><span id="l17.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.6"></a><span id="l17.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.7"></a><span id="l17.7"> </span>
<a href="#l17.8"></a><span id="l17.8" class="difflineminus">-var MODULE_NAME = &quot;testLastDayOfMonthRecurrence&quot;;</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineplus">+var MODULE_NAME = &quot;testLastDayOfMonthRecurrenceRotated&quot;;</span>
<a href="#l17.10"></a><span id="l17.10"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineminus">-var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;window-helpers&quot;];</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;item-editing-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l17.13"></a><span id="l17.13"> </span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-var TIMEOUT_MODAL_DIALOG, CALENDARNAME, EVENTPATH, EVENT_BOX;</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-var CANVAS_BOX, REC_DLG_ACCEPT;</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+var TIMEOUT_MODAL_DIALOG, CALENDARNAME, EVENTPATH, EVENT_BOX, CANVAS_BOX;</span>
<a href="#l17.17"></a><span id="l17.17"> var helpersForController, handleOccurrencePrompt, switchToView, goToDate;</span>
<a href="#l17.18"></a><span id="l17.18"> var invokeEventDialog, deleteCalendars, createCalendar, menulistSelect;</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+var REC_DLG_ACCEPT;</span>
<a href="#l17.20"></a><span id="l17.20"> var plan_for_modal_dialog, wait_for_modal_dialog;</span>
<a href="#l17.21"></a><span id="l17.21"> </span>
<a href="#l17.22"></a><span id="l17.22"> const HOUR = 8;</span>
<a href="#l17.23"></a><span id="l17.23"> </span>
<a href="#l17.24"></a><span id="l17.24"> function setupModule(module) {</span>
<a href="#l17.25"></a><span id="l17.25">     controller = mozmill.getMail3PaneController();</span>
<a href="#l17.26"></a><span id="l17.26">     ({</span>
<a href="#l17.27"></a><span id="l17.27">         TIMEOUT_MODAL_DIALOG,</span>
<a href="#l17.28"></a><span id="l17.28">         CALENDARNAME,</span>
<a href="#l17.29"></a><span id="l17.29">         EVENTPATH,</span>
<a href="#l17.30"></a><span id="l17.30">         EVENT_BOX,</span>
<a href="#l17.31"></a><span id="l17.31">         CANVAS_BOX,</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-        REC_DLG_ACCEPT,</span>
<a href="#l17.33"></a><span id="l17.33">         helpersForController,</span>
<a href="#l17.34"></a><span id="l17.34">         invokeEventDialog,</span>
<a href="#l17.35"></a><span id="l17.35">         createCalendar,</span>
<a href="#l17.36"></a><span id="l17.36">         deleteCalendars,</span>
<a href="#l17.37"></a><span id="l17.37">         switchToView,</span>
<a href="#l17.38"></a><span id="l17.38">         goToDate,</span>
<a href="#l17.39"></a><span id="l17.39">         handleOccurrencePrompt,</span>
<a href="#l17.40"></a><span id="l17.40">         menulistSelect</span>
<a href="#l17.41"></a><span id="l17.41">     } = collector.getModule(&quot;calendar-utils&quot;));</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineminus">-    collector.getModule(&quot;calendar-utils&quot;).setupModule();</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+    collector.getModule(&quot;calendar-utils&quot;).setupModule(controller);</span>
<a href="#l17.44"></a><span id="l17.44">     Object.assign(module, helpersForController(controller));</span>
<a href="#l17.45"></a><span id="l17.45"> </span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+    ({ REC_DLG_ACCEPT } = collector.getModule(&quot;item-editing-helpers&quot;));</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+    collector.getModule(&quot;item-editing-helpers&quot;).setupModule(module);</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+</span>
<a href="#l17.49"></a><span id="l17.49">     ({ plan_for_modal_dialog, wait_for_modal_dialog } =</span>
<a href="#l17.50"></a><span id="l17.50">         collector.getModule(&quot;window-helpers&quot;)</span>
<a href="#l17.51"></a><span id="l17.51">     );</span>
<a href="#l17.52"></a><span id="l17.52"> </span>
<a href="#l17.53"></a><span id="l17.53">     createCalendar(controller, CALENDARNAME);</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineplus">+    // Rotate view.</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineplus">+    controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineplus">+    controller.waitFor(() =&gt; eid(&quot;day-view&quot;).getNode().orient == &quot;horizontal&quot;);</span>
<a href="#l17.57"></a><span id="l17.57"> }</span>
<a href="#l17.58"></a><span id="l17.58"> </span>
<a href="#l17.59"></a><span id="l17.59"> function testLastDayOfMonthRecurrence() {</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineminus">-    controller.click(eid(&quot;calendar-tab-button&quot;));</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineminus">-    switchToView(controller, &quot;day&quot;);</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineminus">-    goToDate(controller, 2008, 1, 31); // start with a leap year</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineplus">+    goToDate(controller, 2008, 1, 31); // Start with a leap year.</span>
<a href="#l17.64"></a><span id="l17.64"> </span>
<a href="#l17.65"></a><span id="l17.65" class="difflineminus">-    // rotate view</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineminus">-    controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineminus">-    controller.waitFor(() =&gt; eid(&quot;day-view&quot;).getNode().orient == &quot;horizontal&quot;);</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineminus">-</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineminus">-    // create monthly recurring event</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineplus">+    // Create monthly recurring event.</span>
<a href="#l17.71"></a><span id="l17.71">     let eventBox = lookupEventBox(&quot;day&quot;, CANVAS_BOX, null, 1, HOUR);</span>
<a href="#l17.72"></a><span id="l17.72">     invokeEventDialog(controller, eventBox, (event, iframe) =&gt; {</span>
<a href="#l17.73"></a><span id="l17.73">         let { eid: eventid } = helpersForController(event);</span>
<a href="#l17.74"></a><span id="l17.74"> </span>
<a href="#l17.75"></a><span id="l17.75">         plan_for_modal_dialog(&quot;Calendar:EventDialog:Recurrence&quot;, setRecurrence);</span>
<a href="#l17.76"></a><span id="l17.76">         menulistSelect(eventid(&quot;item-repeat&quot;), &quot;custom&quot;, event);</span>
<a href="#l17.77"></a><span id="l17.77">         wait_for_modal_dialog(&quot;Calendar:EventDialog:Recurrence&quot;, TIMEOUT_MODAL_DIALOG);</span>
<a href="#l17.78"></a><span id="l17.78"> </span>
<a href="#l17.79"></a><span id="l17.79">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l17.80"></a><span id="l17.80">     });</span>
<a href="#l17.81"></a><span id="l17.81"> </span>
<a href="#l17.82"></a><span id="l17.82">     // data tuple: [year, month, day, row in month view]</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineminus">-    // note: month starts here with 1 for January</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineplus">+    // note: Month starts here with 1 for January.</span>
<a href="#l17.85"></a><span id="l17.85">     let checkingData = [[2008, 1, 31, 5],</span>
<a href="#l17.86"></a><span id="l17.86">                         [2008, 2, 29, 5],</span>
<a href="#l17.87"></a><span id="l17.87">                         [2008, 3, 31, 6],</span>
<a href="#l17.88"></a><span id="l17.88">                         [2008, 4, 30, 5],</span>
<a href="#l17.89"></a><span id="l17.89">                         [2008, 5, 31, 5],</span>
<a href="#l17.90"></a><span id="l17.90">                         [2008, 6, 30, 5],</span>
<a href="#l17.91"></a><span id="l17.91">                         [2008, 7, 31, 5],</span>
<a href="#l17.92"></a><span id="l17.92">                         [2008, 8, 31, 6],</span>
<a href="#l17.93"></a><span id="l17.93">                         [2008, 9, 30, 5],</span>
<a href="#l17.94"></a><span id="l17.94">                         [2008, 10, 31, 5],</span>
<a href="#l17.95"></a><span id="l17.95">                         [2008, 11, 30, 6],</span>
<a href="#l17.96"></a><span id="l17.96">                         [2008, 12, 31, 5],</span>
<a href="#l17.97"></a><span id="l17.97">                         [2009, 1, 31, 5],</span>
<a href="#l17.98"></a><span id="l17.98">                         [2009, 2, 28, 4],</span>
<a href="#l17.99"></a><span id="l17.99">                         [2009, 3, 31, 5]];</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineminus">-    // check all dates</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineplus">+    // Check all dates.</span>
<a href="#l17.102"></a><span id="l17.102">     for (let [y, m, d, correctRow] of checkingData) {</span>
<a href="#l17.103"></a><span id="l17.103">         let date = new Date(y, m - 1, d);</span>
<a href="#l17.104"></a><span id="l17.104">         let column = date.getDay() + 1;</span>
<a href="#l17.105"></a><span id="l17.105"> </span>
<a href="#l17.106"></a><span id="l17.106">         goToDate(controller, y, m, d);</span>
<a href="#l17.107"></a><span id="l17.107"> </span>
<a href="#l17.108"></a><span id="l17.108">         // day view</span>
<a href="#l17.109"></a><span id="l17.109">         switchToView(controller, &quot;day&quot;);</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineminus">-            lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, HOUR, EVENTPATH)</span>
<a href="#l17.112"></a><span id="l17.112" class="difflineminus">-        );</span>
<a href="#l17.113"></a><span id="l17.113" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, EVENTPATH));</span>
<a href="#l17.114"></a><span id="l17.114"> </span>
<a href="#l17.115"></a><span id="l17.115">         // week view</span>
<a href="#l17.116"></a><span id="l17.116">         switchToView(controller, &quot;week&quot;);</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineminus">-            lookupEventBox(&quot;week&quot;, EVENT_BOX, null, column, HOUR, EVENTPATH)</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineminus">-        );</span>
<a href="#l17.120"></a><span id="l17.120" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, column, null, EVENTPATH));</span>
<a href="#l17.121"></a><span id="l17.121"> </span>
<a href="#l17.122"></a><span id="l17.122">         // multiweek view</span>
<a href="#l17.123"></a><span id="l17.123">         switchToView(controller, &quot;multiweek&quot;);</span>
<a href="#l17.124"></a><span id="l17.124">         controller.waitForElement(</span>
<a href="#l17.125"></a><span id="l17.125">             lookupEventBox(&quot;multiweek&quot;, EVENT_BOX, 1, column, null, EVENTPATH)</span>
<a href="#l17.126"></a><span id="l17.126">         );</span>
<a href="#l17.127"></a><span id="l17.127"> </span>
<a href="#l17.128"></a><span id="l17.128">         // month view</span>
<a href="#l17.129"></a><span id="l17.129">         switchToView(controller, &quot;month&quot;);</span>
<a href="#l17.130"></a><span id="l17.130">         controller.waitForElement(</span>
<a href="#l17.131"></a><span id="l17.131">             lookupEventBox(&quot;month&quot;, EVENT_BOX, correctRow, column, null, EVENTPATH)</span>
<a href="#l17.132"></a><span id="l17.132">         );</span>
<a href="#l17.133"></a><span id="l17.133">     }</span>
<a href="#l17.134"></a><span id="l17.134"> </span>
<a href="#l17.135"></a><span id="l17.135" class="difflineminus">-    // delete event</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineplus">+    // Delete event.</span>
<a href="#l17.137"></a><span id="l17.137">     goToDate(controller, checkingData[0][0], checkingData[0][1], checkingData[0][2]);</span>
<a href="#l17.138"></a><span id="l17.138">     switchToView(controller, &quot;day&quot;);</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineminus">-    let box = getEventBoxPath(&quot;day&quot;, EVENT_BOX, null, 1, HOUR) + EVENTPATH;</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineminus">-    controller.waitThenClick(lookup(box));</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineminus">-    handleOccurrencePrompt(controller, eid(&quot;day-view&quot;), &quot;delete&quot;, true, false);</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineminus">-    controller.waitForElementNotPresent(lookup(box));</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineminus">-</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineminus">-    // reset view</span>
<a href="#l17.145"></a><span id="l17.145" class="difflineminus">-    controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l17.146"></a><span id="l17.146" class="difflineminus">-    controller.waitFor(() =&gt; eid(&quot;day-view&quot;).getNode().orient == &quot;vertical&quot;);</span>
<a href="#l17.147"></a><span id="l17.147" class="difflineplus">+    let box = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, EVENTPATH);</span>
<a href="#l17.148"></a><span id="l17.148" class="difflineplus">+    controller.waitThenClick(box);</span>
<a href="#l17.149"></a><span id="l17.149" class="difflineplus">+    handleOccurrencePrompt(controller, eid(&quot;day-view&quot;), &quot;delete&quot;, true);</span>
<a href="#l17.150"></a><span id="l17.150" class="difflineplus">+    controller.waitForElementNotPresent(box);</span>
<a href="#l17.151"></a><span id="l17.151"> }</span>
<a href="#l17.152"></a><span id="l17.152"> </span>
<a href="#l17.153"></a><span id="l17.153"> function setRecurrence(recurrence) {</span>
<a href="#l17.154"></a><span id="l17.154">     let {</span>
<a href="#l17.155"></a><span id="l17.155">         sleep: recsleep,</span>
<a href="#l17.156"></a><span id="l17.156">         lookup: reclookup,</span>
<a href="#l17.157"></a><span id="l17.157">         eid: recid</span>
<a href="#l17.158"></a><span id="l17.158">     } = helpersForController(recurrence);</span>
<a href="#l17.159"></a><span id="l17.159" class="difflineat">@@ -136,15 +127,20 @@ function setRecurrence(recurrence) {</span>
<a href="#l17.160"></a><span id="l17.160">     menulistSelect(recid(&quot;period-list&quot;), &quot;2&quot;, recurrence);</span>
<a href="#l17.161"></a><span id="l17.161"> </span>
<a href="#l17.162"></a><span id="l17.162">     // last day of month</span>
<a href="#l17.163"></a><span id="l17.163">     recurrence.radio(recid(&quot;montly-period-relative-date-radio&quot;));</span>
<a href="#l17.164"></a><span id="l17.164">     menulistSelect(recid(&quot;monthly-ordinal&quot;), &quot;-1&quot;, recurrence);</span>
<a href="#l17.165"></a><span id="l17.165">     menulistSelect(recid(&quot;monthly-weekday&quot;), &quot;-1&quot;, recurrence);</span>
<a href="#l17.166"></a><span id="l17.166">     recsleep();</span>
<a href="#l17.167"></a><span id="l17.167"> </span>
<a href="#l17.168"></a><span id="l17.168" class="difflineminus">-    // close dialog</span>
<a href="#l17.169"></a><span id="l17.169" class="difflineplus">+    // Close dialog.</span>
<a href="#l17.170"></a><span id="l17.170">     recurrence.click(reclookup(REC_DLG_ACCEPT));</span>
<a href="#l17.171"></a><span id="l17.171"> }</span>
<a href="#l17.172"></a><span id="l17.172"> </span>
<a href="#l17.173"></a><span id="l17.173"> function teardownTest(module) {</span>
<a href="#l17.174"></a><span id="l17.174">     deleteCalendars(controller, CALENDARNAME);</span>
<a href="#l17.175"></a><span id="l17.175" class="difflineplus">+    // Reset view.</span>
<a href="#l17.176"></a><span id="l17.176" class="difflineplus">+    if (eid(&quot;day-view&quot;).getNode().orient == &quot;horizontal&quot;) {</span>
<a href="#l17.177"></a><span id="l17.177" class="difflineplus">+        controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l17.178"></a><span id="l17.178" class="difflineplus">+    }</span>
<a href="#l17.179"></a><span id="l17.179" class="difflineplus">+    controller.waitFor(() =&gt; eid(&quot;day-view&quot;).getNode().orient == &quot;vertical&quot;);</span>
<a href="#l17.180"></a><span id="l17.180"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/calendar/test/mozmill/recurrenceRotated/testWeeklyNRecurrence.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/calendar/test/mozmill/recurrenceRotated/testWeeklyNRecurrence.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1,183 +1,168 @@</span>
<a href="#l18.4"></a><span id="l18.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.5"></a><span id="l18.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.6"></a><span id="l18.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.7"></a><span id="l18.7"> </span>
<a href="#l18.8"></a><span id="l18.8" class="difflineminus">-var MODULE_NAME = &quot;testWeeklyNRecurrence&quot;;</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineplus">+var MODULE_NAME = &quot;testWeeklyNRecurrenceRotated&quot;;</span>
<a href="#l18.10"></a><span id="l18.10"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineminus">-var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;window-helpers&quot;];</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;item-editing-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l18.13"></a><span id="l18.13"> </span>
<a href="#l18.14"></a><span id="l18.14"> var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;, null);</span>
<a href="#l18.15"></a><span id="l18.15"> </span>
<a href="#l18.16"></a><span id="l18.16"> var TIMEOUT_MODAL_DIALOG, CALENDARNAME, EVENTPATH, EVENT_BOX, CANVAS_BOX;</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineminus">-var REC_DLG_ACCEPT, REC_DLG_DAYS;</span>
<a href="#l18.18"></a><span id="l18.18"> var helpersForController, handleOccurrencePrompt, switchToView, goToDate;</span>
<a href="#l18.19"></a><span id="l18.19"> var invokeEventDialog, viewForward, deleteCalendars, createCalendar, menulistSelect;</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineplus">+var REC_DLG_ACCEPT, REC_DLG_DAYS;</span>
<a href="#l18.21"></a><span id="l18.21"> var plan_for_modal_dialog, wait_for_modal_dialog;</span>
<a href="#l18.22"></a><span id="l18.22"> </span>
<a href="#l18.23"></a><span id="l18.23"> const HOUR = 8;</span>
<a href="#l18.24"></a><span id="l18.24"> </span>
<a href="#l18.25"></a><span id="l18.25"> function setupModule(module) {</span>
<a href="#l18.26"></a><span id="l18.26">     controller = mozmill.getMail3PaneController();</span>
<a href="#l18.27"></a><span id="l18.27">     ({</span>
<a href="#l18.28"></a><span id="l18.28">         TIMEOUT_MODAL_DIALOG,</span>
<a href="#l18.29"></a><span id="l18.29">         CALENDARNAME,</span>
<a href="#l18.30"></a><span id="l18.30">         EVENTPATH,</span>
<a href="#l18.31"></a><span id="l18.31">         EVENT_BOX,</span>
<a href="#l18.32"></a><span id="l18.32">         CANVAS_BOX,</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-        REC_DLG_ACCEPT,</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineminus">-        REC_DLG_DAYS,</span>
<a href="#l18.35"></a><span id="l18.35">         helpersForController,</span>
<a href="#l18.36"></a><span id="l18.36">         handleOccurrencePrompt,</span>
<a href="#l18.37"></a><span id="l18.37">         switchToView,</span>
<a href="#l18.38"></a><span id="l18.38">         goToDate,</span>
<a href="#l18.39"></a><span id="l18.39">         invokeEventDialog,</span>
<a href="#l18.40"></a><span id="l18.40">         viewForward,</span>
<a href="#l18.41"></a><span id="l18.41">         deleteCalendars,</span>
<a href="#l18.42"></a><span id="l18.42">         createCalendar,</span>
<a href="#l18.43"></a><span id="l18.43">         menulistSelect</span>
<a href="#l18.44"></a><span id="l18.44">     } = collector.getModule(&quot;calendar-utils&quot;));</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineminus">-    collector.getModule(&quot;calendar-utils&quot;).setupModule();</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+    collector.getModule(&quot;calendar-utils&quot;).setupModule(controller);</span>
<a href="#l18.47"></a><span id="l18.47">     Object.assign(module, helpersForController(controller));</span>
<a href="#l18.48"></a><span id="l18.48"> </span>
<a href="#l18.49"></a><span id="l18.49" class="difflineplus">+    ({</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+        REC_DLG_ACCEPT,</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+        REC_DLG_DAYS</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+    } = collector.getModule(&quot;item-editing-helpers&quot;));</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineplus">+    collector.getModule(&quot;item-editing-helpers&quot;).setupModule(module);</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineplus">+</span>
<a href="#l18.55"></a><span id="l18.55">     ({ plan_for_modal_dialog, wait_for_modal_dialog } =</span>
<a href="#l18.56"></a><span id="l18.56">         collector.getModule(&quot;window-helpers&quot;)</span>
<a href="#l18.57"></a><span id="l18.57">     );</span>
<a href="#l18.58"></a><span id="l18.58"> </span>
<a href="#l18.59"></a><span id="l18.59">     createCalendar(controller, CALENDARNAME);</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineplus">+    // Rotate view.</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineplus">+    controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineplus">+    controller.waitFor(() =&gt; eid(&quot;day-view&quot;).getNode().orient == &quot;horizontal&quot;);</span>
<a href="#l18.63"></a><span id="l18.63"> }</span>
<a href="#l18.64"></a><span id="l18.64"> </span>
<a href="#l18.65"></a><span id="l18.65"> function testWeeklyNRecurrence() {</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineminus">-    controller.click(eid(&quot;calendar-tab-button&quot;));</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineminus">-    switchToView(controller, &quot;day&quot;);</span>
<a href="#l18.68"></a><span id="l18.68">     goToDate(controller, 2009, 1, 5);</span>
<a href="#l18.69"></a><span id="l18.69"> </span>
<a href="#l18.70"></a><span id="l18.70" class="difflineminus">-    // rotate view</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineminus">-    controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineminus">-    controller.waitFor(() =&gt; eid(&quot;day-view&quot;).getNode().orient == &quot;horizontal&quot;);</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineminus">-</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineminus">-    // create weekly recurring event</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineplus">+    // Create weekly recurring event.</span>
<a href="#l18.76"></a><span id="l18.76">     let eventBox = lookupEventBox(&quot;day&quot;, CANVAS_BOX, null, 1, HOUR);</span>
<a href="#l18.77"></a><span id="l18.77">     invokeEventDialog(controller, eventBox, (event, iframe) =&gt; {</span>
<a href="#l18.78"></a><span id="l18.78">         let { eid: eventid } = helpersForController(event);</span>
<a href="#l18.79"></a><span id="l18.79"> </span>
<a href="#l18.80"></a><span id="l18.80">         plan_for_modal_dialog(&quot;Calendar:EventDialog:Recurrence&quot;, setRecurrence);</span>
<a href="#l18.81"></a><span id="l18.81">         event.waitForElement(eventid(&quot;item-repeat&quot;));</span>
<a href="#l18.82"></a><span id="l18.82">         menulistSelect(eventid(&quot;item-repeat&quot;), &quot;custom&quot;, event);</span>
<a href="#l18.83"></a><span id="l18.83">         wait_for_modal_dialog(&quot;Calendar:EventDialog:Recurrence&quot;, TIMEOUT_MODAL_DIALOG);</span>
<a href="#l18.84"></a><span id="l18.84"> </span>
<a href="#l18.85"></a><span id="l18.85">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l18.86"></a><span id="l18.86">     });</span>
<a href="#l18.87"></a><span id="l18.87"> </span>
<a href="#l18.88"></a><span id="l18.88" class="difflineminus">-    // check day view</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineminus">-    let box = getEventBoxPath(&quot;day&quot;, EVENT_BOX, undefined, 1, HOUR) + EVENTPATH;</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineplus">+    // Check day view.</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineplus">+    let box = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, EVENTPATH);</span>
<a href="#l18.92"></a><span id="l18.92">     // Monday, Tuesday, Wednesday, Thursday</span>
<a href="#l18.93"></a><span id="l18.93">     for (let i = 0; i &lt; 4; i++) {</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineminus">-        controller.waitForElement(lookup(box));</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineplus">+        controller.waitForElement(box);</span>
<a href="#l18.96"></a><span id="l18.96">         viewForward(controller, 1);</span>
<a href="#l18.97"></a><span id="l18.97">     }</span>
<a href="#l18.98"></a><span id="l18.98"> </span>
<a href="#l18.99"></a><span id="l18.99">     // Not Friday</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineminus">-    sleep();</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineminus">-    controller.assertNodeNotExist(lookup(box));</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineplus">+    controller.waitForElementNotPresent(box);</span>
<a href="#l18.103"></a><span id="l18.103">     viewForward(controller, 1);</span>
<a href="#l18.104"></a><span id="l18.104"> </span>
<a href="#l18.105"></a><span id="l18.105">     // Not Saturday as only 4 occurrences are set.</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineminus">-    sleep();</span>
<a href="#l18.107"></a><span id="l18.107" class="difflineminus">-    controller.assertNodeNotExist(lookup(box));</span>
<a href="#l18.108"></a><span id="l18.108" class="difflineplus">+    controller.waitForElementNotPresent(box);</span>
<a href="#l18.109"></a><span id="l18.109"> </span>
<a href="#l18.110"></a><span id="l18.110" class="difflineminus">-    // check week view</span>
<a href="#l18.111"></a><span id="l18.111" class="difflineplus">+    // Check week view.</span>
<a href="#l18.112"></a><span id="l18.112">     switchToView(controller, &quot;week&quot;);</span>
<a href="#l18.113"></a><span id="l18.113"> </span>
<a href="#l18.114"></a><span id="l18.114">     // Monday, Tuesday, Wednesday, Thursday</span>
<a href="#l18.115"></a><span id="l18.115">     for (let i = 2; i &lt; 6; i++) {</span>
<a href="#l18.116"></a><span id="l18.116" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineminus">-            lookupEventBox(&quot;week&quot;, EVENT_BOX, null, i, HOUR, EVENTPATH)</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineminus">-        );</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, i, null, EVENTPATH));</span>
<a href="#l18.120"></a><span id="l18.120">     }</span>
<a href="#l18.121"></a><span id="l18.121"> </span>
<a href="#l18.122"></a><span id="l18.122">     // Saturday</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineminus">-    controller.assertNodeNotExist(</span>
<a href="#l18.124"></a><span id="l18.124" class="difflineminus">-        lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 7, HOUR, EVENTPATH)</span>
<a href="#l18.125"></a><span id="l18.125" class="difflineminus">-    );</span>
<a href="#l18.126"></a><span id="l18.126" class="difflineplus">+    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 7, null, EVENTPATH));</span>
<a href="#l18.127"></a><span id="l18.127"> </span>
<a href="#l18.128"></a><span id="l18.128">     // check multiweek view</span>
<a href="#l18.129"></a><span id="l18.129">     switchToView(controller, &quot;multiweek&quot;);</span>
<a href="#l18.130"></a><span id="l18.130">     checkMultiWeekView(&quot;multiweek&quot;);</span>
<a href="#l18.131"></a><span id="l18.131"> </span>
<a href="#l18.132"></a><span id="l18.132" class="difflineminus">-    // check month view</span>
<a href="#l18.133"></a><span id="l18.133" class="difflineplus">+    // Check month view.</span>
<a href="#l18.134"></a><span id="l18.134">     switchToView(controller, &quot;month&quot;);</span>
<a href="#l18.135"></a><span id="l18.135">     checkMultiWeekView(&quot;month&quot;);</span>
<a href="#l18.136"></a><span id="l18.136"> </span>
<a href="#l18.137"></a><span id="l18.137" class="difflineminus">-    // delete event</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineminus">-    box = getEventBoxPath(&quot;month&quot;, EVENT_BOX, 2, 2, HOUR) + EVENTPATH;</span>
<a href="#l18.139"></a><span id="l18.139" class="difflineminus">-    controller.click(lookup(box));</span>
<a href="#l18.140"></a><span id="l18.140" class="difflineminus">-    handleOccurrencePrompt(controller, eid(&quot;month-view&quot;), &quot;delete&quot;, true, false);</span>
<a href="#l18.141"></a><span id="l18.141" class="difflineminus">-    controller.waitForElementNotPresent(lookup(box));</span>
<a href="#l18.142"></a><span id="l18.142" class="difflineminus">-</span>
<a href="#l18.143"></a><span id="l18.143" class="difflineminus">-    // reset view</span>
<a href="#l18.144"></a><span id="l18.144" class="difflineminus">-    switchToView(controller, &quot;day&quot;);</span>
<a href="#l18.145"></a><span id="l18.145" class="difflineminus">-    controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l18.146"></a><span id="l18.146" class="difflineminus">-    controller.waitFor(() =&gt; eid(&quot;day-view&quot;).getNode().orient == &quot;vertical&quot;);</span>
<a href="#l18.147"></a><span id="l18.147" class="difflineplus">+    // Delete event.</span>
<a href="#l18.148"></a><span id="l18.148" class="difflineplus">+    box = lookupEventBox(&quot;month&quot;, EVENT_BOX, 2, 2, null, EVENTPATH);</span>
<a href="#l18.149"></a><span id="l18.149" class="difflineplus">+    controller.click(box);</span>
<a href="#l18.150"></a><span id="l18.150" class="difflineplus">+    handleOccurrencePrompt(controller, eid(&quot;month-view&quot;), &quot;delete&quot;, true);</span>
<a href="#l18.151"></a><span id="l18.151" class="difflineplus">+    controller.waitForElementNotPresent(box);</span>
<a href="#l18.152"></a><span id="l18.152"> }</span>
<a href="#l18.153"></a><span id="l18.153"> </span>
<a href="#l18.154"></a><span id="l18.154"> function setRecurrence(recurrence) {</span>
<a href="#l18.155"></a><span id="l18.155" class="difflineminus">-    let {</span>
<a href="#l18.156"></a><span id="l18.156" class="difflineminus">-        sleep: recsleep,</span>
<a href="#l18.157"></a><span id="l18.157" class="difflineminus">-        lookup: reclookup,</span>
<a href="#l18.158"></a><span id="l18.158" class="difflineminus">-        eid: recid,</span>
<a href="#l18.159"></a><span id="l18.159" class="difflineminus">-    } = helpersForController(recurrence);</span>
<a href="#l18.160"></a><span id="l18.160" class="difflineplus">+    let { sleep: recsleep, lookup: reclookup, eid: recid } = helpersForController(recurrence);</span>
<a href="#l18.161"></a><span id="l18.161"> </span>
<a href="#l18.162"></a><span id="l18.162">     // weekly</span>
<a href="#l18.163"></a><span id="l18.163">     recurrence.waitForElement(recid(&quot;period-list&quot;));</span>
<a href="#l18.164"></a><span id="l18.164">     menulistSelect(recid(&quot;period-list&quot;), &quot;1&quot;, recurrence);</span>
<a href="#l18.165"></a><span id="l18.165">     recsleep();</span>
<a href="#l18.166"></a><span id="l18.166"> </span>
<a href="#l18.167"></a><span id="l18.167">     let mon = cal.l10n.getDateFmtString(&quot;day.2.Mmm&quot;);</span>
<a href="#l18.168"></a><span id="l18.168">     let tue = cal.l10n.getDateFmtString(&quot;day.3.Mmm&quot;);</span>
<a href="#l18.169"></a><span id="l18.169">     let wed = cal.l10n.getDateFmtString(&quot;day.4.Mmm&quot;);</span>
<a href="#l18.170"></a><span id="l18.170">     let thu = cal.l10n.getDateFmtString(&quot;day.5.Mmm&quot;);</span>
<a href="#l18.171"></a><span id="l18.171">     let sat = cal.l10n.getDateFmtString(&quot;day.7.Mmm&quot;);</span>
<a href="#l18.172"></a><span id="l18.172"> </span>
<a href="#l18.173"></a><span id="l18.173" class="difflineminus">-    // starting from Monday so it should be checked. We have to wait a little,</span>
<a href="#l18.174"></a><span id="l18.174" class="difflineplus">+    // Starting from Monday so it should be checked. We have to wait a little,</span>
<a href="#l18.175"></a><span id="l18.175">     // because the checkedstate is set in background by JS.</span>
<a href="#l18.176"></a><span id="l18.176">     recurrence.waitFor(() =&gt; {</span>
<a href="#l18.177"></a><span id="l18.177">         return recurrence.assertChecked(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${mon}&quot;}`));</span>
<a href="#l18.178"></a><span id="l18.178">     }, 30000);</span>
<a href="#l18.179"></a><span id="l18.179" class="difflineminus">-    // check Tuesday, Wednesday, Thursday and Saturday too</span>
<a href="#l18.180"></a><span id="l18.180" class="difflineplus">+    // Check Tuesday, Wednesday, Thursday and Saturday too.</span>
<a href="#l18.181"></a><span id="l18.181">     recurrence.click(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${tue}&quot;}`));</span>
<a href="#l18.182"></a><span id="l18.182">     recurrence.click(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${wed}&quot;}`));</span>
<a href="#l18.183"></a><span id="l18.183">     recurrence.click(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${thu}&quot;}`));</span>
<a href="#l18.184"></a><span id="l18.184">     recurrence.click(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${sat}&quot;}`));</span>
<a href="#l18.185"></a><span id="l18.185"> </span>
<a href="#l18.186"></a><span id="l18.186" class="difflineminus">-    // set number of occurrences</span>
<a href="#l18.187"></a><span id="l18.187" class="difflineplus">+    // Set number of recurrences.</span>
<a href="#l18.188"></a><span id="l18.188">     recurrence.click(recid(&quot;recurrence-range-for&quot;));</span>
<a href="#l18.189"></a><span id="l18.189">     let ntimesField = recid(&quot;repeat-ntimes-count&quot;);</span>
<a href="#l18.190"></a><span id="l18.190">     ntimesField.getNode().value = &quot;4&quot;;</span>
<a href="#l18.191"></a><span id="l18.191"> </span>
<a href="#l18.192"></a><span id="l18.192">     // close dialog</span>
<a href="#l18.193"></a><span id="l18.193">     recurrence.click(reclookup(REC_DLG_ACCEPT));</span>
<a href="#l18.194"></a><span id="l18.194"> }</span>
<a href="#l18.195"></a><span id="l18.195"> </span>
<a href="#l18.196"></a><span id="l18.196"> function checkMultiWeekView(view) {</span>
<a href="#l18.197"></a><span id="l18.197" class="difflineminus">-    // make sure, the view has time to load</span>
<a href="#l18.198"></a><span id="l18.198" class="difflineminus">-    sleep();</span>
<a href="#l18.199"></a><span id="l18.199" class="difflineminus">-</span>
<a href="#l18.200"></a><span id="l18.200" class="difflineminus">-    // In month view event starts from 2nd row</span>
<a href="#l18.201"></a><span id="l18.201" class="difflineplus">+    // In month view event starts from 2nd row.</span>
<a href="#l18.202"></a><span id="l18.202">     let week = view == &quot;month&quot; ? 2 : 1;</span>
<a href="#l18.203"></a><span id="l18.203"> </span>
<a href="#l18.204"></a><span id="l18.204">     // Monday, Tuesday, Wednesday, Thursday</span>
<a href="#l18.205"></a><span id="l18.205">     for (let i = 2; i &lt; 6; i++) {</span>
<a href="#l18.206"></a><span id="l18.206" class="difflineminus">-        controller.assertNode(</span>
<a href="#l18.207"></a><span id="l18.207" class="difflineminus">-            lookupEventBox(view, EVENT_BOX, week, i, null, EVENTPATH)</span>
<a href="#l18.208"></a><span id="l18.208" class="difflineminus">-        );</span>
<a href="#l18.209"></a><span id="l18.209" class="difflineplus">+        controller.assertNode(lookupEventBox(view, EVENT_BOX, week, i, null, EVENTPATH));</span>
<a href="#l18.210"></a><span id="l18.210">     }</span>
<a href="#l18.211"></a><span id="l18.211"> </span>
<a href="#l18.212"></a><span id="l18.212">     // Saturday</span>
<a href="#l18.213"></a><span id="l18.213" class="difflineminus">-    controller.assertNodeNotExist(</span>
<a href="#l18.214"></a><span id="l18.214" class="difflineminus">-        getEventBoxPath(view, EVENT_BOX, week, 7, null, EVENTPATH)</span>
<a href="#l18.215"></a><span id="l18.215" class="difflineminus">-    );</span>
<a href="#l18.216"></a><span id="l18.216" class="difflineplus">+    controller.assertNodeNotExist(lookupEventBox(view, EVENT_BOX, week, 7, null, EVENTPATH));</span>
<a href="#l18.217"></a><span id="l18.217"> }</span>
<a href="#l18.218"></a><span id="l18.218"> </span>
<a href="#l18.219"></a><span id="l18.219"> function teardownTest(module) {</span>
<a href="#l18.220"></a><span id="l18.220">     deleteCalendars(controller, CALENDARNAME);</span>
<a href="#l18.221"></a><span id="l18.221" class="difflineplus">+    // Reset view.</span>
<a href="#l18.222"></a><span id="l18.222" class="difflineplus">+    switchToView(controller, &quot;day&quot;);</span>
<a href="#l18.223"></a><span id="l18.223" class="difflineplus">+    if (eid(&quot;day-view&quot;).getNode().orient == &quot;horizontal&quot;) {</span>
<a href="#l18.224"></a><span id="l18.224" class="difflineplus">+        controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l18.225"></a><span id="l18.225" class="difflineplus">+    }</span>
<a href="#l18.226"></a><span id="l18.226" class="difflineplus">+    controller.waitFor(() =&gt; eid(&quot;day-view&quot;).getNode().orient == &quot;vertical&quot;);</span>
<a href="#l18.227"></a><span id="l18.227"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/calendar/test/mozmill/recurrenceRotated/testWeeklyUntilRecurrence.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/calendar/test/mozmill/recurrenceRotated/testWeeklyUntilRecurrence.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -1,227 +1,212 @@</span>
<a href="#l19.4"></a><span id="l19.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l19.5"></a><span id="l19.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l19.6"></a><span id="l19.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l19.7"></a><span id="l19.7"> </span>
<a href="#l19.8"></a><span id="l19.8" class="difflineminus">-var MODULE_NAME = &quot;testWeeklyUntilRecurrence&quot;;</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineplus">+var MODULE_NAME = &quot;testWeeklyUntilRecurrenceRotated&quot;;</span>
<a href="#l19.10"></a><span id="l19.10"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineminus">-var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;window-helpers&quot;];</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;item-editing-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l19.13"></a><span id="l19.13"> </span>
<a href="#l19.14"></a><span id="l19.14"> var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;, null);</span>
<a href="#l19.15"></a><span id="l19.15"> </span>
<a href="#l19.16"></a><span id="l19.16" class="difflineminus">-var SHORT_SLEEP, TIMEOUT_MODAL_DIALOG, CALENDARNAME, EVENTPATH, EVENT_BOX;</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineminus">-var CANVAS_BOX, REC_DLG_DAYS, REC_DLG_ACCEPT, REC_DLG_UNTIL_INPUT;</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+var SHORT_SLEEP, TIMEOUT_MODAL_DIALOG, CALENDARNAME, EVENTPATH, EVENT_BOX, CANVAS_BOX;</span>
<a href="#l19.19"></a><span id="l19.19"> var helpersForController, handleOccurrencePrompt, switchToView, goToDate;</span>
<a href="#l19.20"></a><span id="l19.20"> var invokeEventDialog, viewForward, deleteCalendars, createCalendar, menulistSelect;</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineplus">+var REC_DLG_DAYS, REC_DLG_ACCEPT, REC_DLG_UNTIL_INPUT;</span>
<a href="#l19.22"></a><span id="l19.22"> var plan_for_modal_dialog, wait_for_modal_dialog;</span>
<a href="#l19.23"></a><span id="l19.23"> </span>
<a href="#l19.24"></a><span id="l19.24"> const ENDDATE = new Date(2009, 0, 26); // last Monday in month</span>
<a href="#l19.25"></a><span id="l19.25"> const HOUR = 8;</span>
<a href="#l19.26"></a><span id="l19.26"> </span>
<a href="#l19.27"></a><span id="l19.27"> function setupModule(module) {</span>
<a href="#l19.28"></a><span id="l19.28">     controller = mozmill.getMail3PaneController();</span>
<a href="#l19.29"></a><span id="l19.29">     ({</span>
<a href="#l19.30"></a><span id="l19.30">         SHORT_SLEEP,</span>
<a href="#l19.31"></a><span id="l19.31">         TIMEOUT_MODAL_DIALOG,</span>
<a href="#l19.32"></a><span id="l19.32">         CALENDARNAME,</span>
<a href="#l19.33"></a><span id="l19.33">         EVENTPATH,</span>
<a href="#l19.34"></a><span id="l19.34">         EVENT_BOX,</span>
<a href="#l19.35"></a><span id="l19.35">         CANVAS_BOX,</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineminus">-        REC_DLG_DAYS,</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineminus">-        REC_DLG_ACCEPT,</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineminus">-        REC_DLG_UNTIL_INPUT,</span>
<a href="#l19.39"></a><span id="l19.39">         helpersForController,</span>
<a href="#l19.40"></a><span id="l19.40">         handleOccurrencePrompt,</span>
<a href="#l19.41"></a><span id="l19.41">         switchToView,</span>
<a href="#l19.42"></a><span id="l19.42">         goToDate,</span>
<a href="#l19.43"></a><span id="l19.43">         invokeEventDialog,</span>
<a href="#l19.44"></a><span id="l19.44">         viewForward,</span>
<a href="#l19.45"></a><span id="l19.45">         deleteCalendars,</span>
<a href="#l19.46"></a><span id="l19.46">         createCalendar,</span>
<a href="#l19.47"></a><span id="l19.47">         menulistSelect</span>
<a href="#l19.48"></a><span id="l19.48">     } = collector.getModule(&quot;calendar-utils&quot;));</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineminus">-    collector.getModule(&quot;calendar-utils&quot;).setupModule();</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineplus">+    collector.getModule(&quot;calendar-utils&quot;).setupModule(controller);</span>
<a href="#l19.51"></a><span id="l19.51">     Object.assign(module, helpersForController(controller));</span>
<a href="#l19.52"></a><span id="l19.52"> </span>
<a href="#l19.53"></a><span id="l19.53" class="difflineplus">+    ({</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineplus">+        REC_DLG_DAYS,</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineplus">+        REC_DLG_ACCEPT,</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineplus">+        REC_DLG_UNTIL_INPUT</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineplus">+    } = collector.getModule(&quot;item-editing-helpers&quot;));</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineplus">+    collector.getModule(&quot;item-editing-helpers&quot;).setupModule(module);</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineplus">+</span>
<a href="#l19.60"></a><span id="l19.60">     ({ plan_for_modal_dialog, wait_for_modal_dialog } =</span>
<a href="#l19.61"></a><span id="l19.61">         collector.getModule(&quot;window-helpers&quot;)</span>
<a href="#l19.62"></a><span id="l19.62">     );</span>
<a href="#l19.63"></a><span id="l19.63"> </span>
<a href="#l19.64"></a><span id="l19.64">     createCalendar(controller, CALENDARNAME);</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineplus">+    // Rotate view.</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineplus">+    controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineplus">+    controller.waitFor(() =&gt; eid(&quot;day-view&quot;).getNode().orient == &quot;horizontal&quot;);</span>
<a href="#l19.68"></a><span id="l19.68"> }</span>
<a href="#l19.69"></a><span id="l19.69"> </span>
<a href="#l19.70"></a><span id="l19.70"> function testWeeklyUntilRecurrence() {</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineminus">-    controller.click(eid(&quot;calendar-tab-button&quot;));</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineminus">-    switchToView(controller, &quot;day&quot;);</span>
<a href="#l19.73"></a><span id="l19.73">     goToDate(controller, 2009, 1, 5); // Monday</span>
<a href="#l19.74"></a><span id="l19.74"> </span>
<a href="#l19.75"></a><span id="l19.75" class="difflineminus">-    // rotate view</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineminus">-    controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineminus">-    controller.waitFor(() =&gt; eid(&quot;day-view&quot;).getNode().orient == &quot;horizontal&quot;);</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineminus">-</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineminus">-    // create weekly recurring event</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineplus">+    // Create weekly recurring event.</span>
<a href="#l19.81"></a><span id="l19.81">     let eventBox = lookupEventBox(&quot;day&quot;, CANVAS_BOX, null, 1, HOUR);</span>
<a href="#l19.82"></a><span id="l19.82">     invokeEventDialog(controller, eventBox, (event, iframe) =&gt; {</span>
<a href="#l19.83"></a><span id="l19.83">         let { eid: eventid } = helpersForController(event);</span>
<a href="#l19.84"></a><span id="l19.84"> </span>
<a href="#l19.85"></a><span id="l19.85">         plan_for_modal_dialog(&quot;Calendar:EventDialog:Recurrence&quot;, setRecurrence);</span>
<a href="#l19.86"></a><span id="l19.86">         event.waitForElement(eventid(&quot;item-repeat&quot;));</span>
<a href="#l19.87"></a><span id="l19.87">         menulistSelect(eventid(&quot;item-repeat&quot;), &quot;custom&quot;, event);</span>
<a href="#l19.88"></a><span id="l19.88">         wait_for_modal_dialog(&quot;Calendar:EventDialog:Recurrence&quot;, TIMEOUT_MODAL_DIALOG);</span>
<a href="#l19.89"></a><span id="l19.89"> </span>
<a href="#l19.90"></a><span id="l19.90">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l19.91"></a><span id="l19.91">     });</span>
<a href="#l19.92"></a><span id="l19.92"> </span>
<a href="#l19.93"></a><span id="l19.93" class="difflineminus">-    let box = getEventBoxPath(&quot;day&quot;, EVENT_BOX, null, 1, HOUR) + EVENTPATH;</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineplus">+    let box = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, EVENTPATH);</span>
<a href="#l19.95"></a><span id="l19.95"> </span>
<a href="#l19.96"></a><span id="l19.96" class="difflineminus">-    // check day view</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineplus">+    // Check day view.</span>
<a href="#l19.98"></a><span id="l19.98">     for (let week = 0; week &lt; 3; week++) {</span>
<a href="#l19.99"></a><span id="l19.99">         // Monday</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineminus">-        controller.waitForElement(lookup(box));</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineplus">+        controller.waitForElement(box);</span>
<a href="#l19.102"></a><span id="l19.102">         viewForward(controller, 2);</span>
<a href="#l19.103"></a><span id="l19.103"> </span>
<a href="#l19.104"></a><span id="l19.104">         // Wednesday</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineminus">-        controller.waitForElement(lookup(box));</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineplus">+        controller.waitForElement(box);</span>
<a href="#l19.107"></a><span id="l19.107">         viewForward(controller, 2);</span>
<a href="#l19.108"></a><span id="l19.108"> </span>
<a href="#l19.109"></a><span id="l19.109">         // Friday</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineminus">-        controller.waitForElement(lookup(box));</span>
<a href="#l19.111"></a><span id="l19.111" class="difflineplus">+        controller.waitForElement(box);</span>
<a href="#l19.112"></a><span id="l19.112">         viewForward(controller, 3);</span>
<a href="#l19.113"></a><span id="l19.113">     }</span>
<a href="#l19.114"></a><span id="l19.114"> </span>
<a href="#l19.115"></a><span id="l19.115">     // Monday, last occurrence</span>
<a href="#l19.116"></a><span id="l19.116" class="difflineminus">-    controller.waitForElement(lookup(box));</span>
<a href="#l19.117"></a><span id="l19.117" class="difflineplus">+    controller.waitForElement(box);</span>
<a href="#l19.118"></a><span id="l19.118">     viewForward(controller, 2);</span>
<a href="#l19.119"></a><span id="l19.119"> </span>
<a href="#l19.120"></a><span id="l19.120">     // Wednesday</span>
<a href="#l19.121"></a><span id="l19.121" class="difflineminus">-    controller.waitForElementNotPresent(lookup(box));</span>
<a href="#l19.122"></a><span id="l19.122" class="difflineplus">+    controller.waitForElementNotPresent(box);</span>
<a href="#l19.123"></a><span id="l19.123"> </span>
<a href="#l19.124"></a><span id="l19.124" class="difflineminus">-    // check week view</span>
<a href="#l19.125"></a><span id="l19.125" class="difflineplus">+    // Check week view.</span>
<a href="#l19.126"></a><span id="l19.126">     switchToView(controller, &quot;week&quot;);</span>
<a href="#l19.127"></a><span id="l19.127">     goToDate(controller, 2009, 1, 5);</span>
<a href="#l19.128"></a><span id="l19.128">     for (let week = 0; week &lt; 3; week++) {</span>
<a href="#l19.129"></a><span id="l19.129">         // Monday</span>
<a href="#l19.130"></a><span id="l19.130" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l19.131"></a><span id="l19.131" class="difflineminus">-            lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 2, HOUR, EVENTPATH)</span>
<a href="#l19.132"></a><span id="l19.132" class="difflineminus">-        );</span>
<a href="#l19.133"></a><span id="l19.133" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 2, null, EVENTPATH));</span>
<a href="#l19.134"></a><span id="l19.134"> </span>
<a href="#l19.135"></a><span id="l19.135">         // Wednesday</span>
<a href="#l19.136"></a><span id="l19.136" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l19.137"></a><span id="l19.137" class="difflineminus">-            lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 4, HOUR, EVENTPATH)</span>
<a href="#l19.138"></a><span id="l19.138" class="difflineminus">-        );</span>
<a href="#l19.139"></a><span id="l19.139" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 4, null, EVENTPATH));</span>
<a href="#l19.140"></a><span id="l19.140"> </span>
<a href="#l19.141"></a><span id="l19.141">         // Friday</span>
<a href="#l19.142"></a><span id="l19.142" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l19.143"></a><span id="l19.143" class="difflineminus">-            lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 6, HOUR, EVENTPATH)</span>
<a href="#l19.144"></a><span id="l19.144" class="difflineminus">-        );</span>
<a href="#l19.145"></a><span id="l19.145" class="difflineplus">+        controller.waitForElement(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 6, null, EVENTPATH));</span>
<a href="#l19.146"></a><span id="l19.146"> </span>
<a href="#l19.147"></a><span id="l19.147">         viewForward(controller, 1);</span>
<a href="#l19.148"></a><span id="l19.148">     }</span>
<a href="#l19.149"></a><span id="l19.149"> </span>
<a href="#l19.150"></a><span id="l19.150">     // Monday, last occurrence</span>
<a href="#l19.151"></a><span id="l19.151" class="difflineminus">-    controller.waitForElement(</span>
<a href="#l19.152"></a><span id="l19.152" class="difflineminus">-        lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 2, HOUR, EVENTPATH)</span>
<a href="#l19.153"></a><span id="l19.153" class="difflineminus">-    );</span>
<a href="#l19.154"></a><span id="l19.154" class="difflineplus">+    controller.waitForElement(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 2, null, EVENTPATH));</span>
<a href="#l19.155"></a><span id="l19.155">     // Wednesday</span>
<a href="#l19.156"></a><span id="l19.156" class="difflineminus">-    controller.assertNodeNotExist(</span>
<a href="#l19.157"></a><span id="l19.157" class="difflineminus">-        lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 4, HOUR, EVENTPATH)</span>
<a href="#l19.158"></a><span id="l19.158" class="difflineminus">-    );</span>
<a href="#l19.159"></a><span id="l19.159" class="difflineplus">+    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 4, null, EVENTPATH));</span>
<a href="#l19.160"></a><span id="l19.160"> </span>
<a href="#l19.161"></a><span id="l19.161" class="difflineminus">-    // check multiweek view</span>
<a href="#l19.162"></a><span id="l19.162" class="difflineplus">+    // Check multiweek view.</span>
<a href="#l19.163"></a><span id="l19.163">     switchToView(controller, &quot;multiweek&quot;);</span>
<a href="#l19.164"></a><span id="l19.164">     goToDate(controller, 2009, 1, 5);</span>
<a href="#l19.165"></a><span id="l19.165">     checkMultiWeekView(&quot;multiweek&quot;);</span>
<a href="#l19.166"></a><span id="l19.166"> </span>
<a href="#l19.167"></a><span id="l19.167" class="difflineminus">-    // check month view</span>
<a href="#l19.168"></a><span id="l19.168" class="difflineplus">+    // Check month view.</span>
<a href="#l19.169"></a><span id="l19.169">     switchToView(controller, &quot;month&quot;);</span>
<a href="#l19.170"></a><span id="l19.170">     goToDate(controller, 2009, 1, 5);</span>
<a href="#l19.171"></a><span id="l19.171">     checkMultiWeekView(&quot;month&quot;);</span>
<a href="#l19.172"></a><span id="l19.172"> </span>
<a href="#l19.173"></a><span id="l19.173" class="difflineminus">-    // delete event</span>
<a href="#l19.174"></a><span id="l19.174" class="difflineminus">-    box = getEventBoxPath(&quot;month&quot;, EVENT_BOX, 2, 2, null) + EVENTPATH;</span>
<a href="#l19.175"></a><span id="l19.175" class="difflineminus">-    controller.click(lookup(box));</span>
<a href="#l19.176"></a><span id="l19.176" class="difflineminus">-    handleOccurrencePrompt(controller, eid(&quot;month-view&quot;), &quot;delete&quot;, true, false);</span>
<a href="#l19.177"></a><span id="l19.177" class="difflineminus">-    controller.waitForElementNotPresent(lookup(box));</span>
<a href="#l19.178"></a><span id="l19.178" class="difflineminus">-</span>
<a href="#l19.179"></a><span id="l19.179" class="difflineminus">-    // reset view</span>
<a href="#l19.180"></a><span id="l19.180" class="difflineminus">-    switchToView(controller, &quot;day&quot;);</span>
<a href="#l19.181"></a><span id="l19.181" class="difflineminus">-    controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l19.182"></a><span id="l19.182" class="difflineminus">-    controller.waitFor(() =&gt; eid(&quot;day-view&quot;).getNode().orient == &quot;vertical&quot;);</span>
<a href="#l19.183"></a><span id="l19.183" class="difflineplus">+    // Delete event.</span>
<a href="#l19.184"></a><span id="l19.184" class="difflineplus">+    box = lookupEventBox(&quot;month&quot;, EVENT_BOX, 2, 2, null, EVENTPATH);</span>
<a href="#l19.185"></a><span id="l19.185" class="difflineplus">+    controller.click(box);</span>
<a href="#l19.186"></a><span id="l19.186" class="difflineplus">+    handleOccurrencePrompt(controller, eid(&quot;month-view&quot;), &quot;delete&quot;, true);</span>
<a href="#l19.187"></a><span id="l19.187" class="difflineplus">+    controller.waitForElementNotPresent(box);</span>
<a href="#l19.188"></a><span id="l19.188"> }</span>
<a href="#l19.189"></a><span id="l19.189"> </span>
<a href="#l19.190"></a><span id="l19.190"> function setRecurrence(recurrence) {</span>
<a href="#l19.191"></a><span id="l19.191" class="difflineminus">-    let { sleep: recsleep, lookup: reclookup, eid: recid } =</span>
<a href="#l19.192"></a><span id="l19.192" class="difflineminus">-        helpersForController(recurrence);</span>
<a href="#l19.193"></a><span id="l19.193" class="difflineplus">+    let { sleep: recsleep, lookup: reclookup, eid: recid } = helpersForController(recurrence);</span>
<a href="#l19.194"></a><span id="l19.194"> </span>
<a href="#l19.195"></a><span id="l19.195">     // weekly</span>
<a href="#l19.196"></a><span id="l19.196">     recurrence.waitForElement(recid(&quot;period-list&quot;));</span>
<a href="#l19.197"></a><span id="l19.197">     menulistSelect(recid(&quot;period-list&quot;), &quot;1&quot;, recurrence);</span>
<a href="#l19.198"></a><span id="l19.198"> </span>
<a href="#l19.199"></a><span id="l19.199">     let mon = cal.l10n.getDateFmtString(&quot;day.2.Mmm&quot;);</span>
<a href="#l19.200"></a><span id="l19.200">     let wed = cal.l10n.getDateFmtString(&quot;day.4.Mmm&quot;);</span>
<a href="#l19.201"></a><span id="l19.201">     let fri = cal.l10n.getDateFmtString(&quot;day.6.Mmm&quot;);</span>
<a href="#l19.202"></a><span id="l19.202"> </span>
<a href="#l19.203"></a><span id="l19.203" class="difflineminus">-    // starting from Monday so it should be checked. We have to wait a little,</span>
<a href="#l19.204"></a><span id="l19.204" class="difflineplus">+    // Starting from Monday so it should be checked. We have to wait a little,</span>
<a href="#l19.205"></a><span id="l19.205">     // because the checkedstate is set in background by JS.</span>
<a href="#l19.206"></a><span id="l19.206">     recurrence.waitFor(() =&gt; {</span>
<a href="#l19.207"></a><span id="l19.207">         return recurrence.assertChecked(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${mon}&quot;}`));</span>
<a href="#l19.208"></a><span id="l19.208">     }, 30000);</span>
<a href="#l19.209"></a><span id="l19.209" class="difflineminus">-    // starting from Monday so it should be checked</span>
<a href="#l19.210"></a><span id="l19.210" class="difflineplus">+    // Starting from Monday so it should be checked.</span>
<a href="#l19.211"></a><span id="l19.211">     recurrence.assertChecked(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${mon}&quot;}`));</span>
<a href="#l19.212"></a><span id="l19.212" class="difflineminus">-    // check Wednesday and Friday too</span>
<a href="#l19.213"></a><span id="l19.213" class="difflineplus">+    // Check Wednesday and Friday too.</span>
<a href="#l19.214"></a><span id="l19.214">     recurrence.click(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${wed}&quot;}`));</span>
<a href="#l19.215"></a><span id="l19.215">     recurrence.click(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${fri}&quot;}`));</span>
<a href="#l19.216"></a><span id="l19.216"> </span>
<a href="#l19.217"></a><span id="l19.217" class="difflineminus">-    // set until date</span>
<a href="#l19.218"></a><span id="l19.218" class="difflineplus">+    // Set until date.</span>
<a href="#l19.219"></a><span id="l19.219">     recurrence.radio(recid(&quot;recurrence-range-until&quot;));</span>
<a href="#l19.220"></a><span id="l19.220"> </span>
<a href="#l19.221"></a><span id="l19.221" class="difflineminus">-    // delete previous date</span>
<a href="#l19.222"></a><span id="l19.222" class="difflineplus">+    // Delete previous date.</span>
<a href="#l19.223"></a><span id="l19.223">     let untilInput = reclookup(REC_DLG_UNTIL_INPUT);</span>
<a href="#l19.224"></a><span id="l19.224">     recurrence.keypress(untilInput, &quot;a&quot;, { accelKey: true });</span>
<a href="#l19.225"></a><span id="l19.225">     recurrence.keypress(untilInput, &quot;VK_DELETE&quot;, {});</span>
<a href="#l19.226"></a><span id="l19.226"> </span>
<a href="#l19.227"></a><span id="l19.227">     let dateFormatter = cal.getDateFormatter();</span>
<a href="#l19.228"></a><span id="l19.228"> </span>
<a href="#l19.229"></a><span id="l19.229" class="difflineminus">-    let endDateString = dateFormatter.formatDateShort(cal.dtz.jsDateToDateTime(ENDDATE, cal.dtz.floating));</span>
<a href="#l19.230"></a><span id="l19.230" class="difflineplus">+    let endDateString = dateFormatter.formatDateShort(</span>
<a href="#l19.231"></a><span id="l19.231" class="difflineplus">+        cal.dtz.jsDateToDateTime(ENDDATE, cal.dtz.floating)</span>
<a href="#l19.232"></a><span id="l19.232" class="difflineplus">+    );</span>
<a href="#l19.233"></a><span id="l19.233">     recsleep(SHORT_SLEEP);</span>
<a href="#l19.234"></a><span id="l19.234">     recurrence.type(untilInput, endDateString);</span>
<a href="#l19.235"></a><span id="l19.235"> </span>
<a href="#l19.236"></a><span id="l19.236">     recsleep(SHORT_SLEEP);</span>
<a href="#l19.237"></a><span id="l19.237" class="difflineminus">-    // Move focus to ensure the date is selected</span>
<a href="#l19.238"></a><span id="l19.238" class="difflineplus">+    // Move focus to ensure the date is selected.</span>
<a href="#l19.239"></a><span id="l19.239">     recurrence.keypress(untilInput, &quot;VK_TAB&quot;, {});</span>
<a href="#l19.240"></a><span id="l19.240"> </span>
<a href="#l19.241"></a><span id="l19.241" class="difflineminus">-    // close dialog</span>
<a href="#l19.242"></a><span id="l19.242" class="difflineplus">+    // Close dialog.</span>
<a href="#l19.243"></a><span id="l19.243">     recurrence.click(reclookup(REC_DLG_ACCEPT));</span>
<a href="#l19.244"></a><span id="l19.244"> }</span>
<a href="#l19.245"></a><span id="l19.245"> </span>
<a href="#l19.246"></a><span id="l19.246"> function checkMultiWeekView(view) {</span>
<a href="#l19.247"></a><span id="l19.247">     let startWeek = view == &quot;month&quot; ? 2 : 1;</span>
<a href="#l19.248"></a><span id="l19.248"> </span>
<a href="#l19.249"></a><span id="l19.249">     for (let week = startWeek; week &lt; startWeek + 3; week++) {</span>
<a href="#l19.250"></a><span id="l19.250">         // Monday</span>
<a href="#l19.251"></a><span id="l19.251" class="difflineminus">-        controller.waitForElement(</span>
<a href="#l19.252"></a><span id="l19.252" class="difflineminus">-            lookupEventBox(view, EVENT_BOX, week, 2, null, EVENTPATH)</span>
<a href="#l19.253"></a><span id="l19.253" class="difflineminus">-        );</span>
<a href="#l19.254"></a><span id="l19.254" class="difflineplus">+        controller.waitForElement(lookupEventBox(view, EVENT_BOX, week, 2, null, EVENTPATH));</span>
<a href="#l19.255"></a><span id="l19.255">         // Wednesday</span>
<a href="#l19.256"></a><span id="l19.256" class="difflineminus">-        controller.assertNode(</span>
<a href="#l19.257"></a><span id="l19.257" class="difflineminus">-            lookupEventBox(view, EVENT_BOX, week, 4, null, EVENTPATH)</span>
<a href="#l19.258"></a><span id="l19.258" class="difflineminus">-        );</span>
<a href="#l19.259"></a><span id="l19.259" class="difflineplus">+        controller.assertNode(lookupEventBox(view, EVENT_BOX, week, 4, null, EVENTPATH));</span>
<a href="#l19.260"></a><span id="l19.260">         // Friday</span>
<a href="#l19.261"></a><span id="l19.261" class="difflineminus">-        controller.assertNode(</span>
<a href="#l19.262"></a><span id="l19.262" class="difflineminus">-            lookupEventBox(view, EVENT_BOX, week, 6, null, EVENTPATH)</span>
<a href="#l19.263"></a><span id="l19.263" class="difflineminus">-        );</span>
<a href="#l19.264"></a><span id="l19.264" class="difflineplus">+        controller.assertNode(lookupEventBox(view, EVENT_BOX, week, 6, null, EVENTPATH));</span>
<a href="#l19.265"></a><span id="l19.265">     }</span>
<a href="#l19.266"></a><span id="l19.266"> </span>
<a href="#l19.267"></a><span id="l19.267">     // Monday, last occurrence</span>
<a href="#l19.268"></a><span id="l19.268" class="difflineminus">-    controller.assertNode(</span>
<a href="#l19.269"></a><span id="l19.269" class="difflineminus">-        lookupEventBox(view, EVENT_BOX, startWeek + 3, 2, null, EVENTPATH)</span>
<a href="#l19.270"></a><span id="l19.270" class="difflineminus">-    );</span>
<a href="#l19.271"></a><span id="l19.271" class="difflineplus">+    controller.assertNode(lookupEventBox(view, EVENT_BOX, startWeek + 3, 2, null, EVENTPATH));</span>
<a href="#l19.272"></a><span id="l19.272"> </span>
<a href="#l19.273"></a><span id="l19.273">     // Wednesday</span>
<a href="#l19.274"></a><span id="l19.274">     controller.assertNodeNotExist(</span>
<a href="#l19.275"></a><span id="l19.275">         lookupEventBox(view, EVENT_BOX, startWeek + 3, 4, null, EVENTPATH)</span>
<a href="#l19.276"></a><span id="l19.276">     );</span>
<a href="#l19.277"></a><span id="l19.277"> }</span>
<a href="#l19.278"></a><span id="l19.278"> </span>
<a href="#l19.279"></a><span id="l19.279"> function teardownTest(module) {</span>
<a href="#l19.280"></a><span id="l19.280">     deleteCalendars(controller, CALENDARNAME);</span>
<a href="#l19.281"></a><span id="l19.281" class="difflineplus">+    // Reset view.</span>
<a href="#l19.282"></a><span id="l19.282" class="difflineplus">+    switchToView(controller, &quot;day&quot;);</span>
<a href="#l19.283"></a><span id="l19.283" class="difflineplus">+    if (eid(&quot;day-view&quot;).getNode().orient == &quot;horizontal&quot;) {</span>
<a href="#l19.284"></a><span id="l19.284" class="difflineplus">+        controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l19.285"></a><span id="l19.285" class="difflineplus">+    }</span>
<a href="#l19.286"></a><span id="l19.286" class="difflineplus">+    controller.waitFor(() =&gt; eid(&quot;day-view&quot;).getNode().orient == &quot;vertical&quot;);</span>
<a href="#l19.287"></a><span id="l19.287"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/calendar/test/mozmill/recurrenceRotated/testWeeklyWithExceptionRecurrence.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/calendar/test/mozmill/recurrenceRotated/testWeeklyWithExceptionRecurrence.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -1,304 +1,294 @@</span>
<a href="#l20.4"></a><span id="l20.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.5"></a><span id="l20.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.6"></a><span id="l20.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.7"></a><span id="l20.7"> </span>
<a href="#l20.8"></a><span id="l20.8" class="difflineminus">-var MODULE_NAME = &quot;testWeeklyWithExceptionRecurrence&quot;;</span>
<a href="#l20.9"></a><span id="l20.9" class="difflineplus">+var MODULE_NAME = &quot;testWeeklyWithExceptionRecurrenceRotated&quot;;</span>
<a href="#l20.10"></a><span id="l20.10"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineminus">-var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;window-helpers&quot;];</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;item-editing-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l20.13"></a><span id="l20.13"> </span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-var TIMEOUT_MODAL_DIALOG, CALENDARNAME, EVENTPATH, EVENT_BOX;</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">-var CANVAS_BOX, REC_DLG_ACCEPT, REC_DLG_DAYS;</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+var TIMEOUT_MODAL_DIALOG, CALENDARNAME, EVENT_BOX, CANVAS_BOX;</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineplus">+var DAY_VIEW, WEEK_VIEW, EVENTPATH;</span>
<a href="#l20.18"></a><span id="l20.18"> var helpersForController, handleOccurrencePrompt, switchToView, goToDate;</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-var invokeEventDialog, viewForward, deleteCalendars, createCalendar, setData;</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineplus">+var invokeEventDialog, viewForward, deleteCalendars, createCalendar;</span>
<a href="#l20.21"></a><span id="l20.21"> var menulistSelect;</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineplus">+var REPEAT_DETAILS, REC_DLG_ACCEPT, REC_DLG_DAYS;</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineplus">+var helpersForEditUI, setData;</span>
<a href="#l20.24"></a><span id="l20.24"> var plan_for_modal_dialog, wait_for_modal_dialog;</span>
<a href="#l20.25"></a><span id="l20.25"> </span>
<a href="#l20.26"></a><span id="l20.26"> var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;, null);</span>
<a href="#l20.27"></a><span id="l20.27"> </span>
<a href="#l20.28"></a><span id="l20.28"> const HOUR = 8;</span>
<a href="#l20.29"></a><span id="l20.29"> const STARTDATE = new Date(2009, 0, 6);</span>
<a href="#l20.30"></a><span id="l20.30"> </span>
<a href="#l20.31"></a><span id="l20.31"> function setupModule(module) {</span>
<a href="#l20.32"></a><span id="l20.32">     controller = mozmill.getMail3PaneController();</span>
<a href="#l20.33"></a><span id="l20.33">     ({</span>
<a href="#l20.34"></a><span id="l20.34">         TIMEOUT_MODAL_DIALOG,</span>
<a href="#l20.35"></a><span id="l20.35">         CALENDARNAME,</span>
<a href="#l20.36"></a><span id="l20.36">         EVENT_BOX,</span>
<a href="#l20.37"></a><span id="l20.37">         CANVAS_BOX,</span>
<a href="#l20.38"></a><span id="l20.38">         EVENTPATH,</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineminus">-        REC_DLG_ACCEPT,</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineminus">-        REC_DLG_DAYS,</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+        DAY_VIEW,</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+        WEEK_VIEW,</span>
<a href="#l20.43"></a><span id="l20.43">         helpersForController,</span>
<a href="#l20.44"></a><span id="l20.44">         handleOccurrencePrompt,</span>
<a href="#l20.45"></a><span id="l20.45">         switchToView,</span>
<a href="#l20.46"></a><span id="l20.46">         goToDate,</span>
<a href="#l20.47"></a><span id="l20.47">         invokeEventDialog,</span>
<a href="#l20.48"></a><span id="l20.48">         viewForward,</span>
<a href="#l20.49"></a><span id="l20.49">         deleteCalendars,</span>
<a href="#l20.50"></a><span id="l20.50">         createCalendar,</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineminus">-        setData,</span>
<a href="#l20.52"></a><span id="l20.52">         menulistSelect</span>
<a href="#l20.53"></a><span id="l20.53">     } = collector.getModule(&quot;calendar-utils&quot;));</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineminus">-    collector.getModule(&quot;calendar-utils&quot;).setupModule();</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineplus">+    collector.getModule(&quot;calendar-utils&quot;).setupModule(controller);</span>
<a href="#l20.56"></a><span id="l20.56">     Object.assign(module, helpersForController(controller));</span>
<a href="#l20.57"></a><span id="l20.57"> </span>
<a href="#l20.58"></a><span id="l20.58" class="difflineplus">+    ({</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineplus">+        REPEAT_DETAILS,</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineplus">+        REC_DLG_ACCEPT,</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineplus">+        REC_DLG_DAYS,</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineplus">+        helpersForEditUI,</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineplus">+        setData</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineplus">+    } = collector.getModule(&quot;item-editing-helpers&quot;));</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineplus">+    collector.getModule(&quot;item-editing-helpers&quot;).setupModule(module);</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineplus">+</span>
<a href="#l20.67"></a><span id="l20.67">     ({ plan_for_modal_dialog, wait_for_modal_dialog } =</span>
<a href="#l20.68"></a><span id="l20.68">         collector.getModule(&quot;window-helpers&quot;)</span>
<a href="#l20.69"></a><span id="l20.69">     );</span>
<a href="#l20.70"></a><span id="l20.70"> </span>
<a href="#l20.71"></a><span id="l20.71">     createCalendar(controller, CALENDARNAME);</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineplus">+    // Rotate view.</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineplus">+    controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineplus">+    controller.waitFor(() =&gt; eid(&quot;day-view&quot;).getNode().orient == &quot;horizontal&quot;);</span>
<a href="#l20.75"></a><span id="l20.75"> }</span>
<a href="#l20.76"></a><span id="l20.76"> </span>
<a href="#l20.77"></a><span id="l20.77"> function testWeeklyWithExceptionRecurrence() {</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineminus">-    controller.click(eid(&quot;calendar-tab-button&quot;));</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineminus">-    switchToView(controller, &quot;day&quot;);</span>
<a href="#l20.80"></a><span id="l20.80">     goToDate(controller, 2009, 1, 5);</span>
<a href="#l20.81"></a><span id="l20.81"> </span>
<a href="#l20.82"></a><span id="l20.82" class="difflineminus">-    // rotate view</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineminus">-    controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineminus">-    controller.waitFor(() =&gt; eid(&quot;day-view&quot;).getNode().orient == &quot;horizontal&quot;);</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineminus">-</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineminus">-    // create weekly recurring event</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineplus">+    // Create weekly recurring event.</span>
<a href="#l20.88"></a><span id="l20.88">     let eventBox = lookupEventBox(&quot;day&quot;, CANVAS_BOX, null, 1, HOUR);</span>
<a href="#l20.89"></a><span id="l20.89">     invokeEventDialog(controller, eventBox, (event, iframe) =&gt; {</span>
<a href="#l20.90"></a><span id="l20.90">         let { eid: eventid } = helpersForController(event);</span>
<a href="#l20.91"></a><span id="l20.91"> </span>
<a href="#l20.92"></a><span id="l20.92">         event.waitForElement(eventid(&quot;item-repeat&quot;));</span>
<a href="#l20.93"></a><span id="l20.93">         plan_for_modal_dialog(&quot;Calendar:EventDialog:Recurrence&quot;, setRecurrence);</span>
<a href="#l20.94"></a><span id="l20.94">         menulistSelect(eventid(&quot;item-repeat&quot;), &quot;custom&quot;, event);</span>
<a href="#l20.95"></a><span id="l20.95">         wait_for_modal_dialog(&quot;Calendar:EventDialog:Recurrence&quot;, TIMEOUT_MODAL_DIALOG);</span>
<a href="#l20.96"></a><span id="l20.96"> </span>
<a href="#l20.97"></a><span id="l20.97">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l20.98"></a><span id="l20.98">     });</span>
<a href="#l20.99"></a><span id="l20.99"> </span>
<a href="#l20.100"></a><span id="l20.100" class="difflineminus">-    // move 5th January occurrence to 6th January</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineminus">-    eventBox = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, HOUR, EVENTPATH);</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineminus">-    handleOccurrencePrompt(controller, eventBox, &quot;modify&quot;, false, false);</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineplus">+    // Move 5th January occurrence to 6th January.</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineplus">+    eventBox = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, EVENTPATH);</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineplus">+    handleOccurrencePrompt(controller, eventBox, &quot;modify&quot;, false);</span>
<a href="#l20.106"></a><span id="l20.106">     invokeEventDialog(controller, null, (event, iframe) =&gt; {</span>
<a href="#l20.107"></a><span id="l20.107">         let { eid: eventid } = helpersForController(event);</span>
<a href="#l20.108"></a><span id="l20.108"> </span>
<a href="#l20.109"></a><span id="l20.109">         setData(event, iframe, { startdate: STARTDATE, enddate: STARTDATE });</span>
<a href="#l20.110"></a><span id="l20.110">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l20.111"></a><span id="l20.111">     });</span>
<a href="#l20.112"></a><span id="l20.112"> </span>
<a href="#l20.113"></a><span id="l20.113" class="difflineminus">-    // change recurrence rule</span>
<a href="#l20.114"></a><span id="l20.114" class="difflineplus">+    // Change recurrence rule.</span>
<a href="#l20.115"></a><span id="l20.115">     goToDate(controller, 2009, 1, 7);</span>
<a href="#l20.116"></a><span id="l20.116" class="difflineminus">-    eventBox = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, HOUR, EVENTPATH);</span>
<a href="#l20.117"></a><span id="l20.117" class="difflineminus">-    handleOccurrencePrompt(controller, eventBox, &quot;modify&quot;, true, false);</span>
<a href="#l20.118"></a><span id="l20.118" class="difflineplus">+    eventBox = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, EVENTPATH);</span>
<a href="#l20.119"></a><span id="l20.119" class="difflineplus">+    handleOccurrencePrompt(controller, eventBox, &quot;modify&quot;, true);</span>
<a href="#l20.120"></a><span id="l20.120">     invokeEventDialog(controller, null, (event, iframe) =&gt; {</span>
<a href="#l20.121"></a><span id="l20.121">         let { eid: eventid } = helpersForController(event);</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineminus">-        let { lookup: iframelookup } = helpersForController(iframe);</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineplus">+        let { iframeLookup } = helpersForEditUI(iframe);</span>
<a href="#l20.124"></a><span id="l20.124"> </span>
<a href="#l20.125"></a><span id="l20.125">         event.waitForElement(eventid(&quot;item-repeat&quot;));</span>
<a href="#l20.126"></a><span id="l20.126">         plan_for_modal_dialog(&quot;Calendar:EventDialog:Recurrence&quot;, changeRecurrence);</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineminus">-        event.click(iframelookup(`</span>
<a href="#l20.128"></a><span id="l20.128" class="difflineminus">-            /id(&quot;calendar-event-dialog-inner&quot;)/id(&quot;event-grid&quot;)/</span>
<a href="#l20.129"></a><span id="l20.129" class="difflineminus">-            id(&quot;event-grid-rows&quot;)/id(&quot;event-grid-recurrence-row&quot;)/</span>
<a href="#l20.130"></a><span id="l20.130" class="difflineminus">-            id(&quot;event-grid-recurrence-picker-box&quot;)/id(&quot;repeat-deck&quot;)/</span>
<a href="#l20.131"></a><span id="l20.131" class="difflineminus">-            id(&quot;repeat-details&quot;)/[0]</span>
<a href="#l20.132"></a><span id="l20.132" class="difflineminus">-        `));</span>
<a href="#l20.133"></a><span id="l20.133" class="difflineplus">+        event.click(iframeLookup(REPEAT_DETAILS));</span>
<a href="#l20.134"></a><span id="l20.134">         wait_for_modal_dialog(&quot;Calendar:EventDialog:Recurrence&quot;, TIMEOUT_MODAL_DIALOG);</span>
<a href="#l20.135"></a><span id="l20.135"> </span>
<a href="#l20.136"></a><span id="l20.136">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l20.137"></a><span id="l20.137">     });</span>
<a href="#l20.138"></a><span id="l20.138"> </span>
<a href="#l20.139"></a><span id="l20.139" class="difflineminus">-    // check two weeks</span>
<a href="#l20.140"></a><span id="l20.140" class="difflineplus">+    // Check two weeks.</span>
<a href="#l20.141"></a><span id="l20.141">     // day view</span>
<a href="#l20.142"></a><span id="l20.142">     switchToView(controller, &quot;day&quot;);</span>
<a href="#l20.143"></a><span id="l20.143" class="difflineminus">-    let path = getEventBoxPath(&quot;day&quot;, EVENT_BOX, null, 1, HOUR) + EVENTPATH;</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineplus">+    let path = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, EVENTPATH);</span>
<a href="#l20.145"></a><span id="l20.145"> </span>
<a href="#l20.146"></a><span id="l20.146">     goToDate(controller, 2009, 1, 5);</span>
<a href="#l20.147"></a><span id="l20.147" class="difflineminus">-    controller.waitForElementNotPresent(lookup(path));</span>
<a href="#l20.148"></a><span id="l20.148" class="difflineplus">+    controller.waitForElementNotPresent(path);</span>
<a href="#l20.149"></a><span id="l20.149"> </span>
<a href="#l20.150"></a><span id="l20.150">     viewForward(controller, 1);</span>
<a href="#l20.151"></a><span id="l20.151">     let tuesPath = `</span>
<a href="#l20.152"></a><span id="l20.152" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;tabmail&quot;)/id(&quot;tabmail-tabbox&quot;)/</span>
<a href="#l20.153"></a><span id="l20.153" class="difflineminus">-        id(&quot;tabpanelcontainer&quot;)/id(&quot;calendarTabPanel&quot;)/id(&quot;calendarContent&quot;)/</span>
<a href="#l20.154"></a><span id="l20.154" class="difflineminus">-        id(&quot;calendarDisplayDeck&quot;)/id(&quot;calendar-view-box&quot;)/id(&quot;view-deck&quot;)/</span>
<a href="#l20.155"></a><span id="l20.155" class="difflineminus">-        id(&quot;day-view&quot;)/anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;scrollbox&quot;})/</span>
<a href="#l20.156"></a><span id="l20.156" class="difflineplus">+        ${DAY_VIEW}/anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;scrollbox&quot;})/</span>
<a href="#l20.157"></a><span id="l20.157">         anon({&quot;anonid&quot;:&quot;daybox&quot;})/[0]/anon({&quot;anonid&quot;:&quot;boxstack&quot;})/</span>
<a href="#l20.158"></a><span id="l20.158">         anon({&quot;anonid&quot;:&quot;topbox&quot;})/{&quot;flex&quot;:&quot;1&quot;}/{&quot;flex&quot;:&quot;1&quot;}/[eventIndex]</span>
<a href="#l20.159"></a><span id="l20.159">     `;</span>
<a href="#l20.160"></a><span id="l20.160"> </span>
<a href="#l20.161"></a><span id="l20.161" class="difflineminus">-    // assert exactly two</span>
<a href="#l20.162"></a><span id="l20.162" class="difflineplus">+    // Assert exactly two.</span>
<a href="#l20.163"></a><span id="l20.163">     controller.waitForElement(lookup(tuesPath.replace(&quot;eventIndex&quot;, &quot;0&quot;) + EVENTPATH));</span>
<a href="#l20.164"></a><span id="l20.164">     controller.assertNode(lookup(tuesPath.replace(&quot;eventIndex&quot;, &quot;1&quot;) + EVENTPATH));</span>
<a href="#l20.165"></a><span id="l20.165">     controller.assertNodeNotExist(lookup(tuesPath.replace(&quot;eventIndex&quot;, &quot;2&quot;) + EVENTPATH));</span>
<a href="#l20.166"></a><span id="l20.166"> </span>
<a href="#l20.167"></a><span id="l20.167">     viewForward(controller, 1);</span>
<a href="#l20.168"></a><span id="l20.168" class="difflineminus">-    controller.waitForElement(lookup(path));</span>
<a href="#l20.169"></a><span id="l20.169" class="difflineplus">+    controller.waitForElement(path);</span>
<a href="#l20.170"></a><span id="l20.170">     viewForward(controller, 1);</span>
<a href="#l20.171"></a><span id="l20.171" class="difflineminus">-    controller.waitForElementNotPresent(lookup(path));</span>
<a href="#l20.172"></a><span id="l20.172" class="difflineplus">+    controller.waitForElementNotPresent(path);</span>
<a href="#l20.173"></a><span id="l20.173">     viewForward(controller, 1);</span>
<a href="#l20.174"></a><span id="l20.174" class="difflineminus">-    controller.waitForElement(lookup(path));</span>
<a href="#l20.175"></a><span id="l20.175" class="difflineplus">+    controller.waitForElement(path);</span>
<a href="#l20.176"></a><span id="l20.176">     viewForward(controller, 1);</span>
<a href="#l20.177"></a><span id="l20.177" class="difflineminus">-    controller.waitForElementNotPresent(lookup(path));</span>
<a href="#l20.178"></a><span id="l20.178" class="difflineplus">+    controller.waitForElementNotPresent(path);</span>
<a href="#l20.179"></a><span id="l20.179">     viewForward(controller, 1);</span>
<a href="#l20.180"></a><span id="l20.180" class="difflineminus">-    controller.waitForElementNotPresent(lookup(path));</span>
<a href="#l20.181"></a><span id="l20.181" class="difflineplus">+    controller.waitForElementNotPresent(path);</span>
<a href="#l20.182"></a><span id="l20.182"> </span>
<a href="#l20.183"></a><span id="l20.183">     // next week</span>
<a href="#l20.184"></a><span id="l20.184">     viewForward(controller, 1);</span>
<a href="#l20.185"></a><span id="l20.185" class="difflineminus">-    controller.waitForElement(lookup(path));</span>
<a href="#l20.186"></a><span id="l20.186" class="difflineplus">+    controller.waitForElement(path);</span>
<a href="#l20.187"></a><span id="l20.187">     viewForward(controller, 1);</span>
<a href="#l20.188"></a><span id="l20.188" class="difflineminus">-    controller.waitForElement(lookup(path));</span>
<a href="#l20.189"></a><span id="l20.189" class="difflineplus">+    controller.waitForElement(path);</span>
<a href="#l20.190"></a><span id="l20.190">     viewForward(controller, 1);</span>
<a href="#l20.191"></a><span id="l20.191" class="difflineminus">-    controller.waitForElement(lookup(path));</span>
<a href="#l20.192"></a><span id="l20.192" class="difflineplus">+    controller.waitForElement(path);</span>
<a href="#l20.193"></a><span id="l20.193">     viewForward(controller, 1);</span>
<a href="#l20.194"></a><span id="l20.194" class="difflineminus">-    controller.waitForElementNotPresent(lookup(path));</span>
<a href="#l20.195"></a><span id="l20.195" class="difflineplus">+    controller.waitForElementNotPresent(path);</span>
<a href="#l20.196"></a><span id="l20.196">     viewForward(controller, 1);</span>
<a href="#l20.197"></a><span id="l20.197" class="difflineminus">-    controller.waitForElement(lookup(path));</span>
<a href="#l20.198"></a><span id="l20.198" class="difflineplus">+    controller.waitForElement(path);</span>
<a href="#l20.199"></a><span id="l20.199">     viewForward(controller, 1);</span>
<a href="#l20.200"></a><span id="l20.200" class="difflineminus">-    controller.waitForElementNotPresent(lookup(path));</span>
<a href="#l20.201"></a><span id="l20.201" class="difflineplus">+    controller.waitForElementNotPresent(path);</span>
<a href="#l20.202"></a><span id="l20.202"> </span>
<a href="#l20.203"></a><span id="l20.203">     // week view</span>
<a href="#l20.204"></a><span id="l20.204">     switchToView(controller, &quot;week&quot;);</span>
<a href="#l20.205"></a><span id="l20.205">     goToDate(controller, 2009, 1, 5);</span>
<a href="#l20.206"></a><span id="l20.206"> </span>
<a href="#l20.207"></a><span id="l20.207">     tuesPath = `</span>
<a href="#l20.208"></a><span id="l20.208" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;tabmail&quot;)/id(&quot;tabmail-tabbox&quot;)/</span>
<a href="#l20.209"></a><span id="l20.209" class="difflineminus">-        id(&quot;tabpanelcontainer&quot;)/id(&quot;calendarTabPanel&quot;)/id(&quot;calendarContent&quot;)/</span>
<a href="#l20.210"></a><span id="l20.210" class="difflineminus">-        id(&quot;calendarDisplayDeck&quot;)/id(&quot;calendar-view-box&quot;)/id(&quot;view-deck&quot;)/</span>
<a href="#l20.211"></a><span id="l20.211" class="difflineminus">-        id(&quot;week-view&quot;)/anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;scrollbox&quot;})/</span>
<a href="#l20.212"></a><span id="l20.212" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;daybox&quot;})/[dayIndex]/anon({&quot;anonid&quot;:&quot;boxstack&quot;})/</span>
<a href="#l20.213"></a><span id="l20.213" class="difflineplus">+        ${WEEK_VIEW}/anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;scrollbox&quot;})/</span>
<a href="#l20.214"></a><span id="l20.214" class="difflineplus">+        anon({&quot;anonid&quot;:&quot;daybox&quot;})/[2]/anon({&quot;anonid&quot;:&quot;boxstack&quot;})/</span>
<a href="#l20.215"></a><span id="l20.215">         anon({&quot;anonid&quot;:&quot;topbox&quot;})/{&quot;flex&quot;:&quot;1&quot;}/{&quot;flex&quot;:&quot;1&quot;}/[eventIndex]</span>
<a href="#l20.216"></a><span id="l20.216">     `;</span>
<a href="#l20.217"></a><span id="l20.217"> </span>
<a href="#l20.218"></a><span id="l20.218" class="difflineminus">-    // assert exactly two</span>
<a href="#l20.219"></a><span id="l20.219" class="difflineminus">-    controller.waitForElement(lookup(</span>
<a href="#l20.220"></a><span id="l20.220" class="difflineminus">-        tuesPath.replace(&quot;dayIndex&quot;, &quot;2&quot;).replace(&quot;eventIndex&quot;, &quot;0&quot;) + EVENTPATH</span>
<a href="#l20.221"></a><span id="l20.221" class="difflineminus">-    ));</span>
<a href="#l20.222"></a><span id="l20.222" class="difflineminus">-    controller.assertNode(lookup(</span>
<a href="#l20.223"></a><span id="l20.223" class="difflineminus">-        tuesPath.replace(&quot;dayIndex&quot;, &quot;2&quot;).replace(&quot;eventIndex&quot;, &quot;1&quot;) + EVENTPATH</span>
<a href="#l20.224"></a><span id="l20.224" class="difflineminus">-    ));</span>
<a href="#l20.225"></a><span id="l20.225" class="difflineminus">-    controller.assertNodeNotExist(lookup(</span>
<a href="#l20.226"></a><span id="l20.226" class="difflineminus">-        tuesPath.replace(&quot;dayIndex&quot;, &quot;2&quot;).replace(&quot;eventIndex&quot;, &quot;2&quot;) + EVENTPATH</span>
<a href="#l20.227"></a><span id="l20.227" class="difflineminus">-    ));</span>
<a href="#l20.228"></a><span id="l20.228" class="difflineplus">+    // Assert exactly two.</span>
<a href="#l20.229"></a><span id="l20.229" class="difflineplus">+    controller.waitForElement(lookup(tuesPath.replace(&quot;eventIndex&quot;, &quot;0&quot;) + EVENTPATH));</span>
<a href="#l20.230"></a><span id="l20.230" class="difflineplus">+    controller.assertNode(lookup(tuesPath.replace(&quot;eventIndex&quot;, &quot;1&quot;) + EVENTPATH));</span>
<a href="#l20.231"></a><span id="l20.231" class="difflineplus">+    controller.assertNodeNotExist(lookup(tuesPath.replace(&quot;eventIndex&quot;, &quot;2&quot;) + EVENTPATH));</span>
<a href="#l20.232"></a><span id="l20.232"> </span>
<a href="#l20.233"></a><span id="l20.233" class="difflineminus">-    // wait for the last occurrence because this appears latest.</span>
<a href="#l20.234"></a><span id="l20.234" class="difflineminus">-    controller.waitForElement(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 6, HOUR));</span>
<a href="#l20.235"></a><span id="l20.235" class="difflineminus">-    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 1, HOUR));</span>
<a href="#l20.236"></a><span id="l20.236" class="difflineminus">-    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 2, HOUR));</span>
<a href="#l20.237"></a><span id="l20.237" class="difflineminus">-    controller.assertNode(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 4, HOUR));</span>
<a href="#l20.238"></a><span id="l20.238" class="difflineminus">-    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 5, HOUR));</span>
<a href="#l20.239"></a><span id="l20.239" class="difflineminus">-    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 7, HOUR));</span>
<a href="#l20.240"></a><span id="l20.240" class="difflineplus">+    // Wait for the last occurrence because this appears last.</span>
<a href="#l20.241"></a><span id="l20.241" class="difflineplus">+    controller.waitForElement(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 6, null));</span>
<a href="#l20.242"></a><span id="l20.242" class="difflineplus">+    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 1, null));</span>
<a href="#l20.243"></a><span id="l20.243" class="difflineplus">+    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 2, null));</span>
<a href="#l20.244"></a><span id="l20.244" class="difflineplus">+    controller.assertNode(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 4, null));</span>
<a href="#l20.245"></a><span id="l20.245" class="difflineplus">+    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 5, null));</span>
<a href="#l20.246"></a><span id="l20.246" class="difflineplus">+    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 7, null));</span>
<a href="#l20.247"></a><span id="l20.247"> </span>
<a href="#l20.248"></a><span id="l20.248">     viewForward(controller, 1);</span>
<a href="#l20.249"></a><span id="l20.249" class="difflineminus">-    controller.waitForElement(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 6, HOUR));</span>
<a href="#l20.250"></a><span id="l20.250" class="difflineminus">-    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 1, HOUR));</span>
<a href="#l20.251"></a><span id="l20.251" class="difflineminus">-    controller.assertNode(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 2, HOUR));</span>
<a href="#l20.252"></a><span id="l20.252" class="difflineminus">-    controller.assertNode(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 3, HOUR));</span>
<a href="#l20.253"></a><span id="l20.253" class="difflineminus">-    controller.assertNode(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 4, HOUR));</span>
<a href="#l20.254"></a><span id="l20.254" class="difflineminus">-    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 5, HOUR));</span>
<a href="#l20.255"></a><span id="l20.255" class="difflineminus">-    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 7, HOUR));</span>
<a href="#l20.256"></a><span id="l20.256" class="difflineplus">+    controller.waitForElement(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 6, null));</span>
<a href="#l20.257"></a><span id="l20.257" class="difflineplus">+    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 1, null));</span>
<a href="#l20.258"></a><span id="l20.258" class="difflineplus">+    controller.assertNode(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 2, null));</span>
<a href="#l20.259"></a><span id="l20.259" class="difflineplus">+    controller.assertNode(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 3, null));</span>
<a href="#l20.260"></a><span id="l20.260" class="difflineplus">+    controller.assertNode(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 4, null));</span>
<a href="#l20.261"></a><span id="l20.261" class="difflineplus">+    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 5, null));</span>
<a href="#l20.262"></a><span id="l20.262" class="difflineplus">+    controller.assertNodeNotExist(lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 7, null));</span>
<a href="#l20.263"></a><span id="l20.263"> </span>
<a href="#l20.264"></a><span id="l20.264">     // multiweek view</span>
<a href="#l20.265"></a><span id="l20.265">     switchToView(controller, &quot;multiweek&quot;);</span>
<a href="#l20.266"></a><span id="l20.266">     goToDate(controller, 2009, 1, 5);</span>
<a href="#l20.267"></a><span id="l20.267">     checkMultiWeekView(&quot;multiweek&quot;);</span>
<a href="#l20.268"></a><span id="l20.268"> </span>
<a href="#l20.269"></a><span id="l20.269">     // month view</span>
<a href="#l20.270"></a><span id="l20.270">     switchToView(controller, &quot;month&quot;);</span>
<a href="#l20.271"></a><span id="l20.271">     checkMultiWeekView(&quot;month&quot;);</span>
<a href="#l20.272"></a><span id="l20.272"> </span>
<a href="#l20.273"></a><span id="l20.273" class="difflineminus">-    // delete event</span>
<a href="#l20.274"></a><span id="l20.274" class="difflineplus">+    // Delete event.</span>
<a href="#l20.275"></a><span id="l20.275">     switchToView(controller, &quot;day&quot;);</span>
<a href="#l20.276"></a><span id="l20.276">     goToDate(controller, 2009, 1, 12);</span>
<a href="#l20.277"></a><span id="l20.277" class="difflineminus">-    path = getEventBoxPath(&quot;day&quot;, EVENT_BOX, null, 1, HOUR) + EVENTPATH;</span>
<a href="#l20.278"></a><span id="l20.278" class="difflineminus">-    controller.click(lookup(path));</span>
<a href="#l20.279"></a><span id="l20.279" class="difflineminus">-    handleOccurrencePrompt(controller, eid(&quot;day-view&quot;), &quot;delete&quot;, true, false);</span>
<a href="#l20.280"></a><span id="l20.280" class="difflineminus">-    controller.waitForElementNotPresent(lookup(path));</span>
<a href="#l20.281"></a><span id="l20.281" class="difflineminus">-</span>
<a href="#l20.282"></a><span id="l20.282" class="difflineminus">-    // reset view</span>
<a href="#l20.283"></a><span id="l20.283" class="difflineminus">-    controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l20.284"></a><span id="l20.284" class="difflineminus">-    controller.waitFor(() =&gt; eid(&quot;day-view&quot;).getNode().orient == &quot;vertical&quot;);</span>
<a href="#l20.285"></a><span id="l20.285" class="difflineplus">+    path = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, EVENTPATH);</span>
<a href="#l20.286"></a><span id="l20.286" class="difflineplus">+    controller.click(path);</span>
<a href="#l20.287"></a><span id="l20.287" class="difflineplus">+    handleOccurrencePrompt(controller, eid(&quot;day-view&quot;), &quot;delete&quot;, true);</span>
<a href="#l20.288"></a><span id="l20.288" class="difflineplus">+    controller.waitForElementNotPresent(path);</span>
<a href="#l20.289"></a><span id="l20.289"> }</span>
<a href="#l20.290"></a><span id="l20.290"> </span>
<a href="#l20.291"></a><span id="l20.291"> function setRecurrence(recurrence) {</span>
<a href="#l20.292"></a><span id="l20.292">     let { lookup: reclookup, eid: recid } = helpersForController(recurrence);</span>
<a href="#l20.293"></a><span id="l20.293"> </span>
<a href="#l20.294"></a><span id="l20.294">     // weekly</span>
<a href="#l20.295"></a><span id="l20.295">     menulistSelect(recid(&quot;period-list&quot;), &quot;1&quot;, recurrence);</span>
<a href="#l20.296"></a><span id="l20.296"> </span>
<a href="#l20.297"></a><span id="l20.297">     let mon = cal.l10n.getDateFmtString(&quot;day.2.Mmm&quot;);</span>
<a href="#l20.298"></a><span id="l20.298">     let wed = cal.l10n.getDateFmtString(&quot;day.4.Mmm&quot;);</span>
<a href="#l20.299"></a><span id="l20.299">     let fri = cal.l10n.getDateFmtString(&quot;day.6.Mmm&quot;);</span>
<a href="#l20.300"></a><span id="l20.300"> </span>
<a href="#l20.301"></a><span id="l20.301" class="difflineminus">-    // starting from Monday so it should be checked. We have to wait a little,</span>
<a href="#l20.302"></a><span id="l20.302" class="difflineplus">+    // Starting from Monday so it should be checked. We have to wait a little,</span>
<a href="#l20.303"></a><span id="l20.303">     // because the checkedstate is set in background by JS.</span>
<a href="#l20.304"></a><span id="l20.304">     recurrence.waitFor(() =&gt; {</span>
<a href="#l20.305"></a><span id="l20.305">         return recurrence.assertChecked(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${mon}&quot;}`));</span>
<a href="#l20.306"></a><span id="l20.306">     }, 10000);</span>
<a href="#l20.307"></a><span id="l20.307" class="difflineminus">-    // check Wednesday and Friday too</span>
<a href="#l20.308"></a><span id="l20.308" class="difflineplus">+    // Check Wednesday and Friday too.</span>
<a href="#l20.309"></a><span id="l20.309">     recurrence.click(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${wed}&quot;}`));</span>
<a href="#l20.310"></a><span id="l20.310">     recurrence.assertChecked(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${wed}&quot;}`));</span>
<a href="#l20.311"></a><span id="l20.311">     recurrence.click(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${fri}&quot;}`));</span>
<a href="#l20.312"></a><span id="l20.312">     recurrence.assertChecked(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${fri}&quot;}`));</span>
<a href="#l20.313"></a><span id="l20.313"> </span>
<a href="#l20.314"></a><span id="l20.314" class="difflineminus">-    // close dialog</span>
<a href="#l20.315"></a><span id="l20.315" class="difflineplus">+    // Close dialog.</span>
<a href="#l20.316"></a><span id="l20.316">     recurrence.click(reclookup(REC_DLG_ACCEPT));</span>
<a href="#l20.317"></a><span id="l20.317"> }</span>
<a href="#l20.318"></a><span id="l20.318"> </span>
<a href="#l20.319"></a><span id="l20.319"> function changeRecurrence(recurrence) {</span>
<a href="#l20.320"></a><span id="l20.320">     let { lookup: reclookup, eid: recid } = helpersForController(recurrence);</span>
<a href="#l20.321"></a><span id="l20.321"> </span>
<a href="#l20.322"></a><span id="l20.322">     // weekly</span>
<a href="#l20.323"></a><span id="l20.323">     menulistSelect(recid(&quot;period-list&quot;), &quot;1&quot;, recurrence);</span>
<a href="#l20.324"></a><span id="l20.324"> </span>
<a href="#l20.325"></a><span id="l20.325">     let mon = cal.l10n.getDateFmtString(&quot;day.2.Mmm&quot;);</span>
<a href="#l20.326"></a><span id="l20.326">     let tue = cal.l10n.getDateFmtString(&quot;day.3.Mmm&quot;);</span>
<a href="#l20.327"></a><span id="l20.327">     let wed = cal.l10n.getDateFmtString(&quot;day.4.Mmm&quot;);</span>
<a href="#l20.328"></a><span id="l20.328">     let fri = cal.l10n.getDateFmtString(&quot;day.6.Mmm&quot;);</span>
<a href="#l20.329"></a><span id="l20.329"> </span>
<a href="#l20.330"></a><span id="l20.330" class="difflineminus">-    // check old rule</span>
<a href="#l20.331"></a><span id="l20.331" class="difflineminus">-    // starting from Monday so it should be checked. We have to wait a little,</span>
<a href="#l20.332"></a><span id="l20.332" class="difflineplus">+    // Check old rule.</span>
<a href="#l20.333"></a><span id="l20.333" class="difflineplus">+    // Starting from Monday so it should be checked. We have to wait a little,</span>
<a href="#l20.334"></a><span id="l20.334">     // because the checkedstate is set in background by JS.</span>
<a href="#l20.335"></a><span id="l20.335">     recurrence.waitFor(() =&gt; {</span>
<a href="#l20.336"></a><span id="l20.336">         return recurrence.assertChecked(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${mon}&quot;}`));</span>
<a href="#l20.337"></a><span id="l20.337">     }, 10000);</span>
<a href="#l20.338"></a><span id="l20.338">     recurrence.assertChecked(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${wed}&quot;}`));</span>
<a href="#l20.339"></a><span id="l20.339">     recurrence.assertChecked(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${fri}&quot;}`));</span>
<a href="#l20.340"></a><span id="l20.340"> </span>
<a href="#l20.341"></a><span id="l20.341" class="difflineminus">-    // check Tuesday</span>
<a href="#l20.342"></a><span id="l20.342" class="difflineplus">+    // Check Tuesday.</span>
<a href="#l20.343"></a><span id="l20.343">     recurrence.click(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${tue}&quot;}`));</span>
<a href="#l20.344"></a><span id="l20.344">     recurrence.assertChecked(reclookup(`${REC_DLG_DAYS}/{&quot;label&quot;:&quot;${tue}&quot;}`));</span>
<a href="#l20.345"></a><span id="l20.345"> </span>
<a href="#l20.346"></a><span id="l20.346" class="difflineminus">-    // close dialog</span>
<a href="#l20.347"></a><span id="l20.347" class="difflineplus">+    // Close dialog.</span>
<a href="#l20.348"></a><span id="l20.348">     recurrence.click(reclookup(REC_DLG_ACCEPT));</span>
<a href="#l20.349"></a><span id="l20.349"> }</span>
<a href="#l20.350"></a><span id="l20.350"> </span>
<a href="#l20.351"></a><span id="l20.351"> function checkMultiWeekView(view) {</span>
<a href="#l20.352"></a><span id="l20.352">     let startWeek = view == &quot;multiweek&quot; ? 1 : 2;</span>
<a href="#l20.353"></a><span id="l20.353">     let assertNodeLookup = (...args) =&gt; {</span>
<a href="#l20.354"></a><span id="l20.354">         return controller.assertNode(lookupEventBox(...args));</span>
<a href="#l20.355"></a><span id="l20.355">     };</span>
<a href="#l20.356"></a><span id="l20.356">     let assertNodeNotExistLookup = (...args) =&gt; {</span>
<a href="#l20.357"></a><span id="l20.357">         return controller.assertNodeNotExist(lookupEventBox(...args));</span>
<a href="#l20.358"></a><span id="l20.358">     };</span>
<a href="#l20.359"></a><span id="l20.359"> </span>
<a href="#l20.360"></a><span id="l20.360" class="difflineminus">-    // wait for the first items, then check the ones not to be present</span>
<a href="#l20.361"></a><span id="l20.361" class="difflineminus">-    // assert exactly two</span>
<a href="#l20.362"></a><span id="l20.362" class="difflineminus">-    controller.waitForElement(</span>
<a href="#l20.363"></a><span id="l20.363" class="difflineminus">-        lookupEventBox(view, EVENT_BOX, startWeek, 3, HOUR, &quot;/[0]&quot;)</span>
<a href="#l20.364"></a><span id="l20.364" class="difflineminus">-    );</span>
<a href="#l20.365"></a><span id="l20.365" class="difflineminus">-    assertNodeLookup(view, EVENT_BOX, startWeek, 3, HOUR, &quot;/[1]&quot;);</span>
<a href="#l20.366"></a><span id="l20.366" class="difflineminus">-    assertNodeNotExistLookup(view, EVENT_BOX, startWeek, 3, HOUR, &quot;/[2]&quot;);</span>
<a href="#l20.367"></a><span id="l20.367" class="difflineplus">+    // Wait for the first items, then check the ones not to be present.</span>
<a href="#l20.368"></a><span id="l20.368" class="difflineplus">+    // Assert exactly two.</span>
<a href="#l20.369"></a><span id="l20.369" class="difflineplus">+    controller.waitForElement(lookupEventBox(view, EVENT_BOX, startWeek, 3, null, &quot;/[0]&quot;));</span>
<a href="#l20.370"></a><span id="l20.370" class="difflineplus">+    assertNodeLookup(view, EVENT_BOX, startWeek, 3, null, &quot;/[1]&quot;);</span>
<a href="#l20.371"></a><span id="l20.371" class="difflineplus">+    assertNodeNotExistLookup(view, EVENT_BOX, startWeek, 3, null, &quot;/[2]&quot;);</span>
<a href="#l20.372"></a><span id="l20.372">     // Then check no item on the 5th.</span>
<a href="#l20.373"></a><span id="l20.373" class="difflineminus">-    assertNodeNotExistLookup(view, EVENT_BOX, startWeek, 2, HOUR, EVENTPATH);</span>
<a href="#l20.374"></a><span id="l20.374" class="difflineminus">-    assertNodeNotExistLookup(view, EVENT_BOX, startWeek, 3, HOUR, &quot;/[2]&quot;);</span>
<a href="#l20.375"></a><span id="l20.375" class="difflineminus">-    assertNodeLookup(view, EVENT_BOX, startWeek, 4, HOUR, EVENTPATH);</span>
<a href="#l20.376"></a><span id="l20.376" class="difflineminus">-    assertNodeNotExistLookup(view, EVENT_BOX, startWeek, 5, HOUR, EVENTPATH);</span>
<a href="#l20.377"></a><span id="l20.377" class="difflineminus">-    assertNodeLookup(view, EVENT_BOX, startWeek, 6, HOUR, EVENTPATH);</span>
<a href="#l20.378"></a><span id="l20.378" class="difflineminus">-    assertNodeNotExistLookup(view, EVENT_BOX, startWeek, 7, HOUR, EVENTPATH);</span>
<a href="#l20.379"></a><span id="l20.379" class="difflineplus">+    assertNodeNotExistLookup(view, EVENT_BOX, startWeek, 2, null, EVENTPATH);</span>
<a href="#l20.380"></a><span id="l20.380" class="difflineplus">+    assertNodeNotExistLookup(view, EVENT_BOX, startWeek, 3, null, &quot;/[2]&quot;);</span>
<a href="#l20.381"></a><span id="l20.381" class="difflineplus">+    assertNodeLookup(view, EVENT_BOX, startWeek, 4, null, EVENTPATH);</span>
<a href="#l20.382"></a><span id="l20.382" class="difflineplus">+    assertNodeNotExistLookup(view, EVENT_BOX, startWeek, 5, null, EVENTPATH);</span>
<a href="#l20.383"></a><span id="l20.383" class="difflineplus">+    assertNodeLookup(view, EVENT_BOX, startWeek, 6, null, EVENTPATH);</span>
<a href="#l20.384"></a><span id="l20.384" class="difflineplus">+    assertNodeNotExistLookup(view, EVENT_BOX, startWeek, 7, null, EVENTPATH);</span>
<a href="#l20.385"></a><span id="l20.385"> </span>
<a href="#l20.386"></a><span id="l20.386" class="difflineminus">-    assertNodeNotExistLookup(view, EVENT_BOX, startWeek + 1, 1, HOUR, EVENTPATH);</span>
<a href="#l20.387"></a><span id="l20.387" class="difflineminus">-    assertNodeLookup(view, EVENT_BOX, startWeek + 1, 2, HOUR, EVENTPATH);</span>
<a href="#l20.388"></a><span id="l20.388" class="difflineminus">-    assertNodeLookup(view, EVENT_BOX, startWeek + 1, 3, HOUR, EVENTPATH);</span>
<a href="#l20.389"></a><span id="l20.389" class="difflineminus">-    assertNodeLookup(view, EVENT_BOX, startWeek + 1, 4, HOUR, EVENTPATH);</span>
<a href="#l20.390"></a><span id="l20.390" class="difflineminus">-    assertNodeNotExistLookup(view, EVENT_BOX, startWeek + 1, 5, HOUR, EVENTPATH);</span>
<a href="#l20.391"></a><span id="l20.391" class="difflineminus">-    assertNodeLookup(view, EVENT_BOX, startWeek + 1, 6, HOUR, EVENTPATH);</span>
<a href="#l20.392"></a><span id="l20.392" class="difflineminus">-    assertNodeNotExistLookup(view, EVENT_BOX, startWeek + 1, 7, HOUR, EVENTPATH);</span>
<a href="#l20.393"></a><span id="l20.393" class="difflineplus">+    assertNodeNotExistLookup(view, EVENT_BOX, startWeek + 1, 1, null, EVENTPATH);</span>
<a href="#l20.394"></a><span id="l20.394" class="difflineplus">+    assertNodeLookup(view, EVENT_BOX, startWeek + 1, 2, null, EVENTPATH);</span>
<a href="#l20.395"></a><span id="l20.395" class="difflineplus">+    assertNodeLookup(view, EVENT_BOX, startWeek + 1, 3, null, EVENTPATH);</span>
<a href="#l20.396"></a><span id="l20.396" class="difflineplus">+    assertNodeLookup(view, EVENT_BOX, startWeek + 1, 4, null, EVENTPATH);</span>
<a href="#l20.397"></a><span id="l20.397" class="difflineplus">+    assertNodeNotExistLookup(view, EVENT_BOX, startWeek + 1, 5, null, EVENTPATH);</span>
<a href="#l20.398"></a><span id="l20.398" class="difflineplus">+    assertNodeLookup(view, EVENT_BOX, startWeek + 1, 6, null, EVENTPATH);</span>
<a href="#l20.399"></a><span id="l20.399" class="difflineplus">+    assertNodeNotExistLookup(view, EVENT_BOX, startWeek + 1, 7, null, EVENTPATH);</span>
<a href="#l20.400"></a><span id="l20.400"> }</span>
<a href="#l20.401"></a><span id="l20.401"> </span>
<a href="#l20.402"></a><span id="l20.402"> function teardownTest(module) {</span>
<a href="#l20.403"></a><span id="l20.403">     deleteCalendars(controller, CALENDARNAME);</span>
<a href="#l20.404"></a><span id="l20.404" class="difflineplus">+</span>
<a href="#l20.405"></a><span id="l20.405" class="difflineplus">+    // Reset view.</span>
<a href="#l20.406"></a><span id="l20.406" class="difflineplus">+    if (eid(&quot;day-view&quot;).getNode().orient == &quot;horizontal&quot;) {</span>
<a href="#l20.407"></a><span id="l20.407" class="difflineplus">+        controller.mainMenu.click(&quot;#ltnViewRotated&quot;);</span>
<a href="#l20.408"></a><span id="l20.408" class="difflineplus">+    }</span>
<a href="#l20.409"></a><span id="l20.409" class="difflineplus">+    controller.waitFor(() =&gt; eid(&quot;day-view&quot;).getNode().orient == &quot;vertical&quot;);</span>
<a href="#l20.410"></a><span id="l20.410"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/calendar/test/mozmill/shared-modules/test-calendar-utils.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/calendar/test/mozmill/shared-modules/test-calendar-utils.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -2,100 +2,149 @@</span>
<a href="#l21.4"></a><span id="l21.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l21.5"></a><span id="l21.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l21.6"></a><span id="l21.6"> </span>
<a href="#l21.7"></a><span id="l21.7"> var MODULE_NAME = &quot;calendar-utils&quot;;</span>
<a href="#l21.8"></a><span id="l21.8"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l21.9"></a><span id="l21.9"> var MODULE_REQUIRES = [&quot;window-helpers&quot;, &quot;folder-display-helpers&quot;, &quot;pref-window-helpers&quot;];</span>
<a href="#l21.10"></a><span id="l21.10"> </span>
<a href="#l21.11"></a><span id="l21.11"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;, null);</span>
<a href="#l21.13"></a><span id="l21.13"> var os = {};</span>
<a href="#l21.14"></a><span id="l21.14"> ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;, os);</span>
<a href="#l21.15"></a><span id="l21.15"> var frame = {};</span>
<a href="#l21.16"></a><span id="l21.16"> ChromeUtils.import(&quot;chrome://mozmill/content/modules/frame.js&quot;, frame);</span>
<a href="#l21.17"></a><span id="l21.17"> var utils = {};</span>
<a href="#l21.18"></a><span id="l21.18"> ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.js&quot;, utils);</span>
<a href="#l21.19"></a><span id="l21.19"> </span>
<a href="#l21.20"></a><span id="l21.20"> var SHORT_SLEEP = 100;</span>
<a href="#l21.21"></a><span id="l21.21"> var MID_SLEEP = 500;</span>
<a href="#l21.22"></a><span id="l21.22"> var TIMEOUT_MODAL_DIALOG = 30000;</span>
<a href="#l21.23"></a><span id="l21.23"> var TIMEOUT_MONTHCHANGE = 10000;</span>
<a href="#l21.24"></a><span id="l21.24"> var CALENDARNAME = &quot;Mozmill&quot;;</span>
<a href="#l21.25"></a><span id="l21.25"> </span>
<a href="#l21.26"></a><span id="l21.26" class="difflineminus">-// these are used in EventBox lookup.</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineminus">-var EVENT_BOX = 0; // Use when you need an event box</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineminus">-var CANVAS_BOX = 1; // Use when you need a calendar canvas box</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineminus">-var ALLDAY = 2; // Use when you need an allday canvas or event box</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineplus">+// These are used in EventBox lookup.</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineplus">+var EVENT_BOX = 0; // Use when you need an event box.</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+var CANVAS_BOX = 1; // Use when you need a calendar canvas box.</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineplus">+var ALLDAY = 2; // Use when you need an allday canvas or event box.</span>
<a href="#l21.34"></a><span id="l21.34"> </span>
<a href="#l21.35"></a><span id="l21.35" class="difflineminus">-// Lookup paths and path-snippets</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineminus">-var EVENTPATH = `/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;${CALENDARNAME.toLowerCase()}&quot;}`;</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineminus">-var REC_DLG_ACCEPT = `</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineminus">-        /id(&quot;calendar-event-dialog-recurrence&quot;)</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineminus">-        /anon({&quot;anonid&quot;:&quot;buttons&quot;})/{&quot;dlgtype&quot;:&quot;accept&quot;}</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineplus">+// Lookup paths and path-snippets.</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineplus">+var CALENDAR_PANEL = `</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineplus">+    /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;tabmail&quot;)/id(&quot;tabmail-tabbox&quot;)/</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineplus">+    id(&quot;tabpanelcontainer&quot;)/id(&quot;calendarTabPanel&quot;)/id(&quot;calendarContent&quot;)</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineplus">+`;</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineplus">+var VIEWDECK = `</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineplus">+    ${CALENDAR_PANEL}/id(&quot;calendarDisplayDeck&quot;)/id(&quot;calendar-view-box&quot;)/</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineplus">+    id(&quot;view-deck&quot;)</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineplus">+`;</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineplus">+var DAY_VIEW = `${VIEWDECK}/id(&quot;day-view&quot;)`;</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineplus">+var WEEK_VIEW = `${VIEWDECK}/id(&quot;week-view&quot;)`;</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineplus">+// Multiday-view-day-box of day and week view.</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineplus">+var DAYBOX = `</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineplus">+    anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;scrollbox&quot;})/anon({&quot;anonid&quot;:&quot;daybox&quot;})</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineplus">+`;</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineplus">+// Multiday-view-label-day-box of day and week view.</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineplus">+var LABELDAYBOX = `</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineplus">+    anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;labelbox&quot;})/anon({&quot;anonid&quot;:&quot;labeldaybox&quot;})</span>
<a href="#l21.58"></a><span id="l21.58"> `;</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineminus">-var REC_DLG_DAYS = `</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineminus">-        /id(&quot;calendar-event-dialog-recurrence&quot;)</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineminus">-        /id(&quot;recurrence-pattern-groupbox&quot;)/id(&quot;recurrence-pattern-grid&quot;)</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineminus">-        /id(&quot;recurrence-pattern-rows&quot;)/id(&quot;recurrence-pattern-period-row&quot;)</span>
<a href="#l21.63"></a><span id="l21.63" class="difflineminus">-        /id(&quot;period-deck&quot;)/id(&quot;period-deck-weekly-box&quot;)/[1]/id(&quot;daypicker-weekday&quot;)</span>
<a href="#l21.64"></a><span id="l21.64" class="difflineminus">-        /anon({&quot;anonid&quot;:&quot;mainbox&quot;})</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineplus">+var MULTIWEEK_VIEW = `${VIEWDECK}/id(&quot;multiweek-view&quot;)`;</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineplus">+var MONTH_VIEW = `${VIEWDECK}/id(&quot;month-view&quot;)`;</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineplus">+var TASK_VIEW = `${CALENDAR_PANEL}/id(&quot;calendarDisplayDeck&quot;)/id(&quot;calendar-task-box&quot;)/`;</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineplus">+</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineplus">+var MINIMONTH = `</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineplus">+    ${CALENDAR_PANEL}/id(&quot;ltnSidebar&quot;)/id(&quot;minimonth-pane&quot;)/{&quot;align&quot;:&quot;center&quot;}/</span>
<a href="#l21.71"></a><span id="l21.71" class="difflineplus">+    id(&quot;calMinimonthBox&quot;)/id(&quot;calMinimonth&quot;)</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineplus">+`;</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineplus">+var TODAY_BUTTON = `</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineplus">+    ${MINIMONTH}/anon({&quot;anonid&quot;:&quot;minimonth-header&quot;})/anon({&quot;anonid&quot;:&quot;today-button&quot;})</span>
<a href="#l21.75"></a><span id="l21.75"> `;</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineminus">-var REC_DLG_UNTIL_INPUT = `</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineminus">-        /id(&quot;calendar-event-dialog-recurrence&quot;)/id(&quot;recurrence-range-groupbox&quot;)/[1]/</span>
<a href="#l21.78"></a><span id="l21.78" class="difflineminus">-        id(&quot;recurrence-duration&quot;)/id(&quot;recurrence-range-until-box&quot;)/</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineminus">-        id(&quot;repeat-until-date&quot;)/anon({&quot;class&quot;:&quot;datepicker-box-class&quot;})/</span>
<a href="#l21.80"></a><span id="l21.80" class="difflineminus">-        {&quot;class&quot;:&quot;datepicker-text-class&quot;}/</span>
<a href="#l21.81"></a><span id="l21.81" class="difflineminus">-        anon({&quot;class&quot;:&quot;menulist-editable-box textbox-input-box&quot;})/</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;input&quot;})</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineplus">+var CALENDARLIST = `</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineplus">+    ${CALENDAR_PANEL}/id(&quot;ltnSidebar&quot;)/id(&quot;calendar-panel&quot;)/id(&quot;calendar-list-pane&quot;)/</span>
<a href="#l21.85"></a><span id="l21.85" class="difflineplus">+    id(&quot;calendar-listtree-pane&quot;)/id(&quot;calendar-list-tree-widget&quot;)/</span>
<a href="#l21.86"></a><span id="l21.86" class="difflineplus">+    anon({&quot;anonid&quot;:&quot;tree&quot;})/anon({&quot;anonid&quot;:&quot;treechildren&quot;})</span>
<a href="#l21.87"></a><span id="l21.87" class="difflineplus">+`;</span>
<a href="#l21.88"></a><span id="l21.88" class="difflineplus">+var TODAY_PANE = `</span>
<a href="#l21.89"></a><span id="l21.89" class="difflineplus">+    /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;today-pane-panel&quot;)</span>
<a href="#l21.90"></a><span id="l21.90" class="difflineplus">+`;</span>
<a href="#l21.91"></a><span id="l21.91" class="difflineplus">+var AGENDA_LISTBOX = `</span>
<a href="#l21.92"></a><span id="l21.92" class="difflineplus">+    ${TODAY_PANE}/{&quot;flex&quot;:&quot;1&quot;}/id(&quot;agenda-panel&quot;)/{&quot;flex&quot;:&quot;1&quot;}/id(&quot;agenda-listbox&quot;)</span>
<a href="#l21.93"></a><span id="l21.93" class="difflineplus">+`;</span>
<a href="#l21.94"></a><span id="l21.94" class="difflineplus">+</span>
<a href="#l21.95"></a><span id="l21.95" class="difflineplus">+var EVENTPATH = `</span>
<a href="#l21.96"></a><span id="l21.96" class="difflineplus">+    /{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;${CALENDARNAME.toLowerCase()}&quot;}</span>
<a href="#l21.97"></a><span id="l21.97" class="difflineplus">+`;</span>
<a href="#l21.98"></a><span id="l21.98" class="difflineplus">+// Used after &quot;${EVENTPATH}/${getEventDetials([view])}/&quot;.</span>
<a href="#l21.99"></a><span id="l21.99" class="difflineplus">+var ALARM_ICON_PATH = `</span>
<a href="#l21.100"></a><span id="l21.100" class="difflineplus">+    anon({&quot;anonid&quot;:&quot;category-box-stack&quot;})/anon({&quot;align&quot;:&quot;center&quot;})/</span>
<a href="#l21.101"></a><span id="l21.101" class="difflineplus">+    anon({&quot;anonid&quot;:&quot;alarm-icons-box&quot;})/anon({&quot;class&quot;:&quot;reminder-icon&quot;})</span>
<a href="#l21.102"></a><span id="l21.102"> `;</span>
<a href="#l21.103"></a><span id="l21.103"> </span>
<a href="#l21.104"></a><span id="l21.104"> var plan_for_modal_dialog, wait_for_modal_dialog, open_pref_tab;</span>
<a href="#l21.105"></a><span id="l21.105"> </span>
<a href="#l21.106"></a><span id="l21.106" class="difflineminus">-function setupModule() {</span>
<a href="#l21.107"></a><span id="l21.107" class="difflineplus">+function setupModule(controller) {</span>
<a href="#l21.108"></a><span id="l21.108">     ({ plan_for_modal_dialog, wait_for_modal_dialog } =</span>
<a href="#l21.109"></a><span id="l21.109">         collector.getModule(&quot;window-helpers&quot;));</span>
<a href="#l21.110"></a><span id="l21.110"> </span>
<a href="#l21.111"></a><span id="l21.111" class="difflineminus">-    // this setup is needed for pref-win-helpers. For some reason, the automatic</span>
<a href="#l21.112"></a><span id="l21.112" class="difflineplus">+    // This setup is needed for pref-win-helpers. For some reason, the automatic</span>
<a href="#l21.113"></a><span id="l21.113">     // loading of modules in shared modules does not setup the module correctly.</span>
<a href="#l21.114"></a><span id="l21.114">     collector.getModule(&quot;folder-display-helpers&quot;).setupModule();</span>
<a href="#l21.115"></a><span id="l21.115"> </span>
<a href="#l21.116"></a><span id="l21.116">     ({ open_pref_tab } = collector.getModule(&quot;pref-window-helpers&quot;));</span>
<a href="#l21.117"></a><span id="l21.117">     collector.getModule(&quot;pref-window-helpers&quot;).setupModule();</span>
<a href="#l21.118"></a><span id="l21.118" class="difflineplus">+</span>
<a href="#l21.119"></a><span id="l21.119" class="difflineplus">+    // For our tests, we assume that Sunday is start of week.</span>
<a href="#l21.120"></a><span id="l21.120" class="difflineplus">+    Services.prefs.setIntPref(&quot;calendar.week.start&quot;, 0);</span>
<a href="#l21.121"></a><span id="l21.121" class="difflineplus">+</span>
<a href="#l21.122"></a><span id="l21.122" class="difflineplus">+    // We are in calendarTests, so we make sure, calendar-tab with day-view is displayed.</span>
<a href="#l21.123"></a><span id="l21.123" class="difflineplus">+    let { eid } = helpersForController(controller);</span>
<a href="#l21.124"></a><span id="l21.124" class="difflineplus">+    controller.click(eid(&quot;calendar-tab-button&quot;));</span>
<a href="#l21.125"></a><span id="l21.125" class="difflineplus">+    switchToView(controller, &quot;day&quot;);</span>
<a href="#l21.126"></a><span id="l21.126"> }</span>
<a href="#l21.127"></a><span id="l21.127"> </span>
<a href="#l21.128"></a><span id="l21.128"> function installInto(module) {</span>
<a href="#l21.129"></a><span id="l21.129" class="difflineminus">-    // copy constants into module</span>
<a href="#l21.130"></a><span id="l21.130" class="difflineplus">+    // Copy constants into module.</span>
<a href="#l21.131"></a><span id="l21.131">     module.SHORT_SLEEP = SHORT_SLEEP;</span>
<a href="#l21.132"></a><span id="l21.132">     module.MID_SLEEP = MID_SLEEP;</span>
<a href="#l21.133"></a><span id="l21.133">     module.TIMEOUT_MODAL_DIALOG = TIMEOUT_MODAL_DIALOG;</span>
<a href="#l21.134"></a><span id="l21.134">     module.CALENDARNAME = CALENDARNAME;</span>
<a href="#l21.135"></a><span id="l21.135" class="difflineplus">+    module.CALENDAR_PANEL = CALENDAR_PANEL;</span>
<a href="#l21.136"></a><span id="l21.136" class="difflineplus">+    module.VIEWDECK = VIEWDECK;</span>
<a href="#l21.137"></a><span id="l21.137" class="difflineplus">+    module.DAY_VIEW = DAY_VIEW;</span>
<a href="#l21.138"></a><span id="l21.138" class="difflineplus">+    module.WEEK_VIEW = WEEK_VIEW;</span>
<a href="#l21.139"></a><span id="l21.139" class="difflineplus">+    module.DAYBOX = DAYBOX;</span>
<a href="#l21.140"></a><span id="l21.140" class="difflineplus">+    module.LABELDAYBOX = LABELDAYBOX;</span>
<a href="#l21.141"></a><span id="l21.141" class="difflineplus">+    module.MULTIWEEK_VIEW = MULTIWEEK_VIEW;</span>
<a href="#l21.142"></a><span id="l21.142" class="difflineplus">+    module.MONTH_VIEW = MONTH_VIEW;</span>
<a href="#l21.143"></a><span id="l21.143" class="difflineplus">+    module.TASK_VIEW = TASK_VIEW;</span>
<a href="#l21.144"></a><span id="l21.144" class="difflineplus">+    module.MINIMONTH = MINIMONTH;</span>
<a href="#l21.145"></a><span id="l21.145" class="difflineplus">+    module.TODAY_BUTTON = TODAY_BUTTON;</span>
<a href="#l21.146"></a><span id="l21.146" class="difflineplus">+    module.CALENDARLIST = CALENDARLIST;</span>
<a href="#l21.147"></a><span id="l21.147" class="difflineplus">+    module.TODAY_PANE = TODAY_PANE;</span>
<a href="#l21.148"></a><span id="l21.148" class="difflineplus">+    module.AGENDA_LISTBOX = AGENDA_LISTBOX;</span>
<a href="#l21.149"></a><span id="l21.149">     module.EVENTPATH = EVENTPATH;</span>
<a href="#l21.150"></a><span id="l21.150" class="difflineplus">+    module.ALARM_ICON_PATH = ALARM_ICON_PATH;</span>
<a href="#l21.151"></a><span id="l21.151">     module.EVENT_BOX = EVENT_BOX;</span>
<a href="#l21.152"></a><span id="l21.152">     module.CANVAS_BOX = CANVAS_BOX;</span>
<a href="#l21.153"></a><span id="l21.153">     module.ALLDAY = ALLDAY;</span>
<a href="#l21.154"></a><span id="l21.154" class="difflineminus">-    module.REC_DLG_ACCEPT = REC_DLG_ACCEPT;</span>
<a href="#l21.155"></a><span id="l21.155" class="difflineminus">-    module.REC_DLG_DAYS = REC_DLG_DAYS;</span>
<a href="#l21.156"></a><span id="l21.156" class="difflineminus">-    module.REC_DLG_UNTIL_INPUT = REC_DLG_UNTIL_INPUT;</span>
<a href="#l21.157"></a><span id="l21.157" class="difflineminus">-    // Now copy helper functions</span>
<a href="#l21.158"></a><span id="l21.158" class="difflineplus">+</span>
<a href="#l21.159"></a><span id="l21.159" class="difflineplus">+    // Now copy helper functions.</span>
<a href="#l21.160"></a><span id="l21.160">     module.helpersForController = helpersForController;</span>
<a href="#l21.161"></a><span id="l21.161" class="difflineminus">-    module.acceptSendingNotificationMail = acceptSendingNotificationMail;</span>
<a href="#l21.162"></a><span id="l21.162" class="difflineminus">-    module.handleAddingAttachment = handleAddingAttachment;</span>
<a href="#l21.163"></a><span id="l21.163" class="difflineplus">+    module.setupLightning = setupLightning;</span>
<a href="#l21.164"></a><span id="l21.164">     module.handleOccurrencePrompt = handleOccurrencePrompt;</span>
<a href="#l21.165"></a><span id="l21.165">     module.switchToView = switchToView;</span>
<a href="#l21.166"></a><span id="l21.166">     module.goToDate = goToDate;</span>
<a href="#l21.167"></a><span id="l21.167">     module.invokeEventDialog = invokeEventDialog;</span>
<a href="#l21.168"></a><span id="l21.168">     module.getEventBoxPath = getEventBoxPath;</span>
<a href="#l21.169"></a><span id="l21.169" class="difflineplus">+    module.getEventDetails = getEventDetails;</span>
<a href="#l21.170"></a><span id="l21.170" class="difflineplus">+    module.checkAlarmIcon = checkAlarmIcon;</span>
<a href="#l21.171"></a><span id="l21.171">     module.viewForward = viewForward;</span>
<a href="#l21.172"></a><span id="l21.172">     module.viewBack = viewBack;</span>
<a href="#l21.173"></a><span id="l21.173">     module.deleteCalendars = deleteCalendars;</span>
<a href="#l21.174"></a><span id="l21.174">     module.createCalendar = createCalendar;</span>
<a href="#l21.175"></a><span id="l21.175">     module.handleNewCalendarWizard = handleNewCalendarWizard;</span>
<a href="#l21.176"></a><span id="l21.176">     module.findEventsInNode = findEventsInNode;</span>
<a href="#l21.177"></a><span id="l21.177" class="difflineminus">-    module.setData = setData;</span>
<a href="#l21.178"></a><span id="l21.178">     module.openLightningPrefs = openLightningPrefs;</span>
<a href="#l21.179"></a><span id="l21.179">     module.menulistSelect = menulistSelect;</span>
<a href="#l21.180"></a><span id="l21.180"> }</span>
<a href="#l21.181"></a><span id="l21.181"> </span>
<a href="#l21.182"></a><span id="l21.182"> function helpersForController(controller) {</span>
<a href="#l21.183"></a><span id="l21.183">     function selector(sel) {</span>
<a href="#l21.184"></a><span id="l21.184">         return sel.trim().replace(/\n(\s*)/g, &quot;&quot;);</span>
<a href="#l21.185"></a><span id="l21.185">     }</span>
<a href="#l21.186"></a><span id="l21.186" class="difflineat">@@ -104,157 +153,115 @@ function helpersForController(controller</span>
<a href="#l21.187"></a><span id="l21.187">         lookup: (sel) =&gt; new elementslib.Lookup(controller.window.document, selector(sel)),</span>
<a href="#l21.188"></a><span id="l21.188">         eid: (id) =&gt; new elementslib.ID(controller.window.document, id),</span>
<a href="#l21.189"></a><span id="l21.189">         xpath: (path) =&gt; new elementslib.XPath(controller.window.document, selector(path)),</span>
<a href="#l21.190"></a><span id="l21.190">         sleep: (timeout = MID_SLEEP) =&gt; controller.sleep(timeout),</span>
<a href="#l21.191"></a><span id="l21.191">         getEventBoxPath: (...args) =&gt; getEventBoxPath(controller, ...args),</span>
<a href="#l21.192"></a><span id="l21.192">         lookupEventBox: (view, option, row, column, hour, extra = &quot;/&quot;) =&gt; {</span>
<a href="#l21.193"></a><span id="l21.193">             let path = getEventBoxPath(controller, view, option, row, column, hour);</span>
<a href="#l21.194"></a><span id="l21.194">             return new elementslib.Lookup(controller.window.document, selector(path + extra));</span>
<a href="#l21.195"></a><span id="l21.195" class="difflineplus">+        },</span>
<a href="#l21.196"></a><span id="l21.196" class="difflineplus">+        replaceText: (textbox, text) =&gt; {</span>
<a href="#l21.197"></a><span id="l21.197" class="difflineplus">+            controller.keypress(textbox, &quot;a&quot;, { accelKey: true });</span>
<a href="#l21.198"></a><span id="l21.198" class="difflineplus">+            controller.type(textbox, text);</span>
<a href="#l21.199"></a><span id="l21.199">         }</span>
<a href="#l21.200"></a><span id="l21.200">     };</span>
<a href="#l21.201"></a><span id="l21.201"> }</span>
<a href="#l21.202"></a><span id="l21.202"> </span>
<a href="#l21.203"></a><span id="l21.203"> /**</span>
<a href="#l21.204"></a><span id="l21.204" class="difflineminus">- * make sure, the current view has finished loading</span>
<a href="#l21.205"></a><span id="l21.205" class="difflineplus">+ * Make sure, the current view has finished loading.</span>
<a href="#l21.206"></a><span id="l21.206">  *</span>
<a href="#l21.207"></a><span id="l21.207">  * @param controller        Mozmill window controller</span>
<a href="#l21.208"></a><span id="l21.208">  */</span>
<a href="#l21.209"></a><span id="l21.209"> function ensureViewLoaded(controller) {</span>
<a href="#l21.210"></a><span id="l21.210">     let { sleep } = helpersForController(controller);</span>
<a href="#l21.211"></a><span id="l21.211">     controller.waitFor(() =&gt;</span>
<a href="#l21.212"></a><span id="l21.212">         controller.window.getViewDeck().selectedPanel.mPendingRefreshJobs.size == 0</span>
<a href="#l21.213"></a><span id="l21.213">     );</span>
<a href="#l21.214"></a><span id="l21.214">     // after the queue is empty the view needs a moment to settle.</span>
<a href="#l21.215"></a><span id="l21.215">     sleep(200);</span>
<a href="#l21.216"></a><span id="l21.216"> }</span>
<a href="#l21.217"></a><span id="l21.217"> </span>
<a href="#l21.218"></a><span id="l21.218"> /**</span>
<a href="#l21.219"></a><span id="l21.219" class="difflineminus">- * Accept to send notification email with event to attendees</span>
<a href="#l21.220"></a><span id="l21.220" class="difflineminus">- *</span>
<a href="#l21.221"></a><span id="l21.221" class="difflineminus">- * @param controller        Mozmill window controller</span>
<a href="#l21.222"></a><span id="l21.222" class="difflineminus">- */</span>
<a href="#l21.223"></a><span id="l21.223" class="difflineminus">-function acceptSendingNotificationMail(controller) {</span>
<a href="#l21.224"></a><span id="l21.224" class="difflineminus">-    plan_for_modal_dialog(&quot;commonDialog&quot;, (dialog) =&gt; {</span>
<a href="#l21.225"></a><span id="l21.225" class="difflineminus">-        let { lookup: cdlglookup } = helpersForController(dialog);</span>
<a href="#l21.226"></a><span id="l21.226" class="difflineminus">-        dialog.waitThenClick(cdlglookup(`</span>
<a href="#l21.227"></a><span id="l21.227" class="difflineminus">-            /id(&quot;commonDialog&quot;)/anon({&quot;anonid&quot;:&quot;buttons&quot;})/{&quot;dlgtype&quot;:&quot;accept&quot;}</span>
<a href="#l21.228"></a><span id="l21.228" class="difflineminus">-        `));</span>
<a href="#l21.229"></a><span id="l21.229" class="difflineminus">-    });</span>
<a href="#l21.230"></a><span id="l21.230" class="difflineminus">-</span>
<a href="#l21.231"></a><span id="l21.231" class="difflineminus">-    wait_for_modal_dialog(&quot;commonDialog&quot;);</span>
<a href="#l21.232"></a><span id="l21.232" class="difflineminus">-}</span>
<a href="#l21.233"></a><span id="l21.233" class="difflineminus">-</span>
<a href="#l21.234"></a><span id="l21.234" class="difflineminus">-/**</span>
<a href="#l21.235"></a><span id="l21.235" class="difflineminus">- * Add an attachment with url</span>
<a href="#l21.236"></a><span id="l21.236" class="difflineminus">- *</span>
<a href="#l21.237"></a><span id="l21.237" class="difflineminus">- * @param controller        Mozmill window controller</span>
<a href="#l21.238"></a><span id="l21.238" class="difflineminus">- */</span>
<a href="#l21.239"></a><span id="l21.239" class="difflineminus">-function handleAddingAttachment(controller, url) {</span>
<a href="#l21.240"></a><span id="l21.240" class="difflineminus">-    plan_for_modal_dialog(&quot;commonDialog&quot;, (attachment) =&gt; {</span>
<a href="#l21.241"></a><span id="l21.241" class="difflineminus">-        let { lookup: cdlglookup, eid: cdlgid } = helpersForController(attachment);</span>
<a href="#l21.242"></a><span id="l21.242" class="difflineminus">-        attachment.waitForElement(cdlgid(&quot;loginTextbox&quot;));</span>
<a href="#l21.243"></a><span id="l21.243" class="difflineminus">-        cdlgid(&quot;loginTextbox&quot;).getNode().value = url;</span>
<a href="#l21.244"></a><span id="l21.244" class="difflineminus">-        attachment.click(cdlglookup(`</span>
<a href="#l21.245"></a><span id="l21.245" class="difflineminus">-            /id(&quot;commonDialog&quot;)/anon({&quot;anonid&quot;:&quot;buttons&quot;})/{&quot;dlgtype&quot;:&quot;accept&quot;}</span>
<a href="#l21.246"></a><span id="l21.246" class="difflineminus">-        `));</span>
<a href="#l21.247"></a><span id="l21.247" class="difflineminus">-    });</span>
<a href="#l21.248"></a><span id="l21.248" class="difflineminus">-}</span>
<a href="#l21.249"></a><span id="l21.249" class="difflineminus">-</span>
<a href="#l21.250"></a><span id="l21.250" class="difflineminus">-/**</span>
<a href="#l21.251"></a><span id="l21.251" class="difflineminus">- * open and click the appropriate button on the recurrence-Prompt Dialog</span>
<a href="#l21.252"></a><span id="l21.252" class="difflineplus">+ * Open and click the appropriate button on the recurrence-Prompt Dialog.</span>
<a href="#l21.253"></a><span id="l21.253">  *</span>
<a href="#l21.254"></a><span id="l21.254">  * @param controller      Mozmill window controller</span>
<a href="#l21.255"></a><span id="l21.255" class="difflineminus">- * @param element         Mozmill element which will open the dialog</span>
<a href="#l21.256"></a><span id="l21.256" class="difflineminus">- * @param mode            action to exec on element (delete OR modify)</span>
<a href="#l21.257"></a><span id="l21.257" class="difflineminus">- * @param selectParent    true if all occurrences should be deleted</span>
<a href="#l21.258"></a><span id="l21.258" class="difflineminus">- * @param attendees       Whether there are attendees that can be notified or not</span>
<a href="#l21.259"></a><span id="l21.259" class="difflineplus">+ * @param element         Mozmill element which will open the dialog.</span>
<a href="#l21.260"></a><span id="l21.260" class="difflineplus">+ * @param mode            Action to exec on element (delete OR modify).</span>
<a href="#l21.261"></a><span id="l21.261" class="difflineplus">+ * @param selectParent    true if all occurrences should be deleted.</span>
<a href="#l21.262"></a><span id="l21.262">  */</span>
<a href="#l21.263"></a><span id="l21.263" class="difflineminus">-function handleOccurrencePrompt(controller, element, mode, selectParent, attendees) {</span>
<a href="#l21.264"></a><span id="l21.264" class="difflineplus">+function handleOccurrencePrompt(controller, element, mode, selectParent) {</span>
<a href="#l21.265"></a><span id="l21.265">     controller.waitForElement(element);</span>
<a href="#l21.266"></a><span id="l21.266">     plan_for_modal_dialog(&quot;Calendar:OccurrencePrompt&quot;, (dialog) =&gt; {</span>
<a href="#l21.267"></a><span id="l21.267">         let { eid: dlgid } = helpersForController(dialog);</span>
<a href="#l21.268"></a><span id="l21.268" class="difflineminus">-        if (attendees) {</span>
<a href="#l21.269"></a><span id="l21.269" class="difflineminus">-            acceptSendingNotificationMail();</span>
<a href="#l21.270"></a><span id="l21.270" class="difflineminus">-        }</span>
<a href="#l21.271"></a><span id="l21.271">         if (selectParent) {</span>
<a href="#l21.272"></a><span id="l21.272">             dialog.waitThenClick(dlgid(&quot;accept-parent-button&quot;));</span>
<a href="#l21.273"></a><span id="l21.273">         } else {</span>
<a href="#l21.274"></a><span id="l21.274">             dialog.waitThenClick(dlgid(&quot;accept-occurrence-button&quot;));</span>
<a href="#l21.275"></a><span id="l21.275">         }</span>
<a href="#l21.276"></a><span id="l21.276">     });</span>
<a href="#l21.277"></a><span id="l21.277">     if (mode == &quot;delete&quot;) {</span>
<a href="#l21.278"></a><span id="l21.278">         controller.keypress(element, &quot;VK_DELETE&quot;, {});</span>
<a href="#l21.279"></a><span id="l21.279">     } else if (mode == &quot;modify&quot;) {</span>
<a href="#l21.280"></a><span id="l21.280">         controller.doubleClick(element);</span>
<a href="#l21.281"></a><span id="l21.281">     }</span>
<a href="#l21.282"></a><span id="l21.282">     wait_for_modal_dialog(&quot;Calendar:OccurrencePrompt&quot;, TIMEOUT_MODAL_DIALOG);</span>
<a href="#l21.283"></a><span id="l21.283"> }</span>
<a href="#l21.284"></a><span id="l21.284"> </span>
<a href="#l21.285"></a><span id="l21.285"> /**</span>
<a href="#l21.286"></a><span id="l21.286" class="difflineminus">- * Switch to a view and make sure it's displayed</span>
<a href="#l21.287"></a><span id="l21.287" class="difflineplus">+ * Switch to a view and make sure it's displayed.</span>
<a href="#l21.288"></a><span id="l21.288">  *</span>
<a href="#l21.289"></a><span id="l21.289">  * @param controller        Mozmill window controller</span>
<a href="#l21.290"></a><span id="l21.290">  * @param view              day, week, multiweek or month</span>
<a href="#l21.291"></a><span id="l21.291">  */</span>
<a href="#l21.292"></a><span id="l21.292"> function switchToView(controller, view) {</span>
<a href="#l21.293"></a><span id="l21.293">     let { eid } = helpersForController(controller);</span>
<a href="#l21.294"></a><span id="l21.294"> </span>
<a href="#l21.295"></a><span id="l21.295">     let button = `calendar-${view}-view-button`;</span>
<a href="#l21.296"></a><span id="l21.296"> </span>
<a href="#l21.297"></a><span id="l21.297">     controller.waitThenClick(eid(button));</span>
<a href="#l21.298"></a><span id="l21.298">     ensureViewLoaded(controller);</span>
<a href="#l21.299"></a><span id="l21.299"> }</span>
<a href="#l21.300"></a><span id="l21.300"> </span>
<a href="#l21.301"></a><span id="l21.301"> /**</span>
<a href="#l21.302"></a><span id="l21.302" class="difflineminus">- * Go to a specific date using minimonth</span>
<a href="#l21.303"></a><span id="l21.303" class="difflineplus">+ * Go to a specific date using minimonth.</span>
<a href="#l21.304"></a><span id="l21.304">  *</span>
<a href="#l21.305"></a><span id="l21.305">  * @param controller    Main window controller</span>
<a href="#l21.306"></a><span id="l21.306">  * @param year          Four-digit year</span>
<a href="#l21.307"></a><span id="l21.307">  * @param month         1-based index of a month</span>
<a href="#l21.308"></a><span id="l21.308">  * @param day           1-based index of a day</span>
<a href="#l21.309"></a><span id="l21.309">  */</span>
<a href="#l21.310"></a><span id="l21.310"> function goToDate(controller, year, month, day) {</span>
<a href="#l21.311"></a><span id="l21.311">     let { eid, lookup } = helpersForController(controller);</span>
<a href="#l21.312"></a><span id="l21.312"> </span>
<a href="#l21.313"></a><span id="l21.313" class="difflineminus">-    let miniMonth = `</span>
<a href="#l21.314"></a><span id="l21.314" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;tabmail&quot;)/id(&quot;tabmail-tabbox&quot;)/</span>
<a href="#l21.315"></a><span id="l21.315" class="difflineminus">-        id(&quot;tabpanelcontainer&quot;)/id(&quot;calendarTabPanel&quot;)/id(&quot;calendarContent&quot;)/</span>
<a href="#l21.316"></a><span id="l21.316" class="difflineminus">-        id(&quot;ltnSidebar&quot;)/id(&quot;minimonth-pane&quot;)/{&quot;align&quot;:&quot;center&quot;}/</span>
<a href="#l21.317"></a><span id="l21.317" class="difflineminus">-        id(&quot;calMinimonthBox&quot;)/id(&quot;calMinimonth&quot;)</span>
<a href="#l21.318"></a><span id="l21.318" class="difflineminus">-    `;</span>
<a href="#l21.319"></a><span id="l21.319" class="difflineminus">-</span>
<a href="#l21.320"></a><span id="l21.320">     let activeYear = lookup(`</span>
<a href="#l21.321"></a><span id="l21.321" class="difflineminus">-        ${miniMonth}/anon({&quot;anonid&quot;:&quot;minimonth-header&quot;})/</span>
<a href="#l21.322"></a><span id="l21.322" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;yearcell&quot;})</span>
<a href="#l21.323"></a><span id="l21.323" class="difflineplus">+        ${MINIMONTH}/anon({&quot;anonid&quot;:&quot;minimonth-header&quot;})/anon({&quot;anonid&quot;:&quot;yearcell&quot;})</span>
<a href="#l21.324"></a><span id="l21.324">     `).getNode().getAttribute(&quot;label&quot;);</span>
<a href="#l21.325"></a><span id="l21.325"> </span>
<a href="#l21.326"></a><span id="l21.326">     let activeMonth = lookup(`</span>
<a href="#l21.327"></a><span id="l21.327" class="difflineminus">-        ${miniMonth}/anon({&quot;anonid&quot;:&quot;minimonth-header&quot;})/anon({&quot;anonid&quot;:&quot;monthheader&quot;})</span>
<a href="#l21.328"></a><span id="l21.328" class="difflineplus">+        ${MINIMONTH}/anon({&quot;anonid&quot;:&quot;minimonth-header&quot;})/anon({&quot;anonid&quot;:&quot;monthheader&quot;})</span>
<a href="#l21.329"></a><span id="l21.329">     `).getNode().getAttribute(&quot;selectedIndex&quot;);</span>
<a href="#l21.330"></a><span id="l21.330"> </span>
<a href="#l21.331"></a><span id="l21.331">     let yearDifference = activeYear - year;</span>
<a href="#l21.332"></a><span id="l21.332">     let monthDifference = activeMonth - (month - 1);</span>
<a href="#l21.333"></a><span id="l21.333"> </span>
<a href="#l21.334"></a><span id="l21.334">     if (yearDifference != 0) {</span>
<a href="#l21.335"></a><span id="l21.335">         let direction = yearDifference &gt; 0 ? &quot;up&quot; : &quot;down&quot;;</span>
<a href="#l21.336"></a><span id="l21.336">         let scrollArrow = lookup(`</span>
<a href="#l21.337"></a><span id="l21.337" class="difflineminus">-            ${miniMonth}/anon({&quot;anonid&quot;:&quot;minimonth-header&quot;})/</span>
<a href="#l21.338"></a><span id="l21.338" class="difflineminus">-            anon({&quot;anonid&quot;:&quot;minmonth-popupset&quot;})/anon({&quot;anonid&quot;:&quot;years-popup&quot;})/</span>
<a href="#l21.339"></a><span id="l21.339" class="difflineminus">-            {&quot;class&quot;:&quot;autorepeatbutton-${direction}&quot;}`);</span>
<a href="#l21.340"></a><span id="l21.340" class="difflineplus">+            ${MINIMONTH}/anon({&quot;anonid&quot;:&quot;minimonth-header&quot;})/anon({&quot;anonid&quot;:&quot;minmonth-popupset&quot;})/</span>
<a href="#l21.341"></a><span id="l21.341" class="difflineplus">+            anon({&quot;anonid&quot;:&quot;years-popup&quot;})/{&quot;class&quot;:&quot;autorepeatbutton-${direction}&quot;}`);</span>
<a href="#l21.342"></a><span id="l21.342"> </span>
<a href="#l21.343"></a><span id="l21.343" class="difflineminus">-        // pick year</span>
<a href="#l21.344"></a><span id="l21.344" class="difflineplus">+        // Pick year.</span>
<a href="#l21.345"></a><span id="l21.345">         controller.click(lookup(`</span>
<a href="#l21.346"></a><span id="l21.346" class="difflineminus">-            ${miniMonth}/anon({&quot;anonid&quot;:&quot;minimonth-header&quot;})/</span>
<a href="#l21.347"></a><span id="l21.347" class="difflineminus">-            anon({&quot;anonid&quot;:&quot;yearcell&quot;})</span>
<a href="#l21.348"></a><span id="l21.348" class="difflineplus">+            ${MINIMONTH}/anon({&quot;anonid&quot;:&quot;minimonth-header&quot;})/anon({&quot;anonid&quot;:&quot;yearcell&quot;})</span>
<a href="#l21.349"></a><span id="l21.349">         `));</span>
<a href="#l21.350"></a><span id="l21.350"> </span>
<a href="#l21.351"></a><span id="l21.351">         let getYearListitem = function(aYear) {</span>
<a href="#l21.352"></a><span id="l21.352">             return lookup(`</span>
<a href="#l21.353"></a><span id="l21.353" class="difflineminus">-                ${miniMonth}/anon({&quot;anonid&quot;:&quot;minimonth-header&quot;})/</span>
<a href="#l21.354"></a><span id="l21.354" class="difflineplus">+                ${MINIMONTH}/anon({&quot;anonid&quot;:&quot;minimonth-header&quot;})/</span>
<a href="#l21.355"></a><span id="l21.355">                 anon({&quot;anonid&quot;:&quot;minmonth-popupset&quot;})/anon({&quot;anonid&quot;:&quot;years-popup&quot;})/</span>
<a href="#l21.356"></a><span id="l21.356">                 {&quot;label&quot;:&quot;${aYear}&quot;}</span>
<a href="#l21.357"></a><span id="l21.357">             `);</span>
<a href="#l21.358"></a><span id="l21.358">         };</span>
<a href="#l21.359"></a><span id="l21.359"> </span>
<a href="#l21.360"></a><span id="l21.360">         controller.waitForElement(scrollArrow);</span>
<a href="#l21.361"></a><span id="l21.361">         scrollArrow = scrollArrow.getNode();</span>
<a href="#l21.362"></a><span id="l21.362"> </span>
<a href="#l21.363"></a><span id="l21.363" class="difflineat">@@ -267,40 +274,39 @@ function goToDate(controller, year, mont</span>
<a href="#l21.364"></a><span id="l21.364"> </span>
<a href="#l21.365"></a><span id="l21.365">         controller.waitForEvents.init(eid(&quot;calMinimonth&quot;), [&quot;monthchange&quot;]);</span>
<a href="#l21.366"></a><span id="l21.366">         controller.click(getYearListitem(year));</span>
<a href="#l21.367"></a><span id="l21.367">         controller.waitForEvents.wait(TIMEOUT_MONTHCHANGE);</span>
<a href="#l21.368"></a><span id="l21.368">     }</span>
<a href="#l21.369"></a><span id="l21.369"> </span>
<a href="#l21.370"></a><span id="l21.370">     if (monthDifference != 0) {</span>
<a href="#l21.371"></a><span id="l21.371">         controller.waitForEvents.init(eid(&quot;calMinimonth&quot;), [&quot;monthchange&quot;]);</span>
<a href="#l21.372"></a><span id="l21.372" class="difflineminus">-        // pick month</span>
<a href="#l21.373"></a><span id="l21.373" class="difflineplus">+        // Pick month.</span>
<a href="#l21.374"></a><span id="l21.374">         controller.click(lookup(`</span>
<a href="#l21.375"></a><span id="l21.375" class="difflineminus">-            ${miniMonth}/anon({&quot;anonid&quot;:&quot;minimonth-header&quot;})/</span>
<a href="#l21.376"></a><span id="l21.376" class="difflineminus">-            anon({&quot;anonid&quot;:&quot;monthheader&quot;})/[${activeMonth}]</span>
<a href="#l21.377"></a><span id="l21.377" class="difflineplus">+            ${MINIMONTH}/anon({&quot;anonid&quot;:&quot;minimonth-header&quot;})/anon({&quot;anonid&quot;:&quot;monthheader&quot;})/</span>
<a href="#l21.378"></a><span id="l21.378" class="difflineplus">+            [${activeMonth}]</span>
<a href="#l21.379"></a><span id="l21.379">         `));</span>
<a href="#l21.380"></a><span id="l21.380">         controller.waitThenClick(lookup(`</span>
<a href="#l21.381"></a><span id="l21.381" class="difflineminus">-            ${miniMonth}/anon({&quot;anonid&quot;:&quot;minimonth-header&quot;})/</span>
<a href="#l21.382"></a><span id="l21.382" class="difflineminus">-            anon({&quot;anonid&quot;:&quot;minmonth-popupset&quot;})/anon({&quot;anonid&quot;:&quot;months-popup&quot;})/</span>
<a href="#l21.383"></a><span id="l21.383" class="difflineminus">-            {&quot;index&quot;:&quot;${month - 1}&quot;}</span>
<a href="#l21.384"></a><span id="l21.384" class="difflineplus">+            ${MINIMONTH}/anon({&quot;anonid&quot;:&quot;minimonth-header&quot;})/anon({&quot;anonid&quot;:&quot;minmonth-popupset&quot;})/</span>
<a href="#l21.385"></a><span id="l21.385" class="difflineplus">+            anon({&quot;anonid&quot;:&quot;months-popup&quot;})/{&quot;index&quot;:&quot;${month - 1}&quot;}</span>
<a href="#l21.386"></a><span id="l21.386">         `));</span>
<a href="#l21.387"></a><span id="l21.387">         controller.waitForEvents.wait(TIMEOUT_MONTHCHANGE);</span>
<a href="#l21.388"></a><span id="l21.388">     }</span>
<a href="#l21.389"></a><span id="l21.389"> </span>
<a href="#l21.390"></a><span id="l21.390">     let lastDayInFirstRow = lookup(`</span>
<a href="#l21.391"></a><span id="l21.391" class="difflineminus">-        ${miniMonth}/anon({&quot;anonid&quot;:&quot;minimonth-calendar&quot;})/[3]/[15]</span>
<a href="#l21.392"></a><span id="l21.392" class="difflineplus">+        ${MINIMONTH}/anon({&quot;anonid&quot;:&quot;minimonth-calendar&quot;})/[3]/[15]</span>
<a href="#l21.393"></a><span id="l21.393">     `).getNode().innerHTML;</span>
<a href="#l21.394"></a><span id="l21.394"> </span>
<a href="#l21.395"></a><span id="l21.395">     let positionOfFirst = 7 - lastDayInFirstRow;</span>
<a href="#l21.396"></a><span id="l21.396">     let dateColumn = (positionOfFirst + day - 1) % 7;</span>
<a href="#l21.397"></a><span id="l21.397">     let dateRow = Math.floor((positionOfFirst + day - 1) / 7);</span>
<a href="#l21.398"></a><span id="l21.398"> </span>
<a href="#l21.399"></a><span id="l21.399">     // pick day</span>
<a href="#l21.400"></a><span id="l21.400">     controller.click(lookup(`</span>
<a href="#l21.401"></a><span id="l21.401" class="difflineminus">-        ${miniMonth}/anon({&quot;anonid&quot;:&quot;minimonth-calendar&quot;})/[${(dateRow + 1) * 2 + 1}]/</span>
<a href="#l21.402"></a><span id="l21.402" class="difflineplus">+        ${MINIMONTH}/anon({&quot;anonid&quot;:&quot;minimonth-calendar&quot;})/[${(dateRow + 1) * 2 + 1}]/</span>
<a href="#l21.403"></a><span id="l21.403">         [${(dateColumn + 1) * 2 + 1}]</span>
<a href="#l21.404"></a><span id="l21.404">     `));</span>
<a href="#l21.405"></a><span id="l21.405">     ensureViewLoaded(controller);</span>
<a href="#l21.406"></a><span id="l21.406"> }</span>
<a href="#l21.407"></a><span id="l21.407"> </span>
<a href="#l21.408"></a><span id="l21.408"> /**</span>
<a href="#l21.409"></a><span id="l21.409">  * Opens the event dialog by clicking on the (optional) box and executing the</span>
<a href="#l21.410"></a><span id="l21.410">  * body. The event dialog must be closed in the body function.</span>
<a href="#l21.411"></a><span id="l21.411" class="difflineat">@@ -319,120 +325,149 @@ function invokeEventDialog(controller, c</span>
<a href="#l21.412"></a><span id="l21.412">         return mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;).length &gt; 0;</span>
<a href="#l21.413"></a><span id="l21.413">     }, &quot;event-dialog did not load in time&quot;, MID_SLEEP);</span>
<a href="#l21.414"></a><span id="l21.414"> </span>
<a href="#l21.415"></a><span id="l21.415">     let eventWindow = mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;)[0];</span>
<a href="#l21.416"></a><span id="l21.416">     let eventController = new mozmill.controller.MozMillController(eventWindow);</span>
<a href="#l21.417"></a><span id="l21.417">     let iframe = eventController.window.document.getElementById(&quot;lightning-item-panel-iframe&quot;);</span>
<a href="#l21.418"></a><span id="l21.418"> </span>
<a href="#l21.419"></a><span id="l21.419">     eventController.waitFor(() =&gt; {</span>
<a href="#l21.420"></a><span id="l21.420" class="difflineminus">-        return iframe.contentWindow.onLoad &amp;&amp;</span>
<a href="#l21.421"></a><span id="l21.421" class="difflineminus">-               iframe.contentWindow.onLoad.hasLoaded;</span>
<a href="#l21.422"></a><span id="l21.422" class="difflineplus">+        return iframe.contentWindow.onLoad &amp;&amp; iframe.contentWindow.onLoad.hasLoaded;</span>
<a href="#l21.423"></a><span id="l21.423">     }, &quot;event-dialog did not load in time&quot;, 10000);</span>
<a href="#l21.424"></a><span id="l21.424"> </span>
<a href="#l21.425"></a><span id="l21.425">     // We can't use a full mozmill controller on an iframe, but we need</span>
<a href="#l21.426"></a><span id="l21.426">     // something for helpersForController.</span>
<a href="#l21.427"></a><span id="l21.427">     let mockIframeController = { window: iframe.contentWindow };</span>
<a href="#l21.428"></a><span id="l21.428"> </span>
<a href="#l21.429"></a><span id="l21.429">     body(eventController, mockIframeController);</span>
<a href="#l21.430"></a><span id="l21.430"> </span>
<a href="#l21.431"></a><span id="l21.431" class="difflineminus">-    // Wait for close</span>
<a href="#l21.432"></a><span id="l21.432" class="difflineplus">+    // Wait for close.</span>
<a href="#l21.433"></a><span id="l21.433">     controller.waitFor(() =&gt; mozmill.utils.getWindows(&quot;Calendar:EventDialog&quot;).length == 0);</span>
<a href="#l21.434"></a><span id="l21.434"> }</span>
<a href="#l21.435"></a><span id="l21.435"> </span>
<a href="#l21.436"></a><span id="l21.436"> /**</span>
<a href="#l21.437"></a><span id="l21.437" class="difflineminus">- * Gets the path for an event box</span>
<a href="#l21.438"></a><span id="l21.438" class="difflineplus">+ * Gets the path for an event box.</span>
<a href="#l21.439"></a><span id="l21.439">  *</span>
<a href="#l21.440"></a><span id="l21.440">  * @param controller    main window controller</span>
<a href="#l21.441"></a><span id="l21.441">  * @param view          day, week, multiweek or month</span>
<a href="#l21.442"></a><span id="l21.442">  * @param option        CANVAS_BOX or ALLDAY for creating event, EVENT_BOX for existing event</span>
<a href="#l21.443"></a><span id="l21.443" class="difflineminus">- * @param row           only used in multiweek and month view, 1-based index of a row</span>
<a href="#l21.444"></a><span id="l21.444" class="difflineplus">+ * @param row           Only used in multiweek and month view, 1-based index of a row.</span>
<a href="#l21.445"></a><span id="l21.445">  * @param column        1-based index of a column</span>
<a href="#l21.446"></a><span id="l21.446" class="difflineminus">- * @param hour          index of hour box</span>
<a href="#l21.447"></a><span id="l21.447" class="difflineplus">+ * @param hour          Only used in day and week view, index of hour box.</span>
<a href="#l21.448"></a><span id="l21.448">  * @returns             path string</span>
<a href="#l21.449"></a><span id="l21.449">  */</span>
<a href="#l21.450"></a><span id="l21.450"> function getEventBoxPath(controller, view, option, row, column, hour) {</span>
<a href="#l21.451"></a><span id="l21.451" class="difflineminus">-    let viewDeck = `</span>
<a href="#l21.452"></a><span id="l21.452" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;tabmail&quot;)/id(&quot;tabmail-tabbox&quot;)/</span>
<a href="#l21.453"></a><span id="l21.453" class="difflineminus">-        id(&quot;tabpanelcontainer&quot;)/id(&quot;calendarTabPanel&quot;)/id(&quot;calendarContent&quot;)/</span>
<a href="#l21.454"></a><span id="l21.454" class="difflineminus">-        id(&quot;calendarDisplayDeck&quot;)/id(&quot;calendar-view-box&quot;)/id(&quot;view-deck&quot;)</span>
<a href="#l21.455"></a><span id="l21.455" class="difflineminus">-    `;</span>
<a href="#l21.456"></a><span id="l21.456" class="difflineminus">-</span>
<a href="#l21.457"></a><span id="l21.457" class="difflineminus">-    let path = `${viewDeck}/id(&quot;${view}-view&quot;)`;</span>
<a href="#l21.458"></a><span id="l21.458" class="difflineminus">-</span>
<a href="#l21.459"></a><span id="l21.459" class="difflineplus">+    let path = `${VIEWDECK}/id(&quot;${view}-view&quot;)`;</span>
<a href="#l21.460"></a><span id="l21.460"> </span>
<a href="#l21.461"></a><span id="l21.461">     if ((view == &quot;day&quot; || view == &quot;week&quot;) &amp;&amp; option == ALLDAY) {</span>
<a href="#l21.462"></a><span id="l21.462">         return path + `</span>
<a href="#l21.463"></a><span id="l21.463">             /anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;headerbox&quot;})/</span>
<a href="#l21.464"></a><span id="l21.464" class="difflineminus">-            anon({&quot;anonid&quot;:&quot;headerdaybox&quot;})/</span>
<a href="#l21.465"></a><span id="l21.465" class="difflineminus">-            [${column - 1}]</span>
<a href="#l21.466"></a><span id="l21.466" class="difflineplus">+            anon({&quot;anonid&quot;:&quot;headerdaybox&quot;})/[${column - 1}]</span>
<a href="#l21.467"></a><span id="l21.467">         `;</span>
<a href="#l21.468"></a><span id="l21.468">     } else if (view == &quot;day&quot; || view == &quot;week&quot;) {</span>
<a href="#l21.469"></a><span id="l21.469">         path += `</span>
<a href="#l21.470"></a><span id="l21.470" class="difflineminus">-            /anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;scrollbox&quot;})/</span>
<a href="#l21.471"></a><span id="l21.471" class="difflineminus">-            anon({&quot;anonid&quot;:&quot;daybox&quot;})/[${column - 1}]/</span>
<a href="#l21.472"></a><span id="l21.472" class="difflineminus">-            anon({&quot;anonid&quot;:&quot;boxstack&quot;})</span>
<a href="#l21.473"></a><span id="l21.473" class="difflineplus">+            /anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;scrollbox&quot;})/anon({&quot;anonid&quot;:&quot;daybox&quot;})/</span>
<a href="#l21.474"></a><span id="l21.474" class="difflineplus">+            [${column - 1}]/anon({&quot;anonid&quot;:&quot;boxstack&quot;})</span>
<a href="#l21.475"></a><span id="l21.475">         `;</span>
<a href="#l21.476"></a><span id="l21.476"> </span>
<a href="#l21.477"></a><span id="l21.477">         if (option == CANVAS_BOX) {</span>
<a href="#l21.478"></a><span id="l21.478">             path += `/anon({&quot;anonid&quot;:&quot;bgbox&quot;})/[${hour}]`;</span>
<a href="#l21.479"></a><span id="l21.479">         } else {</span>
<a href="#l21.480"></a><span id="l21.480" class="difflineminus">-            path += '/anon({&quot;anonid&quot;:&quot;topbox&quot;})/{&quot;flex&quot;:&quot;1&quot;}/{&quot;flex&quot;:&quot;1&quot;}/{&quot;flex&quot;:&quot;1&quot;}';</span>
<a href="#l21.481"></a><span id="l21.481" class="difflineplus">+            path += `</span>
<a href="#l21.482"></a><span id="l21.482" class="difflineplus">+                /anon({&quot;anonid&quot;:&quot;topbox&quot;})/{&quot;flex&quot;:&quot;1&quot;}/{&quot;flex&quot;:&quot;1&quot;}/{&quot;flex&quot;:&quot;1&quot;}</span>
<a href="#l21.483"></a><span id="l21.483" class="difflineplus">+            `;</span>
<a href="#l21.484"></a><span id="l21.484">         }</span>
<a href="#l21.485"></a><span id="l21.485"> </span>
<a href="#l21.486"></a><span id="l21.486">         return path;</span>
<a href="#l21.487"></a><span id="l21.487">     } else {</span>
<a href="#l21.488"></a><span id="l21.488">         path += `</span>
<a href="#l21.489"></a><span id="l21.489">             /anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;monthgrid&quot;})/</span>
<a href="#l21.490"></a><span id="l21.490" class="difflineminus">-            anon({&quot;anonid&quot;:&quot;monthgridrows&quot;})/[${row - 1}]/</span>
<a href="#l21.491"></a><span id="l21.491" class="difflineminus">-            [${column - 1}]</span>
<a href="#l21.492"></a><span id="l21.492" class="difflineplus">+            anon({&quot;anonid&quot;:&quot;monthgridrows&quot;})/[${row - 1}]/[${column - 1}]</span>
<a href="#l21.493"></a><span id="l21.493">         `;</span>
<a href="#l21.494"></a><span id="l21.494"> </span>
<a href="#l21.495"></a><span id="l21.495">         if (option == CANVAS_BOX) {</span>
<a href="#l21.496"></a><span id="l21.496" class="difflineminus">-            path += '/anon({&quot;anonid&quot;:&quot;day-items&quot;})';</span>
<a href="#l21.497"></a><span id="l21.497" class="difflineplus">+            path += `</span>
<a href="#l21.498"></a><span id="l21.498" class="difflineplus">+                /anon({&quot;anonid&quot;:&quot;day-items&quot;})</span>
<a href="#l21.499"></a><span id="l21.499" class="difflineplus">+            `;</span>
<a href="#l21.500"></a><span id="l21.500">         }</span>
<a href="#l21.501"></a><span id="l21.501"> </span>
<a href="#l21.502"></a><span id="l21.502">         return path;</span>
<a href="#l21.503"></a><span id="l21.503">     }</span>
<a href="#l21.504"></a><span id="l21.504"> }</span>
<a href="#l21.505"></a><span id="l21.505"> </span>
<a href="#l21.506"></a><span id="l21.506"> /**</span>
<a href="#l21.507"></a><span id="l21.507" class="difflineminus">- * Moves the view n times forward</span>
<a href="#l21.508"></a><span id="l21.508" class="difflineplus">+ * Gets the path snippet for event-details. This is different for day/week and</span>
<a href="#l21.509"></a><span id="l21.509" class="difflineplus">+ * multiweek/month view.</span>
<a href="#l21.510"></a><span id="l21.510" class="difflineplus">+ *</span>
<a href="#l21.511"></a><span id="l21.511" class="difflineplus">+ * @param view          day, week, multiweek or month</span>
<a href="#l21.512"></a><span id="l21.512" class="difflineplus">+ */</span>
<a href="#l21.513"></a><span id="l21.513" class="difflineplus">+function getEventDetails(view) {</span>
<a href="#l21.514"></a><span id="l21.514" class="difflineplus">+    if (view == &quot;day&quot; || view == &quot;week&quot;) {</span>
<a href="#l21.515"></a><span id="l21.515" class="difflineplus">+        return `</span>
<a href="#l21.516"></a><span id="l21.516" class="difflineplus">+            anon({&quot;flex&quot;:&quot;1&quot;})/anon({&quot;anonid&quot;:&quot;event-container&quot;})/</span>
<a href="#l21.517"></a><span id="l21.517" class="difflineplus">+            {&quot;class&quot;:&quot;calendar-event-selection&quot;}/anon({&quot;anonid&quot;:&quot;eventbox&quot;})/</span>
<a href="#l21.518"></a><span id="l21.518" class="difflineplus">+            {&quot;class&quot;:&quot;calendar-event-details&quot;}</span>
<a href="#l21.519"></a><span id="l21.519" class="difflineplus">+        `;</span>
<a href="#l21.520"></a><span id="l21.520" class="difflineplus">+    } else {</span>
<a href="#l21.521"></a><span id="l21.521" class="difflineplus">+        return `</span>
<a href="#l21.522"></a><span id="l21.522" class="difflineplus">+            anon({&quot;flex&quot;:&quot;1&quot;})/[0]/anon({&quot;anonid&quot;:&quot;event-container&quot;})/</span>
<a href="#l21.523"></a><span id="l21.523" class="difflineplus">+            {&quot;class&quot;:&quot;calendar-event-selection&quot;}/anon({&quot;anonid&quot;:&quot;eventbox&quot;})/</span>
<a href="#l21.524"></a><span id="l21.524" class="difflineplus">+            {&quot;class&quot;:&quot;calendar-event-details&quot;}</span>
<a href="#l21.525"></a><span id="l21.525" class="difflineplus">+        `;</span>
<a href="#l21.526"></a><span id="l21.526" class="difflineplus">+    }</span>
<a href="#l21.527"></a><span id="l21.527" class="difflineplus">+}</span>
<a href="#l21.528"></a><span id="l21.528" class="difflineplus">+</span>
<a href="#l21.529"></a><span id="l21.529" class="difflineplus">+/**</span>
<a href="#l21.530"></a><span id="l21.530" class="difflineplus">+ * Checks if Alarm-Icon is shown on a given Event-Box.</span>
<a href="#l21.531"></a><span id="l21.531" class="difflineplus">+ *</span>
<a href="#l21.532"></a><span id="l21.532" class="difflineplus">+ * @param view          day, week, multiweek or month</span>
<a href="#l21.533"></a><span id="l21.533" class="difflineplus">+ * @param row           Only used in multiweek and month view, 1-based index of a row.</span>
<a href="#l21.534"></a><span id="l21.534" class="difflineplus">+ * @param column        1-based index of a column</span>
<a href="#l21.535"></a><span id="l21.535" class="difflineplus">+ */</span>
<a href="#l21.536"></a><span id="l21.536" class="difflineplus">+function checkAlarmIcon(controller, view, row, column) {</span>
<a href="#l21.537"></a><span id="l21.537" class="difflineplus">+    let { lookupEventBox } = helpersForController(controller);</span>
<a href="#l21.538"></a><span id="l21.538" class="difflineplus">+    controller.assertNode(lookupEventBox(view, EVENT_BOX, row, column, null, `</span>
<a href="#l21.539"></a><span id="l21.539" class="difflineplus">+        ${EVENTPATH}/${getEventDetails([view])}/${ALARM_ICON_PATH}</span>
<a href="#l21.540"></a><span id="l21.540" class="difflineplus">+    `));</span>
<a href="#l21.541"></a><span id="l21.541" class="difflineplus">+}</span>
<a href="#l21.542"></a><span id="l21.542" class="difflineplus">+</span>
<a href="#l21.543"></a><span id="l21.543" class="difflineplus">+/**</span>
<a href="#l21.544"></a><span id="l21.544" class="difflineplus">+ * Moves the view n times forward.</span>
<a href="#l21.545"></a><span id="l21.545">  *</span>
<a href="#l21.546"></a><span id="l21.546">  * @param controller    Mozmill window controller</span>
<a href="#l21.547"></a><span id="l21.547" class="difflineminus">- * @param n             how many times next button in view is clicked</span>
<a href="#l21.548"></a><span id="l21.548" class="difflineplus">+ * @param n             How many times next button in view is clicked.</span>
<a href="#l21.549"></a><span id="l21.549">  */</span>
<a href="#l21.550"></a><span id="l21.550"> function viewForward(controller, n) {</span>
<a href="#l21.551"></a><span id="l21.551">     let { eid, sleep } = helpersForController(controller);</span>
<a href="#l21.552"></a><span id="l21.552"> </span>
<a href="#l21.553"></a><span id="l21.553">     for (let i = 0; i &lt; n; i++) {</span>
<a href="#l21.554"></a><span id="l21.554">         controller.click(eid(&quot;next-view-button&quot;));</span>
<a href="#l21.555"></a><span id="l21.555">         sleep(SHORT_SLEEP);</span>
<a href="#l21.556"></a><span id="l21.556">     }</span>
<a href="#l21.557"></a><span id="l21.557">     ensureViewLoaded(controller);</span>
<a href="#l21.558"></a><span id="l21.558"> }</span>
<a href="#l21.559"></a><span id="l21.559"> </span>
<a href="#l21.560"></a><span id="l21.560"> /**</span>
<a href="#l21.561"></a><span id="l21.561" class="difflineminus">- * Moves the view n times back</span>
<a href="#l21.562"></a><span id="l21.562" class="difflineplus">+ * Moves the view n times back.</span>
<a href="#l21.563"></a><span id="l21.563">  *</span>
<a href="#l21.564"></a><span id="l21.564">  * @param controller    Mozmill window controller</span>
<a href="#l21.565"></a><span id="l21.565" class="difflineminus">- * @param n             how many times previous button in view is clicked</span>
<a href="#l21.566"></a><span id="l21.566" class="difflineplus">+ * @param n             How many times previous button in view is clicked.</span>
<a href="#l21.567"></a><span id="l21.567">  */</span>
<a href="#l21.568"></a><span id="l21.568"> function viewBack(controller, n) {</span>
<a href="#l21.569"></a><span id="l21.569">     let { eid, sleep } = helpersForController(controller);</span>
<a href="#l21.570"></a><span id="l21.570"> </span>
<a href="#l21.571"></a><span id="l21.571">     for (let i = 0; i &lt; n; i++) {</span>
<a href="#l21.572"></a><span id="l21.572">         controller.click(eid(&quot;previous-view-button&quot;));</span>
<a href="#l21.573"></a><span id="l21.573">         sleep(SHORT_SLEEP);</span>
<a href="#l21.574"></a><span id="l21.574">     }</span>
<a href="#l21.575"></a><span id="l21.575">     ensureViewLoaded(controller);</span>
<a href="#l21.576"></a><span id="l21.576"> }</span>
<a href="#l21.577"></a><span id="l21.577"> </span>
<a href="#l21.578"></a><span id="l21.578"> /**</span>
<a href="#l21.579"></a><span id="l21.579" class="difflineminus">- * Deletes all calendars with given name</span>
<a href="#l21.580"></a><span id="l21.580" class="difflineplus">+ * Deletes all calendars with given name.</span>
<a href="#l21.581"></a><span id="l21.581">  *</span>
<a href="#l21.582"></a><span id="l21.582">  * @param controller    Mozmill window controller</span>
<a href="#l21.583"></a><span id="l21.583">  * @param name          calendar name</span>
<a href="#l21.584"></a><span id="l21.584">  */</span>
<a href="#l21.585"></a><span id="l21.585"> function deleteCalendars(controller, name) {</span>
<a href="#l21.586"></a><span id="l21.586">     let { eid } = helpersForController(controller);</span>
<a href="#l21.587"></a><span id="l21.587"> </span>
<a href="#l21.588"></a><span id="l21.588">     let win = eid(&quot;messengerWindow&quot;).getNode().ownerGlobal;</span>
<a href="#l21.589"></a><span id="l21.589" class="difflineat">@@ -441,48 +476,46 @@ function deleteCalendars(controller, nam</span>
<a href="#l21.590"></a><span id="l21.590">     for (let calendar of manager.getCalendars({})) {</span>
<a href="#l21.591"></a><span id="l21.591">         if (calendar.name == name) {</span>
<a href="#l21.592"></a><span id="l21.592">             manager.removeCalendar(calendar);</span>
<a href="#l21.593"></a><span id="l21.593">         }</span>
<a href="#l21.594"></a><span id="l21.594">     }</span>
<a href="#l21.595"></a><span id="l21.595"> }</span>
<a href="#l21.596"></a><span id="l21.596"> </span>
<a href="#l21.597"></a><span id="l21.597"> /**</span>
<a href="#l21.598"></a><span id="l21.598" class="difflineminus">- * Creates local calendar with given name and select it in calendars list</span>
<a href="#l21.599"></a><span id="l21.599" class="difflineplus">+ * Creates local calendar with given name and select it in calendars list.</span>
<a href="#l21.600"></a><span id="l21.600">  *</span>
<a href="#l21.601"></a><span id="l21.601">  * @param controller    Mozmill window controller</span>
<a href="#l21.602"></a><span id="l21.602">  * @param name          calendar name</span>
<a href="#l21.603"></a><span id="l21.603">  */</span>
<a href="#l21.604"></a><span id="l21.604"> function createCalendar(controller, name) {</span>
<a href="#l21.605"></a><span id="l21.605">     let { lookup, eid } = helpersForController(controller);</span>
<a href="#l21.606"></a><span id="l21.606"> </span>
<a href="#l21.607"></a><span id="l21.607">     let win = eid(&quot;messengerWindow&quot;).getNode().ownerGlobal;</span>
<a href="#l21.608"></a><span id="l21.608">     let manager = win.cal.getCalendarManager();</span>
<a href="#l21.609"></a><span id="l21.609"> </span>
<a href="#l21.610"></a><span id="l21.610">     let url = Services.io.newURI(&quot;moz-storage-calendar://&quot;);</span>
<a href="#l21.611"></a><span id="l21.611">     let calendar = manager.createCalendar(&quot;storage&quot;, url);</span>
<a href="#l21.612"></a><span id="l21.612">     calendar.name = name;</span>
<a href="#l21.613"></a><span id="l21.613">     manager.registerCalendar(calendar);</span>
<a href="#l21.614"></a><span id="l21.614"> </span>
<a href="#l21.615"></a><span id="l21.615">     let calendarTree = lookup(`</span>
<a href="#l21.616"></a><span id="l21.616" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;tabmail&quot;)/id(&quot;tabmail-tabbox&quot;)/</span>
<a href="#l21.617"></a><span id="l21.617" class="difflineminus">-        id(&quot;tabpanelcontainer&quot;)/id(&quot;calendarTabPanel&quot;)/id(&quot;calendarContent&quot;)/</span>
<a href="#l21.618"></a><span id="l21.618" class="difflineminus">-        id(&quot;ltnSidebar&quot;)/id(&quot;calendar-panel&quot;)/id(&quot;calendar-list-pane&quot;)/</span>
<a href="#l21.619"></a><span id="l21.619" class="difflineplus">+        ${CALENDAR_PANEL}/id(&quot;ltnSidebar&quot;)/id(&quot;calendar-panel&quot;)/id(&quot;calendar-list-pane&quot;)/</span>
<a href="#l21.620"></a><span id="l21.620">         id(&quot;calendar-listtree-pane&quot;)/id(&quot;calendar-list-tree-widget&quot;)</span>
<a href="#l21.621"></a><span id="l21.621">     `).getNode();</span>
<a href="#l21.622"></a><span id="l21.622"> </span>
<a href="#l21.623"></a><span id="l21.623">     for (let i = 0; i &lt; calendarTree.mCalendarList.length; i++) {</span>
<a href="#l21.624"></a><span id="l21.624">         if (calendarTree.mCalendarList[i].id == calendar.id) {</span>
<a href="#l21.625"></a><span id="l21.625">             calendarTree.tree.view.selection.select(i);</span>
<a href="#l21.626"></a><span id="l21.626">         }</span>
<a href="#l21.627"></a><span id="l21.627">     }</span>
<a href="#l21.628"></a><span id="l21.628"> }</span>
<a href="#l21.629"></a><span id="l21.629"> </span>
<a href="#l21.630"></a><span id="l21.630"> /**</span>
<a href="#l21.631"></a><span id="l21.631" class="difflineminus">- * Handles the &quot;Create New Calendar&quot; Wizard</span>
<a href="#l21.632"></a><span id="l21.632" class="difflineplus">+ * Handles the &quot;Create New Calendar&quot; Wizard.</span>
<a href="#l21.633"></a><span id="l21.633">  *</span>
<a href="#l21.634"></a><span id="l21.634">  * @param wizard            wizard dialog controller</span>
<a href="#l21.635"></a><span id="l21.635">  * @param name              calendar name</span>
<a href="#l21.636"></a><span id="l21.636">  * @param data              (optional) dataset object</span>
<a href="#l21.637"></a><span id="l21.637">  *                              showReminders - false to disable reminders</span>
<a href="#l21.638"></a><span id="l21.638">  *                              eMail - id of eMail account</span>
<a href="#l21.639"></a><span id="l21.639">  *                              network.format - ics/caldav/wcap</span>
<a href="#l21.640"></a><span id="l21.640">  *                              network.location - URI (undefined for local ICS)</span>
<a href="#l21.641"></a><span id="l21.641" class="difflineat">@@ -490,346 +523,110 @@ function createCalendar(controller, name</span>
<a href="#l21.642"></a><span id="l21.642">  */</span>
<a href="#l21.643"></a><span id="l21.643"> function handleNewCalendarWizard(wizard, name, data = undefined) {</span>
<a href="#l21.644"></a><span id="l21.644">     let { lookup: wizardlookup, eid: wizardId } = helpersForController(wizard);</span>
<a href="#l21.645"></a><span id="l21.645">     let dlgButton = (btn) =&gt; wizard.window.document.documentElement.getButton(btn);</span>
<a href="#l21.646"></a><span id="l21.646">     if (data == undefined) {</span>
<a href="#l21.647"></a><span id="l21.647">         data = {};</span>
<a href="#l21.648"></a><span id="l21.648">     }</span>
<a href="#l21.649"></a><span id="l21.649"> </span>
<a href="#l21.650"></a><span id="l21.650" class="difflineminus">-    // choose network calendar if any network data is set.</span>
<a href="#l21.651"></a><span id="l21.651" class="difflineplus">+    // Choose network calendar if any network data is set.</span>
<a href="#l21.652"></a><span id="l21.652">     if (data.network) {</span>
<a href="#l21.653"></a><span id="l21.653">         let remoteOption = wizardlookup(`</span>
<a href="#l21.654"></a><span id="l21.654" class="difflineminus">-            /id(&quot;calendar-wizard&quot;)/{&quot;pageid&quot;:&quot;initialPage&quot;}/</span>
<a href="#l21.655"></a><span id="l21.655" class="difflineminus">-            id(&quot;calendar-type&quot;)/{&quot;value&quot;:&quot;remote&quot;}</span>
<a href="#l21.656"></a><span id="l21.656" class="difflineplus">+            /id(&quot;calendar-wizard&quot;)/{&quot;pageid&quot;:&quot;initialPage&quot;}/id(&quot;calendar-type&quot;)/{&quot;value&quot;:&quot;remote&quot;}</span>
<a href="#l21.657"></a><span id="l21.657">         `);</span>
<a href="#l21.658"></a><span id="l21.658">         wizard.waitForElement(remoteOption);</span>
<a href="#l21.659"></a><span id="l21.659">         wizard.radio(remoteOption);</span>
<a href="#l21.660"></a><span id="l21.660">         dlgButton(&quot;next&quot;).doCommand();</span>
<a href="#l21.661"></a><span id="l21.661"> </span>
<a href="#l21.662"></a><span id="l21.662" class="difflineminus">-        // choose format</span>
<a href="#l21.663"></a><span id="l21.663" class="difflineplus">+        // Choose format.</span>
<a href="#l21.664"></a><span id="l21.664">         if (data.network.format == undefined) {</span>
<a href="#l21.665"></a><span id="l21.665">             data.network.format = &quot;ics&quot;;</span>
<a href="#l21.666"></a><span id="l21.666">         }</span>
<a href="#l21.667"></a><span id="l21.667">         let formatOption = wizardlookup(`</span>
<a href="#l21.668"></a><span id="l21.668">             /id(&quot;calendar-wizard&quot;)/{&quot;pageid&quot;:&quot;locationPage&quot;}/[1]/[1]/[0]/</span>
<a href="#l21.669"></a><span id="l21.669">             id(&quot;calendar-format&quot;)/{&quot;value&quot;:&quot;${data.network.format}&quot;}</span>
<a href="#l21.670"></a><span id="l21.670">         `);</span>
<a href="#l21.671"></a><span id="l21.671">         wizard.waitForElement(formatOption);</span>
<a href="#l21.672"></a><span id="l21.672">         wizard.radio(formatOption);</span>
<a href="#l21.673"></a><span id="l21.673"> </span>
<a href="#l21.674"></a><span id="l21.674" class="difflineminus">-        // enter location</span>
<a href="#l21.675"></a><span id="l21.675" class="difflineplus">+        // Enter location.</span>
<a href="#l21.676"></a><span id="l21.676">         if (data.network.location == undefined) {</span>
<a href="#l21.677"></a><span id="l21.677">             let calendarFile = Services.dirsvc.get(&quot;TmpD&quot;, Ci.nsIFile);</span>
<a href="#l21.678"></a><span id="l21.678">             calendarFile.append(name + &quot;.ics&quot;);</span>
<a href="#l21.679"></a><span id="l21.679">             let fileURI = Services.io.newFileURI(calendarFile);</span>
<a href="#l21.680"></a><span id="l21.680">             data.network.location = fileURI.prePath + fileURI.pathQueryRef;</span>
<a href="#l21.681"></a><span id="l21.681">         }</span>
<a href="#l21.682"></a><span id="l21.682">         wizard.type(wizardlookup(`</span>
<a href="#l21.683"></a><span id="l21.683" class="difflineminus">-            /id(&quot;calendar-wizard&quot;)/{&quot;pageid&quot;:&quot;locationPage&quot;}/[1]/[1]/</span>
<a href="#l21.684"></a><span id="l21.684" class="difflineminus">-            {&quot;align&quot;:&quot;center&quot;}/id(&quot;calendar-uri&quot;)/</span>
<a href="#l21.685"></a><span id="l21.685" class="difflineminus">-            anon({&quot;anonid&quot;:&quot;moz-input-box&quot;})/anon({&quot;anonid&quot;:&quot;input&quot;})</span>
<a href="#l21.686"></a><span id="l21.686" class="difflineplus">+            /id(&quot;calendar-wizard&quot;)/{&quot;pageid&quot;:&quot;locationPage&quot;}/[1]/[1]/{&quot;align&quot;:&quot;center&quot;}/</span>
<a href="#l21.687"></a><span id="l21.687" class="difflineplus">+            id(&quot;calendar-uri&quot;)/anon({&quot;anonid&quot;:&quot;moz-input-box&quot;})/anon({&quot;anonid&quot;:&quot;input&quot;})</span>
<a href="#l21.688"></a><span id="l21.688">         `), data.network.location);</span>
<a href="#l21.689"></a><span id="l21.689"> </span>
<a href="#l21.690"></a><span id="l21.690" class="difflineminus">-        // choose offline support</span>
<a href="#l21.691"></a><span id="l21.691" class="difflineplus">+        // Choose offline support.</span>
<a href="#l21.692"></a><span id="l21.692">         if (data.network.offline == undefined) {</span>
<a href="#l21.693"></a><span id="l21.693">             data.network.offline = true;</span>
<a href="#l21.694"></a><span id="l21.694">         }</span>
<a href="#l21.695"></a><span id="l21.695">         wizard.check(wizardId(&quot;cache&quot;), data.network.offline);</span>
<a href="#l21.696"></a><span id="l21.696">         wizard.waitFor(() =&gt; !dlgButton(&quot;next&quot;).disabled);</span>
<a href="#l21.697"></a><span id="l21.697">         dlgButton(&quot;next&quot;).doCommand();</span>
<a href="#l21.698"></a><span id="l21.698">     } else {</span>
<a href="#l21.699"></a><span id="l21.699" class="difflineminus">-        // local calendar is default</span>
<a href="#l21.700"></a><span id="l21.700" class="difflineplus">+        // Local calendar is default.</span>
<a href="#l21.701"></a><span id="l21.701">         dlgButton(&quot;next&quot;).doCommand();</span>
<a href="#l21.702"></a><span id="l21.702">     }</span>
<a href="#l21.703"></a><span id="l21.703" class="difflineminus">-    // set calendar Name</span>
<a href="#l21.704"></a><span id="l21.704" class="difflineplus">+    // Set calendar Name.</span>
<a href="#l21.705"></a><span id="l21.705">     wizard.waitForElement(wizardId(&quot;calendar-name&quot;));</span>
<a href="#l21.706"></a><span id="l21.706" class="difflineminus">-    // not on all platforms setting the value activates the next button</span>
<a href="#l21.707"></a><span id="l21.707" class="difflineminus">-    // so we need to type in case the field is empty</span>
<a href="#l21.708"></a><span id="l21.708" class="difflineplus">+    // Not on all platforms setting the value activates the next button,</span>
<a href="#l21.709"></a><span id="l21.709" class="difflineplus">+    // so we need to type in case the field is empty.</span>
<a href="#l21.710"></a><span id="l21.710">     if (wizardId(&quot;calendar-name&quot;).getNode().value == &quot;&quot;) {</span>
<a href="#l21.711"></a><span id="l21.711">         wizard.type(wizardId(&quot;calendar-name&quot;), name);</span>
<a href="#l21.712"></a><span id="l21.712" class="difflineminus">-    } // else the name is already filled in from URI</span>
<a href="#l21.713"></a><span id="l21.713" class="difflineplus">+    } // Else the name is already filled in from URI.</span>
<a href="#l21.714"></a><span id="l21.714"> </span>
<a href="#l21.715"></a><span id="l21.715" class="difflineminus">-    // set reminder Option</span>
<a href="#l21.716"></a><span id="l21.716" class="difflineplus">+    // Set reminder Option.</span>
<a href="#l21.717"></a><span id="l21.717">     if (data.showReminders == undefined) {</span>
<a href="#l21.718"></a><span id="l21.718">         data.showReminders = true;</span>
<a href="#l21.719"></a><span id="l21.719">     }</span>
<a href="#l21.720"></a><span id="l21.720">     wizard.check(wizardId(&quot;fire-alarms&quot;), data.showReminders);</span>
<a href="#l21.721"></a><span id="l21.721"> </span>
<a href="#l21.722"></a><span id="l21.722" class="difflineminus">-    // set eMail Account</span>
<a href="#l21.723"></a><span id="l21.723" class="difflineplus">+    // Set eMail Account.</span>
<a href="#l21.724"></a><span id="l21.724">     if (data.eMail == undefined) {</span>
<a href="#l21.725"></a><span id="l21.725">         data.eMail = &quot;none&quot;;</span>
<a href="#l21.726"></a><span id="l21.726">     }</span>
<a href="#l21.727"></a><span id="l21.727">     menulistSelect(wizardId(&quot;email-identity-menulist&quot;), data.eMail, wizard);</span>
<a href="#l21.728"></a><span id="l21.728">     wizard.waitFor(() =&gt; !dlgButton(&quot;next&quot;).disabled);</span>
<a href="#l21.729"></a><span id="l21.729">     dlgButton(&quot;next&quot;).doCommand();</span>
<a href="#l21.730"></a><span id="l21.730"> </span>
<a href="#l21.731"></a><span id="l21.731">     // finish</span>
<a href="#l21.732"></a><span id="l21.732">     dlgButton(&quot;finish&quot;).doCommand();</span>
<a href="#l21.733"></a><span id="l21.733"> }</span>
<a href="#l21.734"></a><span id="l21.734"> </span>
<a href="#l21.735"></a><span id="l21.735"> /**</span>
<a href="#l21.736"></a><span id="l21.736" class="difflineminus">- * Retrieves array of all calendar-event-box elements in node</span>
<a href="#l21.737"></a><span id="l21.737" class="difflineplus">+ * Retrieves array of all calendar-event-box elements in node.</span>
<a href="#l21.738"></a><span id="l21.738">  *</span>
<a href="#l21.739"></a><span id="l21.739" class="difflineminus">- * @param node          node to be searched</span>
<a href="#l21.740"></a><span id="l21.740" class="difflineminus">- * @param eventNodes    array where to put resultíng nodes</span>
<a href="#l21.741"></a><span id="l21.741" class="difflineplus">+ * @param node          Node to be searched.</span>
<a href="#l21.742"></a><span id="l21.742" class="difflineplus">+ * @param eventNodes    Array where to put resulting nodes.</span>
<a href="#l21.743"></a><span id="l21.743">  */</span>
<a href="#l21.744"></a><span id="l21.744"> function findEventsInNode(node, eventNodes) {</span>
<a href="#l21.745"></a><span id="l21.745">     if (node.tagName == &quot;calendar-event-box&quot;) {</span>
<a href="#l21.746"></a><span id="l21.746">         eventNodes.push(node);</span>
<a href="#l21.747"></a><span id="l21.747">     } else if (node.children.length &gt; 0) {</span>
<a href="#l21.748"></a><span id="l21.748">         for (let child of node.children) {</span>
<a href="#l21.749"></a><span id="l21.749">             findEventsInNode(child, eventNodes);</span>
<a href="#l21.750"></a><span id="l21.750">         }</span>
<a href="#l21.751"></a><span id="l21.751">     }</span>
<a href="#l21.752"></a><span id="l21.752"> }</span>
<a href="#l21.753"></a><span id="l21.753"> </span>
<a href="#l21.754"></a><span id="l21.754" class="difflineminus">-/**</span>
<a href="#l21.755"></a><span id="l21.755" class="difflineminus">- * Helper function to enter event/task dialog data</span>
<a href="#l21.756"></a><span id="l21.756" class="difflineminus">- *</span>
<a href="#l21.757"></a><span id="l21.757" class="difflineminus">- * @param dialog        event/task dialog controller</span>
<a href="#l21.758"></a><span id="l21.758" class="difflineminus">- * @param iframe        event/task dialog iframe controller</span>
<a href="#l21.759"></a><span id="l21.759" class="difflineminus">- * @param data          dataset object</span>
<a href="#l21.760"></a><span id="l21.760" class="difflineminus">- *                          title - event/task title</span>
<a href="#l21.761"></a><span id="l21.761" class="difflineminus">- *                          location - event/task location</span>
<a href="#l21.762"></a><span id="l21.762" class="difflineminus">- *                          description - event/task description</span>
<a href="#l21.763"></a><span id="l21.763" class="difflineminus">- *                          category - category label</span>
<a href="#l21.764"></a><span id="l21.764" class="difflineminus">- *                          calendar - calendar the item should be in</span>
<a href="#l21.765"></a><span id="l21.765" class="difflineminus">- *                          allday - boolean value</span>
<a href="#l21.766"></a><span id="l21.766" class="difflineminus">- *                          startdate - Date object</span>
<a href="#l21.767"></a><span id="l21.767" class="difflineminus">- *                          starttime - Date object</span>
<a href="#l21.768"></a><span id="l21.768" class="difflineminus">- *                          enddate - Date object</span>
<a href="#l21.769"></a><span id="l21.769" class="difflineminus">- *                          endtime - Date object</span>
<a href="#l21.770"></a><span id="l21.770" class="difflineminus">- *                          repeat - reccurrence value, one of none/daily/weekly/</span>
<a href="#l21.771"></a><span id="l21.771" class="difflineminus">- *                                   every.weekday/bi.weekly/</span>
<a href="#l21.772"></a><span id="l21.772" class="difflineminus">- *                                   monthly/yearly</span>
<a href="#l21.773"></a><span id="l21.773" class="difflineminus">- *                                   (custom is not supported)</span>
<a href="#l21.774"></a><span id="l21.774" class="difflineminus">- *                          reminder - reminder option index (custom not supp.)</span>
<a href="#l21.775"></a><span id="l21.775" class="difflineminus">- *                          priority - none/low/normal/high</span>
<a href="#l21.776"></a><span id="l21.776" class="difflineminus">- *                          privacy - public/confidential/private</span>
<a href="#l21.777"></a><span id="l21.777" class="difflineminus">- *                          status - none/tentative/confirmed/canceled for events</span>
<a href="#l21.778"></a><span id="l21.778" class="difflineminus">- *                                   none/needs-action/in-process/completed/cancelled for tasks</span>
<a href="#l21.779"></a><span id="l21.779" class="difflineminus">- *                          completed - Date object for tasks</span>
<a href="#l21.780"></a><span id="l21.780" class="difflineminus">- *                          percent - percent complete for tasks</span>
<a href="#l21.781"></a><span id="l21.781" class="difflineminus">- *                          freebusy - free/busy</span>
<a href="#l21.782"></a><span id="l21.782" class="difflineminus">- *                          attachment.add - url to add</span>
<a href="#l21.783"></a><span id="l21.783" class="difflineminus">- *                          attachment.remove - label of url to remove (without http://)</span>
<a href="#l21.784"></a><span id="l21.784" class="difflineminus">- */</span>
<a href="#l21.785"></a><span id="l21.785" class="difflineminus">-function setData(dialog, iframe, data) {</span>
<a href="#l21.786"></a><span id="l21.786" class="difflineminus">-    let { eid, sleep } = helpersForController(dialog);</span>
<a href="#l21.787"></a><span id="l21.787" class="difflineminus">-    let { lookup: iframeLookup, eid: iframeId } = helpersForController(iframe);</span>
<a href="#l21.788"></a><span id="l21.788" class="difflineminus">-</span>
<a href="#l21.789"></a><span id="l21.789" class="difflineminus">-    let eventIframe = '/id(&quot;calendar-event-dialog-inner&quot;)/id(&quot;event-grid&quot;)/id(&quot;event-grid-rows&quot;)/';</span>
<a href="#l21.790"></a><span id="l21.790" class="difflineminus">-    let taskIframe = '/id(&quot;calendar-task-dialog-inner&quot;)/id(&quot;event-grid&quot;)/id(&quot;event-grid-rows&quot;)/';</span>
<a href="#l21.791"></a><span id="l21.791" class="difflineminus">-    let innerFrame;</span>
<a href="#l21.792"></a><span id="l21.792" class="difflineminus">-    let isEvent = true;</span>
<a href="#l21.793"></a><span id="l21.793" class="difflineminus">-</span>
<a href="#l21.794"></a><span id="l21.794" class="difflineminus">-    // see if it's an event dialog</span>
<a href="#l21.795"></a><span id="l21.795" class="difflineminus">-    try {</span>
<a href="#l21.796"></a><span id="l21.796" class="difflineminus">-        iframeLookup(eventIframe).getNode();</span>
<a href="#l21.797"></a><span id="l21.797" class="difflineminus">-        innerFrame = eventIframe;</span>
<a href="#l21.798"></a><span id="l21.798" class="difflineminus">-    } catch (error) {</span>
<a href="#l21.799"></a><span id="l21.799" class="difflineminus">-        innerFrame = taskIframe;</span>
<a href="#l21.800"></a><span id="l21.800" class="difflineminus">-        isEvent = false;</span>
<a href="#l21.801"></a><span id="l21.801" class="difflineminus">-    }</span>
<a href="#l21.802"></a><span id="l21.802" class="difflineminus">-</span>
<a href="#l21.803"></a><span id="l21.803" class="difflineminus">-    let dateInput = `</span>
<a href="#l21.804"></a><span id="l21.804" class="difflineminus">-        anon({&quot;class&quot;:&quot;datepicker-box-class&quot;})/{&quot;class&quot;:&quot;datepicker-text-class&quot;}/</span>
<a href="#l21.805"></a><span id="l21.805" class="difflineminus">-        anon({&quot;class&quot;:&quot;menulist-editable-box textbox-input-box&quot;})/</span>
<a href="#l21.806"></a><span id="l21.806" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;input&quot;})</span>
<a href="#l21.807"></a><span id="l21.807" class="difflineminus">-    `;</span>
<a href="#l21.808"></a><span id="l21.808" class="difflineminus">-    let timeInput = `</span>
<a href="#l21.809"></a><span id="l21.809" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;hbox&quot;})/anon({&quot;anonid&quot;:&quot;time-picker&quot;})/</span>
<a href="#l21.810"></a><span id="l21.810" class="difflineminus">-        anon({&quot;class&quot;:&quot;timepicker-box-class&quot;})/</span>
<a href="#l21.811"></a><span id="l21.811" class="difflineminus">-        anon({&quot;class&quot;:&quot;timepicker-text-class&quot;})/anon({&quot;flex&quot;:&quot;1&quot;})/</span>
<a href="#l21.812"></a><span id="l21.812" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;input&quot;})</span>
<a href="#l21.813"></a><span id="l21.813" class="difflineminus">-    `;</span>
<a href="#l21.814"></a><span id="l21.814" class="difflineminus">-    let startId = isEvent ? &quot;event-starttime&quot; : &quot;todo-entrydate&quot;;</span>
<a href="#l21.815"></a><span id="l21.815" class="difflineminus">-    let startDateInput = iframeLookup(`</span>
<a href="#l21.816"></a><span id="l21.816" class="difflineminus">-        ${innerFrame}/id(&quot;event-grid-startdate-row&quot;)/</span>
<a href="#l21.817"></a><span id="l21.817" class="difflineminus">-        id(&quot;event-grid-startdate-picker-box&quot;)/id(&quot;${startId}&quot;)/</span>
<a href="#l21.818"></a><span id="l21.818" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;hbox&quot;})/anon({&quot;anonid&quot;:&quot;date-picker&quot;})/${dateInput}</span>
<a href="#l21.819"></a><span id="l21.819" class="difflineminus">-    `);</span>
<a href="#l21.820"></a><span id="l21.820" class="difflineminus">-    let endId = isEvent ? &quot;event-endtime&quot; : &quot;todo-duedate&quot;;</span>
<a href="#l21.821"></a><span id="l21.821" class="difflineminus">-    let endDateInput = iframeLookup(`</span>
<a href="#l21.822"></a><span id="l21.822" class="difflineminus">-        ${innerFrame}id(&quot;event-grid-enddate-row&quot;)/[1]/</span>
<a href="#l21.823"></a><span id="l21.823" class="difflineminus">-        id(&quot;event-grid-enddate-picker-box&quot;)/id(&quot;${endId}&quot;)/</span>
<a href="#l21.824"></a><span id="l21.824" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;hbox&quot;})/anon({&quot;anonid&quot;:&quot;date-picker&quot;})/${dateInput}</span>
<a href="#l21.825"></a><span id="l21.825" class="difflineminus">-    `);</span>
<a href="#l21.826"></a><span id="l21.826" class="difflineminus">-    let startTimeInput = iframeLookup(`</span>
<a href="#l21.827"></a><span id="l21.827" class="difflineminus">-        ${innerFrame}/id(&quot;event-grid-startdate-row&quot;)/</span>
<a href="#l21.828"></a><span id="l21.828" class="difflineminus">-        id(&quot;event-grid-startdate-picker-box&quot;)/id(&quot;${startId}&quot;)/${timeInput}</span>
<a href="#l21.829"></a><span id="l21.829" class="difflineminus">-    `);</span>
<a href="#l21.830"></a><span id="l21.830" class="difflineminus">-    let endTimeInput = iframeLookup(`</span>
<a href="#l21.831"></a><span id="l21.831" class="difflineminus">-        ${innerFrame}/id(&quot;event-grid-enddate-row&quot;)/[1]/</span>
<a href="#l21.832"></a><span id="l21.832" class="difflineminus">-        id(&quot;event-grid-enddate-picker-box&quot;)/id(&quot;${endId}&quot;)/${timeInput}</span>
<a href="#l21.833"></a><span id="l21.833" class="difflineminus">-    `);</span>
<a href="#l21.834"></a><span id="l21.834" class="difflineminus">-    let completedDateInput = iframeLookup(`</span>
<a href="#l21.835"></a><span id="l21.835" class="difflineminus">-        ${innerFrame}/id(&quot;event-grid-todo-status-row&quot;)/</span>
<a href="#l21.836"></a><span id="l21.836" class="difflineminus">-        id(&quot;event-grid-todo-status-picker-box&quot;)/id(&quot;completed-date-picker&quot;)/${dateInput}</span>
<a href="#l21.837"></a><span id="l21.837" class="difflineminus">-    `);</span>
<a href="#l21.838"></a><span id="l21.838" class="difflineminus">-    let dateFormatter = cal.getDateFormatter();</span>
<a href="#l21.839"></a><span id="l21.839" class="difflineminus">-    // wait for input elements' values to be populated</span>
<a href="#l21.840"></a><span id="l21.840" class="difflineminus">-    sleep();</span>
<a href="#l21.841"></a><span id="l21.841" class="difflineminus">-</span>
<a href="#l21.842"></a><span id="l21.842" class="difflineminus">-    // title</span>
<a href="#l21.843"></a><span id="l21.843" class="difflineminus">-    if (data.title != undefined) {</span>
<a href="#l21.844"></a><span id="l21.844" class="difflineminus">-        // we need to set directly here in case there is already a title.</span>
<a href="#l21.845"></a><span id="l21.845" class="difflineminus">-        // accelKey+a won't work in all OS</span>
<a href="#l21.846"></a><span id="l21.846" class="difflineminus">-        iframeId(&quot;item-title&quot;).getNode().value = data.title;</span>
<a href="#l21.847"></a><span id="l21.847" class="difflineminus">-    }</span>
<a href="#l21.848"></a><span id="l21.848" class="difflineminus">-</span>
<a href="#l21.849"></a><span id="l21.849" class="difflineminus">-    // location</span>
<a href="#l21.850"></a><span id="l21.850" class="difflineminus">-    if (data.location != undefined) {</span>
<a href="#l21.851"></a><span id="l21.851" class="difflineminus">-        // see comment above</span>
<a href="#l21.852"></a><span id="l21.852" class="difflineminus">-        iframeId(&quot;item-location&quot;).getNode().value = data.location;</span>
<a href="#l21.853"></a><span id="l21.853" class="difflineminus">-    }</span>
<a href="#l21.854"></a><span id="l21.854" class="difflineminus">-</span>
<a href="#l21.855"></a><span id="l21.855" class="difflineminus">-    // category</span>
<a href="#l21.856"></a><span id="l21.856" class="difflineminus">-    // TODO: needs adjustment for the menulist-panel now used for categories.</span>
<a href="#l21.857"></a><span id="l21.857" class="difflineminus">-    // will be fixed with Bug 984044</span>
<a href="#l21.858"></a><span id="l21.858" class="difflineminus">-    if (data.category != undefined) {</span>
<a href="#l21.859"></a><span id="l21.859" class="difflineminus">-        menulistSelect(iframeId(&quot;item-categories&quot;), data.category, dialog);</span>
<a href="#l21.860"></a><span id="l21.860" class="difflineminus">-    }</span>
<a href="#l21.861"></a><span id="l21.861" class="difflineminus">-</span>
<a href="#l21.862"></a><span id="l21.862" class="difflineminus">-    // calendar</span>
<a href="#l21.863"></a><span id="l21.863" class="difflineminus">-    if (data.calendar != undefined) {</span>
<a href="#l21.864"></a><span id="l21.864" class="difflineminus">-        menulistSelect(iframeId(&quot;item-calendar&quot;), data.calendar, dialog);</span>
<a href="#l21.865"></a><span id="l21.865" class="difflineminus">-    }</span>
<a href="#l21.866"></a><span id="l21.866" class="difflineminus">-</span>
<a href="#l21.867"></a><span id="l21.867" class="difflineminus">-    // all-day</span>
<a href="#l21.868"></a><span id="l21.868" class="difflineminus">-    if (data.allday != undefined &amp;&amp; isEvent) {</span>
<a href="#l21.869"></a><span id="l21.869" class="difflineminus">-        dialog.check(iframeId(&quot;event-all-day&quot;), data.allday);</span>
<a href="#l21.870"></a><span id="l21.870" class="difflineminus">-    }</span>
<a href="#l21.871"></a><span id="l21.871" class="difflineminus">-</span>
<a href="#l21.872"></a><span id="l21.872" class="difflineminus">-    // startdate</span>
<a href="#l21.873"></a><span id="l21.873" class="difflineminus">-    if (data.startdate != undefined &amp;&amp; data.startdate.constructor.name == &quot;Date&quot;) {</span>
<a href="#l21.874"></a><span id="l21.874" class="difflineminus">-        let startdate = dateFormatter.formatDateShort(cal.dtz.jsDateToDateTime(data.startdate, cal.dtz.floating));</span>
<a href="#l21.875"></a><span id="l21.875" class="difflineminus">-</span>
<a href="#l21.876"></a><span id="l21.876" class="difflineminus">-        if (!isEvent) {</span>
<a href="#l21.877"></a><span id="l21.877" class="difflineminus">-            dialog.check(iframeId(&quot;todo-has-entrydate&quot;), true);</span>
<a href="#l21.878"></a><span id="l21.878" class="difflineminus">-        }</span>
<a href="#l21.879"></a><span id="l21.879" class="difflineminus">-        dialog.keypress(startDateInput, &quot;a&quot;, { accelKey: true });</span>
<a href="#l21.880"></a><span id="l21.880" class="difflineminus">-        dialog.type(startDateInput, startdate);</span>
<a href="#l21.881"></a><span id="l21.881" class="difflineminus">-    }</span>
<a href="#l21.882"></a><span id="l21.882" class="difflineminus">-</span>
<a href="#l21.883"></a><span id="l21.883" class="difflineminus">-    // starttime</span>
<a href="#l21.884"></a><span id="l21.884" class="difflineminus">-    if (data.starttime != undefined &amp;&amp; data.starttime.constructor.name == &quot;Date&quot;) {</span>
<a href="#l21.885"></a><span id="l21.885" class="difflineminus">-        let starttime = dateFormatter.formatTime(cal.dtz.jsDateToDateTime(data.starttime, cal.dtz.floating));</span>
<a href="#l21.886"></a><span id="l21.886" class="difflineminus">-        dialog.click(startTimeInput);</span>
<a href="#l21.887"></a><span id="l21.887" class="difflineminus">-        dialog.keypress(startTimeInput, &quot;a&quot;, { accelKey: true });</span>
<a href="#l21.888"></a><span id="l21.888" class="difflineminus">-        dialog.type(startTimeInput, starttime);</span>
<a href="#l21.889"></a><span id="l21.889" class="difflineminus">-    }</span>
<a href="#l21.890"></a><span id="l21.890" class="difflineminus">-</span>
<a href="#l21.891"></a><span id="l21.891" class="difflineminus">-    // enddate</span>
<a href="#l21.892"></a><span id="l21.892" class="difflineminus">-    if (data.enddate != undefined &amp;&amp; data.enddate.constructor.name == &quot;Date&quot;) {</span>
<a href="#l21.893"></a><span id="l21.893" class="difflineminus">-        let enddate = dateFormatter.formatDateShort(cal.dtz.jsDateToDateTime(data.enddate, cal.dtz.floating));</span>
<a href="#l21.894"></a><span id="l21.894" class="difflineminus">-        if (!isEvent) {</span>
<a href="#l21.895"></a><span id="l21.895" class="difflineminus">-            dialog.check(iframeId(&quot;todo-has-duedate&quot;), true);</span>
<a href="#l21.896"></a><span id="l21.896" class="difflineminus">-        }</span>
<a href="#l21.897"></a><span id="l21.897" class="difflineminus">-        dialog.keypress(endDateInput, &quot;a&quot;, { accelKey: true });</span>
<a href="#l21.898"></a><span id="l21.898" class="difflineminus">-        dialog.type(endDateInput, enddate);</span>
<a href="#l21.899"></a><span id="l21.899" class="difflineminus">-    }</span>
<a href="#l21.900"></a><span id="l21.900" class="difflineminus">-</span>
<a href="#l21.901"></a><span id="l21.901" class="difflineminus">-    // endtime</span>
<a href="#l21.902"></a><span id="l21.902" class="difflineminus">-    if (data.endtime != undefined &amp;&amp; data.endtime.constructor.name == &quot;Date&quot;) {</span>
<a href="#l21.903"></a><span id="l21.903" class="difflineminus">-        let endtime = dateFormatter.formatTime(cal.dtz.jsDateToDateTime(data.endtime, cal.dtz.floating));</span>
<a href="#l21.904"></a><span id="l21.904" class="difflineminus">-        dialog.click(endTimeInput);</span>
<a href="#l21.905"></a><span id="l21.905" class="difflineminus">-        dialog.keypress(endTimeInput, &quot;a&quot;, { accelKey: true });</span>
<a href="#l21.906"></a><span id="l21.906" class="difflineminus">-        dialog.type(endTimeInput, endtime);</span>
<a href="#l21.907"></a><span id="l21.907" class="difflineminus">-    }</span>
<a href="#l21.908"></a><span id="l21.908" class="difflineminus">-</span>
<a href="#l21.909"></a><span id="l21.909" class="difflineminus">-    // recurrence</span>
<a href="#l21.910"></a><span id="l21.910" class="difflineminus">-    if (data.repeat != undefined) {</span>
<a href="#l21.911"></a><span id="l21.911" class="difflineminus">-        menulistSelect(iframeId(&quot;item-repeat&quot;), data.repeat, dialog);</span>
<a href="#l21.912"></a><span id="l21.912" class="difflineminus">-    }</span>
<a href="#l21.913"></a><span id="l21.913" class="difflineminus">-</span>
<a href="#l21.914"></a><span id="l21.914" class="difflineminus">-    // reminder</span>
<a href="#l21.915"></a><span id="l21.915" class="difflineminus">-    // TODO: menulistSelect does not work here, because menuitems have no value.</span>
<a href="#l21.916"></a><span id="l21.916" class="difflineminus">-    // will be fixed with Bug 984044</span>
<a href="#l21.917"></a><span id="l21.917" class="difflineminus">-    if (data.reminder != undefined) {</span>
<a href="#l21.918"></a><span id="l21.918" class="difflineminus">-        menulistSelect(iframeId(&quot;item-alarm&quot;), data.reminder, dialog);</span>
<a href="#l21.919"></a><span id="l21.919" class="difflineminus">-    }</span>
<a href="#l21.920"></a><span id="l21.920" class="difflineminus">-</span>
<a href="#l21.921"></a><span id="l21.921" class="difflineminus">-    // description</span>
<a href="#l21.922"></a><span id="l21.922" class="difflineminus">-    if (data.description != undefined) {</span>
<a href="#l21.923"></a><span id="l21.923" class="difflineminus">-        let descField = iframeId(&quot;item-description&quot;);</span>
<a href="#l21.924"></a><span id="l21.924" class="difflineminus">-        descField.getNode().value = data.description;</span>
<a href="#l21.925"></a><span id="l21.925" class="difflineminus">-    }</span>
<a href="#l21.926"></a><span id="l21.926" class="difflineminus">-</span>
<a href="#l21.927"></a><span id="l21.927" class="difflineminus">-    // priority</span>
<a href="#l21.928"></a><span id="l21.928" class="difflineminus">-    if (data.priority != undefined) {</span>
<a href="#l21.929"></a><span id="l21.929" class="difflineminus">-        dialog.mainMenu.click(`#options-priority-${data.priority}-label`);</span>
<a href="#l21.930"></a><span id="l21.930" class="difflineminus">-    }</span>
<a href="#l21.931"></a><span id="l21.931" class="difflineminus">-</span>
<a href="#l21.932"></a><span id="l21.932" class="difflineminus">-    // privacy</span>
<a href="#l21.933"></a><span id="l21.933" class="difflineminus">-    if (data.privacy != undefined) {</span>
<a href="#l21.934"></a><span id="l21.934" class="difflineminus">-        dialog.mainMenu.click(`#options-privacy-${data.privacy}-menuitem`);</span>
<a href="#l21.935"></a><span id="l21.935" class="difflineminus">-    }</span>
<a href="#l21.936"></a><span id="l21.936" class="difflineminus">-</span>
<a href="#l21.937"></a><span id="l21.937" class="difflineminus">-    // status</span>
<a href="#l21.938"></a><span id="l21.938" class="difflineminus">-    if (data.status != undefined) {</span>
<a href="#l21.939"></a><span id="l21.939" class="difflineminus">-        if (isEvent) {</span>
<a href="#l21.940"></a><span id="l21.940" class="difflineminus">-            dialog.mainMenu.click(`#options-status-${data.status}-menuitem`);</span>
<a href="#l21.941"></a><span id="l21.941" class="difflineminus">-        } else {</span>
<a href="#l21.942"></a><span id="l21.942" class="difflineminus">-            menulistSelect(iframeId(&quot;todo-status&quot;), data.status.toUpperCase(), dialog);</span>
<a href="#l21.943"></a><span id="l21.943" class="difflineminus">-        }</span>
<a href="#l21.944"></a><span id="l21.944" class="difflineminus">-    }</span>
<a href="#l21.945"></a><span id="l21.945" class="difflineminus">-</span>
<a href="#l21.946"></a><span id="l21.946" class="difflineminus">-    let currentStatus = iframeId(&quot;todo-status&quot;).getNode().value;</span>
<a href="#l21.947"></a><span id="l21.947" class="difflineminus">-</span>
<a href="#l21.948"></a><span id="l21.948" class="difflineminus">-    // completed on</span>
<a href="#l21.949"></a><span id="l21.949" class="difflineminus">-    if (data.completed != undefined &amp;&amp; data.completed.constructor.name == &quot;Date&quot; &amp;&amp; !isEvent) {</span>
<a href="#l21.950"></a><span id="l21.950" class="difflineminus">-        let completeddate = dateFormatter.formatDateShort(cal.dtz.jsDateToDateTime(data.completed, cal.dtz.floating));</span>
<a href="#l21.951"></a><span id="l21.951" class="difflineminus">-</span>
<a href="#l21.952"></a><span id="l21.952" class="difflineminus">-        if (currentStatus == &quot;COMPLETED&quot;) {</span>
<a href="#l21.953"></a><span id="l21.953" class="difflineminus">-            completedDateInput.getNode().value = completeddate;</span>
<a href="#l21.954"></a><span id="l21.954" class="difflineminus">-        }</span>
<a href="#l21.955"></a><span id="l21.955" class="difflineminus">-    }</span>
<a href="#l21.956"></a><span id="l21.956" class="difflineminus">-</span>
<a href="#l21.957"></a><span id="l21.957" class="difflineminus">-    // percent complete</span>
<a href="#l21.958"></a><span id="l21.958" class="difflineminus">-    if (data.percent != undefined &amp;&amp;</span>
<a href="#l21.959"></a><span id="l21.959" class="difflineminus">-        (currentStatus == &quot;NEEDS-ACTION&quot; ||</span>
<a href="#l21.960"></a><span id="l21.960" class="difflineminus">-         currentStatus == &quot;IN-PROCESS&quot; ||</span>
<a href="#l21.961"></a><span id="l21.961" class="difflineminus">-         currentStatus == &quot;COMPLETED&quot;)) {</span>
<a href="#l21.962"></a><span id="l21.962" class="difflineminus">-        iframeId(&quot;percent-complete-textbox&quot;).getNode().value = data.percent;</span>
<a href="#l21.963"></a><span id="l21.963" class="difflineminus">-    }</span>
<a href="#l21.964"></a><span id="l21.964" class="difflineminus">-</span>
<a href="#l21.965"></a><span id="l21.965" class="difflineminus">-    // free/busy</span>
<a href="#l21.966"></a><span id="l21.966" class="difflineminus">-    if (data.freebusy != undefined) {</span>
<a href="#l21.967"></a><span id="l21.967" class="difflineminus">-        dialog.mainMenu.click(`#options-freebusy-${data.freebusy}-menuitem`);</span>
<a href="#l21.968"></a><span id="l21.968" class="difflineminus">-    }</span>
<a href="#l21.969"></a><span id="l21.969" class="difflineminus">-</span>
<a href="#l21.970"></a><span id="l21.970" class="difflineminus">-    // attachment</span>
<a href="#l21.971"></a><span id="l21.971" class="difflineminus">-    // TODO: Needs fixing,</span>
<a href="#l21.972"></a><span id="l21.972" class="difflineminus">-    // will be fixed with Bug 984044</span>
<a href="#l21.973"></a><span id="l21.973" class="difflineminus">-    if (data.attachment != undefined) {</span>
<a href="#l21.974"></a><span id="l21.974" class="difflineminus">-        if (data.attachment.add != undefined) {</span>
<a href="#l21.975"></a><span id="l21.975" class="difflineminus">-            handleAddingAttachment(dialog, data.attachment.add);</span>
<a href="#l21.976"></a><span id="l21.976" class="difflineminus">-            dialog.click(eid(&quot;button-url&quot;));</span>
<a href="#l21.977"></a><span id="l21.977" class="difflineminus">-            wait_for_modal_dialog(&quot;commonDialog&quot;);</span>
<a href="#l21.978"></a><span id="l21.978" class="difflineminus">-        }</span>
<a href="#l21.979"></a><span id="l21.979" class="difflineminus">-        if (data.attachment.delete != undefined) {</span>
<a href="#l21.980"></a><span id="l21.980" class="difflineminus">-            dialog.click(iframeLookup(`</span>
<a href="#l21.981"></a><span id="l21.981" class="difflineminus">-                ${innerFrame}/id(&quot;event-grid-attachment-row&quot;)/id(&quot;attachment-link&quot;)/</span>
<a href="#l21.982"></a><span id="l21.982" class="difflineminus">-                {&quot;label&quot;:&quot;${data.attachment.delete}&quot;}</span>
<a href="#l21.983"></a><span id="l21.983" class="difflineminus">-            `));</span>
<a href="#l21.984"></a><span id="l21.984" class="difflineminus">-            dialog.keypress(iframeId(&quot;attachment-link&quot;), &quot;VK_DELETE&quot;, {});</span>
<a href="#l21.985"></a><span id="l21.985" class="difflineminus">-        }</span>
<a href="#l21.986"></a><span id="l21.986" class="difflineminus">-    }</span>
<a href="#l21.987"></a><span id="l21.987" class="difflineminus">-    dialog.click(iframeId(&quot;item-title&quot;));</span>
<a href="#l21.988"></a><span id="l21.988" class="difflineminus">-    sleep();</span>
<a href="#l21.989"></a><span id="l21.989" class="difflineminus">-}</span>
<a href="#l21.990"></a><span id="l21.990" class="difflineminus">-</span>
<a href="#l21.991"></a><span id="l21.991"> function openLightningPrefs(aCallback, aParentController) {</span>
<a href="#l21.992"></a><span id="l21.992" class="difflineminus">-    // Since the Lightning pane is added after load, asking for it with open_pref_tab won't work. Cheat instead.</span>
<a href="#l21.993"></a><span id="l21.993" class="difflineplus">+    // Since the Lightning pane is added after load, asking for it with open_pref_tab won't work.</span>
<a href="#l21.994"></a><span id="l21.994" class="difflineplus">+    // Cheat instead.</span>
<a href="#l21.995"></a><span id="l21.995">     let tab = open_pref_tab(&quot;paneGeneral&quot;);</span>
<a href="#l21.996"></a><span id="l21.996">     tab.browser.contentDocument.querySelector('#category-box radio[pane=&quot;paneLightning&quot;]').click();</span>
<a href="#l21.997"></a><span id="l21.997" class="difflineminus">-    utils.waitFor(() =&gt; tab.browser.contentDocument.documentElement.currentPane.id == &quot;paneLightning&quot;,</span>
<a href="#l21.998"></a><span id="l21.998" class="difflineminus">-                  &quot;Timed out waiting for prefpane paneLightning to load.&quot;);</span>
<a href="#l21.999"></a><span id="l21.999" class="difflineplus">+    utils.waitFor(</span>
<a href="#l21.1000"></a><span id="l21.1000" class="difflineplus">+        () =&gt; tab.browser.contentDocument.documentElement.currentPane.id == &quot;paneLightning&quot;,</span>
<a href="#l21.1001"></a><span id="l21.1001" class="difflineplus">+        &quot;Timed out waiting for prefpane paneLightning to load.&quot;</span>
<a href="#l21.1002"></a><span id="l21.1002" class="difflineplus">+    );</span>
<a href="#l21.1003"></a><span id="l21.1003">     aCallback(tab);</span>
<a href="#l21.1004"></a><span id="l21.1004"> }</span>
<a href="#l21.1005"></a><span id="l21.1005"> </span>
<a href="#l21.1006"></a><span id="l21.1006"> /**</span>
<a href="#l21.1007"></a><span id="l21.1007">  * Helper to work around a mac bug in Thunderbird's mozmill version. This can</span>
<a href="#l21.1008"></a><span id="l21.1008">  * likely be removed with Mozmill 2.0's new Element Object.</span>
<a href="#l21.1009"></a><span id="l21.1009">  *</span>
<a href="#l21.1010"></a><span id="l21.1010">  * @param aMenuList     The XUL menulist to select in</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1">new file mode 100755</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineminus">--- /dev/null</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineplus">+++ b/calendar/test/mozmill/shared-modules/test-item-editing-helpers.js</span>
<a href="#l22.4"></a><span id="l22.4" class="difflineat">@@ -0,0 +1,551 @@</span>
<a href="#l22.5"></a><span id="l22.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l22.6"></a><span id="l22.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l22.7"></a><span id="l22.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l22.8"></a><span id="l22.8" class="difflineplus">+</span>
<a href="#l22.9"></a><span id="l22.9" class="difflineplus">+var MODULE_NAME = &quot;item-editing-helpers&quot;;</span>
<a href="#l22.10"></a><span id="l22.10" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l22.11"></a><span id="l22.11" class="difflineplus">+var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;window-helpers&quot;];</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+var EventUtils = {};</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineplus">+ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/EventUtils.js&quot;, EventUtils);</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;, null);</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineplus">+var SHORT_SLEEP, TIMEOUT_MODAL_DIALOG;</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+var helpersForController, menulistSelect;</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineplus">+var plan_for_modal_dialog, wait_for_modal_dialog;</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineplus">+</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineplus">+function setupModule(module) {</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineplus">+    controller = mozmill.getMail3PaneController();</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineplus">+    ({</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineplus">+        SHORT_SLEEP,</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineplus">+        TIMEOUT_MODAL_DIALOG,</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineplus">+        helpersForController,</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineplus">+        menulistSelect</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineplus">+    } = collector.getModule(&quot;calendar-utils&quot;));</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineplus">+    Object.assign(module, helpersForController(controller));</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineplus">+</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineplus">+    ({ plan_for_modal_dialog, wait_for_modal_dialog } =</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+        collector.getModule(&quot;window-helpers&quot;));</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineplus">+}</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+// Lookup paths and path-snippets.</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineplus">+// These 5 have to be used with itemEditLookup().</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineplus">+var CATEGORY_LIST = `</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineplus">+    id(&quot;event-grid-category-color-row&quot;)/id(&quot;event-grid-category-box&quot;)/id(&quot;item-categories&quot;)/</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineplus">+    id(&quot;item-categories-popup&quot;)</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineplus">+`;</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineplus">+var REPEAT_DETAILS = `</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineplus">+    id(&quot;event-grid-recurrence-row&quot;)/id(&quot;event-grid-recurrence-picker-box&quot;)/id(&quot;repeat-deck&quot;)/</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineplus">+    id(&quot;repeat-details&quot;)/[0]</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineplus">+`;</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineplus">+var EVENT_TABPANELS = `</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineplus">+    id(&quot;event-grid-tabbox&quot;)/id(&quot;event-grid-tabpanels&quot;)</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineplus">+`;</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineplus">+var DESCRIPTION_TEXTBOX = `</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineplus">+    ${EVENT_TABPANELS}/id(&quot;event-grid-tabpanel-description&quot;)/id(&quot;item-description&quot;)/</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineplus">+    anon({&quot;anonid&quot;:&quot;moz-input-box&quot;})/anon({&quot;class&quot;:&quot;textbox-textarea&quot;})</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineplus">+`;</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineplus">+var ATTENDEES_ROW = `</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineplus">+    ${EVENT_TABPANELS}/id(&quot;event-grid-tabpanel-attendees&quot;)/{&quot;flex&quot;:&quot;1&quot;}/</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineplus">+    {&quot;flex&quot;:&quot;1&quot;}/id(&quot;item-attendees-box&quot;)/{&quot;class&quot;:&quot;item-attendees-row&quot;}</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineplus">+`;</span>
<a href="#l22.55"></a><span id="l22.55" class="difflineplus">+// Only for Tasks.</span>
<a href="#l22.56"></a><span id="l22.56" class="difflineplus">+var PERCENT_COMPLETE_INPUT = `</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineplus">+    id(&quot;event-grid-todo-status-row&quot;)/id(&quot;event-grid-todo-status-picker-box&quot;)/</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineplus">+    id(&quot;percent-complete-textbox&quot;)/anon({&quot;class&quot;:&quot;textbox-input-box numberbox-input-box&quot;})/</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineplus">+    anon({&quot;anonid&quot;:&quot;input&quot;})</span>
<a href="#l22.60"></a><span id="l22.60" class="difflineplus">+`;</span>
<a href="#l22.61"></a><span id="l22.61" class="difflineplus">+</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineplus">+// To be appended to the path for a date- or timepicker.</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineplus">+var DATE_INPUT = `</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineplus">+    anon({&quot;class&quot;:&quot;datepicker-box-class&quot;})/{&quot;class&quot;:&quot;datepicker-text-class&quot;}/</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineplus">+    anon({&quot;class&quot;:&quot;menulist-editable-box textbox-input-box&quot;})/anon({&quot;anonid&quot;:&quot;input&quot;})</span>
<a href="#l22.66"></a><span id="l22.66" class="difflineplus">+`;</span>
<a href="#l22.67"></a><span id="l22.67" class="difflineplus">+var TIME_INPUT = `</span>
<a href="#l22.68"></a><span id="l22.68" class="difflineplus">+    anon({&quot;anonid&quot;:&quot;hbox&quot;})/anon({&quot;anonid&quot;:&quot;time-picker&quot;})/anon({&quot;class&quot;:&quot;timepicker-box-class&quot;})/</span>
<a href="#l22.69"></a><span id="l22.69" class="difflineplus">+    anon({&quot;class&quot;:&quot;timepicker-text-class&quot;})/anon({&quot;flex&quot;:&quot;1&quot;})/anon({&quot;anonid&quot;:&quot;input&quot;})</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineplus">+`;</span>
<a href="#l22.71"></a><span id="l22.71" class="difflineplus">+</span>
<a href="#l22.72"></a><span id="l22.72" class="difflineplus">+// The following can be used as is.</span>
<a href="#l22.73"></a><span id="l22.73" class="difflineplus">+var REC_DLG_ACCEPT = `</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineplus">+    /id(&quot;calendar-event-dialog-recurrence&quot;)/anon({&quot;anonid&quot;:&quot;buttons&quot;})/{&quot;dlgtype&quot;:&quot;accept&quot;}</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineplus">+`;</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineplus">+var REC_DLG_DAYS = `</span>
<a href="#l22.77"></a><span id="l22.77" class="difflineplus">+    /id(&quot;calendar-event-dialog-recurrence&quot;)/id(&quot;recurrence-pattern-groupbox&quot;)/</span>
<a href="#l22.78"></a><span id="l22.78" class="difflineplus">+    id(&quot;recurrence-pattern-grid&quot;)/id(&quot;recurrence-pattern-rows&quot;)/id(&quot;recurrence-pattern-period-row&quot;)/</span>
<a href="#l22.79"></a><span id="l22.79" class="difflineplus">+    id(&quot;period-deck&quot;)/id(&quot;period-deck-weekly-box&quot;)/[1]/id(&quot;daypicker-weekday&quot;)/</span>
<a href="#l22.80"></a><span id="l22.80" class="difflineplus">+    anon({&quot;anonid&quot;:&quot;mainbox&quot;})</span>
<a href="#l22.81"></a><span id="l22.81" class="difflineplus">+`;</span>
<a href="#l22.82"></a><span id="l22.82" class="difflineplus">+var REC_DLG_UNTIL_INPUT = `</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineplus">+    /id(&quot;calendar-event-dialog-recurrence&quot;)/id(&quot;recurrence-range-groupbox&quot;)/[1]/</span>
<a href="#l22.84"></a><span id="l22.84" class="difflineplus">+    id(&quot;recurrence-duration&quot;)/id(&quot;recurrence-range-until-box&quot;)/id(&quot;repeat-until-date&quot;)/</span>
<a href="#l22.85"></a><span id="l22.85" class="difflineplus">+    anon({&quot;class&quot;:&quot;datepicker-box-class&quot;})/{&quot;class&quot;:&quot;datepicker-text-class&quot;}/</span>
<a href="#l22.86"></a><span id="l22.86" class="difflineplus">+    anon({&quot;class&quot;:&quot;menulist-editable-box textbox-input-box&quot;})/anon({&quot;anonid&quot;:&quot;input&quot;})</span>
<a href="#l22.87"></a><span id="l22.87" class="difflineplus">+`;</span>
<a href="#l22.88"></a><span id="l22.88" class="difflineplus">+</span>
<a href="#l22.89"></a><span id="l22.89" class="difflineplus">+</span>
<a href="#l22.90"></a><span id="l22.90" class="difflineplus">+function installInto(module) {</span>
<a href="#l22.91"></a><span id="l22.91" class="difflineplus">+    // Copy constants into module.</span>
<a href="#l22.92"></a><span id="l22.92" class="difflineplus">+    module.CATEGORY_LIST = CATEGORY_LIST;</span>
<a href="#l22.93"></a><span id="l22.93" class="difflineplus">+    module.REPEAT_DETAILS = REPEAT_DETAILS;</span>
<a href="#l22.94"></a><span id="l22.94" class="difflineplus">+    module.EVENT_TABPANELS = EVENT_TABPANELS;</span>
<a href="#l22.95"></a><span id="l22.95" class="difflineplus">+    module.DESCRIPTION_TEXTBOX = DESCRIPTION_TEXTBOX;</span>
<a href="#l22.96"></a><span id="l22.96" class="difflineplus">+    module.ATTENDEES_ROW = ATTENDEES_ROW;</span>
<a href="#l22.97"></a><span id="l22.97" class="difflineplus">+    module.PERCENT_COMPLETE_INPUT = PERCENT_COMPLETE_INPUT;</span>
<a href="#l22.98"></a><span id="l22.98" class="difflineplus">+    module.DATE_INPUT = DATE_INPUT;</span>
<a href="#l22.99"></a><span id="l22.99" class="difflineplus">+    module.TIME_INPUT = TIME_INPUT;</span>
<a href="#l22.100"></a><span id="l22.100" class="difflineplus">+    module.REC_DLG_ACCEPT = REC_DLG_ACCEPT;</span>
<a href="#l22.101"></a><span id="l22.101" class="difflineplus">+    module.REC_DLG_DAYS = REC_DLG_DAYS;</span>
<a href="#l22.102"></a><span id="l22.102" class="difflineplus">+    module.REC_DLG_UNTIL_INPUT = REC_DLG_UNTIL_INPUT;</span>
<a href="#l22.103"></a><span id="l22.103" class="difflineplus">+    // Now copy helper functions.</span>
<a href="#l22.104"></a><span id="l22.104" class="difflineplus">+    module.helpersForEditUI = helpersForEditUI;</span>
<a href="#l22.105"></a><span id="l22.105" class="difflineplus">+    module.setData = setData;</span>
<a href="#l22.106"></a><span id="l22.106" class="difflineplus">+    module.setReminderMenulist = setReminderMenulist;</span>
<a href="#l22.107"></a><span id="l22.107" class="difflineplus">+    module.setCategories = setCategories;</span>
<a href="#l22.108"></a><span id="l22.108" class="difflineplus">+    module.handleAddingAttachment = handleAddingAttachment;</span>
<a href="#l22.109"></a><span id="l22.109" class="difflineplus">+    module.acceptSendingNotificationMail = acceptSendingNotificationMail;</span>
<a href="#l22.110"></a><span id="l22.110" class="difflineplus">+}</span>
<a href="#l22.111"></a><span id="l22.111" class="difflineplus">+</span>
<a href="#l22.112"></a><span id="l22.112" class="difflineplus">+function helpersForEditUI(controller) {</span>
<a href="#l22.113"></a><span id="l22.113" class="difflineplus">+    function selector(sel) {</span>
<a href="#l22.114"></a><span id="l22.114" class="difflineplus">+        return sel.trim().replace(/\n(\s*)/g, &quot;&quot;);</span>
<a href="#l22.115"></a><span id="l22.115" class="difflineplus">+    }</span>
<a href="#l22.116"></a><span id="l22.116" class="difflineplus">+</span>
<a href="#l22.117"></a><span id="l22.117" class="difflineplus">+    let isEvent = cal.isEvent(controller.window.calendarItem);</span>
<a href="#l22.118"></a><span id="l22.118" class="difflineplus">+</span>
<a href="#l22.119"></a><span id="l22.119" class="difflineplus">+    let obj = {</span>
<a href="#l22.120"></a><span id="l22.120" class="difflineplus">+        iframeLookup: (path) =&gt; {</span>
<a href="#l22.121"></a><span id="l22.121" class="difflineplus">+            let type = isEvent ? &quot;event&quot; : &quot;task&quot;;</span>
<a href="#l22.122"></a><span id="l22.122" class="difflineplus">+            return new elementslib.Lookup(controller.window.document, selector(`</span>
<a href="#l22.123"></a><span id="l22.123" class="difflineplus">+                /id(&quot;calendar-${type}-dialog-inner&quot;)/id(&quot;event-grid&quot;)/id(&quot;event-grid-rows&quot;)/</span>
<a href="#l22.124"></a><span id="l22.124" class="difflineplus">+                ${path}</span>
<a href="#l22.125"></a><span id="l22.125" class="difflineplus">+            `));</span>
<a href="#l22.126"></a><span id="l22.126" class="difflineplus">+        },</span>
<a href="#l22.127"></a><span id="l22.127" class="difflineplus">+        getDateTimePicker: (id) =&gt; {</span>
<a href="#l22.128"></a><span id="l22.128" class="difflineplus">+            let startId = isEvent ? &quot;event-starttime&quot; : &quot;todo-entrydate&quot;;</span>
<a href="#l22.129"></a><span id="l22.129" class="difflineplus">+            let endId = isEvent ? &quot;event-endtime&quot; : &quot;todo-duedate&quot;;</span>
<a href="#l22.130"></a><span id="l22.130" class="difflineplus">+            let path;</span>
<a href="#l22.131"></a><span id="l22.131" class="difflineplus">+            switch (id) {</span>
<a href="#l22.132"></a><span id="l22.132" class="difflineplus">+                case &quot;STARTDATE&quot;:</span>
<a href="#l22.133"></a><span id="l22.133" class="difflineplus">+                    path = `</span>
<a href="#l22.134"></a><span id="l22.134" class="difflineplus">+                        id(&quot;event-grid-startdate-row&quot;)/id(&quot;event-grid-startdate-picker-box&quot;)/</span>
<a href="#l22.135"></a><span id="l22.135" class="difflineplus">+                        id(&quot;${startId}&quot;)/anon({&quot;anonid&quot;:&quot;hbox&quot;})/anon({&quot;anonid&quot;:&quot;date-picker&quot;})/</span>
<a href="#l22.136"></a><span id="l22.136" class="difflineplus">+                        ${DATE_INPUT}</span>
<a href="#l22.137"></a><span id="l22.137" class="difflineplus">+                    `;</span>
<a href="#l22.138"></a><span id="l22.138" class="difflineplus">+                    break;</span>
<a href="#l22.139"></a><span id="l22.139" class="difflineplus">+                case &quot;ENDDATE&quot;:</span>
<a href="#l22.140"></a><span id="l22.140" class="difflineplus">+                    path = `</span>
<a href="#l22.141"></a><span id="l22.141" class="difflineplus">+                        id(&quot;event-grid-enddate-row&quot;)/[1]/id(&quot;event-grid-enddate-picker-box&quot;)/</span>
<a href="#l22.142"></a><span id="l22.142" class="difflineplus">+                        id(&quot;${endId}&quot;)/anon({&quot;anonid&quot;:&quot;hbox&quot;})/anon({&quot;anonid&quot;:&quot;date-picker&quot;})/</span>
<a href="#l22.143"></a><span id="l22.143" class="difflineplus">+                        ${DATE_INPUT}</span>
<a href="#l22.144"></a><span id="l22.144" class="difflineplus">+                    `;</span>
<a href="#l22.145"></a><span id="l22.145" class="difflineplus">+                    break;</span>
<a href="#l22.146"></a><span id="l22.146" class="difflineplus">+                case &quot;STARTTIME&quot;:</span>
<a href="#l22.147"></a><span id="l22.147" class="difflineplus">+                    path = `</span>
<a href="#l22.148"></a><span id="l22.148" class="difflineplus">+                        id(&quot;event-grid-startdate-row&quot;)/id(&quot;event-grid-startdate-picker-box&quot;)/</span>
<a href="#l22.149"></a><span id="l22.149" class="difflineplus">+                        id(&quot;${startId}&quot;)/${TIME_INPUT}</span>
<a href="#l22.150"></a><span id="l22.150" class="difflineplus">+                    `;</span>
<a href="#l22.151"></a><span id="l22.151" class="difflineplus">+                    break;</span>
<a href="#l22.152"></a><span id="l22.152" class="difflineplus">+                case &quot;ENDTIME&quot;:</span>
<a href="#l22.153"></a><span id="l22.153" class="difflineplus">+                    path = `</span>
<a href="#l22.154"></a><span id="l22.154" class="difflineplus">+                        id(&quot;event-grid-enddate-row&quot;)/[1]/id(&quot;event-grid-enddate-picker-box&quot;)/</span>
<a href="#l22.155"></a><span id="l22.155" class="difflineplus">+                        id(&quot;${endId}&quot;)/${TIME_INPUT}</span>
<a href="#l22.156"></a><span id="l22.156" class="difflineplus">+                    `;</span>
<a href="#l22.157"></a><span id="l22.157" class="difflineplus">+                    break;</span>
<a href="#l22.158"></a><span id="l22.158" class="difflineplus">+                case &quot;UNTILDATE&quot;:</span>
<a href="#l22.159"></a><span id="l22.159" class="difflineplus">+                    path = `</span>
<a href="#l22.160"></a><span id="l22.160" class="difflineplus">+                        id(&quot;event-grid-recurrence-row&quot;)/id(&quot;event-grid-recurrence-picker-box&quot;)/</span>
<a href="#l22.161"></a><span id="l22.161" class="difflineplus">+                        id(&quot;repeat-deck&quot;)/id(&quot;repeat-untilDate&quot;)/id(&quot;repeat-until-datepicker&quot;)/</span>
<a href="#l22.162"></a><span id="l22.162" class="difflineplus">+                        ${DATE_INPUT}</span>
<a href="#l22.163"></a><span id="l22.163" class="difflineplus">+                    `;</span>
<a href="#l22.164"></a><span id="l22.164" class="difflineplus">+                    break;</span>
<a href="#l22.165"></a><span id="l22.165" class="difflineplus">+                case &quot;COMPLETEDDATE&quot;:</span>
<a href="#l22.166"></a><span id="l22.166" class="difflineplus">+                    path = `</span>
<a href="#l22.167"></a><span id="l22.167" class="difflineplus">+                        id(&quot;event-grid-todo-status-row&quot;)/</span>
<a href="#l22.168"></a><span id="l22.168" class="difflineplus">+                        id(&quot;event-grid-todo-status-picker-box&quot;)/id(&quot;completed-date-picker&quot;)/</span>
<a href="#l22.169"></a><span id="l22.169" class="difflineplus">+                        ${DATE_INPUT}</span>
<a href="#l22.170"></a><span id="l22.170" class="difflineplus">+                    `;</span>
<a href="#l22.171"></a><span id="l22.171" class="difflineplus">+                    break;</span>
<a href="#l22.172"></a><span id="l22.172" class="difflineplus">+            }</span>
<a href="#l22.173"></a><span id="l22.173" class="difflineplus">+            return obj.iframeLookup(path);</span>
<a href="#l22.174"></a><span id="l22.174" class="difflineplus">+        }</span>
<a href="#l22.175"></a><span id="l22.175" class="difflineplus">+    };</span>
<a href="#l22.176"></a><span id="l22.176" class="difflineplus">+    return obj;</span>
<a href="#l22.177"></a><span id="l22.177" class="difflineplus">+}</span>
<a href="#l22.178"></a><span id="l22.178" class="difflineplus">+</span>
<a href="#l22.179"></a><span id="l22.179" class="difflineplus">+/**</span>
<a href="#l22.180"></a><span id="l22.180" class="difflineplus">+ * Helper function to enter event/task dialog data.</span>
<a href="#l22.181"></a><span id="l22.181" class="difflineplus">+ *</span>
<a href="#l22.182"></a><span id="l22.182" class="difflineplus">+ * @param dialog    event/task dialog controller</span>
<a href="#l22.183"></a><span id="l22.183" class="difflineplus">+ * @param iframe    event/task dialog iframe controller</span>
<a href="#l22.184"></a><span id="l22.184" class="difflineplus">+ * @param data      dataset object</span>
<a href="#l22.185"></a><span id="l22.185" class="difflineplus">+ *                      title - event/task title</span>
<a href="#l22.186"></a><span id="l22.186" class="difflineplus">+ *                      location - event/task location</span>
<a href="#l22.187"></a><span id="l22.187" class="difflineplus">+ *                      description - event/task description</span>
<a href="#l22.188"></a><span id="l22.188" class="difflineplus">+ *                      categories - Array of category names.</span>
<a href="#l22.189"></a><span id="l22.189" class="difflineplus">+ *                      calendar - Calendar the item should be in.</span>
<a href="#l22.190"></a><span id="l22.190" class="difflineplus">+ *                      allday - boolean value</span>
<a href="#l22.191"></a><span id="l22.191" class="difflineplus">+ *                      startdate - Date object</span>
<a href="#l22.192"></a><span id="l22.192" class="difflineplus">+ *                      starttime - Date object</span>
<a href="#l22.193"></a><span id="l22.193" class="difflineplus">+ *                      enddate - Date object</span>
<a href="#l22.194"></a><span id="l22.194" class="difflineplus">+ *                      endtime - Date object</span>
<a href="#l22.195"></a><span id="l22.195" class="difflineplus">+ *                      timezonedisplay - False for hidden, true for shown.</span>
<a href="#l22.196"></a><span id="l22.196" class="difflineplus">+ *                      repeat - reccurrence value, one of none/daily/weekly/</span>
<a href="#l22.197"></a><span id="l22.197" class="difflineplus">+ *                               every.weekday/bi.weekly/</span>
<a href="#l22.198"></a><span id="l22.198" class="difflineplus">+ *                               monthly/yearly</span>
<a href="#l22.199"></a><span id="l22.199" class="difflineplus">+ *                               (Custom is not supported.)</span>
<a href="#l22.200"></a><span id="l22.200" class="difflineplus">+ *                      repeatuntil - Date object</span>
<a href="#l22.201"></a><span id="l22.201" class="difflineplus">+ *                      reminder - none/0minutes/5minutes/15minutes/30minutes</span>
<a href="#l22.202"></a><span id="l22.202" class="difflineplus">+ *                                 1hour/2hours/12hours/1day/2days/1week</span>
<a href="#l22.203"></a><span id="l22.203" class="difflineplus">+ *                                 (Custom is not supported.)</span>
<a href="#l22.204"></a><span id="l22.204" class="difflineplus">+ *                      priority - none/low/normal/high</span>
<a href="#l22.205"></a><span id="l22.205" class="difflineplus">+ *                      privacy - public/confidential/private</span>
<a href="#l22.206"></a><span id="l22.206" class="difflineplus">+ *                      status - none/tentative/confirmed/canceled for events</span>
<a href="#l22.207"></a><span id="l22.207" class="difflineplus">+ *                               none/needs-action/in-process/completed/cancelled for tasks</span>
<a href="#l22.208"></a><span id="l22.208" class="difflineplus">+ *                      completed - Date object for tasks</span>
<a href="#l22.209"></a><span id="l22.209" class="difflineplus">+ *                      percent - percent complete for tasks</span>
<a href="#l22.210"></a><span id="l22.210" class="difflineplus">+ *                      freebusy - free/busy</span>
<a href="#l22.211"></a><span id="l22.211" class="difflineplus">+ *                      attachment.add - url to add</span>
<a href="#l22.212"></a><span id="l22.212" class="difflineplus">+ *                      attachment.remove - label of url to remove (without http://)</span>
<a href="#l22.213"></a><span id="l22.213" class="difflineplus">+ *                      attendees.add - eMail of attendees to add, comma separated</span>
<a href="#l22.214"></a><span id="l22.214" class="difflineplus">+ *                      attendees.remove - eMail of attendees to remove, comma separated</span>
<a href="#l22.215"></a><span id="l22.215" class="difflineplus">+ */</span>
<a href="#l22.216"></a><span id="l22.216" class="difflineplus">+function setData(dialog, iframe, data) {</span>
<a href="#l22.217"></a><span id="l22.217" class="difflineplus">+    let { eid, sleep, replaceText } = helpersForController(dialog);</span>
<a href="#l22.218"></a><span id="l22.218" class="difflineplus">+    let { eid: iframeid } = helpersForController(iframe);</span>
<a href="#l22.219"></a><span id="l22.219" class="difflineplus">+    let { iframeLookup, getDateTimePicker } = helpersForEditUI(iframe);</span>
<a href="#l22.220"></a><span id="l22.220" class="difflineplus">+</span>
<a href="#l22.221"></a><span id="l22.221" class="difflineplus">+    let isEvent = cal.isEvent(iframe.window.calendarItem);</span>
<a href="#l22.222"></a><span id="l22.222" class="difflineplus">+</span>
<a href="#l22.223"></a><span id="l22.223" class="difflineplus">+    let startdateInput = getDateTimePicker(&quot;STARTDATE&quot;);</span>
<a href="#l22.224"></a><span id="l22.224" class="difflineplus">+    let enddateInput = getDateTimePicker(&quot;ENDDATE&quot;);</span>
<a href="#l22.225"></a><span id="l22.225" class="difflineplus">+    let starttimeInput = getDateTimePicker(&quot;STARTTIME&quot;);</span>
<a href="#l22.226"></a><span id="l22.226" class="difflineplus">+    let endtimeInput = getDateTimePicker(&quot;ENDTIME&quot;);</span>
<a href="#l22.227"></a><span id="l22.227" class="difflineplus">+    let completeddateInput = getDateTimePicker(&quot;COMPLETEDDATE&quot;);</span>
<a href="#l22.228"></a><span id="l22.228" class="difflineplus">+    let percentCompleteInput = iframeLookup(PERCENT_COMPLETE_INPUT);</span>
<a href="#l22.229"></a><span id="l22.229" class="difflineplus">+    let untilDateInput = getDateTimePicker(&quot;UNTILDATE&quot;);</span>
<a href="#l22.230"></a><span id="l22.230" class="difflineplus">+</span>
<a href="#l22.231"></a><span id="l22.231" class="difflineplus">+    let dateFormatter = cal.getDateFormatter();</span>
<a href="#l22.232"></a><span id="l22.232" class="difflineplus">+    // Wait for input elements' values to be populated.</span>
<a href="#l22.233"></a><span id="l22.233" class="difflineplus">+    sleep();</span>
<a href="#l22.234"></a><span id="l22.234" class="difflineplus">+</span>
<a href="#l22.235"></a><span id="l22.235" class="difflineplus">+    // title</span>
<a href="#l22.236"></a><span id="l22.236" class="difflineplus">+    if (data.title != undefined) {</span>
<a href="#l22.237"></a><span id="l22.237" class="difflineplus">+        titleInput = iframeid(&quot;item-title&quot;);</span>
<a href="#l22.238"></a><span id="l22.238" class="difflineplus">+        replaceText(titleInput, data.title);</span>
<a href="#l22.239"></a><span id="l22.239" class="difflineplus">+    }</span>
<a href="#l22.240"></a><span id="l22.240" class="difflineplus">+</span>
<a href="#l22.241"></a><span id="l22.241" class="difflineplus">+    // location</span>
<a href="#l22.242"></a><span id="l22.242" class="difflineplus">+    if (data.location != undefined) {</span>
<a href="#l22.243"></a><span id="l22.243" class="difflineplus">+        locationInput = iframeid(&quot;item-location&quot;);</span>
<a href="#l22.244"></a><span id="l22.244" class="difflineplus">+        replaceText(locationInput, data.location);</span>
<a href="#l22.245"></a><span id="l22.245" class="difflineplus">+    }</span>
<a href="#l22.246"></a><span id="l22.246" class="difflineplus">+</span>
<a href="#l22.247"></a><span id="l22.247" class="difflineplus">+    // categories</span>
<a href="#l22.248"></a><span id="l22.248" class="difflineplus">+    if (data.categories != undefined) {</span>
<a href="#l22.249"></a><span id="l22.249" class="difflineplus">+        setCategories(dialog, iframe, data.categories);</span>
<a href="#l22.250"></a><span id="l22.250" class="difflineplus">+    }</span>
<a href="#l22.251"></a><span id="l22.251" class="difflineplus">+</span>
<a href="#l22.252"></a><span id="l22.252" class="difflineplus">+    // calendar</span>
<a href="#l22.253"></a><span id="l22.253" class="difflineplus">+    if (data.calendar != undefined) {</span>
<a href="#l22.254"></a><span id="l22.254" class="difflineplus">+        menulistSelect(iframeid(&quot;item-calendar&quot;), data.calendar, dialog);</span>
<a href="#l22.255"></a><span id="l22.255" class="difflineplus">+    }</span>
<a href="#l22.256"></a><span id="l22.256" class="difflineplus">+</span>
<a href="#l22.257"></a><span id="l22.257" class="difflineplus">+    // all-day</span>
<a href="#l22.258"></a><span id="l22.258" class="difflineplus">+    if (data.allday != undefined &amp;&amp; isEvent) {</span>
<a href="#l22.259"></a><span id="l22.259" class="difflineplus">+        dialog.check(iframeid(&quot;event-all-day&quot;), data.allday);</span>
<a href="#l22.260"></a><span id="l22.260" class="difflineplus">+    }</span>
<a href="#l22.261"></a><span id="l22.261" class="difflineplus">+</span>
<a href="#l22.262"></a><span id="l22.262" class="difflineplus">+    // timezonedisplay</span>
<a href="#l22.263"></a><span id="l22.263" class="difflineplus">+    if (data.timezonedisplay != undefined) {</span>
<a href="#l22.264"></a><span id="l22.264" class="difflineplus">+        let menuitem = eid(&quot;options-timezones-menuitem&quot;);</span>
<a href="#l22.265"></a><span id="l22.265" class="difflineplus">+        if (menuitem.getNode().getAttribute(&quot;checked&quot;) != data.timezonedisplay) {</span>
<a href="#l22.266"></a><span id="l22.266" class="difflineplus">+            dialog.click(menuitem);</span>
<a href="#l22.267"></a><span id="l22.267" class="difflineplus">+        }</span>
<a href="#l22.268"></a><span id="l22.268" class="difflineplus">+    }</span>
<a href="#l22.269"></a><span id="l22.269" class="difflineplus">+</span>
<a href="#l22.270"></a><span id="l22.270" class="difflineplus">+    // startdate</span>
<a href="#l22.271"></a><span id="l22.271" class="difflineplus">+    if (data.startdate != undefined &amp;&amp; data.startdate.constructor.name == &quot;Date&quot;) {</span>
<a href="#l22.272"></a><span id="l22.272" class="difflineplus">+        let startdate = dateFormatter.formatDateShort(</span>
<a href="#l22.273"></a><span id="l22.273" class="difflineplus">+            cal.dtz.jsDateToDateTime(data.startdate, cal.dtz.floating)</span>
<a href="#l22.274"></a><span id="l22.274" class="difflineplus">+        );</span>
<a href="#l22.275"></a><span id="l22.275" class="difflineplus">+</span>
<a href="#l22.276"></a><span id="l22.276" class="difflineplus">+        if (!isEvent) {</span>
<a href="#l22.277"></a><span id="l22.277" class="difflineplus">+            dialog.check(iframeid(&quot;todo-has-entrydate&quot;), true);</span>
<a href="#l22.278"></a><span id="l22.278" class="difflineplus">+        }</span>
<a href="#l22.279"></a><span id="l22.279" class="difflineplus">+        replaceText(startdateInput, startdate);</span>
<a href="#l22.280"></a><span id="l22.280" class="difflineplus">+    }</span>
<a href="#l22.281"></a><span id="l22.281" class="difflineplus">+</span>
<a href="#l22.282"></a><span id="l22.282" class="difflineplus">+    // starttime</span>
<a href="#l22.283"></a><span id="l22.283" class="difflineplus">+    if (data.starttime != undefined &amp;&amp; data.starttime.constructor.name == &quot;Date&quot;) {</span>
<a href="#l22.284"></a><span id="l22.284" class="difflineplus">+        let starttime = dateFormatter.formatTime(</span>
<a href="#l22.285"></a><span id="l22.285" class="difflineplus">+            cal.dtz.jsDateToDateTime(data.starttime, cal.dtz.floating)</span>
<a href="#l22.286"></a><span id="l22.286" class="difflineplus">+        );</span>
<a href="#l22.287"></a><span id="l22.287" class="difflineplus">+        replaceText(starttimeInput, starttime);</span>
<a href="#l22.288"></a><span id="l22.288" class="difflineplus">+        sleep();</span>
<a href="#l22.289"></a><span id="l22.289" class="difflineplus">+    }</span>
<a href="#l22.290"></a><span id="l22.290" class="difflineplus">+</span>
<a href="#l22.291"></a><span id="l22.291" class="difflineplus">+    // enddate</span>
<a href="#l22.292"></a><span id="l22.292" class="difflineplus">+    if (data.enddate != undefined &amp;&amp; data.enddate.constructor.name == &quot;Date&quot;) {</span>
<a href="#l22.293"></a><span id="l22.293" class="difflineplus">+        let enddate = dateFormatter.formatDateShort(</span>
<a href="#l22.294"></a><span id="l22.294" class="difflineplus">+            cal.dtz.jsDateToDateTime(data.enddate, cal.dtz.floating)</span>
<a href="#l22.295"></a><span id="l22.295" class="difflineplus">+        );</span>
<a href="#l22.296"></a><span id="l22.296" class="difflineplus">+        if (!isEvent) {</span>
<a href="#l22.297"></a><span id="l22.297" class="difflineplus">+            dialog.check(iframeid(&quot;todo-has-duedate&quot;), true);</span>
<a href="#l22.298"></a><span id="l22.298" class="difflineplus">+        }</span>
<a href="#l22.299"></a><span id="l22.299" class="difflineplus">+        replaceText(enddateInput, enddate);</span>
<a href="#l22.300"></a><span id="l22.300" class="difflineplus">+    }</span>
<a href="#l22.301"></a><span id="l22.301" class="difflineplus">+</span>
<a href="#l22.302"></a><span id="l22.302" class="difflineplus">+    // endtime</span>
<a href="#l22.303"></a><span id="l22.303" class="difflineplus">+    if (data.endtime != undefined &amp;&amp; data.endtime.constructor.name == &quot;Date&quot;) {</span>
<a href="#l22.304"></a><span id="l22.304" class="difflineplus">+        let endtime = dateFormatter.formatTime(</span>
<a href="#l22.305"></a><span id="l22.305" class="difflineplus">+            cal.dtz.jsDateToDateTime(data.endtime, cal.dtz.floating)</span>
<a href="#l22.306"></a><span id="l22.306" class="difflineplus">+        );</span>
<a href="#l22.307"></a><span id="l22.307" class="difflineplus">+        replaceText(endtimeInput, endtime);</span>
<a href="#l22.308"></a><span id="l22.308" class="difflineplus">+    }</span>
<a href="#l22.309"></a><span id="l22.309" class="difflineplus">+</span>
<a href="#l22.310"></a><span id="l22.310" class="difflineplus">+    // recurrence</span>
<a href="#l22.311"></a><span id="l22.311" class="difflineplus">+    if (data.repeat != undefined) {</span>
<a href="#l22.312"></a><span id="l22.312" class="difflineplus">+        menulistSelect(iframeid(&quot;item-repeat&quot;), data.repeat, dialog);</span>
<a href="#l22.313"></a><span id="l22.313" class="difflineplus">+    }</span>
<a href="#l22.314"></a><span id="l22.314" class="difflineplus">+    if (data.repeatuntil != undefined &amp;&amp; data.repeatuntil.constructor.name == &quot;Date&quot;) {</span>
<a href="#l22.315"></a><span id="l22.315" class="difflineplus">+        // Only fill in date, when the Datepicker is visible.</span>
<a href="#l22.316"></a><span id="l22.316" class="difflineplus">+        if (iframeid(&quot;repeat-deck&quot;).getNode().selectedIndex == 0) {</span>
<a href="#l22.317"></a><span id="l22.317" class="difflineplus">+            let untildate = dateFormatter.formatDateShort(</span>
<a href="#l22.318"></a><span id="l22.318" class="difflineplus">+                cal.dtz.jsDateToDateTime(data.repeatuntil, cal.dtz.floating)</span>
<a href="#l22.319"></a><span id="l22.319" class="difflineplus">+            );</span>
<a href="#l22.320"></a><span id="l22.320" class="difflineplus">+            replaceText(untilDateInput, untildate);</span>
<a href="#l22.321"></a><span id="l22.321" class="difflineplus">+        }</span>
<a href="#l22.322"></a><span id="l22.322" class="difflineplus">+    }</span>
<a href="#l22.323"></a><span id="l22.323" class="difflineplus">+</span>
<a href="#l22.324"></a><span id="l22.324" class="difflineplus">+    // reminder</span>
<a href="#l22.325"></a><span id="l22.325" class="difflineplus">+    if (data.reminder != undefined) {</span>
<a href="#l22.326"></a><span id="l22.326" class="difflineplus">+        setReminderMenulist(dialog, iframeid(&quot;item-alarm&quot;).getNode(), data.reminder);</span>
<a href="#l22.327"></a><span id="l22.327" class="difflineplus">+    }</span>
<a href="#l22.328"></a><span id="l22.328" class="difflineplus">+</span>
<a href="#l22.329"></a><span id="l22.329" class="difflineplus">+    // priority</span>
<a href="#l22.330"></a><span id="l22.330" class="difflineplus">+    if (data.priority != undefined) {</span>
<a href="#l22.331"></a><span id="l22.331" class="difflineplus">+        dialog.mainMenu.click(`#options-priority-${data.priority}-label`);</span>
<a href="#l22.332"></a><span id="l22.332" class="difflineplus">+    }</span>
<a href="#l22.333"></a><span id="l22.333" class="difflineplus">+</span>
<a href="#l22.334"></a><span id="l22.334" class="difflineplus">+    // privacy</span>
<a href="#l22.335"></a><span id="l22.335" class="difflineplus">+    if (data.privacy != undefined) {</span>
<a href="#l22.336"></a><span id="l22.336" class="difflineplus">+        let toolbarbutton = eid(&quot;button-privacy&quot;);</span>
<a href="#l22.337"></a><span id="l22.337" class="difflineplus">+        let rect = toolbarbutton.getNode().getBoundingClientRect();</span>
<a href="#l22.338"></a><span id="l22.338" class="difflineplus">+        dialog.click(toolbarbutton, rect.width - 5, 5);</span>
<a href="#l22.339"></a><span id="l22.339" class="difflineplus">+        dialog.mainMenu.click(`#options-privacy-${data.privacy}-menuitem`);</span>
<a href="#l22.340"></a><span id="l22.340" class="difflineplus">+        // For some reason, the dialog does not close by itself.</span>
<a href="#l22.341"></a><span id="l22.341" class="difflineplus">+        dialog.click(toolbarbutton, rect.width - 5, 5);</span>
<a href="#l22.342"></a><span id="l22.342" class="difflineplus">+    }</span>
<a href="#l22.343"></a><span id="l22.343" class="difflineplus">+</span>
<a href="#l22.344"></a><span id="l22.344" class="difflineplus">+    // status</span>
<a href="#l22.345"></a><span id="l22.345" class="difflineplus">+    if (data.status != undefined) {</span>
<a href="#l22.346"></a><span id="l22.346" class="difflineplus">+        if (isEvent) {</span>
<a href="#l22.347"></a><span id="l22.347" class="difflineplus">+            dialog.mainMenu.click(`#options-status-${data.status}-menuitem`);</span>
<a href="#l22.348"></a><span id="l22.348" class="difflineplus">+        } else {</span>
<a href="#l22.349"></a><span id="l22.349" class="difflineplus">+            menulistSelect(iframeid(&quot;todo-status&quot;), data.status.toUpperCase(), dialog);</span>
<a href="#l22.350"></a><span id="l22.350" class="difflineplus">+        }</span>
<a href="#l22.351"></a><span id="l22.351" class="difflineplus">+    }</span>
<a href="#l22.352"></a><span id="l22.352" class="difflineplus">+</span>
<a href="#l22.353"></a><span id="l22.353" class="difflineplus">+    let currentStatus = iframeid(&quot;todo-status&quot;).getNode().value;</span>
<a href="#l22.354"></a><span id="l22.354" class="difflineplus">+</span>
<a href="#l22.355"></a><span id="l22.355" class="difflineplus">+    // completed on</span>
<a href="#l22.356"></a><span id="l22.356" class="difflineplus">+    if (data.completed != undefined &amp;&amp; data.completed.constructor.name == &quot;Date&quot; &amp;&amp; !isEvent) {</span>
<a href="#l22.357"></a><span id="l22.357" class="difflineplus">+        let completeddate = dateFormatter.formatDateShort(</span>
<a href="#l22.358"></a><span id="l22.358" class="difflineplus">+            cal.dtz.jsDateToDateTime(data.completed, cal.dtz.floating)</span>
<a href="#l22.359"></a><span id="l22.359" class="difflineplus">+        );</span>
<a href="#l22.360"></a><span id="l22.360" class="difflineplus">+        if (currentStatus == &quot;COMPLETED&quot;) {</span>
<a href="#l22.361"></a><span id="l22.361" class="difflineplus">+            replaceText(completeddateInput, completeddate);</span>
<a href="#l22.362"></a><span id="l22.362" class="difflineplus">+        }</span>
<a href="#l22.363"></a><span id="l22.363" class="difflineplus">+    }</span>
<a href="#l22.364"></a><span id="l22.364" class="difflineplus">+</span>
<a href="#l22.365"></a><span id="l22.365" class="difflineplus">+    // percent complete</span>
<a href="#l22.366"></a><span id="l22.366" class="difflineplus">+    if (data.percent != undefined &amp;&amp;</span>
<a href="#l22.367"></a><span id="l22.367" class="difflineplus">+        (currentStatus == &quot;NEEDS-ACTION&quot; ||</span>
<a href="#l22.368"></a><span id="l22.368" class="difflineplus">+         currentStatus == &quot;IN-PROCESS&quot; ||</span>
<a href="#l22.369"></a><span id="l22.369" class="difflineplus">+         currentStatus == &quot;COMPLETED&quot;)) {</span>
<a href="#l22.370"></a><span id="l22.370" class="difflineplus">+        replaceText(percentCompleteInput, data.percent);</span>
<a href="#l22.371"></a><span id="l22.371" class="difflineplus">+    }</span>
<a href="#l22.372"></a><span id="l22.372" class="difflineplus">+</span>
<a href="#l22.373"></a><span id="l22.373" class="difflineplus">+    // free/busy</span>
<a href="#l22.374"></a><span id="l22.374" class="difflineplus">+    if (data.freebusy != undefined) {</span>
<a href="#l22.375"></a><span id="l22.375" class="difflineplus">+        dialog.mainMenu.click(`#options-freebusy-${data.freebusy}-menuitem`);</span>
<a href="#l22.376"></a><span id="l22.376" class="difflineplus">+    }</span>
<a href="#l22.377"></a><span id="l22.377" class="difflineplus">+</span>
<a href="#l22.378"></a><span id="l22.378" class="difflineplus">+    // description</span>
<a href="#l22.379"></a><span id="l22.379" class="difflineplus">+    if (data.description != undefined) {</span>
<a href="#l22.380"></a><span id="l22.380" class="difflineplus">+        dialog.click(iframeid(&quot;event-grid-tab-description&quot;));</span>
<a href="#l22.381"></a><span id="l22.381" class="difflineplus">+        let descField = iframeLookup(DESCRIPTION_TEXTBOX);</span>
<a href="#l22.382"></a><span id="l22.382" class="difflineplus">+        replaceText(descField, data.description);</span>
<a href="#l22.383"></a><span id="l22.383" class="difflineplus">+    }</span>
<a href="#l22.384"></a><span id="l22.384" class="difflineplus">+</span>
<a href="#l22.385"></a><span id="l22.385" class="difflineplus">+    // attachment</span>
<a href="#l22.386"></a><span id="l22.386" class="difflineplus">+    if (data.attachment != undefined) {</span>
<a href="#l22.387"></a><span id="l22.387" class="difflineplus">+        if (data.attachment.add != undefined) {</span>
<a href="#l22.388"></a><span id="l22.388" class="difflineplus">+            handleAddingAttachment(dialog, data.attachment.add);</span>
<a href="#l22.389"></a><span id="l22.389" class="difflineplus">+        }</span>
<a href="#l22.390"></a><span id="l22.390" class="difflineplus">+        if (data.attachment.remove != undefined) {</span>
<a href="#l22.391"></a><span id="l22.391" class="difflineplus">+            dialog.click(iframeid(&quot;event-grid-tab-attachments&quot;));</span>
<a href="#l22.392"></a><span id="l22.392" class="difflineplus">+            let attachmentBox = iframeid(&quot;attachment-link&quot;);</span>
<a href="#l22.393"></a><span id="l22.393" class="difflineplus">+            let attachments = attachmentBox.getNode().childNodes;</span>
<a href="#l22.394"></a><span id="l22.394" class="difflineplus">+            if (attachments) {</span>
<a href="#l22.395"></a><span id="l22.395" class="difflineplus">+                let attToDelete;</span>
<a href="#l22.396"></a><span id="l22.396" class="difflineplus">+                attachments.forEach((currentValue) =&gt; {</span>
<a href="#l22.397"></a><span id="l22.397" class="difflineplus">+                    if (currentValue.tooltipText.includes(data.attachment.remove)) {</span>
<a href="#l22.398"></a><span id="l22.398" class="difflineplus">+                        attToDelete = currentValue;</span>
<a href="#l22.399"></a><span id="l22.399" class="difflineplus">+                    }</span>
<a href="#l22.400"></a><span id="l22.400" class="difflineplus">+                    if (attToDelete) {</span>
<a href="#l22.401"></a><span id="l22.401" class="difflineplus">+                        dialog.click(new elementslib.Elem(attToDelete));</span>
<a href="#l22.402"></a><span id="l22.402" class="difflineplus">+                        dialog.keypress(attachmentBox, &quot;VK_DELETE&quot;, {});</span>
<a href="#l22.403"></a><span id="l22.403" class="difflineplus">+                        attToDelete = undefined;</span>
<a href="#l22.404"></a><span id="l22.404" class="difflineplus">+                    }</span>
<a href="#l22.405"></a><span id="l22.405" class="difflineplus">+                });</span>
<a href="#l22.406"></a><span id="l22.406" class="difflineplus">+            }</span>
<a href="#l22.407"></a><span id="l22.407" class="difflineplus">+        }</span>
<a href="#l22.408"></a><span id="l22.408" class="difflineplus">+    }</span>
<a href="#l22.409"></a><span id="l22.409" class="difflineplus">+</span>
<a href="#l22.410"></a><span id="l22.410" class="difflineplus">+    // attendees</span>
<a href="#l22.411"></a><span id="l22.411" class="difflineplus">+    if (data.attendees != undefined) {</span>
<a href="#l22.412"></a><span id="l22.412" class="difflineplus">+        // Display attendees Tab.</span>
<a href="#l22.413"></a><span id="l22.413" class="difflineplus">+        dialog.click(iframeid(&quot;event-grid-tab-attendees&quot;));</span>
<a href="#l22.414"></a><span id="l22.414" class="difflineplus">+        // Make sure no notifications are sent, since handling this dialog is</span>
<a href="#l22.415"></a><span id="l22.415" class="difflineplus">+        // not working when deleting a parent of a recurring event.</span>
<a href="#l22.416"></a><span id="l22.416" class="difflineplus">+        let attendeeCheckbox = iframeid(&quot;notify-attendees-checkbox&quot;);</span>
<a href="#l22.417"></a><span id="l22.417" class="difflineplus">+        if (!attendeeCheckbox.getNode().disabled) {</span>
<a href="#l22.418"></a><span id="l22.418" class="difflineplus">+            dialog.check(attendeeCheckbox, false);</span>
<a href="#l22.419"></a><span id="l22.419" class="difflineplus">+        }</span>
<a href="#l22.420"></a><span id="l22.420" class="difflineplus">+</span>
<a href="#l22.421"></a><span id="l22.421" class="difflineplus">+        // add</span>
<a href="#l22.422"></a><span id="l22.422" class="difflineplus">+        if (data.attendees.add != undefined) {</span>
<a href="#l22.423"></a><span id="l22.423" class="difflineplus">+            addAttendees(dialog, iframe, data.attendees.add);</span>
<a href="#l22.424"></a><span id="l22.424" class="difflineplus">+        }</span>
<a href="#l22.425"></a><span id="l22.425" class="difflineplus">+        // delete</span>
<a href="#l22.426"></a><span id="l22.426" class="difflineplus">+        if (data.attendees.remove != undefined) {</span>
<a href="#l22.427"></a><span id="l22.427" class="difflineplus">+            deleteAttendees(dialog, iframe, data.attendees.remove);</span>
<a href="#l22.428"></a><span id="l22.428" class="difflineplus">+        }</span>
<a href="#l22.429"></a><span id="l22.429" class="difflineplus">+    }</span>
<a href="#l22.430"></a><span id="l22.430" class="difflineplus">+</span>
<a href="#l22.431"></a><span id="l22.431" class="difflineplus">+    sleep(SHORT_SLEEP);</span>
<a href="#l22.432"></a><span id="l22.432" class="difflineplus">+}</span>
<a href="#l22.433"></a><span id="l22.433" class="difflineplus">+</span>
<a href="#l22.434"></a><span id="l22.434" class="difflineplus">+/**</span>
<a href="#l22.435"></a><span id="l22.435" class="difflineplus">+ * Select an item in the reminder menulist.</span>
<a href="#l22.436"></a><span id="l22.436" class="difflineplus">+ * Custom reminders are not supported.</span>
<a href="#l22.437"></a><span id="l22.437" class="difflineplus">+ *</span>
<a href="#l22.438"></a><span id="l22.438" class="difflineplus">+ * @param controller      Mozmill controller of item-Iframe</span>
<a href="#l22.439"></a><span id="l22.439" class="difflineplus">+ * @param menulist        the reminder menulist node</span>
<a href="#l22.440"></a><span id="l22.440" class="difflineplus">+ * @param id              identifying string of menuitem id</span>
<a href="#l22.441"></a><span id="l22.441" class="difflineplus">+ */</span>
<a href="#l22.442"></a><span id="l22.442" class="difflineplus">+function setReminderMenulist(controller, menulist, id) {</span>
<a href="#l22.443"></a><span id="l22.443" class="difflineplus">+    let { eid } = helpersForController(controller);</span>
<a href="#l22.444"></a><span id="l22.444" class="difflineplus">+</span>
<a href="#l22.445"></a><span id="l22.445" class="difflineplus">+    let menuitem = eid(`reminder-${id}-menuitem`);</span>
<a href="#l22.446"></a><span id="l22.446" class="difflineplus">+    menulist.click();</span>
<a href="#l22.447"></a><span id="l22.447" class="difflineplus">+    controller.click(menuitem);</span>
<a href="#l22.448"></a><span id="l22.448" class="difflineplus">+    controller.waitFor(() =&gt; {</span>
<a href="#l22.449"></a><span id="l22.449" class="difflineplus">+        return menulist.selectedItem.id == `reminder-${id}-menuitem`;</span>
<a href="#l22.450"></a><span id="l22.450" class="difflineplus">+    });</span>
<a href="#l22.451"></a><span id="l22.451" class="difflineplus">+}</span>
<a href="#l22.452"></a><span id="l22.452" class="difflineplus">+</span>
<a href="#l22.453"></a><span id="l22.453" class="difflineplus">+/**</span>
<a href="#l22.454"></a><span id="l22.454" class="difflineplus">+ * Set the categories in the event-dialog menulist-panel.</span>
<a href="#l22.455"></a><span id="l22.455" class="difflineplus">+ *</span>
<a href="#l22.456"></a><span id="l22.456" class="difflineplus">+ * @param dialog      Mozmill controller of event-dialog</span>
<a href="#l22.457"></a><span id="l22.457" class="difflineplus">+ * @param iframe      controller of the iframe of the dialog</span>
<a href="#l22.458"></a><span id="l22.458" class="difflineplus">+ * @param index       Array containing the categories as strings - leave empty to clear.</span>
<a href="#l22.459"></a><span id="l22.459" class="difflineplus">+ */</span>
<a href="#l22.460"></a><span id="l22.460" class="difflineplus">+function setCategories(dialog, iframe, categories) {</span>
<a href="#l22.461"></a><span id="l22.461" class="difflineplus">+    let { eid: iframeid } = helpersForController(iframe);</span>
<a href="#l22.462"></a><span id="l22.462" class="difflineplus">+    let { iframeLookup } = helpersForEditUI(iframe);</span>
<a href="#l22.463"></a><span id="l22.463" class="difflineplus">+    let categoryMenulist = iframeid(&quot;item-categories&quot;);</span>
<a href="#l22.464"></a><span id="l22.464" class="difflineplus">+    let categoryList = iframeLookup(CATEGORY_LIST);</span>
<a href="#l22.465"></a><span id="l22.465" class="difflineplus">+    dialog.click(categoryMenulist);</span>
<a href="#l22.466"></a><span id="l22.466" class="difflineplus">+    dialog.waitFor(() =&gt; categoryMenulist.getNode().open);</span>
<a href="#l22.467"></a><span id="l22.467" class="difflineplus">+    if (categoryMenulist.itemCount &gt; -1 &amp;&amp; categoryMenulist.itemCount &lt; data.categories.length) {</span>
<a href="#l22.468"></a><span id="l22.468" class="difflineplus">+        mark_failure([&quot;more categories than supported by current calendar&quot;]);</span>
<a href="#l22.469"></a><span id="l22.469" class="difflineplus">+    } else {</span>
<a href="#l22.470"></a><span id="l22.470" class="difflineplus">+        // Iterate over categories and check if needed.</span>
<a href="#l22.471"></a><span id="l22.471" class="difflineplus">+        let listItems = categoryList.getNode().childNodes;</span>
<a href="#l22.472"></a><span id="l22.472" class="difflineplus">+        for (let item of listItems) {</span>
<a href="#l22.473"></a><span id="l22.473" class="difflineplus">+            let set = false;</span>
<a href="#l22.474"></a><span id="l22.474" class="difflineplus">+            if (categories.includes(item.label)) {</span>
<a href="#l22.475"></a><span id="l22.475" class="difflineplus">+                set = true;</span>
<a href="#l22.476"></a><span id="l22.476" class="difflineplus">+            }</span>
<a href="#l22.477"></a><span id="l22.477" class="difflineplus">+            if (set &amp;&amp; !item.getAttribute(&quot;checked&quot;)) {</span>
<a href="#l22.478"></a><span id="l22.478" class="difflineplus">+                item.setAttribute(&quot;checked&quot;, true);</span>
<a href="#l22.479"></a><span id="l22.479" class="difflineplus">+            } else if (!set &amp;&amp; item.getAttribute(&quot;checked&quot;)) {</span>
<a href="#l22.480"></a><span id="l22.480" class="difflineplus">+                item.removeAttribute(&quot;checked&quot;);</span>
<a href="#l22.481"></a><span id="l22.481" class="difflineplus">+            }</span>
<a href="#l22.482"></a><span id="l22.482" class="difflineplus">+        }</span>
<a href="#l22.483"></a><span id="l22.483" class="difflineplus">+    }</span>
<a href="#l22.484"></a><span id="l22.484" class="difflineplus">+    dialog.click(categoryMenulist);</span>
<a href="#l22.485"></a><span id="l22.485" class="difflineplus">+}</span>
<a href="#l22.486"></a><span id="l22.486" class="difflineplus">+</span>
<a href="#l22.487"></a><span id="l22.487" class="difflineplus">+/**</span>
<a href="#l22.488"></a><span id="l22.488" class="difflineplus">+ * Add an attachment with url.</span>
<a href="#l22.489"></a><span id="l22.489" class="difflineplus">+ *</span>
<a href="#l22.490"></a><span id="l22.490" class="difflineplus">+ * @param controller        Mozmill window controller</span>
<a href="#l22.491"></a><span id="l22.491" class="difflineplus">+ */</span>
<a href="#l22.492"></a><span id="l22.492" class="difflineplus">+function handleAddingAttachment(controller, url) {</span>
<a href="#l22.493"></a><span id="l22.493" class="difflineplus">+    let { eid } = helpersForController(controller);</span>
<a href="#l22.494"></a><span id="l22.494" class="difflineplus">+    plan_for_modal_dialog(&quot;commonDialog&quot;, (attachment) =&gt; {</span>
<a href="#l22.495"></a><span id="l22.495" class="difflineplus">+        let { lookup: cdlglookup, eid: cdlgid } = helpersForController(attachment);</span>
<a href="#l22.496"></a><span id="l22.496" class="difflineplus">+        attachment.waitForElement(cdlgid(&quot;loginTextbox&quot;));</span>
<a href="#l22.497"></a><span id="l22.497" class="difflineplus">+        cdlgid(&quot;loginTextbox&quot;).getNode().value = url;</span>
<a href="#l22.498"></a><span id="l22.498" class="difflineplus">+        attachment.click(cdlglookup(`</span>
<a href="#l22.499"></a><span id="l22.499" class="difflineplus">+            /id(&quot;commonDialog&quot;)/anon({&quot;anonid&quot;:&quot;buttons&quot;})/{&quot;dlgtype&quot;:&quot;accept&quot;}</span>
<a href="#l22.500"></a><span id="l22.500" class="difflineplus">+        `));</span>
<a href="#l22.501"></a><span id="l22.501" class="difflineplus">+    });</span>
<a href="#l22.502"></a><span id="l22.502" class="difflineplus">+    controller.click(eid(&quot;button-url&quot;));</span>
<a href="#l22.503"></a><span id="l22.503" class="difflineplus">+</span>
<a href="#l22.504"></a><span id="l22.504" class="difflineplus">+    wait_for_modal_dialog(&quot;commonDialog&quot;, TIMEOUT_MODAL_DIALOG);</span>
<a href="#l22.505"></a><span id="l22.505" class="difflineplus">+}</span>
<a href="#l22.506"></a><span id="l22.506" class="difflineplus">+</span>
<a href="#l22.507"></a><span id="l22.507" class="difflineplus">+function addAttendees(dialog, innerFrame, attendeesString) {</span>
<a href="#l22.508"></a><span id="l22.508" class="difflineplus">+    let { eid: dlgid } = helpersForController(dialog);</span>
<a href="#l22.509"></a><span id="l22.509" class="difflineplus">+</span>
<a href="#l22.510"></a><span id="l22.510" class="difflineplus">+    let attendees = attendeesString.split(&quot;,&quot;);</span>
<a href="#l22.511"></a><span id="l22.511" class="difflineplus">+    for (var attendee of attendees) {</span>
<a href="#l22.512"></a><span id="l22.512" class="difflineplus">+        let calAttendee = innerFrame.window.attendees.find(</span>
<a href="#l22.513"></a><span id="l22.513" class="difflineplus">+            aAtt =&gt; aAtt.id == `mailto:${attendee}`</span>
<a href="#l22.514"></a><span id="l22.514" class="difflineplus">+        );</span>
<a href="#l22.515"></a><span id="l22.515" class="difflineplus">+        // Only add if not already present.</span>
<a href="#l22.516"></a><span id="l22.516" class="difflineplus">+        if (!calAttendee) {</span>
<a href="#l22.517"></a><span id="l22.517" class="difflineplus">+            plan_for_modal_dialog(&quot;Calendar:EventDialog:Attendees&quot;, (attDialog) =&gt; {</span>
<a href="#l22.518"></a><span id="l22.518" class="difflineplus">+                let { lookup: attlookup, sleep: attsleep } = helpersForController(attDialog);</span>
<a href="#l22.519"></a><span id="l22.519" class="difflineplus">+</span>
<a href="#l22.520"></a><span id="l22.520" class="difflineplus">+                let input = attlookup(`</span>
<a href="#l22.521"></a><span id="l22.521" class="difflineplus">+                    /id(&quot;calendar-event-dialog-attendees-v2&quot;)/</span>
<a href="#l22.522"></a><span id="l22.522" class="difflineplus">+                    anon({&quot;class&quot;:&quot;box-inherit dialog-content-box&quot;})</span>
<a href="#l22.523"></a><span id="l22.523" class="difflineplus">+                `);</span>
<a href="#l22.524"></a><span id="l22.524" class="difflineplus">+                // As starting point is always the last entered Attendee, we have</span>
<a href="#l22.525"></a><span id="l22.525" class="difflineplus">+                // to advance to not overwrite it.</span>
<a href="#l22.526"></a><span id="l22.526" class="difflineplus">+                attDialog.keypress(input, &quot;VK_TAB&quot;, {});</span>
<a href="#l22.527"></a><span id="l22.527" class="difflineplus">+                attsleep(SHORT_SLEEP);</span>
<a href="#l22.528"></a><span id="l22.528" class="difflineplus">+                attDialog.type(input, attendee);</span>
<a href="#l22.529"></a><span id="l22.529" class="difflineplus">+                attDialog.click(attlookup(`</span>
<a href="#l22.530"></a><span id="l22.530" class="difflineplus">+                    /id(&quot;calendar-event-dialog-attendees-v2&quot;)/anon({&quot;anonid&quot;:&quot;buttons&quot;})/</span>
<a href="#l22.531"></a><span id="l22.531" class="difflineplus">+                    {&quot;dlgtype&quot;:&quot;accept&quot;}</span>
<a href="#l22.532"></a><span id="l22.532" class="difflineplus">+                `));</span>
<a href="#l22.533"></a><span id="l22.533" class="difflineplus">+            });</span>
<a href="#l22.534"></a><span id="l22.534" class="difflineplus">+            dialog.click(dlgid(&quot;button-attendees&quot;));</span>
<a href="#l22.535"></a><span id="l22.535" class="difflineplus">+            wait_for_modal_dialog(&quot;Calendar:EventDialog:Attendees&quot;, TIMEOUT_MODAL_DIALOG);</span>
<a href="#l22.536"></a><span id="l22.536" class="difflineplus">+        }</span>
<a href="#l22.537"></a><span id="l22.537" class="difflineplus">+    }</span>
<a href="#l22.538"></a><span id="l22.538" class="difflineplus">+}</span>
<a href="#l22.539"></a><span id="l22.539" class="difflineplus">+</span>
<a href="#l22.540"></a><span id="l22.540" class="difflineplus">+function deleteAttendees(event, innerFrame, attendeesString) {</span>
<a href="#l22.541"></a><span id="l22.541" class="difflineplus">+    let { iframeLookup } = helpersForEditUI(innerFrame);</span>
<a href="#l22.542"></a><span id="l22.542" class="difflineplus">+</span>
<a href="#l22.543"></a><span id="l22.543" class="difflineplus">+    // Now delete the attendees.</span>
<a href="#l22.544"></a><span id="l22.544" class="difflineplus">+    let attendees = attendeesString.split(&quot;,&quot;);</span>
<a href="#l22.545"></a><span id="l22.545" class="difflineplus">+    for (var attendee of attendees) {</span>
<a href="#l22.546"></a><span id="l22.546" class="difflineplus">+        let attendeeToDelete = iframeLookup(`${ATTENDEES_ROW}/{&quot;attendeeid&quot;:&quot;mailto:${attendee}&quot;}`);</span>
<a href="#l22.547"></a><span id="l22.547" class="difflineplus">+        // Unfortunately the context menu of the attendees is not working in</span>
<a href="#l22.548"></a><span id="l22.548" class="difflineplus">+        // Mozmill tests. Thus we have to use the JS-functions.</span>
<a href="#l22.549"></a><span id="l22.549" class="difflineplus">+        let calAttendee = innerFrame.window.attendees.find(aAtt =&gt; aAtt.id == `mailto:${attendee}`);</span>
<a href="#l22.550"></a><span id="l22.550" class="difflineplus">+        if (calAttendee) {</span>
<a href="#l22.551"></a><span id="l22.551" class="difflineplus">+            innerFrame.window.removeAttendee(calAttendee);</span>
<a href="#l22.552"></a><span id="l22.552" class="difflineplus">+        }</span>
<a href="#l22.553"></a><span id="l22.553" class="difflineplus">+        event.waitForElementNotPresent(attendeeToDelete);</span>
<a href="#l22.554"></a><span id="l22.554" class="difflineplus">+    }</span>
<a href="#l22.555"></a><span id="l22.555" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/calendar/test/mozmill/testAlarmDefaultValue.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/calendar/test/mozmill/testAlarmDefaultValue.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -3,17 +3,17 @@</span>
<a href="#l23.4"></a><span id="l23.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l23.5"></a><span id="l23.5"> </span>
<a href="#l23.6"></a><span id="l23.6"> /**</span>
<a href="#l23.7"></a><span id="l23.7">  * Test default alarm settings for events and tasks</span>
<a href="#l23.8"></a><span id="l23.8">  */</span>
<a href="#l23.9"></a><span id="l23.9"> </span>
<a href="#l23.10"></a><span id="l23.10"> var MODULE_NAME = &quot;testAlarmDefaultValue&quot;;</span>
<a href="#l23.11"></a><span id="l23.11"> var RELATIVE_ROOT = &quot;./shared-modules&quot;;</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;keyboard-helpers&quot;];</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;content-tab-helpers&quot;];</span>
<a href="#l23.14"></a><span id="l23.14"> </span>
<a href="#l23.15"></a><span id="l23.15"> var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;, null);</span>
<a href="#l23.16"></a><span id="l23.16"> ChromeUtils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l23.17"></a><span id="l23.17"> ChromeUtils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l23.18"></a><span id="l23.18"> </span>
<a href="#l23.19"></a><span id="l23.19"> const DEFVALUE = 43;</span>
<a href="#l23.20"></a><span id="l23.20"> </span>
<a href="#l23.21"></a><span id="l23.21"> var helpersForController, invokeEventDialog, openLightningPrefs, menulistSelect;</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineat">@@ -21,89 +21,84 @@ var helpersForController, invokeEventDia</span>
<a href="#l23.23"></a><span id="l23.23"> function setupModule(module) {</span>
<a href="#l23.24"></a><span id="l23.24">     controller = mozmill.getMail3PaneController();</span>
<a href="#l23.25"></a><span id="l23.25">     ({</span>
<a href="#l23.26"></a><span id="l23.26">         helpersForController,</span>
<a href="#l23.27"></a><span id="l23.27">         invokeEventDialog,</span>
<a href="#l23.28"></a><span id="l23.28">         openLightningPrefs,</span>
<a href="#l23.29"></a><span id="l23.29">         menulistSelect</span>
<a href="#l23.30"></a><span id="l23.30">     } = collector.getModule(&quot;calendar-utils&quot;));</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">-    collector.getModule(&quot;calendar-utils&quot;).setupModule();</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineplus">+    collector.getModule(&quot;calendar-utils&quot;).setupModule(controller);</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineplus">+    Object.assign(module, helpersForController(controller));</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineplus">+</span>
<a href="#l23.35"></a><span id="l23.35">     collector.getModule(&quot;content-tab-helpers&quot;).installInto(module);</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineminus">-    Object.assign(module, helpersForController(controller));</span>
<a href="#l23.37"></a><span id="l23.37"> }</span>
<a href="#l23.38"></a><span id="l23.38"> </span>
<a href="#l23.39"></a><span id="l23.39"> function testDefaultAlarms() {</span>
<a href="#l23.40"></a><span id="l23.40">     let localeUnitString = cal.l10n.getCalString(&quot;unitDays&quot;);</span>
<a href="#l23.41"></a><span id="l23.41">     let unitString = PluralForm.get(DEFVALUE, localeUnitString).replace(&quot;#1&quot;, DEFVALUE);</span>
<a href="#l23.42"></a><span id="l23.42">     let alarmString = (...args) =&gt; cal.l10n.getString(&quot;calendar-alarms&quot;, ...args);</span>
<a href="#l23.43"></a><span id="l23.43">     let originStringEvent = alarmString(&quot;reminderCustomOriginBeginBeforeEvent&quot;);</span>
<a href="#l23.44"></a><span id="l23.44">     let originStringTask = alarmString(&quot;reminderCustomOriginBeginBeforeTask&quot;);</span>
<a href="#l23.45"></a><span id="l23.45">     let expectedEventReminder = alarmString(&quot;reminderCustomTitle&quot;, [unitString, originStringEvent]);</span>
<a href="#l23.46"></a><span id="l23.46">     let expectedTaskReminder = alarmString(&quot;reminderCustomTitle&quot;, [unitString, originStringTask]);</span>
<a href="#l23.47"></a><span id="l23.47"> </span>
<a href="#l23.48"></a><span id="l23.48" class="difflineminus">-    // Configure the lightning preferences</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineplus">+    let detailPath = `</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineplus">+        //*[@id=&quot;reminder-details&quot;]/*[local-name()=&quot;label&quot; and (not(@hidden) or @hidden=&quot;false&quot;)]</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineplus">+    `;</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineplus">+</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineplus">+    // Configure the lightning preferences.</span>
<a href="#l23.54"></a><span id="l23.54">     openLightningPrefs(handlePrefDialog, controller);</span>
<a href="#l23.55"></a><span id="l23.55"> </span>
<a href="#l23.56"></a><span id="l23.56" class="difflineminus">-    // Create New Event</span>
<a href="#l23.57"></a><span id="l23.57" class="difflineplus">+    // Create New Event.</span>
<a href="#l23.58"></a><span id="l23.58">     controller.click(eid(&quot;newMsgButton-calendar-menuitem&quot;));</span>
<a href="#l23.59"></a><span id="l23.59"> </span>
<a href="#l23.60"></a><span id="l23.60" class="difflineminus">-    // Set up the event dialog controller</span>
<a href="#l23.61"></a><span id="l23.61" class="difflineplus">+    // Set up the event dialog controller.</span>
<a href="#l23.62"></a><span id="l23.62">     invokeEventDialog(controller, null, (event, iframe) =&gt; {</span>
<a href="#l23.63"></a><span id="l23.63">         let { xpath: eventpath, eid: eventid } = helpersForController(event);</span>
<a href="#l23.64"></a><span id="l23.64"> </span>
<a href="#l23.65"></a><span id="l23.65" class="difflineminus">-        // Check if the &quot;custom&quot; item was selected</span>
<a href="#l23.66"></a><span id="l23.66" class="difflineplus">+        // Check if the &quot;custom&quot; item was selected.</span>
<a href="#l23.67"></a><span id="l23.67">         event.assertDOMProperty(eventid(&quot;item-alarm&quot;), &quot;value&quot;, &quot;custom&quot;);</span>
<a href="#l23.68"></a><span id="l23.68" class="difflineminus">-        let reminderDetailsVisible = eventpath(`</span>
<a href="#l23.69"></a><span id="l23.69" class="difflineminus">-            //*[@id=&quot;reminder-details&quot;]/</span>
<a href="#l23.70"></a><span id="l23.70" class="difflineminus">-            *[local-name()=&quot;label&quot; and (not(@hidden) or @hidden=&quot;false&quot;)]</span>
<a href="#l23.71"></a><span id="l23.71" class="difflineminus">-        `);</span>
<a href="#l23.72"></a><span id="l23.72" class="difflineplus">+        let reminderDetailsVisible = eventpath(detailPath);</span>
<a href="#l23.73"></a><span id="l23.73">         event.assertDOMProperty(reminderDetailsVisible, &quot;value&quot;, expectedEventReminder);</span>
<a href="#l23.74"></a><span id="l23.74"> </span>
<a href="#l23.75"></a><span id="l23.75" class="difflineminus">-        // Close the event dialog</span>
<a href="#l23.76"></a><span id="l23.76" class="difflineplus">+        // Close the event dialog.</span>
<a href="#l23.77"></a><span id="l23.77">         event.window.close();</span>
<a href="#l23.78"></a><span id="l23.78">     });</span>
<a href="#l23.79"></a><span id="l23.79"> </span>
<a href="#l23.80"></a><span id="l23.80" class="difflineminus">-    // Create New Task</span>
<a href="#l23.81"></a><span id="l23.81" class="difflineplus">+    // Create New Task.</span>
<a href="#l23.82"></a><span id="l23.82">     controller.click(eid(&quot;newMsgButton-task-menuitem&quot;));</span>
<a href="#l23.83"></a><span id="l23.83">     invokeEventDialog(controller, null, (task, iframe) =&gt; {</span>
<a href="#l23.84"></a><span id="l23.84">         let { xpath: taskpath, eid: taskid } = helpersForController(task);</span>
<a href="#l23.85"></a><span id="l23.85"> </span>
<a href="#l23.86"></a><span id="l23.86" class="difflineminus">-        // Check if the &quot;custom&quot; item was selected</span>
<a href="#l23.87"></a><span id="l23.87" class="difflineplus">+        // Check if the &quot;custom&quot; item was selected.</span>
<a href="#l23.88"></a><span id="l23.88">         task.assertDOMProperty(taskid(&quot;item-alarm&quot;), &quot;value&quot;, &quot;custom&quot;);</span>
<a href="#l23.89"></a><span id="l23.89" class="difflineminus">-        let reminderDetailsVisible = taskpath(`</span>
<a href="#l23.90"></a><span id="l23.90" class="difflineminus">-            //*[@id=&quot;reminder-details&quot;]/</span>
<a href="#l23.91"></a><span id="l23.91" class="difflineminus">-            *[local-name()=&quot;label&quot; and (not(@hidden) or @hidden=&quot;false&quot;)]</span>
<a href="#l23.92"></a><span id="l23.92" class="difflineminus">-        `);</span>
<a href="#l23.93"></a><span id="l23.93" class="difflineplus">+        let reminderDetailsVisible = taskpath(detailPath);</span>
<a href="#l23.94"></a><span id="l23.94">         task.assertDOMProperty(reminderDetailsVisible, &quot;value&quot;, expectedTaskReminder);</span>
<a href="#l23.95"></a><span id="l23.95"> </span>
<a href="#l23.96"></a><span id="l23.96" class="difflineminus">-        // Close the task dialog</span>
<a href="#l23.97"></a><span id="l23.97" class="difflineplus">+        // Close the task dialog.</span>
<a href="#l23.98"></a><span id="l23.98">         task.window.close();</span>
<a href="#l23.99"></a><span id="l23.99">     });</span>
<a href="#l23.100"></a><span id="l23.100"> }</span>
<a href="#l23.101"></a><span id="l23.101"> </span>
<a href="#l23.102"></a><span id="l23.102"> function handlePrefDialog(tab) {</span>
<a href="#l23.103"></a><span id="l23.103" class="difflineminus">-    // Click on the alarms tab</span>
<a href="#l23.104"></a><span id="l23.104" class="difflineplus">+    // Click on the alarms tab.</span>
<a href="#l23.105"></a><span id="l23.105">     content_tab_e(tab, &quot;calPreferencesTabAlarms&quot;).click();</span>
<a href="#l23.106"></a><span id="l23.106"> </span>
<a href="#l23.107"></a><span id="l23.107" class="difflineminus">-    // Turn on alarms for events and tasks</span>
<a href="#l23.108"></a><span id="l23.108" class="difflineplus">+    // Turn on alarms for events and tasks.</span>
<a href="#l23.109"></a><span id="l23.109">     menulistSelect(content_tab_eid(tab, &quot;eventdefalarm&quot;), &quot;1&quot;, controller);</span>
<a href="#l23.110"></a><span id="l23.110">     menulistSelect(content_tab_eid(tab, &quot;tododefalarm&quot;), &quot;1&quot;, controller);</span>
<a href="#l23.111"></a><span id="l23.111"> </span>
<a href="#l23.112"></a><span id="l23.112" class="difflineminus">-    // Selects &quot;days&quot; as a unit</span>
<a href="#l23.113"></a><span id="l23.113" class="difflineplus">+    // Selects &quot;days&quot; as a unit.</span>
<a href="#l23.114"></a><span id="l23.114">     menulistSelect(content_tab_eid(tab, &quot;tododefalarmunit&quot;), &quot;days&quot;, controller);</span>
<a href="#l23.115"></a><span id="l23.115">     menulistSelect(content_tab_eid(tab, &quot;eventdefalarmunit&quot;), &quot;days&quot;, controller);</span>
<a href="#l23.116"></a><span id="l23.116"> </span>
<a href="#l23.117"></a><span id="l23.117" class="difflineminus">-    // Sets default alarm length for events to DEFVALUE</span>
<a href="#l23.118"></a><span id="l23.118" class="difflineplus">+    // Sets default alarm length for events to DEFVALUE.</span>
<a href="#l23.119"></a><span id="l23.119">     let eventdefalarmlen = content_tab_eid(tab, &quot;eventdefalarmlen&quot;);</span>
<a href="#l23.120"></a><span id="l23.120" class="difflineminus">-    controller.click(eventdefalarmlen);</span>
<a href="#l23.121"></a><span id="l23.121" class="difflineminus">-    controller.keypress(eventdefalarmlen, &quot;a&quot;, { accelKey: true });</span>
<a href="#l23.122"></a><span id="l23.122" class="difflineminus">-    controller.type(eventdefalarmlen, DEFVALUE.toString());</span>
<a href="#l23.123"></a><span id="l23.123" class="difflineplus">+    replaceText(eventdefalarmlen, DEFVALUE.toString());</span>
<a href="#l23.124"></a><span id="l23.124"> </span>
<a href="#l23.125"></a><span id="l23.125">     let tododefalarmlen = content_tab_eid(tab, &quot;tododefalarmlen&quot;);</span>
<a href="#l23.126"></a><span id="l23.126" class="difflineminus">-    controller.click(tododefalarmlen);</span>
<a href="#l23.127"></a><span id="l23.127" class="difflineminus">-    controller.keypress(tododefalarmlen, &quot;a&quot;, { accelKey: true });</span>
<a href="#l23.128"></a><span id="l23.128" class="difflineminus">-    controller.type(tododefalarmlen, DEFVALUE.toString());</span>
<a href="#l23.129"></a><span id="l23.129" class="difflineplus">+    replaceText(tododefalarmlen, DEFVALUE.toString());</span>
<a href="#l23.130"></a><span id="l23.130"> }</span>
<a href="#l23.131"></a><span id="l23.131"> </span>
<a href="#l23.132"></a><span id="l23.132"> function teardownTest(module) {</span>
<a href="#l23.133"></a><span id="l23.133">     Preferences.resetBranch(&quot;calendar.alarms&quot;);</span>
<a href="#l23.134"></a><span id="l23.134"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/calendar/test/mozmill/testBasicFunctionality.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/calendar/test/mozmill/testBasicFunctionality.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -3,109 +3,93 @@</span>
<a href="#l24.4"></a><span id="l24.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l24.5"></a><span id="l24.5"> </span>
<a href="#l24.6"></a><span id="l24.6"> var MODULE_NAME = &quot;testBasicFunctionality&quot;;</span>
<a href="#l24.7"></a><span id="l24.7"> var RELATIVE_ROOT = &quot;./shared-modules&quot;;</span>
<a href="#l24.8"></a><span id="l24.8"> var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;window-helpers&quot;];</span>
<a href="#l24.9"></a><span id="l24.9"> </span>
<a href="#l24.10"></a><span id="l24.10"> var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;, null);</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+var TIMEOUT_MODAL_DIALOG, CALENDARNAME, CALENDAR_PANEL, DAY_VIEW, DAYBOX, MINIMONTH, CALENDARLIST;</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+var helpersForController, switchToView, deleteCalendars, handleNewCalendarWizard;</span>
<a href="#l24.14"></a><span id="l24.14"> var plan_for_modal_dialog, wait_for_modal_dialog;</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineminus">-var helpersForController, deleteCalendars, handleNewCalendarWizard;</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineminus">-var TIMEOUT_MODAL_DIALOG, CALENDARNAME;</span>
<a href="#l24.17"></a><span id="l24.17"> </span>
<a href="#l24.18"></a><span id="l24.18"> function setupModule(module) {</span>
<a href="#l24.19"></a><span id="l24.19">     controller = mozmill.getMail3PaneController();</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineminus">-    ({ plan_for_modal_dialog, wait_for_modal_dialog } =</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineminus">-        collector.getModule(&quot;window-helpers&quot;));</span>
<a href="#l24.22"></a><span id="l24.22">     ({</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineplus">+        TIMEOUT_MODAL_DIALOG,</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineplus">+        CALENDARNAME,</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineplus">+        CALENDAR_PANEL,</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineplus">+        DAY_VIEW,</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineplus">+        DAYBOX,</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineplus">+        MINIMONTH,</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineplus">+        CALENDARLIST,</span>
<a href="#l24.30"></a><span id="l24.30">         helpersForController,</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineplus">+        switchToView,</span>
<a href="#l24.32"></a><span id="l24.32">         deleteCalendars,</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineminus">-        handleNewCalendarWizard,</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineminus">-        TIMEOUT_MODAL_DIALOG,</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineminus">-        CALENDARNAME</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineplus">+        handleNewCalendarWizard</span>
<a href="#l24.37"></a><span id="l24.37">     } = collector.getModule(&quot;calendar-utils&quot;));</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineminus">-    collector.getModule(&quot;calendar-utils&quot;).setupModule();</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineplus">+    collector.getModule(&quot;calendar-utils&quot;).setupModule(controller);</span>
<a href="#l24.40"></a><span id="l24.40">     Object.assign(module, helpersForController(controller));</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineplus">+</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineplus">+    ({ plan_for_modal_dialog, wait_for_modal_dialog } = collector.getModule(&quot;window-helpers&quot;));</span>
<a href="#l24.43"></a><span id="l24.43"> }</span>
<a href="#l24.44"></a><span id="l24.44"> </span>
<a href="#l24.45"></a><span id="l24.45"> function testSmokeTest() {</span>
<a href="#l24.46"></a><span id="l24.46">     let dateFormatter = cal.getDateFormatter();</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineminus">-    let path = `</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;tabmail&quot;)/id(&quot;tabmail-tabbox&quot;)/</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineminus">-        id(&quot;tabpanelcontainer&quot;)/id(&quot;calendarTabPanel&quot;)/id(&quot;calendarContent&quot;)</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineminus">-    `;</span>
<a href="#l24.51"></a><span id="l24.51"> </span>
<a href="#l24.52"></a><span id="l24.52" class="difflineminus">-    // open calendar view</span>
<a href="#l24.53"></a><span id="l24.53" class="difflineminus">-    controller.click(eid(&quot;calendar-tab-button&quot;));</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineminus">-</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineminus">-    // check for minimonth</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineplus">+    // Check for minimonth.</span>
<a href="#l24.57"></a><span id="l24.57">     controller.waitForElement(eid(&quot;calMinimonth&quot;));</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineminus">-    // every month has a first</span>
<a href="#l24.59"></a><span id="l24.59" class="difflineplus">+    // Every month has a first.</span>
<a href="#l24.60"></a><span id="l24.60">     controller.assertNode(lookup(`</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineminus">-        ${path}/id(&quot;ltnSidebar&quot;)/id(&quot;minimonth-pane&quot;)/{&quot;align&quot;:&quot;center&quot;}/</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineminus">-        id(&quot;calMinimonthBox&quot;)/id(&quot;calMinimonth&quot;)/</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;minimonth-calendar&quot;})/[3]/{&quot;aria-label&quot;:&quot;1&quot;}</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineplus">+        ${MINIMONTH}/anon({&quot;anonid&quot;:&quot;minimonth-calendar&quot;})/[3]/{&quot;aria-label&quot;:&quot;1&quot;}</span>
<a href="#l24.65"></a><span id="l24.65">     `));</span>
<a href="#l24.66"></a><span id="l24.66"> </span>
<a href="#l24.67"></a><span id="l24.67" class="difflineminus">-    // check for calendar list</span>
<a href="#l24.68"></a><span id="l24.68" class="difflineplus">+    // Check for calendar list.</span>
<a href="#l24.69"></a><span id="l24.69">     controller.assertNode(eid(&quot;calendar-list-pane&quot;));</span>
<a href="#l24.70"></a><span id="l24.70" class="difflineminus">-    controller.assertNode(lookup(`</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineminus">-        ${path}/id(&quot;ltnSidebar&quot;)/id(&quot;calendar-panel&quot;)/id(&quot;calendar-list-pane&quot;)/</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineminus">-        id(&quot;calendar-listtree-pane&quot;)/id(&quot;calendar-list-tree-widget&quot;)/</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;tree&quot;})/anon({&quot;anonid&quot;:&quot;treechildren&quot;})</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineminus">-    `));</span>
<a href="#l24.75"></a><span id="l24.75" class="difflineplus">+    controller.assertNode(lookup(CALENDARLIST));</span>
<a href="#l24.76"></a><span id="l24.76"> </span>
<a href="#l24.77"></a><span id="l24.77" class="difflineminus">-    // check for event search</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineplus">+    // Check for event search.</span>
<a href="#l24.79"></a><span id="l24.79">     controller.assertNode(eid(&quot;bottom-events-box&quot;));</span>
<a href="#l24.80"></a><span id="l24.80" class="difflineminus">-    // there should be search field</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineplus">+    // There should be search field.</span>
<a href="#l24.82"></a><span id="l24.82">     controller.assertNode(eid(&quot;unifinder-search-field&quot;));</span>
<a href="#l24.83"></a><span id="l24.83"> </span>
<a href="#l24.84"></a><span id="l24.84" class="difflineminus">-    controller.click(eid(&quot;calendar-day-view-button&quot;));</span>
<a href="#l24.85"></a><span id="l24.85" class="difflineplus">+    switchToView(controller, &quot;day&quot;);</span>
<a href="#l24.86"></a><span id="l24.86"> </span>
<a href="#l24.87"></a><span id="l24.87" class="difflineminus">-    // default view is day view which should have 09:00 label and box</span>
<a href="#l24.88"></a><span id="l24.88" class="difflineplus">+    // Default view is day view which should have 09:00 label and box.</span>
<a href="#l24.89"></a><span id="l24.89">     let someTime = cal.createDateTime();</span>
<a href="#l24.90"></a><span id="l24.90">     someTime.resetTo(someTime.year, someTime.month, someTime.day, 9, 0, 0, someTime.timezone);</span>
<a href="#l24.91"></a><span id="l24.91">     let label = dateFormatter.formatTime(someTime);</span>
<a href="#l24.92"></a><span id="l24.92">     controller.assertNode(lookup(`</span>
<a href="#l24.93"></a><span id="l24.93" class="difflineminus">-        ${path}/id(&quot;calendarDisplayDeck&quot;)/id(&quot;calendar-view-box&quot;)/</span>
<a href="#l24.94"></a><span id="l24.94" class="difflineminus">-        id(&quot;view-deck&quot;)/id(&quot;day-view&quot;)/anon({&quot;anonid&quot;:&quot;mainbox&quot;})/</span>
<a href="#l24.95"></a><span id="l24.95" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;scrollbox&quot;})/anon({&quot;anonid&quot;:&quot;timebar&quot;})/</span>
<a href="#l24.96"></a><span id="l24.96" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;topbox&quot;})/[9]/</span>
<a href="#l24.97"></a><span id="l24.97" class="difflineplus">+        ${DAY_VIEW}/anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;scrollbox&quot;})/</span>
<a href="#l24.98"></a><span id="l24.98" class="difflineplus">+        anon({&quot;anonid&quot;:&quot;timebar&quot;})/anon({&quot;anonid&quot;:&quot;topbox&quot;})/[9]/</span>
<a href="#l24.99"></a><span id="l24.99">         {&quot;class&quot;:&quot;calendar-time-bar-label&quot;,&quot;value&quot;:&quot;${label}&quot;}</span>
<a href="#l24.100"></a><span id="l24.100">     `));</span>
<a href="#l24.101"></a><span id="l24.101">     controller.assertNode(lookup(`</span>
<a href="#l24.102"></a><span id="l24.102" class="difflineminus">-        ${path}/id(&quot;calendarDisplayDeck&quot;)/id(&quot;calendar-view-box&quot;)/</span>
<a href="#l24.103"></a><span id="l24.103" class="difflineminus">-        id(&quot;view-deck&quot;)/id(&quot;day-view&quot;)/anon({&quot;anonid&quot;:&quot;mainbox&quot;})/</span>
<a href="#l24.104"></a><span id="l24.104" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;scrollbox&quot;})/anon({&quot;anonid&quot;:&quot;daybox&quot;})/</span>
<a href="#l24.105"></a><span id="l24.105" class="difflineminus">-        [0]/anon({&quot;anonid&quot;:&quot;boxstack&quot;})/anon({&quot;anonid&quot;:&quot;bgbox&quot;})/[9]</span>
<a href="#l24.106"></a><span id="l24.106" class="difflineplus">+        ${DAY_VIEW}/${DAYBOX}/[0]/anon({&quot;anonid&quot;:&quot;boxstack&quot;})/anon({&quot;anonid&quot;:&quot;bgbox&quot;})/[9]</span>
<a href="#l24.107"></a><span id="l24.107">     `));</span>
<a href="#l24.108"></a><span id="l24.108"> </span>
<a href="#l24.109"></a><span id="l24.109" class="difflineminus">-    // open tasks view</span>
<a href="#l24.110"></a><span id="l24.110" class="difflineplus">+    // Open tasks view.</span>
<a href="#l24.111"></a><span id="l24.111">     controller.click(eid(&quot;task-tab-button&quot;));</span>
<a href="#l24.112"></a><span id="l24.112" class="difflineminus">-    // should be possible to filter today's tasks</span>
<a href="#l24.113"></a><span id="l24.113" class="difflineplus">+    // Should be possible to filter today's tasks.</span>
<a href="#l24.114"></a><span id="l24.114">     controller.waitForElement(eid(&quot;opt_today_filter&quot;));</span>
<a href="#l24.115"></a><span id="l24.115" class="difflineminus">-    // check for task add button</span>
<a href="#l24.116"></a><span id="l24.116" class="difflineplus">+    // Check for task add button.</span>
<a href="#l24.117"></a><span id="l24.117">     controller.assertNode(eid(&quot;calendar-add-task-button&quot;));</span>
<a href="#l24.118"></a><span id="l24.118" class="difflineminus">-    // check for filtered tasks list</span>
<a href="#l24.119"></a><span id="l24.119" class="difflineplus">+    // Check for filtered tasks list.</span>
<a href="#l24.120"></a><span id="l24.120">     controller.assertNode(lookup(`</span>
<a href="#l24.121"></a><span id="l24.121" class="difflineminus">-        ${path}/id(&quot;calendarDisplayDeck&quot;)/id(&quot;calendar-task-box&quot;)/[1]/</span>
<a href="#l24.122"></a><span id="l24.122" class="difflineplus">+        ${CALENDAR_PANEL}/id(&quot;calendarDisplayDeck&quot;)/id(&quot;calendar-task-box&quot;)/[1]/</span>
<a href="#l24.123"></a><span id="l24.123">         id(&quot;calendar-task-tree&quot;)/anon({&quot;anonid&quot;:&quot;calendar-task-tree&quot;})/</span>
<a href="#l24.124"></a><span id="l24.124">         {&quot;tooltip&quot;:&quot;taskTreeTooltip&quot;}</span>
<a href="#l24.125"></a><span id="l24.125">     `));</span>
<a href="#l24.126"></a><span id="l24.126"> </span>
<a href="#l24.127"></a><span id="l24.127" class="difflineminus">-    // create test calendar</span>
<a href="#l24.128"></a><span id="l24.128" class="difflineplus">+    // Create test calendar.</span>
<a href="#l24.129"></a><span id="l24.129">     plan_for_modal_dialog(&quot;Calendar:NewCalendarWizard&quot;, (wizard) =&gt; {</span>
<a href="#l24.130"></a><span id="l24.130">         handleNewCalendarWizard(wizard, CALENDARNAME);</span>
<a href="#l24.131"></a><span id="l24.131">     });</span>
<a href="#l24.132"></a><span id="l24.132" class="difflineminus">-    let calendarList = lookup(`</span>
<a href="#l24.133"></a><span id="l24.133" class="difflineminus">-        ${path}/id(&quot;ltnSidebar&quot;)/id(&quot;calendar-panel&quot;)/id(&quot;calendar-list-pane&quot;)/</span>
<a href="#l24.134"></a><span id="l24.134" class="difflineminus">-        id(&quot;calendar-listtree-pane&quot;)/id(&quot;calendar-list-tree-widget&quot;)/</span>
<a href="#l24.135"></a><span id="l24.135" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;tree&quot;})/anon({&quot;anonid&quot;:&quot;treechildren&quot;})</span>
<a href="#l24.136"></a><span id="l24.136" class="difflineminus">-    `);</span>
<a href="#l24.137"></a><span id="l24.137" class="difflineminus">-    // double click on bottom left</span>
<a href="#l24.138"></a><span id="l24.138" class="difflineplus">+    let calendarList = lookup(CALENDARLIST);</span>
<a href="#l24.139"></a><span id="l24.139" class="difflineplus">+    // Double click on bottom left.</span>
<a href="#l24.140"></a><span id="l24.140">     controller.doubleClick(calendarList, 0, calendarList.getNode().boxObject.height);</span>
<a href="#l24.141"></a><span id="l24.141">     wait_for_modal_dialog(&quot;Calendar:NewCalendarWizard&quot;, TIMEOUT_MODAL_DIALOG);</span>
<a href="#l24.142"></a><span id="l24.142"> }</span>
<a href="#l24.143"></a><span id="l24.143"> </span>
<a href="#l24.144"></a><span id="l24.144"> function teardownTest(module) {</span>
<a href="#l24.145"></a><span id="l24.145" class="difflineminus">-    deleteCalendars(controller, &quot;Mozmill&quot;);</span>
<a href="#l24.146"></a><span id="l24.146" class="difflineplus">+    deleteCalendars(controller, CALENDARNAME);</span>
<a href="#l24.147"></a><span id="l24.147"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/calendar/test/mozmill/testLocalICS.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/calendar/test/mozmill/testLocalICS.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -1,87 +1,87 @@</span>
<a href="#l25.4"></a><span id="l25.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l25.5"></a><span id="l25.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l25.6"></a><span id="l25.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l25.7"></a><span id="l25.7"> </span>
<a href="#l25.8"></a><span id="l25.8"> var MODULE_NAME = &quot;testLocalICS&quot;;</span>
<a href="#l25.9"></a><span id="l25.9"> var RELATIVE_ROOT = &quot;./shared-modules&quot;;</span>
<a href="#l25.10"></a><span id="l25.10" class="difflineminus">-var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;window-helpers&quot;];</span>
<a href="#l25.11"></a><span id="l25.11" class="difflineplus">+var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;item-editing-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l25.12"></a><span id="l25.12"> </span>
<a href="#l25.13"></a><span id="l25.13"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l25.14"></a><span id="l25.14"> </span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+var TIMEOUT_MODAL_DIALOG, CANVAS_BOX, EVENT_BOX;</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineplus">+var helpersForController, invokeEventDialog, deleteCalendars, handleNewCalendarWizard;</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineplus">+var setData;</span>
<a href="#l25.18"></a><span id="l25.18"> var plan_for_modal_dialog, wait_for_modal_dialog;</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineminus">-var helpersForController, invokeEventDialog, switchToView, deleteCalendars;</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineminus">-var handleNewCalendarWizard, setData;</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineminus">-var CANVAS_BOX, EVENT_BOX, TIMEOUT_MODAL_DIALOG;</span>
<a href="#l25.22"></a><span id="l25.22"> </span>
<a href="#l25.23"></a><span id="l25.23"> const HOUR = 8;</span>
<a href="#l25.24"></a><span id="l25.24"> var calendarName, calendarTitle, calendarFile;</span>
<a href="#l25.25"></a><span id="l25.25"> </span>
<a href="#l25.26"></a><span id="l25.26"> function setupModule(module) {</span>
<a href="#l25.27"></a><span id="l25.27">     controller = mozmill.getMail3PaneController();</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineminus">-    ({ plan_for_modal_dialog, wait_for_modal_dialog } =</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineminus">-        collector.getModule(&quot;window-helpers&quot;));</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineplus">+</span>
<a href="#l25.31"></a><span id="l25.31">     ({</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineplus">+        TIMEOUT_MODAL_DIALOG,</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineplus">+        CANVAS_BOX,</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineplus">+        EVENT_BOX,</span>
<a href="#l25.35"></a><span id="l25.35">         helpersForController,</span>
<a href="#l25.36"></a><span id="l25.36">         invokeEventDialog,</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineminus">-        switchToView,</span>
<a href="#l25.38"></a><span id="l25.38">         deleteCalendars,</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineminus">-        handleNewCalendarWizard,</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineminus">-        setData,</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineminus">-        CANVAS_BOX,</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineminus">-        EVENT_BOX,</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineminus">-        TIMEOUT_MODAL_DIALOG</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineplus">+        handleNewCalendarWizard</span>
<a href="#l25.45"></a><span id="l25.45">     } = collector.getModule(&quot;calendar-utils&quot;));</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineminus">-    collector.getModule(&quot;calendar-utils&quot;).setupModule();</span>
<a href="#l25.47"></a><span id="l25.47" class="difflineplus">+    collector.getModule(&quot;calendar-utils&quot;).setupModule(controller);</span>
<a href="#l25.48"></a><span id="l25.48">     Object.assign(module, helpersForController(controller));</span>
<a href="#l25.49"></a><span id="l25.49"> </span>
<a href="#l25.50"></a><span id="l25.50" class="difflineminus">-    // unique name needed as deleting a calendar only unsubscribes from it and</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineplus">+    ({ setData } = collector.getModule(&quot;item-editing-helpers&quot;));</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineplus">+    collector.getModule(&quot;item-editing-helpers&quot;).setupModule(module);</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineplus">+</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineplus">+    ({ plan_for_modal_dialog, wait_for_modal_dialog } = collector.getModule(&quot;window-helpers&quot;));</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineplus">+</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineplus">+    // Unique name needed as deleting a calendar only unsubscribes from it and</span>
<a href="#l25.57"></a><span id="l25.57">     // if same file were used on next testrun then previously created event</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineminus">-    // would show up</span>
<a href="#l25.59"></a><span id="l25.59" class="difflineplus">+    // would show up.</span>
<a href="#l25.60"></a><span id="l25.60">     calendarName = calendarTitle = (new Date()).getTime() + &quot;&quot;;</span>
<a href="#l25.61"></a><span id="l25.61">     calendarFile = Services.dirsvc.get(&quot;TmpD&quot;, Ci.nsIFile);</span>
<a href="#l25.62"></a><span id="l25.62">     calendarFile.append(calendarName + &quot;.ics&quot;);</span>
<a href="#l25.63"></a><span id="l25.63"> }</span>
<a href="#l25.64"></a><span id="l25.64"> </span>
<a href="#l25.65"></a><span id="l25.65"> function testLocalICS() {</span>
<a href="#l25.66"></a><span id="l25.66" class="difflineminus">-    controller.click(eid(&quot;calendar-tab-button&quot;));</span>
<a href="#l25.67"></a><span id="l25.67" class="difflineminus">-    switchToView(controller, &quot;day&quot;);</span>
<a href="#l25.68"></a><span id="l25.68" class="difflineminus">-</span>
<a href="#l25.69"></a><span id="l25.69">     plan_for_modal_dialog(&quot;Calendar:NewCalendarWizard&quot;, (wizard) =&gt; {</span>
<a href="#l25.70"></a><span id="l25.70">         handleNewCalendarWizard(wizard, calendarName, { network: { format: &quot;ics&quot; } });</span>
<a href="#l25.71"></a><span id="l25.71">     });</span>
<a href="#l25.72"></a><span id="l25.72">     controller.mainMenu.click(&quot;#ltnNewCalendar&quot;);</span>
<a href="#l25.73"></a><span id="l25.73">     wait_for_modal_dialog(&quot;Calendar:NewCalendarWizard&quot;, TIMEOUT_MODAL_DIALOG);</span>
<a href="#l25.74"></a><span id="l25.74"> </span>
<a href="#l25.75"></a><span id="l25.75" class="difflineminus">-    // create new event</span>
<a href="#l25.76"></a><span id="l25.76" class="difflineminus">-    let box = lookupEventBox(&quot;day&quot;, CANVAS_BOX, undefined, 1, HOUR);</span>
<a href="#l25.77"></a><span id="l25.77" class="difflineplus">+    // Create new event.</span>
<a href="#l25.78"></a><span id="l25.78" class="difflineplus">+    let box = lookupEventBox(&quot;day&quot;, CANVAS_BOX, null, 1, HOUR);</span>
<a href="#l25.79"></a><span id="l25.79">     invokeEventDialog(controller, box, (event, iframe) =&gt; {</span>
<a href="#l25.80"></a><span id="l25.80">         let { eid: eventid } = helpersForController(event);</span>
<a href="#l25.81"></a><span id="l25.81"> </span>
<a href="#l25.82"></a><span id="l25.82">         setData(event, iframe, { title: calendarTitle, calendar: calendarName });</span>
<a href="#l25.83"></a><span id="l25.83"> </span>
<a href="#l25.84"></a><span id="l25.84">         // save</span>
<a href="#l25.85"></a><span id="l25.85">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l25.86"></a><span id="l25.86">     });</span>
<a href="#l25.87"></a><span id="l25.87"> </span>
<a href="#l25.88"></a><span id="l25.88" class="difflineminus">-    // assert presence in view</span>
<a href="#l25.89"></a><span id="l25.89" class="difflineminus">-    let eventPath = `/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;${calendarName}&quot;}`;</span>
<a href="#l25.90"></a><span id="l25.90" class="difflineminus">-    controller.waitForElement(lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, HOUR, eventPath));</span>
<a href="#l25.91"></a><span id="l25.91" class="difflineplus">+    // Assert presence in view.</span>
<a href="#l25.92"></a><span id="l25.92" class="difflineplus">+    controller.waitForElement(lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, `</span>
<a href="#l25.93"></a><span id="l25.93" class="difflineplus">+        /{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;${calendarName.toLowerCase()}&quot;}</span>
<a href="#l25.94"></a><span id="l25.94" class="difflineplus">+    `));</span>
<a href="#l25.95"></a><span id="l25.95"> </span>
<a href="#l25.96"></a><span id="l25.96" class="difflineminus">-    // verify in file</span>
<a href="#l25.97"></a><span id="l25.97" class="difflineplus">+    // Verify in file.</span>
<a href="#l25.98"></a><span id="l25.98">     let fstream = Components.classes[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l25.99"></a><span id="l25.99">                             .createInstance(Components.interfaces.nsIFileInputStream);</span>
<a href="#l25.100"></a><span id="l25.100">     let cstream = Components.classes[&quot;@mozilla.org/intl/converter-input-stream;1&quot;]</span>
<a href="#l25.101"></a><span id="l25.101">                             .createInstance(Components.interfaces.nsIConverterInputStream);</span>
<a href="#l25.102"></a><span id="l25.102"> </span>
<a href="#l25.103"></a><span id="l25.103" class="difflineminus">-    // wait a moment until file is written</span>
<a href="#l25.104"></a><span id="l25.104" class="difflineplus">+    // Wait a moment until file is written.</span>
<a href="#l25.105"></a><span id="l25.105">     controller.waitFor(() =&gt; calendarFile.exists());</span>
<a href="#l25.106"></a><span id="l25.106"> </span>
<a href="#l25.107"></a><span id="l25.107" class="difflineminus">-    // read the calendar file and check for the summary</span>
<a href="#l25.108"></a><span id="l25.108" class="difflineplus">+    // Read the calendar file and check for the summary.</span>
<a href="#l25.109"></a><span id="l25.109">     fstream.init(calendarFile, -1, 0, 0);</span>
<a href="#l25.110"></a><span id="l25.110">     cstream.init(fstream, &quot;UTF-8&quot;, 0, 0);</span>
<a href="#l25.111"></a><span id="l25.111"> </span>
<a href="#l25.112"></a><span id="l25.112">     let str = {};</span>
<a href="#l25.113"></a><span id="l25.113">     cstream.readString(-1, str);</span>
<a href="#l25.114"></a><span id="l25.114">     cstream.close();</span>
<a href="#l25.115"></a><span id="l25.115"> </span>
<a href="#l25.116"></a><span id="l25.116">     controller.assertJS(str.value.includes(&quot;SUMMARY:&quot; + calendarTitle));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/calendar/test/mozmill/testTimezones.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/calendar/test/mozmill/testTimezones.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -1,18 +1,20 @@</span>
<a href="#l26.4"></a><span id="l26.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l26.5"></a><span id="l26.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l26.6"></a><span id="l26.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l26.7"></a><span id="l26.7"> </span>
<a href="#l26.8"></a><span id="l26.8"> var MODULE_NAME = &quot;testTimezones&quot;;</span>
<a href="#l26.9"></a><span id="l26.9"> var RELATIVE_ROOT = &quot;./shared-modules&quot;;</span>
<a href="#l26.10"></a><span id="l26.10" class="difflineminus">-var MODULE_REQUIRES = [&quot;calendar-utils&quot;];</span>
<a href="#l26.11"></a><span id="l26.11" class="difflineplus">+var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;item-editing-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l26.12"></a><span id="l26.12"> </span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-var helpersForController, invokeEventDialog, switchToView, goToDate, setData;</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineminus">-var findEventsInNode, viewForward, viewBack, CANVAS_BOX, TIMEOUT_MODAL_DIALOG;</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+var TIMEOUT_MODAL_DIALOG, CANVAS_BOX, DAY_VIEW;</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineplus">+var helpersForController, invokeEventDialog, switchToView, goToDate;</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineplus">+var findEventsInNode, viewForward, viewBack;</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineplus">+var setData;</span>
<a href="#l26.19"></a><span id="l26.19"> var plan_for_modal_dialog, wait_for_modal_dialog;</span>
<a href="#l26.20"></a><span id="l26.20"> </span>
<a href="#l26.21"></a><span id="l26.21"> var DATES = [</span>
<a href="#l26.22"></a><span id="l26.22">     [2009, 1, 1], [2009, 4, 2], [2009, 4, 16], [2009, 4, 30],</span>
<a href="#l26.23"></a><span id="l26.23">     [2009, 7, 2], [2009, 10, 15], [2009, 10, 29], [2009, 11, 5]</span>
<a href="#l26.24"></a><span id="l26.24"> ];</span>
<a href="#l26.25"></a><span id="l26.25"> </span>
<a href="#l26.26"></a><span id="l26.26"> var TIMEZONES = [</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineat">@@ -20,55 +22,57 @@ var TIMEZONES = [</span>
<a href="#l26.28"></a><span id="l26.28">     &quot;America/Argentina/Buenos_Aires&quot;, &quot;Europe/Paris&quot;, &quot;Asia/Kathmandu&quot;, &quot;Australia/Adelaide&quot;</span>
<a href="#l26.29"></a><span id="l26.29"> ];</span>
<a href="#l26.30"></a><span id="l26.30"> </span>
<a href="#l26.31"></a><span id="l26.31"> ChromeUtils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l26.32"></a><span id="l26.32"> </span>
<a href="#l26.33"></a><span id="l26.33"> function setupModule(module) {</span>
<a href="#l26.34"></a><span id="l26.34">     controller = mozmill.getMail3PaneController();</span>
<a href="#l26.35"></a><span id="l26.35">     ({</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineplus">+        TIMEOUT_MODAL_DIALOG,</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineplus">+        CANVAS_BOX,</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineplus">+        DAY_VIEW,</span>
<a href="#l26.39"></a><span id="l26.39">         helpersForController,</span>
<a href="#l26.40"></a><span id="l26.40">         invokeEventDialog,</span>
<a href="#l26.41"></a><span id="l26.41">         switchToView,</span>
<a href="#l26.42"></a><span id="l26.42">         goToDate,</span>
<a href="#l26.43"></a><span id="l26.43" class="difflineminus">-        setData,</span>
<a href="#l26.44"></a><span id="l26.44">         findEventsInNode,</span>
<a href="#l26.45"></a><span id="l26.45">         viewForward,</span>
<a href="#l26.46"></a><span id="l26.46" class="difflineminus">-        viewBack,</span>
<a href="#l26.47"></a><span id="l26.47" class="difflineminus">-        CANVAS_BOX,</span>
<a href="#l26.48"></a><span id="l26.48" class="difflineminus">-        TIMEOUT_MODAL_DIALOG</span>
<a href="#l26.49"></a><span id="l26.49" class="difflineplus">+        viewBack</span>
<a href="#l26.50"></a><span id="l26.50">     } = collector.getModule(&quot;calendar-utils&quot;));</span>
<a href="#l26.51"></a><span id="l26.51" class="difflineminus">-    collector.getModule(&quot;calendar-utils&quot;).setupModule();</span>
<a href="#l26.52"></a><span id="l26.52" class="difflineplus">+    collector.getModule(&quot;calendar-utils&quot;).setupModule(controller);</span>
<a href="#l26.53"></a><span id="l26.53">     Object.assign(module, helpersForController(controller));</span>
<a href="#l26.54"></a><span id="l26.54"> </span>
<a href="#l26.55"></a><span id="l26.55" class="difflineminus">-    ({ plan_for_modal_dialog, wait_for_modal_dialog } = collector.getModule(&quot;window-helpers&quot;));</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineplus">+    ({ setData } = collector.getModule(&quot;item-editing-helpers&quot;));</span>
<a href="#l26.57"></a><span id="l26.57" class="difflineplus">+    collector.getModule(&quot;item-editing-helpers&quot;).setupModule(module);</span>
<a href="#l26.58"></a><span id="l26.58" class="difflineplus">+</span>
<a href="#l26.59"></a><span id="l26.59" class="difflineplus">+    ({ plan_for_modal_dialog, wait_for_modal_dialog } =</span>
<a href="#l26.60"></a><span id="l26.60" class="difflineplus">+        collector.getModule(&quot;window-helpers&quot;));</span>
<a href="#l26.61"></a><span id="l26.61"> }</span>
<a href="#l26.62"></a><span id="l26.62"> </span>
<a href="#l26.63"></a><span id="l26.63"> function testTimezones1_SetGMT() {</span>
<a href="#l26.64"></a><span id="l26.64">     Preferences.set(&quot;calendar.timezone.local&quot;, &quot;Europe/London&quot;);</span>
<a href="#l26.65"></a><span id="l26.65"> }</span>
<a href="#l26.66"></a><span id="l26.66"> </span>
<a href="#l26.67"></a><span id="l26.67"> function testTimezones2_CreateEvents() {</span>
<a href="#l26.68"></a><span id="l26.68" class="difflineminus">-    controller.click(eid(&quot;calendar-tab-button&quot;));</span>
<a href="#l26.69"></a><span id="l26.69" class="difflineminus">-    switchToView(controller, &quot;day&quot;);</span>
<a href="#l26.70"></a><span id="l26.70">     goToDate(controller, 2009, 1, 1);</span>
<a href="#l26.71"></a><span id="l26.71"> </span>
<a href="#l26.72"></a><span id="l26.72" class="difflineminus">-    // create weekly recurring events in all TIMEZONES</span>
<a href="#l26.73"></a><span id="l26.73" class="difflineplus">+    // Create weekly recurring events in all TIMEZONES.</span>
<a href="#l26.74"></a><span id="l26.74">     let times = [[4, 30], [5, 0], [3, 0], [3, 0], [9, 0], [14, 0], [19, 45], [1, 30]];</span>
<a href="#l26.75"></a><span id="l26.75">     let time = new Date();</span>
<a href="#l26.76"></a><span id="l26.76">     for (let i = 0; i &lt; TIMEZONES.length; i++) {</span>
<a href="#l26.77"></a><span id="l26.77">         let eventBox = lookupEventBox(&quot;day&quot;, CANVAS_BOX, null, 1, i + 11);</span>
<a href="#l26.78"></a><span id="l26.78">         invokeEventDialog(controller, eventBox, (event, iframe) =&gt; {</span>
<a href="#l26.79"></a><span id="l26.79">             time.setHours(times[i][0]);</span>
<a href="#l26.80"></a><span id="l26.80">             time.setMinutes(times[i][1]);</span>
<a href="#l26.81"></a><span id="l26.81"> </span>
<a href="#l26.82"></a><span id="l26.82" class="difflineminus">-            // set timezone</span>
<a href="#l26.83"></a><span id="l26.83" class="difflineplus">+            // Set timezone.</span>
<a href="#l26.84"></a><span id="l26.84">             setTimezone(event, TIMEZONES[i]);</span>
<a href="#l26.85"></a><span id="l26.85"> </span>
<a href="#l26.86"></a><span id="l26.86" class="difflineminus">-            // set title and repeat</span>
<a href="#l26.87"></a><span id="l26.87" class="difflineplus">+            // Set title and repeat.</span>
<a href="#l26.88"></a><span id="l26.88">             setData(event, iframe, { title: TIMEZONES[i], repeat: &quot;weekly&quot;, starttime: time });</span>
<a href="#l26.89"></a><span id="l26.89"> </span>
<a href="#l26.90"></a><span id="l26.90">             // save</span>
<a href="#l26.91"></a><span id="l26.91">             let { eid: eventid } = helpersForController(event);</span>
<a href="#l26.92"></a><span id="l26.92">             event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l26.93"></a><span id="l26.93">         });</span>
<a href="#l26.94"></a><span id="l26.94">     }</span>
<a href="#l26.95"></a><span id="l26.95"> }</span>
<a href="#l26.96"></a><span id="l26.96" class="difflineat">@@ -266,44 +270,38 @@ function verify(controller, dates, timez</span>
<a href="#l26.97"></a><span id="l26.97">     function* datetimes() {</span>
<a href="#l26.98"></a><span id="l26.98">         for (let idx = 0; idx &lt; dates.length; idx++) {</span>
<a href="#l26.99"></a><span id="l26.99">             yield [dates[idx][0], dates[idx][1], dates[idx][2], times[idx]];</span>
<a href="#l26.100"></a><span id="l26.100">         }</span>
<a href="#l26.101"></a><span id="l26.101">     }</span>
<a href="#l26.102"></a><span id="l26.102"> </span>
<a href="#l26.103"></a><span id="l26.103">     let { lookup } = helpersForController(controller);</span>
<a href="#l26.104"></a><span id="l26.104"> </span>
<a href="#l26.105"></a><span id="l26.105" class="difflineminus">-    let dayView = `</span>
<a href="#l26.106"></a><span id="l26.106" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;tabmail&quot;)/id(&quot;tabmail-tabbox&quot;)/</span>
<a href="#l26.107"></a><span id="l26.107" class="difflineminus">-        id(&quot;tabpanelcontainer&quot;)/id(&quot;calendarTabPanel&quot;)/id(&quot;calendarContent&quot;)/</span>
<a href="#l26.108"></a><span id="l26.108" class="difflineminus">-        id(&quot;calendarDisplayDeck&quot;)/id(&quot;calendar-view-box&quot;)/id(&quot;view-deck&quot;)/</span>
<a href="#l26.109"></a><span id="l26.109" class="difflineminus">-        id(&quot;day-view&quot;)</span>
<a href="#l26.110"></a><span id="l26.110" class="difflineminus">-    `;</span>
<a href="#l26.111"></a><span id="l26.111">     let dayStack = `</span>
<a href="#l26.112"></a><span id="l26.112" class="difflineminus">-        ${dayView}/anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;scrollbox&quot;})/</span>
<a href="#l26.113"></a><span id="l26.113" class="difflineplus">+        ${DAY_VIEW}/anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;scrollbox&quot;})/</span>
<a href="#l26.114"></a><span id="l26.114">         anon({&quot;anonid&quot;:&quot;daybox&quot;})/[0]/anon({&quot;anonid&quot;:&quot;boxstack&quot;})/</span>
<a href="#l26.115"></a><span id="l26.115">         anon({&quot;anonid&quot;:&quot;topbox&quot;})/{&quot;flex&quot;:&quot;1&quot;}</span>
<a href="#l26.116"></a><span id="l26.116">     `;</span>
<a href="#l26.117"></a><span id="l26.117">     let timeLine = `</span>
<a href="#l26.118"></a><span id="l26.118" class="difflineminus">-        ${dayView}/anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;scrollbox&quot;})/</span>
<a href="#l26.119"></a><span id="l26.119" class="difflineplus">+        ${DAY_VIEW}/anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;scrollbox&quot;})/</span>
<a href="#l26.120"></a><span id="l26.120">         anon({&quot;anonid&quot;:&quot;timebar&quot;})/anon({&quot;anonid&quot;:&quot;topbox&quot;})</span>
<a href="#l26.121"></a><span id="l26.121">     `;</span>
<a href="#l26.122"></a><span id="l26.122">     let allowedDifference = 3;</span>
<a href="#l26.123"></a><span id="l26.123"> </span>
<a href="#l26.124"></a><span id="l26.124">     /* Event box' time can't be deduced from it's position in                    ----------------</span>
<a href="#l26.125"></a><span id="l26.125">        xul element tree because for each event a box is laid over whole day and  |___spacer_____|</span>
<a href="#l26.126"></a><span id="l26.126">        a spacer is added to push the event to it's correct location.             |__event_box___|</span>
<a href="#l26.127"></a><span id="l26.127">        But timeline can be used to retrieve the position of a particular hour    |day continues |</span>
<a href="#l26.128"></a><span id="l26.128">        on screen and it can be compared against the position of the event.       ----------------</span>
<a href="#l26.129"></a><span id="l26.129">     */</span>
<a href="#l26.130"></a><span id="l26.130"> </span>
<a href="#l26.131"></a><span id="l26.131">     for (let [selectedYear, selectedMonth, selectedDay, selectedTime] of datetimes()) {</span>
<a href="#l26.132"></a><span id="l26.132">         goToDate(controller, selectedYear, selectedMonth, selectedDay);</span>
<a href="#l26.133"></a><span id="l26.133"> </span>
<a href="#l26.134"></a><span id="l26.134" class="difflineminus">-        // find event with timezone tz</span>
<a href="#l26.135"></a><span id="l26.135" class="difflineplus">+        // Find event with timezone tz.</span>
<a href="#l26.136"></a><span id="l26.136">         for (let tzIdx = 0; tzIdx &lt; timezones.length; tzIdx++) {</span>
<a href="#l26.137"></a><span id="l26.137">             let [correctHour, minutes, day] = selectedTime[tzIdx];</span>
<a href="#l26.138"></a><span id="l26.138"> </span>
<a href="#l26.139"></a><span id="l26.139">             let timeNode = lookup(`${timeLine}/[${correctHour}]`).getNode();</span>
<a href="#l26.140"></a><span id="l26.140">             let timeY = timeNode.boxObject.y + timeNode.boxObject.height * (minutes / 60);</span>
<a href="#l26.141"></a><span id="l26.141"> </span>
<a href="#l26.142"></a><span id="l26.142">             let eventNodes = [];</span>
<a href="#l26.143"></a><span id="l26.143"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/calendar/test/mozmill/testTodayPane.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/calendar/test/mozmill/testTodayPane.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -1,281 +1,180 @@</span>
<a href="#l27.4"></a><span id="l27.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l27.5"></a><span id="l27.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l27.6"></a><span id="l27.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l27.7"></a><span id="l27.7"> </span>
<a href="#l27.8"></a><span id="l27.8"> var MODULE_NAME = &quot;testTodayPane&quot;;</span>
<a href="#l27.9"></a><span id="l27.9"> var RELATIVE_ROOT = &quot;./shared-modules&quot;;</span>
<a href="#l27.10"></a><span id="l27.10" class="difflineminus">-var MODULE_REQUIRES = [&quot;calendar-utils&quot;];</span>
<a href="#l27.11"></a><span id="l27.11" class="difflineplus">+var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;item-editing-helpers&quot;];</span>
<a href="#l27.12"></a><span id="l27.12"> </span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-var helpersForController, invokeEventDialog, createCalendar, deleteCalendars;</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineminus">-var CALENDARNAME;</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineplus">+var CALENDARNAME, CANVAS_BOX, DAY_VIEW, LABELDAYBOX, TODAY_BUTTON, TODAY_PANE, AGENDA_LISTBOX;</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineplus">+var helpersForController, invokeEventDialog, viewForward, createCalendar;</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineplus">+var deleteCalendars;</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineplus">+var setData;</span>
<a href="#l27.19"></a><span id="l27.19"> </span>
<a href="#l27.20"></a><span id="l27.20"> var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;, null);</span>
<a href="#l27.21"></a><span id="l27.21"> </span>
<a href="#l27.22"></a><span id="l27.22"> function setupModule(module) {</span>
<a href="#l27.23"></a><span id="l27.23">     controller = mozmill.getMail3PaneController();</span>
<a href="#l27.24"></a><span id="l27.24">     ({</span>
<a href="#l27.25"></a><span id="l27.25" class="difflineplus">+        CALENDARNAME,</span>
<a href="#l27.26"></a><span id="l27.26" class="difflineplus">+        CANVAS_BOX,</span>
<a href="#l27.27"></a><span id="l27.27" class="difflineplus">+        DAY_VIEW,</span>
<a href="#l27.28"></a><span id="l27.28" class="difflineplus">+        LABELDAYBOX,</span>
<a href="#l27.29"></a><span id="l27.29" class="difflineplus">+        TODAY_BUTTON,</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineplus">+        TODAY_PANE,</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineplus">+        AGENDA_LISTBOX,</span>
<a href="#l27.32"></a><span id="l27.32">         helpersForController,</span>
<a href="#l27.33"></a><span id="l27.33">         invokeEventDialog,</span>
<a href="#l27.34"></a><span id="l27.34" class="difflineplus">+        viewForward,</span>
<a href="#l27.35"></a><span id="l27.35">         createCalendar,</span>
<a href="#l27.36"></a><span id="l27.36" class="difflineminus">-        deleteCalendars,</span>
<a href="#l27.37"></a><span id="l27.37" class="difflineminus">-        CALENDARNAME</span>
<a href="#l27.38"></a><span id="l27.38" class="difflineplus">+        deleteCalendars</span>
<a href="#l27.39"></a><span id="l27.39">     } = collector.getModule(&quot;calendar-utils&quot;));</span>
<a href="#l27.40"></a><span id="l27.40" class="difflineminus">-    collector.getModule(&quot;calendar-utils&quot;).setupModule();</span>
<a href="#l27.41"></a><span id="l27.41" class="difflineplus">+    collector.getModule(&quot;calendar-utils&quot;).setupModule(controller);</span>
<a href="#l27.42"></a><span id="l27.42">     Object.assign(module, helpersForController(controller));</span>
<a href="#l27.43"></a><span id="l27.43"> </span>
<a href="#l27.44"></a><span id="l27.44" class="difflineplus">+    ({ setData } = collector.getModule(&quot;item-editing-helpers&quot;));</span>
<a href="#l27.45"></a><span id="l27.45" class="difflineplus">+    collector.getModule(&quot;item-editing-helpers&quot;).setupModule(module);</span>
<a href="#l27.46"></a><span id="l27.46" class="difflineplus">+</span>
<a href="#l27.47"></a><span id="l27.47">     createCalendar(controller, CALENDARNAME);</span>
<a href="#l27.48"></a><span id="l27.48"> }</span>
<a href="#l27.49"></a><span id="l27.49"> </span>
<a href="#l27.50"></a><span id="l27.50"> function testTodayPane() {</span>
<a href="#l27.51"></a><span id="l27.51" class="difflineminus">-    // paths</span>
<a href="#l27.52"></a><span id="l27.52" class="difflineminus">-    let panels = `</span>
<a href="#l27.53"></a><span id="l27.53" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/</span>
<a href="#l27.54"></a><span id="l27.54" class="difflineminus">-        id(&quot;tabmail&quot;)/id(&quot;tabmail-tabbox&quot;)/id(&quot;tabpanelcontainer&quot;)</span>
<a href="#l27.55"></a><span id="l27.55" class="difflineminus">-    `;</span>
<a href="#l27.56"></a><span id="l27.56" class="difflineminus">-    let miniMonth = `</span>
<a href="#l27.57"></a><span id="l27.57" class="difflineminus">-        ${panels}/id(&quot;calendarTabPanel&quot;)/id(&quot;calendarContent&quot;)/id(&quot;ltnSidebar&quot;)/</span>
<a href="#l27.58"></a><span id="l27.58" class="difflineminus">-        id(&quot;minimonth-pane&quot;)</span>
<a href="#l27.59"></a><span id="l27.59" class="difflineminus">-    `;</span>
<a href="#l27.60"></a><span id="l27.60" class="difflineminus">-    let dayView = `</span>
<a href="#l27.61"></a><span id="l27.61" class="difflineminus">-        ${panels}/id(&quot;calendarTabPanel&quot;)/id(&quot;calendarContent&quot;)/</span>
<a href="#l27.62"></a><span id="l27.62" class="difflineminus">-        id(&quot;calendarDisplayDeck&quot;)/id(&quot;calendar-view-box&quot;)/</span>
<a href="#l27.63"></a><span id="l27.63" class="difflineminus">-        id(&quot;view-deck&quot;)/id(&quot;day-view&quot;)</span>
<a href="#l27.64"></a><span id="l27.64" class="difflineminus">-    `;</span>
<a href="#l27.65"></a><span id="l27.65" class="difflineminus">-    let dayPath = `</span>
<a href="#l27.66"></a><span id="l27.66" class="difflineminus">-        ${dayView}/anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;labelbox&quot;})/</span>
<a href="#l27.67"></a><span id="l27.67" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;labeldaybox&quot;})/{&quot;flex&quot;:&quot;1&quot;}</span>
<a href="#l27.68"></a><span id="l27.68" class="difflineminus">-    `;</span>
<a href="#l27.69"></a><span id="l27.69" class="difflineminus">-    let eventName = `</span>
<a href="#l27.70"></a><span id="l27.70" class="difflineminus">-        id(&quot;calendar-event-dialog-inner&quot;)/id(&quot;event-grid&quot;)/</span>
<a href="#l27.71"></a><span id="l27.71" class="difflineminus">-        id(&quot;event-grid-rows&quot;)/id(&quot;event-grid-title-row&quot;)/id(&quot;item-title&quot;)/</span>
<a href="#l27.72"></a><span id="l27.72" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;moz-input-box&quot;})/anon({&quot;anonid&quot;:&quot;input&quot;})</span>
<a href="#l27.73"></a><span id="l27.73" class="difflineminus">-    `;</span>
<a href="#l27.74"></a><span id="l27.74" class="difflineplus">+    let createEvent = (hour, name) =&gt; {</span>
<a href="#l27.75"></a><span id="l27.75" class="difflineplus">+        let eventBox = lookupEventBox(&quot;day&quot;, CANVAS_BOX, null, 1, hour);</span>
<a href="#l27.76"></a><span id="l27.76" class="difflineplus">+        invokeEventDialog(controller, eventBox, (event, iframe) =&gt; {</span>
<a href="#l27.77"></a><span id="l27.77" class="difflineplus">+            let { eid: eventid } = helpersForController(event);</span>
<a href="#l27.78"></a><span id="l27.78"> </span>
<a href="#l27.79"></a><span id="l27.79" class="difflineminus">-    // open calendar view</span>
<a href="#l27.80"></a><span id="l27.80" class="difflineminus">-    controller.click(eid(&quot;calendar-tab-button&quot;));</span>
<a href="#l27.81"></a><span id="l27.81" class="difflineminus">-    controller.waitThenClick(eid(&quot;calendar-day-view-button&quot;));</span>
<a href="#l27.82"></a><span id="l27.82" class="difflineplus">+            setData(event, iframe, { title: name });</span>
<a href="#l27.83"></a><span id="l27.83" class="difflineplus">+            event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l27.84"></a><span id="l27.84" class="difflineplus">+        });</span>
<a href="#l27.85"></a><span id="l27.85" class="difflineplus">+    };</span>
<a href="#l27.86"></a><span id="l27.86"> </span>
<a href="#l27.87"></a><span id="l27.87" class="difflineminus">-    // go to today and verify date</span>
<a href="#l27.88"></a><span id="l27.88" class="difflineminus">-    controller.waitThenClick(lookup(`</span>
<a href="#l27.89"></a><span id="l27.89" class="difflineminus">-        ${miniMonth}/{&quot;align&quot;:&quot;center&quot;}/id(&quot;calMinimonthBox&quot;)/id(&quot;calMinimonth&quot;)/</span>
<a href="#l27.90"></a><span id="l27.90" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;minimonth-header&quot;})/anon({&quot;anonid&quot;:&quot;today-button&quot;})</span>
<a href="#l27.91"></a><span id="l27.91" class="difflineminus">-    `));</span>
<a href="#l27.92"></a><span id="l27.92" class="difflineplus">+    // Go to today and verify date.</span>
<a href="#l27.93"></a><span id="l27.93" class="difflineplus">+    let dayPath = `${DAY_VIEW}/${LABELDAYBOX}/{&quot;flex&quot;:&quot;1&quot;}`;</span>
<a href="#l27.94"></a><span id="l27.94" class="difflineplus">+    controller.waitThenClick(lookup(TODAY_BUTTON));</span>
<a href="#l27.95"></a><span id="l27.95">     controller.assertJS(lookup(dayPath).getNode().mDate.icalString == getIsoDate());</span>
<a href="#l27.96"></a><span id="l27.96"> </span>
<a href="#l27.97"></a><span id="l27.97">     // Create event 6 hours from now, if this is tomorrow then at 23 today.</span>
<a href="#l27.98"></a><span id="l27.98">     // Doubleclick only triggers new event dialog on visible boxes, so scrolling</span>
<a href="#l27.99"></a><span id="l27.99">     // may be needed by default visible time is 08:00 - 17:00, box of 17th hour</span>
<a href="#l27.100"></a><span id="l27.100" class="difflineminus">-    // is out of view</span>
<a href="#l27.101"></a><span id="l27.101" class="difflineplus">+    // is out of view.</span>
<a href="#l27.102"></a><span id="l27.102">     let hour = (new Date()).getHours();</span>
<a href="#l27.103"></a><span id="l27.103">     let startHour = (hour &lt; 18 ? hour + 6 : 23);</span>
<a href="#l27.104"></a><span id="l27.104" class="difflineminus">-    let view = lookup(dayView).getNode();</span>
<a href="#l27.105"></a><span id="l27.105" class="difflineplus">+    let view = lookup(DAY_VIEW).getNode();</span>
<a href="#l27.106"></a><span id="l27.106"> </span>
<a href="#l27.107"></a><span id="l27.107">     if (startHour &lt; 8 || startHour &gt; 16) {</span>
<a href="#l27.108"></a><span id="l27.108">         view.scrollToMinute(60 * startHour);</span>
<a href="#l27.109"></a><span id="l27.109">     }</span>
<a href="#l27.110"></a><span id="l27.110"> </span>
<a href="#l27.111"></a><span id="l27.111" class="difflineminus">-    invokeEventDialog(controller, lookup(`</span>
<a href="#l27.112"></a><span id="l27.112" class="difflineminus">-        ${dayView}/anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;scrollbox&quot;})/</span>
<a href="#l27.113"></a><span id="l27.113" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;daybox&quot;})/{&quot;class&quot;:&quot;calendar-event-column-even&quot;}/</span>
<a href="#l27.114"></a><span id="l27.114" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;boxstack&quot;})/anon({&quot;anonid&quot;:&quot;bgbox&quot;})/[${startHour}]</span>
<a href="#l27.115"></a><span id="l27.115" class="difflineminus">-    `), (event, iframe) =&gt; {</span>
<a href="#l27.116"></a><span id="l27.116" class="difflineminus">-        let { lookup: iframelookup } = helpersForController(iframe);</span>
<a href="#l27.117"></a><span id="l27.117" class="difflineminus">-        let { eid: eventid } = helpersForController(event);</span>
<a href="#l27.118"></a><span id="l27.118" class="difflineplus">+    createEvent(startHour, &quot;Today's Event&quot;);</span>
<a href="#l27.119"></a><span id="l27.119"> </span>
<a href="#l27.120"></a><span id="l27.120" class="difflineminus">-        let eventNameElement = iframelookup(eventName);</span>
<a href="#l27.121"></a><span id="l27.121" class="difflineminus">-        event.waitForElement(eventNameElement);</span>
<a href="#l27.122"></a><span id="l27.122" class="difflineminus">-        event.type(eventNameElement, &quot;Today's Event&quot;);</span>
<a href="#l27.123"></a><span id="l27.123" class="difflineminus">-        event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l27.124"></a><span id="l27.124" class="difflineminus">-    });</span>
<a href="#l27.125"></a><span id="l27.125" class="difflineminus">-</span>
<a href="#l27.126"></a><span id="l27.126" class="difflineminus">-    // reset view</span>
<a href="#l27.127"></a><span id="l27.127" class="difflineplus">+    // Reset view.</span>
<a href="#l27.128"></a><span id="l27.128">     view.scrollToMinute(60 * 8);</span>
<a href="#l27.129"></a><span id="l27.129"> </span>
<a href="#l27.130"></a><span id="l27.130" class="difflineminus">-    // go to tomorrow and add an event</span>
<a href="#l27.131"></a><span id="l27.131" class="difflineminus">-    controller.click(eid(&quot;next-view-button&quot;));</span>
<a href="#l27.132"></a><span id="l27.132" class="difflineminus">-    invokeEventDialog(controller, lookup(`</span>
<a href="#l27.133"></a><span id="l27.133" class="difflineminus">-        ${dayView}/anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;scrollbox&quot;})/</span>
<a href="#l27.134"></a><span id="l27.134" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;daybox&quot;})/{&quot;class&quot;:&quot;calendar-event-column-even&quot;}/</span>
<a href="#l27.135"></a><span id="l27.135" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;boxstack&quot;})/anon({&quot;anonid&quot;:&quot;bgbox&quot;})/[9]</span>
<a href="#l27.136"></a><span id="l27.136" class="difflineminus">-    `), (event, iframe) =&gt; {</span>
<a href="#l27.137"></a><span id="l27.137" class="difflineminus">-        let { lookup: iframelookup } = helpersForController(iframe);</span>
<a href="#l27.138"></a><span id="l27.138" class="difflineminus">-        let { eid: eventid } = helpersForController(event);</span>
<a href="#l27.139"></a><span id="l27.139" class="difflineminus">-</span>
<a href="#l27.140"></a><span id="l27.140" class="difflineminus">-        let eventNameElement = iframelookup(eventName);</span>
<a href="#l27.141"></a><span id="l27.141" class="difflineminus">-        event.waitForElement(eventNameElement);</span>
<a href="#l27.142"></a><span id="l27.142" class="difflineminus">-        event.type(eventNameElement, &quot;Tomorrow's Event&quot;);</span>
<a href="#l27.143"></a><span id="l27.143" class="difflineminus">-        event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l27.144"></a><span id="l27.144" class="difflineminus">-    });</span>
<a href="#l27.145"></a><span id="l27.145" class="difflineplus">+    // Go to tomorrow and add an event.</span>
<a href="#l27.146"></a><span id="l27.146" class="difflineplus">+    viewForward(controller, 1);</span>
<a href="#l27.147"></a><span id="l27.147" class="difflineplus">+    createEvent(9, &quot;Tomorrow's Event&quot;);</span>
<a href="#l27.148"></a><span id="l27.148"> </span>
<a href="#l27.149"></a><span id="l27.149" class="difflineminus">-    // go 5 days forward and add an event</span>
<a href="#l27.150"></a><span id="l27.150" class="difflineminus">-    for (let i = 0; i &lt; 5; i++) {</span>
<a href="#l27.151"></a><span id="l27.151" class="difflineminus">-        controller.click(eid(&quot;next-view-button&quot;));</span>
<a href="#l27.152"></a><span id="l27.152" class="difflineminus">-    }</span>
<a href="#l27.153"></a><span id="l27.153" class="difflineminus">-    sleep();</span>
<a href="#l27.154"></a><span id="l27.154" class="difflineplus">+    // Go 5 days forward and add an event.</span>
<a href="#l27.155"></a><span id="l27.155" class="difflineplus">+    viewForward(controller, 5);</span>
<a href="#l27.156"></a><span id="l27.156" class="difflineplus">+    createEvent(9, &quot;Future Event&quot;);</span>
<a href="#l27.157"></a><span id="l27.157"> </span>
<a href="#l27.158"></a><span id="l27.158" class="difflineminus">-    invokeEventDialog(controller, lookup(`</span>
<a href="#l27.159"></a><span id="l27.159" class="difflineminus">-        ${dayView}/anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;scrollbox&quot;})/</span>
<a href="#l27.160"></a><span id="l27.160" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;daybox&quot;})/{&quot;class&quot;:&quot;calendar-event-column-even&quot;}/</span>
<a href="#l27.161"></a><span id="l27.161" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;boxstack&quot;})/anon({&quot;anonid&quot;:&quot;bgbox&quot;})/[9]</span>
<a href="#l27.162"></a><span id="l27.162" class="difflineminus">-    `), (event, iframe) =&gt; {</span>
<a href="#l27.163"></a><span id="l27.163" class="difflineminus">-        let { lookup: iframelookup } = helpersForController(iframe);</span>
<a href="#l27.164"></a><span id="l27.164" class="difflineminus">-        let { eid: eventid } = helpersForController(event);</span>
<a href="#l27.165"></a><span id="l27.165" class="difflineminus">-</span>
<a href="#l27.166"></a><span id="l27.166" class="difflineminus">-        let eventNameElement = iframelookup(eventName);</span>
<a href="#l27.167"></a><span id="l27.167" class="difflineminus">-        event.waitForElement(eventNameElement);</span>
<a href="#l27.168"></a><span id="l27.168" class="difflineminus">-        event.type(eventNameElement, &quot;Future's Event&quot;);</span>
<a href="#l27.169"></a><span id="l27.169" class="difflineminus">-        event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l27.170"></a><span id="l27.170" class="difflineminus">-    });</span>
<a href="#l27.171"></a><span id="l27.171" class="difflineminus">-</span>
<a href="#l27.172"></a><span id="l27.172" class="difflineminus">-    // go to mail tab</span>
<a href="#l27.173"></a><span id="l27.173" class="difflineplus">+    // Go to mail tab.</span>
<a href="#l27.174"></a><span id="l27.174">     controller.click(lookup(`</span>
<a href="#l27.175"></a><span id="l27.175" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;navigation-toolbox&quot;)/id(&quot;tabs-toolbar&quot;)/</span>
<a href="#l27.176"></a><span id="l27.176" class="difflineminus">-        id(&quot;tabmail-tabs&quot;)/[0]/</span>
<a href="#l27.177"></a><span id="l27.177" class="difflineminus">-        anon({&quot;class&quot;:&quot;tab-stack&quot;})/{&quot;class&quot;:&quot;tab-background&quot;}/</span>
<a href="#l27.178"></a><span id="l27.178" class="difflineminus">-        {&quot;class&quot;:&quot;tab-line&quot;}</span>
<a href="#l27.179"></a><span id="l27.179" class="difflineplus">+        /id(&quot;messengerWindow&quot;)/id(&quot;navigation-toolbox&quot;)/id(&quot;tabs-toolbar&quot;)/id(&quot;tabmail-tabs&quot;)/[0]</span>
<a href="#l27.180"></a><span id="l27.180">     `));</span>
<a href="#l27.181"></a><span id="l27.181">     sleep();</span>
<a href="#l27.182"></a><span id="l27.182"> </span>
<a href="#l27.183"></a><span id="l27.183" class="difflineminus">-    // verify today pane open</span>
<a href="#l27.184"></a><span id="l27.184" class="difflineminus">-    controller.assertNotDOMProperty(lookup(`</span>
<a href="#l27.185"></a><span id="l27.185" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;today-pane-panel&quot;)</span>
<a href="#l27.186"></a><span id="l27.186" class="difflineminus">-    `), &quot;collapsed&quot;);</span>
<a href="#l27.187"></a><span id="l27.187" class="difflineplus">+    // Verify today pane open.</span>
<a href="#l27.188"></a><span id="l27.188" class="difflineplus">+    controller.assertNotDOMProperty(lookup(TODAY_PANE), &quot;collapsed&quot;);</span>
<a href="#l27.189"></a><span id="l27.189"> </span>
<a href="#l27.190"></a><span id="l27.190" class="difflineminus">-    // verify today pane's date</span>
<a href="#l27.191"></a><span id="l27.191" class="difflineplus">+    // Verify today pane's date.</span>
<a href="#l27.192"></a><span id="l27.192">     controller.assertValue(eid(&quot;datevalue-label&quot;), (new Date()).getDate());</span>
<a href="#l27.193"></a><span id="l27.193"> </span>
<a href="#l27.194"></a><span id="l27.194" class="difflineminus">-    // tomorrow and soon are collapsed by default</span>
<a href="#l27.195"></a><span id="l27.195" class="difflineminus">-    controller.click(lookup(`</span>
<a href="#l27.196"></a><span id="l27.196" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;today-pane-panel&quot;)/</span>
<a href="#l27.197"></a><span id="l27.197" class="difflineminus">-        [1]/id(&quot;agenda-panel&quot;)/[3]/id(&quot;agenda-listbox&quot;)/id(&quot;tomorrow-header&quot;)/</span>
<a href="#l27.198"></a><span id="l27.198" class="difflineplus">+    let expandArrow = `</span>
<a href="#l27.199"></a><span id="l27.199">         anon({&quot;anonid&quot;:&quot;agenda-checkbox-widget&quot;})/anon({&quot;class&quot;:&quot;checkbox-check&quot;})</span>
<a href="#l27.200"></a><span id="l27.200" class="difflineminus">-    `));</span>
<a href="#l27.201"></a><span id="l27.201" class="difflineminus">-    controller.click(lookup(`</span>
<a href="#l27.202"></a><span id="l27.202" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;today-pane-panel&quot;)/</span>
<a href="#l27.203"></a><span id="l27.203" class="difflineminus">-        [1]/id(&quot;agenda-panel&quot;)/[3]/id(&quot;agenda-listbox&quot;)/id(&quot;nextweek-header&quot;)/</span>
<a href="#l27.204"></a><span id="l27.204" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;agenda-checkbox-widget&quot;})/anon({&quot;class&quot;:&quot;checkbox-check&quot;})</span>
<a href="#l27.205"></a><span id="l27.205" class="difflineminus">-    `));</span>
<a href="#l27.206"></a><span id="l27.206" class="difflineplus">+    `;</span>
<a href="#l27.207"></a><span id="l27.207" class="difflineplus">+    // Tomorrow and soon are collapsed by default.</span>
<a href="#l27.208"></a><span id="l27.208" class="difflineplus">+    controller.click(lookup(`${AGENDA_LISTBOX}/id(&quot;tomorrow-header&quot;)/${expandArrow}`));</span>
<a href="#l27.209"></a><span id="l27.209" class="difflineplus">+    controller.click(lookup(`${AGENDA_LISTBOX}/id(&quot;nextweek-header&quot;)/${expandArrow}`));</span>
<a href="#l27.210"></a><span id="l27.210">     sleep();</span>
<a href="#l27.211"></a><span id="l27.211"> </span>
<a href="#l27.212"></a><span id="l27.212" class="difflineminus">-    // verify events shown in today pane</span>
<a href="#l27.213"></a><span id="l27.213" class="difflineplus">+    // Verify events shown in today pane.</span>
<a href="#l27.214"></a><span id="l27.214">     let now = new Date();</span>
<a href="#l27.215"></a><span id="l27.215">     now.setHours(startHour);</span>
<a href="#l27.216"></a><span id="l27.216">     now.setMinutes(0);</span>
<a href="#l27.217"></a><span id="l27.217">     let dtz = cal.dtz.defaultTimezone;</span>
<a href="#l27.218"></a><span id="l27.218">     let probeDate = cal.dtz.jsDateToDateTime(now, dtz);</span>
<a href="#l27.219"></a><span id="l27.219">     let dateFormatter = cal.getDateFormatter();</span>
<a href="#l27.220"></a><span id="l27.220">     let startTime = dateFormatter.formatTime(probeDate);</span>
<a href="#l27.221"></a><span id="l27.221" class="difflineminus">-    controller.assertText(lookup(`</span>
<a href="#l27.222"></a><span id="l27.222" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;today-pane-panel&quot;)/</span>
<a href="#l27.223"></a><span id="l27.223" class="difflineminus">-        [1]/id(&quot;agenda-panel&quot;)/{&quot;flex&quot;:&quot;1&quot;}/id(&quot;agenda-listbox&quot;)/[2]/</span>
<a href="#l27.224"></a><span id="l27.224" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;agenda-container-box&quot;})/</span>
<a href="#l27.225"></a><span id="l27.225" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;agenda-description&quot;})/[0]/</span>
<a href="#l27.226"></a><span id="l27.226" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;agenda-event-start&quot;})/</span>
<a href="#l27.227"></a><span id="l27.227" class="difflineminus">-    `), startTime + &quot; Today's Event&quot;);</span>
<a href="#l27.228"></a><span id="l27.228" class="difflineplus">+</span>
<a href="#l27.229"></a><span id="l27.229" class="difflineplus">+    let eventStart = `</span>
<a href="#l27.230"></a><span id="l27.230" class="difflineplus">+        anon({&quot;anonid&quot;:&quot;agenda-container-box&quot;})/anon({&quot;anonid&quot;:&quot;agenda-description&quot;})/[0]/</span>
<a href="#l27.231"></a><span id="l27.231" class="difflineplus">+        anon({&quot;anonid&quot;:&quot;agenda-event-start&quot;})</span>
<a href="#l27.232"></a><span id="l27.232" class="difflineplus">+    `;</span>
<a href="#l27.233"></a><span id="l27.233" class="difflineplus">+    controller.assertText(lookup(</span>
<a href="#l27.234"></a><span id="l27.234" class="difflineplus">+        `${AGENDA_LISTBOX}/[2]/${eventStart}`), startTime + &quot; Today's Event&quot;</span>
<a href="#l27.235"></a><span id="l27.235" class="difflineplus">+    );</span>
<a href="#l27.236"></a><span id="l27.236"> </span>
<a href="#l27.237"></a><span id="l27.237">     let tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 9, 0);</span>
<a href="#l27.238"></a><span id="l27.238">     probeDate = cal.dtz.jsDateToDateTime(tomorrow, dtz);</span>
<a href="#l27.239"></a><span id="l27.239">     startTime = dateFormatter.formatTime(probeDate);</span>
<a href="#l27.240"></a><span id="l27.240" class="difflineminus">-    controller.assertText(lookup(`</span>
<a href="#l27.241"></a><span id="l27.241" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;today-pane-panel&quot;)/</span>
<a href="#l27.242"></a><span id="l27.242" class="difflineminus">-        [1]/id(&quot;agenda-panel&quot;)/{&quot;flex&quot;:&quot;1&quot;}/id(&quot;agenda-listbox&quot;)/[4]/</span>
<a href="#l27.243"></a><span id="l27.243" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;agenda-container-box&quot;})/</span>
<a href="#l27.244"></a><span id="l27.244" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;agenda-description&quot;})/[0]/</span>
<a href="#l27.245"></a><span id="l27.245" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;agenda-event-start&quot;})/</span>
<a href="#l27.246"></a><span id="l27.246" class="difflineminus">-    `), startTime + &quot; Tomorrow's Event&quot;);</span>
<a href="#l27.247"></a><span id="l27.247" class="difflineplus">+    controller.assertText(lookup(</span>
<a href="#l27.248"></a><span id="l27.248" class="difflineplus">+        `${AGENDA_LISTBOX}/[4]/${eventStart}`), startTime + &quot; Tomorrow's Event&quot;</span>
<a href="#l27.249"></a><span id="l27.249" class="difflineplus">+    );</span>
<a href="#l27.250"></a><span id="l27.250"> </span>
<a href="#l27.251"></a><span id="l27.251">     let future = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 6, 9, 0);</span>
<a href="#l27.252"></a><span id="l27.252">     probeDate = cal.dtz.jsDateToDateTime(future, dtz);</span>
<a href="#l27.253"></a><span id="l27.253">     startTime = dateFormatter.formatDateTime(probeDate);</span>
<a href="#l27.254"></a><span id="l27.254"> </span>
<a href="#l27.255"></a><span id="l27.255" class="difflineminus">-    // Future event's start time</span>
<a href="#l27.256"></a><span id="l27.256" class="difflineminus">-    controller.assertText(lookup(`</span>
<a href="#l27.257"></a><span id="l27.257" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;today-pane-panel&quot;)/</span>
<a href="#l27.258"></a><span id="l27.258" class="difflineminus">-        [1]/id(&quot;agenda-panel&quot;)/</span>
<a href="#l27.259"></a><span id="l27.259" class="difflineminus">-        {&quot;flex&quot;:&quot;1&quot;}/id(&quot;agenda-listbox&quot;)/[6]/anon({&quot;anonid&quot;:&quot;agenda-container-box&quot;})/</span>
<a href="#l27.260"></a><span id="l27.260" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;agenda-description&quot;})/[0]/anon({&quot;anonid&quot;:&quot;agenda-event-start&quot;})</span>
<a href="#l27.261"></a><span id="l27.261" class="difflineminus">-     `), startTime);</span>
<a href="#l27.262"></a><span id="l27.262" class="difflineplus">+    // Future event's start time.</span>
<a href="#l27.263"></a><span id="l27.263" class="difflineplus">+    controller.assertText(lookup(`${AGENDA_LISTBOX}/[6]/${eventStart}`), startTime);</span>
<a href="#l27.264"></a><span id="l27.264"> </span>
<a href="#l27.265"></a><span id="l27.265" class="difflineminus">-    // Future event's title</span>
<a href="#l27.266"></a><span id="l27.266" class="difflineplus">+    // Future event's title.</span>
<a href="#l27.267"></a><span id="l27.267">     controller.assertText(lookup(`</span>
<a href="#l27.268"></a><span id="l27.268" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;today-pane-panel&quot;)/[1]/</span>
<a href="#l27.269"></a><span id="l27.269" class="difflineminus">-        id(&quot;agenda-panel&quot;)/{&quot;flex&quot;:&quot;1&quot;}/id(&quot;agenda-listbox&quot;)/[6]/</span>
<a href="#l27.270"></a><span id="l27.270" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;agenda-container-box&quot;})/</span>
<a href="#l27.271"></a><span id="l27.271" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;agenda-description&quot;})/</span>
<a href="#l27.272"></a><span id="l27.272" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;agenda-event-title&quot;})</span>
<a href="#l27.273"></a><span id="l27.273" class="difflineminus">-    `), &quot;Future's Event&quot;);</span>
<a href="#l27.274"></a><span id="l27.274" class="difflineplus">+        ${AGENDA_LISTBOX}/[6]/anon({&quot;anonid&quot;:&quot;agenda-container-box&quot;})/</span>
<a href="#l27.275"></a><span id="l27.275" class="difflineplus">+        anon({&quot;anonid&quot;:&quot;agenda-description&quot;})/anon({&quot;anonid&quot;:&quot;agenda-event-title&quot;})</span>
<a href="#l27.276"></a><span id="l27.276" class="difflineplus">+    `), &quot;Future Event&quot;);</span>
<a href="#l27.277"></a><span id="l27.277"> </span>
<a href="#l27.278"></a><span id="l27.278" class="difflineminus">-    // delete events</span>
<a href="#l27.279"></a><span id="l27.279" class="difflineminus">-    controller.click(lookup(`</span>
<a href="#l27.280"></a><span id="l27.280" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;today-pane-panel&quot;)/</span>
<a href="#l27.281"></a><span id="l27.281" class="difflineminus">-        [1]/id(&quot;agenda-panel&quot;)/{&quot;flex&quot;:&quot;1&quot;}/id(&quot;agenda-listbox&quot;)/[2]</span>
<a href="#l27.282"></a><span id="l27.282" class="difflineminus">-    `));</span>
<a href="#l27.283"></a><span id="l27.283" class="difflineplus">+    // Delete events.</span>
<a href="#l27.284"></a><span id="l27.284" class="difflineplus">+    controller.click(lookup(`${AGENDA_LISTBOX}/[2]`));</span>
<a href="#l27.285"></a><span id="l27.285"> </span>
<a href="#l27.286"></a><span id="l27.286">     controller.keypress(eid(&quot;agenda-listbox&quot;), &quot;VK_DELETE&quot;, {});</span>
<a href="#l27.287"></a><span id="l27.287" class="difflineminus">-    controller.waitForElementNotPresent(lookup(`</span>
<a href="#l27.288"></a><span id="l27.288" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;today-pane-panel&quot;)/</span>
<a href="#l27.289"></a><span id="l27.289" class="difflineminus">-        [1]/id(&quot;agenda-panel&quot;)/{&quot;flex&quot;:&quot;1&quot;}/id(&quot;agenda-listbox&quot;)/[6]</span>
<a href="#l27.290"></a><span id="l27.290" class="difflineminus">-    `));</span>
<a href="#l27.291"></a><span id="l27.291" class="difflineplus">+    controller.waitForElementNotPresent(lookup(`${AGENDA_LISTBOX}/[6]`));</span>
<a href="#l27.292"></a><span id="l27.292"> </span>
<a href="#l27.293"></a><span id="l27.293" class="difflineminus">-    controller.click(lookup(`</span>
<a href="#l27.294"></a><span id="l27.294" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;today-pane-panel&quot;)/</span>
<a href="#l27.295"></a><span id="l27.295" class="difflineminus">-        [1]/id(&quot;agenda-panel&quot;)/{&quot;flex&quot;:&quot;1&quot;}/id(&quot;agenda-listbox&quot;)/[3]</span>
<a href="#l27.296"></a><span id="l27.296" class="difflineminus">-    `));</span>
<a href="#l27.297"></a><span id="l27.297" class="difflineplus">+    controller.click(lookup(`${AGENDA_LISTBOX}/[3]`));</span>
<a href="#l27.298"></a><span id="l27.298">     controller.keypress(eid(&quot;agenda-listbox&quot;), &quot;VK_DELETE&quot;, {});</span>
<a href="#l27.299"></a><span id="l27.299" class="difflineminus">-    controller.waitForElementNotPresent(lookup(`</span>
<a href="#l27.300"></a><span id="l27.300" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;today-pane-panel&quot;)/</span>
<a href="#l27.301"></a><span id="l27.301" class="difflineminus">-        [1]/id(&quot;agenda-panel&quot;)/{&quot;flex&quot;:&quot;1&quot;}/id(&quot;agenda-listbox&quot;)/[5]</span>
<a href="#l27.302"></a><span id="l27.302" class="difflineminus">-    `));</span>
<a href="#l27.303"></a><span id="l27.303" class="difflineplus">+    controller.waitForElementNotPresent(lookup(`${AGENDA_LISTBOX}/[5]`));</span>
<a href="#l27.304"></a><span id="l27.304"> </span>
<a href="#l27.305"></a><span id="l27.305" class="difflineminus">-    controller.click(lookup(`</span>
<a href="#l27.306"></a><span id="l27.306" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;today-pane-panel&quot;)/</span>
<a href="#l27.307"></a><span id="l27.307" class="difflineminus">-        [1]/id(&quot;agenda-panel&quot;)/{&quot;flex&quot;:&quot;1&quot;}/id(&quot;agenda-listbox&quot;)/[4]</span>
<a href="#l27.308"></a><span id="l27.308" class="difflineminus">-    `));</span>
<a href="#l27.309"></a><span id="l27.309" class="difflineplus">+    controller.click(lookup(`${AGENDA_LISTBOX}/[4]`));</span>
<a href="#l27.310"></a><span id="l27.310">     controller.keypress(eid(&quot;agenda-listbox&quot;), &quot;VK_DELETE&quot;, {});</span>
<a href="#l27.311"></a><span id="l27.311" class="difflineminus">-    controller.waitForElementNotPresent(lookup(`</span>
<a href="#l27.312"></a><span id="l27.312" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;today-pane-panel&quot;)/</span>
<a href="#l27.313"></a><span id="l27.313" class="difflineminus">-        [1]/id(&quot;agenda-panel&quot;)/{&quot;flex&quot;:&quot;1&quot;}/id(&quot;agenda-listbox&quot;)/[4]</span>
<a href="#l27.314"></a><span id="l27.314" class="difflineminus">-    `));</span>
<a href="#l27.315"></a><span id="l27.315" class="difflineplus">+    controller.waitForElementNotPresent(lookup(`${AGENDA_LISTBOX}/[4]`));</span>
<a href="#l27.316"></a><span id="l27.316"> </span>
<a href="#l27.317"></a><span id="l27.317" class="difflineminus">-    // hide and verify today pane hidden</span>
<a href="#l27.318"></a><span id="l27.318" class="difflineplus">+    // Hide and verify today pane hidden.</span>
<a href="#l27.319"></a><span id="l27.319">     controller.click(eid(&quot;calendar-status-todaypane-button&quot;));</span>
<a href="#l27.320"></a><span id="l27.320">     controller.assertNode(lookup(`</span>
<a href="#l27.321"></a><span id="l27.321">         /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/{&quot;collapsed&quot;:&quot;true&quot;}</span>
<a href="#l27.322"></a><span id="l27.322">     `));</span>
<a href="#l27.323"></a><span id="l27.323"> </span>
<a href="#l27.324"></a><span id="l27.324" class="difflineminus">-    // reset today pane</span>
<a href="#l27.325"></a><span id="l27.325" class="difflineplus">+    // Reset today pane.</span>
<a href="#l27.326"></a><span id="l27.326">     controller.click(eid(&quot;calendar-status-todaypane-button&quot;));</span>
<a href="#l27.327"></a><span id="l27.327" class="difflineminus">-    controller.assertNotDOMProperty(lookup(`</span>
<a href="#l27.328"></a><span id="l27.328" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;today-pane-panel&quot;)</span>
<a href="#l27.329"></a><span id="l27.329" class="difflineminus">-    `), &quot;collapsed&quot;);</span>
<a href="#l27.330"></a><span id="l27.330" class="difflineminus">-    controller.click(lookup(`</span>
<a href="#l27.331"></a><span id="l27.331" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;today-pane-panel&quot;)/</span>
<a href="#l27.332"></a><span id="l27.332" class="difflineminus">-        [1]/id(&quot;agenda-panel&quot;)/[3]/id(&quot;agenda-listbox&quot;)/id(&quot;tomorrow-header&quot;)/</span>
<a href="#l27.333"></a><span id="l27.333" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;agenda-checkbox-widget&quot;})/anon({&quot;class&quot;:&quot;checkbox-check&quot;})</span>
<a href="#l27.334"></a><span id="l27.334" class="difflineminus">-    `));</span>
<a href="#l27.335"></a><span id="l27.335" class="difflineminus">-    controller.click(lookup(`</span>
<a href="#l27.336"></a><span id="l27.336" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;today-pane-panel&quot;)/</span>
<a href="#l27.337"></a><span id="l27.337" class="difflineminus">-        [1]/id(&quot;agenda-panel&quot;)/[3]/id(&quot;agenda-listbox&quot;)/id(&quot;nextweek-header&quot;)/</span>
<a href="#l27.338"></a><span id="l27.338" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;agenda-checkbox-widget&quot;})/anon({&quot;class&quot;:&quot;checkbox-check&quot;})</span>
<a href="#l27.339"></a><span id="l27.339" class="difflineminus">-    `));</span>
<a href="#l27.340"></a><span id="l27.340" class="difflineplus">+    controller.assertNotDOMProperty(lookup(TODAY_PANE), &quot;collapsed&quot;);</span>
<a href="#l27.341"></a><span id="l27.341" class="difflineplus">+    controller.click(lookup(`${AGENDA_LISTBOX}/id(&quot;tomorrow-header&quot;)/${expandArrow}`));</span>
<a href="#l27.342"></a><span id="l27.342" class="difflineplus">+    controller.click(lookup(`${AGENDA_LISTBOX}/id(&quot;nextweek-header&quot;)/${expandArrow}`));</span>
<a href="#l27.343"></a><span id="l27.343">     sleep();</span>
<a href="#l27.344"></a><span id="l27.344"> </span>
<a href="#l27.345"></a><span id="l27.345" class="difflineminus">-    // verify tomorrow and soon collapsed</span>
<a href="#l27.346"></a><span id="l27.346" class="difflineplus">+    // Verify tomorrow and soon collapsed.</span>
<a href="#l27.347"></a><span id="l27.347">     tomorrow = lookup(`</span>
<a href="#l27.348"></a><span id="l27.348" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;today-pane-panel&quot;)/</span>
<a href="#l27.349"></a><span id="l27.349" class="difflineminus">-        [1]/id(&quot;agenda-panel&quot;)/{&quot;flex&quot;:&quot;1&quot;}/id(&quot;agenda-listbox&quot;)/[1]/</span>
<a href="#l27.350"></a><span id="l27.350" class="difflineminus">-        anon({&quot;class&quot;:&quot;agenda-checkbox treenode-checkbox&quot;})</span>
<a href="#l27.351"></a><span id="l27.351" class="difflineplus">+        ${AGENDA_LISTBOX}/[1]/anon({&quot;class&quot;:&quot;agenda-checkbox treenode-checkbox&quot;})</span>
<a href="#l27.352"></a><span id="l27.352">     `).getNode();</span>
<a href="#l27.353"></a><span id="l27.353"> </span>
<a href="#l27.354"></a><span id="l27.354">     let soon = lookup(`</span>
<a href="#l27.355"></a><span id="l27.355" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;today-pane-panel&quot;)/</span>
<a href="#l27.356"></a><span id="l27.356" class="difflineminus">-        [1]/id(&quot;agenda-panel&quot;)/{&quot;flex&quot;:&quot;1&quot;}/id(&quot;agenda-listbox&quot;)/[2]/</span>
<a href="#l27.357"></a><span id="l27.357" class="difflineminus">-        anon({&quot;class&quot;:&quot;agenda-checkbox treenode-checkbox&quot;})</span>
<a href="#l27.358"></a><span id="l27.358" class="difflineplus">+        ${AGENDA_LISTBOX}/[2]/anon({&quot;class&quot;:&quot;agenda-checkbox treenode-checkbox&quot;})</span>
<a href="#l27.359"></a><span id="l27.359">     `).getNode();</span>
<a href="#l27.360"></a><span id="l27.360"> </span>
<a href="#l27.361"></a><span id="l27.361">     // TODO This is failing, which might actually be an error in our code!</span>
<a href="#l27.362"></a><span id="l27.362">     //  controller.assertJS(!tomorrow.hasAttribute(&quot;checked&quot;)</span>
<a href="#l27.363"></a><span id="l27.363">     //    || tomorrow.getAttribute(&quot;checked&quot;) != &quot;true&quot;);</span>
<a href="#l27.364"></a><span id="l27.364">     controller.assertJS(</span>
<a href="#l27.365"></a><span id="l27.365">         !soon.hasAttribute(&quot;checked&quot;) ||</span>
<a href="#l27.366"></a><span id="l27.366">         soon.getAttribute(&quot;checked&quot;) != &quot;true&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/calendar/test/mozmill/views/testDayView.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/calendar/test/mozmill/views/testDayView.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -1,144 +1,110 @@</span>
<a href="#l28.4"></a><span id="l28.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l28.5"></a><span id="l28.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l28.6"></a><span id="l28.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l28.7"></a><span id="l28.7"> </span>
<a href="#l28.8"></a><span id="l28.8" class="difflineplus">+var MODULE_NAME = &quot;testDayView&quot;;</span>
<a href="#l28.9"></a><span id="l28.9"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l28.10"></a><span id="l28.10" class="difflineminus">-var MODULE_REQUIRES = [&quot;calendar-utils&quot;];</span>
<a href="#l28.11"></a><span id="l28.11" class="difflineplus">+var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;item-editing-helpers&quot;];</span>
<a href="#l28.12"></a><span id="l28.12"> </span>
<a href="#l28.13"></a><span id="l28.13"> var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;, null);</span>
<a href="#l28.14"></a><span id="l28.14"> </span>
<a href="#l28.15"></a><span id="l28.15" class="difflineminus">-var helpersForController, invokeEventDialog, createCalendar, deleteCalendars;</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineminus">-var goToDate, setData, lookupEventBox;</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineminus">-var CALENDARNAME, CANVAS_BOX, EVENT_BOX;</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineplus">+var CALENDARNAME, CANVAS_BOX, EVENT_BOX, DAY_VIEW, LABELDAYBOX, EVENTPATH;</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineplus">+var helpersForController, invokeEventDialog, getEventDetails, createCalendar;</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineplus">+var deleteCalendars, goToDate, lookupEventBox;</span>
<a href="#l28.21"></a><span id="l28.21" class="difflineplus">+var helpersForEditUI, setData;</span>
<a href="#l28.22"></a><span id="l28.22"> </span>
<a href="#l28.23"></a><span id="l28.23" class="difflineminus">-var TITLE1 = &quot;Day View Event&quot;;</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineminus">-var TITLE2 = &quot;Day View Event Changed&quot;;</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineminus">-var DESC = &quot;Day View Event Description&quot;;</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineplus">+const TITLE1 = &quot;Day View Event&quot;;</span>
<a href="#l28.27"></a><span id="l28.27" class="difflineplus">+const TITLE2 = &quot;Day View Event Changed&quot;;</span>
<a href="#l28.28"></a><span id="l28.28" class="difflineplus">+const DESC = &quot;Day View Event Description&quot;;</span>
<a href="#l28.29"></a><span id="l28.29"> </span>
<a href="#l28.30"></a><span id="l28.30"> function setupModule(module) {</span>
<a href="#l28.31"></a><span id="l28.31">     controller = mozmill.getMail3PaneController();</span>
<a href="#l28.32"></a><span id="l28.32">     ({</span>
<a href="#l28.33"></a><span id="l28.33" class="difflineplus">+        CALENDARNAME,</span>
<a href="#l28.34"></a><span id="l28.34" class="difflineplus">+        CANVAS_BOX,</span>
<a href="#l28.35"></a><span id="l28.35" class="difflineplus">+        EVENT_BOX,</span>
<a href="#l28.36"></a><span id="l28.36" class="difflineplus">+        DAY_VIEW,</span>
<a href="#l28.37"></a><span id="l28.37" class="difflineplus">+        LABELDAYBOX,</span>
<a href="#l28.38"></a><span id="l28.38" class="difflineplus">+        EVENTPATH,</span>
<a href="#l28.39"></a><span id="l28.39">         helpersForController,</span>
<a href="#l28.40"></a><span id="l28.40">         invokeEventDialog,</span>
<a href="#l28.41"></a><span id="l28.41" class="difflineplus">+        getEventDetails,</span>
<a href="#l28.42"></a><span id="l28.42">         createCalendar,</span>
<a href="#l28.43"></a><span id="l28.43">         deleteCalendars,</span>
<a href="#l28.44"></a><span id="l28.44">         goToDate,</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineminus">-        setData,</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineminus">-        lookupEventBox,</span>
<a href="#l28.47"></a><span id="l28.47" class="difflineminus">-        CALENDARNAME,</span>
<a href="#l28.48"></a><span id="l28.48" class="difflineminus">-        CANVAS_BOX,</span>
<a href="#l28.49"></a><span id="l28.49" class="difflineminus">-        EVENT_BOX</span>
<a href="#l28.50"></a><span id="l28.50" class="difflineplus">+        lookupEventBox</span>
<a href="#l28.51"></a><span id="l28.51">     } = collector.getModule(&quot;calendar-utils&quot;));</span>
<a href="#l28.52"></a><span id="l28.52" class="difflineminus">-    collector.getModule(&quot;calendar-utils&quot;).setupModule();</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineplus">+    collector.getModule(&quot;calendar-utils&quot;).setupModule(controller);</span>
<a href="#l28.54"></a><span id="l28.54">     Object.assign(module, helpersForController(controller));</span>
<a href="#l28.55"></a><span id="l28.55"> </span>
<a href="#l28.56"></a><span id="l28.56" class="difflineplus">+    ({</span>
<a href="#l28.57"></a><span id="l28.57" class="difflineplus">+        helpersForEditUI,</span>
<a href="#l28.58"></a><span id="l28.58" class="difflineplus">+        setData</span>
<a href="#l28.59"></a><span id="l28.59" class="difflineplus">+    } = collector.getModule(&quot;item-editing-helpers&quot;));</span>
<a href="#l28.60"></a><span id="l28.60" class="difflineplus">+    collector.getModule(&quot;item-editing-helpers&quot;).setupModule(module);</span>
<a href="#l28.61"></a><span id="l28.61" class="difflineplus">+</span>
<a href="#l28.62"></a><span id="l28.62">     createCalendar(controller, CALENDARNAME);</span>
<a href="#l28.63"></a><span id="l28.63"> }</span>
<a href="#l28.64"></a><span id="l28.64"> </span>
<a href="#l28.65"></a><span id="l28.65"> function testDayView() {</span>
<a href="#l28.66"></a><span id="l28.66">     let dateFormatter = cal.getDateFormatter();</span>
<a href="#l28.67"></a><span id="l28.67" class="difflineminus">-    // paths</span>
<a href="#l28.68"></a><span id="l28.68" class="difflineminus">-    let dayView = `</span>
<a href="#l28.69"></a><span id="l28.69" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;tabmail&quot;)/id(&quot;tabmail-tabbox&quot;)/</span>
<a href="#l28.70"></a><span id="l28.70" class="difflineminus">-        id(&quot;tabpanelcontainer&quot;)/id(&quot;calendarTabPanel&quot;)/id(&quot;calendarContent&quot;)/</span>
<a href="#l28.71"></a><span id="l28.71" class="difflineminus">-        id(&quot;calendarDisplayDeck&quot;)/id(&quot;calendar-view-box&quot;)/id(&quot;view-deck&quot;)/</span>
<a href="#l28.72"></a><span id="l28.72" class="difflineminus">-        id(&quot;day-view&quot;)</span>
<a href="#l28.73"></a><span id="l28.73" class="difflineminus">-    `;</span>
<a href="#l28.74"></a><span id="l28.74" class="difflineminus">-</span>
<a href="#l28.75"></a><span id="l28.75" class="difflineminus">-    // open day view</span>
<a href="#l28.76"></a><span id="l28.76" class="difflineminus">-    controller.click(eid(&quot;calendar-tab-button&quot;));</span>
<a href="#l28.77"></a><span id="l28.77" class="difflineminus">-    controller.waitThenClick(eid(&quot;calendar-day-view-button&quot;));</span>
<a href="#l28.78"></a><span id="l28.78"> </span>
<a href="#l28.79"></a><span id="l28.79">     goToDate(controller, 2009, 1, 1);</span>
<a href="#l28.80"></a><span id="l28.80"> </span>
<a href="#l28.81"></a><span id="l28.81" class="difflineminus">-    // verify date in view</span>
<a href="#l28.82"></a><span id="l28.82" class="difflineminus">-    let day = lookup(`</span>
<a href="#l28.83"></a><span id="l28.83" class="difflineminus">-        ${dayView}/anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;labelbox&quot;})/</span>
<a href="#l28.84"></a><span id="l28.84" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;labeldaybox&quot;})/{&quot;flex&quot;:&quot;1&quot;}</span>
<a href="#l28.85"></a><span id="l28.85" class="difflineminus">-    `);</span>
<a href="#l28.86"></a><span id="l28.86" class="difflineplus">+    // Verify date in view.</span>
<a href="#l28.87"></a><span id="l28.87" class="difflineplus">+    let day = lookup(`${DAY_VIEW}/${LABELDAYBOX}/{&quot;flex&quot;:&quot;1&quot;}`);</span>
<a href="#l28.88"></a><span id="l28.88">     controller.waitFor(() =&gt; day.getNode().mDate.icalString == &quot;20090101&quot;);</span>
<a href="#l28.89"></a><span id="l28.89"> </span>
<a href="#l28.90"></a><span id="l28.90" class="difflineminus">-    // create event at 8 AM</span>
<a href="#l28.91"></a><span id="l28.91" class="difflineplus">+    // Create event at 8 AM.</span>
<a href="#l28.92"></a><span id="l28.92">     let eventBox = lookupEventBox(&quot;day&quot;, CANVAS_BOX, null, 1, 8);</span>
<a href="#l28.93"></a><span id="l28.93">     invokeEventDialog(controller, eventBox, (event, iframe) =&gt; {</span>
<a href="#l28.94"></a><span id="l28.94">         let { eid: eventid } = helpersForController(event);</span>
<a href="#l28.95"></a><span id="l28.95" class="difflineminus">-        let { lookup: iframeLookup } = helpersForController(iframe);</span>
<a href="#l28.96"></a><span id="l28.96" class="difflineplus">+        let { getDateTimePicker } = helpersForEditUI(iframe);</span>
<a href="#l28.97"></a><span id="l28.97"> </span>
<a href="#l28.98"></a><span id="l28.98" class="difflineminus">-        let innerFrame = '/id(&quot;calendar-event-dialog-inner&quot;)/id(&quot;event-grid&quot;)/id(&quot;event-grid-rows&quot;)/';</span>
<a href="#l28.99"></a><span id="l28.99" class="difflineminus">-        let dateInput = `</span>
<a href="#l28.100"></a><span id="l28.100" class="difflineminus">-            anon({&quot;class&quot;:&quot;datepicker-box-class&quot;})/{&quot;class&quot;:&quot;datepicker-text-class&quot;}/</span>
<a href="#l28.101"></a><span id="l28.101" class="difflineminus">-            anon({&quot;class&quot;:&quot;menulist-editable-box textbox-input-box&quot;})/</span>
<a href="#l28.102"></a><span id="l28.102" class="difflineminus">-            anon({&quot;anonid&quot;:&quot;input&quot;})</span>
<a href="#l28.103"></a><span id="l28.103" class="difflineminus">-        `;</span>
<a href="#l28.104"></a><span id="l28.104" class="difflineminus">-        let timeInput = `</span>
<a href="#l28.105"></a><span id="l28.105" class="difflineminus">-            anon({&quot;anonid&quot;:&quot;hbox&quot;})/anon({&quot;anonid&quot;:&quot;time-picker&quot;})/</span>
<a href="#l28.106"></a><span id="l28.106" class="difflineminus">-            anon({&quot;class&quot;:&quot;timepicker-box-class&quot;})/</span>
<a href="#l28.107"></a><span id="l28.107" class="difflineminus">-            anon({&quot;class&quot;:&quot;timepicker-text-class&quot;})/anon({&quot;flex&quot;:&quot;1&quot;})/</span>
<a href="#l28.108"></a><span id="l28.108" class="difflineminus">-            anon({&quot;anonid&quot;:&quot;input&quot;})</span>
<a href="#l28.109"></a><span id="l28.109" class="difflineminus">-        `;</span>
<a href="#l28.110"></a><span id="l28.110" class="difflineminus">-        let startId = &quot;event-starttime&quot;;</span>
<a href="#l28.111"></a><span id="l28.111" class="difflineplus">+        let startTimeInput = getDateTimePicker(&quot;STARTTIME&quot;);</span>
<a href="#l28.112"></a><span id="l28.112" class="difflineplus">+        let startDateInput = getDateTimePicker(&quot;STARTDATE&quot;);</span>
<a href="#l28.113"></a><span id="l28.113"> </span>
<a href="#l28.114"></a><span id="l28.114" class="difflineminus">-        let startTimeInput = iframeLookup(`</span>
<a href="#l28.115"></a><span id="l28.115" class="difflineminus">-            ${innerFrame}/id(&quot;event-grid-startdate-row&quot;)/</span>
<a href="#l28.116"></a><span id="l28.116" class="difflineminus">-            id(&quot;event-grid-startdate-picker-box&quot;)/id(&quot;${startId}&quot;)/${timeInput}</span>
<a href="#l28.117"></a><span id="l28.117" class="difflineminus">-        `);</span>
<a href="#l28.118"></a><span id="l28.118" class="difflineminus">-        let startDateInput = iframeLookup(`</span>
<a href="#l28.119"></a><span id="l28.119" class="difflineminus">-            ${innerFrame}/id(&quot;event-grid-startdate-row&quot;)/</span>
<a href="#l28.120"></a><span id="l28.120" class="difflineminus">-            id(&quot;event-grid-startdate-picker-box&quot;)/id(&quot;${startId}&quot;)/</span>
<a href="#l28.121"></a><span id="l28.121" class="difflineminus">-            anon({&quot;anonid&quot;:&quot;hbox&quot;})/anon({&quot;anonid&quot;:&quot;date-picker&quot;})/${dateInput}</span>
<a href="#l28.122"></a><span id="l28.122" class="difflineminus">-        `);</span>
<a href="#l28.123"></a><span id="l28.123" class="difflineminus">-</span>
<a href="#l28.124"></a><span id="l28.124" class="difflineminus">-        // check that the start time is correct</span>
<a href="#l28.125"></a><span id="l28.125" class="difflineplus">+        // Check that the start time is correct.</span>
<a href="#l28.126"></a><span id="l28.126">         let someDate = cal.createDateTime();</span>
<a href="#l28.127"></a><span id="l28.127">         someDate.resetTo(2009, 0, 1, 8, 0, 0, cal.dtz.floating);</span>
<a href="#l28.128"></a><span id="l28.128">         event.waitForElement(startTimeInput);</span>
<a href="#l28.129"></a><span id="l28.129">         event.assertValue(startTimeInput, dateFormatter.formatTime(someDate));</span>
<a href="#l28.130"></a><span id="l28.130">         event.assertValue(startDateInput, dateFormatter.formatDateShort(someDate));</span>
<a href="#l28.131"></a><span id="l28.131"> </span>
<a href="#l28.132"></a><span id="l28.132" class="difflineminus">-        // fill in title, description and calendar</span>
<a href="#l28.133"></a><span id="l28.133" class="difflineminus">-        setData(event, iframe, { title: TITLE1, description: DESC, calendar: CALENDARNAME });</span>
<a href="#l28.134"></a><span id="l28.134" class="difflineplus">+        // Fill in title, description and calendar.</span>
<a href="#l28.135"></a><span id="l28.135" class="difflineplus">+        setData(event, iframe, {</span>
<a href="#l28.136"></a><span id="l28.136" class="difflineplus">+            title: TITLE1,</span>
<a href="#l28.137"></a><span id="l28.137" class="difflineplus">+            description: DESC,</span>
<a href="#l28.138"></a><span id="l28.138" class="difflineplus">+            calendar: CALENDARNAME</span>
<a href="#l28.139"></a><span id="l28.139" class="difflineplus">+        });</span>
<a href="#l28.140"></a><span id="l28.140"> </span>
<a href="#l28.141"></a><span id="l28.141">         // save</span>
<a href="#l28.142"></a><span id="l28.142">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l28.143"></a><span id="l28.143">     });</span>
<a href="#l28.144"></a><span id="l28.144"> </span>
<a href="#l28.145"></a><span id="l28.145" class="difflineminus">-    // if it was created successfully, it can be opened</span>
<a href="#l28.146"></a><span id="l28.146" class="difflineminus">-    eventBox = lookupEventBox(</span>
<a href="#l28.147"></a><span id="l28.147" class="difflineminus">-        &quot;day&quot;, EVENT_BOX, null, 1, 8,</span>
<a href="#l28.148"></a><span id="l28.148" class="difflineminus">-        `/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;${CALENDARNAME.toLowerCase()}&quot;}`</span>
<a href="#l28.149"></a><span id="l28.149" class="difflineminus">-    );</span>
<a href="#l28.150"></a><span id="l28.150" class="difflineplus">+    // If it was created successfully, it can be opened.</span>
<a href="#l28.151"></a><span id="l28.151" class="difflineplus">+    eventBox = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null, EVENTPATH);</span>
<a href="#l28.152"></a><span id="l28.152">     invokeEventDialog(controller, eventBox, (event, iframe) =&gt; {</span>
<a href="#l28.153"></a><span id="l28.153">         let { eid: eventid } = helpersForController(event);</span>
<a href="#l28.154"></a><span id="l28.154"> </span>
<a href="#l28.155"></a><span id="l28.155" class="difflineminus">-        // change title and save changes</span>
<a href="#l28.156"></a><span id="l28.156" class="difflineplus">+        // Change title and save changes.</span>
<a href="#l28.157"></a><span id="l28.157">         setData(event, iframe, { title: TITLE2 });</span>
<a href="#l28.158"></a><span id="l28.158">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l28.159"></a><span id="l28.159">     });</span>
<a href="#l28.160"></a><span id="l28.160"> </span>
<a href="#l28.161"></a><span id="l28.161" class="difflineminus">-    // check if name was saved</span>
<a href="#l28.162"></a><span id="l28.162" class="difflineminus">-    let eventName = lookupEventBox(</span>
<a href="#l28.163"></a><span id="l28.163" class="difflineminus">-        &quot;day&quot;, EVENT_BOX, null, 1, 8,</span>
<a href="#l28.164"></a><span id="l28.164" class="difflineminus">-        `/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;${CALENDARNAME.toLowerCase()}&quot;}/</span>
<a href="#l28.165"></a><span id="l28.165" class="difflineminus">-        anon({&quot;flex&quot;:&quot;1&quot;})/anon({&quot;anonid&quot;:&quot;event-container&quot;})/</span>
<a href="#l28.166"></a><span id="l28.166" class="difflineminus">-        {&quot;class&quot;:&quot;calendar-event-selection&quot;}/anon({&quot;anonid&quot;:&quot;eventbox&quot;})/</span>
<a href="#l28.167"></a><span id="l28.167" class="difflineminus">-        {&quot;class&quot;:&quot;calendar-event-details&quot;}/anon({&quot;flex&quot;:&quot;1&quot;})/</span>
<a href="#l28.168"></a><span id="l28.168" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;event-name&quot;})`</span>
<a href="#l28.169"></a><span id="l28.169" class="difflineplus">+    // Check if name was saved.</span>
<a href="#l28.170"></a><span id="l28.170" class="difflineplus">+    let eventName = lookupEventBox(&quot;day&quot;, EVENT_BOX, null, 1, null,</span>
<a href="#l28.171"></a><span id="l28.171" class="difflineplus">+        `${EVENTPATH}/${getEventDetails(&quot;day&quot;)}/anon({&quot;flex&quot;:&quot;1&quot;})/anon({&quot;anonid&quot;:&quot;event-name&quot;})`</span>
<a href="#l28.172"></a><span id="l28.172">     );</span>
<a href="#l28.173"></a><span id="l28.173">     controller.waitForElement(eventName);</span>
<a href="#l28.174"></a><span id="l28.174">     controller.assertJSProperty(eventName, &quot;textContent&quot;, TITLE2);</span>
<a href="#l28.175"></a><span id="l28.175"> </span>
<a href="#l28.176"></a><span id="l28.176" class="difflineminus">-    // delete event</span>
<a href="#l28.177"></a><span id="l28.177" class="difflineminus">-    controller.click(lookupEventBox(</span>
<a href="#l28.178"></a><span id="l28.178" class="difflineminus">-        &quot;day&quot;, EVENT_BOX, null, 1, 8,</span>
<a href="#l28.179"></a><span id="l28.179" class="difflineminus">-        `/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;${CALENDARNAME.toLowerCase()}&quot;}`</span>
<a href="#l28.180"></a><span id="l28.180" class="difflineminus">-    ));</span>
<a href="#l28.181"></a><span id="l28.181" class="difflineplus">+    // Delete event</span>
<a href="#l28.182"></a><span id="l28.182" class="difflineplus">+    controller.click(eventBox);</span>
<a href="#l28.183"></a><span id="l28.183">     controller.keypress(eid(&quot;day-view&quot;), &quot;VK_DELETE&quot;, {});</span>
<a href="#l28.184"></a><span id="l28.184" class="difflineminus">-    controller.waitForElementNotPresent(lookupEventBox(</span>
<a href="#l28.185"></a><span id="l28.185" class="difflineminus">-        &quot;day&quot;, EVENT_BOX, null, 1, 8,</span>
<a href="#l28.186"></a><span id="l28.186" class="difflineminus">-        `/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;${CALENDARNAME.toLowerCase()}&quot;}`</span>
<a href="#l28.187"></a><span id="l28.187" class="difflineminus">-    ));</span>
<a href="#l28.188"></a><span id="l28.188" class="difflineplus">+    controller.waitForElementNotPresent(eventBox);</span>
<a href="#l28.189"></a><span id="l28.189"> }</span>
<a href="#l28.190"></a><span id="l28.190"> </span>
<a href="#l28.191"></a><span id="l28.191"> function teardownTest(module) {</span>
<a href="#l28.192"></a><span id="l28.192">     deleteCalendars(controller, CALENDARNAME);</span>
<a href="#l28.193"></a><span id="l28.193"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/calendar/test/mozmill/views/testMonthView.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/calendar/test/mozmill/views/testMonthView.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -1,147 +1,119 @@</span>
<a href="#l29.4"></a><span id="l29.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l29.5"></a><span id="l29.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l29.6"></a><span id="l29.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l29.7"></a><span id="l29.7"> </span>
<a href="#l29.8"></a><span id="l29.8" class="difflineplus">+var MODULE_NAME = &quot;testMonthView&quot;;</span>
<a href="#l29.9"></a><span id="l29.9"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l29.10"></a><span id="l29.10" class="difflineminus">-var MODULE_REQUIRES = [&quot;calendar-utils&quot;];</span>
<a href="#l29.11"></a><span id="l29.11" class="difflineplus">+var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;item-editing-helpers&quot;];</span>
<a href="#l29.12"></a><span id="l29.12"> </span>
<a href="#l29.13"></a><span id="l29.13"> var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;, null);</span>
<a href="#l29.14"></a><span id="l29.14"> </span>
<a href="#l29.15"></a><span id="l29.15" class="difflineminus">-var helpersForController, invokeEventDialog, createCalendar, deleteCalendars;</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineminus">-var goToDate, setData, lookupEventBox;</span>
<a href="#l29.17"></a><span id="l29.17" class="difflineminus">-var CALENDARNAME, CANVAS_BOX, EVENT_BOX;</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineplus">+var CALENDARNAME, EVENT_BOX, CANVAS_BOX, MONTH_VIEW, EVENTPATH;</span>
<a href="#l29.19"></a><span id="l29.19" class="difflineplus">+var helpersForController, switchToView, invokeEventDialog, getEventDetails, createCalendar;</span>
<a href="#l29.20"></a><span id="l29.20" class="difflineplus">+var deleteCalendars, goToDate, lookupEventBox;</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineplus">+var helpersForEditUI, setData;</span>
<a href="#l29.22"></a><span id="l29.22"> </span>
<a href="#l29.23"></a><span id="l29.23" class="difflineminus">-var TITLE1 = &quot;Month View Event&quot;;</span>
<a href="#l29.24"></a><span id="l29.24" class="difflineminus">-var TITLE2 = &quot;Month View Event Changed&quot;;</span>
<a href="#l29.25"></a><span id="l29.25" class="difflineminus">-var DESC = &quot;Month View Event Description&quot;;</span>
<a href="#l29.26"></a><span id="l29.26" class="difflineplus">+const TITLE1 = &quot;Month View Event&quot;;</span>
<a href="#l29.27"></a><span id="l29.27" class="difflineplus">+const TITLE2 = &quot;Month View Event Changed&quot;;</span>
<a href="#l29.28"></a><span id="l29.28" class="difflineplus">+const DESC = &quot;Month View Event Description&quot;;</span>
<a href="#l29.29"></a><span id="l29.29"> </span>
<a href="#l29.30"></a><span id="l29.30"> function setupModule(module) {</span>
<a href="#l29.31"></a><span id="l29.31">     controller = mozmill.getMail3PaneController();</span>
<a href="#l29.32"></a><span id="l29.32">     ({</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineplus">+        CALENDARNAME,</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineplus">+        EVENT_BOX,</span>
<a href="#l29.35"></a><span id="l29.35" class="difflineplus">+        CANVAS_BOX,</span>
<a href="#l29.36"></a><span id="l29.36" class="difflineplus">+        MONTH_VIEW,</span>
<a href="#l29.37"></a><span id="l29.37" class="difflineplus">+        EVENTPATH,</span>
<a href="#l29.38"></a><span id="l29.38">         helpersForController,</span>
<a href="#l29.39"></a><span id="l29.39" class="difflineplus">+        switchToView,</span>
<a href="#l29.40"></a><span id="l29.40">         invokeEventDialog,</span>
<a href="#l29.41"></a><span id="l29.41" class="difflineplus">+        getEventDetails,</span>
<a href="#l29.42"></a><span id="l29.42">         createCalendar,</span>
<a href="#l29.43"></a><span id="l29.43">         deleteCalendars,</span>
<a href="#l29.44"></a><span id="l29.44">         goToDate,</span>
<a href="#l29.45"></a><span id="l29.45" class="difflineminus">-        setData,</span>
<a href="#l29.46"></a><span id="l29.46" class="difflineminus">-        lookupEventBox,</span>
<a href="#l29.47"></a><span id="l29.47" class="difflineminus">-        CALENDARNAME,</span>
<a href="#l29.48"></a><span id="l29.48" class="difflineminus">-        CANVAS_BOX,</span>
<a href="#l29.49"></a><span id="l29.49" class="difflineminus">-        EVENT_BOX</span>
<a href="#l29.50"></a><span id="l29.50" class="difflineplus">+        lookupEventBox</span>
<a href="#l29.51"></a><span id="l29.51">     } = collector.getModule(&quot;calendar-utils&quot;));</span>
<a href="#l29.52"></a><span id="l29.52" class="difflineminus">-    collector.getModule(&quot;calendar-utils&quot;).setupModule();</span>
<a href="#l29.53"></a><span id="l29.53" class="difflineplus">+    collector.getModule(&quot;calendar-utils&quot;).setupModule(controller);</span>
<a href="#l29.54"></a><span id="l29.54">     Object.assign(module, helpersForController(controller));</span>
<a href="#l29.55"></a><span id="l29.55"> </span>
<a href="#l29.56"></a><span id="l29.56" class="difflineplus">+    ({</span>
<a href="#l29.57"></a><span id="l29.57" class="difflineplus">+        helpersForEditUI,</span>
<a href="#l29.58"></a><span id="l29.58" class="difflineplus">+        setData</span>
<a href="#l29.59"></a><span id="l29.59" class="difflineplus">+    } = collector.getModule(&quot;item-editing-helpers&quot;));</span>
<a href="#l29.60"></a><span id="l29.60" class="difflineplus">+    collector.getModule(&quot;item-editing-helpers&quot;).setupModule(module);</span>
<a href="#l29.61"></a><span id="l29.61" class="difflineplus">+</span>
<a href="#l29.62"></a><span id="l29.62">     createCalendar(controller, CALENDARNAME);</span>
<a href="#l29.63"></a><span id="l29.63"> }</span>
<a href="#l29.64"></a><span id="l29.64"> </span>
<a href="#l29.65"></a><span id="l29.65"> function testMonthView() {</span>
<a href="#l29.66"></a><span id="l29.66">     let dateFormatter = cal.getDateFormatter();</span>
<a href="#l29.67"></a><span id="l29.67" class="difflineminus">-    // paths</span>
<a href="#l29.68"></a><span id="l29.68" class="difflineminus">-    let monthView = `</span>
<a href="#l29.69"></a><span id="l29.69" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;tabmail&quot;)/id(&quot;tabmail-tabbox&quot;)/</span>
<a href="#l29.70"></a><span id="l29.70" class="difflineminus">-        id(&quot;tabpanelcontainer&quot;)/id(&quot;calendarTabPanel&quot;)/id(&quot;calendarContent&quot;)/</span>
<a href="#l29.71"></a><span id="l29.71" class="difflineminus">-        id(&quot;calendarDisplayDeck&quot;)/id(&quot;calendar-view-box&quot;)/id(&quot;view-deck&quot;)/</span>
<a href="#l29.72"></a><span id="l29.72" class="difflineminus">-        id(&quot;month-view&quot;)</span>
<a href="#l29.73"></a><span id="l29.73" class="difflineminus">-    `;</span>
<a href="#l29.74"></a><span id="l29.74"> </span>
<a href="#l29.75"></a><span id="l29.75" class="difflineminus">-    controller.click(eid(&quot;calendar-tab-button&quot;));</span>
<a href="#l29.76"></a><span id="l29.76" class="difflineminus">-    controller.waitThenClick(eid(&quot;calendar-month-view-button&quot;));</span>
<a href="#l29.77"></a><span id="l29.77" class="difflineminus">-</span>
<a href="#l29.78"></a><span id="l29.78" class="difflineplus">+    switchToView(controller, &quot;month&quot;);</span>
<a href="#l29.79"></a><span id="l29.79">     goToDate(controller, 2009, 1, 1);</span>
<a href="#l29.80"></a><span id="l29.80"> </span>
<a href="#l29.81"></a><span id="l29.81" class="difflineminus">-    // verify date</span>
<a href="#l29.82"></a><span id="l29.82" class="difflineplus">+    // Verify date.</span>
<a href="#l29.83"></a><span id="l29.83">     let day = lookup(`</span>
<a href="#l29.84"></a><span id="l29.84" class="difflineminus">-        ${monthView}/anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;monthgrid&quot;})/</span>
<a href="#l29.85"></a><span id="l29.85" class="difflineplus">+        ${MONTH_VIEW}/anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;monthgrid&quot;})/</span>
<a href="#l29.86"></a><span id="l29.86">         anon({&quot;anonid&quot;:&quot;monthgridrows&quot;})/[0]/{&quot;selected&quot;:&quot;true&quot;}</span>
<a href="#l29.87"></a><span id="l29.87">     `);</span>
<a href="#l29.88"></a><span id="l29.88">     controller.waitFor(() =&gt; day.getNode().mDate.icalString == &quot;20090101&quot;);</span>
<a href="#l29.89"></a><span id="l29.89"> </span>
<a href="#l29.90"></a><span id="l29.90" class="difflineminus">-    // create event</span>
<a href="#l29.91"></a><span id="l29.91" class="difflineminus">-    // Thursday of 2009-01-01 should be the selected box in the first row with default settings</span>
<a href="#l29.92"></a><span id="l29.92" class="difflineminus">-    let hour = new Date().getHours(); // remember time at click</span>
<a href="#l29.93"></a><span id="l29.93" class="difflineplus">+    // Create event.</span>
<a href="#l29.94"></a><span id="l29.94" class="difflineplus">+    // Thursday of 2009-01-01 should be the selected box in the first row with default settings.</span>
<a href="#l29.95"></a><span id="l29.95" class="difflineplus">+    let hour = new Date().getHours(); // Remember time at click.</span>
<a href="#l29.96"></a><span id="l29.96">     let eventBox = lookupEventBox(&quot;month&quot;, CANVAS_BOX, 1, 5);</span>
<a href="#l29.97"></a><span id="l29.97">     invokeEventDialog(controller, eventBox, (event, iframe) =&gt; {</span>
<a href="#l29.98"></a><span id="l29.98">         let { eid: eventid } = helpersForController(event);</span>
<a href="#l29.99"></a><span id="l29.99" class="difflineminus">-        let { lookup: iframeLookup } = helpersForController(iframe);</span>
<a href="#l29.100"></a><span id="l29.100" class="difflineplus">+        let { getDateTimePicker } = helpersForEditUI(iframe);</span>
<a href="#l29.101"></a><span id="l29.101"> </span>
<a href="#l29.102"></a><span id="l29.102" class="difflineminus">-        let innerFrame = '/id(&quot;calendar-event-dialog-inner&quot;)/id(&quot;event-grid&quot;)/id(&quot;event-grid-rows&quot;)/';</span>
<a href="#l29.103"></a><span id="l29.103" class="difflineminus">-        let dateInput = `</span>
<a href="#l29.104"></a><span id="l29.104" class="difflineminus">-            anon({&quot;class&quot;:&quot;datepicker-box-class&quot;})/{&quot;class&quot;:&quot;datepicker-text-class&quot;}/</span>
<a href="#l29.105"></a><span id="l29.105" class="difflineminus">-            anon({&quot;class&quot;:&quot;menulist-editable-box textbox-input-box&quot;})/</span>
<a href="#l29.106"></a><span id="l29.106" class="difflineminus">-            anon({&quot;anonid&quot;:&quot;input&quot;})</span>
<a href="#l29.107"></a><span id="l29.107" class="difflineminus">-        `;</span>
<a href="#l29.108"></a><span id="l29.108" class="difflineminus">-        let timeInput = `</span>
<a href="#l29.109"></a><span id="l29.109" class="difflineminus">-            anon({&quot;anonid&quot;:&quot;hbox&quot;})/anon({&quot;anonid&quot;:&quot;time-picker&quot;})/</span>
<a href="#l29.110"></a><span id="l29.110" class="difflineminus">-            anon({&quot;class&quot;:&quot;timepicker-box-class&quot;})/</span>
<a href="#l29.111"></a><span id="l29.111" class="difflineminus">-            anon({&quot;class&quot;:&quot;timepicker-text-class&quot;})/anon({&quot;flex&quot;:&quot;1&quot;})/</span>
<a href="#l29.112"></a><span id="l29.112" class="difflineminus">-            anon({&quot;anonid&quot;:&quot;input&quot;})</span>
<a href="#l29.113"></a><span id="l29.113" class="difflineminus">-        `;</span>
<a href="#l29.114"></a><span id="l29.114" class="difflineminus">-        let startId = &quot;event-starttime&quot;;</span>
<a href="#l29.115"></a><span id="l29.115" class="difflineplus">+        let startTimeInput = getDateTimePicker(&quot;STARTTIME&quot;);</span>
<a href="#l29.116"></a><span id="l29.116" class="difflineplus">+        let startDateInput = getDateTimePicker(&quot;STARTDATE&quot;);</span>
<a href="#l29.117"></a><span id="l29.117"> </span>
<a href="#l29.118"></a><span id="l29.118" class="difflineminus">-        let startTimeInput = iframeLookup(`</span>
<a href="#l29.119"></a><span id="l29.119" class="difflineminus">-            ${innerFrame}/id(&quot;event-grid-startdate-row&quot;)/</span>
<a href="#l29.120"></a><span id="l29.120" class="difflineminus">-            id(&quot;event-grid-startdate-picker-box&quot;)/id(&quot;${startId}&quot;)/${timeInput}</span>
<a href="#l29.121"></a><span id="l29.121" class="difflineminus">-        `);</span>
<a href="#l29.122"></a><span id="l29.122" class="difflineminus">-        let startDateInput = iframeLookup(`</span>
<a href="#l29.123"></a><span id="l29.123" class="difflineminus">-            ${innerFrame}/id(&quot;event-grid-startdate-row&quot;)/</span>
<a href="#l29.124"></a><span id="l29.124" class="difflineminus">-            id(&quot;event-grid-startdate-picker-box&quot;)/id(&quot;${startId}&quot;)/</span>
<a href="#l29.125"></a><span id="l29.125" class="difflineminus">-            anon({&quot;anonid&quot;:&quot;hbox&quot;})/anon({&quot;anonid&quot;:&quot;date-picker&quot;})/${dateInput}</span>
<a href="#l29.126"></a><span id="l29.126" class="difflineminus">-        `);</span>
<a href="#l29.127"></a><span id="l29.127" class="difflineminus">-</span>
<a href="#l29.128"></a><span id="l29.128" class="difflineminus">-        // check that the start time is correct</span>
<a href="#l29.129"></a><span id="l29.129" class="difflineminus">-        // next full hour except last hour hour of the day</span>
<a href="#l29.130"></a><span id="l29.130" class="difflineplus">+        // Check that the start time is correct.</span>
<a href="#l29.131"></a><span id="l29.131" class="difflineplus">+        // Next full hour except last hour hour of the day.</span>
<a href="#l29.132"></a><span id="l29.132">         let nextHour = hour == 23 ? hour : (hour + 1) % 24;</span>
<a href="#l29.133"></a><span id="l29.133">         let someDate = cal.dtz.now();</span>
<a href="#l29.134"></a><span id="l29.134">         someDate.resetTo(2009, 0, 1, nextHour, 0, 0, cal.dtz.floating);</span>
<a href="#l29.135"></a><span id="l29.135">         event.waitForElement(startTimeInput);</span>
<a href="#l29.136"></a><span id="l29.136">         event.assertValue(startTimeInput, dateFormatter.formatTime(someDate));</span>
<a href="#l29.137"></a><span id="l29.137">         event.assertValue(startDateInput, dateFormatter.formatDateShort(someDate));</span>
<a href="#l29.138"></a><span id="l29.138"> </span>
<a href="#l29.139"></a><span id="l29.139" class="difflineminus">-        // fill in title, description and calendar</span>
<a href="#l29.140"></a><span id="l29.140" class="difflineminus">-        setData(event, iframe, { title: TITLE1, description: DESC, calendar: CALENDARNAME });</span>
<a href="#l29.141"></a><span id="l29.141" class="difflineplus">+        // Fill in title, description and calendar.</span>
<a href="#l29.142"></a><span id="l29.142" class="difflineplus">+        setData(event, iframe, {</span>
<a href="#l29.143"></a><span id="l29.143" class="difflineplus">+            title: TITLE1,</span>
<a href="#l29.144"></a><span id="l29.144" class="difflineplus">+            description: DESC,</span>
<a href="#l29.145"></a><span id="l29.145" class="difflineplus">+            calendar: CALENDARNAME</span>
<a href="#l29.146"></a><span id="l29.146" class="difflineplus">+        });</span>
<a href="#l29.147"></a><span id="l29.147"> </span>
<a href="#l29.148"></a><span id="l29.148">         // save</span>
<a href="#l29.149"></a><span id="l29.149">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l29.150"></a><span id="l29.150">     });</span>
<a href="#l29.151"></a><span id="l29.151"> </span>
<a href="#l29.152"></a><span id="l29.152" class="difflineminus">-    // if it was created successfully, it can be opened</span>
<a href="#l29.153"></a><span id="l29.153" class="difflineminus">-    eventBox = lookupEventBox(</span>
<a href="#l29.154"></a><span id="l29.154" class="difflineminus">-        &quot;month&quot;, EVENT_BOX, 1, 5, null,</span>
<a href="#l29.155"></a><span id="l29.155" class="difflineminus">-        `/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;${CALENDARNAME.toLowerCase()}&quot;}`</span>
<a href="#l29.156"></a><span id="l29.156" class="difflineminus">-    );</span>
<a href="#l29.157"></a><span id="l29.157" class="difflineplus">+    // If it was created successfully, it can be opened.</span>
<a href="#l29.158"></a><span id="l29.158" class="difflineplus">+    eventBox = lookupEventBox(&quot;month&quot;, EVENT_BOX, 1, 5, null, EVENTPATH);</span>
<a href="#l29.159"></a><span id="l29.159">     invokeEventDialog(controller, eventBox, (event, iframe) =&gt; {</span>
<a href="#l29.160"></a><span id="l29.160">         let { eid: eventid } = helpersForController(event);</span>
<a href="#l29.161"></a><span id="l29.161"> </span>
<a href="#l29.162"></a><span id="l29.162" class="difflineminus">-        // change title and save changes</span>
<a href="#l29.163"></a><span id="l29.163" class="difflineplus">+        // Change title and save changes.</span>
<a href="#l29.164"></a><span id="l29.164">         setData(event, iframe, { title: TITLE2 });</span>
<a href="#l29.165"></a><span id="l29.165">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l29.166"></a><span id="l29.166">     });</span>
<a href="#l29.167"></a><span id="l29.167"> </span>
<a href="#l29.168"></a><span id="l29.168" class="difflineminus">-    // check if name was saved</span>
<a href="#l29.169"></a><span id="l29.169" class="difflineminus">-    let eventName = lookupEventBox(</span>
<a href="#l29.170"></a><span id="l29.170" class="difflineminus">-        &quot;month&quot;, EVENT_BOX, 1, 5, null,</span>
<a href="#l29.171"></a><span id="l29.171" class="difflineminus">-        `/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;${CALENDARNAME.toLowerCase()}&quot;}/</span>
<a href="#l29.172"></a><span id="l29.172" class="difflineminus">-        anon({&quot;flex&quot;:&quot;1&quot;})/[0]/anon({&quot;anonid&quot;:&quot;event-container&quot;})/</span>
<a href="#l29.173"></a><span id="l29.173" class="difflineminus">-        {&quot;class&quot;:&quot;calendar-event-selection&quot;}/anon({&quot;anonid&quot;:&quot;eventbox&quot;})/</span>
<a href="#l29.174"></a><span id="l29.174" class="difflineminus">-        {&quot;class&quot;:&quot;calendar-event-details&quot;}/{&quot;flex&quot;:&quot;1&quot;}/anon({&quot;anonid&quot;:&quot;event-name&quot;})`</span>
<a href="#l29.175"></a><span id="l29.175" class="difflineplus">+    // Check if name was saved.</span>
<a href="#l29.176"></a><span id="l29.176" class="difflineplus">+    let eventName = lookupEventBox(&quot;month&quot;, EVENT_BOX, 1, 5, null,</span>
<a href="#l29.177"></a><span id="l29.177" class="difflineplus">+        `${EVENTPATH}/${getEventDetails(&quot;month&quot;)}/anon({&quot;flex&quot;:&quot;1&quot;})/anon({&quot;anonid&quot;:&quot;event-name&quot;})`</span>
<a href="#l29.178"></a><span id="l29.178">     );</span>
<a href="#l29.179"></a><span id="l29.179"> </span>
<a href="#l29.180"></a><span id="l29.180">     controller.waitForElement(eventName);</span>
<a href="#l29.181"></a><span id="l29.181">     controller.assertValue(eventName, TITLE2);</span>
<a href="#l29.182"></a><span id="l29.182"> </span>
<a href="#l29.183"></a><span id="l29.183" class="difflineminus">-    // delete event</span>
<a href="#l29.184"></a><span id="l29.184" class="difflineminus">-    controller.click(lookupEventBox(</span>
<a href="#l29.185"></a><span id="l29.185" class="difflineminus">-        &quot;month&quot;, EVENT_BOX, 1, 5, null,</span>
<a href="#l29.186"></a><span id="l29.186" class="difflineminus">-        `/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;${CALENDARNAME.toLowerCase()}&quot;}`</span>
<a href="#l29.187"></a><span id="l29.187" class="difflineminus">-    ));</span>
<a href="#l29.188"></a><span id="l29.188" class="difflineplus">+    // Delete event.</span>
<a href="#l29.189"></a><span id="l29.189" class="difflineplus">+    controller.click(eventBox);</span>
<a href="#l29.190"></a><span id="l29.190">     controller.keypress(eid(&quot;month-view&quot;), &quot;VK_DELETE&quot;, {});</span>
<a href="#l29.191"></a><span id="l29.191" class="difflineminus">-    controller.waitForElementNotPresent(lookupEventBox(</span>
<a href="#l29.192"></a><span id="l29.192" class="difflineminus">-        &quot;month&quot;, EVENT_BOX, 1, 5, null,</span>
<a href="#l29.193"></a><span id="l29.193" class="difflineminus">-        `/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;${CALENDARNAME.toLowerCase()}&quot;}`</span>
<a href="#l29.194"></a><span id="l29.194" class="difflineminus">-    ));</span>
<a href="#l29.195"></a><span id="l29.195" class="difflineplus">+    controller.waitForElementNotPresent(eventBox);</span>
<a href="#l29.196"></a><span id="l29.196"> }</span>
<a href="#l29.197"></a><span id="l29.197"> </span>
<a href="#l29.198"></a><span id="l29.198"> function teardownTest(module) {</span>
<a href="#l29.199"></a><span id="l29.199">     deleteCalendars(controller, CALENDARNAME);</span>
<a href="#l29.200"></a><span id="l29.200"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/calendar/test/mozmill/views/testMultiweekView.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/calendar/test/mozmill/views/testMultiweekView.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -1,147 +1,120 @@</span>
<a href="#l30.4"></a><span id="l30.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l30.5"></a><span id="l30.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l30.6"></a><span id="l30.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l30.7"></a><span id="l30.7"> </span>
<a href="#l30.8"></a><span id="l30.8" class="difflineplus">+var MODULE_NAME = &quot;testMultiweekView&quot;;</span>
<a href="#l30.9"></a><span id="l30.9"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l30.10"></a><span id="l30.10" class="difflineminus">-var MODULE_REQUIRES = [&quot;calendar-utils&quot;];</span>
<a href="#l30.11"></a><span id="l30.11" class="difflineplus">+var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;item-editing-helpers&quot;];</span>
<a href="#l30.12"></a><span id="l30.12"> </span>
<a href="#l30.13"></a><span id="l30.13"> var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;, null);</span>
<a href="#l30.14"></a><span id="l30.14"> </span>
<a href="#l30.15"></a><span id="l30.15" class="difflineminus">-var helpersForController, invokeEventDialog, createCalendar, deleteCalendars;</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineminus">-var goToDate, setData, lookupEventBox;</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineminus">-var CALENDARNAME, CANVAS_BOX, EVENT_BOX;</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineplus">+var CALENDARNAME, EVENT_BOX, CANVAS_BOX, MULTIWEEK_VIEW, EVENTPATH;</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineplus">+var helpersForController, switchToView, invokeEventDialog, getEventDetails, createCalendar;</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineplus">+var deleteCalendars, goToDate, lookupEventBox;</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineplus">+var helpersForEditUI, setData;</span>
<a href="#l30.22"></a><span id="l30.22"> </span>
<a href="#l30.23"></a><span id="l30.23" class="difflineminus">-var TITLE1 = &quot;Multiweek View Event&quot;;</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineminus">-var TITLE2 = &quot;Multiweek View Event Changed&quot;;</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineminus">-var DESC = &quot;Multiweek View Event Description&quot;;</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineplus">+const TITLE1 = &quot;Multiweek View Event&quot;;</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineplus">+const TITLE2 = &quot;Multiweek View Event Changed&quot;;</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineplus">+const DESC = &quot;Multiweek View Event Description&quot;;</span>
<a href="#l30.29"></a><span id="l30.29"> </span>
<a href="#l30.30"></a><span id="l30.30"> function setupModule(module) {</span>
<a href="#l30.31"></a><span id="l30.31">     controller = mozmill.getMail3PaneController();</span>
<a href="#l30.32"></a><span id="l30.32">     ({</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineplus">+        CALENDARNAME,</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineplus">+        EVENT_BOX,</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineplus">+        CANVAS_BOX,</span>
<a href="#l30.36"></a><span id="l30.36" class="difflineplus">+        MULTIWEEK_VIEW,</span>
<a href="#l30.37"></a><span id="l30.37" class="difflineplus">+        EVENTPATH,</span>
<a href="#l30.38"></a><span id="l30.38">         helpersForController,</span>
<a href="#l30.39"></a><span id="l30.39" class="difflineplus">+        switchToView,</span>
<a href="#l30.40"></a><span id="l30.40">         invokeEventDialog,</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineplus">+        getEventDetails,</span>
<a href="#l30.42"></a><span id="l30.42">         createCalendar,</span>
<a href="#l30.43"></a><span id="l30.43">         deleteCalendars,</span>
<a href="#l30.44"></a><span id="l30.44">         goToDate,</span>
<a href="#l30.45"></a><span id="l30.45" class="difflineminus">-        setData,</span>
<a href="#l30.46"></a><span id="l30.46" class="difflineminus">-        lookupEventBox,</span>
<a href="#l30.47"></a><span id="l30.47" class="difflineminus">-        CALENDARNAME,</span>
<a href="#l30.48"></a><span id="l30.48" class="difflineminus">-        CANVAS_BOX,</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineminus">-        EVENT_BOX</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineplus">+        lookupEventBox</span>
<a href="#l30.51"></a><span id="l30.51">     } = collector.getModule(&quot;calendar-utils&quot;));</span>
<a href="#l30.52"></a><span id="l30.52" class="difflineminus">-    collector.getModule(&quot;calendar-utils&quot;).setupModule();</span>
<a href="#l30.53"></a><span id="l30.53" class="difflineplus">+    collector.getModule(&quot;calendar-utils&quot;).setupModule(controller);</span>
<a href="#l30.54"></a><span id="l30.54">     Object.assign(module, helpersForController(controller));</span>
<a href="#l30.55"></a><span id="l30.55"> </span>
<a href="#l30.56"></a><span id="l30.56" class="difflineplus">+    ({</span>
<a href="#l30.57"></a><span id="l30.57" class="difflineplus">+        helpersForEditUI,</span>
<a href="#l30.58"></a><span id="l30.58" class="difflineplus">+        setData</span>
<a href="#l30.59"></a><span id="l30.59" class="difflineplus">+    } = collector.getModule(&quot;item-editing-helpers&quot;));</span>
<a href="#l30.60"></a><span id="l30.60" class="difflineplus">+    collector.getModule(&quot;item-editing-helpers&quot;).setupModule(module);</span>
<a href="#l30.61"></a><span id="l30.61" class="difflineplus">+</span>
<a href="#l30.62"></a><span id="l30.62">     createCalendar(controller, CALENDARNAME);</span>
<a href="#l30.63"></a><span id="l30.63"> }</span>
<a href="#l30.64"></a><span id="l30.64"> </span>
<a href="#l30.65"></a><span id="l30.65"> function testMultiWeekView() {</span>
<a href="#l30.66"></a><span id="l30.66">     let dateFormatter = cal.getDateFormatter();</span>
<a href="#l30.67"></a><span id="l30.67" class="difflineminus">-    // paths</span>
<a href="#l30.68"></a><span id="l30.68" class="difflineminus">-    let multiWeekView = `</span>
<a href="#l30.69"></a><span id="l30.69" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;tabmail&quot;)/id(&quot;tabmail-tabbox&quot;)/</span>
<a href="#l30.70"></a><span id="l30.70" class="difflineminus">-        id(&quot;tabpanelcontainer&quot;)/id(&quot;calendarTabPanel&quot;)/id(&quot;calendarContent&quot;)/</span>
<a href="#l30.71"></a><span id="l30.71" class="difflineminus">-        id(&quot;calendarDisplayDeck&quot;)/id(&quot;calendar-view-box&quot;)/id(&quot;view-deck&quot;)/</span>
<a href="#l30.72"></a><span id="l30.72" class="difflineminus">-        id(&quot;multiweek-view&quot;)/</span>
<a href="#l30.73"></a><span id="l30.73" class="difflineminus">-    `;</span>
<a href="#l30.74"></a><span id="l30.74"> </span>
<a href="#l30.75"></a><span id="l30.75" class="difflineminus">-    controller.click(eid(&quot;calendar-tab-button&quot;));</span>
<a href="#l30.76"></a><span id="l30.76" class="difflineminus">-    controller.waitThenClick(eid(&quot;calendar-multiweek-view-button&quot;));</span>
<a href="#l30.77"></a><span id="l30.77" class="difflineminus">-</span>
<a href="#l30.78"></a><span id="l30.78" class="difflineplus">+    switchToView(controller, &quot;multiweek&quot;);</span>
<a href="#l30.79"></a><span id="l30.79">     goToDate(controller, 2009, 1, 1);</span>
<a href="#l30.80"></a><span id="l30.80"> </span>
<a href="#l30.81"></a><span id="l30.81" class="difflineminus">-    // verify date</span>
<a href="#l30.82"></a><span id="l30.82" class="difflineplus">+    // Verify date.</span>
<a href="#l30.83"></a><span id="l30.83">     let day = lookup(`</span>
<a href="#l30.84"></a><span id="l30.84" class="difflineminus">-        ${multiWeekView}/anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;monthgrid&quot;})/</span>
<a href="#l30.85"></a><span id="l30.85" class="difflineplus">+        ${MULTIWEEK_VIEW}/anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;monthgrid&quot;})/</span>
<a href="#l30.86"></a><span id="l30.86">         anon({&quot;anonid&quot;:&quot;monthgridrows&quot;})/[0]/{&quot;selected&quot;:&quot;true&quot;}</span>
<a href="#l30.87"></a><span id="l30.87">     `);</span>
<a href="#l30.88"></a><span id="l30.88">     controller.waitFor(() =&gt; day.getNode().mDate.icalString == &quot;20090101&quot;);</span>
<a href="#l30.89"></a><span id="l30.89"> </span>
<a href="#l30.90"></a><span id="l30.90" class="difflineminus">-    // create event</span>
<a href="#l30.91"></a><span id="l30.91" class="difflineminus">-    // Thursday of 2009-01-01 should be the selected box in the first row with default settings</span>
<a href="#l30.92"></a><span id="l30.92" class="difflineminus">-    let hour = new Date().getHours(); // remember time at click</span>
<a href="#l30.93"></a><span id="l30.93" class="difflineplus">+    // Create event.</span>
<a href="#l30.94"></a><span id="l30.94" class="difflineplus">+    // Thursday of 2009-01-01 should be the selected box in the first row with default settings.</span>
<a href="#l30.95"></a><span id="l30.95" class="difflineplus">+    let hour = new Date().getHours(); // Remember time at click.</span>
<a href="#l30.96"></a><span id="l30.96">     let eventBox = lookupEventBox(&quot;multiweek&quot;, CANVAS_BOX, 1, 5);</span>
<a href="#l30.97"></a><span id="l30.97">     invokeEventDialog(controller, eventBox, (event, iframe) =&gt; {</span>
<a href="#l30.98"></a><span id="l30.98">         let { eid: eventid } = helpersForController(event);</span>
<a href="#l30.99"></a><span id="l30.99" class="difflineminus">-        let { lookup: iframeLookup } = helpersForController(iframe);</span>
<a href="#l30.100"></a><span id="l30.100" class="difflineplus">+        let { getDateTimePicker } = helpersForEditUI(iframe);</span>
<a href="#l30.101"></a><span id="l30.101"> </span>
<a href="#l30.102"></a><span id="l30.102" class="difflineminus">-        let innerFrame = '/id(&quot;calendar-event-dialog-inner&quot;)/id(&quot;event-grid&quot;)/id(&quot;event-grid-rows&quot;)/';</span>
<a href="#l30.103"></a><span id="l30.103" class="difflineminus">-        let dateInput = `</span>
<a href="#l30.104"></a><span id="l30.104" class="difflineminus">-            anon({&quot;class&quot;:&quot;datepicker-box-class&quot;})/{&quot;class&quot;:&quot;datepicker-text-class&quot;}/</span>
<a href="#l30.105"></a><span id="l30.105" class="difflineminus">-            anon({&quot;class&quot;:&quot;menulist-editable-box textbox-input-box&quot;})/</span>
<a href="#l30.106"></a><span id="l30.106" class="difflineminus">-            anon({&quot;anonid&quot;:&quot;input&quot;})</span>
<a href="#l30.107"></a><span id="l30.107" class="difflineminus">-        `;</span>
<a href="#l30.108"></a><span id="l30.108" class="difflineminus">-        let timeInput = `</span>
<a href="#l30.109"></a><span id="l30.109" class="difflineminus">-            anon({&quot;anonid&quot;:&quot;hbox&quot;})/anon({&quot;anonid&quot;:&quot;time-picker&quot;})/</span>
<a href="#l30.110"></a><span id="l30.110" class="difflineminus">-            anon({&quot;class&quot;:&quot;timepicker-box-class&quot;})/</span>
<a href="#l30.111"></a><span id="l30.111" class="difflineminus">-            anon({&quot;class&quot;:&quot;timepicker-text-class&quot;})/anon({&quot;flex&quot;:&quot;1&quot;})/</span>
<a href="#l30.112"></a><span id="l30.112" class="difflineminus">-            anon({&quot;anonid&quot;:&quot;input&quot;})</span>
<a href="#l30.113"></a><span id="l30.113" class="difflineminus">-        `;</span>
<a href="#l30.114"></a><span id="l30.114" class="difflineminus">-        let startId = &quot;event-starttime&quot;;</span>
<a href="#l30.115"></a><span id="l30.115" class="difflineplus">+        let startTimeInput = getDateTimePicker(&quot;STARTTIME&quot;);</span>
<a href="#l30.116"></a><span id="l30.116" class="difflineplus">+        let startDateInput = getDateTimePicker(&quot;STARTDATE&quot;);</span>
<a href="#l30.117"></a><span id="l30.117"> </span>
<a href="#l30.118"></a><span id="l30.118" class="difflineminus">-        let startTimeInput = iframeLookup(`</span>
<a href="#l30.119"></a><span id="l30.119" class="difflineminus">-            ${innerFrame}/id(&quot;event-grid-startdate-row&quot;)/</span>
<a href="#l30.120"></a><span id="l30.120" class="difflineminus">-            id(&quot;event-grid-startdate-picker-box&quot;)/id(&quot;${startId}&quot;)/${timeInput}</span>
<a href="#l30.121"></a><span id="l30.121" class="difflineminus">-        `);</span>
<a href="#l30.122"></a><span id="l30.122" class="difflineminus">-        let startDateInput = iframeLookup(`</span>
<a href="#l30.123"></a><span id="l30.123" class="difflineminus">-            ${innerFrame}/id(&quot;event-grid-startdate-row&quot;)/</span>
<a href="#l30.124"></a><span id="l30.124" class="difflineminus">-            id(&quot;event-grid-startdate-picker-box&quot;)/id(&quot;${startId}&quot;)/</span>
<a href="#l30.125"></a><span id="l30.125" class="difflineminus">-            anon({&quot;anonid&quot;:&quot;hbox&quot;})/anon({&quot;anonid&quot;:&quot;date-picker&quot;})/${dateInput}</span>
<a href="#l30.126"></a><span id="l30.126" class="difflineminus">-        `);</span>
<a href="#l30.127"></a><span id="l30.127" class="difflineminus">-</span>
<a href="#l30.128"></a><span id="l30.128" class="difflineminus">-        // check that the start time is correct</span>
<a href="#l30.129"></a><span id="l30.129" class="difflineminus">-        // next full hour except last hour hour of the day</span>
<a href="#l30.130"></a><span id="l30.130" class="difflineplus">+        // Check that the start time is correct.</span>
<a href="#l30.131"></a><span id="l30.131" class="difflineplus">+        // Next full hour except last hour hour of the day.</span>
<a href="#l30.132"></a><span id="l30.132">         let nextHour = hour == 23 ? hour : (hour + 1) % 24;</span>
<a href="#l30.133"></a><span id="l30.133">         let someDate = cal.dtz.now();</span>
<a href="#l30.134"></a><span id="l30.134">         someDate.resetTo(2009, 0, 1, nextHour, 0, 0, cal.dtz.floating);</span>
<a href="#l30.135"></a><span id="l30.135">         event.waitForElement(startTimeInput);</span>
<a href="#l30.136"></a><span id="l30.136">         event.assertValue(startTimeInput, dateFormatter.formatTime(someDate));</span>
<a href="#l30.137"></a><span id="l30.137">         event.assertValue(startDateInput, dateFormatter.formatDateShort(someDate));</span>
<a href="#l30.138"></a><span id="l30.138"> </span>
<a href="#l30.139"></a><span id="l30.139" class="difflineminus">-        // fill in title, description and calendar</span>
<a href="#l30.140"></a><span id="l30.140" class="difflineminus">-        setData(event, iframe, { title: TITLE1, description: DESC, calendar: CALENDARNAME });</span>
<a href="#l30.141"></a><span id="l30.141" class="difflineplus">+        // Fill in title, description and calendar.</span>
<a href="#l30.142"></a><span id="l30.142" class="difflineplus">+        setData(event, iframe, {</span>
<a href="#l30.143"></a><span id="l30.143" class="difflineplus">+            title: TITLE1,</span>
<a href="#l30.144"></a><span id="l30.144" class="difflineplus">+            description: DESC,</span>
<a href="#l30.145"></a><span id="l30.145" class="difflineplus">+            calendar: CALENDARNAME</span>
<a href="#l30.146"></a><span id="l30.146" class="difflineplus">+        });</span>
<a href="#l30.147"></a><span id="l30.147"> </span>
<a href="#l30.148"></a><span id="l30.148">         // save</span>
<a href="#l30.149"></a><span id="l30.149">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l30.150"></a><span id="l30.150">     });</span>
<a href="#l30.151"></a><span id="l30.151"> </span>
<a href="#l30.152"></a><span id="l30.152" class="difflineminus">-    // if it was created successfully, it can be opened</span>
<a href="#l30.153"></a><span id="l30.153" class="difflineminus">-    eventBox = lookupEventBox(</span>
<a href="#l30.154"></a><span id="l30.154" class="difflineminus">-        &quot;multiweek&quot;, EVENT_BOX, 1, 5, null,</span>
<a href="#l30.155"></a><span id="l30.155" class="difflineminus">-        `/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;${CALENDARNAME.toLowerCase()}&quot;}`</span>
<a href="#l30.156"></a><span id="l30.156" class="difflineminus">-    );</span>
<a href="#l30.157"></a><span id="l30.157" class="difflineplus">+    // If it was created successfully, it can be opened.</span>
<a href="#l30.158"></a><span id="l30.158" class="difflineplus">+    eventBox = lookupEventBox(&quot;multiweek&quot;, EVENT_BOX, 1, 5, null, EVENTPATH);</span>
<a href="#l30.159"></a><span id="l30.159">     invokeEventDialog(controller, eventBox, (event, iframe) =&gt; {</span>
<a href="#l30.160"></a><span id="l30.160">         let { eid: eventid } = helpersForController(event);</span>
<a href="#l30.161"></a><span id="l30.161"> </span>
<a href="#l30.162"></a><span id="l30.162" class="difflineminus">-        // change title and save changes</span>
<a href="#l30.163"></a><span id="l30.163" class="difflineplus">+        // Change title and save changes.</span>
<a href="#l30.164"></a><span id="l30.164">         setData(event, iframe, { title: TITLE2 });</span>
<a href="#l30.165"></a><span id="l30.165">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l30.166"></a><span id="l30.166">     });</span>
<a href="#l30.167"></a><span id="l30.167"> </span>
<a href="#l30.168"></a><span id="l30.168" class="difflineminus">-    // check if name was saved</span>
<a href="#l30.169"></a><span id="l30.169" class="difflineminus">-    let eventName = lookupEventBox(</span>
<a href="#l30.170"></a><span id="l30.170" class="difflineminus">-        &quot;multiweek&quot;, EVENT_BOX, 1, 5, null,</span>
<a href="#l30.171"></a><span id="l30.171" class="difflineminus">-        `/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;${CALENDARNAME.toLowerCase()}&quot;}/</span>
<a href="#l30.172"></a><span id="l30.172" class="difflineminus">-        anon({&quot;flex&quot;:&quot;1&quot;})/[0]/anon({&quot;anonid&quot;:&quot;event-container&quot;})/</span>
<a href="#l30.173"></a><span id="l30.173" class="difflineminus">-        {&quot;class&quot;:&quot;calendar-event-selection&quot;}/anon({&quot;anonid&quot;:&quot;eventbox&quot;})/</span>
<a href="#l30.174"></a><span id="l30.174" class="difflineminus">-        {&quot;class&quot;:&quot;calendar-event-details&quot;}/{&quot;flex&quot;:&quot;1&quot;}/anon({&quot;anonid&quot;:&quot;event-name&quot;})`</span>
<a href="#l30.175"></a><span id="l30.175" class="difflineplus">+    // Check if name was saved.</span>
<a href="#l30.176"></a><span id="l30.176" class="difflineplus">+    let eventName = lookupEventBox(&quot;multiweek&quot;, EVENT_BOX, 1, 5, null,</span>
<a href="#l30.177"></a><span id="l30.177" class="difflineplus">+        `${EVENTPATH}/${getEventDetails(&quot;multiweek&quot;)}/anon({&quot;flex&quot;:&quot;1&quot;})/</span>
<a href="#l30.178"></a><span id="l30.178" class="difflineplus">+        anon({&quot;anonid&quot;:&quot;event-name&quot;})`</span>
<a href="#l30.179"></a><span id="l30.179">     );</span>
<a href="#l30.180"></a><span id="l30.180"> </span>
<a href="#l30.181"></a><span id="l30.181">     controller.waitForElement(eventName);</span>
<a href="#l30.182"></a><span id="l30.182">     controller.assertValue(eventName, TITLE2);</span>
<a href="#l30.183"></a><span id="l30.183"> </span>
<a href="#l30.184"></a><span id="l30.184" class="difflineminus">-    // delete event</span>
<a href="#l30.185"></a><span id="l30.185" class="difflineminus">-    controller.click(lookupEventBox(</span>
<a href="#l30.186"></a><span id="l30.186" class="difflineminus">-        &quot;multiweek&quot;, EVENT_BOX, 1, 5, null,</span>
<a href="#l30.187"></a><span id="l30.187" class="difflineminus">-        `/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;${CALENDARNAME.toLowerCase()}&quot;}`</span>
<a href="#l30.188"></a><span id="l30.188" class="difflineminus">-    ));</span>
<a href="#l30.189"></a><span id="l30.189" class="difflineplus">+    // Delete event.</span>
<a href="#l30.190"></a><span id="l30.190" class="difflineplus">+    controller.click(eventBox);</span>
<a href="#l30.191"></a><span id="l30.191">     controller.keypress(eid(&quot;multiweek-view&quot;), &quot;VK_DELETE&quot;, {});</span>
<a href="#l30.192"></a><span id="l30.192" class="difflineminus">-    controller.waitForElementNotPresent(lookupEventBox(</span>
<a href="#l30.193"></a><span id="l30.193" class="difflineminus">-        &quot;multiweek&quot;, EVENT_BOX, 1, 5, null,</span>
<a href="#l30.194"></a><span id="l30.194" class="difflineminus">-        `/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;${CALENDARNAME.toLowerCase()}&quot;}`</span>
<a href="#l30.195"></a><span id="l30.195" class="difflineminus">-    ));</span>
<a href="#l30.196"></a><span id="l30.196" class="difflineplus">+    controller.waitForElementNotPresent(eventBox);</span>
<a href="#l30.197"></a><span id="l30.197"> }</span>
<a href="#l30.198"></a><span id="l30.198"> </span>
<a href="#l30.199"></a><span id="l30.199"> function teardownTest(module) {</span>
<a href="#l30.200"></a><span id="l30.200">     deleteCalendars(controller, CALENDARNAME);</span>
<a href="#l30.201"></a><span id="l30.201"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/calendar/test/mozmill/views/testTaskView.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/calendar/test/mozmill/views/testTaskView.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -1,157 +1,157 @@</span>
<a href="#l31.4"></a><span id="l31.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l31.5"></a><span id="l31.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l31.6"></a><span id="l31.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l31.7"></a><span id="l31.7"> </span>
<a href="#l31.8"></a><span id="l31.8" class="difflineplus">+var MODULE_NAME = &quot;testTaskView&quot;;</span>
<a href="#l31.9"></a><span id="l31.9"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l31.10"></a><span id="l31.10"> var MODULE_REQUIRES = [&quot;calendar-utils&quot;];</span>
<a href="#l31.11"></a><span id="l31.11"> </span>
<a href="#l31.12"></a><span id="l31.12" class="difflineplus">+var CALENDARNAME, CALENDAR_PANEL, TASK_VIEW;</span>
<a href="#l31.13"></a><span id="l31.13"> var helpersForController, invokeEventDialog, createCalendar, deleteCalendars;</span>
<a href="#l31.14"></a><span id="l31.14"> var setData;</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineminus">-var CALENDARNAME;</span>
<a href="#l31.16"></a><span id="l31.16"> </span>
<a href="#l31.17"></a><span id="l31.17" class="difflineminus">-var TITLE = &quot;Task&quot;;</span>
<a href="#l31.18"></a><span id="l31.18" class="difflineminus">-var DESCRIPTION = &quot;1. Do A\n2. Do B&quot;;</span>
<a href="#l31.19"></a><span id="l31.19" class="difflineminus">-var percentComplete = &quot;50&quot;;</span>
<a href="#l31.20"></a><span id="l31.20" class="difflineplus">+const TITLE = &quot;Task&quot;;</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineplus">+const DESCRIPTION = &quot;1. Do A\n2. Do B&quot;;</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineplus">+const PERCENTCOMPLETE = &quot;50&quot;;</span>
<a href="#l31.23"></a><span id="l31.23"> </span>
<a href="#l31.24"></a><span id="l31.24"> function setupModule(module) {</span>
<a href="#l31.25"></a><span id="l31.25">     controller = mozmill.getMail3PaneController();</span>
<a href="#l31.26"></a><span id="l31.26">     ({</span>
<a href="#l31.27"></a><span id="l31.27" class="difflineplus">+        CALENDARNAME,</span>
<a href="#l31.28"></a><span id="l31.28" class="difflineplus">+        CALENDAR_PANEL,</span>
<a href="#l31.29"></a><span id="l31.29" class="difflineplus">+        TASK_VIEW,</span>
<a href="#l31.30"></a><span id="l31.30">         helpersForController,</span>
<a href="#l31.31"></a><span id="l31.31">         invokeEventDialog,</span>
<a href="#l31.32"></a><span id="l31.32">         createCalendar,</span>
<a href="#l31.33"></a><span id="l31.33" class="difflineminus">-        deleteCalendars,</span>
<a href="#l31.34"></a><span id="l31.34" class="difflineminus">-        setData,</span>
<a href="#l31.35"></a><span id="l31.35" class="difflineminus">-        CALENDARNAME</span>
<a href="#l31.36"></a><span id="l31.36" class="difflineplus">+        deleteCalendars</span>
<a href="#l31.37"></a><span id="l31.37">     } = collector.getModule(&quot;calendar-utils&quot;));</span>
<a href="#l31.38"></a><span id="l31.38" class="difflineminus">-    collector.getModule(&quot;calendar-utils&quot;).setupModule();</span>
<a href="#l31.39"></a><span id="l31.39" class="difflineplus">+    collector.getModule(&quot;calendar-utils&quot;).setupModule(controller);</span>
<a href="#l31.40"></a><span id="l31.40">     Object.assign(module, helpersForController(controller));</span>
<a href="#l31.41"></a><span id="l31.41"> </span>
<a href="#l31.42"></a><span id="l31.42" class="difflineplus">+    ({ setData } = collector.getModule(&quot;item-editing-helpers&quot;));</span>
<a href="#l31.43"></a><span id="l31.43" class="difflineplus">+    collector.getModule(&quot;item-editing-helpers&quot;).setupModule(module);</span>
<a href="#l31.44"></a><span id="l31.44" class="difflineplus">+</span>
<a href="#l31.45"></a><span id="l31.45">     createCalendar(controller, CALENDARNAME);</span>
<a href="#l31.46"></a><span id="l31.46"> }</span>
<a href="#l31.47"></a><span id="l31.47"> </span>
<a href="#l31.48"></a><span id="l31.48" class="difflineminus">-// mozmill doesn't support trees yet, therefore completed checkbox and line-through style are not</span>
<a href="#l31.49"></a><span id="l31.49" class="difflineminus">-// checked</span>
<a href="#l31.50"></a><span id="l31.50" class="difflineplus">+// Mozmill doesn't support trees yet, therefore completed checkbox and line-through style are not</span>
<a href="#l31.51"></a><span id="l31.51" class="difflineplus">+// checked.</span>
<a href="#l31.52"></a><span id="l31.52"> function testTaskView() {</span>
<a href="#l31.53"></a><span id="l31.53">     // paths</span>
<a href="#l31.54"></a><span id="l31.54" class="difflineminus">-    let taskView = `</span>
<a href="#l31.55"></a><span id="l31.55" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;tabmail&quot;)/id(&quot;tabmail-tabbox&quot;)/</span>
<a href="#l31.56"></a><span id="l31.56" class="difflineminus">-        id(&quot;tabpanelcontainer&quot;)/id(&quot;calendarTabPanel&quot;)/id(&quot;calendarContent&quot;)/</span>
<a href="#l31.57"></a><span id="l31.57" class="difflineminus">-        id(&quot;calendarDisplayDeck&quot;)/id(&quot;calendar-task-box&quot;)/</span>
<a href="#l31.58"></a><span id="l31.58" class="difflineplus">+    let treeChildren = `</span>
<a href="#l31.59"></a><span id="l31.59" class="difflineplus">+        ${TASK_VIEW}/[1]/id(&quot;calendar-task-tree&quot;)/anon({&quot;anonid&quot;:&quot;calendar-task-tree&quot;})/</span>
<a href="#l31.60"></a><span id="l31.60" class="difflineplus">+        {&quot;tooltip&quot;:&quot;taskTreeTooltip&quot;}</span>
<a href="#l31.61"></a><span id="l31.61">     `;</span>
<a href="#l31.62"></a><span id="l31.62" class="difflineminus">-    let treeChildren = `</span>
<a href="#l31.63"></a><span id="l31.63" class="difflineminus">-        ${taskView}/[1]/id(&quot;calendar-task-tree&quot;)/</span>
<a href="#l31.64"></a><span id="l31.64" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;calendar-task-tree&quot;})/{&quot;tooltip&quot;:&quot;taskTreeTooltip&quot;}</span>
<a href="#l31.65"></a><span id="l31.65" class="difflineminus">-    `;</span>
<a href="#l31.66"></a><span id="l31.66" class="difflineminus">-    let taskTree = taskView + '[1]/id(&quot;calendar-task-tree&quot;)';</span>
<a href="#l31.67"></a><span id="l31.67" class="difflineplus">+    let taskTree = TASK_VIEW + '[1]/id(&quot;calendar-task-tree&quot;)';</span>
<a href="#l31.68"></a><span id="l31.68">     let toolTip = '/id(&quot;messengerWindow&quot;)/id(&quot;calendar-popupset&quot;)/id(&quot;taskTreeTooltip&quot;)';</span>
<a href="#l31.69"></a><span id="l31.69">     let toolTipGrid = toolTip + '/{&quot;class&quot;:&quot;tooltipBox&quot;}/{&quot;class&quot;:&quot;tooltipHeaderGrid&quot;}/';</span>
<a href="#l31.70"></a><span id="l31.70"> </span>
<a href="#l31.71"></a><span id="l31.71" class="difflineminus">-    // open task view</span>
<a href="#l31.72"></a><span id="l31.72" class="difflineplus">+    // Open task view.</span>
<a href="#l31.73"></a><span id="l31.73">     controller.click(eid(&quot;task-tab-button&quot;));</span>
<a href="#l31.74"></a><span id="l31.74">     sleep();</span>
<a href="#l31.75"></a><span id="l31.75"> </span>
<a href="#l31.76"></a><span id="l31.76" class="difflineminus">-    // make sure that testing calendar is selected</span>
<a href="#l31.77"></a><span id="l31.77" class="difflineplus">+    // Make sure that testing calendar is selected.</span>
<a href="#l31.78"></a><span id="l31.78">     let calendarTree = lookup(`</span>
<a href="#l31.79"></a><span id="l31.79" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;tabmail&quot;)/id(&quot;tabmail-tabbox&quot;)/</span>
<a href="#l31.80"></a><span id="l31.80" class="difflineminus">-        id(&quot;tabpanelcontainer&quot;)/id(&quot;calendarTabPanel&quot;)/id(&quot;calendarContent&quot;)/</span>
<a href="#l31.81"></a><span id="l31.81" class="difflineminus">-        id(&quot;ltnSidebar&quot;)/id(&quot;calendar-panel&quot;)/id(&quot;calendar-list-pane&quot;)/</span>
<a href="#l31.82"></a><span id="l31.82" class="difflineplus">+        ${CALENDAR_PANEL}/id(&quot;ltnSidebar&quot;)/id(&quot;calendar-panel&quot;)/id(&quot;calendar-list-pane&quot;)/</span>
<a href="#l31.83"></a><span id="l31.83">         id(&quot;calendar-listtree-pane&quot;)/id(&quot;calendar-list-tree-widget&quot;)</span>
<a href="#l31.84"></a><span id="l31.84">     `).getNode();</span>
<a href="#l31.85"></a><span id="l31.85"> </span>
<a href="#l31.86"></a><span id="l31.86">     for (let i = 0; i &lt; calendarTree.mCalendarList.length; i++) {</span>
<a href="#l31.87"></a><span id="l31.87">         if (calendarTree.mCalendarList[i].name == CALENDARNAME) {</span>
<a href="#l31.88"></a><span id="l31.88">             calendarTree.tree.view.selection.select(i);</span>
<a href="#l31.89"></a><span id="l31.89">         }</span>
<a href="#l31.90"></a><span id="l31.90">     }</span>
<a href="#l31.91"></a><span id="l31.91"> </span>
<a href="#l31.92"></a><span id="l31.92">     let taskTreeNode = lookup(taskTree).getNode();</span>
<a href="#l31.93"></a><span id="l31.93">     let countBefore = taskTreeNode.mTaskArray.length;</span>
<a href="#l31.94"></a><span id="l31.94"> </span>
<a href="#l31.95"></a><span id="l31.95" class="difflineminus">-    // add task</span>
<a href="#l31.96"></a><span id="l31.96" class="difflineminus">-    controller.type(lookup(`</span>
<a href="#l31.97"></a><span id="l31.97" class="difflineminus">-        ${taskView}/id(&quot;task-addition-box&quot;)/[0]/id(&quot;view-task-edit-field&quot;)/</span>
<a href="#l31.98"></a><span id="l31.98" class="difflineplus">+    // Add task.</span>
<a href="#l31.99"></a><span id="l31.99" class="difflineplus">+    let taskInput= lookup(`</span>
<a href="#l31.100"></a><span id="l31.100" class="difflineplus">+        ${TASK_VIEW}/id(&quot;task-addition-box&quot;)/[0]/id(&quot;view-task-edit-field&quot;)/</span>
<a href="#l31.101"></a><span id="l31.101">         anon({&quot;anonid&quot;:&quot;moz-input-box&quot;})/anon({&quot;anonid&quot;:&quot;input&quot;})</span>
<a href="#l31.102"></a><span id="l31.102" class="difflineminus">-    `), TITLE);</span>
<a href="#l31.103"></a><span id="l31.103" class="difflineminus">-    controller.keypress(lookup(`</span>
<a href="#l31.104"></a><span id="l31.104" class="difflineminus">-        ${taskView}/id(&quot;task-addition-box&quot;)/[0]/id(&quot;view-task-edit-field&quot;)/</span>
<a href="#l31.105"></a><span id="l31.105" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;moz-input-box&quot;})/anon({&quot;anonid&quot;:&quot;input&quot;})</span>
<a href="#l31.106"></a><span id="l31.106" class="difflineminus">-    `), &quot;VK_RETURN&quot;, {});</span>
<a href="#l31.107"></a><span id="l31.107" class="difflineplus">+    `);</span>
<a href="#l31.108"></a><span id="l31.108" class="difflineplus">+    controller.type(taskInput, TITLE);</span>
<a href="#l31.109"></a><span id="l31.109" class="difflineplus">+    controller.keypress(taskInput, &quot;VK_RETURN&quot;, {});</span>
<a href="#l31.110"></a><span id="l31.110"> </span>
<a href="#l31.111"></a><span id="l31.111" class="difflineminus">-    // verify added</span>
<a href="#l31.112"></a><span id="l31.112" class="difflineplus">+    // Verify added.</span>
<a href="#l31.113"></a><span id="l31.113">     let countAfter;</span>
<a href="#l31.114"></a><span id="l31.114">     controller.waitFor(() =&gt; {</span>
<a href="#l31.115"></a><span id="l31.115">         countAfter = taskTreeNode.mTaskArray.length;</span>
<a href="#l31.116"></a><span id="l31.116">         return countBefore + 1 == countAfter;</span>
<a href="#l31.117"></a><span id="l31.117" class="difflineminus">-    });</span>
<a href="#l31.118"></a><span id="l31.118" class="difflineplus">+    }, &quot;Added Task did not appear&quot;);</span>
<a href="#l31.119"></a><span id="l31.119"> </span>
<a href="#l31.120"></a><span id="l31.120" class="difflineminus">-    // last added task is automatically selected so verify detail window data</span>
<a href="#l31.121"></a><span id="l31.121" class="difflineplus">+    // Last added task is automatically selected so verify detail window data.</span>
<a href="#l31.122"></a><span id="l31.122">     controller.assertJSProperty(eid(&quot;calendar-task-details-title&quot;), &quot;textContent&quot;, TITLE);</span>
<a href="#l31.123"></a><span id="l31.123"> </span>
<a href="#l31.124"></a><span id="l31.124" class="difflineminus">-    // open added task</span>
<a href="#l31.125"></a><span id="l31.125" class="difflineminus">-    // doubleclick on completion checkbox is ignored as opening action, so don't click at immediate</span>
<a href="#l31.126"></a><span id="l31.126" class="difflineminus">-    // left where the checkbox is located</span>
<a href="#l31.127"></a><span id="l31.127" class="difflineplus">+    // Open added task</span>
<a href="#l31.128"></a><span id="l31.128" class="difflineplus">+    // Doubleclick on completion checkbox is ignored as opening action, so don't</span>
<a href="#l31.129"></a><span id="l31.129" class="difflineplus">+    // click at immediate left where the checkbox is located.</span>
<a href="#l31.130"></a><span id="l31.130">     controller.doubleClick(lookup(treeChildren), 50, 0);</span>
<a href="#l31.131"></a><span id="l31.131">     invokeEventDialog(controller, null, (task, iframe) =&gt; {</span>
<a href="#l31.132"></a><span id="l31.132">         let { eid: taskid } = helpersForController(task);</span>
<a href="#l31.133"></a><span id="l31.133">         let { eid: iframeId } = helpersForController(iframe);</span>
<a href="#l31.134"></a><span id="l31.134"> </span>
<a href="#l31.135"></a><span id="l31.135" class="difflineminus">-        // verify calendar</span>
<a href="#l31.136"></a><span id="l31.136" class="difflineplus">+        // Verify calendar.</span>
<a href="#l31.137"></a><span id="l31.137">         controller.assertValue(iframeId(&quot;item-calendar&quot;), CALENDARNAME);</span>
<a href="#l31.138"></a><span id="l31.138"> </span>
<a href="#l31.139"></a><span id="l31.139" class="difflineminus">-        setData(task, iframe, { status: &quot;needs-action&quot;, percent: percentComplete, description: DESCRIPTION });</span>
<a href="#l31.140"></a><span id="l31.140" class="difflineplus">+        setData(task, iframe, {</span>
<a href="#l31.141"></a><span id="l31.141" class="difflineplus">+            status: &quot;needs-action&quot;,</span>
<a href="#l31.142"></a><span id="l31.142" class="difflineplus">+            percent: PERCENTCOMPLETE,</span>
<a href="#l31.143"></a><span id="l31.143" class="difflineplus">+            description: DESCRIPTION</span>
<a href="#l31.144"></a><span id="l31.144" class="difflineplus">+        });</span>
<a href="#l31.145"></a><span id="l31.145"> </span>
<a href="#l31.146"></a><span id="l31.146">         // save</span>
<a href="#l31.147"></a><span id="l31.147">         task.click(taskid(&quot;button-saveandclose&quot;));</span>
<a href="#l31.148"></a><span id="l31.148">     });</span>
<a href="#l31.149"></a><span id="l31.149"> </span>
<a href="#l31.150"></a><span id="l31.150" class="difflineminus">-    // verify description and status in details pane</span>
<a href="#l31.151"></a><span id="l31.151" class="difflineplus">+    // Verify description and status in details pane.</span>
<a href="#l31.152"></a><span id="l31.152">     controller.assertValue(lookup(`</span>
<a href="#l31.153"></a><span id="l31.153" class="difflineminus">-        ${taskView}/{&quot;flex&quot;:&quot;1&quot;}/id(&quot;calendar-task-details-container&quot;)/</span>
<a href="#l31.154"></a><span id="l31.154" class="difflineminus">-        id(&quot;calendar-task-details-description&quot;)/</span>
<a href="#l31.155"></a><span id="l31.155" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;moz-input-box&quot;})/anon({&quot;anonid&quot;:&quot;input&quot;})</span>
<a href="#l31.156"></a><span id="l31.156" class="difflineplus">+        ${TASK_VIEW}/{&quot;flex&quot;:&quot;1&quot;}/id(&quot;calendar-task-details-container&quot;)/</span>
<a href="#l31.157"></a><span id="l31.157" class="difflineplus">+        id(&quot;calendar-task-details-description&quot;)/anon({&quot;anonid&quot;:&quot;moz-input-box&quot;})/</span>
<a href="#l31.158"></a><span id="l31.158" class="difflineplus">+        anon({&quot;anonid&quot;:&quot;input&quot;})</span>
<a href="#l31.159"></a><span id="l31.159">     `), DESCRIPTION);</span>
<a href="#l31.160"></a><span id="l31.160">     controller.assertValue(eid(&quot;calendar-task-details-status&quot;), &quot;Needs Action&quot;);</span>
<a href="#l31.161"></a><span id="l31.161"> </span>
<a href="#l31.162"></a><span id="l31.162">     // This is a hack.</span>
<a href="#l31.163"></a><span id="l31.163">     taskTreeNode.getTaskAtRow(0).calendar.setProperty(&quot;capabilities.priority.supported&quot;, true);</span>
<a href="#l31.164"></a><span id="l31.164"> </span>
<a href="#l31.165"></a><span id="l31.165" class="difflineminus">-    // set high priority and verify it in detail pane</span>
<a href="#l31.166"></a><span id="l31.166" class="difflineplus">+    // Set high priority and verify it in detail pane.</span>
<a href="#l31.167"></a><span id="l31.167">     controller.click(eid(&quot;task-actions-priority&quot;));</span>
<a href="#l31.168"></a><span id="l31.168">     sleep();</span>
<a href="#l31.169"></a><span id="l31.169">     controller.click(eid(&quot;priority-1-menuitem&quot;));</span>
<a href="#l31.170"></a><span id="l31.170">     sleep();</span>
<a href="#l31.171"></a><span id="l31.171">     let priorityNode = eid(&quot;calendar-task-details-priority-high&quot;);</span>
<a href="#l31.172"></a><span id="l31.172">     controller.assertNotDOMProperty(priorityNode, &quot;hidden&quot;);</span>
<a href="#l31.173"></a><span id="l31.173"> </span>
<a href="#l31.174"></a><span id="l31.174" class="difflineminus">-    // verify that tooltip shows status, priority and percent complete</span>
<a href="#l31.175"></a><span id="l31.175" class="difflineplus">+    // Verify that tooltip shows status, priority and percent complete.</span>
<a href="#l31.176"></a><span id="l31.176">     let toolTipNode = lookup(toolTip).getNode();</span>
<a href="#l31.177"></a><span id="l31.177">     toolTipNode.ownerGlobal.showToolTip(toolTipNode, taskTreeNode.getTaskAtRow(0));</span>
<a href="#l31.178"></a><span id="l31.178"> </span>
<a href="#l31.179"></a><span id="l31.179">     let toolTipName = lookup(toolTipGrid + &quot;[1]/[0]/[1]&quot;);</span>
<a href="#l31.180"></a><span id="l31.180">     let toolTipCalendar = lookup(toolTipGrid + &quot;[1]/[1]/[1]&quot;);</span>
<a href="#l31.181"></a><span id="l31.181">     let toolTipPriority = lookup(toolTipGrid + &quot;[1]/[2]/[1]&quot;);</span>
<a href="#l31.182"></a><span id="l31.182">     let toolTipStatus = lookup(toolTipGrid + &quot;[1]/[3]/[1]&quot;);</span>
<a href="#l31.183"></a><span id="l31.183">     let toolTipComplete = lookup(toolTipGrid + &quot;[1]/[4]/[1]&quot;);</span>
<a href="#l31.184"></a><span id="l31.184"> </span>
<a href="#l31.185"></a><span id="l31.185">     controller.assertJSProperty(toolTipName, &quot;textContent&quot;, TITLE);</span>
<a href="#l31.186"></a><span id="l31.186">     controller.assertJSProperty(toolTipCalendar, &quot;textContent&quot;, CALENDARNAME);</span>
<a href="#l31.187"></a><span id="l31.187">     controller.assertJSProperty(toolTipPriority, &quot;textContent&quot;, &quot;High&quot;);</span>
<a href="#l31.188"></a><span id="l31.188">     controller.assertJSProperty(toolTipStatus, &quot;textContent&quot;, &quot;Needs Action&quot;);</span>
<a href="#l31.189"></a><span id="l31.189" class="difflineminus">-    controller.assertJSProperty(toolTipComplete, &quot;textContent&quot;, percentComplete + &quot;%&quot;);</span>
<a href="#l31.190"></a><span id="l31.190" class="difflineplus">+    controller.assertJSProperty(toolTipComplete, &quot;textContent&quot;, PERCENTCOMPLETE + &quot;%&quot;);</span>
<a href="#l31.191"></a><span id="l31.191"> </span>
<a href="#l31.192"></a><span id="l31.192" class="difflineminus">-    // mark completed, verify</span>
<a href="#l31.193"></a><span id="l31.193" class="difflineplus">+    // Mark completed, verify.</span>
<a href="#l31.194"></a><span id="l31.194">     controller.click(eid(&quot;task-actions-markcompleted&quot;));</span>
<a href="#l31.195"></a><span id="l31.195">     sleep();</span>
<a href="#l31.196"></a><span id="l31.196"> </span>
<a href="#l31.197"></a><span id="l31.197">     toolTipNode.ownerGlobal.showToolTip(toolTipNode, taskTreeNode.getTaskAtRow(0));</span>
<a href="#l31.198"></a><span id="l31.198">     controller.assertJSProperty(toolTipStatus, &quot;textContent&quot;, &quot;Completed&quot;);</span>
<a href="#l31.199"></a><span id="l31.199"> </span>
<a href="#l31.200"></a><span id="l31.200" class="difflineminus">-    // delete task, verify</span>
<a href="#l31.201"></a><span id="l31.201" class="difflineplus">+    // Delete task and verify.</span>
<a href="#l31.202"></a><span id="l31.202">     controller.click(eid(&quot;task-context-menu-delete&quot;));</span>
<a href="#l31.203"></a><span id="l31.203">     controller.click(eid(&quot;calendar-delete-task-button&quot;));</span>
<a href="#l31.204"></a><span id="l31.204">     let countAfterDelete;</span>
<a href="#l31.205"></a><span id="l31.205">     controller.waitFor(() =&gt; {</span>
<a href="#l31.206"></a><span id="l31.206">         countAfterDelete = taskTreeNode.mTaskArray.length;</span>
<a href="#l31.207"></a><span id="l31.207">         return countAfter - 1 == countAfterDelete;</span>
<a href="#l31.208"></a><span id="l31.208">     });</span>
<a href="#l31.209"></a><span id="l31.209"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/calendar/test/mozmill/views/testWeekView.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/calendar/test/mozmill/views/testWeekView.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -1,144 +1,115 @@</span>
<a href="#l32.4"></a><span id="l32.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l32.5"></a><span id="l32.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l32.6"></a><span id="l32.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l32.7"></a><span id="l32.7"> </span>
<a href="#l32.8"></a><span id="l32.8" class="difflineplus">+var MODULE_NAME = &quot;testWeekView&quot;;</span>
<a href="#l32.9"></a><span id="l32.9"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l32.10"></a><span id="l32.10" class="difflineminus">-var MODULE_REQUIRES = [&quot;calendar-utils&quot;];</span>
<a href="#l32.11"></a><span id="l32.11" class="difflineplus">+var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;item-editing-helpers&quot;];</span>
<a href="#l32.12"></a><span id="l32.12"> </span>
<a href="#l32.13"></a><span id="l32.13"> var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;, null);</span>
<a href="#l32.14"></a><span id="l32.14"> </span>
<a href="#l32.15"></a><span id="l32.15" class="difflineminus">-var helpersForController, invokeEventDialog, createCalendar, deleteCalendars;</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineminus">-var goToDate, setData, lookupEventBox;</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineminus">-var CALENDARNAME, CANVAS_BOX, EVENT_BOX;</span>
<a href="#l32.18"></a><span id="l32.18" class="difflineplus">+var CALENDARNAME, CANVAS_BOX, EVENT_BOX, WEEK_VIEW, EVENTPATH;</span>
<a href="#l32.19"></a><span id="l32.19" class="difflineplus">+var helpersForController, switchToView, invokeEventDialog, getEventDetails, createCalendar;</span>
<a href="#l32.20"></a><span id="l32.20" class="difflineplus">+var deleteCalendars, goToDate, lookupEventBox;</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineplus">+var helpersForEditUI, setData;</span>
<a href="#l32.22"></a><span id="l32.22"> </span>
<a href="#l32.23"></a><span id="l32.23"> var TITLE1 = &quot;Week View Event&quot;;</span>
<a href="#l32.24"></a><span id="l32.24"> var TITLE2 = &quot;Week View Event Changed&quot;;</span>
<a href="#l32.25"></a><span id="l32.25"> var DESC = &quot;Week View Event Description&quot;;</span>
<a href="#l32.26"></a><span id="l32.26"> </span>
<a href="#l32.27"></a><span id="l32.27"> function setupModule(module) {</span>
<a href="#l32.28"></a><span id="l32.28">     controller = mozmill.getMail3PaneController();</span>
<a href="#l32.29"></a><span id="l32.29">     ({</span>
<a href="#l32.30"></a><span id="l32.30" class="difflineplus">+        CALENDARNAME,</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineplus">+        CANVAS_BOX,</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineplus">+        EVENT_BOX,</span>
<a href="#l32.33"></a><span id="l32.33" class="difflineplus">+        WEEK_VIEW,</span>
<a href="#l32.34"></a><span id="l32.34" class="difflineplus">+        EVENTPATH,</span>
<a href="#l32.35"></a><span id="l32.35">         helpersForController,</span>
<a href="#l32.36"></a><span id="l32.36" class="difflineplus">+        switchToView,</span>
<a href="#l32.37"></a><span id="l32.37">         invokeEventDialog,</span>
<a href="#l32.38"></a><span id="l32.38" class="difflineplus">+        getEventDetails,</span>
<a href="#l32.39"></a><span id="l32.39">         createCalendar,</span>
<a href="#l32.40"></a><span id="l32.40">         deleteCalendars,</span>
<a href="#l32.41"></a><span id="l32.41">         goToDate,</span>
<a href="#l32.42"></a><span id="l32.42" class="difflineminus">-        setData,</span>
<a href="#l32.43"></a><span id="l32.43" class="difflineminus">-        lookupEventBox,</span>
<a href="#l32.44"></a><span id="l32.44" class="difflineminus">-        CALENDARNAME,</span>
<a href="#l32.45"></a><span id="l32.45" class="difflineminus">-        CANVAS_BOX,</span>
<a href="#l32.46"></a><span id="l32.46" class="difflineminus">-        EVENT_BOX</span>
<a href="#l32.47"></a><span id="l32.47" class="difflineplus">+        lookupEventBox</span>
<a href="#l32.48"></a><span id="l32.48">     } = collector.getModule(&quot;calendar-utils&quot;));</span>
<a href="#l32.49"></a><span id="l32.49" class="difflineminus">-    collector.getModule(&quot;calendar-utils&quot;).setupModule();</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineplus">+    collector.getModule(&quot;calendar-utils&quot;).setupModule(controller);</span>
<a href="#l32.51"></a><span id="l32.51">     Object.assign(module, helpersForController(controller));</span>
<a href="#l32.52"></a><span id="l32.52"> </span>
<a href="#l32.53"></a><span id="l32.53" class="difflineplus">+    ({</span>
<a href="#l32.54"></a><span id="l32.54" class="difflineplus">+        helpersForEditUI,</span>
<a href="#l32.55"></a><span id="l32.55" class="difflineplus">+        setData</span>
<a href="#l32.56"></a><span id="l32.56" class="difflineplus">+    } = collector.getModule(&quot;item-editing-helpers&quot;));</span>
<a href="#l32.57"></a><span id="l32.57" class="difflineplus">+    collector.getModule(&quot;item-editing-helpers&quot;).setupModule(module);</span>
<a href="#l32.58"></a><span id="l32.58" class="difflineplus">+</span>
<a href="#l32.59"></a><span id="l32.59">     createCalendar(controller, CALENDARNAME);</span>
<a href="#l32.60"></a><span id="l32.60"> }</span>
<a href="#l32.61"></a><span id="l32.61"> </span>
<a href="#l32.62"></a><span id="l32.62"> function testWeekView() {</span>
<a href="#l32.63"></a><span id="l32.63">     let dateFormatter = cal.getDateFormatter();</span>
<a href="#l32.64"></a><span id="l32.64" class="difflineminus">-    // paths</span>
<a href="#l32.65"></a><span id="l32.65" class="difflineminus">-    let weekView = `</span>
<a href="#l32.66"></a><span id="l32.66" class="difflineminus">-        /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;tabmail&quot;)/id(&quot;tabmail-tabbox&quot;)/</span>
<a href="#l32.67"></a><span id="l32.67" class="difflineminus">-        id(&quot;tabpanelcontainer&quot;)/id(&quot;calendarTabPanel&quot;)/id(&quot;calendarContent&quot;)/</span>
<a href="#l32.68"></a><span id="l32.68" class="difflineminus">-        id(&quot;calendarDisplayDeck&quot;)/id(&quot;calendar-view-box&quot;)/id(&quot;view-deck&quot;)/</span>
<a href="#l32.69"></a><span id="l32.69" class="difflineminus">-        id(&quot;week-view&quot;)/</span>
<a href="#l32.70"></a><span id="l32.70" class="difflineminus">-    `;</span>
<a href="#l32.71"></a><span id="l32.71"> </span>
<a href="#l32.72"></a><span id="l32.72" class="difflineminus">-    controller.click(eid(&quot;calendar-tab-button&quot;));</span>
<a href="#l32.73"></a><span id="l32.73" class="difflineminus">-    controller.waitThenClick(eid(&quot;calendar-week-view-button&quot;));</span>
<a href="#l32.74"></a><span id="l32.74" class="difflineminus">-</span>
<a href="#l32.75"></a><span id="l32.75" class="difflineplus">+    switchToView(controller, &quot;week&quot;);</span>
<a href="#l32.76"></a><span id="l32.76">     goToDate(controller, 2009, 1, 1);</span>
<a href="#l32.77"></a><span id="l32.77"> </span>
<a href="#l32.78"></a><span id="l32.78" class="difflineminus">-    // verify date</span>
<a href="#l32.79"></a><span id="l32.79" class="difflineplus">+    // Verify date.</span>
<a href="#l32.80"></a><span id="l32.80">     let day = lookup(`</span>
<a href="#l32.81"></a><span id="l32.81" class="difflineminus">-        ${weekView}/anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;headerbox&quot;})/</span>
<a href="#l32.82"></a><span id="l32.82" class="difflineplus">+        ${WEEK_VIEW}/anon({&quot;anonid&quot;:&quot;mainbox&quot;})/anon({&quot;anonid&quot;:&quot;headerbox&quot;})/</span>
<a href="#l32.83"></a><span id="l32.83">         anon({&quot;anonid&quot;:&quot;headerdaybox&quot;})/{&quot;selected&quot;:&quot;true&quot;}</span>
<a href="#l32.84"></a><span id="l32.84">     `);</span>
<a href="#l32.85"></a><span id="l32.85">     controller.waitFor(() =&gt; day.getNode().mDate.icalString == &quot;20090101&quot;);</span>
<a href="#l32.86"></a><span id="l32.86"> </span>
<a href="#l32.87"></a><span id="l32.87" class="difflineminus">-    // create event at 8 AM</span>
<a href="#l32.88"></a><span id="l32.88" class="difflineminus">-    // Thursday of 2009-01-01 is 4th with default settings</span>
<a href="#l32.89"></a><span id="l32.89" class="difflineplus">+    // Create event at 8 AM.</span>
<a href="#l32.90"></a><span id="l32.90" class="difflineplus">+    // Thursday of 2009-01-01 is 4th with default settings.</span>
<a href="#l32.91"></a><span id="l32.91">     let eventBox = lookupEventBox(&quot;week&quot;, CANVAS_BOX, null, 5, 8);</span>
<a href="#l32.92"></a><span id="l32.92">     invokeEventDialog(controller, eventBox, (event, iframe) =&gt; {</span>
<a href="#l32.93"></a><span id="l32.93">         let { eid: eventid } = helpersForController(event);</span>
<a href="#l32.94"></a><span id="l32.94" class="difflineminus">-        let { lookup: iframeLookup } = helpersForController(iframe);</span>
<a href="#l32.95"></a><span id="l32.95" class="difflineplus">+        let { getDateTimePicker } = helpersForEditUI(iframe);</span>
<a href="#l32.96"></a><span id="l32.96"> </span>
<a href="#l32.97"></a><span id="l32.97" class="difflineminus">-        let innerFrame = '/id(&quot;calendar-event-dialog-inner&quot;)/id(&quot;event-grid&quot;)/id(&quot;event-grid-rows&quot;)/';</span>
<a href="#l32.98"></a><span id="l32.98" class="difflineminus">-        let dateInput = `</span>
<a href="#l32.99"></a><span id="l32.99" class="difflineminus">-            anon({&quot;class&quot;:&quot;datepicker-box-class&quot;})/{&quot;class&quot;:&quot;datepicker-text-class&quot;}/</span>
<a href="#l32.100"></a><span id="l32.100" class="difflineminus">-            anon({&quot;class&quot;:&quot;menulist-editable-box textbox-input-box&quot;})/</span>
<a href="#l32.101"></a><span id="l32.101" class="difflineminus">-            anon({&quot;anonid&quot;:&quot;input&quot;})</span>
<a href="#l32.102"></a><span id="l32.102" class="difflineminus">-        `;</span>
<a href="#l32.103"></a><span id="l32.103" class="difflineminus">-        let timeInput = `</span>
<a href="#l32.104"></a><span id="l32.104" class="difflineminus">-            anon({&quot;anonid&quot;:&quot;hbox&quot;})/anon({&quot;anonid&quot;:&quot;time-picker&quot;})/</span>
<a href="#l32.105"></a><span id="l32.105" class="difflineminus">-            anon({&quot;class&quot;:&quot;timepicker-box-class&quot;})/</span>
<a href="#l32.106"></a><span id="l32.106" class="difflineminus">-            anon({&quot;class&quot;:&quot;timepicker-text-class&quot;})/anon({&quot;flex&quot;:&quot;1&quot;})/</span>
<a href="#l32.107"></a><span id="l32.107" class="difflineminus">-            anon({&quot;anonid&quot;:&quot;input&quot;})</span>
<a href="#l32.108"></a><span id="l32.108" class="difflineminus">-        `;</span>
<a href="#l32.109"></a><span id="l32.109" class="difflineminus">-        let startId = &quot;event-starttime&quot;;</span>
<a href="#l32.110"></a><span id="l32.110" class="difflineplus">+        let startTimeInput = getDateTimePicker(&quot;STARTTIME&quot;);</span>
<a href="#l32.111"></a><span id="l32.111" class="difflineplus">+        let startDateInput = getDateTimePicker(&quot;STARTDATE&quot;);</span>
<a href="#l32.112"></a><span id="l32.112"> </span>
<a href="#l32.113"></a><span id="l32.113" class="difflineminus">-        let startTimeInput = iframeLookup(`</span>
<a href="#l32.114"></a><span id="l32.114" class="difflineminus">-            ${innerFrame}/id(&quot;event-grid-startdate-row&quot;)/</span>
<a href="#l32.115"></a><span id="l32.115" class="difflineminus">-            id(&quot;event-grid-startdate-picker-box&quot;)/id(&quot;${startId}&quot;)/${timeInput}</span>
<a href="#l32.116"></a><span id="l32.116" class="difflineminus">-        `);</span>
<a href="#l32.117"></a><span id="l32.117" class="difflineminus">-        let startDateInput = iframeLookup(`</span>
<a href="#l32.118"></a><span id="l32.118" class="difflineminus">-            ${innerFrame}/id(&quot;event-grid-startdate-row&quot;)/</span>
<a href="#l32.119"></a><span id="l32.119" class="difflineminus">-            id(&quot;event-grid-startdate-picker-box&quot;)/id(&quot;${startId}&quot;)/</span>
<a href="#l32.120"></a><span id="l32.120" class="difflineminus">-            anon({&quot;anonid&quot;:&quot;hbox&quot;})/anon({&quot;anonid&quot;:&quot;date-picker&quot;})/${dateInput}</span>
<a href="#l32.121"></a><span id="l32.121" class="difflineminus">-        `);</span>
<a href="#l32.122"></a><span id="l32.122" class="difflineminus">-</span>
<a href="#l32.123"></a><span id="l32.123" class="difflineminus">-        // check that the start time is correct</span>
<a href="#l32.124"></a><span id="l32.124" class="difflineplus">+        // Check that the start time is correct.</span>
<a href="#l32.125"></a><span id="l32.125">         event.waitForElement(startTimeInput);</span>
<a href="#l32.126"></a><span id="l32.126">         let someDate = cal.createDateTime();</span>
<a href="#l32.127"></a><span id="l32.127">         someDate.resetTo(2009, 0, 1, 8, 0, 0, cal.dtz.floating);</span>
<a href="#l32.128"></a><span id="l32.128">         event.assertValue(startTimeInput, dateFormatter.formatTime(someDate));</span>
<a href="#l32.129"></a><span id="l32.129">         event.assertValue(startDateInput, dateFormatter.formatDateShort(someDate));</span>
<a href="#l32.130"></a><span id="l32.130"> </span>
<a href="#l32.131"></a><span id="l32.131" class="difflineminus">-        // fill in title, description and calendar</span>
<a href="#l32.132"></a><span id="l32.132" class="difflineminus">-        setData(event, iframe, { title: TITLE1, description: DESC, calendar: CALENDARNAME });</span>
<a href="#l32.133"></a><span id="l32.133" class="difflineplus">+        // Fill in title, description and calendar.</span>
<a href="#l32.134"></a><span id="l32.134" class="difflineplus">+        setData(event, iframe, {</span>
<a href="#l32.135"></a><span id="l32.135" class="difflineplus">+            title: TITLE1,</span>
<a href="#l32.136"></a><span id="l32.136" class="difflineplus">+            description: DESC,</span>
<a href="#l32.137"></a><span id="l32.137" class="difflineplus">+            calendar: CALENDARNAME</span>
<a href="#l32.138"></a><span id="l32.138" class="difflineplus">+        });</span>
<a href="#l32.139"></a><span id="l32.139"> </span>
<a href="#l32.140"></a><span id="l32.140">         // save</span>
<a href="#l32.141"></a><span id="l32.141">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l32.142"></a><span id="l32.142">     });</span>
<a href="#l32.143"></a><span id="l32.143"> </span>
<a href="#l32.144"></a><span id="l32.144" class="difflineminus">-    // if it was created successfully, it can be opened</span>
<a href="#l32.145"></a><span id="l32.145" class="difflineminus">-    eventBox = lookupEventBox(</span>
<a href="#l32.146"></a><span id="l32.146" class="difflineminus">-        &quot;week&quot;, EVENT_BOX, null, 5, 8,</span>
<a href="#l32.147"></a><span id="l32.147" class="difflineminus">-        `/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;${CALENDARNAME.toLowerCase()}&quot;}`</span>
<a href="#l32.148"></a><span id="l32.148" class="difflineminus">-    );</span>
<a href="#l32.149"></a><span id="l32.149" class="difflineplus">+    // If it was created successfully, it can be opened.</span>
<a href="#l32.150"></a><span id="l32.150" class="difflineplus">+    eventBox = lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 5, null, EVENTPATH);</span>
<a href="#l32.151"></a><span id="l32.151">     invokeEventDialog(controller, eventBox, (event, iframe) =&gt; {</span>
<a href="#l32.152"></a><span id="l32.152">         let { eid: eventid } = helpersForController(event);</span>
<a href="#l32.153"></a><span id="l32.153"> </span>
<a href="#l32.154"></a><span id="l32.154" class="difflineminus">-        // change title and save changes</span>
<a href="#l32.155"></a><span id="l32.155" class="difflineplus">+        // Change title and save changes.</span>
<a href="#l32.156"></a><span id="l32.156">         setData(event, iframe, { title: TITLE2 });</span>
<a href="#l32.157"></a><span id="l32.157">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l32.158"></a><span id="l32.158">     });</span>
<a href="#l32.159"></a><span id="l32.159"> </span>
<a href="#l32.160"></a><span id="l32.160" class="difflineminus">-    // check if name was saved</span>
<a href="#l32.161"></a><span id="l32.161" class="difflineminus">-    let eventName = lookupEventBox(</span>
<a href="#l32.162"></a><span id="l32.162" class="difflineminus">-        &quot;week&quot;, EVENT_BOX, null, 5, 8,</span>
<a href="#l32.163"></a><span id="l32.163" class="difflineminus">-        `/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;${CALENDARNAME.toLowerCase()}&quot;}/</span>
<a href="#l32.164"></a><span id="l32.164" class="difflineminus">-        anon({&quot;flex&quot;:&quot;1&quot;})/anon({&quot;anonid&quot;:&quot;event-container&quot;})/</span>
<a href="#l32.165"></a><span id="l32.165" class="difflineminus">-        {&quot;class&quot;:&quot;calendar-event-selection&quot;}/anon({&quot;anonid&quot;:&quot;eventbox&quot;})/</span>
<a href="#l32.166"></a><span id="l32.166" class="difflineminus">-        {&quot;class&quot;:&quot;calendar-event-details&quot;}/anon({&quot;flex&quot;:&quot;1&quot;})/</span>
<a href="#l32.167"></a><span id="l32.167" class="difflineminus">-        anon({&quot;anonid&quot;:&quot;event-name&quot;})`</span>
<a href="#l32.168"></a><span id="l32.168" class="difflineplus">+    // Check if name was saved.</span>
<a href="#l32.169"></a><span id="l32.169" class="difflineplus">+    let eventName = lookupEventBox(&quot;week&quot;, EVENT_BOX, null, 5, null,</span>
<a href="#l32.170"></a><span id="l32.170" class="difflineplus">+        `${EVENTPATH}/${getEventDetails(&quot;week&quot;)}/anon({&quot;flex&quot;:&quot;1&quot;})/anon({&quot;anonid&quot;:&quot;event-name&quot;})`</span>
<a href="#l32.171"></a><span id="l32.171">     );</span>
<a href="#l32.172"></a><span id="l32.172">     controller.waitForElement(eventName);</span>
<a href="#l32.173"></a><span id="l32.173">     controller.assertJSProperty(eventName, &quot;textContent&quot;, TITLE2);</span>
<a href="#l32.174"></a><span id="l32.174"> </span>
<a href="#l32.175"></a><span id="l32.175" class="difflineminus">-    // delete event</span>
<a href="#l32.176"></a><span id="l32.176" class="difflineminus">-    controller.click(lookupEventBox(</span>
<a href="#l32.177"></a><span id="l32.177" class="difflineminus">-        &quot;week&quot;, EVENT_BOX, null, 5, 8,</span>
<a href="#l32.178"></a><span id="l32.178" class="difflineminus">-        `/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;${CALENDARNAME.toLowerCase()}&quot;}`</span>
<a href="#l32.179"></a><span id="l32.179" class="difflineminus">-    ));</span>
<a href="#l32.180"></a><span id="l32.180" class="difflineplus">+    // Delete event.</span>
<a href="#l32.181"></a><span id="l32.181" class="difflineplus">+    controller.click(eventBox);</span>
<a href="#l32.182"></a><span id="l32.182">     controller.keypress(eid(&quot;week-view&quot;), &quot;VK_DELETE&quot;, {});</span>
<a href="#l32.183"></a><span id="l32.183" class="difflineminus">-    controller.waitForElementNotPresent(lookupEventBox(</span>
<a href="#l32.184"></a><span id="l32.184" class="difflineminus">-        &quot;week&quot;, EVENT_BOX, null, 5, 8,</span>
<a href="#l32.185"></a><span id="l32.185" class="difflineminus">-        `/{&quot;tooltip&quot;:&quot;itemTooltip&quot;,&quot;calendar&quot;:&quot;${CALENDARNAME.toLowerCase()}&quot;}`</span>
<a href="#l32.186"></a><span id="l32.186" class="difflineminus">-    ));</span>
<a href="#l32.187"></a><span id="l32.187" class="difflineplus">+    controller.waitForElementNotPresent(eventBox);</span>
<a href="#l32.188"></a><span id="l32.188"> }</span>
<a href="#l32.189"></a><span id="l32.189"> </span>
<a href="#l32.190"></a><span id="l32.190"> function teardownTest(module) {</span>
<a href="#l32.191"></a><span id="l32.191">     deleteCalendars(controller, CALENDARNAME);</span>
<a href="#l32.192"></a><span id="l32.192"> }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

