<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 5211:895928822eb3ea5a70c6294e71df940f61af84f5</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 895928822eb3ea5a70c6294e71df940f61af84f5" />
<meta property="og:url" content="/comm-central/rev/895928822eb3ea5a70c6294e71df940f61af84f5" />
<meta property="og:description" content="Rewrite authentication logic (in IMAP, POP, SMTP) (more below) Bug 525238, r=bienvenu, r=bwinton (accountcreation), sr=NeilAway, ui-r=clarkbw" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 895928822eb3ea5a70c6294e71df940f61af84f5 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/895928822eb3ea5a70c6294e71df940f61af84f5">shortlog</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/895928822eb3ea5a70c6294e71df940f61af84f5">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5">files</a> |
changeset |
<a href="/comm-central/raw-rev/895928822eb3ea5a70c6294e71df940f61af84f5">raw</a>  | <a href="/comm-central/archive/895928822eb3ea5a70c6294e71df940f61af84f5.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Rewrite authentication logic (in IMAP, POP, SMTP) (more below) <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=525238">Bug 525238</a>, r=bienvenu, r=bwinton (accountcreation), sr=NeilAway, ui-r=clarkbw
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#66;&#101;&#110;&#32;&#66;&#117;&#99;&#107;&#115;&#99;&#104;&#32;&#60;&#98;&#101;&#110;&#46;&#98;&#117;&#99;&#107;&#115;&#99;&#104;&#64;&#98;&#101;&#111;&#110;&#101;&#120;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 20 Mar 2010 02:11:28 +0100</td></tr>

<tr>
 <td>changeset 5211</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/895928822eb3ea5a70c6294e71df940f61af84f5">895928822eb3ea5a70c6294e71df940f61af84f5</a></td>
</tr>



<tr>
<td>parent 5210</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a03eae58454850ee02dd1a84287f3e61bd44be77">a03eae58454850ee02dd1a84287f3e61bd44be77</a>
</td>
</tr>

<tr>
<td>child 5212</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/efae333beb468fcbeb97aefaaa7d1fab464cf6dc">efae333beb468fcbeb97aefaaa7d1fab464cf6dc</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=895928822eb3ea5a70c6294e71df940f61af84f5">4023</a></td></tr>
<tr><td>push user</td><td>mozilla.BenB@bucksch.org</td></tr>
<tr><td>push date</td><td class="date age">Sat, 20 Mar 2010 01:11:43 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@895928822eb3 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=895928822eb3ea5a70c6294e71df940f61af84f5">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=895928822eb3ea5a70c6294e71df940f61af84f5&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=895928822eb3ea5a70c6294e71df940f61af84f5&newProject=comm-central&newRevision=895928822eb3ea5a70c6294e71df940f61af84f5&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=895928822eb3ea5a70c6294e71df940f61af84f5&newProject=comm-central&newRevision=895928822eb3ea5a70c6294e71df940f61af84f5&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=895928822eb3ea5a70c6294e71df940f61af84f5&newProject=comm-central&newRevision=895928822eb3ea5a70c6294e71df940f61af84f5&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a>, <a href="/comm-central/log?rev=reviewer%28bwinton%29&revcount=50">bwinton</a>, <a href="/comm-central/log?rev=reviewer%28NeilAway%29&revcount=50">NeilAway</a>, <a href="/comm-central/log?rev=reviewer%28clarkbw%29&revcount=50">clarkbw</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=525238">525238</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=339050">339050</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=524698">524698</a></td></tr>




</table></div>

<div class="page_body description">Rewrite authentication logic (in IMAP, POP, SMTP) (more below) <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=525238">Bug 525238</a>, r=bienvenu, r=bwinton (accountcreation), sr=NeilAway, ui-r=clarkbw
- Add pref to specifically set plaintext password auth, encrypted pw auth, Kerberos, NTLM.
  This allows to show proper error (without pw dialog) for Kerberos failure (<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=339050">bug 339050</a>) and
  to invoke a Kerberos OS password prompt (<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=524698">bug 524698</a>).
- For that, and because it was badly needed, also rewrite authentication login.
  This fixes many bugs, e.g. users getting a password prompt when login failed
  for reasons other than password (e.g. POP server limiting to checks every 15 minutes).
- Create migration.jsm where we can update profiles on startup.
- Change IDL constants for SSL, per Neil</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mail/base/content/mailContextMenus.js">mail/base/content/mailContextMenus.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mail/base/content/mailContextMenus.js">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mail/base/content/mailContextMenus.js">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mail/base/content/mailContextMenus.js">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mail/base/content/mailContextMenus.js">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mail/base/content/mailContextMenus.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mail/base/content/msgHdrViewOverlay.js">mail/base/content/msgHdrViewOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mail/base/content/msgHdrViewOverlay.js">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mail/base/content/msgHdrViewOverlay.js">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mail/base/content/msgHdrViewOverlay.js">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mail/base/content/msgHdrViewOverlay.js">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mail/base/content/msgHdrViewOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mail/base/content/msgMail3PaneWindow.js">mail/base/content/msgMail3PaneWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mail/base/content/msgMail3PaneWindow.js">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mail/base/content/msgMail3PaneWindow.js">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mail/base/content/msgMail3PaneWindow.js">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mail/base/content/msgMail3PaneWindow.js">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mail/base/content/msgMail3PaneWindow.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/am-advanced.dtd">mail/locales/en-US/chrome/messenger/am-advanced.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/am-advanced.dtd">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/am-advanced.dtd">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/am-advanced.dtd">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/am-advanced.dtd">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/am-advanced.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/am-server-top.dtd">mail/locales/en-US/chrome/messenger/am-server-top.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/am-server-top.dtd">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/am-server-top.dtd">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/am-server-top.dtd">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/am-server-top.dtd">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/am-server-top.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/imapMsgs.properties">mail/locales/en-US/chrome/messenger/imapMsgs.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/imapMsgs.properties">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/imapMsgs.properties">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/imapMsgs.properties">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/imapMsgs.properties">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/imapMsgs.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/localMsgs.properties">mail/locales/en-US/chrome/messenger/localMsgs.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/localMsgs.properties">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/localMsgs.properties">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/localMsgs.properties">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/localMsgs.properties">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/localMsgs.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/messenger.properties">mail/locales/en-US/chrome/messenger/messenger.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/messenger.properties">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/messenger.properties">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/messenger.properties">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/messenger.properties">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/messenger.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/messengercompose/composeMsgs.properties">mail/locales/en-US/chrome/messenger/messengercompose/composeMsgs.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/messengercompose/composeMsgs.properties">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/messengercompose/composeMsgs.properties">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/messengercompose/composeMsgs.properties">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/messengercompose/composeMsgs.properties">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/messengercompose/composeMsgs.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/smtpEditOverlay.dtd">mail/locales/en-US/chrome/messenger/smtpEditOverlay.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/smtpEditOverlay.dtd">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/smtpEditOverlay.dtd">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/smtpEditOverlay.dtd">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/smtpEditOverlay.dtd">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mail/locales/en-US/chrome/messenger/smtpEditOverlay.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/AccountManager.js">mailnews/base/prefs/content/AccountManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/AccountManager.js">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/AccountManager.js">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/AccountManager.js">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/AccountManager.js">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/AccountManager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/SmtpServerEdit.xul">mailnews/base/prefs/content/SmtpServerEdit.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/SmtpServerEdit.xul">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/SmtpServerEdit.xul">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/SmtpServerEdit.xul">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/SmtpServerEdit.xul">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/SmtpServerEdit.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountUtils.js">mailnews/base/prefs/content/accountUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountUtils.js">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountUtils.js">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountUtils.js">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountUtils.js">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/accountConfig.js">mailnews/base/prefs/content/accountcreation/accountConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/accountConfig.js">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/accountConfig.js">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/accountConfig.js">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/accountConfig.js">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/accountConfig.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/createInBackend.js">mailnews/base/prefs/content/accountcreation/createInBackend.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/createInBackend.js">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/createInBackend.js">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/createInBackend.js">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/createInBackend.js">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/createInBackend.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/emailWizard.js">mailnews/base/prefs/content/accountcreation/emailWizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/emailWizard.js">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/emailWizard.js">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/emailWizard.js">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/emailWizard.js">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/emailWizard.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/guessConfig.js">mailnews/base/prefs/content/accountcreation/guessConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/guessConfig.js">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/guessConfig.js">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/guessConfig.js">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/guessConfig.js">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/guessConfig.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/readFromXML.js">mailnews/base/prefs/content/accountcreation/readFromXML.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/readFromXML.js">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/readFromXML.js">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/readFromXML.js">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/readFromXML.js">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/readFromXML.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/verifyConfig.js">mailnews/base/prefs/content/accountcreation/verifyConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/verifyConfig.js">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/verifyConfig.js">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/verifyConfig.js">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/verifyConfig.js">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/accountcreation/verifyConfig.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/am-server.js">mailnews/base/prefs/content/am-server.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/am-server.js">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/am-server.js">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/am-server.js">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/am-server.js">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/am-server.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/am-server.xul">mailnews/base/prefs/content/am-server.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/am-server.xul">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/am-server.xul">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/am-server.xul">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/am-server.xul">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/am-server.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/am-smtp.js">mailnews/base/prefs/content/am-smtp.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/am-smtp.js">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/am-smtp.js">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/am-smtp.js">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/am-smtp.js">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/am-smtp.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/am-smtp.xul">mailnews/base/prefs/content/am-smtp.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/am-smtp.xul">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/am-smtp.xul">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/am-smtp.xul">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/am-smtp.xul">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/am-smtp.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/smtpEditOverlay.js">mailnews/base/prefs/content/smtpEditOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/smtpEditOverlay.js">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/smtpEditOverlay.js">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/smtpEditOverlay.js">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/smtpEditOverlay.js">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/smtpEditOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/smtpEditOverlay.xul">mailnews/base/prefs/content/smtpEditOverlay.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/smtpEditOverlay.xul">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/smtpEditOverlay.xul">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/smtpEditOverlay.xul">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/smtpEditOverlay.xul">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/prefs/content/smtpEditOverlay.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/public/MailNewsTypes2.idl">mailnews/base/public/MailNewsTypes2.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/public/MailNewsTypes2.idl">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/public/MailNewsTypes2.idl">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/public/MailNewsTypes2.idl">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/public/MailNewsTypes2.idl">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/public/MailNewsTypes2.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/public/nsIMsgIncomingServer.idl">mailnews/base/public/nsIMsgIncomingServer.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/public/nsIMsgIncomingServer.idl">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/public/nsIMsgIncomingServer.idl">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/public/nsIMsgIncomingServer.idl">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/public/nsIMsgIncomingServer.idl">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/public/nsIMsgIncomingServer.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/util/Makefile.in">mailnews/base/util/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/util/Makefile.in">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/util/Makefile.in">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/util/Makefile.in">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/util/Makefile.in">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/util/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/util/migration.jsm">mailnews/base/util/migration.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/util/migration.jsm">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/util/migration.jsm">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/util/migration.jsm">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/util/migration.jsm">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/util/migration.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/util/nsMsgIncomingServer.cpp">mailnews/base/util/nsMsgIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/util/nsMsgIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/util/nsMsgIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/util/nsMsgIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/util/nsMsgIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/util/nsMsgIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/util/nsMsgProtocol.cpp">mailnews/base/util/nsMsgProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/util/nsMsgProtocol.cpp">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/util/nsMsgProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/util/nsMsgProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/util/nsMsgProtocol.cpp">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/base/util/nsMsgProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/public/nsISmtpServer.idl">mailnews/compose/public/nsISmtpServer.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/public/nsISmtpServer.idl">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/public/nsISmtpServer.idl">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/public/nsISmtpServer.idl">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/public/nsISmtpServer.idl">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/public/nsISmtpServer.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsComposeStrings.h">mailnews/compose/src/nsComposeStrings.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsComposeStrings.h">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsComposeStrings.h">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsComposeStrings.h">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsComposeStrings.h">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsComposeStrings.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsMsgSend.cpp">mailnews/compose/src/nsMsgSend.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsMsgSend.cpp">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsMsgSend.cpp">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsMsgSend.cpp">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsMsgSend.cpp">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsMsgSend.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsSmtpProtocol.cpp">mailnews/compose/src/nsSmtpProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsSmtpProtocol.cpp">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsSmtpProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsSmtpProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsSmtpProtocol.cpp">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsSmtpProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsSmtpProtocol.h">mailnews/compose/src/nsSmtpProtocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsSmtpProtocol.h">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsSmtpProtocol.h">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsSmtpProtocol.h">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsSmtpProtocol.h">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsSmtpProtocol.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsSmtpServer.cpp">mailnews/compose/src/nsSmtpServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsSmtpServer.cpp">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsSmtpServer.cpp">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsSmtpServer.cpp">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsSmtpServer.cpp">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsSmtpServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsSmtpService.cpp">mailnews/compose/src/nsSmtpService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsSmtpService.cpp">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsSmtpService.cpp">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsSmtpService.cpp">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsSmtpService.cpp">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/src/nsSmtpService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/head_compose.js">mailnews/compose/test/unit/head_compose.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/head_compose.js">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/head_compose.js">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/head_compose.js">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/head_compose.js">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/head_compose.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_bug155172.js">mailnews/compose/test/unit/test_bug155172.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_bug155172.js">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_bug155172.js">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_bug155172.js">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_bug155172.js">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_bug155172.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_sendMailMessage.js">mailnews/compose/test/unit/test_sendMailMessage.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_sendMailMessage.js">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_sendMailMessage.js">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_sendMailMessage.js">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_sendMailMessage.js">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_sendMailMessage.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_smtpAuthMethods.js">mailnews/compose/test/unit/test_smtpAuthMethods.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_smtpAuthMethods.js">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_smtpAuthMethods.js">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_smtpAuthMethods.js">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_smtpAuthMethods.js">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_smtpAuthMethods.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_smtpPassword.js">mailnews/compose/test/unit/test_smtpPassword.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_smtpPassword.js">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_smtpPassword.js">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_smtpPassword.js">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_smtpPassword.js">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_smtpPassword.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_smtpPassword2.js">mailnews/compose/test/unit/test_smtpPassword2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_smtpPassword2.js">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_smtpPassword2.js">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_smtpPassword2.js">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_smtpPassword2.js">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_smtpPassword2.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">mailnews/compose/test/unit/test_smtpPasswordFailure1.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">mailnews/compose/test/unit/test_smtpPasswordFailure2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapCore.h">mailnews/imap/src/nsImapCore.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapCore.h">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapCore.h">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapCore.h">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapCore.h">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapCore.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapIncomingServer.cpp">mailnews/imap/src/nsImapIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapProtocol.cpp">mailnews/imap/src/nsImapProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapProtocol.cpp">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapProtocol.cpp">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapProtocol.h">mailnews/imap/src/nsImapProtocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapProtocol.h">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapProtocol.h">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapProtocol.h">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapProtocol.h">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapProtocol.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapServerResponseParser.cpp">mailnews/imap/src/nsImapServerResponseParser.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapServerResponseParser.cpp">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapServerResponseParser.cpp">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapServerResponseParser.cpp">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapServerResponseParser.cpp">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapServerResponseParser.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapStringBundle.h">mailnews/imap/src/nsImapStringBundle.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapStringBundle.h">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapStringBundle.h">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapStringBundle.h">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapStringBundle.h">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/src/nsImapStringBundle.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/test/unit/test_imapAuthMethods.js">mailnews/imap/test/unit/test_imapAuthMethods.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/test/unit/test_imapAuthMethods.js">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/test/unit/test_imapAuthMethods.js">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/test/unit/test_imapAuthMethods.js">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/test/unit/test_imapAuthMethods.js">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/imap/test/unit/test_imapAuthMethods.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/import/oexpress/nsOESettings.cpp">mailnews/import/oexpress/nsOESettings.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/import/oexpress/nsOESettings.cpp">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/import/oexpress/nsOESettings.cpp">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/import/oexpress/nsOESettings.cpp">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/import/oexpress/nsOESettings.cpp">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/import/oexpress/nsOESettings.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/import/outlook/src/nsOutlookSettings.cpp">mailnews/import/outlook/src/nsOutlookSettings.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/import/outlook/src/nsOutlookSettings.cpp">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/import/outlook/src/nsOutlookSettings.cpp">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/import/outlook/src/nsOutlookSettings.cpp">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/import/outlook/src/nsOutlookSettings.cpp">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/import/outlook/src/nsOutlookSettings.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/public/nsIPop3IncomingServer.idl">mailnews/local/public/nsIPop3IncomingServer.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/public/nsIPop3IncomingServer.idl">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/public/nsIPop3IncomingServer.idl">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/public/nsIPop3IncomingServer.idl">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/public/nsIPop3IncomingServer.idl">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/public/nsIPop3IncomingServer.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/src/nsLocalStrings.h">mailnews/local/src/nsLocalStrings.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/src/nsLocalStrings.h">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/src/nsLocalStrings.h">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/src/nsLocalStrings.h">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/src/nsLocalStrings.h">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/src/nsLocalStrings.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/src/nsPop3IncomingServer.cpp">mailnews/local/src/nsPop3IncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/src/nsPop3IncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/src/nsPop3IncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/src/nsPop3IncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/src/nsPop3IncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/src/nsPop3IncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/src/nsPop3Protocol.cpp">mailnews/local/src/nsPop3Protocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/src/nsPop3Protocol.cpp">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/src/nsPop3Protocol.cpp">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/src/nsPop3Protocol.cpp">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/src/nsPop3Protocol.cpp">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/src/nsPop3Protocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/src/nsPop3Protocol.h">mailnews/local/src/nsPop3Protocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/src/nsPop3Protocol.h">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/src/nsPop3Protocol.h">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/src/nsPop3Protocol.h">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/src/nsPop3Protocol.h">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/src/nsPop3Protocol.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/test/unit/test_pop3AuthMethods.js">mailnews/local/test/unit/test_pop3AuthMethods.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/test/unit/test_pop3AuthMethods.js">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/test/unit/test_pop3AuthMethods.js">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/test/unit/test_pop3AuthMethods.js">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/test/unit/test_pop3AuthMethods.js">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/test/unit/test_pop3AuthMethods.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/test/unit/test_pop3GSSAPIFail.js">mailnews/local/test/unit/test_pop3GSSAPIFail.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/test/unit/test_pop3GSSAPIFail.js">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/test/unit/test_pop3GSSAPIFail.js">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/test/unit/test_pop3GSSAPIFail.js">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/test/unit/test_pop3GSSAPIFail.js">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/test/unit/test_pop3GSSAPIFail.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/test/unit/test_pop3ServerBrokenCRAMDisconnect.js">mailnews/local/test/unit/test_pop3ServerBrokenCRAMDisconnect.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/test/unit/test_pop3ServerBrokenCRAMDisconnect.js">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/test/unit/test_pop3ServerBrokenCRAMDisconnect.js">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/test/unit/test_pop3ServerBrokenCRAMDisconnect.js">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/test/unit/test_pop3ServerBrokenCRAMDisconnect.js">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/test/unit/test_pop3ServerBrokenCRAMDisconnect.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/test/unit/test_pop3ServerBrokenCRAMFail.js">mailnews/local/test/unit/test_pop3ServerBrokenCRAMFail.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/test/unit/test_pop3ServerBrokenCRAMFail.js">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/test/unit/test_pop3ServerBrokenCRAMFail.js">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/test/unit/test_pop3ServerBrokenCRAMFail.js">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/test/unit/test_pop3ServerBrokenCRAMFail.js">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/local/test/unit/test_pop3ServerBrokenCRAMFail.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/mailnews.js">mailnews/mailnews.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/mailnews.js">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/mailnews.js">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/mailnews.js">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/mailnews.js">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/mailnews.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/mapi/mapihook/src/msgMapiMain.cpp">mailnews/mapi/mapihook/src/msgMapiMain.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/mapi/mapihook/src/msgMapiMain.cpp">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/mapi/mapihook/src/msgMapiMain.cpp">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/mapi/mapihook/src/msgMapiMain.cpp">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/mapi/mapihook/src/msgMapiMain.cpp">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/mapi/mapihook/src/msgMapiMain.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/news/src/nsNNTPProtocol.cpp">mailnews/news/src/nsNNTPProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/news/src/nsNNTPProtocol.cpp">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/news/src/nsNNTPProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/news/src/nsNNTPProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/news/src/nsNNTPProtocol.cpp">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/news/src/nsNNTPProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/news/src/nsNewsFolder.cpp">mailnews/news/src/nsNewsFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/news/src/nsNewsFolder.cpp">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/news/src/nsNewsFolder.cpp">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/news/src/nsNewsFolder.cpp">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/news/src/nsNewsFolder.cpp">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/news/src/nsNewsFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/news/src/nsNntpIncomingServer.cpp">mailnews/news/src/nsNntpIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/news/src/nsNntpIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/news/src/nsNntpIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/news/src/nsNntpIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/news/src/nsNntpIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/news/src/nsNntpIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/news/src/nsNntpService.cpp">mailnews/news/src/nsNntpService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/news/src/nsNntpService.cpp">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/news/src/nsNntpService.cpp">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/news/src/nsNntpService.cpp">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/news/src/nsNntpService.cpp">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/mailnews/news/src/nsNntpService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/suite/common/src/nsSuiteGlue.js">suite/common/src/nsSuiteGlue.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/suite/common/src/nsSuiteGlue.js">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/suite/common/src/nsSuiteGlue.js">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/suite/common/src/nsSuiteGlue.js">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/suite/common/src/nsSuiteGlue.js">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/suite/common/src/nsSuiteGlue.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/compose/composeMsgs.properties">suite/locales/en-US/chrome/mailnews/compose/composeMsgs.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/compose/composeMsgs.properties">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/compose/composeMsgs.properties">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/compose/composeMsgs.properties">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/compose/composeMsgs.properties">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/compose/composeMsgs.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/imapMsgs.properties">suite/locales/en-US/chrome/mailnews/imapMsgs.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/imapMsgs.properties">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/imapMsgs.properties">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/imapMsgs.properties">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/imapMsgs.properties">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/imapMsgs.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/localMsgs.properties">suite/locales/en-US/chrome/mailnews/localMsgs.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/localMsgs.properties">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/localMsgs.properties">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/localMsgs.properties">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/localMsgs.properties">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/localMsgs.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/messenger.properties">suite/locales/en-US/chrome/mailnews/messenger.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/messenger.properties">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/messenger.properties">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/messenger.properties">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/messenger.properties">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/messenger.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/pref/am-advanced.dtd">suite/locales/en-US/chrome/mailnews/pref/am-advanced.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/pref/am-advanced.dtd">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/pref/am-advanced.dtd">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/pref/am-advanced.dtd">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/pref/am-advanced.dtd">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/pref/am-advanced.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/pref/am-server-top.dtd">suite/locales/en-US/chrome/mailnews/pref/am-server-top.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/pref/am-server-top.dtd">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/pref/am-server-top.dtd">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/pref/am-server-top.dtd">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/pref/am-server-top.dtd">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/pref/am-server-top.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/pref/smtpEditOverlay.dtd">suite/locales/en-US/chrome/mailnews/pref/smtpEditOverlay.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/pref/smtpEditOverlay.dtd">file</a> |
<a href="/comm-central/annotate/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/pref/smtpEditOverlay.dtd">annotate</a> |
<a href="/comm-central/diff/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/pref/smtpEditOverlay.dtd">diff</a> |
<a href="/comm-central/comparison/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/pref/smtpEditOverlay.dtd">comparison</a> |
<a href="/comm-central/log/895928822eb3ea5a70c6294e71df940f61af84f5/suite/locales/en-US/chrome/mailnews/pref/smtpEditOverlay.dtd">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/mailContextMenus.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/mailContextMenus.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -627,17 +627,18 @@ function getEmail (url)</span>
<a href="#l1.4"></a><span id="l1.4"> }</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> function CopyMessageUrl()</span>
<a href="#l1.7"></a><span id="l1.7"> {</span>
<a href="#l1.8"></a><span id="l1.8">   try {</span>
<a href="#l1.9"></a><span id="l1.9">     var hdr = gDBView.hdrForFirstSelectedMessage;</span>
<a href="#l1.10"></a><span id="l1.10">     var server = hdr.folder.server;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    var url = (server.socketType == Components.interfaces.nsIMsgIncomingServer.useSSL) ?</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    // TODO let backend construct URL and return as attribute</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+    var url = (server.socketType == Components.interfaces.nsMsgSocketType.SSL) ?</span>
<a href="#l1.15"></a><span id="l1.15">               &quot;snews://&quot; : &quot;news://&quot;;</span>
<a href="#l1.16"></a><span id="l1.16">     url += server.hostName + &quot;:&quot; + server.port + &quot;/&quot; + hdr.messageId;</span>
<a href="#l1.17"></a><span id="l1.17"> </span>
<a href="#l1.18"></a><span id="l1.18">     var clipboard = Components.classes[&quot;@mozilla.org/widget/clipboardhelper;1&quot;]</span>
<a href="#l1.19"></a><span id="l1.19">                               .getService(Components.interfaces.nsIClipboardHelper);</span>
<a href="#l1.20"></a><span id="l1.20">     clipboard.copyString(url);</span>
<a href="#l1.21"></a><span id="l1.21">   }</span>
<a href="#l1.22"></a><span id="l1.22">   catch (ex) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/msgHdrViewOverlay.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/msgHdrViewOverlay.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1504,18 +1504,19 @@ function CopyNewsgroupName(newsgroupNode</span>
<a href="#l2.4"></a><span id="l2.4"> function CopyNewsgroupURL(newsgroupNode)</span>
<a href="#l2.5"></a><span id="l2.5"> {</span>
<a href="#l2.6"></a><span id="l2.6">   let server = GetNewsgroupServer();</span>
<a href="#l2.7"></a><span id="l2.7">   if (!server)</span>
<a href="#l2.8"></a><span id="l2.8">     return;</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10">   let ng = newsgroupNode.getAttribute(&quot;newsgroup&quot;);</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+  // TODO let backend construct URL and return as attribute</span>
<a href="#l2.13"></a><span id="l2.13">   let url;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-  if (server.socketType != Components.interfaces.nsIMsgIncomingServer.useSSL) {</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+  if (server.socketType != Components.interfaces.nsMsgSocketType.SSL) {</span>
<a href="#l2.16"></a><span id="l2.16">     url = &quot;news://&quot; + server.hostName;</span>
<a href="#l2.17"></a><span id="l2.17">     if (server.port != Components.interfaces.nsINntpUrl.DEFAULT_NNTP_PORT)</span>
<a href="#l2.18"></a><span id="l2.18">       url += &quot;:&quot; + server.port;</span>
<a href="#l2.19"></a><span id="l2.19">     url += &quot;/&quot; + ng;</span>
<a href="#l2.20"></a><span id="l2.20">   }</span>
<a href="#l2.21"></a><span id="l2.21">   else {</span>
<a href="#l2.22"></a><span id="l2.22">     url = &quot;snews://&quot; + server.hostName;</span>
<a href="#l2.23"></a><span id="l2.23">     if (server.port != Components.interfaces.nsINntpUrl.DEFAULT_NNTPS_PORT)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -41,17 +41,19 @@</span>
<a href="#l3.4"></a><span id="l3.4">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l3.5"></a><span id="l3.5">  *</span>
<a href="#l3.6"></a><span id="l3.6">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> Components.utils.import(&quot;resource://gre/modules/folderUtils.jsm&quot;);</span>
<a href="#l3.9"></a><span id="l3.9"> Components.utils.import(&quot;resource://app/modules/activity/activityModules.js&quot;);</span>
<a href="#l3.10"></a><span id="l3.10"> Components.utils.import(&quot;resource://app/modules/jsTreeSelection.js&quot;);</span>
<a href="#l3.11"></a><span id="l3.11"> Components.utils.import(&quot;resource://app/modules/MailConsts.js&quot;);</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/errUtils.js&quot;);</span>
<a href="#l3.13"></a><span id="l3.13"> Components.utils.import(&quot;resource://app/modules/IOUtils.js&quot;);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/migration.jsm&quot;);</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16"> /* This is where functions related to the 3 pane window are kept */</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18"> // from MailNewsTypes.h</span>
<a href="#l3.19"></a><span id="l3.19"> const nsMsgKey_None = 0xFFFFFFFF;</span>
<a href="#l3.20"></a><span id="l3.20"> const nsMsgViewIndex_None = 0xFFFFFFFF;</span>
<a href="#l3.21"></a><span id="l3.21"> const kMailCheckOncePrefName = &quot;mail.startup.enabledMailCheckOnce&quot;;</span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23" class="difflineat">@@ -236,16 +238,18 @@ function AutoConfigWizard(okCallback)</span>
<a href="#l3.24"></a><span id="l3.24">   NewMailAccount(msgWindow, okCallback);</span>
<a href="#l3.25"></a><span id="l3.25"> }</span>
<a href="#l3.26"></a><span id="l3.26"> </span>
<a href="#l3.27"></a><span id="l3.27"> /**</span>
<a href="#l3.28"></a><span id="l3.28">  * Called on startup to initialize various parts of the main window</span>
<a href="#l3.29"></a><span id="l3.29">  */</span>
<a href="#l3.30"></a><span id="l3.30"> function OnLoadMessenger()</span>
<a href="#l3.31"></a><span id="l3.31"> {</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  migrateMailnews();</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+</span>
<a href="#l3.34"></a><span id="l3.34">   // update the pane config before we exit onload otherwise the user may see a flicker if we poke the document</span>
<a href="#l3.35"></a><span id="l3.35">   // in delayedOnLoadMessenger...</span>
<a href="#l3.36"></a><span id="l3.36">   UpdateMailPaneConfig(false);</span>
<a href="#l3.37"></a><span id="l3.37">   document.loadBindingDocument('chrome://global/content/bindings/textbox.xml');</span>
<a href="#l3.38"></a><span id="l3.38"> </span>
<a href="#l3.39"></a><span id="l3.39">   // Set a sane starting width/height for all resolutions on new profiles.</span>
<a href="#l3.40"></a><span id="l3.40">   // Do this before the window loads.</span>
<a href="#l3.41"></a><span id="l3.41">   if (!document.documentElement.hasAttribute(&quot;width&quot;))</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/am-advanced.dtd</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/am-advanced.dtd</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -15,9 +15,9 @@</span>
<a href="#l4.4"></a><span id="l4.4"> &lt;!ENTITY smtpListSetDefault.label &quot;Set Default&quot;&gt;</span>
<a href="#l4.5"></a><span id="l4.5"> &lt;!ENTITY smtpListSetDefault.accesskey &quot;t&quot;&gt;</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7"> &lt;!ENTITY serverDescription.label &quot;Description: &quot;&gt;</span>
<a href="#l4.8"></a><span id="l4.8"> &lt;!ENTITY serverName.label &quot;Server Name: &quot;&gt;</span>
<a href="#l4.9"></a><span id="l4.9"> &lt;!ENTITY serverPort.label &quot;Port: &quot;&gt;</span>
<a href="#l4.10"></a><span id="l4.10"> &lt;!ENTITY userName.label   &quot;User Name: &quot;&gt;</span>
<a href="#l4.11"></a><span id="l4.11"> &lt;!ENTITY connectionSecurity.label &quot;Connection Security: &quot;&gt;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-&lt;!ENTITY useSecureAuthentication.label   &quot;Secure Authentication: &quot;&gt;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+&lt;!ENTITY authMethod.label   &quot;Authentication method: &quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/am-server-top.dtd</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/am-server-top.dtd</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -19,18 +19,18 @@</span>
<a href="#l5.4"></a><span id="l5.4"> &lt;!ENTITY biffStart.accesskey &quot;y&quot;&gt;</span>
<a href="#l5.5"></a><span id="l5.5"> &lt;!ENTITY biffEnd.label &quot;minutes&quot;&gt;</span>
<a href="#l5.6"></a><span id="l5.6"> &lt;!ENTITY connectionSecurity.label &quot;Connection security:&quot;&gt;</span>
<a href="#l5.7"></a><span id="l5.7"> &lt;!ENTITY connectionSecurity.accesskey &quot;u&quot;&gt;</span>
<a href="#l5.8"></a><span id="l5.8"> &lt;!ENTITY connectionSecurityType-0.label &quot;None&quot;&gt;</span>
<a href="#l5.9"></a><span id="l5.9"> &lt;!ENTITY connectionSecurityType-1.label &quot;STARTTLS, if available&quot;&gt;</span>
<a href="#l5.10"></a><span id="l5.10"> &lt;!ENTITY connectionSecurityType-2.label &quot;STARTTLS&quot;&gt;</span>
<a href="#l5.11"></a><span id="l5.11"> &lt;!ENTITY connectionSecurityType-3.label &quot;SSL/TLS&quot;&gt;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-&lt;!ENTITY useSecAuth.label &quot;Use secure authentication&quot;&gt;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-&lt;!ENTITY useSecAuth.accesskey &quot;i&quot;&gt;</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+&lt;!ENTITY authMethod.label &quot;Authentication method:&quot;&gt;</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+&lt;!ENTITY authMethod.accesskey &quot;i&quot;&gt;</span>
<a href="#l5.16"></a><span id="l5.16"> &lt;!ENTITY leaveOnServer.label &quot;Leave messages on server&quot;&gt;</span>
<a href="#l5.17"></a><span id="l5.17"> &lt;!ENTITY leaveOnServer.accesskey &quot;g&quot;&gt;</span>
<a href="#l5.18"></a><span id="l5.18"> &lt;!ENTITY headersOnly.label &quot;Fetch headers only&quot;&gt;</span>
<a href="#l5.19"></a><span id="l5.19"> &lt;!ENTITY headersOnly.accesskey &quot;e&quot;&gt;</span>
<a href="#l5.20"></a><span id="l5.20"> &lt;!ENTITY deleteByAgeFromServer.label &quot;For at most&quot;&gt;</span>
<a href="#l5.21"></a><span id="l5.21"> &lt;!ENTITY deleteByAgeFromServer.accesskey &quot;o&quot;&gt;</span>
<a href="#l5.22"></a><span id="l5.22"> &lt;!ENTITY daysEnd.label &quot;days&quot;&gt;</span>
<a href="#l5.23"></a><span id="l5.23"> &lt;!ENTITY deleteOnServer2.label &quot;Until I delete them&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/imapMsgs.properties</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/imapMsgs.properties</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -362,28 +362,39 @@ 5096=This server does not support quotas</span>
<a href="#l6.4"></a><span id="l6.4"> ## @loc None</span>
<a href="#l6.5"></a><span id="l6.5"> 5097=There are no storage quotas on this folder.</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7"> # Out of memory</span>
<a href="#l6.8"></a><span id="l6.8"> ## @name IMAP_OUT_OF_MEMORY</span>
<a href="#l6.9"></a><span id="l6.9"> ## @loc None</span>
<a href="#l6.10"></a><span id="l6.10"> 5100=Application is out of memory.</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-## @name IMAP_AUTH_SECURE_NOTSUPPORTED</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+## @name IMAP_AUTH_MECH_NOT_SUPPORTED</span>
<a href="#l6.14"></a><span id="l6.14"> ## @loc None</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-5102=You cannot log in to %S because you have enabled secure authentication and this server does not support it.\n\nTo log in, turn off secure authentication for this account.</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+# LOCALIZATION NOTE (5101): %S is the server hostname</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+5101=The IMAP server %S does not support the selected authentication method. Please change the 'Authentication method' in the 'Account Settings | Server settings'.</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+## @name IMAP_AUTH_MECH_FAILED</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+## @loc None</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+# LOCALIZATION NOTE (5102): %S is the server hostname</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+5102=All login mechanisms for %S failed. Please check the password or change the 'Authentication method' in the 'Account Settings | Server settings'.</span>
<a href="#l6.23"></a><span id="l6.23"> </span>
<a href="#l6.24"></a><span id="l6.24"> ## @name IMAP_COPYING_MESSAGE_OF</span>
<a href="#l6.25"></a><span id="l6.25"> ## @loc None</span>
<a href="#l6.26"></a><span id="l6.26"> # LOCALIZATION NOTE (Error 5103): Do not translate the word &quot;%S&quot; below.</span>
<a href="#l6.27"></a><span id="l6.27"> # Place the word %3$S in your translation where the name of the destination folder should appear.</span>
<a href="#l6.28"></a><span id="l6.28"> # Place the word %1$S where the currently copying message should appear.</span>
<a href="#l6.29"></a><span id="l6.29"> # Place the word %2$S where the total number of messages should appear.</span>
<a href="#l6.30"></a><span id="l6.30"> 5103=Copying Message %1$S of %2$S to %3$S</span>
<a href="#l6.31"></a><span id="l6.31"> </span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+## @name IMAP_AUTH_GSSAPI_FAILED</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+## @loc None</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+# LOCALIZATION NOTE (5104): %S is the server hostname</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+5104=The Kerberos/GSSAPI ticket was not accepted by the IMAP server %S. Please check that you are logged in to the Kerberos/GSSAPI realm.</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+</span>
<a href="#l6.37"></a><span id="l6.37"> ## @name IMAP_MOVE_FOLDER_TO_TRASH</span>
<a href="#l6.38"></a><span id="l6.38"> ## @loc None</span>
<a href="#l6.39"></a><span id="l6.39"> # LOCALIZATION NOTE (5105): Do not translate the word %S below.</span>
<a href="#l6.40"></a><span id="l6.40"> # &quot;%S&quot; is the the name of the folder.</span>
<a href="#l6.41"></a><span id="l6.41"> 5105=Are you sure you want to delete the folder '%S'?</span>
<a href="#l6.42"></a><span id="l6.42"> </span>
<a href="#l6.43"></a><span id="l6.43"> ## @name IMAP_DELETE_NO_TRASH</span>
<a href="#l6.44"></a><span id="l6.44"> ## @loc None</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineat">@@ -394,12 +405,22 @@ 5106=Deleting this folder is not undoabl</span>
<a href="#l6.46"></a><span id="l6.46"> ## @name IMAP_DELETE_FOLDER_DIALOG_TITLE</span>
<a href="#l6.47"></a><span id="l6.47"> ## @loc None</span>
<a href="#l6.48"></a><span id="l6.48"> 5107=Delete Folder</span>
<a href="#l6.49"></a><span id="l6.49"> </span>
<a href="#l6.50"></a><span id="l6.50"> ## @name IMAP_DELETE_FOLDER_BUTTON_LABEL</span>
<a href="#l6.51"></a><span id="l6.51"> ## @loc None</span>
<a href="#l6.52"></a><span id="l6.52"> 5108=&amp;Delete Folder</span>
<a href="#l6.53"></a><span id="l6.53"> </span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-## @name IMAP_LOGIN_DISABLED</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+## @name IMAP_AUTH_CHANGE_ENCRYPT_TO_PLAIN_NO_SSL</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+## @loc None</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+# LOCALIZATION NOTE (5109): %S is the server hostname</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+5109=The IMAP server %S does not seem to support encrypted passwords. If you just set up the account, please try changing to 'Password, transmitted insecurely' as the 'Authentication method' in the 'Account Settings | Server settings'. If it used to work and now suddenly fails, this is a common scenario how someone could steal your password.</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+## @name IMAP_AUTH_CHANGE_ENCRYPT_TO_PLAIN_SSL</span>
<a href="#l6.61"></a><span id="l6.61"> ## @loc None</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-# LOCALIZATION NOTE (5109): %S is the server address</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-5109=You cannot log in to %S because the server doesn't allow plaintext authentication without STARTTLS or SSL/TLS. Try enabling connection security or secure authentication in the account settings.</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+# LOCALIZATION NOTE (5110): %S is the server hostname</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+5110=The IMAP server %S does not seem to support encrypted passwords. If you just set up this account, please try changing to 'Normal password' as the 'Authentication method' in the 'Account Settings | Server settings'. If it used to work and now suddenly fails, please contact your email administrator or provider.</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+## @name IMAP_AUTH_CHANGE_PLAIN_TO_ENCRYPT</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+## @loc None</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+# LOCALIZATION NOTE (5111): %S is the server hostname</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+5111=The IMAP server %S does not allow plaintext passwords. Please try changing to 'Encrypted password' as the 'Authentication method' in the 'Account Settings | Server settings'.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/localMsgs.properties</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/localMsgs.properties</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -160,20 +160,25 @@ 4027=Copying %S of %S messages to %S</span>
<a href="#l7.4"></a><span id="l7.4"> ## @loc None</span>
<a href="#l7.5"></a><span id="l7.5"> 4028=Moving %S of %S messages to %S</span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7"> # Status - write error occurred</span>
<a href="#l7.8"></a><span id="l7.8"> ## @name POP3_MESSAGE_FOLDER_BUSY</span>
<a href="#l7.9"></a><span id="l7.9"> ## @loc None</span>
<a href="#l7.10"></a><span id="l7.10"> 4029=This folder is being processed. Please wait until processing is complete to get messages.</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-# secure authentication failed</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-## @name CANNOT_PROCESS_SECURE_AUTH</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+# Authentication server caps and pref don't match</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+## @name POP3_AUTH_MECH_NOT_SUPPORTED</span>
<a href="#l7.16"></a><span id="l7.16"> ## @loc None</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-4030=Mail server does not support secure authentication.</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+4030=The server does not support the selected authentication method. Please change the 'Authentication method' in the 'Account Settings | Server settings'.</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+# Status - Could not log in to GSSAPI, and it was the only method</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+## @name POP3_GSSAPI_FAILURE</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+## @loc None</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+4031=The Kerberos/GSSAPI ticket was not accepted by the POP server. Please check that you are logged in to the Kerberos/GSSAPI realm.</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25"> ## @name MOVEMAIL_CANT_OPEN_SPOOL_FILE</span>
<a href="#l7.26"></a><span id="l7.26"> ## @loc None</span>
<a href="#l7.27"></a><span id="l7.27"> 4033=Unable to open mail spool file %S.</span>
<a href="#l7.28"></a><span id="l7.28"> </span>
<a href="#l7.29"></a><span id="l7.29"> ## @name MOVEMAIL_CANT_CREATE_LOCK</span>
<a href="#l7.30"></a><span id="l7.30"> ## @loc None</span>
<a href="#l7.31"></a><span id="l7.31"> 4034=Unable to create lock file %S. For movemail to work, it is necessary to create lock files in the mail spool directory. On many systems, this is best accomplished by making the spool directory be mode 01777.</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineat">@@ -207,21 +212,16 @@ 4040=The POP3 mail server (%S) does not </span>
<a href="#l7.33"></a><span id="l7.33"> ## @name POP3_SERVER_DOES_NOT_SUPPORT_THE_TOP_COMMAND</span>
<a href="#l7.34"></a><span id="l7.34"> ## @loc None</span>
<a href="#l7.35"></a><span id="l7.35"> # LOCALIZATION NOTE(4011): The following sentence should be translated in this way:</span>
<a href="#l7.36"></a><span id="l7.36"> # Do not translate &quot;POP3&quot;</span>
<a href="#l7.37"></a><span id="l7.37"> # Do not translate &quot;%S&quot;. Place %S in your translation where the name of the server should appear.</span>
<a href="#l7.38"></a><span id="l7.38"> # Do not translate &quot;TOP&quot;</span>
<a href="#l7.39"></a><span id="l7.39"> 4041=The POP3 mail server (%S) does not support the TOP command. Without server support for this, we cannot implement the ``Maximum Message Size'' or ``Fetch Headers Only'' preference.  This option has been disabled, and messages will be downloaded regardless of their size.</span>
<a href="#l7.40"></a><span id="l7.40"> </span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-# secure authentication failed and unsure why</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-## @name CANNOT_PROCESS_APOP_AUTH</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-## @loc None</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-4042=The mail server does not support secure authentication or you have entered an incorrect password. Please check your password, or turn off secure authentication in the Server Settings for your mail server in the Account Settings window.\n</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-</span>
<a href="#l7.46"></a><span id="l7.46"> ## @name NS_ERROR_COULD_NOT_CONNECT_VIA_TLS</span>
<a href="#l7.47"></a><span id="l7.47"> ## @loc None</span>
<a href="#l7.48"></a><span id="l7.48"> 4043=Unable to establish TLS connection to POP3 server. The server may be down or may be incorrectly configured. Please verify the correct configuration in the Server Settings for your mail server in the Account Settings window and try again.</span>
<a href="#l7.49"></a><span id="l7.49"> </span>
<a href="#l7.50"></a><span id="l7.50"> ## @name POP3_MOVE_FOLDER_TO_TRASH</span>
<a href="#l7.51"></a><span id="l7.51"> ## @loc None</span>
<a href="#l7.52"></a><span id="l7.52"> # LOCALIZATION NOTE (4044): Do not translate the word %S below.</span>
<a href="#l7.53"></a><span id="l7.53"> # &quot;%S&quot; is the the name of the folder.</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineat">@@ -229,8 +229,24 @@ 4044=Are you sure you want to delete the</span>
<a href="#l7.55"></a><span id="l7.55"> </span>
<a href="#l7.56"></a><span id="l7.56"> ## @name POP3_DELETE_FOLDER_DIALOG_TITLE</span>
<a href="#l7.57"></a><span id="l7.57"> ## @loc None</span>
<a href="#l7.58"></a><span id="l7.58"> 4045=Delete Folder</span>
<a href="#l7.59"></a><span id="l7.59"> </span>
<a href="#l7.60"></a><span id="l7.60"> ## @name POP3_DELETE_FOLDER_BUTTON_LABEL</span>
<a href="#l7.61"></a><span id="l7.61"> ## @loc None</span>
<a href="#l7.62"></a><span id="l7.62"> 4046=&amp;Delete Folder</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+## @name POP3_AUTH_INTERNAL_ERROR</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+## @loc None</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+4047=Internal state error during POP3 server authentication. This is an internal, unexpected error in the application, please report it as bug.</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+## @name POP3_AUTH_CHANGE_ENCRYPT_TO_PLAIN_NO_SSL</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+## @loc None</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+4048=This POP3 server does not seem to support encrypted passwords. If you just set up the account, please try changing to 'Password, transmitted insecurely' as the 'Authentication method' in the 'Account Settings | Server settings'. If it used to work and now suddenly fails, this is a common scenario how someone could steal your password.</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+## @name POP3_AUTH_CHANGE_ENCRYPT_TO_PLAIN_SSL</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+## @loc None</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+4049=This POP3 server does not seem to support encrypted passwords. If you just set up this account, please try changing to 'Normal password' as the 'Authentication method' in the 'Account Settings | Server settings'. If it used to work and now suddenly fails, please contact your email administrator or provider.</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+## @name POP3_AUTH_CHANGE_PLAIN_TO_ENCRYPT</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+## @loc None</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+4050=This POP3 server does not allow plaintext passwords. Please try changing to 'Encrypted password' as the 'Authentication method' in the 'Account Settings | Server settings'.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/messenger.properties</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/messenger.properties</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -128,16 +128,27 @@ smtpServer-ConnectionSecurityType-0=None</span>
<a href="#l8.4"></a><span id="l8.4"> smtpServer-ConnectionSecurityType-1=STARTTLS, if available</span>
<a href="#l8.5"></a><span id="l8.5"> smtpServer-ConnectionSecurityType-2=STARTTLS</span>
<a href="#l8.6"></a><span id="l8.6"> smtpServer-ConnectionSecurityType-3=SSL/TLS</span>
<a href="#l8.7"></a><span id="l8.7"> smtpServer-SecureAuthentication-Type-false=No</span>
<a href="#l8.8"></a><span id="l8.8"> smtpServer-SecureAuthentication-Type-true=Yes</span>
<a href="#l8.9"></a><span id="l8.9"> smtpServers-confirmServerDeletionTitle=Delete Server</span>
<a href="#l8.10"></a><span id="l8.10"> smtpServers-confirmServerDeletion=Are you sure you want to delete the server: \n %S?</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+# Account Settings - Both Incoming and SMTP server</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+authNo=No authentication</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+authOld=Password, original method (insecure)</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+authPasswordCleartextInsecurely=Password, transmitted insecurely</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+authPasswordCleartextViaSSL=Normal password</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+authPasswordEncrypted=Encrypted password</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+authKerberos=Kerberos / GSSAPI</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+authNTLM=NTLM</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+authAnySecure=Any secure method (deprecated)</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+authAny=Any method (insecure)</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+</span>
<a href="#l8.23"></a><span id="l8.23"> # LOCALIZATION NOTE(serverType-nntp): Do not translate &quot;NNTP&quot; in the line below</span>
<a href="#l8.24"></a><span id="l8.24"> serverType-nntp=News Server (NNTP)</span>
<a href="#l8.25"></a><span id="l8.25"> # LOCALIZATION NOTE(serverType-pop3): Do not translate &quot;POP&quot; in the line below</span>
<a href="#l8.26"></a><span id="l8.26"> serverType-pop3=POP Mail Server</span>
<a href="#l8.27"></a><span id="l8.27"> # LOCALIZATION NOTE(serverType-imap): Do not translate &quot;IMAP&quot; in the line below</span>
<a href="#l8.28"></a><span id="l8.28"> serverType-imap=IMAP Mail Server</span>
<a href="#l8.29"></a><span id="l8.29"> serverType-none=Local Mail Store</span>
<a href="#l8.30"></a><span id="l8.30"> # LOCALIZATION NOTE(serverType-movemail): DONT_TRANSLATE</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/messengercompose/composeMsgs.properties</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/messengercompose/composeMsgs.properties</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -203,31 +203,31 @@ 12570=There was an error attaching %S. P</span>
<a href="#l9.4"></a><span id="l9.4"> 12571=There was an error copying the message to the Sent folder. Retry?</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6"> ## @name NS_ERROR_SMTP_GREETING</span>
<a href="#l9.7"></a><span id="l9.7"> 12572=An error occurred sending mail: The mail server sent an incorrect greeting:  %s.</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9"> ## @name NS_ERROR_SENDING_RCPT_COMMAND</span>
<a href="#l9.10"></a><span id="l9.10"> 12575=An error occurred while sending mail. The mail server responded:  %1$s. Please check the message recipient %2$s and try again.</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-## @name NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER_INSECAUTH</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-12579=An error occurred sending mail: Unable to authenticate to SMTP server %S. The server does not support any compatible insecure authentication mechanism but you have chosen insecure authentication. Try switching on secure authentication or contact your service provider.</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+## @name NS_ERROR_SMTP_AUTH_FAILURE</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+12576=Unable to authenticate to SMTP server %S. Please check the password, and verify the 'Authentication method' in 'Account Settings | Outgoing server (SMTP)'.</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+## @name NS_ERROR_SMTP_AUTH_GSSAPI</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+12579=The Kerberos/GSSAPI ticket was not accepted by the SMTP server %S. Please check that you are logged in to the Kerberos/GSSAPI realm.</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-## @name NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER_SECAUTH</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-12580=An error occurred sending mail: Unable to authenticate to SMTP server %S. The server does not support any compatible secure authentication mechanism but you have chosen secure authentication. Try switching off secure authentication or contact your service provider.</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+## @name NS_ERROR_SMTP_AUTH_MECH_NOT_SUPPORTED</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+12580=The SMTP server %S does not support the selected authentication method. Please change the 'Authentication method' in the 'Account Settings | Outgoing Server (SMTP)'.</span>
<a href="#l9.24"></a><span id="l9.24"> </span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-## @name NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER_AUTH_NONE</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-12581=An error occurred sending mail: Unable to authenticate to SMTP server %S. It does not support authentication (SMTP-AUTH) but you have chosen to use authentication. Uncheck 'Use name and password' for that server or contact your service provider.</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+## @name NS_ERROR_SMTP_AUTH_NOT_SUPPORTED</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+12581=Unable to authenticate to SMTP server %S. It does not support authentication (SMTP-AUTH) but you have chosen to use authentication. Please change the 'Authentication method' to 'None' in the 'Account Settings | Outgoing Server (SMTP)' or contact your email service provider for instructions.</span>
<a href="#l9.29"></a><span id="l9.29"> </span>
<a href="#l9.30"></a><span id="l9.30"> ## @name NS_ERROR_STARTTLS_FAILED_EHLO_STARTTLS</span>
<a href="#l9.31"></a><span id="l9.31"> 12582=An error occurred sending mail: Unable to establish a secure link with SMTP server %S using STARTTLS since it doesn't advertise that feature. Switch off STARTTLS for that server or contact your service provider.</span>
<a href="#l9.32"></a><span id="l9.32"> </span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-## @name NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-12583=An error occurred sending mail: Unable to log in to SMTP server %S. The server may be incorrectly configured. Please verify that your SMTP server settings are correct and try again.</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-</span>
<a href="#l9.36"></a><span id="l9.36"> ## @name NS_ERROR_SMTP_PASSWORD_UNDEFINED</span>
<a href="#l9.37"></a><span id="l9.37"> 12584=An error occurred sending mail: Could not get password for %S. The message was not sent.</span>
<a href="#l9.38"></a><span id="l9.38"> </span>
<a href="#l9.39"></a><span id="l9.39"> ## @name NS_ERROR_SMTP_TEMP_SIZE_EXCEEDED</span>
<a href="#l9.40"></a><span id="l9.40"> 12586=The size of the message you are trying to send exceeds a temporary size limit of the server. The message was not sent; try to reduce the message size or wait some time and try again. The server responded:  %s.</span>
<a href="#l9.41"></a><span id="l9.41"> </span>
<a href="#l9.42"></a><span id="l9.42"> ## @name NS_ERROR_SMTP_PERM_SIZE_EXCEEDED_1</span>
<a href="#l9.43"></a><span id="l9.43"> 12587=The size of the message you are trying to send exceeds the global size limit (%d bytes) of the server. The message was not sent; reduce the message size and try again.</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineat">@@ -245,16 +245,26 @@ 12590=The message could not be sent beca</span>
<a href="#l9.45"></a><span id="l9.45"> 12591=The message could not be sent because the connection to SMTP server %S was lost in the middle of the transaction. Try again or contact your network administrator.</span>
<a href="#l9.46"></a><span id="l9.46"> </span>
<a href="#l9.47"></a><span id="l9.47"> ## @name NS_ERROR_SMTP_SEND_FAILED_TIMEOUT</span>
<a href="#l9.48"></a><span id="l9.48"> 12592=The message could not be sent because the connection to SMTP server %S timed out. Try again or contact your network administrator.</span>
<a href="#l9.49"></a><span id="l9.49"> </span>
<a href="#l9.50"></a><span id="l9.50"> ## @name NS_ERROR_SMTP_SEND_FAILED_UNKNOWN_REASON</span>
<a href="#l9.51"></a><span id="l9.51"> 12593=The message could not be sent using SMTP server %S for an unknown reason. Please verify that your SMTP server settings are correct and try again, or contact your network administrator.</span>
<a href="#l9.52"></a><span id="l9.52"> </span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+## @name NS_ERROR_SMTP_AUTH_CHANGE_ENCRYPT_TO_PLAIN_NO_SSL</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+12594=The SMTP server %S does not seem to support encrypted passwords. If you just set up the account, please try changing to 'Password, transmitted insecurely' as the 'Authentication method' in the 'Account Settings | Server settings'. If it used to work and now suddenly fails, this is a common scenario how someone could steal your password.</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+## @name NS_ERROR_SMTP_AUTH_CHANGE_ENCRYPT_TO_PLAIN_SSL</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+12595=The SMTP server %S does not seem to support encrypted passwords. If you just set up this account, please try changing to 'Normal password' as the 'Authentication method' in the 'Account Settings | Server settings'. If it used to work and now suddenly fails, please contact your email administrator or provider.</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+## @name NS_ERROR_SMTP_AUTH_CHANGE_PLAIN_TO_ENCRYPT</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+12596=The SMTP server %S does not allow plaintext passwords. Please try changing to 'Encrypted password' as the 'Authentication method' in the 'Account Settings | Server settings'.</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+</span>
<a href="#l9.63"></a><span id="l9.63"> ## Strings use for the save message dialog shown when the user close a message compose window</span>
<a href="#l9.64"></a><span id="l9.64"> saveDlogTitle=Save Message</span>
<a href="#l9.65"></a><span id="l9.65"> saveDlogMessage=Message has not been sent. Do you want to save the message in the Drafts folder?</span>
<a href="#l9.66"></a><span id="l9.66"> </span>
<a href="#l9.67"></a><span id="l9.67"> ## generics string</span>
<a href="#l9.68"></a><span id="l9.68"> defaultSubject=(no subject)</span>
<a href="#l9.69"></a><span id="l9.69"> chooseFileToAttach=Attach File(s)</span>
<a href="#l9.70"></a><span id="l9.70"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/smtpEditOverlay.dtd</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/smtpEditOverlay.dtd</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1,22 +1,20 @@</span>
<a href="#l10.4"></a><span id="l10.4"> &lt;!ENTITY settings.caption &quot;Settings&quot;&gt;</span>
<a href="#l10.5"></a><span id="l10.5"> &lt;!ENTITY security.caption &quot;Security and Authentication&quot;&gt;</span>
<a href="#l10.6"></a><span id="l10.6"> &lt;!ENTITY serverName.label &quot;Server Name:&quot;&gt;</span>
<a href="#l10.7"></a><span id="l10.7"> &lt;!ENTITY serverName.accesskey &quot;S&quot;&gt;</span>
<a href="#l10.8"></a><span id="l10.8"> &lt;!ENTITY serverDescription.label &quot;Description:&quot;&gt;</span>
<a href="#l10.9"></a><span id="l10.9"> &lt;!ENTITY serverDescription.accesskey &quot;D&quot;&gt;</span>
<a href="#l10.10"></a><span id="l10.10"> &lt;!ENTITY serverPort.label &quot;Port:&quot;&gt;</span>
<a href="#l10.11"></a><span id="l10.11"> &lt;!ENTITY serverPort.accesskey &quot;P&quot;&gt;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-&lt;!ENTITY alwaysUseUsername.label &quot;Use name and password&quot;&gt;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-&lt;!ENTITY alwaysUseUsername.accesskey &quot;U&quot;&gt;</span>
<a href="#l10.14"></a><span id="l10.14"> &lt;!ENTITY userName.label &quot;User Name:&quot;&gt;</span>
<a href="#l10.15"></a><span id="l10.15"> &lt;!ENTITY userName.accesskey &quot;m&quot;&gt;</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-&lt;!ENTITY useSecAuth.label &quot;Use secure authentication&quot;&gt;</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-&lt;!ENTITY useSecAuth.accesskey &quot;i&quot;&gt;</span>
<a href="#l10.18"></a><span id="l10.18"> &lt;!ENTITY connectionSecurity.label &quot;Connection security:&quot;&gt;</span>
<a href="#l10.19"></a><span id="l10.19"> &lt;!ENTITY connectionSecurity.accesskey &quot;n&quot;&gt;</span>
<a href="#l10.20"></a><span id="l10.20"> &lt;!ENTITY connectionSecurityType-0.label &quot;None&quot;&gt;</span>
<a href="#l10.21"></a><span id="l10.21"> &lt;!ENTITY connectionSecurityType-1.label &quot;STARTTLS, if available&quot;&gt;</span>
<a href="#l10.22"></a><span id="l10.22"> &lt;!ENTITY connectionSecurityType-2.label &quot;STARTTLS&quot;&gt;</span>
<a href="#l10.23"></a><span id="l10.23"> &lt;!ENTITY connectionSecurityType-3.label &quot;SSL/TLS&quot;&gt;</span>
<a href="#l10.24"></a><span id="l10.24"> &lt;!ENTITY smtpEditTitle.label &quot;SMTP Server&quot;&gt;</span>
<a href="#l10.25"></a><span id="l10.25"> &lt;!ENTITY serverPortDefault.label &quot;Default:&quot;&gt;</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+&lt;!ENTITY authMethod.label &quot;Authentication method:&quot;&gt;</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+&lt;!ENTITY authMethod.accesskey &quot;i&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/base/prefs/content/AccountManager.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/base/prefs/content/AccountManager.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -383,39 +383,16 @@ function onAddAccount() {</span>
<a href="#l11.4"></a><span id="l11.4"> function AddMailAccount()</span>
<a href="#l11.5"></a><span id="l11.5"> {</span>
<a href="#l11.6"></a><span id="l11.6">   let msgWindow = Components.classes[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l11.7"></a><span id="l11.7">                             .getService(Components.interfaces.nsIMsgMailSession)</span>
<a href="#l11.8"></a><span id="l11.8">                             .topmostMsgWindow;</span>
<a href="#l11.9"></a><span id="l11.9">   NewMailAccount(msgWindow);</span>
<a href="#l11.10"></a><span id="l11.10"> }</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-function ReloadSmtpPanel()</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-{</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-  var smtpUsername = top.frames[&quot;contentFrame&quot;].document.getElementById(&quot;smtp.username&quot;);</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-  var smtpHostname = top.frames[&quot;contentFrame&quot;].document.getElementById(&quot;smtp.hostname&quot;);</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-  var smtpPort = top.frames[&quot;contentFrame&quot;].document.getElementById(&quot;smtp.port&quot;);</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-  var smtpUseUsername = top.frames[&quot;contentFrame&quot;].document.getElementById(&quot;smtp.useUsername&quot;);</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-  var smtpAuthMethod = top.frames[&quot;contentFrame&quot;].document.getElementById(&quot;smtp.authMethod&quot;);</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-  var smtpTrySSL = top.frames[&quot;contentFrame&quot;].document.getElementById(&quot;smtp.trySSL&quot;);</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-  var defaultServer = smtpService.defaultServer;</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-  smtpUsername.value = defaultServer.username;</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-  smtpHostname.value = defaultServer.hostname;</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-  smtpPort.value = defaultServer.port ? defaultServer.port : &quot;&quot;;</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-  smtpAuthMethod.setAttribute(&quot;value&quot;, defaultServer.authMethod);</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-  if (smtpAuthMethod.getAttribute(&quot;value&quot;) == &quot;1&quot;)</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-    smtpUseUsername.checked = true;</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-  var elements = smtpTrySSL.getElementsByAttribute(&quot;value&quot;, defaultServer.trySSL);</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-  if (!elements.item(0))</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-    elements = smtpTrySSL.getElementsByAttribute(&quot;value&quot;, &quot;1&quot;);</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-  smtpTrySSL.selectedItem = elements[0];</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-}</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-</span>
<a href="#l11.35"></a><span id="l11.35"> function onSetDefault(event) {</span>
<a href="#l11.36"></a><span id="l11.36">   if (event.target.getAttribute(&quot;disabled&quot;) == &quot;true&quot;) return;</span>
<a href="#l11.37"></a><span id="l11.37"> </span>
<a href="#l11.38"></a><span id="l11.38">   Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l11.39"></a><span id="l11.39">             .getService(Components.interfaces.nsIMsgAccountManager)</span>
<a href="#l11.40"></a><span id="l11.40">             .defaultAccount = currentAccount;</span>
<a href="#l11.41"></a><span id="l11.41">   setEnabled(document.getElementById(&quot;setDefaultButton&quot;), false);</span>
<a href="#l11.42"></a><span id="l11.42"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/base/prefs/content/SmtpServerEdit.xul</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/base/prefs/content/SmtpServerEdit.xul</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -47,12 +47,13 @@</span>
<a href="#l12.4"></a><span id="l12.4"> </span>
<a href="#l12.5"></a><span id="l12.5"> &lt;dialog title=&quot;&amp;smtpEditTitle.label;&quot;</span>
<a href="#l12.6"></a><span id="l12.6">         xmlns:rdf=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;</span>
<a href="#l12.7"></a><span id="l12.7">         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l12.8"></a><span id="l12.8">         onload=&quot;onLoad();&quot;</span>
<a href="#l12.9"></a><span id="l12.9">         ondialogaccept=&quot;return onAccept();&quot;&gt;</span>
<a href="#l12.10"></a><span id="l12.10"> &lt;stringbundle id=&quot;bundle_prefs&quot; src=&quot;chrome://messenger/locale/prefs.properties&quot;/&gt;</span>
<a href="#l12.11"></a><span id="l12.11"> &lt;stringbundle id=&quot;bundle_brand&quot; src=&quot;chrome://branding/locale/brand.properties&quot;/&gt;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+&lt;stringbundle id=&quot;bundle_messenger&quot; src=&quot;chrome://messenger/locale/messenger.properties&quot;/&gt;</span>
<a href="#l12.13"></a><span id="l12.13"> &lt;script type=&quot;application/javascript&quot; src=&quot;amUtils.js&quot;/&gt;</span>
<a href="#l12.14"></a><span id="l12.14"> &lt;script type=&quot;application/javascript&quot; src=&quot;SmtpServerEdit.js&quot;/&gt;</span>
<a href="#l12.15"></a><span id="l12.15"> &lt;vbox id=&quot;smtpServerEditor&quot;/&gt;</span>
<a href="#l12.16"></a><span id="l12.16"> &lt;/dialog&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountUtils.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountUtils.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -208,32 +208,32 @@ function verifyAccounts(wizardCallback, </span>
<a href="#l13.4"></a><span id="l13.4"> // we do this from a timer because if this is called from the onload=</span>
<a href="#l13.5"></a><span id="l13.5"> // handler, then the parent window doesn't appear until after the wizard</span>
<a href="#l13.6"></a><span id="l13.6"> // has closed, and this is confusing to the user</span>
<a href="#l13.7"></a><span id="l13.7"> function MsgAccountWizard(wizardCallback)</span>
<a href="#l13.8"></a><span id="l13.8"> {</span>
<a href="#l13.9"></a><span id="l13.9">   setTimeout(function() { msgOpenAccountWizard(wizardCallback); }, 0);</span>
<a href="#l13.10"></a><span id="l13.10"> }</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+// @see msgNewMailAccount below</span>
<a href="#l13.13"></a><span id="l13.13"> function msgOpenAccountWizard(wizardCallback)</span>
<a href="#l13.14"></a><span id="l13.14"> {</span>
<a href="#l13.15"></a><span id="l13.15">   gNewAccountToLoad = null;</span>
<a href="#l13.16"></a><span id="l13.16"> </span>
<a href="#l13.17"></a><span id="l13.17">   window.openDialog(&quot;chrome://messenger/content/AccountWizard.xul&quot;, &quot;AccountWizard&quot;,</span>
<a href="#l13.18"></a><span id="l13.18">                     &quot;chrome,modal,titlebar,centerscreen&quot;, {okCallback: wizardCallback});</span>
<a href="#l13.19"></a><span id="l13.19"> </span>
<a href="#l13.20"></a><span id="l13.20">   loadInboxForNewAccount();</span>
<a href="#l13.21"></a><span id="l13.21"> </span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-  // For the first account we need to reset the default smtp server in the</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-  // panel, by accessing smtpServers we are actually ensuring the smtp server</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineminus">-  // list is loaded.</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-  var smtpService = Components.classes[&quot;@mozilla.org/messengercompose/smtp;1&quot;].getService(Components.interfaces.nsISmtpService);</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-  var servers = smtpService.smtpServers;</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-  try{ReloadSmtpPanel();}</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-  catch(ex){}</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+  // If we started with no servers at all and &quot;smtp servers&quot; list selected,</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+  // refresh display somehow. Bug 58506.</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+  // TODO Better fix: select newly created account (in all cases)</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+  if (typeof(getCurrentAccount) == &quot;function&quot; &amp;&amp; // in AccountManager, not menu</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+      !getCurrentAccount())</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+    selectServer(null, null);</span>
<a href="#l13.35"></a><span id="l13.35"> }</span>
<a href="#l13.36"></a><span id="l13.36"> </span>
<a href="#l13.37"></a><span id="l13.37"> // selectPage: the xul file name for the viewing page, </span>
<a href="#l13.38"></a><span id="l13.38"> // null for the account main page, other pages are</span>
<a href="#l13.39"></a><span id="l13.39"> // 'am-server.xul', 'am-copies.xul', 'am-offline.xul', </span>
<a href="#l13.40"></a><span id="l13.40"> // 'am-addressing.xul', 'am-smtp.xul'</span>
<a href="#l13.41"></a><span id="l13.41"> function MsgAccountManager(selectPage)</span>
<a href="#l13.42"></a><span id="l13.42"> {</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineat">@@ -317,22 +317,30 @@ function migrateGlobalQuotingPrefs(allId</span>
<a href="#l13.44"></a><span id="l13.44"> // has closed, and this is confusing to the user</span>
<a href="#l13.45"></a><span id="l13.45"> function NewMailAccount(msgWindow, okCallback)</span>
<a href="#l13.46"></a><span id="l13.46"> {</span>
<a href="#l13.47"></a><span id="l13.47">   if (!msgWindow)</span>
<a href="#l13.48"></a><span id="l13.48">     throw new Error(&quot;NewMailAccount must be given a msgWindow.&quot;);</span>
<a href="#l13.49"></a><span id="l13.49">   setTimeout(msgNewMailAccount, 0, msgWindow, okCallback);</span>
<a href="#l13.50"></a><span id="l13.50"> }</span>
<a href="#l13.51"></a><span id="l13.51"> </span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+// @see msgOpenAccountWizard above</span>
<a href="#l13.53"></a><span id="l13.53"> function msgNewMailAccount(msgWindow, okCallback)</span>
<a href="#l13.54"></a><span id="l13.54"> {</span>
<a href="#l13.55"></a><span id="l13.55">   if (!msgWindow)</span>
<a href="#l13.56"></a><span id="l13.56">     throw new Error(&quot;msgNewMailAccount must be given a msgWindow.&quot;);</span>
<a href="#l13.57"></a><span id="l13.57">   let wm = Components.classes[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l13.58"></a><span id="l13.58">                      .getService()</span>
<a href="#l13.59"></a><span id="l13.59">                      .QueryInterface(Components.interfaces.nsIWindowMediator);</span>
<a href="#l13.60"></a><span id="l13.60">   let existingWindow = wm.getMostRecentWindow(&quot;mail:autoconfig&quot;);</span>
<a href="#l13.61"></a><span id="l13.61">   if (existingWindow)</span>
<a href="#l13.62"></a><span id="l13.62">     existingWindow.focus();</span>
<a href="#l13.63"></a><span id="l13.63">   else</span>
<a href="#l13.64"></a><span id="l13.64">     window.openDialog(&quot;chrome://messenger/content/accountcreation/emailWizard.xul&quot;,</span>
<a href="#l13.65"></a><span id="l13.65">                       &quot;AccountSetup&quot;, &quot;chrome,titlebar,centerscreen&quot;,{msgWindow:msgWindow, okCallback:okCallback});</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+  // If we started with no servers at all and &quot;smtp servers&quot; list selected,</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+  // refresh display somehow. Bug 58506.</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+  // TODO Better fix: select newly created account (in all cases)</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+  if (typeof(getCurrentAccount) == &quot;function&quot; &amp;&amp; // in AccountManager, not menu</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+      !getCurrentAccount())</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+    selectServer(null, null);</span>
<a href="#l13.73"></a><span id="l13.73"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/accountConfig.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/accountConfig.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -58,17 +58,21 @@ function AccountConfig()</span>
<a href="#l14.4"></a><span id="l14.4">     type : null, // string-enum: &quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;</span>
<a href="#l14.5"></a><span id="l14.5">     hostname: null,</span>
<a href="#l14.6"></a><span id="l14.6">     port : null, // Integer</span>
<a href="#l14.7"></a><span id="l14.7">     username : null, // String. May be a placeholder (starts and ends with %).</span>
<a href="#l14.8"></a><span id="l14.8">     password : null,</span>
<a href="#l14.9"></a><span id="l14.9">     // enum: 1 = plain, 2 = SSL/TLS, 3 = STARTTLS always</span>
<a href="#l14.10"></a><span id="l14.10">     // ('TLS when available' is insecure and not supported here)</span>
<a href="#l14.11"></a><span id="l14.11">     socketType : null,</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-    auth : null, // enum: 1 = plain, 2 = &quot;secure&quot;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+    /**</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+     * Defined by Ci.nsMsgAuthMethod</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+     * Same as server pref &quot;authMethod&quot;.</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+     */</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+    auth : 0,</span>
<a href="#l14.18"></a><span id="l14.18">     checkInterval : 10, // Integer, in seconds</span>
<a href="#l14.19"></a><span id="l14.19">     loginAtStartup : true,</span>
<a href="#l14.20"></a><span id="l14.20">     // POP3 only:</span>
<a href="#l14.21"></a><span id="l14.21">     useGlobalInbox : false, // boolean. Not yet implemented.</span>
<a href="#l14.22"></a><span id="l14.22">     leaveMessagesOnServer : true,</span>
<a href="#l14.23"></a><span id="l14.23">     daysToLeaveMessagesOnServer : 14,</span>
<a href="#l14.24"></a><span id="l14.24">     deleteByAgeFromServer : true,</span>
<a href="#l14.25"></a><span id="l14.25">     // When user hits delete, delete from local store and from server</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineat">@@ -77,17 +81,17 @@ function AccountConfig()</span>
<a href="#l14.27"></a><span id="l14.27">   },</span>
<a href="#l14.28"></a><span id="l14.28">   this.outgoing =</span>
<a href="#l14.29"></a><span id="l14.29">   {</span>
<a href="#l14.30"></a><span id="l14.30">     hostname: null,</span>
<a href="#l14.31"></a><span id="l14.31">     port : null, // see incoming</span>
<a href="#l14.32"></a><span id="l14.32">     username : null, // see incoming. may be null, if auth is 0.</span>
<a href="#l14.33"></a><span id="l14.33">     password : null, // see incoming. may be null, if auth is 0.</span>
<a href="#l14.34"></a><span id="l14.34">     socketType : null, // see incoming</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">-    auth : null, // see incoming. 0 for no auth.</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+    auth : null, // see incoming</span>
<a href="#l14.37"></a><span id="l14.37">     addThisServer: true, // if we already have an SMTP server, add this or not.</span>
<a href="#l14.38"></a><span id="l14.38">     // if we already have an SMTP server, use it.</span>
<a href="#l14.39"></a><span id="l14.39">     useGlobalPreferredServer : false,</span>
<a href="#l14.40"></a><span id="l14.40">     existingServerKey : null, // we should reuse an already configures SMTP server. This is nsISmtpServer.key.</span>
<a href="#l14.41"></a><span id="l14.41">     existingServerLabel : null // user display value for existingServerKey</span>
<a href="#l14.42"></a><span id="l14.42">   },</span>
<a href="#l14.43"></a><span id="l14.43">   this.identity =</span>
<a href="#l14.44"></a><span id="l14.44">   {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/createInBackend.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/createInBackend.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -54,29 +54,28 @@ function createAccountInBackend(config)</span>
<a href="#l15.4"></a><span id="l15.4">                     .getService(Ci.nsISmtpService);</span>
<a href="#l15.5"></a><span id="l15.5"> </span>
<a href="#l15.6"></a><span id="l15.6">   // incoming server</span>
<a href="#l15.7"></a><span id="l15.7">   var inServer = accountManager.createIncomingServer(</span>
<a href="#l15.8"></a><span id="l15.8">       config.incoming.username,</span>
<a href="#l15.9"></a><span id="l15.9">       config.incoming.hostname,</span>
<a href="#l15.10"></a><span id="l15.10">       sanitize.enum(config.incoming.type, [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]));</span>
<a href="#l15.11"></a><span id="l15.11">   inServer.port = config.incoming.port;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+  inServer.authMethod = config.incoming.auth;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+  inServer.password = config.incoming.password;</span>
<a href="#l15.14"></a><span id="l15.14">   if (config.rememberPassword &amp;&amp; config.incoming.password.length)</span>
<a href="#l15.15"></a><span id="l15.15">     rememberPassword(inServer, config.incoming.password);</span>
<a href="#l15.16"></a><span id="l15.16"> </span>
<a href="#l15.17"></a><span id="l15.17">   // SSL</span>
<a href="#l15.18"></a><span id="l15.18">   if (config.incoming.socketType == 1) // plain</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-    inServer.socketType = Ci.nsIMsgIncomingServer.defaultSocket;</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+    inServer.socketType = Ci.nsMsgSocketType.plain;</span>
<a href="#l15.21"></a><span id="l15.21">   else if (config.incoming.socketType == 2) // SSL / TLS</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineminus">-    inServer.socketType = Ci.nsIMsgIncomingServer.useSSL;</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+    inServer.socketType = Ci.nsMsgSocketType.SSL;</span>
<a href="#l15.24"></a><span id="l15.24">   else if (config.incoming.socketType == 3) // STARTTLS</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineminus">-    inServer.socketType = Ci.nsIMsgIncomingServer.alwaysUseTLS;</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineminus">-  // auth</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineminus">-  if (config.incoming.auth == 2) // &quot;secure&quot; auth</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineminus">-    inServer.useSecAuth = true;</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+    inServer.socketType = Ci.nsMsgSocketType.alwaysSTARTTLS;</span>
<a href="#l15.30"></a><span id="l15.30">   //inServer.prettyName = config.displayName;</span>
<a href="#l15.31"></a><span id="l15.31">   inServer.prettyName = config.identity.emailAddress;</span>
<a href="#l15.32"></a><span id="l15.32"> </span>
<a href="#l15.33"></a><span id="l15.33">   inServer.doBiff = true;</span>
<a href="#l15.34"></a><span id="l15.34">   inServer.biffMinutes = config.incoming.checkInterval;</span>
<a href="#l15.35"></a><span id="l15.35">   let prefs = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l15.36"></a><span id="l15.36">               .getService(Ci.nsIPrefBranch);</span>
<a href="#l15.37"></a><span id="l15.37">   const loginAtStartupPrefTemplate =</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineat">@@ -115,46 +114,43 @@ function createAccountInBackend(config)</span>
<a href="#l15.39"></a><span id="l15.39">                       config.incoming.deleteOnServerWhenLocalDelete);</span>
<a href="#l15.40"></a><span id="l15.40">     prefs.setBoolPref(ageFromServerPref,</span>
<a href="#l15.41"></a><span id="l15.41">                       config.incoming.deleteByAgeFromServer);</span>
<a href="#l15.42"></a><span id="l15.42">     prefs.setBoolPref(downloadOnBiffPref,</span>
<a href="#l15.43"></a><span id="l15.43">                       config.incoming.downloadOnBiff);</span>
<a href="#l15.44"></a><span id="l15.44">   }</span>
<a href="#l15.45"></a><span id="l15.45">   inServer.valid = true;</span>
<a href="#l15.46"></a><span id="l15.46"> </span>
<a href="#l15.47"></a><span id="l15.47" class="difflineminus">-  let username = config.outgoing.auth &gt; 0 ? config.outgoing.username : null;</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+  let username = config.outgoing.auth &gt; 1 ? config.outgoing.username : null;</span>
<a href="#l15.49"></a><span id="l15.49">   let outServer = smtpManager.findServer(username, config.outgoing.hostname);</span>
<a href="#l15.50"></a><span id="l15.50">   assert(config.outgoing.addThisServer ||</span>
<a href="#l15.51"></a><span id="l15.51">          config.outgoing.useGlobalPreferredServer ||</span>
<a href="#l15.52"></a><span id="l15.52">          config.outgoing.existingServerKey,</span>
<a href="#l15.53"></a><span id="l15.53">          &quot;No SMTP server: inconsistent flags&quot;);</span>
<a href="#l15.54"></a><span id="l15.54"> </span>
<a href="#l15.55"></a><span id="l15.55">   if (config.outgoing.addThisServer &amp;&amp; !outServer)</span>
<a href="#l15.56"></a><span id="l15.56">   {</span>
<a href="#l15.57"></a><span id="l15.57">     outServer = smtpManager.createSmtpServer();</span>
<a href="#l15.58"></a><span id="l15.58">     outServer.hostname = config.outgoing.hostname;</span>
<a href="#l15.59"></a><span id="l15.59">     outServer.port = config.outgoing.port;</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineminus">-    if (config.outgoing.auth &gt; 0)</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineplus">+    outServer.authMethod = config.outgoing.auth;</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+    if (config.outgoing.auth &gt; 1)</span>
<a href="#l15.63"></a><span id="l15.63">     {</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineminus">-      outServer.authMethod = 1;</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineminus">-      outServer.useSecAuth = config.outgoing.auth == 2;</span>
<a href="#l15.66"></a><span id="l15.66">       outServer.username = config.incoming.username;</span>
<a href="#l15.67"></a><span id="l15.67">       outServer.password = config.incoming.password;</span>
<a href="#l15.68"></a><span id="l15.68">       if (config.rememberPassword &amp;&amp; config.incoming.password.length)</span>
<a href="#l15.69"></a><span id="l15.69">         rememberPassword(outServer, config.incoming.password);</span>
<a href="#l15.70"></a><span id="l15.70">     }</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineminus">-    else</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineminus">-      outServer.authMethod = 0;</span>
<a href="#l15.73"></a><span id="l15.73"> </span>
<a href="#l15.74"></a><span id="l15.74">     if (config.outgoing.socketType == 1) // no SSL</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineminus">-      outServer.trySSL = 0; // nsSmtpProtocol.h, line 115</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+      outServer.socketType = Ci.nsMsgSocketType.plain;</span>
<a href="#l15.77"></a><span id="l15.77">     else if (config.outgoing.socketType == 2) // SSL / TLS</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineminus">-      outServer.trySSL = 3;</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineplus">+      outServer.socketType = Ci.nsMsgSocketType.SSL;</span>
<a href="#l15.80"></a><span id="l15.80">     else if (config.outgoing.socketType == 3) // STARTTLS</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineminus">-      outServer.trySSL = 2;</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineplus">+      outServer.socketType = Ci.nsMsgSocketType.alwaysSTARTTLS;</span>
<a href="#l15.83"></a><span id="l15.83"> </span>
<a href="#l15.84"></a><span id="l15.84">     // API problem: &lt;http://mxr.mozilla.org/seamonkey/source/mailnews/compose/public/nsISmtpServer.idl#93&gt;</span>
<a href="#l15.85"></a><span id="l15.85">     outServer.description = config.displayName;</span>
<a href="#l15.86"></a><span id="l15.86">     if (config.password)</span>
<a href="#l15.87"></a><span id="l15.87">       outServer.password = config.outgoing.password;</span>
<a href="#l15.88"></a><span id="l15.88"> </span>
<a href="#l15.89"></a><span id="l15.89">     // If this is the first SMTP server, set it as default</span>
<a href="#l15.90"></a><span id="l15.90">     if (!smtpManager.defaultServer ||</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/emailWizard.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/emailWizard.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -776,20 +776,22 @@ EmailConfigWizard.prototype =</span>
<a href="#l16.4"></a><span id="l16.4">       }</span>
<a href="#l16.5"></a><span id="l16.5">     }</span>
<a href="#l16.6"></a><span id="l16.6"> </span>
<a href="#l16.7"></a><span id="l16.7">     document.getElementById('create_button').disabled = true;</span>
<a href="#l16.8"></a><span id="l16.8">     var me = this;</span>
<a href="#l16.9"></a><span id="l16.9">     if (!this._verifiedConfig)</span>
<a href="#l16.10"></a><span id="l16.10">       this.verifyConfig(function(successfulConfig) // success</span>
<a href="#l16.11"></a><span id="l16.11">                         {</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-                          // the incoming auth might have changed, so we</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+                          // the auth might have changed, so we</span>
<a href="#l16.14"></a><span id="l16.14">                           // should back-port it to the current config.</span>
<a href="#l16.15"></a><span id="l16.15">                           me._currentConfigFilledIn.incoming.auth =</span>
<a href="#l16.16"></a><span id="l16.16">                               successfulConfig.incoming.auth;</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+                          me._currentConfigFilledIn.outgoing.auth =</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+                              successfulConfig.outgoing.auth;</span>
<a href="#l16.19"></a><span id="l16.19">                           me.finish();</span>
<a href="#l16.20"></a><span id="l16.20">                         },</span>
<a href="#l16.21"></a><span id="l16.21">                         function(e) // failure</span>
<a href="#l16.22"></a><span id="l16.22">                         {</span>
<a href="#l16.23"></a><span id="l16.23">                           document.getElementById('create_button').disabled = false;</span>
<a href="#l16.24"></a><span id="l16.24">                           me.editConfigDetails();</span>
<a href="#l16.25"></a><span id="l16.25">                         });</span>
<a href="#l16.26"></a><span id="l16.26">     else</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/guessConfig.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/guessConfig.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -141,57 +141,58 @@ function guessConfig(domain, progressCal</span>
<a href="#l17.4"></a><span id="l17.4">     }</span>
<a href="#l17.5"></a><span id="l17.5">     if ((incomingDone || incomingEx) &amp;&amp; (outgoingDone || outgoingEx))</span>
<a href="#l17.6"></a><span id="l17.6">     {</span>
<a href="#l17.7"></a><span id="l17.7">       successCallback(resultConfig);</span>
<a href="#l17.8"></a><span id="l17.8">       return;</span>
<a href="#l17.9"></a><span id="l17.9">     }</span>
<a href="#l17.10"></a><span id="l17.10">   };</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  var outgoingSuccess = function(type, hostname, port, ssl, secureAuth,</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+  var outgoingSuccess = function(type, hostname, port, ssl, authMethods,</span>
<a href="#l17.14"></a><span id="l17.14">                                   badCert, targetSite)</span>
<a href="#l17.15"></a><span id="l17.15">   {</span>
<a href="#l17.16"></a><span id="l17.16">     assert(type == SMTP, &quot;I only know SMTP for outgoing&quot;);</span>
<a href="#l17.17"></a><span id="l17.17">     // Ensure there are no previously saved outgoing errors if we've got success</span>
<a href="#l17.18"></a><span id="l17.18">     // here.</span>
<a href="#l17.19"></a><span id="l17.19">     outgoingEx = null;</span>
<a href="#l17.20"></a><span id="l17.20">     resultConfig.outgoing.hostname = hostname;</span>
<a href="#l17.21"></a><span id="l17.21">     resultConfig.outgoing.port = port;</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">-    // non-auth smtp servers must be rare at this point.</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineminus">-    resultConfig.outgoing.auth = 1;</span>
<a href="#l17.24"></a><span id="l17.24">     resultConfig.outgoing.socketType = sslConvertToSocketType(ssl);</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+    resultConfig.outgoing.auth = chooseBestAuthMethod(authMethods);</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+    resultConfig.outgoing.authAlternatives = authMethods;</span>
<a href="#l17.27"></a><span id="l17.27">     resultConfig.outgoing.badCert = badCert;</span>
<a href="#l17.28"></a><span id="l17.28"> </span>
<a href="#l17.29"></a><span id="l17.29">     progressCallback(protocolToString(type), hostname, port,</span>
<a href="#l17.30"></a><span id="l17.30">                      sslConvertToSocketType(ssl), true, resultConfig);</span>
<a href="#l17.31"></a><span id="l17.31">     outgoingDone = true;</span>
<a href="#l17.32"></a><span id="l17.32">     checkDone();</span>
<a href="#l17.33"></a><span id="l17.33">   };</span>
<a href="#l17.34"></a><span id="l17.34"> </span>
<a href="#l17.35"></a><span id="l17.35">   var outgoingError = function(ex)</span>
<a href="#l17.36"></a><span id="l17.36">   {</span>
<a href="#l17.37"></a><span id="l17.37">     outgoingEx = ex;</span>
<a href="#l17.38"></a><span id="l17.38">     checkDone();</span>
<a href="#l17.39"></a><span id="l17.39">   };</span>
<a href="#l17.40"></a><span id="l17.40"> </span>
<a href="#l17.41"></a><span id="l17.41" class="difflineminus">-  var incomingSuccess = function(type, hostname, port, ssl, secureAuth, badCert,</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+  var incomingSuccess = function(type, hostname, port, ssl, authMethods, badCert,</span>
<a href="#l17.43"></a><span id="l17.43">                                  targetSite)</span>
<a href="#l17.44"></a><span id="l17.44">   {</span>
<a href="#l17.45"></a><span id="l17.45">     ddump(&quot;incomingSuccess outgoingDone = &quot; + outgoingDone + &quot;\n&quot;);</span>
<a href="#l17.46"></a><span id="l17.46">     ddump(&quot;incoming success username = &quot; + resultConfig.incoming.username + &quot;\n&quot;);</span>
<a href="#l17.47"></a><span id="l17.47">     // Ensure there are no previously saved incoming errors if we've got success</span>
<a href="#l17.48"></a><span id="l17.48">     // here.</span>
<a href="#l17.49"></a><span id="l17.49">     incomingEx = null;</span>
<a href="#l17.50"></a><span id="l17.50">     resultConfig.incoming.hostname = hostname;</span>
<a href="#l17.51"></a><span id="l17.51">     resultConfig.incoming.port = port;</span>
<a href="#l17.52"></a><span id="l17.52">     resultConfig.incoming.type = protocolToString(type);</span>
<a href="#l17.53"></a><span id="l17.53">     resultConfig.incoming.socketType =  sslConvertToSocketType(ssl);</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineplus">+    resultConfig.incoming.auth = chooseBestAuthMethod(authMethods);</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineplus">+    resultConfig.incoming.authAlternatives = authMethods;</span>
<a href="#l17.56"></a><span id="l17.56">     resultConfig.incoming.badCert = badCert;</span>
<a href="#l17.57"></a><span id="l17.57">     resultConfig.incoming.targetSite = targetSite;</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineminus">-    resultConfig.incoming.auth = secureAuth ? 2 : 1;</span>
<a href="#l17.59"></a><span id="l17.59"> </span>
<a href="#l17.60"></a><span id="l17.60">     progressCallback(protocolToString(type), hostname, port,</span>
<a href="#l17.61"></a><span id="l17.61">                      sslConvertToSocketType(ssl), true, resultConfig);</span>
<a href="#l17.62"></a><span id="l17.62">     incomingDone = true;</span>
<a href="#l17.63"></a><span id="l17.63">     checkDone();</span>
<a href="#l17.64"></a><span id="l17.64">   };</span>
<a href="#l17.65"></a><span id="l17.65"> </span>
<a href="#l17.66"></a><span id="l17.66">   var incomingError = function(ex)</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineat">@@ -350,16 +351,19 @@ function protocolToString(type)</span>
<a href="#l17.68"></a><span id="l17.68"> </span>
<a href="#l17.69"></a><span id="l17.69"> /**</span>
<a href="#l17.70"></a><span id="l17.70">  * @param successCallback {function(type, hostname, port, ssl)} Called when the</span>
<a href="#l17.71"></a><span id="l17.71">  * config is OK</span>
<a href="#l17.72"></a><span id="l17.72">  *    type @see constants above</span>
<a href="#l17.73"></a><span id="l17.73">  *    hostname {String}</span>
<a href="#l17.74"></a><span id="l17.74">  *    port {Integer}</span>
<a href="#l17.75"></a><span id="l17.75">  *    ssl @see constants above</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineplus">+ *    authMethods {Array of possible auth types}, @see _advertisesAuthMethods()</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineplus">+ *    selfSignedCert {Boolean}</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineplus">+ *    sslTargetSite {String}</span>
<a href="#l17.79"></a><span id="l17.79">  * @param errorCallback {function(ex)} Called when we could not find a config</span>
<a href="#l17.80"></a><span id="l17.80">  * @param progressCallback { function(hostname, port) } Called when we tried</span>
<a href="#l17.81"></a><span id="l17.81">  *    (will try?) a new hostname and port</span>
<a href="#l17.82"></a><span id="l17.82">  */</span>
<a href="#l17.83"></a><span id="l17.83"> function HostDetector(progressCallback, successCallback, errorCallback)</span>
<a href="#l17.84"></a><span id="l17.84"> {</span>
<a href="#l17.85"></a><span id="l17.85">   this._init(progressCallback, successCallback, errorCallback);</span>
<a href="#l17.86"></a><span id="l17.86"> }</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineat">@@ -538,26 +542,26 @@ HostDetector.prototype =</span>
<a href="#l17.88"></a><span id="l17.88">     else</span>
<a href="#l17.89"></a><span id="l17.89">     {</span>
<a href="#l17.90"></a><span id="l17.90">       if (curTry[1] != TLS || this._matchTLS(curTry, wiredata))</span>
<a href="#l17.91"></a><span id="l17.91">       {</span>
<a href="#l17.92"></a><span id="l17.92">         this._log.info(&quot;non-null data: &quot; + wiredata.toString());</span>
<a href="#l17.93"></a><span id="l17.93">         let type = curTry[0];</span>
<a href="#l17.94"></a><span id="l17.94">         let port = curTry[2];</span>
<a href="#l17.95"></a><span id="l17.95">         let ssl = curTry[1];</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineminus">-        let secureAuth = this._advertisesSecureAuth(type, wiredata);</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineplus">+        let authMethods = this._advertisesAuthMethods(type, wiredata); // TODO</span>
<a href="#l17.98"></a><span id="l17.98">         if (this._selfSignedCert)</span>
<a href="#l17.99"></a><span id="l17.99">         {</span>
<a href="#l17.100"></a><span id="l17.100">           // the callback will put up the cert exception dialog, so</span>
<a href="#l17.101"></a><span id="l17.101">           // clear the override here.</span>
<a href="#l17.102"></a><span id="l17.102">           this._log.info(&quot;clearing validity override&quot;);</span>
<a href="#l17.103"></a><span id="l17.103">           gOverrideService.clearValidityOverride(this._host, curTry[2]);</span>
<a href="#l17.104"></a><span id="l17.104">         }</span>
<a href="#l17.105"></a><span id="l17.105">         this._log.info(&quot;SUCCESS, _selfSignedCert = &quot; + this._selfSignedCert);</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineminus">-        this.mSuccessCallback(type, this._host, port, ssl, secureAuth,</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineplus">+        this.mSuccessCallback(type, this._host, port, ssl, authMethods,</span>
<a href="#l17.108"></a><span id="l17.108">                               this._selfSignedCert, this._targetSite);</span>
<a href="#l17.109"></a><span id="l17.109">         return; // stop trying, you're done!</span>
<a href="#l17.110"></a><span id="l17.110">       }</span>
<a href="#l17.111"></a><span id="l17.111">     }</span>
<a href="#l17.112"></a><span id="l17.112"> </span>
<a href="#l17.113"></a><span id="l17.113">     // report success if you found it.</span>
<a href="#l17.114"></a><span id="l17.114">     this.keepTrying()</span>
<a href="#l17.115"></a><span id="l17.115">   },</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineat">@@ -565,42 +569,70 @@ HostDetector.prototype =</span>
<a href="#l17.117"></a><span id="l17.117">   cancel : function()</span>
<a href="#l17.118"></a><span id="l17.118">   {</span>
<a href="#l17.119"></a><span id="l17.119">     this._cancel = true;</span>
<a href="#l17.120"></a><span id="l17.120">     // XXX this is not enough -- we have to actively stop the network calls, as</span>
<a href="#l17.121"></a><span id="l17.121">     // they may result in callbacks e.g. to the cert handler.  If the dialog is</span>
<a href="#l17.122"></a><span id="l17.122">     // gone by the time this happens, the javascript stack is horked.</span>
<a href="#l17.123"></a><span id="l17.123">   },</span>
<a href="#l17.124"></a><span id="l17.124"> </span>
<a href="#l17.125"></a><span id="l17.125" class="difflineminus">-  _advertisesSecureAuth : function(protocol, capaResponse)</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineplus">+  /**</span>
<a href="#l17.127"></a><span id="l17.127" class="difflineplus">+   * Which auth mechanism the server claims to support.</span>
<a href="#l17.128"></a><span id="l17.128" class="difflineplus">+   * (That doesn't necessarily reflect reality, it is more an upper bound.)</span>
<a href="#l17.129"></a><span id="l17.129" class="difflineplus">+   * @returns Array with values for AccountConfig.incoming/outgoing.auth ,</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineplus">+   * in decreasing order of preference.</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineplus">+   * E.g. [ 5, 4 ] for a server that supports only Kerberos and encrypted passwords.</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineplus">+   */</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineplus">+  _advertisesAuthMethods : function(protocol, capaResponse)</span>
<a href="#l17.134"></a><span id="l17.134">   {</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineminus">-    // for imap to support secure auth,</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineminus">-    // capabilities needs to return 1 or more of the following:</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineplus">+    // for imap, capabilities contain one or more of the following for secure auth:</span>
<a href="#l17.138"></a><span id="l17.138">     // &quot;AUTH=CRAM-MD5&quot;, &quot;AUTH=NTLM&quot;, &quot;AUTH=GSSAPI&quot;, &quot;AUTH=MSN&quot;</span>
<a href="#l17.139"></a><span id="l17.139">     // for pop3, the auth mechanisms are returned in capa as the following:</span>
<a href="#l17.140"></a><span id="l17.140">     // &quot;CRAM-MD5&quot;, &quot;NTLM&quot;, &quot;MSN&quot;, &quot;GSSAPI&quot;</span>
<a href="#l17.141"></a><span id="l17.141">     // For smtp, EHLO will return AUTH and then a list of the</span>
<a href="#l17.142"></a><span id="l17.142">     // mechanism(s) supported, e.g.,</span>
<a href="#l17.143"></a><span id="l17.143">     // AUTH LOGIN NTLM MSN CRAM-MD5 GSSAPI</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineplus">+    var result = new Array();</span>
<a href="#l17.145"></a><span id="l17.145">     let line = capaResponse.join(&quot;\n&quot;)</span>
<a href="#l17.146"></a><span id="l17.146" class="difflineplus">+    var prefix = &quot;&quot;;</span>
<a href="#l17.147"></a><span id="l17.147">     if (protocol == POP)</span>
<a href="#l17.148"></a><span id="l17.148" class="difflineminus">-      return /CRAM-MD5|NTLM|MSN|GSSAPI/.test(line);</span>
<a href="#l17.149"></a><span id="l17.149" class="difflineminus">-    if (protocol == IMAP)</span>
<a href="#l17.150"></a><span id="l17.150" class="difflineminus">-      return /AUTH=(CRAM-MD5|NTLM|MSN|GSSAPI)/.test(line);</span>
<a href="#l17.151"></a><span id="l17.151" class="difflineminus">-    if (protocol == SMTP)</span>
<a href="#l17.152"></a><span id="l17.152" class="difflineminus">-      return /AUTH (CRAM-MD5|NTLM|MSN|GSSAPI)/.test(line);</span>
<a href="#l17.153"></a><span id="l17.153" class="difflineplus">+      prefix = &quot;&quot;;</span>
<a href="#l17.154"></a><span id="l17.154" class="difflineplus">+    else if (protocol == IMAP)</span>
<a href="#l17.155"></a><span id="l17.155" class="difflineplus">+      prefix = &quot;AUTH=&quot;;</span>
<a href="#l17.156"></a><span id="l17.156" class="difflineplus">+    else if (protocol == SMTP)</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineplus">+      prefix = &quot;AUTH &quot;;</span>
<a href="#l17.158"></a><span id="l17.158" class="difflineplus">+    if (new RegExp(prefix + &quot;GSSAPI&quot;).test(line))</span>
<a href="#l17.159"></a><span id="l17.159" class="difflineplus">+      result.push(Ci.nsMsgAuthMethod.GSSAPI);</span>
<a href="#l17.160"></a><span id="l17.160" class="difflineplus">+    if (new RegExp(prefix + &quot;(NTLM|MSN)&quot;).test(line))</span>
<a href="#l17.161"></a><span id="l17.161" class="difflineplus">+      result.push(Ci.nsMsgAuthMethod.NTLM);</span>
<a href="#l17.162"></a><span id="l17.162" class="difflineplus">+    if (new RegExp(prefix + &quot;CRAM-MD5&quot;).test(line))</span>
<a href="#l17.163"></a><span id="l17.163" class="difflineplus">+      result.push(Ci.nsMsgAuthMethod.passwordEncrypted);</span>
<a href="#l17.164"></a><span id="l17.164" class="difflineplus">+    if ( ! (protocol == IMAP &amp;&amp; /LOGINDISABLED/.test(line)))</span>
<a href="#l17.165"></a><span id="l17.165" class="difflineplus">+      result.push(Ci.nsMsgAuthMethod.passwordCleartext);</span>
<a href="#l17.166"></a><span id="l17.166" class="difflineplus">+    return result;</span>
<a href="#l17.167"></a><span id="l17.167">   },</span>
<a href="#l17.168"></a><span id="l17.168"> </span>
<a href="#l17.169"></a><span id="l17.169">   _matchTLS : function(curTry, result)</span>
<a href="#l17.170"></a><span id="l17.170">   {</span>
<a href="#l17.171"></a><span id="l17.171">       return curTry != null &amp;&amp; curTry[1] == TLS &amp;&amp;</span>
<a href="#l17.172"></a><span id="l17.172">              hasTLS(result.join(&quot;\n&quot;), curTry[0]);</span>
<a href="#l17.173"></a><span id="l17.173">   }</span>
<a href="#l17.174"></a><span id="l17.174"> }</span>
<a href="#l17.175"></a><span id="l17.175"> </span>
<a href="#l17.176"></a><span id="l17.176" class="difflineplus">+/**</span>
<a href="#l17.177"></a><span id="l17.177" class="difflineplus">+ * @param authMethods @see return value of _advertisesAuthMethods()</span>
<a href="#l17.178"></a><span id="l17.178" class="difflineplus">+ * @return one of them, the preferred one</span>
<a href="#l17.179"></a><span id="l17.179" class="difflineplus">+ * Note: this might be Kerberos, which might not actually work,</span>
<a href="#l17.180"></a><span id="l17.180" class="difflineplus">+ * so you might need to try the others, too.</span>
<a href="#l17.181"></a><span id="l17.181" class="difflineplus">+ */</span>
<a href="#l17.182"></a><span id="l17.182" class="difflineplus">+function chooseBestAuthMethod(authMethods)</span>
<a href="#l17.183"></a><span id="l17.183" class="difflineplus">+{</span>
<a href="#l17.184"></a><span id="l17.184" class="difflineplus">+  return authMethods[0]; // take first (= most preferred)</span>
<a href="#l17.185"></a><span id="l17.185" class="difflineplus">+}</span>
<a href="#l17.186"></a><span id="l17.186" class="difflineplus">+</span>
<a href="#l17.187"></a><span id="l17.187"> function IncomingHostDetector(progressCallback, successCallback, errorCallback)</span>
<a href="#l17.188"></a><span id="l17.188"> {</span>
<a href="#l17.189"></a><span id="l17.189">   this._init(progressCallback, successCallback, errorCallback);</span>
<a href="#l17.190"></a><span id="l17.190"> }</span>
<a href="#l17.191"></a><span id="l17.191"> </span>
<a href="#l17.192"></a><span id="l17.192"> IncomingHostDetector.prototype =</span>
<a href="#l17.193"></a><span id="l17.193"> {</span>
<a href="#l17.194"></a><span id="l17.194">   __proto__ : new HostDetector(),</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/readFromXML.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/readFromXML.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -69,17 +69,24 @@ function readFromXML(clientConfigXML)</span>
<a href="#l18.4"></a><span id="l18.4"> </span>
<a href="#l18.5"></a><span id="l18.5">   // incoming server</span>
<a href="#l18.6"></a><span id="l18.6">   var iX = xml.incomingServer; // input (XML)</span>
<a href="#l18.7"></a><span id="l18.7">   var iO = d.incoming; // output (object)</span>
<a href="#l18.8"></a><span id="l18.8">   iO.type = sanitize.enum(iX.@type, [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]);</span>
<a href="#l18.9"></a><span id="l18.9">   iO.hostname = sanitize.hostname(iX.hostname);</span>
<a href="#l18.10"></a><span id="l18.10">   iO.port = sanitize.integerRange(iX.port, 1, 65535);</span>
<a href="#l18.11"></a><span id="l18.11">   iO.username = sanitize.string(iX.username); // may be a %VARIABLE%</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-  iO.auth = sanitize.translate(iX.authentication, { plain : 1, secure : 2 }); // TODO &quot;secure&quot;</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+  iO.auth = sanitize.translate(iX.authentication,</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+        { &quot;password-clear&quot; : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+          plain : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+          &quot;password-encrypted&quot; : Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+          secure : Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+          GSSAPI : Ci.nsMsgAuthMethod.GSSAPI,</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+          NTLM : Ci.nsMsgAuthMethod.NTLM });</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineplus">+  ddump(&quot;&lt;authentication&gt; = &quot; + iX.authentication + &quot;, incom.authMethod = &quot; + iO.auth);</span>
<a href="#l18.21"></a><span id="l18.21">   iO.socketType = sanitize.translate(iX.socketType, { plain : 1, SSL: 2, STARTTLS: 3 });</span>
<a href="#l18.22"></a><span id="l18.22">   if (iO.type == &quot;pop3&quot; &amp;&amp; &quot;pop3&quot; in iX)</span>
<a href="#l18.23"></a><span id="l18.23">   {</span>
<a href="#l18.24"></a><span id="l18.24">     if (&quot;leaveMessagesOnServer&quot; in iX.pop3)</span>
<a href="#l18.25"></a><span id="l18.25">       iO.leaveMessagesOnServer = sanitize.boolean(iX.pop3.leaveMessagesOnServer);</span>
<a href="#l18.26"></a><span id="l18.26">     if (&quot;daysToLeaveMessagesOnServer&quot; in iX.pop3)</span>
<a href="#l18.27"></a><span id="l18.27">       iO.daysToLeaveMessagesOnServer = sanitize.integer(iX.pop3.daysToLeaveMessagesOnServer);</span>
<a href="#l18.28"></a><span id="l18.28">     if (&quot;downloadOnBiff&quot; in iX.pop3)</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineat">@@ -97,19 +104,26 @@ function readFromXML(clientConfigXML)</span>
<a href="#l18.30"></a><span id="l18.30">   oO.hostname = sanitize.hostname(oX.hostname);</span>
<a href="#l18.31"></a><span id="l18.31">   oO.port = sanitize.integerRange(oX.port, 1, 65535);</span>
<a href="#l18.32"></a><span id="l18.32">   if (&quot;username&quot; in oX)</span>
<a href="#l18.33"></a><span id="l18.33">     oO.username = sanitize.string(oX.username);</span>
<a href="#l18.34"></a><span id="l18.34"> </span>
<a href="#l18.35"></a><span id="l18.35">   oO.socketType = sanitize.translate(oX.socketType,</span>
<a href="#l18.36"></a><span id="l18.36">                                      { plain : 1, SSL: 2, STARTTLS: 3 });</span>
<a href="#l18.37"></a><span id="l18.37">   oO.auth = sanitize.translate(oX.authentication,</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineminus">-                               { none : 0 /* e.g. IP-address-based */,</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineminus">-                                 plain : 1, secure : 2,  // TODO &quot;secure&quot;</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineminus">-                                 &quot;smtp-after-pop&quot; : 0 /* hope for the best */});</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+        { none : Ci.nsMsgAuthMethod.none, // open relay</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+          &quot;client-IP-address&quot; : Ci.nsMsgAuthMethod.none, // inside ISP or corp network</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+          &quot;smtp-after-pop&quot; : Ci.nsMsgAuthMethod.none, // hope for the best</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+          &quot;password-clear&quot; : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineplus">+          plain : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+          &quot;password-encrypted&quot; : Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+          secure : Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineplus">+          GSSAPI : Ci.nsMsgAuthMethod.GSSAPI,</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineplus">+          NTLM : Ci.nsMsgAuthMethod.NTLM });</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+  ddump(&quot;&lt;authentication&gt; = &quot; + iX.authentication + &quot;, outgoing.authMethod = &quot; + oO.auth);</span>
<a href="#l18.51"></a><span id="l18.51">   if (&quot;addThisServer&quot; in oX)</span>
<a href="#l18.52"></a><span id="l18.52">     oO.addThisServer = sanitize.boolean(oX.addThisServer);</span>
<a href="#l18.53"></a><span id="l18.53">   if (&quot;useGlobalPreferredServer&quot; in oX)</span>
<a href="#l18.54"></a><span id="l18.54">     oO.useGlobalPreferredServer = sanitize.boolean(oX.useGlobalPreferredServer);</span>
<a href="#l18.55"></a><span id="l18.55"> </span>
<a href="#l18.56"></a><span id="l18.56">   for each (var inputField in xml.inputField)</span>
<a href="#l18.57"></a><span id="l18.57">   {</span>
<a href="#l18.58"></a><span id="l18.58">     if (!d.inputFields)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/verifyConfig.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/verifyConfig.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -80,25 +80,22 @@ function verifyConfig(config, alter, msg</span>
<a href="#l19.4"></a><span id="l19.4">   var inServer =</span>
<a href="#l19.5"></a><span id="l19.5">     accountManager.createIncomingServer(config.incoming.username,</span>
<a href="#l19.6"></a><span id="l19.6">                                         config.incoming.hostname,</span>
<a href="#l19.7"></a><span id="l19.7">                                         sanitize.enum(config.incoming.type,</span>
<a href="#l19.8"></a><span id="l19.8">                                                       [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]));</span>
<a href="#l19.9"></a><span id="l19.9">   inServer.port = config.incoming.port;</span>
<a href="#l19.10"></a><span id="l19.10">   inServer.password = config.incoming.password;</span>
<a href="#l19.11"></a><span id="l19.11">   if (config.incoming.socketType == 1) // plain</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-    inServer.socketType = Ci.nsIMsgIncomingServer.defaultSocket;</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+    inServer.socketType = Ci.nsMsgSocketType.plain;</span>
<a href="#l19.14"></a><span id="l19.14">   else if (config.incoming.socketType == 2) // SSL</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">-    inServer.socketType = Ci.nsIMsgIncomingServer.useSSL;</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineminus">-  else if (config.incoming.socketType == 3) // TLS</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineminus">-    inServer.socketType = Ci.nsIMsgIncomingServer.alwaysUseTLS;</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineminus">-</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineminus">-  // auth</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineminus">-  if (config.incoming.auth == 2) // &quot;secure&quot; auth</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineminus">-    inServer.useSecAuth = true;</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineplus">+    inServer.socketType = Ci.nsMsgSocketType.SSL;</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineplus">+  else if (config.incoming.socketType == 3) // STARTTLS</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineplus">+    inServer.socketType = Ci.nsMsgSocketType.alwaysSTARTTLS;</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineplus">+  inServer.authMethod = config.incoming.auth;</span>
<a href="#l19.26"></a><span id="l19.26"> </span>
<a href="#l19.27"></a><span id="l19.27">   try {</span>
<a href="#l19.28"></a><span id="l19.28">     if (inServer.password)</span>
<a href="#l19.29"></a><span id="l19.29">       verifyLogon(config, inServer, alter, msgWindow,</span>
<a href="#l19.30"></a><span id="l19.30">                   successCallback, errorCallback);</span>
<a href="#l19.31"></a><span id="l19.31">     else {</span>
<a href="#l19.32"></a><span id="l19.32">       // Avoid pref pollution, clear out server prefs.</span>
<a href="#l19.33"></a><span id="l19.33">       accountManager.removeIncomingServer(inServer, true);</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineat">@@ -155,20 +152,20 @@ function urlListener(config, server, alt</span>
<a href="#l19.35"></a><span id="l19.35">   this._log = Log4Moz.getConfiguredLogger(&quot;mail.wizard&quot;);</span>
<a href="#l19.36"></a><span id="l19.36"> }</span>
<a href="#l19.37"></a><span id="l19.37"> urlListener.prototype =</span>
<a href="#l19.38"></a><span id="l19.38"> {</span>
<a href="#l19.39"></a><span id="l19.39">   OnStartRunningUrl: function(aUrl)</span>
<a href="#l19.40"></a><span id="l19.40">   {</span>
<a href="#l19.41"></a><span id="l19.41">     this._log.info(&quot;Starting to test username&quot;);</span>
<a href="#l19.42"></a><span id="l19.42">     this._log.info(&quot;  username=&quot; + (this.mConfig.incoming.username !=</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineminus">-                                    this.mConfig.identity.emailAddress));</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineminus">-    this._log.info(&quot;  secAuth=&quot; + this.mServer.useSecAuth);</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineminus">-    this._log.info(&quot;  savedUsername=&quot; +</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineminus">-                   (this.mConfig.usernameSaved ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineplus">+                          this.mConfig.identity.emailAddress) +</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineplus">+                          &quot;, have savedUsername=&quot; +</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineplus">+                          (this.mConfig.usernameSaved ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineplus">+    this._log.info(&quot;  authMethod=&quot; + this.mServer.authMethod);</span>
<a href="#l19.51"></a><span id="l19.51">   },</span>
<a href="#l19.52"></a><span id="l19.52"> </span>
<a href="#l19.53"></a><span id="l19.53">   OnStopRunningUrl: function(aUrl, aExitCode)</span>
<a href="#l19.54"></a><span id="l19.54">   {</span>
<a href="#l19.55"></a><span id="l19.55">     if (Components.isSuccessCode(aExitCode))</span>
<a href="#l19.56"></a><span id="l19.56">     {</span>
<a href="#l19.57"></a><span id="l19.57">       this._cleanup();</span>
<a href="#l19.58"></a><span id="l19.58">       this.mSuccessCallback(this.mConfig);</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineat">@@ -180,29 +177,28 @@ urlListener.prototype =</span>
<a href="#l19.60"></a><span id="l19.60">       var stringBundle = getStringBundle(&quot;chrome://messenger/locale/accountCreationModel.properties&quot;);</span>
<a href="#l19.61"></a><span id="l19.61">       var errorMsg = stringBundle.GetStringFromName(&quot;cannot_login.error&quot;);</span>
<a href="#l19.62"></a><span id="l19.62">       this.mErrorCallback(new Exception(errorMsg));</span>
<a href="#l19.63"></a><span id="l19.63">     }</span>
<a href="#l19.64"></a><span id="l19.64">     // Try other variations, unless there's a cert error, in which</span>
<a href="#l19.65"></a><span id="l19.65">     // case we'll see what the user chooses.</span>
<a href="#l19.66"></a><span id="l19.66">     else if (!this.mCertError)</span>
<a href="#l19.67"></a><span id="l19.67">     {</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineminus">-      ddump(&quot;trying next logon\n&quot;);</span>
<a href="#l19.69"></a><span id="l19.69">       this.tryNextLogon()</span>
<a href="#l19.70"></a><span id="l19.70">     }</span>
<a href="#l19.71"></a><span id="l19.71">   },</span>
<a href="#l19.72"></a><span id="l19.72"> </span>
<a href="#l19.73"></a><span id="l19.73">   tryNextLogon: function()</span>
<a href="#l19.74"></a><span id="l19.74">   {</span>
<a href="#l19.75"></a><span id="l19.75">     this._log.info(&quot;tryNextLogon()&quot;);</span>
<a href="#l19.76"></a><span id="l19.76">     this._log.info(&quot;  username=&quot; + (this.mConfig.incoming.username !=</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineminus">-                                    this.mConfig.identity.emailAddress));</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineminus">-    this._log.info(&quot;  secAuth=&quot; + this.mServer.useSecAuth);</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineminus">-    this._log.info(&quot;  savedUsername=&quot; +</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineminus">-                   (this.mConfig.usernameSaved ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineplus">+                          this.mConfig.identity.emailAddress) +</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineplus">+                          &quot;, have savedUsername=&quot; +</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineplus">+                          (this.mConfig.usernameSaved ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l19.84"></a><span id="l19.84" class="difflineplus">+    this._log.info(&quot;  authMethod=&quot; + this.mServer.authMethod);</span>
<a href="#l19.85"></a><span id="l19.85">     // check if we tried full email address as username</span>
<a href="#l19.86"></a><span id="l19.86">     if (this.mConfig.incoming.username != this.mConfig.identity.emailAddress)</span>
<a href="#l19.87"></a><span id="l19.87">     {</span>
<a href="#l19.88"></a><span id="l19.88">       this._log.info(&quot;  Changing username to email address.&quot;);</span>
<a href="#l19.89"></a><span id="l19.89">       this.mConfig.usernameSaved = this.mConfig.incoming.username;</span>
<a href="#l19.90"></a><span id="l19.90">       this.mConfig.incoming.username = this.mConfig.identity.emailAddress;</span>
<a href="#l19.91"></a><span id="l19.91">       this.mServer.username = this.mConfig.incoming.username;</span>
<a href="#l19.92"></a><span id="l19.92">       this.mServer.password = this.mConfig.incoming.password;</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineat">@@ -219,34 +215,47 @@ urlListener.prototype =</span>
<a href="#l19.94"></a><span id="l19.94">       this.mConfig.incoming.username = this.mConfig.usernameSaved;</span>
<a href="#l19.95"></a><span id="l19.95">       this.mConfig.usernameSaved = null;</span>
<a href="#l19.96"></a><span id="l19.96">     }</span>
<a href="#l19.97"></a><span id="l19.97"> </span>
<a href="#l19.98"></a><span id="l19.98">     // sec auth seems to have failed, and we've tried both</span>
<a href="#l19.99"></a><span id="l19.99">     // varieties of user name, sadly.</span>
<a href="#l19.100"></a><span id="l19.100">     // So fall back to non-secure auth, and</span>
<a href="#l19.101"></a><span id="l19.101">     // again try the user name and email address as username</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineminus">-    if (this.mServer.useSecAuth &amp;&amp;</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineminus">-        (this.mServer.socketType == Ci.nsIMsgIncomingServer.useSSL ||</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineminus">-         this.mServer.socketType == Ci.nsIMsgIncomingServer.alwaysUseTLS))</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineplus">+    assert(this.mConfig.incoming.auth == this.mServer.authMethod);</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineplus">+    assert(!this.mConfig.incoming.authAlternatives ||</span>
<a href="#l19.107"></a><span id="l19.107" class="difflineplus">+           this.mConfig.incoming.auth == this.mConfig.incoming.authAlternatives[0]);</span>
<a href="#l19.108"></a><span id="l19.108" class="difflineplus">+    this._log.info(&quot;  Using SSL: &quot; +</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineplus">+        (this.mServer.socketType == Ci.nsMsgSocketType.SSL ||</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineplus">+         this.mServer.socketType == Ci.nsMsgSocketType.alwaysSTARTTLS));</span>
<a href="#l19.111"></a><span id="l19.111" class="difflineplus">+    this._log.info(&quot;  auth alternatives count = &quot; + (this.mConfig.incoming.authAlternatives ?</span>
<a href="#l19.112"></a><span id="l19.112" class="difflineplus">+         this.mConfig.incoming.authAlternatives.length : &quot;none&quot;));</span>
<a href="#l19.113"></a><span id="l19.113" class="difflineplus">+    if (this.mConfig.incoming.authAlternatives &amp;&amp;</span>
<a href="#l19.114"></a><span id="l19.114" class="difflineplus">+        this.mConfig.incoming.authAlternatives.length &gt; 1)/* &amp;&amp;</span>
<a href="#l19.115"></a><span id="l19.115" class="difflineplus">+        (this.mConfig.incoming.authAlternatives[1] &gt;</span>
<a href="#l19.116"></a><span id="l19.116" class="difflineplus">+            Ci.nsMsgAuthMethod.passwordCleartext || // next best auth is secure</span>
<a href="#l19.117"></a><span id="l19.117" class="difflineplus">+         this.mServer.socketType == Ci.nsMsgSocketType.SSL ||</span>
<a href="#l19.118"></a><span id="l19.118" class="difflineplus">+         this.mServer.socketType == Ci.nsMsgSocketType.alwaysSTARTTLS))*/</span>
<a href="#l19.119"></a><span id="l19.119">     {</span>
<a href="#l19.120"></a><span id="l19.120" class="difflineminus">-      this._log.info(&quot;  Changing useSecAuth to false.&quot;);</span>
<a href="#l19.121"></a><span id="l19.121" class="difflineminus">-      this._log.info(&quot;  password=&quot; +</span>
<a href="#l19.122"></a><span id="l19.122" class="difflineplus">+      this._log.info(&quot;  Decreasing auth.&quot;);</span>
<a href="#l19.123"></a><span id="l19.123" class="difflineplus">+      this._log.info(&quot;  Have password: &quot; +</span>
<a href="#l19.124"></a><span id="l19.124">                      (this.mServer.password ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l19.125"></a><span id="l19.125" class="difflineminus">-      this.mConfig.incoming.auth = 1; // &quot;insecure&quot; auth</span>
<a href="#l19.126"></a><span id="l19.126" class="difflineminus">-      this.mServer.useSecAuth = false;</span>
<a href="#l19.127"></a><span id="l19.127" class="difflineplus">+      this.mConfig.incoming.authAlternatives.shift(); // it failed, so remove it from list of possibilities</span>
<a href="#l19.128"></a><span id="l19.128" class="difflineplus">+      this.mConfig.incoming.auth = this.mConfig.incoming.authAlternatives[0]; // take the next best method</span>
<a href="#l19.129"></a><span id="l19.129" class="difflineplus">+      this.mConfig.outgoing.auth = this.mConfig.incoming.auth; // TODO good idea???</span>
<a href="#l19.130"></a><span id="l19.130" class="difflineplus">+      this.mServer.authMethod = this.mConfig.incoming.auth;</span>
<a href="#l19.131"></a><span id="l19.131">       this.mServer.username = this.mConfig.incoming.username;</span>
<a href="#l19.132"></a><span id="l19.132">       this.mServer.password = this.mConfig.incoming.password;</span>
<a href="#l19.133"></a><span id="l19.133">       verifyLogon(this.mConfig, this.mServer, this.mAlter, this.mMsgWindow,</span>
<a href="#l19.134"></a><span id="l19.134">                   this.mSuccessCallback, this.mErrorCallback);</span>
<a href="#l19.135"></a><span id="l19.135">       return;</span>
<a href="#l19.136"></a><span id="l19.136">     }</span>
<a href="#l19.137"></a><span id="l19.137"> </span>
<a href="#l19.138"></a><span id="l19.138">     // Tried all variations we can. Give up.</span>
<a href="#l19.139"></a><span id="l19.139" class="difflineminus">-    this._log.info(&quot;  Giving up.&quot;);</span>
<a href="#l19.140"></a><span id="l19.140" class="difflineplus">+    this._log.info(&quot;Giving up.&quot;);</span>
<a href="#l19.141"></a><span id="l19.141">     this._cleanup();</span>
<a href="#l19.142"></a><span id="l19.142">     let stringBundle = getStringBundle(&quot;chrome://messenger/locale/accountCreationModel.properties&quot;);</span>
<a href="#l19.143"></a><span id="l19.143">     let errorMsg = stringBundle.GetStringFromName(&quot;cannot_login.error&quot;);</span>
<a href="#l19.144"></a><span id="l19.144">     this.mErrorCallback(new Exception(errorMsg));</span>
<a href="#l19.145"></a><span id="l19.145">     return;</span>
<a href="#l19.146"></a><span id="l19.146">   },</span>
<a href="#l19.147"></a><span id="l19.147"> </span>
<a href="#l19.148"></a><span id="l19.148">   _cleanup : function()</span>
<a href="#l19.149"></a><span id="l19.149" class="difflineat">@@ -260,29 +269,29 @@ urlListener.prototype =</span>
<a href="#l19.150"></a><span id="l19.150">   },</span>
<a href="#l19.151"></a><span id="l19.151"> </span>
<a href="#l19.152"></a><span id="l19.152">   // Suppress any certificate errors</span>
<a href="#l19.153"></a><span id="l19.153">   notifyCertProblem: function(socketInfo, status, targetSite) {</span>
<a href="#l19.154"></a><span id="l19.154">     if (!status)</span>
<a href="#l19.155"></a><span id="l19.155">       return true;</span>
<a href="#l19.156"></a><span id="l19.156"> </span>
<a href="#l19.157"></a><span id="l19.157">     this.mCertError = true;</span>
<a href="#l19.158"></a><span id="l19.158" class="difflineminus">-    ddump(&quot;got cert error\n&quot;);</span>
<a href="#l19.159"></a><span id="l19.159" class="difflineplus">+    this._log.error(&quot;cert error&quot;);</span>
<a href="#l19.160"></a><span id="l19.160">     setTimeout(this.informUserOfCertError, 0, socketInfo, targetSite, this);</span>
<a href="#l19.161"></a><span id="l19.161">     return true;</span>
<a href="#l19.162"></a><span id="l19.162">   },</span>
<a href="#l19.163"></a><span id="l19.163"> </span>
<a href="#l19.164"></a><span id="l19.164">   informUserOfCertError : function(socketInfo, targetSite, self) {</span>
<a href="#l19.165"></a><span id="l19.165">     let params = { exceptionAdded : false };</span>
<a href="#l19.166"></a><span id="l19.166">     params.prefetchCert = true;</span>
<a href="#l19.167"></a><span id="l19.167">     params.location = targetSite;</span>
<a href="#l19.168"></a><span id="l19.168">     window.openDialog(&quot;chrome://pippki/content/exceptionDialog.xul&quot;,</span>
<a href="#l19.169"></a><span id="l19.169">                       &quot;&quot;,&quot;chrome,centerscreen,modal&quot;, params);</span>
<a href="#l19.170"></a><span id="l19.170" class="difflineminus">-    ddump(&quot;after exception dialog\n&quot;);</span>
<a href="#l19.171"></a><span id="l19.171" class="difflineminus">-    ddump(&quot;exceptionAdded = &quot; + params.exceptionAdded + &quot;\n&quot;);</span>
<a href="#l19.172"></a><span id="l19.172" class="difflineplus">+    self._log.info(&quot;cert exception dialog closed&quot;);</span>
<a href="#l19.173"></a><span id="l19.173" class="difflineplus">+    self._log.info(&quot;cert exceptionAdded = &quot; + params.exceptionAdded);</span>
<a href="#l19.174"></a><span id="l19.174">     if (!params.exceptionAdded) {</span>
<a href="#l19.175"></a><span id="l19.175">       self._cleanup();</span>
<a href="#l19.176"></a><span id="l19.176">       let stringBundle = getStringBundle(&quot;chrome://messenger/locale/accountCreationModel.properties&quot;);</span>
<a href="#l19.177"></a><span id="l19.177">       let errorMsg = stringBundle.GetStringFromName(&quot;cannot_login.error&quot;);</span>
<a href="#l19.178"></a><span id="l19.178">       self.mErrorCallback(new Exception(errorMsg));</span>
<a href="#l19.179"></a><span id="l19.179">     }</span>
<a href="#l19.180"></a><span id="l19.180">     else {</span>
<a href="#l19.181"></a><span id="l19.181">       // Retry the logon now that we've added the cert exception.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-server.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-server.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -39,34 +39,33 @@</span>
<a href="#l20.4"></a><span id="l20.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l20.5"></a><span id="l20.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l20.6"></a><span id="l20.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l20.7"></a><span id="l20.7">  *</span>
<a href="#l20.8"></a><span id="l20.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l20.9"></a><span id="l20.9"> </span>
<a href="#l20.10"></a><span id="l20.10"> var gServer;</span>
<a href="#l20.11"></a><span id="l20.11"> var gObserver;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l20.13"></a><span id="l20.13"> </span>
<a href="#l20.14"></a><span id="l20.14"> function onInit(aPageId, aServerId) </span>
<a href="#l20.15"></a><span id="l20.15"> {</span>
<a href="#l20.16"></a><span id="l20.16">   initServerType();</span>
<a href="#l20.17"></a><span id="l20.17"> </span>
<a href="#l20.18"></a><span id="l20.18">   onCheckItem(&quot;server.biffMinutes&quot;, &quot;server.doBiff&quot;);</span>
<a href="#l20.19"></a><span id="l20.19">   onCheckItem(&quot;nntp.maxArticles&quot;, &quot;nntp.notifyOn&quot;);</span>
<a href="#l20.20"></a><span id="l20.20">   setupMailOnServerUI();</span>
<a href="#l20.21"></a><span id="l20.21">   setupFixedUI();</span>
<a href="#l20.22"></a><span id="l20.22">   if (document.getElementById(&quot;server.type&quot;).getAttribute(&quot;value&quot;) == &quot;imap&quot;)</span>
<a href="#l20.23"></a><span id="l20.23">     setupImapDeleteUI(aServerId);</span>
<a href="#l20.24"></a><span id="l20.24"> </span>
<a href="#l20.25"></a><span id="l20.25">   // &quot;STARTTLS, if available&quot; is vulnerable to MITM attacks so we shouldn't</span>
<a href="#l20.26"></a><span id="l20.26">   // allow users to choose it anymore. Hide the option unless the user already</span>
<a href="#l20.27"></a><span id="l20.27">   // has it set.</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineminus">-  var hidden = (document.getElementById(&quot;server.socketType&quot;).value !=</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineminus">-                Components.interfaces.nsIMsgIncomingServer.tryTLS);</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-  document.getElementById(&quot;connectionSecurityType-1&quot;).hidden = hidden;</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+  hideUnlessSelected(document.getElementById(&quot;connectionSecurityType-1&quot;));</span>
<a href="#l20.32"></a><span id="l20.32"> }</span>
<a href="#l20.33"></a><span id="l20.33"> </span>
<a href="#l20.34"></a><span id="l20.34"> function onPreInit(account, accountValues)</span>
<a href="#l20.35"></a><span id="l20.35"> {</span>
<a href="#l20.36"></a><span id="l20.36">   var type = parent.getAccountValue(account, accountValues, &quot;server&quot;, &quot;type&quot;, null, false);</span>
<a href="#l20.37"></a><span id="l20.37">   hideShowControls(type);</span>
<a href="#l20.38"></a><span id="l20.38"> </span>
<a href="#l20.39"></a><span id="l20.39">   gObserver= Components.classes[&quot;@mozilla.org/observer-service;1&quot;].</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineat">@@ -86,22 +85,44 @@ function initServerType()</span>
<a href="#l20.41"></a><span id="l20.41"> {</span>
<a href="#l20.42"></a><span id="l20.42">   var serverType = document.getElementById(&quot;server.type&quot;).getAttribute(&quot;value&quot;);</span>
<a href="#l20.43"></a><span id="l20.43">   var propertyName = &quot;serverType-&quot; + serverType;</span>
<a href="#l20.44"></a><span id="l20.44"> </span>
<a href="#l20.45"></a><span id="l20.45">   var messengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l20.46"></a><span id="l20.46">   var verboseName = messengerBundle.getString(propertyName);</span>
<a href="#l20.47"></a><span id="l20.47">   setDivText(&quot;servertype.verbose&quot;, verboseName);</span>
<a href="#l20.48"></a><span id="l20.48"> </span>
<a href="#l20.49"></a><span id="l20.49" class="difflineminus">-  var isSecureSelected = (document.getElementById(&quot;server.socketType&quot;).value ==</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineminus">-                          Components.interfaces.nsIMsgIncomingServer.useSSL);</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineplus">+  secureSelect();</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineplus">+</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineplus">+  setLabelFromStringBundle(&quot;authMethod-no&quot;, &quot;authNo&quot;);</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineplus">+  setLabelFromStringBundle(&quot;authMethod-old&quot;, &quot;authOld&quot;);</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineplus">+  setLabelFromStringBundle(&quot;authMethod-kerberos&quot;, &quot;authKerberos&quot;);</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineplus">+  setLabelFromStringBundle(&quot;authMethod-ntlm&quot;, &quot;authNTLM&quot;);</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+  setLabelFromStringBundle(&quot;authMethod-anysecure&quot;, &quot;authAnySecure&quot;);</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineplus">+  setLabelFromStringBundle(&quot;authMethod-any&quot;, &quot;authAny&quot;);</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineplus">+  setLabelFromStringBundle(&quot;authMethod-password-encrypted&quot;,</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineplus">+      &quot;authPasswordEncrypted&quot;);</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineplus">+  //authMethod-password-cleartext already set in selectSelect()</span>
<a href="#l20.62"></a><span id="l20.62"> </span>
<a href="#l20.63"></a><span id="l20.63" class="difflineminus">-  var protocolInfo = Components.classes[&quot;@mozilla.org/messenger/protocol/info;1?type=&quot; + serverType]</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineminus">-                               .getService(Components.interfaces.nsIMsgProtocolInfo);</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineminus">-  document.getElementById(&quot;defaultPort&quot;).value = protocolInfo.getDefaultServerPort(isSecureSelected);</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineplus">+  // Hide deprecated/hidden auth options, unless selected</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineplus">+  hideUnlessSelected(document.getElementById(&quot;authMethod-no&quot;));</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineplus">+  hideUnlessSelected(document.getElementById(&quot;authMethod-old&quot;));</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineplus">+  hideUnlessSelected(document.getElementById(&quot;authMethod-anysecure&quot;));</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineplus">+  hideUnlessSelected(document.getElementById(&quot;authMethod-any&quot;));</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineplus">+}</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineplus">+</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineplus">+function hideUnlessSelected(element)</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineplus">+{</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineplus">+  element.hidden = !element.selected;</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineplus">+}</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineplus">+</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineplus">+function setLabelFromStringBundle(elementID, stringName)</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineplus">+{</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+  document.getElementById(elementID).label =</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineplus">+      document.getElementById(&quot;bundle_messenger&quot;).getString(stringName);</span>
<a href="#l20.82"></a><span id="l20.82"> }</span>
<a href="#l20.83"></a><span id="l20.83"> </span>
<a href="#l20.84"></a><span id="l20.84"> function setDivText(divname, value) </span>
<a href="#l20.85"></a><span id="l20.85"> {</span>
<a href="#l20.86"></a><span id="l20.86">   var div = document.getElementById(divname);</span>
<a href="#l20.87"></a><span id="l20.87">   if (!div) </span>
<a href="#l20.88"></a><span id="l20.88">     return;</span>
<a href="#l20.89"></a><span id="l20.89">   div.setAttribute(&quot;value&quot;, value);</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineat">@@ -159,38 +180,42 @@ function onAdvanced()</span>
<a href="#l20.91"></a><span id="l20.91">     var pop3Server = gServer.QueryInterface(Components.interfaces.nsIPop3IncomingServer);</span>
<a href="#l20.92"></a><span id="l20.92">     // we're explicitly setting this so we'll go through the SetDeferredToAccount method</span>
<a href="#l20.93"></a><span id="l20.93">     pop3Server.deferredToAccount = serverSettings.deferredToAccount;</span>
<a href="#l20.94"></a><span id="l20.94">   }</span>
<a href="#l20.95"></a><span id="l20.95"> }</span>
<a href="#l20.96"></a><span id="l20.96"> </span>
<a href="#l20.97"></a><span id="l20.97"> function secureSelect()</span>
<a href="#l20.98"></a><span id="l20.98"> {</span>
<a href="#l20.99"></a><span id="l20.99" class="difflineminus">-    var serverType   = document.getElementById(&quot;server.type&quot;).getAttribute(&quot;value&quot;);</span>
<a href="#l20.100"></a><span id="l20.100" class="difflineplus">+    var socketType = document.getElementById(&quot;server.socketType&quot;).value;</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineplus">+    var serverType = document.getElementById(&quot;server.type&quot;).value;</span>
<a href="#l20.102"></a><span id="l20.102">     var protocolInfo = Components.classes[&quot;@mozilla.org/messenger/protocol/info;1?type=&quot; + serverType]</span>
<a href="#l20.103"></a><span id="l20.103">                                  .getService(Components.interfaces.nsIMsgProtocolInfo);</span>
<a href="#l20.104"></a><span id="l20.104"> </span>
<a href="#l20.105"></a><span id="l20.105" class="difflineminus">-    var isSecureSelected = (document.getElementById(&quot;server.socketType&quot;).value ==</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineminus">-                            Components.interfaces.nsIMsgIncomingServer.useSSL);</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineminus">-</span>
<a href="#l20.108"></a><span id="l20.108">     var defaultPort = protocolInfo.getDefaultServerPort(false);</span>
<a href="#l20.109"></a><span id="l20.109">     var defaultPortSecure = protocolInfo.getDefaultServerPort(true);</span>
<a href="#l20.110"></a><span id="l20.110">     var port = document.getElementById(&quot;server.port&quot;);</span>
<a href="#l20.111"></a><span id="l20.111">     var portDefault = document.getElementById(&quot;defaultPort&quot;);</span>
<a href="#l20.112"></a><span id="l20.112">     var prevDefaultPort = portDefault.value;</span>
<a href="#l20.113"></a><span id="l20.113"> </span>
<a href="#l20.114"></a><span id="l20.114" class="difflineminus">-    if (isSecureSelected) {</span>
<a href="#l20.115"></a><span id="l20.115" class="difflineplus">+    if (socketType == Ci.nsMsgSocketType.SSL) {</span>
<a href="#l20.116"></a><span id="l20.116">       portDefault.value = defaultPortSecure;</span>
<a href="#l20.117"></a><span id="l20.117">       if (port.value == &quot;&quot; || (port.value == defaultPort &amp;&amp; prevDefaultPort != portDefault.value))</span>
<a href="#l20.118"></a><span id="l20.118">         port.value = defaultPortSecure;</span>
<a href="#l20.119"></a><span id="l20.119">     } else {</span>
<a href="#l20.120"></a><span id="l20.120">         portDefault.value = defaultPort;</span>
<a href="#l20.121"></a><span id="l20.121">         if (port.value == &quot;&quot; || (port.value == defaultPortSecure &amp;&amp; prevDefaultPort != portDefault.value))</span>
<a href="#l20.122"></a><span id="l20.122">           port.value = defaultPort;</span>
<a href="#l20.123"></a><span id="l20.123">     }</span>
<a href="#l20.124"></a><span id="l20.124" class="difflineplus">+</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineplus">+    // switch &quot;insecure password&quot; label</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineplus">+    setLabelFromStringBundle(&quot;authMethod-password-cleartext&quot;,</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineplus">+        socketType == Ci.nsMsgSocketType.SSL ||</span>
<a href="#l20.128"></a><span id="l20.128" class="difflineplus">+        socketType == Ci.nsMsgSocketType.alwaysSTARTTLS ?</span>
<a href="#l20.129"></a><span id="l20.129" class="difflineplus">+        &quot;authPasswordCleartextViaSSL&quot; : &quot;authPasswordCleartextInsecurely&quot;);</span>
<a href="#l20.130"></a><span id="l20.130"> }</span>
<a href="#l20.131"></a><span id="l20.131"> </span>
<a href="#l20.132"></a><span id="l20.132"> function onCheckItem(changeElementId, checkElementId)</span>
<a href="#l20.133"></a><span id="l20.133"> {</span>
<a href="#l20.134"></a><span id="l20.134">     var element = document.getElementById(changeElementId);</span>
<a href="#l20.135"></a><span id="l20.135">     var notify = document.getElementById(checkElementId);</span>
<a href="#l20.136"></a><span id="l20.136">     var checked = notify.checked;</span>
<a href="#l20.137"></a><span id="l20.137"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-server.xul</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-server.xul</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -111,39 +111,63 @@</span>
<a href="#l21.4"></a><span id="l21.4">       &lt;/row&gt;</span>
<a href="#l21.5"></a><span id="l21.5">     &lt;/rows&gt;</span>
<a href="#l21.6"></a><span id="l21.6">   &lt;/grid&gt;</span>
<a href="#l21.7"></a><span id="l21.7"> </span>
<a href="#l21.8"></a><span id="l21.8">   &lt;separator class=&quot;thin&quot;/&gt;</span>
<a href="#l21.9"></a><span id="l21.9"> </span>
<a href="#l21.10"></a><span id="l21.10">   &lt;groupbox hidefor=&quot;movemail&quot;&gt;</span>
<a href="#l21.11"></a><span id="l21.11">     &lt;caption label=&quot;&amp;securitySettings.label;&quot;/&gt;</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-    &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-      &lt;label value=&quot;&amp;connectionSecurity.label;&quot;</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-             accesskey=&quot;&amp;connectionSecurity.accesskey;&quot;</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-             control=&quot;server.socketType&quot;/&gt;</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-      &lt;menulist wsm_persist=&quot;true&quot; id=&quot;server.socketType&quot;</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineminus">-                oncommand=&quot;secureSelect();&quot;&gt;</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineminus">-        &lt;menupopup id=&quot;server.socketTypePopup&quot;&gt;</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineminus">-          &lt;menuitem value=&quot;0&quot; label=&quot;&amp;connectionSecurityType-0.label;&quot;/&gt;</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineminus">-          &lt;menuitem id=&quot;connectionSecurityType-1&quot;</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineminus">-                    value=&quot;1&quot; label=&quot;&amp;connectionSecurityType-1.label;&quot;</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineminus">-                    disabled=&quot;true&quot;/&gt;</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineminus">-          &lt;menuitem value=&quot;2&quot; label=&quot;&amp;connectionSecurityType-2.label;&quot;</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineminus">-                    hidefor=&quot;nntp&quot;/&gt;</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineminus">-          &lt;menuitem value=&quot;3&quot; label=&quot;&amp;connectionSecurityType-3.label;&quot;/&gt;</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineminus">-        &lt;/menupopup&gt;</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineminus">-      &lt;/menulist&gt;</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineminus">-    &lt;/hbox&gt;</span>
<a href="#l21.29"></a><span id="l21.29"> </span>
<a href="#l21.30"></a><span id="l21.30" class="difflineminus">-    &lt;checkbox wsm_persist=&quot;true&quot; id=&quot;server.useSecAuth&quot;</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-              label=&quot;&amp;useSecAuth.label;&quot; hidefor=&quot;nntp,movemail&quot;</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-              accesskey=&quot;&amp;useSecAuth.accesskey;&quot;</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineminus">-              prefattribute=&quot;value&quot;</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineminus">-              prefstring=&quot;mail.server.%serverkey%.useSecAuth&quot;/&gt;</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineplus">+    &lt;grid flex=&quot;1&quot;&gt;</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineplus">+      &lt;columns&gt;</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineplus">+        &lt;column/&gt;</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineplus">+        &lt;column/&gt;</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineplus">+      &lt;/columns&gt;</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineplus">+      &lt;rows&gt;</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineplus">+        &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineplus">+          &lt;label value=&quot;&amp;connectionSecurity.label;&quot;</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineplus">+                 accesskey=&quot;&amp;connectionSecurity.accesskey;&quot;</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineplus">+                 control=&quot;server.socketType&quot;/&gt;</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineplus">+          &lt;menulist wsm_persist=&quot;true&quot; id=&quot;server.socketType&quot;</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineplus">+                    oncommand=&quot;secureSelect();&quot;&gt;</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineplus">+            &lt;menupopup id=&quot;server.socketTypePopup&quot;&gt;</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineplus">+              &lt;menuitem value=&quot;0&quot; label=&quot;&amp;connectionSecurityType-0.label;&quot;/&gt;</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineplus">+              &lt;menuitem id=&quot;connectionSecurityType-1&quot;</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineplus">+                        value=&quot;1&quot; label=&quot;&amp;connectionSecurityType-1.label;&quot;</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineplus">+                        disabled=&quot;true&quot;/&gt;</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineplus">+              &lt;menuitem value=&quot;2&quot; label=&quot;&amp;connectionSecurityType-2.label;&quot;</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineplus">+                        hidefor=&quot;nntp&quot;/&gt;</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineplus">+              &lt;menuitem value=&quot;3&quot; label=&quot;&amp;connectionSecurityType-3.label;&quot;/&gt;</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineplus">+            &lt;/menupopup&gt;</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineplus">+          &lt;/menulist&gt;</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineplus">+        &lt;/row&gt;</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineplus">+        &lt;row align=&quot;center&quot; hidefor=&quot;nntp,movemail&quot;&gt;</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineplus">+          &lt;label value=&quot;&amp;authMethod.label;&quot;</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineplus">+                 accesskey=&quot;&amp;authMethod.accesskey;&quot;</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineplus">+                 control=&quot;server.authMethod&quot;/&gt;</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineplus">+          &lt;!-- same in smtpEditOverlay.xul/js --&gt;</span>
<a href="#l21.63"></a><span id="l21.63" class="difflineplus">+          &lt;menulist id=&quot;server.authMethod&quot;</span>
<a href="#l21.64"></a><span id="l21.64" class="difflineplus">+                    wsm_persist=&quot;true&quot;</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineplus">+                    preftype=&quot;int&quot; type=&quot;number&quot;</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineplus">+                    prefstring=&quot;mail.server.%serverkey%.authMethod&quot;&gt;</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineplus">+            &lt;menupopup id=&quot;server.authMethodPopup&quot;&gt;</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineplus">+              &lt;menuitem id=&quot;authMethod-no&quot; value=&quot;1&quot;/&gt;</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineplus">+              &lt;menuitem id=&quot;authMethod-old&quot; value=&quot;2&quot;/&gt;</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineplus">+              &lt;menuitem id=&quot;authMethod-password-cleartext&quot; value=&quot;3&quot;/&gt;</span>
<a href="#l21.71"></a><span id="l21.71" class="difflineplus">+              &lt;menuitem id=&quot;authMethod-password-encrypted&quot; value=&quot;4&quot;/&gt;</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineplus">+              &lt;menuitem id=&quot;authMethod-kerberos&quot; value=&quot;5&quot;/&gt;</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineplus">+              &lt;menuitem id=&quot;authMethod-ntlm&quot; value=&quot;6&quot;/&gt;</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineplus">+              &lt;menuitem id=&quot;authMethod-anysecure&quot; value=&quot;8&quot;/&gt;</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineplus">+              &lt;menuitem id=&quot;authMethod-any&quot; value=&quot;9&quot;/&gt;</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineplus">+            &lt;/menupopup&gt;</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineplus">+          &lt;/menulist&gt;</span>
<a href="#l21.78"></a><span id="l21.78" class="difflineplus">+        &lt;/row&gt;</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineplus">+      &lt;/rows&gt;</span>
<a href="#l21.80"></a><span id="l21.80" class="difflineplus">+    &lt;/grid&gt;</span>
<a href="#l21.81"></a><span id="l21.81">   &lt;/groupbox&gt;</span>
<a href="#l21.82"></a><span id="l21.82"> </span>
<a href="#l21.83"></a><span id="l21.83">   &lt;groupbox&gt;</span>
<a href="#l21.84"></a><span id="l21.84">     &lt;caption label=&quot;&amp;serverSettings.label;&quot;/&gt;</span>
<a href="#l21.85"></a><span id="l21.85">     &lt;vbox align=&quot;start&quot;&gt;</span>
<a href="#l21.86"></a><span id="l21.86">     &lt;checkbox wsm_persist=&quot;true&quot;</span>
<a href="#l21.87"></a><span id="l21.87">               id=&quot;server.loginAtStartUp&quot; </span>
<a href="#l21.88"></a><span id="l21.88">               label=&quot;&amp;loginAtStartup.label;&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-smtp.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-smtp.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -134,19 +134,53 @@ var gSmtpServerListWindow =</span>
<a href="#l22.4"></a><span id="l22.4">   {</span>
<a href="#l22.5"></a><span id="l22.5">     var noneSelected = this.mBundle.getString(&quot;smtpServerList-NotSpecified&quot;);</span>
<a href="#l22.6"></a><span id="l22.6"> </span>
<a href="#l22.7"></a><span id="l22.7">     document.getElementById('nameValue').value = aServer.hostname;</span>
<a href="#l22.8"></a><span id="l22.8">     document.getElementById('descriptionValue').value = aServer.description || noneSelected;</span>
<a href="#l22.9"></a><span id="l22.9">     document.getElementById('portValue').value = aServer.port;</span>
<a href="#l22.10"></a><span id="l22.10">     document.getElementById('userNameValue').value = aServer.username || noneSelected;</span>
<a href="#l22.11"></a><span id="l22.11">     document.getElementById('useSecureConnectionValue').value =</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-      this.mBundle.getString(&quot;smtpServer-ConnectionSecurityType-&quot; + aServer.trySSL);</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-    document.getElementById('useSecureAuthenticationValue').value =</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">-      this.mBundle.getString(&quot;smtpServer-SecureAuthentication-Type-&quot; + aServer.useSecAuth);</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+      this.mBundle.getString(&quot;smtpServer-ConnectionSecurityType-&quot; +</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+      aServer.socketType);</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineplus">+</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+    const AuthMethod = Components.interfaces.nsMsgAuthMethod;</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineplus">+    const SocketType = Components.interfaces.nsMsgSocketType;</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineplus">+    var authStr = &quot;&quot;;</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineplus">+    switch (aServer.authMethod)</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineplus">+    {</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineplus">+      case AuthMethod.none:</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineplus">+        authStr = &quot;authNo&quot;;</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineplus">+        break;</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineplus">+      case AuthMethod.passwordEncrypted:</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineplus">+        authStr = &quot;authPasswordEncrypted&quot;;</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineplus">+        break;</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineplus">+      case AuthMethod.GSSAPI:</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineplus">+        authStr = &quot;authKerberos&quot;;</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineplus">+        break;</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+      case AuthMethod.NTLM:</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineplus">+        authStr = &quot;authNTLM&quot;;</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+        break;</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineplus">+      case AuthMethod.secure:</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineplus">+        authStr = &quot;authAnySecure&quot;;</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineplus">+        break;</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineplus">+      case AuthMethod.passwordCleartext:</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineplus">+        authStr = (aServer.socketType == SocketType.SSL ||</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineplus">+                   aServer.socketType == SocketType.alwaysSTARTTLS)</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineplus">+                  ? &quot;authPasswordCleartextViaSSL&quot;</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineplus">+                  : &quot;authPasswordCleartextInsecurely&quot;;</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineplus">+        break;</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineplus">+      default:</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineplus">+        // leave empty</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineplus">+        dump(&quot;Warning: unknown value for smtpserver...authMethod: &quot; +</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineplus">+             aServer.authMethod + &quot;\n&quot;);</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineplus">+    }</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineplus">+    if (authStr)</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineplus">+      document.getElementById(&quot;authMethodValue&quot;).value =</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineplus">+          this.mBundle.getString(authStr);</span>
<a href="#l22.52"></a><span id="l22.52">   },</span>
<a href="#l22.53"></a><span id="l22.53"> </span>
<a href="#l22.54"></a><span id="l22.54">   refreshServerList: function(aServerKeyToSelect, aFocusList)</span>
<a href="#l22.55"></a><span id="l22.55">   {</span>
<a href="#l22.56"></a><span id="l22.56">     // remove all children</span>
<a href="#l22.57"></a><span id="l22.57">     while (this.mServerList.hasChildNodes())</span>
<a href="#l22.58"></a><span id="l22.58">       this.mServerList.removeChild(this.mServerList.lastChild);</span>
<a href="#l22.59"></a><span id="l22.59"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-smtp.xul</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-smtp.xul</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -1,14 +1,12 @@</span>
<a href="#l23.4"></a><span id="l23.4"> &lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l23.5"></a><span id="l23.5"> </span>
<a href="#l23.6"></a><span id="l23.6"> &lt;?xml-stylesheet href=&quot;chrome://messenger/skin/accountManage.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l23.7"></a><span id="l23.7"> </span>
<a href="#l23.8"></a><span id="l23.8" class="difflineminus">-&lt;?xul-overlay href=&quot;chrome://messenger/content/smtpEditOverlay.xul&quot;?&gt;</span>
<a href="#l23.9"></a><span id="l23.9" class="difflineminus">-</span>
<a href="#l23.10"></a><span id="l23.10"> &lt;!DOCTYPE page SYSTEM &quot;chrome://messenger/locale/am-advanced.dtd&quot; &gt;</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12"> &lt;page xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l23.13"></a><span id="l23.13">       title=&quot;&amp;smtpServer.label;&quot;</span>
<a href="#l23.14"></a><span id="l23.14">       onload=&quot;gSmtpServerListWindow.onLoad();&quot;&gt;</span>
<a href="#l23.15"></a><span id="l23.15">   &lt;script type=&quot;application/javascript&quot; src=&quot;amUtils.js&quot;/&gt;</span>
<a href="#l23.16"></a><span id="l23.16">   &lt;script type=&quot;application/javascript&quot; src=&quot;am-smtp.js&quot;/&gt;</span>
<a href="#l23.17"></a><span id="l23.17">   </span>
<a href="#l23.18"></a><span id="l23.18" class="difflineat">@@ -62,18 +60,18 @@</span>
<a href="#l23.19"></a><span id="l23.19">             &lt;hbox pack=&quot;end&quot;&gt;&lt;label id=&quot;portLabel&quot; value=&quot;&amp;serverPort.label;&quot; control=&quot;portValue&quot;/&gt;&lt;/hbox&gt;</span>
<a href="#l23.20"></a><span id="l23.20">             &lt;textbox id=&quot;portValue&quot; readonly=&quot;true&quot; class=&quot;plain&quot;/&gt;</span>
<a href="#l23.21"></a><span id="l23.21">           &lt;/row&gt;</span>
<a href="#l23.22"></a><span id="l23.22">           &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l23.23"></a><span id="l23.23">             &lt;hbox pack=&quot;end&quot;&gt;&lt;label id=&quot;userNameLabel&quot; value=&quot;&amp;userName.label;&quot; control=&quot;userNameValue&quot;/&gt;&lt;/hbox&gt;</span>
<a href="#l23.24"></a><span id="l23.24">             &lt;textbox id=&quot;userNameValue&quot; readonly=&quot;true&quot; class=&quot;plain&quot;/&gt;</span>
<a href="#l23.25"></a><span id="l23.25">           &lt;/row&gt;</span>
<a href="#l23.26"></a><span id="l23.26">           &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineminus">-              &lt;hbox pack=&quot;end&quot;&gt;&lt;label id=&quot;useSecureAuthenticationLabel&quot; value=&quot;&amp;useSecureAuthentication.label;&quot; control=&quot;useSecureAuthenticationValue&quot;/&gt;&lt;/hbox&gt;</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineminus">-              &lt;textbox id=&quot;useSecureAuthenticationValue&quot; readonly=&quot;true&quot; class=&quot;plain&quot;/&gt;</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineplus">+              &lt;hbox pack=&quot;end&quot;&gt;&lt;label value=&quot;&amp;authMethod.label;&quot; control=&quot;authMethodValue&quot;/&gt;&lt;/hbox&gt;</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineplus">+              &lt;textbox id=&quot;authMethodValue&quot; readonly=&quot;true&quot; class=&quot;plain&quot;/&gt;</span>
<a href="#l23.31"></a><span id="l23.31">           &lt;/row&gt;</span>
<a href="#l23.32"></a><span id="l23.32">           &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l23.33"></a><span id="l23.33">             &lt;hbox pack=&quot;end&quot;&gt;</span>
<a href="#l23.34"></a><span id="l23.34">               &lt;label id=&quot;connectionSecurityLabel&quot; value=&quot;&amp;connectionSecurity.label;&quot;</span>
<a href="#l23.35"></a><span id="l23.35">                      control=&quot;useSecureConnectionValue&quot;/&gt;</span>
<a href="#l23.36"></a><span id="l23.36">             &lt;/hbox&gt;</span>
<a href="#l23.37"></a><span id="l23.37">             &lt;textbox id=&quot;useSecureConnectionValue&quot; readonly=&quot;true&quot; class=&quot;plain&quot;/&gt;</span>
<a href="#l23.38"></a><span id="l23.38">           &lt;/row&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/base/prefs/content/smtpEditOverlay.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/base/prefs/content/smtpEditOverlay.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -40,167 +40,168 @@</span>
<a href="#l24.4"></a><span id="l24.4"> // be real hacky with document.getElementById until document.controls works</span>
<a href="#l24.5"></a><span id="l24.5"> // with the new XUL widgets</span>
<a href="#l24.6"></a><span id="l24.6"> </span>
<a href="#l24.7"></a><span id="l24.7"> var gSmtpUsername;</span>
<a href="#l24.8"></a><span id="l24.8"> var gSmtpDescription;</span>
<a href="#l24.9"></a><span id="l24.9"> var gSmtpUsernameLabel;</span>
<a href="#l24.10"></a><span id="l24.10"> var gSmtpHostname;</span>
<a href="#l24.11"></a><span id="l24.11"> var gSmtpPort;</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-var gSmtpUseSecAuth;</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-var gSmtpUseUsername;</span>
<a href="#l24.14"></a><span id="l24.14"> var gSmtpAuthMethod;</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineminus">-var gSmtpTrySSL;</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineplus">+var gSmtpSocketType;</span>
<a href="#l24.17"></a><span id="l24.17"> var gSmtpPrefBranch;</span>
<a href="#l24.18"></a><span id="l24.18"> var gPrefBranch = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;].getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l24.19"></a><span id="l24.19"> var gSmtpService = Components.classes[&quot;@mozilla.org/messengercompose/smtp;1&quot;].getService(Components.interfaces.nsISmtpService);</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineminus">-var gSavedUsername = &quot;&quot;;</span>
<a href="#l24.21"></a><span id="l24.21"> var gPort;</span>
<a href="#l24.22"></a><span id="l24.22"> var gDefaultPort;</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l24.24"></a><span id="l24.24"> </span>
<a href="#l24.25"></a><span id="l24.25"> function initSmtpSettings(server) {</span>
<a href="#l24.26"></a><span id="l24.26">     gSmtpUsername = document.getElementById(&quot;smtp.username&quot;);</span>
<a href="#l24.27"></a><span id="l24.27">     gSmtpDescription = document.getElementById(&quot;smtp.description&quot;);</span>
<a href="#l24.28"></a><span id="l24.28">     gSmtpUsernameLabel = document.getElementById(&quot;smtp.username.label&quot;);</span>
<a href="#l24.29"></a><span id="l24.29">     gSmtpHostname = document.getElementById(&quot;smtp.hostname&quot;);</span>
<a href="#l24.30"></a><span id="l24.30">     gSmtpPort = document.getElementById(&quot;smtp.port&quot;);</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineminus">-    gSmtpUseUsername = document.getElementById(&quot;smtp.useUsername&quot;);</span>
<a href="#l24.32"></a><span id="l24.32">     gSmtpAuthMethod = document.getElementById(&quot;smtp.authMethod&quot;);</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineminus">-    gSmtpTrySSL = document.getElementById(&quot;smtp.trySSL&quot;);</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineminus">-    gSmtpUseSecAuth = document.getElementById(&quot;smtp.useSecAuth&quot;);</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineplus">+    gSmtpSocketType = document.getElementById(&quot;smtp.socketType&quot;);</span>
<a href="#l24.36"></a><span id="l24.36">     gDefaultPort = document.getElementById(&quot;smtp.defaultPort&quot;);</span>
<a href="#l24.37"></a><span id="l24.37">     gPort = document.getElementById(&quot;smtp.port&quot;);</span>
<a href="#l24.38"></a><span id="l24.38"> </span>
<a href="#l24.39"></a><span id="l24.39">     if (server) {</span>
<a href="#l24.40"></a><span id="l24.40">         gSmtpHostname.value = server.hostname;</span>
<a href="#l24.41"></a><span id="l24.41">         gSmtpDescription.value = server.description;</span>
<a href="#l24.42"></a><span id="l24.42">         gSmtpPort.value = server.port ? server.port : &quot;&quot;;</span>
<a href="#l24.43"></a><span id="l24.43">         gSmtpUsername.value = server.username;</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineminus">-        gSmtpAuthMethod.setAttribute(&quot;value&quot;, server.authMethod);</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineminus">-        gSmtpTrySSL.value = (server.trySSL &lt; 4) ? server.trySSL : 1;</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineminus">-        gSmtpUseSecAuth.checked = server.useSecAuth == &quot;1&quot;;</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineplus">+        gSmtpAuthMethod.value = server.authMethod;</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineplus">+        gSmtpSocketType.value = (server.socketType &lt; 4) ? server.socketType : 1;</span>
<a href="#l24.49"></a><span id="l24.49">     } else {</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineminus">-        const PREF_AUTH_ANY = 1; // From nsSmtpProtocol.h</span>
<a href="#l24.51"></a><span id="l24.51" class="difflineminus">-        gSmtpAuthMethod.setAttribute(&quot;value&quot;, PREF_AUTH_ANY);</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineminus">-        const PREF_SECURE_NEVER = 0; // From nsSmtpProtocol.h</span>
<a href="#l24.53"></a><span id="l24.53" class="difflineminus">-        gSmtpTrySSL.value = PREF_SECURE_NEVER;</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineplus">+        // When does that happen? TODO Get default prefs, if realistic, otherwise remove</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineplus">+        gSmtpAuthMethod.value = 3; // cleartext</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineplus">+        gSmtpSocketType.value = 0;</span>
<a href="#l24.57"></a><span id="l24.57">     }</span>
<a href="#l24.58"></a><span id="l24.58"> </span>
<a href="#l24.59"></a><span id="l24.59" class="difflineminus">-    gSmtpUseUsername.checked = (gSmtpAuthMethod.getAttribute(&quot;value&quot;) == &quot;1&quot;);</span>
<a href="#l24.60"></a><span id="l24.60" class="difflineplus">+    sslChanged(false);</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineplus">+    authMethodChanged(false);</span>
<a href="#l24.62"></a><span id="l24.62"> </span>
<a href="#l24.63"></a><span id="l24.63" class="difflineminus">-    //dump(&quot;gSmtpAuthMethod = &lt;&quot; + gSmtpAuthMethod.localName + &quot;&gt;\n&quot;);</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineminus">-    //dump(&quot;gSmtpAuthMethod.value = &quot; + gSmtpAuthMethod.getAttribute(&quot;value&quot;) + &quot;\n&quot;);</span>
<a href="#l24.65"></a><span id="l24.65" class="difflineminus">-</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineminus">-    onUseUsername(gSmtpUseUsername, false);</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineminus">-    selectProtocol(false);</span>
<a href="#l24.68"></a><span id="l24.68">     if (gSmtpService.defaultServer)</span>
<a href="#l24.69"></a><span id="l24.69">       onLockPreference();</span>
<a href="#l24.70"></a><span id="l24.70"> </span>
<a href="#l24.71"></a><span id="l24.71" class="difflineminus">-    //&quot;STARTTLS, if available&quot; is vulnerable to MITM attacks so we shouldn't</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineplus">+    setLabelFromStringBundle(&quot;authMethod-no&quot;, &quot;authNo&quot;);</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineplus">+    setLabelFromStringBundle(&quot;authMethod-kerberos&quot;, &quot;authKerberos&quot;);</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineplus">+    setLabelFromStringBundle(&quot;authMethod-ntlm&quot;, &quot;authNTLM&quot;);</span>
<a href="#l24.75"></a><span id="l24.75" class="difflineplus">+    setLabelFromStringBundle(&quot;authMethod-anysecure&quot;, &quot;authAnySecure&quot;);</span>
<a href="#l24.76"></a><span id="l24.76" class="difflineplus">+    setLabelFromStringBundle(&quot;authMethod-any&quot;, &quot;authAny&quot;);</span>
<a href="#l24.77"></a><span id="l24.77" class="difflineplus">+    setLabelFromStringBundle(&quot;authMethod-password-encrypted&quot;,</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineplus">+        &quot;authPasswordEncrypted&quot;);</span>
<a href="#l24.79"></a><span id="l24.79" class="difflineplus">+    //authMethod-password-cleartext already set in sslChanged()</span>
<a href="#l24.80"></a><span id="l24.80" class="difflineplus">+</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineplus">+    // Hide deprecated/hidden auth options, unless selected</span>
<a href="#l24.82"></a><span id="l24.82" class="difflineplus">+    hideUnlessSelected(document.getElementById(&quot;authMethod-anysecure&quot;));</span>
<a href="#l24.83"></a><span id="l24.83" class="difflineplus">+    hideUnlessSelected(document.getElementById(&quot;authMethod-any&quot;));</span>
<a href="#l24.84"></a><span id="l24.84" class="difflineplus">+</span>
<a href="#l24.85"></a><span id="l24.85" class="difflineplus">+    // &quot;STARTTLS, if available&quot; is vulnerable to MITM attacks so we shouldn't</span>
<a href="#l24.86"></a><span id="l24.86">     // allow users to choose it anymore. Hide the option unless the user already</span>
<a href="#l24.87"></a><span id="l24.87">     // has it set.</span>
<a href="#l24.88"></a><span id="l24.88" class="difflineminus">-    const PREF_SECURE_TRY_STARTTLS = 1; // From nsSmtpProtocol.h</span>
<a href="#l24.89"></a><span id="l24.89" class="difflineminus">-    var hidden = (document.getElementById(&quot;smtp.trySSL&quot;).value != PREF_SECURE_TRY_STARTTLS);</span>
<a href="#l24.90"></a><span id="l24.90" class="difflineminus">-    document.getElementById(&quot;connectionSecurityType-1&quot;).hidden = hidden;</span>
<a href="#l24.91"></a><span id="l24.91" class="difflineplus">+    hideUnlessSelected(document.getElementById(&quot;connectionSecurityType-1&quot;));</span>
<a href="#l24.92"></a><span id="l24.92" class="difflineplus">+}</span>
<a href="#l24.93"></a><span id="l24.93" class="difflineplus">+</span>
<a href="#l24.94"></a><span id="l24.94" class="difflineplus">+function hideUnlessSelected(element)</span>
<a href="#l24.95"></a><span id="l24.95" class="difflineplus">+{</span>
<a href="#l24.96"></a><span id="l24.96" class="difflineplus">+  element.hidden = !element.selected;</span>
<a href="#l24.97"></a><span id="l24.97" class="difflineplus">+}</span>
<a href="#l24.98"></a><span id="l24.98" class="difflineplus">+</span>
<a href="#l24.99"></a><span id="l24.99" class="difflineplus">+function setLabelFromStringBundle(elementID, stringName)</span>
<a href="#l24.100"></a><span id="l24.100" class="difflineplus">+{</span>
<a href="#l24.101"></a><span id="l24.101" class="difflineplus">+  document.getElementById(elementID).label =</span>
<a href="#l24.102"></a><span id="l24.102" class="difflineplus">+      document.getElementById(&quot;bundle_messenger&quot;).getString(stringName);</span>
<a href="#l24.103"></a><span id="l24.103"> }</span>
<a href="#l24.104"></a><span id="l24.104"> </span>
<a href="#l24.105"></a><span id="l24.105"> // Disables xul elements that have associated preferences locked.</span>
<a href="#l24.106"></a><span id="l24.106"> function onLockPreference()</span>
<a href="#l24.107"></a><span id="l24.107"> {</span>
<a href="#l24.108"></a><span id="l24.108" class="difflineminus">-    var defaultSmtpServerKey = gPrefBranch.getCharPref(&quot;mail.smtp.defaultserver&quot;);</span>
<a href="#l24.109"></a><span id="l24.109" class="difflineminus">-    var finalPrefString = &quot;mail.smtpserver.&quot; + defaultSmtpServerKey + &quot;.&quot;; </span>
<a href="#l24.110"></a><span id="l24.110" class="difflineplus">+  try {</span>
<a href="#l24.111"></a><span id="l24.111" class="difflineplus">+    var finalPrefString = &quot;mail.smtpserver.&quot; +</span>
<a href="#l24.112"></a><span id="l24.112" class="difflineplus">+        gSmtpService.defaultServer.key + &quot;.&quot;;</span>
<a href="#l24.113"></a><span id="l24.113"> </span>
<a href="#l24.114"></a><span id="l24.114">     var prefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;].getService(Components.interfaces.nsIPrefService);</span>
<a href="#l24.115"></a><span id="l24.115"> </span>
<a href="#l24.116"></a><span id="l24.116">     var allPrefElements = {</span>
<a href="#l24.117"></a><span id="l24.117">       hostname:     gSmtpHostname,</span>
<a href="#l24.118"></a><span id="l24.118">       description:  gSmtpDescription,</span>
<a href="#l24.119"></a><span id="l24.119">       port:         gSmtpPort,</span>
<a href="#l24.120"></a><span id="l24.120" class="difflineminus">-      use_username: gSmtpUseUsername,</span>
<a href="#l24.121"></a><span id="l24.121" class="difflineminus">-      try_ssl:      gSmtpTrySSL</span>
<a href="#l24.122"></a><span id="l24.122" class="difflineplus">+      authMethod:   gSmtpAuthMethod,</span>
<a href="#l24.123"></a><span id="l24.123" class="difflineplus">+      try_ssl:      gSmtpSocketType</span>
<a href="#l24.124"></a><span id="l24.124">     };</span>
<a href="#l24.125"></a><span id="l24.125"> </span>
<a href="#l24.126"></a><span id="l24.126">     gSmtpPrefBranch = prefService.getBranch(finalPrefString);</span>
<a href="#l24.127"></a><span id="l24.127">     disableIfLocked( allPrefElements );</span>
<a href="#l24.128"></a><span id="l24.128" class="difflineplus">+  } catch (e) { dump(&quot;error while locking prefs: &quot; + e + &quot;\n&quot;); } // non-fatal</span>
<a href="#l24.129"></a><span id="l24.129"> } </span>
<a href="#l24.130"></a><span id="l24.130"> </span>
<a href="#l24.131"></a><span id="l24.131"> // Does the work of disabling an element given the array which contains xul id/prefstring pairs.</span>
<a href="#l24.132"></a><span id="l24.132"> // Also saves the id/locked state in an array so that other areas of the code can avoid</span>
<a href="#l24.133"></a><span id="l24.133"> // stomping on the disabled state indiscriminately.</span>
<a href="#l24.134"></a><span id="l24.134"> function disableIfLocked( prefstrArray )</span>
<a href="#l24.135"></a><span id="l24.135"> {</span>
<a href="#l24.136"></a><span id="l24.136">   for (var prefstring in prefstrArray)</span>
<a href="#l24.137"></a><span id="l24.137">     if (gSmtpPrefBranch.prefIsLocked(prefstring))</span>
<a href="#l24.138"></a><span id="l24.138">       prefstrArray[prefstring].disabled = true;</span>
<a href="#l24.139"></a><span id="l24.139"> }</span>
<a href="#l24.140"></a><span id="l24.140"> </span>
<a href="#l24.141"></a><span id="l24.141"> function saveSmtpSettings(server)</span>
<a href="#l24.142"></a><span id="l24.142"> {</span>
<a href="#l24.143"></a><span id="l24.143" class="difflineminus">-    gSmtpAuthMethod.setAttribute(&quot;value&quot;, gSmtpUseUsername.checked ? &quot;1&quot; : &quot;0&quot;);</span>
<a href="#l24.144"></a><span id="l24.144" class="difflineminus">-</span>
<a href="#l24.145"></a><span id="l24.145">     //dump(&quot;Saving to &quot; + server + &quot;\n&quot;);</span>
<a href="#l24.146"></a><span id="l24.146">     if (server) {</span>
<a href="#l24.147"></a><span id="l24.147">         server.hostname = gSmtpHostname.value;</span>
<a href="#l24.148"></a><span id="l24.148">         server.description = gSmtpDescription.value;</span>
<a href="#l24.149"></a><span id="l24.149">         server.port = gSmtpPort.value;</span>
<a href="#l24.150"></a><span id="l24.150" class="difflineminus">-        server.authMethod = (gSmtpUseUsername.checked ? 1 : 0);</span>
<a href="#l24.151"></a><span id="l24.151" class="difflineminus">-        //dump(&quot;Saved authmethod = &quot; + server.authMethod +</span>
<a href="#l24.152"></a><span id="l24.152" class="difflineminus">-        //     &quot; but checked = &quot; + gSmtpUseUsername.checked + &quot;\n&quot;);</span>
<a href="#l24.153"></a><span id="l24.153" class="difflineplus">+        server.authMethod = gSmtpAuthMethod.value;</span>
<a href="#l24.154"></a><span id="l24.154">         server.username = gSmtpUsername.value;</span>
<a href="#l24.155"></a><span id="l24.155" class="difflineminus">-        server.trySSL = gSmtpTrySSL.value;</span>
<a href="#l24.156"></a><span id="l24.156" class="difflineminus">-        server.useSecAuth = gSmtpUseSecAuth.checked;</span>
<a href="#l24.157"></a><span id="l24.157" class="difflineplus">+        server.socketType = gSmtpSocketType.value;</span>
<a href="#l24.158"></a><span id="l24.158">     }</span>
<a href="#l24.159"></a><span id="l24.159"> }</span>
<a href="#l24.160"></a><span id="l24.160"> </span>
<a href="#l24.161"></a><span id="l24.161" class="difflineminus">-function onUseUsername(checkbox, dofocus)</span>
<a href="#l24.162"></a><span id="l24.162" class="difflineplus">+function authMethodChanged(userAction)</span>
<a href="#l24.163"></a><span id="l24.163"> {</span>
<a href="#l24.164"></a><span id="l24.164" class="difflineminus">-    if (checkbox.checked) {</span>
<a href="#l24.165"></a><span id="l24.165" class="difflineminus">-        // not only do we enable the elements when the check box is checked,</span>
<a href="#l24.166"></a><span id="l24.166" class="difflineminus">-        // but we also make sure that it's not disabled (ie locked) as well.</span>
<a href="#l24.167"></a><span id="l24.167" class="difflineminus">-        if (!checkbox.disabled) {</span>
<a href="#l24.168"></a><span id="l24.168" class="difflineminus">-            gSmtpUsername.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l24.169"></a><span id="l24.169" class="difflineminus">-            gSmtpUsernameLabel.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l24.170"></a><span id="l24.170" class="difflineminus">-            gSmtpUseSecAuth.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l24.171"></a><span id="l24.171" class="difflineminus">-        }</span>
<a href="#l24.172"></a><span id="l24.172" class="difflineminus">-        if (dofocus)</span>
<a href="#l24.173"></a><span id="l24.173" class="difflineminus">-            gSmtpUsername.focus();</span>
<a href="#l24.174"></a><span id="l24.174" class="difflineminus">-        if (gSavedUsername &amp;&amp; gSavedUsername != &quot;&quot;)</span>
<a href="#l24.175"></a><span id="l24.175" class="difflineminus">-            gSmtpUsername.value = gSavedUsername;</span>
<a href="#l24.176"></a><span id="l24.176" class="difflineminus">-    } else {</span>
<a href="#l24.177"></a><span id="l24.177" class="difflineminus">-        gSavedUsername = gSmtpUsername.value;</span>
<a href="#l24.178"></a><span id="l24.178" class="difflineminus">-        gSmtpUsername.value = &quot;&quot;;</span>
<a href="#l24.179"></a><span id="l24.179" class="difflineminus">-        gSmtpUsername.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l24.180"></a><span id="l24.180" class="difflineminus">-        gSmtpUsernameLabel.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l24.181"></a><span id="l24.181" class="difflineminus">-        gSmtpUseSecAuth.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l24.182"></a><span id="l24.182" class="difflineminus">-    }</span>
<a href="#l24.183"></a><span id="l24.183" class="difflineplus">+  var noUsername = gSmtpAuthMethod.value == Ci.nsMsgAuthMethod.none;</span>
<a href="#l24.184"></a><span id="l24.184" class="difflineplus">+  gSmtpUsername.disabled = noUsername;</span>
<a href="#l24.185"></a><span id="l24.185" class="difflineplus">+  gSmtpUsernameLabel.disabled = noUsername;</span>
<a href="#l24.186"></a><span id="l24.186"> }</span>
<a href="#l24.187"></a><span id="l24.187"> </span>
<a href="#l24.188"></a><span id="l24.188"> /**</span>
<a href="#l24.189"></a><span id="l24.189" class="difflineminus">- * Resets the default port to SMTP or SMTPS, dependending on |gSmtpTrySSL| value,</span>
<a href="#l24.190"></a><span id="l24.190" class="difflineminus">- * and sets the port to use to this default, if that's appropriate.</span>
<a href="#l24.191"></a><span id="l24.191" class="difflineplus">+ * Resets the default port to SMTP or SMTPS, dependending on</span>
<a href="#l24.192"></a><span id="l24.192" class="difflineplus">+ * the |gSmtpSocketType| value, and sets the port to use to this default,</span>
<a href="#l24.193"></a><span id="l24.193" class="difflineplus">+ * if that's appropriate.</span>
<a href="#l24.194"></a><span id="l24.194">  *</span>
<a href="#l24.195"></a><span id="l24.195">  * @param userAction false for dialog initialization,</span>
<a href="#l24.196"></a><span id="l24.196">  *                   true for user action.</span>
<a href="#l24.197"></a><span id="l24.197">  */</span>
<a href="#l24.198"></a><span id="l24.198" class="difflineminus">-function selectProtocol(userAction) {</span>
<a href="#l24.199"></a><span id="l24.199" class="difflineplus">+function sslChanged(userAction)</span>
<a href="#l24.200"></a><span id="l24.200" class="difflineplus">+{</span>
<a href="#l24.201"></a><span id="l24.201">   const DEFAULT_SMTP_PORT = &quot;25&quot;;</span>
<a href="#l24.202"></a><span id="l24.202">   const DEFAULT_SMTPS_PORT = &quot;465&quot;;</span>
<a href="#l24.203"></a><span id="l24.203" class="difflineminus">-</span>
<a href="#l24.204"></a><span id="l24.204" class="difflineplus">+  var socketType = gSmtpSocketType.value;</span>
<a href="#l24.205"></a><span id="l24.205">   var otherDefaultPort;</span>
<a href="#l24.206"></a><span id="l24.206">   var prevDefaultPort = gDefaultPort.value;</span>
<a href="#l24.207"></a><span id="l24.207"> </span>
<a href="#l24.208"></a><span id="l24.208" class="difflineminus">-  if (gSmtpTrySSL.value == 3) {</span>
<a href="#l24.209"></a><span id="l24.209" class="difflineplus">+  if (socketType == Ci.nsMsgSocketType.SSL) {</span>
<a href="#l24.210"></a><span id="l24.210">     gDefaultPort.value = DEFAULT_SMTPS_PORT;</span>
<a href="#l24.211"></a><span id="l24.211">     otherDefaultPort = DEFAULT_SMTP_PORT;</span>
<a href="#l24.212"></a><span id="l24.212">   } else {</span>
<a href="#l24.213"></a><span id="l24.213">     gDefaultPort.value = DEFAULT_SMTP_PORT;</span>
<a href="#l24.214"></a><span id="l24.214">     otherDefaultPort = DEFAULT_SMTPS_PORT;</span>
<a href="#l24.215"></a><span id="l24.215">   }</span>
<a href="#l24.216"></a><span id="l24.216"> </span>
<a href="#l24.217"></a><span id="l24.217">   // If the port is not set,</span>
<a href="#l24.218"></a><span id="l24.218">   // or the user is causing the default port to change,</span>
<a href="#l24.219"></a><span id="l24.219">   //   and the port is set to the default for the other protocol,</span>
<a href="#l24.220"></a><span id="l24.220">   // then set the port to the default for the new protocol.</span>
<a href="#l24.221"></a><span id="l24.221">   if ((gPort.value == &quot;&quot;) ||</span>
<a href="#l24.222"></a><span id="l24.222">       (userAction &amp;&amp; (gDefaultPort.value != prevDefaultPort) &amp;&amp;</span>
<a href="#l24.223"></a><span id="l24.223">        (gPort.value == otherDefaultPort)))</span>
<a href="#l24.224"></a><span id="l24.224">     gPort.value = gDefaultPort.value;</span>
<a href="#l24.225"></a><span id="l24.225" class="difflineplus">+</span>
<a href="#l24.226"></a><span id="l24.226" class="difflineplus">+  // switch &quot;insecure password&quot; label</span>
<a href="#l24.227"></a><span id="l24.227" class="difflineplus">+  setLabelFromStringBundle(&quot;authMethod-password-cleartext&quot;,</span>
<a href="#l24.228"></a><span id="l24.228" class="difflineplus">+      socketType == Ci.nsMsgSocketType.SSL ||</span>
<a href="#l24.229"></a><span id="l24.229" class="difflineplus">+      socketType == Ci.nsMsgSocketType.alwaysSTARTTLS ?</span>
<a href="#l24.230"></a><span id="l24.230" class="difflineplus">+      &quot;authPasswordCleartextViaSSL&quot; : &quot;authPasswordCleartextInsecurely&quot;);</span>
<a href="#l24.231"></a><span id="l24.231"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/base/prefs/content/smtpEditOverlay.xul</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/base/prefs/content/smtpEditOverlay.xul</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -50,85 +50,99 @@</span>
<a href="#l25.4"></a><span id="l25.4">           &lt;caption label=&quot;&amp;settings.caption;&quot;/&gt;</span>
<a href="#l25.5"></a><span id="l25.5">           &lt;grid flex=&quot;1&quot;&gt;</span>
<a href="#l25.6"></a><span id="l25.6">               &lt;columns&gt;</span>
<a href="#l25.7"></a><span id="l25.7">                   &lt;column/&gt;</span>
<a href="#l25.8"></a><span id="l25.8">                   &lt;column flex=&quot;1&quot;/&gt;</span>
<a href="#l25.9"></a><span id="l25.9">               &lt;/columns&gt;</span>
<a href="#l25.10"></a><span id="l25.10">               &lt;rows&gt;</span>
<a href="#l25.11"></a><span id="l25.11">                   &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-                      &lt;hbox pack=&quot;end&quot;&gt;&lt;label value=&quot;&amp;serverDescription.label;&quot; accesskey=&quot;&amp;serverDescription.accesskey;&quot;</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-                                              control=&quot;smtp.description&quot;/&gt;&lt;/hbox&gt;</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+                       &lt;label value=&quot;&amp;serverDescription.label;&quot;</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+                              accesskey=&quot;&amp;serverDescription.accesskey;&quot;</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineplus">+                              control=&quot;smtp.description&quot;/&gt;</span>
<a href="#l25.17"></a><span id="l25.17">                        &lt;textbox id=&quot;smtp.description&quot; flex=&quot;1&quot; preftype=&quot;string&quot; prefstring=&quot;mail.smtpserver.%serverkey%.description&quot;/&gt;</span>
<a href="#l25.18"></a><span id="l25.18">                   &lt;/row&gt;</span>
<a href="#l25.19"></a><span id="l25.19"> </span>
<a href="#l25.20"></a><span id="l25.20">                   &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineminus">-                      &lt;hbox pack=&quot;end&quot;&gt;&lt;label value=&quot;&amp;serverName.label;&quot; accesskey=&quot;&amp;serverName.accesskey;&quot; control=&quot;smtp.hostname&quot;/&gt;&lt;/hbox&gt;</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineplus">+                      &lt;label value=&quot;&amp;serverName.label;&quot;</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineplus">+                             accesskey=&quot;&amp;serverName.accesskey;&quot;</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineplus">+                             control=&quot;smtp.hostname&quot;/&gt;</span>
<a href="#l25.25"></a><span id="l25.25">                       &lt;textbox id=&quot;smtp.hostname&quot; flex=&quot;1&quot; preftype=&quot;string&quot; class=&quot;uri-element&quot; prefstring=&quot;mail.smtpserver.%serverkey%.hostname&quot;/&gt;</span>
<a href="#l25.26"></a><span id="l25.26">                   &lt;/row&gt;</span>
<a href="#l25.27"></a><span id="l25.27">                   &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineminus">-                      &lt;hbox pack=&quot;end&quot;&gt;&lt;label value=&quot;&amp;serverPort.label;&quot; accesskey=&quot;&amp;serverPort.accesskey;&quot; control=&quot;smtp.port&quot;/&gt;</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineminus">-                      &lt;/hbox&gt;</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineminus">-</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineplus">+                      &lt;label value=&quot;&amp;serverPort.label;&quot;</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineplus">+                             accesskey=&quot;&amp;serverPort.accesskey;&quot;</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineplus">+                             control=&quot;smtp.port&quot;/&gt;</span>
<a href="#l25.34"></a><span id="l25.34">                       &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l25.35"></a><span id="l25.35">                           &lt;textbox id=&quot;smtp.port&quot; size=&quot;4&quot;</span>
<a href="#l25.36"></a><span id="l25.36">                                    preftype=&quot;int&quot;</span>
<a href="#l25.37"></a><span id="l25.37">                                    prefstring=&quot;mail.smtpserver.%serverkey%.port&quot;/&gt;</span>
<a href="#l25.38"></a><span id="l25.38">                           &lt;label value=&quot;&amp;serverPortDefault.label;&quot;/&gt;</span>
<a href="#l25.39"></a><span id="l25.39">                           &lt;label id=&quot;smtp.defaultPort&quot;/&gt;</span>
<a href="#l25.40"></a><span id="l25.40">                       &lt;/hbox&gt;</span>
<a href="#l25.41"></a><span id="l25.41">                   &lt;/row&gt;</span>
<a href="#l25.42"></a><span id="l25.42">               &lt;/rows&gt;</span>
<a href="#l25.43"></a><span id="l25.43">           &lt;/grid&gt;</span>
<a href="#l25.44"></a><span id="l25.44">       &lt;/groupbox&gt;</span>
<a href="#l25.45"></a><span id="l25.45"> </span>
<a href="#l25.46"></a><span id="l25.46">       &lt;separator class=&quot;thin&quot;/&gt;</span>
<a href="#l25.47"></a><span id="l25.47"> </span>
<a href="#l25.48"></a><span id="l25.48">       &lt;groupbox&gt;</span>
<a href="#l25.49"></a><span id="l25.49">         &lt;caption label=&quot;&amp;security.caption;&quot;/&gt;</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineminus">-        &lt;vbox&gt;</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineminus">-            &lt;!-- This hidden one will hold the integer version</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineminus">-                 of smtp.useUsername --&gt;</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineminus">-            &lt;label hidden=&quot;true&quot; id=&quot;smtp.authMethod&quot;/&gt;</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineminus">-            &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineminus">-            &lt;checkbox id=&quot;smtp.useUsername&quot; label=&quot;&amp;alwaysUseUsername.label;&quot;</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineminus">-                      accesskey=&quot;&amp;alwaysUseUsername.accesskey;&quot;</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineminus">-                      oncommand=&quot;onUseUsername(event.target,true);&quot;</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineminus">-                      prefattribute=&quot;value&quot;</span>
<a href="#l25.59"></a><span id="l25.59" class="difflineminus">-                      prefstring=&quot;mail.smtpserver.%serverkey%.use_username&quot;/&gt;</span>
<a href="#l25.60"></a><span id="l25.60" class="difflineminus">-            &lt;/hbox&gt;</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineminus">-            &lt;vbox class=&quot;indent&quot;&gt;</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineminus">-              &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l25.63"></a><span id="l25.63" class="difflineplus">+</span>
<a href="#l25.64"></a><span id="l25.64" class="difflineplus">+        &lt;grid flex=&quot;1&quot;&gt;</span>
<a href="#l25.65"></a><span id="l25.65" class="difflineplus">+          &lt;columns&gt;</span>
<a href="#l25.66"></a><span id="l25.66" class="difflineplus">+            &lt;column/&gt;</span>
<a href="#l25.67"></a><span id="l25.67" class="difflineplus">+            &lt;column flex=&quot;1&quot;/&gt;</span>
<a href="#l25.68"></a><span id="l25.68" class="difflineplus">+          &lt;/columns&gt;</span>
<a href="#l25.69"></a><span id="l25.69" class="difflineplus">+          &lt;rows&gt;</span>
<a href="#l25.70"></a><span id="l25.70" class="difflineplus">+            &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l25.71"></a><span id="l25.71" class="difflineplus">+              &lt;label value=&quot;&amp;connectionSecurity.label;&quot;</span>
<a href="#l25.72"></a><span id="l25.72" class="difflineplus">+                     accesskey=&quot;&amp;connectionSecurity.accesskey;&quot;</span>
<a href="#l25.73"></a><span id="l25.73" class="difflineplus">+                     control=&quot;smtp.socketType&quot;/&gt;</span>
<a href="#l25.74"></a><span id="l25.74" class="difflineplus">+              &lt;menulist id=&quot;smtp.socketType&quot; oncommand=&quot;sslChanged(true);&quot;</span>
<a href="#l25.75"></a><span id="l25.75" class="difflineplus">+                        prefstring=&quot;mail.smtpserver.%serverkey%.try_ssl&quot;&gt;</span>
<a href="#l25.76"></a><span id="l25.76" class="difflineplus">+                &lt;menupopup id=&quot;smtp.socketTypePopup&quot;&gt;</span>
<a href="#l25.77"></a><span id="l25.77" class="difflineplus">+                  &lt;menuitem value=&quot;0&quot; label=&quot;&amp;connectionSecurityType-0.label;&quot;/&gt;</span>
<a href="#l25.78"></a><span id="l25.78" class="difflineplus">+                  &lt;menuitem id=&quot;connectionSecurityType-1&quot;</span>
<a href="#l25.79"></a><span id="l25.79" class="difflineplus">+                            value=&quot;1&quot; label=&quot;&amp;connectionSecurityType-1.label;&quot;</span>
<a href="#l25.80"></a><span id="l25.80" class="difflineplus">+                            disabled=&quot;true&quot; hidden=&quot;true&quot;/&gt;</span>
<a href="#l25.81"></a><span id="l25.81" class="difflineplus">+                  &lt;menuitem value=&quot;2&quot; label=&quot;&amp;connectionSecurityType-2.label;&quot;/&gt;</span>
<a href="#l25.82"></a><span id="l25.82" class="difflineplus">+                  &lt;menuitem value=&quot;3&quot; label=&quot;&amp;connectionSecurityType-3.label;&quot;/&gt;</span>
<a href="#l25.83"></a><span id="l25.83" class="difflineplus">+                &lt;/menupopup&gt;</span>
<a href="#l25.84"></a><span id="l25.84" class="difflineplus">+              &lt;/menulist&gt;</span>
<a href="#l25.85"></a><span id="l25.85" class="difflineplus">+            &lt;/row&gt;</span>
<a href="#l25.86"></a><span id="l25.86" class="difflineplus">+            &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l25.87"></a><span id="l25.87" class="difflineplus">+              &lt;label value=&quot;&amp;authMethod.label;&quot;</span>
<a href="#l25.88"></a><span id="l25.88" class="difflineplus">+                     accesskey=&quot;&amp;authMethod.accesskey;&quot;</span>
<a href="#l25.89"></a><span id="l25.89" class="difflineplus">+                     control=&quot;server.authMethod&quot;/&gt;</span>
<a href="#l25.90"></a><span id="l25.90" class="difflineplus">+              &lt;!-- same in am-server.xul/js --&gt;</span>
<a href="#l25.91"></a><span id="l25.91" class="difflineplus">+              &lt;menulist id=&quot;smtp.authMethod&quot;</span>
<a href="#l25.92"></a><span id="l25.92" class="difflineplus">+                        oncommand=&quot;authMethodChanged(true);&quot;</span>
<a href="#l25.93"></a><span id="l25.93" class="difflineplus">+                        wsm_persist=&quot;true&quot;</span>
<a href="#l25.94"></a><span id="l25.94" class="difflineplus">+                        preftype=&quot;int&quot; type=&quot;number&quot;</span>
<a href="#l25.95"></a><span id="l25.95" class="difflineplus">+                        prefstring=&quot;mail.smtpserver.%serverkey%.authMethod&quot;&gt;</span>
<a href="#l25.96"></a><span id="l25.96" class="difflineplus">+                &lt;menupopup id=&quot;smtp.authMethodPopup&quot;&gt;</span>
<a href="#l25.97"></a><span id="l25.97" class="difflineplus">+                  &lt;menuitem id=&quot;authMethod-no&quot; value=&quot;1&quot;/&gt;</span>
<a href="#l25.98"></a><span id="l25.98" class="difflineplus">+                  &lt;menuitem id=&quot;authMethod-password-cleartext&quot; value=&quot;3&quot;/&gt;</span>
<a href="#l25.99"></a><span id="l25.99" class="difflineplus">+                  &lt;menuitem id=&quot;authMethod-password-encrypted&quot; value=&quot;4&quot;/&gt;</span>
<a href="#l25.100"></a><span id="l25.100" class="difflineplus">+                  &lt;menuitem id=&quot;authMethod-kerberos&quot; value=&quot;5&quot;/&gt;</span>
<a href="#l25.101"></a><span id="l25.101" class="difflineplus">+                  &lt;menuitem id=&quot;authMethod-ntlm&quot; value=&quot;6&quot;/&gt;</span>
<a href="#l25.102"></a><span id="l25.102" class="difflineplus">+                  &lt;menuitem id=&quot;authMethod-anysecure&quot; value=&quot;8&quot;/&gt;</span>
<a href="#l25.103"></a><span id="l25.103" class="difflineplus">+                  &lt;menuitem id=&quot;authMethod-any&quot; value=&quot;9&quot;/&gt;</span>
<a href="#l25.104"></a><span id="l25.104" class="difflineplus">+                &lt;/menupopup&gt;</span>
<a href="#l25.105"></a><span id="l25.105" class="difflineplus">+              &lt;/menulist&gt;</span>
<a href="#l25.106"></a><span id="l25.106" class="difflineplus">+            &lt;/row&gt;</span>
<a href="#l25.107"></a><span id="l25.107" class="difflineplus">+            &lt;row id=&quot;smtp.username.box&quot; align=&quot;center&quot;&gt;</span>
<a href="#l25.108"></a><span id="l25.108" class="difflineplus">+              &lt;hbox class=&quot;indent&quot;&gt;</span>
<a href="#l25.109"></a><span id="l25.109">                 &lt;label id=&quot;smtp.username.label&quot; value=&quot;&amp;userName.label;&quot;</span>
<a href="#l25.110"></a><span id="l25.110" class="difflineminus">-                       accesskey=&quot;&amp;userName.accesskey;&quot; control=&quot;smtp.username&quot;/&gt;</span>
<a href="#l25.111"></a><span id="l25.111" class="difflineminus">-                &lt;textbox id=&quot;smtp.username&quot; flex=&quot;1&quot;</span>
<a href="#l25.112"></a><span id="l25.112" class="difflineminus">-                         preftype=&quot;string&quot;</span>
<a href="#l25.113"></a><span id="l25.113" class="difflineminus">-                         prefstring=&quot;mail.smtpserver.%serverkey%.username&quot;/&gt;</span>
<a href="#l25.114"></a><span id="l25.114" class="difflineplus">+                       accesskey=&quot;&amp;userName.accesskey;&quot;</span>
<a href="#l25.115"></a><span id="l25.115" class="difflineplus">+                       control=&quot;smtp.username&quot;/&gt;</span>
<a href="#l25.116"></a><span id="l25.116">               &lt;/hbox&gt;</span>
<a href="#l25.117"></a><span id="l25.117" class="difflineminus">-              &lt;checkbox id=&quot;smtp.useSecAuth&quot;</span>
<a href="#l25.118"></a><span id="l25.118" class="difflineminus">-                        label=&quot;&amp;useSecAuth.label;&quot;</span>
<a href="#l25.119"></a><span id="l25.119" class="difflineminus">-                        accesskey=&quot;&amp;useSecAuth.accesskey;&quot;</span>
<a href="#l25.120"></a><span id="l25.120" class="difflineminus">-                        prefattribute=&quot;value&quot;</span>
<a href="#l25.121"></a><span id="l25.121" class="difflineminus">-                        prefstring=&quot;mail.smtpserver.%serverkey%.useSecAuth&quot;/&gt;</span>
<a href="#l25.122"></a><span id="l25.122" class="difflineminus">-            &lt;/vbox&gt;</span>
<a href="#l25.123"></a><span id="l25.123" class="difflineminus">-        &lt;/vbox&gt;</span>
<a href="#l25.124"></a><span id="l25.124" class="difflineminus">-</span>
<a href="#l25.125"></a><span id="l25.125" class="difflineminus">-        &lt;separator class=&quot;thin&quot;/&gt;</span>
<a href="#l25.126"></a><span id="l25.126" class="difflineminus">-</span>
<a href="#l25.127"></a><span id="l25.127" class="difflineminus">-        &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l25.128"></a><span id="l25.128" class="difflineminus">-          &lt;label value=&quot;&amp;connectionSecurity.label;&quot;</span>
<a href="#l25.129"></a><span id="l25.129" class="difflineminus">-                accesskey=&quot;&amp;connectionSecurity.accesskey;&quot;</span>
<a href="#l25.130"></a><span id="l25.130" class="difflineminus">-                control=&quot;smtp.trySSL&quot;/&gt;</span>
<a href="#l25.131"></a><span id="l25.131" class="difflineminus">-          &lt;menulist id=&quot;smtp.trySSL&quot; oncommand=&quot;selectProtocol(true);&quot;</span>
<a href="#l25.132"></a><span id="l25.132" class="difflineminus">-                    prefstring=&quot;mail.smtpserver.%serverkey%.try_ssl&quot;&gt;</span>
<a href="#l25.133"></a><span id="l25.133" class="difflineminus">-            &lt;menupopup id=&quot;smtp.trySSLPopup&quot;&gt;</span>
<a href="#l25.134"></a><span id="l25.134" class="difflineminus">-              &lt;menuitem value=&quot;0&quot; label=&quot;&amp;connectionSecurityType-0.label;&quot;/&gt;</span>
<a href="#l25.135"></a><span id="l25.135" class="difflineminus">-              &lt;menuitem id=&quot;connectionSecurityType-1&quot;</span>
<a href="#l25.136"></a><span id="l25.136" class="difflineminus">-                        value=&quot;1&quot; label=&quot;&amp;connectionSecurityType-1.label;&quot;</span>
<a href="#l25.137"></a><span id="l25.137" class="difflineminus">-                        disabled=&quot;true&quot; hidden=&quot;true&quot;/&gt;</span>
<a href="#l25.138"></a><span id="l25.138" class="difflineminus">-              &lt;menuitem value=&quot;2&quot; label=&quot;&amp;connectionSecurityType-2.label;&quot;/&gt;</span>
<a href="#l25.139"></a><span id="l25.139" class="difflineminus">-              &lt;menuitem value=&quot;3&quot; label=&quot;&amp;connectionSecurityType-3.label;&quot;/&gt;</span>
<a href="#l25.140"></a><span id="l25.140" class="difflineminus">-            &lt;/menupopup&gt;</span>
<a href="#l25.141"></a><span id="l25.141" class="difflineminus">-          &lt;/menulist&gt;</span>
<a href="#l25.142"></a><span id="l25.142" class="difflineminus">-        &lt;/hbox&gt;</span>
<a href="#l25.143"></a><span id="l25.143" class="difflineminus">-      &lt;/groupbox&gt;</span>
<a href="#l25.144"></a><span id="l25.144" class="difflineplus">+              &lt;textbox id=&quot;smtp.username&quot; flex=&quot;1&quot;</span>
<a href="#l25.145"></a><span id="l25.145" class="difflineplus">+                       preftype=&quot;string&quot;</span>
<a href="#l25.146"></a><span id="l25.146" class="difflineplus">+                       prefstring=&quot;mail.smtpserver.%serverkey%.username&quot;/&gt;</span>
<a href="#l25.147"></a><span id="l25.147" class="difflineplus">+            &lt;/row&gt;</span>
<a href="#l25.148"></a><span id="l25.148" class="difflineplus">+          &lt;/rows&gt;</span>
<a href="#l25.149"></a><span id="l25.149" class="difflineplus">+        &lt;/grid&gt;</span>
<a href="#l25.150"></a><span id="l25.150" class="difflineplus">+     &lt;/groupbox&gt;</span>
<a href="#l25.151"></a><span id="l25.151">   &lt;/vbox&gt;</span>
<a href="#l25.152"></a><span id="l25.152"> &lt;/overlay&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/base/public/MailNewsTypes2.idl</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/base/public/MailNewsTypes2.idl</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -36,16 +36,18 @@</span>
<a href="#l26.4"></a><span id="l26.4">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l26.5"></a><span id="l26.5"> </span>
<a href="#l26.6"></a><span id="l26.6"> typedef unsigned long nsMsgKey;</span>
<a href="#l26.7"></a><span id="l26.7"> typedef unsigned long nsMsgViewIndex;</span>
<a href="#l26.8"></a><span id="l26.8"> </span>
<a href="#l26.9"></a><span id="l26.9"> typedef long nsMsgSearchScopeValue;</span>
<a href="#l26.10"></a><span id="l26.10"> </span>
<a href="#l26.11"></a><span id="l26.11"> typedef long nsMsgPriorityValue;</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineplus">+typedef long nsMsgSocketTypeValue;</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+typedef long nsMsgAuthMethodValue;</span>
<a href="#l26.14"></a><span id="l26.14"> </span>
<a href="#l26.15"></a><span id="l26.15"> typedef unsigned long nsMsgJunkStatus;</span>
<a href="#l26.16"></a><span id="l26.16"> </span>
<a href="#l26.17"></a><span id="l26.17"> typedef unsigned long nsMsgJunkScore;</span>
<a href="#l26.18"></a><span id="l26.18"> </span>
<a href="#l26.19"></a><span id="l26.19"> [scriptable, uuid(94C0D8D8-2045-11d3-8A8F-0060B0FC04D2)]</span>
<a href="#l26.20"></a><span id="l26.20"> interface nsMsgPriority {</span>
<a href="#l26.21"></a><span id="l26.21">     const nsMsgPriorityValue notSet = 0;</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineat">@@ -54,14 +56,65 @@ interface nsMsgPriority {</span>
<a href="#l26.23"></a><span id="l26.23">     const nsMsgPriorityValue low = 3;</span>
<a href="#l26.24"></a><span id="l26.24">     const nsMsgPriorityValue normal = 4;</span>
<a href="#l26.25"></a><span id="l26.25">     const nsMsgPriorityValue high = 5;</span>
<a href="#l26.26"></a><span id="l26.26">     const nsMsgPriorityValue highest = 6;</span>
<a href="#l26.27"></a><span id="l26.27">     // the default for a priority picker</span>
<a href="#l26.28"></a><span id="l26.28">     const nsMsgPriorityValue Default = 4;</span>
<a href="#l26.29"></a><span id="l26.29"> };</span>
<a href="#l26.30"></a><span id="l26.30"> </span>
<a href="#l26.31"></a><span id="l26.31" class="difflineplus">+/**</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineplus">+ * Defines whether to use SSL or STARTTLS or not.</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineplus">+ * Used by @see nsIMsgIncomingServer.socketType</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineplus">+ * and @see nsISmtpServer.socketType</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineplus">+ */</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineplus">+[scriptable, uuid(bc78bc74-1b34-48e8-ac2b-968e8dff1aeb)]</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineplus">+interface nsMsgSocketType {</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineplus">+    /// No SSL or STARTTLS</span>
<a href="#l26.39"></a><span id="l26.39" class="difflineplus">+    const nsMsgSocketTypeValue plain = 0;</span>
<a href="#l26.40"></a><span id="l26.40" class="difflineplus">+    /// Use TLS via STARTTLS, but only if server offers it.</span>
<a href="#l26.41"></a><span id="l26.41" class="difflineplus">+    /// @deprecated This is vulnerable to MITM attacks</span>
<a href="#l26.42"></a><span id="l26.42" class="difflineplus">+    const nsMsgSocketTypeValue trySTARTTLS = 1;</span>
<a href="#l26.43"></a><span id="l26.43" class="difflineplus">+    /// Insist on TLS via STARTTLS.</span>
<a href="#l26.44"></a><span id="l26.44" class="difflineplus">+    /// Uses normal port.</span>
<a href="#l26.45"></a><span id="l26.45" class="difflineplus">+    const nsMsgSocketTypeValue alwaysSTARTTLS = 2;</span>
<a href="#l26.46"></a><span id="l26.46" class="difflineplus">+    /// Connect via SSL.</span>
<a href="#l26.47"></a><span id="l26.47" class="difflineplus">+    /// Needs special SSL port.</span>
<a href="#l26.48"></a><span id="l26.48" class="difflineplus">+    const nsMsgSocketTypeValue SSL = 3;</span>
<a href="#l26.49"></a><span id="l26.49" class="difflineplus">+};</span>
<a href="#l26.50"></a><span id="l26.50" class="difflineplus">+</span>
<a href="#l26.51"></a><span id="l26.51" class="difflineplus">+/**</span>
<a href="#l26.52"></a><span id="l26.52" class="difflineplus">+ * Defines which authentication schemes we should try.</span>
<a href="#l26.53"></a><span id="l26.53" class="difflineplus">+ * Used by @see nsIMsgIncomingServer.authMethod</span>
<a href="#l26.54"></a><span id="l26.54" class="difflineplus">+ * and @see nsISmtpServer.authMethod</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineplus">+ */</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineplus">+[scriptable, uuid(4a10e647-d179-4a53-b7ef-df575ff5f405)]</span>
<a href="#l26.57"></a><span id="l26.57" class="difflineplus">+interface nsMsgAuthMethod {</span>
<a href="#l26.58"></a><span id="l26.58" class="difflineplus">+    // 0 is intentionally undefined and invalid</span>
<a href="#l26.59"></a><span id="l26.59" class="difflineplus">+    /// No login needed. E.g. IP-address-based.</span>
<a href="#l26.60"></a><span id="l26.60" class="difflineplus">+    const nsMsgAuthMethodValue none = 1;</span>
<a href="#l26.61"></a><span id="l26.61" class="difflineplus">+    /// Do not use AUTH commands (e.g. AUTH=PLAIN),</span>
<a href="#l26.62"></a><span id="l26.62" class="difflineplus">+    /// but the original login commands that the protocol specified</span>
<a href="#l26.63"></a><span id="l26.63" class="difflineplus">+    /// (POP: &quot;USER&quot;/&quot;PASS&quot;, IMAP: &quot;login&quot;, not valid for SMTP)</span>
<a href="#l26.64"></a><span id="l26.64" class="difflineplus">+    const nsMsgAuthMethodValue old = 2;</span>
<a href="#l26.65"></a><span id="l26.65" class="difflineplus">+    /// password in the clear. AUTH=PLAIN/LOGIN or old-style login.</span>
<a href="#l26.66"></a><span id="l26.66" class="difflineplus">+    const nsMsgAuthMethodValue passwordCleartext = 3;</span>
<a href="#l26.67"></a><span id="l26.67" class="difflineplus">+    /// hashed password. CRAM-MD5, DIGEST-MD5</span>
<a href="#l26.68"></a><span id="l26.68" class="difflineplus">+    const nsMsgAuthMethodValue passwordEncrypted = 4;</span>
<a href="#l26.69"></a><span id="l26.69" class="difflineplus">+    /// Kerberos / GSSAPI (Unix single-signon)</span>
<a href="#l26.70"></a><span id="l26.70" class="difflineplus">+    const nsMsgAuthMethodValue GSSAPI = 5;</span>
<a href="#l26.71"></a><span id="l26.71" class="difflineplus">+    /// NTLM is a Windows single-singon scheme.</span>
<a href="#l26.72"></a><span id="l26.72" class="difflineplus">+    /// Includes MSN / Passport.net, which is the same with a different name.</span>
<a href="#l26.73"></a><span id="l26.73" class="difflineplus">+    const nsMsgAuthMethodValue NTLM = 6;</span>
<a href="#l26.74"></a><span id="l26.74" class="difflineplus">+    /// Encrypted password or Kerberos / GSSAPI or NTLM.</span>
<a href="#l26.75"></a><span id="l26.75" class="difflineplus">+    /// @deprecated - for migration only.</span>
<a href="#l26.76"></a><span id="l26.76" class="difflineplus">+    const nsMsgAuthMethodValue secure = 8;</span>
<a href="#l26.77"></a><span id="l26.77" class="difflineplus">+    /// Let us pick any of the auth types supported by the server.</span>
<a href="#l26.78"></a><span id="l26.78" class="difflineplus">+    /// Discouraged, because vulnerable to MITM attacks, even if server offers secure auth.</span>
<a href="#l26.79"></a><span id="l26.79" class="difflineplus">+    const nsMsgAuthMethodValue anything = 9;</span>
<a href="#l26.80"></a><span id="l26.80" class="difflineplus">+};</span>
<a href="#l26.81"></a><span id="l26.81" class="difflineplus">+</span>
<a href="#l26.82"></a><span id="l26.82"> typedef unsigned long nsMsgLabelValue;</span>
<a href="#l26.83"></a><span id="l26.83"> </span>
<a href="#l26.84"></a><span id="l26.84"> typedef long nsMsgViewSortOrderValue;</span>
<a href="#l26.85"></a><span id="l26.85"> typedef long nsMsgViewSortTypeValue;</span>
<a href="#l26.86"></a><span id="l26.86"> typedef long nsMsgViewTypeValue;</span>
<a href="#l26.87"></a><span id="l26.87"> typedef long nsMsgViewFlagsTypeValue;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgIncomingServer.idl</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgIncomingServer.idl</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -54,17 +54,17 @@ interface nsILocalFile;</span>
<a href="#l27.4"></a><span id="l27.4"> interface nsIURI;</span>
<a href="#l27.5"></a><span id="l27.5"> </span>
<a href="#l27.6"></a><span id="l27.6"> /*</span>
<a href="#l27.7"></a><span id="l27.7">  * Interface for incoming mail/news host</span>
<a href="#l27.8"></a><span id="l27.8">  * this is the base interface for all mail server types (imap, pop, nntp, etc)</span>
<a href="#l27.9"></a><span id="l27.9">  * often you will want to add extra interfaces that give you server-specific</span>
<a href="#l27.10"></a><span id="l27.10">  * attributes and methods.</span>
<a href="#l27.11"></a><span id="l27.11">  */</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-[scriptable, uuid(cca9b826-24d8-4b76-b229-b8b12f1ecbd5)]</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+[scriptable, uuid(798c89ed-2c25-4eaa-b34d-5b2c2ab62286)]</span>
<a href="#l27.14"></a><span id="l27.14"> interface nsIMsgIncomingServer : nsISupports {</span>
<a href="#l27.15"></a><span id="l27.15"> </span>
<a href="#l27.16"></a><span id="l27.16">   /**</span>
<a href="#l27.17"></a><span id="l27.17">    * internal pref key - guaranteed to be unique across all servers</span>
<a href="#l27.18"></a><span id="l27.18">    */</span>
<a href="#l27.19"></a><span id="l27.19">   attribute ACString key;</span>
<a href="#l27.20"></a><span id="l27.20"> </span>
<a href="#l27.21"></a><span id="l27.21">   /**</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineat">@@ -183,31 +183,31 @@ interface nsIMsgIncomingServer : nsISupp</span>
<a href="#l27.23"></a><span id="l27.23">      going off at the same time. */</span>
<a href="#l27.24"></a><span id="l27.24">   attribute boolean serverBusy;</span>
<a href="#l27.25"></a><span id="l27.25"> </span>
<a href="#l27.26"></a><span id="l27.26">   /**</span>
<a href="#l27.27"></a><span id="l27.27">    * Is the server using a secure channel (SSL or STARTTLS).</span>
<a href="#l27.28"></a><span id="l27.28">    */</span>
<a href="#l27.29"></a><span id="l27.29">   readonly attribute boolean isSecure;</span>
<a href="#l27.30"></a><span id="l27.30"> </span>
<a href="#l27.31"></a><span id="l27.31" class="difflineminus">-  /* should we use secure authentication? */</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineminus">-  attribute boolean useSecAuth;</span>
<a href="#l27.33"></a><span id="l27.33" class="difflineminus">-</span>
<a href="#l27.34"></a><span id="l27.34" class="difflineminus">-  const long defaultSocket = 0;</span>
<a href="#l27.35"></a><span id="l27.35" class="difflineminus">-  const long tryTLS = 1;</span>
<a href="#l27.36"></a><span id="l27.36" class="difflineminus">-  const long alwaysUseTLS = 2;</span>
<a href="#l27.37"></a><span id="l27.37" class="difflineminus">-  const long useSSL = 3;</span>
<a href="#l27.38"></a><span id="l27.38" class="difflineplus">+  /**</span>
<a href="#l27.39"></a><span id="l27.39" class="difflineplus">+   * Authentication mechanism.</span>
<a href="#l27.40"></a><span id="l27.40" class="difflineplus">+   *</span>
<a href="#l27.41"></a><span id="l27.41" class="difflineplus">+   * @see nsMsgAuthMethod (in MailNewsTypes2.idl)</span>
<a href="#l27.42"></a><span id="l27.42" class="difflineplus">+   * Same as &quot;mail.server...authMethod&quot; pref</span>
<a href="#l27.43"></a><span id="l27.43" class="difflineplus">+   */</span>
<a href="#l27.44"></a><span id="l27.44" class="difflineplus">+  attribute nsMsgAuthMethodValue authMethod;</span>
<a href="#l27.45"></a><span id="l27.45"> </span>
<a href="#l27.46"></a><span id="l27.46" class="difflineminus">-  /* use above values */</span>
<a href="#l27.47"></a><span id="l27.47" class="difflineminus">-  attribute long socketType;</span>
<a href="#l27.48"></a><span id="l27.48" class="difflineminus">-</span>
<a href="#l27.49"></a><span id="l27.49" class="difflineminus">-  /* if a logon mechanism fails, should we fallback to a different</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineminus">-     mechanism?</span>
<a href="#l27.51"></a><span id="l27.51" class="difflineminus">-  */</span>
<a href="#l27.52"></a><span id="l27.52" class="difflineminus">-  attribute boolean logonFallback;</span>
<a href="#l27.53"></a><span id="l27.53" class="difflineplus">+  /**</span>
<a href="#l27.54"></a><span id="l27.54" class="difflineplus">+   * Whether to SSL or STARTTLS or not</span>
<a href="#l27.55"></a><span id="l27.55" class="difflineplus">+   *</span>
<a href="#l27.56"></a><span id="l27.56" class="difflineplus">+   * @see nsMsgSocketType (in MailNewsTypes2.idl)</span>
<a href="#l27.57"></a><span id="l27.57" class="difflineplus">+   * Same as &quot;mail.server...socketType&quot; pref</span>
<a href="#l27.58"></a><span id="l27.58" class="difflineplus">+   */</span>
<a href="#l27.59"></a><span id="l27.59" class="difflineplus">+  attribute nsMsgSocketTypeValue socketType;</span>
<a href="#l27.60"></a><span id="l27.60"> </span>
<a href="#l27.61"></a><span id="l27.61">   /* dead code. */</span>
<a href="#l27.62"></a><span id="l27.62">   readonly attribute boolean isSecureServer;</span>
<a href="#l27.63"></a><span id="l27.63"> </span>
<a href="#l27.64"></a><span id="l27.64">   /* empty trash on exit */</span>
<a href="#l27.65"></a><span id="l27.65">   attribute boolean emptyTrashOnExit;</span>
<a href="#l27.66"></a><span id="l27.66"> </span>
<a href="#l27.67"></a><span id="l27.67">   /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/base/util/Makefile.in</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/base/util/Makefile.in</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -133,16 +133,17 @@ EXTRA_JS_MODULES = \</span>
<a href="#l28.4"></a><span id="l28.4"> 		errUtils.js \</span>
<a href="#l28.5"></a><span id="l28.5"> 		iteratorUtils.jsm \</span>
<a href="#l28.6"></a><span id="l28.6"> 		jsTreeSelection.js \</span>
<a href="#l28.7"></a><span id="l28.7"> 		traceHelper.js \</span>
<a href="#l28.8"></a><span id="l28.8"> 		autoconfigUtils.jsm \</span>
<a href="#l28.9"></a><span id="l28.9"> 		StringBundle.js \</span>
<a href="#l28.10"></a><span id="l28.10"> 		templateUtils.js \</span>
<a href="#l28.11"></a><span id="l28.11"> 		IOUtils.js \</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineplus">+		migration.jsm \</span>
<a href="#l28.13"></a><span id="l28.13"> 		$(NULL)</span>
<a href="#l28.14"></a><span id="l28.14"> </span>
<a href="#l28.15"></a><span id="l28.15"> ifndef MOZ_STATIC_MAIL_BUILD</span>
<a href="#l28.16"></a><span id="l28.16"> </span>
<a href="#l28.17"></a><span id="l28.17"> ifdef MOZILLA_INTERNAL_API</span>
<a href="#l28.18"></a><span id="l28.18"> EXTRA_DSO_LDOPTS = \</span>
<a href="#l28.19"></a><span id="l28.19"> 	$(LIBS_DIR) \</span>
<a href="#l28.20"></a><span id="l28.20"> 	$(MOZDEPTH)/rdf/util/src/internal/$(LIB_PREFIX)rdfutil_s.$(LIB_SUFFIX) \</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1">new file mode 100644</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineminus">--- /dev/null</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineplus">+++ b/mailnews/base/util/migration.jsm</span>
<a href="#l29.4"></a><span id="l29.4" class="difflineat">@@ -0,0 +1,131 @@</span>
<a href="#l29.5"></a><span id="l29.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l29.6"></a><span id="l29.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l29.7"></a><span id="l29.7" class="difflineplus">+ *</span>
<a href="#l29.8"></a><span id="l29.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l29.9"></a><span id="l29.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l29.10"></a><span id="l29.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l29.11"></a><span id="l29.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineplus">+ *</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineplus">+ * License.</span>
<a href="#l29.17"></a><span id="l29.17" class="difflineplus">+ *</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineplus">+ * The Original Code is autoconfig code.</span>
<a href="#l29.19"></a><span id="l29.19" class="difflineplus">+ *</span>
<a href="#l29.20"></a><span id="l29.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineplus">+ *   Ben Bucksch.</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2010</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l29.24"></a><span id="l29.24" class="difflineplus">+ *</span>
<a href="#l29.25"></a><span id="l29.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l29.26"></a><span id="l29.26" class="difflineplus">+ *</span>
<a href="#l29.27"></a><span id="l29.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l29.28"></a><span id="l29.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l29.29"></a><span id="l29.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l29.30"></a><span id="l29.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l29.31"></a><span id="l29.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l29.35"></a><span id="l29.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l29.36"></a><span id="l29.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l29.37"></a><span id="l29.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l29.38"></a><span id="l29.38" class="difflineplus">+ *</span>
<a href="#l29.39"></a><span id="l29.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l29.40"></a><span id="l29.40" class="difflineplus">+</span>
<a href="#l29.41"></a><span id="l29.41" class="difflineplus">+/**</span>
<a href="#l29.42"></a><span id="l29.42" class="difflineplus">+ * Migrate profile (prefs and other files) from older versions of Mailnews to</span>
<a href="#l29.43"></a><span id="l29.43" class="difflineplus">+ * current.</span>
<a href="#l29.44"></a><span id="l29.44" class="difflineplus">+ * This should be run at startup. It migrates as needed: each migration</span>
<a href="#l29.45"></a><span id="l29.45" class="difflineplus">+ * function should be written to be a no-op when the value is already migrated</span>
<a href="#l29.46"></a><span id="l29.46" class="difflineplus">+ * or was never used in the old version.</span>
<a href="#l29.47"></a><span id="l29.47" class="difflineplus">+ */</span>
<a href="#l29.48"></a><span id="l29.48" class="difflineplus">+</span>
<a href="#l29.49"></a><span id="l29.49" class="difflineplus">+var EXPORTED_SYMBOLS = [ &quot;migrateMailnews&quot; ];</span>
<a href="#l29.50"></a><span id="l29.50" class="difflineplus">+</span>
<a href="#l29.51"></a><span id="l29.51" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/errUtils.js&quot;);</span>
<a href="#l29.52"></a><span id="l29.52" class="difflineplus">+//Components.utils.import(&quot;resource://app/modules/Services.js&quot;);</span>
<a href="#l29.53"></a><span id="l29.53" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l29.54"></a><span id="l29.54" class="difflineplus">+var gPrefs;</span>
<a href="#l29.55"></a><span id="l29.55" class="difflineplus">+</span>
<a href="#l29.56"></a><span id="l29.56" class="difflineplus">+function migrateMailnews()</span>
<a href="#l29.57"></a><span id="l29.57" class="difflineplus">+{</span>
<a href="#l29.58"></a><span id="l29.58" class="difflineplus">+  try {</span>
<a href="#l29.59"></a><span id="l29.59" class="difflineplus">+    //gPrefs = Services.prefs; -- Gecko 1.9.3+</span>
<a href="#l29.60"></a><span id="l29.60" class="difflineplus">+    gPrefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l29.61"></a><span id="l29.61" class="difflineplus">+        .getService(Ci.nsIPrefBranch);</span>
<a href="#l29.62"></a><span id="l29.62" class="difflineplus">+</span>
<a href="#l29.63"></a><span id="l29.63" class="difflineplus">+    MigrateServerAuthPref();</span>
<a href="#l29.64"></a><span id="l29.64" class="difflineplus">+  } catch (e) { logException(e); }</span>
<a href="#l29.65"></a><span id="l29.65" class="difflineplus">+}</span>
<a href="#l29.66"></a><span id="l29.66" class="difflineplus">+</span>
<a href="#l29.67"></a><span id="l29.67" class="difflineplus">+/**</span>
<a href="#l29.68"></a><span id="l29.68" class="difflineplus">+ * Migrates from pref useSecAuth to pref authMethod</span>
<a href="#l29.69"></a><span id="l29.69" class="difflineplus">+ */</span>
<a href="#l29.70"></a><span id="l29.70" class="difflineplus">+function MigrateServerAuthPref()</span>
<a href="#l29.71"></a><span id="l29.71" class="difflineplus">+{</span>
<a href="#l29.72"></a><span id="l29.72" class="difflineplus">+  try {</span>
<a href="#l29.73"></a><span id="l29.73" class="difflineplus">+    // comma-separated list of all accounts.</span>
<a href="#l29.74"></a><span id="l29.74" class="difflineplus">+    var accounts = gPrefs.getCharPref(&quot;mail.accountmanager.accounts&quot;)</span>
<a href="#l29.75"></a><span id="l29.75" class="difflineplus">+        .split(&quot;,&quot;);</span>
<a href="#l29.76"></a><span id="l29.76" class="difflineplus">+    for (let i = 0; i &lt; accounts.length; i++)</span>
<a href="#l29.77"></a><span id="l29.77" class="difflineplus">+    {</span>
<a href="#l29.78"></a><span id="l29.78" class="difflineplus">+      let accountKey = accounts[i]; // e.g. &quot;account1&quot;</span>
<a href="#l29.79"></a><span id="l29.79" class="difflineplus">+      let serverKey = gPrefs.getCharPref(&quot;mail.account.&quot; + accountKey +</span>
<a href="#l29.80"></a><span id="l29.80" class="difflineplus">+         &quot;.server&quot;);</span>
<a href="#l29.81"></a><span id="l29.81" class="difflineplus">+      let server = &quot;mail.server.&quot; + serverKey + &quot;.&quot;;</span>
<a href="#l29.82"></a><span id="l29.82" class="difflineplus">+      if (gPrefs.prefHasUserValue(server + &quot;authMethod&quot;))</span>
<a href="#l29.83"></a><span id="l29.83" class="difflineplus">+        continue;</span>
<a href="#l29.84"></a><span id="l29.84" class="difflineplus">+      if (!gPrefs.prefHasUserValue(server + &quot;useSecAuth&quot;) &amp;&amp;</span>
<a href="#l29.85"></a><span id="l29.85" class="difflineplus">+          !gPrefs.prefHasUserValue(server + &quot;auth_login&quot;))</span>
<a href="#l29.86"></a><span id="l29.86" class="difflineplus">+        continue;</span>
<a href="#l29.87"></a><span id="l29.87" class="difflineplus">+      // auth_login = false =&gt; old-style auth</span>
<a href="#l29.88"></a><span id="l29.88" class="difflineplus">+      // else: useSecAuth = true =&gt; &quot;secure auth&quot;</span>
<a href="#l29.89"></a><span id="l29.89" class="difflineplus">+      // else: cleartext pw</span>
<a href="#l29.90"></a><span id="l29.90" class="difflineplus">+      let auth_login = true;</span>
<a href="#l29.91"></a><span id="l29.91" class="difflineplus">+      let useSecAuth = false; // old default, default pref now removed</span>
<a href="#l29.92"></a><span id="l29.92" class="difflineplus">+      try {</span>
<a href="#l29.93"></a><span id="l29.93" class="difflineplus">+        auth_login = gPrefs.getBoolPref(server + &quot;auth_login&quot;);</span>
<a href="#l29.94"></a><span id="l29.94" class="difflineplus">+      } catch (e) {}</span>
<a href="#l29.95"></a><span id="l29.95" class="difflineplus">+      try {</span>
<a href="#l29.96"></a><span id="l29.96" class="difflineplus">+        useSecAuth = gPrefs.getBoolPref(server + &quot;useSecAuth&quot;);</span>
<a href="#l29.97"></a><span id="l29.97" class="difflineplus">+      } catch (e) {}</span>
<a href="#l29.98"></a><span id="l29.98" class="difflineplus">+</span>
<a href="#l29.99"></a><span id="l29.99" class="difflineplus">+      gPrefs.setIntPref(server + &quot;authMethod&quot;,</span>
<a href="#l29.100"></a><span id="l29.100" class="difflineplus">+          auth_login ? (useSecAuth ?</span>
<a href="#l29.101"></a><span id="l29.101" class="difflineplus">+                           Ci.nsMsgAuthMethod.secure :</span>
<a href="#l29.102"></a><span id="l29.102" class="difflineplus">+                           Ci.nsMsgAuthMethod.passwordCleartext) :</span>
<a href="#l29.103"></a><span id="l29.103" class="difflineplus">+                       Ci.nsMsgAuthMethod.old);</span>
<a href="#l29.104"></a><span id="l29.104" class="difflineplus">+    }</span>
<a href="#l29.105"></a><span id="l29.105" class="difflineplus">+</span>
<a href="#l29.106"></a><span id="l29.106" class="difflineplus">+    // same again for SMTP servers</span>
<a href="#l29.107"></a><span id="l29.107" class="difflineplus">+    var smtpservers = gPrefs.getCharPref(&quot;mail.smtpservers&quot;).split(&quot;,&quot;);</span>
<a href="#l29.108"></a><span id="l29.108" class="difflineplus">+    for (let i = 0; i &lt; smtpservers.length; i++)</span>
<a href="#l29.109"></a><span id="l29.109" class="difflineplus">+    {</span>
<a href="#l29.110"></a><span id="l29.110" class="difflineplus">+      let server = &quot;mail.smtpserver.&quot; + smtpservers[i] + &quot;.&quot;;</span>
<a href="#l29.111"></a><span id="l29.111" class="difflineplus">+      if (gPrefs.prefHasUserValue(server + &quot;authMethod&quot;))</span>
<a href="#l29.112"></a><span id="l29.112" class="difflineplus">+        continue;</span>
<a href="#l29.113"></a><span id="l29.113" class="difflineplus">+      if (!gPrefs.prefHasUserValue(server + &quot;useSecAuth&quot;) &amp;&amp;</span>
<a href="#l29.114"></a><span id="l29.114" class="difflineplus">+          !gPrefs.prefHasUserValue(server + &quot;auth_method&quot;))</span>
<a href="#l29.115"></a><span id="l29.115" class="difflineplus">+        continue;</span>
<a href="#l29.116"></a><span id="l29.116" class="difflineplus">+      // auth_method = 0 =&gt; no auth</span>
<a href="#l29.117"></a><span id="l29.117" class="difflineplus">+      // else: useSecAuth = true =&gt; &quot;secure auth&quot;</span>
<a href="#l29.118"></a><span id="l29.118" class="difflineplus">+      // else: cleartext pw</span>
<a href="#l29.119"></a><span id="l29.119" class="difflineplus">+      let auth_method = 1;</span>
<a href="#l29.120"></a><span id="l29.120" class="difflineplus">+      let useSecAuth = false;</span>
<a href="#l29.121"></a><span id="l29.121" class="difflineplus">+      try {</span>
<a href="#l29.122"></a><span id="l29.122" class="difflineplus">+        auth_method = gPrefs.getIntPref(server + &quot;auth_method&quot;);</span>
<a href="#l29.123"></a><span id="l29.123" class="difflineplus">+      } catch (e) {}</span>
<a href="#l29.124"></a><span id="l29.124" class="difflineplus">+      try {</span>
<a href="#l29.125"></a><span id="l29.125" class="difflineplus">+        useSecAuth = gPrefs.getBoolPref(server + &quot;useSecAuth&quot;);</span>
<a href="#l29.126"></a><span id="l29.126" class="difflineplus">+      } catch (e) {}</span>
<a href="#l29.127"></a><span id="l29.127" class="difflineplus">+</span>
<a href="#l29.128"></a><span id="l29.128" class="difflineplus">+      gPrefs.setIntPref(server + &quot;authMethod&quot;,</span>
<a href="#l29.129"></a><span id="l29.129" class="difflineplus">+          auth_method ? (useSecAuth ?</span>
<a href="#l29.130"></a><span id="l29.130" class="difflineplus">+                            Ci.nsMsgAuthMethod.secure :</span>
<a href="#l29.131"></a><span id="l29.131" class="difflineplus">+                            Ci.nsMsgAuthMethod.passwordCleartext) :</span>
<a href="#l29.132"></a><span id="l29.132" class="difflineplus">+                        Ci.nsMsgAuthMethod.none);</span>
<a href="#l29.133"></a><span id="l29.133" class="difflineplus">+    }</span>
<a href="#l29.134"></a><span id="l29.134" class="difflineplus">+  } catch(e) { logException(e); }</span>
<a href="#l29.135"></a><span id="l29.135" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/base/util/nsMsgIncomingServer.cpp</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgIncomingServer.cpp</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -1370,33 +1370,33 @@ nsMsgIncomingServer::GetPort(PRInt32 *aP</span>
<a href="#l30.4"></a><span id="l30.4">   // port based on the protocol</span>
<a href="#l30.5"></a><span id="l30.5">   nsCOMPtr&lt;nsIMsgProtocolInfo&gt; protocolInfo;</span>
<a href="#l30.6"></a><span id="l30.6">   rv = getProtocolInfo(getter_AddRefs(protocolInfo));</span>
<a href="#l30.7"></a><span id="l30.7">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.8"></a><span id="l30.8"> </span>
<a href="#l30.9"></a><span id="l30.9">   PRInt32 socketType;</span>
<a href="#l30.10"></a><span id="l30.10">   rv = GetSocketType(&amp;socketType);</span>
<a href="#l30.11"></a><span id="l30.11">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-  PRBool useSSLPort = (socketType == nsIMsgIncomingServer::useSSL);</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+  PRBool useSSLPort = (socketType == nsMsgSocketType::SSL);</span>
<a href="#l30.14"></a><span id="l30.14">   return protocolInfo-&gt;GetDefaultServerPort(useSSLPort, aPort);</span>
<a href="#l30.15"></a><span id="l30.15"> }</span>
<a href="#l30.16"></a><span id="l30.16"> </span>
<a href="#l30.17"></a><span id="l30.17"> NS_IMETHODIMP</span>
<a href="#l30.18"></a><span id="l30.18"> nsMsgIncomingServer::SetPort(PRInt32 aPort)</span>
<a href="#l30.19"></a><span id="l30.19"> {</span>
<a href="#l30.20"></a><span id="l30.20">   nsresult rv;</span>
<a href="#l30.21"></a><span id="l30.21"> </span>
<a href="#l30.22"></a><span id="l30.22">   nsCOMPtr&lt;nsIMsgProtocolInfo&gt; protocolInfo;</span>
<a href="#l30.23"></a><span id="l30.23">   rv = getProtocolInfo(getter_AddRefs(protocolInfo));</span>
<a href="#l30.24"></a><span id="l30.24">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.25"></a><span id="l30.25"> </span>
<a href="#l30.26"></a><span id="l30.26">   PRInt32 socketType;</span>
<a href="#l30.27"></a><span id="l30.27">   rv = GetSocketType(&amp;socketType);</span>
<a href="#l30.28"></a><span id="l30.28">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineminus">-  PRBool useSSLPort = (socketType == nsIMsgIncomingServer::useSSL);</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineplus">+  PRBool useSSLPort = (socketType == nsMsgSocketType::SSL);</span>
<a href="#l30.31"></a><span id="l30.31"> </span>
<a href="#l30.32"></a><span id="l30.32">   PRInt32 defaultPort;</span>
<a href="#l30.33"></a><span id="l30.33">   protocolInfo-&gt;GetDefaultServerPort(useSSLPort, &amp;defaultPort);</span>
<a href="#l30.34"></a><span id="l30.34">   return SetIntValue(&quot;port&quot;, aPort == defaultPort ? PORT_NOT_SET : aPort);</span>
<a href="#l30.35"></a><span id="l30.35"> }</span>
<a href="#l30.36"></a><span id="l30.36"> </span>
<a href="#l30.37"></a><span id="l30.37"> nsresult</span>
<a href="#l30.38"></a><span id="l30.38"> nsMsgIncomingServer::getProtocolInfo(nsIMsgProtocolInfo **aResult)</span>
<a href="#l30.39"></a><span id="l30.39" class="difflineat">@@ -1637,25 +1637,24 @@ nsMsgIncomingServer::GetSearchScope(nsMs</span>
<a href="#l30.40"></a><span id="l30.40"> </span>
<a href="#l30.41"></a><span id="l30.41"> NS_IMETHODIMP</span>
<a href="#l30.42"></a><span id="l30.42"> nsMsgIncomingServer::GetIsSecure(PRBool *aIsSecure)</span>
<a href="#l30.43"></a><span id="l30.43"> {</span>
<a href="#l30.44"></a><span id="l30.44">   NS_ENSURE_ARG_POINTER(aIsSecure);</span>
<a href="#l30.45"></a><span id="l30.45">   PRInt32 socketType;</span>
<a href="#l30.46"></a><span id="l30.46">   nsresult rv = GetSocketType(&amp;socketType);</span>
<a href="#l30.47"></a><span id="l30.47">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l30.48"></a><span id="l30.48" class="difflineminus">-  *aIsSecure = (socketType == nsIMsgIncomingServer::alwaysUseTLS ||</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineminus">-                socketType == nsIMsgIncomingServer::useSSL);</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineplus">+  *aIsSecure = (socketType == nsMsgSocketType::alwaysSTARTTLS ||</span>
<a href="#l30.51"></a><span id="l30.51" class="difflineplus">+                socketType == nsMsgSocketType::SSL);</span>
<a href="#l30.52"></a><span id="l30.52">   return NS_OK;</span>
<a href="#l30.53"></a><span id="l30.53"> }</span>
<a href="#l30.54"></a><span id="l30.54"> </span>
<a href="#l30.55"></a><span id="l30.55"> // use the convenience macros to implement the accessors</span>
<a href="#l30.56"></a><span id="l30.56"> NS_IMPL_SERVERPREF_STR(nsMsgIncomingServer, Username, &quot;userName&quot;)</span>
<a href="#l30.57"></a><span id="l30.57" class="difflineminus">-NS_IMPL_SERVERPREF_BOOL(nsMsgIncomingServer, UseSecAuth, &quot;useSecAuth&quot;)</span>
<a href="#l30.58"></a><span id="l30.58" class="difflineminus">-NS_IMPL_SERVERPREF_BOOL(nsMsgIncomingServer, LogonFallback, &quot;logon_fallback&quot;)</span>
<a href="#l30.59"></a><span id="l30.59" class="difflineplus">+NS_IMPL_SERVERPREF_INT(nsMsgIncomingServer, AuthMethod, &quot;authMethod&quot;)</span>
<a href="#l30.60"></a><span id="l30.60"> NS_IMPL_SERVERPREF_INT(nsMsgIncomingServer, BiffMinutes, &quot;check_time&quot;)</span>
<a href="#l30.61"></a><span id="l30.61"> NS_IMPL_SERVERPREF_STR(nsMsgIncomingServer, Type, &quot;type&quot;)</span>
<a href="#l30.62"></a><span id="l30.62"> // in 4.x, this was &quot;mail.pop3_gets_new_mail&quot; for pop and</span>
<a href="#l30.63"></a><span id="l30.63"> // &quot;mail.imap.new_mail_get_headers&quot; for imap (it was global)</span>
<a href="#l30.64"></a><span id="l30.64"> // in 5.0, this will be per server, and it will be &quot;download_on_biff&quot;</span>
<a href="#l30.65"></a><span id="l30.65"> NS_IMPL_SERVERPREF_BOOL(nsMsgIncomingServer, DownloadOnBiff, &quot;download_on_biff&quot;)</span>
<a href="#l30.66"></a><span id="l30.66"> NS_IMPL_SERVERPREF_BOOL(nsMsgIncomingServer, Valid, &quot;valid&quot;)</span>
<a href="#l30.67"></a><span id="l30.67"> NS_IMPL_SERVERPREF_BOOL(nsMsgIncomingServer, EmptyTrashOnExit,</span>
<a href="#l30.68"></a><span id="l30.68" class="difflineat">@@ -1695,47 +1694,47 @@ NS_IMETHODIMP nsMsgIncomingServer::GetSo</span>
<a href="#l30.69"></a><span id="l30.69"> </span>
<a href="#l30.70"></a><span id="l30.70">   // socketType is set to default value. Look at isSecure setting</span>
<a href="#l30.71"></a><span id="l30.71">   if (NS_FAILED(rv))</span>
<a href="#l30.72"></a><span id="l30.72">   {</span>
<a href="#l30.73"></a><span id="l30.73">     PRBool isSecure;</span>
<a href="#l30.74"></a><span id="l30.74">     rv = mPrefBranch-&gt;GetBoolPref(&quot;isSecure&quot;, &amp;isSecure);</span>
<a href="#l30.75"></a><span id="l30.75">     if (NS_SUCCEEDED(rv) &amp;&amp; isSecure)</span>
<a href="#l30.76"></a><span id="l30.76">     {</span>
<a href="#l30.77"></a><span id="l30.77" class="difflineminus">-      *aSocketType = nsIMsgIncomingServer::useSSL;</span>
<a href="#l30.78"></a><span id="l30.78" class="difflineplus">+      *aSocketType = nsMsgSocketType::SSL;</span>
<a href="#l30.79"></a><span id="l30.79">       // don't call virtual method in case overrides call GetSocketType</span>
<a href="#l30.80"></a><span id="l30.80">       nsMsgIncomingServer::SetSocketType(*aSocketType);</span>
<a href="#l30.81"></a><span id="l30.81">     }</span>
<a href="#l30.82"></a><span id="l30.82">     else</span>
<a href="#l30.83"></a><span id="l30.83">     {</span>
<a href="#l30.84"></a><span id="l30.84">       if (!mDefPrefBranch)</span>
<a href="#l30.85"></a><span id="l30.85">         return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l30.86"></a><span id="l30.86">       rv = mDefPrefBranch-&gt;GetIntPref(&quot;socketType&quot;, aSocketType);</span>
<a href="#l30.87"></a><span id="l30.87">       if (NS_FAILED(rv))</span>
<a href="#l30.88"></a><span id="l30.88" class="difflineminus">-        *aSocketType = nsIMsgIncomingServer::defaultSocket;</span>
<a href="#l30.89"></a><span id="l30.89" class="difflineplus">+        *aSocketType = nsMsgSocketType::plain;</span>
<a href="#l30.90"></a><span id="l30.90">     }</span>
<a href="#l30.91"></a><span id="l30.91">   }</span>
<a href="#l30.92"></a><span id="l30.92">   return rv;</span>
<a href="#l30.93"></a><span id="l30.93"> }</span>
<a href="#l30.94"></a><span id="l30.94"> </span>
<a href="#l30.95"></a><span id="l30.95"> NS_IMETHODIMP nsMsgIncomingServer::SetSocketType(PRInt32 aSocketType)</span>
<a href="#l30.96"></a><span id="l30.96"> {</span>
<a href="#l30.97"></a><span id="l30.97">   if (!mPrefBranch)</span>
<a href="#l30.98"></a><span id="l30.98">     return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l30.99"></a><span id="l30.99"> </span>
<a href="#l30.100"></a><span id="l30.100" class="difflineminus">-  PRInt32 socketType = nsIMsgIncomingServer::defaultSocket;</span>
<a href="#l30.101"></a><span id="l30.101" class="difflineplus">+  PRInt32 socketType = nsMsgSocketType::plain;</span>
<a href="#l30.102"></a><span id="l30.102">   mPrefBranch-&gt;GetIntPref(&quot;socketType&quot;, &amp;socketType);</span>
<a href="#l30.103"></a><span id="l30.103"> </span>
<a href="#l30.104"></a><span id="l30.104">   nsresult rv = mPrefBranch-&gt;SetIntPref(&quot;socketType&quot;, aSocketType);</span>
<a href="#l30.105"></a><span id="l30.105">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.106"></a><span id="l30.106"> </span>
<a href="#l30.107"></a><span id="l30.107" class="difflineminus">-  PRBool isSecureOld = (socketType == nsIMsgIncomingServer::alwaysUseTLS ||</span>
<a href="#l30.108"></a><span id="l30.108" class="difflineminus">-                        socketType == nsIMsgIncomingServer::useSSL);</span>
<a href="#l30.109"></a><span id="l30.109" class="difflineminus">-  PRBool isSecureNew = (aSocketType == nsIMsgIncomingServer::alwaysUseTLS ||</span>
<a href="#l30.110"></a><span id="l30.110" class="difflineminus">-                        aSocketType == nsIMsgIncomingServer::useSSL);</span>
<a href="#l30.111"></a><span id="l30.111" class="difflineplus">+  PRBool isSecureOld = (socketType == nsMsgSocketType::alwaysSTARTTLS ||</span>
<a href="#l30.112"></a><span id="l30.112" class="difflineplus">+                        socketType == nsMsgSocketType::SSL);</span>
<a href="#l30.113"></a><span id="l30.113" class="difflineplus">+  PRBool isSecureNew = (aSocketType == nsMsgSocketType::alwaysSTARTTLS ||</span>
<a href="#l30.114"></a><span id="l30.114" class="difflineplus">+                        aSocketType == nsMsgSocketType::SSL);</span>
<a href="#l30.115"></a><span id="l30.115">   if ((isSecureOld != isSecureNew) &amp;&amp; m_rootFolder)</span>
<a href="#l30.116"></a><span id="l30.116">     m_rootFolder-&gt;NotifyBoolPropertyChanged(NS_NewAtom(&quot;isSecure&quot;),</span>
<a href="#l30.117"></a><span id="l30.117">                                             isSecureOld, isSecureNew);</span>
<a href="#l30.118"></a><span id="l30.118">   return NS_OK;</span>
<a href="#l30.119"></a><span id="l30.119"> }</span>
<a href="#l30.120"></a><span id="l30.120"> </span>
<a href="#l30.121"></a><span id="l30.121"> // Check if the password is available and return a boolean indicating whether</span>
<a href="#l30.122"></a><span id="l30.122"> // it is being authenticated or not.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/base/util/nsMsgProtocol.cpp</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgProtocol.cpp</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -830,16 +830,19 @@ nsresult nsMsgProtocol::PostMessage(nsIU</span>
<a href="#l31.4"></a><span id="l31.4">   } while (more);</span>
<a href="#l31.5"></a><span id="l31.5"> </span>
<a href="#l31.6"></a><span id="l31.6">   return NS_OK;</span>
<a href="#l31.7"></a><span id="l31.7"> }</span>
<a href="#l31.8"></a><span id="l31.8"> </span>
<a href="#l31.9"></a><span id="l31.9"> nsresult nsMsgProtocol::DoGSSAPIStep1(const char *service, const char *username, nsCString &amp;response)</span>
<a href="#l31.10"></a><span id="l31.10"> {</span>
<a href="#l31.11"></a><span id="l31.11">     nsresult rv;</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineplus">+#ifdef DEBUG_BenB</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+    printf(&quot;GSSAPI step 1 for service %s, username %s\n&quot;, service, username);</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineplus">+#endif</span>
<a href="#l31.15"></a><span id="l31.15"> </span>
<a href="#l31.16"></a><span id="l31.16">     // if this fails, then it means that we cannot do GSSAPI SASL.</span>
<a href="#l31.17"></a><span id="l31.17">     m_authModule = do_CreateInstance(NS_AUTH_MODULE_CONTRACTID_PREFIX &quot;sasl-gssapi&quot;, &amp;rv);</span>
<a href="#l31.18"></a><span id="l31.18">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l31.19"></a><span id="l31.19"> </span>
<a href="#l31.20"></a><span id="l31.20">     m_authModule-&gt;Init(service, nsIAuthModule::REQ_DEFAULT, nsnull, NS_ConvertUTF8toUTF16(username).get(), nsnull);</span>
<a href="#l31.21"></a><span id="l31.21"> </span>
<a href="#l31.22"></a><span id="l31.22">     void *outBuf;</span>
<a href="#l31.23"></a><span id="l31.23" class="difflineat">@@ -850,21 +853,27 @@ nsresult nsMsgProtocol::DoGSSAPIStep1(co</span>
<a href="#l31.24"></a><span id="l31.24">         char *base64Str = PL_Base64Encode((char *)outBuf, outBufLen, nsnull);</span>
<a href="#l31.25"></a><span id="l31.25">         if (base64Str)</span>
<a href="#l31.26"></a><span id="l31.26">             response.Adopt(base64Str);</span>
<a href="#l31.27"></a><span id="l31.27">         else</span>
<a href="#l31.28"></a><span id="l31.28">             rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l31.29"></a><span id="l31.29">         nsMemory::Free(outBuf);</span>
<a href="#l31.30"></a><span id="l31.30">     }</span>
<a href="#l31.31"></a><span id="l31.31"> </span>
<a href="#l31.32"></a><span id="l31.32" class="difflineplus">+#ifdef DEBUG_BenB</span>
<a href="#l31.33"></a><span id="l31.33" class="difflineplus">+    printf(&quot;GSSAPI step 1 succeeded\n&quot;);</span>
<a href="#l31.34"></a><span id="l31.34" class="difflineplus">+#endif</span>
<a href="#l31.35"></a><span id="l31.35">     return rv;</span>
<a href="#l31.36"></a><span id="l31.36"> }</span>
<a href="#l31.37"></a><span id="l31.37"> </span>
<a href="#l31.38"></a><span id="l31.38"> nsresult nsMsgProtocol::DoGSSAPIStep2(nsCString &amp;commandResponse, nsCString &amp;response)</span>
<a href="#l31.39"></a><span id="l31.39"> {</span>
<a href="#l31.40"></a><span id="l31.40" class="difflineplus">+#ifdef DEBUG_BenB</span>
<a href="#l31.41"></a><span id="l31.41" class="difflineplus">+    printf(&quot;GSSAPI step 2\n&quot;);</span>
<a href="#l31.42"></a><span id="l31.42" class="difflineplus">+#endif</span>
<a href="#l31.43"></a><span id="l31.43">     nsresult rv;</span>
<a href="#l31.44"></a><span id="l31.44">     void *inBuf, *outBuf;</span>
<a href="#l31.45"></a><span id="l31.45">     PRUint32 inBufLen, outBufLen;</span>
<a href="#l31.46"></a><span id="l31.46">     PRUint32 len = commandResponse.Length();</span>
<a href="#l31.47"></a><span id="l31.47"> </span>
<a href="#l31.48"></a><span id="l31.48">     // Cyrus SASL may send us zero length tokens (grrrr)</span>
<a href="#l31.49"></a><span id="l31.49">     if (len &gt; 0) {</span>
<a href="#l31.50"></a><span id="l31.50">         // decode into the input secbuffer</span>
<a href="#l31.51"></a><span id="l31.51" class="difflineat">@@ -908,16 +917,19 @@ nsresult nsMsgProtocol::DoGSSAPIStep2(ns</span>
<a href="#l31.52"></a><span id="l31.52">                 response.Adopt(base64Str);</span>
<a href="#l31.53"></a><span id="l31.53">             else</span>
<a href="#l31.54"></a><span id="l31.54">                 rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l31.55"></a><span id="l31.55">         }</span>
<a href="#l31.56"></a><span id="l31.56">         else</span>
<a href="#l31.57"></a><span id="l31.57">             response.Adopt((char *)nsMemory::Clone(&quot;&quot;,1));</span>
<a href="#l31.58"></a><span id="l31.58">     }</span>
<a href="#l31.59"></a><span id="l31.59"> </span>
<a href="#l31.60"></a><span id="l31.60" class="difflineplus">+#ifdef DEBUG_BenB</span>
<a href="#l31.61"></a><span id="l31.61" class="difflineplus">+    printf(NS_SUCCEEDED(rv) ? &quot;GSSAPI step 2 succeeded\n&quot; : &quot;GSSAPI step 2 failed\n&quot;);</span>
<a href="#l31.62"></a><span id="l31.62" class="difflineplus">+#endif</span>
<a href="#l31.63"></a><span id="l31.63">     return rv;</span>
<a href="#l31.64"></a><span id="l31.64"> }</span>
<a href="#l31.65"></a><span id="l31.65"> </span>
<a href="#l31.66"></a><span id="l31.66"> nsresult nsMsgProtocol::DoNtlmStep1(const char *username, const char *password, nsCString &amp;response)</span>
<a href="#l31.67"></a><span id="l31.67"> {</span>
<a href="#l31.68"></a><span id="l31.68">     nsresult rv;</span>
<a href="#l31.69"></a><span id="l31.69"> </span>
<a href="#l31.70"></a><span id="l31.70">     m_authModule = do_CreateInstance(NS_AUTH_MODULE_CONTRACTID_PREFIX &quot;ntlm&quot;, &amp;rv);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/compose/public/nsISmtpServer.idl</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/compose/public/nsISmtpServer.idl</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -32,30 +32,31 @@</span>
<a href="#l32.4"></a><span id="l32.4">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l32.5"></a><span id="l32.5">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l32.6"></a><span id="l32.6">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l32.7"></a><span id="l32.7">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l32.8"></a><span id="l32.8">  *</span>
<a href="#l32.9"></a><span id="l32.9">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l32.10"></a><span id="l32.10"> </span>
<a href="#l32.11"></a><span id="l32.11"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineplus">+#include &quot;MailNewsTypes2.idl&quot;</span>
<a href="#l32.13"></a><span id="l32.13"> </span>
<a href="#l32.14"></a><span id="l32.14"> interface nsIAuthPrompt;</span>
<a href="#l32.15"></a><span id="l32.15"> interface nsIUrlListener;</span>
<a href="#l32.16"></a><span id="l32.16"> interface nsIURI;</span>
<a href="#l32.17"></a><span id="l32.17"> interface nsIMsgWindow;</span>
<a href="#l32.18"></a><span id="l32.18"> </span>
<a href="#l32.19"></a><span id="l32.19"> /**</span>
<a href="#l32.20"></a><span id="l32.20">  * This interface represents a single SMTP Server. A SMTP server instance may be</span>
<a href="#l32.21"></a><span id="l32.21">  * created/obtained from nsIMsgAccountManager.</span>
<a href="#l32.22"></a><span id="l32.22">  *</span>
<a href="#l32.23"></a><span id="l32.23">  * Most of the attributes will set/get preferences from the main preferences</span>
<a href="#l32.24"></a><span id="l32.24">  * file.</span>
<a href="#l32.25"></a><span id="l32.25">  */</span>
<a href="#l32.26"></a><span id="l32.26" class="difflineminus">-[scriptable, uuid(cf300e82-9def-43b0-b663-be08437960eb)]</span>
<a href="#l32.27"></a><span id="l32.27" class="difflineplus">+[scriptable, uuid(a53dce6c-cd81-495c-83bc-45a65df1f08e)]</span>
<a href="#l32.28"></a><span id="l32.28"> interface nsISmtpServer : nsISupports {</span>
<a href="#l32.29"></a><span id="l32.29"> </span>
<a href="#l32.30"></a><span id="l32.30">   /// A unique identifier for the server.</span>
<a href="#l32.31"></a><span id="l32.31">   attribute string key;</span>
<a href="#l32.32"></a><span id="l32.32"> </span>
<a href="#l32.33"></a><span id="l32.33">   /// A user supplied description for the server.</span>
<a href="#l32.34"></a><span id="l32.34">   attribute AUTF8String description;</span>
<a href="#l32.35"></a><span id="l32.35"> </span>
<a href="#l32.36"></a><span id="l32.36" class="difflineat">@@ -76,37 +77,32 @@ interface nsISmtpServer : nsISupports {</span>
<a href="#l32.37"></a><span id="l32.37">    * the sending password.</span>
<a href="#l32.38"></a><span id="l32.38">    */</span>
<a href="#l32.39"></a><span id="l32.39">   attribute ACString password;</span>
<a href="#l32.40"></a><span id="l32.40"> </span>
<a href="#l32.41"></a><span id="l32.41">   /// Returns a displayname of the format hostname:port or just hostname</span>
<a href="#l32.42"></a><span id="l32.42">   readonly attribute string displayname;</span>
<a href="#l32.43"></a><span id="l32.43"> </span>
<a href="#l32.44"></a><span id="l32.44">   /**</span>
<a href="#l32.45"></a><span id="l32.45" class="difflineminus">-   * Whether or not to use authentication for this server.</span>
<a href="#l32.46"></a><span id="l32.46" class="difflineminus">-   * 0 = no authentication, 1 = use authentication.</span>
<a href="#l32.47"></a><span id="l32.47" class="difflineminus">-   * Reflects the mail.smtpserver.*.auth_method pref (default has value 1).</span>
<a href="#l32.48"></a><span id="l32.48" class="difflineplus">+   * Authentication mechanism.</span>
<a href="#l32.49"></a><span id="l32.49" class="difflineplus">+   *</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineplus">+   * @see nsMsgAuthMethod (in MailNewsTypes2.idl)</span>
<a href="#l32.51"></a><span id="l32.51" class="difflineplus">+   * Same as &quot;mail.smtpserver...authMethod&quot; pref</span>
<a href="#l32.52"></a><span id="l32.52" class="difflineplus">+   *</span>
<a href="#l32.53"></a><span id="l32.53" class="difflineplus">+   * Compatibility note: This attribute had a different meaning in TB &lt; 3.1</span>
<a href="#l32.54"></a><span id="l32.54">    */</span>
<a href="#l32.55"></a><span id="l32.55" class="difflineminus">-  attribute long authMethod;</span>
<a href="#l32.56"></a><span id="l32.56" class="difflineminus">-</span>
<a href="#l32.57"></a><span id="l32.57" class="difflineminus">-  /// Should we always use secure authentication?</span>
<a href="#l32.58"></a><span id="l32.58" class="difflineminus">-  attribute boolean useSecAuth;</span>
<a href="#l32.59"></a><span id="l32.59" class="difflineminus">-</span>
<a href="#l32.60"></a><span id="l32.60" class="difflineminus">-  /// Should we attempt to use secure authentication if the server supports it?</span>
<a href="#l32.61"></a><span id="l32.61" class="difflineminus">-  attribute boolean trySecAuth;</span>
<a href="#l32.62"></a><span id="l32.62" class="difflineplus">+  attribute nsMsgAuthMethodValue authMethod;</span>
<a href="#l32.63"></a><span id="l32.63"> </span>
<a href="#l32.64"></a><span id="l32.64">   /**</span>
<a href="#l32.65"></a><span id="l32.65" class="difflineminus">-   * Should we use SSL for this connection?</span>
<a href="#l32.66"></a><span id="l32.66" class="difflineminus">-   * 0 = never</span>
<a href="#l32.67"></a><span id="l32.67" class="difflineminus">-   * 1 = STARTTLS, if available (discouraged, insecure)</span>
<a href="#l32.68"></a><span id="l32.68" class="difflineminus">-   * 2 = TLS (STARTTLS) always</span>
<a href="#l32.69"></a><span id="l32.69" class="difflineminus">-   * 3 = SSL (SMTPS) always</span>
<a href="#l32.70"></a><span id="l32.70" class="difflineminus">-   * @see nsSmtpProtocol.h line 115 and nsSmtpProtocol.cpp line 331</span>
<a href="#l32.71"></a><span id="l32.71" class="difflineplus">+   * Whether to SSL or STARTTLS or not</span>
<a href="#l32.72"></a><span id="l32.72" class="difflineplus">+   *</span>
<a href="#l32.73"></a><span id="l32.73" class="difflineplus">+   * @see nsMsgSocketType (in MailNewsTypes2.idl)</span>
<a href="#l32.74"></a><span id="l32.74" class="difflineplus">+   * Same as &quot;mail.smtpserver...try_ssl&quot; pref</span>
<a href="#l32.75"></a><span id="l32.75">    */</span>
<a href="#l32.76"></a><span id="l32.76" class="difflineminus">-  attribute long trySSL;</span>
<a href="#l32.77"></a><span id="l32.77" class="difflineplus">+  attribute nsMsgSocketTypeValue socketType;</span>
<a href="#l32.78"></a><span id="l32.78"> </span>
<a href="#l32.79"></a><span id="l32.79">   /**</span>
<a href="#l32.80"></a><span id="l32.80">    * May contain an alternative argument to EHLO or HELO to provide to the</span>
<a href="#l32.81"></a><span id="l32.81">    * server. Reflects the value of the mail.smtpserver.*.hello_argument pref.</span>
<a href="#l32.82"></a><span id="l32.82">    * This is mainly useful where ISPs don't bother providing PTR records for</span>
<a href="#l32.83"></a><span id="l32.83">    * their servers and therefore users get an error on sending. See bug 244030</span>
<a href="#l32.84"></a><span id="l32.84">    * for more discussion.</span>
<a href="#l32.85"></a><span id="l32.85">    */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/compose/src/nsComposeStrings.h</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/compose/src/nsComposeStrings.h</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -69,27 +69,31 @@</span>
<a href="#l33.4"></a><span id="l33.4"> </span>
<a href="#l33.5"></a><span id="l33.5"> #define NS_MSG_ERROR_ATTACHING_FILE                 NS_MSG_GENERATE_FAILURE(12570)</span>
<a href="#l33.6"></a><span id="l33.6"> #define NS_MSG_ERROR_DOING_FCC                      12571</span>
<a href="#l33.7"></a><span id="l33.7"> </span>
<a href="#l33.8"></a><span id="l33.8"> #define NS_ERROR_SMTP_GREETING                      NS_MSG_GENERATE_FAILURE(12572)</span>
<a href="#l33.9"></a><span id="l33.9"> </span>
<a href="#l33.10"></a><span id="l33.10"> #define NS_ERROR_SENDING_RCPT_COMMAND               NS_MSG_GENERATE_FAILURE(12575)</span>
<a href="#l33.11"></a><span id="l33.11"> </span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-#define NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER_INSECAUTH   NS_MSG_GENERATE_FAILURE(12579)</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineminus">-#define NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER_SECAUTH     NS_MSG_GENERATE_FAILURE(12580)</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineminus">-#define NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER_AUTH_NONE   NS_MSG_GENERATE_FAILURE(12581)</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineplus">+#define NS_ERROR_SMTP_AUTH_FAILURE                  NS_MSG_GENERATE_FAILURE(12576)</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineplus">+#define NS_ERROR_SMTP_AUTH_GSSAPI                   NS_MSG_GENERATE_FAILURE(12579)</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineplus">+#define NS_ERROR_SMTP_AUTH_MECH_NOT_SUPPORTED       NS_MSG_GENERATE_FAILURE(12580)</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineplus">+#define NS_ERROR_SMTP_AUTH_NOT_SUPPORTED            NS_MSG_GENERATE_FAILURE(12581)</span>
<a href="#l33.19"></a><span id="l33.19"> </span>
<a href="#l33.20"></a><span id="l33.20"> #define NS_ERROR_STARTTLS_FAILED_EHLO_STARTTLS      NS_MSG_GENERATE_FAILURE(12582)</span>
<a href="#l33.21"></a><span id="l33.21"> </span>
<a href="#l33.22"></a><span id="l33.22" class="difflineminus">-#define NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER     NS_MSG_GENERATE_FAILURE(12583)</span>
<a href="#l33.23"></a><span id="l33.23"> #define NS_ERROR_SMTP_PASSWORD_UNDEFINED            NS_MSG_GENERATE_FAILURE(12584)</span>
<a href="#l33.24"></a><span id="l33.24"> #define NS_ERROR_SMTP_TEMP_SIZE_EXCEEDED            NS_MSG_GENERATE_FAILURE(12586)</span>
<a href="#l33.25"></a><span id="l33.25"> #define NS_ERROR_SMTP_PERM_SIZE_EXCEEDED_1          NS_MSG_GENERATE_FAILURE(12587)</span>
<a href="#l33.26"></a><span id="l33.26"> #define NS_ERROR_SMTP_PERM_SIZE_EXCEEDED_2          NS_MSG_GENERATE_FAILURE(12588)</span>
<a href="#l33.27"></a><span id="l33.27"> </span>
<a href="#l33.28"></a><span id="l33.28"> #define NS_ERROR_SMTP_SEND_FAILED_UNKNOWN_SERVER    NS_MSG_GENERATE_FAILURE(12589)</span>
<a href="#l33.29"></a><span id="l33.29"> #define NS_ERROR_SMTP_SEND_FAILED_REFUSED           NS_MSG_GENERATE_FAILURE(12590)</span>
<a href="#l33.30"></a><span id="l33.30"> #define NS_ERROR_SMTP_SEND_FAILED_INTERRUPTED       NS_MSG_GENERATE_FAILURE(12591)</span>
<a href="#l33.31"></a><span id="l33.31"> #define NS_ERROR_SMTP_SEND_FAILED_TIMEOUT           NS_MSG_GENERATE_FAILURE(12592)</span>
<a href="#l33.32"></a><span id="l33.32"> #define NS_ERROR_SMTP_SEND_FAILED_UNKNOWN_REASON    NS_MSG_GENERATE_FAILURE(12593)</span>
<a href="#l33.33"></a><span id="l33.33"> </span>
<a href="#l33.34"></a><span id="l33.34" class="difflineplus">+#define NS_ERROR_SMTP_AUTH_CHANGE_ENCRYPT_TO_PLAIN_NO_SSL  NS_MSG_GENERATE_FAILURE(12594)</span>
<a href="#l33.35"></a><span id="l33.35" class="difflineplus">+#define NS_ERROR_SMTP_AUTH_CHANGE_ENCRYPT_TO_PLAIN_SSL     NS_MSG_GENERATE_FAILURE(12595)</span>
<a href="#l33.36"></a><span id="l33.36" class="difflineplus">+#define NS_ERROR_SMTP_AUTH_CHANGE_PLAIN_TO_ENCRYPT         NS_MSG_GENERATE_FAILURE(12596)</span>
<a href="#l33.37"></a><span id="l33.37" class="difflineplus">+</span>
<a href="#l33.38"></a><span id="l33.38"> #endif /* _nsComposeStrings_H__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -3870,21 +3870,24 @@ nsMsgComposeAndSend::DoDeliveryExitProce</span>
<a href="#l34.4"></a><span id="l34.4"> </span>
<a href="#l34.5"></a><span id="l34.5">     nsString eMsg;</span>
<a href="#l34.6"></a><span id="l34.6">     if (aExitCode == NS_ERROR_SMTP_SEND_FAILED_UNKNOWN_SERVER ||</span>
<a href="#l34.7"></a><span id="l34.7">         aExitCode == NS_ERROR_SMTP_SEND_FAILED_UNKNOWN_REASON ||</span>
<a href="#l34.8"></a><span id="l34.8">         aExitCode == NS_ERROR_SMTP_SEND_FAILED_REFUSED ||</span>
<a href="#l34.9"></a><span id="l34.9">         aExitCode == NS_ERROR_SMTP_SEND_FAILED_INTERRUPTED ||</span>
<a href="#l34.10"></a><span id="l34.10">         aExitCode == NS_ERROR_SMTP_SEND_FAILED_TIMEOUT ||</span>
<a href="#l34.11"></a><span id="l34.11">         aExitCode == NS_ERROR_SMTP_PASSWORD_UNDEFINED ||</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-        aExitCode == NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER ||</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineminus">-        aExitCode == NS_ERROR_STARTTLS_FAILED_EHLO_STARTTLS ||</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineminus">-        aExitCode == NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER_INSECAUTH ||</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineminus">-        aExitCode == NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER_SECAUTH ||</span>
<a href="#l34.16"></a><span id="l34.16" class="difflineminus">-        aExitCode == NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER_AUTH_NONE)</span>
<a href="#l34.17"></a><span id="l34.17" class="difflineplus">+        aExitCode == NS_ERROR_SMTP_AUTH_FAILURE ||</span>
<a href="#l34.18"></a><span id="l34.18" class="difflineplus">+        aExitCode == NS_ERROR_SMTP_AUTH_GSSAPI ||</span>
<a href="#l34.19"></a><span id="l34.19" class="difflineplus">+        aExitCode == NS_ERROR_SMTP_AUTH_MECH_NOT_SUPPORTED ||</span>
<a href="#l34.20"></a><span id="l34.20" class="difflineplus">+        aExitCode == NS_ERROR_SMTP_AUTH_NOT_SUPPORTED ||</span>
<a href="#l34.21"></a><span id="l34.21" class="difflineplus">+        aExitCode == NS_ERROR_SMTP_AUTH_CHANGE_ENCRYPT_TO_PLAIN_NO_SSL ||</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineplus">+        aExitCode == NS_ERROR_SMTP_AUTH_CHANGE_ENCRYPT_TO_PLAIN_SSL ||</span>
<a href="#l34.23"></a><span id="l34.23" class="difflineplus">+        aExitCode == NS_ERROR_SMTP_AUTH_CHANGE_PLAIN_TO_ENCRYPT ||</span>
<a href="#l34.24"></a><span id="l34.24" class="difflineplus">+        aExitCode == NS_ERROR_STARTTLS_FAILED_EHLO_STARTTLS)</span>
<a href="#l34.25"></a><span id="l34.25">       FormatStringWithSMTPHostNameByID(aExitCode, getter_Copies(eMsg));</span>
<a href="#l34.26"></a><span id="l34.26">     else</span>
<a href="#l34.27"></a><span id="l34.27">       mComposeBundle-&gt;GetStringFromID(NS_ERROR_GET_CODE(aExitCode), getter_Copies(eMsg));</span>
<a href="#l34.28"></a><span id="l34.28"> </span>
<a href="#l34.29"></a><span id="l34.29">     Fail(aExitCode, eMsg.get(), &amp;aExitCode);</span>
<a href="#l34.30"></a><span id="l34.30">     NotifyListenerOnStopSending(nsnull, aExitCode, nsnull, nsnull);</span>
<a href="#l34.31"></a><span id="l34.31">     return;</span>
<a href="#l34.32"></a><span id="l34.32">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpProtocol.cpp</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpProtocol.cpp</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -18,16 +18,17 @@</span>
<a href="#l35.4"></a><span id="l35.4">  * Netscape Communications Corporation.</span>
<a href="#l35.5"></a><span id="l35.5">  * Portions created by the Initial Developer are Copyright (C) 1998</span>
<a href="#l35.6"></a><span id="l35.6">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l35.7"></a><span id="l35.7">  *</span>
<a href="#l35.8"></a><span id="l35.8">  * Contributor(s):</span>
<a href="#l35.9"></a><span id="l35.9">  *   Christian Eyrich &lt;ch.ey@gmx.net&gt;</span>
<a href="#l35.10"></a><span id="l35.10">  *   Olivier Parniere BT Global Services / Etat francais Ministere de la Defense</span>
<a href="#l35.11"></a><span id="l35.11">  *   Eric Ballet Baz BT Global Services / Etat francais Ministere de la Defense</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineplus">+ *   Ben Bucksch &lt;ben.bucksch beonex.com&gt; of Beonex &lt;http://business.beonex.com&gt;</span>
<a href="#l35.13"></a><span id="l35.13">  *</span>
<a href="#l35.14"></a><span id="l35.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l35.15"></a><span id="l35.15">  * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l35.16"></a><span id="l35.16">  * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l35.17"></a><span id="l35.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l35.18"></a><span id="l35.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l35.19"></a><span id="l35.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l35.20"></a><span id="l35.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l35.21"></a><span id="l35.21" class="difflineat">@@ -74,16 +75,17 @@</span>
<a href="#l35.22"></a><span id="l35.22"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l35.23"></a><span id="l35.23"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l35.24"></a><span id="l35.24"> #include &quot;nsISignatureVerifier.h&quot;</span>
<a href="#l35.25"></a><span id="l35.25"> #include &quot;nsISSLSocketControl.h&quot;</span>
<a href="#l35.26"></a><span id="l35.26"> #include &quot;nsComposeStrings.h&quot;</span>
<a href="#l35.27"></a><span id="l35.27"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l35.28"></a><span id="l35.28"> #include &quot;nsMsgCompUtils.h&quot;</span>
<a href="#l35.29"></a><span id="l35.29"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l35.30"></a><span id="l35.30" class="difflineplus">+#include &quot;MailNewsTypes2.h&quot; // for nsMsgSocketType and nsMsgAuthMethod</span>
<a href="#l35.31"></a><span id="l35.31"> </span>
<a href="#l35.32"></a><span id="l35.32"> </span>
<a href="#l35.33"></a><span id="l35.33"> #ifndef XP_UNIX</span>
<a href="#l35.34"></a><span id="l35.34"> #include &lt;stdarg.h&gt;</span>
<a href="#l35.35"></a><span id="l35.35"> #endif /* !XP_UNIX */</span>
<a href="#l35.36"></a><span id="l35.36"> </span>
<a href="#l35.37"></a><span id="l35.37"> static PRLogModuleInfo *SMTPLogModule = nsnull;</span>
<a href="#l35.38"></a><span id="l35.38"> </span>
<a href="#l35.39"></a><span id="l35.39" class="difflineat">@@ -252,22 +254,21 @@ nsSmtpProtocol::~nsSmtpProtocol()</span>
<a href="#l35.40"></a><span id="l35.40"> }</span>
<a href="#l35.41"></a><span id="l35.41"> </span>
<a href="#l35.42"></a><span id="l35.42"> void nsSmtpProtocol::Initialize(nsIURI * aURL)</span>
<a href="#l35.43"></a><span id="l35.43"> {</span>
<a href="#l35.44"></a><span id="l35.44">     NS_PRECONDITION(aURL, &quot;invalid URL passed into Smtp Protocol&quot;);</span>
<a href="#l35.45"></a><span id="l35.45">     nsresult rv = NS_OK;</span>
<a href="#l35.46"></a><span id="l35.46"> </span>
<a href="#l35.47"></a><span id="l35.47">     m_flags = 0;</span>
<a href="#l35.48"></a><span id="l35.48" class="difflineminus">-    m_origAuthFlags = 0;</span>
<a href="#l35.49"></a><span id="l35.49" class="difflineminus">-    m_prefAuthMethod = PREF_AUTH_NONE;</span>
<a href="#l35.50"></a><span id="l35.50" class="difflineplus">+    m_prefAuthMethods = 0;</span>
<a href="#l35.51"></a><span id="l35.51" class="difflineplus">+    m_failedAuthMethods = 0;</span>
<a href="#l35.52"></a><span id="l35.52" class="difflineplus">+    m_currentAuthMethod = 0;</span>
<a href="#l35.53"></a><span id="l35.53">     m_usernamePrompted = PR_FALSE;</span>
<a href="#l35.54"></a><span id="l35.54" class="difflineminus">-    m_prefTrySSL = PREF_SECURE_TRY_STARTTLS;</span>
<a href="#l35.55"></a><span id="l35.55" class="difflineminus">-    m_prefUseSecAuth = PR_TRUE;</span>
<a href="#l35.56"></a><span id="l35.56" class="difflineminus">-    m_prefTrySecAuth = PR_FALSE;</span>
<a href="#l35.57"></a><span id="l35.57" class="difflineplus">+    m_prefSocketType = nsMsgSocketType::trySTARTTLS;</span>
<a href="#l35.58"></a><span id="l35.58">     m_tlsInitiated = PR_FALSE;</span>
<a href="#l35.59"></a><span id="l35.59"> </span>
<a href="#l35.60"></a><span id="l35.60">     m_urlErrorState = NS_ERROR_FAILURE;</span>
<a href="#l35.61"></a><span id="l35.61"> </span>
<a href="#l35.62"></a><span id="l35.62">     if (!SMTPLogModule)</span>
<a href="#l35.63"></a><span id="l35.63">         SMTPLogModule = PR_NewLogModule(&quot;SMTP&quot;);</span>
<a href="#l35.64"></a><span id="l35.64"> </span>
<a href="#l35.65"></a><span id="l35.65">     if (aURL)</span>
<a href="#l35.66"></a><span id="l35.66" class="difflineat">@@ -305,57 +306,53 @@ void nsSmtpProtocol::Initialize(nsIURI *</span>
<a href="#l35.67"></a><span id="l35.67">         file-&gt;GetFileSize(&amp;m_totalMessageSize);</span>
<a href="#l35.68"></a><span id="l35.68"> </span>
<a href="#l35.69"></a><span id="l35.69">     m_originalContentLength = 0;</span>
<a href="#l35.70"></a><span id="l35.70">     m_totalAmountRead = 0;</span>
<a href="#l35.71"></a><span id="l35.71"> </span>
<a href="#l35.72"></a><span id="l35.72">     m_lineStreamBuffer = new nsMsgLineStreamBuffer(OUTPUT_BUFFER_SIZE, PR_TRUE);</span>
<a href="#l35.73"></a><span id="l35.73">     // ** may want to consider caching the server capability to save lots of</span>
<a href="#l35.74"></a><span id="l35.74">     // round trip communication between the client and server</span>
<a href="#l35.75"></a><span id="l35.75" class="difflineplus">+    PRInt32 authMethod = 0;</span>
<a href="#l35.76"></a><span id="l35.76">     nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l35.77"></a><span id="l35.77">     m_runningURL-&gt;GetSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l35.78"></a><span id="l35.78">     if (smtpServer) {</span>
<a href="#l35.79"></a><span id="l35.79" class="difflineminus">-        smtpServer-&gt;GetAuthMethod(&amp;m_prefAuthMethod);</span>
<a href="#l35.80"></a><span id="l35.80" class="difflineminus">-        smtpServer-&gt;GetTrySSL(&amp;m_prefTrySSL);</span>
<a href="#l35.81"></a><span id="l35.81" class="difflineminus">-        smtpServer-&gt;GetUseSecAuth(&amp;m_prefUseSecAuth);</span>
<a href="#l35.82"></a><span id="l35.82" class="difflineminus">-        // Uncomment out the following line to turn back on sec auth probing</span>
<a href="#l35.83"></a><span id="l35.83" class="difflineminus">-        // smtpServer-&gt;GetTrySecAuth(&amp;m_prefTrySecAuth);</span>
<a href="#l35.84"></a><span id="l35.84" class="difflineplus">+        smtpServer-&gt;GetAuthMethod(&amp;authMethod);</span>
<a href="#l35.85"></a><span id="l35.85" class="difflineplus">+        smtpServer-&gt;GetSocketType(&amp;m_prefSocketType);</span>
<a href="#l35.86"></a><span id="l35.86">         smtpServer-&gt;GetHelloArgument(getter_Copies(m_helloArgument));</span>
<a href="#l35.87"></a><span id="l35.87">     }</span>
<a href="#l35.88"></a><span id="l35.88" class="difflineplus">+    InitPrefAuthMethods(authMethod);</span>
<a href="#l35.89"></a><span id="l35.89"> </span>
<a href="#l35.90"></a><span id="l35.90"> #if defined(PR_LOGGING)</span>
<a href="#l35.91"></a><span id="l35.91">     nsCAutoString hostName;</span>
<a href="#l35.92"></a><span id="l35.92">     aURL-&gt;GetAsciiHost(hostName);</span>
<a href="#l35.93"></a><span id="l35.93">     PR_LOG(SMTPLogModule, PR_LOG_ALWAYS, (&quot;SMTP Connecting to: %s&quot;, hostName.get()));</span>
<a href="#l35.94"></a><span id="l35.94"> #endif</span>
<a href="#l35.95"></a><span id="l35.95"> </span>
<a href="#l35.96"></a><span id="l35.96">     // When we are making a secure connection, we need to make sure that we</span>
<a href="#l35.97"></a><span id="l35.97">     // pass an interface requestor down to the socket transport so that PSM can</span>
<a href="#l35.98"></a><span id="l35.98">     // retrieve a nsIPrompt instance if needed.</span>
<a href="#l35.99"></a><span id="l35.99">     nsCOMPtr&lt;nsIInterfaceRequestor&gt; callbacks;</span>
<a href="#l35.100"></a><span id="l35.100">     nsCOMPtr&lt;nsISmtpUrl&gt; smtpUrl(do_QueryInterface(aURL));</span>
<a href="#l35.101"></a><span id="l35.101">     if (smtpUrl)</span>
<a href="#l35.102"></a><span id="l35.102">         smtpUrl-&gt;GetNotificationCallbacks(getter_AddRefs(callbacks));</span>
<a href="#l35.103"></a><span id="l35.103"> </span>
<a href="#l35.104"></a><span id="l35.104" class="difflineminus">-    if (m_prefTrySSL == PREF_SECURE_ALWAYS_SMTPS)</span>
<a href="#l35.105"></a><span id="l35.105" class="difflineplus">+    if (m_prefSocketType == nsMsgSocketType::SSL)</span>
<a href="#l35.106"></a><span id="l35.106">         rv = OpenNetworkSocket(aURL, &quot;ssl&quot;, callbacks);</span>
<a href="#l35.107"></a><span id="l35.107" class="difflineminus">-    else if (m_prefTrySSL != PREF_SECURE_NEVER)</span>
<a href="#l35.108"></a><span id="l35.108" class="difflineplus">+    else if (m_prefSocketType != nsMsgSocketType::plain)</span>
<a href="#l35.109"></a><span id="l35.109">     {</span>
<a href="#l35.110"></a><span id="l35.110">         rv = OpenNetworkSocket(aURL, &quot;starttls&quot;, callbacks);</span>
<a href="#l35.111"></a><span id="l35.111" class="difflineminus">-        if (NS_FAILED(rv) &amp;&amp; m_prefTrySSL == PREF_SECURE_TRY_STARTTLS)</span>
<a href="#l35.112"></a><span id="l35.112" class="difflineplus">+        if (NS_FAILED(rv) &amp;&amp; m_prefSocketType == nsMsgSocketType::trySTARTTLS)</span>
<a href="#l35.113"></a><span id="l35.113">         {</span>
<a href="#l35.114"></a><span id="l35.114" class="difflineminus">-            m_prefTrySSL = PREF_SECURE_NEVER;</span>
<a href="#l35.115"></a><span id="l35.115" class="difflineplus">+            m_prefSocketType = nsMsgSocketType::plain;</span>
<a href="#l35.116"></a><span id="l35.116">             rv = OpenNetworkSocket(aURL, nsnull, callbacks);</span>
<a href="#l35.117"></a><span id="l35.117">         }</span>
<a href="#l35.118"></a><span id="l35.118">     }</span>
<a href="#l35.119"></a><span id="l35.119">     else</span>
<a href="#l35.120"></a><span id="l35.120">         rv = OpenNetworkSocket(aURL, nsnull, callbacks);</span>
<a href="#l35.121"></a><span id="l35.121" class="difflineminus">-</span>
<a href="#l35.122"></a><span id="l35.122" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l35.123"></a><span id="l35.123" class="difflineminus">-        return;</span>
<a href="#l35.124"></a><span id="l35.124"> }</span>
<a href="#l35.125"></a><span id="l35.125"> </span>
<a href="#l35.126"></a><span id="l35.126"> void nsSmtpProtocol::AppendHelloArgument(nsACString&amp; aResult)</span>
<a href="#l35.127"></a><span id="l35.127"> {</span>
<a href="#l35.128"></a><span id="l35.128">   nsresult rv;</span>
<a href="#l35.129"></a><span id="l35.129"> </span>
<a href="#l35.130"></a><span id="l35.130">   // is a custom EHLO/HELO argument configured for the transport to be used?</span>
<a href="#l35.131"></a><span id="l35.131">   if (!m_helloArgument.IsEmpty())</span>
<a href="#l35.132"></a><span id="l35.132" class="difflineat">@@ -539,17 +536,17 @@ PRInt32 nsSmtpProtocol::ExtensionLoginRe</span>
<a href="#l35.133"></a><span id="l35.133"> #ifdef DEBUG</span>
<a href="#l35.134"></a><span id="l35.134">     nsresult rv =</span>
<a href="#l35.135"></a><span id="l35.135"> #endif</span>
<a href="#l35.136"></a><span id="l35.136">     nsExplainErrorDetails(m_runningURL, NS_ERROR_SMTP_GREETING,</span>
<a href="#l35.137"></a><span id="l35.137">                           m_responseText.get());</span>
<a href="#l35.138"></a><span id="l35.138">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to explain SMTP error&quot;);</span>
<a href="#l35.139"></a><span id="l35.139"> </span>
<a href="#l35.140"></a><span id="l35.140">     m_urlErrorState = NS_ERROR_BUT_DONT_SHOW_ALERT;</span>
<a href="#l35.141"></a><span id="l35.141" class="difflineminus">-    return(NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER);</span>
<a href="#l35.142"></a><span id="l35.142" class="difflineplus">+    return NS_ERROR_SMTP_AUTH_FAILURE;</span>
<a href="#l35.143"></a><span id="l35.143">   }</span>
<a href="#l35.144"></a><span id="l35.144"> </span>
<a href="#l35.145"></a><span id="l35.145">   nsCAutoString buffer(&quot;EHLO &quot;);</span>
<a href="#l35.146"></a><span id="l35.146">   AppendHelloArgument(buffer);</span>
<a href="#l35.147"></a><span id="l35.147">   buffer += CRLF;</span>
<a href="#l35.148"></a><span id="l35.148"> </span>
<a href="#l35.149"></a><span id="l35.149">   nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(m_runningURL);</span>
<a href="#l35.150"></a><span id="l35.150"> </span>
<a href="#l35.151"></a><span id="l35.151" class="difflineat">@@ -573,17 +570,17 @@ PRInt32 nsSmtpProtocol::SendHeloResponse</span>
<a href="#l35.152"></a><span id="l35.152"> #ifdef DEBUG</span>
<a href="#l35.153"></a><span id="l35.153">     rv =</span>
<a href="#l35.154"></a><span id="l35.154"> #endif</span>
<a href="#l35.155"></a><span id="l35.155">     nsExplainErrorDetails(m_runningURL, NS_ERROR_SMTP_SERVER_ERROR,</span>
<a href="#l35.156"></a><span id="l35.156">                           m_responseText.get());</span>
<a href="#l35.157"></a><span id="l35.157">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to explain SMTP error&quot;);</span>
<a href="#l35.158"></a><span id="l35.158"> </span>
<a href="#l35.159"></a><span id="l35.159">     m_urlErrorState = NS_ERROR_BUT_DONT_SHOW_ALERT;</span>
<a href="#l35.160"></a><span id="l35.160" class="difflineminus">-    return(NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER);</span>
<a href="#l35.161"></a><span id="l35.161" class="difflineplus">+    return NS_ERROR_SMTP_AUTH_FAILURE;</span>
<a href="#l35.162"></a><span id="l35.162">   }</span>
<a href="#l35.163"></a><span id="l35.163"> </span>
<a href="#l35.164"></a><span id="l35.164">   // check if we're just verifying the ability to logon</span>
<a href="#l35.165"></a><span id="l35.165">   nsCOMPtr&lt;nsISmtpUrl&gt; smtpUrl = do_QueryInterface(m_runningURL, &amp;rv);</span>
<a href="#l35.166"></a><span id="l35.166">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.167"></a><span id="l35.167">   PRBool verifyingLogon = PR_FALSE;</span>
<a href="#l35.168"></a><span id="l35.168">   smtpUrl-&gt;GetVerifyLogon(&amp;verifyingLogon);</span>
<a href="#l35.169"></a><span id="l35.169">   if (verifyingLogon)</span>
<a href="#l35.170"></a><span id="l35.170" class="difflineat">@@ -683,30 +680,23 @@ PRInt32 nsSmtpProtocol::SendEhloResponse</span>
<a href="#l35.171"></a><span id="l35.171">         /* EHLO must not be implemented by the server, so fall back to the HELO case</span>
<a href="#l35.172"></a><span id="l35.172">          * if command is unrecognized or unimplemented.</span>
<a href="#l35.173"></a><span id="l35.173">          */</span>
<a href="#l35.174"></a><span id="l35.174">         if (m_responseCode == 500 || m_responseCode == 502)</span>
<a href="#l35.175"></a><span id="l35.175">         {</span>
<a href="#l35.176"></a><span id="l35.176">             /* If STARTTLS is requested by the user, EHLO is required to advertise it.</span>
<a href="#l35.177"></a><span id="l35.177">              * But only if TLS handshake is not already accomplished.</span>
<a href="#l35.178"></a><span id="l35.178">              */</span>
<a href="#l35.179"></a><span id="l35.179" class="difflineminus">-            if (m_prefTrySSL == PREF_SECURE_ALWAYS_STARTTLS &amp;&amp; !m_tlsEnabled)</span>
<a href="#l35.180"></a><span id="l35.180" class="difflineplus">+            if (m_prefSocketType == nsMsgSocketType::alwaysSTARTTLS &amp;&amp;</span>
<a href="#l35.181"></a><span id="l35.181" class="difflineplus">+                !m_tlsEnabled)</span>
<a href="#l35.182"></a><span id="l35.182">             {</span>
<a href="#l35.183"></a><span id="l35.183">                 m_nextState = SMTP_ERROR_DONE;</span>
<a href="#l35.184"></a><span id="l35.184">                 m_urlErrorState = NS_ERROR_STARTTLS_FAILED_EHLO_STARTTLS;</span>
<a href="#l35.185"></a><span id="l35.185">                 return(NS_ERROR_STARTTLS_FAILED_EHLO_STARTTLS);</span>
<a href="#l35.186"></a><span id="l35.186">             }</span>
<a href="#l35.187"></a><span id="l35.187" class="difflineminus">-            else</span>
<a href="#l35.188"></a><span id="l35.188" class="difflineminus">-                // EHLO is always needed if authentication is requested.</span>
<a href="#l35.189"></a><span id="l35.189" class="difflineminus">-                if (m_prefAuthMethod == PREF_AUTH_ANY)</span>
<a href="#l35.190"></a><span id="l35.190" class="difflineminus">-                {</span>
<a href="#l35.191"></a><span id="l35.191" class="difflineminus">-                    m_nextState = SMTP_ERROR_DONE;</span>
<a href="#l35.192"></a><span id="l35.192" class="difflineminus">-                    m_urlErrorState = NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER_AUTH_NONE;</span>
<a href="#l35.193"></a><span id="l35.193" class="difflineminus">-                    return(NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER);</span>
<a href="#l35.194"></a><span id="l35.194" class="difflineminus">-                }</span>
<a href="#l35.195"></a><span id="l35.195"> </span>
<a href="#l35.196"></a><span id="l35.196">             nsCAutoString buffer(&quot;HELO &quot;);</span>
<a href="#l35.197"></a><span id="l35.197">             AppendHelloArgument(buffer);</span>
<a href="#l35.198"></a><span id="l35.198">             buffer += CRLF;</span>
<a href="#l35.199"></a><span id="l35.199"> </span>
<a href="#l35.200"></a><span id="l35.200">             status = SendData(url, buffer.get());</span>
<a href="#l35.201"></a><span id="l35.201"> </span>
<a href="#l35.202"></a><span id="l35.202">             m_nextState = SMTP_RESPONSE;</span>
<a href="#l35.203"></a><span id="l35.203" class="difflineat">@@ -722,17 +712,17 @@ PRInt32 nsSmtpProtocol::SendEhloResponse</span>
<a href="#l35.204"></a><span id="l35.204"> #ifdef DEBUG</span>
<a href="#l35.205"></a><span id="l35.205">             nsresult rv =</span>
<a href="#l35.206"></a><span id="l35.206"> #endif</span>
<a href="#l35.207"></a><span id="l35.207">             nsExplainErrorDetails(m_runningURL, NS_ERROR_SMTP_SERVER_ERROR,</span>
<a href="#l35.208"></a><span id="l35.208">                                   m_responseText.get());</span>
<a href="#l35.209"></a><span id="l35.209">             NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to explain SMTP error&quot;);</span>
<a href="#l35.210"></a><span id="l35.210"> </span>
<a href="#l35.211"></a><span id="l35.211">             m_urlErrorState = NS_ERROR_BUT_DONT_SHOW_ALERT;</span>
<a href="#l35.212"></a><span id="l35.212" class="difflineminus">-            return(NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER);</span>
<a href="#l35.213"></a><span id="l35.213" class="difflineplus">+            return NS_ERROR_SMTP_AUTH_FAILURE;</span>
<a href="#l35.214"></a><span id="l35.214">         }</span>
<a href="#l35.215"></a><span id="l35.215">     }</span>
<a href="#l35.216"></a><span id="l35.216"> </span>
<a href="#l35.217"></a><span id="l35.217">     PRInt32 responseLength = m_responseText.Length();</span>
<a href="#l35.218"></a><span id="l35.218">     PRInt32 startPos = 0;</span>
<a href="#l35.219"></a><span id="l35.219">     PRInt32 endPos;</span>
<a href="#l35.220"></a><span id="l35.220">     do</span>
<a href="#l35.221"></a><span id="l35.221">     {</span>
<a href="#l35.222"></a><span id="l35.222" class="difflineat">@@ -749,71 +739,42 @@ PRInt32 nsSmtpProtocol::SendEhloResponse</span>
<a href="#l35.223"></a><span id="l35.223">         else if (responseLine.Compare(&quot;DSN&quot;, PR_TRUE) == 0)</span>
<a href="#l35.224"></a><span id="l35.224">         {</span>
<a href="#l35.225"></a><span id="l35.225">             SetFlag(SMTP_EHLO_DSN_ENABLED);</span>
<a href="#l35.226"></a><span id="l35.226">         }</span>
<a href="#l35.227"></a><span id="l35.227">         else if (responseLine.Compare(&quot;AUTH&quot;, PR_TRUE, 4) == 0)</span>
<a href="#l35.228"></a><span id="l35.228">         {</span>
<a href="#l35.229"></a><span id="l35.229">             SetFlag(SMTP_AUTH);</span>
<a href="#l35.230"></a><span id="l35.230"> </span>
<a href="#l35.231"></a><span id="l35.231" class="difflineminus">-            if (m_prefUseSecAuth || m_prefTrySecAuth)</span>
<a href="#l35.232"></a><span id="l35.232" class="difflineminus">-            {</span>
<a href="#l35.233"></a><span id="l35.233" class="difflineminus">-                if (responseLine.Find(&quot;GSSAPI&quot;, PR_TRUE, 5) &gt;= 0)</span>
<a href="#l35.234"></a><span id="l35.234" class="difflineminus">-                    SetFlag(SMTP_AUTH_GSSAPI_ENABLED);</span>
<a href="#l35.235"></a><span id="l35.235" class="difflineminus">-</span>
<a href="#l35.236"></a><span id="l35.236" class="difflineminus">-                nsresult rv;</span>
<a href="#l35.237"></a><span id="l35.237" class="difflineminus">-                nsCOMPtr&lt;nsISignatureVerifier&gt; verifier = do_GetService(SIGNATURE_VERIFIER_CONTRACTID, &amp;rv);</span>
<a href="#l35.238"></a><span id="l35.238" class="difflineminus">-                // this checks if psm is installed...</span>
<a href="#l35.239"></a><span id="l35.239" class="difflineminus">-                if (NS_SUCCEEDED(rv))</span>
<a href="#l35.240"></a><span id="l35.240" class="difflineminus">-                {</span>
<a href="#l35.241"></a><span id="l35.241" class="difflineminus">-                    if (responseLine.Find(&quot;CRAM-MD5&quot;, PR_TRUE, 5) &gt;= 0)</span>
<a href="#l35.242"></a><span id="l35.242" class="difflineminus">-                        SetFlag(SMTP_AUTH_CRAM_MD5_ENABLED);</span>
<a href="#l35.243"></a><span id="l35.243" class="difflineminus">-</span>
<a href="#l35.244"></a><span id="l35.244" class="difflineminus">-                    if (responseLine.Find(&quot;NTLM&quot;, PR_TRUE, 5) &gt;= 0)</span>
<a href="#l35.245"></a><span id="l35.245" class="difflineminus">-                        SetFlag(SMTP_AUTH_NTLM_ENABLED);</span>
<a href="#l35.246"></a><span id="l35.246" class="difflineminus">-</span>
<a href="#l35.247"></a><span id="l35.247" class="difflineminus">-                    if (responseLine.Find(&quot;MSN&quot;, PR_TRUE, 5) &gt;= 0)</span>
<a href="#l35.248"></a><span id="l35.248" class="difflineminus">-                        SetFlag(SMTP_AUTH_MSN_ENABLED);</span>
<a href="#l35.249"></a><span id="l35.249" class="difflineminus">-                }</span>
<a href="#l35.250"></a><span id="l35.250" class="difflineplus">+            if (responseLine.Find(&quot;GSSAPI&quot;, PR_TRUE, 5) &gt;= 0)</span>
<a href="#l35.251"></a><span id="l35.251" class="difflineplus">+                SetFlag(SMTP_AUTH_GSSAPI_ENABLED);</span>
<a href="#l35.252"></a><span id="l35.252"> </span>
<a href="#l35.253"></a><span id="l35.253" class="difflineminus">-                if (m_prefTrySecAuth)</span>
<a href="#l35.254"></a><span id="l35.254" class="difflineminus">-                {</span>
<a href="#l35.255"></a><span id="l35.255" class="difflineminus">-                  // don't adopt value for m_prefTrySecAuth instantly</span>
<a href="#l35.256"></a><span id="l35.256" class="difflineminus">-                  // so that we reprobe in case of STARTTLS</span>
<a href="#l35.257"></a><span id="l35.257" class="difflineplus">+            nsresult rv;</span>
<a href="#l35.258"></a><span id="l35.258" class="difflineplus">+            nsCOMPtr&lt;nsISignatureVerifier&gt; verifier = do_GetService(SIGNATURE_VERIFIER_CONTRACTID, &amp;rv);</span>
<a href="#l35.259"></a><span id="l35.259" class="difflineplus">+            // this checks if psm is installed...</span>
<a href="#l35.260"></a><span id="l35.260" class="difflineplus">+            if (NS_SUCCEEDED(rv))</span>
<a href="#l35.261"></a><span id="l35.261" class="difflineplus">+            {</span>
<a href="#l35.262"></a><span id="l35.262" class="difflineplus">+                if (responseLine.Find(&quot;CRAM-MD5&quot;, PR_TRUE, 5) &gt;= 0)</span>
<a href="#l35.263"></a><span id="l35.263" class="difflineplus">+                    SetFlag(SMTP_AUTH_CRAM_MD5_ENABLED);</span>
<a href="#l35.264"></a><span id="l35.264"> </span>
<a href="#l35.265"></a><span id="l35.265" class="difflineminus">-                  nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l35.266"></a><span id="l35.266" class="difflineminus">-                  m_runningURL-&gt;GetSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l35.267"></a><span id="l35.267" class="difflineminus">-                  if (smtpServer)</span>
<a href="#l35.268"></a><span id="l35.268" class="difflineminus">-                  {</span>
<a href="#l35.269"></a><span id="l35.269" class="difflineminus">-                    // If we are in probe mode, save what we found out for the future.</span>
<a href="#l35.270"></a><span id="l35.270" class="difflineminus">-                    // Don't trust GSSAPI since the server can advertise it </span>
<a href="#l35.271"></a><span id="l35.271" class="difflineminus">-                    // but the client may not be set up for it.</span>
<a href="#l35.272"></a><span id="l35.272" class="difflineminus">-                    m_prefUseSecAuth = TestFlag(SMTP_AUTH_SEC_ENABLED &amp;</span>
<a href="#l35.273"></a><span id="l35.273" class="difflineminus">-                                                ~SMTP_AUTH_GSSAPI_ENABLED);</span>
<a href="#l35.274"></a><span id="l35.274" class="difflineminus">-                    smtpServer-&gt;SetUseSecAuth(m_prefUseSecAuth);</span>
<a href="#l35.275"></a><span id="l35.275" class="difflineminus">-                    // then disable probing for next run</span>
<a href="#l35.276"></a><span id="l35.276" class="difflineminus">-                    smtpServer-&gt;SetTrySecAuth(PR_FALSE);</span>
<a href="#l35.277"></a><span id="l35.277" class="difflineminus">-                  }</span>
<a href="#l35.278"></a><span id="l35.278" class="difflineminus">-                }</span>
<a href="#l35.279"></a><span id="l35.279" class="difflineplus">+                if (responseLine.Find(&quot;NTLM&quot;, PR_TRUE, 5) &gt;= 0)</span>
<a href="#l35.280"></a><span id="l35.280" class="difflineplus">+                    SetFlag(SMTP_AUTH_NTLM_ENABLED);</span>
<a href="#l35.281"></a><span id="l35.281" class="difflineplus">+</span>
<a href="#l35.282"></a><span id="l35.282" class="difflineplus">+                if (responseLine.Find(&quot;MSN&quot;, PR_TRUE, 5) &gt;= 0)</span>
<a href="#l35.283"></a><span id="l35.283" class="difflineplus">+                    SetFlag(SMTP_AUTH_MSN_ENABLED);</span>
<a href="#l35.284"></a><span id="l35.284">             }</span>
<a href="#l35.285"></a><span id="l35.285"> </span>
<a href="#l35.286"></a><span id="l35.286" class="difflineminus">-            if (!m_prefUseSecAuth)</span>
<a href="#l35.287"></a><span id="l35.287" class="difflineminus">-            {</span>
<a href="#l35.288"></a><span id="l35.288" class="difflineminus">-                if (responseLine.Find(&quot;PLAIN&quot;, PR_TRUE, 5) &gt;= 0)</span>
<a href="#l35.289"></a><span id="l35.289" class="difflineminus">-                    SetFlag(SMTP_AUTH_PLAIN_ENABLED);</span>
<a href="#l35.290"></a><span id="l35.290" class="difflineplus">+            if (responseLine.Find(&quot;PLAIN&quot;, PR_TRUE, 5) &gt;= 0)</span>
<a href="#l35.291"></a><span id="l35.291" class="difflineplus">+                SetFlag(SMTP_AUTH_PLAIN_ENABLED);</span>
<a href="#l35.292"></a><span id="l35.292"> </span>
<a href="#l35.293"></a><span id="l35.293" class="difflineminus">-                if (responseLine.Find(&quot;LOGIN&quot;, PR_TRUE, 5) &gt;= 0)</span>
<a href="#l35.294"></a><span id="l35.294" class="difflineminus">-                    SetFlag(SMTP_AUTH_LOGIN_ENABLED);</span>
<a href="#l35.295"></a><span id="l35.295" class="difflineplus">+            if (responseLine.Find(&quot;LOGIN&quot;, PR_TRUE, 5) &gt;= 0)</span>
<a href="#l35.296"></a><span id="l35.296" class="difflineplus">+                SetFlag(SMTP_AUTH_LOGIN_ENABLED);</span>
<a href="#l35.297"></a><span id="l35.297"> </span>
<a href="#l35.298"></a><span id="l35.298" class="difflineminus">-                if (responseLine.Find(&quot;EXTERNAL&quot;, PR_TRUE, 5) &gt;= 0)</span>
<a href="#l35.299"></a><span id="l35.299" class="difflineminus">-                    SetFlag(SMTP_AUTH_EXTERNAL_ENABLED);</span>
<a href="#l35.300"></a><span id="l35.300" class="difflineminus">-            }</span>
<a href="#l35.301"></a><span id="l35.301" class="difflineminus">-</span>
<a href="#l35.302"></a><span id="l35.302" class="difflineminus">-            // for use after mechs disabled fallbacks when login failed</span>
<a href="#l35.303"></a><span id="l35.303" class="difflineminus">-            BackupAuthFlags();</span>
<a href="#l35.304"></a><span id="l35.304" class="difflineplus">+            if (responseLine.Find(&quot;EXTERNAL&quot;, PR_TRUE, 5) &gt;= 0)</span>
<a href="#l35.305"></a><span id="l35.305" class="difflineplus">+                SetFlag(SMTP_AUTH_EXTERNAL_ENABLED);</span>
<a href="#l35.306"></a><span id="l35.306">         }</span>
<a href="#l35.307"></a><span id="l35.307">         else if (responseLine.Compare(&quot;SIZE&quot;, PR_TRUE, 4) == 0)</span>
<a href="#l35.308"></a><span id="l35.308">         {</span>
<a href="#l35.309"></a><span id="l35.309">             SetFlag(SMTP_EHLO_SIZE_ENABLED);</span>
<a href="#l35.310"></a><span id="l35.310"> </span>
<a href="#l35.311"></a><span id="l35.311">             m_sizelimit = atol((responseLine.get()) + 4);</span>
<a href="#l35.312"></a><span id="l35.312">         }</span>
<a href="#l35.313"></a><span id="l35.313"> </span>
<a href="#l35.314"></a><span id="l35.314" class="difflineat">@@ -860,237 +821,364 @@ PRInt32 nsSmtpProtocol::SendTLSResponse(</span>
<a href="#l35.315"></a><span id="l35.315">       }</span>
<a href="#l35.316"></a><span id="l35.316"> </span>
<a href="#l35.317"></a><span id="l35.317">       if (NS_SUCCEEDED(rv))</span>
<a href="#l35.318"></a><span id="l35.318">       {</span>
<a href="#l35.319"></a><span id="l35.319">           m_nextState = SMTP_EXTN_LOGIN_RESPONSE;</span>
<a href="#l35.320"></a><span id="l35.320">           m_nextStateAfterResponse = SMTP_EXTN_LOGIN_RESPONSE;</span>
<a href="#l35.321"></a><span id="l35.321">           m_tlsEnabled = PR_TRUE;</span>
<a href="#l35.322"></a><span id="l35.322">           m_flags = 0; // resetting the flags</span>
<a href="#l35.323"></a><span id="l35.323" class="difflineminus">-          BackupAuthFlags();</span>
<a href="#l35.324"></a><span id="l35.324">           return rv;</span>
<a href="#l35.325"></a><span id="l35.325">       }</span>
<a href="#l35.326"></a><span id="l35.326">   }</span>
<a href="#l35.327"></a><span id="l35.327"> </span>
<a href="#l35.328"></a><span id="l35.328">   ClearFlag(SMTP_EHLO_STARTTLS_ENABLED);</span>
<a href="#l35.329"></a><span id="l35.329">   m_tlsInitiated = PR_FALSE;</span>
<a href="#l35.330"></a><span id="l35.330">   m_nextState = SMTP_AUTH_PROCESS_STATE;</span>
<a href="#l35.331"></a><span id="l35.331"> </span>
<a href="#l35.332"></a><span id="l35.332">   return rv;</span>
<a href="#l35.333"></a><span id="l35.333"> }</span>
<a href="#l35.334"></a><span id="l35.334"> </span>
<a href="#l35.335"></a><span id="l35.335" class="difflineplus">+void nsSmtpProtocol::InitPrefAuthMethods(PRInt32 authMethodPrefValue)</span>
<a href="#l35.336"></a><span id="l35.336" class="difflineplus">+{</span>
<a href="#l35.337"></a><span id="l35.337" class="difflineplus">+  // for m_prefAuthMethods, using the same flags as server capablities.</span>
<a href="#l35.338"></a><span id="l35.338" class="difflineplus">+  switch (authMethodPrefValue)</span>
<a href="#l35.339"></a><span id="l35.339" class="difflineplus">+  {</span>
<a href="#l35.340"></a><span id="l35.340" class="difflineplus">+    case nsMsgAuthMethod::none:</span>
<a href="#l35.341"></a><span id="l35.341" class="difflineplus">+      m_prefAuthMethods = SMTP_AUTH_NONE_ENABLED;</span>
<a href="#l35.342"></a><span id="l35.342" class="difflineplus">+      break;</span>
<a href="#l35.343"></a><span id="l35.343" class="difflineplus">+    //case nsMsgAuthMethod::old -- no such thing for SMTP</span>
<a href="#l35.344"></a><span id="l35.344" class="difflineplus">+    case nsMsgAuthMethod::passwordCleartext:</span>
<a href="#l35.345"></a><span id="l35.345" class="difflineplus">+      m_prefAuthMethods = SMTP_AUTH_LOGIN_ENABLED |</span>
<a href="#l35.346"></a><span id="l35.346" class="difflineplus">+        SMTP_AUTH_PLAIN_ENABLED;</span>
<a href="#l35.347"></a><span id="l35.347" class="difflineplus">+      break;</span>
<a href="#l35.348"></a><span id="l35.348" class="difflineplus">+    case nsMsgAuthMethod::passwordEncrypted:</span>
<a href="#l35.349"></a><span id="l35.349" class="difflineplus">+      m_prefAuthMethods = SMTP_AUTH_CRAM_MD5_ENABLED;</span>
<a href="#l35.350"></a><span id="l35.350" class="difflineplus">+      break;</span>
<a href="#l35.351"></a><span id="l35.351" class="difflineplus">+    case nsMsgAuthMethod::NTLM:</span>
<a href="#l35.352"></a><span id="l35.352" class="difflineplus">+      m_prefAuthMethods = SMTP_AUTH_NTLM_ENABLED |</span>
<a href="#l35.353"></a><span id="l35.353" class="difflineplus">+          SMTP_AUTH_MSN_ENABLED;</span>
<a href="#l35.354"></a><span id="l35.354" class="difflineplus">+      break;</span>
<a href="#l35.355"></a><span id="l35.355" class="difflineplus">+    case nsMsgAuthMethod::GSSAPI:</span>
<a href="#l35.356"></a><span id="l35.356" class="difflineplus">+      m_prefAuthMethods = SMTP_AUTH_GSSAPI_ENABLED;</span>
<a href="#l35.357"></a><span id="l35.357" class="difflineplus">+      break;</span>
<a href="#l35.358"></a><span id="l35.358" class="difflineplus">+    case nsMsgAuthMethod::secure:</span>
<a href="#l35.359"></a><span id="l35.359" class="difflineplus">+      m_prefAuthMethods = SMTP_AUTH_CRAM_MD5_ENABLED |</span>
<a href="#l35.360"></a><span id="l35.360" class="difflineplus">+          SMTP_AUTH_GSSAPI_ENABLED |</span>
<a href="#l35.361"></a><span id="l35.361" class="difflineplus">+          SMTP_AUTH_NTLM_ENABLED | SMTP_AUTH_MSN_ENABLED |</span>
<a href="#l35.362"></a><span id="l35.362" class="difflineplus">+          SMTP_AUTH_EXTERNAL_ENABLED; // TODO: Expose EXTERNAL? How?</span>
<a href="#l35.363"></a><span id="l35.363" class="difflineplus">+      break;</span>
<a href="#l35.364"></a><span id="l35.364" class="difflineplus">+    default:</span>
<a href="#l35.365"></a><span id="l35.365" class="difflineplus">+      NS_ASSERTION(false, &quot;SMTP: authMethod pref invalid&quot;);</span>
<a href="#l35.366"></a><span id="l35.366" class="difflineplus">+      // TODO log to error console</span>
<a href="#l35.367"></a><span id="l35.367" class="difflineplus">+      PR_LOG(SMTPLogModule, PR_LOG_ERROR,</span>
<a href="#l35.368"></a><span id="l35.368" class="difflineplus">+          (&quot;SMTP: bad pref authMethod = %d\n&quot;, authMethodPrefValue));</span>
<a href="#l35.369"></a><span id="l35.369" class="difflineplus">+      // fall to any</span>
<a href="#l35.370"></a><span id="l35.370" class="difflineplus">+    case nsMsgAuthMethod::anything:</span>
<a href="#l35.371"></a><span id="l35.371" class="difflineplus">+      m_prefAuthMethods =</span>
<a href="#l35.372"></a><span id="l35.372" class="difflineplus">+          SMTP_AUTH_LOGIN_ENABLED | SMTP_AUTH_PLAIN_ENABLED |</span>
<a href="#l35.373"></a><span id="l35.373" class="difflineplus">+          SMTP_AUTH_CRAM_MD5_ENABLED | SMTP_AUTH_GSSAPI_ENABLED |</span>
<a href="#l35.374"></a><span id="l35.374" class="difflineplus">+          SMTP_AUTH_NTLM_ENABLED | SMTP_AUTH_MSN_ENABLED |</span>
<a href="#l35.375"></a><span id="l35.375" class="difflineplus">+          SMTP_AUTH_EXTERNAL_ENABLED;</span>
<a href="#l35.376"></a><span id="l35.376" class="difflineplus">+      break;</span>
<a href="#l35.377"></a><span id="l35.377" class="difflineplus">+  }</span>
<a href="#l35.378"></a><span id="l35.378" class="difflineplus">+  NS_ASSERTION(m_prefAuthMethods != 0, &quot;SMTP:InitPrefAuthMethods() failed&quot;);</span>
<a href="#l35.379"></a><span id="l35.379" class="difflineplus">+}</span>
<a href="#l35.380"></a><span id="l35.380" class="difflineplus">+</span>
<a href="#l35.381"></a><span id="l35.381" class="difflineplus">+/**</span>
<a href="#l35.382"></a><span id="l35.382" class="difflineplus">+ * Changes m_currentAuthMethod to pick the next-best one</span>
<a href="#l35.383"></a><span id="l35.383" class="difflineplus">+ * which is allowed by server and prefs and not marked failed.</span>
<a href="#l35.384"></a><span id="l35.384" class="difflineplus">+ * The order of preference and trying of auth methods is encoded here.</span>
<a href="#l35.385"></a><span id="l35.385" class="difflineplus">+ */</span>
<a href="#l35.386"></a><span id="l35.386" class="difflineplus">+nsresult nsSmtpProtocol::ChooseAuthMethod()</span>
<a href="#l35.387"></a><span id="l35.387" class="difflineplus">+{</span>
<a href="#l35.388"></a><span id="l35.388" class="difflineplus">+  PRInt32 serverCaps = m_flags; // from nsMsgProtocol::TestFlag()</span>
<a href="#l35.389"></a><span id="l35.389" class="difflineplus">+  PRInt32 availCaps = serverCaps &amp; m_prefAuthMethods &amp; ~m_failedAuthMethods;</span>
<a href="#l35.390"></a><span id="l35.390" class="difflineplus">+</span>
<a href="#l35.391"></a><span id="l35.391" class="difflineplus">+  PR_LOG(SMTPLogModule, PR_LOG_DEBUG,</span>
<a href="#l35.392"></a><span id="l35.392" class="difflineplus">+        (&quot;SMTP auth: server caps 0x%X, pref 0x%X, failed 0x%X, avail caps 0x%X&quot;,</span>
<a href="#l35.393"></a><span id="l35.393" class="difflineplus">+        serverCaps, m_prefAuthMethods, m_failedAuthMethods, availCaps));</span>
<a href="#l35.394"></a><span id="l35.394" class="difflineplus">+  PR_LOG(SMTPLogModule, PR_LOG_DEBUG,</span>
<a href="#l35.395"></a><span id="l35.395" class="difflineplus">+        (&quot;(GSSAPI = 0x%X, CRAM = 0x%X, NTLM = 0x%X, &quot;</span>
<a href="#l35.396"></a><span id="l35.396" class="difflineplus">+        &quot;MSN =  0x%X, PLAIN = 0x%X, LOGIN = 0x%X, EXTERNAL = 0x%X)&quot;,</span>
<a href="#l35.397"></a><span id="l35.397" class="difflineplus">+        SMTP_AUTH_GSSAPI_ENABLED, SMTP_AUTH_CRAM_MD5_ENABLED,</span>
<a href="#l35.398"></a><span id="l35.398" class="difflineplus">+        SMTP_AUTH_NTLM_ENABLED, SMTP_AUTH_MSN_ENABLED, SMTP_AUTH_PLAIN_ENABLED,</span>
<a href="#l35.399"></a><span id="l35.399" class="difflineplus">+        SMTP_AUTH_LOGIN_ENABLED, SMTP_AUTH_EXTERNAL_ENABLED));</span>
<a href="#l35.400"></a><span id="l35.400" class="difflineplus">+</span>
<a href="#l35.401"></a><span id="l35.401" class="difflineplus">+  if (SMTP_AUTH_GSSAPI_ENABLED &amp; availCaps)</span>
<a href="#l35.402"></a><span id="l35.402" class="difflineplus">+    m_currentAuthMethod = SMTP_AUTH_GSSAPI_ENABLED;</span>
<a href="#l35.403"></a><span id="l35.403" class="difflineplus">+  else if (SMTP_AUTH_CRAM_MD5_ENABLED &amp; availCaps)</span>
<a href="#l35.404"></a><span id="l35.404" class="difflineplus">+    m_currentAuthMethod = SMTP_AUTH_CRAM_MD5_ENABLED;</span>
<a href="#l35.405"></a><span id="l35.405" class="difflineplus">+  else if (SMTP_AUTH_NTLM_ENABLED &amp; availCaps)</span>
<a href="#l35.406"></a><span id="l35.406" class="difflineplus">+    m_currentAuthMethod = SMTP_AUTH_NTLM_ENABLED;</span>
<a href="#l35.407"></a><span id="l35.407" class="difflineplus">+  else if (SMTP_AUTH_MSN_ENABLED &amp; availCaps)</span>
<a href="#l35.408"></a><span id="l35.408" class="difflineplus">+    m_currentAuthMethod = SMTP_AUTH_MSN_ENABLED;</span>
<a href="#l35.409"></a><span id="l35.409" class="difflineplus">+  else if (SMTP_AUTH_PLAIN_ENABLED &amp; availCaps)</span>
<a href="#l35.410"></a><span id="l35.410" class="difflineplus">+    m_currentAuthMethod = SMTP_AUTH_PLAIN_ENABLED;</span>
<a href="#l35.411"></a><span id="l35.411" class="difflineplus">+  else if (SMTP_AUTH_LOGIN_ENABLED &amp; availCaps)</span>
<a href="#l35.412"></a><span id="l35.412" class="difflineplus">+    m_currentAuthMethod = SMTP_AUTH_LOGIN_ENABLED;</span>
<a href="#l35.413"></a><span id="l35.413" class="difflineplus">+  else if (SMTP_AUTH_EXTERNAL_ENABLED &amp; availCaps)</span>
<a href="#l35.414"></a><span id="l35.414" class="difflineplus">+    m_currentAuthMethod = SMTP_AUTH_EXTERNAL_ENABLED;</span>
<a href="#l35.415"></a><span id="l35.415" class="difflineplus">+  else</span>
<a href="#l35.416"></a><span id="l35.416" class="difflineplus">+  {</span>
<a href="#l35.417"></a><span id="l35.417" class="difflineplus">+    PR_LOG(SMTPLogModule, PR_LOG_ERROR, (&quot;no auth method remaining&quot;));</span>
<a href="#l35.418"></a><span id="l35.418" class="difflineplus">+    m_currentAuthMethod = 0;</span>
<a href="#l35.419"></a><span id="l35.419" class="difflineplus">+    return NS_ERROR_SMTP_AUTH_FAILURE;</span>
<a href="#l35.420"></a><span id="l35.420" class="difflineplus">+  }</span>
<a href="#l35.421"></a><span id="l35.421" class="difflineplus">+  PR_LOG(SMTPLogModule, PR_LOG_DEBUG, (&quot;trying auth method 0x%X&quot;, m_currentAuthMethod));</span>
<a href="#l35.422"></a><span id="l35.422" class="difflineplus">+  return NS_OK;</span>
<a href="#l35.423"></a><span id="l35.423" class="difflineplus">+}</span>
<a href="#l35.424"></a><span id="l35.424" class="difflineplus">+</span>
<a href="#l35.425"></a><span id="l35.425" class="difflineplus">+void nsSmtpProtocol::MarkAuthMethodAsFailed(PRInt32 failedAuthMethod)</span>
<a href="#l35.426"></a><span id="l35.426" class="difflineplus">+{</span>
<a href="#l35.427"></a><span id="l35.427" class="difflineplus">+  PR_LOG(SMTPLogModule, PR_LOG_DEBUG,</span>
<a href="#l35.428"></a><span id="l35.428" class="difflineplus">+      (&quot;marking auth method 0x%X failed&quot;, failedAuthMethod));</span>
<a href="#l35.429"></a><span id="l35.429" class="difflineplus">+  m_failedAuthMethods |= failedAuthMethod;</span>
<a href="#l35.430"></a><span id="l35.430" class="difflineplus">+}</span>
<a href="#l35.431"></a><span id="l35.431" class="difflineplus">+</span>
<a href="#l35.432"></a><span id="l35.432" class="difflineplus">+/**</span>
<a href="#l35.433"></a><span id="l35.433" class="difflineplus">+ * Start over, trying all auth methods again</span>
<a href="#l35.434"></a><span id="l35.434" class="difflineplus">+ */</span>
<a href="#l35.435"></a><span id="l35.435" class="difflineplus">+void nsSmtpProtocol::ResetAuthMethods()</span>
<a href="#l35.436"></a><span id="l35.436" class="difflineplus">+{</span>
<a href="#l35.437"></a><span id="l35.437" class="difflineplus">+  m_currentAuthMethod = 0;</span>
<a href="#l35.438"></a><span id="l35.438" class="difflineplus">+  m_failedAuthMethods = 0;</span>
<a href="#l35.439"></a><span id="l35.439" class="difflineplus">+}</span>
<a href="#l35.440"></a><span id="l35.440" class="difflineplus">+</span>
<a href="#l35.441"></a><span id="l35.441"> PRInt32 nsSmtpProtocol::ProcessAuth()</span>
<a href="#l35.442"></a><span id="l35.442"> {</span>
<a href="#l35.443"></a><span id="l35.443">     PRInt32 status = 0;</span>
<a href="#l35.444"></a><span id="l35.444">     nsCAutoString buffer;</span>
<a href="#l35.445"></a><span id="l35.445">     nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(m_runningURL);</span>
<a href="#l35.446"></a><span id="l35.446"> </span>
<a href="#l35.447"></a><span id="l35.447">     if (!m_tlsEnabled)</span>
<a href="#l35.448"></a><span id="l35.448">     {</span>
<a href="#l35.449"></a><span id="l35.449">         if (TestFlag(SMTP_EHLO_STARTTLS_ENABLED))</span>
<a href="#l35.450"></a><span id="l35.450">         {</span>
<a href="#l35.451"></a><span id="l35.451">             // Do not try to combine SMTPS with STARTTLS.</span>
<a href="#l35.452"></a><span id="l35.452" class="difflineminus">-            // If PREF_SECURE_ALWAYS_SMTPS is set,</span>
<a href="#l35.453"></a><span id="l35.453" class="difflineplus">+            // If nsMsgSocketType::SSL is set,</span>
<a href="#l35.454"></a><span id="l35.454">             // we are alrady using a secure connection.</span>
<a href="#l35.455"></a><span id="l35.455">             // Do not attempt to do STARTTLS,</span>
<a href="#l35.456"></a><span id="l35.456">             // even if server offers it.</span>
<a href="#l35.457"></a><span id="l35.457" class="difflineminus">-            if (m_prefTrySSL == PREF_SECURE_TRY_STARTTLS ||</span>
<a href="#l35.458"></a><span id="l35.458" class="difflineminus">-                m_prefTrySSL == PREF_SECURE_ALWAYS_STARTTLS)</span>
<a href="#l35.459"></a><span id="l35.459" class="difflineplus">+            if (m_prefSocketType == nsMsgSocketType::trySTARTTLS ||</span>
<a href="#l35.460"></a><span id="l35.460" class="difflineplus">+                m_prefSocketType == nsMsgSocketType::alwaysSTARTTLS)</span>
<a href="#l35.461"></a><span id="l35.461">             {</span>
<a href="#l35.462"></a><span id="l35.462">                 buffer = &quot;STARTTLS&quot;;</span>
<a href="#l35.463"></a><span id="l35.463">                 buffer += CRLF;</span>
<a href="#l35.464"></a><span id="l35.464"> </span>
<a href="#l35.465"></a><span id="l35.465">                 status = SendData(url, buffer.get());</span>
<a href="#l35.466"></a><span id="l35.466"> </span>
<a href="#l35.467"></a><span id="l35.467">                 m_tlsInitiated = PR_TRUE;</span>
<a href="#l35.468"></a><span id="l35.468"> </span>
<a href="#l35.469"></a><span id="l35.469">                 m_nextState = SMTP_RESPONSE;</span>
<a href="#l35.470"></a><span id="l35.470">                 m_nextStateAfterResponse = SMTP_TLS_RESPONSE;</span>
<a href="#l35.471"></a><span id="l35.471">                 SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l35.472"></a><span id="l35.472">                 return status;</span>
<a href="#l35.473"></a><span id="l35.473">             }</span>
<a href="#l35.474"></a><span id="l35.474">         }</span>
<a href="#l35.475"></a><span id="l35.475" class="difflineminus">-        else if (m_prefTrySSL == PREF_SECURE_ALWAYS_STARTTLS)</span>
<a href="#l35.476"></a><span id="l35.476" class="difflineplus">+        else if (m_prefSocketType == nsMsgSocketType::alwaysSTARTTLS)</span>
<a href="#l35.477"></a><span id="l35.477">         {</span>
<a href="#l35.478"></a><span id="l35.478">             m_nextState = SMTP_ERROR_DONE;</span>
<a href="#l35.479"></a><span id="l35.479">             m_urlErrorState = NS_ERROR_STARTTLS_FAILED_EHLO_STARTTLS;</span>
<a href="#l35.480"></a><span id="l35.480" class="difflineminus">-            return NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER;</span>
<a href="#l35.481"></a><span id="l35.481" class="difflineplus">+            return NS_ERROR_STARTTLS_FAILED_EHLO_STARTTLS;</span>
<a href="#l35.482"></a><span id="l35.482">         }</span>
<a href="#l35.483"></a><span id="l35.483">     }</span>
<a href="#l35.484"></a><span id="l35.484" class="difflineplus">+  // (wrong indention until here)</span>
<a href="#l35.485"></a><span id="l35.485"> </span>
<a href="#l35.486"></a><span id="l35.486" class="difflineminus">-    if (TestFlag(SMTP_AUTH_EXTERNAL_ENABLED))</span>
<a href="#l35.487"></a><span id="l35.487" class="difflineminus">-    {</span>
<a href="#l35.488"></a><span id="l35.488" class="difflineminus">-        buffer = &quot;AUTH EXTERNAL =&quot;;</span>
<a href="#l35.489"></a><span id="l35.489" class="difflineminus">-        buffer += CRLF;</span>
<a href="#l35.490"></a><span id="l35.490" class="difflineminus">-        SendData(url, buffer.get());</span>
<a href="#l35.491"></a><span id="l35.491" class="difflineminus">-        m_nextState = SMTP_RESPONSE;</span>
<a href="#l35.492"></a><span id="l35.492" class="difflineminus">-        m_nextStateAfterResponse = SMTP_AUTH_EXTERNAL_RESPONSE;</span>
<a href="#l35.493"></a><span id="l35.493" class="difflineminus">-        SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l35.494"></a><span id="l35.494" class="difflineminus">-        return NS_OK;</span>
<a href="#l35.495"></a><span id="l35.495" class="difflineminus">-    }</span>
<a href="#l35.496"></a><span id="l35.496" class="difflineminus">-    else</span>
<a href="#l35.497"></a><span id="l35.497" class="difflineminus">-    if (m_prefAuthMethod == PREF_AUTH_ANY)</span>
<a href="#l35.498"></a><span id="l35.498" class="difflineminus">-    {</span>
<a href="#l35.499"></a><span id="l35.499" class="difflineminus">-        // did the server advertise authentication capability at all?</span>
<a href="#l35.500"></a><span id="l35.500" class="difflineminus">-        if (!TestFlag(SMTP_AUTH))</span>
<a href="#l35.501"></a><span id="l35.501" class="difflineminus">-        {</span>
<a href="#l35.502"></a><span id="l35.502" class="difflineminus">-            m_nextState = SMTP_ERROR_DONE;</span>
<a href="#l35.503"></a><span id="l35.503" class="difflineminus">-            m_urlErrorState = NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER_AUTH_NONE;</span>
<a href="#l35.504"></a><span id="l35.504" class="difflineminus">-            return NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER;</span>
<a href="#l35.505"></a><span id="l35.505" class="difflineminus">-        }</span>
<a href="#l35.506"></a><span id="l35.506" class="difflineplus">+  (void) ChooseAuthMethod(); // advance m_currentAuthMethod</span>
<a href="#l35.507"></a><span id="l35.507"> </span>
<a href="#l35.508"></a><span id="l35.508" class="difflineminus">-        /* check if the server supports at least one of the mechanisms</span>
<a href="#l35.509"></a><span id="l35.509" class="difflineminus">-           in the class the user wants us to use */</span>
<a href="#l35.510"></a><span id="l35.510" class="difflineminus">-        if (m_prefUseSecAuth)</span>
<a href="#l35.511"></a><span id="l35.511" class="difflineminus">-        {</span>
<a href="#l35.512"></a><span id="l35.512" class="difflineminus">-            if (!TestFlag(SMTP_AUTH_SEC_ENABLED))</span>
<a href="#l35.513"></a><span id="l35.513" class="difflineminus">-                m_urlErrorState = NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER_SECAUTH;</span>
<a href="#l35.514"></a><span id="l35.514" class="difflineminus">-        }</span>
<a href="#l35.515"></a><span id="l35.515" class="difflineminus">-        else</span>
<a href="#l35.516"></a><span id="l35.516" class="difflineminus">-        {</span>
<a href="#l35.517"></a><span id="l35.517" class="difflineminus">-            if (!TestFlag(SMTP_AUTH_INSEC_ENABLED))</span>
<a href="#l35.518"></a><span id="l35.518" class="difflineminus">-                m_urlErrorState = NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER_INSECAUTH;</span>
<a href="#l35.519"></a><span id="l35.519" class="difflineminus">-        }</span>
<a href="#l35.520"></a><span id="l35.520" class="difflineplus">+  if (m_prefAuthMethods == SMTP_AUTH_NONE_ENABLED) // No auth needed</span>
<a href="#l35.521"></a><span id="l35.521" class="difflineplus">+  {</span>
<a href="#l35.522"></a><span id="l35.522" class="difflineplus">+    m_nextState = SMTP_SEND_HELO_RESPONSE;</span>
<a href="#l35.523"></a><span id="l35.523" class="difflineplus">+    // fake to 250 because SendHeloResponse() tests for this</span>
<a href="#l35.524"></a><span id="l35.524" class="difflineplus">+    m_responseCode = 250;</span>
<a href="#l35.525"></a><span id="l35.525" class="difflineplus">+  }</span>
<a href="#l35.526"></a><span id="l35.526" class="difflineplus">+  // did the server advertise authentication capability at all,</span>
<a href="#l35.527"></a><span id="l35.527" class="difflineplus">+  // but we wanted to auth?</span>
<a href="#l35.528"></a><span id="l35.528" class="difflineplus">+  else if (!TestFlag(SMTP_AUTH))</span>
<a href="#l35.529"></a><span id="l35.529" class="difflineplus">+  {</span>
<a href="#l35.530"></a><span id="l35.530" class="difflineplus">+    m_urlErrorState = NS_ERROR_SMTP_AUTH_NOT_SUPPORTED;</span>
<a href="#l35.531"></a><span id="l35.531" class="difflineplus">+    m_nextState = SMTP_ERROR_DONE;</span>
<a href="#l35.532"></a><span id="l35.532" class="difflineplus">+    return NS_ERROR_SMTP_AUTH_FAILURE;</span>
<a href="#l35.533"></a><span id="l35.533" class="difflineplus">+  }</span>
<a href="#l35.534"></a><span id="l35.534" class="difflineplus">+  else if (m_currentAuthMethod == SMTP_AUTH_EXTERNAL_ENABLED)</span>
<a href="#l35.535"></a><span id="l35.535" class="difflineplus">+  {</span>
<a href="#l35.536"></a><span id="l35.536" class="difflineplus">+    buffer = &quot;AUTH EXTERNAL =&quot;;</span>
<a href="#l35.537"></a><span id="l35.537" class="difflineplus">+    buffer += CRLF;</span>
<a href="#l35.538"></a><span id="l35.538" class="difflineplus">+    SendData(url, buffer.get());</span>
<a href="#l35.539"></a><span id="l35.539" class="difflineplus">+    m_nextState = SMTP_RESPONSE;</span>
<a href="#l35.540"></a><span id="l35.540" class="difflineplus">+    m_nextStateAfterResponse = SMTP_AUTH_EXTERNAL_RESPONSE;</span>
<a href="#l35.541"></a><span id="l35.541" class="difflineplus">+    SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l35.542"></a><span id="l35.542" class="difflineplus">+    return NS_OK;</span>
<a href="#l35.543"></a><span id="l35.543" class="difflineplus">+  }</span>
<a href="#l35.544"></a><span id="l35.544" class="difflineplus">+  else if (m_currentAuthMethod == SMTP_AUTH_GSSAPI_ENABLED)</span>
<a href="#l35.545"></a><span id="l35.545" class="difflineplus">+  {</span>
<a href="#l35.546"></a><span id="l35.546" class="difflineplus">+    m_nextState = SMTP_SEND_AUTH_GSSAPI_FIRST;</span>
<a href="#l35.547"></a><span id="l35.547" class="difflineplus">+  }</span>
<a href="#l35.548"></a><span id="l35.548" class="difflineplus">+  else if (m_currentAuthMethod == SMTP_AUTH_CRAM_MD5_ENABLED ||</span>
<a href="#l35.549"></a><span id="l35.549" class="difflineplus">+           m_currentAuthMethod == SMTP_AUTH_PLAIN_ENABLED ||</span>
<a href="#l35.550"></a><span id="l35.550" class="difflineplus">+           m_currentAuthMethod == SMTP_AUTH_NTLM_ENABLED)</span>
<a href="#l35.551"></a><span id="l35.551" class="difflineplus">+  {</span>
<a href="#l35.552"></a><span id="l35.552" class="difflineplus">+    m_nextState = SMTP_SEND_AUTH_LOGIN_STEP1;</span>
<a href="#l35.553"></a><span id="l35.553" class="difflineplus">+  }</span>
<a href="#l35.554"></a><span id="l35.554" class="difflineplus">+  else if (m_currentAuthMethod == SMTP_AUTH_LOGIN_ENABLED ||</span>
<a href="#l35.555"></a><span id="l35.555" class="difflineplus">+           m_currentAuthMethod == SMTP_AUTH_MSN_ENABLED)</span>
<a href="#l35.556"></a><span id="l35.556" class="difflineplus">+  {</span>
<a href="#l35.557"></a><span id="l35.557" class="difflineplus">+    m_nextState = SMTP_SEND_AUTH_LOGIN_STEP0;</span>
<a href="#l35.558"></a><span id="l35.558" class="difflineplus">+  }</span>
<a href="#l35.559"></a><span id="l35.559" class="difflineplus">+  else // All auth methods failed</span>
<a href="#l35.560"></a><span id="l35.560" class="difflineplus">+  {</span>
<a href="#l35.561"></a><span id="l35.561" class="difflineplus">+    // show an appropriate error msg</span>
<a href="#l35.562"></a><span id="l35.562" class="difflineplus">+    if (m_failedAuthMethods == 0)</span>
<a href="#l35.563"></a><span id="l35.563" class="difflineplus">+    {</span>
<a href="#l35.564"></a><span id="l35.564" class="difflineplus">+      // we didn't even try anything, so we had a non-working config:</span>
<a href="#l35.565"></a><span id="l35.565" class="difflineplus">+      // pref doesn't match server</span>
<a href="#l35.566"></a><span id="l35.566" class="difflineplus">+      PR_LOG(SMTPLogModule, PR_LOG_ERROR,</span>
<a href="#l35.567"></a><span id="l35.567" class="difflineplus">+          (&quot;no working auth mech - pref doesn't match server capas&quot;));</span>
<a href="#l35.568"></a><span id="l35.568"> </span>
<a href="#l35.569"></a><span id="l35.569" class="difflineminus">-        if (m_urlErrorState != NS_ERROR_FAILURE)</span>
<a href="#l35.570"></a><span id="l35.570" class="difflineminus">-        {</span>
<a href="#l35.571"></a><span id="l35.571" class="difflineminus">-            m_nextState = SMTP_ERROR_DONE;</span>
<a href="#l35.572"></a><span id="l35.572" class="difflineminus">-            return NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER;</span>
<a href="#l35.573"></a><span id="l35.573" class="difflineminus">-        }</span>
<a href="#l35.574"></a><span id="l35.574" class="difflineminus">-</span>
<a href="#l35.575"></a><span id="l35.575" class="difflineminus">-</span>
<a href="#l35.576"></a><span id="l35.576" class="difflineminus">-        if (TestFlag(SMTP_AUTH_GSSAPI_ENABLED))</span>
<a href="#l35.577"></a><span id="l35.577" class="difflineminus">-            m_nextState = SMTP_SEND_AUTH_GSSAPI_FIRST;</span>
<a href="#l35.578"></a><span id="l35.578" class="difflineminus">-        else if (TestFlag(SMTP_AUTH_CRAM_MD5_ENABLED) ||</span>
<a href="#l35.579"></a><span id="l35.579" class="difflineminus">-                 TestFlag(SMTP_AUTH_NTLM_ENABLED) ||</span>
<a href="#l35.580"></a><span id="l35.580" class="difflineminus">-                 TestFlag(SMTP_AUTH_PLAIN_ENABLED))</span>
<a href="#l35.581"></a><span id="l35.581" class="difflineminus">-            m_nextState = SMTP_SEND_AUTH_LOGIN_STEP1;</span>
<a href="#l35.582"></a><span id="l35.582" class="difflineminus">-        else if (TestFlag(SMTP_AUTH_MSN_ENABLED) ||</span>
<a href="#l35.583"></a><span id="l35.583" class="difflineminus">-                 TestFlag(SMTP_AUTH_LOGIN_ENABLED))</span>
<a href="#l35.584"></a><span id="l35.584" class="difflineminus">-            m_nextState = SMTP_SEND_AUTH_LOGIN_STEP0;</span>
<a href="#l35.585"></a><span id="l35.585" class="difflineplus">+      // pref has encrypted pw &amp; server claims to support plaintext pw</span>
<a href="#l35.586"></a><span id="l35.586" class="difflineplus">+      if (m_prefAuthMethods == SMTP_AUTH_CRAM_MD5_ENABLED &amp;&amp;</span>
<a href="#l35.587"></a><span id="l35.587" class="difflineplus">+          m_flags &amp; (SMTP_AUTH_LOGIN_ENABLED | SMTP_AUTH_PLAIN_ENABLED))</span>
<a href="#l35.588"></a><span id="l35.588" class="difflineplus">+      {</span>
<a href="#l35.589"></a><span id="l35.589" class="difflineplus">+        // have SSL</span>
<a href="#l35.590"></a><span id="l35.590" class="difflineplus">+        if (m_prefSocketType == nsMsgSocketType::SSL ||</span>
<a href="#l35.591"></a><span id="l35.591" class="difflineplus">+            m_prefSocketType == nsMsgSocketType::alwaysSTARTTLS)</span>
<a href="#l35.592"></a><span id="l35.592" class="difflineplus">+          // tell user to change to plaintext pw</span>
<a href="#l35.593"></a><span id="l35.593" class="difflineplus">+          m_urlErrorState = NS_ERROR_SMTP_AUTH_CHANGE_ENCRYPT_TO_PLAIN_SSL;</span>
<a href="#l35.594"></a><span id="l35.594" class="difflineplus">+        else</span>
<a href="#l35.595"></a><span id="l35.595" class="difflineplus">+          // tell user to change to plaintext pw, with big warning</span>
<a href="#l35.596"></a><span id="l35.596" class="difflineplus">+          m_urlErrorState = NS_ERROR_SMTP_AUTH_CHANGE_ENCRYPT_TO_PLAIN_NO_SSL;</span>
<a href="#l35.597"></a><span id="l35.597" class="difflineplus">+      }</span>
<a href="#l35.598"></a><span id="l35.598" class="difflineplus">+      // pref has plaintext pw &amp; server claims to support encrypted pw</span>
<a href="#l35.599"></a><span id="l35.599" class="difflineplus">+      else if (m_prefAuthMethods == (SMTP_AUTH_LOGIN_ENABLED |</span>
<a href="#l35.600"></a><span id="l35.600" class="difflineplus">+                   SMTP_AUTH_PLAIN_ENABLED) &amp;&amp;</span>
<a href="#l35.601"></a><span id="l35.601" class="difflineplus">+               m_flags &amp; SMTP_AUTH_CRAM_MD5_ENABLED)</span>
<a href="#l35.602"></a><span id="l35.602" class="difflineplus">+        // tell user to change to encrypted pw</span>
<a href="#l35.603"></a><span id="l35.603" class="difflineplus">+        m_urlErrorState = NS_ERROR_SMTP_AUTH_CHANGE_PLAIN_TO_ENCRYPT;</span>
<a href="#l35.604"></a><span id="l35.604" class="difflineplus">+      else</span>
<a href="#l35.605"></a><span id="l35.605" class="difflineplus">+      {</span>
<a href="#l35.606"></a><span id="l35.606" class="difflineplus">+        // just &quot;change auth method&quot;</span>
<a href="#l35.607"></a><span id="l35.607" class="difflineplus">+        m_urlErrorState = NS_ERROR_SMTP_AUTH_MECH_NOT_SUPPORTED;</span>
<a href="#l35.608"></a><span id="l35.608" class="difflineplus">+      }</span>
<a href="#l35.609"></a><span id="l35.609" class="difflineplus">+    }</span>
<a href="#l35.610"></a><span id="l35.610" class="difflineplus">+    else if (m_failedAuthMethods == SMTP_AUTH_GSSAPI_ENABLED)</span>
<a href="#l35.611"></a><span id="l35.611" class="difflineplus">+    {</span>
<a href="#l35.612"></a><span id="l35.612" class="difflineplus">+      // We have only GSSAPI, and it failed, so nothing left to do.</span>
<a href="#l35.613"></a><span id="l35.613" class="difflineplus">+      PR_LOG(SMTPLogModule, PR_LOG_ERROR, (&quot;GSSAPI only and it failed&quot;));</span>
<a href="#l35.614"></a><span id="l35.614" class="difflineplus">+      m_urlErrorState = NS_ERROR_SMTP_AUTH_GSSAPI;</span>
<a href="#l35.615"></a><span id="l35.615">     }</span>
<a href="#l35.616"></a><span id="l35.616">     else</span>
<a href="#l35.617"></a><span id="l35.617">     {</span>
<a href="#l35.618"></a><span id="l35.618" class="difflineminus">-        m_nextState = SMTP_SEND_HELO_RESPONSE;</span>
<a href="#l35.619"></a><span id="l35.619" class="difflineminus">-        // fake to 250 because SendHeloResponse() tests for this</span>
<a href="#l35.620"></a><span id="l35.620" class="difflineminus">-        m_responseCode = 250;</span>
<a href="#l35.621"></a><span id="l35.621" class="difflineplus">+      // we tried to login, but it all failed</span>
<a href="#l35.622"></a><span id="l35.622" class="difflineplus">+      PR_LOG(SMTPLogModule, PR_LOG_ERROR, (&quot;All auth attempts failed&quot;));</span>
<a href="#l35.623"></a><span id="l35.623" class="difflineplus">+      m_urlErrorState = NS_ERROR_SMTP_AUTH_FAILURE;</span>
<a href="#l35.624"></a><span id="l35.624">     }</span>
<a href="#l35.625"></a><span id="l35.625" class="difflineplus">+    m_nextState = SMTP_ERROR_DONE;</span>
<a href="#l35.626"></a><span id="l35.626" class="difflineplus">+    return NS_ERROR_SMTP_AUTH_FAILURE;</span>
<a href="#l35.627"></a><span id="l35.627" class="difflineplus">+  }</span>
<a href="#l35.628"></a><span id="l35.628"> </span>
<a href="#l35.629"></a><span id="l35.629" class="difflineminus">-    return NS_OK;</span>
<a href="#l35.630"></a><span id="l35.630" class="difflineplus">+  return NS_OK;</span>
<a href="#l35.631"></a><span id="l35.631"> }</span>
<a href="#l35.632"></a><span id="l35.632"> </span>
<a href="#l35.633"></a><span id="l35.633"> </span>
<a href="#l35.634"></a><span id="l35.634" class="difflineminus">-void nsSmtpProtocol::BackupAuthFlags()</span>
<a href="#l35.635"></a><span id="l35.635" class="difflineminus">-{</span>
<a href="#l35.636"></a><span id="l35.636" class="difflineminus">-  m_origAuthFlags = m_flags &amp; SMTP_AUTH_ANY_ENABLED;</span>
<a href="#l35.637"></a><span id="l35.637" class="difflineminus">-}</span>
<a href="#l35.638"></a><span id="l35.638" class="difflineminus">-</span>
<a href="#l35.639"></a><span id="l35.639" class="difflineminus">-void nsSmtpProtocol::RestoreAuthFlags()</span>
<a href="#l35.640"></a><span id="l35.640" class="difflineminus">-{</span>
<a href="#l35.641"></a><span id="l35.641" class="difflineminus">-  m_flags |= m_origAuthFlags;</span>
<a href="#l35.642"></a><span id="l35.642" class="difflineminus">-}</span>
<a href="#l35.643"></a><span id="l35.643" class="difflineminus">-</span>
<a href="#l35.644"></a><span id="l35.644"> </span>
<a href="#l35.645"></a><span id="l35.645"> PRInt32 nsSmtpProtocol::AuthLoginResponse(nsIInputStream * stream, PRUint32 length)</span>
<a href="#l35.646"></a><span id="l35.646"> {</span>
<a href="#l35.647"></a><span id="l35.647" class="difflineplus">+  PR_LOG(SMTPLogModule, PR_LOG_DEBUG, (&quot;SMTP Login response, code %d&quot;, m_responseCode));</span>
<a href="#l35.648"></a><span id="l35.648">   PRInt32 status = 0;</span>
<a href="#l35.649"></a><span id="l35.649" class="difflineminus">-  nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l35.650"></a><span id="l35.650" class="difflineminus">-  m_runningURL-&gt;GetSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l35.651"></a><span id="l35.651"> </span>
<a href="#l35.652"></a><span id="l35.652">   switch (m_responseCode/100)</span>
<a href="#l35.653"></a><span id="l35.653">   {</span>
<a href="#l35.654"></a><span id="l35.654">     case 2:</span>
<a href="#l35.655"></a><span id="l35.655">       m_nextState = SMTP_SEND_HELO_RESPONSE;</span>
<a href="#l35.656"></a><span id="l35.656">       // fake to 250 because SendHeloResponse() tests for this</span>
<a href="#l35.657"></a><span id="l35.657">       m_responseCode = 250;</span>
<a href="#l35.658"></a><span id="l35.658">       break;</span>
<a href="#l35.659"></a><span id="l35.659">     case 3:</span>
<a href="#l35.660"></a><span id="l35.660">       m_nextState = SMTP_SEND_AUTH_LOGIN_STEP2;</span>
<a href="#l35.661"></a><span id="l35.661">       break;</span>
<a href="#l35.662"></a><span id="l35.662">     case 5:</span>
<a href="#l35.663"></a><span id="l35.663">     default:</span>
<a href="#l35.664"></a><span id="l35.664" class="difflineplus">+      nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l35.665"></a><span id="l35.665" class="difflineplus">+      m_runningURL-&gt;GetSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l35.666"></a><span id="l35.666">       if (smtpServer)</span>
<a href="#l35.667"></a><span id="l35.667">       {</span>
<a href="#l35.668"></a><span id="l35.668" class="difflineminus">-        // If one authentication failed, we're going to</span>
<a href="#l35.669"></a><span id="l35.669" class="difflineplus">+        // If one authentication failed, mark it failed, so that we're going to</span>
<a href="#l35.670"></a><span id="l35.670">         // fall back on a less secure login method.</span>
<a href="#l35.671"></a><span id="l35.671" class="difflineminus">-        if(TestFlag(SMTP_AUTH_GSSAPI_ENABLED))</span>
<a href="#l35.672"></a><span id="l35.672" class="difflineminus">-          ClearFlag(SMTP_AUTH_GSSAPI_ENABLED);</span>
<a href="#l35.673"></a><span id="l35.673" class="difflineminus">-        else if(TestFlag(SMTP_AUTH_DIGEST_MD5_ENABLED))</span>
<a href="#l35.674"></a><span id="l35.674" class="difflineminus">-          // if DIGEST-MD5 enabled, clear it if we failed.</span>
<a href="#l35.675"></a><span id="l35.675" class="difflineminus">-          ClearFlag(SMTP_AUTH_DIGEST_MD5_ENABLED);</span>
<a href="#l35.676"></a><span id="l35.676" class="difflineminus">-        else if(TestFlag(SMTP_AUTH_CRAM_MD5_ENABLED))</span>
<a href="#l35.677"></a><span id="l35.677" class="difflineminus">-          // if CRAM-MD5 enabled, clear it if we failed.</span>
<a href="#l35.678"></a><span id="l35.678" class="difflineminus">-          ClearFlag(SMTP_AUTH_CRAM_MD5_ENABLED);</span>
<a href="#l35.679"></a><span id="l35.679" class="difflineminus">-        else if(TestFlag(SMTP_AUTH_NTLM_ENABLED))</span>
<a href="#l35.680"></a><span id="l35.680" class="difflineminus">-          // if NTLM enabled, clear it if we failed.</span>
<a href="#l35.681"></a><span id="l35.681" class="difflineminus">-          ClearFlag(SMTP_AUTH_NTLM_ENABLED);</span>
<a href="#l35.682"></a><span id="l35.682" class="difflineminus">-        else if(TestFlag(SMTP_AUTH_MSN_ENABLED))</span>
<a href="#l35.683"></a><span id="l35.683" class="difflineminus">-          // if MSN enabled, clear it if we failed.</span>
<a href="#l35.684"></a><span id="l35.684" class="difflineminus">-          ClearFlag(SMTP_AUTH_MSN_ENABLED);</span>
<a href="#l35.685"></a><span id="l35.685" class="difflineminus">-        else if(TestFlag(SMTP_AUTH_PLAIN_ENABLED))</span>
<a href="#l35.686"></a><span id="l35.686" class="difflineminus">-          // if PLAIN enabled, clear it if we failed.</span>
<a href="#l35.687"></a><span id="l35.687" class="difflineminus">-          ClearFlag(SMTP_AUTH_PLAIN_ENABLED);</span>
<a href="#l35.688"></a><span id="l35.688" class="difflineminus">-        else if(TestFlag(SMTP_AUTH_LOGIN_ENABLED))</span>
<a href="#l35.689"></a><span id="l35.689" class="difflineminus">-          // if LOGIN enabled, clear it if we failed.</span>
<a href="#l35.690"></a><span id="l35.690" class="difflineminus">-          ClearFlag(SMTP_AUTH_LOGIN_ENABLED);</span>
<a href="#l35.691"></a><span id="l35.691" class="difflineplus">+        MarkAuthMethodAsFailed(m_currentAuthMethod);</span>
<a href="#l35.692"></a><span id="l35.692"> </span>
<a href="#l35.693"></a><span id="l35.693" class="difflineminus">-        // Only forget the password if we've no mechanism left.</span>
<a href="#l35.694"></a><span id="l35.694" class="difflineminus">-        if (!TestFlag(SMTP_AUTH_ANY_ENABLED))</span>
<a href="#l35.695"></a><span id="l35.695" class="difflineplus">+        PRBool allFailed = NS_FAILED(ChooseAuthMethod());</span>
<a href="#l35.696"></a><span id="l35.696" class="difflineplus">+        if (allFailed &amp;&amp; m_failedAuthMethods &gt; 0 &amp;&amp;</span>
<a href="#l35.697"></a><span id="l35.697" class="difflineplus">+            m_failedAuthMethods != SMTP_AUTH_GSSAPI_ENABLED &amp;&amp;</span>
<a href="#l35.698"></a><span id="l35.698" class="difflineplus">+            m_failedAuthMethods != SMTP_AUTH_EXTERNAL_ENABLED)</span>
<a href="#l35.699"></a><span id="l35.699">         {</span>
<a href="#l35.700"></a><span id="l35.700" class="difflineplus">+          // We've tried all avail. methods, and they all failed, and we have no mechanism left.</span>
<a href="#l35.701"></a><span id="l35.701" class="difflineplus">+          // Ask user to try with a new password.</span>
<a href="#l35.702"></a><span id="l35.702" class="difflineplus">+          PR_LOG(SMTPLogModule, PR_LOG_WARN,</span>
<a href="#l35.703"></a><span id="l35.703" class="difflineplus">+              (&quot;SMTP: ask user what to do (after login failed): new password, retry or cancel&quot;));</span>
<a href="#l35.704"></a><span id="l35.704" class="difflineplus">+</span>
<a href="#l35.705"></a><span id="l35.705">           nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l35.706"></a><span id="l35.706">           nsresult rv = m_runningURL-&gt;GetSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l35.707"></a><span id="l35.707">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.708"></a><span id="l35.708"> </span>
<a href="#l35.709"></a><span id="l35.709">           nsCString hostname;</span>
<a href="#l35.710"></a><span id="l35.710">           rv = smtpServer-&gt;GetHostname(hostname);</span>
<a href="#l35.711"></a><span id="l35.711">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.712"></a><span id="l35.712"> </span>
<a href="#l35.713"></a><span id="l35.713" class="difflineminus">-          PRInt32 buttonPressed = 0;</span>
<a href="#l35.714"></a><span id="l35.714" class="difflineplus">+          PRInt32 buttonPressed = 1;</span>
<a href="#l35.715"></a><span id="l35.715">           if (NS_SUCCEEDED(MsgPromptLoginFailed(nsnull, hostname,</span>
<a href="#l35.716"></a><span id="l35.716">                                                 &amp;buttonPressed)))</span>
<a href="#l35.717"></a><span id="l35.717">           {</span>
<a href="#l35.718"></a><span id="l35.718" class="difflineminus">-            if (buttonPressed == 1)</span>
<a href="#l35.719"></a><span id="l35.719" class="difflineplus">+            if (buttonPressed == 1) // Cancel button</span>
<a href="#l35.720"></a><span id="l35.720">             {</span>
<a href="#l35.721"></a><span id="l35.721" class="difflineminus">-              // Cancel button pressed, so we need to abort.</span>
<a href="#l35.722"></a><span id="l35.722" class="difflineminus">-              status = NS_ERROR_FAILURE;</span>
<a href="#l35.723"></a><span id="l35.723" class="difflineminus">-</span>
<a href="#l35.724"></a><span id="l35.724" class="difflineminus">-              // and just get out of here.</span>
<a href="#l35.725"></a><span id="l35.725" class="difflineplus">+              PR_LOG(SMTPLogModule, PR_LOG_WARN, (&quot;cancel button pressed&quot;));</span>
<a href="#l35.726"></a><span id="l35.726" class="difflineplus">+              // abort and get out of here</span>
<a href="#l35.727"></a><span id="l35.727" class="difflineplus">+              status = NS_ERROR_ABORT;</span>
<a href="#l35.728"></a><span id="l35.728">               break;</span>
<a href="#l35.729"></a><span id="l35.729">             }</span>
<a href="#l35.730"></a><span id="l35.730" class="difflineminus">-            if (buttonPressed == 2)</span>
<a href="#l35.731"></a><span id="l35.731" class="difflineplus">+            else if (buttonPressed == 2) // 'New password' button</span>
<a href="#l35.732"></a><span id="l35.732">             {</span>
<a href="#l35.733"></a><span id="l35.733" class="difflineplus">+              PR_LOG(SMTPLogModule, PR_LOG_WARN, (&quot;new password button pressed&quot;));</span>
<a href="#l35.734"></a><span id="l35.734">               // Change password was pressed. For now, forget the stored</span>
<a href="#l35.735"></a><span id="l35.735">               // password and we'll prompt for a new one next time around.</span>
<a href="#l35.736"></a><span id="l35.736">               smtpServer-&gt;ForgetPassword();</span>
<a href="#l35.737"></a><span id="l35.737" class="difflineplus">+              if (m_usernamePrompted)</span>
<a href="#l35.738"></a><span id="l35.738" class="difflineplus">+                smtpServer-&gt;SetUsername(EmptyCString());</span>
<a href="#l35.739"></a><span id="l35.739" class="difflineplus">+</span>
<a href="#l35.740"></a><span id="l35.740" class="difflineplus">+              // Let's restore the original auth flags from SendEhloResponse</span>
<a href="#l35.741"></a><span id="l35.741" class="difflineplus">+              // so we can try them again with new password and username</span>
<a href="#l35.742"></a><span id="l35.742" class="difflineplus">+              ResetAuthMethods();</span>
<a href="#l35.743"></a><span id="l35.743" class="difflineplus">+              // except for GSSAPI and EXTERNAL, which don't care about passwords.</span>
<a href="#l35.744"></a><span id="l35.744" class="difflineplus">+              MarkAuthMethodAsFailed(SMTP_AUTH_GSSAPI_ENABLED);</span>
<a href="#l35.745"></a><span id="l35.745" class="difflineplus">+              MarkAuthMethodAsFailed(SMTP_AUTH_EXTERNAL_ENABLED);</span>
<a href="#l35.746"></a><span id="l35.746" class="difflineplus">+            }</span>
<a href="#l35.747"></a><span id="l35.747" class="difflineplus">+            else if (buttonPressed == 0) // Retry button</span>
<a href="#l35.748"></a><span id="l35.748" class="difflineplus">+            {</span>
<a href="#l35.749"></a><span id="l35.749" class="difflineplus">+              PR_LOG(SMTPLogModule, PR_LOG_WARN, (&quot;retry button pressed&quot;));</span>
<a href="#l35.750"></a><span id="l35.750" class="difflineplus">+              // try all again, including GSSAPI</span>
<a href="#l35.751"></a><span id="l35.751" class="difflineplus">+              ResetAuthMethods();</span>
<a href="#l35.752"></a><span id="l35.752">             }</span>
<a href="#l35.753"></a><span id="l35.753">           }</span>
<a href="#l35.754"></a><span id="l35.754" class="difflineminus">-          if (m_usernamePrompted)</span>
<a href="#l35.755"></a><span id="l35.755" class="difflineminus">-            smtpServer-&gt;SetUsername(EmptyCString());</span>
<a href="#l35.756"></a><span id="l35.756" class="difflineplus">+        }</span>
<a href="#l35.757"></a><span id="l35.757" class="difflineplus">+        PR_LOG(SMTPLogModule, PR_LOG_ERROR,</span>
<a href="#l35.758"></a><span id="l35.758" class="difflineplus">+            (&quot;SMTP: login failed: failed %X, current %X&quot;, m_failedAuthMethods, m_currentAuthMethod));</span>
<a href="#l35.759"></a><span id="l35.759"> </span>
<a href="#l35.760"></a><span id="l35.760" class="difflineminus">-          // Let's restore the original auth flags from SendEhloResponse</span>
<a href="#l35.761"></a><span id="l35.761" class="difflineminus">-          // so we can try them again with new password and username</span>
<a href="#l35.762"></a><span id="l35.762" class="difflineminus">-          RestoreAuthFlags();</span>
<a href="#l35.763"></a><span id="l35.763" class="difflineminus">-          // except for gssapi, which doesn't care about the new password.</span>
<a href="#l35.764"></a><span id="l35.764" class="difflineminus">-          ClearFlag(SMTP_AUTH_GSSAPI_ENABLED);</span>
<a href="#l35.765"></a><span id="l35.765" class="difflineminus">-        }</span>
<a href="#l35.766"></a><span id="l35.766" class="difflineminus">-</span>
<a href="#l35.767"></a><span id="l35.767" class="difflineminus">-        m_nextState = SMTP_AUTH_PROCESS_STATE;</span>
<a href="#l35.768"></a><span id="l35.768" class="difflineplus">+        m_nextState = SMTP_AUTH_PROCESS_STATE; // try auth (ProcessAuth()) again, with other method</span>
<a href="#l35.769"></a><span id="l35.769">       }</span>
<a href="#l35.770"></a><span id="l35.770">       else</span>
<a href="#l35.771"></a><span id="l35.771">           status = NS_ERROR_SMTP_PASSWORD_UNDEFINED;</span>
<a href="#l35.772"></a><span id="l35.772">       break;</span>
<a href="#l35.773"></a><span id="l35.773">   }</span>
<a href="#l35.774"></a><span id="l35.774"> </span>
<a href="#l35.775"></a><span id="l35.775">   return (status);</span>
<a href="#l35.776"></a><span id="l35.776"> }</span>
<a href="#l35.777"></a><span id="l35.777"> </span>
<a href="#l35.778"></a><span id="l35.778" class="difflineminus">-// GSSAPI may consist of multiple round trips</span>
<a href="#l35.779"></a><span id="l35.779" class="difflineminus">-</span>
<a href="#l35.780"></a><span id="l35.780"> PRInt32 nsSmtpProtocol::AuthGSSAPIFirst()</span>
<a href="#l35.781"></a><span id="l35.781"> {</span>
<a href="#l35.782"></a><span id="l35.782" class="difflineplus">+  NS_ASSERTION(m_currentAuthMethod == SMTP_AUTH_GSSAPI_ENABLED, &quot;called in invalid state&quot;);</span>
<a href="#l35.783"></a><span id="l35.783">   nsCAutoString command(&quot;AUTH GSSAPI &quot;);</span>
<a href="#l35.784"></a><span id="l35.784">   nsCAutoString resp;</span>
<a href="#l35.785"></a><span id="l35.785">   nsCAutoString service(&quot;smtp@&quot;);</span>
<a href="#l35.786"></a><span id="l35.786">   nsCString hostName;</span>
<a href="#l35.787"></a><span id="l35.787">   nsCString userName;</span>
<a href="#l35.788"></a><span id="l35.788">   nsresult rv;</span>
<a href="#l35.789"></a><span id="l35.789">   nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l35.790"></a><span id="l35.790">   rv = m_runningURL-&gt;GetSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l35.791"></a><span id="l35.791" class="difflineat">@@ -1099,37 +1187,44 @@ PRInt32 nsSmtpProtocol::AuthGSSAPIFirst(</span>
<a href="#l35.792"></a><span id="l35.792"> </span>
<a href="#l35.793"></a><span id="l35.793">   rv = smtpServer-&gt;GetUsername(userName);</span>
<a href="#l35.794"></a><span id="l35.794">   if (NS_FAILED(rv))</span>
<a href="#l35.795"></a><span id="l35.795">     return NS_ERROR_FAILURE;</span>
<a href="#l35.796"></a><span id="l35.796"> </span>
<a href="#l35.797"></a><span id="l35.797">   rv = smtpServer-&gt;GetHostname(hostName);</span>
<a href="#l35.798"></a><span id="l35.798">   if (NS_FAILED(rv))</span>
<a href="#l35.799"></a><span id="l35.799">     return NS_ERROR_FAILURE;</span>
<a href="#l35.800"></a><span id="l35.800" class="difflineplus">+  service.Append(hostName);</span>
<a href="#l35.801"></a><span id="l35.801" class="difflineplus">+  PR_LOG(SMTPLogModule, PR_LOG_DEBUG, (&quot;SMTP: GSSAPI step 1 for user %s at server %s, service %s&quot;,</span>
<a href="#l35.802"></a><span id="l35.802" class="difflineplus">+      userName.get(), hostName.get(), service.get()));</span>
<a href="#l35.803"></a><span id="l35.803"> </span>
<a href="#l35.804"></a><span id="l35.804" class="difflineminus">- service.Append(hostName);</span>
<a href="#l35.805"></a><span id="l35.805">   rv = DoGSSAPIStep1(service.get(), userName.get(), resp);</span>
<a href="#l35.806"></a><span id="l35.806">   if (NS_FAILED(rv))</span>
<a href="#l35.807"></a><span id="l35.807">   {</span>
<a href="#l35.808"></a><span id="l35.808" class="difflineplus">+    PR_LOG(SMTPLogModule, PR_LOG_ERROR, (&quot;SMTP: GSSAPI step 1 failed early&quot;));</span>
<a href="#l35.809"></a><span id="l35.809" class="difflineplus">+    MarkAuthMethodAsFailed(SMTP_AUTH_GSSAPI_ENABLED);</span>
<a href="#l35.810"></a><span id="l35.810">     m_nextState = SMTP_AUTH_PROCESS_STATE;</span>
<a href="#l35.811"></a><span id="l35.811" class="difflineminus">-    ClearFlag(SMTP_AUTH_GSSAPI_ENABLED);</span>
<a href="#l35.812"></a><span id="l35.812">     return 0;</span>
<a href="#l35.813"></a><span id="l35.813">   }</span>
<a href="#l35.814"></a><span id="l35.814">   else</span>
<a href="#l35.815"></a><span id="l35.815">     command.Append(resp);</span>
<a href="#l35.816"></a><span id="l35.816">   command.Append(CRLF);</span>
<a href="#l35.817"></a><span id="l35.817">   m_nextState = SMTP_RESPONSE;</span>
<a href="#l35.818"></a><span id="l35.818">   m_nextStateAfterResponse = SMTP_SEND_AUTH_GSSAPI_STEP;</span>
<a href="#l35.819"></a><span id="l35.819">   SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l35.820"></a><span id="l35.820">   nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(m_runningURL);</span>
<a href="#l35.821"></a><span id="l35.821">   return SendData(url, command.get());</span>
<a href="#l35.822"></a><span id="l35.822"> }</span>
<a href="#l35.823"></a><span id="l35.823"> </span>
<a href="#l35.824"></a><span id="l35.824" class="difflineplus">+// GSSAPI may consist of multiple round trips</span>
<a href="#l35.825"></a><span id="l35.825" class="difflineplus">+</span>
<a href="#l35.826"></a><span id="l35.826"> PRInt32 nsSmtpProtocol::AuthGSSAPIStep()</span>
<a href="#l35.827"></a><span id="l35.827"> {</span>
<a href="#l35.828"></a><span id="l35.828" class="difflineplus">+  PR_LOG(SMTPLogModule, PR_LOG_DEBUG, (&quot;SMTP: GSSAPI auth step 2&quot;));</span>
<a href="#l35.829"></a><span id="l35.829" class="difflineplus">+  NS_ASSERTION(m_currentAuthMethod == SMTP_AUTH_GSSAPI_ENABLED, &quot;called in invalid state&quot;);</span>
<a href="#l35.830"></a><span id="l35.830">   nsresult rv;</span>
<a href="#l35.831"></a><span id="l35.831">   nsCAutoString cmd;</span>
<a href="#l35.832"></a><span id="l35.832"> </span>
<a href="#l35.833"></a><span id="l35.833">   // Check to see what the server said</span>
<a href="#l35.834"></a><span id="l35.834">   if (m_responseCode / 100 != 3) {</span>
<a href="#l35.835"></a><span id="l35.835">     m_nextState = SMTP_AUTH_LOGIN_RESPONSE;</span>
<a href="#l35.836"></a><span id="l35.836">     return 0;</span>
<a href="#l35.837"></a><span id="l35.837">   }</span>
<a href="#l35.838"></a><span id="l35.838" class="difflineat">@@ -1149,38 +1244,45 @@ PRInt32 nsSmtpProtocol::AuthGSSAPIStep()</span>
<a href="#l35.839"></a><span id="l35.839"> </span>
<a href="#l35.840"></a><span id="l35.840"> </span>
<a href="#l35.841"></a><span id="l35.841"> // LOGIN and MSN consist of three steps (MSN not through the mechanism</span>
<a href="#l35.842"></a><span id="l35.842"> // but by non-RFC2821 compliant implementation in MS servers) not two as</span>
<a href="#l35.843"></a><span id="l35.843"> // PLAIN or CRAM-MD5, so we've to start here and continue with AuthStep1</span>
<a href="#l35.844"></a><span id="l35.844"> // if the server responds with with a 3xx code to &quot;AUTH LOGIN&quot; or &quot;AUTH MSN&quot;</span>
<a href="#l35.845"></a><span id="l35.845"> PRInt32 nsSmtpProtocol::AuthLoginStep0()</span>
<a href="#l35.846"></a><span id="l35.846"> {</span>
<a href="#l35.847"></a><span id="l35.847" class="difflineminus">-    nsCAutoString command(TestFlag(SMTP_AUTH_MSN_ENABLED) ? &quot;AUTH MSN&quot; CRLF :</span>
<a href="#l35.848"></a><span id="l35.848" class="difflineminus">-                                                            &quot;AUTH LOGIN&quot; CRLF);</span>
<a href="#l35.849"></a><span id="l35.849" class="difflineplus">+    NS_ASSERTION(m_currentAuthMethod == SMTP_AUTH_MSN_ENABLED ||</span>
<a href="#l35.850"></a><span id="l35.850" class="difflineplus">+        m_currentAuthMethod == SMTP_AUTH_LOGIN_ENABLED,</span>
<a href="#l35.851"></a><span id="l35.851" class="difflineplus">+        &quot;called in invalid state&quot;);</span>
<a href="#l35.852"></a><span id="l35.852" class="difflineplus">+    PR_LOG(SMTPLogModule, PR_LOG_DEBUG, (&quot;SMTP: MSN or LOGIN auth, step 0&quot;));</span>
<a href="#l35.853"></a><span id="l35.853" class="difflineplus">+    nsCAutoString command(m_currentAuthMethod == SMTP_AUTH_MSN_ENABLED</span>
<a href="#l35.854"></a><span id="l35.854" class="difflineplus">+        ? &quot;AUTH MSN&quot; CRLF : &quot;AUTH LOGIN&quot; CRLF);</span>
<a href="#l35.855"></a><span id="l35.855">     m_nextState = SMTP_RESPONSE;</span>
<a href="#l35.856"></a><span id="l35.856">     m_nextStateAfterResponse = SMTP_AUTH_LOGIN_STEP0_RESPONSE;</span>
<a href="#l35.857"></a><span id="l35.857">     SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l35.858"></a><span id="l35.858"> </span>
<a href="#l35.859"></a><span id="l35.859">     return SendData(m_url, command.get());</span>
<a href="#l35.860"></a><span id="l35.860"> }</span>
<a href="#l35.861"></a><span id="l35.861"> </span>
<a href="#l35.862"></a><span id="l35.862"> PRInt32 nsSmtpProtocol::AuthLoginStep0Response()</span>
<a href="#l35.863"></a><span id="l35.863"> {</span>
<a href="#l35.864"></a><span id="l35.864" class="difflineplus">+    NS_ASSERTION(m_currentAuthMethod == SMTP_AUTH_MSN_ENABLED ||</span>
<a href="#l35.865"></a><span id="l35.865" class="difflineplus">+        m_currentAuthMethod == SMTP_AUTH_LOGIN_ENABLED,</span>
<a href="#l35.866"></a><span id="l35.866" class="difflineplus">+        &quot;called in invalid state&quot;);</span>
<a href="#l35.867"></a><span id="l35.867">     // need the test to be here instead in AuthLoginResponse() to</span>
<a href="#l35.868"></a><span id="l35.868">     // continue with step 1 instead of 2 in case of a code 3xx</span>
<a href="#l35.869"></a><span id="l35.869">     m_nextState = (m_responseCode/100 == 3) ?</span>
<a href="#l35.870"></a><span id="l35.870">                   SMTP_SEND_AUTH_LOGIN_STEP1 : SMTP_AUTH_LOGIN_RESPONSE;</span>
<a href="#l35.871"></a><span id="l35.871"> </span>
<a href="#l35.872"></a><span id="l35.872">     return 0;</span>
<a href="#l35.873"></a><span id="l35.873"> }</span>
<a href="#l35.874"></a><span id="l35.874"> </span>
<a href="#l35.875"></a><span id="l35.875"> PRInt32 nsSmtpProtocol::AuthLoginStep1()</span>
<a href="#l35.876"></a><span id="l35.876"> {</span>
<a href="#l35.877"></a><span id="l35.877" class="difflineminus">-  char buffer[512];</span>
<a href="#l35.878"></a><span id="l35.878" class="difflineplus">+  char buffer[512]; // TODO nsCAutoString</span>
<a href="#l35.879"></a><span id="l35.879">   nsresult rv;</span>
<a href="#l35.880"></a><span id="l35.880">   PRInt32 status = 0;</span>
<a href="#l35.881"></a><span id="l35.881">   nsCString username;</span>
<a href="#l35.882"></a><span id="l35.882">   char *base64Str = nsnull;</span>
<a href="#l35.883"></a><span id="l35.883">   nsCAutoString password;</span>
<a href="#l35.884"></a><span id="l35.884">   nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l35.885"></a><span id="l35.885">   rv = m_runningURL-&gt;GetSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l35.886"></a><span id="l35.886">   if (NS_FAILED(rv)) return NS_ERROR_FAILURE;</span>
<a href="#l35.887"></a><span id="l35.887" class="difflineat">@@ -1188,54 +1290,61 @@ PRInt32 nsSmtpProtocol::AuthLoginStep1()</span>
<a href="#l35.888"></a><span id="l35.888">   rv = smtpServer-&gt;GetUsername(username);</span>
<a href="#l35.889"></a><span id="l35.889">   if (username.IsEmpty())</span>
<a href="#l35.890"></a><span id="l35.890">   {</span>
<a href="#l35.891"></a><span id="l35.891">     rv = GetUsernamePassword(username, password);</span>
<a href="#l35.892"></a><span id="l35.892">     m_usernamePrompted = PR_TRUE;</span>
<a href="#l35.893"></a><span id="l35.893">     if (username.IsEmpty() || password.IsEmpty())</span>
<a href="#l35.894"></a><span id="l35.894">       return NS_ERROR_SMTP_PASSWORD_UNDEFINED;</span>
<a href="#l35.895"></a><span id="l35.895">   }</span>
<a href="#l35.896"></a><span id="l35.896" class="difflineplus">+  PR_LOG(SMTPLogModule, PR_LOG_DEBUG, (&quot;SMTP AuthLoginStep1() for %s@%s&quot;,</span>
<a href="#l35.897"></a><span id="l35.897" class="difflineplus">+      username.get(), smtpServer.get()));</span>
<a href="#l35.898"></a><span id="l35.898"> </span>
<a href="#l35.899"></a><span id="l35.899">   GetPassword(password);</span>
<a href="#l35.900"></a><span id="l35.900">   if (password.IsEmpty())</span>
<a href="#l35.901"></a><span id="l35.901">   {</span>
<a href="#l35.902"></a><span id="l35.902" class="difflineplus">+    PR_LOG(SMTPLogModule, PR_LOG_ERROR, (&quot;SMTP: password undefined&quot;));</span>
<a href="#l35.903"></a><span id="l35.903">     m_urlErrorState = NS_ERROR_SMTP_PASSWORD_UNDEFINED;</span>
<a href="#l35.904"></a><span id="l35.904">     return NS_ERROR_SMTP_PASSWORD_UNDEFINED;</span>
<a href="#l35.905"></a><span id="l35.905">   }</span>
<a href="#l35.906"></a><span id="l35.906"> </span>
<a href="#l35.907"></a><span id="l35.907" class="difflineminus">-  if (TestFlag(SMTP_AUTH_CRAM_MD5_ENABLED))</span>
<a href="#l35.908"></a><span id="l35.908" class="difflineplus">+  if (m_currentAuthMethod == SMTP_AUTH_CRAM_MD5_ENABLED)</span>
<a href="#l35.909"></a><span id="l35.909" class="difflineplus">+  {</span>
<a href="#l35.910"></a><span id="l35.910" class="difflineplus">+    PR_LOG(SMTPLogModule, PR_LOG_ERROR, (&quot;CRAM auth, step 1&quot;));</span>
<a href="#l35.911"></a><span id="l35.911">     PR_snprintf(buffer, sizeof(buffer), &quot;AUTH CRAM-MD5&quot; CRLF);</span>
<a href="#l35.912"></a><span id="l35.912" class="difflineminus">-  else</span>
<a href="#l35.913"></a><span id="l35.913" class="difflineminus">-  if (TestFlag(SMTP_AUTH_NTLM_ENABLED) || TestFlag(SMTP_AUTH_MSN_ENABLED))</span>
<a href="#l35.914"></a><span id="l35.914" class="difflineplus">+  }</span>
<a href="#l35.915"></a><span id="l35.915" class="difflineplus">+  else if (m_currentAuthMethod == SMTP_AUTH_NTLM_ENABLED ||</span>
<a href="#l35.916"></a><span id="l35.916" class="difflineplus">+           m_currentAuthMethod == SMTP_AUTH_MSN_ENABLED)</span>
<a href="#l35.917"></a><span id="l35.917">   {</span>
<a href="#l35.918"></a><span id="l35.918" class="difflineplus">+    PR_LOG(SMTPLogModule, PR_LOG_DEBUG, (&quot;NTLM/MSN auth, step 1&quot;));</span>
<a href="#l35.919"></a><span id="l35.919">     nsCAutoString response;</span>
<a href="#l35.920"></a><span id="l35.920">     rv = DoNtlmStep1(username.get(), password.get(), response);</span>
<a href="#l35.921"></a><span id="l35.921">     PR_snprintf(buffer, sizeof(buffer), TestFlag(SMTP_AUTH_NTLM_ENABLED) ?</span>
<a href="#l35.922"></a><span id="l35.922">                                         &quot;AUTH NTLM %.256s&quot; CRLF :</span>
<a href="#l35.923"></a><span id="l35.923">                                         &quot;%.256s&quot; CRLF, response.get());</span>
<a href="#l35.924"></a><span id="l35.924">   }</span>
<a href="#l35.925"></a><span id="l35.925" class="difflineminus">-  else</span>
<a href="#l35.926"></a><span id="l35.926" class="difflineminus">-  if (TestFlag(SMTP_AUTH_PLAIN_ENABLED))</span>
<a href="#l35.927"></a><span id="l35.927" class="difflineplus">+  else if (m_currentAuthMethod == SMTP_AUTH_PLAIN_ENABLED)</span>
<a href="#l35.928"></a><span id="l35.928">   {</span>
<a href="#l35.929"></a><span id="l35.929" class="difflineplus">+    PR_LOG(SMTPLogModule, PR_LOG_DEBUG, (&quot;PLAIN auth&quot;));</span>
<a href="#l35.930"></a><span id="l35.930">     char plain_string[512];</span>
<a href="#l35.931"></a><span id="l35.931">     int len = 1; /* first &lt;NUL&gt; char */</span>
<a href="#l35.932"></a><span id="l35.932"> </span>
<a href="#l35.933"></a><span id="l35.933">     memset(plain_string, 0, 512);</span>
<a href="#l35.934"></a><span id="l35.934">     PR_snprintf(&amp;plain_string[1], 510, &quot;%s&quot;, username.get());</span>
<a href="#l35.935"></a><span id="l35.935">     len += username.Length();</span>
<a href="#l35.936"></a><span id="l35.936">     len++; /* second &lt;NUL&gt; char */</span>
<a href="#l35.937"></a><span id="l35.937">     PR_snprintf(&amp;plain_string[len], 511-len, &quot;%s&quot;, password.get());</span>
<a href="#l35.938"></a><span id="l35.938">     len += password.Length();</span>
<a href="#l35.939"></a><span id="l35.939"> </span>
<a href="#l35.940"></a><span id="l35.940">     base64Str = PL_Base64Encode(plain_string, len, nsnull);</span>
<a href="#l35.941"></a><span id="l35.941">     PR_snprintf(buffer, sizeof(buffer), &quot;AUTH PLAIN %.256s&quot; CRLF, base64Str);</span>
<a href="#l35.942"></a><span id="l35.942">   }</span>
<a href="#l35.943"></a><span id="l35.943" class="difflineminus">-  else</span>
<a href="#l35.944"></a><span id="l35.944" class="difflineminus">-  if (TestFlag(SMTP_AUTH_LOGIN_ENABLED))</span>
<a href="#l35.945"></a><span id="l35.945" class="difflineplus">+  else if (m_currentAuthMethod == SMTP_AUTH_LOGIN_ENABLED)</span>
<a href="#l35.946"></a><span id="l35.946">   {</span>
<a href="#l35.947"></a><span id="l35.947" class="difflineplus">+    PR_LOG(SMTPLogModule, PR_LOG_DEBUG, (&quot;LOGIN auth&quot;));</span>
<a href="#l35.948"></a><span id="l35.948">     base64Str = PL_Base64Encode(username.get(),</span>
<a href="#l35.949"></a><span id="l35.949">         username.Length(), nsnull);</span>
<a href="#l35.950"></a><span id="l35.950">     PR_snprintf(buffer, sizeof(buffer), &quot;%.256s&quot; CRLF, base64Str);</span>
<a href="#l35.951"></a><span id="l35.951">   }</span>
<a href="#l35.952"></a><span id="l35.952">   else</span>
<a href="#l35.953"></a><span id="l35.953">     return (NS_ERROR_COMMUNICATIONS_ERROR);</span>
<a href="#l35.954"></a><span id="l35.954"> </span>
<a href="#l35.955"></a><span id="l35.955">   nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(m_runningURL);</span>
<a href="#l35.956"></a><span id="l35.956" class="difflineat">@@ -1260,33 +1369,35 @@ PRInt32 nsSmtpProtocol::AuthLoginStep2()</span>
<a href="#l35.957"></a><span id="l35.957">   nsCAutoString password;</span>
<a href="#l35.958"></a><span id="l35.958"> </span>
<a href="#l35.959"></a><span id="l35.959">   GetPassword(password);</span>
<a href="#l35.960"></a><span id="l35.960">   if (password.IsEmpty())</span>
<a href="#l35.961"></a><span id="l35.961">   {</span>
<a href="#l35.962"></a><span id="l35.962">     m_urlErrorState = NS_ERROR_SMTP_PASSWORD_UNDEFINED;</span>
<a href="#l35.963"></a><span id="l35.963">     return NS_ERROR_SMTP_PASSWORD_UNDEFINED;</span>
<a href="#l35.964"></a><span id="l35.964">   }</span>
<a href="#l35.965"></a><span id="l35.965" class="difflineplus">+  PR_LOG(SMTPLogModule, PR_LOG_MAX, (&quot;SMTP AuthLoginStep2&quot;));</span>
<a href="#l35.966"></a><span id="l35.966"> </span>
<a href="#l35.967"></a><span id="l35.967">   if (!password.IsEmpty())</span>
<a href="#l35.968"></a><span id="l35.968">   {</span>
<a href="#l35.969"></a><span id="l35.969">     char buffer[512];</span>
<a href="#l35.970"></a><span id="l35.970" class="difflineminus">-    if (TestFlag(SMTP_AUTH_CRAM_MD5_ENABLED))</span>
<a href="#l35.971"></a><span id="l35.971" class="difflineplus">+    if (m_currentAuthMethod == SMTP_AUTH_CRAM_MD5_ENABLED)</span>
<a href="#l35.972"></a><span id="l35.972">     {</span>
<a href="#l35.973"></a><span id="l35.973" class="difflineplus">+      PR_LOG(SMTPLogModule, PR_LOG_DEBUG, (&quot;CRAM auth, step 2&quot;));</span>
<a href="#l35.974"></a><span id="l35.974">       unsigned char digest[DIGEST_LENGTH];</span>
<a href="#l35.975"></a><span id="l35.975">       char * decodedChallenge = PL_Base64Decode(m_responseText.get(),</span>
<a href="#l35.976"></a><span id="l35.976">         m_responseText.Length(), nsnull);</span>
<a href="#l35.977"></a><span id="l35.977"> </span>
<a href="#l35.978"></a><span id="l35.978">       if (decodedChallenge)</span>
<a href="#l35.979"></a><span id="l35.979">         rv = MSGCramMD5(decodedChallenge, strlen(decodedChallenge), password.get(), password.Length(), digest);</span>
<a href="#l35.980"></a><span id="l35.980">       else</span>
<a href="#l35.981"></a><span id="l35.981">         rv = NS_ERROR_FAILURE;</span>
<a href="#l35.982"></a><span id="l35.982"> </span>
<a href="#l35.983"></a><span id="l35.983">       PR_Free(decodedChallenge);</span>
<a href="#l35.984"></a><span id="l35.984" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; digest)</span>
<a href="#l35.985"></a><span id="l35.985" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l35.986"></a><span id="l35.986">       {</span>
<a href="#l35.987"></a><span id="l35.987">         nsCAutoString encodedDigest;</span>
<a href="#l35.988"></a><span id="l35.988">         char hexVal[8];</span>
<a href="#l35.989"></a><span id="l35.989"> </span>
<a href="#l35.990"></a><span id="l35.990">         for (PRUint32 j=0; j&lt;16; j++)</span>
<a href="#l35.991"></a><span id="l35.991">         {</span>
<a href="#l35.992"></a><span id="l35.992">           PR_snprintf (hexVal,8, &quot;%.2x&quot;, 0x0ff &amp; (unsigned short)digest[j]);</span>
<a href="#l35.993"></a><span id="l35.993">           encodedDigest.Append(hexVal);</span>
<a href="#l35.994"></a><span id="l35.994" class="difflineat">@@ -1302,29 +1413,34 @@ PRInt32 nsSmtpProtocol::AuthLoginStep2()</span>
<a href="#l35.995"></a><span id="l35.995">         PR_snprintf(buffer, sizeof(buffer), &quot;%s %s&quot;, userName.get(), encodedDigest.get());</span>
<a href="#l35.996"></a><span id="l35.996">         char *base64Str = PL_Base64Encode(buffer, strlen(buffer), nsnull);</span>
<a href="#l35.997"></a><span id="l35.997">         PR_snprintf(buffer, sizeof(buffer), &quot;%s&quot; CRLF, base64Str);</span>
<a href="#l35.998"></a><span id="l35.998">         NS_Free(base64Str);</span>
<a href="#l35.999"></a><span id="l35.999">       }</span>
<a href="#l35.1000"></a><span id="l35.1000">       if (NS_FAILED(rv))</span>
<a href="#l35.1001"></a><span id="l35.1001">         PR_snprintf(buffer, sizeof(buffer), &quot;*&quot; CRLF);</span>
<a href="#l35.1002"></a><span id="l35.1002">     }</span>
<a href="#l35.1003"></a><span id="l35.1003" class="difflineminus">-    else</span>
<a href="#l35.1004"></a><span id="l35.1004" class="difflineminus">-    if (TestFlag(SMTP_AUTH_NTLM_ENABLED) || TestFlag(SMTP_AUTH_MSN_ENABLED))</span>
<a href="#l35.1005"></a><span id="l35.1005" class="difflineplus">+    else if (m_currentAuthMethod == SMTP_AUTH_NTLM_ENABLED ||</span>
<a href="#l35.1006"></a><span id="l35.1006" class="difflineplus">+             m_currentAuthMethod == SMTP_AUTH_MSN_ENABLED)</span>
<a href="#l35.1007"></a><span id="l35.1007">     {</span>
<a href="#l35.1008"></a><span id="l35.1008" class="difflineplus">+      PR_LOG(SMTPLogModule, PR_LOG_DEBUG, (&quot;NTLM/MSN auth, step 2&quot;));</span>
<a href="#l35.1009"></a><span id="l35.1009">       nsCAutoString response;</span>
<a href="#l35.1010"></a><span id="l35.1010">       rv = DoNtlmStep2(m_responseText, response);</span>
<a href="#l35.1011"></a><span id="l35.1011">       PR_snprintf(buffer, sizeof(buffer), &quot;%.256s&quot; CRLF, response.get());</span>
<a href="#l35.1012"></a><span id="l35.1012">     }</span>
<a href="#l35.1013"></a><span id="l35.1013" class="difflineminus">-    else</span>
<a href="#l35.1014"></a><span id="l35.1014" class="difflineplus">+    else if (m_currentAuthMethod == SMTP_AUTH_PLAIN_ENABLED ||</span>
<a href="#l35.1015"></a><span id="l35.1015" class="difflineplus">+             m_currentAuthMethod == SMTP_AUTH_LOGIN_ENABLED)</span>
<a href="#l35.1016"></a><span id="l35.1016">     {</span>
<a href="#l35.1017"></a><span id="l35.1017" class="difflineplus">+      PR_LOG(SMTPLogModule, PR_LOG_DEBUG, (&quot;PLAIN/LOGIN auth, step 2&quot;));</span>
<a href="#l35.1018"></a><span id="l35.1018">       char *base64Str = PL_Base64Encode(password.get(), password.Length(), nsnull);</span>
<a href="#l35.1019"></a><span id="l35.1019">       PR_snprintf(buffer, sizeof(buffer), &quot;%.256s&quot; CRLF, base64Str);</span>
<a href="#l35.1020"></a><span id="l35.1020">       NS_Free(base64Str);</span>
<a href="#l35.1021"></a><span id="l35.1021">     }</span>
<a href="#l35.1022"></a><span id="l35.1022" class="difflineplus">+    else</span>
<a href="#l35.1023"></a><span id="l35.1023" class="difflineplus">+      return NS_ERROR_COMMUNICATIONS_ERROR;</span>
<a href="#l35.1024"></a><span id="l35.1024"> </span>
<a href="#l35.1025"></a><span id="l35.1025">     nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(m_runningURL);</span>
<a href="#l35.1026"></a><span id="l35.1026">     status = SendData(url, buffer, PR_TRUE);</span>
<a href="#l35.1027"></a><span id="l35.1027">     m_nextState = SMTP_RESPONSE;</span>
<a href="#l35.1028"></a><span id="l35.1028">     m_nextStateAfterResponse = SMTP_AUTH_LOGIN_RESPONSE;</span>
<a href="#l35.1029"></a><span id="l35.1029">     SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l35.1030"></a><span id="l35.1030">     return (status);</span>
<a href="#l35.1031"></a><span id="l35.1031">   }</span>
<a href="#l35.1032"></a><span id="l35.1032" class="difflineat">@@ -1621,17 +1737,17 @@ nsresult nsSmtpProtocol::LoadUrl(nsIURI </span>
<a href="#l35.1033"></a><span id="l35.1033">   if (hostName.IsEmpty())</span>
<a href="#l35.1034"></a><span id="l35.1034">   {</span>
<a href="#l35.1035"></a><span id="l35.1035">     nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; aMsgUrl = do_QueryInterface(aURL);</span>
<a href="#l35.1036"></a><span id="l35.1036">     if (aMsgUrl)</span>
<a href="#l35.1037"></a><span id="l35.1037">     {</span>
<a href="#l35.1038"></a><span id="l35.1038">       aMsgUrl-&gt;SetUrlState(PR_TRUE, NS_OK);</span>
<a href="#l35.1039"></a><span id="l35.1039">       // set the url as a url currently being run...</span>
<a href="#l35.1040"></a><span id="l35.1040">       aMsgUrl-&gt;SetUrlState(PR_FALSE /* we aren't running the url */,</span>
<a href="#l35.1041"></a><span id="l35.1041" class="difflineminus">-                           NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER); </span>
<a href="#l35.1042"></a><span id="l35.1042" class="difflineplus">+                           NS_ERROR_SMTP_AUTH_FAILURE);</span>
<a href="#l35.1043"></a><span id="l35.1043">     }</span>
<a href="#l35.1044"></a><span id="l35.1044">     return NS_ERROR_BUT_DONT_SHOW_ALERT;</span>
<a href="#l35.1045"></a><span id="l35.1045">   }</span>
<a href="#l35.1046"></a><span id="l35.1046"> </span>
<a href="#l35.1047"></a><span id="l35.1047">   PRBool postMessage = PR_FALSE;</span>
<a href="#l35.1048"></a><span id="l35.1048">   m_runningURL-&gt;GetPostMessage(&amp;postMessage);</span>
<a href="#l35.1049"></a><span id="l35.1049"> </span>
<a href="#l35.1050"></a><span id="l35.1050">   if (postMessage)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpProtocol.h</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpProtocol.h</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -39,16 +39,17 @@</span>
<a href="#l36.4"></a><span id="l36.4"> #define nsSmtpProtocol_h___</span>
<a href="#l36.5"></a><span id="l36.5"> </span>
<a href="#l36.6"></a><span id="l36.6"> #include &quot;nsMsgProtocol.h&quot;</span>
<a href="#l36.7"></a><span id="l36.7"> #include &quot;nsIStreamListener.h&quot;</span>
<a href="#l36.8"></a><span id="l36.8"> #include &quot;nsISmtpUrl.h&quot;</span>
<a href="#l36.9"></a><span id="l36.9"> #include &quot;nsIMsgStatusFeedback.h&quot;</span>
<a href="#l36.10"></a><span id="l36.10"> #include &quot;nsMsgLineBuffer.h&quot;</span>
<a href="#l36.11"></a><span id="l36.11"> #include &quot;nsIAuthModule.h&quot;</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineplus">+#include &quot;MailNewsTypes2.h&quot; // for nsMsgSocketType</span>
<a href="#l36.13"></a><span id="l36.13"> </span>
<a href="#l36.14"></a><span id="l36.14"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l36.15"></a><span id="l36.15"> </span>
<a href="#l36.16"></a><span id="l36.16">  /* states of the machine</span>
<a href="#l36.17"></a><span id="l36.17">  */</span>
<a href="#l36.18"></a><span id="l36.18"> typedef enum _SmtpState {</span>
<a href="#l36.19"></a><span id="l36.19"> SMTP_RESPONSE = 0,                                  // 0</span>
<a href="#l36.20"></a><span id="l36.20"> SMTP_START_CONNECT,                                 // 1</span>
<a href="#l36.21"></a><span id="l36.21" class="difflineat">@@ -85,42 +86,28 @@ SMTP_SEND_AUTH_GSSAPI_STEP              </span>
<a href="#l36.22"></a><span id="l36.22"> #define SMTP_EHLO_DSN_ENABLED           0x00000004</span>
<a href="#l36.23"></a><span id="l36.23"> #define SMTP_EHLO_STARTTLS_ENABLED      0x00000008</span>
<a href="#l36.24"></a><span id="l36.24"> #define SMTP_EHLO_SIZE_ENABLED          0x00000010</span>
<a href="#l36.25"></a><span id="l36.25"> </span>
<a href="#l36.26"></a><span id="l36.26"> // insecure mechanisms follow</span>
<a href="#l36.27"></a><span id="l36.27"> #define SMTP_AUTH_LOGIN_ENABLED         0x00000100</span>
<a href="#l36.28"></a><span id="l36.28"> #define SMTP_AUTH_PLAIN_ENABLED         0x00000200</span>
<a href="#l36.29"></a><span id="l36.29"> #define SMTP_AUTH_EXTERNAL_ENABLED      0x00000400</span>
<a href="#l36.30"></a><span id="l36.30" class="difflineminus">-// sum of above insecure mechanisms</span>
<a href="#l36.31"></a><span id="l36.31" class="difflineminus">-#define SMTP_AUTH_INSEC_ENABLED         0x00000700</span>
<a href="#l36.32"></a><span id="l36.32"> // secure mechanisms follow</span>
<a href="#l36.33"></a><span id="l36.33"> #define SMTP_AUTH_GSSAPI_ENABLED        0x00000800</span>
<a href="#l36.34"></a><span id="l36.34"> #define SMTP_AUTH_DIGEST_MD5_ENABLED    0x00001000</span>
<a href="#l36.35"></a><span id="l36.35"> #define SMTP_AUTH_CRAM_MD5_ENABLED      0x00002000</span>
<a href="#l36.36"></a><span id="l36.36"> #define SMTP_AUTH_NTLM_ENABLED          0x00004000</span>
<a href="#l36.37"></a><span id="l36.37"> #define SMTP_AUTH_MSN_ENABLED           0x00008000</span>
<a href="#l36.38"></a><span id="l36.38" class="difflineminus">-// sum of above secure mechanisms</span>
<a href="#l36.39"></a><span id="l36.39" class="difflineminus">-#define SMTP_AUTH_SEC_ENABLED           0x0000F800</span>
<a href="#l36.40"></a><span id="l36.40" class="difflineminus">-// sum of all above mechanisms</span>
<a href="#l36.41"></a><span id="l36.41" class="difflineminus">-#define SMTP_AUTH_ANY_ENABLED           0x0000FF00</span>
<a href="#l36.42"></a><span id="l36.42" class="difflineplus">+// sum of all above auth mechanisms</span>
<a href="#l36.43"></a><span id="l36.43" class="difflineplus">+#define SMTP_AUTH_ANY                   0x0000FF00</span>
<a href="#l36.44"></a><span id="l36.44"> // indicates that AUTH has been advertised</span>
<a href="#l36.45"></a><span id="l36.45"> #define SMTP_AUTH                       0x00010000</span>
<a href="#l36.46"></a><span id="l36.46" class="difflineminus">-</span>
<a href="#l36.47"></a><span id="l36.47" class="difflineminus">-typedef enum _PrefAuthMethod {</span>
<a href="#l36.48"></a><span id="l36.48" class="difflineminus">-    PREF_AUTH_NONE = 0,</span>
<a href="#l36.49"></a><span id="l36.49" class="difflineminus">-    PREF_AUTH_ANY = 1</span>
<a href="#l36.50"></a><span id="l36.50" class="difflineminus">-} PrefAuthMethod;</span>
<a href="#l36.51"></a><span id="l36.51" class="difflineminus">-</span>
<a href="#l36.52"></a><span id="l36.52" class="difflineminus">-typedef enum _PrefTrySSL {</span>
<a href="#l36.53"></a><span id="l36.53" class="difflineminus">-    PREF_SECURE_NEVER = 0,</span>
<a href="#l36.54"></a><span id="l36.54" class="difflineminus">-    PREF_SECURE_TRY_STARTTLS = 1,</span>
<a href="#l36.55"></a><span id="l36.55" class="difflineminus">-    PREF_SECURE_ALWAYS_STARTTLS = 2,</span>
<a href="#l36.56"></a><span id="l36.56" class="difflineminus">-    PREF_SECURE_ALWAYS_SMTPS = 3</span>
<a href="#l36.57"></a><span id="l36.57" class="difflineminus">-} PrefTrySSL;</span>
<a href="#l36.58"></a><span id="l36.58" class="difflineplus">+// No login necessary (pref)</span>
<a href="#l36.59"></a><span id="l36.59" class="difflineplus">+#define SMTP_AUTH_NONE_ENABLED          0x00020000</span>
<a href="#l36.60"></a><span id="l36.60"> </span>
<a href="#l36.61"></a><span id="l36.61"> class nsSmtpProtocol : public nsMsgAsyncWriteProtocol</span>
<a href="#l36.62"></a><span id="l36.62"> {</span>
<a href="#l36.63"></a><span id="l36.63"> public:</span>
<a href="#l36.64"></a><span id="l36.64">     NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l36.65"></a><span id="l36.65"> </span>
<a href="#l36.66"></a><span id="l36.66">     // Creating a protocol instance requires the URL which needs to be run.</span>
<a href="#l36.67"></a><span id="l36.67">     nsSmtpProtocol(nsIURI * aURL);</span>
<a href="#l36.68"></a><span id="l36.68" class="difflineat">@@ -164,21 +151,18 @@ private:</span>
<a href="#l36.69"></a><span id="l36.69">     char           *m_addresses;</span>
<a href="#l36.70"></a><span id="l36.70">     PRUint32       m_addressesLeft;</span>
<a href="#l36.71"></a><span id="l36.71">     nsCString m_mailAddr;</span>
<a href="#l36.72"></a><span id="l36.72">     nsCString m_helloArgument;</span>
<a href="#l36.73"></a><span id="l36.73">     PRInt32        m_sizelimit;</span>
<a href="#l36.74"></a><span id="l36.74"> </span>
<a href="#l36.75"></a><span id="l36.75">     // *** the following should move to the smtp server when we support</span>
<a href="#l36.76"></a><span id="l36.76">     // multiple smtp servers</span>
<a href="#l36.77"></a><span id="l36.77" class="difflineminus">-    PRInt32 m_prefAuthMethod;</span>
<a href="#l36.78"></a><span id="l36.78" class="difflineminus">-    PRBool m_prefUseSecAuth;</span>
<a href="#l36.79"></a><span id="l36.79" class="difflineminus">-    PRBool m_prefTrySecAuth;</span>
<a href="#l36.80"></a><span id="l36.80">     PRBool m_usernamePrompted;</span>
<a href="#l36.81"></a><span id="l36.81" class="difflineminus">-    PRInt32 m_prefTrySSL;</span>
<a href="#l36.82"></a><span id="l36.82" class="difflineplus">+    PRInt32 m_prefSocketType;</span>
<a href="#l36.83"></a><span id="l36.83">     PRBool m_tlsEnabled;</span>
<a href="#l36.84"></a><span id="l36.84"> </span>
<a href="#l36.85"></a><span id="l36.85">     PRBool m_tlsInitiated;</span>
<a href="#l36.86"></a><span id="l36.86"> </span>
<a href="#l36.87"></a><span id="l36.87">     PRBool m_sendDone;</span>
<a href="#l36.88"></a><span id="l36.88"> </span>
<a href="#l36.89"></a><span id="l36.89">     PRInt32 m_totalAmountRead;</span>
<a href="#l36.90"></a><span id="l36.90"> #ifdef UNREADY_CODE </span>
<a href="#l36.91"></a><span id="l36.91" class="difflineat">@@ -242,14 +226,18 @@ private:</span>
<a href="#l36.92"></a><span id="l36.92"> </span>
<a href="#l36.93"></a><span id="l36.93">     void AppendHelloArgument(nsACString&amp; aResult);</span>
<a href="#l36.94"></a><span id="l36.94">     nsresult GetPassword(nsCString &amp;aPassword);</span>
<a href="#l36.95"></a><span id="l36.95">     nsresult GetUsernamePassword(nsACString &amp;aUsername, nsACString &amp;aPassword);</span>
<a href="#l36.96"></a><span id="l36.96">     nsresult PromptForPassword(nsISmtpServer *aSmtpServer, nsISmtpUrl *aSmtpUrl, </span>
<a href="#l36.97"></a><span id="l36.97">                                const PRUnichar **formatStrings, </span>
<a href="#l36.98"></a><span id="l36.98">                                nsACString &amp;aPassword);</span>
<a href="#l36.99"></a><span id="l36.99"> </span>
<a href="#l36.100"></a><span id="l36.100" class="difflineminus">-    void BackupAuthFlags();</span>
<a href="#l36.101"></a><span id="l36.101" class="difflineminus">-    void RestoreAuthFlags();</span>
<a href="#l36.102"></a><span id="l36.102" class="difflineminus">-    PRInt32 m_origAuthFlags;</span>
<a href="#l36.103"></a><span id="l36.103" class="difflineplus">+    void    InitPrefAuthMethods(PRInt32 authMethodPrefValue);</span>
<a href="#l36.104"></a><span id="l36.104" class="difflineplus">+    nsresult ChooseAuthMethod();</span>
<a href="#l36.105"></a><span id="l36.105" class="difflineplus">+    void    MarkAuthMethodAsFailed(PRInt32 failedAuthMethod);</span>
<a href="#l36.106"></a><span id="l36.106" class="difflineplus">+    void    ResetAuthMethods();</span>
<a href="#l36.107"></a><span id="l36.107" class="difflineplus">+    PRInt32 m_prefAuthMethods; // set of capability flags for auth methods</span>
<a href="#l36.108"></a><span id="l36.108" class="difflineplus">+    PRInt32 m_failedAuthMethods; // ditto</span>
<a href="#l36.109"></a><span id="l36.109" class="difflineplus">+    PRInt32 m_currentAuthMethod; // exactly one capability flag, or 0</span>
<a href="#l36.110"></a><span id="l36.110"> };</span>
<a href="#l36.111"></a><span id="l36.111"> </span>
<a href="#l36.112"></a><span id="l36.112"> #endif  // nsSmtpProtocol_h___</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpServer.cpp</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpServer.cpp</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -199,61 +199,27 @@ nsSmtpServer::GetDisplayname(char * *aDi</span>
<a href="#l37.4"></a><span id="l37.4">         hostname.AppendInt(port);</span>
<a href="#l37.5"></a><span id="l37.5">     }</span>
<a href="#l37.6"></a><span id="l37.6"> </span>
<a href="#l37.7"></a><span id="l37.7">     *aDisplayname = ToNewCString(hostname);</span>
<a href="#l37.8"></a><span id="l37.8">     return NS_OK;</span>
<a href="#l37.9"></a><span id="l37.9"> }</span>
<a href="#l37.10"></a><span id="l37.10"> </span>
<a href="#l37.11"></a><span id="l37.11"> NS_IMETHODIMP</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-nsSmtpServer::GetTrySSL(PRInt32 *trySSL)</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+nsSmtpServer::GetSocketType(PRInt32 *socketType)</span>
<a href="#l37.14"></a><span id="l37.14"> {</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineminus">-  NS_ENSURE_ARG_POINTER(trySSL);</span>
<a href="#l37.16"></a><span id="l37.16" class="difflineminus">-  getIntPrefWithDefault(&quot;try_ssl&quot;, trySSL, 0);</span>
<a href="#l37.17"></a><span id="l37.17" class="difflineplus">+  NS_ENSURE_ARG_POINTER(socketType);</span>
<a href="#l37.18"></a><span id="l37.18" class="difflineplus">+  getIntPrefWithDefault(&quot;try_ssl&quot;, socketType, 0);</span>
<a href="#l37.19"></a><span id="l37.19">   return NS_OK;</span>
<a href="#l37.20"></a><span id="l37.20"> }</span>
<a href="#l37.21"></a><span id="l37.21"> </span>
<a href="#l37.22"></a><span id="l37.22"> NS_IMETHODIMP</span>
<a href="#l37.23"></a><span id="l37.23" class="difflineminus">-nsSmtpServer::SetTrySSL(PRInt32 trySSL)</span>
<a href="#l37.24"></a><span id="l37.24" class="difflineminus">-{</span>
<a href="#l37.25"></a><span id="l37.25" class="difflineminus">-    return mPrefBranch-&gt;SetIntPref(&quot;try_ssl&quot;, trySSL);</span>
<a href="#l37.26"></a><span id="l37.26" class="difflineminus">-}</span>
<a href="#l37.27"></a><span id="l37.27" class="difflineminus">-</span>
<a href="#l37.28"></a><span id="l37.28" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l37.29"></a><span id="l37.29" class="difflineminus">-nsSmtpServer::GetUseSecAuth(PRBool *useSecAuth)</span>
<a href="#l37.30"></a><span id="l37.30" class="difflineminus">-{</span>
<a href="#l37.31"></a><span id="l37.31" class="difflineminus">-    nsresult rv;</span>
<a href="#l37.32"></a><span id="l37.32" class="difflineminus">-    NS_ENSURE_ARG_POINTER(useSecAuth);</span>
<a href="#l37.33"></a><span id="l37.33" class="difflineminus">-    rv = mPrefBranch-&gt;GetBoolPref(&quot;useSecAuth&quot;, useSecAuth);</span>
<a href="#l37.34"></a><span id="l37.34" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l37.35"></a><span id="l37.35" class="difflineminus">-        mDefPrefBranch-&gt;GetBoolPref(&quot;useSecAuth&quot;, useSecAuth);</span>
<a href="#l37.36"></a><span id="l37.36" class="difflineminus">-    return NS_OK;</span>
<a href="#l37.37"></a><span id="l37.37" class="difflineminus">-}</span>
<a href="#l37.38"></a><span id="l37.38" class="difflineminus">-</span>
<a href="#l37.39"></a><span id="l37.39" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l37.40"></a><span id="l37.40" class="difflineminus">-nsSmtpServer::SetUseSecAuth(const PRBool useSecAuth)</span>
<a href="#l37.41"></a><span id="l37.41" class="difflineplus">+nsSmtpServer::SetSocketType(PRInt32 socketType)</span>
<a href="#l37.42"></a><span id="l37.42"> {</span>
<a href="#l37.43"></a><span id="l37.43" class="difflineminus">-    return mPrefBranch-&gt;SetBoolPref(&quot;useSecAuth&quot;, useSecAuth);</span>
<a href="#l37.44"></a><span id="l37.44" class="difflineminus">-}</span>
<a href="#l37.45"></a><span id="l37.45" class="difflineminus">-</span>
<a href="#l37.46"></a><span id="l37.46" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l37.47"></a><span id="l37.47" class="difflineminus">-nsSmtpServer::GetTrySecAuth(PRBool *trySecAuth)</span>
<a href="#l37.48"></a><span id="l37.48" class="difflineminus">-{</span>
<a href="#l37.49"></a><span id="l37.49" class="difflineminus">-    nsresult rv;</span>
<a href="#l37.50"></a><span id="l37.50" class="difflineminus">-    NS_ENSURE_ARG_POINTER(trySecAuth);</span>
<a href="#l37.51"></a><span id="l37.51" class="difflineminus">-    rv = mPrefBranch-&gt;GetBoolPref(&quot;trySecAuth&quot;, trySecAuth);</span>
<a href="#l37.52"></a><span id="l37.52" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l37.53"></a><span id="l37.53" class="difflineminus">-        mDefPrefBranch-&gt;GetBoolPref(&quot;trySecAuth&quot;, trySecAuth);</span>
<a href="#l37.54"></a><span id="l37.54" class="difflineminus">-    return NS_OK;</span>
<a href="#l37.55"></a><span id="l37.55" class="difflineminus">-}</span>
<a href="#l37.56"></a><span id="l37.56" class="difflineminus">-</span>
<a href="#l37.57"></a><span id="l37.57" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l37.58"></a><span id="l37.58" class="difflineminus">-nsSmtpServer::SetTrySecAuth(const PRBool trySecAuth)</span>
<a href="#l37.59"></a><span id="l37.59" class="difflineminus">-{</span>
<a href="#l37.60"></a><span id="l37.60" class="difflineminus">-    return mPrefBranch-&gt;SetBoolPref(&quot;trySecAuth&quot;, trySecAuth);</span>
<a href="#l37.61"></a><span id="l37.61" class="difflineplus">+    return mPrefBranch-&gt;SetIntPref(&quot;try_ssl&quot;, socketType);</span>
<a href="#l37.62"></a><span id="l37.62"> }</span>
<a href="#l37.63"></a><span id="l37.63"> </span>
<a href="#l37.64"></a><span id="l37.64"> NS_IMETHODIMP</span>
<a href="#l37.65"></a><span id="l37.65"> nsSmtpServer::GetHelloArgument(char * *aHelloArgument)</span>
<a href="#l37.66"></a><span id="l37.66"> {</span>
<a href="#l37.67"></a><span id="l37.67">     nsresult rv;</span>
<a href="#l37.68"></a><span id="l37.68">     NS_ENSURE_ARG_POINTER(aHelloArgument);</span>
<a href="#l37.69"></a><span id="l37.69">     rv = mPrefBranch-&gt;GetCharPref(&quot;hello_argument&quot;, aHelloArgument);</span>
<a href="#l37.70"></a><span id="l37.70" class="difflineat">@@ -265,17 +231,17 @@ nsSmtpServer::GetHelloArgument(char * *a</span>
<a href="#l37.71"></a><span id="l37.71">     }</span>
<a href="#l37.72"></a><span id="l37.72">     return NS_OK;</span>
<a href="#l37.73"></a><span id="l37.73"> }</span>
<a href="#l37.74"></a><span id="l37.74"> </span>
<a href="#l37.75"></a><span id="l37.75"> NS_IMETHODIMP</span>
<a href="#l37.76"></a><span id="l37.76"> nsSmtpServer::GetAuthMethod(PRInt32 *authMethod)</span>
<a href="#l37.77"></a><span id="l37.77"> {</span>
<a href="#l37.78"></a><span id="l37.78">   NS_ENSURE_ARG_POINTER(authMethod);</span>
<a href="#l37.79"></a><span id="l37.79" class="difflineminus">-  getIntPrefWithDefault(&quot;auth_method&quot;, authMethod, 1);</span>
<a href="#l37.80"></a><span id="l37.80" class="difflineplus">+  getIntPrefWithDefault(&quot;authMethod&quot;, authMethod, 3);</span>
<a href="#l37.81"></a><span id="l37.81">   return NS_OK;</span>
<a href="#l37.82"></a><span id="l37.82"> }</span>
<a href="#l37.83"></a><span id="l37.83"> </span>
<a href="#l37.84"></a><span id="l37.84"> void</span>
<a href="#l37.85"></a><span id="l37.85"> nsSmtpServer::getIntPrefWithDefault(const char *prefName,</span>
<a href="#l37.86"></a><span id="l37.86">                                     PRInt32 *val,</span>
<a href="#l37.87"></a><span id="l37.87">                                     PRInt32 defVal)</span>
<a href="#l37.88"></a><span id="l37.88"> {</span>
<a href="#l37.89"></a><span id="l37.89" class="difflineat">@@ -287,17 +253,17 @@ nsSmtpServer::getIntPrefWithDefault(cons</span>
<a href="#l37.90"></a><span id="l37.90">   if (NS_FAILED(rv))</span>
<a href="#l37.91"></a><span id="l37.91">     // last resort</span>
<a href="#l37.92"></a><span id="l37.92">     *val = defVal;</span>
<a href="#l37.93"></a><span id="l37.93"> }</span>
<a href="#l37.94"></a><span id="l37.94"> </span>
<a href="#l37.95"></a><span id="l37.95"> NS_IMETHODIMP</span>
<a href="#l37.96"></a><span id="l37.96"> nsSmtpServer::SetAuthMethod(PRInt32 authMethod)</span>
<a href="#l37.97"></a><span id="l37.97"> {</span>
<a href="#l37.98"></a><span id="l37.98" class="difflineminus">-    return mPrefBranch-&gt;SetIntPref(&quot;auth_method&quot;, authMethod);</span>
<a href="#l37.99"></a><span id="l37.99" class="difflineplus">+    return mPrefBranch-&gt;SetIntPref(&quot;authMethod&quot;, authMethod);</span>
<a href="#l37.100"></a><span id="l37.100"> }</span>
<a href="#l37.101"></a><span id="l37.101"> </span>
<a href="#l37.102"></a><span id="l37.102"> NS_IMETHODIMP</span>
<a href="#l37.103"></a><span id="l37.103"> nsSmtpServer::GetUsername(nsACString &amp;aUsername)</span>
<a href="#l37.104"></a><span id="l37.104"> {</span>
<a href="#l37.105"></a><span id="l37.105">   nsCString result;</span>
<a href="#l37.106"></a><span id="l37.106">   nsresult rv = mPrefBranch-&gt;GetCharPref(&quot;username&quot;, getter_Copies(result));</span>
<a href="#l37.107"></a><span id="l37.107">   if (NS_FAILED(rv))</span>
<a href="#l37.108"></a><span id="l37.108" class="difflineat">@@ -455,17 +421,17 @@ nsSmtpServer::GetPasswordWithUI(const PR</span>
<a href="#l37.109"></a><span id="l37.109">                                nsIAuthPrompt::SAVE_PASSWORD_PERMANENTLY,</span>
<a href="#l37.110"></a><span id="l37.110">                                getter_Copies(uniPassword), &amp;okayValue);</span>
<a href="#l37.111"></a><span id="l37.111">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.112"></a><span id="l37.112"> </span>
<a href="#l37.113"></a><span id="l37.113">   // If the user pressed cancel, just return an empty string.</span>
<a href="#l37.114"></a><span id="l37.114">   if (!okayValue)</span>
<a href="#l37.115"></a><span id="l37.115">   {</span>
<a href="#l37.116"></a><span id="l37.116">     aPassword.Truncate();</span>
<a href="#l37.117"></a><span id="l37.117" class="difflineminus">-    return rv;</span>
<a href="#l37.118"></a><span id="l37.118" class="difflineplus">+    return NS_MSG_PASSWORD_PROMPT_CANCELLED;</span>
<a href="#l37.119"></a><span id="l37.119">   }</span>
<a href="#l37.120"></a><span id="l37.120"> </span>
<a href="#l37.121"></a><span id="l37.121">   NS_LossyConvertUTF16toASCII password(uniPassword);</span>
<a href="#l37.122"></a><span id="l37.122"> </span>
<a href="#l37.123"></a><span id="l37.123">   rv = SetPassword(password);</span>
<a href="#l37.124"></a><span id="l37.124">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.125"></a><span id="l37.125"> </span>
<a href="#l37.126"></a><span id="l37.126">   aPassword = password;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpService.cpp</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpService.cpp</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -165,25 +165,25 @@ nsresult NS_MsgBuildSmtpUrl(nsIFile * aF</span>
<a href="#l38.4"></a><span id="l38.4">   // mscott: this function is a convience hack until netlib actually dispatches</span>
<a href="#l38.5"></a><span id="l38.5">   // smtp urls. in addition until we have a session to get a password, host and</span>
<a href="#l38.6"></a><span id="l38.6">   // other stuff from, we need to use default values....</span>
<a href="#l38.7"></a><span id="l38.7">   // ..for testing purposes....</span>
<a href="#l38.8"></a><span id="l38.8"> </span>
<a href="#l38.9"></a><span id="l38.9">     nsCString smtpHostName;</span>
<a href="#l38.10"></a><span id="l38.10">     nsCString smtpUserName;</span>
<a href="#l38.11"></a><span id="l38.11">     PRInt32 smtpPort;</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-    PRInt32 trySSL;</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+    PRInt32 socketType;</span>
<a href="#l38.14"></a><span id="l38.14"> </span>
<a href="#l38.15"></a><span id="l38.15">     aSmtpServer-&gt;GetHostname(smtpHostName);</span>
<a href="#l38.16"></a><span id="l38.16">     aSmtpServer-&gt;GetUsername(smtpUserName);</span>
<a href="#l38.17"></a><span id="l38.17">     aSmtpServer-&gt;GetPort(&amp;smtpPort);</span>
<a href="#l38.18"></a><span id="l38.18" class="difflineminus">-    aSmtpServer-&gt;GetTrySSL(&amp;trySSL);</span>
<a href="#l38.19"></a><span id="l38.19" class="difflineplus">+    aSmtpServer-&gt;GetSocketType(&amp;socketType);</span>
<a href="#l38.20"></a><span id="l38.20"> </span>
<a href="#l38.21"></a><span id="l38.21">     if (!smtpPort)</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineminus">-      smtpPort = (trySSL == PREF_SECURE_ALWAYS_SMTPS) ? </span>
<a href="#l38.23"></a><span id="l38.23" class="difflineplus">+      smtpPort = (socketType == nsMsgSocketType::SSL) ?</span>
<a href="#l38.24"></a><span id="l38.24">         nsISmtpUrl::DEFAULT_SMTPS_PORT :  nsISmtpUrl::DEFAULT_SMTP_PORT;</span>
<a href="#l38.25"></a><span id="l38.25"> </span>
<a href="#l38.26"></a><span id="l38.26">   nsresult rv;</span>
<a href="#l38.27"></a><span id="l38.27">   nsCOMPtr&lt;nsISmtpUrl&gt; smtpUrl(do_CreateInstance(kCSmtpUrlCID, &amp;rv));</span>
<a href="#l38.28"></a><span id="l38.28">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.29"></a><span id="l38.29"> </span>
<a href="#l38.30"></a><span id="l38.30">   nsCAutoString urlSpec(&quot;smtp://&quot;);</span>
<a href="#l38.31"></a><span id="l38.31"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mailnews/compose/test/unit/head_compose.js</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mailnews/compose/test/unit/head_compose.js</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -22,17 +22,17 @@ function getBasicSmtpServer() {</span>
<a href="#l39.4"></a><span id="l39.4">                       .getService(Ci.nsISmtpService);</span>
<a href="#l39.5"></a><span id="l39.5"> </span>
<a href="#l39.6"></a><span id="l39.6">   // Create an smtp server and fill in the details.</span>
<a href="#l39.7"></a><span id="l39.7">   var smtpServer = smtpService.createSmtpServer();</span>
<a href="#l39.8"></a><span id="l39.8"> </span>
<a href="#l39.9"></a><span id="l39.9">   smtpServer.hostname = &quot;localhost&quot;;</span>
<a href="#l39.10"></a><span id="l39.10">   smtpServer.port = SMTP_PORT;</span>
<a href="#l39.11"></a><span id="l39.11">   // Set the authentication method to &quot;none&quot;</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-  smtpServer.authMethod = 0;</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineplus">+  smtpServer.authMethod = 1;</span>
<a href="#l39.14"></a><span id="l39.14"> </span>
<a href="#l39.15"></a><span id="l39.15">   // Override the default greeting so we get something predicitable</span>
<a href="#l39.16"></a><span id="l39.16">   // in the ELHO message</span>
<a href="#l39.17"></a><span id="l39.17">   var prefSvc = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l39.18"></a><span id="l39.18">     .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l39.19"></a><span id="l39.19"> </span>
<a href="#l39.20"></a><span id="l39.20">   prefSvc.setCharPref(&quot;mail.smtpserver.default.hello_argument&quot;, &quot;test&quot;);</span>
<a href="#l39.21"></a><span id="l39.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_bug155172.js</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_bug155172.js</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -64,20 +64,18 @@ function run_test() {</span>
<a href="#l40.4"></a><span id="l40.4">   // the server if something fails.</span>
<a href="#l40.5"></a><span id="l40.5">   try {</span>
<a href="#l40.6"></a><span id="l40.6">     // Start the fake SMTP server</span>
<a href="#l40.7"></a><span id="l40.7">     server.start(SMTP_PORT);</span>
<a href="#l40.8"></a><span id="l40.8"> </span>
<a href="#l40.9"></a><span id="l40.9">     // This time with auth</span>
<a href="#l40.10"></a><span id="l40.10">     test = &quot;Auth sendMailMessage&quot;;</span>
<a href="#l40.11"></a><span id="l40.11"> </span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-    smtpServer.authMethod = 1;</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineminus">-    smtpServer.useSecAuth = false;</span>
<a href="#l40.14"></a><span id="l40.14" class="difflineminus">-    smtpServer.trySecAuth = false;</span>
<a href="#l40.15"></a><span id="l40.15" class="difflineminus">-    smtpServer.trySSL = false;</span>
<a href="#l40.16"></a><span id="l40.16" class="difflineplus">+    smtpServer.authMethod = Ci.nsMsgAuthMethod.passwordCleartext;</span>
<a href="#l40.17"></a><span id="l40.17" class="difflineplus">+    smtpServer.socketType = Ci.nsMsgSocketType.plain;</span>
<a href="#l40.18"></a><span id="l40.18">     smtpServer.username = kUsername;</span>
<a href="#l40.19"></a><span id="l40.19"> </span>
<a href="#l40.20"></a><span id="l40.20">     smtpService.sendMailMessage(testFile, kTo, identity,</span>
<a href="#l40.21"></a><span id="l40.21">                                 null, null, null, null,</span>
<a href="#l40.22"></a><span id="l40.22">                                 false, {}, {});</span>
<a href="#l40.23"></a><span id="l40.23"> </span>
<a href="#l40.24"></a><span id="l40.24">     // Set the new password for when we get a prompt</span>
<a href="#l40.25"></a><span id="l40.25">     gNewPassword = kPassword1;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_sendMailMessage.js</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_sendMailMessage.js</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -49,20 +49,18 @@ function test_RFC2821() {</span>
<a href="#l41.4"></a><span id="l41.4">                                        &quot;RCPT TO:&lt;&quot; + kTo + &quot;&gt;&quot;,</span>
<a href="#l41.5"></a><span id="l41.5">                                        &quot;DATA&quot;]);</span>
<a href="#l41.6"></a><span id="l41.6"> </span>
<a href="#l41.7"></a><span id="l41.7">     server.resetTest();</span>
<a href="#l41.8"></a><span id="l41.8"> </span>
<a href="#l41.9"></a><span id="l41.9">     // This time with auth</span>
<a href="#l41.10"></a><span id="l41.10">     test = &quot;Auth sendMailMessage&quot;;</span>
<a href="#l41.11"></a><span id="l41.11"> </span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-    smtpServer.authMethod = 1;</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineminus">-    smtpServer.useSecAuth = false;</span>
<a href="#l41.14"></a><span id="l41.14" class="difflineminus">-    smtpServer.trySecAuth = false;</span>
<a href="#l41.15"></a><span id="l41.15" class="difflineminus">-    smtpServer.trySSL = false;</span>
<a href="#l41.16"></a><span id="l41.16" class="difflineplus">+    smtpServer.authMethod = Ci.nsMsgAuthMethod.passwordCleartext;</span>
<a href="#l41.17"></a><span id="l41.17" class="difflineplus">+    smtpServer.socketType = Ci.nsMsgSocketType.plain;</span>
<a href="#l41.18"></a><span id="l41.18">     smtpServer.username = kUsername;</span>
<a href="#l41.19"></a><span id="l41.19">     smtpServer.password = kPassword;</span>
<a href="#l41.20"></a><span id="l41.20"> </span>
<a href="#l41.21"></a><span id="l41.21">     smtpService.sendMailMessage(testFile, kTo, identity,</span>
<a href="#l41.22"></a><span id="l41.22">                                 null, null, null, null,</span>
<a href="#l41.23"></a><span id="l41.23">                                 false, {}, {});</span>
<a href="#l41.24"></a><span id="l41.24"> </span>
<a href="#l41.25"></a><span id="l41.25">     server.performTest();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1">new file mode 100644</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineminus">--- /dev/null</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpAuthMethods.js</span>
<a href="#l42.4"></a><span id="l42.4" class="difflineat">@@ -0,0 +1,128 @@</span>
<a href="#l42.5"></a><span id="l42.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l42.6"></a><span id="l42.6" class="difflineplus">+/**</span>
<a href="#l42.7"></a><span id="l42.7" class="difflineplus">+ * Authentication tests for SMTP.</span>
<a href="#l42.8"></a><span id="l42.8" class="difflineplus">+ *</span>
<a href="#l42.9"></a><span id="l42.9" class="difflineplus">+ * Test code &lt;copied from=&quot;test_pop3AuthMethods.js&quot;&gt;</span>
<a href="#l42.10"></a><span id="l42.10" class="difflineplus">+ */</span>
<a href="#l42.11"></a><span id="l42.11" class="difflineplus">+</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineplus">+var server;</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+var handler;</span>
<a href="#l42.14"></a><span id="l42.14" class="difflineplus">+var smtpServer;</span>
<a href="#l42.15"></a><span id="l42.15" class="difflineplus">+var smtpService;</span>
<a href="#l42.16"></a><span id="l42.16" class="difflineplus">+var testFile;</span>
<a href="#l42.17"></a><span id="l42.17" class="difflineplus">+var identity;</span>
<a href="#l42.18"></a><span id="l42.18" class="difflineplus">+</span>
<a href="#l42.19"></a><span id="l42.19" class="difflineplus">+const kUsername = &quot;fred&quot;;</span>
<a href="#l42.20"></a><span id="l42.20" class="difflineplus">+const kPassword = &quot;wilma&quot;;</span>
<a href="#l42.21"></a><span id="l42.21" class="difflineplus">+const kSender = &quot;from@invalid.com&quot;;</span>
<a href="#l42.22"></a><span id="l42.22" class="difflineplus">+const kTo = &quot;to@invalid.com&quot;;</span>
<a href="#l42.23"></a><span id="l42.23" class="difflineplus">+const MAILFROM = &quot;MAIL FROM:&lt;&quot; + kSender + &quot;&gt; SIZE=155&quot;;</span>
<a href="#l42.24"></a><span id="l42.24" class="difflineplus">+const RCPTTO = &quot;RCPT TO:&lt;&quot; + kTo + &quot;&gt;&quot;;</span>
<a href="#l42.25"></a><span id="l42.25" class="difflineplus">+const AUTHPLAIN = &quot;AUTH PLAIN &quot; + AuthPLAIN.encodeLine(kUsername, kPassword);</span>
<a href="#l42.26"></a><span id="l42.26" class="difflineplus">+</span>
<a href="#l42.27"></a><span id="l42.27" class="difflineplus">+var tests = [</span>
<a href="#l42.28"></a><span id="l42.28" class="difflineplus">+  { title: &quot;Cleartext password, with server supporting AUTH PLAIN, LOGIN, and CRAM&quot;,</span>
<a href="#l42.29"></a><span id="l42.29" class="difflineplus">+    clientAuthMethod : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l42.30"></a><span id="l42.30" class="difflineplus">+    serverAuthMethods : [ &quot;PLAIN&quot;, &quot;LOGIN&quot;, &quot;CRAM-MD5&quot; ],</span>
<a href="#l42.31"></a><span id="l42.31" class="difflineplus">+    expectSuccess : true,</span>
<a href="#l42.32"></a><span id="l42.32" class="difflineplus">+    transaction: [ &quot;EHLO test&quot;, AUTHPLAIN, MAILFROM, RCPTTO, &quot;DATA&quot; ] },</span>
<a href="#l42.33"></a><span id="l42.33" class="difflineplus">+  { title: &quot;Cleartext password, with server only supporting AUTH LOGIN&quot;,</span>
<a href="#l42.34"></a><span id="l42.34" class="difflineplus">+    clientAuthMethod : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l42.35"></a><span id="l42.35" class="difflineplus">+    serverAuthMethods : [ &quot;LOGIN&quot; ],</span>
<a href="#l42.36"></a><span id="l42.36" class="difflineplus">+    expectSuccess : true,</span>
<a href="#l42.37"></a><span id="l42.37" class="difflineplus">+    transaction: [ &quot;EHLO test&quot;, &quot;AUTH LOGIN&quot;, MAILFROM, RCPTTO, &quot;DATA&quot; ] },</span>
<a href="#l42.38"></a><span id="l42.38" class="difflineplus">+  { title: &quot;Encrypted password, with server supporting AUTH PLAIN, LOGIN and CRAM&quot;,</span>
<a href="#l42.39"></a><span id="l42.39" class="difflineplus">+    clientAuthMethod : Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l42.40"></a><span id="l42.40" class="difflineplus">+    serverAuthMethods : [ &quot;PLAIN&quot;, &quot;LOGIN&quot;, &quot;CRAM-MD5&quot; ],</span>
<a href="#l42.41"></a><span id="l42.41" class="difflineplus">+    expectSuccess : true,</span>
<a href="#l42.42"></a><span id="l42.42" class="difflineplus">+    transaction: [ &quot;EHLO test&quot;, &quot;AUTH CRAM-MD5&quot;, MAILFROM, RCPTTO, &quot;DATA&quot; ] },</span>
<a href="#l42.43"></a><span id="l42.43" class="difflineplus">+  { title: &quot;Encrypted password, with server only supporting AUTH PLAIN (must fail)&quot;,</span>
<a href="#l42.44"></a><span id="l42.44" class="difflineplus">+    clientAuthMethod : Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l42.45"></a><span id="l42.45" class="difflineplus">+    serverAuthMethods : [ &quot;PLAIN&quot; ],</span>
<a href="#l42.46"></a><span id="l42.46" class="difflineplus">+    expectSuccess : false,</span>
<a href="#l42.47"></a><span id="l42.47" class="difflineplus">+    transaction: [ &quot;EHLO test&quot;] },</span>
<a href="#l42.48"></a><span id="l42.48" class="difflineplus">+  { title: &quot;Any secure method, with server supporting AUTH PLAIN, LOGIN and CRAM&quot;,</span>
<a href="#l42.49"></a><span id="l42.49" class="difflineplus">+    clientAuthMethod : Ci.nsMsgAuthMethod.secure,</span>
<a href="#l42.50"></a><span id="l42.50" class="difflineplus">+    serverAuthMethods : [ &quot;PLAIN&quot; , &quot;LOGIN&quot;, &quot;CRAM-MD5&quot; ],</span>
<a href="#l42.51"></a><span id="l42.51" class="difflineplus">+    expectSuccess : true,</span>
<a href="#l42.52"></a><span id="l42.52" class="difflineplus">+    transaction: [ &quot;EHLO test&quot;, &quot;AUTH CRAM-MD5&quot;, MAILFROM, RCPTTO, &quot;DATA&quot; ] },</span>
<a href="#l42.53"></a><span id="l42.53" class="difflineplus">+  { title: &quot;Any secure method, with server only supporting AUTH PLAIN (must fail)&quot;,</span>
<a href="#l42.54"></a><span id="l42.54" class="difflineplus">+    clientAuthMethod : Ci.nsMsgAuthMethod.secure,</span>
<a href="#l42.55"></a><span id="l42.55" class="difflineplus">+    serverAuthMethods : [ &quot;PLAIN&quot; ],</span>
<a href="#l42.56"></a><span id="l42.56" class="difflineplus">+    expectSuccess : false,</span>
<a href="#l42.57"></a><span id="l42.57" class="difflineplus">+    transaction: [ &quot;EHLO test&quot; ] },</span>
<a href="#l42.58"></a><span id="l42.58" class="difflineplus">+];</span>
<a href="#l42.59"></a><span id="l42.59" class="difflineplus">+</span>
<a href="#l42.60"></a><span id="l42.60" class="difflineplus">+</span>
<a href="#l42.61"></a><span id="l42.61" class="difflineplus">+</span>
<a href="#l42.62"></a><span id="l42.62" class="difflineplus">+function nextTest() {</span>
<a href="#l42.63"></a><span id="l42.63" class="difflineplus">+  if (tests.length == 0)</span>
<a href="#l42.64"></a><span id="l42.64" class="difflineplus">+  {</span>
<a href="#l42.65"></a><span id="l42.65" class="difflineplus">+    // this is sync, so we run into endTest() at the end of run_test() now</span>
<a href="#l42.66"></a><span id="l42.66" class="difflineplus">+    return;</span>
<a href="#l42.67"></a><span id="l42.67" class="difflineplus">+  }</span>
<a href="#l42.68"></a><span id="l42.68" class="difflineplus">+  server.resetTest();</span>
<a href="#l42.69"></a><span id="l42.69" class="difflineplus">+</span>
<a href="#l42.70"></a><span id="l42.70" class="difflineplus">+  var curTest = tests.shift();</span>
<a href="#l42.71"></a><span id="l42.71" class="difflineplus">+  test = curTest.title;</span>
<a href="#l42.72"></a><span id="l42.72" class="difflineplus">+  dump(&quot;NEXT test: &quot; + curTest.title + &quot;\n&quot;);</span>
<a href="#l42.73"></a><span id="l42.73" class="difflineplus">+</span>
<a href="#l42.74"></a><span id="l42.74" class="difflineplus">+</span>
<a href="#l42.75"></a><span id="l42.75" class="difflineplus">+  // Adapt to curTest</span>
<a href="#l42.76"></a><span id="l42.76" class="difflineplus">+  handler.kAuthSchemes = curTest.serverAuthMethods;</span>
<a href="#l42.77"></a><span id="l42.77" class="difflineplus">+  smtpServer.authMethod = curTest.clientAuthMethod;</span>
<a href="#l42.78"></a><span id="l42.78" class="difflineplus">+</span>
<a href="#l42.79"></a><span id="l42.79" class="difflineplus">+  // Run test</span>
<a href="#l42.80"></a><span id="l42.80" class="difflineplus">+  smtpService.sendMailMessage(testFile, kTo, identity,</span>
<a href="#l42.81"></a><span id="l42.81" class="difflineplus">+                              null, null, null, null,</span>
<a href="#l42.82"></a><span id="l42.82" class="difflineplus">+                              false, {}, {});</span>
<a href="#l42.83"></a><span id="l42.83" class="difflineplus">+  server.performTest();</span>
<a href="#l42.84"></a><span id="l42.84" class="difflineplus">+</span>
<a href="#l42.85"></a><span id="l42.85" class="difflineplus">+  do_check_transaction(server.playTransaction(), curTest.transaction);</span>
<a href="#l42.86"></a><span id="l42.86" class="difflineplus">+</span>
<a href="#l42.87"></a><span id="l42.87" class="difflineplus">+  nextTest();</span>
<a href="#l42.88"></a><span id="l42.88" class="difflineplus">+}</span>
<a href="#l42.89"></a><span id="l42.89" class="difflineplus">+</span>
<a href="#l42.90"></a><span id="l42.90" class="difflineplus">+function run_test() {</span>
<a href="#l42.91"></a><span id="l42.91" class="difflineplus">+  // Handle the server in a try/catch/finally loop so that we always will stop</span>
<a href="#l42.92"></a><span id="l42.92" class="difflineplus">+  // the server if something fails.</span>
<a href="#l42.93"></a><span id="l42.93" class="difflineplus">+  try {</span>
<a href="#l42.94"></a><span id="l42.94" class="difflineplus">+    handler = new SMTP_RFC2821_handler(new smtpDaemon());</span>
<a href="#l42.95"></a><span id="l42.95" class="difflineplus">+    server = new nsMailServer(handler);</span>
<a href="#l42.96"></a><span id="l42.96" class="difflineplus">+    handler.kUsername = kUsername;</span>
<a href="#l42.97"></a><span id="l42.97" class="difflineplus">+    handler.kPassword = kPassword;</span>
<a href="#l42.98"></a><span id="l42.98" class="difflineplus">+    handler.kAuthRequired = true;</span>
<a href="#l42.99"></a><span id="l42.99" class="difflineplus">+    dump(&quot;AUTH PLAIN = &quot; + AUTHPLAIN + &quot;\n&quot;);</span>
<a href="#l42.100"></a><span id="l42.100" class="difflineplus">+    server.start(SMTP_PORT);</span>
<a href="#l42.101"></a><span id="l42.101" class="difflineplus">+</span>
<a href="#l42.102"></a><span id="l42.102" class="difflineplus">+    loadLocalMailAccount();</span>
<a href="#l42.103"></a><span id="l42.103" class="difflineplus">+    smtpServer = getBasicSmtpServer();</span>
<a href="#l42.104"></a><span id="l42.104" class="difflineplus">+    smtpServer.socketType = Ci.nsMsgSocketType.plain;</span>
<a href="#l42.105"></a><span id="l42.105" class="difflineplus">+    smtpServer.username = handler.kUsername;</span>
<a href="#l42.106"></a><span id="l42.106" class="difflineplus">+    smtpServer.password = handler.kPassword;</span>
<a href="#l42.107"></a><span id="l42.107" class="difflineplus">+    identity = getSmtpIdentity(kSender, smtpServer);</span>
<a href="#l42.108"></a><span id="l42.108" class="difflineplus">+    smtpService = Cc[&quot;@mozilla.org/messengercompose/smtp;1&quot;]</span>
<a href="#l42.109"></a><span id="l42.109" class="difflineplus">+                        .getService(Ci.nsISmtpService);</span>
<a href="#l42.110"></a><span id="l42.110" class="difflineplus">+</span>
<a href="#l42.111"></a><span id="l42.111" class="difflineplus">+    testFile = do_get_file(&quot;data/message1.eml&quot;);</span>
<a href="#l42.112"></a><span id="l42.112" class="difflineplus">+</span>
<a href="#l42.113"></a><span id="l42.113" class="difflineplus">+    nextTest();</span>
<a href="#l42.114"></a><span id="l42.114" class="difflineplus">+</span>
<a href="#l42.115"></a><span id="l42.115" class="difflineplus">+  } catch (e) {</span>
<a href="#l42.116"></a><span id="l42.116" class="difflineplus">+    do_throw(e);</span>
<a href="#l42.117"></a><span id="l42.117" class="difflineplus">+  } finally {</span>
<a href="#l42.118"></a><span id="l42.118" class="difflineplus">+    endTest();</span>
<a href="#l42.119"></a><span id="l42.119" class="difflineplus">+  }</span>
<a href="#l42.120"></a><span id="l42.120" class="difflineplus">+}</span>
<a href="#l42.121"></a><span id="l42.121" class="difflineplus">+</span>
<a href="#l42.122"></a><span id="l42.122" class="difflineplus">+function endTest() {</span>
<a href="#l42.123"></a><span id="l42.123" class="difflineplus">+    dump(&quot;endTest()\n&quot;);</span>
<a href="#l42.124"></a><span id="l42.124" class="difflineplus">+    server.stop();</span>
<a href="#l42.125"></a><span id="l42.125" class="difflineplus">+</span>
<a href="#l42.126"></a><span id="l42.126" class="difflineplus">+    dump(&quot;emptying event loop\n&quot;);</span>
<a href="#l42.127"></a><span id="l42.127" class="difflineplus">+    var thread = gThreadManager.currentThread;</span>
<a href="#l42.128"></a><span id="l42.128" class="difflineplus">+    while (thread.hasPendingEvents()) {</span>
<a href="#l42.129"></a><span id="l42.129" class="difflineplus">+        dump(&quot;next event\n&quot;);</span>
<a href="#l42.130"></a><span id="l42.130" class="difflineplus">+      thread.processNextEvent(true);</span>
<a href="#l42.131"></a><span id="l42.131" class="difflineplus">+    }</span>
<a href="#l42.132"></a><span id="l42.132" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpPassword.js</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpPassword.js</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -41,20 +41,18 @@ function run_test() {</span>
<a href="#l43.4"></a><span id="l43.4">   // the server if something fails.</span>
<a href="#l43.5"></a><span id="l43.5">   try {</span>
<a href="#l43.6"></a><span id="l43.6">     // Start the fake SMTP server</span>
<a href="#l43.7"></a><span id="l43.7">     server.start(SMTP_PORT);</span>
<a href="#l43.8"></a><span id="l43.8"> </span>
<a href="#l43.9"></a><span id="l43.9">     // This time with auth</span>
<a href="#l43.10"></a><span id="l43.10">     test = &quot;Auth sendMailMessage&quot;;</span>
<a href="#l43.11"></a><span id="l43.11"> </span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-    smtpServer.authMethod = 1;</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineminus">-    smtpServer.useSecAuth = false;</span>
<a href="#l43.14"></a><span id="l43.14" class="difflineminus">-    smtpServer.trySecAuth = false;</span>
<a href="#l43.15"></a><span id="l43.15" class="difflineminus">-    smtpServer.trySSL = false;</span>
<a href="#l43.16"></a><span id="l43.16" class="difflineplus">+    smtpServer.authMethod = Ci.nsMsgAuthMethod.passwordCleartext;</span>
<a href="#l43.17"></a><span id="l43.17" class="difflineplus">+    smtpServer.socketType = Ci.nsMsgSocketType.plain;</span>
<a href="#l43.18"></a><span id="l43.18">     smtpServer.username = kUsername;</span>
<a href="#l43.19"></a><span id="l43.19"> </span>
<a href="#l43.20"></a><span id="l43.20">     smtpService.sendMailMessage(testFile, kTo, identity,</span>
<a href="#l43.21"></a><span id="l43.21">                                 null, null, null, null,</span>
<a href="#l43.22"></a><span id="l43.22">                                 false, {}, {});</span>
<a href="#l43.23"></a><span id="l43.23"> </span>
<a href="#l43.24"></a><span id="l43.24">     server.performTest();</span>
<a href="#l43.25"></a><span id="l43.25"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpPassword2.js</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpPassword2.js</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -21,19 +21,19 @@ function run_test()</span>
<a href="#l44.4"></a><span id="l44.4">   signons.copyTo(gProfileDir, &quot;signons.txt&quot;);</span>
<a href="#l44.5"></a><span id="l44.5"> </span>
<a href="#l44.6"></a><span id="l44.6">   // Set up the basic accounts and folders.</span>
<a href="#l44.7"></a><span id="l44.7">   loadLocalMailAccount();</span>
<a href="#l44.8"></a><span id="l44.8"> </span>
<a href="#l44.9"></a><span id="l44.9">   var smtpServer1 = getBasicSmtpServer();</span>
<a href="#l44.10"></a><span id="l44.10">   var smtpServer2 = getBasicSmtpServer();</span>
<a href="#l44.11"></a><span id="l44.11"> </span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-  smtpServer1.authMethod = 1;</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+  smtpServer1.authMethod = 3;</span>
<a href="#l44.14"></a><span id="l44.14">   smtpServer1.username = kUser1;</span>
<a href="#l44.15"></a><span id="l44.15" class="difflineminus">-  smtpServer2.authMethod = 1;</span>
<a href="#l44.16"></a><span id="l44.16" class="difflineplus">+  smtpServer2.authMethod = 3;</span>
<a href="#l44.17"></a><span id="l44.17">   smtpServer2.username = kUser2;</span>
<a href="#l44.18"></a><span id="l44.18"> </span>
<a href="#l44.19"></a><span id="l44.19">   var i;</span>
<a href="#l44.20"></a><span id="l44.20">   var count = {};</span>
<a href="#l44.21"></a><span id="l44.21"> </span>
<a href="#l44.22"></a><span id="l44.22">   // Test - Check there are two logins to begin with.</span>
<a href="#l44.23"></a><span id="l44.23">   var logins = loginMgr.findLogins(count, kServerUrl, null, kServerUrl);</span>
<a href="#l44.24"></a><span id="l44.24"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpPasswordFailure1.js</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpPasswordFailure1.js</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -108,20 +108,18 @@ function run_test() {</span>
<a href="#l45.4"></a><span id="l45.4">   // the server if something fails.</span>
<a href="#l45.5"></a><span id="l45.5">   try {</span>
<a href="#l45.6"></a><span id="l45.6">     // Start the fake SMTP server</span>
<a href="#l45.7"></a><span id="l45.7">     server.start(SMTP_PORT);</span>
<a href="#l45.8"></a><span id="l45.8"> </span>
<a href="#l45.9"></a><span id="l45.9">     // This time with auth</span>
<a href="#l45.10"></a><span id="l45.10">     test = &quot;Auth sendMailMessage&quot;;</span>
<a href="#l45.11"></a><span id="l45.11"> </span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-    smtpServer.authMethod = 1;</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineminus">-    smtpServer.useSecAuth = false;</span>
<a href="#l45.14"></a><span id="l45.14" class="difflineminus">-    smtpServer.trySecAuth = false;</span>
<a href="#l45.15"></a><span id="l45.15" class="difflineminus">-    smtpServer.trySSL = false;</span>
<a href="#l45.16"></a><span id="l45.16" class="difflineplus">+    smtpServer.authMethod = Ci.nsMsgAuthMethod.passwordCleartext;</span>
<a href="#l45.17"></a><span id="l45.17" class="difflineplus">+    smtpServer.socketType = Ci.nsMsgSocketType.plain;</span>
<a href="#l45.18"></a><span id="l45.18">     smtpServer.username = kUsername;</span>
<a href="#l45.19"></a><span id="l45.19"> </span>
<a href="#l45.20"></a><span id="l45.20">     dump(&quot;Send\n&quot;);</span>
<a href="#l45.21"></a><span id="l45.21"> </span>
<a href="#l45.22"></a><span id="l45.22">     smtpService.sendMailMessage(testFile, kTo, identity,</span>
<a href="#l45.23"></a><span id="l45.23">                                 null, null, null, null,</span>
<a href="#l45.24"></a><span id="l45.24">                                 false, {}, {});</span>
<a href="#l45.25"></a><span id="l45.25"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpPasswordFailure2.js</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpPasswordFailure2.js</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -119,20 +119,18 @@ function run_test() {</span>
<a href="#l46.4"></a><span id="l46.4">   // the server if something fails.</span>
<a href="#l46.5"></a><span id="l46.5">   try {</span>
<a href="#l46.6"></a><span id="l46.6">     // Start the fake SMTP server</span>
<a href="#l46.7"></a><span id="l46.7">     server.start(SMTP_PORT);</span>
<a href="#l46.8"></a><span id="l46.8"> </span>
<a href="#l46.9"></a><span id="l46.9">     // This time with auth</span>
<a href="#l46.10"></a><span id="l46.10">     test = &quot;Auth sendMailMessage&quot;;</span>
<a href="#l46.11"></a><span id="l46.11"> </span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-    smtpServer.authMethod = 1;</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineminus">-    smtpServer.useSecAuth = false;</span>
<a href="#l46.14"></a><span id="l46.14" class="difflineminus">-    smtpServer.trySecAuth = false;</span>
<a href="#l46.15"></a><span id="l46.15" class="difflineminus">-    smtpServer.trySSL = false;</span>
<a href="#l46.16"></a><span id="l46.16" class="difflineplus">+    smtpServer.authMethod = Ci.nsMsgAuthMethod.passwordCleartext;</span>
<a href="#l46.17"></a><span id="l46.17" class="difflineplus">+    smtpServer.socketType = Ci.nsMsgSocketType.plain;</span>
<a href="#l46.18"></a><span id="l46.18">     smtpServer.username = kUsername;</span>
<a href="#l46.19"></a><span id="l46.19"> </span>
<a href="#l46.20"></a><span id="l46.20">     dump(&quot;Send\n&quot;);</span>
<a href="#l46.21"></a><span id="l46.21"> </span>
<a href="#l46.22"></a><span id="l46.22">     smtpService.sendMailMessage(testFile, kTo, identity,</span>
<a href="#l46.23"></a><span id="l46.23">                                 null, null, null, null,</span>
<a href="#l46.24"></a><span id="l46.24">                                 false, {}, {});</span>
<a href="#l46.25"></a><span id="l46.25"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/mailnews/imap/src/nsImapCore.h</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapCore.h</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -118,18 +118,18 @@ typedef enum {</span>
<a href="#l47.4"></a><span id="l47.4">     kPublicNamespace,</span>
<a href="#l47.5"></a><span id="l47.5">     kDefaultNamespace,</span>
<a href="#l47.6"></a><span id="l47.6">     kUnknownNamespace</span>
<a href="#l47.7"></a><span id="l47.7"> } EIMAPNamespaceType;</span>
<a href="#l47.8"></a><span id="l47.8"> </span>
<a href="#l47.9"></a><span id="l47.9"> typedef enum {</span>
<a href="#l47.10"></a><span id="l47.10">     kCapabilityUndefined = 0x00000000,</span>
<a href="#l47.11"></a><span id="l47.11">     kCapabilityDefined = 0x00000001,</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineminus">-    kHasAuthLoginCapability = 0x00000002,</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineminus">-    kHasXNetscapeCapability = 0x00000004,</span>
<a href="#l47.14"></a><span id="l47.14" class="difflineplus">+    kHasAuthLoginCapability = 0x00000002, /* AUTH LOGIN (not the same as kHasAuthOldLoginCapability) */</span>
<a href="#l47.15"></a><span id="l47.15" class="difflineplus">+    kHasAuthOldLoginCapability = 0x00000004, /* original IMAP login method */</span>
<a href="#l47.16"></a><span id="l47.16">     kHasXSenderCapability = 0x00000008,</span>
<a href="#l47.17"></a><span id="l47.17">     kIMAP4Capability = 0x00000010,          /* RFC1734 */</span>
<a href="#l47.18"></a><span id="l47.18">     kIMAP4rev1Capability = 0x00000020,      /* RFC2060 */</span>
<a href="#l47.19"></a><span id="l47.19">     kIMAP4other = 0x00000040,                       /* future rev?? */</span>
<a href="#l47.20"></a><span id="l47.20">     kNoHierarchyRename = 0x00000080,                        /* no hierarchy rename */</span>
<a href="#l47.21"></a><span id="l47.21">     kACLCapability = 0x00000100,          /* ACL extension */</span>
<a href="#l47.22"></a><span id="l47.22">     kNamespaceCapability = 0x00000200,    /* IMAP4 Namespace Extension */</span>
<a href="#l47.23"></a><span id="l47.23">     kMailboxDataCapability = 0x00000400,  /* MAILBOXDATA SMTP posting extension */</span>
<a href="#l47.24"></a><span id="l47.24" class="difflineat">@@ -140,18 +140,18 @@ typedef enum {</span>
<a href="#l47.25"></a><span id="l47.25">     kAOLImapCapability = 0x00008000,     /* aol imap extensions */</span>
<a href="#l47.26"></a><span id="l47.26">     kHasLanguageCapability = 0x00010000, /* language extensions */</span>
<a href="#l47.27"></a><span id="l47.27">     kHasCRAMCapability     = 0x00020000, /* CRAM auth extension */</span>
<a href="#l47.28"></a><span id="l47.28">     kQuotaCapability       = 0x00040000, /* RFC 2087 quota extension */</span>
<a href="#l47.29"></a><span id="l47.29">     kHasIdleCapability       = 0x00080000,  /* RFC 2177 idle extension */</span>
<a href="#l47.30"></a><span id="l47.30">     kHasAuthNTLMCapability = 0x00100000,  /* AUTH NTLM extension */</span>
<a href="#l47.31"></a><span id="l47.31">     kHasAuthMSNCapability = 0x00200000,   /* AUTH MSN extension */</span>
<a href="#l47.32"></a><span id="l47.32">     kHasStartTLSCapability = 0x00400000,   /* STARTTLS support */</span>
<a href="#l47.33"></a><span id="l47.33" class="difflineminus">-    kLoginDisabled = 0x00800000,        /* login disabled */</span>
<a href="#l47.34"></a><span id="l47.34" class="difflineminus">-    kHasAuthGssApiCapability = 0x01000000, /* GSSAPI AUTH */ </span>
<a href="#l47.35"></a><span id="l47.35" class="difflineplus">+    kHasAuthNoneCapability = 0x00800000, /* needs no login */</span>
<a href="#l47.36"></a><span id="l47.36" class="difflineplus">+    kHasAuthGssApiCapability = 0x01000000, /* GSSAPI AUTH */</span>
<a href="#l47.37"></a><span id="l47.37">     kHasCondStoreCapability =  0x02000000, /* RFC 3551 CondStore extension */</span>
<a href="#l47.38"></a><span id="l47.38">     kHasEnableCapability    =  0x04000000, /* RFC 5161 ENABLE extension */</span>
<a href="#l47.39"></a><span id="l47.39">     kHasXListCapability    =  0x08000000,  /* XLIST extension */</span>
<a href="#l47.40"></a><span id="l47.40">     kHasCompressDeflateCapability  =  0x10000000  /* RFC 4978 COMPRESS extension */</span>
<a href="#l47.41"></a><span id="l47.41"> } eIMAPCapabilityFlag;</span>
<a href="#l47.42"></a><span id="l47.42"> </span>
<a href="#l47.43"></a><span id="l47.43"> // this used to be part of the connection object class - maybe we should move it into </span>
<a href="#l47.44"></a><span id="l47.44"> // something similar</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -829,24 +829,33 @@ nsImapIncomingServer::GetImapConnection(</span>
<a href="#l48.4"></a><span id="l48.4"> nsresult</span>
<a href="#l48.5"></a><span id="l48.5"> nsImapIncomingServer::CreateProtocolInstance(nsIEventTarget *aEventTarget,</span>
<a href="#l48.6"></a><span id="l48.6">                                              nsIImapProtocol ** aImapConnection)</span>
<a href="#l48.7"></a><span id="l48.7"> {</span>
<a href="#l48.8"></a><span id="l48.8">   // create a new connection and add it to the connection cache</span>
<a href="#l48.9"></a><span id="l48.9">   // we may need to flag the protocol connection as busy so we don't get</span>
<a href="#l48.10"></a><span id="l48.10">   // a race condition where someone else goes through this code</span>
<a href="#l48.11"></a><span id="l48.11"> </span>
<a href="#l48.12"></a><span id="l48.12" class="difflineminus">-  PRBool useSecAuth;</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineminus">-  GetUseSecAuth(&amp;useSecAuth);</span>
<a href="#l48.14"></a><span id="l48.14" class="difflineplus">+  PRInt32 authMethod;</span>
<a href="#l48.15"></a><span id="l48.15" class="difflineplus">+  GetAuthMethod(&amp;authMethod);</span>
<a href="#l48.16"></a><span id="l48.16">   nsresult rv;</span>
<a href="#l48.17"></a><span id="l48.17" class="difflineminus">-  // pre-flight that we have nss - on the ui thread</span>
<a href="#l48.18"></a><span id="l48.18" class="difflineminus">-  if (useSecAuth)</span>
<a href="#l48.19"></a><span id="l48.19" class="difflineplus">+  // pre-flight that we have nss - on the ui thread - for MD5 etc.</span>
<a href="#l48.20"></a><span id="l48.20" class="difflineplus">+  switch (authMethod)</span>
<a href="#l48.21"></a><span id="l48.21">   {</span>
<a href="#l48.22"></a><span id="l48.22" class="difflineminus">-    nsCOMPtr&lt;nsISignatureVerifier&gt; verifier = do_GetService(SIGNATURE_VERIFIER_CONTRACTID, &amp;rv);</span>
<a href="#l48.23"></a><span id="l48.23" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.24"></a><span id="l48.24" class="difflineplus">+    case nsMsgAuthMethod::passwordEncrypted:</span>
<a href="#l48.25"></a><span id="l48.25" class="difflineplus">+    case nsMsgAuthMethod::secure:</span>
<a href="#l48.26"></a><span id="l48.26" class="difflineplus">+    case nsMsgAuthMethod::anything:</span>
<a href="#l48.27"></a><span id="l48.27" class="difflineplus">+      {</span>
<a href="#l48.28"></a><span id="l48.28" class="difflineplus">+        nsCOMPtr&lt;nsISignatureVerifier&gt; verifier =</span>
<a href="#l48.29"></a><span id="l48.29" class="difflineplus">+            do_GetService(SIGNATURE_VERIFIER_CONTRACTID, &amp;rv);</span>
<a href="#l48.30"></a><span id="l48.30" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.31"></a><span id="l48.31" class="difflineplus">+      }</span>
<a href="#l48.32"></a><span id="l48.32" class="difflineplus">+      break;</span>
<a href="#l48.33"></a><span id="l48.33" class="difflineplus">+    default:</span>
<a href="#l48.34"></a><span id="l48.34" class="difflineplus">+      break;</span>
<a href="#l48.35"></a><span id="l48.35">   }</span>
<a href="#l48.36"></a><span id="l48.36">   nsIImapProtocol * protocolInstance;</span>
<a href="#l48.37"></a><span id="l48.37">   rv = CallCreateInstance(kImapProtocolCID, &amp;protocolInstance);</span>
<a href="#l48.38"></a><span id="l48.38">   if (NS_SUCCEEDED(rv) &amp;&amp; protocolInstance)</span>
<a href="#l48.39"></a><span id="l48.39">   {</span>
<a href="#l48.40"></a><span id="l48.40">     nsCOMPtr&lt;nsIImapHostSessionList&gt; hostSession =</span>
<a href="#l48.41"></a><span id="l48.41">       do_GetService(kCImapHostSessionListCID, &amp;rv);</span>
<a href="#l48.42"></a><span id="l48.42">     if (NS_SUCCEEDED(rv))</span>
<a href="#l48.43"></a><span id="l48.43" class="difflineat">@@ -2751,17 +2760,17 @@ nsImapIncomingServer::GeneratePrettyName</span>
<a href="#l48.44"></a><span id="l48.44">   PRInt32 serverPort = PORT_NOT_SET;</span>
<a href="#l48.45"></a><span id="l48.45">   rv = GetPort(&amp;serverPort);</span>
<a href="#l48.46"></a><span id="l48.46">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l48.47"></a><span id="l48.47"> </span>
<a href="#l48.48"></a><span id="l48.48">   // Is the server secure ?</span>
<a href="#l48.49"></a><span id="l48.49">   PRInt32 socketType;</span>
<a href="#l48.50"></a><span id="l48.50">   rv = GetSocketType(&amp;socketType);</span>
<a href="#l48.51"></a><span id="l48.51">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l48.52"></a><span id="l48.52" class="difflineminus">-  PRBool isSecure = (socketType == nsIMsgIncomingServer::useSSL);</span>
<a href="#l48.53"></a><span id="l48.53" class="difflineplus">+  PRBool isSecure = (socketType == nsMsgSocketType::SSL);</span>
<a href="#l48.54"></a><span id="l48.54"> </span>
<a href="#l48.55"></a><span id="l48.55">   // Is server port a default port ?</span>
<a href="#l48.56"></a><span id="l48.56">   PRBool isItDefaultPort = PR_FALSE;</span>
<a href="#l48.57"></a><span id="l48.57">   if (((serverPort == defaultServerPort) &amp;&amp; !isSecure)||</span>
<a href="#l48.58"></a><span id="l48.58">       ((serverPort == defaultSecureServerPort) &amp;&amp; isSecure))</span>
<a href="#l48.59"></a><span id="l48.59">       isItDefaultPort = PR_TRUE;</span>
<a href="#l48.60"></a><span id="l48.60"> </span>
<a href="#l48.61"></a><span id="l48.61">   // Construct pretty name from username and hostname</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -18,16 +18,17 @@</span>
<a href="#l49.4"></a><span id="l49.4">  * Netscape Communications Corporation.</span>
<a href="#l49.5"></a><span id="l49.5">  * Portions created by the Initial Developer are Copyright (C) 1999</span>
<a href="#l49.6"></a><span id="l49.6">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l49.7"></a><span id="l49.7">  *</span>
<a href="#l49.8"></a><span id="l49.8">  * Contributor(s):</span>
<a href="#l49.9"></a><span id="l49.9">  *   Pierre Phaneuf &lt;pp@ludusdesign.com&gt;</span>
<a href="#l49.10"></a><span id="l49.10">  *   Henry Jia &lt;Henry.Jia@sun.com&gt;</span>
<a href="#l49.11"></a><span id="l49.11">  *   Lorenzo Colitti &lt;lorenzo@colitti.com&gt;</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineplus">+ *   Ben Bucksch &lt;ben.bucksch beonex.com&gt; &lt;http://business.beonex.com&gt;</span>
<a href="#l49.13"></a><span id="l49.13">  *</span>
<a href="#l49.14"></a><span id="l49.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l49.15"></a><span id="l49.15">  * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l49.16"></a><span id="l49.16">  * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l49.17"></a><span id="l49.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l49.18"></a><span id="l49.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l49.19"></a><span id="l49.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l49.20"></a><span id="l49.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l49.21"></a><span id="l49.21" class="difflineat">@@ -371,24 +372,25 @@ nsImapProtocol::nsImapProtocol() : nsMsg</span>
<a href="#l49.22"></a><span id="l49.22"> {</span>
<a href="#l49.23"></a><span id="l49.23">   m_urlInProgress = PR_FALSE;</span>
<a href="#l49.24"></a><span id="l49.24">   m_idle = PR_FALSE;</span>
<a href="#l49.25"></a><span id="l49.25">   m_retryUrlOnError = PR_FALSE;</span>
<a href="#l49.26"></a><span id="l49.26">   m_useIdle = PR_TRUE; // by default, use it</span>
<a href="#l49.27"></a><span id="l49.27">   m_useCondStore = PR_TRUE;</span>
<a href="#l49.28"></a><span id="l49.28">   m_useCompressDeflate = PR_TRUE;</span>
<a href="#l49.29"></a><span id="l49.29">   m_ignoreExpunges = PR_FALSE;</span>
<a href="#l49.30"></a><span id="l49.30" class="difflineminus">-  m_useSecAuth = PR_FALSE;</span>
<a href="#l49.31"></a><span id="l49.31" class="difflineminus">-  m_socketType = nsIMsgIncomingServer::tryTLS;</span>
<a href="#l49.32"></a><span id="l49.32" class="difflineplus">+  m_prefAuthMethods = kCapabilityUndefined;</span>
<a href="#l49.33"></a><span id="l49.33" class="difflineplus">+  m_failedAuthMethods = 0;</span>
<a href="#l49.34"></a><span id="l49.34" class="difflineplus">+  m_currentAuthMethod = kCapabilityUndefined;</span>
<a href="#l49.35"></a><span id="l49.35" class="difflineplus">+  m_socketType = nsMsgSocketType::trySTARTTLS;</span>
<a href="#l49.36"></a><span id="l49.36">   m_connectionStatus = 0;</span>
<a href="#l49.37"></a><span id="l49.37">   m_safeToCloseConnection = PR_FALSE;</span>
<a href="#l49.38"></a><span id="l49.38">   m_hostSessionList = nsnull;</span>
<a href="#l49.39"></a><span id="l49.39">   m_flagState = nsnull;</span>
<a href="#l49.40"></a><span id="l49.40">   m_fetchBodyIdList = nsnull;</span>
<a href="#l49.41"></a><span id="l49.41" class="difflineminus">-  m_authLogin = PR_TRUE;</span>
<a href="#l49.42"></a><span id="l49.42"> </span>
<a href="#l49.43"></a><span id="l49.43">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l49.44"></a><span id="l49.44">   NS_ASSERTION(prefBranch, &quot;FAILED to create the preference service&quot;);</span>
<a href="#l49.45"></a><span id="l49.45"> </span>
<a href="#l49.46"></a><span id="l49.46">   // read in the accept languages preference</span>
<a href="#l49.47"></a><span id="l49.47">   if (prefBranch)</span>
<a href="#l49.48"></a><span id="l49.48">   {</span>
<a href="#l49.49"></a><span id="l49.49">     if (!gInitialized)</span>
<a href="#l49.50"></a><span id="l49.50" class="difflineat">@@ -524,19 +526,17 @@ nsresult nsImapProtocol::Initialize(nsII</span>
<a href="#l49.51"></a><span id="l49.51"> </span>
<a href="#l49.52"></a><span id="l49.52">   m_sinkEventTarget = aSinkEventTarget;</span>
<a href="#l49.53"></a><span id="l49.53">   m_hostSessionList = aHostSessionList; // no ref count...host session list has life time &gt; connection</span>
<a href="#l49.54"></a><span id="l49.54">   m_parser.SetHostSessionList(aHostSessionList);</span>
<a href="#l49.55"></a><span id="l49.55">   m_parser.SetFlagState(m_flagState);</span>
<a href="#l49.56"></a><span id="l49.56"> </span>
<a href="#l49.57"></a><span id="l49.57">   // one of the initializations that should be done in UI thread</span>
<a href="#l49.58"></a><span id="l49.58">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l49.59"></a><span id="l49.59" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; prefBranch)</span>
<a href="#l49.60"></a><span id="l49.60" class="difflineminus">-    prefBranch-&gt;GetBoolPref(&quot;mail.auth_login&quot;, &amp;m_authLogin);</span>
<a href="#l49.61"></a><span id="l49.61" class="difflineminus">-    </span>
<a href="#l49.62"></a><span id="l49.62" class="difflineplus">+</span>
<a href="#l49.63"></a><span id="l49.63">   // Now initialize the thread for the connection and create appropriate monitors</span>
<a href="#l49.64"></a><span id="l49.64">   if (m_thread == nsnull)</span>
<a href="#l49.65"></a><span id="l49.65">   {</span>
<a href="#l49.66"></a><span id="l49.66">     m_dataAvailableMonitor = PR_NewMonitor();</span>
<a href="#l49.67"></a><span id="l49.67">     m_urlReadyToRunMonitor = PR_NewMonitor();</span>
<a href="#l49.68"></a><span id="l49.68">     m_pseudoInterruptMonitor = PR_NewMonitor();</span>
<a href="#l49.69"></a><span id="l49.69">     m_dataMemberMonitor = PR_NewMonitor();</span>
<a href="#l49.70"></a><span id="l49.70">     m_threadDeathMonitor = PR_NewMonitor();</span>
<a href="#l49.71"></a><span id="l49.71" class="difflineat">@@ -791,19 +791,21 @@ nsresult nsImapProtocol::SetupWithUrl(ns</span>
<a href="#l49.72"></a><span id="l49.72">                                 getter_AddRefs(m_channelListener));</span>
<a href="#l49.73"></a><span id="l49.73">       if (NS_FAILED(rv)) return rv;</span>
<a href="#l49.74"></a><span id="l49.74">     }</span>
<a href="#l49.75"></a><span id="l49.75"> </span>
<a href="#l49.76"></a><span id="l49.76">     PRUint32 capability = kCapabilityUndefined;</span>
<a href="#l49.77"></a><span id="l49.77"> </span>
<a href="#l49.78"></a><span id="l49.78">     m_hostSessionList-&gt;GetCapabilityForHost(GetImapServerKey(), capability);</span>
<a href="#l49.79"></a><span id="l49.79"> </span>
<a href="#l49.80"></a><span id="l49.80" class="difflineplus">+    PRInt32 authMethod;</span>
<a href="#l49.81"></a><span id="l49.81" class="difflineplus">+    (void) server-&gt;GetAuthMethod(&amp;authMethod);</span>
<a href="#l49.82"></a><span id="l49.82" class="difflineplus">+    InitPrefAuthMethods(authMethod);</span>
<a href="#l49.83"></a><span id="l49.83" class="difflineplus">+    (void) server-&gt;GetSocketType(&amp;m_socketType);</span>
<a href="#l49.84"></a><span id="l49.84">     PRBool shuttingDown;</span>
<a href="#l49.85"></a><span id="l49.85" class="difflineminus">-    (void) server-&gt;GetUseSecAuth(&amp;m_useSecAuth);</span>
<a href="#l49.86"></a><span id="l49.86" class="difflineminus">-    (void) server-&gt;GetSocketType(&amp;m_socketType);</span>
<a href="#l49.87"></a><span id="l49.87">     (void) imapServer-&gt;GetShuttingDown(&amp;shuttingDown);</span>
<a href="#l49.88"></a><span id="l49.88">     if (!shuttingDown)</span>
<a href="#l49.89"></a><span id="l49.89">       (void) imapServer-&gt;GetUseIdle(&amp;m_useIdle);</span>
<a href="#l49.90"></a><span id="l49.90">     else</span>
<a href="#l49.91"></a><span id="l49.91">       m_useIdle = PR_FALSE;</span>
<a href="#l49.92"></a><span id="l49.92">     if (imapServer)</span>
<a href="#l49.93"></a><span id="l49.93">       imapServer-&gt;GetFetchByChunks(&amp;m_fetchByChunks);</span>
<a href="#l49.94"></a><span id="l49.94"> </span>
<a href="#l49.95"></a><span id="l49.95" class="difflineat">@@ -813,35 +815,36 @@ nsresult nsImapProtocol::SetupWithUrl(ns</span>
<a href="#l49.96"></a><span id="l49.96">       PRInt32 port=-1;</span>
<a href="#l49.97"></a><span id="l49.97">       server-&gt;GetPort(&amp;port);</span>
<a href="#l49.98"></a><span id="l49.98"> </span>
<a href="#l49.99"></a><span id="l49.99">       if (port &lt;= 0)</span>
<a href="#l49.100"></a><span id="l49.100">       {</span>
<a href="#l49.101"></a><span id="l49.101">         PRInt32 socketType;</span>
<a href="#l49.102"></a><span id="l49.102">         // Be a bit smarter about setting the default port</span>
<a href="#l49.103"></a><span id="l49.103">         port = (NS_SUCCEEDED(server-&gt;GetSocketType(&amp;socketType)) &amp;&amp;</span>
<a href="#l49.104"></a><span id="l49.104" class="difflineminus">-                socketType == nsIMsgIncomingServer::useSSL) ?</span>
<a href="#l49.105"></a><span id="l49.105" class="difflineplus">+                socketType == nsMsgSocketType::SSL) ?</span>
<a href="#l49.106"></a><span id="l49.106">                nsIImapUrl::DEFAULT_IMAPS_PORT : nsIImapUrl::DEFAULT_IMAP_PORT;</span>
<a href="#l49.107"></a><span id="l49.107">       }</span>
<a href="#l49.108"></a><span id="l49.108">       nsCAutoString hostName;</span>
<a href="#l49.109"></a><span id="l49.109">       nsCOMPtr&lt;nsISocketTransportService&gt; socketService = </span>
<a href="#l49.110"></a><span id="l49.110">                do_GetService(NS_SOCKETTRANSPORTSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l49.111"></a><span id="l49.111">       if (NS_SUCCEEDED(rv) &amp;&amp; aURL)</span>
<a href="#l49.112"></a><span id="l49.112">       {</span>
<a href="#l49.113"></a><span id="l49.113">         aURL-&gt;GetPort(&amp;port);</span>
<a href="#l49.114"></a><span id="l49.114">         server-&gt;GetRealHostName(hostName);</span>
<a href="#l49.115"></a><span id="l49.115"> </span>
<a href="#l49.116"></a><span id="l49.116">         Log(&quot;SetupWithUrl&quot;, nsnull, &quot;clearing IMAP_CONNECTION_IS_OPEN&quot;);</span>
<a href="#l49.117"></a><span id="l49.117">         ClearFlag(IMAP_CONNECTION_IS_OPEN);</span>
<a href="#l49.118"></a><span id="l49.118">         const char *connectionType = nsnull;</span>
<a href="#l49.119"></a><span id="l49.119"> </span>
<a href="#l49.120"></a><span id="l49.120" class="difflineminus">-        if (m_socketType == nsIMsgIncomingServer::useSSL)</span>
<a href="#l49.121"></a><span id="l49.121" class="difflineplus">+        if (m_socketType == nsMsgSocketType::SSL)</span>
<a href="#l49.122"></a><span id="l49.122">           connectionType = &quot;ssl&quot;;</span>
<a href="#l49.123"></a><span id="l49.123" class="difflineminus">-        else if ((m_socketType == nsIMsgIncomingServer::tryTLS &amp;&amp; (capability &amp; kHasStartTLSCapability))</span>
<a href="#l49.124"></a><span id="l49.124" class="difflineminus">-          || m_socketType == nsIMsgIncomingServer::alwaysUseTLS)</span>
<a href="#l49.125"></a><span id="l49.125" class="difflineplus">+        else if ((m_socketType == nsMsgSocketType::trySTARTTLS &amp;&amp;</span>
<a href="#l49.126"></a><span id="l49.126" class="difflineplus">+                 (capability &amp; kHasStartTLSCapability))</span>
<a href="#l49.127"></a><span id="l49.127" class="difflineplus">+                 || m_socketType == nsMsgSocketType::alwaysSTARTTLS)</span>
<a href="#l49.128"></a><span id="l49.128">           connectionType = &quot;starttls&quot;;</span>
<a href="#l49.129"></a><span id="l49.129"> </span>
<a href="#l49.130"></a><span id="l49.130">         nsCOMPtr&lt;nsIProxyInfo&gt; proxyInfo;</span>
<a href="#l49.131"></a><span id="l49.131">         rv = NS_ExamineForProxy(&quot;imap&quot;, hostName.get(), port, getter_AddRefs(proxyInfo));</span>
<a href="#l49.132"></a><span id="l49.132">         if (NS_FAILED(rv)) proxyInfo = nsnull;</span>
<a href="#l49.133"></a><span id="l49.133"> </span>
<a href="#l49.134"></a><span id="l49.134">         const nsACString *socketHost;</span>
<a href="#l49.135"></a><span id="l49.135">         PRUint16 socketPort;</span>
<a href="#l49.136"></a><span id="l49.136" class="difflineat">@@ -854,20 +857,20 @@ nsresult nsImapProtocol::SetupWithUrl(ns</span>
<a href="#l49.137"></a><span id="l49.137">         else</span>
<a href="#l49.138"></a><span id="l49.138">         {</span>
<a href="#l49.139"></a><span id="l49.139">           socketHost = &amp;hostName;</span>
<a href="#l49.140"></a><span id="l49.140">           socketPort = port;</span>
<a href="#l49.141"></a><span id="l49.141">         }</span>
<a href="#l49.142"></a><span id="l49.142">         rv = socketService-&gt;CreateTransport(&amp;connectionType, connectionType != nsnull,</span>
<a href="#l49.143"></a><span id="l49.143">                                             *socketHost, socketPort, proxyInfo,</span>
<a href="#l49.144"></a><span id="l49.144">                                             getter_AddRefs(m_transport));</span>
<a href="#l49.145"></a><span id="l49.145" class="difflineminus">-        if (NS_FAILED(rv) &amp;&amp; m_socketType == nsIMsgIncomingServer::tryTLS)</span>
<a href="#l49.146"></a><span id="l49.146" class="difflineplus">+        if (NS_FAILED(rv) &amp;&amp; m_socketType == nsMsgSocketType::trySTARTTLS)</span>
<a href="#l49.147"></a><span id="l49.147">         {</span>
<a href="#l49.148"></a><span id="l49.148">           connectionType = nsnull;</span>
<a href="#l49.149"></a><span id="l49.149" class="difflineminus">-          m_socketType = nsIMsgIncomingServer::defaultSocket;</span>
<a href="#l49.150"></a><span id="l49.150" class="difflineplus">+          m_socketType = nsMsgSocketType::plain;</span>
<a href="#l49.151"></a><span id="l49.151">           rv = socketService-&gt;CreateTransport(&amp;connectionType, connectionType != nsnull,</span>
<a href="#l49.152"></a><span id="l49.152">                                               *socketHost, socketPort, proxyInfo,</span>
<a href="#l49.153"></a><span id="l49.153">                                               getter_AddRefs(m_transport));</span>
<a href="#l49.154"></a><span id="l49.154">         }</span>
<a href="#l49.155"></a><span id="l49.155">         // remember so we can know whether we can issue a start tls or not...</span>
<a href="#l49.156"></a><span id="l49.156">         m_connectionType = connectionType;</span>
<a href="#l49.157"></a><span id="l49.157">         if (m_transport &amp;&amp; m_mockChannel)</span>
<a href="#l49.158"></a><span id="l49.158">         {</span>
<a href="#l49.159"></a><span id="l49.159" class="difflineat">@@ -1626,19 +1629,19 @@ PRBool nsImapProtocol::ProcessCurrentURL</span>
<a href="#l49.160"></a><span id="l49.160">         if (!DeathSignalReceived() &amp;&amp; GetConnectionStatus() &gt;= 0)</span>
<a href="#l49.161"></a><span id="l49.161">           AlertUserEventUsingId(IMAP_SERVER_NOT_IMAP4);</span>
<a href="#l49.162"></a><span id="l49.162"> </span>
<a href="#l49.163"></a><span id="l49.163">         SetConnectionStatus(-1);        // stop netlib</span>
<a href="#l49.164"></a><span id="l49.164">       }</span>
<a href="#l49.165"></a><span id="l49.165">       else</span>
<a href="#l49.166"></a><span id="l49.166">       {</span>
<a href="#l49.167"></a><span id="l49.167">         if (m_connectionType.Equals(&quot;starttls&quot;)</span>
<a href="#l49.168"></a><span id="l49.168" class="difflineminus">-            &amp;&amp; (m_socketType == nsIMsgIncomingServer::tryTLS</span>
<a href="#l49.169"></a><span id="l49.169" class="difflineplus">+            &amp;&amp; (m_socketType == nsMsgSocketType::trySTARTTLS</span>
<a href="#l49.170"></a><span id="l49.170">             &amp;&amp; (GetServerStateParser().GetCapabilityFlag() &amp; kHasStartTLSCapability))</span>
<a href="#l49.171"></a><span id="l49.171" class="difflineminus">-          || m_socketType == nsIMsgIncomingServer::alwaysUseTLS)</span>
<a href="#l49.172"></a><span id="l49.172" class="difflineplus">+          || m_socketType == nsMsgSocketType::alwaysSTARTTLS)</span>
<a href="#l49.173"></a><span id="l49.173">         {</span>
<a href="#l49.174"></a><span id="l49.174">           StartTLS();</span>
<a href="#l49.175"></a><span id="l49.175">           if (GetServerStateParser().LastCommandSuccessful())</span>
<a href="#l49.176"></a><span id="l49.176">           {</span>
<a href="#l49.177"></a><span id="l49.177">             nsCOMPtr&lt;nsISupports&gt; secInfo;</span>
<a href="#l49.178"></a><span id="l49.178">             nsCOMPtr&lt;nsISocketTransport&gt; strans = do_QueryInterface(m_transport, &amp;rv);</span>
<a href="#l49.179"></a><span id="l49.179">             if (NS_FAILED(rv)) return rv;</span>
<a href="#l49.180"></a><span id="l49.180"> </span>
<a href="#l49.181"></a><span id="l49.181" class="difflineat">@@ -1648,16 +1651,19 @@ PRBool nsImapProtocol::ProcessCurrentURL</span>
<a href="#l49.182"></a><span id="l49.182">             {</span>
<a href="#l49.183"></a><span id="l49.183">               nsCOMPtr&lt;nsISSLSocketControl&gt; sslControl = do_QueryInterface(secInfo, &amp;rv);</span>
<a href="#l49.184"></a><span id="l49.184"> </span>
<a href="#l49.185"></a><span id="l49.185">               if (NS_SUCCEEDED(rv) &amp;&amp; sslControl)</span>
<a href="#l49.186"></a><span id="l49.186">               {</span>
<a href="#l49.187"></a><span id="l49.187">                 rv = sslControl-&gt;StartTLS();</span>
<a href="#l49.188"></a><span id="l49.188">                 if (NS_SUCCEEDED(rv))</span>
<a href="#l49.189"></a><span id="l49.189">                 {</span>
<a href="#l49.190"></a><span id="l49.190" class="difflineplus">+                  // force re-issue of &quot;capability&quot;, because servers may</span>
<a href="#l49.191"></a><span id="l49.191" class="difflineplus">+                  // enable other auth features (e.g. remove LOGINDISABLED</span>
<a href="#l49.192"></a><span id="l49.192" class="difflineplus">+                  // and add AUTH=PLAIN) after we upgraded to SSL.</span>
<a href="#l49.193"></a><span id="l49.193">                   Capability();</span>
<a href="#l49.194"></a><span id="l49.194">                   PRInt32 capabilityFlag = GetServerStateParser().GetCapabilityFlag();</span>
<a href="#l49.195"></a><span id="l49.195">                   // Courier imap doesn't return STARTTLS capability if we've done</span>
<a href="#l49.196"></a><span id="l49.196">                   // a STARTTLS! But we need to remember this capability so we'll</span>
<a href="#l49.197"></a><span id="l49.197">                   // try to use STARTTLS next time.</span>
<a href="#l49.198"></a><span id="l49.198">                   if (!(capabilityFlag &amp; kHasStartTLSCapability))</span>
<a href="#l49.199"></a><span id="l49.199">                   {</span>
<a href="#l49.200"></a><span id="l49.200">                     capabilityFlag |= kHasStartTLSCapability;</span>
<a href="#l49.201"></a><span id="l49.201" class="difflineat">@@ -1668,34 +1674,34 @@ PRBool nsImapProtocol::ProcessCurrentURL</span>
<a href="#l49.202"></a><span id="l49.202">                 }</span>
<a href="#l49.203"></a><span id="l49.203">               }</span>
<a href="#l49.204"></a><span id="l49.204">             }</span>
<a href="#l49.205"></a><span id="l49.205">             if (NS_FAILED(rv))</span>
<a href="#l49.206"></a><span id="l49.206">             {</span>
<a href="#l49.207"></a><span id="l49.207">               nsCAutoString logLine(&quot;STARTTLS negotiation failed. Error 0x&quot;);</span>
<a href="#l49.208"></a><span id="l49.208">               logLine.AppendInt(rv, 16);</span>
<a href="#l49.209"></a><span id="l49.209">               Log(&quot;ProcessCurrentURL&quot;, nsnull, logLine.get());</span>
<a href="#l49.210"></a><span id="l49.210" class="difflineminus">-              if (m_socketType == nsIMsgIncomingServer::alwaysUseTLS)</span>
<a href="#l49.211"></a><span id="l49.211" class="difflineplus">+              if (m_socketType == nsMsgSocketType::alwaysSTARTTLS)</span>
<a href="#l49.212"></a><span id="l49.212">               {</span>
<a href="#l49.213"></a><span id="l49.213">                 SetConnectionStatus(-1);        // stop netlib</span>
<a href="#l49.214"></a><span id="l49.214">                 m_transport-&gt;Close(rv);</span>
<a href="#l49.215"></a><span id="l49.215">               }</span>
<a href="#l49.216"></a><span id="l49.216">             }</span>
<a href="#l49.217"></a><span id="l49.217">           }</span>
<a href="#l49.218"></a><span id="l49.218" class="difflineminus">-          else if (m_socketType == nsIMsgIncomingServer::alwaysUseTLS)</span>
<a href="#l49.219"></a><span id="l49.219" class="difflineplus">+          else if (m_socketType == nsMsgSocketType::alwaysSTARTTLS)</span>
<a href="#l49.220"></a><span id="l49.220">           {</span>
<a href="#l49.221"></a><span id="l49.221">             SetConnectionStatus(-1);        // stop netlib</span>
<a href="#l49.222"></a><span id="l49.222">             if (m_transport)</span>
<a href="#l49.223"></a><span id="l49.223">               m_transport-&gt;Close(rv);</span>
<a href="#l49.224"></a><span id="l49.224">           }</span>
<a href="#l49.225"></a><span id="l49.225">         }</span>
<a href="#l49.226"></a><span id="l49.226">         // in this case, we didn't know the server supported TLS when</span>
<a href="#l49.227"></a><span id="l49.227">         // we created the socket, so we're going to retry with</span>
<a href="#l49.228"></a><span id="l49.228">         // STARTTLS.</span>
<a href="#l49.229"></a><span id="l49.229" class="difflineminus">-        else if (m_socketType == nsIMsgIncomingServer::tryTLS</span>
<a href="#l49.230"></a><span id="l49.230" class="difflineplus">+        else if (m_socketType == nsMsgSocketType::trySTARTTLS</span>
<a href="#l49.231"></a><span id="l49.231">             &amp;&amp; (GetServerStateParser().GetCapabilityFlag() &amp; kHasStartTLSCapability))</span>
<a href="#l49.232"></a><span id="l49.232">         {</span>
<a href="#l49.233"></a><span id="l49.233">           ClearFlag(IMAP_CONNECTION_IS_OPEN);</span>
<a href="#l49.234"></a><span id="l49.234">           TellThreadToDie();</span>
<a href="#l49.235"></a><span id="l49.235">           SetConnectionStatus(-1);</span>
<a href="#l49.236"></a><span id="l49.236">           return RetryUrl();</span>
<a href="#l49.237"></a><span id="l49.237">         }</span>
<a href="#l49.238"></a><span id="l49.238">         logonFailed = !TryToLogon();</span>
<a href="#l49.239"></a><span id="l49.239" class="difflineat">@@ -5407,119 +5413,203 @@ void nsImapProtocol::EscapeUserNamePassw</span>
<a href="#l49.240"></a><span id="l49.240">         {</span>
<a href="#l49.241"></a><span id="l49.241">             resultStr-&gt;Append('\\');</span>
<a href="#l49.242"></a><span id="l49.242">         }</span>
<a href="#l49.243"></a><span id="l49.243">         resultStr-&gt;Append(strToEscape[i]);</span>
<a href="#l49.244"></a><span id="l49.244">     }</span>
<a href="#l49.245"></a><span id="l49.245">   }</span>
<a href="#l49.246"></a><span id="l49.246"> }</span>
<a href="#l49.247"></a><span id="l49.247"> </span>
<a href="#l49.248"></a><span id="l49.248" class="difflineminus">-void nsImapProtocol::InsecureLogin(const char *userName, const nsCString &amp;password)</span>
<a href="#l49.249"></a><span id="l49.249" class="difflineminus">-{</span>
<a href="#l49.250"></a><span id="l49.250" class="difflineminus">-  ProgressEventFunctionUsingId (IMAP_STATUS_SENDING_LOGIN);</span>
<a href="#l49.251"></a><span id="l49.251" class="difflineminus">-  IncrementCommandTagNumber();</span>
<a href="#l49.252"></a><span id="l49.252" class="difflineminus">-  nsCString command (GetServerCommandTag());</span>
<a href="#l49.253"></a><span id="l49.253" class="difflineminus">-  nsCAutoString escapedUserName;</span>
<a href="#l49.254"></a><span id="l49.254" class="difflineminus">-  command.Append(&quot; login \&quot;&quot;);</span>
<a href="#l49.255"></a><span id="l49.255" class="difflineminus">-  EscapeUserNamePasswordString(userName, &amp;escapedUserName);</span>
<a href="#l49.256"></a><span id="l49.256" class="difflineminus">-  command.Append(escapedUserName);</span>
<a href="#l49.257"></a><span id="l49.257" class="difflineminus">-  command.Append(&quot;\&quot; \&quot;&quot;);</span>
<a href="#l49.258"></a><span id="l49.258" class="difflineminus">-</span>
<a href="#l49.259"></a><span id="l49.259" class="difflineminus">-  // if the password contains a \, login will fail</span>
<a href="#l49.260"></a><span id="l49.260" class="difflineminus">-  // turn foo\bar into foo\\bar</span>
<a href="#l49.261"></a><span id="l49.261" class="difflineminus">-  nsCAutoString correctedPassword;</span>
<a href="#l49.262"></a><span id="l49.262" class="difflineminus">-  EscapeUserNamePasswordString(password.get(), &amp;correctedPassword);</span>
<a href="#l49.263"></a><span id="l49.263" class="difflineminus">-  command.Append(correctedPassword);</span>
<a href="#l49.264"></a><span id="l49.264" class="difflineminus">-  command.Append(&quot;\&quot;&quot;CRLF);</span>
<a href="#l49.265"></a><span id="l49.265" class="difflineminus">-</span>
<a href="#l49.266"></a><span id="l49.266" class="difflineminus">-  nsresult rv = SendData(command.get(), PR_TRUE /* suppress logging */);</span>
<a href="#l49.267"></a><span id="l49.267" class="difflineminus">-</span>
<a href="#l49.268"></a><span id="l49.268" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l49.269"></a><span id="l49.269" class="difflineminus">-     ParseIMAPandCheckForNewMail();</span>
<a href="#l49.270"></a><span id="l49.270" class="difflineplus">+void nsImapProtocol::InitPrefAuthMethods(PRInt32 authMethodPrefValue)</span>
<a href="#l49.271"></a><span id="l49.271" class="difflineplus">+{</span>
<a href="#l49.272"></a><span id="l49.272" class="difflineplus">+    // for m_prefAuthMethods, using the same flags as server capablities.</span>
<a href="#l49.273"></a><span id="l49.273" class="difflineplus">+    switch (authMethodPrefValue)</span>
<a href="#l49.274"></a><span id="l49.274" class="difflineplus">+    {</span>
<a href="#l49.275"></a><span id="l49.275" class="difflineplus">+      case nsMsgAuthMethod::none:</span>
<a href="#l49.276"></a><span id="l49.276" class="difflineplus">+        m_prefAuthMethods = kHasAuthNoneCapability;</span>
<a href="#l49.277"></a><span id="l49.277" class="difflineplus">+        break;</span>
<a href="#l49.278"></a><span id="l49.278" class="difflineplus">+      case nsMsgAuthMethod::old:</span>
<a href="#l49.279"></a><span id="l49.279" class="difflineplus">+        m_prefAuthMethods = kHasAuthOldLoginCapability;</span>
<a href="#l49.280"></a><span id="l49.280" class="difflineplus">+        break;</span>
<a href="#l49.281"></a><span id="l49.281" class="difflineplus">+      case nsMsgAuthMethod::passwordCleartext:</span>
<a href="#l49.282"></a><span id="l49.282" class="difflineplus">+        m_prefAuthMethods = kHasAuthOldLoginCapability |</span>
<a href="#l49.283"></a><span id="l49.283" class="difflineplus">+            kHasAuthLoginCapability | kHasAuthPlainCapability;</span>
<a href="#l49.284"></a><span id="l49.284" class="difflineplus">+        break;</span>
<a href="#l49.285"></a><span id="l49.285" class="difflineplus">+      case nsMsgAuthMethod::passwordEncrypted:</span>
<a href="#l49.286"></a><span id="l49.286" class="difflineplus">+        m_prefAuthMethods = kHasCRAMCapability;</span>
<a href="#l49.287"></a><span id="l49.287" class="difflineplus">+        break;</span>
<a href="#l49.288"></a><span id="l49.288" class="difflineplus">+      case nsMsgAuthMethod::NTLM:</span>
<a href="#l49.289"></a><span id="l49.289" class="difflineplus">+        m_prefAuthMethods = kHasAuthNTLMCapability | kHasAuthMSNCapability;</span>
<a href="#l49.290"></a><span id="l49.290" class="difflineplus">+        break;</span>
<a href="#l49.291"></a><span id="l49.291" class="difflineplus">+      case nsMsgAuthMethod::GSSAPI:</span>
<a href="#l49.292"></a><span id="l49.292" class="difflineplus">+        m_prefAuthMethods = kHasAuthGssApiCapability;</span>
<a href="#l49.293"></a><span id="l49.293" class="difflineplus">+        break;</span>
<a href="#l49.294"></a><span id="l49.294" class="difflineplus">+      case nsMsgAuthMethod::secure:</span>
<a href="#l49.295"></a><span id="l49.295" class="difflineplus">+        m_prefAuthMethods = kHasCRAMCapability |</span>
<a href="#l49.296"></a><span id="l49.296" class="difflineplus">+            kHasAuthGssApiCapability |</span>
<a href="#l49.297"></a><span id="l49.297" class="difflineplus">+            kHasAuthNTLMCapability | kHasAuthMSNCapability;</span>
<a href="#l49.298"></a><span id="l49.298" class="difflineplus">+        break;</span>
<a href="#l49.299"></a><span id="l49.299" class="difflineplus">+      default:</span>
<a href="#l49.300"></a><span id="l49.300" class="difflineplus">+        NS_ASSERTION(false, &quot;IMAP: authMethod pref invalid&quot;);</span>
<a href="#l49.301"></a><span id="l49.301" class="difflineplus">+        // TODO log to error console</span>
<a href="#l49.302"></a><span id="l49.302" class="difflineplus">+        PR_LOG(IMAP, PR_LOG_ERROR,</span>
<a href="#l49.303"></a><span id="l49.303" class="difflineplus">+            (&quot;IMAP: bad pref authMethod = %d\n&quot;, authMethodPrefValue));</span>
<a href="#l49.304"></a><span id="l49.304" class="difflineplus">+        // fall to any</span>
<a href="#l49.305"></a><span id="l49.305" class="difflineplus">+      case nsMsgAuthMethod::anything:</span>
<a href="#l49.306"></a><span id="l49.306" class="difflineplus">+        m_prefAuthMethods = kHasAuthOldLoginCapability |</span>
<a href="#l49.307"></a><span id="l49.307" class="difflineplus">+            kHasAuthLoginCapability | kHasAuthPlainCapability |</span>
<a href="#l49.308"></a><span id="l49.308" class="difflineplus">+            kHasCRAMCapability | kHasAuthGssApiCapability |</span>
<a href="#l49.309"></a><span id="l49.309" class="difflineplus">+            kHasAuthNTLMCapability | kHasAuthMSNCapability;</span>
<a href="#l49.310"></a><span id="l49.310" class="difflineplus">+        break;</span>
<a href="#l49.311"></a><span id="l49.311" class="difflineplus">+    }</span>
<a href="#l49.312"></a><span id="l49.312" class="difflineplus">+    NS_ASSERTION(m_prefAuthMethods != kCapabilityUndefined,</span>
<a href="#l49.313"></a><span id="l49.313" class="difflineplus">+         &quot;IMAP: InitPrefAuthMethods() didn't work&quot;);</span>
<a href="#l49.314"></a><span id="l49.314" class="difflineplus">+}</span>
<a href="#l49.315"></a><span id="l49.315" class="difflineplus">+</span>
<a href="#l49.316"></a><span id="l49.316" class="difflineplus">+/**</span>
<a href="#l49.317"></a><span id="l49.317" class="difflineplus">+ * Changes m_currentAuthMethod to pick the best remaining one</span>
<a href="#l49.318"></a><span id="l49.318" class="difflineplus">+ * which is allowed by server and prefs and not marked failed.</span>
<a href="#l49.319"></a><span id="l49.319" class="difflineplus">+ * The order of preference and trying of auth methods is encoded here.</span>
<a href="#l49.320"></a><span id="l49.320" class="difflineplus">+ */</span>
<a href="#l49.321"></a><span id="l49.321" class="difflineplus">+nsresult nsImapProtocol::ChooseAuthMethod()</span>
<a href="#l49.322"></a><span id="l49.322" class="difflineplus">+{</span>
<a href="#l49.323"></a><span id="l49.323" class="difflineplus">+  PRInt32 serverCaps = GetServerStateParser().GetCapabilityFlag();</span>
<a href="#l49.324"></a><span id="l49.324" class="difflineplus">+  PRInt32 availCaps = serverCaps &amp; m_prefAuthMethods &amp; ~m_failedAuthMethods;</span>
<a href="#l49.325"></a><span id="l49.325" class="difflineplus">+</span>
<a href="#l49.326"></a><span id="l49.326" class="difflineplus">+  PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;IMAP auth: server caps 0x%X, pref 0x%X, failed 0x%X, avail caps 0x%X&quot;,</span>
<a href="#l49.327"></a><span id="l49.327" class="difflineplus">+        serverCaps, m_prefAuthMethods, m_failedAuthMethods, availCaps));</span>
<a href="#l49.328"></a><span id="l49.328" class="difflineplus">+  PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;(GSSAPI = 0x%X, CRAM = 0x%X, NTLM = 0x%X, &quot;</span>
<a href="#l49.329"></a><span id="l49.329" class="difflineplus">+        &quot;MSN =  0x%X, PLAIN = 0x%X, LOGIN = 0x%X, old-style IMAP login = 0x%X)&quot;,</span>
<a href="#l49.330"></a><span id="l49.330" class="difflineplus">+        kHasAuthGssApiCapability, kHasCRAMCapability, kHasAuthNTLMCapability,</span>
<a href="#l49.331"></a><span id="l49.331" class="difflineplus">+        kHasAuthMSNCapability, kHasAuthPlainCapability, kHasAuthLoginCapability,</span>
<a href="#l49.332"></a><span id="l49.332" class="difflineplus">+        kHasAuthOldLoginCapability));</span>
<a href="#l49.333"></a><span id="l49.333" class="difflineplus">+</span>
<a href="#l49.334"></a><span id="l49.334" class="difflineplus">+  if (kHasAuthGssApiCapability &amp; availCaps)</span>
<a href="#l49.335"></a><span id="l49.335" class="difflineplus">+    m_currentAuthMethod = kHasAuthGssApiCapability;</span>
<a href="#l49.336"></a><span id="l49.336" class="difflineplus">+  else if (kHasCRAMCapability &amp; availCaps)</span>
<a href="#l49.337"></a><span id="l49.337" class="difflineplus">+    m_currentAuthMethod = kHasCRAMCapability;</span>
<a href="#l49.338"></a><span id="l49.338" class="difflineplus">+  else if (kHasAuthNTLMCapability &amp; availCaps)</span>
<a href="#l49.339"></a><span id="l49.339" class="difflineplus">+    m_currentAuthMethod = kHasAuthNTLMCapability;</span>
<a href="#l49.340"></a><span id="l49.340" class="difflineplus">+  else if (kHasAuthMSNCapability &amp; availCaps)</span>
<a href="#l49.341"></a><span id="l49.341" class="difflineplus">+    m_currentAuthMethod = kHasAuthMSNCapability;</span>
<a href="#l49.342"></a><span id="l49.342" class="difflineplus">+  else if (kHasAuthPlainCapability &amp; availCaps)</span>
<a href="#l49.343"></a><span id="l49.343" class="difflineplus">+    m_currentAuthMethod = kHasAuthPlainCapability;</span>
<a href="#l49.344"></a><span id="l49.344" class="difflineplus">+  else if (kHasAuthLoginCapability &amp; availCaps)</span>
<a href="#l49.345"></a><span id="l49.345" class="difflineplus">+    m_currentAuthMethod = kHasAuthLoginCapability;</span>
<a href="#l49.346"></a><span id="l49.346" class="difflineplus">+  else if (kHasAuthOldLoginCapability &amp; availCaps)</span>
<a href="#l49.347"></a><span id="l49.347" class="difflineplus">+    m_currentAuthMethod = kHasAuthOldLoginCapability;</span>
<a href="#l49.348"></a><span id="l49.348" class="difflineplus">+  else</span>
<a href="#l49.349"></a><span id="l49.349" class="difflineplus">+  {</span>
<a href="#l49.350"></a><span id="l49.350" class="difflineplus">+    PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;no remaining auth method&quot;));</span>
<a href="#l49.351"></a><span id="l49.351" class="difflineplus">+    m_currentAuthMethod = kCapabilityUndefined;</span>
<a href="#l49.352"></a><span id="l49.352" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l49.353"></a><span id="l49.353" class="difflineplus">+  }</span>
<a href="#l49.354"></a><span id="l49.354" class="difflineplus">+  PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;trying auth method 0x%X&quot;, m_currentAuthMethod));</span>
<a href="#l49.355"></a><span id="l49.355" class="difflineplus">+  return NS_OK;</span>
<a href="#l49.356"></a><span id="l49.356" class="difflineplus">+}</span>
<a href="#l49.357"></a><span id="l49.357" class="difflineplus">+</span>
<a href="#l49.358"></a><span id="l49.358" class="difflineplus">+void nsImapProtocol::MarkAuthMethodAsFailed(PRInt32 failedAuthMethod)</span>
<a href="#l49.359"></a><span id="l49.359" class="difflineplus">+{</span>
<a href="#l49.360"></a><span id="l49.360" class="difflineplus">+  PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;marking auth method 0x%X failed&quot;, failedAuthMethod));</span>
<a href="#l49.361"></a><span id="l49.361" class="difflineplus">+  m_failedAuthMethods |= failedAuthMethod;</span>
<a href="#l49.362"></a><span id="l49.362" class="difflineplus">+}</span>
<a href="#l49.363"></a><span id="l49.363" class="difflineplus">+</span>
<a href="#l49.364"></a><span id="l49.364" class="difflineplus">+/**</span>
<a href="#l49.365"></a><span id="l49.365" class="difflineplus">+ * Start over, trying all auth methods again</span>
<a href="#l49.366"></a><span id="l49.366" class="difflineplus">+ */</span>
<a href="#l49.367"></a><span id="l49.367" class="difflineplus">+void nsImapProtocol::ResetAuthMethods()</span>
<a href="#l49.368"></a><span id="l49.368" class="difflineplus">+{</span>
<a href="#l49.369"></a><span id="l49.369" class="difflineplus">+  PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;resetting (failed) auth methods&quot;));</span>
<a href="#l49.370"></a><span id="l49.370" class="difflineplus">+  m_currentAuthMethod = kCapabilityUndefined;</span>
<a href="#l49.371"></a><span id="l49.371" class="difflineplus">+  m_failedAuthMethods = 0;</span>
<a href="#l49.372"></a><span id="l49.372"> }</span>
<a href="#l49.373"></a><span id="l49.373"> </span>
<a href="#l49.374"></a><span id="l49.374"> nsresult nsImapProtocol::AuthLogin(const char *userName, const nsCString &amp;password, eIMAPCapabilityFlag flag)</span>
<a href="#l49.375"></a><span id="l49.375"> {</span>
<a href="#l49.376"></a><span id="l49.376">   ProgressEventFunctionUsingId (IMAP_STATUS_SENDING_AUTH_LOGIN);</span>
<a href="#l49.377"></a><span id="l49.377">   IncrementCommandTagNumber();</span>
<a href="#l49.378"></a><span id="l49.378"> </span>
<a href="#l49.379"></a><span id="l49.379">   char * currentCommand=nsnull;</span>
<a href="#l49.380"></a><span id="l49.380">   nsresult rv;</span>
<a href="#l49.381"></a><span id="l49.381"> </span>
<a href="#l49.382"></a><span id="l49.382" class="difflineplus">+  PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;IMAP: trying auth method 0x%X&quot;, m_currentAuthMethod));</span>
<a href="#l49.383"></a><span id="l49.383" class="difflineplus">+</span>
<a href="#l49.384"></a><span id="l49.384">   if (flag &amp; kHasCRAMCapability)</span>
<a href="#l49.385"></a><span id="l49.385">   {</span>
<a href="#l49.386"></a><span id="l49.386" class="difflineminus">-      // inform the server that we want to begin a CRAM authentication procedure...</span>
<a href="#l49.387"></a><span id="l49.387" class="difflineminus">-      nsCAutoString command (GetServerCommandTag());</span>
<a href="#l49.388"></a><span id="l49.388" class="difflineminus">-      command.Append(&quot; authenticate CRAM-MD5&quot; CRLF);</span>
<a href="#l49.389"></a><span id="l49.389" class="difflineminus">-      rv = SendData(command.get());</span>
<a href="#l49.390"></a><span id="l49.390" class="difflineminus">-      ParseIMAPandCheckForNewMail();</span>
<a href="#l49.391"></a><span id="l49.391" class="difflineminus">-      if (GetServerStateParser().LastCommandSuccessful())</span>
<a href="#l49.392"></a><span id="l49.392" class="difflineplus">+    NS_ENSURE_TRUE(m_imapServerSink, NS_ERROR_NULL_POINTER);</span>
<a href="#l49.393"></a><span id="l49.393" class="difflineplus">+    PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;MD5 auth&quot;));</span>
<a href="#l49.394"></a><span id="l49.394" class="difflineplus">+    // inform the server that we want to begin a CRAM authentication procedure...</span>
<a href="#l49.395"></a><span id="l49.395" class="difflineplus">+    nsCAutoString command (GetServerCommandTag());</span>
<a href="#l49.396"></a><span id="l49.396" class="difflineplus">+    command.Append(&quot; authenticate CRAM-MD5&quot; CRLF);</span>
<a href="#l49.397"></a><span id="l49.397" class="difflineplus">+    rv = SendData(command.get());</span>
<a href="#l49.398"></a><span id="l49.398" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l49.399"></a><span id="l49.399" class="difflineplus">+    ParseIMAPandCheckForNewMail();</span>
<a href="#l49.400"></a><span id="l49.400" class="difflineplus">+    if (GetServerStateParser().LastCommandSuccessful())</span>
<a href="#l49.401"></a><span id="l49.401" class="difflineplus">+    {</span>
<a href="#l49.402"></a><span id="l49.402" class="difflineplus">+      char *digest = nsnull;</span>
<a href="#l49.403"></a><span id="l49.403" class="difflineplus">+      char *cramDigest = GetServerStateParser().fAuthChallenge;</span>
<a href="#l49.404"></a><span id="l49.404" class="difflineplus">+      char *decodedChallenge = PL_Base64Decode(cramDigest,</span>
<a href="#l49.405"></a><span id="l49.405" class="difflineplus">+                                                strlen(cramDigest), nsnull);</span>
<a href="#l49.406"></a><span id="l49.406" class="difflineplus">+      rv = m_imapServerSink-&gt;CramMD5Hash(decodedChallenge, password.get(), &amp;digest);</span>
<a href="#l49.407"></a><span id="l49.407" class="difflineplus">+      PR_Free(decodedChallenge);</span>
<a href="#l49.408"></a><span id="l49.408" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l49.409"></a><span id="l49.409" class="difflineplus">+      NS_ENSURE_TRUE(digest, NS_ERROR_NULL_POINTER);</span>
<a href="#l49.410"></a><span id="l49.410" class="difflineplus">+      nsCAutoString encodedDigest;</span>
<a href="#l49.411"></a><span id="l49.411" class="difflineplus">+      char hexVal[8];</span>
<a href="#l49.412"></a><span id="l49.412" class="difflineplus">+</span>
<a href="#l49.413"></a><span id="l49.413" class="difflineplus">+      for (PRUint32 j=0; j&lt;16; j++)</span>
<a href="#l49.414"></a><span id="l49.414">       {</span>
<a href="#l49.415"></a><span id="l49.415" class="difflineminus">-        char *digest = nsnull;</span>
<a href="#l49.416"></a><span id="l49.416" class="difflineminus">-        char *cramDigest = GetServerStateParser().fAuthChallenge;</span>
<a href="#l49.417"></a><span id="l49.417" class="difflineminus">-        char * decodedChallenge = PL_Base64Decode(cramDigest,</span>
<a href="#l49.418"></a><span id="l49.418" class="difflineminus">-                                                  strlen(cramDigest), nsnull);</span>
<a href="#l49.419"></a><span id="l49.419" class="difflineminus">-        if (m_imapServerSink)</span>
<a href="#l49.420"></a><span id="l49.420" class="difflineminus">-          rv = m_imapServerSink-&gt;CramMD5Hash(decodedChallenge, password.get(), &amp;digest);</span>
<a href="#l49.421"></a><span id="l49.421" class="difflineminus">-</span>
<a href="#l49.422"></a><span id="l49.422" class="difflineminus">-        PR_Free(decodedChallenge);</span>
<a href="#l49.423"></a><span id="l49.423" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; digest)</span>
<a href="#l49.424"></a><span id="l49.424" class="difflineminus">-        {</span>
<a href="#l49.425"></a><span id="l49.425" class="difflineminus">-          nsCAutoString encodedDigest;</span>
<a href="#l49.426"></a><span id="l49.426" class="difflineminus">-          char hexVal[8];</span>
<a href="#l49.427"></a><span id="l49.427" class="difflineminus">-</span>
<a href="#l49.428"></a><span id="l49.428" class="difflineminus">-          for (PRUint32 j=0; j&lt;16; j++)</span>
<a href="#l49.429"></a><span id="l49.429" class="difflineminus">-          {</span>
<a href="#l49.430"></a><span id="l49.430" class="difflineminus">-            PR_snprintf (hexVal,8, &quot;%.2x&quot;, 0x0ff &amp; (unsigned short)(digest[j]));</span>
<a href="#l49.431"></a><span id="l49.431" class="difflineminus">-            encodedDigest.Append(hexVal);</span>
<a href="#l49.432"></a><span id="l49.432" class="difflineminus">-          }</span>
<a href="#l49.433"></a><span id="l49.433" class="difflineminus">-</span>
<a href="#l49.434"></a><span id="l49.434" class="difflineminus">-          PR_snprintf(m_dataOutputBuf, OUTPUT_BUFFER_SIZE, &quot;%s %s&quot;, userName, encodedDigest.get());</span>
<a href="#l49.435"></a><span id="l49.435" class="difflineminus">-          char *base64Str = PL_Base64Encode(m_dataOutputBuf, strlen(m_dataOutputBuf), nsnull);</span>
<a href="#l49.436"></a><span id="l49.436" class="difflineminus">-          PR_snprintf(m_dataOutputBuf, OUTPUT_BUFFER_SIZE, &quot;%s&quot; CRLF, base64Str);</span>
<a href="#l49.437"></a><span id="l49.437" class="difflineminus">-          PR_Free(base64Str);</span>
<a href="#l49.438"></a><span id="l49.438" class="difflineminus">-          PR_Free(digest);</span>
<a href="#l49.439"></a><span id="l49.439" class="difflineminus">-          rv = SendData(m_dataOutputBuf);</span>
<a href="#l49.440"></a><span id="l49.440" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l49.441"></a><span id="l49.441" class="difflineminus">-            ParseIMAPandCheckForNewMail(command.get());</span>
<a href="#l49.442"></a><span id="l49.442" class="difflineminus">-          if (GetServerStateParser().LastCommandSuccessful())</span>
<a href="#l49.443"></a><span id="l49.443" class="difflineminus">-            return NS_OK;</span>
<a href="#l49.444"></a><span id="l49.444" class="difflineminus">-          GetServerStateParser().SetCapabilityFlag(GetServerStateParser().GetCapabilityFlag() &amp; ~kHasCRAMCapability);</span>
<a href="#l49.445"></a><span id="l49.445" class="difflineminus">-</span>
<a href="#l49.446"></a><span id="l49.446" class="difflineminus">-        }</span>
<a href="#l49.447"></a><span id="l49.447" class="difflineplus">+        PR_snprintf (hexVal,8, &quot;%.2x&quot;, 0x0ff &amp; (unsigned short)(digest[j]));</span>
<a href="#l49.448"></a><span id="l49.448" class="difflineplus">+        encodedDigest.Append(hexVal);</span>
<a href="#l49.449"></a><span id="l49.449" class="difflineplus">+      }</span>
<a href="#l49.450"></a><span id="l49.450" class="difflineplus">+</span>
<a href="#l49.451"></a><span id="l49.451" class="difflineplus">+      PR_snprintf(m_dataOutputBuf, OUTPUT_BUFFER_SIZE, &quot;%s %s&quot;, userName, encodedDigest.get());</span>
<a href="#l49.452"></a><span id="l49.452" class="difflineplus">+      char *base64Str = PL_Base64Encode(m_dataOutputBuf, strlen(m_dataOutputBuf), nsnull);</span>
<a href="#l49.453"></a><span id="l49.453" class="difflineplus">+      PR_snprintf(m_dataOutputBuf, OUTPUT_BUFFER_SIZE, &quot;%s&quot; CRLF, base64Str);</span>
<a href="#l49.454"></a><span id="l49.454" class="difflineplus">+      PR_Free(base64Str);</span>
<a href="#l49.455"></a><span id="l49.455" class="difflineplus">+      PR_Free(digest);</span>
<a href="#l49.456"></a><span id="l49.456" class="difflineplus">+      rv = SendData(m_dataOutputBuf);</span>
<a href="#l49.457"></a><span id="l49.457" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l49.458"></a><span id="l49.458" class="difflineplus">+      ParseIMAPandCheckForNewMail(command.get());</span>
<a href="#l49.459"></a><span id="l49.459">     }</span>
<a href="#l49.460"></a><span id="l49.460">   } // if CRAM response was received</span>
<a href="#l49.461"></a><span id="l49.461">   else if (flag &amp; kHasAuthGssApiCapability)</span>
<a href="#l49.462"></a><span id="l49.462">   {</span>
<a href="#l49.463"></a><span id="l49.463" class="difflineplus">+    PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;MD5 auth&quot;));</span>
<a href="#l49.464"></a><span id="l49.464" class="difflineplus">+</span>
<a href="#l49.465"></a><span id="l49.465">     // Only try GSSAPI once - if it fails, its going to be because we don't</span>
<a href="#l49.466"></a><span id="l49.466">     // have valid credentials</span>
<a href="#l49.467"></a><span id="l49.467" class="difflineminus">-    GetServerStateParser().SetCapabilityFlag(GetServerStateParser().GetCapabilityFlag() &amp; ~(kHasAuthGssApiCapability));</span>
<a href="#l49.468"></a><span id="l49.468" class="difflineplus">+    //MarkAuthMethodAsFailed(kHasAuthGssApiCapability);</span>
<a href="#l49.469"></a><span id="l49.469"> </span>
<a href="#l49.470"></a><span id="l49.470">     // We do step1 first, so we don't try GSSAPI against a server which</span>
<a href="#l49.471"></a><span id="l49.471">     // we can't get credentials for.</span>
<a href="#l49.472"></a><span id="l49.472">     nsCAutoString response;</span>
<a href="#l49.473"></a><span id="l49.473" class="difflineminus">-    nsresult gssrv;</span>
<a href="#l49.474"></a><span id="l49.474" class="difflineminus">-</span>
<a href="#l49.475"></a><span id="l49.475" class="difflineplus">+</span>
<a href="#l49.476"></a><span id="l49.476" class="difflineplus">+    // realHostname != GetImapHostName() when hostname was changed</span>
<a href="#l49.477"></a><span id="l49.477" class="difflineplus">+    nsCAutoString realHostname;</span>
<a href="#l49.478"></a><span id="l49.478" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryReferent(m_server);</span>
<a href="#l49.479"></a><span id="l49.479" class="difflineplus">+    server-&gt;GetRealHostName(realHostname);</span>
<a href="#l49.480"></a><span id="l49.480">     nsCAutoString service(&quot;imap@&quot;);</span>
<a href="#l49.481"></a><span id="l49.481" class="difflineminus">-    service.Append(GetImapHostName());</span>
<a href="#l49.482"></a><span id="l49.482" class="difflineminus">-    gssrv = DoGSSAPIStep1(service.get(), userName, response);</span>
<a href="#l49.483"></a><span id="l49.483" class="difflineminus">-    NS_ENSURE_SUCCESS(gssrv, gssrv);</span>
<a href="#l49.484"></a><span id="l49.484" class="difflineplus">+    service.Append(realHostname);</span>
<a href="#l49.485"></a><span id="l49.485" class="difflineplus">+    rv = DoGSSAPIStep1(service.get(), userName, response);</span>
<a href="#l49.486"></a><span id="l49.486" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l49.487"></a><span id="l49.487"> </span>
<a href="#l49.488"></a><span id="l49.488">     nsCAutoString command (GetServerCommandTag());</span>
<a href="#l49.489"></a><span id="l49.489">     command.Append(&quot; authenticate GSSAPI&quot; CRLF);</span>
<a href="#l49.490"></a><span id="l49.490">     rv = SendData(command.get());</span>
<a href="#l49.491"></a><span id="l49.491">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l49.492"></a><span id="l49.492"> </span>
<a href="#l49.493"></a><span id="l49.493">     ParseIMAPandCheckForNewMail(&quot;AUTH GSSAPI&quot;);</span>
<a href="#l49.494"></a><span id="l49.494">     if (GetServerStateParser().LastCommandSuccessful())</span>
<a href="#l49.495"></a><span id="l49.495">     {</span>
<a href="#l49.496"></a><span id="l49.496">       response += CRLF;</span>
<a href="#l49.497"></a><span id="l49.497">       rv = SendData(response.get());</span>
<a href="#l49.498"></a><span id="l49.498">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l49.499"></a><span id="l49.499">       ParseIMAPandCheckForNewMail(command.get());</span>
<a href="#l49.500"></a><span id="l49.500" class="difflineplus">+      nsresult gssrv = NS_OK;</span>
<a href="#l49.501"></a><span id="l49.501"> </span>
<a href="#l49.502"></a><span id="l49.502">       while (GetServerStateParser().LastCommandSuccessful() &amp;&amp;</span>
<a href="#l49.503"></a><span id="l49.503">              NS_SUCCEEDED(gssrv) &amp;&amp; gssrv != NS_SUCCESS_AUTH_FINISHED)</span>
<a href="#l49.504"></a><span id="l49.504">       {</span>
<a href="#l49.505"></a><span id="l49.505">         nsCString challengeStr(GetServerStateParser().fAuthChallenge);</span>
<a href="#l49.506"></a><span id="l49.506">         gssrv = DoGSSAPIStep2(challengeStr, response);</span>
<a href="#l49.507"></a><span id="l49.507">         if (NS_SUCCEEDED(gssrv))</span>
<a href="#l49.508"></a><span id="l49.508">         {</span>
<a href="#l49.509"></a><span id="l49.509" class="difflineat">@@ -5527,132 +5617,142 @@ nsresult nsImapProtocol::AuthLogin(const</span>
<a href="#l49.510"></a><span id="l49.510">           rv = SendData(response.get());</span>
<a href="#l49.511"></a><span id="l49.511">         }</span>
<a href="#l49.512"></a><span id="l49.512">         else</span>
<a href="#l49.513"></a><span id="l49.513">           rv = SendData(&quot;*&quot; CRLF);</span>
<a href="#l49.514"></a><span id="l49.514"> </span>
<a href="#l49.515"></a><span id="l49.515">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l49.516"></a><span id="l49.516">         ParseIMAPandCheckForNewMail(command.get());</span>
<a href="#l49.517"></a><span id="l49.517">       }</span>
<a href="#l49.518"></a><span id="l49.518" class="difflineminus">-      rv = gssrv;</span>
<a href="#l49.519"></a><span id="l49.519" class="difflineminus">-    }</span>
<a href="#l49.520"></a><span id="l49.520" class="difflineminus">-    return rv;</span>
<a href="#l49.521"></a><span id="l49.521" class="difflineminus">-  }</span>
<a href="#l49.522"></a><span id="l49.522" class="difflineminus">-  else if (flag &amp; (kHasAuthNTLMCapability|kHasAuthMSNCapability))</span>
<a href="#l49.523"></a><span id="l49.523" class="difflineminus">-  {</span>
<a href="#l49.524"></a><span id="l49.524" class="difflineplus">+      // TODO: whether it worked or not is shown by LastCommandSuccessful(), not gssrv, right?</span>
<a href="#l49.525"></a><span id="l49.525" class="difflineplus">+    }</span>
<a href="#l49.526"></a><span id="l49.526" class="difflineplus">+  }</span>
<a href="#l49.527"></a><span id="l49.527" class="difflineplus">+  else if (flag &amp; (kHasAuthNTLMCapability | kHasAuthMSNCapability))</span>
<a href="#l49.528"></a><span id="l49.528" class="difflineplus">+  {</span>
<a href="#l49.529"></a><span id="l49.529" class="difflineplus">+    PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;NTLM auth&quot;));</span>
<a href="#l49.530"></a><span id="l49.530">     nsCAutoString command (GetServerCommandTag());</span>
<a href="#l49.531"></a><span id="l49.531">     command.Append((flag &amp; kHasAuthNTLMCapability) ? &quot; authenticate NTLM&quot; CRLF</span>
<a href="#l49.532"></a><span id="l49.532">                                                    : &quot; authenticate MSN&quot; CRLF);</span>
<a href="#l49.533"></a><span id="l49.533">     rv = SendData(command.get());</span>
<a href="#l49.534"></a><span id="l49.534">     ParseIMAPandCheckForNewMail(&quot;AUTH NTLM&quot;); // this just waits for ntlm step 1</span>
<a href="#l49.535"></a><span id="l49.535">     if (GetServerStateParser().LastCommandSuccessful())</span>
<a href="#l49.536"></a><span id="l49.536">     {</span>
<a href="#l49.537"></a><span id="l49.537">       nsCAutoString cmd;</span>
<a href="#l49.538"></a><span id="l49.538">       rv = DoNtlmStep1(userName, password.get(), cmd);</span>
<a href="#l49.539"></a><span id="l49.539" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l49.540"></a><span id="l49.540" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l49.541"></a><span id="l49.541" class="difflineplus">+      cmd += CRLF;</span>
<a href="#l49.542"></a><span id="l49.542" class="difflineplus">+      rv = SendData(cmd.get());</span>
<a href="#l49.543"></a><span id="l49.543" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l49.544"></a><span id="l49.544" class="difflineplus">+      ParseIMAPandCheckForNewMail(command.get());</span>
<a href="#l49.545"></a><span id="l49.545" class="difflineplus">+      if (GetServerStateParser().LastCommandSuccessful())</span>
<a href="#l49.546"></a><span id="l49.546">       {</span>
<a href="#l49.547"></a><span id="l49.547" class="difflineminus">-        cmd += CRLF;</span>
<a href="#l49.548"></a><span id="l49.548" class="difflineminus">-        rv = SendData(cmd.get());</span>
<a href="#l49.549"></a><span id="l49.549" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l49.550"></a><span id="l49.550" class="difflineminus">-        {</span>
<a href="#l49.551"></a><span id="l49.551" class="difflineminus">-          ParseIMAPandCheckForNewMail(command.get());</span>
<a href="#l49.552"></a><span id="l49.552" class="difflineminus">-          if (GetServerStateParser().LastCommandSuccessful())</span>
<a href="#l49.553"></a><span id="l49.553" class="difflineminus">-          {</span>
<a href="#l49.554"></a><span id="l49.554" class="difflineminus">-            nsCString challengeStr(GetServerStateParser().fAuthChallenge);</span>
<a href="#l49.555"></a><span id="l49.555" class="difflineminus">-            nsCString response;</span>
<a href="#l49.556"></a><span id="l49.556" class="difflineminus">-            rv = DoNtlmStep2(challengeStr, response);</span>
<a href="#l49.557"></a><span id="l49.557" class="difflineminus">-            if (NS_SUCCEEDED(rv))</span>
<a href="#l49.558"></a><span id="l49.558" class="difflineminus">-            {</span>
<a href="#l49.559"></a><span id="l49.559" class="difflineminus">-              response += CRLF;</span>
<a href="#l49.560"></a><span id="l49.560" class="difflineminus">-              rv = SendData(response.get());</span>
<a href="#l49.561"></a><span id="l49.561" class="difflineminus">-              ParseIMAPandCheckForNewMail(command.get());</span>
<a href="#l49.562"></a><span id="l49.562" class="difflineminus">-              if (!GetServerStateParser().LastCommandSuccessful())</span>
<a href="#l49.563"></a><span id="l49.563" class="difflineminus">-                GetServerStateParser().SetCapabilityFlag(GetServerStateParser().GetCapabilityFlag() &amp; ~(kHasAuthNTLMCapability|kHasAuthMSNCapability));</span>
<a href="#l49.564"></a><span id="l49.564" class="difflineminus">-            }</span>
<a href="#l49.565"></a><span id="l49.565" class="difflineminus">-          }</span>
<a href="#l49.566"></a><span id="l49.566" class="difflineminus">-        }</span>
<a href="#l49.567"></a><span id="l49.567" class="difflineplus">+        nsCString challengeStr(GetServerStateParser().fAuthChallenge);</span>
<a href="#l49.568"></a><span id="l49.568" class="difflineplus">+        nsCString response;</span>
<a href="#l49.569"></a><span id="l49.569" class="difflineplus">+        rv = DoNtlmStep2(challengeStr, response);</span>
<a href="#l49.570"></a><span id="l49.570" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l49.571"></a><span id="l49.571" class="difflineplus">+        response += CRLF;</span>
<a href="#l49.572"></a><span id="l49.572" class="difflineplus">+        rv = SendData(response.get());</span>
<a href="#l49.573"></a><span id="l49.573" class="difflineplus">+        ParseIMAPandCheckForNewMail(command.get());</span>
<a href="#l49.574"></a><span id="l49.574">       }</span>
<a href="#l49.575"></a><span id="l49.575">     }</span>
<a href="#l49.576"></a><span id="l49.576">   }</span>
<a href="#l49.577"></a><span id="l49.577">   else if (flag &amp; kHasAuthPlainCapability)</span>
<a href="#l49.578"></a><span id="l49.578">   {</span>
<a href="#l49.579"></a><span id="l49.579" class="difflineplus">+    PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;PLAIN auth&quot;));</span>
<a href="#l49.580"></a><span id="l49.580">     PR_snprintf(m_dataOutputBuf, OUTPUT_BUFFER_SIZE, &quot;%s authenticate plain&quot; CRLF, GetServerCommandTag());</span>
<a href="#l49.581"></a><span id="l49.581">     rv = SendData(m_dataOutputBuf);</span>
<a href="#l49.582"></a><span id="l49.582">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l49.583"></a><span id="l49.583">     currentCommand = PL_strdup(m_dataOutputBuf); /* StrAllocCopy(currentCommand, GetOutputBuffer()); */</span>
<a href="#l49.584"></a><span id="l49.584">     ParseIMAPandCheckForNewMail();</span>
<a href="#l49.585"></a><span id="l49.585">     if (GetServerStateParser().LastCommandSuccessful())</span>
<a href="#l49.586"></a><span id="l49.586">     {</span>
<a href="#l49.587"></a><span id="l49.587" class="difflineminus">-      char plainstr[512]; // placeholder for &quot;&lt;NUL&gt;userName&lt;NUL&gt;password&quot;</span>
<a href="#l49.588"></a><span id="l49.588" class="difflineplus">+      // RFC 4616</span>
<a href="#l49.589"></a><span id="l49.589" class="difflineplus">+      char plainstr[512]; // placeholder for &quot;&lt;NUL&gt;userName&lt;NUL&gt;password&quot; TODO nsCAutoString</span>
<a href="#l49.590"></a><span id="l49.590">       int len = 1; // count for first &lt;NUL&gt; char</span>
<a href="#l49.591"></a><span id="l49.591">       memset(plainstr, 0, 512);</span>
<a href="#l49.592"></a><span id="l49.592">       PR_snprintf(&amp;plainstr[1], 510, &quot;%s&quot;, userName);</span>
<a href="#l49.593"></a><span id="l49.593">       len += PL_strlen(userName);</span>
<a href="#l49.594"></a><span id="l49.594">       len++;  // count for second &lt;NUL&gt; char</span>
<a href="#l49.595"></a><span id="l49.595">       PR_snprintf(&amp;plainstr[len], 511-len, &quot;%s&quot;, password.get());</span>
<a href="#l49.596"></a><span id="l49.596">       len += password.Length();</span>
<a href="#l49.597"></a><span id="l49.597">       char *base64Str = PL_Base64Encode(plainstr, len, nsnull);</span>
<a href="#l49.598"></a><span id="l49.598" class="difflineminus">-      if (base64Str)</span>
<a href="#l49.599"></a><span id="l49.599" class="difflineminus">-      {</span>
<a href="#l49.600"></a><span id="l49.600" class="difflineminus">-        PR_snprintf(m_dataOutputBuf, OUTPUT_BUFFER_SIZE, &quot;%s&quot; CRLF, base64Str);</span>
<a href="#l49.601"></a><span id="l49.601" class="difflineminus">-        PR_Free(base64Str);</span>
<a href="#l49.602"></a><span id="l49.602" class="difflineminus">-        rv = SendData(m_dataOutputBuf, PR_TRUE /* suppress logging */);</span>
<a href="#l49.603"></a><span id="l49.603" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l49.604"></a><span id="l49.604" class="difflineminus">-            ParseIMAPandCheckForNewMail(currentCommand);</span>
<a href="#l49.605"></a><span id="l49.605" class="difflineminus">-        if (GetServerStateParser().LastCommandSuccessful())</span>
<a href="#l49.606"></a><span id="l49.606" class="difflineminus">-        {</span>
<a href="#l49.607"></a><span id="l49.607" class="difflineminus">-          PR_Free(currentCommand);</span>
<a href="#l49.608"></a><span id="l49.608" class="difflineminus">-          return NS_OK;</span>
<a href="#l49.609"></a><span id="l49.609" class="difflineminus">-        } // if the last command succeeded</span>
<a href="#l49.610"></a><span id="l49.610" class="difflineminus">-      } // if we got a base 64 encoded string</span>
<a href="#l49.611"></a><span id="l49.611" class="difflineplus">+      PR_snprintf(m_dataOutputBuf, OUTPUT_BUFFER_SIZE, &quot;%s&quot; CRLF, base64Str);</span>
<a href="#l49.612"></a><span id="l49.612" class="difflineplus">+      PR_Free(base64Str);</span>
<a href="#l49.613"></a><span id="l49.613" class="difflineplus">+      rv = SendData(m_dataOutputBuf, PR_TRUE /* suppress logging */);</span>
<a href="#l49.614"></a><span id="l49.614" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l49.615"></a><span id="l49.615" class="difflineplus">+        ParseIMAPandCheckForNewMail(currentCommand);</span>
<a href="#l49.616"></a><span id="l49.616">     } // if the last command succeeded</span>
<a href="#l49.617"></a><span id="l49.617">   } // if auth plain capability</span>
<a href="#l49.618"></a><span id="l49.618" class="difflineminus">-</span>
<a href="#l49.619"></a><span id="l49.619">   else if (flag &amp; kHasAuthLoginCapability)</span>
<a href="#l49.620"></a><span id="l49.620">   {</span>
<a href="#l49.621"></a><span id="l49.621" class="difflineplus">+    PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;LOGIN auth&quot;));</span>
<a href="#l49.622"></a><span id="l49.622">     PR_snprintf(m_dataOutputBuf, OUTPUT_BUFFER_SIZE, &quot;%s authenticate login&quot; CRLF, GetServerCommandTag());</span>
<a href="#l49.623"></a><span id="l49.623">     rv = SendData(m_dataOutputBuf);</span>
<a href="#l49.624"></a><span id="l49.624">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l49.625"></a><span id="l49.625">     currentCommand = PL_strdup(m_dataOutputBuf);</span>
<a href="#l49.626"></a><span id="l49.626">     ParseIMAPandCheckForNewMail();</span>
<a href="#l49.627"></a><span id="l49.627"> </span>
<a href="#l49.628"></a><span id="l49.628">     if (GetServerStateParser().LastCommandSuccessful())</span>
<a href="#l49.629"></a><span id="l49.629">     {</span>
<a href="#l49.630"></a><span id="l49.630">       char *base64Str = PL_Base64Encode(userName, PL_strlen(userName), nsnull);</span>
<a href="#l49.631"></a><span id="l49.631" class="difflineminus">-      if(base64Str)</span>
<a href="#l49.632"></a><span id="l49.632" class="difflineplus">+      PR_snprintf(m_dataOutputBuf, OUTPUT_BUFFER_SIZE, &quot;%s&quot; CRLF, base64Str);</span>
<a href="#l49.633"></a><span id="l49.633" class="difflineplus">+      PR_Free(base64Str);</span>
<a href="#l49.634"></a><span id="l49.634" class="difflineplus">+      rv = SendData(m_dataOutputBuf, PR_TRUE /* suppress logging */);</span>
<a href="#l49.635"></a><span id="l49.635" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l49.636"></a><span id="l49.636">       {</span>
<a href="#l49.637"></a><span id="l49.637" class="difflineminus">-        PR_snprintf(m_dataOutputBuf, OUTPUT_BUFFER_SIZE, &quot;%s&quot; CRLF, base64Str);</span>
<a href="#l49.638"></a><span id="l49.638" class="difflineminus">-        PR_Free(base64Str);</span>
<a href="#l49.639"></a><span id="l49.639" class="difflineminus">-        rv = SendData(m_dataOutputBuf, PR_TRUE /* suppress logging */);</span>
<a href="#l49.640"></a><span id="l49.640" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l49.641"></a><span id="l49.641" class="difflineminus">-            ParseIMAPandCheckForNewMail(currentCommand);</span>
<a href="#l49.642"></a><span id="l49.642" class="difflineminus">-      }</span>
<a href="#l49.643"></a><span id="l49.643" class="difflineminus">-      if (GetServerStateParser().LastCommandSuccessful())</span>
<a href="#l49.644"></a><span id="l49.644" class="difflineminus">-      {</span>
<a href="#l49.645"></a><span id="l49.645" class="difflineminus">-        base64Str = PL_Base64Encode(password.get(), password.Length(), nsnull);</span>
<a href="#l49.646"></a><span id="l49.646" class="difflineminus">-        PR_snprintf(m_dataOutputBuf, OUTPUT_BUFFER_SIZE, &quot;%s&quot; CRLF, base64Str);</span>
<a href="#l49.647"></a><span id="l49.647" class="difflineminus">-        PR_Free(base64Str);</span>
<a href="#l49.648"></a><span id="l49.648" class="difflineminus">-        rv = SendData(m_dataOutputBuf, PR_TRUE /* suppress logging */);</span>
<a href="#l49.649"></a><span id="l49.649" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l49.650"></a><span id="l49.650" class="difflineminus">-           ParseIMAPandCheckForNewMail(currentCommand);</span>
<a href="#l49.651"></a><span id="l49.651" class="difflineplus">+        ParseIMAPandCheckForNewMail(currentCommand);</span>
<a href="#l49.652"></a><span id="l49.652">         if (GetServerStateParser().LastCommandSuccessful())</span>
<a href="#l49.653"></a><span id="l49.653">         {</span>
<a href="#l49.654"></a><span id="l49.654" class="difflineminus">-          PR_Free(currentCommand);</span>
<a href="#l49.655"></a><span id="l49.655" class="difflineminus">-          return NS_OK;</span>
<a href="#l49.656"></a><span id="l49.656" class="difflineminus">-        }</span>
<a href="#l49.657"></a><span id="l49.657" class="difflineplus">+          base64Str = PL_Base64Encode(password.get(), password.Length(), nsnull);</span>
<a href="#l49.658"></a><span id="l49.658" class="difflineplus">+          PR_snprintf(m_dataOutputBuf, OUTPUT_BUFFER_SIZE, &quot;%s&quot; CRLF, base64Str);</span>
<a href="#l49.659"></a><span id="l49.659" class="difflineplus">+          PR_Free(base64Str);</span>
<a href="#l49.660"></a><span id="l49.660" class="difflineplus">+          rv = SendData(m_dataOutputBuf, PR_TRUE /* suppress logging */);</span>
<a href="#l49.661"></a><span id="l49.661" class="difflineplus">+          if (NS_SUCCEEDED(rv))</span>
<a href="#l49.662"></a><span id="l49.662" class="difflineplus">+            ParseIMAPandCheckForNewMail(currentCommand);</span>
<a href="#l49.663"></a><span id="l49.663" class="difflineplus">+        } // if last command successful</span>
<a href="#l49.664"></a><span id="l49.664">       } // if last command successful</span>
<a href="#l49.665"></a><span id="l49.665">     } // if last command successful</span>
<a href="#l49.666"></a><span id="l49.666">   } // if has auth login capability</span>
<a href="#l49.667"></a><span id="l49.667" class="difflineminus">-</span>
<a href="#l49.668"></a><span id="l49.668" class="difflineminus">-  // Fall back to InsecureLogin() if the user did not request secure authentication</span>
<a href="#l49.669"></a><span id="l49.669" class="difflineminus">-  if (!m_useSecAuth &amp;&amp; ! (GetServerStateParser().GetCapabilityFlag() &amp; kLoginDisabled))</span>
<a href="#l49.670"></a><span id="l49.670" class="difflineminus">-    InsecureLogin(userName, password);</span>
<a href="#l49.671"></a><span id="l49.671" class="difflineplus">+  else if (flag &amp; kHasAuthOldLoginCapability)</span>
<a href="#l49.672"></a><span id="l49.672" class="difflineplus">+  {</span>
<a href="#l49.673"></a><span id="l49.673" class="difflineplus">+    PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;old-style auth&quot;));</span>
<a href="#l49.674"></a><span id="l49.674" class="difflineplus">+    ProgressEventFunctionUsingId (IMAP_STATUS_SENDING_LOGIN);</span>
<a href="#l49.675"></a><span id="l49.675" class="difflineplus">+    IncrementCommandTagNumber();</span>
<a href="#l49.676"></a><span id="l49.676" class="difflineplus">+    nsCString command (GetServerCommandTag());</span>
<a href="#l49.677"></a><span id="l49.677" class="difflineplus">+    nsCAutoString escapedUserName;</span>
<a href="#l49.678"></a><span id="l49.678" class="difflineplus">+    command.Append(&quot; login \&quot;&quot;);</span>
<a href="#l49.679"></a><span id="l49.679" class="difflineplus">+    EscapeUserNamePasswordString(userName, &amp;escapedUserName);</span>
<a href="#l49.680"></a><span id="l49.680" class="difflineplus">+    command.Append(escapedUserName);</span>
<a href="#l49.681"></a><span id="l49.681" class="difflineplus">+    command.Append(&quot;\&quot; \&quot;&quot;);</span>
<a href="#l49.682"></a><span id="l49.682" class="difflineplus">+</span>
<a href="#l49.683"></a><span id="l49.683" class="difflineplus">+    // if the password contains a \, login will fail</span>
<a href="#l49.684"></a><span id="l49.684" class="difflineplus">+    // turn foo\bar into foo\\bar</span>
<a href="#l49.685"></a><span id="l49.685" class="difflineplus">+    nsCAutoString correctedPassword;</span>
<a href="#l49.686"></a><span id="l49.686" class="difflineplus">+    EscapeUserNamePasswordString(password.get(), &amp;correctedPassword);</span>
<a href="#l49.687"></a><span id="l49.687" class="difflineplus">+    command.Append(correctedPassword);</span>
<a href="#l49.688"></a><span id="l49.688" class="difflineplus">+    command.Append(&quot;\&quot;&quot;CRLF);</span>
<a href="#l49.689"></a><span id="l49.689" class="difflineplus">+    rv = SendData(command.get(), PR_TRUE /* suppress logging */);</span>
<a href="#l49.690"></a><span id="l49.690" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l49.691"></a><span id="l49.691" class="difflineplus">+    ParseIMAPandCheckForNewMail();</span>
<a href="#l49.692"></a><span id="l49.692" class="difflineplus">+  }</span>
<a href="#l49.693"></a><span id="l49.693" class="difflineplus">+  else if (flag &amp; kHasAuthNoneCapability)</span>
<a href="#l49.694"></a><span id="l49.694" class="difflineplus">+  {</span>
<a href="#l49.695"></a><span id="l49.695" class="difflineplus">+    // TODO What to do? &quot;login &lt;username&gt;&quot; like POP?</span>
<a href="#l49.696"></a><span id="l49.696" class="difflineplus">+    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l49.697"></a><span id="l49.697" class="difflineplus">+  }</span>
<a href="#l49.698"></a><span id="l49.698" class="difflineplus">+  else</span>
<a href="#l49.699"></a><span id="l49.699" class="difflineplus">+  {</span>
<a href="#l49.700"></a><span id="l49.700" class="difflineplus">+    PR_LOG(IMAP, PR_LOG_ERROR, (&quot;flags param has no auth scheme selected&quot;));</span>
<a href="#l49.701"></a><span id="l49.701" class="difflineplus">+    return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l49.702"></a><span id="l49.702" class="difflineplus">+  }</span>
<a href="#l49.703"></a><span id="l49.703"> </span>
<a href="#l49.704"></a><span id="l49.704">   PR_Free(currentCommand);</span>
<a href="#l49.705"></a><span id="l49.705" class="difflineminus">-  return NS_OK;</span>
<a href="#l49.706"></a><span id="l49.706" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l49.707"></a><span id="l49.707" class="difflineplus">+  return GetServerStateParser().LastCommandSuccessful() ?</span>
<a href="#l49.708"></a><span id="l49.708" class="difflineplus">+        NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l49.709"></a><span id="l49.709"> }</span>
<a href="#l49.710"></a><span id="l49.710"> </span>
<a href="#l49.711"></a><span id="l49.711"> void nsImapProtocol::OnLSubFolders()</span>
<a href="#l49.712"></a><span id="l49.712"> {</span>
<a href="#l49.713"></a><span id="l49.713">   // **** use to find out whether Drafts, Sent, &amp; Templates folder</span>
<a href="#l49.714"></a><span id="l49.714">   // exists or not even the user didn't subscribe to it</span>
<a href="#l49.715"></a><span id="l49.715">   char *mailboxName = OnCreateServerSourceFolderPathString();</span>
<a href="#l49.716"></a><span id="l49.716">   if (mailboxName)</span>
<a href="#l49.717"></a><span id="l49.717" class="difflineat">@@ -7943,243 +8043,266 @@ nsresult nsImapProtocol::GetMsgWindow(ns</span>
<a href="#l49.718"></a><span id="l49.718"> {</span>
<a href="#l49.719"></a><span id="l49.719">     nsresult rv = NS_OK;</span>
<a href="#l49.720"></a><span id="l49.720">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl =</span>
<a href="#l49.721"></a><span id="l49.721">         do_QueryInterface(m_runningUrl, &amp;rv);</span>
<a href="#l49.722"></a><span id="l49.722">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l49.723"></a><span id="l49.723">     return mailnewsUrl-&gt;GetMsgWindow(aMsgWindow);</span>
<a href="#l49.724"></a><span id="l49.724"> }</span>
<a href="#l49.725"></a><span id="l49.725"> </span>
<a href="#l49.726"></a><span id="l49.726" class="difflineplus">+/**</span>
<a href="#l49.727"></a><span id="l49.727" class="difflineplus">+ * Get password from RAM, disk (password manager) or user (dialog)</span>
<a href="#l49.728"></a><span id="l49.728" class="difflineplus">+ * @return NS_MSG_PASSWORD_PROMPT_CANCELLED</span>
<a href="#l49.729"></a><span id="l49.729" class="difflineplus">+ *    (which is NS_SUCCEEDED!) when user cancelled</span>
<a href="#l49.730"></a><span id="l49.730" class="difflineplus">+ *    NS_FAILED(rv) for other errors</span>
<a href="#l49.731"></a><span id="l49.731" class="difflineplus">+ */</span>
<a href="#l49.732"></a><span id="l49.732"> nsresult nsImapProtocol::GetPassword(nsCString &amp;password)</span>
<a href="#l49.733"></a><span id="l49.733"> {</span>
<a href="#l49.734"></a><span id="l49.734" class="difflineminus">-  if (password.IsEmpty() &amp;&amp; m_imapServerSink &amp;&amp;</span>
<a href="#l49.735"></a><span id="l49.735" class="difflineminus">-      !(m_useSecAuth &amp;&amp; GetServerStateParser().GetCapabilityFlag() &amp; kHasAuthGssApiCapability))</span>
<a href="#l49.736"></a><span id="l49.736" class="difflineplus">+  // we are in the imap thread so *NEVER* try to extract the password with UI</span>
<a href="#l49.737"></a><span id="l49.737" class="difflineplus">+  // if logon redirection has changed the password, use the cookie as the password</span>
<a href="#l49.738"></a><span id="l49.738" class="difflineplus">+  if (m_overRideUrlConnectionInfo)</span>
<a href="#l49.739"></a><span id="l49.739" class="difflineplus">+  {</span>
<a href="#l49.740"></a><span id="l49.740" class="difflineplus">+    password.Assign(m_logonCookie);</span>
<a href="#l49.741"></a><span id="l49.741" class="difflineplus">+    return NS_OK;</span>
<a href="#l49.742"></a><span id="l49.742" class="difflineplus">+  }</span>
<a href="#l49.743"></a><span id="l49.743" class="difflineplus">+</span>
<a href="#l49.744"></a><span id="l49.744" class="difflineplus">+  NS_ENSURE_TRUE(m_imapServerSink, NS_ERROR_NULL_POINTER);</span>
<a href="#l49.745"></a><span id="l49.745" class="difflineplus">+  NS_ENSURE_TRUE(m_server, NS_ERROR_NULL_POINTER);</span>
<a href="#l49.746"></a><span id="l49.746" class="difflineplus">+  nsresult rv;</span>
<a href="#l49.747"></a><span id="l49.747" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryReferent(m_server, &amp;rv);</span>
<a href="#l49.748"></a><span id="l49.748" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l49.749"></a><span id="l49.749" class="difflineplus">+</span>
<a href="#l49.750"></a><span id="l49.750" class="difflineplus">+  // Get the password already stored in mem</span>
<a href="#l49.751"></a><span id="l49.751" class="difflineplus">+  rv = server-&gt;GetPassword(password);</span>
<a href="#l49.752"></a><span id="l49.752" class="difflineplus">+  if (NS_FAILED(rv) || password.IsEmpty())</span>
<a href="#l49.753"></a><span id="l49.753">   {</span>
<a href="#l49.754"></a><span id="l49.754">     nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l49.755"></a><span id="l49.755" class="difflineminus">-</span>
<a href="#l49.756"></a><span id="l49.756">     GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l49.757"></a><span id="l49.757" class="difflineminus">-    // need to copy password, because in the case of Cancel,</span>
<a href="#l49.758"></a><span id="l49.758" class="difflineminus">-    // GetPasswordWithUI will truncate the password.</span>
<a href="#l49.759"></a><span id="l49.759" class="difflineminus">-    nsCString pwd = m_lastPasswordSent;</span>
<a href="#l49.760"></a><span id="l49.760" class="difflineminus">-    nsresult rv = m_imapServerSink-&gt;PromptForPassword(pwd, msgWindow);</span>
<a href="#l49.761"></a><span id="l49.761" class="difflineminus">-</span>
<a href="#l49.762"></a><span id="l49.762" class="difflineminus">-    if (NS_FAILED(rv) || rv == NS_MSG_PASSWORD_PROMPT_CANCELLED)</span>
<a href="#l49.763"></a><span id="l49.763" class="difflineplus">+    NS_ENSURE_TRUE(msgWindow, NS_ERROR_NOT_AVAILABLE); // biff case</span>
<a href="#l49.764"></a><span id="l49.764" class="difflineplus">+</span>
<a href="#l49.765"></a><span id="l49.765" class="difflineplus">+    // Get the password from pw manager (harddisk) or user (dialog)</span>
<a href="#l49.766"></a><span id="l49.766" class="difflineplus">+    nsCAutoString pwd; // GetPasswordWithUI truncates the password on Cancel</span>
<a href="#l49.767"></a><span id="l49.767" class="difflineplus">+    rv = m_imapServerSink-&gt;PromptForPassword(pwd, msgWindow);</span>
<a href="#l49.768"></a><span id="l49.768" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l49.769"></a><span id="l49.769" class="difflineplus">+    if (rv == NS_MSG_PASSWORD_PROMPT_CANCELLED) // (this is a success code)</span>
<a href="#l49.770"></a><span id="l49.770">       return NS_ERROR_ABORT;</span>
<a href="#l49.771"></a><span id="l49.771" class="difflineminus">-</span>
<a href="#l49.772"></a><span id="l49.772" class="difflineplus">+    NS_ENSURE_TRUE(!pwd.IsEmpty(), NS_ERROR_ABORT);</span>
<a href="#l49.773"></a><span id="l49.773">     password.Assign(pwd);</span>
<a href="#l49.774"></a><span id="l49.774">   }</span>
<a href="#l49.775"></a><span id="l49.775" class="difflineplus">+</span>
<a href="#l49.776"></a><span id="l49.776">   m_lastPasswordSent = password;</span>
<a href="#l49.777"></a><span id="l49.777">   return NS_OK;</span>
<a href="#l49.778"></a><span id="l49.778"> }</span>
<a href="#l49.779"></a><span id="l49.779"> </span>
<a href="#l49.780"></a><span id="l49.780"> PRBool nsImapProtocol::TryToLogon()</span>
<a href="#l49.781"></a><span id="l49.781"> {</span>
<a href="#l49.782"></a><span id="l49.782" class="difflineminus">-  PRInt32 logonTries = 0;</span>
<a href="#l49.783"></a><span id="l49.783" class="difflineminus">-  const PRInt32 maxLogonTries = 4;</span>
<a href="#l49.784"></a><span id="l49.784" class="difflineplus">+  PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;try to log in&quot;));</span>
<a href="#l49.785"></a><span id="l49.785" class="difflineplus">+  NS_ENSURE_TRUE(m_imapServerSink, false);</span>
<a href="#l49.786"></a><span id="l49.786">   PRBool loginSucceeded = PR_FALSE;</span>
<a href="#l49.787"></a><span id="l49.787" class="difflineminus">-  PRBool clientSucceeded = PR_TRUE;</span>
<a href="#l49.788"></a><span id="l49.788" class="difflineplus">+  PRBool skipLoop = PR_FALSE;</span>
<a href="#l49.789"></a><span id="l49.789">   nsCAutoString password;</span>
<a href="#l49.790"></a><span id="l49.790">   nsCAutoString userName;</span>
<a href="#l49.791"></a><span id="l49.791" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l49.792"></a><span id="l49.792" class="difflineminus">-</span>
<a href="#l49.793"></a><span id="l49.793" class="difflineminus">-  // get the password and user name for the current incoming server...</span>
<a href="#l49.794"></a><span id="l49.794" class="difflineminus">-  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryReferent(m_server);</span>
<a href="#l49.795"></a><span id="l49.795" class="difflineminus">-  if (!m_imapServerSink)</span>
<a href="#l49.796"></a><span id="l49.796" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l49.797"></a><span id="l49.797" class="difflineminus">-</span>
<a href="#l49.798"></a><span id="l49.798" class="difflineminus">-  if (server)</span>
<a href="#l49.799"></a><span id="l49.799" class="difflineminus">-  {</span>
<a href="#l49.800"></a><span id="l49.800" class="difflineminus">-    // we are in the imap thread so *NEVER* try to extract the password with UI</span>
<a href="#l49.801"></a><span id="l49.801" class="difflineminus">-    // if logon redirection has changed the password, use the cookie as the password</span>
<a href="#l49.802"></a><span id="l49.802" class="difflineminus">-    if (m_overRideUrlConnectionInfo)</span>
<a href="#l49.803"></a><span id="l49.803" class="difflineminus">-      password.Assign(m_logonCookie);</span>
<a href="#l49.804"></a><span id="l49.804" class="difflineplus">+</span>
<a href="#l49.805"></a><span id="l49.805" class="difflineplus">+  nsresult rv = ChooseAuthMethod();</span>
<a href="#l49.806"></a><span id="l49.806" class="difflineplus">+  if (NS_FAILED(rv)) // all methods failed</span>
<a href="#l49.807"></a><span id="l49.807" class="difflineplus">+  {</span>
<a href="#l49.808"></a><span id="l49.808" class="difflineplus">+    // are there any matching login schemes at all?</span>
<a href="#l49.809"></a><span id="l49.809" class="difflineplus">+    if (!(GetServerStateParser().GetCapabilityFlag() &amp; m_prefAuthMethods))</span>
<a href="#l49.810"></a><span id="l49.810" class="difflineplus">+    {</span>
<a href="#l49.811"></a><span id="l49.811" class="difflineplus">+      // Pref doesn't match server. Now, find an appropriate error msg.</span>
<a href="#l49.812"></a><span id="l49.812" class="difflineplus">+</span>
<a href="#l49.813"></a><span id="l49.813" class="difflineplus">+      // pref has plaintext pw &amp; server claims to support encrypted pw</span>
<a href="#l49.814"></a><span id="l49.814" class="difflineplus">+      if (m_prefAuthMethods == (kHasAuthOldLoginCapability |</span>
<a href="#l49.815"></a><span id="l49.815" class="difflineplus">+              kHasAuthLoginCapability | kHasAuthPlainCapability) &amp;&amp;</span>
<a href="#l49.816"></a><span id="l49.816" class="difflineplus">+          GetServerStateParser().GetCapabilityFlag() &amp; kHasCRAMCapability)</span>
<a href="#l49.817"></a><span id="l49.817" class="difflineplus">+        // tell user to change to encrypted pw</span>
<a href="#l49.818"></a><span id="l49.818" class="difflineplus">+        AlertUserEventUsingId(IMAP_AUTH_CHANGE_PLAIN_TO_ENCRYPT);</span>
<a href="#l49.819"></a><span id="l49.819" class="difflineplus">+      // pref has encrypted pw &amp; server claims to support plaintext pw</span>
<a href="#l49.820"></a><span id="l49.820" class="difflineplus">+      else if (m_prefAuthMethods == kHasCRAMCapability &amp;&amp;</span>
<a href="#l49.821"></a><span id="l49.821" class="difflineplus">+               GetServerStateParser().GetCapabilityFlag() &amp;</span>
<a href="#l49.822"></a><span id="l49.822" class="difflineplus">+                   (kHasAuthOldLoginCapability | kHasAuthLoginCapability |</span>
<a href="#l49.823"></a><span id="l49.823" class="difflineplus">+                    kHasAuthPlainCapability))</span>
<a href="#l49.824"></a><span id="l49.824" class="difflineplus">+      {</span>
<a href="#l49.825"></a><span id="l49.825" class="difflineplus">+        // have SSL</span>
<a href="#l49.826"></a><span id="l49.826" class="difflineplus">+        if (m_socketType == nsMsgSocketType::SSL ||</span>
<a href="#l49.827"></a><span id="l49.827" class="difflineplus">+            m_socketType == nsMsgSocketType::alwaysSTARTTLS)</span>
<a href="#l49.828"></a><span id="l49.828" class="difflineplus">+          // tell user to change to plaintext pw</span>
<a href="#l49.829"></a><span id="l49.829" class="difflineplus">+          AlertUserEventUsingId(IMAP_AUTH_CHANGE_ENCRYPT_TO_PLAIN_SSL);</span>
<a href="#l49.830"></a><span id="l49.830" class="difflineplus">+        else</span>
<a href="#l49.831"></a><span id="l49.831" class="difflineplus">+          // tell user to change to plaintext pw, with big warning</span>
<a href="#l49.832"></a><span id="l49.832" class="difflineplus">+          AlertUserEventUsingId(IMAP_AUTH_CHANGE_ENCRYPT_TO_PLAIN_NO_SSL);</span>
<a href="#l49.833"></a><span id="l49.833" class="difflineplus">+      }</span>
<a href="#l49.834"></a><span id="l49.834" class="difflineplus">+      else</span>
<a href="#l49.835"></a><span id="l49.835" class="difflineplus">+        // just &quot;change auth method&quot;</span>
<a href="#l49.836"></a><span id="l49.836" class="difflineplus">+        AlertUserEventUsingId(IMAP_AUTH_MECH_NOT_SUPPORTED);</span>
<a href="#l49.837"></a><span id="l49.837" class="difflineplus">+</span>
<a href="#l49.838"></a><span id="l49.838" class="difflineplus">+      skipLoop = PR_TRUE;</span>
<a href="#l49.839"></a><span id="l49.839" class="difflineplus">+    }</span>
<a href="#l49.840"></a><span id="l49.840">     else</span>
<a href="#l49.841"></a><span id="l49.841" class="difflineminus">-      rv = server-&gt;GetPassword(password);</span>
<a href="#l49.842"></a><span id="l49.842" class="difflineminus">-    rv = m_imapServerSink-&gt;GetLoginUsername(userName);</span>
<a href="#l49.843"></a><span id="l49.843" class="difflineminus">-  }</span>
<a href="#l49.844"></a><span id="l49.844" class="difflineminus">-</span>
<a href="#l49.845"></a><span id="l49.845" class="difflineminus">-  do</span>
<a href="#l49.846"></a><span id="l49.846" class="difflineminus">-  {</span>
<a href="#l49.847"></a><span id="l49.847" class="difflineminus">-      PRBool imapPasswordIsNew = PR_FALSE;</span>
<a href="#l49.848"></a><span id="l49.848" class="difflineminus">-      if (!userName.IsEmpty())</span>
<a href="#l49.849"></a><span id="l49.849" class="difflineminus">-      {</span>
<a href="#l49.850"></a><span id="l49.850" class="difflineminus">-      PRBool lastReportingErrors = GetServerStateParser().GetReportingErrors();</span>
<a href="#l49.851"></a><span id="l49.851" class="difflineminus">-      GetServerStateParser().SetReportingErrors(PR_FALSE);  // turn off errors - we'll put up our own.</span>
<a href="#l49.852"></a><span id="l49.852" class="difflineminus">-</span>
<a href="#l49.853"></a><span id="l49.853" class="difflineminus">-      if (GetServerStateParser().GetCapabilityFlag() == kCapabilityUndefined)</span>
<a href="#l49.854"></a><span id="l49.854" class="difflineminus">-        Capability();</span>
<a href="#l49.855"></a><span id="l49.855" class="difflineminus">-</span>
<a href="#l49.856"></a><span id="l49.856" class="difflineminus">-      if (m_authLogin)</span>
<a href="#l49.857"></a><span id="l49.857" class="difflineplus">+    {</span>
<a href="#l49.858"></a><span id="l49.858" class="difflineplus">+      // try to reset failed methods and try them again</span>
<a href="#l49.859"></a><span id="l49.859" class="difflineplus">+      ResetAuthMethods();</span>
<a href="#l49.860"></a><span id="l49.860" class="difflineplus">+      rv = ChooseAuthMethod();</span>
<a href="#l49.861"></a><span id="l49.861" class="difflineplus">+      if (NS_FAILED(rv)) // all methods failed</span>
<a href="#l49.862"></a><span id="l49.862">       {</span>
<a href="#l49.863"></a><span id="l49.863" class="difflineminus">-        // If secure auth is configured, don't proceed unless the server</span>
<a href="#l49.864"></a><span id="l49.864" class="difflineminus">-        // supports it. This avoids fallback to insecure login in case</span>
<a href="#l49.865"></a><span id="l49.865" class="difflineminus">-        // authentication fails.</span>
<a href="#l49.866"></a><span id="l49.866" class="difflineminus">-        if(m_useSecAuth &amp;&amp; !(GetServerStateParser().GetCapabilityFlag()</span>
<a href="#l49.867"></a><span id="l49.867" class="difflineminus">-            &amp; (kHasCRAMCapability|kHasAuthNTLMCapability|kHasAuthMSNCapability|kHasAuthGssApiCapability)))</span>
<a href="#l49.868"></a><span id="l49.868" class="difflineminus">-        {</span>
<a href="#l49.869"></a><span id="l49.869" class="difflineminus">-          AlertUserEventUsingId(IMAP_AUTH_SECURE_NOTSUPPORTED);</span>
<a href="#l49.870"></a><span id="l49.870" class="difflineminus">-          break;</span>
<a href="#l49.871"></a><span id="l49.871" class="difflineminus">-        }</span>
<a href="#l49.872"></a><span id="l49.872" class="difflineminus">-</span>
<a href="#l49.873"></a><span id="l49.873" class="difflineminus">-        // If secure auth is disabled, ensure that server supports plaintext auth</span>
<a href="#l49.874"></a><span id="l49.874" class="difflineminus">-        if (!m_useSecAuth &amp;&amp; !(GetServerStateParser().GetCapabilityFlag()</span>
<a href="#l49.875"></a><span id="l49.875" class="difflineminus">-             &amp; (kLoginDisabled|kHasAuthLoginCapability|kHasAuthPlainCapability)</span>
<a href="#l49.876"></a><span id="l49.876" class="difflineminus">-             ^  kLoginDisabled))</span>
<a href="#l49.877"></a><span id="l49.877" class="difflineminus">-        {</span>
<a href="#l49.878"></a><span id="l49.878" class="difflineminus">-          AlertUserEventUsingId(IMAP_LOGIN_DISABLED);</span>
<a href="#l49.879"></a><span id="l49.879" class="difflineminus">-          // force re-issue of Capability() to make sure login still disabled.</span>
<a href="#l49.880"></a><span id="l49.880" class="difflineminus">-          m_hostSessionList-&gt;SetCapabilityForHost(GetImapServerKey(), kCapabilityUndefined);</span>
<a href="#l49.881"></a><span id="l49.881" class="difflineminus">-          break;</span>
<a href="#l49.882"></a><span id="l49.882" class="difflineminus">-        }</span>
<a href="#l49.883"></a><span id="l49.883" class="difflineminus">-</span>
<a href="#l49.884"></a><span id="l49.884" class="difflineminus">-        clientSucceeded = PR_TRUE;</span>
<a href="#l49.885"></a><span id="l49.885" class="difflineminus">-        rv = GetPassword(password);</span>
<a href="#l49.886"></a><span id="l49.886" class="difflineminus">-        if (NS_FAILED(rv)) break;</span>
<a href="#l49.887"></a><span id="l49.887" class="difflineminus">-        </span>
<a href="#l49.888"></a><span id="l49.888" class="difflineminus">-        // Use CRAM/NTLM/MSN only if secure auth is enabled. This is for servers that</span>
<a href="#l49.889"></a><span id="l49.889" class="difflineminus">-        // say they support CRAM but are so badly broken that trying it causes</span>
<a href="#l49.890"></a><span id="l49.890" class="difflineminus">-        // all subsequent login attempts to fail (bug 231303, bug 227560)</span>
<a href="#l49.891"></a><span id="l49.891" class="difflineminus">-        if (m_useSecAuth &amp;&amp; GetServerStateParser().GetCapabilityFlag() &amp; kHasAuthGssApiCapability)</span>
<a href="#l49.892"></a><span id="l49.892" class="difflineminus">-        {</span>
<a href="#l49.893"></a><span id="l49.893" class="difflineminus">-          clientSucceeded = NS_SUCCEEDED(AuthLogin(userName.get(), password, kHasAuthGssApiCapability));</span>
<a href="#l49.894"></a><span id="l49.894" class="difflineminus">-        }</span>
<a href="#l49.895"></a><span id="l49.895" class="difflineminus">-        else if (m_useSecAuth &amp;&amp; GetServerStateParser().GetCapabilityFlag() &amp; kHasCRAMCapability)</span>
<a href="#l49.896"></a><span id="l49.896" class="difflineplus">+        PR_LOG(IMAP, PR_LOG_ERROR, (&quot;huch? there are auth methods, and we resetted failed ones, but ChooseAuthMethod still fails.&quot;));</span>
<a href="#l49.897"></a><span id="l49.897" class="difflineplus">+        return false;</span>
<a href="#l49.898"></a><span id="l49.898" class="difflineplus">+      }</span>
<a href="#l49.899"></a><span id="l49.899" class="difflineplus">+    }</span>
<a href="#l49.900"></a><span id="l49.900" class="difflineplus">+  }</span>
<a href="#l49.901"></a><span id="l49.901" class="difflineplus">+</span>
<a href="#l49.902"></a><span id="l49.902" class="difflineplus">+  // Get username, either the stored one or from user</span>
<a href="#l49.903"></a><span id="l49.903" class="difflineplus">+  rv = m_imapServerSink-&gt;GetLoginUsername(userName);</span>
<a href="#l49.904"></a><span id="l49.904" class="difflineplus">+  if (NS_FAILED(rv) || userName.IsEmpty())</span>
<a href="#l49.905"></a><span id="l49.905" class="difflineplus">+  {</span>
<a href="#l49.906"></a><span id="l49.906" class="difflineplus">+    // The user hit &quot;Cancel&quot; on the dialog box</span>
<a href="#l49.907"></a><span id="l49.907" class="difflineplus">+    skipLoop = PR_TRUE;</span>
<a href="#l49.908"></a><span id="l49.908" class="difflineplus">+  }</span>
<a href="#l49.909"></a><span id="l49.909" class="difflineplus">+</span>
<a href="#l49.910"></a><span id="l49.910" class="difflineplus">+  /*</span>
<a href="#l49.911"></a><span id="l49.911" class="difflineplus">+   * Login can fail for various reasons:</span>
<a href="#l49.912"></a><span id="l49.912" class="difflineplus">+   * 1. Server claims to support GSSAPI, but it really doesn't.</span>
<a href="#l49.913"></a><span id="l49.913" class="difflineplus">+   *    Or the client doesn't support GSSAPI, or is not logged in yet.</span>
<a href="#l49.914"></a><span id="l49.914" class="difflineplus">+   *    (GSSAPI is a mechanism without password in apps).</span>
<a href="#l49.915"></a><span id="l49.915" class="difflineplus">+   * 2. Server claims to support CRAM-MD5, but it's broken and will fail despite correct password.</span>
<a href="#l49.916"></a><span id="l49.916" class="difflineplus">+   * 2.1. Some servers say they support CRAM but are so badly broken that trying it causes</span>
<a href="#l49.917"></a><span id="l49.917" class="difflineplus">+   *    all subsequent login attempts to fail during this connection (bug 231303).</span>
<a href="#l49.918"></a><span id="l49.918" class="difflineplus">+   *    So we use CRAM/NTLM/MSN only if enabled in prefs.</span>
<a href="#l49.919"></a><span id="l49.919" class="difflineplus">+   *    Update: if it affects only some ISPs, we can maybe use the ISP DB</span>
<a href="#l49.920"></a><span id="l49.920" class="difflineplus">+   *    and disable CRAM specifically for these.</span>
<a href="#l49.921"></a><span id="l49.921" class="difflineplus">+   * 3. Prefs are set to require auth methods which the server doesn't support</span>
<a href="#l49.922"></a><span id="l49.922" class="difflineplus">+   *     (per CAPS or we tried and they failed).</span>
<a href="#l49.923"></a><span id="l49.923" class="difflineplus">+   * 4. User provided wrong password.</span>
<a href="#l49.924"></a><span id="l49.924" class="difflineplus">+   * 5. We tried too often and the server shut us down, so even a correct attempt</span>
<a href="#l49.925"></a><span id="l49.925" class="difflineplus">+   *    will now (currently) fail.</span>
<a href="#l49.926"></a><span id="l49.926" class="difflineplus">+   * The above problems may overlap, e.g. 3. with 1. and 2., and we can't differentiate</span>
<a href="#l49.927"></a><span id="l49.927" class="difflineplus">+   * between 2. and 4., which is really unfortunate.</span>
<a href="#l49.928"></a><span id="l49.928" class="difflineplus">+   */</span>
<a href="#l49.929"></a><span id="l49.929" class="difflineplus">+</span>
<a href="#l49.930"></a><span id="l49.930" class="difflineplus">+  // This loops over 1) auth methods (only one per loop) and 2) password tries (with UI)</span>
<a href="#l49.931"></a><span id="l49.931" class="difflineplus">+  while (!loginSucceeded &amp;&amp; !skipLoop &amp;&amp; !DeathSignalReceived())</span>
<a href="#l49.932"></a><span id="l49.932" class="difflineplus">+  {</span>
<a href="#l49.933"></a><span id="l49.933" class="difflineplus">+      // Get password</span>
<a href="#l49.934"></a><span id="l49.934" class="difflineplus">+      if (m_currentAuthMethod != kHasAuthGssApiCapability &amp;&amp; // GSSAPI uses no pw in apps</span>
<a href="#l49.935"></a><span id="l49.935" class="difflineplus">+          m_currentAuthMethod != kHasAuthNoneCapability)</span>
<a href="#l49.936"></a><span id="l49.936" class="difflineplus">+      {</span>
<a href="#l49.937"></a><span id="l49.937" class="difflineplus">+          rv = GetPassword(password);</span>
<a href="#l49.938"></a><span id="l49.938" class="difflineplus">+          if (rv == NS_MSG_PASSWORD_PROMPT_CANCELLED || NS_FAILED(rv))</span>
<a href="#l49.939"></a><span id="l49.939" class="difflineplus">+          {</span>
<a href="#l49.940"></a><span id="l49.940" class="difflineplus">+            PR_LOG(IMAP, PR_LOG_ERROR, (&quot;IMAP: password prompt failed or user canceled it&quot;));</span>
<a href="#l49.941"></a><span id="l49.941" class="difflineplus">+            break;</span>
<a href="#l49.942"></a><span id="l49.942" class="difflineplus">+          }</span>
<a href="#l49.943"></a><span id="l49.943" class="difflineplus">+          PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;got new password&quot;));</span>
<a href="#l49.944"></a><span id="l49.944" class="difflineplus">+      }</span>
<a href="#l49.945"></a><span id="l49.945" class="difflineplus">+</span>
<a href="#l49.946"></a><span id="l49.946" class="difflineplus">+      PRBool lastReportingErrors = GetServerStateParser().GetReportingErrors();</span>
<a href="#l49.947"></a><span id="l49.947" class="difflineplus">+      GetServerStateParser().SetReportingErrors(PR_FALSE); // turn off errors - we'll put up our own.</span>
<a href="#l49.948"></a><span id="l49.948" class="difflineplus">+</span>
<a href="#l49.949"></a><span id="l49.949" class="difflineplus">+      rv = AuthLogin(userName.get(), password, m_currentAuthMethod);</span>
<a href="#l49.950"></a><span id="l49.950" class="difflineplus">+</span>
<a href="#l49.951"></a><span id="l49.951" class="difflineplus">+      GetServerStateParser().SetReportingErrors(lastReportingErrors); // restore error reports</span>
<a href="#l49.952"></a><span id="l49.952" class="difflineplus">+      loginSucceeded = NS_SUCCEEDED(rv);</span>
<a href="#l49.953"></a><span id="l49.953" class="difflineplus">+</span>
<a href="#l49.954"></a><span id="l49.954" class="difflineplus">+      if (!loginSucceeded)</span>
<a href="#l49.955"></a><span id="l49.955" class="difflineplus">+      {</span>
<a href="#l49.956"></a><span id="l49.956" class="difflineplus">+        PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;authlogin failed&quot;));</span>
<a href="#l49.957"></a><span id="l49.957" class="difflineplus">+        MarkAuthMethodAsFailed(m_currentAuthMethod);</span>
<a href="#l49.958"></a><span id="l49.958" class="difflineplus">+        rv = ChooseAuthMethod(); // change m_currentAuthMethod to try other one next round</span>
<a href="#l49.959"></a><span id="l49.959" class="difflineplus">+</span>
<a href="#l49.960"></a><span id="l49.960" class="difflineplus">+        if (NS_FAILED(rv)) // all methods failed</span>
<a href="#l49.961"></a><span id="l49.961">         {</span>
<a href="#l49.962"></a><span id="l49.962" class="difflineminus">-          AuthLogin (userName.get(), password, kHasCRAMCapability);</span>
<a href="#l49.963"></a><span id="l49.963" class="difflineminus">-          logonTries++;</span>
<a href="#l49.964"></a><span id="l49.964" class="difflineminus">-        }</span>
<a href="#l49.965"></a><span id="l49.965" class="difflineminus">-        else if (m_useSecAuth &amp;&amp; GetServerStateParser().GetCapabilityFlag() &amp; kHasAuthNTLMCapability)</span>
<a href="#l49.966"></a><span id="l49.966" class="difflineminus">-        {</span>
<a href="#l49.967"></a><span id="l49.967" class="difflineminus">-          AuthLogin (userName.get(), password, kHasAuthNTLMCapability);</span>
<a href="#l49.968"></a><span id="l49.968" class="difflineminus">-          logonTries++;</span>
<a href="#l49.969"></a><span id="l49.969" class="difflineminus">-        }</span>
<a href="#l49.970"></a><span id="l49.970" class="difflineminus">-        else if (m_useSecAuth &amp;&amp; GetServerStateParser().GetCapabilityFlag() &amp; kHasAuthMSNCapability)</span>
<a href="#l49.971"></a><span id="l49.971" class="difflineminus">-        {</span>
<a href="#l49.972"></a><span id="l49.972" class="difflineminus">-          AuthLogin (userName.get(), password, kHasAuthMSNCapability);</span>
<a href="#l49.973"></a><span id="l49.973" class="difflineminus">-          logonTries++;</span>
<a href="#l49.974"></a><span id="l49.974" class="difflineminus">-        }</span>
<a href="#l49.975"></a><span id="l49.975" class="difflineminus">-        else if (GetServerStateParser().GetCapabilityFlag() &amp; kHasAuthPlainCapability)</span>
<a href="#l49.976"></a><span id="l49.976" class="difflineminus">-        {</span>
<a href="#l49.977"></a><span id="l49.977" class="difflineminus">-          AuthLogin (userName.get(), password, kHasAuthPlainCapability);</span>
<a href="#l49.978"></a><span id="l49.978" class="difflineminus">-          logonTries++;</span>
<a href="#l49.979"></a><span id="l49.979" class="difflineminus">-        }</span>
<a href="#l49.980"></a><span id="l49.980" class="difflineminus">-        else if (GetServerStateParser().GetCapabilityFlag() &amp; kHasAuthLoginCapability)</span>
<a href="#l49.981"></a><span id="l49.981" class="difflineminus">-        {</span>
<a href="#l49.982"></a><span id="l49.982" class="difflineminus">-          AuthLogin (userName.get(), password,  kHasAuthLoginCapability);</span>
<a href="#l49.983"></a><span id="l49.983" class="difflineminus">-          logonTries++; // This counts as a logon try for most servers</span>
<a href="#l49.984"></a><span id="l49.984" class="difflineminus">-        }</span>
<a href="#l49.985"></a><span id="l49.985" class="difflineminus">-        else if (! (GetServerStateParser().GetCapabilityFlag() &amp; kLoginDisabled))</span>
<a href="#l49.986"></a><span id="l49.986" class="difflineminus">-          InsecureLogin(userName.get(), password);</span>
<a href="#l49.987"></a><span id="l49.987" class="difflineminus">-      } // if prefbool</span>
<a href="#l49.988"></a><span id="l49.988" class="difflineminus">-      else if (! (GetServerStateParser().GetCapabilityFlag() &amp; kLoginDisabled))</span>
<a href="#l49.989"></a><span id="l49.989" class="difflineminus">-      {</span>
<a href="#l49.990"></a><span id="l49.990" class="difflineminus">-        rv = GetPassword(password);</span>
<a href="#l49.991"></a><span id="l49.991" class="difflineminus">-        if (NS_FAILED(rv)) break;</span>
<a href="#l49.992"></a><span id="l49.992" class="difflineminus">-        InsecureLogin(userName.get(), password);</span>
<a href="#l49.993"></a><span id="l49.993" class="difflineminus">-      }</span>
<a href="#l49.994"></a><span id="l49.994" class="difflineminus">-</span>
<a href="#l49.995"></a><span id="l49.995" class="difflineminus">-      if (!clientSucceeded || !GetServerStateParser().LastCommandSuccessful())</span>
<a href="#l49.996"></a><span id="l49.996" class="difflineminus">-      {</span>
<a href="#l49.997"></a><span id="l49.997" class="difflineminus">-        if (!DeathSignalReceived() &amp;&amp; clientSucceeded)</span>
<a href="#l49.998"></a><span id="l49.998" class="difflineminus">-        {</span>
<a href="#l49.999"></a><span id="l49.999" class="difflineminus">-          // login failed!</span>
<a href="#l49.1000"></a><span id="l49.1000" class="difflineminus">-          // if we failed because of an interrupt, then do not bother the user</span>
<a href="#l49.1001"></a><span id="l49.1001" class="difflineminus">-          // similarly - if we failed due to a local error, don't bug them</span>
<a href="#l49.1002"></a><span id="l49.1002" class="difflineminus">-          if (m_imapServerSink)</span>
<a href="#l49.1003"></a><span id="l49.1003" class="difflineplus">+          if (m_prefAuthMethods == kHasAuthGssApiCapability)</span>
<a href="#l49.1004"></a><span id="l49.1004" class="difflineplus">+          {</span>
<a href="#l49.1005"></a><span id="l49.1005" class="difflineplus">+            // GSSAPI failed, and it's the only available method,</span>
<a href="#l49.1006"></a><span id="l49.1006" class="difflineplus">+            // and it's password-less, so nothing left to do.</span>
<a href="#l49.1007"></a><span id="l49.1007" class="difflineplus">+            AlertUserEventUsingId(IMAP_AUTH_GSSAPI_FAILED);</span>
<a href="#l49.1008"></a><span id="l49.1008" class="difflineplus">+            break;</span>
<a href="#l49.1009"></a><span id="l49.1009" class="difflineplus">+          }</span>
<a href="#l49.1010"></a><span id="l49.1010" class="difflineplus">+</span>
<a href="#l49.1011"></a><span id="l49.1011" class="difflineplus">+          // The reason that we failed might be a wrong password, so</span>
<a href="#l49.1012"></a><span id="l49.1012" class="difflineplus">+          // ask user what to do</span>
<a href="#l49.1013"></a><span id="l49.1013" class="difflineplus">+          PR_LOG(IMAP, PR_LOG_WARN, (&quot;IMAP: ask user what to do (after login failed): new passwort, retry, cancel&quot;));</span>
<a href="#l49.1014"></a><span id="l49.1014" class="difflineplus">+          if (!m_imapServerSink)</span>
<a href="#l49.1015"></a><span id="l49.1015" class="difflineplus">+            break;</span>
<a href="#l49.1016"></a><span id="l49.1016" class="difflineplus">+          nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l49.1017"></a><span id="l49.1017" class="difflineplus">+          GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l49.1018"></a><span id="l49.1018" class="difflineplus">+          // if there's no msg window, don't forget the password</span>
<a href="#l49.1019"></a><span id="l49.1019" class="difflineplus">+          if (!msgWindow)</span>
<a href="#l49.1020"></a><span id="l49.1020" class="difflineplus">+            break;</span>
<a href="#l49.1021"></a><span id="l49.1021" class="difflineplus">+          PRInt32 buttonPressed = 1;</span>
<a href="#l49.1022"></a><span id="l49.1022" class="difflineplus">+          rv = m_imapServerSink-&gt;PromptLoginFailed(msgWindow,</span>
<a href="#l49.1023"></a><span id="l49.1023" class="difflineplus">+                                                    &amp;buttonPressed);</span>
<a href="#l49.1024"></a><span id="l49.1024" class="difflineplus">+          if (NS_FAILED(rv))</span>
<a href="#l49.1025"></a><span id="l49.1025" class="difflineplus">+            break;</span>
<a href="#l49.1026"></a><span id="l49.1026" class="difflineplus">+          if (buttonPressed == 2) // 'New password' button</span>
<a href="#l49.1027"></a><span id="l49.1027">           {</span>
<a href="#l49.1028"></a><span id="l49.1028" class="difflineminus">-            nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l49.1029"></a><span id="l49.1029" class="difflineminus">-            GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l49.1030"></a><span id="l49.1030" class="difflineminus">-            // if there's no msg window, don't forget the password</span>
<a href="#l49.1031"></a><span id="l49.1031" class="difflineminus">-            if (msgWindow)</span>
<a href="#l49.1032"></a><span id="l49.1032" class="difflineminus">-            {</span>
<a href="#l49.1033"></a><span id="l49.1033" class="difflineminus">-              PRInt32 buttonPressed = 0;</span>
<a href="#l49.1034"></a><span id="l49.1034" class="difflineminus">-              rv = m_imapServerSink-&gt;PromptLoginFailed(msgWindow,</span>
<a href="#l49.1035"></a><span id="l49.1035" class="difflineminus">-                                                       &amp;buttonPressed);</span>
<a href="#l49.1036"></a><span id="l49.1036" class="difflineminus">-              if (NS_SUCCEEDED(rv))</span>
<a href="#l49.1037"></a><span id="l49.1037" class="difflineminus">-              {</span>
<a href="#l49.1038"></a><span id="l49.1038" class="difflineminus">-                if (buttonPressed == 2)</span>
<a href="#l49.1039"></a><span id="l49.1039" class="difflineminus">-                {</span>
<a href="#l49.1040"></a><span id="l49.1040" class="difflineminus">-                  // Change password was pressed. For now, forget the</span>
<a href="#l49.1041"></a><span id="l49.1041" class="difflineminus">-                  // stored password and we'll prompt for a new one next time</span>
<a href="#l49.1042"></a><span id="l49.1042" class="difflineminus">-                  // around.</span>
<a href="#l49.1043"></a><span id="l49.1043" class="difflineminus">-                  m_imapServerSink-&gt;ForgetPassword();</span>
<a href="#l49.1044"></a><span id="l49.1044" class="difflineminus">-                  // Reset logon tries to allow the user to have some failed</span>
<a href="#l49.1045"></a><span id="l49.1045" class="difflineminus">-                  // attempts even if they have already pressed retry a few</span>
<a href="#l49.1046"></a><span id="l49.1046" class="difflineminus">-                  // times.</span>
<a href="#l49.1047"></a><span id="l49.1047" class="difflineminus">-                  logonTries = 0;</span>
<a href="#l49.1048"></a><span id="l49.1048" class="difflineminus">-                }</span>
<a href="#l49.1049"></a><span id="l49.1049" class="difflineminus">-                else if (buttonPressed == 1)</span>
<a href="#l49.1050"></a><span id="l49.1050" class="difflineminus">-                  // Cancel button pressed, abort quickly by exiting the loop</span>
<a href="#l49.1051"></a><span id="l49.1051" class="difflineminus">-                  // this time.</span>
<a href="#l49.1052"></a><span id="l49.1052" class="difflineminus">-                  logonTries = maxLogonTries;</span>
<a href="#l49.1053"></a><span id="l49.1053" class="difflineminus">-              }</span>
<a href="#l49.1054"></a><span id="l49.1054" class="difflineminus">-            }</span>
<a href="#l49.1055"></a><span id="l49.1055" class="difflineplus">+            PR_LOG(IMAP, PR_LOG_WARN, (&quot;new password button pressed.&quot;));</span>
<a href="#l49.1056"></a><span id="l49.1056" class="difflineplus">+            // Forget the current password</span>
<a href="#l49.1057"></a><span id="l49.1057" class="difflineplus">+            password.Truncate();</span>
<a href="#l49.1058"></a><span id="l49.1058" class="difflineplus">+            m_hostSessionList-&gt;SetPasswordForHost(GetImapServerKey(), nsnull);</span>
<a href="#l49.1059"></a><span id="l49.1059" class="difflineplus">+            m_imapServerSink-&gt;ForgetPassword();</span>
<a href="#l49.1060"></a><span id="l49.1060" class="difflineplus">+            PR_LOG(IMAP, PR_LOG_WARN, (&quot;password resetted (nulled)&quot;));</span>
<a href="#l49.1061"></a><span id="l49.1061" class="difflineplus">+            // Will call GetPassword() in beginning of next loop</span>
<a href="#l49.1062"></a><span id="l49.1062" class="difflineplus">+</span>
<a href="#l49.1063"></a><span id="l49.1063" class="difflineplus">+            // Try all possible auth methods again with the new password.</span>
<a href="#l49.1064"></a><span id="l49.1064" class="difflineplus">+            ResetAuthMethods();</span>
<a href="#l49.1065"></a><span id="l49.1065">           }</span>
<a href="#l49.1066"></a><span id="l49.1066" class="difflineminus">-</span>
<a href="#l49.1067"></a><span id="l49.1067" class="difflineminus">-          m_hostSessionList-&gt;SetPasswordForHost(GetImapServerKey(), nsnull);</span>
<a href="#l49.1068"></a><span id="l49.1068" class="difflineplus">+          else if (buttonPressed == 0) // Retry button</span>
<a href="#l49.1069"></a><span id="l49.1069" class="difflineplus">+          {</span>
<a href="#l49.1070"></a><span id="l49.1070" class="difflineplus">+            PR_LOG(IMAP, PR_LOG_WARN, (&quot;retry button pressed&quot;));</span>
<a href="#l49.1071"></a><span id="l49.1071" class="difflineplus">+            // Try all possible auth methods again</span>
<a href="#l49.1072"></a><span id="l49.1072" class="difflineplus">+            ResetAuthMethods();</span>
<a href="#l49.1073"></a><span id="l49.1073" class="difflineplus">+          }</span>
<a href="#l49.1074"></a><span id="l49.1074" class="difflineplus">+          else if (buttonPressed == 1) // Cancel button</span>
<a href="#l49.1075"></a><span id="l49.1075" class="difflineplus">+          {</span>
<a href="#l49.1076"></a><span id="l49.1076" class="difflineplus">+            PR_LOG(IMAP, PR_LOG_WARN, (&quot;cancel button pressed&quot;));</span>
<a href="#l49.1077"></a><span id="l49.1077" class="difflineplus">+            break; // Abort quickly</span>
<a href="#l49.1078"></a><span id="l49.1078" class="difflineplus">+          }</span>
<a href="#l49.1079"></a><span id="l49.1079" class="difflineplus">+</span>
<a href="#l49.1080"></a><span id="l49.1080" class="difflineplus">+          // TODO what is this for? When does it get set to != unknown again?</span>
<a href="#l49.1081"></a><span id="l49.1081">           m_currentBiffState = nsIMsgFolder::nsMsgBiffState_Unknown;</span>
<a href="#l49.1082"></a><span id="l49.1082">           SendSetBiffIndicatorEvent(m_currentBiffState);</span>
<a href="#l49.1083"></a><span id="l49.1083" class="difflineminus">-          password.Truncate();</span>
<a href="#l49.1084"></a><span id="l49.1084" class="difflineminus">-        } // if we didn't receive the death signal...</span>
<a href="#l49.1085"></a><span id="l49.1085" class="difflineminus">-      } // if login failed</span>
<a href="#l49.1086"></a><span id="l49.1086" class="difflineminus">-      else  // login succeeded</span>
<a href="#l49.1087"></a><span id="l49.1087" class="difflineminus">-      {</span>
<a href="#l49.1088"></a><span id="l49.1088" class="difflineminus">-        PRBool passwordAlreadyVerified;</span>
<a href="#l49.1089"></a><span id="l49.1089" class="difflineminus">-        rv = m_hostSessionList-&gt;SetPasswordForHost(GetImapServerKey(), password.get());</span>
<a href="#l49.1090"></a><span id="l49.1090" class="difflineminus">-        rv = m_hostSessionList-&gt;GetPasswordVerifiedOnline(GetImapServerKey(), passwordAlreadyVerified);</span>
<a href="#l49.1091"></a><span id="l49.1091" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; !passwordAlreadyVerified)</span>
<a href="#l49.1092"></a><span id="l49.1092" class="difflineminus">-          m_hostSessionList-&gt;SetPasswordVerifiedOnline(GetImapServerKey());</span>
<a href="#l49.1093"></a><span id="l49.1093" class="difflineminus">-        imapPasswordIsNew = !passwordAlreadyVerified;</span>
<a href="#l49.1094"></a><span id="l49.1094" class="difflineminus">-        if (imapPasswordIsNew)</span>
<a href="#l49.1095"></a><span id="l49.1095" class="difflineminus">-        {</span>
<a href="#l49.1096"></a><span id="l49.1096" class="difflineminus">-          if (m_currentBiffState == nsIMsgFolder::nsMsgBiffState_Unknown)</span>
<a href="#l49.1097"></a><span id="l49.1097" class="difflineminus">-          {</span>
<a href="#l49.1098"></a><span id="l49.1098" class="difflineminus">-              m_currentBiffState = nsIMsgFolder::nsMsgBiffState_NoMail;</span>
<a href="#l49.1099"></a><span id="l49.1099" class="difflineminus">-              SendSetBiffIndicatorEvent(m_currentBiffState);</span>
<a href="#l49.1100"></a><span id="l49.1100" class="difflineminus">-          }</span>
<a href="#l49.1101"></a><span id="l49.1101" class="difflineminus">-        }</span>
<a href="#l49.1102"></a><span id="l49.1102" class="difflineminus">-</span>
<a href="#l49.1103"></a><span id="l49.1103" class="difflineminus">-        loginSucceeded = PR_TRUE;</span>
<a href="#l49.1104"></a><span id="l49.1104" class="difflineminus">-      } // else if login succeeded</span>
<a href="#l49.1105"></a><span id="l49.1105" class="difflineminus">-</span>
<a href="#l49.1106"></a><span id="l49.1106" class="difflineminus">-      GetServerStateParser().SetReportingErrors(lastReportingErrors);  // restore it</span>
<a href="#l49.1107"></a><span id="l49.1107" class="difflineminus">-</span>
<a href="#l49.1108"></a><span id="l49.1108" class="difflineminus">-      if (loginSucceeded &amp;&amp; imapPasswordIsNew)</span>
<a href="#l49.1109"></a><span id="l49.1109" class="difflineplus">+        } // all methods failed</span>
<a href="#l49.1110"></a><span id="l49.1110" class="difflineplus">+      } // login failed</span>
<a href="#l49.1111"></a><span id="l49.1111" class="difflineplus">+  } // while</span>
<a href="#l49.1112"></a><span id="l49.1112" class="difflineplus">+</span>
<a href="#l49.1113"></a><span id="l49.1113" class="difflineplus">+  if (loginSucceeded)</span>
<a href="#l49.1114"></a><span id="l49.1114" class="difflineplus">+  {</span>
<a href="#l49.1115"></a><span id="l49.1115" class="difflineplus">+    PR_LOG(IMAP, PR_LOG_DEBUG, (&quot;login succeeded&quot;));</span>
<a href="#l49.1116"></a><span id="l49.1116" class="difflineplus">+    PRBool passwordAlreadyVerified;</span>
<a href="#l49.1117"></a><span id="l49.1117" class="difflineplus">+    m_hostSessionList-&gt;SetPasswordForHost(GetImapServerKey(), password.get());</span>
<a href="#l49.1118"></a><span id="l49.1118" class="difflineplus">+    rv = m_hostSessionList-&gt;GetPasswordVerifiedOnline(GetImapServerKey(), passwordAlreadyVerified);</span>
<a href="#l49.1119"></a><span id="l49.1119" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !passwordAlreadyVerified)</span>
<a href="#l49.1120"></a><span id="l49.1120" class="difflineplus">+      m_hostSessionList-&gt;SetPasswordVerifiedOnline(GetImapServerKey());</span>
<a href="#l49.1121"></a><span id="l49.1121" class="difflineplus">+    PRBool imapPasswordIsNew = !passwordAlreadyVerified;</span>
<a href="#l49.1122"></a><span id="l49.1122" class="difflineplus">+    if (imapPasswordIsNew)</span>
<a href="#l49.1123"></a><span id="l49.1123" class="difflineplus">+    {</span>
<a href="#l49.1124"></a><span id="l49.1124" class="difflineplus">+      if (m_currentBiffState == nsIMsgFolder::nsMsgBiffState_Unknown)</span>
<a href="#l49.1125"></a><span id="l49.1125">       {</span>
<a href="#l49.1126"></a><span id="l49.1126" class="difflineminus">-        // let's record the user as authenticated.</span>
<a href="#l49.1127"></a><span id="l49.1127" class="difflineminus">-        m_imapServerSink-&gt;SetUserAuthenticated(PR_TRUE);</span>
<a href="#l49.1128"></a><span id="l49.1128" class="difflineminus">-      }</span>
<a href="#l49.1129"></a><span id="l49.1129" class="difflineminus">-</span>
<a href="#l49.1130"></a><span id="l49.1130" class="difflineminus">-      if (loginSucceeded)</span>
<a href="#l49.1131"></a><span id="l49.1131" class="difflineminus">-      {</span>
<a href="#l49.1132"></a><span id="l49.1132" class="difflineminus">-        nsImapAction imapAction;</span>
<a href="#l49.1133"></a><span id="l49.1133" class="difflineminus">-        m_runningUrl-&gt;GetImapAction(&amp;imapAction);</span>
<a href="#l49.1134"></a><span id="l49.1134" class="difflineminus">-        // We don't want to do any more processing if we're just</span>
<a href="#l49.1135"></a><span id="l49.1135" class="difflineminus">-        // verifying the ability to logon because it can leave us in</span>
<a href="#l49.1136"></a><span id="l49.1136" class="difflineminus">-        // a half-constructed state.</span>
<a href="#l49.1137"></a><span id="l49.1137" class="difflineminus">-        if (imapAction != nsIImapUrl::nsImapVerifylogon)</span>
<a href="#l49.1138"></a><span id="l49.1138" class="difflineminus">-          ProcessAfterAuthenticated();</span>
<a href="#l49.1139"></a><span id="l49.1139" class="difflineplus">+          m_currentBiffState = nsIMsgFolder::nsMsgBiffState_NoMail;</span>
<a href="#l49.1140"></a><span id="l49.1140" class="difflineplus">+          SendSetBiffIndicatorEvent(m_currentBiffState);</span>
<a href="#l49.1141"></a><span id="l49.1141">       }</span>
<a href="#l49.1142"></a><span id="l49.1142" class="difflineminus">-    }</span>
<a href="#l49.1143"></a><span id="l49.1143" class="difflineminus">-    else</span>
<a href="#l49.1144"></a><span id="l49.1144" class="difflineminus">-    {</span>
<a href="#l49.1145"></a><span id="l49.1145" class="difflineminus">-      // The user hit &quot;Cancel&quot; on the dialog box</span>
<a href="#l49.1146"></a><span id="l49.1146" class="difflineminus">-      HandleCurrentUrlError();</span>
<a href="#l49.1147"></a><span id="l49.1147" class="difflineminus">-      break;</span>
<a href="#l49.1148"></a><span id="l49.1148" class="difflineminus">-    }</span>
<a href="#l49.1149"></a><span id="l49.1149" class="difflineminus">-  }</span>
<a href="#l49.1150"></a><span id="l49.1150" class="difflineminus">-</span>
<a href="#l49.1151"></a><span id="l49.1151" class="difflineminus">-  while (!loginSucceeded &amp;&amp; ++logonTries &lt; maxLogonTries);</span>
<a href="#l49.1152"></a><span id="l49.1152" class="difflineminus">-</span>
<a href="#l49.1153"></a><span id="l49.1153" class="difflineminus">-  if (!loginSucceeded)</span>
<a href="#l49.1154"></a><span id="l49.1154" class="difflineminus">-  {</span>
<a href="#l49.1155"></a><span id="l49.1155" class="difflineplus">+      m_imapServerSink-&gt;SetUserAuthenticated(PR_TRUE);</span>
<a href="#l49.1156"></a><span id="l49.1156" class="difflineplus">+    }</span>
<a href="#l49.1157"></a><span id="l49.1157" class="difflineplus">+</span>
<a href="#l49.1158"></a><span id="l49.1158" class="difflineplus">+    nsImapAction imapAction;</span>
<a href="#l49.1159"></a><span id="l49.1159" class="difflineplus">+    m_runningUrl-&gt;GetImapAction(&amp;imapAction);</span>
<a href="#l49.1160"></a><span id="l49.1160" class="difflineplus">+    // We don't want to do any more processing if we're just</span>
<a href="#l49.1161"></a><span id="l49.1161" class="difflineplus">+    // verifying the ability to logon because it can leave us in</span>
<a href="#l49.1162"></a><span id="l49.1162" class="difflineplus">+    // a half-constructed state.</span>
<a href="#l49.1163"></a><span id="l49.1163" class="difflineplus">+    if (imapAction != nsIImapUrl::nsImapVerifylogon)</span>
<a href="#l49.1164"></a><span id="l49.1164" class="difflineplus">+      ProcessAfterAuthenticated();</span>
<a href="#l49.1165"></a><span id="l49.1165" class="difflineplus">+  }</span>
<a href="#l49.1166"></a><span id="l49.1166" class="difflineplus">+  else // login failed</span>
<a href="#l49.1167"></a><span id="l49.1167" class="difflineplus">+  {</span>
<a href="#l49.1168"></a><span id="l49.1168" class="difflineplus">+    PR_LOG(IMAP, PR_LOG_ERROR, (&quot;login failed entirely&quot;));</span>
<a href="#l49.1169"></a><span id="l49.1169">     m_currentBiffState = nsIMsgFolder::nsMsgBiffState_Unknown;</span>
<a href="#l49.1170"></a><span id="l49.1170">     SendSetBiffIndicatorEvent(m_currentBiffState);</span>
<a href="#l49.1171"></a><span id="l49.1171">     HandleCurrentUrlError();</span>
<a href="#l49.1172"></a><span id="l49.1172" class="difflineminus">-    SetConnectionStatus(-1);        // stop netlib</span>
<a href="#l49.1173"></a><span id="l49.1173" class="difflineplus">+    SetConnectionStatus(-1); // stop netlib</span>
<a href="#l49.1174"></a><span id="l49.1174">   }</span>
<a href="#l49.1175"></a><span id="l49.1175"> </span>
<a href="#l49.1176"></a><span id="l49.1176">   return loginSucceeded;</span>
<a href="#l49.1177"></a><span id="l49.1177"> }</span>
<a href="#l49.1178"></a><span id="l49.1178"> </span>
<a href="#l49.1179"></a><span id="l49.1179"> void nsImapProtocol::UpdateFolderQuotaData(nsCString&amp; aQuotaRoot, PRUint32 aUsed, PRUint32 aMax)</span>
<a href="#l49.1180"></a><span id="l49.1180"> {</span>
<a href="#l49.1181"></a><span id="l49.1181">   NS_ASSERTION(m_imapMailFolderSink, &quot;m_imapMailFolderSink is null!&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.h</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.h</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -346,17 +346,16 @@ private:</span>
<a href="#l50.4"></a><span id="l50.4">   nsCString             m_userName;</span>
<a href="#l50.5"></a><span id="l50.5">   nsCString             m_serverKey;</span>
<a href="#l50.6"></a><span id="l50.6">   char                  *m_dataOutputBuf;</span>
<a href="#l50.7"></a><span id="l50.7">   nsMsgLineStreamBuffer * m_inputStreamBuffer;</span>
<a href="#l50.8"></a><span id="l50.8">   PRUint32              m_allocatedSize; // allocated size</span>
<a href="#l50.9"></a><span id="l50.9">   PRUint32        m_totalDataSize; // total data size</span>
<a href="#l50.10"></a><span id="l50.10">   PRUint32        m_curReadIndex;  // current read index</span>
<a href="#l50.11"></a><span id="l50.11">   nsCString       m_trashFolderName;</span>
<a href="#l50.12"></a><span id="l50.12" class="difflineminus">-  PRBool          m_authLogin;</span>
<a href="#l50.13"></a><span id="l50.13"> </span>
<a href="#l50.14"></a><span id="l50.14">   // Ouput stream for writing commands to the socket</span>
<a href="#l50.15"></a><span id="l50.15">   nsCOMPtr&lt;nsISocketTransport&gt;  m_transport;</span>
<a href="#l50.16"></a><span id="l50.16"> </span>
<a href="#l50.17"></a><span id="l50.17">   nsCOMPtr&lt;nsIAsyncInputStream&gt;   m_channelInputStream;</span>
<a href="#l50.18"></a><span id="l50.18">   nsCOMPtr&lt;nsIAsyncOutputStream&gt;  m_channelOutputStream;</span>
<a href="#l50.19"></a><span id="l50.19">   nsCOMPtr&lt;nsIImapMockChannel&gt;    m_mockChannel;   // this is the channel we should forward to people</span>
<a href="#l50.20"></a><span id="l50.20">   //nsCOMPtr&lt;nsIRequest&gt; mAsyncReadRequest; // we're going to cancel this when we're done with the conn.</span>
<a href="#l50.21"></a><span id="l50.21" class="difflineat">@@ -470,16 +469,20 @@ private:</span>
<a href="#l50.22"></a><span id="l50.22">   int  m_currentServerCommandTagNumber;</span>
<a href="#l50.23"></a><span id="l50.23">   void IncrementCommandTagNumber();</span>
<a href="#l50.24"></a><span id="l50.24">   char *GetServerCommandTag();</span>
<a href="#l50.25"></a><span id="l50.25"> </span>
<a href="#l50.26"></a><span id="l50.26">   void StartTLS();</span>
<a href="#l50.27"></a><span id="l50.27"> </span>
<a href="#l50.28"></a><span id="l50.28">   // login related methods.</span>
<a href="#l50.29"></a><span id="l50.29">   nsresult GetPassword(nsCString &amp;password);</span>
<a href="#l50.30"></a><span id="l50.30" class="difflineplus">+  void InitPrefAuthMethods(PRInt32 authMethodPrefValue);</span>
<a href="#l50.31"></a><span id="l50.31" class="difflineplus">+  nsresult ChooseAuthMethod();</span>
<a href="#l50.32"></a><span id="l50.32" class="difflineplus">+  void MarkAuthMethodAsFailed(PRInt32 failedAuthMethod);</span>
<a href="#l50.33"></a><span id="l50.33" class="difflineplus">+  void ResetAuthMethods();</span>
<a href="#l50.34"></a><span id="l50.34"> </span>
<a href="#l50.35"></a><span id="l50.35">   // All of these methods actually issue protocol</span>
<a href="#l50.36"></a><span id="l50.36">   void Capability(); // query host for capabilities.</span>
<a href="#l50.37"></a><span id="l50.37">   void EnableCondStore(); </span>
<a href="#l50.38"></a><span id="l50.38">   void StartCompressDeflate();</span>
<a href="#l50.39"></a><span id="l50.39">   nsresult BeginCompressing();</span>
<a href="#l50.40"></a><span id="l50.40">   void Language(); // set the language on the server if it supports it</span>
<a href="#l50.41"></a><span id="l50.41">   void Namespace();</span>
<a href="#l50.42"></a><span id="l50.42" class="difflineat">@@ -590,17 +593,19 @@ private:</span>
<a href="#l50.43"></a><span id="l50.43">   PRTime  m_lastActiveTime;</span>
<a href="#l50.44"></a><span id="l50.44">   PRInt32 m_tooFastTime;</span>
<a href="#l50.45"></a><span id="l50.45">   PRInt32 m_idealTime;</span>
<a href="#l50.46"></a><span id="l50.46">   PRInt32 m_chunkAddSize;</span>
<a href="#l50.47"></a><span id="l50.47">   PRInt32 m_chunkStartSize;</span>
<a href="#l50.48"></a><span id="l50.48">   PRBool  m_fetchByChunks;</span>
<a href="#l50.49"></a><span id="l50.49">   PRInt32 m_curFetchSize;</span>
<a href="#l50.50"></a><span id="l50.50">   PRBool  m_ignoreExpunges;</span>
<a href="#l50.51"></a><span id="l50.51" class="difflineminus">-  PRBool  m_useSecAuth;</span>
<a href="#l50.52"></a><span id="l50.52" class="difflineplus">+  PRInt32 m_prefAuthMethods; // set of capability flags (in nsImapCore.h) for auth methods</span>
<a href="#l50.53"></a><span id="l50.53" class="difflineplus">+  PRInt32 m_failedAuthMethods; // ditto</span>
<a href="#l50.54"></a><span id="l50.54" class="difflineplus">+  eIMAPCapabilityFlag m_currentAuthMethod; // exactly one capability flag, or 0</span>
<a href="#l50.55"></a><span id="l50.55">   PRInt32 m_socketType;</span>
<a href="#l50.56"></a><span id="l50.56">   PRInt32 m_chunkSize;</span>
<a href="#l50.57"></a><span id="l50.57">   PRInt32 m_chunkThreshold;</span>
<a href="#l50.58"></a><span id="l50.58">   nsRefPtr &lt;nsMsgImapLineDownloadCache&gt; m_downloadLineCache;</span>
<a href="#l50.59"></a><span id="l50.59">   nsRefPtr &lt;nsMsgImapHdrXferInfo&gt; m_hdrDownloadCache;</span>
<a href="#l50.60"></a><span id="l50.60">   nsCOMPtr &lt;nsIImapHeaderInfo&gt; m_curHdrInfo;</span>
<a href="#l50.61"></a><span id="l50.61">   // mapping between special xlist mailboxes and the corresponding folder flag</span>
<a href="#l50.62"></a><span id="l50.62">   nsDataHashtable&lt;nsCStringHashKey, PRInt32&gt; m_specialXListMailboxes;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/mailnews/imap/src/nsImapServerResponseParser.cpp</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapServerResponseParser.cpp</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -2189,17 +2189,17 @@ void nsImapServerResponseParser::msg_obs</span>
<a href="#l51.4"></a><span id="l51.4">   else</span>
<a href="#l51.5"></a><span id="l51.5">     SetSyntaxError(PR_TRUE);</span>
<a href="#l51.6"></a><span id="l51.6">   </span>
<a href="#l51.7"></a><span id="l51.7"> }</span>
<a href="#l51.8"></a><span id="l51.8"> </span>
<a href="#l51.9"></a><span id="l51.9"> void nsImapServerResponseParser::capability_data()</span>
<a href="#l51.10"></a><span id="l51.10"> {</span>
<a href="#l51.11"></a><span id="l51.11">   PRInt32 endToken = -1;</span>
<a href="#l51.12"></a><span id="l51.12" class="difflineminus">-  fCapabilityFlag = kCapabilityDefined;</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineplus">+  fCapabilityFlag = kCapabilityDefined | kHasAuthOldLoginCapability;</span>
<a href="#l51.14"></a><span id="l51.14">   do {</span>
<a href="#l51.15"></a><span id="l51.15">     AdvanceToNextToken();</span>
<a href="#l51.16"></a><span id="l51.16">     if (fNextToken) {</span>
<a href="#l51.17"></a><span id="l51.17">       nsCString token(fNextToken);</span>
<a href="#l51.18"></a><span id="l51.18">       endToken = token.FindChar(']');</span>
<a href="#l51.19"></a><span id="l51.19">       if (endToken &gt;= 0)</span>
<a href="#l51.20"></a><span id="l51.20">         token.Truncate(endToken);</span>
<a href="#l51.21"></a><span id="l51.21"> </span>
<a href="#l51.22"></a><span id="l51.22" class="difflineat">@@ -2213,19 +2213,17 @@ void nsImapServerResponseParser::capabil</span>
<a href="#l51.23"></a><span id="l51.23">         fCapabilityFlag |= kHasAuthNTLMCapability;</span>
<a href="#l51.24"></a><span id="l51.24">       else if (token.Equals(&quot;AUTH=GSSAPI&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l51.25"></a><span id="l51.25">         fCapabilityFlag |= kHasAuthGssApiCapability;</span>
<a href="#l51.26"></a><span id="l51.26">       else if (token.Equals(&quot;AUTH=MSN&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l51.27"></a><span id="l51.27">         fCapabilityFlag |= kHasAuthMSNCapability;</span>
<a href="#l51.28"></a><span id="l51.28">       else if (token.Equals(&quot;STARTTLS&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l51.29"></a><span id="l51.29">         fCapabilityFlag |= kHasStartTLSCapability;</span>
<a href="#l51.30"></a><span id="l51.30">       else if (token.Equals(&quot;LOGINDISABLED&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l51.31"></a><span id="l51.31" class="difflineminus">-        fCapabilityFlag |= kLoginDisabled;</span>
<a href="#l51.32"></a><span id="l51.32" class="difflineminus">-      else if (token.Equals(&quot;X-NETSCAPE&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l51.33"></a><span id="l51.33" class="difflineminus">-        fCapabilityFlag |= kHasXNetscapeCapability;</span>
<a href="#l51.34"></a><span id="l51.34" class="difflineplus">+        fCapabilityFlag &amp;= ~kHasAuthOldLoginCapability; // remove flag</span>
<a href="#l51.35"></a><span id="l51.35">       else if (token.Equals(&quot;XSENDER&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l51.36"></a><span id="l51.36">         fCapabilityFlag |= kHasXSenderCapability;</span>
<a href="#l51.37"></a><span id="l51.37">       else if (token.Equals(&quot;IMAP4&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l51.38"></a><span id="l51.38">         fCapabilityFlag |= kIMAP4Capability;</span>
<a href="#l51.39"></a><span id="l51.39">       else if (token.Equals(&quot;IMAP4rev1&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l51.40"></a><span id="l51.40">         fCapabilityFlag |= kIMAP4rev1Capability;</span>
<a href="#l51.41"></a><span id="l51.41">       else if (Substring(token,0,5).Equals(&quot;IMAP4&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l51.42"></a><span id="l51.42">         fCapabilityFlag |= kIMAP4other;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/mailnews/imap/src/nsImapStringBundle.h</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapStringBundle.h</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -109,17 +109,21 @@ PR_END_EXTERN_C</span>
<a href="#l52.4"></a><span id="l52.4"> #define IMAP_SERVER_DOESNT_SUPPORT_ACL              5084</span>
<a href="#l52.5"></a><span id="l52.5"> #define IMAP_ACL_EXPUNGE_RIGHT                      5085</span>
<a href="#l52.6"></a><span id="l52.6"> #define IMAP_SERVER_DISCONNECTED                    5090</span>
<a href="#l52.7"></a><span id="l52.7"> #define IMAP_SUBSCRIBE_PROMPT                       5092</span>
<a href="#l52.8"></a><span id="l52.8"> #define IMAP_SERVER_DROPPED_CONNECTION              5093</span>
<a href="#l52.9"></a><span id="l52.9"> #define IMAP_QUOTA_STATUS_FOLDERNOTOPEN             5095</span>
<a href="#l52.10"></a><span id="l52.10"> #define IMAP_QUOTA_STATUS_NOTSUPPORTED              5096</span>
<a href="#l52.11"></a><span id="l52.11"> #define IMAP_QUOTA_STATUS_NOQUOTA                   5097</span>
<a href="#l52.12"></a><span id="l52.12" class="difflineminus">-#define	IMAP_OUT_OF_MEMORY                          5100</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineminus">-#define IMAP_AUTH_SECURE_NOTSUPPORTED               5102</span>
<a href="#l52.14"></a><span id="l52.14" class="difflineplus">+#define IMAP_OUT_OF_MEMORY                          5100</span>
<a href="#l52.15"></a><span id="l52.15" class="difflineplus">+#define IMAP_AUTH_MECH_NOT_SUPPORTED                5101</span>
<a href="#l52.16"></a><span id="l52.16" class="difflineplus">+#define IMAP_AUTH_MECH_FAILED                       5102</span>
<a href="#l52.17"></a><span id="l52.17"> #define IMAP_COPYING_MESSAGE_OF                     5103</span>
<a href="#l52.18"></a><span id="l52.18" class="difflineplus">+#define IMAP_AUTH_GSSAPI_FAILED                     5104</span>
<a href="#l52.19"></a><span id="l52.19"> #define IMAP_MOVE_FOLDER_TO_TRASH                   5105</span>
<a href="#l52.20"></a><span id="l52.20"> #define IMAP_DELETE_NO_TRASH                        5106</span>
<a href="#l52.21"></a><span id="l52.21"> #define IMAP_DELETE_FOLDER_DIALOG_TITLE             5107</span>
<a href="#l52.22"></a><span id="l52.22"> #define IMAP_DELETE_FOLDER_BUTTON_LABEL             5108</span>
<a href="#l52.23"></a><span id="l52.23" class="difflineminus">-#define IMAP_LOGIN_DISABLED                         5109</span>
<a href="#l52.24"></a><span id="l52.24" class="difflineplus">+#define IMAP_AUTH_CHANGE_ENCRYPT_TO_PLAIN_NO_SSL    5109</span>
<a href="#l52.25"></a><span id="l52.25" class="difflineplus">+#define IMAP_AUTH_CHANGE_ENCRYPT_TO_PLAIN_SSL       5110</span>
<a href="#l52.26"></a><span id="l52.26" class="difflineplus">+#define IMAP_AUTH_CHANGE_PLAIN_TO_ENCRYPT           5111</span>
<a href="#l52.27"></a><span id="l52.27"> #endif /* _nsImapStringBundle_H__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1">new file mode 100644</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineminus">--- /dev/null</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapAuthMethods.js</span>
<a href="#l53.4"></a><span id="l53.4" class="difflineat">@@ -0,0 +1,163 @@</span>
<a href="#l53.5"></a><span id="l53.5" class="difflineplus">+/**</span>
<a href="#l53.6"></a><span id="l53.6" class="difflineplus">+ * Login tests for IMAP</span>
<a href="#l53.7"></a><span id="l53.7" class="difflineplus">+ *</span>
<a href="#l53.8"></a><span id="l53.8" class="difflineplus">+ * Test code &lt;copied from=&quot;test_mailboxes.js&quot;&gt;</span>
<a href="#l53.9"></a><span id="l53.9" class="difflineplus">+ * and &lt;copied from=&quot;test_pop3AuthMethods.js&quot;&gt;</span>
<a href="#l53.10"></a><span id="l53.10" class="difflineplus">+ *</span>
<a href="#l53.11"></a><span id="l53.11" class="difflineplus">+ * BUGS:</span>
<a href="#l53.12"></a><span id="l53.12" class="difflineplus">+ * - cleanup after each test doesn't seem to work correctly. Effects:</span>
<a href="#l53.13"></a><span id="l53.13" class="difflineplus">+ *    - one more &quot;lsub&quot; per test, e.g. &quot;capability&quot;, &quot;auth...&quot;, &quot;lsub&quot;, &quot;lsub&quot;, &quot;lsub&quot;, &quot;list&quot; in the 3. test.,</span>
<a href="#l53.14"></a><span id="l53.14" class="difflineplus">+ *    - root folder check succeeds although login failed</span>
<a href="#l53.15"></a><span id="l53.15" class="difflineplus">+ * - removeIncomingServer(..., true); (cleanup files) fails.</span>
<a href="#l53.16"></a><span id="l53.16" class="difflineplus">+ */</span>
<a href="#l53.17"></a><span id="l53.17" class="difflineplus">+</span>
<a href="#l53.18"></a><span id="l53.18" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l53.19"></a><span id="l53.19" class="difflineplus">+load(&quot;../../mailnews/resources/alertTestUtils.js&quot;);</span>
<a href="#l53.20"></a><span id="l53.20" class="difflineplus">+</span>
<a href="#l53.21"></a><span id="l53.21" class="difflineplus">+//const kUsername = &quot;fred&quot;;</span>
<a href="#l53.22"></a><span id="l53.22" class="difflineplus">+//const kPassword = &quot;wilma&quot;;</span>
<a href="#l53.23"></a><span id="l53.23" class="difflineplus">+</span>
<a href="#l53.24"></a><span id="l53.24" class="difflineplus">+var acctMgr;</span>
<a href="#l53.25"></a><span id="l53.25" class="difflineplus">+var thisTest;</span>
<a href="#l53.26"></a><span id="l53.26" class="difflineplus">+var test = null;</span>
<a href="#l53.27"></a><span id="l53.27" class="difflineplus">+</span>
<a href="#l53.28"></a><span id="l53.28" class="difflineplus">+var tests = [</span>
<a href="#l53.29"></a><span id="l53.29" class="difflineplus">+  { title: &quot;Cleartext password, with server only supporting old-style login&quot;,</span>
<a href="#l53.30"></a><span id="l53.30" class="difflineplus">+    clientAuthMethod : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l53.31"></a><span id="l53.31" class="difflineplus">+    serverAuthMethods : [],</span>
<a href="#l53.32"></a><span id="l53.32" class="difflineplus">+    expectSuccess : true,</span>
<a href="#l53.33"></a><span id="l53.33" class="difflineplus">+    transaction: [ &quot;capability&quot;, &quot;login&quot;, &quot;lsub&quot; ] },</span>
<a href="#l53.34"></a><span id="l53.34" class="difflineplus">+  // Just to make sure we clean up properly - in the test and in TB, e.g. don't cache stuff</span>
<a href="#l53.35"></a><span id="l53.35" class="difflineplus">+  { title: &quot;Second time Cleartext password, with server only supporting old-style login&quot;,</span>
<a href="#l53.36"></a><span id="l53.36" class="difflineplus">+    clientAuthMethod : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l53.37"></a><span id="l53.37" class="difflineplus">+    serverAuthMethods : [],</span>
<a href="#l53.38"></a><span id="l53.38" class="difflineplus">+    expectSuccess : true,</span>
<a href="#l53.39"></a><span id="l53.39" class="difflineplus">+    transaction: [ &quot;capability&quot;, &quot;login&quot;, &quot;lsub&quot; ] },</span>
<a href="#l53.40"></a><span id="l53.40" class="difflineplus">+ { title: &quot;Cleartext password, with server supporting AUTH PLAIN, LOGIN and CRAM&quot;,</span>
<a href="#l53.41"></a><span id="l53.41" class="difflineplus">+    clientAuthMethod : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l53.42"></a><span id="l53.42" class="difflineplus">+    serverAuthMethods : [ &quot;PLAIN&quot;, &quot;LOGIN&quot;, &quot;CRAM-MD5&quot; ],</span>
<a href="#l53.43"></a><span id="l53.43" class="difflineplus">+    expectSuccess : true,</span>
<a href="#l53.44"></a><span id="l53.44" class="difflineplus">+    transaction: [ &quot;capability&quot;, &quot;authenticate PLAIN&quot;, &quot;lsub&quot; ] },</span>
<a href="#l53.45"></a><span id="l53.45" class="difflineplus">+  { title: &quot;Cleartext password, with server supporting only AUTH LOGIN&quot;,</span>
<a href="#l53.46"></a><span id="l53.46" class="difflineplus">+    clientAuthMethod : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l53.47"></a><span id="l53.47" class="difflineplus">+    serverAuthMethods : [ &quot;LOGIN&quot; ],</span>
<a href="#l53.48"></a><span id="l53.48" class="difflineplus">+    expectSuccess : true,</span>
<a href="#l53.49"></a><span id="l53.49" class="difflineplus">+    transaction: [ &quot;capability&quot;, &quot;authenticate LOGIN&quot;, &quot;lsub&quot; ] },</span>
<a href="#l53.50"></a><span id="l53.50" class="difflineplus">+  { title: &quot;Encrypted password, with server supporting PLAIN and CRAM&quot;,</span>
<a href="#l53.51"></a><span id="l53.51" class="difflineplus">+    clientAuthMethod : Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l53.52"></a><span id="l53.52" class="difflineplus">+    serverAuthMethods : [ &quot;PLAIN&quot;, &quot;LOGIN&quot;, &quot;CRAM-MD5&quot; ],</span>
<a href="#l53.53"></a><span id="l53.53" class="difflineplus">+    expectSuccess : true,</span>
<a href="#l53.54"></a><span id="l53.54" class="difflineplus">+    transaction: [ &quot;capability&quot;, &quot;authenticate CRAM-MD5&quot;, &quot;lsub&quot; ] },</span>
<a href="#l53.55"></a><span id="l53.55" class="difflineplus">+  { title: &quot;Encrypted password, with server only supporting AUTH PLAIN and LOGIN (must fail)&quot;,</span>
<a href="#l53.56"></a><span id="l53.56" class="difflineplus">+    clientAuthMethod : Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l53.57"></a><span id="l53.57" class="difflineplus">+    serverAuthMethods : [ &quot;PLAIN&quot;, &quot;LOGIN&quot; ],</span>
<a href="#l53.58"></a><span id="l53.58" class="difflineplus">+    expectSuccess : false,</span>
<a href="#l53.59"></a><span id="l53.59" class="difflineplus">+    transaction: [ &quot;capability&quot; ] },</span>
<a href="#l53.60"></a><span id="l53.60" class="difflineplus">+  { title: &quot;Any secure method, with server supporting AUTH PLAIN and CRAM&quot;,</span>
<a href="#l53.61"></a><span id="l53.61" class="difflineplus">+    clientAuthMethod : Ci.nsMsgAuthMethod.secure,</span>
<a href="#l53.62"></a><span id="l53.62" class="difflineplus">+    serverAuthMethods : [ &quot;PLAIN&quot; , &quot;LOGIN&quot;, &quot;CRAM-MD5&quot; ],</span>
<a href="#l53.63"></a><span id="l53.63" class="difflineplus">+    expectSuccess : true,</span>
<a href="#l53.64"></a><span id="l53.64" class="difflineplus">+    transaction: [ &quot;capability&quot;, &quot;authenticate CRAM-MD5&quot;, &quot;lsub&quot; ] },</span>
<a href="#l53.65"></a><span id="l53.65" class="difflineplus">+  { title: &quot;Any secure method, with server only supporting AUTH PLAIN and LOGIN (must fail)&quot;,</span>
<a href="#l53.66"></a><span id="l53.66" class="difflineplus">+    clientAuthMethod : Ci.nsMsgAuthMethod.secure,</span>
<a href="#l53.67"></a><span id="l53.67" class="difflineplus">+    serverAuthMethods : [ &quot;PLAIN&quot; ],</span>
<a href="#l53.68"></a><span id="l53.68" class="difflineplus">+    expectSuccess : false,</span>
<a href="#l53.69"></a><span id="l53.69" class="difflineplus">+    transaction: [ &quot;capability&quot; ] },</span>
<a href="#l53.70"></a><span id="l53.70" class="difflineplus">+];</span>
<a href="#l53.71"></a><span id="l53.71" class="difflineplus">+</span>
<a href="#l53.72"></a><span id="l53.72" class="difflineplus">+function nextTest() {</span>
<a href="#l53.73"></a><span id="l53.73" class="difflineplus">+  try {</span>
<a href="#l53.74"></a><span id="l53.74" class="difflineplus">+    thisTest = tests.shift();</span>
<a href="#l53.75"></a><span id="l53.75" class="difflineplus">+    if (!thisTest)</span>
<a href="#l53.76"></a><span id="l53.76" class="difflineplus">+    {</span>
<a href="#l53.77"></a><span id="l53.77" class="difflineplus">+        endTest();</span>
<a href="#l53.78"></a><span id="l53.78" class="difflineplus">+        return;</span>
<a href="#l53.79"></a><span id="l53.79" class="difflineplus">+    }</span>
<a href="#l53.80"></a><span id="l53.80" class="difflineplus">+    /* doesn't work, hangs on first performTest(...)</span>
<a href="#l53.81"></a><span id="l53.81" class="difflineplus">+    {</span>
<a href="#l53.82"></a><span id="l53.82" class="difflineplus">+      dump(&quot;resetTest()\n&quot;);</span>
<a href="#l53.83"></a><span id="l53.83" class="difflineplus">+      server.resetTest();</span>
<a href="#l53.84"></a><span id="l53.84" class="difflineplus">+      dump(&quot;server.performTest()\n&quot;);</span>
<a href="#l53.85"></a><span id="l53.85" class="difflineplus">+      server.performTest();</span>
<a href="#l53.86"></a><span id="l53.86" class="difflineplus">+    }*/</span>
<a href="#l53.87"></a><span id="l53.87" class="difflineplus">+</span>
<a href="#l53.88"></a><span id="l53.88" class="difflineplus">+    test = thisTest.title;</span>
<a href="#l53.89"></a><span id="l53.89" class="difflineplus">+    dump(&quot;NEXT test: &quot; + thisTest.title + &quot;\n&quot;);</span>
<a href="#l53.90"></a><span id="l53.90" class="difflineplus">+</span>
<a href="#l53.91"></a><span id="l53.91" class="difflineplus">+    // (re)create fake server</span>
<a href="#l53.92"></a><span id="l53.92" class="difflineplus">+    var daemon = new imapDaemon();</span>
<a href="#l53.93"></a><span id="l53.93" class="difflineplus">+    var server = makeServer(daemon, &quot;&quot;);</span>
<a href="#l53.94"></a><span id="l53.94" class="difflineplus">+    server.setDebugLevel(fsDebugAll);</span>
<a href="#l53.95"></a><span id="l53.95" class="difflineplus">+    var handler = server._handler;</span>
<a href="#l53.96"></a><span id="l53.96" class="difflineplus">+    //handler.kUsername = kUsername;</span>
<a href="#l53.97"></a><span id="l53.97" class="difflineplus">+    //handler.kPassword = kPassword;</span>
<a href="#l53.98"></a><span id="l53.98" class="difflineplus">+    //daemon.createMailbox(&quot;somemailbox&quot;);</span>
<a href="#l53.99"></a><span id="l53.99" class="difflineplus">+</span>
<a href="#l53.100"></a><span id="l53.100" class="difflineplus">+    handler.kAuthSchemes = thisTest.serverAuthMethods;</span>
<a href="#l53.101"></a><span id="l53.101" class="difflineplus">+</span>
<a href="#l53.102"></a><span id="l53.102" class="difflineplus">+    // If Mailnews ever caches server capabilities, delete and re-create the incomingServer here</span>
<a href="#l53.103"></a><span id="l53.103" class="difflineplus">+    var incomingServer = createLocalIMAPServer();</span>
<a href="#l53.104"></a><span id="l53.104" class="difflineplus">+</span>
<a href="#l53.105"></a><span id="l53.105" class="difflineplus">+    let msgServer = incomingServer;</span>
<a href="#l53.106"></a><span id="l53.106" class="difflineplus">+    msgServer.QueryInterface(Ci.nsIMsgIncomingServer);</span>
<a href="#l53.107"></a><span id="l53.107" class="difflineplus">+    msgServer.authMethod = thisTest.clientAuthMethod;</span>
<a href="#l53.108"></a><span id="l53.108" class="difflineplus">+</span>
<a href="#l53.109"></a><span id="l53.109" class="difflineplus">+    // connect</span>
<a href="#l53.110"></a><span id="l53.110" class="difflineplus">+    incomingServer.performExpand(null);</span>
<a href="#l53.111"></a><span id="l53.111" class="difflineplus">+    server.performTest(&quot;LSUB&quot;);</span>
<a href="#l53.112"></a><span id="l53.112" class="difflineplus">+</span>
<a href="#l53.113"></a><span id="l53.113" class="difflineplus">+    dump(&quot;should &quot; + (thisTest.expectSuccess ? &quot;&quot;:&quot;not &quot;) + &quot;be logged in\n&quot;);</span>
<a href="#l53.114"></a><span id="l53.114" class="difflineplus">+    do_check_eq(true, incomingServer instanceof Ci.nsIImapServerSink);</span>
<a href="#l53.115"></a><span id="l53.115" class="difflineplus">+    //do_check_eq(thisTest.expectSuccess, incomingServer.userAuthenticated); TODO fails second time</span>
<a href="#l53.116"></a><span id="l53.116" class="difflineplus">+    //var rootFolder = incomingServer.rootFolder;</span>
<a href="#l53.117"></a><span id="l53.117" class="difflineplus">+    // Client creates fake Inbox, so check other folder</span>
<a href="#l53.118"></a><span id="l53.118" class="difflineplus">+    //do_check_eq(thisTest.expectSuccess,</span>
<a href="#l53.119"></a><span id="l53.119" class="difflineplus">+    //    rootFolder.containsChildNamed(&quot;somemailbox&quot;)); TODO</span>
<a href="#l53.120"></a><span id="l53.120" class="difflineplus">+    do_check_transaction(server.playTransaction(), thisTest.transaction, false);</span>
<a href="#l53.121"></a><span id="l53.121" class="difflineplus">+</span>
<a href="#l53.122"></a><span id="l53.122" class="difflineplus">+    do {</span>
<a href="#l53.123"></a><span id="l53.123" class="difflineplus">+      incomingServer.closeCachedConnections();</span>
<a href="#l53.124"></a><span id="l53.124" class="difflineplus">+    } while (incomingServer.serverBusy)</span>
<a href="#l53.125"></a><span id="l53.125" class="difflineplus">+    incomingServer.shutdown();</span>
<a href="#l53.126"></a><span id="l53.126" class="difflineplus">+    incomingServer.clearAllValues();</span>
<a href="#l53.127"></a><span id="l53.127" class="difflineplus">+    deleteIMAPServer(incomingServer);</span>
<a href="#l53.128"></a><span id="l53.128" class="difflineplus">+    acctMgr.closeCachedConnections();</span>
<a href="#l53.129"></a><span id="l53.129" class="difflineplus">+    acctMgr.shutdownServers();</span>
<a href="#l53.130"></a><span id="l53.130" class="difflineplus">+    acctMgr.UnloadAccounts();</span>
<a href="#l53.131"></a><span id="l53.131" class="difflineplus">+    server.stop();</span>
<a href="#l53.132"></a><span id="l53.132" class="difflineplus">+</span>
<a href="#l53.133"></a><span id="l53.133" class="difflineplus">+  } catch (e) {</span>
<a href="#l53.134"></a><span id="l53.134" class="difflineplus">+    //server.stop();</span>
<a href="#l53.135"></a><span id="l53.135" class="difflineplus">+    //endTest();</span>
<a href="#l53.136"></a><span id="l53.136" class="difflineplus">+    do_throw(e);</span>
<a href="#l53.137"></a><span id="l53.137" class="difflineplus">+  }</span>
<a href="#l53.138"></a><span id="l53.138" class="difflineplus">+</span>
<a href="#l53.139"></a><span id="l53.139" class="difflineplus">+  nextTest();</span>
<a href="#l53.140"></a><span id="l53.140" class="difflineplus">+}</span>
<a href="#l53.141"></a><span id="l53.141" class="difflineplus">+</span>
<a href="#l53.142"></a><span id="l53.142" class="difflineplus">+function deleteIMAPServer(incomingServer) {</span>
<a href="#l53.143"></a><span id="l53.143" class="difflineplus">+  if (!incomingServer)</span>
<a href="#l53.144"></a><span id="l53.144" class="difflineplus">+    return;</span>
<a href="#l53.145"></a><span id="l53.145" class="difflineplus">+  acctMgr.removeIncomingServer(incomingServer, false); // TODO cleanup files = true fails</span>
<a href="#l53.146"></a><span id="l53.146" class="difflineplus">+  //incomingServer = null;</span>
<a href="#l53.147"></a><span id="l53.147" class="difflineplus">+  acctMgr.removeAccount(acctMgr.defaultAccount);</span>
<a href="#l53.148"></a><span id="l53.148" class="difflineplus">+}</span>
<a href="#l53.149"></a><span id="l53.149" class="difflineplus">+</span>
<a href="#l53.150"></a><span id="l53.150" class="difflineplus">+</span>
<a href="#l53.151"></a><span id="l53.151" class="difflineplus">+function run_test() {</span>
<a href="#l53.152"></a><span id="l53.152" class="difflineplus">+  do_test_pending();</span>
<a href="#l53.153"></a><span id="l53.153" class="difflineplus">+</span>
<a href="#l53.154"></a><span id="l53.154" class="difflineplus">+  registerAlertTestUtils();</span>
<a href="#l53.155"></a><span id="l53.155" class="difflineplus">+  acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l53.156"></a><span id="l53.156" class="difflineplus">+                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l53.157"></a><span id="l53.157" class="difflineplus">+</span>
<a href="#l53.158"></a><span id="l53.158" class="difflineplus">+  nextTest();</span>
<a href="#l53.159"></a><span id="l53.159" class="difflineplus">+}</span>
<a href="#l53.160"></a><span id="l53.160" class="difflineplus">+</span>
<a href="#l53.161"></a><span id="l53.161" class="difflineplus">+function endTest() {</span>
<a href="#l53.162"></a><span id="l53.162" class="difflineplus">+  var thread = gThreadManager.currentThread;</span>
<a href="#l53.163"></a><span id="l53.163" class="difflineplus">+  while (thread.hasPendingEvents())</span>
<a href="#l53.164"></a><span id="l53.164" class="difflineplus">+    thread.processNextEvent(true);</span>
<a href="#l53.165"></a><span id="l53.165" class="difflineplus">+</span>
<a href="#l53.166"></a><span id="l53.166" class="difflineplus">+  do_test_finished();</span>
<a href="#l53.167"></a><span id="l53.167" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/mailnews/import/oexpress/nsOESettings.cpp</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/mailnews/import/oexpress/nsOESettings.cpp</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -73,19 +73,19 @@ public:</span>
<a href="#l54.4"></a><span id="l54.4"> </span>
<a href="#l54.5"></a><span id="l54.5">   static PRBool DoImport( nsIMsgAccount **ppAccount);</span>
<a href="#l54.6"></a><span id="l54.6"> </span>
<a href="#l54.7"></a><span id="l54.7">   static PRBool DoIMAPServer( nsIMsgAccountManager *pMgr, HKEY hKey, char *pServerName, nsIMsgAccount **ppAccount);</span>
<a href="#l54.8"></a><span id="l54.8">   static PRBool DoPOP3Server( nsIMsgAccountManager *pMgr, HKEY hKey, char *pServerName, nsIMsgAccount **ppAccount);</span>
<a href="#l54.9"></a><span id="l54.9">   static PRBool DoNNTPServer( nsIMsgAccountManager *pMgr, HKEY hKey, char *pServerName, nsIMsgAccount **ppAccount);</span>
<a href="#l54.10"></a><span id="l54.10"> </span>
<a href="#l54.11"></a><span id="l54.11">   static void SetIdentities( nsIMsgAccountManager *pMgr, nsIMsgAccount *pAcc, HKEY hKey,</span>
<a href="#l54.12"></a><span id="l54.12" class="difflineminus">-                             char *pIncomgUserName, PRBool useSecAuth, PRBool isNNTP);</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineplus">+                             char *pIncomgUserName, PRInt32 authMethodIncoming, PRBool isNNTP);</span>
<a href="#l54.14"></a><span id="l54.14">   static void SetSmtpServer( char *pSmtpServer, HKEY hKey, nsIMsgIdentity *id,</span>
<a href="#l54.15"></a><span id="l54.15" class="difflineminus">-                             char *pIncomgUserName, PRBool useSecAuth);</span>
<a href="#l54.16"></a><span id="l54.16" class="difflineplus">+                             char *pIncomgUserName, PRInt32 authMethodIncoming);</span>
<a href="#l54.17"></a><span id="l54.17">   static nsresult GetAccountName(HKEY hKey, char *defaultName, nsString &amp;acctName);</span>
<a href="#l54.18"></a><span id="l54.18"> };</span>
<a href="#l54.19"></a><span id="l54.19"> </span>
<a href="#l54.20"></a><span id="l54.20"> static PRInt32 checkNewMailTime;// OE global setting, let's default to 30</span>
<a href="#l54.21"></a><span id="l54.21"> static PRBool  checkNewMail;    // OE global setting, let's default to PR_FALSE</span>
<a href="#l54.22"></a><span id="l54.22">                                 // This won't cause unwanted autodownloads-</span>
<a href="#l54.23"></a><span id="l54.23">                                 // user can set prefs after import</span>
<a href="#l54.24"></a><span id="l54.24"> </span>
<a href="#l54.25"></a><span id="l54.25" class="difflineat">@@ -396,17 +396,17 @@ nsresult OESettings::GetAccountName(HKEY</span>
<a href="#l54.26"></a><span id="l54.26">   }</span>
<a href="#l54.27"></a><span id="l54.27">   else</span>
<a href="#l54.28"></a><span id="l54.28">     acctName.AssignASCII(defaultName);</span>
<a href="#l54.29"></a><span id="l54.29">   return rv;</span>
<a href="#l54.30"></a><span id="l54.30"> }</span>
<a href="#l54.31"></a><span id="l54.31"> </span>
<a href="#l54.32"></a><span id="l54.32"> PRBool OESettings::DoIMAPServer( nsIMsgAccountManager *pMgr, HKEY hKey, char *pServerName, nsIMsgAccount **ppAccount)</span>
<a href="#l54.33"></a><span id="l54.33"> {</span>
<a href="#l54.34"></a><span id="l54.34" class="difflineminus">-  PRBool useSecAuth;    // Secure Password Authentication</span>
<a href="#l54.35"></a><span id="l54.35" class="difflineplus">+  PRInt32 authMethod;</span>
<a href="#l54.36"></a><span id="l54.36">   if (ppAccount)</span>
<a href="#l54.37"></a><span id="l54.37">     *ppAccount = nsnull;</span>
<a href="#l54.38"></a><span id="l54.38"> </span>
<a href="#l54.39"></a><span id="l54.39">   char * pUserName;</span>
<a href="#l54.40"></a><span id="l54.40">   pUserName = (char *)nsOERegUtil::GetValueBytes(hKey, &quot;IMAP User Name&quot;);</span>
<a href="#l54.41"></a><span id="l54.41">   if (!pUserName)</span>
<a href="#l54.42"></a><span id="l54.42">     return( PR_FALSE);</span>
<a href="#l54.43"></a><span id="l54.43"> </span>
<a href="#l54.44"></a><span id="l54.44" class="difflineat">@@ -432,38 +432,39 @@ PRBool OESettings::DoIMAPServer( nsIMsgA</span>
<a href="#l54.45"></a><span id="l54.45">         imapServer-&gt;SetServerDirectory(nsDependentCString((const char *) pRootFolder));</span>
<a href="#l54.46"></a><span id="l54.46">         nsOERegUtil::FreeValueBytes(pRootFolder);</span>
<a href="#l54.47"></a><span id="l54.47">       }</span>
<a href="#l54.48"></a><span id="l54.48"> </span>
<a href="#l54.49"></a><span id="l54.49">       BYTE * pSecureConnection = nsOERegUtil::GetValueBytes(hKey, &quot;IMAP Secure Connection&quot;);</span>
<a href="#l54.50"></a><span id="l54.50">       if (pSecureConnection)</span>
<a href="#l54.51"></a><span id="l54.51">       {</span>
<a href="#l54.52"></a><span id="l54.52">         if (*pSecureConnection)</span>
<a href="#l54.53"></a><span id="l54.53" class="difflineminus">-          in-&gt;SetSocketType(nsIMsgIncomingServer::useSSL);</span>
<a href="#l54.54"></a><span id="l54.54" class="difflineplus">+          in-&gt;SetSocketType(nsMsgSocketType::SSL);</span>
<a href="#l54.55"></a><span id="l54.55">         nsOERegUtil::FreeValueBytes(pSecureConnection);</span>
<a href="#l54.56"></a><span id="l54.56">       }</span>
<a href="#l54.57"></a><span id="l54.57"> </span>
<a href="#l54.58"></a><span id="l54.58">       BYTE * pPort = nsOERegUtil::GetValueBytes(hKey, &quot;IMAP Port&quot;);</span>
<a href="#l54.59"></a><span id="l54.59">       if (pPort)</span>
<a href="#l54.60"></a><span id="l54.60">       {</span>
<a href="#l54.61"></a><span id="l54.61">         in-&gt;SetPort(*(PRInt32 *) pPort);</span>
<a href="#l54.62"></a><span id="l54.62">         nsOERegUtil::FreeValueBytes(pPort);</span>
<a href="#l54.63"></a><span id="l54.63">       }</span>
<a href="#l54.64"></a><span id="l54.64"> </span>
<a href="#l54.65"></a><span id="l54.65">       BYTE * pBytesTemp = nsOERegUtil::GetValueBytes(hKey, &quot;IMAP Use Sicily&quot;);</span>
<a href="#l54.66"></a><span id="l54.66">       if (pBytesTemp)</span>
<a href="#l54.67"></a><span id="l54.67">       {</span>
<a href="#l54.68"></a><span id="l54.68" class="difflineminus">-        in-&gt;SetUseSecAuth(*(PRBool *)pBytesTemp);</span>
<a href="#l54.69"></a><span id="l54.69" class="difflineminus">-        useSecAuth = *(PRBool *)pBytesTemp;</span>
<a href="#l54.70"></a><span id="l54.70" class="difflineplus">+        PRBool secAuth = *(PRBool *)pBytesTemp;</span>
<a href="#l54.71"></a><span id="l54.71">         nsOERegUtil::FreeValueBytes(pBytesTemp);</span>
<a href="#l54.72"></a><span id="l54.72" class="difflineplus">+        authMethod = secAuth ? nsMsgAuthMethod::secure</span>
<a href="#l54.73"></a><span id="l54.73" class="difflineplus">+            : nsMsgAuthMethod::passwordCleartext;</span>
<a href="#l54.74"></a><span id="l54.74">       }</span>
<a href="#l54.75"></a><span id="l54.75">       else {</span>
<a href="#l54.76"></a><span id="l54.76" class="difflineminus">-        in-&gt;SetUseSecAuth(PR_FALSE);</span>
<a href="#l54.77"></a><span id="l54.77" class="difflineminus">-        useSecAuth = PR_FALSE;</span>
<a href="#l54.78"></a><span id="l54.78" class="difflineplus">+        authMethod = nsMsgAuthMethod::passwordCleartext;</span>
<a href="#l54.79"></a><span id="l54.79">       }</span>
<a href="#l54.80"></a><span id="l54.80" class="difflineplus">+      in-&gt;SetAuthMethod(authMethod);</span>
<a href="#l54.81"></a><span id="l54.81"> </span>
<a href="#l54.82"></a><span id="l54.82">       in-&gt;SetDoBiff(checkNewMail);</span>
<a href="#l54.83"></a><span id="l54.83">       in-&gt;SetBiffMinutes(checkNewMailTime);</span>
<a href="#l54.84"></a><span id="l54.84"> </span>
<a href="#l54.85"></a><span id="l54.85">       IMPORT_LOG2(&quot;Created IMAP server named: %s, userName: %s\n&quot;,</span>
<a href="#l54.86"></a><span id="l54.86">                    pServerName, pUserName);</span>
<a href="#l54.87"></a><span id="l54.87"> </span>
<a href="#l54.88"></a><span id="l54.88">       nsString prettyName;</span>
<a href="#l54.89"></a><span id="l54.89" class="difflineat">@@ -474,48 +475,48 @@ PRBool OESettings::DoIMAPServer( nsIMsgA</span>
<a href="#l54.90"></a><span id="l54.90">       nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l54.91"></a><span id="l54.91">       rv = pMgr-&gt;CreateAccount(getter_AddRefs( account));</span>
<a href="#l54.92"></a><span id="l54.92">       if (NS_SUCCEEDED( rv) &amp;&amp; account) {</span>
<a href="#l54.93"></a><span id="l54.93">         rv = account-&gt;SetIncomingServer(in);</span>
<a href="#l54.94"></a><span id="l54.94"> </span>
<a href="#l54.95"></a><span id="l54.95">         IMPORT_LOG0(&quot;Created an account and set the IMAP server as the incoming server\n&quot;);</span>
<a href="#l54.96"></a><span id="l54.96"> </span>
<a href="#l54.97"></a><span id="l54.97">         // Fiddle with the identities</span>
<a href="#l54.98"></a><span id="l54.98" class="difflineminus">-        SetIdentities(pMgr, account, hKey, pUserName, useSecAuth, PR_FALSE);</span>
<a href="#l54.99"></a><span id="l54.99" class="difflineplus">+        SetIdentities(pMgr, account, hKey, pUserName, authMethod, PR_FALSE);</span>
<a href="#l54.100"></a><span id="l54.100">         result = PR_TRUE;</span>
<a href="#l54.101"></a><span id="l54.101">         if (ppAccount)</span>
<a href="#l54.102"></a><span id="l54.102">           account-&gt;QueryInterface(NS_GET_IID(nsIMsgAccount), (void **)ppAccount);</span>
<a href="#l54.103"></a><span id="l54.103">       }</span>
<a href="#l54.104"></a><span id="l54.104">     }</span>
<a href="#l54.105"></a><span id="l54.105">   }</span>
<a href="#l54.106"></a><span id="l54.106">   else if (NS_SUCCEEDED(rv) &amp;&amp; in) {</span>
<a href="#l54.107"></a><span id="l54.107">     // for an existing server we create another identity,</span>
<a href="#l54.108"></a><span id="l54.108">     //  TB lists under 'manage identities'</span>
<a href="#l54.109"></a><span id="l54.109">     nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l54.110"></a><span id="l54.110">     rv = pMgr-&gt;FindAccountForServer(in, getter_AddRefs( account));</span>
<a href="#l54.111"></a><span id="l54.111">     if (NS_SUCCEEDED( rv) &amp;&amp; account) {</span>
<a href="#l54.112"></a><span id="l54.112">       IMPORT_LOG0(&quot;Created an identity and added to existing IMAP incoming server\n&quot;);</span>
<a href="#l54.113"></a><span id="l54.113">       // Fiddle with the identities</span>
<a href="#l54.114"></a><span id="l54.114" class="difflineminus">-      in-&gt;GetUseSecAuth(&amp;useSecAuth);</span>
<a href="#l54.115"></a><span id="l54.115" class="difflineminus">-      SetIdentities(pMgr, account, hKey, pUserName, useSecAuth, PR_FALSE);</span>
<a href="#l54.116"></a><span id="l54.116" class="difflineplus">+      in-&gt;GetAuthMethod(&amp;authMethod);</span>
<a href="#l54.117"></a><span id="l54.117" class="difflineplus">+      SetIdentities(pMgr, account, hKey, pUserName, authMethod, PR_FALSE);</span>
<a href="#l54.118"></a><span id="l54.118">       result = PR_TRUE;</span>
<a href="#l54.119"></a><span id="l54.119">       if (ppAccount)</span>
<a href="#l54.120"></a><span id="l54.120">         account-&gt;QueryInterface(NS_GET_IID(nsIMsgAccount),</span>
<a href="#l54.121"></a><span id="l54.121">                                  (void **)ppAccount);</span>
<a href="#l54.122"></a><span id="l54.122">     }</span>
<a href="#l54.123"></a><span id="l54.123">   }</span>
<a href="#l54.124"></a><span id="l54.124">   else</span>
<a href="#l54.125"></a><span id="l54.125">     result = PR_TRUE;</span>
<a href="#l54.126"></a><span id="l54.126">   nsOERegUtil::FreeValueBytes((BYTE *) pUserName);</span>
<a href="#l54.127"></a><span id="l54.127">   return( result);</span>
<a href="#l54.128"></a><span id="l54.128"> }</span>
<a href="#l54.129"></a><span id="l54.129"> </span>
<a href="#l54.130"></a><span id="l54.130"> PRBool OESettings::DoPOP3Server( nsIMsgAccountManager *pMgr, HKEY hKey, char *pServerName, nsIMsgAccount **ppAccount)</span>
<a href="#l54.131"></a><span id="l54.131"> {</span>
<a href="#l54.132"></a><span id="l54.132" class="difflineminus">-  PRBool useSecAuth;    // Secure Password Authentication</span>
<a href="#l54.133"></a><span id="l54.133" class="difflineplus">+  PRInt32 authMethod;    // Secure Password Authentication</span>
<a href="#l54.134"></a><span id="l54.134">   if (ppAccount)</span>
<a href="#l54.135"></a><span id="l54.135">     *ppAccount = nsnull;</span>
<a href="#l54.136"></a><span id="l54.136"> </span>
<a href="#l54.137"></a><span id="l54.137">   char * pUserName;</span>
<a href="#l54.138"></a><span id="l54.138">   pUserName = (char *)nsOERegUtil::GetValueBytes( hKey, &quot;POP3 User Name&quot;);</span>
<a href="#l54.139"></a><span id="l54.139">   if (!pUserName)</span>
<a href="#l54.140"></a><span id="l54.140">     return( PR_FALSE);</span>
<a href="#l54.141"></a><span id="l54.141"> </span>
<a href="#l54.142"></a><span id="l54.142" class="difflineat">@@ -533,38 +534,39 @@ PRBool OESettings::DoPOP3Server( nsIMsgA</span>
<a href="#l54.143"></a><span id="l54.143">                                     nsDependentCString(pServerName),</span>
<a href="#l54.144"></a><span id="l54.144">                                     NS_LITERAL_CSTRING(&quot;pop3&quot;),</span>
<a href="#l54.145"></a><span id="l54.145">                                     getter_AddRefs( in));</span>
<a href="#l54.146"></a><span id="l54.146">     if (NS_SUCCEEDED( rv) &amp;&amp; in) {</span>
<a href="#l54.147"></a><span id="l54.147">       BYTE * pSecureConnection = nsOERegUtil::GetValueBytes( hKey, &quot;POP3 Secure Connection&quot;);</span>
<a href="#l54.148"></a><span id="l54.148">       if (pSecureConnection)</span>
<a href="#l54.149"></a><span id="l54.149">       {</span>
<a href="#l54.150"></a><span id="l54.150">         if (*pSecureConnection)</span>
<a href="#l54.151"></a><span id="l54.151" class="difflineminus">-          in-&gt;SetSocketType(nsIMsgIncomingServer::useSSL);</span>
<a href="#l54.152"></a><span id="l54.152" class="difflineplus">+          in-&gt;SetSocketType(nsMsgSocketType::SSL);</span>
<a href="#l54.153"></a><span id="l54.153">         nsOERegUtil::FreeValueBytes(pSecureConnection);</span>
<a href="#l54.154"></a><span id="l54.154">       }</span>
<a href="#l54.155"></a><span id="l54.155"> </span>
<a href="#l54.156"></a><span id="l54.156">       BYTE * pPort = nsOERegUtil::GetValueBytes( hKey, &quot;POP3 Port&quot;);</span>
<a href="#l54.157"></a><span id="l54.157">       if (pPort)</span>
<a href="#l54.158"></a><span id="l54.158">       {</span>
<a href="#l54.159"></a><span id="l54.159">         in-&gt;SetPort(*(PRInt32 *) pPort);</span>
<a href="#l54.160"></a><span id="l54.160">         nsOERegUtil::FreeValueBytes(pPort);</span>
<a href="#l54.161"></a><span id="l54.161">       }</span>
<a href="#l54.162"></a><span id="l54.162"> </span>
<a href="#l54.163"></a><span id="l54.163">       BYTE * pBytesTemp = nsOERegUtil::GetValueBytes( hKey, &quot;POP3 Use Sicily&quot;);</span>
<a href="#l54.164"></a><span id="l54.164">       if (pBytesTemp)</span>
<a href="#l54.165"></a><span id="l54.165">       {</span>
<a href="#l54.166"></a><span id="l54.166" class="difflineminus">-        in-&gt;SetUseSecAuth(*(PRBool *)pBytesTemp );</span>
<a href="#l54.167"></a><span id="l54.167" class="difflineminus">-        useSecAuth = *(PRBool *)pBytesTemp;</span>
<a href="#l54.168"></a><span id="l54.168" class="difflineplus">+        PRBool secAuth = *(PRBool *)pBytesTemp;</span>
<a href="#l54.169"></a><span id="l54.169">         nsOERegUtil::FreeValueBytes(pBytesTemp);</span>
<a href="#l54.170"></a><span id="l54.170" class="difflineplus">+        authMethod = secAuth ? nsMsgAuthMethod::secure</span>
<a href="#l54.171"></a><span id="l54.171" class="difflineplus">+            : nsMsgAuthMethod::passwordCleartext;</span>
<a href="#l54.172"></a><span id="l54.172">       }</span>
<a href="#l54.173"></a><span id="l54.173">       else {</span>
<a href="#l54.174"></a><span id="l54.174" class="difflineminus">-        in-&gt;SetUseSecAuth( PR_FALSE);</span>
<a href="#l54.175"></a><span id="l54.175" class="difflineminus">-        useSecAuth = PR_FALSE;</span>
<a href="#l54.176"></a><span id="l54.176" class="difflineplus">+        authMethod = nsMsgAuthMethod::passwordCleartext;</span>
<a href="#l54.177"></a><span id="l54.177">       }</span>
<a href="#l54.178"></a><span id="l54.178" class="difflineplus">+      in-&gt;SetAuthMethod(authMethod);</span>
<a href="#l54.179"></a><span id="l54.179"> </span>
<a href="#l54.180"></a><span id="l54.180">       in-&gt;SetDoBiff(checkNewMail);</span>
<a href="#l54.181"></a><span id="l54.181">       in-&gt;SetBiffMinutes(checkNewMailTime);</span>
<a href="#l54.182"></a><span id="l54.182">       nsCOMPtr&lt;nsIPop3IncomingServer&gt; pop3Server = do_QueryInterface(in);</span>
<a href="#l54.183"></a><span id="l54.183">       if (pop3Server) {</span>
<a href="#l54.184"></a><span id="l54.184">         // set local folders as the Inbox to use for this POP3 server</span>
<a href="#l54.185"></a><span id="l54.185">         nsCOMPtr&lt;nsIMsgIncomingServer&gt; localFoldersServer;</span>
<a href="#l54.186"></a><span id="l54.186">         pMgr-&gt;GetLocalFoldersServer(getter_AddRefs(localFoldersServer));</span>
<a href="#l54.187"></a><span id="l54.187" class="difflineat">@@ -635,17 +637,17 @@ PRBool OESettings::DoPOP3Server( nsIMsgA</span>
<a href="#l54.188"></a><span id="l54.188">       // We have a server, create an account.</span>
<a href="#l54.189"></a><span id="l54.189">       nsCOMPtr&lt;nsIMsgAccount&gt;  account;</span>
<a href="#l54.190"></a><span id="l54.190">       rv = pMgr-&gt;CreateAccount(getter_AddRefs( account));</span>
<a href="#l54.191"></a><span id="l54.191">       if (NS_SUCCEEDED( rv) &amp;&amp; account) {</span>
<a href="#l54.192"></a><span id="l54.192">         rv = account-&gt;SetIncomingServer(in);</span>
<a href="#l54.193"></a><span id="l54.193">         IMPORT_LOG0(&quot;Created a new account and set the incoming server to the POP3 server.\n&quot;);</span>
<a href="#l54.194"></a><span id="l54.194"> </span>
<a href="#l54.195"></a><span id="l54.195">         // Fiddle with the identities</span>
<a href="#l54.196"></a><span id="l54.196" class="difflineminus">-        SetIdentities(pMgr, account, hKey, pUserName, useSecAuth, PR_FALSE);</span>
<a href="#l54.197"></a><span id="l54.197" class="difflineplus">+        SetIdentities(pMgr, account, hKey, pUserName, authMethod, PR_FALSE);</span>
<a href="#l54.198"></a><span id="l54.198">         result = PR_TRUE;</span>
<a href="#l54.199"></a><span id="l54.199">         if (ppAccount)</span>
<a href="#l54.200"></a><span id="l54.200">           account-&gt;QueryInterface(NS_GET_IID(nsIMsgAccount),</span>
<a href="#l54.201"></a><span id="l54.201">                                    (void **)ppAccount);</span>
<a href="#l54.202"></a><span id="l54.202">       }</span>
<a href="#l54.203"></a><span id="l54.203">     }</span>
<a href="#l54.204"></a><span id="l54.204">   } </span>
<a href="#l54.205"></a><span id="l54.205">   else if (NS_SUCCEEDED(rv) &amp;&amp; in) {</span>
<a href="#l54.206"></a><span id="l54.206" class="difflineat">@@ -653,18 +655,18 @@ PRBool OESettings::DoPOP3Server( nsIMsgA</span>
<a href="#l54.207"></a><span id="l54.207">                 pServerName, pUserName);</span>
<a href="#l54.208"></a><span id="l54.208">     // for an existing server we create another identity,</span>
<a href="#l54.209"></a><span id="l54.209">     // TB listed under 'manage identities'</span>
<a href="#l54.210"></a><span id="l54.210">     nsCOMPtr&lt;nsIMsgAccount&gt;  account;</span>
<a href="#l54.211"></a><span id="l54.211">     rv = pMgr-&gt;FindAccountForServer(in, getter_AddRefs( account));</span>
<a href="#l54.212"></a><span id="l54.212">     if (NS_SUCCEEDED(rv) &amp;&amp; account) {</span>
<a href="#l54.213"></a><span id="l54.213">       IMPORT_LOG0(&quot;Created identity and added to existing POP3 incoming server.\n&quot;);</span>
<a href="#l54.214"></a><span id="l54.214">       // Fiddle with the identities</span>
<a href="#l54.215"></a><span id="l54.215" class="difflineminus">-      in-&gt;GetUseSecAuth(&amp;useSecAuth);</span>
<a href="#l54.216"></a><span id="l54.216" class="difflineminus">-      SetIdentities(pMgr, account, hKey, pUserName, useSecAuth, PR_FALSE);</span>
<a href="#l54.217"></a><span id="l54.217" class="difflineplus">+      in-&gt;GetAuthMethod(&amp;authMethod);</span>
<a href="#l54.218"></a><span id="l54.218" class="difflineplus">+      SetIdentities(pMgr, account, hKey, pUserName, authMethod, PR_FALSE);</span>
<a href="#l54.219"></a><span id="l54.219">       result = PR_TRUE;</span>
<a href="#l54.220"></a><span id="l54.220">       if (ppAccount)</span>
<a href="#l54.221"></a><span id="l54.221">         account-&gt;QueryInterface(NS_GET_IID(nsIMsgAccount), (void **)ppAccount);</span>
<a href="#l54.222"></a><span id="l54.222">     }</span>
<a href="#l54.223"></a><span id="l54.223">   }</span>
<a href="#l54.224"></a><span id="l54.224">   else</span>
<a href="#l54.225"></a><span id="l54.225">     result = PR_TRUE;</span>
<a href="#l54.226"></a><span id="l54.226">   nsOERegUtil::FreeValueBytes((BYTE *) pUserName);</span>
<a href="#l54.227"></a><span id="l54.227" class="difflineat">@@ -749,17 +751,17 @@ PRBool OESettings::DoNNTPServer( nsIMsgA</span>
<a href="#l54.228"></a><span id="l54.228">   else</span>
<a href="#l54.229"></a><span id="l54.229">     result = PR_TRUE;</span>
<a href="#l54.230"></a><span id="l54.230">   nsOERegUtil::FreeValueBytes((BYTE *) pUserName);</span>
<a href="#l54.231"></a><span id="l54.231">   return result;</span>
<a href="#l54.232"></a><span id="l54.232"> }</span>
<a href="#l54.233"></a><span id="l54.233"> </span>
<a href="#l54.234"></a><span id="l54.234"> void OESettings::SetIdentities(nsIMsgAccountManager *pMgr, nsIMsgAccount *pAcc,</span>
<a href="#l54.235"></a><span id="l54.235">                                HKEY hKey, char *pIncomgUserName,</span>
<a href="#l54.236"></a><span id="l54.236" class="difflineminus">-                               PRBool useSecAuth, PRBool isNNTP )</span>
<a href="#l54.237"></a><span id="l54.237" class="difflineplus">+                               PRInt32 authMethodIncoming, PRBool isNNTP )</span>
<a href="#l54.238"></a><span id="l54.238"> {</span>
<a href="#l54.239"></a><span id="l54.239">   // Get the relevant information for an identity</span>
<a href="#l54.240"></a><span id="l54.240">   char *pSmtpServer = (char *)nsOERegUtil::GetValueBytes(hKey, &quot;SMTP Server&quot;);</span>
<a href="#l54.241"></a><span id="l54.241">   char *pName = (char *)nsOERegUtil::GetValueBytes(hKey, isNNTP ? &quot;NNTP Display Name&quot; : &quot;SMTP Display Name&quot;);</span>
<a href="#l54.242"></a><span id="l54.242">   char *pEmail = (char *)nsOERegUtil::GetValueBytes(hKey, isNNTP ? &quot;NNTP Email Address&quot; : &quot;SMTP Email Address&quot;);</span>
<a href="#l54.243"></a><span id="l54.243">   char *pReply = (char *)nsOERegUtil::GetValueBytes(hKey, isNNTP ? &quot;NNTP Reply To Email Address&quot; : &quot;SMTP Reply To Email Address&quot;);</span>
<a href="#l54.244"></a><span id="l54.244">   char *pOrgName = (char *)nsOERegUtil::GetValueBytes(hKey, isNNTP ? &quot;NNTP Organization Name&quot; : &quot;SMTP Organization Name&quot;);</span>
<a href="#l54.245"></a><span id="l54.245"> </span>
<a href="#l54.246"></a><span id="l54.246" class="difflineat">@@ -789,27 +791,27 @@ void OESettings::SetIdentities(nsIMsgAcc</span>
<a href="#l54.247"></a><span id="l54.247">       pAcc-&gt;AddIdentity(id);</span>
<a href="#l54.248"></a><span id="l54.248"> </span>
<a href="#l54.249"></a><span id="l54.249">       IMPORT_LOG0(&quot;Created identity and added to the account\n&quot;);</span>
<a href="#l54.250"></a><span id="l54.250">       IMPORT_LOG1(&quot;\tname: %s\n&quot;, pName);</span>
<a href="#l54.251"></a><span id="l54.251">       IMPORT_LOG1(&quot;\temail: %s\n&quot;, pEmail);</span>
<a href="#l54.252"></a><span id="l54.252">     }</span>
<a href="#l54.253"></a><span id="l54.253"> </span>
<a href="#l54.254"></a><span id="l54.254">   if (!isNNTP)  // NNTP does not use SMTP in OE or TB</span>
<a href="#l54.255"></a><span id="l54.255" class="difflineminus">-    SetSmtpServer( pSmtpServer, hKey, id, pIncomgUserName, useSecAuth);</span>
<a href="#l54.256"></a><span id="l54.256" class="difflineplus">+    SetSmtpServer(pSmtpServer, hKey, id, pIncomgUserName, authMethodIncoming);</span>
<a href="#l54.257"></a><span id="l54.257"> </span>
<a href="#l54.258"></a><span id="l54.258">   nsOERegUtil::FreeValueBytes((BYTE *)pName);</span>
<a href="#l54.259"></a><span id="l54.259">   nsOERegUtil::FreeValueBytes((BYTE *)pSmtpServer);</span>
<a href="#l54.260"></a><span id="l54.260">   nsOERegUtil::FreeValueBytes((BYTE *)pEmail);</span>
<a href="#l54.261"></a><span id="l54.261">   nsOERegUtil::FreeValueBytes((BYTE *)pReply);</span>
<a href="#l54.262"></a><span id="l54.262"> }</span>
<a href="#l54.263"></a><span id="l54.263"> </span>
<a href="#l54.264"></a><span id="l54.264"> void OESettings::SetSmtpServer(char *pSmtpServer, HKEY hKey,</span>
<a href="#l54.265"></a><span id="l54.265">                                nsIMsgIdentity *id, char *pIncomgUserName,</span>
<a href="#l54.266"></a><span id="l54.266" class="difflineminus">-                               PRBool useSecAuth)</span>
<a href="#l54.267"></a><span id="l54.267" class="difflineplus">+                               PRInt32 authMethodIncoming)</span>
<a href="#l54.268"></a><span id="l54.268"> {</span>
<a href="#l54.269"></a><span id="l54.269">   // set the id.smtpserver accordingly</span>
<a href="#l54.270"></a><span id="l54.270">   // first we have to calculate the smtp user name which is based on sicily</span>
<a href="#l54.271"></a><span id="l54.271">   if (!hKey || !id || !pIncomgUserName || !pSmtpServer)</span>
<a href="#l54.272"></a><span id="l54.272">     return;</span>
<a href="#l54.273"></a><span id="l54.273">   nsCString smtpServerKey, userName;</span>
<a href="#l54.274"></a><span id="l54.274">   BYTE *pBytes;</span>
<a href="#l54.275"></a><span id="l54.275">   // smtp user name depends on sicily which may or not exist</span>
<a href="#l54.276"></a><span id="l54.276" class="difflineat">@@ -858,38 +860,34 @@ void OESettings::SetSmtpServer(char *pSm</span>
<a href="#l54.277"></a><span id="l54.277">         {</span>
<a href="#l54.278"></a><span id="l54.278">           smtpServer-&gt;SetPort(*(PRInt32 *) pBytes);</span>
<a href="#l54.279"></a><span id="l54.279">           nsOERegUtil::FreeValueBytes(pBytes);</span>
<a href="#l54.280"></a><span id="l54.280">         }</span>
<a href="#l54.281"></a><span id="l54.281">         pBytes = nsOERegUtil::GetValueBytes(hKey,&quot;SMTP Secure Connection&quot;);</span>
<a href="#l54.282"></a><span id="l54.282">         if (pBytes)</span>
<a href="#l54.283"></a><span id="l54.283">         {</span>
<a href="#l54.284"></a><span id="l54.284">           if (*(PRInt32 *)pBytes == 1)</span>
<a href="#l54.285"></a><span id="l54.285" class="difflineminus">-            smtpServer-&gt;SetTrySSL(nsIMsgIncomingServer::useSSL);</span>
<a href="#l54.286"></a><span id="l54.286" class="difflineplus">+            smtpServer-&gt;SetSocketType(nsMsgSocketType::SSL);</span>
<a href="#l54.287"></a><span id="l54.287">           else</span>
<a href="#l54.288"></a><span id="l54.288" class="difflineminus">-            smtpServer-&gt;SetTrySSL(nsIMsgIncomingServer::defaultSocket);</span>
<a href="#l54.289"></a><span id="l54.289" class="difflineplus">+            smtpServer-&gt;SetSocketType(nsMsgSocketType::plain);</span>
<a href="#l54.290"></a><span id="l54.290">           nsOERegUtil::FreeValueBytes(pBytes);</span>
<a href="#l54.291"></a><span id="l54.291">         }</span>
<a href="#l54.292"></a><span id="l54.292">         smtpServer-&gt;SetUsername(userName);</span>
<a href="#l54.293"></a><span id="l54.293">         switch (useSicily) {</span>
<a href="#l54.294"></a><span id="l54.294">           case 1 :</span>
<a href="#l54.295"></a><span id="l54.295" class="difflineminus">-            smtpServer-&gt;SetAuthMethod(1);</span>
<a href="#l54.296"></a><span id="l54.296" class="difflineminus">-            smtpServer-&gt;SetUseSecAuth(PR_TRUE);  // useSecAuth</span>
<a href="#l54.297"></a><span id="l54.297" class="difflineplus">+            smtpServer-&gt;SetAuthMethod(nsMsgAuthMethod::secure);</span>
<a href="#l54.298"></a><span id="l54.298">             break;</span>
<a href="#l54.299"></a><span id="l54.299" class="difflineminus">-          case 2 : // requires authentication use incoming settings</span>
<a href="#l54.300"></a><span id="l54.300" class="difflineminus">-            smtpServer-&gt;SetAuthMethod(1);</span>
<a href="#l54.301"></a><span id="l54.301" class="difflineminus">-            smtpServer-&gt;SetUseSecAuth(useSecAuth);</span>
<a href="#l54.302"></a><span id="l54.302" class="difflineplus">+          case 2 : // requires SMTP authentication to use the incoming server settings</span>
<a href="#l54.303"></a><span id="l54.303" class="difflineplus">+            smtpServer-&gt;SetAuthMethod(authMethodIncoming);</span>
<a href="#l54.304"></a><span id="l54.304">             break;</span>
<a href="#l54.305"></a><span id="l54.305">           case 3 :</span>
<a href="#l54.306"></a><span id="l54.306" class="difflineminus">-            smtpServer-&gt;SetAuthMethod(1);</span>
<a href="#l54.307"></a><span id="l54.307" class="difflineminus">-            smtpServer-&gt;SetUseSecAuth(PR_FALSE);</span>
<a href="#l54.308"></a><span id="l54.308" class="difflineplus">+            smtpServer-&gt;SetAuthMethod(nsMsgAuthMethod::passwordCleartext);</span>
<a href="#l54.309"></a><span id="l54.309">             break;</span>
<a href="#l54.310"></a><span id="l54.310">           default:</span>
<a href="#l54.311"></a><span id="l54.311" class="difflineminus">-            smtpServer-&gt;SetAuthMethod(0);</span>
<a href="#l54.312"></a><span id="l54.312" class="difflineminus">-            smtpServer-&gt;SetUseSecAuth(PR_FALSE);</span>
<a href="#l54.313"></a><span id="l54.313" class="difflineplus">+            smtpServer-&gt;SetAuthMethod(nsMsgAuthMethod::none);</span>
<a href="#l54.314"></a><span id="l54.314">         }</span>
<a href="#l54.315"></a><span id="l54.315"> </span>
<a href="#l54.316"></a><span id="l54.316">         smtpServer-&gt;SetHostname(nsDependentCString(pSmtpServer));</span>
<a href="#l54.317"></a><span id="l54.317"> </span>
<a href="#l54.318"></a><span id="l54.318">         smtpServer-&gt;GetKey(getter_Copies(smtpServerKey));</span>
<a href="#l54.319"></a><span id="l54.319">         id-&gt;SetSmtpServerKey(smtpServerKey);</span>
<a href="#l54.320"></a><span id="l54.320"> </span>
<a href="#l54.321"></a><span id="l54.321">         IMPORT_LOG1(&quot;Created new SMTP server: %s\n&quot;, pSmtpServer);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookSettings.cpp</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookSettings.cpp</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineat">@@ -303,18 +303,17 @@ PRBool OutlookSettings::DoIMAPServer( ns</span>
<a href="#l55.4"></a><span id="l55.4">   // I now have a user name/server name pair, find out if it already exists?</span>
<a href="#l55.5"></a><span id="l55.5">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; in;</span>
<a href="#l55.6"></a><span id="l55.6">   nsresult rv = pMgr-&gt;FindServer( nsDependentCString((const char *)pBytes), nsDependentCString(pServerName), NS_LITERAL_CSTRING(&quot;imap&quot;), getter_AddRefs( in));</span>
<a href="#l55.7"></a><span id="l55.7">   if (NS_FAILED( rv) || (in == nsnull)) {</span>
<a href="#l55.8"></a><span id="l55.8">     // Create the incoming server and an account for it?</span>
<a href="#l55.9"></a><span id="l55.9">     rv = pMgr-&gt;CreateIncomingServer( nsDependentCString((const char *)pBytes), nsDependentCString(pServerName), NS_LITERAL_CSTRING(&quot;imap&quot;), getter_AddRefs( in));</span>
<a href="#l55.10"></a><span id="l55.10">     if (NS_SUCCEEDED( rv) &amp;&amp; in) {</span>
<a href="#l55.11"></a><span id="l55.11">       rv = in-&gt;SetType(NS_LITERAL_CSTRING(&quot;imap&quot;));</span>
<a href="#l55.12"></a><span id="l55.12" class="difflineminus">-      // rv = in-&gt;SetHostName( pServerName);</span>
<a href="#l55.13"></a><span id="l55.13" class="difflineminus">-      // rv = in-&gt;SetUsername( (char *)pBytes);</span>
<a href="#l55.14"></a><span id="l55.14" class="difflineplus">+      // TODO SSL, auth method</span>
<a href="#l55.15"></a><span id="l55.15"> </span>
<a href="#l55.16"></a><span id="l55.16">       IMPORT_LOG2( &quot;Created IMAP server named: %s, userName: %s\n&quot;, pServerName, (char *)pBytes);</span>
<a href="#l55.17"></a><span id="l55.17"> </span>
<a href="#l55.18"></a><span id="l55.18">       nsString prettyName;</span>
<a href="#l55.19"></a><span id="l55.19">       if (NS_SUCCEEDED(GetAccountName(hKey, pServerName, prettyName)))</span>
<a href="#l55.20"></a><span id="l55.20">         rv = in-&gt;SetPrettyName( prettyName);</span>
<a href="#l55.21"></a><span id="l55.21">       // We have a server, create an account.</span>
<a href="#l55.22"></a><span id="l55.22">       nsCOMPtr&lt;nsIMsgAccount&gt;  account;</span>
<a href="#l55.23"></a><span id="l55.23" class="difflineat">@@ -356,16 +355,18 @@ PRBool OutlookSettings::DoPOP3Server( ns</span>
<a href="#l55.24"></a><span id="l55.24">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; in;</span>
<a href="#l55.25"></a><span id="l55.25">   nsresult rv = pMgr-&gt;FindServer( nsDependentCString((const char *)pBytes), nsDependentCString(pServerName), NS_LITERAL_CSTRING(&quot;pop3&quot;), getter_AddRefs( in));</span>
<a href="#l55.26"></a><span id="l55.26">   if (NS_FAILED( rv) || (in == nsnull)) {</span>
<a href="#l55.27"></a><span id="l55.27">     // Create the incoming server and an account for it?</span>
<a href="#l55.28"></a><span id="l55.28">     rv = pMgr-&gt;CreateIncomingServer(nsDependentCString((const char *)pBytes), nsDependentCString(pServerName), NS_LITERAL_CSTRING(&quot;pop3&quot;), getter_AddRefs( in));</span>
<a href="#l55.29"></a><span id="l55.29">     if (NS_SUCCEEDED( rv) &amp;&amp; in) {</span>
<a href="#l55.30"></a><span id="l55.30">       rv = in-&gt;SetType(NS_LITERAL_CSTRING(&quot;pop3&quot;));</span>
<a href="#l55.31"></a><span id="l55.31"> </span>
<a href="#l55.32"></a><span id="l55.32" class="difflineplus">+      // TODO SSL, auth method</span>
<a href="#l55.33"></a><span id="l55.33" class="difflineplus">+</span>
<a href="#l55.34"></a><span id="l55.34">         nsCOMPtr&lt;nsIPop3IncomingServer&gt; pop3Server = do_QueryInterface(in);</span>
<a href="#l55.35"></a><span id="l55.35">         if (pop3Server) {</span>
<a href="#l55.36"></a><span id="l55.36">             // set local folders as the Inbox to use for this POP3 server</span>
<a href="#l55.37"></a><span id="l55.37">             nsCOMPtr&lt;nsIMsgIncomingServer&gt; localFoldersServer;</span>
<a href="#l55.38"></a><span id="l55.38">             pMgr-&gt;GetLocalFoldersServer(getter_AddRefs(localFoldersServer));</span>
<a href="#l55.39"></a><span id="l55.39"> </span>
<a href="#l55.40"></a><span id="l55.40">             if (!localFoldersServer)</span>
<a href="#l55.41"></a><span id="l55.41">             {</span>
<a href="#l55.42"></a><span id="l55.42" class="difflineat">@@ -537,13 +538,14 @@ void OutlookSettings::SetSmtpServer(nsIM</span>
<a href="#l55.43"></a><span id="l55.43">       return;</span>
<a href="#l55.44"></a><span id="l55.44">     }</span>
<a href="#l55.45"></a><span id="l55.45">     nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l55.46"></a><span id="l55.46">     rv = smtpService-&gt;CreateSmtpServer( getter_AddRefs( smtpServer));</span>
<a href="#l55.47"></a><span id="l55.47">     if (NS_SUCCEEDED( rv) &amp;&amp; smtpServer) {</span>
<a href="#l55.48"></a><span id="l55.48">       smtpServer-&gt;SetHostname(nsDependentCString(pServer));</span>
<a href="#l55.49"></a><span id="l55.49">       if (!user.IsEmpty())</span>
<a href="#l55.50"></a><span id="l55.50">         smtpServer-&gt;SetUsername(user);</span>
<a href="#l55.51"></a><span id="l55.51" class="difflineplus">+      // TODO SSL, auth method</span>
<a href="#l55.52"></a><span id="l55.52">       IMPORT_LOG1( &quot;Ceated new SMTP server: %s\n&quot;, pServer);</span>
<a href="#l55.53"></a><span id="l55.53">     }</span>
<a href="#l55.54"></a><span id="l55.54">   }</span>
<a href="#l55.55"></a><span id="l55.55"> }</span>
<a href="#l55.56"></a><span id="l55.56"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1" class="difflineminus">--- a/mailnews/local/public/nsIPop3IncomingServer.idl</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineplus">+++ b/mailnews/local/public/nsIPop3IncomingServer.idl</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineat">@@ -38,22 +38,21 @@</span>
<a href="#l56.4"></a><span id="l56.4"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l56.5"></a><span id="l56.5"> </span>
<a href="#l56.6"></a><span id="l56.6"> interface nsIPop3Protocol;</span>
<a href="#l56.7"></a><span id="l56.7"> interface nsISupportsArray;</span>
<a href="#l56.8"></a><span id="l56.8"> interface nsIMsgFolder;</span>
<a href="#l56.9"></a><span id="l56.9"> interface nsIUrlListener;</span>
<a href="#l56.10"></a><span id="l56.10"> interface nsIMsgWindow;</span>
<a href="#l56.11"></a><span id="l56.11"> </span>
<a href="#l56.12"></a><span id="l56.12" class="difflineminus">-[scriptable, uuid(FC67F5C9-C8BB-46c1-90CB-1E752ECCEB19)]</span>
<a href="#l56.13"></a><span id="l56.13" class="difflineplus">+[scriptable, uuid(98d50234-6c8a-4875-815b-40e0178a13bd)]</span>
<a href="#l56.14"></a><span id="l56.14"> interface nsIPop3IncomingServer : nsISupports {</span>
<a href="#l56.15"></a><span id="l56.15">   attribute boolean leaveMessagesOnServer;</span>
<a href="#l56.16"></a><span id="l56.16">   attribute boolean headersOnly;</span>
<a href="#l56.17"></a><span id="l56.17">   attribute boolean deleteMailLeftOnServer;</span>
<a href="#l56.18"></a><span id="l56.18" class="difflineminus">-  attribute boolean authLogin;</span>
<a href="#l56.19"></a><span id="l56.19">   attribute boolean dotFix;</span>
<a href="#l56.20"></a><span id="l56.20">   attribute unsigned long pop3CapabilityFlags;</span>
<a href="#l56.21"></a><span id="l56.21">   attribute boolean deleteByAgeFromServer;</span>
<a href="#l56.22"></a><span id="l56.22">   attribute long numDaysToLeaveOnServer;</span>
<a href="#l56.23"></a><span id="l56.23">   attribute nsIPop3Protocol runningProtocol;</span>
<a href="#l56.24"></a><span id="l56.24">   // client adds uidls to mark one by one, then calls markMessages</span>
<a href="#l56.25"></a><span id="l56.25">   void addUidlToMark(in string aUidl, in PRInt32 newStatus);</span>
<a href="#l56.26"></a><span id="l56.26">   void markMessages();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/mailnews/local/src/nsLocalStrings.h</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalStrings.h</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -21,24 +21,28 @@</span>
<a href="#l57.4"></a><span id="l57.4"> #define POP3_USERNAME_UNDEFINED                               4014</span>
<a href="#l57.5"></a><span id="l57.5"> #define POP3_LIST_FAILURE                                     4015</span>
<a href="#l57.6"></a><span id="l57.6"> #define POP3_DELE_FAILURE                                     4016</span>
<a href="#l57.7"></a><span id="l57.7"> #define POP3_STAT_FAILURE                                     4024</span>
<a href="#l57.8"></a><span id="l57.8"> #define POP3_SERVER_SAID                                      4025</span>
<a href="#l57.9"></a><span id="l57.9"> #define COPYING_MSGS_STATUS                                   4027</span>
<a href="#l57.10"></a><span id="l57.10"> #define MOVING_MSGS_STATUS                                    4028</span>
<a href="#l57.11"></a><span id="l57.11"> #define POP3_MESSAGE_FOLDER_BUSY                              4029</span>
<a href="#l57.12"></a><span id="l57.12" class="difflineminus">-#define CANNOT_PROCESS_SECURE_AUTH                            4030</span>
<a href="#l57.13"></a><span id="l57.13" class="difflineplus">+#define POP3_AUTH_MECH_NOT_SUPPORTED                          4030</span>
<a href="#l57.14"></a><span id="l57.14" class="difflineplus">+#define POP3_GSSAPI_FAILURE                                   4031</span>
<a href="#l57.15"></a><span id="l57.15"> #define MOVEMAIL_CANT_OPEN_SPOOL_FILE                         4033</span>
<a href="#l57.16"></a><span id="l57.16"> #define MOVEMAIL_CANT_CREATE_LOCK                             4034</span>
<a href="#l57.17"></a><span id="l57.17"> #define MOVEMAIL_CANT_DELETE_LOCK                             4035</span>
<a href="#l57.18"></a><span id="l57.18"> #define MOVEMAIL_CANT_TRUNCATE_SPOOL_FILE                     4036</span>
<a href="#l57.19"></a><span id="l57.19"> #define MOVEMAIL_SPOOL_FILE_NOT_FOUND                         4037</span>
<a href="#l57.20"></a><span id="l57.20"> #define POP3_TMP_DOWNLOAD_FAILED                              4038</span>
<a href="#l57.21"></a><span id="l57.21"> #define POP3_SERVER_DOES_NOT_SUPPORT_UIDL_ETC                 4040</span>
<a href="#l57.22"></a><span id="l57.22"> #define POP3_SERVER_DOES_NOT_SUPPORT_THE_TOP_COMMAND          4041</span>
<a href="#l57.23"></a><span id="l57.23" class="difflineminus">-#define CANNOT_PROCESS_APOP_AUTH                              4042</span>
<a href="#l57.24"></a><span id="l57.24"> #define NS_ERROR_COULD_NOT_CONNECT_VIA_TLS                    4043</span>
<a href="#l57.25"></a><span id="l57.25"> #define POP3_MOVE_FOLDER_TO_TRASH                             4044</span>
<a href="#l57.26"></a><span id="l57.26"> #define POP3_DELETE_FOLDER_DIALOG_TITLE                       4045</span>
<a href="#l57.27"></a><span id="l57.27"> #define POP3_DELETE_FOLDER_BUTTON_LABEL                       4046</span>
<a href="#l57.28"></a><span id="l57.28" class="difflineplus">+#define POP3_AUTH_INTERNAL_ERROR                              4047</span>
<a href="#l57.29"></a><span id="l57.29" class="difflineplus">+#define POP3_AUTH_CHANGE_ENCRYPT_TO_PLAIN_NO_SSL              4048</span>
<a href="#l57.30"></a><span id="l57.30" class="difflineplus">+#define POP3_AUTH_CHANGE_ENCRYPT_TO_PLAIN_SSL                 4049</span>
<a href="#l57.31"></a><span id="l57.31" class="difflineplus">+#define POP3_AUTH_CHANGE_PLAIN_TO_ENCRYPT                     4050</span>
<a href="#l57.32"></a><span id="l57.32"> </span>
<a href="#l57.33"></a><span id="l57.33"> #endif /* _nsLocalStrings_H__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1" class="difflineminus">--- a/mailnews/local/src/nsPop3IncomingServer.cpp</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3IncomingServer.cpp</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineat">@@ -108,20 +108,16 @@ NS_IMPL_SERVERPREF_BOOL(nsPop3IncomingSe</span>
<a href="#l58.4"></a><span id="l58.4">                         HeadersOnly,</span>
<a href="#l58.5"></a><span id="l58.5">                         &quot;headers_only&quot;)</span>
<a href="#l58.6"></a><span id="l58.6"> </span>
<a href="#l58.7"></a><span id="l58.7"> NS_IMPL_SERVERPREF_BOOL(nsPop3IncomingServer,</span>
<a href="#l58.8"></a><span id="l58.8">                         DeleteMailLeftOnServer,</span>
<a href="#l58.9"></a><span id="l58.9">                         &quot;delete_mail_left_on_server&quot;)</span>
<a href="#l58.10"></a><span id="l58.10"> </span>
<a href="#l58.11"></a><span id="l58.11"> NS_IMPL_SERVERPREF_BOOL(nsPop3IncomingServer,</span>
<a href="#l58.12"></a><span id="l58.12" class="difflineminus">-                        AuthLogin,</span>
<a href="#l58.13"></a><span id="l58.13" class="difflineminus">-                        &quot;auth_login&quot;)</span>
<a href="#l58.14"></a><span id="l58.14" class="difflineminus">-</span>
<a href="#l58.15"></a><span id="l58.15" class="difflineminus">-NS_IMPL_SERVERPREF_BOOL(nsPop3IncomingServer,</span>
<a href="#l58.16"></a><span id="l58.16">                         DotFix,</span>
<a href="#l58.17"></a><span id="l58.17">                         &quot;dot_fix&quot;)</span>
<a href="#l58.18"></a><span id="l58.18"> </span>
<a href="#l58.19"></a><span id="l58.19"> NS_IMPL_SERVERPREF_BOOL(nsPop3IncomingServer,</span>
<a href="#l58.20"></a><span id="l58.20">                         DeleteByAgeFromServer,</span>
<a href="#l58.21"></a><span id="l58.21">                         &quot;delete_by_age_from_server&quot;)</span>
<a href="#l58.22"></a><span id="l58.22"> </span>
<a href="#l58.23"></a><span id="l58.23"> NS_IMPL_SERVERPREF_INT(nsPop3IncomingServer,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Protocol.cpp</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Protocol.cpp</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineat">@@ -19,16 +19,17 @@</span>
<a href="#l59.4"></a><span id="l59.4">  * Netscape Communications Corporation.</span>
<a href="#l59.5"></a><span id="l59.5">  * Portions created by the Initial Developer are Copyright (C) 1998</span>
<a href="#l59.6"></a><span id="l59.6">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l59.7"></a><span id="l59.7">  *</span>
<a href="#l59.8"></a><span id="l59.8">  * Contributor(s):</span>
<a href="#l59.9"></a><span id="l59.9">  *   Howard Chu &lt;hyc@highlandsun.com&gt;</span>
<a href="#l59.10"></a><span id="l59.10">  *   David Bienvenu &lt;bienvenu@nventure.com&gt;</span>
<a href="#l59.11"></a><span id="l59.11">  *   Christian Eyrich &lt;ch.ey@gmx.net&gt;</span>
<a href="#l59.12"></a><span id="l59.12" class="difflineplus">+ *   Ben Bucksch &lt;ben.bucksch beonex.com&gt; &lt;http://business.beonex.com&gt;</span>
<a href="#l59.13"></a><span id="l59.13">  *</span>
<a href="#l59.14"></a><span id="l59.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l59.15"></a><span id="l59.15">  * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l59.16"></a><span id="l59.16">  * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l59.17"></a><span id="l59.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l59.18"></a><span id="l59.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l59.19"></a><span id="l59.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l59.20"></a><span id="l59.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l59.21"></a><span id="l59.21" class="difflineat">@@ -67,19 +68,16 @@</span>
<a href="#l59.22"></a><span id="l59.22"> #include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l59.23"></a><span id="l59.23"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l59.24"></a><span id="l59.24"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l59.25"></a><span id="l59.25"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l59.26"></a><span id="l59.26"> #include &quot;nsIMsgFolder.h&quot; // TO include biffState enum. Change to bool later...</span>
<a href="#l59.27"></a><span id="l59.27"> #include &quot;nsIDocShell.h&quot;</span>
<a href="#l59.28"></a><span id="l59.28"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l59.29"></a><span id="l59.29"> #include &quot;nsISignatureVerifier.h&quot;</span>
<a href="#l59.30"></a><span id="l59.30" class="difflineminus">-#include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l59.31"></a><span id="l59.31" class="difflineminus">-#include &quot;nsIPrefService.h&quot;</span>
<a href="#l59.32"></a><span id="l59.32" class="difflineminus">-#include &quot;nsIPrefLocalizedString.h&quot;</span>
<a href="#l59.33"></a><span id="l59.33"> #include &quot;nsISocketTransport.h&quot;</span>
<a href="#l59.34"></a><span id="l59.34"> #include &quot;nsISSLSocketControl.h&quot;</span>
<a href="#l59.35"></a><span id="l59.35"> #include &quot;nsILineInputStream.h&quot;</span>
<a href="#l59.36"></a><span id="l59.36"> #include &quot;nsLocalStrings.h&quot;</span>
<a href="#l59.37"></a><span id="l59.37"> #include &quot;nsIInterfaceRequestor.h&quot;</span>
<a href="#l59.38"></a><span id="l59.38"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l59.39"></a><span id="l59.39"> </span>
<a href="#l59.40"></a><span id="l59.40"> #define EXTRA_SAFETY_SPACE 3096</span>
<a href="#l59.41"></a><span id="l59.41" class="difflineat">@@ -489,58 +487,65 @@ nsPop3Protocol::nsPop3Protocol(nsIURI* a</span>
<a href="#l59.42"></a><span id="l59.42">   m_pop3ConData(nsnull),</span>
<a href="#l59.43"></a><span id="l59.43">   m_password_already_sent(PR_FALSE)</span>
<a href="#l59.44"></a><span id="l59.44"> {</span>
<a href="#l59.45"></a><span id="l59.45"> }</span>
<a href="#l59.46"></a><span id="l59.46"> </span>
<a href="#l59.47"></a><span id="l59.47"> nsresult nsPop3Protocol::Initialize(nsIURI * aURL)</span>
<a href="#l59.48"></a><span id="l59.48"> {</span>
<a href="#l59.49"></a><span id="l59.49">   nsresult rv = NS_OK;</span>
<a href="#l59.50"></a><span id="l59.50" class="difflineplus">+  if (!POP3LOGMODULE)</span>
<a href="#l59.51"></a><span id="l59.51" class="difflineplus">+    POP3LOGMODULE = PR_NewLogModule(&quot;POP3&quot;);</span>
<a href="#l59.52"></a><span id="l59.52"> </span>
<a href="#l59.53"></a><span id="l59.53">   m_pop3ConData = (Pop3ConData *)PR_NEWZAP(Pop3ConData);</span>
<a href="#l59.54"></a><span id="l59.54">   if(!m_pop3ConData)</span>
<a href="#l59.55"></a><span id="l59.55">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l59.56"></a><span id="l59.56"> </span>
<a href="#l59.57"></a><span id="l59.57">   m_totalBytesReceived = 0;</span>
<a href="#l59.58"></a><span id="l59.58">   m_bytesInMsgReceived = 0;</span>
<a href="#l59.59"></a><span id="l59.59">   m_totalFolderSize = 0;</span>
<a href="#l59.60"></a><span id="l59.60">   m_totalDownloadSize = 0;</span>
<a href="#l59.61"></a><span id="l59.61">   m_totalBytesReceived = 0;</span>
<a href="#l59.62"></a><span id="l59.62">   m_tlsEnabled = PR_FALSE;</span>
<a href="#l59.63"></a><span id="l59.63" class="difflineminus">-  m_socketType = nsIMsgIncomingServer::tryTLS;</span>
<a href="#l59.64"></a><span id="l59.64" class="difflineplus">+  m_socketType = nsMsgSocketType::trySTARTTLS;</span>
<a href="#l59.65"></a><span id="l59.65" class="difflineplus">+  m_prefAuthMethods = POP3_AUTH_MECH_UNDEFINED;</span>
<a href="#l59.66"></a><span id="l59.66" class="difflineplus">+  m_failedAuthMethods = 0;</span>
<a href="#l59.67"></a><span id="l59.67" class="difflineplus">+  m_currentAuthMethod = POP3_AUTH_MECH_UNDEFINED;</span>
<a href="#l59.68"></a><span id="l59.68"> </span>
<a href="#l59.69"></a><span id="l59.69">   if (aURL)</span>
<a href="#l59.70"></a><span id="l59.70">   {</span>
<a href="#l59.71"></a><span id="l59.71">     // extract out message feedback if there is any.</span>
<a href="#l59.72"></a><span id="l59.72">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(aURL);</span>
<a href="#l59.73"></a><span id="l59.73">     if (mailnewsUrl)</span>
<a href="#l59.74"></a><span id="l59.74">     {</span>
<a href="#l59.75"></a><span id="l59.75">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l59.76"></a><span id="l59.76">       mailnewsUrl-&gt;GetStatusFeedback(getter_AddRefs(m_statusFeedback));</span>
<a href="#l59.77"></a><span id="l59.77">       mailnewsUrl-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l59.78"></a><span id="l59.78">       NS_ENSURE_TRUE(server, NS_MSG_INVALID_OR_MISSING_SERVER);</span>
<a href="#l59.79"></a><span id="l59.79"> </span>
<a href="#l59.80"></a><span id="l59.80">       rv = server-&gt;GetSocketType(&amp;m_socketType);</span>
<a href="#l59.81"></a><span id="l59.81">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l59.82"></a><span id="l59.82"> </span>
<a href="#l59.83"></a><span id="l59.83" class="difflineminus">-      rv = server-&gt;GetUseSecAuth(&amp;m_useSecAuth);</span>
<a href="#l59.84"></a><span id="l59.84" class="difflineplus">+      PRInt32 authMethod = 0;</span>
<a href="#l59.85"></a><span id="l59.85" class="difflineplus">+      rv = server-&gt;GetAuthMethod(&amp;authMethod);</span>
<a href="#l59.86"></a><span id="l59.86">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l59.87"></a><span id="l59.87" class="difflineplus">+      InitPrefAuthMethods(authMethod);</span>
<a href="#l59.88"></a><span id="l59.88"> </span>
<a href="#l59.89"></a><span id="l59.89">       m_pop3Server = do_QueryInterface(server);</span>
<a href="#l59.90"></a><span id="l59.90">       if (m_pop3Server)</span>
<a href="#l59.91"></a><span id="l59.91">         m_pop3Server-&gt;GetPop3CapabilityFlags(&amp;m_pop3ConData-&gt;capability_flags);</span>
<a href="#l59.92"></a><span id="l59.92">     }</span>
<a href="#l59.93"></a><span id="l59.93"> </span>
<a href="#l59.94"></a><span id="l59.94">     m_url = do_QueryInterface(aURL);</span>
<a href="#l59.95"></a><span id="l59.95"> </span>
<a href="#l59.96"></a><span id="l59.96">     // When we are making a secure connection, we need to make sure that we</span>
<a href="#l59.97"></a><span id="l59.97">     // pass an interface requestor down to the socket transport so that PSM can</span>
<a href="#l59.98"></a><span id="l59.98">     // retrieve a nsIPrompt instance if needed.</span>
<a href="#l59.99"></a><span id="l59.99">     nsCOMPtr&lt;nsIInterfaceRequestor&gt; ir;</span>
<a href="#l59.100"></a><span id="l59.100" class="difflineminus">-    if (m_socketType != nsIMsgIncomingServer::defaultSocket)</span>
<a href="#l59.101"></a><span id="l59.101" class="difflineplus">+    if (m_socketType != nsMsgSocketType::plain)</span>
<a href="#l59.102"></a><span id="l59.102">     {</span>
<a href="#l59.103"></a><span id="l59.103">       nsCOMPtr&lt;nsIMsgWindow&gt; msgwin;</span>
<a href="#l59.104"></a><span id="l59.104">       mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(msgwin));</span>
<a href="#l59.105"></a><span id="l59.105">       if (!msgwin)</span>
<a href="#l59.106"></a><span id="l59.106">         GetTopmostMsgWindow(getter_AddRefs(msgwin));</span>
<a href="#l59.107"></a><span id="l59.107">       if (msgwin)</span>
<a href="#l59.108"></a><span id="l59.108">       {</span>
<a href="#l59.109"></a><span id="l59.109">         nsCOMPtr&lt;nsIDocShell&gt; docshell;</span>
<a href="#l59.110"></a><span id="l59.110" class="difflineat">@@ -564,36 +569,33 @@ nsresult nsPop3Protocol::Initialize(nsIU</span>
<a href="#l59.111"></a><span id="l59.111">     if (server)</span>
<a href="#l59.112"></a><span id="l59.112">       server-&gt;GetRealHostName(hostName);</span>
<a href="#l59.113"></a><span id="l59.113"> </span>
<a href="#l59.114"></a><span id="l59.114">     nsCOMPtr&lt;nsIProxyInfo&gt; proxyInfo;</span>
<a href="#l59.115"></a><span id="l59.115">     rv = MsgExamineForProxy(&quot;pop&quot;, hostName.get(), port, getter_AddRefs(proxyInfo));</span>
<a href="#l59.116"></a><span id="l59.116">     if (NS_FAILED(rv)) proxyInfo = nsnull;</span>
<a href="#l59.117"></a><span id="l59.117"> </span>
<a href="#l59.118"></a><span id="l59.118">     const char *connectionType = nsnull;</span>
<a href="#l59.119"></a><span id="l59.119" class="difflineminus">-    if (m_socketType == nsIMsgIncomingServer::useSSL)</span>
<a href="#l59.120"></a><span id="l59.120" class="difflineplus">+    if (m_socketType == nsMsgSocketType::SSL)</span>
<a href="#l59.121"></a><span id="l59.121">       connectionType = &quot;ssl&quot;;</span>
<a href="#l59.122"></a><span id="l59.122" class="difflineminus">-    else if (m_socketType == nsIMsgIncomingServer::tryTLS ||</span>
<a href="#l59.123"></a><span id="l59.123" class="difflineminus">-          m_socketType == nsIMsgIncomingServer::alwaysUseTLS)</span>
<a href="#l59.124"></a><span id="l59.124" class="difflineplus">+    else if (m_socketType == nsMsgSocketType::trySTARTTLS ||</span>
<a href="#l59.125"></a><span id="l59.125" class="difflineplus">+          m_socketType == nsMsgSocketType::alwaysSTARTTLS)</span>
<a href="#l59.126"></a><span id="l59.126">         connectionType = &quot;starttls&quot;;</span>
<a href="#l59.127"></a><span id="l59.127"> </span>
<a href="#l59.128"></a><span id="l59.128">     rv = OpenNetworkSocketWithInfo(hostName.get(), port, connectionType, proxyInfo, ir);</span>
<a href="#l59.129"></a><span id="l59.129" class="difflineminus">-    if (NS_FAILED(rv) &amp;&amp; m_socketType == nsIMsgIncomingServer::tryTLS)</span>
<a href="#l59.130"></a><span id="l59.130" class="difflineplus">+    if (NS_FAILED(rv) &amp;&amp; m_socketType == nsMsgSocketType::trySTARTTLS)</span>
<a href="#l59.131"></a><span id="l59.131">     {</span>
<a href="#l59.132"></a><span id="l59.132" class="difflineminus">-      m_socketType = nsIMsgIncomingServer::defaultSocket;</span>
<a href="#l59.133"></a><span id="l59.133" class="difflineplus">+      m_socketType = nsMsgSocketType::plain;</span>
<a href="#l59.134"></a><span id="l59.134">       rv = OpenNetworkSocketWithInfo(hostName.get(), port, nsnull, proxyInfo, ir);</span>
<a href="#l59.135"></a><span id="l59.135">     }</span>
<a href="#l59.136"></a><span id="l59.136"> </span>
<a href="#l59.137"></a><span id="l59.137">     if(NS_FAILED(rv))</span>
<a href="#l59.138"></a><span id="l59.138">       return rv;</span>
<a href="#l59.139"></a><span id="l59.139">   } // if we got a url...</span>
<a href="#l59.140"></a><span id="l59.140"> </span>
<a href="#l59.141"></a><span id="l59.141" class="difflineminus">-  if (!POP3LOGMODULE)</span>
<a href="#l59.142"></a><span id="l59.142" class="difflineminus">-      POP3LOGMODULE = PR_NewLogModule(&quot;POP3&quot;);</span>
<a href="#l59.143"></a><span id="l59.143" class="difflineminus">-</span>
<a href="#l59.144"></a><span id="l59.144">   m_lineStreamBuffer = new nsMsgLineStreamBuffer(OUTPUT_BUFFER_SIZE, PR_TRUE);</span>
<a href="#l59.145"></a><span id="l59.145">   if(!m_lineStreamBuffer)</span>
<a href="#l59.146"></a><span id="l59.146">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l59.147"></a><span id="l59.147"> </span>
<a href="#l59.148"></a><span id="l59.148">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService(do_GetService(&quot;@mozilla.org/intl/stringbundle;1&quot;, &amp;rv));</span>
<a href="#l59.149"></a><span id="l59.149">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l59.150"></a><span id="l59.150">   return bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/localMsgs.properties&quot;, getter_AddRefs(mLocalBundle));</span>
<a href="#l59.151"></a><span id="l59.151"> }</span>
<a href="#l59.152"></a><span id="l59.152" class="difflineat">@@ -622,16 +624,21 @@ void nsPop3Protocol::ClearCapFlag(PRUint</span>
<a href="#l59.153"></a><span id="l59.153">     m_pop3ConData-&gt;capability_flags &amp;= ~flag;</span>
<a href="#l59.154"></a><span id="l59.154"> }</span>
<a href="#l59.155"></a><span id="l59.155"> </span>
<a href="#l59.156"></a><span id="l59.156"> PRBool nsPop3Protocol::TestCapFlag(PRUint32 flag)</span>
<a href="#l59.157"></a><span id="l59.157"> {</span>
<a href="#l59.158"></a><span id="l59.158">     return m_pop3ConData-&gt;capability_flags &amp; flag;</span>
<a href="#l59.159"></a><span id="l59.159"> }</span>
<a href="#l59.160"></a><span id="l59.160"> </span>
<a href="#l59.161"></a><span id="l59.161" class="difflineplus">+PRUint32 nsPop3Protocol::GetCapFlags()</span>
<a href="#l59.162"></a><span id="l59.162" class="difflineplus">+{</span>
<a href="#l59.163"></a><span id="l59.163" class="difflineplus">+    return m_pop3ConData-&gt;capability_flags;</span>
<a href="#l59.164"></a><span id="l59.164" class="difflineplus">+}</span>
<a href="#l59.165"></a><span id="l59.165" class="difflineplus">+</span>
<a href="#l59.166"></a><span id="l59.166"> void nsPop3Protocol::UpdateStatus(PRInt32 aStatusID)</span>
<a href="#l59.167"></a><span id="l59.167"> {</span>
<a href="#l59.168"></a><span id="l59.168">   if (m_statusFeedback)</span>
<a href="#l59.169"></a><span id="l59.169">   {</span>
<a href="#l59.170"></a><span id="l59.170">     nsString statusString;</span>
<a href="#l59.171"></a><span id="l59.171">     mLocalBundle-&gt;GetStringFromID(aStatusID, getter_Copies(statusString));</span>
<a href="#l59.172"></a><span id="l59.172">     UpdateStatusWithString(statusString.get());</span>
<a href="#l59.173"></a><span id="l59.173">   }</span>
<a href="#l59.174"></a><span id="l59.174" class="difflineat">@@ -660,125 +667,121 @@ void nsPop3Protocol::SetUsername(const c</span>
<a href="#l59.175"></a><span id="l59.175"> {</span>
<a href="#l59.176"></a><span id="l59.176">   NS_ASSERTION(name, &quot;no name specified!&quot;);</span>
<a href="#l59.177"></a><span id="l59.177">     if (name)</span>
<a href="#l59.178"></a><span id="l59.178">       m_username = name;</span>
<a href="#l59.179"></a><span id="l59.179"> }</span>
<a href="#l59.180"></a><span id="l59.180"> </span>
<a href="#l59.181"></a><span id="l59.181"> nsresult nsPop3Protocol::GetPassword(nsCString&amp; aPassword)</span>
<a href="#l59.182"></a><span id="l59.182"> {</span>
<a href="#l59.183"></a><span id="l59.183" class="difflineplus">+  PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;GetPassword()&quot;));</span>
<a href="#l59.184"></a><span id="l59.184">   nsresult rv = NS_OK;</span>
<a href="#l59.185"></a><span id="l59.185">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_pop3Server);</span>
<a href="#l59.186"></a><span id="l59.186" class="difflineminus">-</span>
<a href="#l59.187"></a><span id="l59.187" class="difflineminus">-  if (server)</span>
<a href="#l59.188"></a><span id="l59.188" class="difflineplus">+  NS_ENSURE_TRUE(server, NS_MSG_INVALID_OR_MISSING_SERVER);</span>
<a href="#l59.189"></a><span id="l59.189" class="difflineplus">+</span>
<a href="#l59.190"></a><span id="l59.190" class="difflineplus">+  PRBool isAuthenticated;</span>
<a href="#l59.191"></a><span id="l59.191" class="difflineplus">+  m_nsIPop3Sink-&gt;GetUserAuthenticated(&amp;isAuthenticated);</span>
<a href="#l59.192"></a><span id="l59.192" class="difflineplus">+</span>
<a href="#l59.193"></a><span id="l59.193" class="difflineplus">+  // pass the failed password into the password prompt so that</span>
<a href="#l59.194"></a><span id="l59.194" class="difflineplus">+  // it will be pre-filled, in case it failed because of a</span>
<a href="#l59.195"></a><span id="l59.195" class="difflineplus">+  // server problem and not because it was wrong.</span>
<a href="#l59.196"></a><span id="l59.196" class="difflineplus">+  if (!m_lastPasswordSent.IsEmpty())</span>
<a href="#l59.197"></a><span id="l59.197" class="difflineplus">+    aPassword = m_lastPasswordSent;</span>
<a href="#l59.198"></a><span id="l59.198" class="difflineplus">+</span>
<a href="#l59.199"></a><span id="l59.199" class="difflineplus">+  // Set up some items that we're going to need for the prompting.</span>
<a href="#l59.200"></a><span id="l59.200" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_url, &amp;rv);</span>
<a href="#l59.201"></a><span id="l59.201" class="difflineplus">+  nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l59.202"></a><span id="l59.202" class="difflineplus">+  if (mailnewsUrl)</span>
<a href="#l59.203"></a><span id="l59.203" class="difflineplus">+    mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l59.204"></a><span id="l59.204" class="difflineplus">+</span>
<a href="#l59.205"></a><span id="l59.205" class="difflineplus">+  nsCString userName;</span>
<a href="#l59.206"></a><span id="l59.206" class="difflineplus">+  server-&gt;GetRealUsername(userName);</span>
<a href="#l59.207"></a><span id="l59.207" class="difflineplus">+</span>
<a href="#l59.208"></a><span id="l59.208" class="difflineplus">+  nsCString hostName;</span>
<a href="#l59.209"></a><span id="l59.209" class="difflineplus">+  server-&gt;GetRealHostName(hostName);</span>
<a href="#l59.210"></a><span id="l59.210" class="difflineplus">+</span>
<a href="#l59.211"></a><span id="l59.211" class="difflineplus">+  nsString passwordPrompt;</span>
<a href="#l59.212"></a><span id="l59.212" class="difflineplus">+  NS_ConvertUTF8toUTF16 userNameUTF16(userName);</span>
<a href="#l59.213"></a><span id="l59.213" class="difflineplus">+  NS_ConvertUTF8toUTF16 hostNameUTF16(hostName);</span>
<a href="#l59.214"></a><span id="l59.214" class="difflineplus">+  const PRUnichar* passwordParams[] = { userNameUTF16.get(),</span>
<a href="#l59.215"></a><span id="l59.215" class="difflineplus">+                                        hostNameUTF16.get() };</span>
<a href="#l59.216"></a><span id="l59.216" class="difflineplus">+</span>
<a href="#l59.217"></a><span id="l59.217" class="difflineplus">+  // if the last prompt got us a bad password then show a special dialog</span>
<a href="#l59.218"></a><span id="l59.218" class="difflineplus">+  if (TestFlag(POP3_PASSWORD_FAILED))</span>
<a href="#l59.219"></a><span id="l59.219">   {</span>
<a href="#l59.220"></a><span id="l59.220" class="difflineminus">-    PRBool isAuthenticated;</span>
<a href="#l59.221"></a><span id="l59.221" class="difflineminus">-    m_nsIPop3Sink-&gt;GetUserAuthenticated(&amp;isAuthenticated);</span>
<a href="#l59.222"></a><span id="l59.222" class="difflineminus">-</span>
<a href="#l59.223"></a><span id="l59.223" class="difflineminus">-    // pass the failed password into the password prompt so that</span>
<a href="#l59.224"></a><span id="l59.224" class="difflineminus">-    // it will be pre-filled, in case it failed because of a</span>
<a href="#l59.225"></a><span id="l59.225" class="difflineminus">-    // server problem and not because it was wrong.</span>
<a href="#l59.226"></a><span id="l59.226" class="difflineminus">-    if (!m_lastPasswordSent.IsEmpty())</span>
<a href="#l59.227"></a><span id="l59.227" class="difflineminus">-      aPassword = m_lastPasswordSent;</span>
<a href="#l59.228"></a><span id="l59.228" class="difflineminus">-</span>
<a href="#l59.229"></a><span id="l59.229" class="difflineminus">-    // clear the password if the last one failed</span>
<a href="#l59.230"></a><span id="l59.230" class="difflineminus">-    if (TestFlag(POP3_PASSWORD_FAILED))</span>
<a href="#l59.231"></a><span id="l59.231" class="difflineplus">+    // Biff case (no msgWindow) shouldn't cause prompts or passwords to get forgotten at all</span>
<a href="#l59.232"></a><span id="l59.232" class="difflineplus">+    // TODO shouldn't we skip the new password prompt below as well for biff? Just exit here?</span>
<a href="#l59.233"></a><span id="l59.233" class="difflineplus">+    if (msgWindow)</span>
<a href="#l59.234"></a><span id="l59.234">     {</span>
<a href="#l59.235"></a><span id="l59.235" class="difflineminus">-      // if we've already gotten a password and it wasn't correct..clear</span>
<a href="#l59.236"></a><span id="l59.236" class="difflineminus">-      // out the password and try again.</span>
<a href="#l59.237"></a><span id="l59.237" class="difflineminus">-      rv = server-&gt;SetPassword(EmptyCString());</span>
<a href="#l59.238"></a><span id="l59.238" class="difflineminus">-    }</span>
<a href="#l59.239"></a><span id="l59.239" class="difflineminus">-</span>
<a href="#l59.240"></a><span id="l59.240" class="difflineminus">-    // Set up some items that we're going to need for the prompting.</span>
<a href="#l59.241"></a><span id="l59.241" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_url, &amp;rv);</span>
<a href="#l59.242"></a><span id="l59.242" class="difflineminus">-    nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l59.243"></a><span id="l59.243" class="difflineminus">-    if (mailnewsUrl)</span>
<a href="#l59.244"></a><span id="l59.244" class="difflineminus">-      mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l59.245"></a><span id="l59.245" class="difflineminus">-</span>
<a href="#l59.246"></a><span id="l59.246" class="difflineminus">-    nsCString userName;</span>
<a href="#l59.247"></a><span id="l59.247" class="difflineminus">-    server-&gt;GetRealUsername(userName);</span>
<a href="#l59.248"></a><span id="l59.248" class="difflineminus">-</span>
<a href="#l59.249"></a><span id="l59.249" class="difflineminus">-    nsCString hostName;</span>
<a href="#l59.250"></a><span id="l59.250" class="difflineminus">-    server-&gt;GetRealHostName(hostName);</span>
<a href="#l59.251"></a><span id="l59.251" class="difflineminus">-</span>
<a href="#l59.252"></a><span id="l59.252" class="difflineminus">-    nsString passwordPrompt;</span>
<a href="#l59.253"></a><span id="l59.253" class="difflineminus">-    NS_ConvertUTF8toUTF16 userNameUTF16(userName);</span>
<a href="#l59.254"></a><span id="l59.254" class="difflineminus">-    NS_ConvertUTF8toUTF16 hostNameUTF16(hostName);</span>
<a href="#l59.255"></a><span id="l59.255" class="difflineminus">-    const PRUnichar* passwordParams[] = { userNameUTF16.get(),</span>
<a href="#l59.256"></a><span id="l59.256" class="difflineminus">-                                          hostNameUTF16.get() };</span>
<a href="#l59.257"></a><span id="l59.257" class="difflineminus">-</span>
<a href="#l59.258"></a><span id="l59.258" class="difflineminus">-    // if the last prompt got us a bad password then show a special dialog</span>
<a href="#l59.259"></a><span id="l59.259" class="difflineminus">-    if (TestFlag(POP3_PASSWORD_FAILED))</span>
<a href="#l59.260"></a><span id="l59.260" class="difflineminus">-    {</span>
<a href="#l59.261"></a><span id="l59.261" class="difflineminus">-      // if we haven't successfully logged onto the server in this session</span>
<a href="#l59.262"></a><span id="l59.262" class="difflineminus">-      // and tried at least twice or if the server threw the specific error,</span>
<a href="#l59.263"></a><span id="l59.263" class="difflineminus">-      // forget the password.</span>
<a href="#l59.264"></a><span id="l59.264" class="difflineminus">-      // Only do this if it's not check for new mail, since biff shouldn't</span>
<a href="#l59.265"></a><span id="l59.265" class="difflineminus">-      // cause passwords to get forgotten at all.</span>
<a href="#l59.266"></a><span id="l59.266" class="difflineminus">-      if ((!isAuthenticated || m_pop3ConData-&gt;logonFailureCount &gt; 2) &amp;&amp; msgWindow)</span>
<a href="#l59.267"></a><span id="l59.267" class="difflineplus">+      PR_LOG(POP3LOGMODULE, PR_LOG_WARN,</span>
<a href="#l59.268"></a><span id="l59.268" class="difflineplus">+          (&quot;POP: ask user what to do (after password failed): new password, retry or cancel&quot;));</span>
<a href="#l59.269"></a><span id="l59.269" class="difflineplus">+</span>
<a href="#l59.270"></a><span id="l59.270" class="difflineplus">+      PRInt32 buttonPressed = 0;</span>
<a href="#l59.271"></a><span id="l59.271" class="difflineplus">+      if (NS_SUCCEEDED(MsgPromptLoginFailed(msgWindow, hostName,</span>
<a href="#l59.272"></a><span id="l59.272" class="difflineplus">+                                            &amp;buttonPressed)))</span>
<a href="#l59.273"></a><span id="l59.273">       {</span>
<a href="#l59.274"></a><span id="l59.274" class="difflineminus">-        PRInt32 buttonPressed = 0;</span>
<a href="#l59.275"></a><span id="l59.275" class="difflineminus">-        if (NS_SUCCEEDED(MsgPromptLoginFailed(msgWindow, hostName,</span>
<a href="#l59.276"></a><span id="l59.276" class="difflineminus">-                                              &amp;buttonPressed)))</span>
<a href="#l59.277"></a><span id="l59.277" class="difflineplus">+        if (buttonPressed == 1) // Cancel button</span>
<a href="#l59.278"></a><span id="l59.278" class="difflineplus">+        {</span>
<a href="#l59.279"></a><span id="l59.279" class="difflineplus">+          PR_LOG(POP3LOGMODULE, PR_LOG_WARN, (&quot;cancel button pressed&quot;));</span>
<a href="#l59.280"></a><span id="l59.280" class="difflineplus">+          // About quickly and stop trying for now.</span>
<a href="#l59.281"></a><span id="l59.281" class="difflineplus">+          m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l59.282"></a><span id="l59.282" class="difflineplus">+</span>
<a href="#l59.283"></a><span id="l59.283" class="difflineplus">+          // Clear the password we're going to return to force failure in</span>
<a href="#l59.284"></a><span id="l59.284" class="difflineplus">+          // the get mail instance.</span>
<a href="#l59.285"></a><span id="l59.285" class="difflineplus">+          aPassword.Truncate();</span>
<a href="#l59.286"></a><span id="l59.286" class="difflineplus">+</span>
<a href="#l59.287"></a><span id="l59.287" class="difflineplus">+          // We also have to clear the password failed flag, otherwise we'll</span>
<a href="#l59.288"></a><span id="l59.288" class="difflineplus">+          // automatically try again.</span>
<a href="#l59.289"></a><span id="l59.289" class="difflineplus">+          ClearFlag(POP3_PASSWORD_FAILED);</span>
<a href="#l59.290"></a><span id="l59.290" class="difflineplus">+          return NS_ERROR_ABORT;</span>
<a href="#l59.291"></a><span id="l59.291" class="difflineplus">+        }</span>
<a href="#l59.292"></a><span id="l59.292" class="difflineplus">+        else if (buttonPressed == 2) // &quot;New password&quot; button</span>
<a href="#l59.293"></a><span id="l59.293">         {</span>
<a href="#l59.294"></a><span id="l59.294" class="difflineminus">-          if (buttonPressed == 1)</span>
<a href="#l59.295"></a><span id="l59.295" class="difflineminus">-          {</span>
<a href="#l59.296"></a><span id="l59.296" class="difflineminus">-            // Cancel button pressed, about quickly and stop trying for now.</span>
<a href="#l59.297"></a><span id="l59.297" class="difflineminus">-            m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l59.298"></a><span id="l59.298" class="difflineminus">-</span>
<a href="#l59.299"></a><span id="l59.299" class="difflineminus">-            // Clear the password we're going to return to force failure in</span>
<a href="#l59.300"></a><span id="l59.300" class="difflineminus">-            // the get mail instance.</span>
<a href="#l59.301"></a><span id="l59.301" class="difflineminus">-            aPassword.Truncate();</span>
<a href="#l59.302"></a><span id="l59.302" class="difflineminus">-</span>
<a href="#l59.303"></a><span id="l59.303" class="difflineminus">-            // We also have to clear the password failed flag, otherwise we'll</span>
<a href="#l59.304"></a><span id="l59.304" class="difflineminus">-            // automatically try again.</span>
<a href="#l59.305"></a><span id="l59.305" class="difflineminus">-            ClearFlag(POP3_PASSWORD_FAILED);</span>
<a href="#l59.306"></a><span id="l59.306" class="difflineminus">-            return NS_ERROR_FAILURE;</span>
<a href="#l59.307"></a><span id="l59.307" class="difflineminus">-          }</span>
<a href="#l59.308"></a><span id="l59.308" class="difflineminus">-          if (buttonPressed == 2)</span>
<a href="#l59.309"></a><span id="l59.309" class="difflineminus">-          {</span>
<a href="#l59.310"></a><span id="l59.310" class="difflineminus">-            // Change password was pressed. For now, forget the stored password</span>
<a href="#l59.311"></a><span id="l59.311" class="difflineminus">-            // and we'll prompt for a new one next time around.</span>
<a href="#l59.312"></a><span id="l59.312" class="difflineminus">-            rv = server-&gt;ForgetPassword();</span>
<a href="#l59.313"></a><span id="l59.313" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l59.314"></a><span id="l59.314" class="difflineminus">-          }</span>
<a href="#l59.315"></a><span id="l59.315" class="difflineminus">-          // Reset the logon failure count now that we've prompted the user</span>
<a href="#l59.316"></a><span id="l59.316" class="difflineminus">-          m_pop3ConData-&gt;logonFailureCount = 0;</span>
<a href="#l59.317"></a><span id="l59.317" class="difflineplus">+          PR_LOG(POP3LOGMODULE, PR_LOG_WARN, (&quot;new password button pressed&quot;));</span>
<a href="#l59.318"></a><span id="l59.318" class="difflineplus">+          // Forget the stored password</span>
<a href="#l59.319"></a><span id="l59.319" class="difflineplus">+          // and we'll prompt for a new one next time around.</span>
<a href="#l59.320"></a><span id="l59.320" class="difflineplus">+          rv = server-&gt;ForgetPassword();</span>
<a href="#l59.321"></a><span id="l59.321" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l59.322"></a><span id="l59.322" class="difflineplus">+</span>
<a href="#l59.323"></a><span id="l59.323" class="difflineplus">+          // try all methods again with new password</span>
<a href="#l59.324"></a><span id="l59.324" class="difflineplus">+          ResetAuthMethods();</span>
<a href="#l59.325"></a><span id="l59.325" class="difflineplus">+          // ... apart from GSSAPI, which doesn't care about passwords</span>
<a href="#l59.326"></a><span id="l59.326" class="difflineplus">+          MarkAuthMethodAsFailed(POP3_HAS_AUTH_GSSAPI);</span>
<a href="#l59.327"></a><span id="l59.327" class="difflineplus">+        }</span>
<a href="#l59.328"></a><span id="l59.328" class="difflineplus">+        else if (buttonPressed == 0) // &quot;Retry&quot; button</span>
<a href="#l59.329"></a><span id="l59.329" class="difflineplus">+        {</span>
<a href="#l59.330"></a><span id="l59.330" class="difflineplus">+          PR_LOG(POP3LOGMODULE, PR_LOG_WARN, (&quot;retry button pressed&quot;));</span>
<a href="#l59.331"></a><span id="l59.331" class="difflineplus">+          // try all methods again, including GSSAPI</span>
<a href="#l59.332"></a><span id="l59.332" class="difflineplus">+          ResetAuthMethods();</span>
<a href="#l59.333"></a><span id="l59.333" class="difflineplus">+          ClearFlag(POP3_PASSWORD_FAILED|POP3_AUTH_FAILURE);</span>
<a href="#l59.334"></a><span id="l59.334" class="difflineplus">+          return NS_OK;</span>
<a href="#l59.335"></a><span id="l59.335">         }</span>
<a href="#l59.336"></a><span id="l59.336">       }</span>
<a href="#l59.337"></a><span id="l59.337" class="difflineminus">-      mLocalBundle-&gt;FormatStringFromName(</span>
<a href="#l59.338"></a><span id="l59.338" class="difflineminus">-        NS_LITERAL_STRING(&quot;pop3PreviouslyEnteredPasswordIsInvalidPrompt&quot;).get(),</span>
<a href="#l59.339"></a><span id="l59.339" class="difflineminus">-        passwordParams, 2, getter_Copies(passwordPrompt));</span>
<a href="#l59.340"></a><span id="l59.340">     }</span>
<a href="#l59.341"></a><span id="l59.341" class="difflineminus">-    else</span>
<a href="#l59.342"></a><span id="l59.342" class="difflineminus">-      // Otherwise this is the first time we've asked about the server's</span>
<a href="#l59.343"></a><span id="l59.343" class="difflineminus">-      // password so show a first time prompt.</span>
<a href="#l59.344"></a><span id="l59.344" class="difflineminus">-      mLocalBundle-&gt;FormatStringFromName(</span>
<a href="#l59.345"></a><span id="l59.345" class="difflineminus">-        NS_LITERAL_STRING(&quot;pop3EnterPasswordPrompt&quot;).get(),</span>
<a href="#l59.346"></a><span id="l59.346" class="difflineminus">-        passwordParams, 2, getter_Copies(passwordPrompt));</span>
<a href="#l59.347"></a><span id="l59.347" class="difflineminus">-</span>
<a href="#l59.348"></a><span id="l59.348" class="difflineminus">-    nsString passwordTitle;</span>
<a href="#l59.349"></a><span id="l59.349" class="difflineminus">-    mLocalBundle-&gt;GetStringFromName(</span>
<a href="#l59.350"></a><span id="l59.350" class="difflineminus">-      NS_LITERAL_STRING(&quot;pop3EnterPasswordPromptTitle&quot;).get(),</span>
<a href="#l59.351"></a><span id="l59.351" class="difflineminus">-      getter_Copies(passwordTitle));</span>
<a href="#l59.352"></a><span id="l59.352" class="difflineminus">-</span>
<a href="#l59.353"></a><span id="l59.353" class="difflineminus">-    // Now go and get the password.</span>
<a href="#l59.354"></a><span id="l59.354" class="difflineminus">-    if (!passwordPrompt.IsEmpty() &amp;&amp; !passwordTitle.IsEmpty())</span>
<a href="#l59.355"></a><span id="l59.355" class="difflineminus">-      rv = server-&gt;GetPasswordWithUI(passwordPrompt, passwordTitle,</span>
<a href="#l59.356"></a><span id="l59.356" class="difflineminus">-                                     msgWindow, aPassword);</span>
<a href="#l59.357"></a><span id="l59.357" class="difflineminus">-    ClearFlag(POP3_PASSWORD_FAILED|POP3_AUTH_FAILURE);</span>
<a href="#l59.358"></a><span id="l59.358" class="difflineminus">-</span>
<a href="#l59.359"></a><span id="l59.359" class="difflineminus">-    // If it failed, then user pressed the cancel button (or some other</span>
<a href="#l59.360"></a><span id="l59.360" class="difflineminus">-    // failure).</span>
<a href="#l59.361"></a><span id="l59.361" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l59.362"></a><span id="l59.362" class="difflineminus">-      m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l59.363"></a><span id="l59.363" class="difflineplus">+    mLocalBundle-&gt;FormatStringFromName(</span>
<a href="#l59.364"></a><span id="l59.364" class="difflineplus">+      NS_LITERAL_STRING(&quot;pop3PreviouslyEnteredPasswordIsInvalidPrompt&quot;).get(),</span>
<a href="#l59.365"></a><span id="l59.365" class="difflineplus">+      passwordParams, 2, getter_Copies(passwordPrompt));</span>
<a href="#l59.366"></a><span id="l59.366">   }</span>
<a href="#l59.367"></a><span id="l59.367">   else</span>
<a href="#l59.368"></a><span id="l59.368" class="difflineminus">-    // No server present :-(</span>
<a href="#l59.369"></a><span id="l59.369" class="difflineminus">-    rv = NS_MSG_INVALID_OR_MISSING_SERVER;</span>
<a href="#l59.370"></a><span id="l59.370" class="difflineplus">+    // Otherwise this is the first time we've asked about the server's</span>
<a href="#l59.371"></a><span id="l59.371" class="difflineplus">+    // password so show a first time prompt.</span>
<a href="#l59.372"></a><span id="l59.372" class="difflineplus">+    mLocalBundle-&gt;FormatStringFromName(</span>
<a href="#l59.373"></a><span id="l59.373" class="difflineplus">+      NS_LITERAL_STRING(&quot;pop3EnterPasswordPrompt&quot;).get(),</span>
<a href="#l59.374"></a><span id="l59.374" class="difflineplus">+      passwordParams, 2, getter_Copies(passwordPrompt));</span>
<a href="#l59.375"></a><span id="l59.375" class="difflineplus">+</span>
<a href="#l59.376"></a><span id="l59.376" class="difflineplus">+  nsString passwordTitle;</span>
<a href="#l59.377"></a><span id="l59.377" class="difflineplus">+  mLocalBundle-&gt;GetStringFromName(</span>
<a href="#l59.378"></a><span id="l59.378" class="difflineplus">+    NS_LITERAL_STRING(&quot;pop3EnterPasswordPromptTitle&quot;).get(),</span>
<a href="#l59.379"></a><span id="l59.379" class="difflineplus">+    getter_Copies(passwordTitle));</span>
<a href="#l59.380"></a><span id="l59.380" class="difflineplus">+</span>
<a href="#l59.381"></a><span id="l59.381" class="difflineplus">+  // Now go and get the password.</span>
<a href="#l59.382"></a><span id="l59.382" class="difflineplus">+  if (!passwordPrompt.IsEmpty() &amp;&amp; !passwordTitle.IsEmpty())</span>
<a href="#l59.383"></a><span id="l59.383" class="difflineplus">+    rv = server-&gt;GetPasswordWithUI(passwordPrompt, passwordTitle,</span>
<a href="#l59.384"></a><span id="l59.384" class="difflineplus">+                                    msgWindow, aPassword);</span>
<a href="#l59.385"></a><span id="l59.385" class="difflineplus">+  ClearFlag(POP3_PASSWORD_FAILED|POP3_AUTH_FAILURE);</span>
<a href="#l59.386"></a><span id="l59.386"> </span>
<a href="#l59.387"></a><span id="l59.387">   return rv;</span>
<a href="#l59.388"></a><span id="l59.388"> }</span>
<a href="#l59.389"></a><span id="l59.389"> </span>
<a href="#l59.390"></a><span id="l59.390"> NS_IMETHODIMP nsPop3Protocol::OnTransportStatus(nsITransport *aTransport, nsresult aStatus, PRUint64 aProgress, PRUint64 aProgressMax)</span>
<a href="#l59.391"></a><span id="l59.391"> {</span>
<a href="#l59.392"></a><span id="l59.392">   return nsMsgProtocol::OnTransportStatus(aTransport, aStatus, aProgress, aProgressMax);</span>
<a href="#l59.393"></a><span id="l59.393"> }</span>
<a href="#l59.394"></a><span id="l59.394" class="difflineat">@@ -974,17 +977,17 @@ nsPop3Protocol::WaitForStartOfConnection</span>
<a href="#l59.395"></a><span id="l59.395">   if(*line == '+')</span>
<a href="#l59.396"></a><span id="l59.396">   {</span>
<a href="#l59.397"></a><span id="l59.397">     m_pop3ConData-&gt;command_succeeded = PR_TRUE;</span>
<a href="#l59.398"></a><span id="l59.398">     if(PL_strlen(line) &gt; 4)</span>
<a href="#l59.399"></a><span id="l59.399">       m_commandResponse = line + 4;</span>
<a href="#l59.400"></a><span id="l59.400">     else</span>
<a href="#l59.401"></a><span id="l59.401">       m_commandResponse = line;</span>
<a href="#l59.402"></a><span id="l59.402"> </span>
<a href="#l59.403"></a><span id="l59.403" class="difflineminus">-    if (m_useSecAuth)</span>
<a href="#l59.404"></a><span id="l59.404" class="difflineplus">+    if (m_prefAuthMethods &amp; POP3_HAS_AUTH_APOP)</span>
<a href="#l59.405"></a><span id="l59.405">     {</span>
<a href="#l59.406"></a><span id="l59.406">         nsresult rv;</span>
<a href="#l59.407"></a><span id="l59.407">         nsCOMPtr&lt;nsISignatureVerifier&gt; verifier = do_GetService(SIGNATURE_VERIFIER_CONTRACTID, &amp;rv);</span>
<a href="#l59.408"></a><span id="l59.408">         // this checks if psm is installed...</span>
<a href="#l59.409"></a><span id="l59.409">         if (NS_SUCCEEDED(rv))</span>
<a href="#l59.410"></a><span id="l59.410">         {</span>
<a href="#l59.411"></a><span id="l59.411">           if (NS_SUCCEEDED(GetApopTimestamp()))</span>
<a href="#l59.412"></a><span id="l59.412">             SetCapFlag(POP3_HAS_AUTH_APOP);</span>
<a href="#l59.413"></a><span id="l59.413" class="difflineat">@@ -1045,17 +1048,20 @@ nsPop3Protocol::WaitForResponse(nsIInput</span>
<a href="#l59.414"></a><span id="l59.414">     else</span>
<a href="#l59.415"></a><span id="l59.415">       m_commandResponse  = line;</span>
<a href="#l59.416"></a><span id="l59.416"> </span>
<a href="#l59.417"></a><span id="l59.417">     // search for the response codes (RFC 2449, chapter 8 and RFC 3206)</span>
<a href="#l59.418"></a><span id="l59.418">     if(TestCapFlag(POP3_HAS_RESP_CODES | POP3_HAS_AUTH_RESP_CODE))</span>
<a href="#l59.419"></a><span id="l59.419">     {</span>
<a href="#l59.420"></a><span id="l59.420">         // code for authentication failure due to the user's credentials</span>
<a href="#l59.421"></a><span id="l59.421">         if(m_commandResponse.Find(&quot;[AUTH&quot;, PR_TRUE) &gt;= 0)</span>
<a href="#l59.422"></a><span id="l59.422" class="difflineplus">+        {</span>
<a href="#l59.423"></a><span id="l59.423" class="difflineplus">+          PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;setting auth failure&quot;));</span>
<a href="#l59.424"></a><span id="l59.424">           SetFlag(POP3_AUTH_FAILURE);</span>
<a href="#l59.425"></a><span id="l59.425" class="difflineplus">+        }</span>
<a href="#l59.426"></a><span id="l59.426"> </span>
<a href="#l59.427"></a><span id="l59.427">         // codes for failures due to other reasons</span>
<a href="#l59.428"></a><span id="l59.428">         if(m_commandResponse.Find(&quot;[LOGIN-DELAY&quot;, PR_TRUE) &gt;= 0 ||</span>
<a href="#l59.429"></a><span id="l59.429">            m_commandResponse.Find(&quot;[IN-USE&quot;, PR_TRUE) &gt;= 0 ||</span>
<a href="#l59.430"></a><span id="l59.430">            m_commandResponse.Find(&quot;[SYS&quot;, PR_TRUE) &gt;= 0)</span>
<a href="#l59.431"></a><span id="l59.431">       SetFlag(POP3_STOPLOGIN);</span>
<a href="#l59.432"></a><span id="l59.432"> </span>
<a href="#l59.433"></a><span id="l59.433">       // remove the codes from the response string presented to the user</span>
<a href="#l59.434"></a><span id="l59.434" class="difflineat">@@ -1246,24 +1252,20 @@ PRInt32 nsPop3Protocol::AuthResponse(nsI</span>
<a href="#l59.435"></a><span id="l59.435"> }</span>
<a href="#l59.436"></a><span id="l59.436"> </span>
<a href="#l59.437"></a><span id="l59.437"> /*</span>
<a href="#l59.438"></a><span id="l59.438">  * POP3 CAPA extension, see RFC 2449, chapter 5</span>
<a href="#l59.439"></a><span id="l59.439">  */</span>
<a href="#l59.440"></a><span id="l59.440"> </span>
<a href="#l59.441"></a><span id="l59.441"> PRInt32 nsPop3Protocol::SendCapa()</span>
<a href="#l59.442"></a><span id="l59.442"> {</span>
<a href="#l59.443"></a><span id="l59.443" class="difflineplus">+    PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;SendCapa()&quot;));</span>
<a href="#l59.444"></a><span id="l59.444">     if(!m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l59.445"></a><span id="l59.445">         return(Error(POP3_SERVER_ERROR));</span>
<a href="#l59.446"></a><span id="l59.446"> </span>
<a href="#l59.447"></a><span id="l59.447" class="difflineminus">-    // for use after mechs disabled fallbacks when login failed</span>
<a href="#l59.448"></a><span id="l59.448" class="difflineminus">-    // should better live in AuthResponse(), but it would only</span>
<a href="#l59.449"></a><span id="l59.449" class="difflineminus">-    // be called the first time then</span>
<a href="#l59.450"></a><span id="l59.450" class="difflineminus">-    BackupAuthFlags();</span>
<a href="#l59.451"></a><span id="l59.451" class="difflineminus">-</span>
<a href="#l59.452"></a><span id="l59.452">     nsCAutoString command(&quot;CAPA&quot; CRLF);</span>
<a href="#l59.453"></a><span id="l59.453"> </span>
<a href="#l59.454"></a><span id="l59.454">     m_pop3ConData-&gt;next_state_after_response = POP3_CAPA_RESPONSE;</span>
<a href="#l59.455"></a><span id="l59.455">     return SendData(m_url, command.get());</span>
<a href="#l59.456"></a><span id="l59.456"> }</span>
<a href="#l59.457"></a><span id="l59.457"> </span>
<a href="#l59.458"></a><span id="l59.458"> PRInt32 nsPop3Protocol::CapaResponse(nsIInputStream* inputStream,</span>
<a href="#l59.459"></a><span id="l59.459">                              PRUint32 length)</span>
<a href="#l59.460"></a><span id="l59.460" class="difflineat">@@ -1361,21 +1363,20 @@ PRInt32 nsPop3Protocol::CapaResponse(nsI</span>
<a href="#l59.461"></a><span id="l59.461">             if (responseLine.Find(&quot;NTLM&quot;, PR_TRUE) &gt;= 0)</span>
<a href="#l59.462"></a><span id="l59.462">                 SetCapFlag(POP3_HAS_AUTH_NTLM);</span>
<a href="#l59.463"></a><span id="l59.463"> </span>
<a href="#l59.464"></a><span id="l59.464">             if (responseLine.Find(&quot;MSN&quot;, PR_TRUE) &gt;= 0)</span>
<a href="#l59.465"></a><span id="l59.465">                 SetCapFlag(POP3_HAS_AUTH_NTLM|POP3_HAS_AUTH_MSN);</span>
<a href="#l59.466"></a><span id="l59.466">         }</span>
<a href="#l59.467"></a><span id="l59.467"> </span>
<a href="#l59.468"></a><span id="l59.468">         m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l59.469"></a><span id="l59.469" class="difflineminus">-        // for use after mechs disabled fallbacks when login failed</span>
<a href="#l59.470"></a><span id="l59.470" class="difflineminus">-        BackupAuthFlags();</span>
<a href="#l59.471"></a><span id="l59.471">     }</span>
<a href="#l59.472"></a><span id="l59.472"> </span>
<a href="#l59.473"></a><span id="l59.473">     PR_Free(line);</span>
<a href="#l59.474"></a><span id="l59.474" class="difflineplus">+    PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;capa processed&quot;));</span>
<a href="#l59.475"></a><span id="l59.475">     return 0;</span>
<a href="#l59.476"></a><span id="l59.476"> }</span>
<a href="#l59.477"></a><span id="l59.477"> </span>
<a href="#l59.478"></a><span id="l59.478"> PRInt32 nsPop3Protocol::SendTLSResponse()</span>
<a href="#l59.479"></a><span id="l59.479"> {</span>
<a href="#l59.480"></a><span id="l59.480">   // only tear down our existing connection and open a new one if we received</span>
<a href="#l59.481"></a><span id="l59.481">   // a +OK response from the pop server after we issued the STLS command</span>
<a href="#l59.482"></a><span id="l59.482">   nsresult rv = NS_OK;</span>
<a href="#l59.483"></a><span id="l59.483" class="difflineat">@@ -1417,203 +1418,331 @@ PRInt32 nsPop3Protocol::SendTLSResponse(</span>
<a href="#l59.484"></a><span id="l59.484">   }</span>
<a href="#l59.485"></a><span id="l59.485"> </span>
<a href="#l59.486"></a><span id="l59.486">   ClearFlag(POP3_HAS_STLS);</span>
<a href="#l59.487"></a><span id="l59.487">   m_pop3ConData-&gt;next_state = POP3_PROCESS_AUTH;</span>
<a href="#l59.488"></a><span id="l59.488"> </span>
<a href="#l59.489"></a><span id="l59.489">   return rv;</span>
<a href="#l59.490"></a><span id="l59.490"> }</span>
<a href="#l59.491"></a><span id="l59.491"> </span>
<a href="#l59.492"></a><span id="l59.492" class="difflineplus">+void nsPop3Protocol::InitPrefAuthMethods(PRInt32 authMethodPrefValue)</span>
<a href="#l59.493"></a><span id="l59.493" class="difflineplus">+{</span>
<a href="#l59.494"></a><span id="l59.494" class="difflineplus">+  // for m_prefAuthMethods, using the same flags as server capablities.</span>
<a href="#l59.495"></a><span id="l59.495" class="difflineplus">+  switch (authMethodPrefValue)</span>
<a href="#l59.496"></a><span id="l59.496" class="difflineplus">+  {</span>
<a href="#l59.497"></a><span id="l59.497" class="difflineplus">+    case nsMsgAuthMethod::none:</span>
<a href="#l59.498"></a><span id="l59.498" class="difflineplus">+      m_prefAuthMethods = POP3_HAS_AUTH_NONE;</span>
<a href="#l59.499"></a><span id="l59.499" class="difflineplus">+      break;</span>
<a href="#l59.500"></a><span id="l59.500" class="difflineplus">+    case nsMsgAuthMethod::old:</span>
<a href="#l59.501"></a><span id="l59.501" class="difflineplus">+      m_prefAuthMethods = POP3_HAS_AUTH_USER;</span>
<a href="#l59.502"></a><span id="l59.502" class="difflineplus">+      break;</span>
<a href="#l59.503"></a><span id="l59.503" class="difflineplus">+    case nsMsgAuthMethod::passwordCleartext:</span>
<a href="#l59.504"></a><span id="l59.504" class="difflineplus">+      m_prefAuthMethods = POP3_HAS_AUTH_USER |</span>
<a href="#l59.505"></a><span id="l59.505" class="difflineplus">+          POP3_HAS_AUTH_LOGIN | POP3_HAS_AUTH_PLAIN;</span>
<a href="#l59.506"></a><span id="l59.506" class="difflineplus">+      break;</span>
<a href="#l59.507"></a><span id="l59.507" class="difflineplus">+    case nsMsgAuthMethod::passwordEncrypted:</span>
<a href="#l59.508"></a><span id="l59.508" class="difflineplus">+      m_prefAuthMethods = POP3_HAS_AUTH_CRAM_MD5 |</span>
<a href="#l59.509"></a><span id="l59.509" class="difflineplus">+          POP3_HAS_AUTH_APOP;</span>
<a href="#l59.510"></a><span id="l59.510" class="difflineplus">+      break;</span>
<a href="#l59.511"></a><span id="l59.511" class="difflineplus">+    case nsMsgAuthMethod::NTLM:</span>
<a href="#l59.512"></a><span id="l59.512" class="difflineplus">+      m_prefAuthMethods = POP3_HAS_AUTH_NTLM | POP3_HAS_AUTH_MSN;</span>
<a href="#l59.513"></a><span id="l59.513" class="difflineplus">+      break;</span>
<a href="#l59.514"></a><span id="l59.514" class="difflineplus">+    case nsMsgAuthMethod::GSSAPI:</span>
<a href="#l59.515"></a><span id="l59.515" class="difflineplus">+      m_prefAuthMethods = POP3_HAS_AUTH_GSSAPI;</span>
<a href="#l59.516"></a><span id="l59.516" class="difflineplus">+      break;</span>
<a href="#l59.517"></a><span id="l59.517" class="difflineplus">+    case nsMsgAuthMethod::secure:</span>
<a href="#l59.518"></a><span id="l59.518" class="difflineplus">+      m_prefAuthMethods = POP3_HAS_AUTH_APOP |</span>
<a href="#l59.519"></a><span id="l59.519" class="difflineplus">+          POP3_HAS_AUTH_CRAM_MD5 | POP3_HAS_AUTH_GSSAPI |</span>
<a href="#l59.520"></a><span id="l59.520" class="difflineplus">+          POP3_HAS_AUTH_NTLM | POP3_HAS_AUTH_MSN;</span>
<a href="#l59.521"></a><span id="l59.521" class="difflineplus">+      break;</span>
<a href="#l59.522"></a><span id="l59.522" class="difflineplus">+    default:</span>
<a href="#l59.523"></a><span id="l59.523" class="difflineplus">+      NS_ASSERTION(false, &quot;POP: authMethod pref invalid&quot;);</span>
<a href="#l59.524"></a><span id="l59.524" class="difflineplus">+      // TODO log to error console</span>
<a href="#l59.525"></a><span id="l59.525" class="difflineplus">+      PR_LOG(POP3LOGMODULE, PR_LOG_ERROR,</span>
<a href="#l59.526"></a><span id="l59.526" class="difflineplus">+          (&quot;POP: bad pref authMethod = %d\n&quot;, authMethodPrefValue));</span>
<a href="#l59.527"></a><span id="l59.527" class="difflineplus">+      // fall to any</span>
<a href="#l59.528"></a><span id="l59.528" class="difflineplus">+    case nsMsgAuthMethod::anything:</span>
<a href="#l59.529"></a><span id="l59.529" class="difflineplus">+      m_prefAuthMethods = POP3_HAS_AUTH_USER |</span>
<a href="#l59.530"></a><span id="l59.530" class="difflineplus">+          POP3_HAS_AUTH_LOGIN | POP3_HAS_AUTH_PLAIN |</span>
<a href="#l59.531"></a><span id="l59.531" class="difflineplus">+          POP3_HAS_AUTH_CRAM_MD5 | POP3_HAS_AUTH_APOP |</span>
<a href="#l59.532"></a><span id="l59.532" class="difflineplus">+          POP3_HAS_AUTH_GSSAPI |</span>
<a href="#l59.533"></a><span id="l59.533" class="difflineplus">+          POP3_HAS_AUTH_NTLM | POP3_HAS_AUTH_MSN;</span>
<a href="#l59.534"></a><span id="l59.534" class="difflineplus">+      // TODO needed?</span>
<a href="#l59.535"></a><span id="l59.535" class="difflineplus">+      break;</span>
<a href="#l59.536"></a><span id="l59.536" class="difflineplus">+  }</span>
<a href="#l59.537"></a><span id="l59.537" class="difflineplus">+  NS_ASSERTION(m_prefAuthMethods != POP3_AUTH_MECH_UNDEFINED,</span>
<a href="#l59.538"></a><span id="l59.538" class="difflineplus">+      &quot;POP: InitPrefAuthMethods() didn't work&quot;);</span>
<a href="#l59.539"></a><span id="l59.539" class="difflineplus">+}</span>
<a href="#l59.540"></a><span id="l59.540" class="difflineplus">+</span>
<a href="#l59.541"></a><span id="l59.541" class="difflineplus">+/**</span>
<a href="#l59.542"></a><span id="l59.542" class="difflineplus">+ * Changes m_currentAuthMethod to pick the best one</span>
<a href="#l59.543"></a><span id="l59.543" class="difflineplus">+ * which is allowed by server and prefs and not marked failed.</span>
<a href="#l59.544"></a><span id="l59.544" class="difflineplus">+ * The order of preference and trying of auth methods is encoded here.</span>
<a href="#l59.545"></a><span id="l59.545" class="difflineplus">+ */</span>
<a href="#l59.546"></a><span id="l59.546" class="difflineplus">+nsresult nsPop3Protocol::ChooseAuthMethod()</span>
<a href="#l59.547"></a><span id="l59.547" class="difflineplus">+{</span>
<a href="#l59.548"></a><span id="l59.548" class="difflineplus">+  PRInt32 availCaps = GetCapFlags() &amp; m_prefAuthMethods &amp; ~m_failedAuthMethods;</span>
<a href="#l59.549"></a><span id="l59.549" class="difflineplus">+</span>
<a href="#l59.550"></a><span id="l59.550" class="difflineplus">+  PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG,</span>
<a href="#l59.551"></a><span id="l59.551" class="difflineplus">+        (&quot;POP auth: server caps 0x%X, pref 0x%X, failed 0x%X, avail caps 0x%X&quot;,</span>
<a href="#l59.552"></a><span id="l59.552" class="difflineplus">+        GetCapFlags(), m_prefAuthMethods, m_failedAuthMethods, availCaps));</span>
<a href="#l59.553"></a><span id="l59.553" class="difflineplus">+  PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG,</span>
<a href="#l59.554"></a><span id="l59.554" class="difflineplus">+        (&quot;(GSSAPI = 0x%X, CRAM = 0x%X, APOP = 0x%X, NTLM = 0x%X, &quot;</span>
<a href="#l59.555"></a><span id="l59.555" class="difflineplus">+        &quot;MSN =  0x%X, PLAIN = 0x%X, LOGIN = 0x%X, USER/PASS = 0x%X)&quot;,</span>
<a href="#l59.556"></a><span id="l59.556" class="difflineplus">+        POP3_HAS_AUTH_GSSAPI, POP3_HAS_AUTH_CRAM_MD5, POP3_HAS_AUTH_APOP,</span>
<a href="#l59.557"></a><span id="l59.557" class="difflineplus">+        POP3_HAS_AUTH_NTLM, POP3_HAS_AUTH_MSN, POP3_HAS_AUTH_PLAIN,</span>
<a href="#l59.558"></a><span id="l59.558" class="difflineplus">+        POP3_HAS_AUTH_LOGIN, POP3_HAS_AUTH_USER));</span>
<a href="#l59.559"></a><span id="l59.559" class="difflineplus">+</span>
<a href="#l59.560"></a><span id="l59.560" class="difflineplus">+  if (POP3_HAS_AUTH_GSSAPI &amp; availCaps)</span>
<a href="#l59.561"></a><span id="l59.561" class="difflineplus">+    m_currentAuthMethod = POP3_HAS_AUTH_GSSAPI;</span>
<a href="#l59.562"></a><span id="l59.562" class="difflineplus">+  else if (POP3_HAS_AUTH_CRAM_MD5 &amp; availCaps)</span>
<a href="#l59.563"></a><span id="l59.563" class="difflineplus">+    m_currentAuthMethod = POP3_HAS_AUTH_CRAM_MD5;</span>
<a href="#l59.564"></a><span id="l59.564" class="difflineplus">+  else if (POP3_HAS_AUTH_APOP &amp; availCaps)</span>
<a href="#l59.565"></a><span id="l59.565" class="difflineplus">+    m_currentAuthMethod = POP3_HAS_AUTH_APOP;</span>
<a href="#l59.566"></a><span id="l59.566" class="difflineplus">+  else if (POP3_HAS_AUTH_NTLM &amp; availCaps)</span>
<a href="#l59.567"></a><span id="l59.567" class="difflineplus">+    m_currentAuthMethod = POP3_HAS_AUTH_NTLM;</span>
<a href="#l59.568"></a><span id="l59.568" class="difflineplus">+  else if (POP3_HAS_AUTH_MSN &amp; availCaps)</span>
<a href="#l59.569"></a><span id="l59.569" class="difflineplus">+    m_currentAuthMethod = POP3_HAS_AUTH_MSN;</span>
<a href="#l59.570"></a><span id="l59.570" class="difflineplus">+  else if (POP3_HAS_AUTH_PLAIN &amp; availCaps)</span>
<a href="#l59.571"></a><span id="l59.571" class="difflineplus">+    m_currentAuthMethod = POP3_HAS_AUTH_PLAIN;</span>
<a href="#l59.572"></a><span id="l59.572" class="difflineplus">+  else if (POP3_HAS_AUTH_LOGIN &amp; availCaps)</span>
<a href="#l59.573"></a><span id="l59.573" class="difflineplus">+    m_currentAuthMethod = POP3_HAS_AUTH_LOGIN;</span>
<a href="#l59.574"></a><span id="l59.574" class="difflineplus">+  else if (POP3_HAS_AUTH_USER &amp; availCaps)</span>
<a href="#l59.575"></a><span id="l59.575" class="difflineplus">+    m_currentAuthMethod = POP3_HAS_AUTH_USER;</span>
<a href="#l59.576"></a><span id="l59.576" class="difflineplus">+  else</span>
<a href="#l59.577"></a><span id="l59.577" class="difflineplus">+  {</span>
<a href="#l59.578"></a><span id="l59.578" class="difflineplus">+    // there are no matching login schemes at all, per server and prefs</span>
<a href="#l59.579"></a><span id="l59.579" class="difflineplus">+    m_currentAuthMethod = POP3_AUTH_MECH_UNDEFINED;</span>
<a href="#l59.580"></a><span id="l59.580" class="difflineplus">+    PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;no auth method remaining&quot;));</span>
<a href="#l59.581"></a><span id="l59.581" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l59.582"></a><span id="l59.582" class="difflineplus">+  }</span>
<a href="#l59.583"></a><span id="l59.583" class="difflineplus">+  PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;trying auth method 0x%X&quot;, m_currentAuthMethod));</span>
<a href="#l59.584"></a><span id="l59.584" class="difflineplus">+  return NS_OK;</span>
<a href="#l59.585"></a><span id="l59.585" class="difflineplus">+}</span>
<a href="#l59.586"></a><span id="l59.586" class="difflineplus">+</span>
<a href="#l59.587"></a><span id="l59.587" class="difflineplus">+void nsPop3Protocol::MarkAuthMethodAsFailed(PRInt32 failedAuthMethod)</span>
<a href="#l59.588"></a><span id="l59.588" class="difflineplus">+{</span>
<a href="#l59.589"></a><span id="l59.589" class="difflineplus">+  PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG,</span>
<a href="#l59.590"></a><span id="l59.590" class="difflineplus">+      (&quot;marking auth method 0x%X failed&quot;, failedAuthMethod));</span>
<a href="#l59.591"></a><span id="l59.591" class="difflineplus">+  m_failedAuthMethods |= failedAuthMethod;</span>
<a href="#l59.592"></a><span id="l59.592" class="difflineplus">+}</span>
<a href="#l59.593"></a><span id="l59.593" class="difflineplus">+</span>
<a href="#l59.594"></a><span id="l59.594" class="difflineplus">+/**</span>
<a href="#l59.595"></a><span id="l59.595" class="difflineplus">+ * Start over, trying all auth methods again</span>
<a href="#l59.596"></a><span id="l59.596" class="difflineplus">+ */</span>
<a href="#l59.597"></a><span id="l59.597" class="difflineplus">+void nsPop3Protocol::ResetAuthMethods()</span>
<a href="#l59.598"></a><span id="l59.598" class="difflineplus">+{</span>
<a href="#l59.599"></a><span id="l59.599" class="difflineplus">+  PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;resetting (failed) auth methods&quot;));</span>
<a href="#l59.600"></a><span id="l59.600" class="difflineplus">+  m_currentAuthMethod = POP3_AUTH_MECH_UNDEFINED;</span>
<a href="#l59.601"></a><span id="l59.601" class="difflineplus">+  m_failedAuthMethods = 0;</span>
<a href="#l59.602"></a><span id="l59.602" class="difflineplus">+}</span>
<a href="#l59.603"></a><span id="l59.603" class="difflineplus">+</span>
<a href="#l59.604"></a><span id="l59.604" class="difflineplus">+/**</span>
<a href="#l59.605"></a><span id="l59.605" class="difflineplus">+ * state POP3_PROCESS_AUTH</span>
<a href="#l59.606"></a><span id="l59.606" class="difflineplus">+ * Called when we should try to authenticate to the server.</span>
<a href="#l59.607"></a><span id="l59.607" class="difflineplus">+ * Also called when one auth method fails and we want to try and start</span>
<a href="#l59.608"></a><span id="l59.608" class="difflineplus">+ * the next best auth method.</span>
<a href="#l59.609"></a><span id="l59.609" class="difflineplus">+ */</span>
<a href="#l59.610"></a><span id="l59.610"> PRInt32 nsPop3Protocol::ProcessAuth()</span>
<a href="#l59.611"></a><span id="l59.611"> {</span>
<a href="#l59.612"></a><span id="l59.612" class="difflineplus">+    PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;ProcessAuth()&quot;));</span>
<a href="#l59.613"></a><span id="l59.613" class="difflineplus">+</span>
<a href="#l59.614"></a><span id="l59.614" class="difflineplus">+    // Try to upgrade to STARTTLS -- TODO move into its own function</span>
<a href="#l59.615"></a><span id="l59.615">     if (!m_tlsEnabled)</span>
<a href="#l59.616"></a><span id="l59.616">     {</span>
<a href="#l59.617"></a><span id="l59.617">       if(TestCapFlag(POP3_HAS_STLS))</span>
<a href="#l59.618"></a><span id="l59.618">       {</span>
<a href="#l59.619"></a><span id="l59.619" class="difflineminus">-        if (m_socketType == nsIMsgIncomingServer::tryTLS ||</span>
<a href="#l59.620"></a><span id="l59.620" class="difflineminus">-            m_socketType == nsIMsgIncomingServer::alwaysUseTLS)</span>
<a href="#l59.621"></a><span id="l59.621" class="difflineplus">+        if (m_socketType == nsMsgSocketType::trySTARTTLS ||</span>
<a href="#l59.622"></a><span id="l59.622" class="difflineplus">+            m_socketType == nsMsgSocketType::alwaysSTARTTLS)</span>
<a href="#l59.623"></a><span id="l59.623">         {</span>
<a href="#l59.624"></a><span id="l59.624">             nsCAutoString command(&quot;STLS&quot; CRLF);</span>
<a href="#l59.625"></a><span id="l59.625"> </span>
<a href="#l59.626"></a><span id="l59.626">             m_pop3ConData-&gt;next_state_after_response = POP3_TLS_RESPONSE;</span>
<a href="#l59.627"></a><span id="l59.627">             return SendData(m_url, command.get());</span>
<a href="#l59.628"></a><span id="l59.628">         }</span>
<a href="#l59.629"></a><span id="l59.629">       }</span>
<a href="#l59.630"></a><span id="l59.630" class="difflineminus">-      else if (m_socketType == nsIMsgIncomingServer::alwaysUseTLS)</span>
<a href="#l59.631"></a><span id="l59.631" class="difflineplus">+      else if (m_socketType == nsMsgSocketType::alwaysSTARTTLS)</span>
<a href="#l59.632"></a><span id="l59.632">       {</span>
<a href="#l59.633"></a><span id="l59.633">           m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l59.634"></a><span id="l59.634">           return(Error(NS_ERROR_COULD_NOT_CONNECT_VIA_TLS));</span>
<a href="#l59.635"></a><span id="l59.635">       }</span>
<a href="#l59.636"></a><span id="l59.636">     }</span>
<a href="#l59.637"></a><span id="l59.637"> </span>
<a href="#l59.638"></a><span id="l59.638">     m_password_already_sent = PR_FALSE;</span>
<a href="#l59.639"></a><span id="l59.639"> </span>
<a href="#l59.640"></a><span id="l59.640" class="difflineminus">-    if(m_useSecAuth)</span>
<a href="#l59.641"></a><span id="l59.641" class="difflineplus">+    nsresult rv = ChooseAuthMethod();</span>
<a href="#l59.642"></a><span id="l59.642" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l59.643"></a><span id="l59.643">     {</span>
<a href="#l59.644"></a><span id="l59.644" class="difflineminus">-      if (TestCapFlag(POP3_HAS_AUTH_GSSAPI))</span>
<a href="#l59.645"></a><span id="l59.645" class="difflineminus">-          m_pop3ConData-&gt;next_state = POP3_AUTH_GSSAPI;</span>
<a href="#l59.646"></a><span id="l59.646" class="difflineminus">-      else if (TestCapFlag(POP3_HAS_AUTH_CRAM_MD5))</span>
<a href="#l59.647"></a><span id="l59.647" class="difflineminus">-          m_pop3ConData-&gt;next_state = POP3_SEND_USERNAME;</span>
<a href="#l59.648"></a><span id="l59.648" class="difflineminus">-      else</span>
<a href="#l59.649"></a><span id="l59.649" class="difflineminus">-        if (TestCapFlag(POP3_HAS_AUTH_NTLM))</span>
<a href="#l59.650"></a><span id="l59.650" class="difflineminus">-            m_pop3ConData-&gt;next_state = POP3_AUTH_NTLM;</span>
<a href="#l59.651"></a><span id="l59.651" class="difflineminus">-        else</span>
<a href="#l59.652"></a><span id="l59.652" class="difflineminus">-        if (TestCapFlag(POP3_HAS_AUTH_APOP))</span>
<a href="#l59.653"></a><span id="l59.653" class="difflineminus">-            m_pop3ConData-&gt;next_state = POP3_SEND_PASSWORD;</span>
<a href="#l59.654"></a><span id="l59.654" class="difflineplus">+      // Pref doesn't match server. Now, find an appropriate error msg.</span>
<a href="#l59.655"></a><span id="l59.655" class="difflineplus">+      PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG,</span>
<a href="#l59.656"></a><span id="l59.656" class="difflineplus">+           (&quot;ProcessAuth() early exit because no auth methods&quot;));</span>
<a href="#l59.657"></a><span id="l59.657" class="difflineplus">+</span>
<a href="#l59.658"></a><span id="l59.658" class="difflineplus">+      // AuthGSSAPI* falls in here in case of an auth failure.</span>
<a href="#l59.659"></a><span id="l59.659" class="difflineplus">+      // If Kerberos was the only method, assume that</span>
<a href="#l59.660"></a><span id="l59.660" class="difflineplus">+      // the user is just not logged in yet, and show an appropriate error.</span>
<a href="#l59.661"></a><span id="l59.661" class="difflineplus">+      if (m_prefAuthMethods == POP3_HAS_AUTH_GSSAPI &amp;&amp;</span>
<a href="#l59.662"></a><span id="l59.662" class="difflineplus">+          m_failedAuthMethods == POP3_HAS_AUTH_GSSAPI)</span>
<a href="#l59.663"></a><span id="l59.663" class="difflineplus">+        return Error(POP3_GSSAPI_FAILURE);</span>
<a href="#l59.664"></a><span id="l59.664" class="difflineplus">+</span>
<a href="#l59.665"></a><span id="l59.665" class="difflineplus">+      // pref has plaintext pw &amp; server claims to support encrypted pw</span>
<a href="#l59.666"></a><span id="l59.666" class="difflineplus">+      if (m_prefAuthMethods == (POP3_HAS_AUTH_USER | POP3_HAS_AUTH_LOGIN |</span>
<a href="#l59.667"></a><span id="l59.667" class="difflineplus">+              POP3_HAS_AUTH_PLAIN) &amp;&amp;</span>
<a href="#l59.668"></a><span id="l59.668" class="difflineplus">+          GetCapFlags() &amp; (POP3_HAS_AUTH_CRAM_MD5 | POP3_HAS_AUTH_APOP))</span>
<a href="#l59.669"></a><span id="l59.669" class="difflineplus">+        // tell user to change to encrypted pw</span>
<a href="#l59.670"></a><span id="l59.670" class="difflineplus">+        return Error(POP3_AUTH_CHANGE_PLAIN_TO_ENCRYPT);</span>
<a href="#l59.671"></a><span id="l59.671" class="difflineplus">+      // pref has encrypted pw &amp; server claims to support plaintext pw</span>
<a href="#l59.672"></a><span id="l59.672" class="difflineplus">+      else if (m_prefAuthMethods == (POP3_HAS_AUTH_CRAM_MD5 |</span>
<a href="#l59.673"></a><span id="l59.673" class="difflineplus">+                    POP3_HAS_AUTH_APOP) &amp;&amp;</span>
<a href="#l59.674"></a><span id="l59.674" class="difflineplus">+               GetCapFlags() &amp; (POP3_HAS_AUTH_USER | POP3_HAS_AUTH_LOGIN |</span>
<a href="#l59.675"></a><span id="l59.675" class="difflineplus">+                    POP3_HAS_AUTH_PLAIN))</span>
<a href="#l59.676"></a><span id="l59.676" class="difflineplus">+      {</span>
<a href="#l59.677"></a><span id="l59.677" class="difflineplus">+        // have SSL</span>
<a href="#l59.678"></a><span id="l59.678" class="difflineplus">+        if (m_socketType == nsMsgSocketType::SSL ||</span>
<a href="#l59.679"></a><span id="l59.679" class="difflineplus">+            m_socketType == nsMsgSocketType::alwaysSTARTTLS)</span>
<a href="#l59.680"></a><span id="l59.680" class="difflineplus">+          // tell user to change to plaintext pw</span>
<a href="#l59.681"></a><span id="l59.681" class="difflineplus">+          return Error(POP3_AUTH_CHANGE_ENCRYPT_TO_PLAIN_SSL);</span>
<a href="#l59.682"></a><span id="l59.682">         else</span>
<a href="#l59.683"></a><span id="l59.683" class="difflineminus">-          return(Error(CANNOT_PROCESS_SECURE_AUTH));</span>
<a href="#l59.684"></a><span id="l59.684" class="difflineplus">+          // tell user to change to plaintext pw, with big warning</span>
<a href="#l59.685"></a><span id="l59.685" class="difflineplus">+          return Error(POP3_AUTH_CHANGE_ENCRYPT_TO_PLAIN_NO_SSL);</span>
<a href="#l59.686"></a><span id="l59.686" class="difflineplus">+      }</span>
<a href="#l59.687"></a><span id="l59.687" class="difflineplus">+      else</span>
<a href="#l59.688"></a><span id="l59.688" class="difflineplus">+        // just &quot;change auth method&quot;</span>
<a href="#l59.689"></a><span id="l59.689" class="difflineplus">+        return Error(POP3_AUTH_MECH_NOT_SUPPORTED);</span>
<a href="#l59.690"></a><span id="l59.690">     }</span>
<a href="#l59.691"></a><span id="l59.691" class="difflineminus">-    else</span>
<a href="#l59.692"></a><span id="l59.692" class="difflineplus">+</span>
<a href="#l59.693"></a><span id="l59.693" class="difflineplus">+    switch (m_currentAuthMethod)</span>
<a href="#l59.694"></a><span id="l59.694">     {</span>
<a href="#l59.695"></a><span id="l59.695" class="difflineminus">-        if (TestCapFlag(POP3_HAS_AUTH_PLAIN))</span>
<a href="#l59.696"></a><span id="l59.696" class="difflineminus">-            m_pop3ConData-&gt;next_state = POP3_SEND_USERNAME;</span>
<a href="#l59.697"></a><span id="l59.697" class="difflineminus">-        else</span>
<a href="#l59.698"></a><span id="l59.698" class="difflineminus">-        if (TestCapFlag(POP3_HAS_AUTH_LOGIN))</span>
<a href="#l59.699"></a><span id="l59.699" class="difflineminus">-            m_pop3ConData-&gt;next_state = POP3_AUTH_LOGIN;</span>
<a href="#l59.700"></a><span id="l59.700" class="difflineminus">-        else</span>
<a href="#l59.701"></a><span id="l59.701" class="difflineminus">-        if (TestCapFlag(POP3_HAS_AUTH_USER))</span>
<a href="#l59.702"></a><span id="l59.702" class="difflineminus">-            m_pop3ConData-&gt;next_state = POP3_SEND_USERNAME;</span>
<a href="#l59.703"></a><span id="l59.703" class="difflineminus">-        else</span>
<a href="#l59.704"></a><span id="l59.704" class="difflineminus">-            return(Error(POP3_SERVER_ERROR));</span>
<a href="#l59.705"></a><span id="l59.705" class="difflineplus">+      case POP3_HAS_AUTH_GSSAPI:</span>
<a href="#l59.706"></a><span id="l59.706" class="difflineplus">+        PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;POP GSSAPI&quot;));</span>
<a href="#l59.707"></a><span id="l59.707" class="difflineplus">+        m_pop3ConData-&gt;next_state = POP3_AUTH_GSSAPI;</span>
<a href="#l59.708"></a><span id="l59.708" class="difflineplus">+        break;</span>
<a href="#l59.709"></a><span id="l59.709" class="difflineplus">+      case POP3_HAS_AUTH_APOP:</span>
<a href="#l59.710"></a><span id="l59.710" class="difflineplus">+        PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;POP APOP&quot;));</span>
<a href="#l59.711"></a><span id="l59.711" class="difflineplus">+        m_pop3ConData-&gt;next_state = POP3_SEND_PASSWORD;</span>
<a href="#l59.712"></a><span id="l59.712" class="difflineplus">+        break;</span>
<a href="#l59.713"></a><span id="l59.713" class="difflineplus">+      case POP3_HAS_AUTH_CRAM_MD5:</span>
<a href="#l59.714"></a><span id="l59.714" class="difflineplus">+        PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;POP CRAM&quot;));</span>
<a href="#l59.715"></a><span id="l59.715" class="difflineplus">+      case POP3_HAS_AUTH_PLAIN:</span>
<a href="#l59.716"></a><span id="l59.716" class="difflineplus">+      case POP3_HAS_AUTH_USER:</span>
<a href="#l59.717"></a><span id="l59.717" class="difflineplus">+        PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;POP username&quot;));</span>
<a href="#l59.718"></a><span id="l59.718" class="difflineplus">+        m_pop3ConData-&gt;next_state = POP3_SEND_USERNAME;</span>
<a href="#l59.719"></a><span id="l59.719" class="difflineplus">+        break;</span>
<a href="#l59.720"></a><span id="l59.720" class="difflineplus">+      case POP3_HAS_AUTH_LOGIN:</span>
<a href="#l59.721"></a><span id="l59.721" class="difflineplus">+        PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;POP AUTH=LOGIN&quot;));</span>
<a href="#l59.722"></a><span id="l59.722" class="difflineplus">+        m_pop3ConData-&gt;next_state = POP3_AUTH_LOGIN;</span>
<a href="#l59.723"></a><span id="l59.723" class="difflineplus">+        break;</span>
<a href="#l59.724"></a><span id="l59.724" class="difflineplus">+      case POP3_HAS_AUTH_NTLM:</span>
<a href="#l59.725"></a><span id="l59.725" class="difflineplus">+        PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;POP NTLM&quot;));</span>
<a href="#l59.726"></a><span id="l59.726" class="difflineplus">+        m_pop3ConData-&gt;next_state = POP3_AUTH_NTLM;</span>
<a href="#l59.727"></a><span id="l59.727" class="difflineplus">+        break;</span>
<a href="#l59.728"></a><span id="l59.728" class="difflineplus">+      case POP3_HAS_AUTH_NONE:</span>
<a href="#l59.729"></a><span id="l59.729" class="difflineplus">+        PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;POP no auth&quot;));</span>
<a href="#l59.730"></a><span id="l59.730" class="difflineplus">+        m_pop3ConData-&gt;command_succeeded = true;</span>
<a href="#l59.731"></a><span id="l59.731" class="difflineplus">+        m_pop3ConData-&gt;next_state = POP3_NEXT_AUTH_STEP;</span>
<a href="#l59.732"></a><span id="l59.732" class="difflineplus">+        break;</span>
<a href="#l59.733"></a><span id="l59.733" class="difflineplus">+      default:</span>
<a href="#l59.734"></a><span id="l59.734" class="difflineplus">+        PR_LOG(POP3LOGMODULE, PR_LOG_ERROR,</span>
<a href="#l59.735"></a><span id="l59.735" class="difflineplus">+             (&quot;POP: m_currentAuthMethod has unknown value&quot;));</span>
<a href="#l59.736"></a><span id="l59.736" class="difflineplus">+        return Error(POP3_AUTH_MECH_NOT_SUPPORTED);</span>
<a href="#l59.737"></a><span id="l59.737">     }</span>
<a href="#l59.738"></a><span id="l59.738"> </span>
<a href="#l59.739"></a><span id="l59.739">     m_pop3ConData-&gt;pause_for_read = PR_FALSE;</span>
<a href="#l59.740"></a><span id="l59.740"> </span>
<a href="#l59.741"></a><span id="l59.741">     return 0;</span>
<a href="#l59.742"></a><span id="l59.742"> }</span>
<a href="#l59.743"></a><span id="l59.743"> </span>
<a href="#l59.744"></a><span id="l59.744" class="difflineminus">-void nsPop3Protocol::BackupAuthFlags()</span>
<a href="#l59.745"></a><span id="l59.745" class="difflineminus">-{</span>
<a href="#l59.746"></a><span id="l59.746" class="difflineminus">-  m_origAuthFlags = m_pop3ConData-&gt;capability_flags &amp;</span>
<a href="#l59.747"></a><span id="l59.747" class="difflineminus">-                    (POP3_HAS_AUTH_ANY | POP3_HAS_AUTH_ANY_SEC);</span>
<a href="#l59.748"></a><span id="l59.748" class="difflineminus">-}</span>
<a href="#l59.749"></a><span id="l59.749" class="difflineminus">-</span>
<a href="#l59.750"></a><span id="l59.750" class="difflineminus">-void nsPop3Protocol::RestoreAuthFlags()</span>
<a href="#l59.751"></a><span id="l59.751" class="difflineplus">+/**</span>
<a href="#l59.752"></a><span id="l59.752" class="difflineplus">+ * state POP3_NEXT_AUTH_STEP</span>
<a href="#l59.753"></a><span id="l59.753" class="difflineplus">+ * This is called when we finished one auth step (e.g. sending username</span>
<a href="#l59.754"></a><span id="l59.754" class="difflineplus">+ * or password are separate steps, similarly for AUTH LOGIN, NTLM etc.)</span>
<a href="#l59.755"></a><span id="l59.755" class="difflineplus">+ * and want to proceed to the next one.</span>
<a href="#l59.756"></a><span id="l59.756" class="difflineplus">+ */</span>
<a href="#l59.757"></a><span id="l59.757" class="difflineplus">+PRInt32 nsPop3Protocol::NextAuthStep()</span>
<a href="#l59.758"></a><span id="l59.758"> {</span>
<a href="#l59.759"></a><span id="l59.759" class="difflineminus">-  m_pop3ConData-&gt;capability_flags |= m_origAuthFlags;</span>
<a href="#l59.760"></a><span id="l59.760" class="difflineminus">-}</span>
<a href="#l59.761"></a><span id="l59.761" class="difflineminus">-</span>
<a href="#l59.762"></a><span id="l59.762" class="difflineminus">-PRInt32 nsPop3Protocol::AuthFallback()</span>
<a href="#l59.763"></a><span id="l59.763" class="difflineminus">-{</span>
<a href="#l59.764"></a><span id="l59.764" class="difflineplus">+    PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;NextAuthStep()&quot;));</span>
<a href="#l59.765"></a><span id="l59.765">     if (m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l59.766"></a><span id="l59.766" class="difflineminus">-        if(m_password_already_sent)</span>
<a href="#l59.767"></a><span id="l59.767" class="difflineplus">+    {</span>
<a href="#l59.768"></a><span id="l59.768" class="difflineplus">+        if (m_password_already_sent || // (also true for GSSAPI)</span>
<a href="#l59.769"></a><span id="l59.769" class="difflineplus">+            m_currentAuthMethod == POP3_HAS_AUTH_NONE)</span>
<a href="#l59.770"></a><span id="l59.770">         {</span>
<a href="#l59.771"></a><span id="l59.771" class="difflineplus">+            PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;login succeeded&quot;));</span>
<a href="#l59.772"></a><span id="l59.772">             m_nsIPop3Sink-&gt;SetUserAuthenticated(PR_TRUE);</span>
<a href="#l59.773"></a><span id="l59.773">             ClearFlag(POP3_PASSWORD_FAILED);</span>
<a href="#l59.774"></a><span id="l59.774">             if (m_pop3ConData-&gt;verify_logon)</span>
<a href="#l59.775"></a><span id="l59.775">               m_pop3ConData-&gt;next_state = POP3_SEND_QUIT;</span>
<a href="#l59.776"></a><span id="l59.776">             else</span>
<a href="#l59.777"></a><span id="l59.777">               m_pop3ConData-&gt;next_state = (m_pop3ConData-&gt;get_url)</span>
<a href="#l59.778"></a><span id="l59.778">                                           ? POP3_SEND_GURL : POP3_SEND_STAT;</span>
<a href="#l59.779"></a><span id="l59.779">         }</span>
<a href="#l59.780"></a><span id="l59.780">         else</span>
<a href="#l59.781"></a><span id="l59.781">             m_pop3ConData-&gt;next_state = POP3_SEND_PASSWORD;</span>
<a href="#l59.782"></a><span id="l59.782" class="difflineplus">+    }</span>
<a href="#l59.783"></a><span id="l59.783">     else</span>
<a href="#l59.784"></a><span id="l59.784">     {</span>
<a href="#l59.785"></a><span id="l59.785" class="difflineplus">+        PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;command did not succeed&quot;));</span>
<a href="#l59.786"></a><span id="l59.786">         // response code received shows that login failed not because of</span>
<a href="#l59.787"></a><span id="l59.787">         // wrong credential -&gt; stop login without retry or pw dialog, only alert</span>
<a href="#l59.788"></a><span id="l59.788">         if (TestFlag(POP3_STOPLOGIN))</span>
<a href="#l59.789"></a><span id="l59.789">             return(Error((m_password_already_sent)</span>
<a href="#l59.790"></a><span id="l59.790">                          ? POP3_PASSWORD_FAILURE : POP3_USERNAME_FAILURE));</span>
<a href="#l59.791"></a><span id="l59.791"> </span>
<a href="#l59.792"></a><span id="l59.792">         // response code received shows that server is certain about the</span>
<a href="#l59.793"></a><span id="l59.793" class="difflineminus">-        // credential was wrong, or fallback has been disabled by pref</span>
<a href="#l59.794"></a><span id="l59.794" class="difflineminus">-        // -&gt; no fallback, show alert and pw dialog</span>
<a href="#l59.795"></a><span id="l59.795" class="difflineminus">-        PRBool logonFallback = PR_TRUE;</span>
<a href="#l59.796"></a><span id="l59.796" class="difflineminus">-        nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_pop3Server);</span>
<a href="#l59.797"></a><span id="l59.797" class="difflineminus">-        if (server)</span>
<a href="#l59.798"></a><span id="l59.798" class="difflineminus">-          server-&gt;GetLogonFallback(&amp;logonFallback);</span>
<a href="#l59.799"></a><span id="l59.799" class="difflineminus">-        if (!logonFallback)</span>
<a href="#l59.800"></a><span id="l59.800" class="difflineminus">-          SetFlag(POP3_AUTH_FAILURE);</span>
<a href="#l59.801"></a><span id="l59.801" class="difflineminus">-</span>
<a href="#l59.802"></a><span id="l59.802" class="difflineplus">+        // credential was wrong -&gt; no fallback, show alert and pw dialog</span>
<a href="#l59.803"></a><span id="l59.803">         if (TestFlag(POP3_AUTH_FAILURE))</span>
<a href="#l59.804"></a><span id="l59.804">         {</span>
<a href="#l59.805"></a><span id="l59.805" class="difflineplus">+            PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG,</span>
<a href="#l59.806"></a><span id="l59.806" class="difflineplus">+               (&quot;auth failure, setting password failed&quot;));</span>
<a href="#l59.807"></a><span id="l59.807">             Error((m_password_already_sent)</span>
<a href="#l59.808"></a><span id="l59.808">                          ? POP3_PASSWORD_FAILURE : POP3_USERNAME_FAILURE);</span>
<a href="#l59.809"></a><span id="l59.809">             SetFlag(POP3_PASSWORD_FAILED);</span>
<a href="#l59.810"></a><span id="l59.810">             ClearFlag(POP3_AUTH_FAILURE);</span>
<a href="#l59.811"></a><span id="l59.811" class="difflineminus">-            m_pop3ConData-&gt;logonFailureCount++;</span>
<a href="#l59.812"></a><span id="l59.812">             return 0;</span>
<a href="#l59.813"></a><span id="l59.813">         }</span>
<a href="#l59.814"></a><span id="l59.814"> </span>
<a href="#l59.815"></a><span id="l59.815" class="difflineminus">-        // we have no certain response code -&gt; fallback and try again</span>
<a href="#l59.816"></a><span id="l59.816" class="difflineminus">-        if (m_useSecAuth)</span>
<a href="#l59.817"></a><span id="l59.817" class="difflineminus">-        {</span>
<a href="#l59.818"></a><span id="l59.818" class="difflineminus">-            // If one authentication failed, we're going to</span>
<a href="#l59.819"></a><span id="l59.819" class="difflineminus">-            // fall back on a less secure login method.</span>
<a href="#l59.820"></a><span id="l59.820" class="difflineminus">-            if (TestCapFlag(POP3_HAS_AUTH_GSSAPI))</span>
<a href="#l59.821"></a><span id="l59.821" class="difflineminus">-                ClearCapFlag(POP3_HAS_AUTH_GSSAPI);</span>
<a href="#l59.822"></a><span id="l59.822" class="difflineminus">-            else if (TestCapFlag(POP3_HAS_AUTH_CRAM_MD5))</span>
<a href="#l59.823"></a><span id="l59.823" class="difflineminus">-                // if CRAM-MD5 enabled, disable it</span>
<a href="#l59.824"></a><span id="l59.824" class="difflineminus">-                ClearCapFlag(POP3_HAS_AUTH_CRAM_MD5);</span>
<a href="#l59.825"></a><span id="l59.825" class="difflineminus">-            else if (TestCapFlag(POP3_HAS_AUTH_NTLM))</span>
<a href="#l59.826"></a><span id="l59.826" class="difflineminus">-                // if NTLM enabled, disable it</span>
<a href="#l59.827"></a><span id="l59.827" class="difflineminus">-                ClearCapFlag(POP3_HAS_AUTH_NTLM|POP3_HAS_AUTH_MSN);</span>
<a href="#l59.828"></a><span id="l59.828" class="difflineminus">-            else if (TestCapFlag(POP3_HAS_AUTH_APOP))</span>
<a href="#l59.829"></a><span id="l59.829" class="difflineminus">-            {</span>
<a href="#l59.830"></a><span id="l59.830" class="difflineminus">-                // if APOP enabled, disable it</span>
<a href="#l59.831"></a><span id="l59.831" class="difflineminus">-                ClearCapFlag(POP3_HAS_AUTH_APOP);</span>
<a href="#l59.832"></a><span id="l59.832" class="difflineminus">-                // unsure because APOP failed and we can't determine why</span>
<a href="#l59.833"></a><span id="l59.833" class="difflineminus">-                Error(CANNOT_PROCESS_APOP_AUTH);</span>
<a href="#l59.834"></a><span id="l59.834" class="difflineminus">-            }</span>
<a href="#l59.835"></a><span id="l59.835" class="difflineminus">-        }</span>
<a href="#l59.836"></a><span id="l59.836" class="difflineminus">-        else</span>
<a href="#l59.837"></a><span id="l59.837" class="difflineplus">+        // We have no certain response code -&gt; fallback and try again.</span>
<a href="#l59.838"></a><span id="l59.838" class="difflineplus">+        // Mark the auth method failed, to use a different method next round.</span>
<a href="#l59.839"></a><span id="l59.839" class="difflineplus">+        MarkAuthMethodAsFailed(m_currentAuthMethod);</span>
<a href="#l59.840"></a><span id="l59.840" class="difflineplus">+</span>
<a href="#l59.841"></a><span id="l59.841" class="difflineplus">+        if (m_currentAuthMethod == POP3_HAS_AUTH_USER &amp;&amp;</span>
<a href="#l59.842"></a><span id="l59.842" class="difflineplus">+            !m_password_already_sent)</span>
<a href="#l59.843"></a><span id="l59.843">         {</span>
<a href="#l59.844"></a><span id="l59.844" class="difflineminus">-            // If one authentication failed, we're going to</span>
<a href="#l59.845"></a><span id="l59.845" class="difflineminus">-            // fall back on a less secure login method.</span>
<a href="#l59.846"></a><span id="l59.846" class="difflineminus">-            if (TestCapFlag(POP3_HAS_AUTH_PLAIN))</span>
<a href="#l59.847"></a><span id="l59.847" class="difflineminus">-                // if PLAIN enabled, disable it</span>
<a href="#l59.848"></a><span id="l59.848" class="difflineminus">-                ClearCapFlag(POP3_HAS_AUTH_PLAIN);</span>
<a href="#l59.849"></a><span id="l59.849" class="difflineminus">-            else if(TestCapFlag(POP3_HAS_AUTH_LOGIN))</span>
<a href="#l59.850"></a><span id="l59.850" class="difflineminus">-                // if LOGIN enabled, disable it</span>
<a href="#l59.851"></a><span id="l59.851" class="difflineminus">-                ClearCapFlag(POP3_HAS_AUTH_LOGIN);</span>
<a href="#l59.852"></a><span id="l59.852" class="difflineminus">-            else if(TestCapFlag(POP3_HAS_AUTH_USER))</span>
<a href="#l59.853"></a><span id="l59.853" class="difflineminus">-            {</span>
<a href="#l59.854"></a><span id="l59.854" class="difflineminus">-                if(m_password_already_sent)</span>
<a href="#l59.855"></a><span id="l59.855" class="difflineminus">-                    // if USER enabled, disable it</span>
<a href="#l59.856"></a><span id="l59.856" class="difflineminus">-                    ClearCapFlag(POP3_HAS_AUTH_USER);</span>
<a href="#l59.857"></a><span id="l59.857" class="difflineminus">-                else</span>
<a href="#l59.858"></a><span id="l59.858" class="difflineminus">-                    // if USER enabled,</span>
<a href="#l59.859"></a><span id="l59.859" class="difflineminus">-                    // it was the username which was wrong -</span>
<a href="#l59.860"></a><span id="l59.860" class="difflineminus">-                    // no fallback but return error</span>
<a href="#l59.861"></a><span id="l59.861" class="difflineminus">-                    return(Error(POP3_USERNAME_FAILURE));</span>
<a href="#l59.862"></a><span id="l59.862" class="difflineminus">-            }</span>
<a href="#l59.863"></a><span id="l59.863" class="difflineplus">+            PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;USER username failed&quot;));</span>
<a href="#l59.864"></a><span id="l59.864" class="difflineplus">+            // if USER auth method failed before sending the password,</span>
<a href="#l59.865"></a><span id="l59.865" class="difflineplus">+            // the username was wrong.</span>
<a href="#l59.866"></a><span id="l59.866" class="difflineplus">+            // no fallback but return error</span>
<a href="#l59.867"></a><span id="l59.867" class="difflineplus">+            return Error(POP3_USERNAME_FAILURE);</span>
<a href="#l59.868"></a><span id="l59.868">         }</span>
<a href="#l59.869"></a><span id="l59.869"> </span>
<a href="#l59.870"></a><span id="l59.870" class="difflineminus">-        // Only forget the password if we've no mechanism left.</span>
<a href="#l59.871"></a><span id="l59.871" class="difflineminus">-        if (m_useSecAuth &amp;&amp; !TestCapFlag(POP3_HAS_AUTH_ANY_SEC) ||</span>
<a href="#l59.872"></a><span id="l59.872" class="difflineminus">-            !m_useSecAuth &amp;&amp; !TestCapFlag(POP3_HAS_AUTH_ANY))</span>
<a href="#l59.873"></a><span id="l59.873" class="difflineplus">+        // If we have no auth method left, ask user to try with new password</span>
<a href="#l59.874"></a><span id="l59.874" class="difflineplus">+        nsresult rv = ChooseAuthMethod();</span>
<a href="#l59.875"></a><span id="l59.875" class="difflineplus">+        if (NS_FAILED(rv))</span>
<a href="#l59.876"></a><span id="l59.876">         {</span>
<a href="#l59.877"></a><span id="l59.877" class="difflineminus">-            // Let's restore the original auth flags from AuthResponse so we can</span>
<a href="#l59.878"></a><span id="l59.878" class="difflineminus">-            // try them again with new password and username</span>
<a href="#l59.879"></a><span id="l59.879" class="difflineminus">-            RestoreAuthFlags();</span>
<a href="#l59.880"></a><span id="l59.880" class="difflineminus">-            m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l59.881"></a><span id="l59.881" class="difflineminus">-</span>
<a href="#l59.882"></a><span id="l59.882" class="difflineminus">-            Error(POP3_PASSWORD_FAILURE);</span>
<a href="#l59.883"></a><span id="l59.883" class="difflineminus">-            /* The password failed.</span>
<a href="#l59.884"></a><span id="l59.884" class="difflineminus">-</span>
<a href="#l59.885"></a><span id="l59.885" class="difflineminus">-               Sever the connection and go back to the `read password' state,</span>
<a href="#l59.886"></a><span id="l59.886" class="difflineplus">+            PR_LOG(POP3LOGMODULE, PR_LOG_ERROR,</span>
<a href="#l59.887"></a><span id="l59.887" class="difflineplus">+                (&quot;POP: no auth methods remaining, setting password failure&quot;));</span>
<a href="#l59.888"></a><span id="l59.888" class="difflineplus">+            /* Sever the connection and go back to the `read password' state,</span>
<a href="#l59.889"></a><span id="l59.889">                which, upon success, will re-open the connection.  Set a flag</span>
<a href="#l59.890"></a><span id="l59.890">                which causes the prompt to be different that time (to indicate</span>
<a href="#l59.891"></a><span id="l59.891">                that the old password was bogus.)</span>
<a href="#l59.892"></a><span id="l59.892"> </span>
<a href="#l59.893"></a><span id="l59.893">                But if we're just checking for new mail (biff) then don't bother</span>
<a href="#l59.894"></a><span id="l59.894">                prompting the user for a password: just fail silently.</span>
<a href="#l59.895"></a><span id="l59.895">             */</span>
<a href="#l59.896"></a><span id="l59.896" class="difflineminus">-</span>
<a href="#l59.897"></a><span id="l59.897">             SetFlag(POP3_PASSWORD_FAILED);</span>
<a href="#l59.898"></a><span id="l59.898" class="difflineminus">-            m_pop3ConData-&gt;logonFailureCount++;</span>
<a href="#l59.899"></a><span id="l59.899" class="difflineplus">+            Error(POP3_PASSWORD_FAILURE);</span>
<a href="#l59.900"></a><span id="l59.900"> </span>
<a href="#l59.901"></a><span id="l59.901">             if (m_nsIPop3Sink)</span>
<a href="#l59.902"></a><span id="l59.902">                 m_nsIPop3Sink-&gt;SetMailAccountURL(NULL);</span>
<a href="#l59.903"></a><span id="l59.903"> </span>
<a href="#l59.904"></a><span id="l59.904">             return 0;</span>
<a href="#l59.905"></a><span id="l59.905">         }</span>
<a href="#l59.906"></a><span id="l59.906" class="difflineminus">-</span>
<a href="#l59.907"></a><span id="l59.907" class="difflineminus">-        m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l59.908"></a><span id="l59.908" class="difflineplus">+        PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG,</span>
<a href="#l59.909"></a><span id="l59.909" class="difflineplus">+           (&quot;still have some auth methods to try&quot;));</span>
<a href="#l59.910"></a><span id="l59.910" class="difflineplus">+</span>
<a href="#l59.911"></a><span id="l59.911" class="difflineplus">+        // TODO needed?</span>
<a href="#l59.912"></a><span id="l59.912" class="difflineplus">+        //m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l59.913"></a><span id="l59.913"> </span>
<a href="#l59.914"></a><span id="l59.914">         m_pop3ConData-&gt;command_succeeded = PR_TRUE;</span>
<a href="#l59.915"></a><span id="l59.915"> </span>
<a href="#l59.916"></a><span id="l59.916">         m_pop3ConData-&gt;next_state = POP3_PROCESS_AUTH;</span>
<a href="#l59.917"></a><span id="l59.917">     }</span>
<a href="#l59.918"></a><span id="l59.918"> </span>
<a href="#l59.919"></a><span id="l59.919">     if (TestCapFlag(POP3_AUTH_MECH_UNDEFINED))</span>
<a href="#l59.920"></a><span id="l59.920">     {</span>
<a href="#l59.921"></a><span id="l59.921" class="difflineat">@@ -1635,69 +1764,68 @@ PRInt32 nsPop3Protocol::AuthLogin()</span>
<a href="#l59.922"></a><span id="l59.922">     m_pop3ConData-&gt;next_state_after_response = POP3_AUTH_LOGIN_RESPONSE;</span>
<a href="#l59.923"></a><span id="l59.923">     m_pop3ConData-&gt;pause_for_read = PR_TRUE;</span>
<a href="#l59.924"></a><span id="l59.924"> </span>
<a href="#l59.925"></a><span id="l59.925">     return SendData(m_url, command.get());</span>
<a href="#l59.926"></a><span id="l59.926"> }</span>
<a href="#l59.927"></a><span id="l59.927"> </span>
<a href="#l59.928"></a><span id="l59.928"> PRInt32 nsPop3Protocol::AuthLoginResponse()</span>
<a href="#l59.929"></a><span id="l59.929"> {</span>
<a href="#l59.930"></a><span id="l59.930" class="difflineminus">-    // need the test to be here instead in AuthFallback() to</span>
<a href="#l59.931"></a><span id="l59.931" class="difflineplus">+    // need the test to be here instead in NextAuthStep() to</span>
<a href="#l59.932"></a><span id="l59.932">     // differentiate between command AUTH LOGIN failed and</span>
<a href="#l59.933"></a><span id="l59.933">     // sending username using LOGIN mechanism failed.</span>
<a href="#l59.934"></a><span id="l59.934">     if (!m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l59.935"></a><span id="l59.935">     {</span>
<a href="#l59.936"></a><span id="l59.936">         // we failed with LOGIN, remove it</span>
<a href="#l59.937"></a><span id="l59.937" class="difflineminus">-        ClearCapFlag(POP3_HAS_AUTH_LOGIN);</span>
<a href="#l59.938"></a><span id="l59.938" class="difflineminus">-</span>
<a href="#l59.939"></a><span id="l59.939" class="difflineplus">+        MarkAuthMethodAsFailed(POP3_HAS_AUTH_LOGIN);</span>
<a href="#l59.940"></a><span id="l59.940">         m_pop3ConData-&gt;next_state = POP3_PROCESS_AUTH;</span>
<a href="#l59.941"></a><span id="l59.941">     }</span>
<a href="#l59.942"></a><span id="l59.942">     else</span>
<a href="#l59.943"></a><span id="l59.943">         m_pop3ConData-&gt;next_state = POP3_SEND_USERNAME;</span>
<a href="#l59.944"></a><span id="l59.944"> </span>
<a href="#l59.945"></a><span id="l59.945">     m_pop3ConData-&gt;pause_for_read = PR_FALSE;</span>
<a href="#l59.946"></a><span id="l59.946"> </span>
<a href="#l59.947"></a><span id="l59.947">     return 0;</span>
<a href="#l59.948"></a><span id="l59.948"> }</span>
<a href="#l59.949"></a><span id="l59.949"> </span>
<a href="#l59.950"></a><span id="l59.950"> // NTLM, like LOGIN consists of three steps not two as USER/PASS or CRAM-MD5,</span>
<a href="#l59.951"></a><span id="l59.951"> // so we've to start here and continue in SendUsername if the server</span>
<a href="#l59.952"></a><span id="l59.952"> // responds + to &quot;AUTH NTLM&quot;</span>
<a href="#l59.953"></a><span id="l59.953"> PRInt32 nsPop3Protocol::AuthNtlm()</span>
<a href="#l59.954"></a><span id="l59.954"> {</span>
<a href="#l59.955"></a><span id="l59.955" class="difflineminus">-    nsCAutoString command (TestCapFlag(POP3_HAS_AUTH_MSN) ? &quot;AUTH MSN&quot; CRLF :</span>
<a href="#l59.956"></a><span id="l59.956" class="difflineminus">-                                                            &quot;AUTH NTLM&quot; CRLF);</span>
<a href="#l59.957"></a><span id="l59.957" class="difflineplus">+    nsCAutoString command (m_currentAuthMethod == POP3_HAS_AUTH_MSN</span>
<a href="#l59.958"></a><span id="l59.958" class="difflineplus">+          ? &quot;AUTH MSN&quot; CRLF : &quot;AUTH NTLM&quot; CRLF);</span>
<a href="#l59.959"></a><span id="l59.959">     m_pop3ConData-&gt;next_state_after_response = POP3_AUTH_NTLM_RESPONSE;</span>
<a href="#l59.960"></a><span id="l59.960">     m_pop3ConData-&gt;pause_for_read = PR_TRUE;</span>
<a href="#l59.961"></a><span id="l59.961"> </span>
<a href="#l59.962"></a><span id="l59.962">     return SendData(m_url, command.get());</span>
<a href="#l59.963"></a><span id="l59.963"> }</span>
<a href="#l59.964"></a><span id="l59.964"> </span>
<a href="#l59.965"></a><span id="l59.965"> PRInt32 nsPop3Protocol::AuthNtlmResponse()</span>
<a href="#l59.966"></a><span id="l59.966"> {</span>
<a href="#l59.967"></a><span id="l59.967" class="difflineminus">-    // need the test to be here instead in AuthFallback() to</span>
<a href="#l59.968"></a><span id="l59.968" class="difflineplus">+    // need the test to be here instead in NextAuthStep() to</span>
<a href="#l59.969"></a><span id="l59.969">     // differentiate between command AUTH NTLM failed and</span>
<a href="#l59.970"></a><span id="l59.970">     // sending username using NTLM mechanism failed.</span>
<a href="#l59.971"></a><span id="l59.971">     if (!m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l59.972"></a><span id="l59.972">     {</span>
<a href="#l59.973"></a><span id="l59.973" class="difflineminus">-        // we failed with NTLM, remove it</span>
<a href="#l59.974"></a><span id="l59.974" class="difflineminus">-        ClearCapFlag(POP3_HAS_AUTH_NTLM|POP3_HAS_AUTH_MSN);</span>
<a href="#l59.975"></a><span id="l59.975" class="difflineminus">-</span>
<a href="#l59.976"></a><span id="l59.976" class="difflineplus">+        MarkAuthMethodAsFailed(POP3_HAS_AUTH_NTLM);</span>
<a href="#l59.977"></a><span id="l59.977" class="difflineplus">+        MarkAuthMethodAsFailed(POP3_HAS_AUTH_MSN);</span>
<a href="#l59.978"></a><span id="l59.978">         m_pop3ConData-&gt;next_state = POP3_PROCESS_AUTH;</span>
<a href="#l59.979"></a><span id="l59.979">     }</span>
<a href="#l59.980"></a><span id="l59.980">     else</span>
<a href="#l59.981"></a><span id="l59.981">         m_pop3ConData-&gt;next_state = POP3_SEND_USERNAME;</span>
<a href="#l59.982"></a><span id="l59.982"> </span>
<a href="#l59.983"></a><span id="l59.983">     m_pop3ConData-&gt;pause_for_read = PR_FALSE;</span>
<a href="#l59.984"></a><span id="l59.984"> </span>
<a href="#l59.985"></a><span id="l59.985">     return 0;</span>
<a href="#l59.986"></a><span id="l59.986"> }</span>
<a href="#l59.987"></a><span id="l59.987"> </span>
<a href="#l59.988"></a><span id="l59.988"> PRInt32 nsPop3Protocol::AuthGSSAPI()</span>
<a href="#l59.989"></a><span id="l59.989"> {</span>
<a href="#l59.990"></a><span id="l59.990" class="difflineplus">+    PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;AuthGSSAPI()&quot;));</span>
<a href="#l59.991"></a><span id="l59.991">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_pop3Server);</span>
<a href="#l59.992"></a><span id="l59.992">     if (server) {</span>
<a href="#l59.993"></a><span id="l59.993">         nsCAutoString cmd;</span>
<a href="#l59.994"></a><span id="l59.994">         nsCAutoString service(&quot;pop@&quot;);</span>
<a href="#l59.995"></a><span id="l59.995">         nsCString hostName;</span>
<a href="#l59.996"></a><span id="l59.996">         nsresult rv;</span>
<a href="#l59.997"></a><span id="l59.997">         server-&gt;GetRealHostName(hostName);</span>
<a href="#l59.998"></a><span id="l59.998">         service.Append(hostName);</span>
<a href="#l59.999"></a><span id="l59.999" class="difflineat">@@ -1705,29 +1833,29 @@ PRInt32 nsPop3Protocol::AuthGSSAPI()</span>
<a href="#l59.1000"></a><span id="l59.1000">         if (NS_SUCCEEDED(rv)) {</span>
<a href="#l59.1001"></a><span id="l59.1001">             m_GSSAPICache.Assign(cmd);</span>
<a href="#l59.1002"></a><span id="l59.1002">             m_pop3ConData-&gt;next_state_after_response = POP3_AUTH_GSSAPI_FIRST;</span>
<a href="#l59.1003"></a><span id="l59.1003">             m_pop3ConData-&gt;pause_for_read = PR_TRUE;</span>
<a href="#l59.1004"></a><span id="l59.1004">             return SendData(m_url, &quot;AUTH GSSAPI&quot; CRLF);</span>
<a href="#l59.1005"></a><span id="l59.1005">         }</span>
<a href="#l59.1006"></a><span id="l59.1006">     }</span>
<a href="#l59.1007"></a><span id="l59.1007"> </span>
<a href="#l59.1008"></a><span id="l59.1008" class="difflineminus">-    ClearCapFlag(POP3_HAS_AUTH_GSSAPI);</span>
<a href="#l59.1009"></a><span id="l59.1009" class="difflineplus">+    MarkAuthMethodAsFailed(POP3_HAS_AUTH_GSSAPI);</span>
<a href="#l59.1010"></a><span id="l59.1010">     m_pop3ConData-&gt;next_state = POP3_PROCESS_AUTH;</span>
<a href="#l59.1011"></a><span id="l59.1011">     m_pop3ConData-&gt;pause_for_read = PR_FALSE;</span>
<a href="#l59.1012"></a><span id="l59.1012">     return NS_OK;</span>
<a href="#l59.1013"></a><span id="l59.1013"> }</span>
<a href="#l59.1014"></a><span id="l59.1014"> </span>
<a href="#l59.1015"></a><span id="l59.1015"> PRInt32 nsPop3Protocol::AuthGSSAPIResponse(PRBool first)</span>
<a href="#l59.1016"></a><span id="l59.1016"> {</span>
<a href="#l59.1017"></a><span id="l59.1017">     if (!m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l59.1018"></a><span id="l59.1018">     {</span>
<a href="#l59.1019"></a><span id="l59.1019">         if (first)</span>
<a href="#l59.1020"></a><span id="l59.1020">             m_GSSAPICache.Truncate();</span>
<a href="#l59.1021"></a><span id="l59.1021" class="difflineminus">-        ClearCapFlag(POP3_HAS_AUTH_GSSAPI);</span>
<a href="#l59.1022"></a><span id="l59.1022" class="difflineplus">+        MarkAuthMethodAsFailed(POP3_HAS_AUTH_GSSAPI);</span>
<a href="#l59.1023"></a><span id="l59.1023">         m_pop3ConData-&gt;next_state = POP3_PROCESS_AUTH;</span>
<a href="#l59.1024"></a><span id="l59.1024">         m_pop3ConData-&gt;pause_for_read = PR_FALSE;</span>
<a href="#l59.1025"></a><span id="l59.1025">         return NS_OK;</span>
<a href="#l59.1026"></a><span id="l59.1026">     }</span>
<a href="#l59.1027"></a><span id="l59.1027"> </span>
<a href="#l59.1028"></a><span id="l59.1028">     nsresult rv;</span>
<a href="#l59.1029"></a><span id="l59.1029"> </span>
<a href="#l59.1030"></a><span id="l59.1030">     m_pop3ConData-&gt;next_state_after_response = POP3_AUTH_GSSAPI_STEP;</span>
<a href="#l59.1031"></a><span id="l59.1031" class="difflineat">@@ -1735,220 +1863,248 @@ PRInt32 nsPop3Protocol::AuthGSSAPIRespon</span>
<a href="#l59.1032"></a><span id="l59.1032"> </span>
<a href="#l59.1033"></a><span id="l59.1033">     if (first) {</span>
<a href="#l59.1034"></a><span id="l59.1034">         m_GSSAPICache += CRLF;</span>
<a href="#l59.1035"></a><span id="l59.1035">         rv = SendData(m_url, m_GSSAPICache.get());</span>
<a href="#l59.1036"></a><span id="l59.1036">         m_GSSAPICache.Truncate();</span>
<a href="#l59.1037"></a><span id="l59.1037">     }</span>
<a href="#l59.1038"></a><span id="l59.1038">     else {</span>
<a href="#l59.1039"></a><span id="l59.1039">         nsCAutoString cmd;</span>
<a href="#l59.1040"></a><span id="l59.1040" class="difflineplus">+        PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;GSSAPI step 2&quot;));</span>
<a href="#l59.1041"></a><span id="l59.1041">         rv = DoGSSAPIStep2(m_commandResponse, cmd);</span>
<a href="#l59.1042"></a><span id="l59.1042">         if (NS_FAILED(rv))</span>
<a href="#l59.1043"></a><span id="l59.1043">             cmd = &quot;*&quot;;</span>
<a href="#l59.1044"></a><span id="l59.1044">         if (rv == NS_SUCCESS_AUTH_FINISHED) {</span>
<a href="#l59.1045"></a><span id="l59.1045" class="difflineminus">-            m_pop3ConData-&gt;next_state_after_response = POP3_AUTH_FALLBACK;</span>
<a href="#l59.1046"></a><span id="l59.1046" class="difflineplus">+            m_pop3ConData-&gt;next_state_after_response = POP3_NEXT_AUTH_STEP;</span>
<a href="#l59.1047"></a><span id="l59.1047">             m_password_already_sent = PR_TRUE;</span>
<a href="#l59.1048"></a><span id="l59.1048">         }</span>
<a href="#l59.1049"></a><span id="l59.1049">         cmd += CRLF;</span>
<a href="#l59.1050"></a><span id="l59.1050">         rv = SendData(m_url, cmd.get());</span>
<a href="#l59.1051"></a><span id="l59.1051">     }</span>
<a href="#l59.1052"></a><span id="l59.1052"> </span>
<a href="#l59.1053"></a><span id="l59.1053">     return rv;</span>
<a href="#l59.1054"></a><span id="l59.1054"> }</span>
<a href="#l59.1055"></a><span id="l59.1055"> </span>
<a href="#l59.1056"></a><span id="l59.1056"> PRInt32 nsPop3Protocol::SendUsername()</span>
<a href="#l59.1057"></a><span id="l59.1057"> {</span>
<a href="#l59.1058"></a><span id="l59.1058" class="difflineplus">+    PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;SendUsername()&quot;));</span>
<a href="#l59.1059"></a><span id="l59.1059">     if(m_username.IsEmpty())</span>
<a href="#l59.1060"></a><span id="l59.1060">       return(Error(POP3_USERNAME_UNDEFINED));</span>
<a href="#l59.1061"></a><span id="l59.1061"> </span>
<a href="#l59.1062"></a><span id="l59.1062" class="difflineplus">+    // &lt;copied from=&quot;SendPassword()&quot;&gt;</span>
<a href="#l59.1063"></a><span id="l59.1063" class="difflineplus">+    // Needed for NTLM</span>
<a href="#l59.1064"></a><span id="l59.1064">     nsCString password;</span>
<a href="#l59.1065"></a><span id="l59.1065">     nsresult rv = GetPassword(password);</span>
<a href="#l59.1066"></a><span id="l59.1066" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; rv == NS_MSG_PASSWORD_PROMPT_CANCELLED)</span>
<a href="#l59.1067"></a><span id="l59.1067" class="difflineplus">+    if (rv == NS_MSG_PASSWORD_PROMPT_CANCELLED) // this is a &quot;success&quot; code</span>
<a href="#l59.1068"></a><span id="l59.1068">     {</span>
<a href="#l59.1069"></a><span id="l59.1069">       // user has canceled the password prompt</span>
<a href="#l59.1070"></a><span id="l59.1070">       m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l59.1071"></a><span id="l59.1071">       return NS_ERROR_ABORT;</span>
<a href="#l59.1072"></a><span id="l59.1072">     }</span>
<a href="#l59.1073"></a><span id="l59.1073">     else if (NS_FAILED(rv) || password.IsEmpty())</span>
<a href="#l59.1074"></a><span id="l59.1074" class="difflineplus">+    {</span>
<a href="#l59.1075"></a><span id="l59.1075" class="difflineplus">+      m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l59.1076"></a><span id="l59.1076">       return Error(POP3_PASSWORD_UNDEFINED);</span>
<a href="#l59.1077"></a><span id="l59.1077" class="difflineplus">+    }</span>
<a href="#l59.1078"></a><span id="l59.1078" class="difflineplus">+    // &lt;/copied&gt;</span>
<a href="#l59.1079"></a><span id="l59.1079"> </span>
<a href="#l59.1080"></a><span id="l59.1080">     nsCAutoString cmd;</span>
<a href="#l59.1081"></a><span id="l59.1081"> </span>
<a href="#l59.1082"></a><span id="l59.1082" class="difflineminus">-    if (m_useSecAuth)</span>
<a href="#l59.1083"></a><span id="l59.1083" class="difflineplus">+    if (m_currentAuthMethod == POP3_HAS_AUTH_NTLM)</span>
<a href="#l59.1084"></a><span id="l59.1084" class="difflineplus">+        (void) DoNtlmStep1(m_username.get(), password.get(), cmd);</span>
<a href="#l59.1085"></a><span id="l59.1085" class="difflineplus">+    else if (m_currentAuthMethod == POP3_HAS_AUTH_CRAM_MD5)</span>
<a href="#l59.1086"></a><span id="l59.1086" class="difflineplus">+        cmd = &quot;AUTH CRAM-MD5&quot;;</span>
<a href="#l59.1087"></a><span id="l59.1087" class="difflineplus">+    else if (m_currentAuthMethod == POP3_HAS_AUTH_PLAIN)</span>
<a href="#l59.1088"></a><span id="l59.1088" class="difflineplus">+        cmd = &quot;AUTH PLAIN&quot;;</span>
<a href="#l59.1089"></a><span id="l59.1089" class="difflineplus">+    else if (m_currentAuthMethod == POP3_HAS_AUTH_LOGIN)</span>
<a href="#l59.1090"></a><span id="l59.1090">     {</span>
<a href="#l59.1091"></a><span id="l59.1091" class="difflineminus">-      if (TestCapFlag(POP3_HAS_AUTH_CRAM_MD5))</span>
<a href="#l59.1092"></a><span id="l59.1092" class="difflineminus">-          cmd = &quot;AUTH CRAM-MD5&quot;;</span>
<a href="#l59.1093"></a><span id="l59.1093" class="difflineminus">-      else if (TestCapFlag(POP3_HAS_AUTH_NTLM))</span>
<a href="#l59.1094"></a><span id="l59.1094" class="difflineminus">-          rv = DoNtlmStep1(m_username.get(), password.get(), cmd);</span>
<a href="#l59.1095"></a><span id="l59.1095" class="difflineplus">+        char *base64Str = PL_Base64Encode(m_username.get(), m_username.Length(), nsnull);</span>
<a href="#l59.1096"></a><span id="l59.1096" class="difflineplus">+        cmd = base64Str;</span>
<a href="#l59.1097"></a><span id="l59.1097" class="difflineplus">+        PR_Free(base64Str);</span>
<a href="#l59.1098"></a><span id="l59.1098" class="difflineplus">+    }</span>
<a href="#l59.1099"></a><span id="l59.1099" class="difflineplus">+    else if (m_currentAuthMethod == POP3_HAS_AUTH_USER)</span>
<a href="#l59.1100"></a><span id="l59.1100" class="difflineplus">+    {</span>
<a href="#l59.1101"></a><span id="l59.1101" class="difflineplus">+        PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;USER login&quot;));</span>
<a href="#l59.1102"></a><span id="l59.1102" class="difflineplus">+        cmd = &quot;USER &quot;;</span>
<a href="#l59.1103"></a><span id="l59.1103" class="difflineplus">+        cmd += m_username;</span>
<a href="#l59.1104"></a><span id="l59.1104">     }</span>
<a href="#l59.1105"></a><span id="l59.1105">     else</span>
<a href="#l59.1106"></a><span id="l59.1106">     {</span>
<a href="#l59.1107"></a><span id="l59.1107" class="difflineminus">-        if (TestCapFlag(POP3_HAS_AUTH_PLAIN))</span>
<a href="#l59.1108"></a><span id="l59.1108" class="difflineminus">-            cmd = &quot;AUTH PLAIN&quot;;</span>
<a href="#l59.1109"></a><span id="l59.1109" class="difflineminus">-        else if (TestCapFlag(POP3_HAS_AUTH_LOGIN))</span>
<a href="#l59.1110"></a><span id="l59.1110" class="difflineminus">-        {</span>
<a href="#l59.1111"></a><span id="l59.1111" class="difflineminus">-            char *base64Str = PL_Base64Encode(m_username.get(), m_username.Length(), nsnull);</span>
<a href="#l59.1112"></a><span id="l59.1112" class="difflineminus">-            cmd = base64Str;</span>
<a href="#l59.1113"></a><span id="l59.1113" class="difflineminus">-            PR_Free(base64Str);</span>
<a href="#l59.1114"></a><span id="l59.1114" class="difflineminus">-        }</span>
<a href="#l59.1115"></a><span id="l59.1115" class="difflineminus">-        else</span>
<a href="#l59.1116"></a><span id="l59.1116" class="difflineminus">-        {</span>
<a href="#l59.1117"></a><span id="l59.1117" class="difflineminus">-            cmd = &quot;USER &quot;;</span>
<a href="#l59.1118"></a><span id="l59.1118" class="difflineminus">-            cmd += m_username;</span>
<a href="#l59.1119"></a><span id="l59.1119" class="difflineminus">-        }</span>
<a href="#l59.1120"></a><span id="l59.1120" class="difflineplus">+      PR_LOG(POP3LOGMODULE, PR_LOG_ERROR,</span>
<a href="#l59.1121"></a><span id="l59.1121" class="difflineplus">+          (&quot;In nsPop3Protocol::SendUsername(), m_currentAuthMethod is 0x%X, &quot;</span>
<a href="#l59.1122"></a><span id="l59.1122" class="difflineplus">+          &quot;but that is unexpected&quot;, m_currentAuthMethod));</span>
<a href="#l59.1123"></a><span id="l59.1123" class="difflineplus">+      return Error(POP3_AUTH_INTERNAL_ERROR);</span>
<a href="#l59.1124"></a><span id="l59.1124">     }</span>
<a href="#l59.1125"></a><span id="l59.1125" class="difflineplus">+</span>
<a href="#l59.1126"></a><span id="l59.1126">     cmd += CRLF;</span>
<a href="#l59.1127"></a><span id="l59.1127"> </span>
<a href="#l59.1128"></a><span id="l59.1128" class="difflineminus">-    m_pop3ConData-&gt;next_state_after_response = POP3_AUTH_FALLBACK;</span>
<a href="#l59.1129"></a><span id="l59.1129" class="difflineplus">+    m_pop3ConData-&gt;next_state_after_response = POP3_NEXT_AUTH_STEP;</span>
<a href="#l59.1130"></a><span id="l59.1130"> </span>
<a href="#l59.1131"></a><span id="l59.1131">     m_pop3ConData-&gt;pause_for_read = PR_TRUE;</span>
<a href="#l59.1132"></a><span id="l59.1132"> </span>
<a href="#l59.1133"></a><span id="l59.1133">     return SendData(m_url, cmd.get());</span>
<a href="#l59.1134"></a><span id="l59.1134"> }</span>
<a href="#l59.1135"></a><span id="l59.1135"> </span>
<a href="#l59.1136"></a><span id="l59.1136"> PRInt32 nsPop3Protocol::SendPassword()</span>
<a href="#l59.1137"></a><span id="l59.1137"> {</span>
<a href="#l59.1138"></a><span id="l59.1138" class="difflineminus">-    if (m_username.IsEmpty())</span>
<a href="#l59.1139"></a><span id="l59.1139" class="difflineminus">-        return(Error(POP3_USERNAME_UNDEFINED));</span>
<a href="#l59.1140"></a><span id="l59.1140" class="difflineminus">-</span>
<a href="#l59.1141"></a><span id="l59.1141" class="difflineminus">-    nsCString password;</span>
<a href="#l59.1142"></a><span id="l59.1142" class="difflineminus">-    nsresult rv = GetPassword(password);</span>
<a href="#l59.1143"></a><span id="l59.1143" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; rv == NS_MSG_PASSWORD_PROMPT_CANCELLED)</span>
<a href="#l59.1144"></a><span id="l59.1144" class="difflineplus">+  PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;SendPassword()&quot;));</span>
<a href="#l59.1145"></a><span id="l59.1145" class="difflineplus">+  if (m_username.IsEmpty())</span>
<a href="#l59.1146"></a><span id="l59.1146" class="difflineplus">+    return(Error(POP3_USERNAME_UNDEFINED));</span>
<a href="#l59.1147"></a><span id="l59.1147" class="difflineplus">+</span>
<a href="#l59.1148"></a><span id="l59.1148" class="difflineplus">+  // &lt;copied to=&quot;SendUsername()&quot;&gt;</span>
<a href="#l59.1149"></a><span id="l59.1149" class="difflineplus">+  // Needed here, too, because APOP skips SendUsername()</span>
<a href="#l59.1150"></a><span id="l59.1150" class="difflineplus">+  nsCString password;</span>
<a href="#l59.1151"></a><span id="l59.1151" class="difflineplus">+  nsresult rv = GetPassword(password);</span>
<a href="#l59.1152"></a><span id="l59.1152" class="difflineplus">+  if (rv == NS_MSG_PASSWORD_PROMPT_CANCELLED) // this is a &quot;success&quot; code</span>
<a href="#l59.1153"></a><span id="l59.1153" class="difflineplus">+  {</span>
<a href="#l59.1154"></a><span id="l59.1154" class="difflineplus">+    // user has canceled the password prompt</span>
<a href="#l59.1155"></a><span id="l59.1155" class="difflineplus">+    m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l59.1156"></a><span id="l59.1156" class="difflineplus">+    return NS_ERROR_ABORT;</span>
<a href="#l59.1157"></a><span id="l59.1157" class="difflineplus">+  }</span>
<a href="#l59.1158"></a><span id="l59.1158" class="difflineplus">+  else if (NS_FAILED(rv) || password.IsEmpty())</span>
<a href="#l59.1159"></a><span id="l59.1159" class="difflineplus">+  {</span>
<a href="#l59.1160"></a><span id="l59.1160" class="difflineplus">+    m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l59.1161"></a><span id="l59.1161" class="difflineplus">+    return Error(POP3_PASSWORD_UNDEFINED);</span>
<a href="#l59.1162"></a><span id="l59.1162" class="difflineplus">+  }</span>
<a href="#l59.1163"></a><span id="l59.1163" class="difflineplus">+  // &lt;/copied&gt;</span>
<a href="#l59.1164"></a><span id="l59.1164" class="difflineplus">+</span>
<a href="#l59.1165"></a><span id="l59.1165" class="difflineplus">+  nsCAutoString cmd;</span>
<a href="#l59.1166"></a><span id="l59.1166" class="difflineplus">+</span>
<a href="#l59.1167"></a><span id="l59.1167" class="difflineplus">+  if (m_currentAuthMethod == POP3_HAS_AUTH_NTLM)</span>
<a href="#l59.1168"></a><span id="l59.1168" class="difflineplus">+    rv = DoNtlmStep2(m_commandResponse, cmd);</span>
<a href="#l59.1169"></a><span id="l59.1169" class="difflineplus">+  else if (m_currentAuthMethod == POP3_HAS_AUTH_CRAM_MD5)</span>
<a href="#l59.1170"></a><span id="l59.1170" class="difflineplus">+  {</span>
<a href="#l59.1171"></a><span id="l59.1171" class="difflineplus">+    PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;CRAM login&quot;));</span>
<a href="#l59.1172"></a><span id="l59.1172" class="difflineplus">+    char buffer[512]; // TODO nsCAutoString</span>
<a href="#l59.1173"></a><span id="l59.1173" class="difflineplus">+    unsigned char digest[DIGEST_LENGTH];</span>
<a href="#l59.1174"></a><span id="l59.1174" class="difflineplus">+</span>
<a href="#l59.1175"></a><span id="l59.1175" class="difflineplus">+    char *decodedChallenge = PL_Base64Decode(m_commandResponse.get(),</span>
<a href="#l59.1176"></a><span id="l59.1176" class="difflineplus">+    m_commandResponse.Length(), nsnull);</span>
<a href="#l59.1177"></a><span id="l59.1177" class="difflineplus">+</span>
<a href="#l59.1178"></a><span id="l59.1178" class="difflineplus">+    if (decodedChallenge)</span>
<a href="#l59.1179"></a><span id="l59.1179" class="difflineplus">+      rv = MSGCramMD5(decodedChallenge, strlen(decodedChallenge),</span>
<a href="#l59.1180"></a><span id="l59.1180" class="difflineplus">+                      password.get(), password.Length(), digest);</span>
<a href="#l59.1181"></a><span id="l59.1181" class="difflineplus">+    else</span>
<a href="#l59.1182"></a><span id="l59.1182" class="difflineplus">+      rv = NS_ERROR_NULL_POINTER;</span>
<a href="#l59.1183"></a><span id="l59.1183" class="difflineplus">+</span>
<a href="#l59.1184"></a><span id="l59.1184" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; digest)</span>
<a href="#l59.1185"></a><span id="l59.1185">     {</span>
<a href="#l59.1186"></a><span id="l59.1186" class="difflineminus">-        // user has canceled the password prompt</span>
<a href="#l59.1187"></a><span id="l59.1187" class="difflineminus">-        m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l59.1188"></a><span id="l59.1188" class="difflineminus">-        return NS_ERROR_ABORT;</span>
<a href="#l59.1189"></a><span id="l59.1189" class="difflineplus">+      nsCAutoString encodedDigest;</span>
<a href="#l59.1190"></a><span id="l59.1190" class="difflineplus">+      char hexVal[8];</span>
<a href="#l59.1191"></a><span id="l59.1191" class="difflineplus">+</span>
<a href="#l59.1192"></a><span id="l59.1192" class="difflineplus">+      for (PRUint32 j = 0; j &lt; 16; j++)</span>
<a href="#l59.1193"></a><span id="l59.1193" class="difflineplus">+      {</span>
<a href="#l59.1194"></a><span id="l59.1194" class="difflineplus">+        PR_snprintf (hexVal,8, &quot;%.2x&quot;, 0x0ff &amp; (unsigned short)digest[j]);</span>
<a href="#l59.1195"></a><span id="l59.1195" class="difflineplus">+        encodedDigest.Append(hexVal);</span>
<a href="#l59.1196"></a><span id="l59.1196" class="difflineplus">+      }</span>
<a href="#l59.1197"></a><span id="l59.1197" class="difflineplus">+</span>
<a href="#l59.1198"></a><span id="l59.1198" class="difflineplus">+      PR_snprintf(buffer, sizeof(buffer), &quot;%s %s&quot;, m_username.get(),</span>
<a href="#l59.1199"></a><span id="l59.1199" class="difflineplus">+                  encodedDigest.get());</span>
<a href="#l59.1200"></a><span id="l59.1200" class="difflineplus">+      char *base64Str = PL_Base64Encode(buffer, strlen(buffer), nsnull);</span>
<a href="#l59.1201"></a><span id="l59.1201" class="difflineplus">+      cmd = base64Str;</span>
<a href="#l59.1202"></a><span id="l59.1202" class="difflineplus">+      PR_Free(base64Str);</span>
<a href="#l59.1203"></a><span id="l59.1203">     }</span>
<a href="#l59.1204"></a><span id="l59.1204" class="difflineminus">-    else if (NS_FAILED(rv) || password.IsEmpty())</span>
<a href="#l59.1205"></a><span id="l59.1205" class="difflineminus">-    {</span>
<a href="#l59.1206"></a><span id="l59.1206" class="difflineminus">-      return Error(POP3_PASSWORD_UNDEFINED);</span>
<a href="#l59.1207"></a><span id="l59.1207" class="difflineminus">-    }</span>
<a href="#l59.1208"></a><span id="l59.1208" class="difflineminus">-</span>
<a href="#l59.1209"></a><span id="l59.1209" class="difflineminus">-    nsCAutoString cmd;</span>
<a href="#l59.1210"></a><span id="l59.1210" class="difflineminus">-    if (m_useSecAuth)</span>
<a href="#l59.1211"></a><span id="l59.1211" class="difflineplus">+</span>
<a href="#l59.1212"></a><span id="l59.1212" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l59.1213"></a><span id="l59.1213" class="difflineplus">+      cmd = &quot;*&quot;;</span>
<a href="#l59.1214"></a><span id="l59.1214" class="difflineplus">+  }</span>
<a href="#l59.1215"></a><span id="l59.1215" class="difflineplus">+  else if (m_currentAuthMethod == POP3_HAS_AUTH_APOP)</span>
<a href="#l59.1216"></a><span id="l59.1216" class="difflineplus">+  {</span>
<a href="#l59.1217"></a><span id="l59.1217" class="difflineplus">+    PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;APOP login&quot;));</span>
<a href="#l59.1218"></a><span id="l59.1218" class="difflineplus">+    char buffer[512];</span>
<a href="#l59.1219"></a><span id="l59.1219" class="difflineplus">+    unsigned char digest[DIGEST_LENGTH];</span>
<a href="#l59.1220"></a><span id="l59.1220" class="difflineplus">+</span>
<a href="#l59.1221"></a><span id="l59.1221" class="difflineplus">+    rv = MSGApopMD5(m_ApopTimestamp.get(), m_ApopTimestamp.Length(),</span>
<a href="#l59.1222"></a><span id="l59.1222" class="difflineplus">+                    password.get(), password.Length(), digest);</span>
<a href="#l59.1223"></a><span id="l59.1223" class="difflineplus">+</span>
<a href="#l59.1224"></a><span id="l59.1224" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; digest)</span>
<a href="#l59.1225"></a><span id="l59.1225">     {</span>
<a href="#l59.1226"></a><span id="l59.1226" class="difflineminus">-        if (TestCapFlag(POP3_HAS_AUTH_CRAM_MD5))</span>
<a href="#l59.1227"></a><span id="l59.1227" class="difflineminus">-        {</span>
<a href="#l59.1228"></a><span id="l59.1228" class="difflineminus">-            char buffer[512];</span>
<a href="#l59.1229"></a><span id="l59.1229" class="difflineminus">-            unsigned char digest[DIGEST_LENGTH];</span>
<a href="#l59.1230"></a><span id="l59.1230" class="difflineminus">-</span>
<a href="#l59.1231"></a><span id="l59.1231" class="difflineminus">-            char *decodedChallenge = PL_Base64Decode(m_commandResponse.get(),</span>
<a href="#l59.1232"></a><span id="l59.1232" class="difflineminus">-            m_commandResponse.Length(), nsnull);</span>
<a href="#l59.1233"></a><span id="l59.1233" class="difflineminus">-</span>
<a href="#l59.1234"></a><span id="l59.1234" class="difflineminus">-            if (decodedChallenge)</span>
<a href="#l59.1235"></a><span id="l59.1235" class="difflineminus">-                rv = MSGCramMD5(decodedChallenge, strlen(decodedChallenge), password.get(), password.Length(), digest);</span>
<a href="#l59.1236"></a><span id="l59.1236" class="difflineminus">-            else</span>
<a href="#l59.1237"></a><span id="l59.1237" class="difflineminus">-                rv = NS_ERROR_FAILURE;</span>
<a href="#l59.1238"></a><span id="l59.1238" class="difflineminus">-</span>
<a href="#l59.1239"></a><span id="l59.1239" class="difflineminus">-            if (NS_SUCCEEDED(rv) &amp;&amp; digest)</span>
<a href="#l59.1240"></a><span id="l59.1240" class="difflineminus">-            {</span>
<a href="#l59.1241"></a><span id="l59.1241" class="difflineminus">-                nsCAutoString encodedDigest;</span>
<a href="#l59.1242"></a><span id="l59.1242" class="difflineminus">-                char hexVal[8];</span>
<a href="#l59.1243"></a><span id="l59.1243" class="difflineminus">-</span>
<a href="#l59.1244"></a><span id="l59.1244" class="difflineminus">-                for (PRUint32 j=0; j&lt;16; j++)</span>
<a href="#l59.1245"></a><span id="l59.1245" class="difflineminus">-                {</span>
<a href="#l59.1246"></a><span id="l59.1246" class="difflineminus">-                    PR_snprintf (hexVal,8, &quot;%.2x&quot;, 0x0ff &amp; (unsigned short)digest[j]);</span>
<a href="#l59.1247"></a><span id="l59.1247" class="difflineminus">-                    encodedDigest.Append(hexVal);</span>
<a href="#l59.1248"></a><span id="l59.1248" class="difflineminus">-                }</span>
<a href="#l59.1249"></a><span id="l59.1249" class="difflineminus">-</span>
<a href="#l59.1250"></a><span id="l59.1250" class="difflineminus">-                PR_snprintf(buffer, sizeof(buffer), &quot;%s %s&quot;, m_username.get(), encodedDigest.get());</span>
<a href="#l59.1251"></a><span id="l59.1251" class="difflineminus">-                char *base64Str = PL_Base64Encode(buffer, strlen(buffer), nsnull);</span>
<a href="#l59.1252"></a><span id="l59.1252" class="difflineminus">-                cmd = base64Str;</span>
<a href="#l59.1253"></a><span id="l59.1253" class="difflineminus">-                PR_Free(base64Str);</span>
<a href="#l59.1254"></a><span id="l59.1254" class="difflineminus">-            }</span>
<a href="#l59.1255"></a><span id="l59.1255" class="difflineminus">-</span>
<a href="#l59.1256"></a><span id="l59.1256" class="difflineminus">-            if (NS_FAILED(rv))</span>
<a href="#l59.1257"></a><span id="l59.1257" class="difflineminus">-                cmd = &quot;*&quot;;</span>
<a href="#l59.1258"></a><span id="l59.1258" class="difflineminus">-        }</span>
<a href="#l59.1259"></a><span id="l59.1259" class="difflineminus">-        else if (TestCapFlag(POP3_HAS_AUTH_NTLM))</span>
<a href="#l59.1260"></a><span id="l59.1260" class="difflineminus">-            rv = DoNtlmStep2(m_commandResponse, cmd);</span>
<a href="#l59.1261"></a><span id="l59.1261" class="difflineminus">-        else if (TestCapFlag(POP3_HAS_AUTH_APOP))</span>
<a href="#l59.1262"></a><span id="l59.1262" class="difflineminus">-        {</span>
<a href="#l59.1263"></a><span id="l59.1263" class="difflineminus">-            char buffer[512];</span>
<a href="#l59.1264"></a><span id="l59.1264" class="difflineminus">-            unsigned char digest[DIGEST_LENGTH];</span>
<a href="#l59.1265"></a><span id="l59.1265" class="difflineminus">-</span>
<a href="#l59.1266"></a><span id="l59.1266" class="difflineminus">-            rv = MSGApopMD5(m_ApopTimestamp.get(), m_ApopTimestamp.Length(), password.get(), password.Length(), digest);</span>
<a href="#l59.1267"></a><span id="l59.1267" class="difflineminus">-</span>
<a href="#l59.1268"></a><span id="l59.1268" class="difflineminus">-            if (NS_SUCCEEDED(rv) &amp;&amp; digest)</span>
<a href="#l59.1269"></a><span id="l59.1269" class="difflineminus">-            {</span>
<a href="#l59.1270"></a><span id="l59.1270" class="difflineminus">-                nsCAutoString encodedDigest;</span>
<a href="#l59.1271"></a><span id="l59.1271" class="difflineminus">-                char hexVal[8];</span>
<a href="#l59.1272"></a><span id="l59.1272" class="difflineminus">-</span>
<a href="#l59.1273"></a><span id="l59.1273" class="difflineminus">-                for (PRUint32 j=0; j&lt;16; j++)</span>
<a href="#l59.1274"></a><span id="l59.1274" class="difflineminus">-                {</span>
<a href="#l59.1275"></a><span id="l59.1275" class="difflineminus">-                    PR_snprintf (hexVal,8, &quot;%.2x&quot;, 0x0ff &amp; (unsigned short)digest[j]);</span>
<a href="#l59.1276"></a><span id="l59.1276" class="difflineminus">-                    encodedDigest.Append(hexVal);</span>
<a href="#l59.1277"></a><span id="l59.1277" class="difflineminus">-                }</span>
<a href="#l59.1278"></a><span id="l59.1278" class="difflineminus">-</span>
<a href="#l59.1279"></a><span id="l59.1279" class="difflineminus">-                PR_snprintf(buffer, sizeof(buffer), &quot;APOP %s %s&quot;, m_username.get(), encodedDigest.get());</span>
<a href="#l59.1280"></a><span id="l59.1280" class="difflineminus">-                cmd = buffer;</span>
<a href="#l59.1281"></a><span id="l59.1281" class="difflineminus">-            }</span>
<a href="#l59.1282"></a><span id="l59.1282" class="difflineminus">-</span>
<a href="#l59.1283"></a><span id="l59.1283" class="difflineminus">-            if (NS_FAILED(rv))</span>
<a href="#l59.1284"></a><span id="l59.1284" class="difflineminus">-                cmd = &quot;*&quot;;</span>
<a href="#l59.1285"></a><span id="l59.1285" class="difflineminus">-        }</span>
<a href="#l59.1286"></a><span id="l59.1286" class="difflineplus">+      nsCAutoString encodedDigest;</span>
<a href="#l59.1287"></a><span id="l59.1287" class="difflineplus">+      char hexVal[8];</span>
<a href="#l59.1288"></a><span id="l59.1288" class="difflineplus">+</span>
<a href="#l59.1289"></a><span id="l59.1289" class="difflineplus">+      for (PRUint32 j=0; j&lt;16; j++)</span>
<a href="#l59.1290"></a><span id="l59.1290" class="difflineplus">+      {</span>
<a href="#l59.1291"></a><span id="l59.1291" class="difflineplus">+        PR_snprintf (hexVal,8, &quot;%.2x&quot;, 0x0ff &amp; (unsigned short)digest[j]);</span>
<a href="#l59.1292"></a><span id="l59.1292" class="difflineplus">+        encodedDigest.Append(hexVal);</span>
<a href="#l59.1293"></a><span id="l59.1293" class="difflineplus">+      }</span>
<a href="#l59.1294"></a><span id="l59.1294" class="difflineplus">+</span>
<a href="#l59.1295"></a><span id="l59.1295" class="difflineplus">+      PR_snprintf(buffer, sizeof(buffer), &quot;APOP %s %s&quot;, m_username.get(),</span>
<a href="#l59.1296"></a><span id="l59.1296" class="difflineplus">+                  encodedDigest.get());</span>
<a href="#l59.1297"></a><span id="l59.1297" class="difflineplus">+      cmd = buffer;</span>
<a href="#l59.1298"></a><span id="l59.1298" class="difflineplus">+    }</span>
<a href="#l59.1299"></a><span id="l59.1299" class="difflineplus">+</span>
<a href="#l59.1300"></a><span id="l59.1300" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l59.1301"></a><span id="l59.1301" class="difflineplus">+      cmd = &quot;*&quot;;</span>
<a href="#l59.1302"></a><span id="l59.1302" class="difflineplus">+  }</span>
<a href="#l59.1303"></a><span id="l59.1303" class="difflineplus">+  else if (m_currentAuthMethod == POP3_HAS_AUTH_PLAIN)</span>
<a href="#l59.1304"></a><span id="l59.1304" class="difflineplus">+  {</span>
<a href="#l59.1305"></a><span id="l59.1305" class="difflineplus">+    PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;PLAIN login&quot;));</span>
<a href="#l59.1306"></a><span id="l59.1306" class="difflineplus">+    // workaround for IPswitch's IMail server software</span>
<a href="#l59.1307"></a><span id="l59.1307" class="difflineplus">+    // this server goes into LOGIN mode even if we send &quot;AUTH PLAIN&quot;</span>
<a href="#l59.1308"></a><span id="l59.1308" class="difflineplus">+    // &quot;VXNlc&quot; is the beginning of the base64 encoded prompt (&quot;Username:&quot;) for LOGIN</span>
<a href="#l59.1309"></a><span id="l59.1309" class="difflineplus">+    if (StringBeginsWith(m_commandResponse, NS_LITERAL_CSTRING(&quot;VXNlc&quot;)))</span>
<a href="#l59.1310"></a><span id="l59.1310" class="difflineplus">+    {</span>
<a href="#l59.1311"></a><span id="l59.1311" class="difflineplus">+      // disable PLAIN and enable LOGIN (in case it's not already enabled)</span>
<a href="#l59.1312"></a><span id="l59.1312" class="difflineplus">+      ClearCapFlag(POP3_HAS_AUTH_PLAIN);</span>
<a href="#l59.1313"></a><span id="l59.1313" class="difflineplus">+      SetCapFlag(POP3_HAS_AUTH_LOGIN);</span>
<a href="#l59.1314"></a><span id="l59.1314" class="difflineplus">+      m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l59.1315"></a><span id="l59.1315" class="difflineplus">+</span>
<a href="#l59.1316"></a><span id="l59.1316" class="difflineplus">+      // reenter authentication again at LOGIN response handler</span>
<a href="#l59.1317"></a><span id="l59.1317" class="difflineplus">+      m_pop3ConData-&gt;next_state = POP3_AUTH_LOGIN_RESPONSE;</span>
<a href="#l59.1318"></a><span id="l59.1318" class="difflineplus">+      m_pop3ConData-&gt;pause_for_read = PR_FALSE;</span>
<a href="#l59.1319"></a><span id="l59.1319" class="difflineplus">+      return 0;</span>
<a href="#l59.1320"></a><span id="l59.1320">     }</span>
<a href="#l59.1321"></a><span id="l59.1321" class="difflineminus">-    else</span>
<a href="#l59.1322"></a><span id="l59.1322" class="difflineminus">-    {</span>
<a href="#l59.1323"></a><span id="l59.1323" class="difflineminus">-        if (TestCapFlag(POP3_HAS_AUTH_PLAIN))</span>
<a href="#l59.1324"></a><span id="l59.1324" class="difflineminus">-        {</span>
<a href="#l59.1325"></a><span id="l59.1325" class="difflineminus">-            // workaround for IPswitch's IMail server software</span>
<a href="#l59.1326"></a><span id="l59.1326" class="difflineminus">-            // this server goes into LOGIN mode even if we send &quot;AUTH PLAIN&quot;</span>
<a href="#l59.1327"></a><span id="l59.1327" class="difflineminus">-            // &quot;VXNlc&quot; is the begin of the base64 encoded prompt for LOGIN</span>
<a href="#l59.1328"></a><span id="l59.1328" class="difflineminus">-            if (StringBeginsWith(m_commandResponse, NS_LITERAL_CSTRING(&quot;VXNlc&quot;)))</span>
<a href="#l59.1329"></a><span id="l59.1329" class="difflineminus">-            {</span>
<a href="#l59.1330"></a><span id="l59.1330" class="difflineminus">-                // disable PLAIN and enable LOGIN (in case it's not already enabled)</span>
<a href="#l59.1331"></a><span id="l59.1331" class="difflineminus">-                ClearCapFlag(POP3_HAS_AUTH_PLAIN);</span>
<a href="#l59.1332"></a><span id="l59.1332" class="difflineminus">-                SetCapFlag(POP3_HAS_AUTH_LOGIN);</span>
<a href="#l59.1333"></a><span id="l59.1333" class="difflineminus">-                m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l59.1334"></a><span id="l59.1334" class="difflineminus">-</span>
<a href="#l59.1335"></a><span id="l59.1335" class="difflineminus">-                // reenter authentication again at LOGIN response handler</span>
<a href="#l59.1336"></a><span id="l59.1336" class="difflineminus">-                m_pop3ConData-&gt;next_state = POP3_AUTH_LOGIN_RESPONSE;</span>
<a href="#l59.1337"></a><span id="l59.1337" class="difflineminus">-                m_pop3ConData-&gt;pause_for_read = PR_FALSE;</span>
<a href="#l59.1338"></a><span id="l59.1338" class="difflineminus">-                return 0;</span>
<a href="#l59.1339"></a><span id="l59.1339" class="difflineminus">-            }</span>
<a href="#l59.1340"></a><span id="l59.1340" class="difflineminus">-</span>
<a href="#l59.1341"></a><span id="l59.1341" class="difflineminus">-            char plain_string[512];</span>
<a href="#l59.1342"></a><span id="l59.1342" class="difflineminus">-            int len = 1; /* first &lt;NUL&gt; char */</span>
<a href="#l59.1343"></a><span id="l59.1343" class="difflineminus">-</span>
<a href="#l59.1344"></a><span id="l59.1344" class="difflineminus">-            memset(plain_string, 0, 512);</span>
<a href="#l59.1345"></a><span id="l59.1345" class="difflineminus">-            PR_snprintf(&amp;plain_string[1], 510, &quot;%s&quot;, m_username.get());</span>
<a href="#l59.1346"></a><span id="l59.1346" class="difflineminus">-            len += m_username.Length();</span>
<a href="#l59.1347"></a><span id="l59.1347" class="difflineminus">-            len++; /* second &lt;NUL&gt; char */</span>
<a href="#l59.1348"></a><span id="l59.1348" class="difflineminus">-            PR_snprintf(&amp;plain_string[len], 511-len, &quot;%s&quot;, password.get());</span>
<a href="#l59.1349"></a><span id="l59.1349" class="difflineminus">-            len += password.Length();</span>
<a href="#l59.1350"></a><span id="l59.1350" class="difflineminus">-</span>
<a href="#l59.1351"></a><span id="l59.1351" class="difflineminus">-            char *base64Str = PL_Base64Encode(plain_string, len, nsnull);</span>
<a href="#l59.1352"></a><span id="l59.1352" class="difflineminus">-            cmd = base64Str;</span>
<a href="#l59.1353"></a><span id="l59.1353" class="difflineminus">-            PR_Free(base64Str);</span>
<a href="#l59.1354"></a><span id="l59.1354" class="difflineminus">-        }</span>
<a href="#l59.1355"></a><span id="l59.1355" class="difflineminus">-        else if (TestCapFlag(POP3_HAS_AUTH_LOGIN))</span>
<a href="#l59.1356"></a><span id="l59.1356" class="difflineminus">-        {</span>
<a href="#l59.1357"></a><span id="l59.1357" class="difflineminus">-            char * base64Str =</span>
<a href="#l59.1358"></a><span id="l59.1358" class="difflineminus">-                PL_Base64Encode(password.get(), password.Length(), nsnull);</span>
<a href="#l59.1359"></a><span id="l59.1359" class="difflineminus">-            cmd = base64Str;</span>
<a href="#l59.1360"></a><span id="l59.1360" class="difflineminus">-            PR_Free(base64Str);</span>
<a href="#l59.1361"></a><span id="l59.1361" class="difflineminus">-        }</span>
<a href="#l59.1362"></a><span id="l59.1362" class="difflineminus">-        else</span>
<a href="#l59.1363"></a><span id="l59.1363" class="difflineminus">-        {</span>
<a href="#l59.1364"></a><span id="l59.1364" class="difflineminus">-            cmd = &quot;PASS &quot;;</span>
<a href="#l59.1365"></a><span id="l59.1365" class="difflineminus">-            cmd += password;</span>
<a href="#l59.1366"></a><span id="l59.1366" class="difflineminus">-        }</span>
<a href="#l59.1367"></a><span id="l59.1367" class="difflineminus">-    }</span>
<a href="#l59.1368"></a><span id="l59.1368" class="difflineminus">-    cmd += CRLF;</span>
<a href="#l59.1369"></a><span id="l59.1369" class="difflineminus">-</span>
<a href="#l59.1370"></a><span id="l59.1370" class="difflineminus">-    m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l59.1371"></a><span id="l59.1371" class="difflineminus">-</span>
<a href="#l59.1372"></a><span id="l59.1372" class="difflineminus">-    m_pop3ConData-&gt;next_state_after_response = POP3_AUTH_FALLBACK;</span>
<a href="#l59.1373"></a><span id="l59.1373" class="difflineminus">-</span>
<a href="#l59.1374"></a><span id="l59.1374" class="difflineminus">-    m_pop3ConData-&gt;pause_for_read = PR_TRUE;</span>
<a href="#l59.1375"></a><span id="l59.1375" class="difflineminus">-</span>
<a href="#l59.1376"></a><span id="l59.1376" class="difflineminus">-    m_password_already_sent = PR_TRUE;</span>
<a href="#l59.1377"></a><span id="l59.1377" class="difflineminus">-    m_lastPasswordSent = password;</span>
<a href="#l59.1378"></a><span id="l59.1378" class="difflineminus">-    return SendData(m_url, cmd.get(), PR_TRUE);</span>
<a href="#l59.1379"></a><span id="l59.1379" class="difflineplus">+</span>
<a href="#l59.1380"></a><span id="l59.1380" class="difflineplus">+    char plain_string[512]; // TODO nsCString</span>
<a href="#l59.1381"></a><span id="l59.1381" class="difflineplus">+    int len = 1; /* first &lt;NUL&gt; char */</span>
<a href="#l59.1382"></a><span id="l59.1382" class="difflineplus">+    memset(plain_string, 0, 512);</span>
<a href="#l59.1383"></a><span id="l59.1383" class="difflineplus">+    PR_snprintf(&amp;plain_string[1], 510, &quot;%s&quot;, m_username.get());</span>
<a href="#l59.1384"></a><span id="l59.1384" class="difflineplus">+    len += m_username.Length();</span>
<a href="#l59.1385"></a><span id="l59.1385" class="difflineplus">+    len++; /* second &lt;NUL&gt; char */</span>
<a href="#l59.1386"></a><span id="l59.1386" class="difflineplus">+    PR_snprintf(&amp;plain_string[len], 511-len, &quot;%s&quot;, password.get());</span>
<a href="#l59.1387"></a><span id="l59.1387" class="difflineplus">+    len += password.Length();</span>
<a href="#l59.1388"></a><span id="l59.1388" class="difflineplus">+</span>
<a href="#l59.1389"></a><span id="l59.1389" class="difflineplus">+    char *base64Str = PL_Base64Encode(plain_string, len, nsnull);</span>
<a href="#l59.1390"></a><span id="l59.1390" class="difflineplus">+    cmd = base64Str;</span>
<a href="#l59.1391"></a><span id="l59.1391" class="difflineplus">+    PR_Free(base64Str);</span>
<a href="#l59.1392"></a><span id="l59.1392" class="difflineplus">+  }</span>
<a href="#l59.1393"></a><span id="l59.1393" class="difflineplus">+  else if (m_currentAuthMethod == POP3_HAS_AUTH_LOGIN)</span>
<a href="#l59.1394"></a><span id="l59.1394" class="difflineplus">+  {</span>
<a href="#l59.1395"></a><span id="l59.1395" class="difflineplus">+    PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;LOGIN password&quot;));</span>
<a href="#l59.1396"></a><span id="l59.1396" class="difflineplus">+    char * base64Str =</span>
<a href="#l59.1397"></a><span id="l59.1397" class="difflineplus">+        PL_Base64Encode(password.get(), password.Length(), nsnull);</span>
<a href="#l59.1398"></a><span id="l59.1398" class="difflineplus">+    cmd = base64Str;</span>
<a href="#l59.1399"></a><span id="l59.1399" class="difflineplus">+    PR_Free(base64Str);</span>
<a href="#l59.1400"></a><span id="l59.1400" class="difflineplus">+  }</span>
<a href="#l59.1401"></a><span id="l59.1401" class="difflineplus">+  else if (m_currentAuthMethod == POP3_HAS_AUTH_USER)</span>
<a href="#l59.1402"></a><span id="l59.1402" class="difflineplus">+  {</span>
<a href="#l59.1403"></a><span id="l59.1403" class="difflineplus">+    PR_LOG(POP3LOGMODULE, PR_LOG_DEBUG, (&quot;PASS password&quot;));</span>
<a href="#l59.1404"></a><span id="l59.1404" class="difflineplus">+    cmd = &quot;PASS &quot;;</span>
<a href="#l59.1405"></a><span id="l59.1405" class="difflineplus">+    cmd += password;</span>
<a href="#l59.1406"></a><span id="l59.1406" class="difflineplus">+  }</span>
<a href="#l59.1407"></a><span id="l59.1407" class="difflineplus">+  else</span>
<a href="#l59.1408"></a><span id="l59.1408" class="difflineplus">+  {</span>
<a href="#l59.1409"></a><span id="l59.1409" class="difflineplus">+    PR_LOG(POP3LOGMODULE, PR_LOG_ERROR,</span>
<a href="#l59.1410"></a><span id="l59.1410" class="difflineplus">+        (&quot;In nsPop3Protocol::SendPassword(), m_currentAuthMethod is %X, &quot;</span>
<a href="#l59.1411"></a><span id="l59.1411" class="difflineplus">+        &quot;but that is unexpected&quot;, m_currentAuthMethod));</span>
<a href="#l59.1412"></a><span id="l59.1412" class="difflineplus">+    return Error(POP3_AUTH_INTERNAL_ERROR);</span>
<a href="#l59.1413"></a><span id="l59.1413" class="difflineplus">+  }</span>
<a href="#l59.1414"></a><span id="l59.1414" class="difflineplus">+</span>
<a href="#l59.1415"></a><span id="l59.1415" class="difflineplus">+  cmd += CRLF;</span>
<a href="#l59.1416"></a><span id="l59.1416" class="difflineplus">+</span>
<a href="#l59.1417"></a><span id="l59.1417" class="difflineplus">+  // TODO needed?</span>
<a href="#l59.1418"></a><span id="l59.1418" class="difflineplus">+  //m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l59.1419"></a><span id="l59.1419" class="difflineplus">+</span>
<a href="#l59.1420"></a><span id="l59.1420" class="difflineplus">+  m_pop3ConData-&gt;next_state_after_response = POP3_NEXT_AUTH_STEP;</span>
<a href="#l59.1421"></a><span id="l59.1421" class="difflineplus">+</span>
<a href="#l59.1422"></a><span id="l59.1422" class="difflineplus">+  m_pop3ConData-&gt;pause_for_read = PR_TRUE;</span>
<a href="#l59.1423"></a><span id="l59.1423" class="difflineplus">+</span>
<a href="#l59.1424"></a><span id="l59.1424" class="difflineplus">+  m_password_already_sent = PR_TRUE;</span>
<a href="#l59.1425"></a><span id="l59.1425" class="difflineplus">+  m_lastPasswordSent = password;</span>
<a href="#l59.1426"></a><span id="l59.1426" class="difflineplus">+  return SendData(m_url, cmd.get(), PR_TRUE);</span>
<a href="#l59.1427"></a><span id="l59.1427"> }</span>
<a href="#l59.1428"></a><span id="l59.1428"> </span>
<a href="#l59.1429"></a><span id="l59.1429"> PRInt32 nsPop3Protocol::SendStatOrGurl(PRBool sendStat)</span>
<a href="#l59.1430"></a><span id="l59.1430"> {</span>
<a href="#l59.1431"></a><span id="l59.1431">   nsCAutoString cmd;</span>
<a href="#l59.1432"></a><span id="l59.1432">   if (sendStat)</span>
<a href="#l59.1433"></a><span id="l59.1433">   {</span>
<a href="#l59.1434"></a><span id="l59.1434">     cmd  = &quot;STAT&quot; CRLF;</span>
<a href="#l59.1435"></a><span id="l59.1435" class="difflineat">@@ -2703,20 +2859,17 @@ PRInt32 nsPop3Protocol::GetMsg()</span>
<a href="#l59.1436"></a><span id="l59.1436">   }</span>
<a href="#l59.1437"></a><span id="l59.1437"> </span>
<a href="#l59.1438"></a><span id="l59.1438">   /* Look at this message, and decide whether to ignore it, get it, just get</span>
<a href="#l59.1439"></a><span id="l59.1439">   the TOP of it, or delete it. */</span>
<a href="#l59.1440"></a><span id="l59.1440"> </span>
<a href="#l59.1441"></a><span id="l59.1441">   // if this is a message we've seen for the first time, we won't find it in</span>
<a href="#l59.1442"></a><span id="l59.1442">   // m_pop3ConData-uidlinfo-&gt;hash.  By default, we retrieve messages, unless they have a status,</span>
<a href="#l59.1443"></a><span id="l59.1443">   // or are too big, in which case we figure out what to do.</span>
<a href="#l59.1444"></a><span id="l59.1444" class="difflineminus">-  PRBool prefBool = PR_FALSE;</span>
<a href="#l59.1445"></a><span id="l59.1445" class="difflineminus">-  m_pop3Server-&gt;GetAuthLogin(&amp;prefBool);</span>
<a href="#l59.1446"></a><span id="l59.1446" class="difflineminus">-</span>
<a href="#l59.1447"></a><span id="l59.1447" class="difflineminus">-  if (prefBool &amp;&amp; (TestCapFlag(POP3_HAS_XSENDER)))</span>
<a href="#l59.1448"></a><span id="l59.1448" class="difflineplus">+  if (m_prefAuthMethods != POP3_HAS_AUTH_USER &amp;&amp; TestCapFlag(POP3_HAS_XSENDER))</span>
<a href="#l59.1449"></a><span id="l59.1449">     m_pop3ConData-&gt;next_state = POP3_SEND_XSENDER;</span>
<a href="#l59.1450"></a><span id="l59.1450">   else</span>
<a href="#l59.1451"></a><span id="l59.1451">     m_pop3ConData-&gt;next_state = POP3_SEND_RETR;</span>
<a href="#l59.1452"></a><span id="l59.1452">   m_pop3ConData-&gt;truncating_cur_msg = PR_FALSE;</span>
<a href="#l59.1453"></a><span id="l59.1453">   m_pop3ConData-&gt;pause_for_read = PR_FALSE;</span>
<a href="#l59.1454"></a><span id="l59.1454">   if (m_pop3ConData-&gt;msg_info)</span>
<a href="#l59.1455"></a><span id="l59.1455">   {</span>
<a href="#l59.1456"></a><span id="l59.1456">     Pop3MsgInfo* info = m_pop3ConData-&gt;msg_info + m_pop3ConData-&gt;last_accessed_msg;</span>
<a href="#l59.1457"></a><span id="l59.1457" class="difflineat">@@ -3180,36 +3333,33 @@ nsPop3Protocol::TopResponse(nsIInputStre</span>
<a href="#l59.1458"></a><span id="l59.1458">   if(m_pop3ConData-&gt;cur_msg_size == -1 &amp;&amp;  /* first line after TOP command sent */</span>
<a href="#l59.1459"></a><span id="l59.1459">     !m_pop3ConData-&gt;command_succeeded)  /* and TOP command failed */</span>
<a href="#l59.1460"></a><span id="l59.1460">   {</span>
<a href="#l59.1461"></a><span id="l59.1461">   /* TOP doesn't work so we can't retrieve the first part of this msg.</span>
<a href="#l59.1462"></a><span id="l59.1462">   So just go download the whole thing, and warn the user.</span>
<a href="#l59.1463"></a><span id="l59.1463"> </span>
<a href="#l59.1464"></a><span id="l59.1464">     Note that the progress bar will not be accurate in this case.</span>
<a href="#l59.1465"></a><span id="l59.1465">     Oops. #### */</span>
<a href="#l59.1466"></a><span id="l59.1466" class="difflineminus">-    PRBool prefBool = PR_FALSE;</span>
<a href="#l59.1467"></a><span id="l59.1467">     m_pop3ConData-&gt;truncating_cur_msg = PR_FALSE;</span>
<a href="#l59.1468"></a><span id="l59.1468"> </span>
<a href="#l59.1469"></a><span id="l59.1469">     nsString statusTemplate;</span>
<a href="#l59.1470"></a><span id="l59.1470">     mLocalBundle-&gt;GetStringFromID(POP3_SERVER_DOES_NOT_SUPPORT_THE_TOP_COMMAND, getter_Copies(statusTemplate));</span>
<a href="#l59.1471"></a><span id="l59.1471">     if (!statusTemplate.IsEmpty())</span>
<a href="#l59.1472"></a><span id="l59.1472">     {</span>
<a href="#l59.1473"></a><span id="l59.1473">       nsCAutoString hostName;</span>
<a href="#l59.1474"></a><span id="l59.1474">       PRUnichar * statusString = nsnull;</span>
<a href="#l59.1475"></a><span id="l59.1475">       m_url-&gt;GetHost(hostName);</span>
<a href="#l59.1476"></a><span id="l59.1476"> </span>
<a href="#l59.1477"></a><span id="l59.1477">       statusString = nsTextFormatter::smprintf(statusTemplate.get(), hostName.get());</span>
<a href="#l59.1478"></a><span id="l59.1478">       UpdateStatusWithString(statusString);</span>
<a href="#l59.1479"></a><span id="l59.1479">       nsTextFormatter::smprintf_free(statusString);</span>
<a href="#l59.1480"></a><span id="l59.1480">     }</span>
<a href="#l59.1481"></a><span id="l59.1481"> </span>
<a href="#l59.1482"></a><span id="l59.1482" class="difflineminus">-    m_pop3Server-&gt;GetAuthLogin(&amp;prefBool);</span>
<a href="#l59.1483"></a><span id="l59.1483" class="difflineminus">-</span>
<a href="#l59.1484"></a><span id="l59.1484" class="difflineminus">-    if (prefBool &amp;&amp;</span>
<a href="#l59.1485"></a><span id="l59.1485" class="difflineminus">-      (TestCapFlag(POP3_HAS_XSENDER)))</span>
<a href="#l59.1486"></a><span id="l59.1486" class="difflineplus">+    if (m_prefAuthMethods != POP3_HAS_AUTH_USER &amp;&amp;</span>
<a href="#l59.1487"></a><span id="l59.1487" class="difflineplus">+        TestCapFlag(POP3_HAS_XSENDER))</span>
<a href="#l59.1488"></a><span id="l59.1488">       m_pop3ConData-&gt;next_state = POP3_SEND_XSENDER;</span>
<a href="#l59.1489"></a><span id="l59.1489">     else</span>
<a href="#l59.1490"></a><span id="l59.1490">       m_pop3ConData-&gt;next_state = POP3_SEND_RETR;</span>
<a href="#l59.1491"></a><span id="l59.1491">     return(0);</span>
<a href="#l59.1492"></a><span id="l59.1492">   }</span>
<a href="#l59.1493"></a><span id="l59.1493"> </span>
<a href="#l59.1494"></a><span id="l59.1494">   /* If TOP works, we handle it in the same way as RETR. */</span>
<a href="#l59.1495"></a><span id="l59.1495">   return RetrResponse(inputStream, length);</span>
<a href="#l59.1496"></a><span id="l59.1496" class="difflineat">@@ -3454,37 +3604,29 @@ nsresult nsPop3Protocol::ProcessProtocol</span>
<a href="#l59.1497"></a><span id="l59.1497">           m_nsIPop3Sink-&gt;SetBiffStateAndUpdateFE(m_pop3ConData-&gt;biffstate, 0, PR_FALSE);</span>
<a href="#l59.1498"></a><span id="l59.1498"> </span>
<a href="#l59.1499"></a><span id="l59.1499">           /* update old style biff */</span>
<a href="#l59.1500"></a><span id="l59.1500">           m_pop3ConData-&gt;next_state = POP3_FREE;</span>
<a href="#l59.1501"></a><span id="l59.1501">           m_pop3ConData-&gt;pause_for_read = PR_FALSE;</span>
<a href="#l59.1502"></a><span id="l59.1502">           break;</span>
<a href="#l59.1503"></a><span id="l59.1503">         }</span>
<a href="#l59.1504"></a><span id="l59.1504"> </span>
<a href="#l59.1505"></a><span id="l59.1505" class="difflineminus">-        if (m_username.IsEmpty() || !pwd)</span>
<a href="#l59.1506"></a><span id="l59.1506" class="difflineplus">+        m_pop3ConData-&gt;pause_for_read = PR_FALSE;</span>
<a href="#l59.1507"></a><span id="l59.1507" class="difflineplus">+        // we are already connected so just go on and send the username</span>
<a href="#l59.1508"></a><span id="l59.1508" class="difflineplus">+        if (m_prefAuthMethods == POP3_HAS_AUTH_USER)</span>
<a href="#l59.1509"></a><span id="l59.1509">         {</span>
<a href="#l59.1510"></a><span id="l59.1510" class="difflineminus">-          m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l59.1511"></a><span id="l59.1511" class="difflineminus">-          m_pop3ConData-&gt;pause_for_read = PR_FALSE;</span>
<a href="#l59.1512"></a><span id="l59.1512" class="difflineplus">+          m_currentAuthMethod = POP3_HAS_AUTH_USER;</span>
<a href="#l59.1513"></a><span id="l59.1513" class="difflineplus">+          m_pop3ConData-&gt;next_state = POP3_SEND_USERNAME;</span>
<a href="#l59.1514"></a><span id="l59.1514">         }</span>
<a href="#l59.1515"></a><span id="l59.1515">         else</span>
<a href="#l59.1516"></a><span id="l59.1516">         {</span>
<a href="#l59.1517"></a><span id="l59.1517" class="difflineminus">-          // we are already connected so just go on and send the username</span>
<a href="#l59.1518"></a><span id="l59.1518" class="difflineminus">-          PRBool prefBool = PR_FALSE;</span>
<a href="#l59.1519"></a><span id="l59.1519" class="difflineminus">-          m_pop3ConData-&gt;pause_for_read = PR_FALSE;</span>
<a href="#l59.1520"></a><span id="l59.1520" class="difflineminus">-          m_pop3Server-&gt;GetAuthLogin(&amp;prefBool);</span>
<a href="#l59.1521"></a><span id="l59.1521" class="difflineminus">-</span>
<a href="#l59.1522"></a><span id="l59.1522" class="difflineminus">-          if (prefBool)</span>
<a href="#l59.1523"></a><span id="l59.1523" class="difflineminus">-          {</span>
<a href="#l59.1524"></a><span id="l59.1524" class="difflineminus">-            if (TestCapFlag(POP3_AUTH_MECH_UNDEFINED))</span>
<a href="#l59.1525"></a><span id="l59.1525" class="difflineminus">-              m_pop3ConData-&gt;next_state = POP3_SEND_AUTH;</span>
<a href="#l59.1526"></a><span id="l59.1526" class="difflineminus">-            else</span>
<a href="#l59.1527"></a><span id="l59.1527" class="difflineminus">-              m_pop3ConData-&gt;next_state = POP3_SEND_CAPA;</span>
<a href="#l59.1528"></a><span id="l59.1528" class="difflineminus">-          }</span>
<a href="#l59.1529"></a><span id="l59.1529" class="difflineplus">+          if (TestCapFlag(POP3_AUTH_MECH_UNDEFINED))</span>
<a href="#l59.1530"></a><span id="l59.1530" class="difflineplus">+            m_pop3ConData-&gt;next_state = POP3_SEND_AUTH;</span>
<a href="#l59.1531"></a><span id="l59.1531">           else</span>
<a href="#l59.1532"></a><span id="l59.1532" class="difflineminus">-            m_pop3ConData-&gt;next_state = POP3_SEND_USERNAME;</span>
<a href="#l59.1533"></a><span id="l59.1533" class="difflineplus">+            m_pop3ConData-&gt;next_state = POP3_SEND_CAPA;</span>
<a href="#l59.1534"></a><span id="l59.1534">         }</span>
<a href="#l59.1535"></a><span id="l59.1535">         break;</span>
<a href="#l59.1536"></a><span id="l59.1536">       }</span>
<a href="#l59.1537"></a><span id="l59.1537"> </span>
<a href="#l59.1538"></a><span id="l59.1538"> </span>
<a href="#l59.1539"></a><span id="l59.1539">     case POP3_START_CONNECT:</span>
<a href="#l59.1540"></a><span id="l59.1540">       {</span>
<a href="#l59.1541"></a><span id="l59.1541">         m_pop3ConData-&gt;next_state = POP3_FINISH_CONNECT;</span>
<a href="#l59.1542"></a><span id="l59.1542" class="difflineat">@@ -3504,28 +3646,28 @@ nsresult nsPop3Protocol::ProcessProtocol</span>
<a href="#l59.1543"></a><span id="l59.1543">       break;</span>
<a href="#l59.1544"></a><span id="l59.1544"> </span>
<a href="#l59.1545"></a><span id="l59.1545">     case POP3_WAIT_FOR_START_OF_CONNECTION_RESPONSE:</span>
<a href="#l59.1546"></a><span id="l59.1546">       {</span>
<a href="#l59.1547"></a><span id="l59.1547">         status = WaitForStartOfConnectionResponse(aInputStream, aLength);</span>
<a href="#l59.1548"></a><span id="l59.1548"> </span>
<a href="#l59.1549"></a><span id="l59.1549">         if(status)</span>
<a href="#l59.1550"></a><span id="l59.1550">         {</span>
<a href="#l59.1551"></a><span id="l59.1551" class="difflineminus">-          PRBool prefBool = PR_FALSE;</span>
<a href="#l59.1552"></a><span id="l59.1552" class="difflineminus">-          m_pop3Server-&gt;GetAuthLogin(&amp;prefBool);</span>
<a href="#l59.1553"></a><span id="l59.1553" class="difflineminus">-</span>
<a href="#l59.1554"></a><span id="l59.1554" class="difflineminus">-          if (prefBool)</span>
<a href="#l59.1555"></a><span id="l59.1555" class="difflineplus">+          if (m_prefAuthMethods == POP3_HAS_AUTH_USER)</span>
<a href="#l59.1556"></a><span id="l59.1556" class="difflineplus">+          {</span>
<a href="#l59.1557"></a><span id="l59.1557" class="difflineplus">+            m_currentAuthMethod = POP3_HAS_AUTH_USER;</span>
<a href="#l59.1558"></a><span id="l59.1558" class="difflineplus">+            m_pop3ConData-&gt;next_state = POP3_SEND_USERNAME;</span>
<a href="#l59.1559"></a><span id="l59.1559" class="difflineplus">+          }</span>
<a href="#l59.1560"></a><span id="l59.1560" class="difflineplus">+          else</span>
<a href="#l59.1561"></a><span id="l59.1561">           {</span>
<a href="#l59.1562"></a><span id="l59.1562">             if (TestCapFlag(POP3_AUTH_MECH_UNDEFINED))</span>
<a href="#l59.1563"></a><span id="l59.1563">               m_pop3ConData-&gt;next_state = POP3_SEND_AUTH;</span>
<a href="#l59.1564"></a><span id="l59.1564">             else</span>
<a href="#l59.1565"></a><span id="l59.1565">               m_pop3ConData-&gt;next_state = POP3_SEND_CAPA;</span>
<a href="#l59.1566"></a><span id="l59.1566">           }</span>
<a href="#l59.1567"></a><span id="l59.1567" class="difflineminus">-          else</span>
<a href="#l59.1568"></a><span id="l59.1568" class="difflineminus">-            m_pop3ConData-&gt;next_state = POP3_SEND_USERNAME;</span>
<a href="#l59.1569"></a><span id="l59.1569">         }</span>
<a href="#l59.1570"></a><span id="l59.1570"> </span>
<a href="#l59.1571"></a><span id="l59.1571">         break;</span>
<a href="#l59.1572"></a><span id="l59.1572">       }</span>
<a href="#l59.1573"></a><span id="l59.1573"> </span>
<a href="#l59.1574"></a><span id="l59.1574">     case POP3_SEND_AUTH:</span>
<a href="#l59.1575"></a><span id="l59.1575">       status = SendAuth();</span>
<a href="#l59.1576"></a><span id="l59.1576">       break;</span>
<a href="#l59.1577"></a><span id="l59.1577" class="difflineat">@@ -3545,18 +3687,18 @@ nsresult nsPop3Protocol::ProcessProtocol</span>
<a href="#l59.1578"></a><span id="l59.1578">     case POP3_TLS_RESPONSE:</span>
<a href="#l59.1579"></a><span id="l59.1579">       status = SendTLSResponse();</span>
<a href="#l59.1580"></a><span id="l59.1580">       break;</span>
<a href="#l59.1581"></a><span id="l59.1581"> </span>
<a href="#l59.1582"></a><span id="l59.1582">     case POP3_PROCESS_AUTH:</span>
<a href="#l59.1583"></a><span id="l59.1583">       status = ProcessAuth();</span>
<a href="#l59.1584"></a><span id="l59.1584">       break;</span>
<a href="#l59.1585"></a><span id="l59.1585"> </span>
<a href="#l59.1586"></a><span id="l59.1586" class="difflineminus">-    case POP3_AUTH_FALLBACK:</span>
<a href="#l59.1587"></a><span id="l59.1587" class="difflineminus">-      status = AuthFallback();</span>
<a href="#l59.1588"></a><span id="l59.1588" class="difflineplus">+    case POP3_NEXT_AUTH_STEP:</span>
<a href="#l59.1589"></a><span id="l59.1589" class="difflineplus">+      status = NextAuthStep();</span>
<a href="#l59.1590"></a><span id="l59.1590">       break;</span>
<a href="#l59.1591"></a><span id="l59.1591"> </span>
<a href="#l59.1592"></a><span id="l59.1592">     case POP3_AUTH_LOGIN:</span>
<a href="#l59.1593"></a><span id="l59.1593">       status = AuthLogin();</span>
<a href="#l59.1594"></a><span id="l59.1594">       break;</span>
<a href="#l59.1595"></a><span id="l59.1595"> </span>
<a href="#l59.1596"></a><span id="l59.1596">     case POP3_AUTH_LOGIN_RESPONSE:</span>
<a href="#l59.1597"></a><span id="l59.1597">       status = AuthLoginResponse();</span>
<a href="#l59.1598"></a><span id="l59.1598" class="difflineat">@@ -3763,17 +3905,17 @@ nsresult nsPop3Protocol::ProcessProtocol</span>
<a href="#l59.1599"></a><span id="l59.1599">           UpdateStatusWithString(statusString);</span>
<a href="#l59.1600"></a><span id="l59.1600">           nsTextFormatter::smprintf_free(statusString);</span>
<a href="#l59.1601"></a><span id="l59.1601">         }</span>
<a href="#l59.1602"></a><span id="l59.1602"> </span>
<a href="#l59.1603"></a><span id="l59.1603">         NS_ASSERTION (!TestFlag(POP3_PASSWORD_FAILED), &quot;POP3_PASSWORD_FAILED set when del_started&quot;);</span>
<a href="#l59.1604"></a><span id="l59.1604">         m_nsIPop3Sink-&gt;AbortMailDelivery(this);</span>
<a href="#l59.1605"></a><span id="l59.1605">       }</span>
<a href="#l59.1606"></a><span id="l59.1606"> </span>
<a href="#l59.1607"></a><span id="l59.1607" class="difflineminus">-      if (TestFlag(POP3_PASSWORD_FAILED) &amp;&amp; m_pop3ConData-&gt;logonFailureCount &lt; 6)</span>
<a href="#l59.1608"></a><span id="l59.1608" class="difflineplus">+      if (TestFlag(POP3_PASSWORD_FAILED))</span>
<a href="#l59.1609"></a><span id="l59.1609">       {</span>
<a href="#l59.1610"></a><span id="l59.1610">       /* We got here because the password was wrong, so go</span>
<a href="#l59.1611"></a><span id="l59.1611">         read a new one and re-open the connection. */</span>
<a href="#l59.1612"></a><span id="l59.1612">         m_pop3ConData-&gt;next_state = POP3_READ_PASSWORD;</span>
<a href="#l59.1613"></a><span id="l59.1613">         m_pop3ConData-&gt;command_succeeded = PR_TRUE;</span>
<a href="#l59.1614"></a><span id="l59.1614">         status = 0;</span>
<a href="#l59.1615"></a><span id="l59.1615">         break;</span>
<a href="#l59.1616"></a><span id="l59.1616">       }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Protocol.h</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Protocol.h</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineat">@@ -109,16 +109,18 @@ enum Pop3CapabilityEnum {</span>
<a href="#l60.4"></a><span id="l60.4">     POP3_HAS_AUTH_NTLM          = 0x00008000,</span>
<a href="#l60.5"></a><span id="l60.5">     POP3_HAS_AUTH_MSN           = 0x00010000,</span>
<a href="#l60.6"></a><span id="l60.6">     POP3_HAS_RESP_CODES         = 0x00020000,</span>
<a href="#l60.7"></a><span id="l60.7">     POP3_HAS_AUTH_RESP_CODE     = 0x00040000,</span>
<a href="#l60.8"></a><span id="l60.8">     POP3_HAS_STLS               = 0x00080000,</span>
<a href="#l60.9"></a><span id="l60.9">     POP3_HAS_AUTH_GSSAPI        = 0x00100000</span>
<a href="#l60.10"></a><span id="l60.10"> };</span>
<a href="#l60.11"></a><span id="l60.11"> </span>
<a href="#l60.12"></a><span id="l60.12" class="difflineplus">+// TODO use value &gt; 0?</span>
<a href="#l60.13"></a><span id="l60.13" class="difflineplus">+#define POP3_HAS_AUTH_NONE        0</span>
<a href="#l60.14"></a><span id="l60.14"> #define POP3_HAS_AUTH_ANY         0x00001C00</span>
<a href="#l60.15"></a><span id="l60.15"> #define POP3_HAS_AUTH_ANY_SEC     0x0011E000</span>
<a href="#l60.16"></a><span id="l60.16"> </span>
<a href="#l60.17"></a><span id="l60.17"> enum Pop3StatesEnum {</span>
<a href="#l60.18"></a><span id="l60.18">     POP3_READ_PASSWORD,                         // 0</span>
<a href="#l60.19"></a><span id="l60.19">                                                 //</span>
<a href="#l60.20"></a><span id="l60.20">     POP3_START_CONNECT,                         // 1</span>
<a href="#l60.21"></a><span id="l60.21">     POP3_FINISH_CONNECT,                        // 2</span>
<a href="#l60.22"></a><span id="l60.22" class="difflineat">@@ -149,17 +151,17 @@ enum Pop3StatesEnum {</span>
<a href="#l60.23"></a><span id="l60.23">     POP3_DONE,                                  // 23</span>
<a href="#l60.24"></a><span id="l60.24">     POP3_ERROR_DONE,                            // 24</span>
<a href="#l60.25"></a><span id="l60.25">     POP3_FREE,                                  // 25</span>
<a href="#l60.26"></a><span id="l60.26">     POP3_SEND_AUTH,                             // 26</span>
<a href="#l60.27"></a><span id="l60.27">     POP3_AUTH_RESPONSE,                         // 27</span>
<a href="#l60.28"></a><span id="l60.28">     POP3_SEND_CAPA,                             // 28</span>
<a href="#l60.29"></a><span id="l60.29">     POP3_CAPA_RESPONSE,                         // 29</span>
<a href="#l60.30"></a><span id="l60.30">     POP3_PROCESS_AUTH,                          // 30</span>
<a href="#l60.31"></a><span id="l60.31" class="difflineminus">-    POP3_AUTH_FALLBACK,                         // 31</span>
<a href="#l60.32"></a><span id="l60.32" class="difflineplus">+    POP3_NEXT_AUTH_STEP,                        // 31</span>
<a href="#l60.33"></a><span id="l60.33"> </span>
<a href="#l60.34"></a><span id="l60.34">     POP3_AUTH_LOGIN,                            // 32</span>
<a href="#l60.35"></a><span id="l60.35">     POP3_AUTH_LOGIN_RESPONSE,                   // 33</span>
<a href="#l60.36"></a><span id="l60.36">     POP3_AUTH_NTLM,                             // 34</span>
<a href="#l60.37"></a><span id="l60.37">     POP3_AUTH_NTLM_RESPONSE,                    // 35</span>
<a href="#l60.38"></a><span id="l60.38">     POP3_SEND_XSENDER,                          // 36</span>
<a href="#l60.39"></a><span id="l60.39">     POP3_XSENDER_RESPONSE,                      // 37</span>
<a href="#l60.40"></a><span id="l60.40">     POP3_SEND_GURL,                             // 38</span>
<a href="#l60.41"></a><span id="l60.41" class="difflineat">@@ -249,17 +251,16 @@ typedef struct _Pop3ConData {</span>
<a href="#l60.42"></a><span id="l60.42">     char *only_uidl;              /* If non-NULL, then load only this UIDL. */</span>
<a href="#l60.43"></a><span id="l60.43"> </span>
<a href="#l60.44"></a><span id="l60.44">     PRBool get_url;</span>
<a href="#l60.45"></a><span id="l60.45">     PRBool seenFromHeader;</span>
<a href="#l60.46"></a><span id="l60.46">     PRInt32 parsed_bytes;</span>
<a href="#l60.47"></a><span id="l60.47">     PRInt32 pop3_size;</span>
<a href="#l60.48"></a><span id="l60.48">     PRBool dot_fix;</span>
<a href="#l60.49"></a><span id="l60.49">     PRBool assumed_end;</span>
<a href="#l60.50"></a><span id="l60.50" class="difflineminus">-    PRInt32 logonFailureCount;</span>
<a href="#l60.51"></a><span id="l60.51">     nsresult urlStatus;</span>
<a href="#l60.52"></a><span id="l60.52"> } Pop3ConData;</span>
<a href="#l60.53"></a><span id="l60.53"> </span>
<a href="#l60.54"></a><span id="l60.54"> // State Flags (Note, I use the word state in terms of storing</span>
<a href="#l60.55"></a><span id="l60.55"> // state information about the connection (authentication, have we sent</span>
<a href="#l60.56"></a><span id="l60.56"> // commands, etc. I do not intend it to refer to protocol state)</span>
<a href="#l60.57"></a><span id="l60.57"> #define POP3_PAUSE_FOR_READ      0x00000001  /* should we pause for the next read */</span>
<a href="#l60.58"></a><span id="l60.58"> #define POP3_PASSWORD_FAILED    0x00000002</span>
<a href="#l60.59"></a><span id="l60.59" class="difflineat">@@ -327,26 +328,31 @@ private:</span>
<a href="#l60.60"></a><span id="l60.60"> </span>
<a href="#l60.61"></a><span id="l60.61">   nsMsgLineStreamBuffer   * m_lineStreamBuffer; // used to efficiently extract lines from the incoming data stream</span>
<a href="#l60.62"></a><span id="l60.62">   Pop3ConData* m_pop3ConData;</span>
<a href="#l60.63"></a><span id="l60.63">   void FreeMsgInfo();</span>
<a href="#l60.64"></a><span id="l60.64">   void Abort();</span>
<a href="#l60.65"></a><span id="l60.65"> </span>
<a href="#l60.66"></a><span id="l60.66">   PRBool m_tlsEnabled;</span>
<a href="#l60.67"></a><span id="l60.67">   PRInt32 m_socketType;</span>
<a href="#l60.68"></a><span id="l60.68" class="difflineminus">-  PRBool m_useSecAuth;</span>
<a href="#l60.69"></a><span id="l60.69">   PRBool m_password_already_sent;</span>
<a href="#l60.70"></a><span id="l60.70"> </span>
<a href="#l60.71"></a><span id="l60.71">   void SetCapFlag(PRUint32 flag);</span>
<a href="#l60.72"></a><span id="l60.72">   void ClearCapFlag(PRUint32 flag);</span>
<a href="#l60.73"></a><span id="l60.73">   PRBool TestCapFlag(PRUint32 flag);</span>
<a href="#l60.74"></a><span id="l60.74" class="difflineplus">+  PRUint32 GetCapFlags();</span>
<a href="#l60.75"></a><span id="l60.75"> </span>
<a href="#l60.76"></a><span id="l60.76" class="difflineminus">-  void BackupAuthFlags();</span>
<a href="#l60.77"></a><span id="l60.77" class="difflineminus">-  void RestoreAuthFlags();</span>
<a href="#l60.78"></a><span id="l60.78" class="difflineminus">-  PRInt32 m_origAuthFlags;</span>
<a href="#l60.79"></a><span id="l60.79" class="difflineplus">+  void    InitPrefAuthMethods(PRInt32 authMethodPrefValue);</span>
<a href="#l60.80"></a><span id="l60.80" class="difflineplus">+  nsresult ChooseAuthMethod();</span>
<a href="#l60.81"></a><span id="l60.81" class="difflineplus">+  void    MarkAuthMethodAsFailed(PRInt32 failedAuthMethod);</span>
<a href="#l60.82"></a><span id="l60.82" class="difflineplus">+  void    ResetAuthMethods();</span>
<a href="#l60.83"></a><span id="l60.83" class="difflineplus">+  PRInt32 m_prefAuthMethods; // set of capability flags for auth methods</span>
<a href="#l60.84"></a><span id="l60.84" class="difflineplus">+  PRInt32 m_failedAuthMethods; // ditto</span>
<a href="#l60.85"></a><span id="l60.85" class="difflineplus">+  PRInt32 m_currentAuthMethod; // exactly one capability flag, or 0</span>
<a href="#l60.86"></a><span id="l60.86" class="difflineplus">+</span>
<a href="#l60.87"></a><span id="l60.87">   PRInt32 m_listpos;</span>
<a href="#l60.88"></a><span id="l60.88"> </span>
<a href="#l60.89"></a><span id="l60.89">   nsresult HandleLine(char *line, PRUint32 line_length);</span>
<a href="#l60.90"></a><span id="l60.90"> </span>
<a href="#l60.91"></a><span id="l60.91">   nsresult GetApopTimestamp();</span>
<a href="#l60.92"></a><span id="l60.92"> </span>
<a href="#l60.93"></a><span id="l60.93">   //////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l60.94"></a><span id="l60.94">       // Begin Pop3 protocol state handlers</span>
<a href="#l60.95"></a><span id="l60.95" class="difflineat">@@ -357,17 +363,17 @@ private:</span>
<a href="#l60.96"></a><span id="l60.96">                           PRUint32 length);</span>
<a href="#l60.97"></a><span id="l60.97">   PRInt32 Error(PRInt32 err_code);</span>
<a href="#l60.98"></a><span id="l60.98">   PRInt32 SendAuth();</span>
<a href="#l60.99"></a><span id="l60.99">   PRInt32 AuthResponse(nsIInputStream* inputStream, PRUint32 length);</span>
<a href="#l60.100"></a><span id="l60.100">   PRInt32 SendCapa();</span>
<a href="#l60.101"></a><span id="l60.101">   PRInt32 CapaResponse(nsIInputStream* inputStream, PRUint32 length);</span>
<a href="#l60.102"></a><span id="l60.102">   PRInt32 SendTLSResponse();</span>
<a href="#l60.103"></a><span id="l60.103">   PRInt32 ProcessAuth();</span>
<a href="#l60.104"></a><span id="l60.104" class="difflineminus">-  PRInt32 AuthFallback();</span>
<a href="#l60.105"></a><span id="l60.105" class="difflineplus">+  PRInt32 NextAuthStep();</span>
<a href="#l60.106"></a><span id="l60.106">   PRInt32 AuthLogin();</span>
<a href="#l60.107"></a><span id="l60.107">   PRInt32 AuthLoginResponse();</span>
<a href="#l60.108"></a><span id="l60.108">   PRInt32 AuthNtlm();</span>
<a href="#l60.109"></a><span id="l60.109">   PRInt32 AuthNtlmResponse();</span>
<a href="#l60.110"></a><span id="l60.110">   PRInt32 AuthGSSAPI();</span>
<a href="#l60.111"></a><span id="l60.111">   PRInt32 AuthGSSAPIResponse(PRBool first);</span>
<a href="#l60.112"></a><span id="l60.112">   PRInt32 SendUsername();</span>
<a href="#l60.113"></a><span id="l60.113">   PRInt32 SendPassword();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1">new file mode 100644</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineminus">--- /dev/null</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3AuthMethods.js</span>
<a href="#l61.4"></a><span id="l61.4" class="difflineat">@@ -0,0 +1,188 @@</span>
<a href="#l61.5"></a><span id="l61.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l61.6"></a><span id="l61.6" class="difflineplus">+/**</span>
<a href="#l61.7"></a><span id="l61.7" class="difflineplus">+ * Login tests for POP3</span>
<a href="#l61.8"></a><span id="l61.8" class="difflineplus">+ *</span>
<a href="#l61.9"></a><span id="l61.9" class="difflineplus">+ * Test code &lt;copied from=&quot;test_pop3GetNewMail.js&quot;&gt;</span>
<a href="#l61.10"></a><span id="l61.10" class="difflineplus">+ */</span>
<a href="#l61.11"></a><span id="l61.11" class="difflineplus">+var server;</span>
<a href="#l61.12"></a><span id="l61.12" class="difflineplus">+var daemon;</span>
<a href="#l61.13"></a><span id="l61.13" class="difflineplus">+var handler;</span>
<a href="#l61.14"></a><span id="l61.14" class="difflineplus">+var incomingServer;</span>
<a href="#l61.15"></a><span id="l61.15" class="difflineplus">+var pop3Service;</span>
<a href="#l61.16"></a><span id="l61.16" class="difflineplus">+var acctMgr;</span>
<a href="#l61.17"></a><span id="l61.17" class="difflineplus">+var thisTest;</span>
<a href="#l61.18"></a><span id="l61.18" class="difflineplus">+var test = null;</span>
<a href="#l61.19"></a><span id="l61.19" class="difflineplus">+</span>
<a href="#l61.20"></a><span id="l61.20" class="difflineplus">+var tests = [</span>
<a href="#l61.21"></a><span id="l61.21" class="difflineplus">+  { title: &quot;Cleartext password, with server only supporting USER/PASS&quot;,</span>
<a href="#l61.22"></a><span id="l61.22" class="difflineplus">+    clientAuthMethod : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l61.23"></a><span id="l61.23" class="difflineplus">+    serverAuthMethods : [],</span>
<a href="#l61.24"></a><span id="l61.24" class="difflineplus">+    expectSuccess : true,</span>
<a href="#l61.25"></a><span id="l61.25" class="difflineplus">+    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;USER fred&quot;, &quot;PASS wilma&quot;, &quot;STAT&quot; ] },</span>
<a href="#l61.26"></a><span id="l61.26" class="difflineplus">+  // Just to make sure we clear the auth flags and re-issue &quot;AUTH&quot;</span>
<a href="#l61.27"></a><span id="l61.27" class="difflineplus">+  { title: &quot;Second time Cleartext password, with server only supporting USER/PASS&quot;,</span>
<a href="#l61.28"></a><span id="l61.28" class="difflineplus">+    clientAuthMethod : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l61.29"></a><span id="l61.29" class="difflineplus">+    serverAuthMethods : [],</span>
<a href="#l61.30"></a><span id="l61.30" class="difflineplus">+    expectSuccess : true,</span>
<a href="#l61.31"></a><span id="l61.31" class="difflineplus">+    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;USER fred&quot;, &quot;PASS wilma&quot;, &quot;STAT&quot; ] },</span>
<a href="#l61.32"></a><span id="l61.32" class="difflineplus">+  { title: &quot;Cleartext password, with server supporting AUTH PLAIN, LOGIN and CRAM&quot;,</span>
<a href="#l61.33"></a><span id="l61.33" class="difflineplus">+    clientAuthMethod : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l61.34"></a><span id="l61.34" class="difflineplus">+    serverAuthMethods : [ &quot;PLAIN&quot;, &quot;LOGIN&quot;, &quot;CRAM-MD5&quot; ],</span>
<a href="#l61.35"></a><span id="l61.35" class="difflineplus">+    expectSuccess : true,</span>
<a href="#l61.36"></a><span id="l61.36" class="difflineplus">+    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH PLAIN&quot;, &quot;STAT&quot; ] },</span>
<a href="#l61.37"></a><span id="l61.37" class="difflineplus">+  { title: &quot;Cleartext password, with server supporting only AUTH LOGIN&quot;,</span>
<a href="#l61.38"></a><span id="l61.38" class="difflineplus">+    clientAuthMethod : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l61.39"></a><span id="l61.39" class="difflineplus">+    serverAuthMethods : [ &quot;LOGIN&quot; ],</span>
<a href="#l61.40"></a><span id="l61.40" class="difflineplus">+    expectSuccess : true,</span>
<a href="#l61.41"></a><span id="l61.41" class="difflineplus">+    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH LOGIN&quot;, &quot;STAT&quot; ] },</span>
<a href="#l61.42"></a><span id="l61.42" class="difflineplus">+  { title: &quot;Encrypted password, with server supporting PLAIN and CRAM&quot;,</span>
<a href="#l61.43"></a><span id="l61.43" class="difflineplus">+    clientAuthMethod : Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l61.44"></a><span id="l61.44" class="difflineplus">+    serverAuthMethods : [ &quot;PLAIN&quot;, &quot;LOGIN&quot;, &quot;CRAM-MD5&quot; ],</span>
<a href="#l61.45"></a><span id="l61.45" class="difflineplus">+    expectSuccess : true,</span>
<a href="#l61.46"></a><span id="l61.46" class="difflineplus">+    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH CRAM-MD5&quot;, &quot;STAT&quot; ] },</span>
<a href="#l61.47"></a><span id="l61.47" class="difflineplus">+  { title: &quot;Encrypted password, with server only supporting AUTH PLAIN and LOGIN (must fail)&quot;,</span>
<a href="#l61.48"></a><span id="l61.48" class="difflineplus">+    clientAuthMethod : Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l61.49"></a><span id="l61.49" class="difflineplus">+    serverAuthMethods : [ &quot;PLAIN&quot;, &quot;LOGIN&quot; ],</span>
<a href="#l61.50"></a><span id="l61.50" class="difflineplus">+    expectSuccess : false,</span>
<a href="#l61.51"></a><span id="l61.51" class="difflineplus">+    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot;] },</span>
<a href="#l61.52"></a><span id="l61.52" class="difflineplus">+  { title: &quot;Any secure method, with server supporting AUTH PLAIN and CRAM&quot;,</span>
<a href="#l61.53"></a><span id="l61.53" class="difflineplus">+    clientAuthMethod : Ci.nsMsgAuthMethod.secure,</span>
<a href="#l61.54"></a><span id="l61.54" class="difflineplus">+    serverAuthMethods : [ &quot;PLAIN&quot; , &quot;LOGIN&quot;, &quot;CRAM-MD5&quot; ],</span>
<a href="#l61.55"></a><span id="l61.55" class="difflineplus">+    expectSuccess : true,</span>
<a href="#l61.56"></a><span id="l61.56" class="difflineplus">+    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH CRAM-MD5&quot;, &quot;STAT&quot; ] },</span>
<a href="#l61.57"></a><span id="l61.57" class="difflineplus">+  { title: &quot;Any secure method, with server only supporting AUTH PLAIN and LOGIN (must fail)&quot;,</span>
<a href="#l61.58"></a><span id="l61.58" class="difflineplus">+    clientAuthMethod : Ci.nsMsgAuthMethod.secure,</span>
<a href="#l61.59"></a><span id="l61.59" class="difflineplus">+    serverAuthMethods : [ &quot;PLAIN&quot; ],</span>
<a href="#l61.60"></a><span id="l61.60" class="difflineplus">+    expectSuccess : false,</span>
<a href="#l61.61"></a><span id="l61.61" class="difflineplus">+    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot; ] }</span>
<a href="#l61.62"></a><span id="l61.62" class="difflineplus">+];</span>
<a href="#l61.63"></a><span id="l61.63" class="difflineplus">+</span>
<a href="#l61.64"></a><span id="l61.64" class="difflineplus">+var urlListener =</span>
<a href="#l61.65"></a><span id="l61.65" class="difflineplus">+{</span>
<a href="#l61.66"></a><span id="l61.66" class="difflineplus">+  OnStartRunningUrl: function (url) {</span>
<a href="#l61.67"></a><span id="l61.67" class="difflineplus">+  },</span>
<a href="#l61.68"></a><span id="l61.68" class="difflineplus">+  OnStopRunningUrl: function (url, result) {</span>
<a href="#l61.69"></a><span id="l61.69" class="difflineplus">+    try {</span>
<a href="#l61.70"></a><span id="l61.70" class="difflineplus">+      if (thisTest.expectSuccess)</span>
<a href="#l61.71"></a><span id="l61.71" class="difflineplus">+        do_check_eq(result, 0);</span>
<a href="#l61.72"></a><span id="l61.72" class="difflineplus">+      else</span>
<a href="#l61.73"></a><span id="l61.73" class="difflineplus">+        do_check_neq(result, 0);</span>
<a href="#l61.74"></a><span id="l61.74" class="difflineplus">+</span>
<a href="#l61.75"></a><span id="l61.75" class="difflineplus">+      var transaction = server.playTransaction();</span>
<a href="#l61.76"></a><span id="l61.76" class="difflineplus">+      do_check_transaction(transaction, thisTest.transaction);</span>
<a href="#l61.77"></a><span id="l61.77" class="difflineplus">+</span>
<a href="#l61.78"></a><span id="l61.78" class="difflineplus">+      do_timeout(0, checkBusy);</span>
<a href="#l61.79"></a><span id="l61.79" class="difflineplus">+    } catch (e) {</span>
<a href="#l61.80"></a><span id="l61.80" class="difflineplus">+      server.stop();</span>
<a href="#l61.81"></a><span id="l61.81" class="difflineplus">+      var thread = gThreadManager.currentThread;</span>
<a href="#l61.82"></a><span id="l61.82" class="difflineplus">+      while (thread.hasPendingEvents())</span>
<a href="#l61.83"></a><span id="l61.83" class="difflineplus">+        thread.processNextEvent(true);</span>
<a href="#l61.84"></a><span id="l61.84" class="difflineplus">+</span>
<a href="#l61.85"></a><span id="l61.85" class="difflineplus">+      do_throw(e);</span>
<a href="#l61.86"></a><span id="l61.86" class="difflineplus">+    }</span>
<a href="#l61.87"></a><span id="l61.87" class="difflineplus">+  }</span>
<a href="#l61.88"></a><span id="l61.88" class="difflineplus">+};</span>
<a href="#l61.89"></a><span id="l61.89" class="difflineplus">+</span>
<a href="#l61.90"></a><span id="l61.90" class="difflineplus">+function checkBusy() {</span>
<a href="#l61.91"></a><span id="l61.91" class="difflineplus">+  if (tests.length == 0) {</span>
<a href="#l61.92"></a><span id="l61.92" class="difflineplus">+    incomingServer.closeCachedConnections();</span>
<a href="#l61.93"></a><span id="l61.93" class="difflineplus">+</span>
<a href="#l61.94"></a><span id="l61.94" class="difflineplus">+    // No more tests, let everything finish</span>
<a href="#l61.95"></a><span id="l61.95" class="difflineplus">+    server.stop();</span>
<a href="#l61.96"></a><span id="l61.96" class="difflineplus">+</span>
<a href="#l61.97"></a><span id="l61.97" class="difflineplus">+    var thread = gThreadManager.currentThread;</span>
<a href="#l61.98"></a><span id="l61.98" class="difflineplus">+    while (thread.hasPendingEvents())</span>
<a href="#l61.99"></a><span id="l61.99" class="difflineplus">+      thread.processNextEvent(true);</span>
<a href="#l61.100"></a><span id="l61.100" class="difflineplus">+</span>
<a href="#l61.101"></a><span id="l61.101" class="difflineplus">+    do_test_finished();</span>
<a href="#l61.102"></a><span id="l61.102" class="difflineplus">+    return;</span>
<a href="#l61.103"></a><span id="l61.103" class="difflineplus">+  }</span>
<a href="#l61.104"></a><span id="l61.104" class="difflineplus">+</span>
<a href="#l61.105"></a><span id="l61.105" class="difflineplus">+  // If the server hasn't quite finished, just delay a little longer.</span>
<a href="#l61.106"></a><span id="l61.106" class="difflineplus">+  if (incomingServer.serverBusy ||</span>
<a href="#l61.107"></a><span id="l61.107" class="difflineplus">+      (incomingServer instanceof Ci.nsIPop3IncomingServer &amp;&amp;</span>
<a href="#l61.108"></a><span id="l61.108" class="difflineplus">+       incomingServer.runningProtocol)) {</span>
<a href="#l61.109"></a><span id="l61.109" class="difflineplus">+    do_timeout(20, checkBusy);</span>
<a href="#l61.110"></a><span id="l61.110" class="difflineplus">+    return;</span>
<a href="#l61.111"></a><span id="l61.111" class="difflineplus">+  }</span>
<a href="#l61.112"></a><span id="l61.112" class="difflineplus">+</span>
<a href="#l61.113"></a><span id="l61.113" class="difflineplus">+  testNext();</span>
<a href="#l61.114"></a><span id="l61.114" class="difflineplus">+}</span>
<a href="#l61.115"></a><span id="l61.115" class="difflineplus">+</span>
<a href="#l61.116"></a><span id="l61.116" class="difflineplus">+function testNext() {</span>
<a href="#l61.117"></a><span id="l61.117" class="difflineplus">+  thisTest = tests.shift();</span>
<a href="#l61.118"></a><span id="l61.118" class="difflineplus">+</span>
<a href="#l61.119"></a><span id="l61.119" class="difflineplus">+  // Handle the server in a try/catch/finally loop so that we always will stop</span>
<a href="#l61.120"></a><span id="l61.120" class="difflineplus">+  // the server if something fails.</span>
<a href="#l61.121"></a><span id="l61.121" class="difflineplus">+  try {</span>
<a href="#l61.122"></a><span id="l61.122" class="difflineplus">+    server.resetTest();</span>
<a href="#l61.123"></a><span id="l61.123" class="difflineplus">+</span>
<a href="#l61.124"></a><span id="l61.124" class="difflineplus">+    test = thisTest.title;</span>
<a href="#l61.125"></a><span id="l61.125" class="difflineplus">+    dump(&quot;NEXT test: &quot; + thisTest.title + &quot;\n&quot;);</span>
<a href="#l61.126"></a><span id="l61.126" class="difflineplus">+</span>
<a href="#l61.127"></a><span id="l61.127" class="difflineplus">+    handler.kAuthSchemes = thisTest.serverAuthMethods;</span>
<a href="#l61.128"></a><span id="l61.128" class="difflineplus">+</span>
<a href="#l61.129"></a><span id="l61.129" class="difflineplus">+    // Mailnews caches server capabilities, so try to reset it</span>
<a href="#l61.130"></a><span id="l61.130" class="difflineplus">+    // (alternative would be .pop3CapabilityFlags = 0, but this is safer)</span>
<a href="#l61.131"></a><span id="l61.131" class="difflineplus">+    deletePop3Server();</span>
<a href="#l61.132"></a><span id="l61.132" class="difflineplus">+    incomingServer = createPop3Server();</span>
<a href="#l61.133"></a><span id="l61.133" class="difflineplus">+</span>
<a href="#l61.134"></a><span id="l61.134" class="difflineplus">+    let msgServer = incomingServer;</span>
<a href="#l61.135"></a><span id="l61.135" class="difflineplus">+    msgServer.QueryInterface(Ci.nsIMsgIncomingServer);</span>
<a href="#l61.136"></a><span id="l61.136" class="difflineplus">+    msgServer.authMethod = thisTest.clientAuthMethod;</span>
<a href="#l61.137"></a><span id="l61.137" class="difflineplus">+</span>
<a href="#l61.138"></a><span id="l61.138" class="difflineplus">+    pop3Service.GetNewMail(null, urlListener, gLocalInboxFolder,</span>
<a href="#l61.139"></a><span id="l61.139" class="difflineplus">+                           incomingServer);</span>
<a href="#l61.140"></a><span id="l61.140" class="difflineplus">+    server.performTest();</span>
<a href="#l61.141"></a><span id="l61.141" class="difflineplus">+  } catch (e) {</span>
<a href="#l61.142"></a><span id="l61.142" class="difflineplus">+    server.stop();</span>
<a href="#l61.143"></a><span id="l61.143" class="difflineplus">+    do_throw(e);</span>
<a href="#l61.144"></a><span id="l61.144" class="difflineplus">+  }</span>
<a href="#l61.145"></a><span id="l61.145" class="difflineplus">+}</span>
<a href="#l61.146"></a><span id="l61.146" class="difflineplus">+</span>
<a href="#l61.147"></a><span id="l61.147" class="difflineplus">+// &lt;copied from=&quot;head_maillocal.js::createPop3ServerAndLocalFolders()&quot;&gt;</span>
<a href="#l61.148"></a><span id="l61.148" class="difflineplus">+function createPop3Server()</span>
<a href="#l61.149"></a><span id="l61.149" class="difflineplus">+{</span>
<a href="#l61.150"></a><span id="l61.150" class="difflineplus">+  var incoming = acctMgr.createIncomingServer(&quot;fred&quot;, &quot;localhost&quot;, &quot;pop3&quot;);</span>
<a href="#l61.151"></a><span id="l61.151" class="difflineplus">+  incoming.port = POP3_PORT;</span>
<a href="#l61.152"></a><span id="l61.152" class="difflineplus">+  incoming.password = &quot;wilma&quot;;</span>
<a href="#l61.153"></a><span id="l61.153" class="difflineplus">+  return incoming;</span>
<a href="#l61.154"></a><span id="l61.154" class="difflineplus">+}</span>
<a href="#l61.155"></a><span id="l61.155" class="difflineplus">+//&lt;/copied&gt;</span>
<a href="#l61.156"></a><span id="l61.156" class="difflineplus">+</span>
<a href="#l61.157"></a><span id="l61.157" class="difflineplus">+function deletePop3Server()</span>
<a href="#l61.158"></a><span id="l61.158" class="difflineplus">+{</span>
<a href="#l61.159"></a><span id="l61.159" class="difflineplus">+  if (!incomingServer)</span>
<a href="#l61.160"></a><span id="l61.160" class="difflineplus">+    return;</span>
<a href="#l61.161"></a><span id="l61.161" class="difflineplus">+  acctMgr.removeIncomingServer(incomingServer, true);</span>
<a href="#l61.162"></a><span id="l61.162" class="difflineplus">+  incomingServer = null;</span>
<a href="#l61.163"></a><span id="l61.163" class="difflineplus">+}</span>
<a href="#l61.164"></a><span id="l61.164" class="difflineplus">+</span>
<a href="#l61.165"></a><span id="l61.165" class="difflineplus">+function run_test() {</span>
<a href="#l61.166"></a><span id="l61.166" class="difflineplus">+  // Disable new mail notifications</span>
<a href="#l61.167"></a><span id="l61.167" class="difflineplus">+  var prefSvc = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l61.168"></a><span id="l61.168" class="difflineplus">+    .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l61.169"></a><span id="l61.169" class="difflineplus">+</span>
<a href="#l61.170"></a><span id="l61.170" class="difflineplus">+  prefSvc.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l61.171"></a><span id="l61.171" class="difflineplus">+  prefSvc.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l61.172"></a><span id="l61.172" class="difflineplus">+  prefSvc.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l61.173"></a><span id="l61.173" class="difflineplus">+  prefSvc.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l61.174"></a><span id="l61.174" class="difflineplus">+</span>
<a href="#l61.175"></a><span id="l61.175" class="difflineplus">+  ssd = setupServerDaemon();</span>
<a href="#l61.176"></a><span id="l61.176" class="difflineplus">+  daemon = ssd[0];</span>
<a href="#l61.177"></a><span id="l61.177" class="difflineplus">+  server = ssd[1];</span>
<a href="#l61.178"></a><span id="l61.178" class="difflineplus">+  handler = ssd[2];</span>
<a href="#l61.179"></a><span id="l61.179" class="difflineplus">+  server.start(POP3_PORT);</span>
<a href="#l61.180"></a><span id="l61.180" class="difflineplus">+</span>
<a href="#l61.181"></a><span id="l61.181" class="difflineplus">+  //incomingServer = createPop3ServerAndLocalFolders();</span>
<a href="#l61.182"></a><span id="l61.182" class="difflineplus">+  loadLocalMailAccount();</span>
<a href="#l61.183"></a><span id="l61.183" class="difflineplus">+</span>
<a href="#l61.184"></a><span id="l61.184" class="difflineplus">+  pop3Service = Cc[&quot;@mozilla.org/messenger/popservice;1&quot;]</span>
<a href="#l61.185"></a><span id="l61.185" class="difflineplus">+                      .getService(Ci.nsIPop3Service);</span>
<a href="#l61.186"></a><span id="l61.186" class="difflineplus">+  acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l61.187"></a><span id="l61.187" class="difflineplus">+                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l61.188"></a><span id="l61.188" class="difflineplus">+</span>
<a href="#l61.189"></a><span id="l61.189" class="difflineplus">+  do_test_pending();</span>
<a href="#l61.190"></a><span id="l61.190" class="difflineplus">+</span>
<a href="#l61.191"></a><span id="l61.191" class="difflineplus">+  testNext();</span>
<a href="#l61.192"></a><span id="l61.192" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1">new file mode 100644</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineminus">--- /dev/null</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3GSSAPIFail.js</span>
<a href="#l62.4"></a><span id="l62.4" class="difflineat">@@ -0,0 +1,218 @@</span>
<a href="#l62.5"></a><span id="l62.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l62.6"></a><span id="l62.6" class="difflineplus">+/**</span>
<a href="#l62.7"></a><span id="l62.7" class="difflineplus">+ * A server offers GSSAPI (Kerberos), but auth fails, due to client or server.</span>
<a href="#l62.8"></a><span id="l62.8" class="difflineplus">+ *</span>
<a href="#l62.9"></a><span id="l62.9" class="difflineplus">+ * This mainly tests whether we use the correct login mode.</span>
<a href="#l62.10"></a><span id="l62.10" class="difflineplus">+ *</span>
<a href="#l62.11"></a><span id="l62.11" class="difflineplus">+ * Whether it fails due to</span>
<a href="#l62.12"></a><span id="l62.12" class="difflineplus">+ * - client not set up</span>
<a href="#l62.13"></a><span id="l62.13" class="difflineplus">+ * - client ticket expired / not logged in</span>
<a href="#l62.14"></a><span id="l62.14" class="difflineplus">+ * - server not being set up properly</span>
<a href="#l62.15"></a><span id="l62.15" class="difflineplus">+ * makes no difference to Thunderbird, as that's all hidden in the gssapi-Library</span>
<a href="#l62.16"></a><span id="l62.16" class="difflineplus">+ * from the OS. So, the server here just returning err is a good approximation</span>
<a href="#l62.17"></a><span id="l62.17" class="difflineplus">+ * of reality of the above cases.</span>
<a href="#l62.18"></a><span id="l62.18" class="difflineplus">+ *</span>
<a href="#l62.19"></a><span id="l62.19" class="difflineplus">+ * Actually, we (more precisely the OS GSSAPI lib) fail out of band</span>
<a href="#l62.20"></a><span id="l62.20" class="difflineplus">+ * in the Kerberos protocol, before the AUTH GSSAPI command is even issued.</span>
<a href="#l62.21"></a><span id="l62.21" class="difflineplus">+ *</span>
<a href="#l62.22"></a><span id="l62.22" class="difflineplus">+ * @author Ben Bucksch</span>
<a href="#l62.23"></a><span id="l62.23" class="difflineplus">+ */</span>
<a href="#l62.24"></a><span id="l62.24" class="difflineplus">+</span>
<a href="#l62.25"></a><span id="l62.25" class="difflineplus">+var server;</span>
<a href="#l62.26"></a><span id="l62.26" class="difflineplus">+var daemon;</span>
<a href="#l62.27"></a><span id="l62.27" class="difflineplus">+var handler;</span>
<a href="#l62.28"></a><span id="l62.28" class="difflineplus">+var incomingServer;</span>
<a href="#l62.29"></a><span id="l62.29" class="difflineplus">+var pop3Service;</span>
<a href="#l62.30"></a><span id="l62.30" class="difflineplus">+var acctMgr;</span>
<a href="#l62.31"></a><span id="l62.31" class="difflineplus">+var thisTest;</span>
<a href="#l62.32"></a><span id="l62.32" class="difflineplus">+var test = null;</span>
<a href="#l62.33"></a><span id="l62.33" class="difflineplus">+</span>
<a href="#l62.34"></a><span id="l62.34" class="difflineplus">+var tests = [</span>
<a href="#l62.35"></a><span id="l62.35" class="difflineplus">+  { title: &quot;GSSAPI auth, server with GSSAPI only&quot;,</span>
<a href="#l62.36"></a><span id="l62.36" class="difflineplus">+    clientAuthMethod : Ci.nsMsgAuthMethod.GSSAPI,</span>
<a href="#l62.37"></a><span id="l62.37" class="difflineplus">+    serverAuthMethods : [ &quot;GSSAPI&quot; ],</span>
<a href="#l62.38"></a><span id="l62.38" class="difflineplus">+    expectSuccess : false,</span>
<a href="#l62.39"></a><span id="l62.39" class="difflineplus">+    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot; ] },</span>
<a href="#l62.40"></a><span id="l62.40" class="difflineplus">+    // First GSSAPI step happens and fails out of band, thus no &quot;AUTH GSSAPI&quot;</span>
<a href="#l62.41"></a><span id="l62.41" class="difflineplus">+  { title: &quot;GSSAPI auth, server with GSSAPI and CRAM-MD5&quot;,</span>
<a href="#l62.42"></a><span id="l62.42" class="difflineplus">+    clientAuthMethod : Ci.nsMsgAuthMethod.GSSAPI,</span>
<a href="#l62.43"></a><span id="l62.43" class="difflineplus">+    serverAuthMethods : [ &quot;GSSAPI&quot;, &quot;CRAM-MD5&quot; ],</span>
<a href="#l62.44"></a><span id="l62.44" class="difflineplus">+    expectSuccess : false,</span>
<a href="#l62.45"></a><span id="l62.45" class="difflineplus">+    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot; ] },</span>
<a href="#l62.46"></a><span id="l62.46" class="difflineplus">+  { title: &quot;Any secure auth, server with GSSAPI only&quot;,</span>
<a href="#l62.47"></a><span id="l62.47" class="difflineplus">+    clientAuthMethod : Ci.nsMsgAuthMethod.secure,</span>
<a href="#l62.48"></a><span id="l62.48" class="difflineplus">+    serverAuthMethods : [ &quot;GSSAPI&quot; ],</span>
<a href="#l62.49"></a><span id="l62.49" class="difflineplus">+    expectSuccess : false,</span>
<a href="#l62.50"></a><span id="l62.50" class="difflineplus">+    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot; ] },</span>
<a href="#l62.51"></a><span id="l62.51" class="difflineplus">+  { title: &quot;Any secure auth, server with GSSAPI and CRAM-MD5&quot;,</span>
<a href="#l62.52"></a><span id="l62.52" class="difflineplus">+    clientAuthMethod : Ci.nsMsgAuthMethod.secure,</span>
<a href="#l62.53"></a><span id="l62.53" class="difflineplus">+    serverAuthMethods : [ &quot;GSSAPI&quot;, &quot;CRAM-MD5&quot; ],</span>
<a href="#l62.54"></a><span id="l62.54" class="difflineplus">+    expectSuccess : true,</span>
<a href="#l62.55"></a><span id="l62.55" class="difflineplus">+    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH CRAM-MD5&quot;, &quot;STAT&quot; ] },</span>
<a href="#l62.56"></a><span id="l62.56" class="difflineplus">+  { title: &quot;Encrypted password, server with GSSAPI and CRAM-MD5&quot;,</span>
<a href="#l62.57"></a><span id="l62.57" class="difflineplus">+    clientAuthMethod : Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l62.58"></a><span id="l62.58" class="difflineplus">+    serverAuthMethods : [ &quot;GSSAPI&quot;, &quot;CRAM-MD5&quot; ],</span>
<a href="#l62.59"></a><span id="l62.59" class="difflineplus">+    expectSuccess : true,</span>
<a href="#l62.60"></a><span id="l62.60" class="difflineplus">+    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH CRAM-MD5&quot;, &quot;STAT&quot; ] },</span>
<a href="#l62.61"></a><span id="l62.61" class="difflineplus">+];</span>
<a href="#l62.62"></a><span id="l62.62" class="difflineplus">+</span>
<a href="#l62.63"></a><span id="l62.63" class="difflineplus">+var urlListener =</span>
<a href="#l62.64"></a><span id="l62.64" class="difflineplus">+{</span>
<a href="#l62.65"></a><span id="l62.65" class="difflineplus">+  OnStartRunningUrl: function (url) {</span>
<a href="#l62.66"></a><span id="l62.66" class="difflineplus">+  },</span>
<a href="#l62.67"></a><span id="l62.67" class="difflineplus">+  OnStopRunningUrl: function (url, result) {</span>
<a href="#l62.68"></a><span id="l62.68" class="difflineplus">+    try {</span>
<a href="#l62.69"></a><span id="l62.69" class="difflineplus">+      if (thisTest.expectSuccess)</span>
<a href="#l62.70"></a><span id="l62.70" class="difflineplus">+        do_check_eq(result, 0);</span>
<a href="#l62.71"></a><span id="l62.71" class="difflineplus">+      else</span>
<a href="#l62.72"></a><span id="l62.72" class="difflineplus">+        do_check_neq(result, 0);</span>
<a href="#l62.73"></a><span id="l62.73" class="difflineplus">+</span>
<a href="#l62.74"></a><span id="l62.74" class="difflineplus">+      var transaction = server.playTransaction();</span>
<a href="#l62.75"></a><span id="l62.75" class="difflineplus">+      do_check_transaction(transaction, thisTest.transaction);</span>
<a href="#l62.76"></a><span id="l62.76" class="difflineplus">+</span>
<a href="#l62.77"></a><span id="l62.77" class="difflineplus">+      do_timeout(0, checkBusy);</span>
<a href="#l62.78"></a><span id="l62.78" class="difflineplus">+    } catch (e) {</span>
<a href="#l62.79"></a><span id="l62.79" class="difflineplus">+      server.stop();</span>
<a href="#l62.80"></a><span id="l62.80" class="difflineplus">+      var thread = gThreadManager.currentThread;</span>
<a href="#l62.81"></a><span id="l62.81" class="difflineplus">+      while (thread.hasPendingEvents())</span>
<a href="#l62.82"></a><span id="l62.82" class="difflineplus">+        thread.processNextEvent(true);</span>
<a href="#l62.83"></a><span id="l62.83" class="difflineplus">+</span>
<a href="#l62.84"></a><span id="l62.84" class="difflineplus">+      do_throw(e);</span>
<a href="#l62.85"></a><span id="l62.85" class="difflineplus">+    }</span>
<a href="#l62.86"></a><span id="l62.86" class="difflineplus">+  }</span>
<a href="#l62.87"></a><span id="l62.87" class="difflineplus">+};</span>
<a href="#l62.88"></a><span id="l62.88" class="difflineplus">+</span>
<a href="#l62.89"></a><span id="l62.89" class="difflineplus">+function checkBusy() {</span>
<a href="#l62.90"></a><span id="l62.90" class="difflineplus">+  if (tests.length == 0) {</span>
<a href="#l62.91"></a><span id="l62.91" class="difflineplus">+    incomingServer.closeCachedConnections();</span>
<a href="#l62.92"></a><span id="l62.92" class="difflineplus">+</span>
<a href="#l62.93"></a><span id="l62.93" class="difflineplus">+    // No more tests, let everything finish</span>
<a href="#l62.94"></a><span id="l62.94" class="difflineplus">+    server.stop();</span>
<a href="#l62.95"></a><span id="l62.95" class="difflineplus">+</span>
<a href="#l62.96"></a><span id="l62.96" class="difflineplus">+    var thread = gThreadManager.currentThread;</span>
<a href="#l62.97"></a><span id="l62.97" class="difflineplus">+    while (thread.hasPendingEvents())</span>
<a href="#l62.98"></a><span id="l62.98" class="difflineplus">+      thread.processNextEvent(true);</span>
<a href="#l62.99"></a><span id="l62.99" class="difflineplus">+</span>
<a href="#l62.100"></a><span id="l62.100" class="difflineplus">+    do_test_finished();</span>
<a href="#l62.101"></a><span id="l62.101" class="difflineplus">+    return;</span>
<a href="#l62.102"></a><span id="l62.102" class="difflineplus">+  }</span>
<a href="#l62.103"></a><span id="l62.103" class="difflineplus">+</span>
<a href="#l62.104"></a><span id="l62.104" class="difflineplus">+  // If the server hasn't quite finished, just delay a little longer.</span>
<a href="#l62.105"></a><span id="l62.105" class="difflineplus">+  if (incomingServer.serverBusy ||</span>
<a href="#l62.106"></a><span id="l62.106" class="difflineplus">+      (incomingServer instanceof Ci.nsIPop3IncomingServer &amp;&amp;</span>
<a href="#l62.107"></a><span id="l62.107" class="difflineplus">+       incomingServer.runningProtocol)) {</span>
<a href="#l62.108"></a><span id="l62.108" class="difflineplus">+    do_timeout(20, checkBusy);</span>
<a href="#l62.109"></a><span id="l62.109" class="difflineplus">+    return;</span>
<a href="#l62.110"></a><span id="l62.110" class="difflineplus">+  }</span>
<a href="#l62.111"></a><span id="l62.111" class="difflineplus">+</span>
<a href="#l62.112"></a><span id="l62.112" class="difflineplus">+  testNext();</span>
<a href="#l62.113"></a><span id="l62.113" class="difflineplus">+}</span>
<a href="#l62.114"></a><span id="l62.114" class="difflineplus">+</span>
<a href="#l62.115"></a><span id="l62.115" class="difflineplus">+function testNext() {</span>
<a href="#l62.116"></a><span id="l62.116" class="difflineplus">+  thisTest = tests.shift();</span>
<a href="#l62.117"></a><span id="l62.117" class="difflineplus">+</span>
<a href="#l62.118"></a><span id="l62.118" class="difflineplus">+  // Handle the server in a try/catch/finally loop so that we always will stop</span>
<a href="#l62.119"></a><span id="l62.119" class="difflineplus">+  // the server if something fails.</span>
<a href="#l62.120"></a><span id="l62.120" class="difflineplus">+  try {</span>
<a href="#l62.121"></a><span id="l62.121" class="difflineplus">+    server.resetTest();</span>
<a href="#l62.122"></a><span id="l62.122" class="difflineplus">+</span>
<a href="#l62.123"></a><span id="l62.123" class="difflineplus">+    test = thisTest.title;</span>
<a href="#l62.124"></a><span id="l62.124" class="difflineplus">+    dump(&quot;NEXT test is: &quot; + thisTest.title + &quot;\n&quot;);</span>
<a href="#l62.125"></a><span id="l62.125" class="difflineplus">+</span>
<a href="#l62.126"></a><span id="l62.126" class="difflineplus">+    handler.kAuthSchemes = thisTest.serverAuthMethods;</span>
<a href="#l62.127"></a><span id="l62.127" class="difflineplus">+</span>
<a href="#l62.128"></a><span id="l62.128" class="difflineplus">+    // Mailnews caches server capabilities, so try to reset it</span>
<a href="#l62.129"></a><span id="l62.129" class="difflineplus">+    deletePop3Server();</span>
<a href="#l62.130"></a><span id="l62.130" class="difflineplus">+    incomingServer = createPop3Server();</span>
<a href="#l62.131"></a><span id="l62.131" class="difflineplus">+</span>
<a href="#l62.132"></a><span id="l62.132" class="difflineplus">+    let msgServer = incomingServer;</span>
<a href="#l62.133"></a><span id="l62.133" class="difflineplus">+    msgServer.QueryInterface(Ci.nsIMsgIncomingServer);</span>
<a href="#l62.134"></a><span id="l62.134" class="difflineplus">+    msgServer.authMethod = thisTest.clientAuthMethod;</span>
<a href="#l62.135"></a><span id="l62.135" class="difflineplus">+</span>
<a href="#l62.136"></a><span id="l62.136" class="difflineplus">+    pop3Service.GetNewMail(null, urlListener, gLocalInboxFolder,</span>
<a href="#l62.137"></a><span id="l62.137" class="difflineplus">+                           incomingServer);</span>
<a href="#l62.138"></a><span id="l62.138" class="difflineplus">+    server.performTest();</span>
<a href="#l62.139"></a><span id="l62.139" class="difflineplus">+  } catch (e) {</span>
<a href="#l62.140"></a><span id="l62.140" class="difflineplus">+    server.stop();</span>
<a href="#l62.141"></a><span id="l62.141" class="difflineplus">+    do_throw(e);</span>
<a href="#l62.142"></a><span id="l62.142" class="difflineplus">+  }</span>
<a href="#l62.143"></a><span id="l62.143" class="difflineplus">+}</span>
<a href="#l62.144"></a><span id="l62.144" class="difflineplus">+</span>
<a href="#l62.145"></a><span id="l62.145" class="difflineplus">+// &lt;copied from=&quot;head_maillocal.js::createPop3ServerAndLocalFolders()&quot;&gt;</span>
<a href="#l62.146"></a><span id="l62.146" class="difflineplus">+function createPop3Server()</span>
<a href="#l62.147"></a><span id="l62.147" class="difflineplus">+{</span>
<a href="#l62.148"></a><span id="l62.148" class="difflineplus">+  var incoming = acctMgr.createIncomingServer(&quot;fred&quot;, &quot;localhost&quot;, &quot;pop3&quot;);</span>
<a href="#l62.149"></a><span id="l62.149" class="difflineplus">+  incoming.port = POP3_PORT;</span>
<a href="#l62.150"></a><span id="l62.150" class="difflineplus">+  incoming.password = &quot;wilma&quot;;</span>
<a href="#l62.151"></a><span id="l62.151" class="difflineplus">+  return incoming;</span>
<a href="#l62.152"></a><span id="l62.152" class="difflineplus">+}</span>
<a href="#l62.153"></a><span id="l62.153" class="difflineplus">+//&lt;/copied&gt;</span>
<a href="#l62.154"></a><span id="l62.154" class="difflineplus">+</span>
<a href="#l62.155"></a><span id="l62.155" class="difflineplus">+function deletePop3Server()</span>
<a href="#l62.156"></a><span id="l62.156" class="difflineplus">+{</span>
<a href="#l62.157"></a><span id="l62.157" class="difflineplus">+  if (!incomingServer)</span>
<a href="#l62.158"></a><span id="l62.158" class="difflineplus">+    return;</span>
<a href="#l62.159"></a><span id="l62.159" class="difflineplus">+  acctMgr.removeIncomingServer(incomingServer, true);</span>
<a href="#l62.160"></a><span id="l62.160" class="difflineplus">+  incomingServer = null;</span>
<a href="#l62.161"></a><span id="l62.161" class="difflineplus">+}</span>
<a href="#l62.162"></a><span id="l62.162" class="difflineplus">+</span>
<a href="#l62.163"></a><span id="l62.163" class="difflineplus">+function GSSAPIFail_handler(daemon)</span>
<a href="#l62.164"></a><span id="l62.164" class="difflineplus">+{</span>
<a href="#l62.165"></a><span id="l62.165" class="difflineplus">+  POP3_RFC5034_handler.call(this, daemon);</span>
<a href="#l62.166"></a><span id="l62.166" class="difflineplus">+}</span>
<a href="#l62.167"></a><span id="l62.167" class="difflineplus">+GSSAPIFail_handler.prototype = {</span>
<a href="#l62.168"></a><span id="l62.168" class="difflineplus">+  __proto__ : POP3_RFC5034_handler.prototype, // inherit</span>
<a href="#l62.169"></a><span id="l62.169" class="difflineplus">+  _needGSSAPI : false,</span>
<a href="#l62.170"></a><span id="l62.170" class="difflineplus">+  // kAuthSchemes will be set by test</span>
<a href="#l62.171"></a><span id="l62.171" class="difflineplus">+</span>
<a href="#l62.172"></a><span id="l62.172" class="difflineplus">+  AUTH: function(restLine)</span>
<a href="#l62.173"></a><span id="l62.173" class="difflineplus">+  {</span>
<a href="#l62.174"></a><span id="l62.174" class="difflineplus">+    var scheme = restLine.split(&quot; &quot;)[0];</span>
<a href="#l62.175"></a><span id="l62.175" class="difflineplus">+    if (scheme == &quot;GSSAPI&quot;)</span>
<a href="#l62.176"></a><span id="l62.176" class="difflineplus">+    {</span>
<a href="#l62.177"></a><span id="l62.177" class="difflineplus">+      this._multiline = true;</span>
<a href="#l62.178"></a><span id="l62.178" class="difflineplus">+      this._needGSSAPI = true;</span>
<a href="#l62.179"></a><span id="l62.179" class="difflineplus">+      return &quot;+&quot;;</span>
<a href="#l62.180"></a><span id="l62.180" class="difflineplus">+    }</span>
<a href="#l62.181"></a><span id="l62.181" class="difflineplus">+    return POP3_RFC5034_handler.prototype.AUTH.call(this, restLine); // call parent</span>
<a href="#l62.182"></a><span id="l62.182" class="difflineplus">+  },</span>
<a href="#l62.183"></a><span id="l62.183" class="difflineplus">+  onMultiline: function(line) {</span>
<a href="#l62.184"></a><span id="l62.184" class="difflineplus">+    if (this._needGSSAPI) {</span>
<a href="#l62.185"></a><span id="l62.185" class="difflineplus">+      this._multiline = false;</span>
<a href="#l62.186"></a><span id="l62.186" class="difflineplus">+      this._needGSSAPI = false;</span>
<a href="#l62.187"></a><span id="l62.187" class="difflineplus">+      return &quot;-ERR hm.... shall I allow you? hm... NO.&quot;;</span>
<a href="#l62.188"></a><span id="l62.188" class="difflineplus">+    }</span>
<a href="#l62.189"></a><span id="l62.189" class="difflineplus">+</span>
<a href="#l62.190"></a><span id="l62.190" class="difflineplus">+    if (POP3_RFC5034_handler.prototype.onMultiline)</span>
<a href="#l62.191"></a><span id="l62.191" class="difflineplus">+      return POP3_RFC5034_handler.prototype.onMultiline.call(this, line); // call parent</span>
<a href="#l62.192"></a><span id="l62.192" class="difflineplus">+    return undefined;</span>
<a href="#l62.193"></a><span id="l62.193" class="difflineplus">+  }</span>
<a href="#l62.194"></a><span id="l62.194" class="difflineplus">+}</span>
<a href="#l62.195"></a><span id="l62.195" class="difflineplus">+</span>
<a href="#l62.196"></a><span id="l62.196" class="difflineplus">+function run_test() {</span>
<a href="#l62.197"></a><span id="l62.197" class="difflineplus">+  // Disable new mail notifications</span>
<a href="#l62.198"></a><span id="l62.198" class="difflineplus">+  var prefSvc = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l62.199"></a><span id="l62.199" class="difflineplus">+    .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l62.200"></a><span id="l62.200" class="difflineplus">+</span>
<a href="#l62.201"></a><span id="l62.201" class="difflineplus">+  prefSvc.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l62.202"></a><span id="l62.202" class="difflineplus">+  prefSvc.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l62.203"></a><span id="l62.203" class="difflineplus">+  prefSvc.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l62.204"></a><span id="l62.204" class="difflineplus">+  prefSvc.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l62.205"></a><span id="l62.205" class="difflineplus">+</span>
<a href="#l62.206"></a><span id="l62.206" class="difflineplus">+  daemon = new pop3Daemon();</span>
<a href="#l62.207"></a><span id="l62.207" class="difflineplus">+  handler = new GSSAPIFail_handler(daemon);</span>
<a href="#l62.208"></a><span id="l62.208" class="difflineplus">+  server = new nsMailServer(handler);</span>
<a href="#l62.209"></a><span id="l62.209" class="difflineplus">+  server.start(POP3_PORT);</span>
<a href="#l62.210"></a><span id="l62.210" class="difflineplus">+</span>
<a href="#l62.211"></a><span id="l62.211" class="difflineplus">+  //incomingServer = createPop3ServerAndLocalFolders();</span>
<a href="#l62.212"></a><span id="l62.212" class="difflineplus">+  loadLocalMailAccount();</span>
<a href="#l62.213"></a><span id="l62.213" class="difflineplus">+</span>
<a href="#l62.214"></a><span id="l62.214" class="difflineplus">+  pop3Service = Cc[&quot;@mozilla.org/messenger/popservice;1&quot;]</span>
<a href="#l62.215"></a><span id="l62.215" class="difflineplus">+                      .getService(Ci.nsIPop3Service);</span>
<a href="#l62.216"></a><span id="l62.216" class="difflineplus">+  acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l62.217"></a><span id="l62.217" class="difflineplus">+                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l62.218"></a><span id="l62.218" class="difflineplus">+</span>
<a href="#l62.219"></a><span id="l62.219" class="difflineplus">+  do_test_pending();</span>
<a href="#l62.220"></a><span id="l62.220" class="difflineplus">+</span>
<a href="#l62.221"></a><span id="l62.221" class="difflineplus">+  testNext();</span>
<a href="#l62.222"></a><span id="l62.222" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1">new file mode 100644</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineminus">--- /dev/null</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3ServerBrokenCRAMDisconnect.js</span>
<a href="#l63.4"></a><span id="l63.4" class="difflineat">@@ -0,0 +1,147 @@</span>
<a href="#l63.5"></a><span id="l63.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l63.6"></a><span id="l63.6" class="difflineplus">+/**</span>
<a href="#l63.7"></a><span id="l63.7" class="difflineplus">+ * Server which advertises CRAM-MD5, but is impolite enough to just</span>
<a href="#l63.8"></a><span id="l63.8" class="difflineplus">+ * disconnect (close the TCP connection) when we try it.</span>
<a href="#l63.9"></a><span id="l63.9" class="difflineplus">+ *</span>
<a href="#l63.10"></a><span id="l63.10" class="difflineplus">+ * This is a tough one, because we may lose state on which auth schemes</span>
<a href="#l63.11"></a><span id="l63.11" class="difflineplus">+ * are allowed and which ones failed and may restart from scratch, and</span>
<a href="#l63.12"></a><span id="l63.12" class="difflineplus">+ * retry, never skipping the failed scheme.</span>
<a href="#l63.13"></a><span id="l63.13" class="difflineplus">+ * Dear server implementors, NEVER DO THAT! Be polite, give an error</span>
<a href="#l63.14"></a><span id="l63.14" class="difflineplus">+ * with explanation and by all means keep the connection open.</span>
<a href="#l63.15"></a><span id="l63.15" class="difflineplus">+ *</span>
<a href="#l63.16"></a><span id="l63.16" class="difflineplus">+ * I don't know if real servers do that, but bienvenu says they exist.</span>
<a href="#l63.17"></a><span id="l63.17" class="difflineplus">+ *</span>
<a href="#l63.18"></a><span id="l63.18" class="difflineplus">+ * TODO:</span>
<a href="#l63.19"></a><span id="l63.19" class="difflineplus">+ * This test shows that the current situation is not good.</span>
<a href="#l63.20"></a><span id="l63.20" class="difflineplus">+ * Problems:</span>
<a href="#l63.21"></a><span id="l63.21" class="difflineplus">+ * - We should reopen the connection, remember which auth scheme failed</span>
<a href="#l63.22"></a><span id="l63.22" class="difflineplus">+ *    and start with the next in list, not trying the broken one again.</span>
<a href="#l63.23"></a><span id="l63.23" class="difflineplus">+ *    We currently neither retry nor remember.</span>
<a href="#l63.24"></a><span id="l63.24" class="difflineplus">+ * - OnStopRunningUrl() returns success although the server closed the connection</span>
<a href="#l63.25"></a><span id="l63.25" class="difflineplus">+ *    and it's clearly not successful.</span>
<a href="#l63.26"></a><span id="l63.26" class="difflineplus">+ * - incomingServer thinks it is still running/busy although the connection is</span>
<a href="#l63.27"></a><span id="l63.27" class="difflineplus">+ *    clearly done and over.</span>
<a href="#l63.28"></a><span id="l63.28" class="difflineplus">+ *</span>
<a href="#l63.29"></a><span id="l63.29" class="difflineplus">+ * @author Ben Bucksch</span>
<a href="#l63.30"></a><span id="l63.30" class="difflineplus">+ */</span>
<a href="#l63.31"></a><span id="l63.31" class="difflineplus">+</span>
<a href="#l63.32"></a><span id="l63.32" class="difflineplus">+var server;</span>
<a href="#l63.33"></a><span id="l63.33" class="difflineplus">+var daemon;</span>
<a href="#l63.34"></a><span id="l63.34" class="difflineplus">+var handler;</span>
<a href="#l63.35"></a><span id="l63.35" class="difflineplus">+var incomingServer;</span>
<a href="#l63.36"></a><span id="l63.36" class="difflineplus">+var pop3Service;</span>
<a href="#l63.37"></a><span id="l63.37" class="difflineplus">+const test = &quot;Server which advertises CRAM-MD5, but closes the connection when it's tried&quot;;</span>
<a href="#l63.38"></a><span id="l63.38" class="difflineplus">+// that's how it currently looks like (we fail to log in):</span>
<a href="#l63.39"></a><span id="l63.39" class="difflineplus">+const expectedTransaction = [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH CRAM-MD5&quot; ];</span>
<a href="#l63.40"></a><span id="l63.40" class="difflineplus">+// TODO that's how it should look like (we start a new connection and try another scheme):</span>
<a href="#l63.41"></a><span id="l63.41" class="difflineplus">+//const expectedTransaction = [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH CRAM-MD5&quot;, &quot;CAPA&quot;, &quot;AUTH PLAIN&quot;, &quot;STAT&quot; ];</span>
<a href="#l63.42"></a><span id="l63.42" class="difflineplus">+</span>
<a href="#l63.43"></a><span id="l63.43" class="difflineplus">+var urlListener =</span>
<a href="#l63.44"></a><span id="l63.44" class="difflineplus">+{</span>
<a href="#l63.45"></a><span id="l63.45" class="difflineplus">+  OnStartRunningUrl: function (url) {</span>
<a href="#l63.46"></a><span id="l63.46" class="difflineplus">+  },</span>
<a href="#l63.47"></a><span id="l63.47" class="difflineplus">+  OnStopRunningUrl: function (url, result) {</span>
<a href="#l63.48"></a><span id="l63.48" class="difflineplus">+    try {</span>
<a href="#l63.49"></a><span id="l63.49" class="difflineplus">+      // TODO we should be getting an error here, if we couldn't log in, but we don't.</span>
<a href="#l63.50"></a><span id="l63.50" class="difflineplus">+      do_check_eq(result, 0);</span>
<a href="#l63.51"></a><span id="l63.51" class="difflineplus">+</span>
<a href="#l63.52"></a><span id="l63.52" class="difflineplus">+      var transaction = server.playTransaction();</span>
<a href="#l63.53"></a><span id="l63.53" class="difflineplus">+      do_check_transaction(transaction, expectedTransaction);</span>
<a href="#l63.54"></a><span id="l63.54" class="difflineplus">+</span>
<a href="#l63.55"></a><span id="l63.55" class="difflineplus">+      do_timeout(0, endTest);</span>
<a href="#l63.56"></a><span id="l63.56" class="difflineplus">+    } catch (e) {</span>
<a href="#l63.57"></a><span id="l63.57" class="difflineplus">+      server.stop();</span>
<a href="#l63.58"></a><span id="l63.58" class="difflineplus">+      var thread = gThreadManager.currentThread;</span>
<a href="#l63.59"></a><span id="l63.59" class="difflineplus">+      while (thread.hasPendingEvents())</span>
<a href="#l63.60"></a><span id="l63.60" class="difflineplus">+        thread.processNextEvent(true);</span>
<a href="#l63.61"></a><span id="l63.61" class="difflineplus">+</span>
<a href="#l63.62"></a><span id="l63.62" class="difflineplus">+      do_throw(e);</span>
<a href="#l63.63"></a><span id="l63.63" class="difflineplus">+    }</span>
<a href="#l63.64"></a><span id="l63.64" class="difflineplus">+  }</span>
<a href="#l63.65"></a><span id="l63.65" class="difflineplus">+};</span>
<a href="#l63.66"></a><span id="l63.66" class="difflineplus">+</span>
<a href="#l63.67"></a><span id="l63.67" class="difflineplus">+function checkBusy() {</span>
<a href="#l63.68"></a><span id="l63.68" class="difflineplus">+  // If the server hasn't quite finished, just delay a little longer.</span>
<a href="#l63.69"></a><span id="l63.69" class="difflineplus">+  if (incomingServer.serverBusy ||</span>
<a href="#l63.70"></a><span id="l63.70" class="difflineplus">+      (incomingServer instanceof Ci.nsIPop3IncomingServer &amp;&amp;</span>
<a href="#l63.71"></a><span id="l63.71" class="difflineplus">+       incomingServer.runningProtocol)) {</span>
<a href="#l63.72"></a><span id="l63.72" class="difflineplus">+    do_timeout(20, checkBusy);</span>
<a href="#l63.73"></a><span id="l63.73" class="difflineplus">+    return;</span>
<a href="#l63.74"></a><span id="l63.74" class="difflineplus">+  }</span>
<a href="#l63.75"></a><span id="l63.75" class="difflineplus">+</span>
<a href="#l63.76"></a><span id="l63.76" class="difflineplus">+  endTest();</span>
<a href="#l63.77"></a><span id="l63.77" class="difflineplus">+}</span>
<a href="#l63.78"></a><span id="l63.78" class="difflineplus">+</span>
<a href="#l63.79"></a><span id="l63.79" class="difflineplus">+function endTest() {</span>
<a href="#l63.80"></a><span id="l63.80" class="difflineplus">+  incomingServer.closeCachedConnections();</span>
<a href="#l63.81"></a><span id="l63.81" class="difflineplus">+</span>
<a href="#l63.82"></a><span id="l63.82" class="difflineplus">+  // No more tests, let everything finish</span>
<a href="#l63.83"></a><span id="l63.83" class="difflineplus">+  server.stop();</span>
<a href="#l63.84"></a><span id="l63.84" class="difflineplus">+</span>
<a href="#l63.85"></a><span id="l63.85" class="difflineplus">+  var thread = gThreadManager.currentThread;</span>
<a href="#l63.86"></a><span id="l63.86" class="difflineplus">+  while (thread.hasPendingEvents())</span>
<a href="#l63.87"></a><span id="l63.87" class="difflineplus">+    thread.processNextEvent(true);</span>
<a href="#l63.88"></a><span id="l63.88" class="difflineplus">+</span>
<a href="#l63.89"></a><span id="l63.89" class="difflineplus">+  do_test_finished();</span>
<a href="#l63.90"></a><span id="l63.90" class="difflineplus">+}</span>
<a href="#l63.91"></a><span id="l63.91" class="difflineplus">+</span>
<a href="#l63.92"></a><span id="l63.92" class="difflineplus">+function CRAMFail_handler(daemon)</span>
<a href="#l63.93"></a><span id="l63.93" class="difflineplus">+{</span>
<a href="#l63.94"></a><span id="l63.94" class="difflineplus">+  POP3_RFC5034_handler.call(this, daemon);</span>
<a href="#l63.95"></a><span id="l63.95" class="difflineplus">+</span>
<a href="#l63.96"></a><span id="l63.96" class="difflineplus">+  this._kAuthSchemeStartFunction[&quot;CRAM-MD5&quot;] = this.killConn;</span>
<a href="#l63.97"></a><span id="l63.97" class="difflineplus">+}</span>
<a href="#l63.98"></a><span id="l63.98" class="difflineplus">+CRAMFail_handler.prototype = {</span>
<a href="#l63.99"></a><span id="l63.99" class="difflineplus">+  __proto__ : POP3_RFC5034_handler.prototype, // inherit</span>
<a href="#l63.100"></a><span id="l63.100" class="difflineplus">+</span>
<a href="#l63.101"></a><span id="l63.101" class="difflineplus">+  killConn : function()</span>
<a href="#l63.102"></a><span id="l63.102" class="difflineplus">+  {</span>
<a href="#l63.103"></a><span id="l63.103" class="difflineplus">+     server._readers.forEach(function (reader) {</span>
<a href="#l63.104"></a><span id="l63.104" class="difflineplus">+        //reader.closeSocket(); doesn't close right away</span>
<a href="#l63.105"></a><span id="l63.105" class="difflineplus">+        reader._realCloseSocket();</span>
<a href="#l63.106"></a><span id="l63.106" class="difflineplus">+    });</span>
<a href="#l63.107"></a><span id="l63.107" class="difflineplus">+    return &quot;-ERR I don't feel like it&quot;;</span>
<a href="#l63.108"></a><span id="l63.108" class="difflineplus">+  }</span>
<a href="#l63.109"></a><span id="l63.109" class="difflineplus">+}</span>
<a href="#l63.110"></a><span id="l63.110" class="difflineplus">+</span>
<a href="#l63.111"></a><span id="l63.111" class="difflineplus">+function run_test() {</span>
<a href="#l63.112"></a><span id="l63.112" class="difflineplus">+  try {</span>
<a href="#l63.113"></a><span id="l63.113" class="difflineplus">+    do_test_pending();</span>
<a href="#l63.114"></a><span id="l63.114" class="difflineplus">+</span>
<a href="#l63.115"></a><span id="l63.115" class="difflineplus">+    // Disable new mail notifications</span>
<a href="#l63.116"></a><span id="l63.116" class="difflineplus">+    var prefSvc = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l63.117"></a><span id="l63.117" class="difflineplus">+      .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l63.118"></a><span id="l63.118" class="difflineplus">+</span>
<a href="#l63.119"></a><span id="l63.119" class="difflineplus">+    prefSvc.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l63.120"></a><span id="l63.120" class="difflineplus">+    prefSvc.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l63.121"></a><span id="l63.121" class="difflineplus">+    prefSvc.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l63.122"></a><span id="l63.122" class="difflineplus">+    prefSvc.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l63.123"></a><span id="l63.123" class="difflineplus">+</span>
<a href="#l63.124"></a><span id="l63.124" class="difflineplus">+    daemon = new pop3Daemon();</span>
<a href="#l63.125"></a><span id="l63.125" class="difflineplus">+    handler = new CRAMFail_handler(daemon);</span>
<a href="#l63.126"></a><span id="l63.126" class="difflineplus">+    server = new nsMailServer(handler);</span>
<a href="#l63.127"></a><span id="l63.127" class="difflineplus">+    server.start(POP3_PORT);</span>
<a href="#l63.128"></a><span id="l63.128" class="difflineplus">+</span>
<a href="#l63.129"></a><span id="l63.129" class="difflineplus">+    incomingServer = createPop3ServerAndLocalFolders();</span>
<a href="#l63.130"></a><span id="l63.130" class="difflineplus">+    let msgServer = incomingServer;</span>
<a href="#l63.131"></a><span id="l63.131" class="difflineplus">+    msgServer.QueryInterface(Ci.nsIMsgIncomingServer);</span>
<a href="#l63.132"></a><span id="l63.132" class="difflineplus">+    // Need to allow any auth here, although that's not use in TB really,</span>
<a href="#l63.133"></a><span id="l63.133" class="difflineplus">+    // because we need to fall back to something after CRAM-MD5 and</span>
<a href="#l63.134"></a><span id="l63.134" class="difflineplus">+    // check that login works after we fell back.</span>
<a href="#l63.135"></a><span id="l63.135" class="difflineplus">+    msgServer.authMethod = Ci.nsMsgAuthMethod.anything;</span>
<a href="#l63.136"></a><span id="l63.136" class="difflineplus">+</span>
<a href="#l63.137"></a><span id="l63.137" class="difflineplus">+    pop3Service = Cc[&quot;@mozilla.org/messenger/popservice;1&quot;]</span>
<a href="#l63.138"></a><span id="l63.138" class="difflineplus">+                        .getService(Ci.nsIPop3Service);</span>
<a href="#l63.139"></a><span id="l63.139" class="difflineplus">+    pop3Service.GetNewMail(null, urlListener, gLocalInboxFolder,</span>
<a href="#l63.140"></a><span id="l63.140" class="difflineplus">+                           incomingServer);</span>
<a href="#l63.141"></a><span id="l63.141" class="difflineplus">+    server.performTest();</span>
<a href="#l63.142"></a><span id="l63.142" class="difflineplus">+  } catch (e) {</span>
<a href="#l63.143"></a><span id="l63.143" class="difflineplus">+    server.stop();</span>
<a href="#l63.144"></a><span id="l63.144" class="difflineplus">+</span>
<a href="#l63.145"></a><span id="l63.145" class="difflineplus">+    do_throw(e);</span>
<a href="#l63.146"></a><span id="l63.146" class="difflineplus">+  } finally {</span>
<a href="#l63.147"></a><span id="l63.147" class="difflineplus">+    var thread = gThreadManager.currentThread;</span>
<a href="#l63.148"></a><span id="l63.148" class="difflineplus">+    while (thread.hasPendingEvents())</span>
<a href="#l63.149"></a><span id="l63.149" class="difflineplus">+      thread.processNextEvent(true);</span>
<a href="#l63.150"></a><span id="l63.150" class="difflineplus">+  }</span>
<a href="#l63.151"></a><span id="l63.151" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1">new file mode 100644</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineminus">--- /dev/null</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3ServerBrokenCRAMFail.js</span>
<a href="#l64.4"></a><span id="l64.4" class="difflineat">@@ -0,0 +1,119 @@</span>
<a href="#l64.5"></a><span id="l64.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l64.6"></a><span id="l64.6" class="difflineplus">+/**</span>
<a href="#l64.7"></a><span id="l64.7" class="difflineplus">+ * Server which advertises CRAM-MD5, but fails when it's tried.</span>
<a href="#l64.8"></a><span id="l64.8" class="difflineplus">+ * This reportedly happens for some misconfigured servers.</span>
<a href="#l64.9"></a><span id="l64.9" class="difflineplus">+ */</span>
<a href="#l64.10"></a><span id="l64.10" class="difflineplus">+var server;</span>
<a href="#l64.11"></a><span id="l64.11" class="difflineplus">+var daemon;</span>
<a href="#l64.12"></a><span id="l64.12" class="difflineplus">+var handler;</span>
<a href="#l64.13"></a><span id="l64.13" class="difflineplus">+var incomingServer;</span>
<a href="#l64.14"></a><span id="l64.14" class="difflineplus">+var pop3Service;</span>
<a href="#l64.15"></a><span id="l64.15" class="difflineplus">+const test = &quot;Server which advertises CRAM-MD5, but fails when it's tried&quot;;</span>
<a href="#l64.16"></a><span id="l64.16" class="difflineplus">+const expectedTransaction = [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH CRAM-MD5&quot;, &quot;AUTH PLAIN&quot;, &quot;STAT&quot; ];</span>
<a href="#l64.17"></a><span id="l64.17" class="difflineplus">+</span>
<a href="#l64.18"></a><span id="l64.18" class="difflineplus">+var urlListener =</span>
<a href="#l64.19"></a><span id="l64.19" class="difflineplus">+{</span>
<a href="#l64.20"></a><span id="l64.20" class="difflineplus">+  OnStartRunningUrl: function (url) {</span>
<a href="#l64.21"></a><span id="l64.21" class="difflineplus">+  },</span>
<a href="#l64.22"></a><span id="l64.22" class="difflineplus">+  OnStopRunningUrl: function (url, result) {</span>
<a href="#l64.23"></a><span id="l64.23" class="difflineplus">+    try {</span>
<a href="#l64.24"></a><span id="l64.24" class="difflineplus">+      do_check_eq(result, 0);</span>
<a href="#l64.25"></a><span id="l64.25" class="difflineplus">+</span>
<a href="#l64.26"></a><span id="l64.26" class="difflineplus">+      var transaction = server.playTransaction();</span>
<a href="#l64.27"></a><span id="l64.27" class="difflineplus">+      do_check_transaction(transaction, expectedTransaction);</span>
<a href="#l64.28"></a><span id="l64.28" class="difflineplus">+</span>
<a href="#l64.29"></a><span id="l64.29" class="difflineplus">+      do_timeout(0, checkBusy);</span>
<a href="#l64.30"></a><span id="l64.30" class="difflineplus">+    } catch (e) {</span>
<a href="#l64.31"></a><span id="l64.31" class="difflineplus">+      server.stop();</span>
<a href="#l64.32"></a><span id="l64.32" class="difflineplus">+      var thread = gThreadManager.currentThread;</span>
<a href="#l64.33"></a><span id="l64.33" class="difflineplus">+      while (thread.hasPendingEvents())</span>
<a href="#l64.34"></a><span id="l64.34" class="difflineplus">+        thread.processNextEvent(true);</span>
<a href="#l64.35"></a><span id="l64.35" class="difflineplus">+</span>
<a href="#l64.36"></a><span id="l64.36" class="difflineplus">+      do_throw(e);</span>
<a href="#l64.37"></a><span id="l64.37" class="difflineplus">+    }</span>
<a href="#l64.38"></a><span id="l64.38" class="difflineplus">+  }</span>
<a href="#l64.39"></a><span id="l64.39" class="difflineplus">+};</span>
<a href="#l64.40"></a><span id="l64.40" class="difflineplus">+</span>
<a href="#l64.41"></a><span id="l64.41" class="difflineplus">+function checkBusy() {</span>
<a href="#l64.42"></a><span id="l64.42" class="difflineplus">+  // If the server hasn't quite finished, just delay a little longer.</span>
<a href="#l64.43"></a><span id="l64.43" class="difflineplus">+  if (incomingServer.serverBusy ||</span>
<a href="#l64.44"></a><span id="l64.44" class="difflineplus">+      (incomingServer instanceof Ci.nsIPop3IncomingServer &amp;&amp;</span>
<a href="#l64.45"></a><span id="l64.45" class="difflineplus">+       incomingServer.runningProtocol)) {</span>
<a href="#l64.46"></a><span id="l64.46" class="difflineplus">+    do_timeout(20, checkBusy);</span>
<a href="#l64.47"></a><span id="l64.47" class="difflineplus">+    return;</span>
<a href="#l64.48"></a><span id="l64.48" class="difflineplus">+  }</span>
<a href="#l64.49"></a><span id="l64.49" class="difflineplus">+</span>
<a href="#l64.50"></a><span id="l64.50" class="difflineplus">+  endTest();</span>
<a href="#l64.51"></a><span id="l64.51" class="difflineplus">+}</span>
<a href="#l64.52"></a><span id="l64.52" class="difflineplus">+</span>
<a href="#l64.53"></a><span id="l64.53" class="difflineplus">+function endTest() {</span>
<a href="#l64.54"></a><span id="l64.54" class="difflineplus">+  incomingServer.closeCachedConnections();</span>
<a href="#l64.55"></a><span id="l64.55" class="difflineplus">+</span>
<a href="#l64.56"></a><span id="l64.56" class="difflineplus">+  // No more tests, let everything finish</span>
<a href="#l64.57"></a><span id="l64.57" class="difflineplus">+  server.stop();</span>
<a href="#l64.58"></a><span id="l64.58" class="difflineplus">+</span>
<a href="#l64.59"></a><span id="l64.59" class="difflineplus">+  var thread = gThreadManager.currentThread;</span>
<a href="#l64.60"></a><span id="l64.60" class="difflineplus">+  while (thread.hasPendingEvents())</span>
<a href="#l64.61"></a><span id="l64.61" class="difflineplus">+    thread.processNextEvent(true);</span>
<a href="#l64.62"></a><span id="l64.62" class="difflineplus">+</span>
<a href="#l64.63"></a><span id="l64.63" class="difflineplus">+  do_test_finished();</span>
<a href="#l64.64"></a><span id="l64.64" class="difflineplus">+}</span>
<a href="#l64.65"></a><span id="l64.65" class="difflineplus">+</span>
<a href="#l64.66"></a><span id="l64.66" class="difflineplus">+function CRAMFail_handler(daemon)</span>
<a href="#l64.67"></a><span id="l64.67" class="difflineplus">+{</span>
<a href="#l64.68"></a><span id="l64.68" class="difflineplus">+  POP3_RFC5034_handler.call(this, daemon);</span>
<a href="#l64.69"></a><span id="l64.69" class="difflineplus">+</span>
<a href="#l64.70"></a><span id="l64.70" class="difflineplus">+  this._kAuthSchemeStartFunction[&quot;CRAM-MD5&quot;] = this.killConn;</span>
<a href="#l64.71"></a><span id="l64.71" class="difflineplus">+}</span>
<a href="#l64.72"></a><span id="l64.72" class="difflineplus">+CRAMFail_handler.prototype = {</span>
<a href="#l64.73"></a><span id="l64.73" class="difflineplus">+  __proto__ : POP3_RFC5034_handler.prototype, // inherit</span>
<a href="#l64.74"></a><span id="l64.74" class="difflineplus">+</span>
<a href="#l64.75"></a><span id="l64.75" class="difflineplus">+  killConn : function()</span>
<a href="#l64.76"></a><span id="l64.76" class="difflineplus">+  {</span>
<a href="#l64.77"></a><span id="l64.77" class="difflineplus">+    this._multiline = false;</span>
<a href="#l64.78"></a><span id="l64.78" class="difflineplus">+    this._state = kStateAuthNeeded;</span>
<a href="#l64.79"></a><span id="l64.79" class="difflineplus">+    return &quot;-ERR I just pretended to implement CRAM-MD5&quot;;</span>
<a href="#l64.80"></a><span id="l64.80" class="difflineplus">+  }</span>
<a href="#l64.81"></a><span id="l64.81" class="difflineplus">+}</span>
<a href="#l64.82"></a><span id="l64.82" class="difflineplus">+</span>
<a href="#l64.83"></a><span id="l64.83" class="difflineplus">+function run_test() {</span>
<a href="#l64.84"></a><span id="l64.84" class="difflineplus">+  try {</span>
<a href="#l64.85"></a><span id="l64.85" class="difflineplus">+    do_test_pending();</span>
<a href="#l64.86"></a><span id="l64.86" class="difflineplus">+</span>
<a href="#l64.87"></a><span id="l64.87" class="difflineplus">+    // Disable new mail notifications</span>
<a href="#l64.88"></a><span id="l64.88" class="difflineplus">+    var prefSvc = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l64.89"></a><span id="l64.89" class="difflineplus">+      .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l64.90"></a><span id="l64.90" class="difflineplus">+</span>
<a href="#l64.91"></a><span id="l64.91" class="difflineplus">+    prefSvc.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l64.92"></a><span id="l64.92" class="difflineplus">+    prefSvc.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l64.93"></a><span id="l64.93" class="difflineplus">+    prefSvc.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l64.94"></a><span id="l64.94" class="difflineplus">+    prefSvc.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l64.95"></a><span id="l64.95" class="difflineplus">+</span>
<a href="#l64.96"></a><span id="l64.96" class="difflineplus">+    daemon = new pop3Daemon();</span>
<a href="#l64.97"></a><span id="l64.97" class="difflineplus">+    handler = new CRAMFail_handler(daemon);</span>
<a href="#l64.98"></a><span id="l64.98" class="difflineplus">+    server = new nsMailServer(handler);</span>
<a href="#l64.99"></a><span id="l64.99" class="difflineplus">+    server.start(POP3_PORT);</span>
<a href="#l64.100"></a><span id="l64.100" class="difflineplus">+</span>
<a href="#l64.101"></a><span id="l64.101" class="difflineplus">+    incomingServer = createPop3ServerAndLocalFolders();</span>
<a href="#l64.102"></a><span id="l64.102" class="difflineplus">+    let msgServer = incomingServer;</span>
<a href="#l64.103"></a><span id="l64.103" class="difflineplus">+    msgServer.QueryInterface(Ci.nsIMsgIncomingServer);</span>
<a href="#l64.104"></a><span id="l64.104" class="difflineplus">+    // Need to allow any auth here, although that's not use in TB really,</span>
<a href="#l64.105"></a><span id="l64.105" class="difflineplus">+    // because we need to fall back to something after CRAM-MD5 and</span>
<a href="#l64.106"></a><span id="l64.106" class="difflineplus">+    // check that login works after we fell back.</span>
<a href="#l64.107"></a><span id="l64.107" class="difflineplus">+    msgServer.authMethod = Ci.nsMsgAuthMethod.anything;</span>
<a href="#l64.108"></a><span id="l64.108" class="difflineplus">+</span>
<a href="#l64.109"></a><span id="l64.109" class="difflineplus">+    pop3Service = Cc[&quot;@mozilla.org/messenger/popservice;1&quot;]</span>
<a href="#l64.110"></a><span id="l64.110" class="difflineplus">+                        .getService(Ci.nsIPop3Service);</span>
<a href="#l64.111"></a><span id="l64.111" class="difflineplus">+    pop3Service.GetNewMail(null, urlListener, gLocalInboxFolder,</span>
<a href="#l64.112"></a><span id="l64.112" class="difflineplus">+                           incomingServer);</span>
<a href="#l64.113"></a><span id="l64.113" class="difflineplus">+    server.performTest();</span>
<a href="#l64.114"></a><span id="l64.114" class="difflineplus">+  } catch (e) {</span>
<a href="#l64.115"></a><span id="l64.115" class="difflineplus">+    server.stop();</span>
<a href="#l64.116"></a><span id="l64.116" class="difflineplus">+</span>
<a href="#l64.117"></a><span id="l64.117" class="difflineplus">+    do_throw(e);</span>
<a href="#l64.118"></a><span id="l64.118" class="difflineplus">+  } finally {</span>
<a href="#l64.119"></a><span id="l64.119" class="difflineplus">+    var thread = gThreadManager.currentThread;</span>
<a href="#l64.120"></a><span id="l64.120" class="difflineplus">+    while (thread.hasPendingEvents())</span>
<a href="#l64.121"></a><span id="l64.121" class="difflineplus">+      thread.processNextEvent(true);</span>
<a href="#l64.122"></a><span id="l64.122" class="difflineplus">+  }</span>
<a href="#l64.123"></a><span id="l64.123" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1" class="difflineminus">--- a/mailnews/mailnews.js</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineplus">+++ b/mailnews/mailnews.js</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineat">@@ -120,17 +120,16 @@ pref(&quot;mail.delete_matches_sort_order&quot;, f</span>
<a href="#l65.4"></a><span id="l65.4"> // mailnews tcp read+write timeout in seconds.</span>
<a href="#l65.5"></a><span id="l65.5"> pref(&quot;mailnews.tcptimeout&quot;, 100);</span>
<a href="#l65.6"></a><span id="l65.6"> </span>
<a href="#l65.7"></a><span id="l65.7"> pref(&quot;mailnews.headers.showSender&quot;, false);</span>
<a href="#l65.8"></a><span id="l65.8"> </span>
<a href="#l65.9"></a><span id="l65.9"> // Mail server preferences, pop by default</span>
<a href="#l65.10"></a><span id="l65.10"> // 0 pop, 1 imap; (Unix only:) 2 movemail, 3 inbox.</span>
<a href="#l65.11"></a><span id="l65.11"> pref(&quot;mail.server_type&quot;, 0);</span>
<a href="#l65.12"></a><span id="l65.12" class="difflineminus">-pref(&quot;mail.auth_login&quot;, true);</span>
<a href="#l65.13"></a><span id="l65.13"> </span>
<a href="#l65.14"></a><span id="l65.14"> pref(&quot;mail.default_drafts&quot;, &quot;&quot;);    // empty string use default Drafts name;</span>
<a href="#l65.15"></a><span id="l65.15"> pref(&quot;mail.default_templates&quot;, &quot;&quot;); // empty string use default Templates name</span>
<a href="#l65.16"></a><span id="l65.16"> </span>
<a href="#l65.17"></a><span id="l65.17"> // set to 0 if you don't want to ignore timestamp differences between</span>
<a href="#l65.18"></a><span id="l65.18"> // local mail folders and the value stored in the corresponding .msf file.</span>
<a href="#l65.19"></a><span id="l65.19"> // 0 was the default up to and including 1.5. I've made the default</span>
<a href="#l65.20"></a><span id="l65.20"> // be greater than one hour so daylight savings time changes don't affect us.</span>
<a href="#l65.21"></a><span id="l65.21" class="difflineat">@@ -226,17 +225,16 @@ pref(&quot;mail.html_compose&quot;,               </span>
<a href="#l65.22"></a><span id="l65.22"> // this will show up in the address picker in the compose window</span>
<a href="#l65.23"></a><span id="l65.23"> // examples: &quot;X-Face&quot; or &quot;Approved,X-No-Archive&quot;</span>
<a href="#l65.24"></a><span id="l65.24"> pref(&quot;mail.compose.other.header&quot;, &quot;&quot;);</span>
<a href="#l65.25"></a><span id="l65.25"> pref(&quot;mail.compose.autosave&quot;, true);</span>
<a href="#l65.26"></a><span id="l65.26"> pref(&quot;mail.compose.autosaveinterval&quot;, 5); // in minutes</span>
<a href="#l65.27"></a><span id="l65.27"> pref(&quot;mail.fcc_folder&quot;,                     &quot;&quot;);</span>
<a href="#l65.28"></a><span id="l65.28"> </span>
<a href="#l65.29"></a><span id="l65.29"> pref(&quot;mail.default_html_action&quot;, 0);          // 0=ask, 1=plain, 2=html, 3=both</span>
<a href="#l65.30"></a><span id="l65.30" class="difflineminus">-pref(&quot;mail.smtp.ssl&quot;, 0);                     // 0 = no, 1 = try, 2 = must use SSL</span>
<a href="#l65.31"></a><span id="l65.31"> </span>
<a href="#l65.32"></a><span id="l65.32"> pref(&quot;mail.mdn.report.not_in_to_cc&quot;, 2);               // 0: Never 1: Always 2: Ask me</span>
<a href="#l65.33"></a><span id="l65.33"> pref(&quot;mail.mdn.report.outside_domain&quot;, 2);             // 0: Never 1: Always 2: Ask me</span>
<a href="#l65.34"></a><span id="l65.34"> pref(&quot;mail.mdn.report.other&quot;, 2);                      // 0: Never 1: Always 2: Ask me 3: Denial</span>
<a href="#l65.35"></a><span id="l65.35"> </span>
<a href="#l65.36"></a><span id="l65.36"> pref(&quot;mail.incorporate.return_receipt&quot;, 0);            // 0: Inbox/filter 1: Sent folder</span>
<a href="#l65.37"></a><span id="l65.37"> pref(&quot;mail.request.return_receipt&quot;, 2);                // 1: DSN 2: MDN 3: Both</span>
<a href="#l65.38"></a><span id="l65.38"> pref(&quot;mail.receipt.request_header_type&quot;, 0);           // 0: MDN-DNT header  1: RRT header 2: Both (MC)</span>
<a href="#l65.39"></a><span id="l65.39" class="difflineat">@@ -456,23 +454,22 @@ pref(&quot;mail.server.default.offline_suppor</span>
<a href="#l65.40"></a><span id="l65.40"> pref(&quot;mail.server.default.leave_on_server&quot;, false);</span>
<a href="#l65.41"></a><span id="l65.41"> pref(&quot;mail.server.default.download_on_biff&quot;, false);</span>
<a href="#l65.42"></a><span id="l65.42"> pref(&quot;mail.server.default.check_time&quot;, 10);</span>
<a href="#l65.43"></a><span id="l65.43"> pref(&quot;mail.server.default.delete_by_age_from_server&quot;, false);</span>
<a href="#l65.44"></a><span id="l65.44"> pref(&quot;mail.server.default.num_days_to_leave_on_server&quot;, 7);</span>
<a href="#l65.45"></a><span id="l65.45"> pref(&quot;mail.server.default.dot_fix&quot;, true);</span>
<a href="#l65.46"></a><span id="l65.46"> pref(&quot;mail.server.default.limit_offline_message_size&quot;, false);</span>
<a href="#l65.47"></a><span id="l65.47"> pref(&quot;mail.server.default.max_size&quot;, 50);</span>
<a href="#l65.48"></a><span id="l65.48" class="difflineminus">-pref(&quot;mail.server.default.auth_login&quot;, true);</span>
<a href="#l65.49"></a><span id="l65.49"> pref(&quot;mail.server.default.delete_mail_left_on_server&quot;, false);</span>
<a href="#l65.50"></a><span id="l65.50"> pref(&quot;mail.server.default.valid&quot;, true);</span>
<a href="#l65.51"></a><span id="l65.51"> pref(&quot;mail.server.default.abbreviate&quot;, true);</span>
<a href="#l65.52"></a><span id="l65.52"> pref(&quot;mail.server.default.isSecure&quot;, false);</span>
<a href="#l65.53"></a><span id="l65.53" class="difflineminus">-pref(&quot;mail.server.default.useSecAuth&quot;, false);</span>
<a href="#l65.54"></a><span id="l65.54" class="difflineminus">-pref(&quot;mail.server.default.socketType&quot;, 0);</span>
<a href="#l65.55"></a><span id="l65.55" class="difflineplus">+pref(&quot;mail.server.default.authMethod&quot;, 3); // cleartext password. @see nsIMsgIncomingServer.authMethod.</span>
<a href="#l65.56"></a><span id="l65.56" class="difflineplus">+pref(&quot;mail.server.default.socketType&quot;, 0); // @see nsIMsgIncomingServer.socketType</span>
<a href="#l65.57"></a><span id="l65.57"> pref(&quot;mail.server.default.override_namespaces&quot;, true);</span>
<a href="#l65.58"></a><span id="l65.58"> pref(&quot;mail.server.default.deferred_to_account&quot;, &quot;&quot;);</span>
<a href="#l65.59"></a><span id="l65.59"> </span>
<a href="#l65.60"></a><span id="l65.60"> pref(&quot;mail.server.default.delete_model&quot;, 1);</span>
<a href="#l65.61"></a><span id="l65.61"> pref(&quot;mail.server.default.fetch_by_chunks&quot;, true);</span>
<a href="#l65.62"></a><span id="l65.62"> pref(&quot;mail.server.default.mime_parts_on_demand&quot;, true);</span>
<a href="#l65.63"></a><span id="l65.63"> </span>
<a href="#l65.64"></a><span id="l65.64"> pref(&quot;mail.server.default.always_authenticate&quot;, false);</span>
<a href="#l65.65"></a><span id="l65.65" class="difflineat">@@ -490,17 +487,16 @@ pref(&quot;mail.server.default.hidden&quot;, false</span>
<a href="#l65.66"></a><span id="l65.66"> </span>
<a href="#l65.67"></a><span id="l65.67"> pref(&quot;mail.server.default.using_subscription&quot;, true);</span>
<a href="#l65.68"></a><span id="l65.68"> pref(&quot;mail.server.default.dual_use_folders&quot;, true);</span>
<a href="#l65.69"></a><span id="l65.69"> pref(&quot;mail.server.default.canDelete&quot;, false);</span>
<a href="#l65.70"></a><span id="l65.70"> pref(&quot;mail.server.default.login_at_startup&quot;, false);</span>
<a href="#l65.71"></a><span id="l65.71"> pref(&quot;mail.server.default.allows_specialfolders_usage&quot;, true);</span>
<a href="#l65.72"></a><span id="l65.72"> pref(&quot;mail.server.default.canCreateFolders&quot;, true);</span>
<a href="#l65.73"></a><span id="l65.73"> pref(&quot;mail.server.default.canFileMessages&quot;, true);</span>
<a href="#l65.74"></a><span id="l65.74" class="difflineminus">-pref(&quot;mail.server.default.logon_fallback&quot;, true);</span>
<a href="#l65.75"></a><span id="l65.75"> </span>
<a href="#l65.76"></a><span id="l65.76"> // special enhancements for IMAP servers</span>
<a href="#l65.77"></a><span id="l65.77"> pref(&quot;mail.server.default.is_gmail&quot;, false);</span>
<a href="#l65.78"></a><span id="l65.78"> pref(&quot;mail.server.default.use_idle&quot;, true);</span>
<a href="#l65.79"></a><span id="l65.79"> // in case client or server has bugs in condstore implementation</span>
<a href="#l65.80"></a><span id="l65.80"> pref(&quot;mail.server.default.use_condstore&quot;, true);</span>
<a href="#l65.81"></a><span id="l65.81"> // in case client or server has bugs in compress implementation</span>
<a href="#l65.82"></a><span id="l65.82"> pref(&quot;mail.server.default.use_compress_deflate&quot;, true);</span>
<a href="#l65.83"></a><span id="l65.83" class="difflineat">@@ -561,20 +557,18 @@ pref(&quot;mail.autoComplete.highlightNonMatc</span>
<a href="#l65.84"></a><span id="l65.84"> // if true, we'll use the password from an incoming server with</span>
<a href="#l65.85"></a><span id="l65.85"> // matching username and domain</span>
<a href="#l65.86"></a><span id="l65.86"> pref(&quot;mail.smtp.useMatchingDomainServer&quot;, false);</span>
<a href="#l65.87"></a><span id="l65.87"> </span>
<a href="#l65.88"></a><span id="l65.88"> // if true, we'll use the password from an incoming server with</span>
<a href="#l65.89"></a><span id="l65.89"> // matching username and host name</span>
<a href="#l65.90"></a><span id="l65.90"> pref(&quot;mail.smtp.useMatchingHostNameServer&quot;, false);</span>
<a href="#l65.91"></a><span id="l65.91"> </span>
<a href="#l65.92"></a><span id="l65.92" class="difflineminus">-pref(&quot;mail.smtpserver.default.auth_method&quot;, 1); // auth any</span>
<a href="#l65.93"></a><span id="l65.93" class="difflineminus">-pref(&quot;mail.smtpserver.default.useSecAuth&quot;, false);</span>
<a href="#l65.94"></a><span id="l65.94" class="difflineminus">-pref(&quot;mail.smtpserver.default.trySecAuth&quot;, true);</span>
<a href="#l65.95"></a><span id="l65.95" class="difflineminus">-pref(&quot;mail.smtpserver.default.try_ssl&quot;, 0);</span>
<a href="#l65.96"></a><span id="l65.96" class="difflineplus">+pref(&quot;mail.smtpserver.default.authMethod&quot;, 3); // cleartext password. @see nsIMsgIncomingServer.authMethod.</span>
<a href="#l65.97"></a><span id="l65.97" class="difflineplus">+pref(&quot;mail.smtpserver.default.try_ssl&quot;, 0); // @see nsISmtpServer.socketType</span>
<a href="#l65.98"></a><span id="l65.98"> </span>
<a href="#l65.99"></a><span id="l65.99"> // For the next 3 prefs, see &lt;http://www.bucksch.org/1/projects/mozilla/16507&gt;</span>
<a href="#l65.100"></a><span id="l65.100"> pref(&quot;mail.display_glyph&quot;, true);   // TXT-&gt;HTML :-) etc. in viewer</span>
<a href="#l65.101"></a><span id="l65.101"> pref(&quot;mail.display_struct&quot;, true);  // TXT-&gt;HTML *bold* etc. in viewer; ditto</span>
<a href="#l65.102"></a><span id="l65.102"> pref(&quot;mail.send_struct&quot;, false);   // HTML-&gt;HTML *bold* etc. during Send; ditto</span>
<a href="#l65.103"></a><span id="l65.103"> // display time and date in message pane using senders timezone</span>
<a href="#l65.104"></a><span id="l65.104"> pref(&quot;mailnews.display.date_senders_timezone&quot;, false);</span>
<a href="#l65.105"></a><span id="l65.105"> // For the next 4 prefs, see &lt;http://www.bucksch.org/1/projects/mozilla/108153&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1" class="difflineminus">--- a/mailnews/mapi/mapihook/src/msgMapiMain.cpp</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineplus">+++ b/mailnews/mapi/mapihook/src/msgMapiMain.cpp</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineat">@@ -256,17 +256,23 @@ HRESULT nsMAPIConfiguration::GetMAPIErro</span>
<a href="#l66.4"></a><span id="l66.4">   switch (res)</span>
<a href="#l66.5"></a><span id="l66.5">   {</span>
<a href="#l66.6"></a><span id="l66.6">     case NS_MSG_NO_RECIPIENTS :</span>
<a href="#l66.7"></a><span id="l66.7">       hr = MAPI_E_BAD_RECIPTYPE;</span>
<a href="#l66.8"></a><span id="l66.8">       break;</span>
<a href="#l66.9"></a><span id="l66.9">     case NS_ERROR_COULD_NOT_GET_USERS_MAIL_ADDRESS :</span>
<a href="#l66.10"></a><span id="l66.10">       hr = MAPI_E_INVALID_RECIPS;</span>
<a href="#l66.11"></a><span id="l66.11">       break;</span>
<a href="#l66.12"></a><span id="l66.12" class="difflineminus">-    case NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER :</span>
<a href="#l66.13"></a><span id="l66.13" class="difflineplus">+    case NS_ERROR_SMTP_AUTH_FAILURE :</span>
<a href="#l66.14"></a><span id="l66.14" class="difflineplus">+    case NS_ERROR_SMTP_AUTH_GSSAPI :</span>
<a href="#l66.15"></a><span id="l66.15" class="difflineplus">+    case NS_ERROR_SMTP_AUTH_MECH_NOT_SUPPORTED :</span>
<a href="#l66.16"></a><span id="l66.16" class="difflineplus">+    case NS_ERROR_SMTP_AUTH_NOT_SUPPORTED :</span>
<a href="#l66.17"></a><span id="l66.17" class="difflineplus">+    case NS_ERROR_SMTP_AUTH_CHANGE_ENCRYPT_TO_PLAIN_NO_SSL :</span>
<a href="#l66.18"></a><span id="l66.18" class="difflineplus">+    case NS_ERROR_SMTP_AUTH_CHANGE_ENCRYPT_TO_PLAIN_SSL :</span>
<a href="#l66.19"></a><span id="l66.19" class="difflineplus">+    case NS_ERROR_SMTP_AUTH_CHANGE_PLAIN_TO_ENCRYPT :</span>
<a href="#l66.20"></a><span id="l66.20">       hr = MAPI_E_LOGIN_FAILURE;</span>
<a href="#l66.21"></a><span id="l66.21">       break;</span>
<a href="#l66.22"></a><span id="l66.22">     case NS_MSG_UNABLE_TO_OPEN_FILE :</span>
<a href="#l66.23"></a><span id="l66.23">     case NS_MSG_UNABLE_TO_OPEN_TMP_FILE :</span>
<a href="#l66.24"></a><span id="l66.24">     case NS_MSG_COULDNT_OPEN_FCC_FOLDER :</span>
<a href="#l66.25"></a><span id="l66.25">     case NS_ERROR_FILE_INVALID_PATH :</span>
<a href="#l66.26"></a><span id="l66.26">       hr = MAPI_E_ATTACHMENT_OPEN_FAILURE;</span>
<a href="#l66.27"></a><span id="l66.27">       break;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineat">@@ -425,17 +425,17 @@ NS_IMETHODIMP nsNNTPProtocol::Initialize</span>
<a href="#l67.4"></a><span id="l67.4"> </span>
<a href="#l67.5"></a><span id="l67.5">   PRInt32 port = 0;</span>
<a href="#l67.6"></a><span id="l67.6">   rv = m_url-&gt;GetPort(&amp;port);</span>
<a href="#l67.7"></a><span id="l67.7">   if (NS_FAILED(rv) || (port&lt;=0)) {</span>
<a href="#l67.8"></a><span id="l67.8">     rv = server-&gt;GetPort(&amp;port);</span>
<a href="#l67.9"></a><span id="l67.9">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l67.10"></a><span id="l67.10"> </span>
<a href="#l67.11"></a><span id="l67.11">     if (port&lt;=0) {</span>
<a href="#l67.12"></a><span id="l67.12" class="difflineminus">-      port = (socketType == nsIMsgIncomingServer::useSSL) ?</span>
<a href="#l67.13"></a><span id="l67.13" class="difflineplus">+      port = (socketType == nsMsgSocketType::SSL) ?</span>
<a href="#l67.14"></a><span id="l67.14">              nsINntpUrl::DEFAULT_NNTPS_PORT : nsINntpUrl::DEFAULT_NNTP_PORT;</span>
<a href="#l67.15"></a><span id="l67.15">     }</span>
<a href="#l67.16"></a><span id="l67.16"> </span>
<a href="#l67.17"></a><span id="l67.17">     rv = m_url-&gt;SetPort(port);</span>
<a href="#l67.18"></a><span id="l67.18">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l67.19"></a><span id="l67.19">   }</span>
<a href="#l67.20"></a><span id="l67.20"> </span>
<a href="#l67.21"></a><span id="l67.21">   NS_PRECONDITION(m_url , &quot;invalid URL passed into NNTP Protocol&quot;);</span>
<a href="#l67.22"></a><span id="l67.22" class="difflineat">@@ -495,17 +495,17 @@ NS_IMETHODIMP nsNNTPProtocol::Initialize</span>
<a href="#l67.23"></a><span id="l67.23">   }</span>
<a href="#l67.24"></a><span id="l67.24"> </span>
<a href="#l67.25"></a><span id="l67.25">   if (!m_socketIsOpen)</span>
<a href="#l67.26"></a><span id="l67.26">   {</span>
<a href="#l67.27"></a><span id="l67.27">     // When we are making a secure connection, we need to make sure that we</span>
<a href="#l67.28"></a><span id="l67.28">     // pass an interface requestor down to the socket transport so that PSM can</span>
<a href="#l67.29"></a><span id="l67.29">     // retrieve a nsIPrompt instance if needed.</span>
<a href="#l67.30"></a><span id="l67.30">     nsCOMPtr&lt;nsIInterfaceRequestor&gt; ir;</span>
<a href="#l67.31"></a><span id="l67.31" class="difflineminus">-    if (socketType != nsIMsgIncomingServer::defaultSocket &amp;&amp; aMsgWindow)</span>
<a href="#l67.32"></a><span id="l67.32" class="difflineplus">+    if (socketType != nsMsgSocketType::plain &amp;&amp; aMsgWindow)</span>
<a href="#l67.33"></a><span id="l67.33">     {</span>
<a href="#l67.34"></a><span id="l67.34">       nsCOMPtr&lt;nsIDocShell&gt; docShell;</span>
<a href="#l67.35"></a><span id="l67.35">       aMsgWindow-&gt;GetRootDocShell(getter_AddRefs(docShell));</span>
<a href="#l67.36"></a><span id="l67.36">       ir = do_QueryInterface(docShell);</span>
<a href="#l67.37"></a><span id="l67.37">     }</span>
<a href="#l67.38"></a><span id="l67.38"> </span>
<a href="#l67.39"></a><span id="l67.39">     PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) opening connection to %s on port %d&quot;,this, hostName.get(), port));</span>
<a href="#l67.40"></a><span id="l67.40">     // call base class to set up the transport</span>
<a href="#l67.41"></a><span id="l67.41" class="difflineat">@@ -517,17 +517,17 @@ NS_IMETHODIMP nsNNTPProtocol::Initialize</span>
<a href="#l67.42"></a><span id="l67.42">     rv = server-&gt;GetRealHostName(hostName);</span>
<a href="#l67.43"></a><span id="l67.43">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l67.44"></a><span id="l67.44"> </span>
<a href="#l67.45"></a><span id="l67.45">     nsCOMPtr&lt;nsIProxyInfo&gt; proxyInfo;</span>
<a href="#l67.46"></a><span id="l67.46">     rv = NS_ExamineForProxy(&quot;nntp&quot;, hostName.get(), port, getter_AddRefs(proxyInfo));</span>
<a href="#l67.47"></a><span id="l67.47">     if (NS_FAILED(rv)) proxyInfo = nsnull;</span>
<a href="#l67.48"></a><span id="l67.48"> </span>
<a href="#l67.49"></a><span id="l67.49">     rv = OpenNetworkSocketWithInfo(hostName.get(), port,</span>
<a href="#l67.50"></a><span id="l67.50" class="difflineminus">-           (socketType == nsIMsgIncomingServer::useSSL) ? &quot;ssl&quot; : nsnull,</span>
<a href="#l67.51"></a><span id="l67.51" class="difflineplus">+           (socketType == nsMsgSocketType::SSL) ? &quot;ssl&quot; : nsnull,</span>
<a href="#l67.52"></a><span id="l67.52">            proxyInfo, ir);</span>
<a href="#l67.53"></a><span id="l67.53"> </span>
<a href="#l67.54"></a><span id="l67.54">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l67.55"></a><span id="l67.55">     m_nextState = NNTP_LOGIN_RESPONSE;</span>
<a href="#l67.56"></a><span id="l67.56">   }</span>
<a href="#l67.57"></a><span id="l67.57">   else {</span>
<a href="#l67.58"></a><span id="l67.58">     m_nextState = SEND_FIRST_NNTP_COMMAND;</span>
<a href="#l67.59"></a><span id="l67.59">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l68.1"></a><span id="l68.1" class="difflineminus">--- a/mailnews/news/src/nsNewsFolder.cpp</span>
<a href="#l68.2"></a><span id="l68.2" class="difflineplus">+++ b/mailnews/news/src/nsNewsFolder.cpp</span>
<a href="#l68.3"></a><span id="l68.3" class="difflineat">@@ -463,17 +463,17 @@ NS_IMETHODIMP nsMsgNewsFolder::GetFolder</span>
<a href="#l68.4"></a><span id="l68.4"> </span>
<a href="#l68.5"></a><span id="l68.5">   PRInt32 socketType;</span>
<a href="#l68.6"></a><span id="l68.6">   rv = server-&gt;GetSocketType(&amp;socketType);</span>
<a href="#l68.7"></a><span id="l68.7">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.8"></a><span id="l68.8"> </span>
<a href="#l68.9"></a><span id="l68.9">   PRInt32 port;</span>
<a href="#l68.10"></a><span id="l68.10">   rv = server-&gt;GetPort(&amp;port);</span>
<a href="#l68.11"></a><span id="l68.11">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.12"></a><span id="l68.12" class="difflineminus">-  const char *newsScheme = (socketType == nsIMsgIncomingServer::useSSL) ?</span>
<a href="#l68.13"></a><span id="l68.13" class="difflineplus">+  const char *newsScheme = (socketType == nsMsgSocketType::SSL) ?</span>
<a href="#l68.14"></a><span id="l68.14">                            SNEWS_SCHEME : NEWS_SCHEME;</span>
<a href="#l68.15"></a><span id="l68.15">   nsCString escapedName;</span>
<a href="#l68.16"></a><span id="l68.16">   rv = NS_MsgEscapeEncodeURLPath(groupName, escapedName);</span>
<a href="#l68.17"></a><span id="l68.17">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.18"></a><span id="l68.18">   nsCString tmpStr;</span>
<a href="#l68.19"></a><span id="l68.19">   tmpStr.Adopt(PR_smprintf(&quot;%s//%s:%ld/%s&quot;, newsScheme, hostName.get(), port,</span>
<a href="#l68.20"></a><span id="l68.20">                            escapedName.get()));</span>
<a href="#l68.21"></a><span id="l68.21">   aUrl.Assign(tmpStr);</span>
<a href="#l68.22"></a><span id="l68.22" class="difflineat">@@ -1128,17 +1128,17 @@ nsresult nsMsgNewsFolder::CreateNewsgrou</span>
<a href="#l68.23"></a><span id="l68.23"> </span>
<a href="#l68.24"></a><span id="l68.24">     PRInt32 socketType;</span>
<a href="#l68.25"></a><span id="l68.25">     nsresult rv = server-&gt;GetSocketType(&amp;socketType);</span>
<a href="#l68.26"></a><span id="l68.26">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.27"></a><span id="l68.27"> </span>
<a href="#l68.28"></a><span id="l68.28">     // Only set this for ssl newsgroups as for non-ssl connections, we don't</span>
<a href="#l68.29"></a><span id="l68.29">     // need to specify the port as it is the default for the protocol and</span>
<a href="#l68.30"></a><span id="l68.30">     // password manager &quot;blanks&quot; those out.</span>
<a href="#l68.31"></a><span id="l68.31" class="difflineminus">-    if (socketType == nsIMsgIncomingServer::useSSL)</span>
<a href="#l68.32"></a><span id="l68.32" class="difflineplus">+    if (socketType == nsMsgSocketType::SSL)</span>
<a href="#l68.33"></a><span id="l68.33">     {</span>
<a href="#l68.34"></a><span id="l68.34">       rv = url-&gt;SetPort(nsINntpUrl::DEFAULT_NNTPS_PORT);</span>
<a href="#l68.35"></a><span id="l68.35">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l68.36"></a><span id="l68.36">     }</span>
<a href="#l68.37"></a><span id="l68.37">   }</span>
<a href="#l68.38"></a><span id="l68.38"> </span>
<a href="#l68.39"></a><span id="l68.39">   if (ref)</span>
<a href="#l68.40"></a><span id="l68.40">   {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l69.1"></a><span id="l69.1" class="difflineminus">--- a/mailnews/news/src/nsNntpIncomingServer.cpp</span>
<a href="#l69.2"></a><span id="l69.2" class="difflineplus">+++ b/mailnews/news/src/nsNntpIncomingServer.cpp</span>
<a href="#l69.3"></a><span id="l69.3" class="difflineat">@@ -2086,32 +2086,32 @@ nsNntpIncomingServer::GetSocketType(PRIn</span>
<a href="#l69.4"></a><span id="l69.4"> </span>
<a href="#l69.5"></a><span id="l69.5">   nsresult rv = mPrefBranch-&gt;GetIntPref(&quot;socketType&quot;, aSocketType);</span>
<a href="#l69.6"></a><span id="l69.6">   if (NS_FAILED(rv))</span>
<a href="#l69.7"></a><span id="l69.7">   {</span>
<a href="#l69.8"></a><span id="l69.8">     if (!mDefPrefBranch)</span>
<a href="#l69.9"></a><span id="l69.9">       return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l69.10"></a><span id="l69.10">     rv = mDefPrefBranch-&gt;GetIntPref(&quot;socketType&quot;, aSocketType);</span>
<a href="#l69.11"></a><span id="l69.11">     if (NS_FAILED(rv))</span>
<a href="#l69.12"></a><span id="l69.12" class="difflineminus">-      *aSocketType = nsIMsgIncomingServer::defaultSocket;</span>
<a href="#l69.13"></a><span id="l69.13" class="difflineplus">+      *aSocketType = nsMsgSocketType::plain;</span>
<a href="#l69.14"></a><span id="l69.14">   }</span>
<a href="#l69.15"></a><span id="l69.15"> </span>
<a href="#l69.16"></a><span id="l69.16">   // nsMsgIncomingServer::GetSocketType migrates old isSecure to socketType</span>
<a href="#l69.17"></a><span id="l69.17">   // style for mail. Unfortunately, a bug caused news socketType 0 to be stored</span>
<a href="#l69.18"></a><span id="l69.18">   // in the prefs even for isSecure true, so the migration wouldn't happen :(</span>
<a href="#l69.19"></a><span id="l69.19"> </span>
<a href="#l69.20"></a><span id="l69.20">   // Now that we know the socket, make sure isSecure true + socketType 0</span>
<a href="#l69.21"></a><span id="l69.21">   // doesn't mix. Migrate if that's the case here.</span>
<a href="#l69.22"></a><span id="l69.22" class="difflineminus">-  if (*aSocketType == nsIMsgIncomingServer::defaultSocket)</span>
<a href="#l69.23"></a><span id="l69.23" class="difflineplus">+  if (*aSocketType == nsMsgSocketType::plain)</span>
<a href="#l69.24"></a><span id="l69.24">   {</span>
<a href="#l69.25"></a><span id="l69.25">     PRBool isSecure = PR_FALSE;</span>
<a href="#l69.26"></a><span id="l69.26">     nsresult rv2 = mPrefBranch-&gt;GetBoolPref(&quot;isSecure&quot;, &amp;isSecure);</span>
<a href="#l69.27"></a><span id="l69.27">     if (NS_SUCCEEDED(rv2) &amp;&amp; isSecure)</span>
<a href="#l69.28"></a><span id="l69.28">     {</span>
<a href="#l69.29"></a><span id="l69.29" class="difflineminus">-      *aSocketType = nsIMsgIncomingServer::useSSL;</span>
<a href="#l69.30"></a><span id="l69.30" class="difflineplus">+      *aSocketType = nsMsgSocketType::SSL;</span>
<a href="#l69.31"></a><span id="l69.31">       // Don't call virtual method in case overrides call GetSocketType.</span>
<a href="#l69.32"></a><span id="l69.32">       nsMsgIncomingServer::SetSocketType(*aSocketType);</span>
<a href="#l69.33"></a><span id="l69.33">     }</span>
<a href="#l69.34"></a><span id="l69.34">   }</span>
<a href="#l69.35"></a><span id="l69.35">   return rv;</span>
<a href="#l69.36"></a><span id="l69.36"> }</span>
<a href="#l69.37"></a><span id="l69.37"> </span>
<a href="#l69.38"></a><span id="l69.38"> NS_IMETHODIMP</span>
<a href="#l69.39"></a><span id="l69.39" class="difflineat">@@ -2122,17 +2122,17 @@ nsNntpIncomingServer::SetSocketType(PRIn</span>
<a href="#l69.40"></a><span id="l69.40">   nsresult rv = nsMsgIncomingServer::SetSocketType(aSocketType);</span>
<a href="#l69.41"></a><span id="l69.41">   if (NS_SUCCEEDED(rv))</span>
<a href="#l69.42"></a><span id="l69.42">   {</span>
<a href="#l69.43"></a><span id="l69.43">     PRBool isSecure = PR_FALSE;</span>
<a href="#l69.44"></a><span id="l69.44">     if (NS_SUCCEEDED(mPrefBranch-&gt;GetBoolPref(&quot;isSecure&quot;, &amp;isSecure)))</span>
<a href="#l69.45"></a><span id="l69.45">     {</span>
<a href="#l69.46"></a><span id="l69.46">       // Must keep isSecure in sync since we migrate based on it... if it's set.</span>
<a href="#l69.47"></a><span id="l69.47">       rv = mPrefBranch-&gt;SetBoolPref(&quot;isSecure&quot;,</span>
<a href="#l69.48"></a><span id="l69.48" class="difflineminus">-                                    aSocketType == nsIMsgIncomingServer::useSSL);</span>
<a href="#l69.49"></a><span id="l69.49" class="difflineplus">+                                    aSocketType == nsMsgSocketType::SSL);</span>
<a href="#l69.50"></a><span id="l69.50">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l69.51"></a><span id="l69.51">     }</span>
<a href="#l69.52"></a><span id="l69.52">   }</span>
<a href="#l69.53"></a><span id="l69.53">   return rv;</span>
<a href="#l69.54"></a><span id="l69.54"> }</span>
<a href="#l69.55"></a><span id="l69.55"> </span>
<a href="#l69.56"></a><span id="l69.56"> NS_IMETHODIMP</span>
<a href="#l69.57"></a><span id="l69.57"> nsNntpIncomingServer::OnUserOrHostNameChanged(const nsACString&amp; oldName, const nsACString&amp; newName)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l70.1"></a><span id="l70.1" class="difflineminus">--- a/mailnews/news/src/nsNntpService.cpp</span>
<a href="#l70.2"></a><span id="l70.2" class="difflineplus">+++ b/mailnews/news/src/nsNntpService.cpp</span>
<a href="#l70.3"></a><span id="l70.3" class="difflineat">@@ -302,17 +302,17 @@ nsNntpService::DisplayMessage(const char</span>
<a href="#l70.4"></a><span id="l70.4">     {</span>
<a href="#l70.5"></a><span id="l70.5">       rv = server-&gt;GetPort(&amp;port);</span>
<a href="#l70.6"></a><span id="l70.6">       if (NS_FAILED(rv) || (port &lt;= 0))</span>
<a href="#l70.7"></a><span id="l70.7">       {</span>
<a href="#l70.8"></a><span id="l70.8">         PRInt32 socketType;</span>
<a href="#l70.9"></a><span id="l70.9">         rv = server-&gt;GetSocketType(&amp;socketType);</span>
<a href="#l70.10"></a><span id="l70.10">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l70.11"></a><span id="l70.11"> </span>
<a href="#l70.12"></a><span id="l70.12" class="difflineminus">-        port = (socketType == nsIMsgIncomingServer::useSSL) ?</span>
<a href="#l70.13"></a><span id="l70.13" class="difflineplus">+        port = (socketType == nsMsgSocketType::SSL) ?</span>
<a href="#l70.14"></a><span id="l70.14">                nsINntpUrl::DEFAULT_NNTPS_PORT : nsINntpUrl::DEFAULT_NNTP_PORT;</span>
<a href="#l70.15"></a><span id="l70.15">       }</span>
<a href="#l70.16"></a><span id="l70.16"> </span>
<a href="#l70.17"></a><span id="l70.17">       rv = url-&gt;SetPort(port);</span>
<a href="#l70.18"></a><span id="l70.18">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l70.19"></a><span id="l70.19">     }</span>
<a href="#l70.20"></a><span id="l70.20"> </span>
<a href="#l70.21"></a><span id="l70.21">     folder-&gt;ShouldStoreMsgOffline(key, &amp;shouldStoreMsgOffline);</span>
<a href="#l70.22"></a><span id="l70.22" class="difflineat">@@ -1058,17 +1058,17 @@ nsNntpService::CreateNewsAccount(const c</span>
<a href="#l70.23"></a><span id="l70.23">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l70.24"></a><span id="l70.24"> </span>
<a href="#l70.25"></a><span id="l70.25">   // for news, username is always null</span>
<a href="#l70.26"></a><span id="l70.26">   rv = accountManager-&gt;CreateIncomingServer(EmptyCString(), nsDependentCString(aHostname), NS_LITERAL_CSTRING(&quot;nntp&quot;), aServer);</span>
<a href="#l70.27"></a><span id="l70.27">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l70.28"></a><span id="l70.28"> </span>
<a href="#l70.29"></a><span id="l70.29">   if (aUseSSL)</span>
<a href="#l70.30"></a><span id="l70.30">   {</span>
<a href="#l70.31"></a><span id="l70.31" class="difflineminus">-    rv = (*aServer)-&gt;SetSocketType(nsIMsgIncomingServer::useSSL);</span>
<a href="#l70.32"></a><span id="l70.32" class="difflineplus">+    rv = (*aServer)-&gt;SetSocketType(nsMsgSocketType::SSL);</span>
<a href="#l70.33"></a><span id="l70.33">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l70.34"></a><span id="l70.34">   }</span>
<a href="#l70.35"></a><span id="l70.35"> </span>
<a href="#l70.36"></a><span id="l70.36">   rv = (*aServer)-&gt;SetPort(aPort);</span>
<a href="#l70.37"></a><span id="l70.37">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l70.38"></a><span id="l70.38"> </span>
<a href="#l70.39"></a><span id="l70.39">   nsCOMPtr &lt;nsIMsgIdentity&gt; identity;</span>
<a href="#l70.40"></a><span id="l70.40">   rv = accountManager-&gt;CreateIdentity(getter_AddRefs(identity));</span>
<a href="#l70.41"></a><span id="l70.41" class="difflineat">@@ -1602,17 +1602,17 @@ nsNntpService::StreamMessage(const char </span>
<a href="#l70.42"></a><span id="l70.42">         nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l70.43"></a><span id="l70.43">         rv = folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l70.44"></a><span id="l70.44">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l70.45"></a><span id="l70.45"> </span>
<a href="#l70.46"></a><span id="l70.46">         PRInt32 socketType;</span>
<a href="#l70.47"></a><span id="l70.47">         rv = server-&gt;GetSocketType(&amp;socketType);</span>
<a href="#l70.48"></a><span id="l70.48">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l70.49"></a><span id="l70.49"> </span>
<a href="#l70.50"></a><span id="l70.50" class="difflineminus">-        url-&gt;SetPort((socketType == nsIMsgIncomingServer::useSSL) ?</span>
<a href="#l70.51"></a><span id="l70.51" class="difflineplus">+        url-&gt;SetPort((socketType == nsMsgSocketType::SSL) ?</span>
<a href="#l70.52"></a><span id="l70.52">                      nsINntpUrl::DEFAULT_NNTPS_PORT : nsINntpUrl::DEFAULT_NNTP_PORT);</span>
<a href="#l70.53"></a><span id="l70.53"> </span>
<a href="#l70.54"></a><span id="l70.54">         rv = IsMsgInMemCache(url, folder, nsnull, &amp;hasMsgOffline);</span>
<a href="#l70.55"></a><span id="l70.55">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l70.56"></a><span id="l70.56">       }</span>
<a href="#l70.57"></a><span id="l70.57"> </span>
<a href="#l70.58"></a><span id="l70.58">       // Return with an error if we didn't find it in the memory cache either</span>
<a href="#l70.59"></a><span id="l70.59">       if (!hasMsgOffline)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l71.1"></a><span id="l71.1" class="difflineminus">--- a/suite/common/src/nsSuiteGlue.js</span>
<a href="#l71.2"></a><span id="l71.2" class="difflineplus">+++ b/suite/common/src/nsSuiteGlue.js</span>
<a href="#l71.3"></a><span id="l71.3" class="difflineat">@@ -38,16 +38,17 @@</span>
<a href="#l71.4"></a><span id="l71.4">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l71.5"></a><span id="l71.5">  *</span>
<a href="#l71.6"></a><span id="l71.6">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l71.7"></a><span id="l71.7"> </span>
<a href="#l71.8"></a><span id="l71.8"> const XULNS = &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;;</span>
<a href="#l71.9"></a><span id="l71.9"> </span>
<a href="#l71.10"></a><span id="l71.10"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l71.11"></a><span id="l71.11"> Components.utils.import(&quot;resource://app/modules/Sanitizer.jsm&quot;);</span>
<a href="#l71.12"></a><span id="l71.12" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/migration.jsm&quot;);</span>
<a href="#l71.13"></a><span id="l71.13"> </span>
<a href="#l71.14"></a><span id="l71.14"> // Constructor</span>
<a href="#l71.15"></a><span id="l71.15"> </span>
<a href="#l71.16"></a><span id="l71.16"> function SuiteGlue() {</span>
<a href="#l71.17"></a><span id="l71.17">   this._init();</span>
<a href="#l71.18"></a><span id="l71.18"> }</span>
<a href="#l71.19"></a><span id="l71.19"> </span>
<a href="#l71.20"></a><span id="l71.20"> SuiteGlue.prototype = {</span>
<a href="#l71.21"></a><span id="l71.21" class="difflineat">@@ -153,16 +154,17 @@ SuiteGlue.prototype = {</span>
<a href="#l71.22"></a><span id="l71.22">     osvr.removeObserver(this, &quot;session-save&quot;);</span>
<a href="#l71.23"></a><span id="l71.23">     osvr.removeObserver(this, &quot;dl-done&quot;);</span>
<a href="#l71.24"></a><span id="l71.24">   },</span>
<a href="#l71.25"></a><span id="l71.25"> </span>
<a href="#l71.26"></a><span id="l71.26">   // profile startup handler (contains profile initialization routines)</span>
<a href="#l71.27"></a><span id="l71.27">   _onProfileStartup: function()</span>
<a href="#l71.28"></a><span id="l71.28">   {</span>
<a href="#l71.29"></a><span id="l71.29">     this._updatePrefs();</span>
<a href="#l71.30"></a><span id="l71.30" class="difflineplus">+    migrateMailnews(); // migration.jsm</span>
<a href="#l71.31"></a><span id="l71.31"> </span>
<a href="#l71.32"></a><span id="l71.32">     Sanitizer.checkAndSanitize();</span>
<a href="#l71.33"></a><span id="l71.33"> </span>
<a href="#l71.34"></a><span id="l71.34">     const prefSvc = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l71.35"></a><span id="l71.35">                               .getService(Components.interfaces.nsIPrefBranch2);</span>
<a href="#l71.36"></a><span id="l71.36">     if (prefSvc.prefHasUserValue(&quot;privacy.sanitize.didShutdownSanitize&quot;)) {</span>
<a href="#l71.37"></a><span id="l71.37">       prefSvc.clearUserPref(&quot;privacy.sanitize.didShutdownSanitize&quot;);</span>
<a href="#l71.38"></a><span id="l71.38">       // We need to persist this preference change, since we want to</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l72.1"></a><span id="l72.1" class="difflineminus">--- a/suite/locales/en-US/chrome/mailnews/compose/composeMsgs.properties</span>
<a href="#l72.2"></a><span id="l72.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/mailnews/compose/composeMsgs.properties</span>
<a href="#l72.3"></a><span id="l72.3" class="difflineat">@@ -203,31 +203,31 @@ 12570=There was an error attaching %S. P</span>
<a href="#l72.4"></a><span id="l72.4"> 12571=There was an error copying the message to the Sent folder. Retry?</span>
<a href="#l72.5"></a><span id="l72.5"> </span>
<a href="#l72.6"></a><span id="l72.6"> ## @name NS_ERROR_SMTP_GREETING</span>
<a href="#l72.7"></a><span id="l72.7"> 12572=An error occurred sending mail: The mail server sent an incorrect greeting:  %s.</span>
<a href="#l72.8"></a><span id="l72.8"> </span>
<a href="#l72.9"></a><span id="l72.9"> ## @name NS_ERROR_SENDING_RCPT_COMMAND</span>
<a href="#l72.10"></a><span id="l72.10"> 12575=An error occurred while sending mail. The mail server responded:  %1$s. Please check the message recipient %2$s and try again.</span>
<a href="#l72.11"></a><span id="l72.11"> </span>
<a href="#l72.12"></a><span id="l72.12" class="difflineminus">-## @name NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER_INSECAUTH</span>
<a href="#l72.13"></a><span id="l72.13" class="difflineminus">-12579=An error occurred sending mail: Unable to authenticate to SMTP server %S. The server does not support any compatible insecure authentication mechanism but you have chosen insecure authentication. Try switching on secure authentication or contact your service provider.</span>
<a href="#l72.14"></a><span id="l72.14" class="difflineplus">+## @name NS_ERROR_SMTP_AUTH_FAILURE</span>
<a href="#l72.15"></a><span id="l72.15" class="difflineplus">+12576=Unable to authenticate to SMTP server %S. Please check the password, and verify the 'Authentication method' in 'Account Settings | Outgoing server (SMTP)'.</span>
<a href="#l72.16"></a><span id="l72.16" class="difflineplus">+</span>
<a href="#l72.17"></a><span id="l72.17" class="difflineplus">+## @name NS_ERROR_SMTP_AUTH_GSSAPI</span>
<a href="#l72.18"></a><span id="l72.18" class="difflineplus">+12579=The Kerberos/GSSAPI ticket was not accepted by the SMTP server %S. Please check that you are logged in to the Kerberos/GSSAPI realm.</span>
<a href="#l72.19"></a><span id="l72.19"> </span>
<a href="#l72.20"></a><span id="l72.20" class="difflineminus">-## @name NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER_SECAUTH</span>
<a href="#l72.21"></a><span id="l72.21" class="difflineminus">-12580=An error occurred sending mail: Unable to authenticate to SMTP server %S. The server does not support any compatible secure authentication mechanism but you have chosen secure authentication. Try switching off secure authentication or contact your service provider.</span>
<a href="#l72.22"></a><span id="l72.22" class="difflineplus">+## @name NS_ERROR_SMTP_AUTH_MECH_NOT_SUPPORTED</span>
<a href="#l72.23"></a><span id="l72.23" class="difflineplus">+12580=The SMTP server %S does not support the selected authentication method. Please change the 'Authentication method' in the 'Account Settings | Outgoing Server (SMTP)'.</span>
<a href="#l72.24"></a><span id="l72.24"> </span>
<a href="#l72.25"></a><span id="l72.25" class="difflineminus">-## @name NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER_AUTH_NONE</span>
<a href="#l72.26"></a><span id="l72.26" class="difflineminus">-12581=An error occurred sending mail: Unable to authenticate to SMTP server %S. It does not support authentication (SMTP-AUTH) but you have chosen to use authentication. Uncheck 'Use name and password' for that server or contact your service provider.</span>
<a href="#l72.27"></a><span id="l72.27" class="difflineplus">+## @name NS_ERROR_SMTP_AUTH_NOT_SUPPORTED</span>
<a href="#l72.28"></a><span id="l72.28" class="difflineplus">+12581=Unable to authenticate to SMTP server %S. It does not support authentication (SMTP-AUTH) but you have chosen to use authentication. Please change the 'Authentication method' to 'None' in the 'Account Settings | Outgoing Server (SMTP)' or contact your email service provider for instructions.</span>
<a href="#l72.29"></a><span id="l72.29"> </span>
<a href="#l72.30"></a><span id="l72.30"> ## @name NS_ERROR_STARTTLS_FAILED_EHLO_STARTTLS</span>
<a href="#l72.31"></a><span id="l72.31"> 12582=An error occurred sending mail: Unable to establish a secure link with SMTP server %S using STARTTLS since it doesn't advertise that feature. Switch off STARTTLS for that server or contact your service provider.</span>
<a href="#l72.32"></a><span id="l72.32"> </span>
<a href="#l72.33"></a><span id="l72.33" class="difflineminus">-## @name NS_ERROR_COULD_NOT_LOGIN_TO_SMTP_SERVER</span>
<a href="#l72.34"></a><span id="l72.34" class="difflineminus">-12583=An error occurred sending mail: Unable to log in to SMTP server %S. The server may be incorrectly configured. Please verify that your SMTP server settings are correct and try again.</span>
<a href="#l72.35"></a><span id="l72.35" class="difflineminus">-</span>
<a href="#l72.36"></a><span id="l72.36"> ## @name NS_ERROR_SMTP_PASSWORD_UNDEFINED</span>
<a href="#l72.37"></a><span id="l72.37"> 12584=An error occurred sending mail: Could not get password for %S. The message was not sent.</span>
<a href="#l72.38"></a><span id="l72.38"> </span>
<a href="#l72.39"></a><span id="l72.39"> ## @name NS_ERROR_SMTP_TEMP_SIZE_EXCEEDED</span>
<a href="#l72.40"></a><span id="l72.40"> 12586=The size of the message you are trying to send exceeds a temporary size limit of the server. The message was not sent; try to reduce the message size or wait some time and try again. The server responded:  %s.</span>
<a href="#l72.41"></a><span id="l72.41"> </span>
<a href="#l72.42"></a><span id="l72.42"> ## @name NS_ERROR_SMTP_PERM_SIZE_EXCEEDED_1</span>
<a href="#l72.43"></a><span id="l72.43"> 12587=The size of the message you are trying to send exceeds the global size limit (%d bytes) of the server. The message was not sent; reduce the message size and try again.</span>
<a href="#l72.44"></a><span id="l72.44" class="difflineat">@@ -245,16 +245,26 @@ 12590=The message could not be sent beca</span>
<a href="#l72.45"></a><span id="l72.45"> 12591=The message could not be sent because the connection to SMTP server %S was lost in the middle of the transaction. Try again or contact your network administrator.</span>
<a href="#l72.46"></a><span id="l72.46"> </span>
<a href="#l72.47"></a><span id="l72.47"> ## @name NS_ERROR_SMTP_SEND_FAILED_TIMEOUT</span>
<a href="#l72.48"></a><span id="l72.48"> 12592=The message could not be sent because the connection to SMTP server %S timed out. Try again or contact your network administrator.</span>
<a href="#l72.49"></a><span id="l72.49"> </span>
<a href="#l72.50"></a><span id="l72.50"> ## @name NS_ERROR_SMTP_SEND_FAILED_UNKNOWN_REASON</span>
<a href="#l72.51"></a><span id="l72.51"> 12593=The message could not be sent using SMTP server %S for an unknown reason. Please verify that your SMTP server settings are correct and try again, or contact your network administrator.</span>
<a href="#l72.52"></a><span id="l72.52"> </span>
<a href="#l72.53"></a><span id="l72.53" class="difflineplus">+## @name NS_ERROR_SMTP_AUTH_CHANGE_ENCRYPT_TO_PLAIN_NO_SSL</span>
<a href="#l72.54"></a><span id="l72.54" class="difflineplus">+12594=The SMTP server %S does not seem to support encrypted passwords. If you just set up the account, please try changing to 'Password, transmitted insecurely' as the 'Authentication method' in the 'Account Settings | Server settings'. If it used to work and now suddenly fails, this is a common scenario how someone could steal your password.</span>
<a href="#l72.55"></a><span id="l72.55" class="difflineplus">+</span>
<a href="#l72.56"></a><span id="l72.56" class="difflineplus">+## @name NS_ERROR_SMTP_AUTH_CHANGE_ENCRYPT_TO_PLAIN_SSL</span>
<a href="#l72.57"></a><span id="l72.57" class="difflineplus">+12595=The SMTP server %S does not seem to support encrypted passwords. If you just set up this account, please try changing to 'Normal password' as the 'Authentication method' in the 'Account Settings | Server settings'. If it used to work and now suddenly fails, please contact your email administrator or provider.</span>
<a href="#l72.58"></a><span id="l72.58" class="difflineplus">+</span>
<a href="#l72.59"></a><span id="l72.59" class="difflineplus">+## @name NS_ERROR_SMTP_AUTH_CHANGE_PLAIN_TO_ENCRYPT</span>
<a href="#l72.60"></a><span id="l72.60" class="difflineplus">+12596=The SMTP server %S does not allow plaintext passwords. Please try changing to 'Encrypted password' as the 'Authentication method' in the 'Account Settings | Server settings'.</span>
<a href="#l72.61"></a><span id="l72.61" class="difflineplus">+</span>
<a href="#l72.62"></a><span id="l72.62" class="difflineplus">+</span>
<a href="#l72.63"></a><span id="l72.63"> ## Strings use for the save message dialog shown when the user close a message compose window</span>
<a href="#l72.64"></a><span id="l72.64"> saveDlogTitle=Save Message</span>
<a href="#l72.65"></a><span id="l72.65"> saveDlogMessage=Message has not been sent. Do you want to save the message in the Drafts folder?</span>
<a href="#l72.66"></a><span id="l72.66"> </span>
<a href="#l72.67"></a><span id="l72.67"> ## generics string</span>
<a href="#l72.68"></a><span id="l72.68"> defaultSubject=(no subject)</span>
<a href="#l72.69"></a><span id="l72.69"> chooseFileToAttach=Attach File(s)</span>
<a href="#l72.70"></a><span id="l72.70"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l73.1"></a><span id="l73.1" class="difflineminus">--- a/suite/locales/en-US/chrome/mailnews/imapMsgs.properties</span>
<a href="#l73.2"></a><span id="l73.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/mailnews/imapMsgs.properties</span>
<a href="#l73.3"></a><span id="l73.3" class="difflineat">@@ -119,17 +119,17 @@ 5012=Checking mail server capabilities…</span>
<a href="#l73.4"></a><span id="l73.4"> # Status - logging on</span>
<a href="#l73.5"></a><span id="l73.5"> ## @name IMAP_STATUS_SENDING_LOGIN</span>
<a href="#l73.6"></a><span id="l73.6"> ## @loc None</span>
<a href="#l73.7"></a><span id="l73.7"> 5013=Sending login information…</span>
<a href="#l73.8"></a><span id="l73.8"> </span>
<a href="#l73.9"></a><span id="l73.9"> # Status - auth logon</span>
<a href="#l73.10"></a><span id="l73.10"> ## @name IMAP_STATUS_SENDING_AUTH_LOGIN</span>
<a href="#l73.11"></a><span id="l73.11"> ## @loc None</span>
<a href="#l73.12"></a><span id="l73.12" class="difflineminus">-5014=Sending secure login information…</span>
<a href="#l73.13"></a><span id="l73.13" class="difflineplus">+5014=Sending login information…</span>
<a href="#l73.14"></a><span id="l73.14"> </span>
<a href="#l73.15"></a><span id="l73.15"> ## @name IMAP_DOWNLOADING_MESSAGE</span>
<a href="#l73.16"></a><span id="l73.16"> ## @loc None</span>
<a href="#l73.17"></a><span id="l73.17"> 5015=Downloading message…</span>
<a href="#l73.18"></a><span id="l73.18"> </span>
<a href="#l73.19"></a><span id="l73.19"> ## @name IMAP_GETTING_ACL_FOR_FOLDER</span>
<a href="#l73.20"></a><span id="l73.20"> ## @loc None</span>
<a href="#l73.21"></a><span id="l73.21"> # LOCALIZATION NOTE (Error 5029): Do not translate the word &quot;ACL&quot; below.</span>
<a href="#l73.22"></a><span id="l73.22" class="difflineat">@@ -360,28 +360,39 @@ 5096=This server does not support quotas</span>
<a href="#l73.23"></a><span id="l73.23"> ## @loc None</span>
<a href="#l73.24"></a><span id="l73.24"> 5097=There are no storage quotas on this folder.</span>
<a href="#l73.25"></a><span id="l73.25"> </span>
<a href="#l73.26"></a><span id="l73.26"> # Out of memory</span>
<a href="#l73.27"></a><span id="l73.27"> ## @name IMAP_OUT_OF_MEMORY</span>
<a href="#l73.28"></a><span id="l73.28"> ## @loc None</span>
<a href="#l73.29"></a><span id="l73.29"> 5100=Application is out of memory.</span>
<a href="#l73.30"></a><span id="l73.30"> </span>
<a href="#l73.31"></a><span id="l73.31" class="difflineminus">-## @name IMAP_AUTH_SECURE_NOTSUPPORTED</span>
<a href="#l73.32"></a><span id="l73.32" class="difflineplus">+## @name IMAP_AUTH_MECH_NOT_SUPPORTED</span>
<a href="#l73.33"></a><span id="l73.33"> ## @loc None</span>
<a href="#l73.34"></a><span id="l73.34" class="difflineminus">-5102=You cannot log in to %S because you have enabled secure authentication and this server does not support it.\n\nTo log in, turn off secure authentication for this account.</span>
<a href="#l73.35"></a><span id="l73.35" class="difflineplus">+# LOCALIZATION NOTE (5101): %S is the server hostname</span>
<a href="#l73.36"></a><span id="l73.36" class="difflineplus">+5101=The IMAP server %S does not support the selected authentication method. Please change the 'Authentication method' in the 'Account Settings | Server settings'.</span>
<a href="#l73.37"></a><span id="l73.37" class="difflineplus">+</span>
<a href="#l73.38"></a><span id="l73.38" class="difflineplus">+## @name IMAP_AUTH_MECH_FAILED</span>
<a href="#l73.39"></a><span id="l73.39" class="difflineplus">+## @loc None</span>
<a href="#l73.40"></a><span id="l73.40" class="difflineplus">+# LOCALIZATION NOTE (5102): %S is the server hostname</span>
<a href="#l73.41"></a><span id="l73.41" class="difflineplus">+5102=All login mechanisms for %S failed. Please check the password or change the 'Authentication method' in the 'Account Settings | Server settings'.</span>
<a href="#l73.42"></a><span id="l73.42"> </span>
<a href="#l73.43"></a><span id="l73.43"> ## @name IMAP_COPYING_MESSAGE_OF</span>
<a href="#l73.44"></a><span id="l73.44"> ## @loc None</span>
<a href="#l73.45"></a><span id="l73.45"> # LOCALIZATION NOTE (Error 5103): Do not translate the word &quot;%S&quot; below.</span>
<a href="#l73.46"></a><span id="l73.46"> # Place the word %3$S in your translation where the name of the destination folder should appear.</span>
<a href="#l73.47"></a><span id="l73.47"> # Place the word %1$S where the currently copying message should appear.</span>
<a href="#l73.48"></a><span id="l73.48"> # Place the word %2$S where the total number of messages should appear.</span>
<a href="#l73.49"></a><span id="l73.49"> 5103=Copying Message %1$S of %2$S to %3$S</span>
<a href="#l73.50"></a><span id="l73.50"> </span>
<a href="#l73.51"></a><span id="l73.51" class="difflineplus">+## @name IMAP_AUTH_GSSAPI_FAILED</span>
<a href="#l73.52"></a><span id="l73.52" class="difflineplus">+## @loc None</span>
<a href="#l73.53"></a><span id="l73.53" class="difflineplus">+# LOCALIZATION NOTE (5104): %S is the server hostname</span>
<a href="#l73.54"></a><span id="l73.54" class="difflineplus">+5104=The Kerberos/GSSAPI ticket was not accepted by the IMAP server %S. Please check that you are logged in to the Kerberos/GSSAPI realm.</span>
<a href="#l73.55"></a><span id="l73.55" class="difflineplus">+</span>
<a href="#l73.56"></a><span id="l73.56"> ## @name IMAP_MOVE_FOLDER_TO_TRASH</span>
<a href="#l73.57"></a><span id="l73.57"> ## @loc None</span>
<a href="#l73.58"></a><span id="l73.58"> # LOCALIZATION NOTE (5105): Do not translate the word %S below.</span>
<a href="#l73.59"></a><span id="l73.59"> # &quot;%S&quot; is the name of the folder.</span>
<a href="#l73.60"></a><span id="l73.60"> 5105=Are you sure you want to delete the folder '%S'?</span>
<a href="#l73.61"></a><span id="l73.61"> </span>
<a href="#l73.62"></a><span id="l73.62"> ## @name IMAP_DELETE_NO_TRASH</span>
<a href="#l73.63"></a><span id="l73.63"> ## @loc None</span>
<a href="#l73.64"></a><span id="l73.64" class="difflineat">@@ -392,12 +403,22 @@ 5106=Deleting this folder is not undoabl</span>
<a href="#l73.65"></a><span id="l73.65"> ## @name IMAP_DELETE_FOLDER_DIALOG_TITLE</span>
<a href="#l73.66"></a><span id="l73.66"> ## @loc None</span>
<a href="#l73.67"></a><span id="l73.67"> 5107=Delete Folder</span>
<a href="#l73.68"></a><span id="l73.68"> </span>
<a href="#l73.69"></a><span id="l73.69"> ## @name IMAP_DELETE_FOLDER_BUTTON_LABEL</span>
<a href="#l73.70"></a><span id="l73.70"> ## @loc None</span>
<a href="#l73.71"></a><span id="l73.71"> 5108=&amp;Delete Folder</span>
<a href="#l73.72"></a><span id="l73.72"> </span>
<a href="#l73.73"></a><span id="l73.73" class="difflineminus">-## @name IMAP_LOGIN_DISABLED</span>
<a href="#l73.74"></a><span id="l73.74" class="difflineplus">+## @name IMAP_AUTH_CHANGE_ENCRYPT_TO_PLAIN_NO_SSL</span>
<a href="#l73.75"></a><span id="l73.75" class="difflineplus">+## @loc None</span>
<a href="#l73.76"></a><span id="l73.76" class="difflineplus">+# LOCALIZATION NOTE (5109): %S is the server hostname</span>
<a href="#l73.77"></a><span id="l73.77" class="difflineplus">+5109=The IMAP server %S does not seem to support encrypted passwords. If you just set up the account, please try changing to 'Password, transmitted insecurely' as the 'Authentication method' in the 'Account Settings | Server settings'. If it used to work and now suddenly fails, this is a common scenario how someone could steal your password.</span>
<a href="#l73.78"></a><span id="l73.78" class="difflineplus">+</span>
<a href="#l73.79"></a><span id="l73.79" class="difflineplus">+## @name IMAP_AUTH_CHANGE_ENCRYPT_TO_PLAIN_SSL</span>
<a href="#l73.80"></a><span id="l73.80"> ## @loc None</span>
<a href="#l73.81"></a><span id="l73.81" class="difflineminus">-# LOCALIZATION NOTE (5109): %S is the server address</span>
<a href="#l73.82"></a><span id="l73.82" class="difflineminus">-5109=You cannot log in to %S because the server doesn't allow plaintext authentication without STARTTLS or SSL/TLS. Try enabling connection security or secure authentication in the account settings.</span>
<a href="#l73.83"></a><span id="l73.83" class="difflineplus">+# LOCALIZATION NOTE (5110): %S is the server hostname</span>
<a href="#l73.84"></a><span id="l73.84" class="difflineplus">+5110=The IMAP server %S does not seem to support encrypted passwords. If you just set up this account, please try changing to 'Normal password' as the 'Authentication method' in the 'Account Settings | Server settings'. If it used to work and now suddenly fails, please contact your email administrator or provider.</span>
<a href="#l73.85"></a><span id="l73.85" class="difflineplus">+</span>
<a href="#l73.86"></a><span id="l73.86" class="difflineplus">+## @name IMAP_AUTH_CHANGE_PLAIN_TO_ENCRYPT</span>
<a href="#l73.87"></a><span id="l73.87" class="difflineplus">+## @loc None</span>
<a href="#l73.88"></a><span id="l73.88" class="difflineplus">+# LOCALIZATION NOTE (5111): %S is the server hostname</span>
<a href="#l73.89"></a><span id="l73.89" class="difflineplus">+5111=The IMAP server %S does not allow plaintext passwords. Please try changing to 'Encrypted password' as the 'Authentication method' in the 'Account Settings | Server settings'.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l74.1"></a><span id="l74.1" class="difflineminus">--- a/suite/locales/en-US/chrome/mailnews/localMsgs.properties</span>
<a href="#l74.2"></a><span id="l74.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/mailnews/localMsgs.properties</span>
<a href="#l74.3"></a><span id="l74.3" class="difflineat">@@ -160,20 +160,25 @@ 4025= Mail server %S responded:</span>
<a href="#l74.4"></a><span id="l74.4"> ## @name COPYING_MSGS_STATUS</span>
<a href="#l74.5"></a><span id="l74.5"> ## @loc None</span>
<a href="#l74.6"></a><span id="l74.6"> 4027=Copying %S of %S messages to %S</span>
<a href="#l74.7"></a><span id="l74.7"> </span>
<a href="#l74.8"></a><span id="l74.8"> ## @name MOVING_MSGS_STATUS</span>
<a href="#l74.9"></a><span id="l74.9"> ## @loc None</span>
<a href="#l74.10"></a><span id="l74.10"> 4028=Moving %S of %S messages to %S</span>
<a href="#l74.11"></a><span id="l74.11"> </span>
<a href="#l74.12"></a><span id="l74.12" class="difflineminus">-# secure authentication failed</span>
<a href="#l74.13"></a><span id="l74.13" class="difflineminus">-## @name CANNOT_PROCESS_SECURE_AUTH</span>
<a href="#l74.14"></a><span id="l74.14" class="difflineplus">+# Authentication server caps and pref don't match</span>
<a href="#l74.15"></a><span id="l74.15" class="difflineplus">+## @name POP3_AUTH_MECH_NOT_SUPPORTED</span>
<a href="#l74.16"></a><span id="l74.16"> ## @loc None</span>
<a href="#l74.17"></a><span id="l74.17" class="difflineminus">-4030=Mail server does not support secure authentication.</span>
<a href="#l74.18"></a><span id="l74.18" class="difflineplus">+4030=The server does not support the selected authentication method. Please change the Authentication method in the Account Settings.</span>
<a href="#l74.19"></a><span id="l74.19" class="difflineplus">+</span>
<a href="#l74.20"></a><span id="l74.20" class="difflineplus">+# Status - Could not log in to GSSAPI, and it was the only method</span>
<a href="#l74.21"></a><span id="l74.21" class="difflineplus">+## @name POP3_GSSAPI_FAILURE</span>
<a href="#l74.22"></a><span id="l74.22" class="difflineplus">+## @loc None</span>
<a href="#l74.23"></a><span id="l74.23" class="difflineplus">+4031=The Kerberos/GSSAPI ticket was not accepted by the POP server. Please check that you are logged in to the Kerberos/GSSAPI realm.</span>
<a href="#l74.24"></a><span id="l74.24"> </span>
<a href="#l74.25"></a><span id="l74.25"> ## @name MOVEMAIL_CANT_OPEN_SPOOL_FILE</span>
<a href="#l74.26"></a><span id="l74.26"> ## @loc None</span>
<a href="#l74.27"></a><span id="l74.27"> 4033=Unable to open mail spool file %S.</span>
<a href="#l74.28"></a><span id="l74.28"> </span>
<a href="#l74.29"></a><span id="l74.29"> ## @name MOVEMAIL_CANT_CREATE_LOCK</span>
<a href="#l74.30"></a><span id="l74.30"> ## @loc None</span>
<a href="#l74.31"></a><span id="l74.31"> 4034=Unable to create lock file %S. For movemail to work, it is necessary to create lock files in the mail spool directory. On many systems, this is best accomplished by making the spool directory be mode 01777.</span>
<a href="#l74.32"></a><span id="l74.32" class="difflineat">@@ -207,21 +212,16 @@ 4040=The POP3 mail server (%S) does not </span>
<a href="#l74.33"></a><span id="l74.33"> ## @name POP3_SERVER_DOES_NOT_SUPPORT_THE_TOP_COMMAND</span>
<a href="#l74.34"></a><span id="l74.34"> ## @loc None</span>
<a href="#l74.35"></a><span id="l74.35"> # LOCALIZATION NOTE(4011): The following sentence should be translated in this way:</span>
<a href="#l74.36"></a><span id="l74.36"> # Do not translate &quot;POP3&quot;</span>
<a href="#l74.37"></a><span id="l74.37"> # Do not translate &quot;%S&quot;. Place %S in your translation where the name of the server should appear.</span>
<a href="#l74.38"></a><span id="l74.38"> # Do not translate &quot;TOP&quot;</span>
<a href="#l74.39"></a><span id="l74.39"> 4041=The POP3 mail server (%S) does not support the TOP command. Without server support for this, we cannot implement the ``Maximum Message Size'' or ``Fetch Headers Only'' preference.  This option has been disabled, and messages will be downloaded regardless of their size.</span>
<a href="#l74.40"></a><span id="l74.40"> </span>
<a href="#l74.41"></a><span id="l74.41" class="difflineminus">-# secure authentication failed and unsure why</span>
<a href="#l74.42"></a><span id="l74.42" class="difflineminus">-## @name CANNOT_PROCESS_APOP_AUTH</span>
<a href="#l74.43"></a><span id="l74.43" class="difflineminus">-## @loc None</span>
<a href="#l74.44"></a><span id="l74.44" class="difflineminus">-4042=The mail server does not support secure authentication or you have entered an incorrect password. Please check your password, or turn off secure authentication in the Server Settings for your mail server in the Account Settings window.\n</span>
<a href="#l74.45"></a><span id="l74.45" class="difflineminus">-</span>
<a href="#l74.46"></a><span id="l74.46"> ## @name NS_ERROR_COULD_NOT_CONNECT_VIA_TLS</span>
<a href="#l74.47"></a><span id="l74.47"> ## @loc None</span>
<a href="#l74.48"></a><span id="l74.48"> 4043=Unable to establish TLS connection to POP3 server. The server may be down or may be incorrectly configured. Please verify the correct configuration in the Server Settings for your mail server in the Account Settings window and try again.</span>
<a href="#l74.49"></a><span id="l74.49"> </span>
<a href="#l74.50"></a><span id="l74.50"> ## @name POP3_MOVE_FOLDER_TO_TRASH</span>
<a href="#l74.51"></a><span id="l74.51"> ## @loc None</span>
<a href="#l74.52"></a><span id="l74.52"> # LOCALIZATION NOTE (4044): Do not translate the word %S below.</span>
<a href="#l74.53"></a><span id="l74.53"> # &quot;%S&quot; is the name of the folder.</span>
<a href="#l74.54"></a><span id="l74.54" class="difflineat">@@ -229,8 +229,24 @@ 4044=Are you sure you want to delete the</span>
<a href="#l74.55"></a><span id="l74.55"> </span>
<a href="#l74.56"></a><span id="l74.56"> ## @name POP3_DELETE_FOLDER_DIALOG_TITLE</span>
<a href="#l74.57"></a><span id="l74.57"> ## @loc None</span>
<a href="#l74.58"></a><span id="l74.58"> 4045=Delete Folder</span>
<a href="#l74.59"></a><span id="l74.59"> </span>
<a href="#l74.60"></a><span id="l74.60"> ## @name POP3_DELETE_FOLDER_BUTTON_LABEL</span>
<a href="#l74.61"></a><span id="l74.61"> ## @loc None</span>
<a href="#l74.62"></a><span id="l74.62"> 4046=&amp;Delete Folder</span>
<a href="#l74.63"></a><span id="l74.63" class="difflineplus">+</span>
<a href="#l74.64"></a><span id="l74.64" class="difflineplus">+## @name POP3_AUTH_INTERNAL_ERROR</span>
<a href="#l74.65"></a><span id="l74.65" class="difflineplus">+## @loc None</span>
<a href="#l74.66"></a><span id="l74.66" class="difflineplus">+4047=Internal state error during POP3 server authentication. This is an internal, unexpected error in the application, please report it as bug.</span>
<a href="#l74.67"></a><span id="l74.67" class="difflineplus">+</span>
<a href="#l74.68"></a><span id="l74.68" class="difflineplus">+## @name POP3_AUTH_CHANGE_ENCRYPT_TO_PLAIN_NO_SSL</span>
<a href="#l74.69"></a><span id="l74.69" class="difflineplus">+## @loc None</span>
<a href="#l74.70"></a><span id="l74.70" class="difflineplus">+4048=This POP3 server does not seem to support encrypted passwords. If you just set up the account, please try changing to 'Password, transmitted insecurely' as the 'Authentication method' in the 'Account Settings | Server settings'. If it used to work and now suddenly fails, this is a common scenario how someone could steal your password.</span>
<a href="#l74.71"></a><span id="l74.71" class="difflineplus">+</span>
<a href="#l74.72"></a><span id="l74.72" class="difflineplus">+## @name POP3_AUTH_CHANGE_ENCRYPT_TO_PLAIN_SSL</span>
<a href="#l74.73"></a><span id="l74.73" class="difflineplus">+## @loc None</span>
<a href="#l74.74"></a><span id="l74.74" class="difflineplus">+4049=This POP3 server does not seem to support encrypted passwords. If you just set up this account, please try changing to 'Normal password' as the 'Authentication method' in the 'Account Settings | Server settings'. If it used to work and now suddenly fails, please contact your email administrator or provider.</span>
<a href="#l74.75"></a><span id="l74.75" class="difflineplus">+</span>
<a href="#l74.76"></a><span id="l74.76" class="difflineplus">+## @name POP3_AUTH_CHANGE_PLAIN_TO_ENCRYPT</span>
<a href="#l74.77"></a><span id="l74.77" class="difflineplus">+## @loc None</span>
<a href="#l74.78"></a><span id="l74.78" class="difflineplus">+4050=This POP3 server does not allow plaintext passwords. Please try changing to 'Encrypted password' as the 'Authentication method' in the 'Account Settings | Server settings'.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l75.1"></a><span id="l75.1" class="difflineminus">--- a/suite/locales/en-US/chrome/mailnews/messenger.properties</span>
<a href="#l75.2"></a><span id="l75.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/mailnews/messenger.properties</span>
<a href="#l75.3"></a><span id="l75.3" class="difflineat">@@ -132,16 +132,27 @@ smtpServer-ConnectionSecurityType-0=None</span>
<a href="#l75.4"></a><span id="l75.4"> smtpServer-ConnectionSecurityType-1=STARTTLS, if available</span>
<a href="#l75.5"></a><span id="l75.5"> smtpServer-ConnectionSecurityType-2=STARTTLS</span>
<a href="#l75.6"></a><span id="l75.6"> smtpServer-ConnectionSecurityType-3=SSL/TLS</span>
<a href="#l75.7"></a><span id="l75.7"> smtpServer-SecureAuthentication-Type-false=No</span>
<a href="#l75.8"></a><span id="l75.8"> smtpServer-SecureAuthentication-Type-true=Yes</span>
<a href="#l75.9"></a><span id="l75.9"> smtpServers-confirmServerDeletionTitle=Delete Server</span>
<a href="#l75.10"></a><span id="l75.10"> smtpServers-confirmServerDeletion=Are you sure you want to delete the server: \n %S?</span>
<a href="#l75.11"></a><span id="l75.11"> </span>
<a href="#l75.12"></a><span id="l75.12" class="difflineplus">+# Account Settings - Both Incoming and SMTP server</span>
<a href="#l75.13"></a><span id="l75.13" class="difflineplus">+authNo=No authentication</span>
<a href="#l75.14"></a><span id="l75.14" class="difflineplus">+authOld=Password, original method (insecure)</span>
<a href="#l75.15"></a><span id="l75.15" class="difflineplus">+authPasswordCleartextInsecurely=Password, transmitted insecurely</span>
<a href="#l75.16"></a><span id="l75.16" class="difflineplus">+authPasswordCleartextViaSSL=Normal password</span>
<a href="#l75.17"></a><span id="l75.17" class="difflineplus">+authPasswordEncrypted=Encrypted password</span>
<a href="#l75.18"></a><span id="l75.18" class="difflineplus">+authKerberos=Kerberos / GSSAPI</span>
<a href="#l75.19"></a><span id="l75.19" class="difflineplus">+authNTLM=NTLM</span>
<a href="#l75.20"></a><span id="l75.20" class="difflineplus">+authAnySecure=Any secure method (deprecated)</span>
<a href="#l75.21"></a><span id="l75.21" class="difflineplus">+authAny=Any method (insecure)</span>
<a href="#l75.22"></a><span id="l75.22" class="difflineplus">+</span>
<a href="#l75.23"></a><span id="l75.23"> # LOCALIZATION NOTE(serverType-nntp): Do not translate &quot;NNTP&quot; in the line below</span>
<a href="#l75.24"></a><span id="l75.24"> serverType-nntp=News Server (NNTP)</span>
<a href="#l75.25"></a><span id="l75.25"> # LOCALIZATION NOTE(serverType-pop3): Do not translate &quot;POP&quot; in the line below</span>
<a href="#l75.26"></a><span id="l75.26"> serverType-pop3=POP Mail Server</span>
<a href="#l75.27"></a><span id="l75.27"> # LOCALIZATION NOTE(serverType-imap): Do not translate &quot;IMAP&quot; in the line below</span>
<a href="#l75.28"></a><span id="l75.28"> serverType-imap=IMAP Mail Server</span>
<a href="#l75.29"></a><span id="l75.29"> serverType-none=Local Mail Store</span>
<a href="#l75.30"></a><span id="l75.30"> # LOCALIZATION NOTE(serverType-movemail): DONT_TRANSLATE</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l76.1"></a><span id="l76.1" class="difflineminus">--- a/suite/locales/en-US/chrome/mailnews/pref/am-advanced.dtd</span>
<a href="#l76.2"></a><span id="l76.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/mailnews/pref/am-advanced.dtd</span>
<a href="#l76.3"></a><span id="l76.3" class="difflineat">@@ -12,9 +12,9 @@</span>
<a href="#l76.4"></a><span id="l76.4"> &lt;!ENTITY smtpListSetDefault.label &quot;Set Default&quot;&gt;</span>
<a href="#l76.5"></a><span id="l76.5"> &lt;!ENTITY smtpListSetDefault.accesskey &quot;t&quot;&gt;</span>
<a href="#l76.6"></a><span id="l76.6"> </span>
<a href="#l76.7"></a><span id="l76.7"> &lt;!ENTITY serverDescription.label &quot;Description: &quot;&gt;</span>
<a href="#l76.8"></a><span id="l76.8"> &lt;!ENTITY serverName.label &quot;Server Name: &quot;&gt;</span>
<a href="#l76.9"></a><span id="l76.9"> &lt;!ENTITY serverPort.label &quot;Port: &quot;&gt;</span>
<a href="#l76.10"></a><span id="l76.10"> &lt;!ENTITY userName.label   &quot;User Name: &quot;&gt;</span>
<a href="#l76.11"></a><span id="l76.11"> &lt;!ENTITY connectionSecurity.label &quot;Connection Security: &quot;&gt;</span>
<a href="#l76.12"></a><span id="l76.12" class="difflineminus">-&lt;!ENTITY useSecureAuthentication.label   &quot;Secure Authentication: &quot;&gt;</span>
<a href="#l76.13"></a><span id="l76.13" class="difflineplus">+&lt;!ENTITY authMethod.label   &quot;Authentication method: &quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l77.1"></a><span id="l77.1" class="difflineminus">--- a/suite/locales/en-US/chrome/mailnews/pref/am-server-top.dtd</span>
<a href="#l77.2"></a><span id="l77.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/mailnews/pref/am-server-top.dtd</span>
<a href="#l77.3"></a><span id="l77.3" class="difflineat">@@ -19,18 +19,18 @@</span>
<a href="#l77.4"></a><span id="l77.4"> &lt;!ENTITY biffStart.accesskey &quot;y&quot;&gt;</span>
<a href="#l77.5"></a><span id="l77.5"> &lt;!ENTITY biffEnd.label &quot;minutes&quot;&gt;</span>
<a href="#l77.6"></a><span id="l77.6"> &lt;!ENTITY connectionSecurity.label &quot;Connection security:&quot;&gt;</span>
<a href="#l77.7"></a><span id="l77.7"> &lt;!ENTITY connectionSecurity.accesskey &quot;u&quot;&gt;</span>
<a href="#l77.8"></a><span id="l77.8"> &lt;!ENTITY connectionSecurityType-0.label &quot;None&quot;&gt;</span>
<a href="#l77.9"></a><span id="l77.9"> &lt;!ENTITY connectionSecurityType-1.label &quot;STARTTLS, if available&quot;&gt;</span>
<a href="#l77.10"></a><span id="l77.10"> &lt;!ENTITY connectionSecurityType-2.label &quot;STARTTLS&quot;&gt;</span>
<a href="#l77.11"></a><span id="l77.11"> &lt;!ENTITY connectionSecurityType-3.label &quot;SSL/TLS&quot;&gt;</span>
<a href="#l77.12"></a><span id="l77.12" class="difflineminus">-&lt;!ENTITY useSecAuth.label &quot;Use secure authentication&quot;&gt;</span>
<a href="#l77.13"></a><span id="l77.13" class="difflineminus">-&lt;!ENTITY useSecAuth.accesskey &quot;i&quot;&gt;</span>
<a href="#l77.14"></a><span id="l77.14" class="difflineplus">+&lt;!ENTITY authMethod.label &quot;Authentication method:&quot;&gt;</span>
<a href="#l77.15"></a><span id="l77.15" class="difflineplus">+&lt;!ENTITY authMethod.accesskey &quot;i&quot;&gt;</span>
<a href="#l77.16"></a><span id="l77.16"> &lt;!ENTITY leaveOnServer.label &quot;Leave messages on server&quot;&gt;</span>
<a href="#l77.17"></a><span id="l77.17"> &lt;!ENTITY leaveOnServer.accesskey &quot;g&quot;&gt;</span>
<a href="#l77.18"></a><span id="l77.18"> &lt;!ENTITY headersOnly.label &quot;Fetch headers only&quot;&gt;</span>
<a href="#l77.19"></a><span id="l77.19"> &lt;!ENTITY headersOnly.accesskey &quot;e&quot;&gt;</span>
<a href="#l77.20"></a><span id="l77.20"> &lt;!ENTITY deleteByAgeFromServer.label &quot;For at most&quot;&gt;</span>
<a href="#l77.21"></a><span id="l77.21"> &lt;!ENTITY deleteByAgeFromServer.accesskey &quot;o&quot;&gt;</span>
<a href="#l77.22"></a><span id="l77.22"> &lt;!ENTITY daysEnd.label &quot;days&quot;&gt;</span>
<a href="#l77.23"></a><span id="l77.23"> &lt;!ENTITY deleteOnServer2.label &quot;Until I delete them&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l78.1"></a><span id="l78.1" class="difflineminus">--- a/suite/locales/en-US/chrome/mailnews/pref/smtpEditOverlay.dtd</span>
<a href="#l78.2"></a><span id="l78.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/mailnews/pref/smtpEditOverlay.dtd</span>
<a href="#l78.3"></a><span id="l78.3" class="difflineat">@@ -1,22 +1,20 @@</span>
<a href="#l78.4"></a><span id="l78.4"> &lt;!ENTITY settings.caption &quot;Settings&quot;&gt;</span>
<a href="#l78.5"></a><span id="l78.5"> &lt;!ENTITY security.caption &quot;Security and Authentication&quot;&gt;</span>
<a href="#l78.6"></a><span id="l78.6"> &lt;!ENTITY serverName.label &quot;Server Name:&quot;&gt;</span>
<a href="#l78.7"></a><span id="l78.7"> &lt;!ENTITY serverName.accesskey &quot;S&quot;&gt;</span>
<a href="#l78.8"></a><span id="l78.8"> &lt;!ENTITY serverDescription.label &quot;Description:&quot;&gt;</span>
<a href="#l78.9"></a><span id="l78.9"> &lt;!ENTITY serverDescription.accesskey &quot;D&quot;&gt;</span>
<a href="#l78.10"></a><span id="l78.10"> &lt;!ENTITY serverPort.label &quot;Port:&quot;&gt;</span>
<a href="#l78.11"></a><span id="l78.11"> &lt;!ENTITY serverPort.accesskey &quot;P&quot;&gt;</span>
<a href="#l78.12"></a><span id="l78.12" class="difflineminus">-&lt;!ENTITY alwaysUseUsername.label &quot;Use name and password&quot;&gt;</span>
<a href="#l78.13"></a><span id="l78.13" class="difflineminus">-&lt;!ENTITY alwaysUseUsername.accesskey &quot;U&quot;&gt;</span>
<a href="#l78.14"></a><span id="l78.14"> &lt;!ENTITY userName.label &quot;User Name:&quot;&gt;</span>
<a href="#l78.15"></a><span id="l78.15"> &lt;!ENTITY userName.accesskey &quot;m&quot;&gt;</span>
<a href="#l78.16"></a><span id="l78.16" class="difflineminus">-&lt;!ENTITY useSecAuth.label &quot;Use secure authentication&quot;&gt;</span>
<a href="#l78.17"></a><span id="l78.17" class="difflineminus">-&lt;!ENTITY useSecAuth.accesskey &quot;i&quot;&gt;</span>
<a href="#l78.18"></a><span id="l78.18"> &lt;!ENTITY connectionSecurity.label &quot;Connection security:&quot;&gt;</span>
<a href="#l78.19"></a><span id="l78.19"> &lt;!ENTITY connectionSecurity.accesskey &quot;n&quot;&gt;</span>
<a href="#l78.20"></a><span id="l78.20"> &lt;!ENTITY connectionSecurityType-0.label &quot;None&quot;&gt;</span>
<a href="#l78.21"></a><span id="l78.21"> &lt;!ENTITY connectionSecurityType-1.label &quot;STARTTLS, if available&quot;&gt;</span>
<a href="#l78.22"></a><span id="l78.22"> &lt;!ENTITY connectionSecurityType-2.label &quot;STARTTLS&quot;&gt;</span>
<a href="#l78.23"></a><span id="l78.23"> &lt;!ENTITY connectionSecurityType-3.label &quot;SSL/TLS&quot;&gt;</span>
<a href="#l78.24"></a><span id="l78.24"> &lt;!ENTITY smtpEditTitle.label &quot;SMTP Server&quot;&gt;</span>
<a href="#l78.25"></a><span id="l78.25"> &lt;!ENTITY serverPortDefault.label &quot;Default:&quot;&gt;</span>
<a href="#l78.26"></a><span id="l78.26" class="difflineplus">+&lt;!ENTITY authMethod.label &quot;Authentication method:&quot;&gt;</span>
<a href="#l78.27"></a><span id="l78.27" class="difflineplus">+&lt;!ENTITY authMethod.accesskey &quot;i&quot;&gt;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

