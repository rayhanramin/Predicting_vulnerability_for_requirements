<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 1632:1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb" />
<meta property="og:url" content="/comm-central/rev/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb" />
<meta property="og:description" content="Bug 472314 - Second batch of documentation. r=dbo" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb">shortlog</a> |
<a href="/comm-central/log/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb">files</a> |
changeset |
<a href="/comm-central/raw-rev/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb">raw</a>  | <a href="/comm-central/archive/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=472314">Bug 472314</a> - Second batch of documentation. r=dbo
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 14 Jan 2009 15:20:24 +0100</td></tr>

<tr>
 <td>changeset 1632</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb">1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb</a></td>
</tr>



<tr>
<td>parent 1631</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d225e9ddbea110b641e9860535012fb90816f864">d225e9ddbea110b641e9860535012fb90816f864</a>
</td>
</tr>

<tr>
<td>child 1633</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b7f98d3d4e737ea2069a6729746e7d32e1fe3361">b7f98d3d4e737ea2069a6729746e7d32e1fe3361</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb">1307</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Wed, 14 Jan 2009 14:24:00 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@1a6a0499ede4 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb&newProject=comm-central&newRevision=1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb&newProject=comm-central&newRevision=1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb&newProject=comm-central&newRevision=1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28dbo%29&revcount=50">dbo</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=472314">472314</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=472314">Bug 472314</a> - Second batch of documentation. r=dbo</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-alarm-dialog.js">calendar/base/content/calendar-alarm-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-alarm-dialog.js">file</a> |
<a href="/comm-central/annotate/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-alarm-dialog.js">annotate</a> |
<a href="/comm-central/diff/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-alarm-dialog.js">diff</a> |
<a href="/comm-central/comparison/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-alarm-dialog.js">comparison</a> |
<a href="/comm-central/log/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-alarm-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-chrome-startup.js">calendar/base/content/calendar-chrome-startup.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-chrome-startup.js">file</a> |
<a href="/comm-central/annotate/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-chrome-startup.js">annotate</a> |
<a href="/comm-central/diff/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-chrome-startup.js">diff</a> |
<a href="/comm-central/comparison/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-chrome-startup.js">comparison</a> |
<a href="/comm-central/log/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-chrome-startup.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-clipboard.js">calendar/base/content/calendar-clipboard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-clipboard.js">file</a> |
<a href="/comm-central/annotate/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-clipboard.js">annotate</a> |
<a href="/comm-central/diff/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-clipboard.js">diff</a> |
<a href="/comm-central/comparison/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-clipboard.js">comparison</a> |
<a href="/comm-central/log/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-clipboard.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-common-sets.js">calendar/base/content/calendar-common-sets.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-common-sets.js">file</a> |
<a href="/comm-central/annotate/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-common-sets.js">annotate</a> |
<a href="/comm-central/diff/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-common-sets.js">diff</a> |
<a href="/comm-central/comparison/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-common-sets.js">comparison</a> |
<a href="/comm-central/log/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-common-sets.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-invitations-manager.js">calendar/base/content/calendar-invitations-manager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-invitations-manager.js">file</a> |
<a href="/comm-central/annotate/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-invitations-manager.js">annotate</a> |
<a href="/comm-central/diff/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-invitations-manager.js">diff</a> |
<a href="/comm-central/comparison/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-invitations-manager.js">comparison</a> |
<a href="/comm-central/log/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-invitations-manager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-item-editing.js">calendar/base/content/calendar-item-editing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-item-editing.js">file</a> |
<a href="/comm-central/annotate/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-item-editing.js">annotate</a> |
<a href="/comm-central/diff/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-item-editing.js">diff</a> |
<a href="/comm-central/comparison/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-item-editing.js">comparison</a> |
<a href="/comm-central/log/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-item-editing.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-statusbar.js">calendar/base/content/calendar-statusbar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-statusbar.js">file</a> |
<a href="/comm-central/annotate/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-statusbar.js">annotate</a> |
<a href="/comm-central/diff/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-statusbar.js">diff</a> |
<a href="/comm-central/comparison/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-statusbar.js">comparison</a> |
<a href="/comm-central/log/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-statusbar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-subscriptions-dialog.js">calendar/base/content/calendar-subscriptions-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-subscriptions-dialog.js">file</a> |
<a href="/comm-central/annotate/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-subscriptions-dialog.js">annotate</a> |
<a href="/comm-central/diff/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-subscriptions-dialog.js">diff</a> |
<a href="/comm-central/comparison/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-subscriptions-dialog.js">comparison</a> |
<a href="/comm-central/log/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-subscriptions-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-task-editing.js">calendar/base/content/calendar-task-editing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-task-editing.js">file</a> |
<a href="/comm-central/annotate/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-task-editing.js">annotate</a> |
<a href="/comm-central/diff/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-task-editing.js">diff</a> |
<a href="/comm-central/comparison/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-task-editing.js">comparison</a> |
<a href="/comm-central/log/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-task-editing.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-task-view.js">calendar/base/content/calendar-task-view.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-task-view.js">file</a> |
<a href="/comm-central/annotate/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-task-view.js">annotate</a> |
<a href="/comm-central/diff/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-task-view.js">diff</a> |
<a href="/comm-central/comparison/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-task-view.js">comparison</a> |
<a href="/comm-central/log/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-task-view.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-ui-utils.js">calendar/base/content/calendar-ui-utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-ui-utils.js">file</a> |
<a href="/comm-central/annotate/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-ui-utils.js">annotate</a> |
<a href="/comm-central/diff/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-ui-utils.js">diff</a> |
<a href="/comm-central/comparison/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-ui-utils.js">comparison</a> |
<a href="/comm-central/log/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-ui-utils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-views.js">calendar/base/content/calendar-views.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-views.js">file</a> |
<a href="/comm-central/annotate/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-views.js">annotate</a> |
<a href="/comm-central/diff/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-views.js">diff</a> |
<a href="/comm-central/comparison/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-views.js">comparison</a> |
<a href="/comm-central/log/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/calendar-views.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/dialogs/calendar-event-dialog-timezone.js">calendar/base/content/dialogs/calendar-event-dialog-timezone.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/dialogs/calendar-event-dialog-timezone.js">file</a> |
<a href="/comm-central/annotate/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/dialogs/calendar-event-dialog-timezone.js">annotate</a> |
<a href="/comm-central/diff/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/dialogs/calendar-event-dialog-timezone.js">diff</a> |
<a href="/comm-central/comparison/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/dialogs/calendar-event-dialog-timezone.js">comparison</a> |
<a href="/comm-central/log/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/dialogs/calendar-event-dialog-timezone.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/migration.js">calendar/base/content/migration.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/migration.js">file</a> |
<a href="/comm-central/annotate/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/migration.js">annotate</a> |
<a href="/comm-central/diff/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/migration.js">diff</a> |
<a href="/comm-central/comparison/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/migration.js">comparison</a> |
<a href="/comm-central/log/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/migration.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/today-pane.js">calendar/base/content/today-pane.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/today-pane.js">file</a> |
<a href="/comm-central/annotate/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/today-pane.js">annotate</a> |
<a href="/comm-central/diff/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/today-pane.js">diff</a> |
<a href="/comm-central/comparison/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/today-pane.js">comparison</a> |
<a href="/comm-central/log/1a6a0499ede4c4d3a2626e0c152bb942db6dc8cb/calendar/base/content/today-pane.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/content/calendar-alarm-dialog.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/content/calendar-alarm-dialog.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -31,24 +31,23 @@</span>
<a href="#l1.4"></a><span id="l1.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l1.5"></a><span id="l1.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l1.6"></a><span id="l1.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l1.7"></a><span id="l1.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l1.8"></a><span id="l1.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l1.9"></a><span id="l1.9">  *</span>
<a href="#l1.10"></a><span id="l1.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+</span>
<a href="#l1.14"></a><span id="l1.14"> /**</span>
<a href="#l1.15"></a><span id="l1.15">  * Helper function to get the alarm service and cache it.</span>
<a href="#l1.16"></a><span id="l1.16">  *</span>
<a href="#l1.17"></a><span id="l1.17">  * @return The alarm service component</span>
<a href="#l1.18"></a><span id="l1.18">  */</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-Components.utils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-</span>
<a href="#l1.22"></a><span id="l1.22"> function getAlarmService() {</span>
<a href="#l1.23"></a><span id="l1.23">     if (!window.mAlarmService) {</span>
<a href="#l1.24"></a><span id="l1.24">         window.mAlarmService = Components.classes[&quot;@mozilla.org/calendar/alarm-service;1&quot;]</span>
<a href="#l1.25"></a><span id="l1.25">                                          .getService(Components.interfaces.calIAlarmService);</span>
<a href="#l1.26"></a><span id="l1.26">     }</span>
<a href="#l1.27"></a><span id="l1.27">     return window.mAlarmService;</span>
<a href="#l1.28"></a><span id="l1.28"> }</span>
<a href="#l1.29"></a><span id="l1.29"> </span>
<a href="#l1.30"></a><span id="l1.30" class="difflineat">@@ -211,17 +210,17 @@ function snoozeAllItems(aDurationMinutes</span>
<a href="#l1.31"></a><span id="l1.31"> </span>
<a href="#l1.32"></a><span id="l1.32"> /**</span>
<a href="#l1.33"></a><span id="l1.33">  * Sets up the window title, counting the number of alarms in the window.</span>
<a href="#l1.34"></a><span id="l1.34">  */</span>
<a href="#l1.35"></a><span id="l1.35"> function setupTitle() {</span>
<a href="#l1.36"></a><span id="l1.36">     var alarmRichlist = document.getElementById(&quot;alarm-richlist&quot;);</span>
<a href="#l1.37"></a><span id="l1.37">     var reminders = alarmRichlist.childNodes.length;</span>
<a href="#l1.38"></a><span id="l1.38"> </span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-    let title = PluralForm.get(reminders, calGetString(&quot;calendar&quot;, &quot;alarmWindowTitle.label&quot;)); </span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+    let title = PluralForm.get(reminders, calGetString(&quot;calendar&quot;, &quot;alarmWindowTitle.label&quot;));</span>
<a href="#l1.41"></a><span id="l1.41">     document.title = title.replace(&quot;#1&quot;, reminders);</span>
<a href="#l1.42"></a><span id="l1.42"> }</span>
<a href="#l1.43"></a><span id="l1.43"> </span>
<a href="#l1.44"></a><span id="l1.44"> /**</span>
<a href="#l1.45"></a><span id="l1.45">  * Add an alarm widget for the passed calendar item</span>
<a href="#l1.46"></a><span id="l1.46">  *</span>
<a href="#l1.47"></a><span id="l1.47">  * @param aItem       The calendar item to add a widget for.</span>
<a href="#l1.48"></a><span id="l1.48">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/content/calendar-chrome-startup.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/content/calendar-chrome-startup.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -75,14 +75,19 @@ function commonFinishCalendar() {</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5">     // Remove the command controller</span>
<a href="#l2.6"></a><span id="l2.6">     removeCalendarCommandController();</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8">     document.getElementById(&quot;calsidebar_splitter&quot;).removeEventListener(&quot;command&quot;, onCalendarViewResize, false);</span>
<a href="#l2.9"></a><span id="l2.9">     window.removeEventListener(&quot;resize&quot;, onCalendarViewResize, true);</span>
<a href="#l2.10"></a><span id="l2.10"> }</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+/**</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+ * Handler function to create |viewtype + &quot;viewresized&quot;| events that are</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+ * dispatched through the calendarviewBroadcaster.</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+ *</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+ * XXX this has nothing to do with startup, needs to go somewhere else.</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+ */</span>
<a href="#l2.18"></a><span id="l2.18"> function onCalendarViewResize(aEvent) {</span>
<a href="#l2.19"></a><span id="l2.19">     let event = document.createEvent('Events');</span>
<a href="#l2.20"></a><span id="l2.20">     event.initEvent(currentView().type + &quot;viewresized&quot;, true, false);</span>
<a href="#l2.21"></a><span id="l2.21">     document.getElementById(&quot;calendarviewBroadcaster&quot;).dispatchEvent(event);</span>
<a href="#l2.22"></a><span id="l2.22"> }</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/content/calendar-clipboard.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/content/calendar-clipboard.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -34,53 +34,65 @@</span>
<a href="#l3.4"></a><span id="l3.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l3.5"></a><span id="l3.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l3.6"></a><span id="l3.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l3.7"></a><span id="l3.7">  *</span>
<a href="#l3.8"></a><span id="l3.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+/**</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+ * Gets the clipboard service.</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+ * @see nsIClipboard</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+ * @return          The clipboard service.</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+ */</span>
<a href="#l3.17"></a><span id="l3.17"> function getClipboard() {</span>
<a href="#l3.18"></a><span id="l3.18">     return Components.classes[&quot;@mozilla.org/widget/clipboard;1&quot;]</span>
<a href="#l3.19"></a><span id="l3.19">                      .getService(Components.interfaces.nsIClipboard);</span>
<a href="#l3.20"></a><span id="l3.20"> }</span>
<a href="#l3.21"></a><span id="l3.21"> </span>
<a href="#l3.22"></a><span id="l3.22"> /**</span>
<a href="#l3.23"></a><span id="l3.23">  * Test if a writable calendar is selected, and if the clipboard has items that</span>
<a href="#l3.24"></a><span id="l3.24">  * can be pasted into Calendar. The data must be of type &quot;text/calendar&quot; or</span>
<a href="#l3.25"></a><span id="l3.25">  * &quot;text/unicode&quot;.</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+ *</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+ * @return          If true, pasting is currently possible.</span>
<a href="#l3.28"></a><span id="l3.28">  */</span>
<a href="#l3.29"></a><span id="l3.29"> function canPaste() {</span>
<a href="#l3.30"></a><span id="l3.30">     let selectedCal = getSelectedCalendar();</span>
<a href="#l3.31"></a><span id="l3.31">     if (!selectedCal || !cal.isCalendarWritable(selectedCal)) {</span>
<a href="#l3.32"></a><span id="l3.32">         return false;</span>
<a href="#l3.33"></a><span id="l3.33">     }</span>
<a href="#l3.34"></a><span id="l3.34"> </span>
<a href="#l3.35"></a><span id="l3.35">     const flavors = [&quot;text/calendar&quot;, &quot;text/unicode&quot;];</span>
<a href="#l3.36"></a><span id="l3.36">     return getClipboard().hasDataMatchingFlavors(flavors,</span>
<a href="#l3.37"></a><span id="l3.37">                                                  flavors.length,</span>
<a href="#l3.38"></a><span id="l3.38">                                                  Components.interfaces.nsIClipboard.kGlobalClipboard);</span>
<a href="#l3.39"></a><span id="l3.39"> }</span>
<a href="#l3.40"></a><span id="l3.40"> </span>
<a href="#l3.41"></a><span id="l3.41"> /**</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">- * Copy iCalendar data to the Clipboard, and delete the selected items. Does</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">- * not use calendarItemArray parameter, because selected items are deleted.</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+ * Copy the ics data of the current view's selected events to the clipboard and</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+ * deletes the events on success</span>
<a href="#l3.46"></a><span id="l3.46">  */</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-function cutToClipboard(/* calendarItemArray */) {</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+function cutToClipboard() {</span>
<a href="#l3.49"></a><span id="l3.49">     let calendarItemArray = currentView().getSelectedItems({});</span>
<a href="#l3.50"></a><span id="l3.50"> </span>
<a href="#l3.51"></a><span id="l3.51">     if (copyToClipboard(calendarItemArray)) {</span>
<a href="#l3.52"></a><span id="l3.52">         deleteSelectedEvents();</span>
<a href="#l3.53"></a><span id="l3.53">     }</span>
<a href="#l3.54"></a><span id="l3.54"> }</span>
<a href="#l3.55"></a><span id="l3.55"> </span>
<a href="#l3.56"></a><span id="l3.56"> /**</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">- * Copy iCalendar data to the Clipboard. The data is copied to both</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">- * text/calendar and text/unicode.</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+ * Copy the ics data of the items in calendarItemArray to the clipboard. Fills</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+ * both text/unicode and text/calendar mime types.</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+ *</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+ * @param calendarItemArray     (optional) an array of items to copy. If not</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+ *                                passed, the current view's selected items will</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+ *                                be used.</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+ * @return                      A boolean indicating if the operation succeeded.</span>
<a href="#l3.66"></a><span id="l3.66">  */</span>
<a href="#l3.67"></a><span id="l3.67"> function copyToClipboard(calendarItemArray) {</span>
<a href="#l3.68"></a><span id="l3.68">     if (!calendarItemArray) {</span>
<a href="#l3.69"></a><span id="l3.69">         calendarItemArray = currentView().getSelectedItems({});</span>
<a href="#l3.70"></a><span id="l3.70">     }</span>
<a href="#l3.71"></a><span id="l3.71"> </span>
<a href="#l3.72"></a><span id="l3.72">     if (!calendarItemArray.length) {</span>
<a href="#l3.73"></a><span id="l3.73">         return false;</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineat">@@ -120,18 +132,18 @@ function copyToClipboard(calendarItemArr</span>
<a href="#l3.75"></a><span id="l3.75">                           Components.interfaces.nsIClipboard.kGlobalClipboard);</span>
<a href="#l3.76"></a><span id="l3.76"> </span>
<a href="#l3.77"></a><span id="l3.77">         return true;</span>
<a href="#l3.78"></a><span id="l3.78">     }</span>
<a href="#l3.79"></a><span id="l3.79">     return false;</span>
<a href="#l3.80"></a><span id="l3.80"> }</span>
<a href="#l3.81"></a><span id="l3.81"> </span>
<a href="#l3.82"></a><span id="l3.82"> /**</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">- * Paste iCalendar data from the clipboard, or paste clipboard text into</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">- * description of new item.</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+ * Reads ics data from the clipboard, parses it into items and inserts the items</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+ * into the currently selected calendar.</span>
<a href="#l3.87"></a><span id="l3.87">  */</span>
<a href="#l3.88"></a><span id="l3.88"> function pasteFromClipboard() {</span>
<a href="#l3.89"></a><span id="l3.89">     if (!canPaste()) {</span>
<a href="#l3.90"></a><span id="l3.90">         return;</span>
<a href="#l3.91"></a><span id="l3.91">     }</span>
<a href="#l3.92"></a><span id="l3.92"> </span>
<a href="#l3.93"></a><span id="l3.93">     let clipboard = getClipboard();</span>
<a href="#l3.94"></a><span id="l3.94">     let trans = Components.classes[&quot;@mozilla.org/widget/transferable;1&quot;]</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineat">@@ -161,17 +173,17 @@ function pasteFromClipboard() {</span>
<a href="#l3.96"></a><span id="l3.96">                 return;</span>
<a href="#l3.97"></a><span id="l3.97">             }</span>
<a href="#l3.98"></a><span id="l3.98"> </span>
<a href="#l3.99"></a><span id="l3.99">             let icsParser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l3.100"></a><span id="l3.100">                                       .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l3.101"></a><span id="l3.101">             try {</span>
<a href="#l3.102"></a><span id="l3.102">                 icsParser.parseString(data, null);</span>
<a href="#l3.103"></a><span id="l3.103">             } catch(e) {}</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineminus">-            </span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+</span>
<a href="#l3.106"></a><span id="l3.106">             let items = icsParser.getItems({});</span>
<a href="#l3.107"></a><span id="l3.107">             if (items.length == 0) {</span>
<a href="#l3.108"></a><span id="l3.108">                 return;</span>
<a href="#l3.109"></a><span id="l3.109">             }</span>
<a href="#l3.110"></a><span id="l3.110"> </span>
<a href="#l3.111"></a><span id="l3.111">             // If there are multiple items on the clipboard, the earliest</span>
<a href="#l3.112"></a><span id="l3.112">             // should be set to the selected day and the rest adjusted.</span>
<a href="#l3.113"></a><span id="l3.113">             let earliestDate = null;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/content/calendar-common-sets.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/content/calendar-common-sets.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -29,16 +29,20 @@</span>
<a href="#l4.4"></a><span id="l4.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l4.5"></a><span id="l4.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l4.6"></a><span id="l4.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l4.7"></a><span id="l4.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l4.8"></a><span id="l4.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.9"></a><span id="l4.9">  *</span>
<a href="#l4.10"></a><span id="l4.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+/**</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+ * Command controller to execute calendar specific commands</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+ * @see nsICommandController</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+ */</span>
<a href="#l4.16"></a><span id="l4.16"> var calendarController = {</span>
<a href="#l4.17"></a><span id="l4.17">     defaultController: null,</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19">     commands: {</span>
<a href="#l4.20"></a><span id="l4.20">         // Common commands</span>
<a href="#l4.21"></a><span id="l4.21">         &quot;calendar_new_event_command&quot;: true,</span>
<a href="#l4.22"></a><span id="l4.22">         &quot;calendar_modify_event_command&quot;: true,</span>
<a href="#l4.23"></a><span id="l4.23">         &quot;calendar_delete_event_command&quot;: true,</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineat">@@ -200,17 +204,17 @@ var calendarController = {</span>
<a href="#l4.25"></a><span id="l4.25">                         return false;</span>
<a href="#l4.26"></a><span id="l4.26">                     case &quot;button_delete&quot;:</span>
<a href="#l4.27"></a><span id="l4.27">                     case &quot;cmd_delete&quot;:</span>
<a href="#l4.28"></a><span id="l4.28">                         return this.item_selected;</span>
<a href="#l4.29"></a><span id="l4.29">                 }</span>
<a href="#l4.30"></a><span id="l4.30">                 if (aCommand in this.commands) {</span>
<a href="#l4.31"></a><span id="l4.31">                     // All other commands we support should be enabled by default</span>
<a href="#l4.32"></a><span id="l4.32">                     return true;</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-                }            </span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+                }</span>
<a href="#l4.35"></a><span id="l4.35">         }</span>
<a href="#l4.36"></a><span id="l4.36">         return false;</span>
<a href="#l4.37"></a><span id="l4.37">     },</span>
<a href="#l4.38"></a><span id="l4.38"> </span>
<a href="#l4.39"></a><span id="l4.39">     doCommand: function cC_doCommand(aCommand) {</span>
<a href="#l4.40"></a><span id="l4.40">         switch (aCommand) {</span>
<a href="#l4.41"></a><span id="l4.41">             // Common Commands</span>
<a href="#l4.42"></a><span id="l4.42">             case &quot;calendar_new_event_command&quot;:</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineat">@@ -303,17 +307,17 @@ var calendarController = {</span>
<a href="#l4.44"></a><span id="l4.44">                 break;</span>
<a href="#l4.45"></a><span id="l4.45">             default:</span>
<a href="#l4.46"></a><span id="l4.46">                 if (this.defaultController &amp;&amp; !this.isCalendarInForeground()) {</span>
<a href="#l4.47"></a><span id="l4.47">                     // If calendar is not in foreground, let the default controller take</span>
<a href="#l4.48"></a><span id="l4.48">                     // care. If we don't have a default controller (i.e sunbird), just</span>
<a href="#l4.49"></a><span id="l4.49">                     // continue.</span>
<a href="#l4.50"></a><span id="l4.50">                     this.defaultController.doCommand(aCommand);</span>
<a href="#l4.51"></a><span id="l4.51">                     return;</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-                }                </span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+                }</span>
<a href="#l4.54"></a><span id="l4.54">                 switch (aCommand) {</span>
<a href="#l4.55"></a><span id="l4.55">                     // These commands are overridden in lightning and native in sunbird.</span>
<a href="#l4.56"></a><span id="l4.56">                     case &quot;cmd_cut&quot;:</span>
<a href="#l4.57"></a><span id="l4.57">                         cutToClipboard();</span>
<a href="#l4.58"></a><span id="l4.58">                         break;</span>
<a href="#l4.59"></a><span id="l4.59">                     case &quot;cmd_copy&quot;:</span>
<a href="#l4.60"></a><span id="l4.60">                         copyToClipboard();</span>
<a href="#l4.61"></a><span id="l4.61">                         break;</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineat">@@ -356,17 +360,17 @@ var calendarController = {</span>
<a href="#l4.63"></a><span id="l4.63">         // For sunbird, calendar is always in foreground. Otherwise check if</span>
<a href="#l4.64"></a><span id="l4.64">         // we are in the correct mode.</span>
<a href="#l4.65"></a><span id="l4.65">         return isSunbird() || (gCurrentMode &amp;&amp; gCurrentMode != &quot;mail&quot;);</span>
<a href="#l4.66"></a><span id="l4.66">     },</span>
<a href="#l4.67"></a><span id="l4.67"> </span>
<a href="#l4.68"></a><span id="l4.68">     onSelectionChanged: function cC_onSelectionChanged(aEvent) {</span>
<a href="#l4.69"></a><span id="l4.69">         var selectedItems = aEvent.detail;</span>
<a href="#l4.70"></a><span id="l4.70">         calendarController.item_selected = selectedItems &amp;&amp; (selectedItems.length &gt; 0);</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineminus">-        </span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+</span>
<a href="#l4.73"></a><span id="l4.73">         var selLength = (selectedItems === undefined ? 0 : selectedItems.length);</span>
<a href="#l4.74"></a><span id="l4.74">         var selected_events_readonly = 0;</span>
<a href="#l4.75"></a><span id="l4.75">         var selected_events_requires_network = 0;</span>
<a href="#l4.76"></a><span id="l4.76">         if (selLength &gt; 0) {</span>
<a href="#l4.77"></a><span id="l4.77">             for each (var item in selectedItems) {</span>
<a href="#l4.78"></a><span id="l4.78">                 if (item.calendar.readOnly) {</span>
<a href="#l4.79"></a><span id="l4.79">                     selected_events_readonly++;</span>
<a href="#l4.80"></a><span id="l4.80">                 }</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineat">@@ -381,116 +385,165 @@ var calendarController = {</span>
<a href="#l4.82"></a><span id="l4.82"> </span>
<a href="#l4.83"></a><span id="l4.83">         calendarController.selected_events_requires_network =</span>
<a href="#l4.84"></a><span id="l4.84">               (selected_events_requires_network == selLength);</span>
<a href="#l4.85"></a><span id="l4.85">         document.commandDispatcher.updateCommands(&quot;calendar_commands&quot;);</span>
<a href="#l4.86"></a><span id="l4.86">         if(!isSunbird()) {</span>
<a href="#l4.87"></a><span id="l4.87">             document.commandDispatcher.updateCommands('mail-toolbar');</span>
<a href="#l4.88"></a><span id="l4.88">         }</span>
<a href="#l4.89"></a><span id="l4.89">     },</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineminus">-    </span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+</span>
<a href="#l4.92"></a><span id="l4.92">     /**</span>
<a href="#l4.93"></a><span id="l4.93">      * Condition Helpers</span>
<a href="#l4.94"></a><span id="l4.94">      */</span>
<a href="#l4.95"></a><span id="l4.95"> </span>
<a href="#l4.96"></a><span id="l4.96" class="difflineminus">-    // This will be set up manually.</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+    // These attributes will be set up manually.</span>
<a href="#l4.98"></a><span id="l4.98">     item_selected: false,</span>
<a href="#l4.99"></a><span id="l4.99">     selected_events_readonly: false,</span>
<a href="#l4.100"></a><span id="l4.100">     selected_events_requires_network: false,</span>
<a href="#l4.101"></a><span id="l4.101"> </span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+    /**</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+     * Returns a boolean indicating if its possible to write items to any</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+     * calendar.</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+     */</span>
<a href="#l4.106"></a><span id="l4.106">     get writable() {</span>
<a href="#l4.107"></a><span id="l4.107">         return !this.all_readonly &amp;&amp;</span>
<a href="#l4.108"></a><span id="l4.108">                (!this.offline || (this.has_local_calendars &amp;&amp;</span>
<a href="#l4.109"></a><span id="l4.109">                !this.all_local_calendars_readonly));</span>
<a href="#l4.110"></a><span id="l4.110">     },</span>
<a href="#l4.111"></a><span id="l4.111"> </span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+    /**</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+     * Returns a boolean indicating if the application is currently in offline</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+     * mode.</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+     */</span>
<a href="#l4.116"></a><span id="l4.116">     get offline() {</span>
<a href="#l4.117"></a><span id="l4.117">         return getIOService().offline;</span>
<a href="#l4.118"></a><span id="l4.118">     },</span>
<a href="#l4.119"></a><span id="l4.119"> </span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+    /**</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+     * Returns a boolean indicating if all calendars are readonly.</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+     */</span>
<a href="#l4.123"></a><span id="l4.123">     get all_readonly () {</span>
<a href="#l4.124"></a><span id="l4.124">         var calMgr = getCalendarManager();</span>
<a href="#l4.125"></a><span id="l4.125">         return (calMgr.readOnlyCalendarCount == calMgr.calendarCount);</span>
<a href="#l4.126"></a><span id="l4.126">     },</span>
<a href="#l4.127"></a><span id="l4.127"> </span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+    /**</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+     * Returns a boolean indicating if all calendars are local</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+     */</span>
<a href="#l4.131"></a><span id="l4.131">     get no_network_calendars() {</span>
<a href="#l4.132"></a><span id="l4.132">         return (getCalendarManager().networkCalendarCount == 0);</span>
<a href="#l4.133"></a><span id="l4.133">     },</span>
<a href="#l4.134"></a><span id="l4.134"> </span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+    /**</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+     * Returns a boolean indicating if there are calendars that don't require</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+     * network access.</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+     */</span>
<a href="#l4.139"></a><span id="l4.139">     get has_local_calendars() {</span>
<a href="#l4.140"></a><span id="l4.140">         var calMgr = getCalendarManager();</span>
<a href="#l4.141"></a><span id="l4.141">         return (calMgr.networkCalendarCount &lt; calMgr.calendarCount);</span>
<a href="#l4.142"></a><span id="l4.142">     },</span>
<a href="#l4.143"></a><span id="l4.143"> </span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+    /**</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+     * Returns a boolean indicating that there is only one calendar left.</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+     */</span>
<a href="#l4.147"></a><span id="l4.147">     get last_calendar() {</span>
<a href="#l4.148"></a><span id="l4.148">         return (getCalendarManager().calendarCount &lt; 2);</span>
<a href="#l4.149"></a><span id="l4.149">     },</span>
<a href="#l4.150"></a><span id="l4.150"> </span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+    /**</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+     * Returns a boolean indicating that all local calendars are readonly</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+     */</span>
<a href="#l4.154"></a><span id="l4.154">     get all_local_calendars_readonly() {</span>
<a href="#l4.155"></a><span id="l4.155">         // We might want to speed this part up by keeping track of this in the</span>
<a href="#l4.156"></a><span id="l4.156">         // calendar manager.</span>
<a href="#l4.157"></a><span id="l4.157">         var cals = getCalendarManager().getCalendars({});</span>
<a href="#l4.158"></a><span id="l4.158">         var count = cals.length;</span>
<a href="#l4.159"></a><span id="l4.159">         for each (var cal in cals) {</span>
<a href="#l4.160"></a><span id="l4.160">             if (!isCalendarWritable(cal)) {</span>
<a href="#l4.161"></a><span id="l4.161">                 count--;</span>
<a href="#l4.162"></a><span id="l4.162">             }</span>
<a href="#l4.163"></a><span id="l4.163">         }</span>
<a href="#l4.164"></a><span id="l4.164">         return (count == 0);</span>
<a href="#l4.165"></a><span id="l4.165">     },</span>
<a href="#l4.166"></a><span id="l4.166"> </span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+    /**</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineplus">+     * Returns a boolean indicating if the items selected in the current view</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineplus">+     * all have writable calendars.</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineplus">+     */</span>
<a href="#l4.171"></a><span id="l4.171">     get selected_items_writable() {</span>
<a href="#l4.172"></a><span id="l4.172">         return this.writable &amp;&amp;</span>
<a href="#l4.173"></a><span id="l4.173">                this.item_selected &amp;&amp;</span>
<a href="#l4.174"></a><span id="l4.174">                !this.selected_events_readonly &amp;&amp;</span>
<a href="#l4.175"></a><span id="l4.175">                (!this.offline || !this.selected_events_requires_network);</span>
<a href="#l4.176"></a><span id="l4.176">     },</span>
<a href="#l4.177"></a><span id="l4.177"> </span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+    /**</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+     * Returns a boolean indicating that at least one of the calendars supports</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineplus">+     * tasks.</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+     */</span>
<a href="#l4.182"></a><span id="l4.182">     get calendars_support_tasks() {</span>
<a href="#l4.183"></a><span id="l4.183">         // XXX We might want to cache this</span>
<a href="#l4.184"></a><span id="l4.184">         var calendars = getCalendarManager().getCalendars({});</span>
<a href="#l4.185"></a><span id="l4.185"> </span>
<a href="#l4.186"></a><span id="l4.186">         for each (var cal in calendars) {</span>
<a href="#l4.187"></a><span id="l4.187">             if (isCalendarWritable(cal) &amp;&amp;</span>
<a href="#l4.188"></a><span id="l4.188">                 cal.getProperty(&quot;capabilities.tasks.supported&quot;) !== false) {</span>
<a href="#l4.189"></a><span id="l4.189">                 return true;</span>
<a href="#l4.190"></a><span id="l4.190">             }</span>
<a href="#l4.191"></a><span id="l4.191">         }</span>
<a href="#l4.192"></a><span id="l4.192">         return false;</span>
<a href="#l4.193"></a><span id="l4.193">     },</span>
<a href="#l4.194"></a><span id="l4.194"> </span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineplus">+    /**</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+     * Returns a boolean indicating that at least one of the calendars supports</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineplus">+     * events.</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineplus">+     */</span>
<a href="#l4.200"></a><span id="l4.200">     get calendars_support_events() {</span>
<a href="#l4.201"></a><span id="l4.201">         // XXX We might want to cache this</span>
<a href="#l4.202"></a><span id="l4.202">         var calendars = getCalendarManager().getCalendars({});</span>
<a href="#l4.203"></a><span id="l4.203"> </span>
<a href="#l4.204"></a><span id="l4.204">         for each (var cal in calendars) {</span>
<a href="#l4.205"></a><span id="l4.205">             if (isCalendarWritable(cal) &amp;&amp;</span>
<a href="#l4.206"></a><span id="l4.206">                 cal.getProperty(&quot;capabilities.events.supported&quot;) !== false) {</span>
<a href="#l4.207"></a><span id="l4.207">                 return true;</span>
<a href="#l4.208"></a><span id="l4.208">             }</span>
<a href="#l4.209"></a><span id="l4.209">         }</span>
<a href="#l4.210"></a><span id="l4.210">         return false;</span>
<a href="#l4.211"></a><span id="l4.211">     },</span>
<a href="#l4.212"></a><span id="l4.212"> </span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+    /**</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+     * Returns a boolean indicating that tasks are selected.</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineplus">+     */</span>
<a href="#l4.216"></a><span id="l4.216">     get todo_items_selected cC_todo_items_selected() {</span>
<a href="#l4.217"></a><span id="l4.217">         var selectedTasks = getSelectedTasks();</span>
<a href="#l4.218"></a><span id="l4.218">         return (selectedTasks.length &gt; 0);</span>
<a href="#l4.219"></a><span id="l4.219">     },</span>
<a href="#l4.220"></a><span id="l4.220"> </span>
<a href="#l4.221"></a><span id="l4.221" class="difflineplus">+    /**</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineplus">+     * Returns a boolean indicating that at least one task in the selection is</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineplus">+     * on a calendar that is writable.</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineplus">+     */</span>
<a href="#l4.225"></a><span id="l4.225">     get todo_items_writable cC_todo_items_writable() {</span>
<a href="#l4.226"></a><span id="l4.226">         var selectedTasks = getSelectedTasks();</span>
<a href="#l4.227"></a><span id="l4.227">         for each (var task in selectedTasks) {</span>
<a href="#l4.228"></a><span id="l4.228">             if (isCalendarWritable(task.calendar)) {</span>
<a href="#l4.229"></a><span id="l4.229">                 return true;</span>
<a href="#l4.230"></a><span id="l4.230">             }</span>
<a href="#l4.231"></a><span id="l4.231">         }</span>
<a href="#l4.232"></a><span id="l4.232">         return false;</span>
<a href="#l4.233"></a><span id="l4.233">     }</span>
<a href="#l4.234"></a><span id="l4.234"> };</span>
<a href="#l4.235"></a><span id="l4.235"> </span>
<a href="#l4.236"></a><span id="l4.236" class="difflineplus">+/**</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineplus">+ * Inserts the command controller into the document. On Lightning, also make</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineplus">+ * sure that it is inserted before the conflicting thunderbird command</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineplus">+ * controller.</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineplus">+ */</span>
<a href="#l4.241"></a><span id="l4.241"> function injectCalendarCommandController() {</span>
<a href="#l4.242"></a><span id="l4.242">     if (!isSunbird()) {</span>
<a href="#l4.243"></a><span id="l4.243">         // We need to put our new command controller *before* the one that</span>
<a href="#l4.244"></a><span id="l4.244">         // gets installed by thunderbird. Since we get called pretty early</span>
<a href="#l4.245"></a><span id="l4.245">         // during startup we need to install the function below as a callback</span>
<a href="#l4.246"></a><span id="l4.246">         // that periodically checks when the original thunderbird controller</span>
<a href="#l4.247"></a><span id="l4.247">         // gets alive. Please note that setTimeout with a value of 0 means that</span>
<a href="#l4.248"></a><span id="l4.248">         // we leave the current thread in order to re-enter the message loop.</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineat">@@ -503,45 +556,64 @@ function injectCalendarCommandController</span>
<a href="#l4.250"></a><span id="l4.250">             calendarController.defaultController = tbController;</span>
<a href="#l4.251"></a><span id="l4.251">             ltnInitializeMenus();</span>
<a href="#l4.252"></a><span id="l4.252">         }</span>
<a href="#l4.253"></a><span id="l4.253">     }</span>
<a href="#l4.254"></a><span id="l4.254">     top.controllers.insertControllerAt(0, calendarController);</span>
<a href="#l4.255"></a><span id="l4.255">     document.commandDispatcher.updateCommands(&quot;calendar_commands&quot;);</span>
<a href="#l4.256"></a><span id="l4.256"> }</span>
<a href="#l4.257"></a><span id="l4.257"> </span>
<a href="#l4.258"></a><span id="l4.258" class="difflineplus">+/**</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineplus">+ * Remove the calendar command controller from the document.</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineplus">+ */</span>
<a href="#l4.261"></a><span id="l4.261"> function removeCalendarCommandController() {</span>
<a href="#l4.262"></a><span id="l4.262">     top.controllers.removeController(calendarController);</span>
<a href="#l4.263"></a><span id="l4.263"> }</span>
<a href="#l4.264"></a><span id="l4.264"> </span>
<a href="#l4.265"></a><span id="l4.265" class="difflineminus">-function adaptModificationMenuItem(aMenuItemId, aItemType) {</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineminus">-    var menuItem = document.getElementById(aMenuItemId);</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineminus">-    if (menuItem) {</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineminus">-        menuItem.setAttribute(&quot;label&quot;, calGetString(&quot;calendar&quot;, &quot;delete&quot; + aItemType + &quot;Label&quot;));</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineminus">-        menuItem.setAttribute(&quot;accesskey&quot;, calGetString(&quot;calendar&quot;, &quot;delete&quot; + aItemType + &quot;Accesskey&quot;));</span>
<a href="#l4.270"></a><span id="l4.270" class="difflineplus">+/**</span>
<a href="#l4.271"></a><span id="l4.271" class="difflineplus">+ * Handler function to set up the item context menu, depending on the given</span>
<a href="#l4.272"></a><span id="l4.272" class="difflineplus">+ * items. Changes the delete menuitem to fit the passed items.</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineplus">+ *</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineplus">+ * @param event         The DOM popupshowing event that is triggered by opening</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineplus">+ *                        the context menu.</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineplus">+ * @param items         An array of items (usually the selected items) to adapt</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineplus">+ *                        the context menu for.</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineplus">+ * @return              True, to show the popup menu.</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineplus">+ */</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineplus">+function setupContextItemType(event, items) {</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineplus">+    function adaptModificationMenuItem(aMenuItemId, aItemType) {</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineplus">+        let menuItem = document.getElementById(aMenuItemId);</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineplus">+        if (menuItem) {</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineplus">+            menuItem.setAttribute(&quot;label&quot;, calGetString(&quot;calendar&quot;, &quot;delete&quot; + aItemType + &quot;Label&quot;));</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineplus">+            menuItem.setAttribute(&quot;accesskey&quot;, calGetString(&quot;calendar&quot;, &quot;delete&quot; + aItemType + &quot;Accesskey&quot;));</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineplus">+        }</span>
<a href="#l4.287"></a><span id="l4.287">     }</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineminus">-}</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineminus">-</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineminus">-function setupContextItemType(event, items) {</span>
<a href="#l4.291"></a><span id="l4.291">     if (items.some(isEvent) &amp;&amp; items.some(isToDo)) {</span>
<a href="#l4.292"></a><span id="l4.292">         event.target.setAttribute(&quot;type&quot;, &quot;mixed&quot;);</span>
<a href="#l4.293"></a><span id="l4.293">         adaptModificationMenuItem(&quot;calendar-item-context-menu-delete-menuitem&quot;, &quot;Item&quot;);</span>
<a href="#l4.294"></a><span id="l4.294">     } else if (items.length &amp;&amp; isEvent(items[0])) {</span>
<a href="#l4.295"></a><span id="l4.295">         event.target.setAttribute(&quot;type&quot;, &quot;event&quot;);</span>
<a href="#l4.296"></a><span id="l4.296">         adaptModificationMenuItem(&quot;calendar-item-context-menu-delete-menuitem&quot;, &quot;Event&quot;);</span>
<a href="#l4.297"></a><span id="l4.297">     } else if (items.length &amp;&amp; isToDo(items[0])) {</span>
<a href="#l4.298"></a><span id="l4.298">         event.target.setAttribute(&quot;type&quot;, &quot;todo&quot;);</span>
<a href="#l4.299"></a><span id="l4.299">         adaptModificationMenuItem(&quot;calendar-item-context-menu-delete-menuitem&quot;, &quot;Task&quot;);</span>
<a href="#l4.300"></a><span id="l4.300">     } else {</span>
<a href="#l4.301"></a><span id="l4.301">         event.target.removeAttribute(&quot;type&quot;);</span>
<a href="#l4.302"></a><span id="l4.302">         adaptModificationMenuItem(&quot;calendar-item-context-menu-delete-menuitem&quot;, &quot;Item&quot;);</span>
<a href="#l4.303"></a><span id="l4.303">     }</span>
<a href="#l4.304"></a><span id="l4.304">     return true;</span>
<a href="#l4.305"></a><span id="l4.305"> }</span>
<a href="#l4.306"></a><span id="l4.306"> </span>
<a href="#l4.307"></a><span id="l4.307" class="difflineplus">+/**</span>
<a href="#l4.308"></a><span id="l4.308" class="difflineplus">+ * Shows the given date in the current view, if in calendar mode.</span>
<a href="#l4.309"></a><span id="l4.309" class="difflineplus">+ *</span>
<a href="#l4.310"></a><span id="l4.310" class="difflineplus">+ * XXX This function is misplaced, should go to calendar-views.js or a minimonth</span>
<a href="#l4.311"></a><span id="l4.311" class="difflineplus">+ * specific js file.</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineplus">+ *</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineplus">+ * @param aNewDate      The new date as a JSDate.</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineplus">+ */</span>
<a href="#l4.315"></a><span id="l4.315"> function minimonthPick(aNewDate) {</span>
<a href="#l4.316"></a><span id="l4.316">   if (isSunbird() || gCurrentMode == &quot;calendar&quot;) {</span>
<a href="#l4.317"></a><span id="l4.317">       let cdt = jsDateToDateTime(aNewDate, currentView().timezone);</span>
<a href="#l4.318"></a><span id="l4.318">       cdt.isDate = true;</span>
<a href="#l4.319"></a><span id="l4.319">       currentView().goToDay(cdt);</span>
<a href="#l4.320"></a><span id="l4.320">   }</span>
<a href="#l4.321"></a><span id="l4.321"> }</span>
<a href="#l4.322"></a><span id="l4.322" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/content/calendar-invitations-manager.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/content/calendar-invitations-manager.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -34,44 +34,68 @@</span>
<a href="#l5.4"></a><span id="l5.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l5.5"></a><span id="l5.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l5.6"></a><span id="l5.6">  *</span>
<a href="#l5.7"></a><span id="l5.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l5.10"></a><span id="l5.10"> Components.utils.import(&quot;resource://calendar/modules/calItipUtils.jsm&quot;);</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+/**</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+ * This object contains functions to take care of manipulating requests.</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+ */</span>
<a href="#l5.15"></a><span id="l5.15"> var gInvitationsRequestManager = {</span>
<a href="#l5.16"></a><span id="l5.16">     mRequestStatusList: {},</span>
<a href="#l5.17"></a><span id="l5.17"> </span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+    /**</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+     * Add a request to the request manager.</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+     *</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+     * @param calendar    The calendar to add for.</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+     * @param op          The operation to add</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+     */</span>
<a href="#l5.24"></a><span id="l5.24">     addRequestStatus: function IRM_addRequestStatus(calendar, op) {</span>
<a href="#l5.25"></a><span id="l5.25">         if (op) {</span>
<a href="#l5.26"></a><span id="l5.26">             this.mRequestStatusList[calendar.id] = op;</span>
<a href="#l5.27"></a><span id="l5.27">         }</span>
<a href="#l5.28"></a><span id="l5.28">     },</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+    /**</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+     * Cancel all pending requests</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+     */</span>
<a href="#l5.33"></a><span id="l5.33">     cancelPendingRequests: function IRM_cancelPendingRequests() {</span>
<a href="#l5.34"></a><span id="l5.34">         for each (var request in this.mRequestStatusList) {</span>
<a href="#l5.35"></a><span id="l5.35">             if (request &amp;&amp; request.isPending) {</span>
<a href="#l5.36"></a><span id="l5.36">                 request.cancel(null);</span>
<a href="#l5.37"></a><span id="l5.37">             }</span>
<a href="#l5.38"></a><span id="l5.38">         }</span>
<a href="#l5.39"></a><span id="l5.39">         this.mRequestStatusList = {};</span>
<a href="#l5.40"></a><span id="l5.40">     }</span>
<a href="#l5.41"></a><span id="l5.41"> };</span>
<a href="#l5.42"></a><span id="l5.42"> </span>
<a href="#l5.43"></a><span id="l5.43"> var gInvitationsManager = null;</span>
<a href="#l5.44"></a><span id="l5.44"> </span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+/**</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+ * Return a cached instance of the invitations manager</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+ *</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+ * @return      The invitations manager instance.</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+ */</span>
<a href="#l5.50"></a><span id="l5.50"> function getInvitationsManager() {</span>
<a href="#l5.51"></a><span id="l5.51">     if (!gInvitationsManager) {</span>
<a href="#l5.52"></a><span id="l5.52">         gInvitationsManager = new InvitationsManager();</span>
<a href="#l5.53"></a><span id="l5.53">     }</span>
<a href="#l5.54"></a><span id="l5.54">     return gInvitationsManager;</span>
<a href="#l5.55"></a><span id="l5.55"> }</span>
<a href="#l5.56"></a><span id="l5.56"> </span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+/**</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+ * The invitations manager class constructor</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+ *</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+ * XXX do we really need this to be an instance?</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+ *</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+ * @constructor</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+ */</span>
<a href="#l5.64"></a><span id="l5.64"> function InvitationsManager() {</span>
<a href="#l5.65"></a><span id="l5.65">     this.mItemList = new Array();</span>
<a href="#l5.66"></a><span id="l5.66">     this.mStartDate = null;</span>
<a href="#l5.67"></a><span id="l5.67">     this.mJobsPending = 0;</span>
<a href="#l5.68"></a><span id="l5.68">     this.mTimer = null;</span>
<a href="#l5.69"></a><span id="l5.69"> </span>
<a href="#l5.70"></a><span id="l5.70">     var self = this;</span>
<a href="#l5.71"></a><span id="l5.71">     window.addEventListener(&quot;unload&quot;, function() {</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineat">@@ -81,35 +105,52 @@ function InvitationsManager() {</span>
<a href="#l5.73"></a><span id="l5.73"> }</span>
<a href="#l5.74"></a><span id="l5.74"> </span>
<a href="#l5.75"></a><span id="l5.75"> InvitationsManager.prototype = {</span>
<a href="#l5.76"></a><span id="l5.76">     mItemList: null,</span>
<a href="#l5.77"></a><span id="l5.77">     mStartDate: null,</span>
<a href="#l5.78"></a><span id="l5.78">     mJobsPending: 0,</span>
<a href="#l5.79"></a><span id="l5.79">     mTimer: null,</span>
<a href="#l5.80"></a><span id="l5.80"> </span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+    /**</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+     * Schedule an update for the invitations manager asynchronously.</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+     *</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+     * @param firstDelay          The timeout before the operation should start.</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+     * @param operationListener   The calIGenericOperationListener to notify.</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+     */</span>
<a href="#l5.87"></a><span id="l5.87">     scheduleInvitationsUpdate: function IM_scheduleInvitationsUpdate(firstDelay,</span>
<a href="#l5.88"></a><span id="l5.88">                                                                      operationListener) {</span>
<a href="#l5.89"></a><span id="l5.89">         this.cancelInvitationsUpdate();</span>
<a href="#l5.90"></a><span id="l5.90"> </span>
<a href="#l5.91"></a><span id="l5.91">         var self = this;</span>
<a href="#l5.92"></a><span id="l5.92">         this.mTimer = setTimeout(function startInvitationsTimer() {</span>
<a href="#l5.93"></a><span id="l5.93">             if (getPrefSafe(&quot;calendar.invitations.autorefresh.enabled&quot;, true)) {</span>
<a href="#l5.94"></a><span id="l5.94">                 self.mTimer = setInterval(function repeatingInvitationsTimer() {</span>
<a href="#l5.95"></a><span id="l5.95">                     self.getInvitations(operationListener);</span>
<a href="#l5.96"></a><span id="l5.96">                     }, getPrefSafe(&quot;calendar.invitations.autorefresh.timeout&quot;, 3) * 60000);</span>
<a href="#l5.97"></a><span id="l5.97">             }</span>
<a href="#l5.98"></a><span id="l5.98">             self.getInvitations(operationListener);</span>
<a href="#l5.99"></a><span id="l5.99">         }, firstDelay);</span>
<a href="#l5.100"></a><span id="l5.100">     },</span>
<a href="#l5.101"></a><span id="l5.101"> </span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+    /**</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+     * Cancel pending any pending invitations update.</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+     */</span>
<a href="#l5.105"></a><span id="l5.105">     cancelInvitationsUpdate: function IM_cancelInvitationsUpdate() {</span>
<a href="#l5.106"></a><span id="l5.106">         clearTimeout(this.mTimer);</span>
<a href="#l5.107"></a><span id="l5.107">     },</span>
<a href="#l5.108"></a><span id="l5.108"> </span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+    /**</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+     * Retrieve invitations from all calendars. Notify all passed</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+     * operation listeners.</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+     *</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+     * @param operationListener1    The first operation listener to notify.</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+     * @param operationListener2    (optinal) The second operation listener to</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+     *                                notify.</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+     */</span>
<a href="#l5.117"></a><span id="l5.117">     getInvitations: function IM_getInvitations(operationListener1,</span>
<a href="#l5.118"></a><span id="l5.118">                                                operationListener2) {</span>
<a href="#l5.119"></a><span id="l5.119">         var listeners = [];</span>
<a href="#l5.120"></a><span id="l5.120">         if (operationListener1) {</span>
<a href="#l5.121"></a><span id="l5.121">             listeners.push(operationListener1);</span>
<a href="#l5.122"></a><span id="l5.122">         }</span>
<a href="#l5.123"></a><span id="l5.123">         if (operationListener2) {</span>
<a href="#l5.124"></a><span id="l5.124">             listeners.push(operationListener2);</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineat">@@ -210,16 +251,28 @@ InvitationsManager.prototype = {</span>
<a href="#l5.126"></a><span id="l5.126">                 gInvitationsRequestManager.addRequestStatus(calendar, op);</span>
<a href="#l5.127"></a><span id="l5.127">             } catch (exc) {</span>
<a href="#l5.128"></a><span id="l5.128">                 opListener.onOperationComplete();</span>
<a href="#l5.129"></a><span id="l5.129">                 ERROR(exc);</span>
<a href="#l5.130"></a><span id="l5.130">             }</span>
<a href="#l5.131"></a><span id="l5.131">         }</span>
<a href="#l5.132"></a><span id="l5.132">     },</span>
<a href="#l5.133"></a><span id="l5.133"> </span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+    /**</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+     * Open the invitations dialog, non-modal.</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+     *</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+     * XXX Passing these listeners in instead of keeping them in the window</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+     * sounds fishy to me. Maybe there is a more encapsulated solution.</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+     *</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineplus">+     * @param onLoadOpListener          The operation listener to notify when</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+     *                                    getting invitations. Should be passed</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+     *                                    to this.getInvitations().</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+     * @param finishedCallBack          A callback function to call when the</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+     *                                    dialog has completed.</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+     */</span>
<a href="#l5.146"></a><span id="l5.146">     openInvitationsDialog: function IM_openInvitationsDialog(onLoadOpListener,</span>
<a href="#l5.147"></a><span id="l5.147">                                                              finishedCallBack) {</span>
<a href="#l5.148"></a><span id="l5.148">         var args = new Object();</span>
<a href="#l5.149"></a><span id="l5.149">         args.onLoadOperationListener = onLoadOpListener;</span>
<a href="#l5.150"></a><span id="l5.150">         args.queue = new Array();</span>
<a href="#l5.151"></a><span id="l5.151">         args.finishedCallBack = finishedCallBack;</span>
<a href="#l5.152"></a><span id="l5.152">         args.requestManager = gInvitationsRequestManager;</span>
<a href="#l5.153"></a><span id="l5.153">         args.invitationsManager = this;</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineat">@@ -228,16 +281,25 @@ InvitationsManager.prototype = {</span>
<a href="#l5.155"></a><span id="l5.155">         // open the dialog</span>
<a href="#l5.156"></a><span id="l5.156">         window.openDialog(</span>
<a href="#l5.157"></a><span id="l5.157">             &quot;chrome://calendar/content/calendar-invitations-dialog.xul&quot;,</span>
<a href="#l5.158"></a><span id="l5.158">             &quot;_blank&quot;,</span>
<a href="#l5.159"></a><span id="l5.159">             &quot;chrome,titlebar,resizable&quot;,</span>
<a href="#l5.160"></a><span id="l5.160">             args);</span>
<a href="#l5.161"></a><span id="l5.161">     },</span>
<a href="#l5.162"></a><span id="l5.162"> </span>
<a href="#l5.163"></a><span id="l5.163" class="difflineplus">+    /**</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineplus">+     * Process the passed job queue. A job is an object that consists of an</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineplus">+     * action, a newItem and and oldItem. This processor only takes &quot;modify&quot;</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineplus">+     * operations into account.</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineplus">+     *</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineplus">+     * @param queue                         The array of objects to process.</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineplus">+     * @param jobQueueFinishedCallBack      A callback function called when</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineplus">+     *                                        job has finished.</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineplus">+     */</span>
<a href="#l5.172"></a><span id="l5.172">     processJobQueue: function IM_processJobQueue(queue,</span>
<a href="#l5.173"></a><span id="l5.173">                                                  jobQueueFinishedCallBack) {</span>
<a href="#l5.174"></a><span id="l5.174">         // TODO: undo/redo</span>
<a href="#l5.175"></a><span id="l5.175">         function operationListener(mgr, queueCallback, oldItem_) {</span>
<a href="#l5.176"></a><span id="l5.176">             this.mInvitationsManager = mgr;</span>
<a href="#l5.177"></a><span id="l5.177">             this.mJobQueueFinishedCallBack = queueCallback;</span>
<a href="#l5.178"></a><span id="l5.178">             this.mOldItem = oldItem_;</span>
<a href="#l5.179"></a><span id="l5.179">         }</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineat">@@ -286,71 +348,113 @@ InvitationsManager.prototype = {</span>
<a href="#l5.181"></a><span id="l5.181">                     break;</span>
<a href="#l5.182"></a><span id="l5.182">             }</span>
<a href="#l5.183"></a><span id="l5.183">         }</span>
<a href="#l5.184"></a><span id="l5.184">         if (this.mJobsPending == 0 &amp;&amp; jobQueueFinishedCallBack) {</span>
<a href="#l5.185"></a><span id="l5.185">             jobQueueFinishedCallBack();</span>
<a href="#l5.186"></a><span id="l5.186">         }</span>
<a href="#l5.187"></a><span id="l5.187">     },</span>
<a href="#l5.188"></a><span id="l5.188"> </span>
<a href="#l5.189"></a><span id="l5.189" class="difflineplus">+    /**</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineplus">+     * Checks if the internal item list contains the given item</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineplus">+     * XXXdbo       Please document these correctly.</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineplus">+     *</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineplus">+     * @param item      The item to look for.</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineplus">+     * @return          A boolean value indicating if the item was found.</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineplus">+     */</span>
<a href="#l5.196"></a><span id="l5.196">     hasItem: function IM_hasItem(item) {</span>
<a href="#l5.197"></a><span id="l5.197">         var hid = item.hashId;</span>
<a href="#l5.198"></a><span id="l5.198">         return this.mItemList.some(</span>
<a href="#l5.199"></a><span id="l5.199">             function someFunc(item_) {</span>
<a href="#l5.200"></a><span id="l5.200">                 return hid == item_.hashId;</span>
<a href="#l5.201"></a><span id="l5.201">             });</span>
<a href="#l5.202"></a><span id="l5.202">     },</span>
<a href="#l5.203"></a><span id="l5.203"> </span>
<a href="#l5.204"></a><span id="l5.204" class="difflineplus">+    /**</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineplus">+     * Adds an item to the internal item list.</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineplus">+     * XXXdbo       Please document these correctly.</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineplus">+     *</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineplus">+     * @param item      The item to add.</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineplus">+     */</span>
<a href="#l5.210"></a><span id="l5.210">     addItem: function IM_addItem(item) {</span>
<a href="#l5.211"></a><span id="l5.211">         var recInfo = item.recurrenceInfo;</span>
<a href="#l5.212"></a><span id="l5.212">         if (recInfo &amp;&amp; !cal.isOpenInvitation(item)) {</span>
<a href="#l5.213"></a><span id="l5.213">             // scan exceptions:</span>
<a href="#l5.214"></a><span id="l5.214">             var ids = recInfo.getExceptionIds({});</span>
<a href="#l5.215"></a><span id="l5.215">             for each (var id in ids) {</span>
<a href="#l5.216"></a><span id="l5.216">                 var ex = recInfo.getExceptionFor(id);</span>
<a href="#l5.217"></a><span id="l5.217">                 if (ex &amp;&amp; this.validateItem(ex) &amp;&amp; !this.hasItem(ex)) {</span>
<a href="#l5.218"></a><span id="l5.218">                     this.mItemList.push(ex);</span>
<a href="#l5.219"></a><span id="l5.219">                 }</span>
<a href="#l5.220"></a><span id="l5.220">             }</span>
<a href="#l5.221"></a><span id="l5.221">         } else if (this.validateItem(item) &amp;&amp; !this.hasItem(item)) {</span>
<a href="#l5.222"></a><span id="l5.222">             this.mItemList.push(item);</span>
<a href="#l5.223"></a><span id="l5.223">         }</span>
<a href="#l5.224"></a><span id="l5.224">     },</span>
<a href="#l5.225"></a><span id="l5.225"> </span>
<a href="#l5.226"></a><span id="l5.226" class="difflineplus">+    /**</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineplus">+     * Removes an item from the internal item list</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineplus">+     * XXXdbo       Please document these correctly.</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineplus">+     *</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineplus">+     * @param item      The item to remove.</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineplus">+     */</span>
<a href="#l5.232"></a><span id="l5.232">     deleteItem: function IM_deleteItem(item) {</span>
<a href="#l5.233"></a><span id="l5.233">         var id = item.id;</span>
<a href="#l5.234"></a><span id="l5.234">         this.mItemList.filter(</span>
<a href="#l5.235"></a><span id="l5.235">             function filterFunc(item_) {</span>
<a href="#l5.236"></a><span id="l5.236">                 return id != item_.id;</span>
<a href="#l5.237"></a><span id="l5.237">             });</span>
<a href="#l5.238"></a><span id="l5.238">     },</span>
<a href="#l5.239"></a><span id="l5.239"> </span>
<a href="#l5.240"></a><span id="l5.240" class="difflineplus">+    /**</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineplus">+     * Remove all items from the internal item list</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineplus">+     * XXXdbo       Please document these correctly.</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineplus">+     */</span>
<a href="#l5.244"></a><span id="l5.244">     deleteAllItems: function IM_deleteAllItems() {</span>
<a href="#l5.245"></a><span id="l5.245">         this.mItemList = [];</span>
<a href="#l5.246"></a><span id="l5.246">     },</span>
<a href="#l5.247"></a><span id="l5.247"> </span>
<a href="#l5.248"></a><span id="l5.248" class="difflineplus">+    /**</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineplus">+     * Helper function to create a start date to search from. This date is the</span>
<a href="#l5.250"></a><span id="l5.250" class="difflineplus">+     * current time with hour/minute/second set to zero.</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineplus">+     *</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineplus">+     * @return      Potential start date.</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineplus">+     */</span>
<a href="#l5.254"></a><span id="l5.254">     getStartDate: function IM_getStartDate() {</span>
<a href="#l5.255"></a><span id="l5.255">         var date = now();</span>
<a href="#l5.256"></a><span id="l5.256">         date.second = 0;</span>
<a href="#l5.257"></a><span id="l5.257">         date.minute = 0;</span>
<a href="#l5.258"></a><span id="l5.258">         date.hour = 0;</span>
<a href="#l5.259"></a><span id="l5.259">         return date;</span>
<a href="#l5.260"></a><span id="l5.260">     },</span>
<a href="#l5.261"></a><span id="l5.261"> </span>
<a href="#l5.262"></a><span id="l5.262" class="difflineplus">+    /**</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineplus">+     * Updates the start date for the invitations manager to the date returned</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineplus">+     * from this.getStartDate(), unless the previously existing start date is</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineplus">+     * the same or after what getStartDate() returned.</span>
<a href="#l5.266"></a><span id="l5.266" class="difflineplus">+     */</span>
<a href="#l5.267"></a><span id="l5.267">     updateStartDate: function IM_updateStartDate() {</span>
<a href="#l5.268"></a><span id="l5.268">         if (!this.mStartDate) {</span>
<a href="#l5.269"></a><span id="l5.269">             this.mStartDate = this.getStartDate();</span>
<a href="#l5.270"></a><span id="l5.270">         } else {</span>
<a href="#l5.271"></a><span id="l5.271">             var startDate = this.getStartDate();</span>
<a href="#l5.272"></a><span id="l5.272">             if (startDate.compare(this.mStartDate) &gt; 0) {</span>
<a href="#l5.273"></a><span id="l5.273">                 this.mStartDate = startDate;</span>
<a href="#l5.274"></a><span id="l5.274">             }</span>
<a href="#l5.275"></a><span id="l5.275">         }</span>
<a href="#l5.276"></a><span id="l5.276">     },</span>
<a href="#l5.277"></a><span id="l5.277"> </span>
<a href="#l5.278"></a><span id="l5.278" class="difflineplus">+    /**</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineplus">+     * Checks if the item is valid for the invitation manager. Checks if the</span>
<a href="#l5.280"></a><span id="l5.280" class="difflineplus">+     * item is in the range of the invitation manager and if the item is a valid</span>
<a href="#l5.281"></a><span id="l5.281" class="difflineplus">+     * invitation.</span>
<a href="#l5.282"></a><span id="l5.282" class="difflineplus">+     *</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineplus">+     * @param item      The item to check</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineplus">+     * @return          A boolean indicating if the item is a valid invitation.</span>
<a href="#l5.285"></a><span id="l5.285" class="difflineplus">+     */</span>
<a href="#l5.286"></a><span id="l5.286">     validateItem: function IM_validateItem(item) {</span>
<a href="#l5.287"></a><span id="l5.287">         if (item.calendar instanceof Components.interfaces.calISchedulingSupport &amp;&amp;</span>
<a href="#l5.288"></a><span id="l5.288">             !item.calendar.isInvitation(item)) {</span>
<a href="#l5.289"></a><span id="l5.289">             return false; // exclude if organizer has invited himself</span>
<a href="#l5.290"></a><span id="l5.290">         }</span>
<a href="#l5.291"></a><span id="l5.291">         var start = item[calGetStartDateProp(item)] || item[calGetEndDateProp(item)];</span>
<a href="#l5.292"></a><span id="l5.292">         return (cal.isOpenInvitation(item) &amp;&amp;</span>
<a href="#l5.293"></a><span id="l5.293">                 start.compare(this.mStartDate) &gt;= 0);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/base/content/calendar-item-editing.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/base/content/calendar-item-editing.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -32,17 +32,27 @@</span>
<a href="#l6.4"></a><span id="l6.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l6.5"></a><span id="l6.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l6.6"></a><span id="l6.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l6.7"></a><span id="l6.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l6.8"></a><span id="l6.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l6.9"></a><span id="l6.9">  *</span>
<a href="#l6.10"></a><span id="l6.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-/* all params are optional */</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+/**</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+ * Creates an event with the calendar event dialog.</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+ *</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+ * @param calendar      (optional) The calendar to create the event in</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+ * @param startDate     (optional) The event's start date.</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+ * @param endDate       (optional) The event's end date.</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+ * @param summary       (optional) The event's title.</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+ * @param event         (optional) A template event to show in the dialog</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+ * @param aForceAllDay  (optioanl) Make sure the event shown in the dialog is an</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+ *                                   allday event.</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+ */</span>
<a href="#l6.24"></a><span id="l6.24"> function createEventWithDialog(calendar, startDate, endDate, summary, event, aForceAllday) {</span>
<a href="#l6.25"></a><span id="l6.25">     const kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27">     var onNewEvent = function(item, calendar, originalItem, listener) {</span>
<a href="#l6.28"></a><span id="l6.28">         if (item.id) {</span>
<a href="#l6.29"></a><span id="l6.29">             // If the item already has an id, then this is the result of</span>
<a href="#l6.30"></a><span id="l6.30">             // saving the item without closing, and then saving again.</span>
<a href="#l6.31"></a><span id="l6.31">             doTransaction('modify', item, calendar, originalItem, listener);</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineat">@@ -124,16 +134,24 @@ function createEventWithDialog(calendar,</span>
<a href="#l6.33"></a><span id="l6.33">             event.title = summary;</span>
<a href="#l6.34"></a><span id="l6.34">         }</span>
<a href="#l6.35"></a><span id="l6.35"> </span>
<a href="#l6.36"></a><span id="l6.36">         setDefaultAlarmValues(event);</span>
<a href="#l6.37"></a><span id="l6.37">     }</span>
<a href="#l6.38"></a><span id="l6.38">     openEventDialog(event, calendar, &quot;new&quot;, onNewEvent, null);</span>
<a href="#l6.39"></a><span id="l6.39"> }</span>
<a href="#l6.40"></a><span id="l6.40"> </span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+/**</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+ * Creates a task with the calendar event dialog.</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+ *</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+ * @param calendar      (optional) The calendar to create the task in</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+ * @param dueDate       (optional) The task's due date.</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+ * @param summary       (optional) The task's title.</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+ * @param todo          (optional) A template task to show in the dialog.</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+ */</span>
<a href="#l6.49"></a><span id="l6.49"> function createTodoWithDialog(calendar, dueDate, summary, todo) {</span>
<a href="#l6.50"></a><span id="l6.50">     const kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l6.51"></a><span id="l6.51"> </span>
<a href="#l6.52"></a><span id="l6.52">     var onNewItem = function(item, calendar, originalItem, listener) {</span>
<a href="#l6.53"></a><span id="l6.53">         if (item.id) {</span>
<a href="#l6.54"></a><span id="l6.54">             // If the item already has an id, then this is the result of</span>
<a href="#l6.55"></a><span id="l6.55">             // saving the item without closing, and then saving again.</span>
<a href="#l6.56"></a><span id="l6.56">             doTransaction('modify', item, calendar, originalItem, listener);</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineat">@@ -167,16 +185,26 @@ function createTodoWithDialog(calendar, </span>
<a href="#l6.58"></a><span id="l6.58"> </span>
<a href="#l6.59"></a><span id="l6.59">         setDefaultAlarmValues(todo);</span>
<a href="#l6.60"></a><span id="l6.60">     }</span>
<a href="#l6.61"></a><span id="l6.61"> </span>
<a href="#l6.62"></a><span id="l6.62">     openEventDialog(todo, calendar, &quot;new&quot;, onNewItem, null);</span>
<a href="#l6.63"></a><span id="l6.63"> }</span>
<a href="#l6.64"></a><span id="l6.64"> </span>
<a href="#l6.65"></a><span id="l6.65"> </span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+/**</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+ * Modifies the passed event in the event dialog.</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+ *</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+ * @param aItem                 The item to modify.</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+ * @param job                   (optional) The job object that controlls this</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+ *                                           modification.</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+ * @param aPromptOccurrence     If the user should be prompted to select if the</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+ *                                parent item or occurrence should be modified.</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+ */</span>
<a href="#l6.76"></a><span id="l6.76"> function modifyEventWithDialog(aItem, job, aPromptOccurrence) {</span>
<a href="#l6.77"></a><span id="l6.77">     var onModifyItem = function(item, calendar, originalItem, listener) {</span>
<a href="#l6.78"></a><span id="l6.78">         doTransaction('modify', item, calendar, originalItem, listener);</span>
<a href="#l6.79"></a><span id="l6.79">     };</span>
<a href="#l6.80"></a><span id="l6.80"> </span>
<a href="#l6.81"></a><span id="l6.81">     var item = aItem;</span>
<a href="#l6.82"></a><span id="l6.82">     var futureItem, response;</span>
<a href="#l6.83"></a><span id="l6.83">     if (aPromptOccurrence !== false) {</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineat">@@ -186,16 +214,25 @@ function modifyEventWithDialog(aItem, jo</span>
<a href="#l6.85"></a><span id="l6.85">     if (item &amp;&amp; (response || response === undefined)) {</span>
<a href="#l6.86"></a><span id="l6.86">         openEventDialog(item, item.calendar, &quot;modify&quot;, onModifyItem, job);</span>
<a href="#l6.87"></a><span id="l6.87">     } else if (job &amp;&amp; job.dispose) {</span>
<a href="#l6.88"></a><span id="l6.88">         // If the action was canceled and there is a job, dispose it directly.</span>
<a href="#l6.89"></a><span id="l6.89">         job.dispose();</span>
<a href="#l6.90"></a><span id="l6.90">     }</span>
<a href="#l6.91"></a><span id="l6.91"> }</span>
<a href="#l6.92"></a><span id="l6.92"> </span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+/**</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+ * Opens the event dialog with the given item (task OR event)</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+ *</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+ * @param calendarItem      The item to open the dialog with</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+ * @param calendar          The calendar to open the dialog with.</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+ * @param mode              The operation the dialog should do (&quot;new&quot;, &quot;modify&quot;)</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+ * @param callback          The callback to call when the dialog has completed.</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+ * @param job               (optional) The job object for the modification.</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+ */</span>
<a href="#l6.102"></a><span id="l6.102"> function openEventDialog(calendarItem, calendar, mode, callback, job) {</span>
<a href="#l6.103"></a><span id="l6.103">     // Set up some defaults</span>
<a href="#l6.104"></a><span id="l6.104">     mode = mode || &quot;new&quot;;</span>
<a href="#l6.105"></a><span id="l6.105">     calendar = calendar || getSelectedCalendar();</span>
<a href="#l6.106"></a><span id="l6.106">     var calendars = getCalendarManager().getCalendars({});</span>
<a href="#l6.107"></a><span id="l6.107">     calendars = calendars.filter(isCalendarWritable);</span>
<a href="#l6.108"></a><span id="l6.108"> </span>
<a href="#l6.109"></a><span id="l6.109">     var isItemSupported;</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineat">@@ -342,58 +379,100 @@ function promptOccurrenceModification(aI</span>
<a href="#l6.111"></a><span id="l6.111">             // take care.</span>
<a href="#l6.112"></a><span id="l6.112">             break;</span>
<a href="#l6.113"></a><span id="l6.113">     }</span>
<a href="#l6.114"></a><span id="l6.114"> </span>
<a href="#l6.115"></a><span id="l6.115">     return [pastItem, futureItem, type];</span>
<a href="#l6.116"></a><span id="l6.116"> }</span>
<a href="#l6.117"></a><span id="l6.117"> </span>
<a href="#l6.118"></a><span id="l6.118"> // Undo/Redo code</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineplus">+</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineplus">+/**</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+ * Helper to return the transaction manager service.</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+ *</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+ * @return      The calITransactionManager service.</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+ */</span>
<a href="#l6.125"></a><span id="l6.125"> function getTransactionMgr() {</span>
<a href="#l6.126"></a><span id="l6.126">     return Components.classes[&quot;@mozilla.org/calendar/transactionmanager;1&quot;]</span>
<a href="#l6.127"></a><span id="l6.127">                      .getService(Components.interfaces.calITransactionManager);</span>
<a href="#l6.128"></a><span id="l6.128"> }</span>
<a href="#l6.129"></a><span id="l6.129"> </span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineplus">+/**</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+ * Create and commit a transaction with the given arguments to the transaction</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineplus">+ * manager. Also updates the undo/redo menu.</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineplus">+ *</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineplus">+ * @see                 calITransactionManager</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineplus">+ * @param aAction       The action to do.</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineplus">+ * @param aItem         The new item to add/modify/delete</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineplus">+ * @param aCalendar     The calendar to do the transaction on</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+ * @param aOldItem      (optional) some actions require an old item</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+ * @param aListener     (optional) the listener to call when complete.</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineplus">+ */</span>
<a href="#l6.142"></a><span id="l6.142"> function doTransaction(aAction, aItem, aCalendar, aOldItem, aListener) {</span>
<a href="#l6.143"></a><span id="l6.143">     getTransactionMgr().createAndCommitTxn(aAction,</span>
<a href="#l6.144"></a><span id="l6.144">                                            aItem,</span>
<a href="#l6.145"></a><span id="l6.145">                                            aCalendar,</span>
<a href="#l6.146"></a><span id="l6.146">                                            aOldItem,</span>
<a href="#l6.147"></a><span id="l6.147">                                            aListener ? aListener : null);</span>
<a href="#l6.148"></a><span id="l6.148">     updateUndoRedoMenu();</span>
<a href="#l6.149"></a><span id="l6.149"> }</span>
<a href="#l6.150"></a><span id="l6.150"> </span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+/**</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineplus">+ * Undo the last operation done through the transaction manager.</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+ */</span>
<a href="#l6.154"></a><span id="l6.154"> function undo() {</span>
<a href="#l6.155"></a><span id="l6.155">     if (canUndo()) {</span>
<a href="#l6.156"></a><span id="l6.156">         getTransactionMgr().undo();</span>
<a href="#l6.157"></a><span id="l6.157">         updateUndoRedoMenu();</span>
<a href="#l6.158"></a><span id="l6.158">     }</span>
<a href="#l6.159"></a><span id="l6.159"> }</span>
<a href="#l6.160"></a><span id="l6.160"> </span>
<a href="#l6.161"></a><span id="l6.161" class="difflineplus">+/**</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineplus">+ * Redo the last undone operation in the transaction manager.</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineplus">+ */</span>
<a href="#l6.164"></a><span id="l6.164"> function redo() {</span>
<a href="#l6.165"></a><span id="l6.165">     if (canRedo()) {</span>
<a href="#l6.166"></a><span id="l6.166">         getTransactionMgr().redo();</span>
<a href="#l6.167"></a><span id="l6.167">         updateUndoRedoMenu();</span>
<a href="#l6.168"></a><span id="l6.168">     }</span>
<a href="#l6.169"></a><span id="l6.169"> }</span>
<a href="#l6.170"></a><span id="l6.170"> </span>
<a href="#l6.171"></a><span id="l6.171" class="difflineplus">+/**</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineplus">+ * Start a batch transaction on the transaction manager. Can be called multiple</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineplus">+ * times, which nests transactions.</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineplus">+ */</span>
<a href="#l6.175"></a><span id="l6.175"> function startBatchTransaction() {</span>
<a href="#l6.176"></a><span id="l6.176">     getTransactionMgr().beginBatch();</span>
<a href="#l6.177"></a><span id="l6.177"> }</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineplus">+</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineplus">+/**</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineplus">+ * End a previously started batch transaction. NOTE: be sure to call this in a</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineplus">+ * try-catch-finally-block in case you have code that could fail between</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineplus">+ * startBatchTransaction and this call.</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineplus">+ */</span>
<a href="#l6.184"></a><span id="l6.184"> function endBatchTransaction() {</span>
<a href="#l6.185"></a><span id="l6.185">     getTransactionMgr().endBatch();</span>
<a href="#l6.186"></a><span id="l6.186">     updateUndoRedoMenu();</span>
<a href="#l6.187"></a><span id="l6.187"> }</span>
<a href="#l6.188"></a><span id="l6.188"> </span>
<a href="#l6.189"></a><span id="l6.189" class="difflineplus">+/**</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineplus">+ * Checks if the last operation can be undone (or if there is a last operation</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineplus">+ * at all).</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineplus">+ */</span>
<a href="#l6.193"></a><span id="l6.193"> function canUndo() {</span>
<a href="#l6.194"></a><span id="l6.194">     return getTransactionMgr().canUndo();</span>
<a href="#l6.195"></a><span id="l6.195"> }</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineplus">+</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineplus">+/**</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineplus">+ * Checks if the last undone operation can be redone.</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineplus">+ */</span>
<a href="#l6.200"></a><span id="l6.200"> function canRedo() {</span>
<a href="#l6.201"></a><span id="l6.201">     return getTransactionMgr().canRedo();</span>
<a href="#l6.202"></a><span id="l6.202"> }</span>
<a href="#l6.203"></a><span id="l6.203"> </span>
<a href="#l6.204"></a><span id="l6.204"> /**</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineminus">- * Update the undo and redo menu items</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineplus">+ * Update the undo and redo commands.</span>
<a href="#l6.207"></a><span id="l6.207">  */</span>
<a href="#l6.208"></a><span id="l6.208"> function updateUndoRedoMenu() {</span>
<a href="#l6.209"></a><span id="l6.209">     goUpdateCommand(&quot;cmd_undo&quot;);</span>
<a href="#l6.210"></a><span id="l6.210">     goUpdateCommand(&quot;cmd_redo&quot;);</span>
<a href="#l6.211"></a><span id="l6.211"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/base/content/calendar-statusbar.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/base/content/calendar-statusbar.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -29,17 +29,20 @@</span>
<a href="#l7.4"></a><span id="l7.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l7.5"></a><span id="l7.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l7.6"></a><span id="l7.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l7.7"></a><span id="l7.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.8"></a><span id="l7.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.9"></a><span id="l7.9">  *</span>
<a href="#l7.10"></a><span id="l7.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+/**</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+ * This code might change soon if we support Thunderbird's activity manager.</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+ * NOTE: The naming &quot;Meteors&quot; is historical.</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+ */</span>
<a href="#l7.17"></a><span id="l7.17">  var gCalendarStatusFeedback = {</span>
<a href="#l7.18"></a><span id="l7.18">      mCalendarValue: 0,</span>
<a href="#l7.19"></a><span id="l7.19">      mCalendarStep: 0,</span>
<a href="#l7.20"></a><span id="l7.20">      mCalendarCount: 0,</span>
<a href="#l7.21"></a><span id="l7.21">      mWindow: null,</span>
<a href="#l7.22"></a><span id="l7.22">      mStatusText: null,</span>
<a href="#l7.23"></a><span id="l7.23">      mStatusBar: null,</span>
<a href="#l7.24"></a><span id="l7.24">      mStatusProgressPanel: null,</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineat">@@ -141,9 +144,9 @@</span>
<a href="#l7.26"></a><span id="l7.26">              // it may be possible that the throbber has been disabled by another</span>
<a href="#l7.27"></a><span id="l7.27">              // completed operation</span>
<a href="#l7.28"></a><span id="l7.28">              if (this.mThrobber){</span>
<a href="#l7.29"></a><span id="l7.29">                  this.mThrobber.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l7.30"></a><span id="l7.30">                  this.mThrobber.setAttribute(&quot;busy&quot;, true);</span>
<a href="#l7.31"></a><span id="l7.31">              }</span>
<a href="#l7.32"></a><span id="l7.32">          }</span>
<a href="#l7.33"></a><span id="l7.33">      }</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">- };</span>
<a href="#l7.35"></a><span id="l7.35">\ No newline at end of file</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+ };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/base/content/calendar-subscriptions-dialog.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/base/content/calendar-subscriptions-dialog.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -30,55 +30,77 @@</span>
<a href="#l8.4"></a><span id="l8.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l8.5"></a><span id="l8.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l8.6"></a><span id="l8.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l8.7"></a><span id="l8.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l8.8"></a><span id="l8.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l8.9"></a><span id="l8.9">  *</span>
<a href="#l8.10"></a><span id="l8.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+/**</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+ * Cancels any pending search operations.</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+ */</span>
<a href="#l8.15"></a><span id="l8.15"> var gCurrentSearchOperation = null;</span>
<a href="#l8.16"></a><span id="l8.16"> function cancelPendingSearchOperation() {</span>
<a href="#l8.17"></a><span id="l8.17">     if (gCurrentSearchOperation &amp;&amp; gCurrentSearchOperation.isPending) {</span>
<a href="#l8.18"></a><span id="l8.18">         gCurrentSearchOperation.cancel(Components.interfaces.calIErrors.OPERATION_CANCELLED);</span>
<a href="#l8.19"></a><span id="l8.19">     }</span>
<a href="#l8.20"></a><span id="l8.20">     gCurrentSearchOperation = null;</span>
<a href="#l8.21"></a><span id="l8.21"> }</span>
<a href="#l8.22"></a><span id="l8.22"> </span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+/**</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+ * Sets up the subscriptions dialog.</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+ */</span>
<a href="#l8.26"></a><span id="l8.26"> function onLoad() {</span>
<a href="#l8.27"></a><span id="l8.27">     opener.setCursor(&quot;auto&quot;);</span>
<a href="#l8.28"></a><span id="l8.28"> }</span>
<a href="#l8.29"></a><span id="l8.29"> </span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+/**</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+ * Cleans up the subscriptions dialog.</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+ */</span>
<a href="#l8.33"></a><span id="l8.33"> function onUnload() {</span>
<a href="#l8.34"></a><span id="l8.34">     cancelPendingSearchOperation();</span>
<a href="#l8.35"></a><span id="l8.35"> }</span>
<a href="#l8.36"></a><span id="l8.36"> </span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+/**</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+ * Handler function to handle dialog keypress events.</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+ * (Cancels the search when pressing escape)</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+ */</span>
<a href="#l8.41"></a><span id="l8.41"> function onKeyPress(event) {</span>
<a href="#l8.42"></a><span id="l8.42">     switch(event.keyCode) {</span>
<a href="#l8.43"></a><span id="l8.43">         case 27: /* ESC */</span>
<a href="#l8.44"></a><span id="l8.44">             if (gCurrentSearchOperation) {</span>
<a href="#l8.45"></a><span id="l8.45">                 cancelPendingSearchOperation();</span>
<a href="#l8.46"></a><span id="l8.46">                 document.getElementById(&quot;status-deck&quot;).selectedIndex = 0;</span>
<a href="#l8.47"></a><span id="l8.47">                 event.stopPropagation();</span>
<a href="#l8.48"></a><span id="l8.48">                 event.preventDefault();</span>
<a href="#l8.49"></a><span id="l8.49">             }</span>
<a href="#l8.50"></a><span id="l8.50">             break;</span>
<a href="#l8.51"></a><span id="l8.51">     }</span>
<a href="#l8.52"></a><span id="l8.52"> }</span>
<a href="#l8.53"></a><span id="l8.53"> </span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+/**</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+ * Handler function to handle keypress events in the textbox.</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+ * (Starts the search when hitting enter)</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+ */</span>
<a href="#l8.58"></a><span id="l8.58"> function onTextBoxKeyPress(event) {</span>
<a href="#l8.59"></a><span id="l8.59">     switch(event.keyCode) {</span>
<a href="#l8.60"></a><span id="l8.60">         case 13: /* RET */</span>
<a href="#l8.61"></a><span id="l8.61">             onSearch();</span>
<a href="#l8.62"></a><span id="l8.62">             event.stopPropagation();</span>
<a href="#l8.63"></a><span id="l8.63">             event.preventDefault();</span>
<a href="#l8.64"></a><span id="l8.64">             break;</span>
<a href="#l8.65"></a><span id="l8.65">     }</span>
<a href="#l8.66"></a><span id="l8.66"> }</span>
<a href="#l8.67"></a><span id="l8.67"> </span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+/**</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+ * Handler function to be called when the accept button is pressed.</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+ *</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+ * @return      Returns true if the window should be closed</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+ */</span>
<a href="#l8.73"></a><span id="l8.73"> function onAccept() {</span>
<a href="#l8.74"></a><span id="l8.74">     var richListBox = document.getElementById(&quot;subscriptions-listbox&quot;);</span>
<a href="#l8.75"></a><span id="l8.75">     var rowCount = richListBox.getRowCount();</span>
<a href="#l8.76"></a><span id="l8.76">     for (var i = 0; i &lt; rowCount; i++) {</span>
<a href="#l8.77"></a><span id="l8.77">         var richListItem = richListBox.getItemAtIndex(i);</span>
<a href="#l8.78"></a><span id="l8.78">         var checked = richListItem.checked;</span>
<a href="#l8.79"></a><span id="l8.79">         if (checked != richListItem.subscribed) {</span>
<a href="#l8.80"></a><span id="l8.80">             var calendar = richListItem.calendar;</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineat">@@ -87,19 +109,25 @@ function onAccept() {</span>
<a href="#l8.82"></a><span id="l8.82">             } else {</span>
<a href="#l8.83"></a><span id="l8.83">                 getCalendarManager().unregisterCalendar(calendar);</span>
<a href="#l8.84"></a><span id="l8.84">             }</span>
<a href="#l8.85"></a><span id="l8.85">         }</span>
<a href="#l8.86"></a><span id="l8.86">     }</span>
<a href="#l8.87"></a><span id="l8.87">     return true;</span>
<a href="#l8.88"></a><span id="l8.88"> }</span>
<a href="#l8.89"></a><span id="l8.89"> </span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+/**</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+ * Handler function to be called when the cancel button is pressed.</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+ */</span>
<a href="#l8.93"></a><span id="l8.93"> function onCancel() {</span>
<a href="#l8.94"></a><span id="l8.94"> }</span>
<a href="#l8.95"></a><span id="l8.95"> </span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+/**</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+ * Performs the search for subscriptions, canceling any pending searches.</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+ */</span>
<a href="#l8.99"></a><span id="l8.99"> function onSearch() {</span>
<a href="#l8.100"></a><span id="l8.100">     cancelPendingSearchOperation();</span>
<a href="#l8.101"></a><span id="l8.101"> </span>
<a href="#l8.102"></a><span id="l8.102">     var richListBox = document.getElementById(&quot;subscriptions-listbox&quot;);</span>
<a href="#l8.103"></a><span id="l8.103">     richListBox.clear();</span>
<a href="#l8.104"></a><span id="l8.104"> </span>
<a href="#l8.105"></a><span id="l8.105">     var registeredCals = {};</span>
<a href="#l8.106"></a><span id="l8.106">     for each (var cal in getCalendarManager().getCalendars({})) {</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineat">@@ -128,21 +156,29 @@ function onSearch() {</span>
<a href="#l8.108"></a><span id="l8.108">     var op = getCalendarSearchService().searchForCalendars(document.getElementById(&quot;search-textbox&quot;).value,</span>
<a href="#l8.109"></a><span id="l8.109">                                                            0 /* hints */, 50, opListener);</span>
<a href="#l8.110"></a><span id="l8.110">     if (op &amp;&amp; op.isPending) {</span>
<a href="#l8.111"></a><span id="l8.111">         gCurrentSearchOperation = op;</span>
<a href="#l8.112"></a><span id="l8.112">         document.getElementById(&quot;status-deck&quot;).selectedIndex = 1;</span>
<a href="#l8.113"></a><span id="l8.113">     }</span>
<a href="#l8.114"></a><span id="l8.114"> }</span>
<a href="#l8.115"></a><span id="l8.115"> </span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+/**</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+ * Markes the selected item in the subscriptions-listbox for subscribing. The</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+ * actual subscribe happens when the window is closed.</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+ */</span>
<a href="#l8.120"></a><span id="l8.120"> function onSubscribe() {</span>
<a href="#l8.121"></a><span id="l8.121">     var item = document.getElementById(&quot;subscriptions-listbox&quot;).selectedItem;</span>
<a href="#l8.122"></a><span id="l8.122">     if (item &amp;&amp; !item.disabled) {</span>
<a href="#l8.123"></a><span id="l8.123">         item.checked = true;</span>
<a href="#l8.124"></a><span id="l8.124">     }</span>
<a href="#l8.125"></a><span id="l8.125"> }</span>
<a href="#l8.126"></a><span id="l8.126"> </span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+/**</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+ * Unmarkes the selected item in the subscriptions-listbox for subscribing. The</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+ * actual subscribe happens when the window is closed.</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+ */</span>
<a href="#l8.131"></a><span id="l8.131"> function onUnsubscribe() {</span>
<a href="#l8.132"></a><span id="l8.132">     var item = document.getElementById(&quot;subscriptions-listbox&quot;).selectedItem;</span>
<a href="#l8.133"></a><span id="l8.133">     if (item &amp;&amp; !item.disabled) {</span>
<a href="#l8.134"></a><span id="l8.134">         item.checked = false;</span>
<a href="#l8.135"></a><span id="l8.135">     }</span>
<a href="#l8.136"></a><span id="l8.136"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/base/content/calendar-task-editing.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-editing.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -39,40 +39,60 @@</span>
<a href="#l9.4"></a><span id="l9.4">  * Used by the &quot;quick add&quot; feature for tasks, for example in the task view or</span>
<a href="#l9.5"></a><span id="l9.5">  * the uniinder-todo.</span>
<a href="#l9.6"></a><span id="l9.6">  *</span>
<a href="#l9.7"></a><span id="l9.7">  * NOTE: many of the following methods are called without taskEdit being the</span>
<a href="#l9.8"></a><span id="l9.8">  * |this| object.</span>
<a href="#l9.9"></a><span id="l9.9">  */</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11"> var taskEdit = {</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+    /**</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+     * Get the currently observed calendar.</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+     */</span>
<a href="#l9.15"></a><span id="l9.15">     mObservedCalendar: null,</span>
<a href="#l9.16"></a><span id="l9.16">     get observedCalendar tE_get_observedCalendar() {</span>
<a href="#l9.17"></a><span id="l9.17">         return this.mObservedCalendar;</span>
<a href="#l9.18"></a><span id="l9.18">     },</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+    /**</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+     * Set the currently observed calendar, removing listeners to any old</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+     * calendar set and adding listeners to the new one.</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+     */</span>
<a href="#l9.24"></a><span id="l9.24">     set observedCalendar tE_set_observedCalendar(v) {</span>
<a href="#l9.25"></a><span id="l9.25">         if (this.mObservedCalendar) {</span>
<a href="#l9.26"></a><span id="l9.26">             this.mObservedCalendar.removeObserver(this.calendarObserver);</span>
<a href="#l9.27"></a><span id="l9.27">         }</span>
<a href="#l9.28"></a><span id="l9.28"> </span>
<a href="#l9.29"></a><span id="l9.29">         this.mObservedCalendar = v;</span>
<a href="#l9.30"></a><span id="l9.30"> </span>
<a href="#l9.31"></a><span id="l9.31">         if (this.mObservedCalendar) {</span>
<a href="#l9.32"></a><span id="l9.32">             this.mObservedCalendar.addObserver(this.calendarObserver);</span>
<a href="#l9.33"></a><span id="l9.33">         }</span>
<a href="#l9.34"></a><span id="l9.34">         return this.mObservedCalendar;</span>
<a href="#l9.35"></a><span id="l9.35">     },</span>
<a href="#l9.36"></a><span id="l9.36"> </span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+    /**</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+     * Helper function to set readonly and aria-disabled states and the value</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+     * for a given target.</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+     *</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+     * @param aTarget   The ID or XUL node to set the value</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+     * @param aDisable  A boolean if the target should be disabled.</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+     * @param aValue    The value that should be set on the target.</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+     */</span>
<a href="#l9.45"></a><span id="l9.45">     setupTaskField: function tE_setupTaskField(aTarget, aDisable, aValue) {</span>
<a href="#l9.46"></a><span id="l9.46">         aTarget.value = aValue;</span>
<a href="#l9.47"></a><span id="l9.47">         setElementValue(aTarget, aDisable &amp;&amp; &quot;true&quot;, &quot;readonly&quot;);</span>
<a href="#l9.48"></a><span id="l9.48">         setElementValue(aTarget, aDisable &amp;&amp; &quot;true&quot;, &quot;aria-disabled&quot;);</span>
<a href="#l9.49"></a><span id="l9.49">     },</span>
<a href="#l9.50"></a><span id="l9.50"> </span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+    /**</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+     * Handler function to call when the quick-add textbox gains focus.</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+     *</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+     * @param aEvent    The DOM focus event</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+     */</span>
<a href="#l9.56"></a><span id="l9.56">     onFocus: function tE_onFocus(aEvent) {</span>
<a href="#l9.57"></a><span id="l9.57">         var edit = aEvent.target;</span>
<a href="#l9.58"></a><span id="l9.58">         if (edit.localName == &quot;input&quot;) {</span>
<a href="#l9.59"></a><span id="l9.59">             // For some reason, we only recieve an onfocus event for the textbox</span>
<a href="#l9.60"></a><span id="l9.60">             // when debugging with venkman.</span>
<a href="#l9.61"></a><span id="l9.61">             edit = edit.parentNode.parentNode;</span>
<a href="#l9.62"></a><span id="l9.62">         }</span>
<a href="#l9.63"></a><span id="l9.63"> </span>
<a href="#l9.64"></a><span id="l9.64" class="difflineat">@@ -88,16 +108,21 @@ var taskEdit = {</span>
<a href="#l9.65"></a><span id="l9.65">                                     true,</span>
<a href="#l9.66"></a><span id="l9.66">                                     calGetString(&quot;calendar&quot;, &quot;taskEditInstructionsReadonly&quot;));</span>
<a href="#l9.67"></a><span id="l9.67">         } else {</span>
<a href="#l9.68"></a><span id="l9.68">             edit.showsInstructions = false;</span>
<a href="#l9.69"></a><span id="l9.69">             taskEdit.setupTaskField(edit, false, edit.savedValue || &quot;&quot;);</span>
<a href="#l9.70"></a><span id="l9.70">         }</span>
<a href="#l9.71"></a><span id="l9.71">     },</span>
<a href="#l9.72"></a><span id="l9.72"> </span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+    /**</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineplus">+     * Handler function to call when the quick-add textbox loses focus.</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineplus">+     *</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineplus">+     * @param aEvent    The DOM blur event</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+     */</span>
<a href="#l9.78"></a><span id="l9.78">     onBlur: function tE_onBlur(aEvent) {</span>
<a href="#l9.79"></a><span id="l9.79">         var edit = aEvent.target;</span>
<a href="#l9.80"></a><span id="l9.80">         if (edit.localName == &quot;input&quot;) {</span>
<a href="#l9.81"></a><span id="l9.81">             // For some reason, we only recieve the blur event for the input</span>
<a href="#l9.82"></a><span id="l9.82">             // element. There are no targets that point to the textbox. Go up</span>
<a href="#l9.83"></a><span id="l9.83">             // the parent chain until we reach the textbox.</span>
<a href="#l9.84"></a><span id="l9.84">             edit = edit.parentNode.parentNode;</span>
<a href="#l9.85"></a><span id="l9.85">         }</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineat">@@ -118,46 +143,65 @@ var taskEdit = {</span>
<a href="#l9.87"></a><span id="l9.87">             }</span>
<a href="#l9.88"></a><span id="l9.88">             taskEdit.setupTaskField(edit,</span>
<a href="#l9.89"></a><span id="l9.89">                                     false,</span>
<a href="#l9.90"></a><span id="l9.90">                                     calGetString(&quot;calendar&quot;, &quot;taskEditInstructions&quot;));</span>
<a href="#l9.91"></a><span id="l9.91">         }</span>
<a href="#l9.92"></a><span id="l9.92">         edit.showsInstructions = true;</span>
<a href="#l9.93"></a><span id="l9.93">     },</span>
<a href="#l9.94"></a><span id="l9.94"> </span>
<a href="#l9.95"></a><span id="l9.95" class="difflineplus">+    /**</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+     * Handler function to call on keypress for the quick-add textbox.</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+     *</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+     * @param aEvent    The DOM keypress event</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineplus">+     */</span>
<a href="#l9.100"></a><span id="l9.100">     onKeyPress: function tE_onKeyPress(aEvent) {</span>
<a href="#l9.101"></a><span id="l9.101">         if (aEvent.keyCode == Components.interfaces.nsIDOMKeyEvent.DOM_VK_RETURN) {</span>
<a href="#l9.102"></a><span id="l9.102">             var edit = aEvent.target;</span>
<a href="#l9.103"></a><span id="l9.103">             if (edit.value &amp;&amp; edit.value.length &gt; 0) {</span>
<a href="#l9.104"></a><span id="l9.104">                 var item = createTodo();</span>
<a href="#l9.105"></a><span id="l9.105">                 item.calendar = getSelectedCalendar();</span>
<a href="#l9.106"></a><span id="l9.106">                 item.title = edit.value;</span>
<a href="#l9.107"></a><span id="l9.107">                 edit.value = &quot;&quot;;</span>
<a href="#l9.108"></a><span id="l9.108">                 setDefaultAlarmValues(item);</span>
<a href="#l9.109"></a><span id="l9.109">                 doTransaction('add', item, item.calendar, null, null);</span>
<a href="#l9.110"></a><span id="l9.110">             }</span>
<a href="#l9.111"></a><span id="l9.111">         }</span>
<a href="#l9.112"></a><span id="l9.112">     },</span>
<a href="#l9.113"></a><span id="l9.113"> </span>
<a href="#l9.114"></a><span id="l9.114" class="difflineplus">+    /**</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineplus">+     * Window load function to set up all quick-add textboxes. The texbox must</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineplus">+     * have the class &quot;task-edit-field&quot;.</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+     */</span>
<a href="#l9.118"></a><span id="l9.118">     onLoad: function tE_onLoad(aEvent) {</span>
<a href="#l9.119"></a><span id="l9.119">         window.removeEventListener(&quot;load&quot;, taskEdit.onLoad, false);</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineplus">+        // TODO use getElementsByClassName</span>
<a href="#l9.121"></a><span id="l9.121">         var taskEditFields = document.getElementsByAttribute(&quot;class&quot;, &quot;task-edit-field&quot;);</span>
<a href="#l9.122"></a><span id="l9.122">         for (var i = 0; i &lt; taskEditFields.length; i++) {</span>
<a href="#l9.123"></a><span id="l9.123">             taskEdit.onBlur({ target: taskEditFields[i] });</span>
<a href="#l9.124"></a><span id="l9.124">         }</span>
<a href="#l9.125"></a><span id="l9.125"> </span>
<a href="#l9.126"></a><span id="l9.126">         getCompositeCalendar().addObserver(taskEdit.compositeObserver);</span>
<a href="#l9.127"></a><span id="l9.127">         taskEdit.observedCalendar = getSelectedCalendar();</span>
<a href="#l9.128"></a><span id="l9.128">     },</span>
<a href="#l9.129"></a><span id="l9.129"> </span>
<a href="#l9.130"></a><span id="l9.130" class="difflineplus">+    /**</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineplus">+     * Window load function to clean up all quick-add fields.</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineplus">+     */</span>
<a href="#l9.133"></a><span id="l9.133">     onUnload: function tE_onUnload() {</span>
<a href="#l9.134"></a><span id="l9.134">         getCompositeCalendar().removeObserver(taskEdit.compositeObserver);</span>
<a href="#l9.135"></a><span id="l9.135">         taskEdit.observedCalendar = null;</span>
<a href="#l9.136"></a><span id="l9.136">     },</span>
<a href="#l9.137"></a><span id="l9.137"> </span>
<a href="#l9.138"></a><span id="l9.138" class="difflineplus">+    /**</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineplus">+     * Observer to watch for readonly, disabled and capability changes of the</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineplus">+     * observed calendar.</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineplus">+     *</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineplus">+     * @see calIObserver</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineplus">+     */</span>
<a href="#l9.144"></a><span id="l9.144">     calendarObserver: {</span>
<a href="#l9.145"></a><span id="l9.145">         QueryInterface: function tE_calObs_QueryInterface(aIID) {</span>
<a href="#l9.146"></a><span id="l9.146">             return doQueryInterface(this, null, aIID,</span>
<a href="#l9.147"></a><span id="l9.147">                                     [Components.interfaces.calIObserver]);</span>
<a href="#l9.148"></a><span id="l9.148">         },</span>
<a href="#l9.149"></a><span id="l9.149"> </span>
<a href="#l9.150"></a><span id="l9.150">         // calIObserver:</span>
<a href="#l9.151"></a><span id="l9.151">         onStartBatch: function() {},</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineat">@@ -191,16 +235,23 @@ var taskEdit = {</span>
<a href="#l9.153"></a><span id="l9.153">                                                            aName) {</span>
<a href="#l9.154"></a><span id="l9.154">             // Since the old value is not used directly in onPropertyChanged,</span>
<a href="#l9.155"></a><span id="l9.155">             // but should not be the same as the value, set it to a different</span>
<a href="#l9.156"></a><span id="l9.156">             // value.</span>
<a href="#l9.157"></a><span id="l9.157">             this.onPropertyChanged(aCalendar, aName, null, null);</span>
<a href="#l9.158"></a><span id="l9.158">         }</span>
<a href="#l9.159"></a><span id="l9.159">     },</span>
<a href="#l9.160"></a><span id="l9.160"> </span>
<a href="#l9.161"></a><span id="l9.161" class="difflineplus">+    /**</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineplus">+     * Observer to watch for changes to the selected calendar.</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineplus">+     *</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineplus">+     * XXX I think we don't need to implement calIObserver here.</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineplus">+     *</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineplus">+     * @see calICompositeObserver</span>
<a href="#l9.167"></a><span id="l9.167" class="difflineplus">+     */</span>
<a href="#l9.168"></a><span id="l9.168">     compositeObserver: {</span>
<a href="#l9.169"></a><span id="l9.169">         QueryInterface: function tE_compObs_QueryInterface(aIID) {</span>
<a href="#l9.170"></a><span id="l9.170">             return doQueryInterface(this, null, aIID,</span>
<a href="#l9.171"></a><span id="l9.171">                                     [Components.interfaces.calIObserver,</span>
<a href="#l9.172"></a><span id="l9.172">                                      Components.interfaces.calICompositeObserver]);</span>
<a href="#l9.173"></a><span id="l9.173">         },</span>
<a href="#l9.174"></a><span id="l9.174"> </span>
<a href="#l9.175"></a><span id="l9.175">         // calIObserver:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/base/content/calendar-task-view.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-view.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -32,20 +32,24 @@</span>
<a href="#l10.4"></a><span id="l10.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l10.5"></a><span id="l10.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l10.6"></a><span id="l10.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l10.7"></a><span id="l10.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l10.8"></a><span id="l10.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l10.9"></a><span id="l10.9">  *</span>
<a href="#l10.10"></a><span id="l10.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+</span>
<a href="#l10.13"></a><span id="l10.13"> var taskDetailsView = {</span>
<a href="#l10.14"></a><span id="l10.14"> </span>
<a href="#l10.15"></a><span id="l10.15">     /**</span>
<a href="#l10.16"></a><span id="l10.16">      * Task Details Events</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+     *</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+     * XXXberend Please document this function, possibly also consolidate since</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+     * its the only function in taskDetailsView.</span>
<a href="#l10.20"></a><span id="l10.20">      */</span>
<a href="#l10.21"></a><span id="l10.21">     onSelect: function tDV_onSelect(event) {</span>
<a href="#l10.22"></a><span id="l10.22"> </span>
<a href="#l10.23"></a><span id="l10.23">         var dateFormatter =</span>
<a href="#l10.24"></a><span id="l10.24">             Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l10.25"></a><span id="l10.25">             .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l10.26"></a><span id="l10.26"> </span>
<a href="#l10.27"></a><span id="l10.27">         var displayElement = function(id,flag) {</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineat">@@ -118,17 +122,17 @@ var taskDetailsView = {</span>
<a href="#l10.29"></a><span id="l10.29">                                 &quot;taskDetailsStatusCompletedOn&quot;,</span>
<a href="#l10.30"></a><span id="l10.30">                                 [dateFormatter.formatDateTime(completedDate)]);</span>
<a href="#l10.31"></a><span id="l10.31">                         }</span>
<a href="#l10.32"></a><span id="l10.32">                         break;</span>
<a href="#l10.33"></a><span id="l10.33">                     case &quot;CANCELLED&quot;:</span>
<a href="#l10.34"></a><span id="l10.34">                         statusDetails.value = calGetString(</span>
<a href="#l10.35"></a><span id="l10.35">                             &quot;calendar&quot;,</span>
<a href="#l10.36"></a><span id="l10.36">                             &quot;taskDetailsStatusCancelled&quot;);</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-                        break; </span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+                        break;</span>
<a href="#l10.39"></a><span id="l10.39">                     default:</span>
<a href="#l10.40"></a><span id="l10.40">                         displayElement(&quot;calendar-task-details-status-row&quot;, false);</span>
<a href="#l10.41"></a><span id="l10.41">                         break;</span>
<a href="#l10.42"></a><span id="l10.42">                 }</span>
<a href="#l10.43"></a><span id="l10.43">             }</span>
<a href="#l10.44"></a><span id="l10.44">             var categories = item.getCategories({});</span>
<a href="#l10.45"></a><span id="l10.45">             if (displayElement(&quot;calendar-task-details-category-row&quot;, categories.length &gt; 0)) {</span>
<a href="#l10.46"></a><span id="l10.46">                 document.getElementById(&quot;calendar-task-details-category&quot;).value = categories.join(&quot;, &quot;);</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineat">@@ -159,28 +163,42 @@ var taskDetailsView = {</span>
<a href="#l10.48"></a><span id="l10.48">                 var urlLabel = document.getElementById(&quot;calendar-task-details-attachment&quot;);</span>
<a href="#l10.49"></a><span id="l10.49">                 urlLabel.value = gURL;</span>
<a href="#l10.50"></a><span id="l10.50">                 urlLabel.setAttribute(&quot;tooltiptext&quot;, gURL);</span>
<a href="#l10.51"></a><span id="l10.51">             }</span>
<a href="#l10.52"></a><span id="l10.52">         }</span>
<a href="#l10.53"></a><span id="l10.53">     }</span>
<a href="#l10.54"></a><span id="l10.54"> };</span>
<a href="#l10.55"></a><span id="l10.55"> </span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+/**</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+ * Updates the currently applied filter for the task view and refreshes the task</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+ * tree.</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+ *</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+ * @param filter        The filter name to set.</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+ */</span>
<a href="#l10.63"></a><span id="l10.63"> function taskViewUpdate(filter) {</span>
<a href="#l10.64"></a><span id="l10.64">     document.getElementById(&quot;filterBroadcaster&quot;).setAttribute(&quot;value&quot;, filter);</span>
<a href="#l10.65"></a><span id="l10.65"> </span>
<a href="#l10.66"></a><span id="l10.66">     var tree = document.getElementById(&quot;calendar-task-tree&quot;);</span>
<a href="#l10.67"></a><span id="l10.67"> </span>
<a href="#l10.68"></a><span id="l10.68">     // set the filters</span>
<a href="#l10.69"></a><span id="l10.69">     tree.mFilter.propertyFilter  = filter;</span>
<a href="#l10.70"></a><span id="l10.70">     tree.mFilter.setDateFilter(filter);</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-    </span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+</span>
<a href="#l10.73"></a><span id="l10.73">     tree.refresh();</span>
<a href="#l10.74"></a><span id="l10.74"> }</span>
<a href="#l10.75"></a><span id="l10.75"> </span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+/**</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+ * Prepares a dialog to send an email to the organizer of the currently selected</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+ * task in the task view.</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+ *</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+ * XXX We already have a function with this name in the event dialog. Either</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+ * consolidate or make name more clear.</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+ */</span>
<a href="#l10.83"></a><span id="l10.83"> function sendMailToOrganizer() {</span>
<a href="#l10.84"></a><span id="l10.84">     var item = document.getElementById(&quot;calendar-task-tree&quot;).currentTask;</span>
<a href="#l10.85"></a><span id="l10.85">     if (item != null) {</span>
<a href="#l10.86"></a><span id="l10.86">         var organizer = item.organizer;</span>
<a href="#l10.87"></a><span id="l10.87">         if (organizer) {</span>
<a href="#l10.88"></a><span id="l10.88">             if (organizer.id &amp;&amp; organizer.id.length) {</span>
<a href="#l10.89"></a><span id="l10.89">                 var email = organizer.id;</span>
<a href="#l10.90"></a><span id="l10.90">                 var re = new RegExp(&quot;^mailto:(.*)&quot;, &quot;i&quot;);</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineat">@@ -198,16 +216,23 @@ function sendMailToOrganizer() {</span>
<a href="#l10.92"></a><span id="l10.92">                                                 [item.title]);</span>
<a href="#l10.93"></a><span id="l10.93"> </span>
<a href="#l10.94"></a><span id="l10.94">                 sendMailTo(email, emailSubject);</span>
<a href="#l10.95"></a><span id="l10.95">             }</span>
<a href="#l10.96"></a><span id="l10.96">         }</span>
<a href="#l10.97"></a><span id="l10.97">     }</span>
<a href="#l10.98"></a><span id="l10.98"> }</span>
<a href="#l10.99"></a><span id="l10.99"> </span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+/**</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+ * Handler function to observe changing of the calendar display deck. Updates</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+ * the task tree if the task view was selected.</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+ *</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+ * TODO Consolidate this function and anything connected, its still from times</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+ * before we had view tabs.</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineplus">+ */</span>
<a href="#l10.107"></a><span id="l10.107"> function taskViewObserveDisplayDeckChange(event) {</span>
<a href="#l10.108"></a><span id="l10.108">     var deck = event.target;</span>
<a href="#l10.109"></a><span id="l10.109"> </span>
<a href="#l10.110"></a><span id="l10.110">     // Bug 309505: The 'select' event also fires when we change the selected</span>
<a href="#l10.111"></a><span id="l10.111">     // panel of calendar-view-box.  Workaround with this check.</span>
<a href="#l10.112"></a><span id="l10.112">     if (deck.id != &quot;calendarDisplayDeck&quot;) {</span>
<a href="#l10.113"></a><span id="l10.113">         return;</span>
<a href="#l10.114"></a><span id="l10.114">     }</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineat">@@ -220,12 +245,13 @@ function taskViewObserveDisplayDeckChang</span>
<a href="#l10.116"></a><span id="l10.116"> </span>
<a href="#l10.117"></a><span id="l10.117">     // In case we find that the task view has been made visible, we refresh the view.</span>
<a href="#l10.118"></a><span id="l10.118">     if (id == &quot;calendar-task-box&quot;) {</span>
<a href="#l10.119"></a><span id="l10.119">         taskViewUpdate(</span>
<a href="#l10.120"></a><span id="l10.120">             document.getElementById(&quot;task-tree-filtergroup&quot;).value || &quot;all&quot;);</span>
<a href="#l10.121"></a><span id="l10.121">     }</span>
<a href="#l10.122"></a><span id="l10.122"> }</span>
<a href="#l10.123"></a><span id="l10.123"> </span>
<a href="#l10.124"></a><span id="l10.124" class="difflineplus">+// Install event listeners for the display deck change.</span>
<a href="#l10.125"></a><span id="l10.125"> document.addEventListener(&quot;load&quot;, function () {</span>
<a href="#l10.126"></a><span id="l10.126">   document.getElementById(&quot;calendarDisplayDeck&quot;).</span>
<a href="#l10.127"></a><span id="l10.127">     addEventListener(&quot;select&quot;, taskViewObserveDisplayDeckChange, true);</span>
<a href="#l10.128"></a><span id="l10.128">   }, true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/calendar/base/content/calendar-ui-utils.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/calendar/base/content/calendar-ui-utils.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -30,29 +30,29 @@</span>
<a href="#l11.4"></a><span id="l11.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l11.5"></a><span id="l11.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l11.6"></a><span id="l11.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l11.7"></a><span id="l11.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l11.8"></a><span id="l11.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l11.9"></a><span id="l11.9">  *</span>
<a href="#l11.10"></a><span id="l11.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+</span>
<a href="#l11.15"></a><span id="l11.15"> /**</span>
<a href="#l11.16"></a><span id="l11.16">  * Helper function for filling the form,</span>
<a href="#l11.17"></a><span id="l11.17">  * Set the value of a property of a XUL element</span>
<a href="#l11.18"></a><span id="l11.18">  *</span>
<a href="#l11.19"></a><span id="l11.19">  * @param aElement      ID of XUL element to set, or the element node itself</span>
<a href="#l11.20"></a><span id="l11.20">  * @param aNewValue     value to set property to ( if undefined no change is made )</span>
<a href="#l11.21"></a><span id="l11.21">  * @param aPropertyName OPTIONAL name of property to set, default is &quot;value&quot;,</span>
<a href="#l11.22"></a><span id="l11.22">  *                        use &quot;checked&quot; for radios &amp; checkboxes, &quot;data&quot; for</span>
<a href="#l11.23"></a><span id="l11.23">  *                        drop-downs</span>
<a href="#l11.24"></a><span id="l11.24">  */</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-</span>
<a href="#l11.28"></a><span id="l11.28"> function setElementValue(aElement, aNewValue, aPropertyName) {</span>
<a href="#l11.29"></a><span id="l11.29">     ASSERT(aElement);</span>
<a href="#l11.30"></a><span id="l11.30">     var undefined;</span>
<a href="#l11.31"></a><span id="l11.31"> </span>
<a href="#l11.32"></a><span id="l11.32">     if (aNewValue !== undefined) {</span>
<a href="#l11.33"></a><span id="l11.33">         if (typeof(aElement) == &quot;string&quot;) {</span>
<a href="#l11.34"></a><span id="l11.34">             aElement = document.getElementById(aElement);</span>
<a href="#l11.35"></a><span id="l11.35">         }</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineat">@@ -152,16 +152,19 @@ function disableElement(aElement) {</span>
<a href="#l11.37"></a><span id="l11.37"> </span>
<a href="#l11.38"></a><span id="l11.38"> /**</span>
<a href="#l11.39"></a><span id="l11.39">  * This function unconditionally disables the element for</span>
<a href="#l11.40"></a><span id="l11.40">  * which the id has been passed as argument. Furthermore, it</span>
<a href="#l11.41"></a><span id="l11.41">  * remembers who was responsible for this action by using</span>
<a href="#l11.42"></a><span id="l11.42">  * the given key (lockId). In case the control should be</span>
<a href="#l11.43"></a><span id="l11.43">  * enabled again the lock gets removed, but the control only</span>
<a href="#l11.44"></a><span id="l11.44">  * gets enabled if *all* possibly held locks have been removed.</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+ *</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+ * @param elementId     The element ID of the element to disable.</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+ * @param lockId        The ID of the lock to set.</span>
<a href="#l11.48"></a><span id="l11.48">  */</span>
<a href="#l11.49"></a><span id="l11.49"> function disableElementWithLock(elementId,lockId) {</span>
<a href="#l11.50"></a><span id="l11.50"> </span>
<a href="#l11.51"></a><span id="l11.51">     // unconditionally disable the element.</span>
<a href="#l11.52"></a><span id="l11.52">     disableElement(elementId);</span>
<a href="#l11.53"></a><span id="l11.53"> </span>
<a href="#l11.54"></a><span id="l11.54">     // remember that this element has been locked with</span>
<a href="#l11.55"></a><span id="l11.55">     // the key passed as argument. we keep a primitive</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineat">@@ -175,16 +178,20 @@ function disableElementWithLock(elementI</span>
<a href="#l11.57"></a><span id="l11.57">         }</span>
<a href="#l11.58"></a><span id="l11.58">     }</span>
<a href="#l11.59"></a><span id="l11.59"> }</span>
<a href="#l11.60"></a><span id="l11.60"> </span>
<a href="#l11.61"></a><span id="l11.61"> /**</span>
<a href="#l11.62"></a><span id="l11.62">  * This function is intended to be used in tandem with the</span>
<a href="#l11.63"></a><span id="l11.63">  * above defined function 'disableElementWithLock()'.</span>
<a href="#l11.64"></a><span id="l11.64">  * See the respective comment for further details.</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+ *</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+ * @see disableElementWithLock</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+ * @param elementId     The element ID of the element to enable.</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+ * @param lockId        The ID of the lock to set.</span>
<a href="#l11.69"></a><span id="l11.69">  */</span>
<a href="#l11.70"></a><span id="l11.70"> function enableElementWithLock(elementId, lockId) {</span>
<a href="#l11.71"></a><span id="l11.71"> </span>
<a href="#l11.72"></a><span id="l11.72">     var element = document.getElementById(elementId);</span>
<a href="#l11.73"></a><span id="l11.73">     if (!element) {</span>
<a href="#l11.74"></a><span id="l11.74">         dump(&quot;unable to find &quot; + elementId + &quot;\n&quot;);</span>
<a href="#l11.75"></a><span id="l11.75">         return;</span>
<a href="#l11.76"></a><span id="l11.76">     }</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineat">@@ -198,18 +205,18 @@ function enableElementWithLock(elementId</span>
<a href="#l11.78"></a><span id="l11.78">             element.removeAttribute(&quot;lock&quot;);</span>
<a href="#l11.79"></a><span id="l11.79">         }</span>
<a href="#l11.80"></a><span id="l11.80">         if (n &lt;= 0) {</span>
<a href="#l11.81"></a><span id="l11.81">             enableElement(elementId);</span>
<a href="#l11.82"></a><span id="l11.82">         }</span>
<a href="#l11.83"></a><span id="l11.83">     }</span>
<a href="#l11.84"></a><span id="l11.84"> }</span>
<a href="#l11.85"></a><span id="l11.85"> </span>
<a href="#l11.86"></a><span id="l11.86" class="difflineminus">-/** </span>
<a href="#l11.87"></a><span id="l11.87" class="difflineminus">- * Unchecks the commands of the child elements of a DOM-tree-node e.g of a menu</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+/**</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+ * Unchecks the commands of the child elements of a DOM-tree-node i.e of a menu</span>
<a href="#l11.90"></a><span id="l11.90">  *</span>
<a href="#l11.91"></a><span id="l11.91">  * @param aEvent    The event from which the target is taken to retrieve the</span>
<a href="#l11.92"></a><span id="l11.92">  *                    child elements</span>
<a href="#l11.93"></a><span id="l11.93">  */</span>
<a href="#l11.94"></a><span id="l11.94"> function uncheckChildNodes(aEvent) {</span>
<a href="#l11.95"></a><span id="l11.95">     var liveList = aEvent.target.getElementsByAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l11.96"></a><span id="l11.96">     for (var i = liveList.length - 1; i &gt;= 0; i-- ) {</span>
<a href="#l11.97"></a><span id="l11.97">         var commandName = liveList.item(i).getAttribute(&quot;command&quot;);</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineat">@@ -233,16 +240,18 @@ function removeChildren(aElement) {</span>
<a href="#l11.99"></a><span id="l11.99">     while (aElement.firstChild) {</span>
<a href="#l11.100"></a><span id="l11.100">         aElement.removeChild(aElement.lastChild);</span>
<a href="#l11.101"></a><span id="l11.101">     }</span>
<a href="#l11.102"></a><span id="l11.102"> }</span>
<a href="#l11.103"></a><span id="l11.103"> </span>
<a href="#l11.104"></a><span id="l11.104"> /**</span>
<a href="#l11.105"></a><span id="l11.105">  * Sorts a sorted array of calendars by pref |calendar.list.sortOrder|.</span>
<a href="#l11.106"></a><span id="l11.106">  * Repairs that pref if dangling entries exist.</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+ *</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineplus">+ * @param calendars     An array of calendars to sort.</span>
<a href="#l11.109"></a><span id="l11.109">  */</span>
<a href="#l11.110"></a><span id="l11.110"> function sortCalendarArray(calendars) {</span>
<a href="#l11.111"></a><span id="l11.111">     let ret = calendars.concat([]);</span>
<a href="#l11.112"></a><span id="l11.112">     let sortOrder = {};</span>
<a href="#l11.113"></a><span id="l11.113">     let sortOrderPref = cal.getPrefSafe(&quot;calendar.list.sortOrder&quot;, &quot;&quot;).split(&quot; &quot;);</span>
<a href="#l11.114"></a><span id="l11.114">     for (let i = 0; i &lt; sortOrderPref.length; ++i) {</span>
<a href="#l11.115"></a><span id="l11.115">         sortOrder[sortOrderPref[i]] = i;</span>
<a href="#l11.116"></a><span id="l11.116">     }</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineat">@@ -305,16 +314,28 @@ function appendCalendarItems(aItem, aCal</span>
<a href="#l11.118"></a><span id="l11.118">             if (calendarToUse &amp;&amp; calendarToUse.id == calendar.id) {</span>
<a href="#l11.119"></a><span id="l11.119">                 indexToSelect = index;</span>
<a href="#l11.120"></a><span id="l11.120">             }</span>
<a href="#l11.121"></a><span id="l11.121">         }</span>
<a href="#l11.122"></a><span id="l11.122">     }</span>
<a href="#l11.123"></a><span id="l11.123">     return indexToSelect;</span>
<a href="#l11.124"></a><span id="l11.124"> }</span>
<a href="#l11.125"></a><span id="l11.125"> </span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+/**</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineplus">+* Fills up a menu - either a menupopup or a menulist - with menuitems that refer</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineplus">+* to categories.</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineplus">+*</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineplus">+* @param aItem                 The event or task</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineplus">+* @param aCategoryMenuList     The direct parent of the menuitems - either a</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineplus">+*                                menupopup or a menulist</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineplus">+* @param aCommand              A string that is applied to the &quot;oncommand&quot;</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineplus">+*                                attribute of each menuitem</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineplus">+* @return                      The index of the category that is selected.</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineplus">+*                                By default 0 is returned.</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineplus">+*/</span>
<a href="#l11.138"></a><span id="l11.138"> function appendCategoryItems(aItem, aCategoryMenuList, aCommand) {</span>
<a href="#l11.139"></a><span id="l11.139">     var categoriesList = getPrefCategoriesArray();</span>
<a href="#l11.140"></a><span id="l11.140"> </span>
<a href="#l11.141"></a><span id="l11.141">     // 'split'may return an array containing one</span>
<a href="#l11.142"></a><span id="l11.142">     // empty string, rather than an empty array. This results in an empty</span>
<a href="#l11.143"></a><span id="l11.143">     // menulist item with no corresponding category.</span>
<a href="#l11.144"></a><span id="l11.144">     if (categoriesList.length == 1 &amp;&amp; !categoriesList[0].length) {</span>
<a href="#l11.145"></a><span id="l11.145">         categoriesList.pop();</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineat">@@ -324,17 +345,17 @@ function appendCategoryItems(aItem, aCat</span>
<a href="#l11.147"></a><span id="l11.147">     if (aItem) {</span>
<a href="#l11.148"></a><span id="l11.148">         for each (var itemCategory in aItem.getCategories({})) {</span>
<a href="#l11.149"></a><span id="l11.149">             if (!categoriesList.some(function(cat){ return cat == itemCategory; })){</span>
<a href="#l11.150"></a><span id="l11.150">                 categoriesList.push(itemCategory);</span>
<a href="#l11.151"></a><span id="l11.151">             }</span>
<a href="#l11.152"></a><span id="l11.152">         }</span>
<a href="#l11.153"></a><span id="l11.153">         cal.sortArrayByLocaleCollator(categoriesList);</span>
<a href="#l11.154"></a><span id="l11.154">     }</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineminus">-    </span>
<a href="#l11.156"></a><span id="l11.156" class="difflineplus">+</span>
<a href="#l11.157"></a><span id="l11.157">     while (aCategoryMenuList.hasChildNodes()) {</span>
<a href="#l11.158"></a><span id="l11.158">        aCategoryMenuList.removeChild(aCategoryMenuList.lastChild);</span>
<a href="#l11.159"></a><span id="l11.159">     }</span>
<a href="#l11.160"></a><span id="l11.160"> </span>
<a href="#l11.161"></a><span id="l11.161">     var indexToSelect = 0;</span>
<a href="#l11.162"></a><span id="l11.162">     var menuitem = addMenuItem(aCategoryMenuList, calGetString(&quot;calendar&quot;, &quot;None&quot;), &quot;NONE&quot;, aCommand);</span>
<a href="#l11.163"></a><span id="l11.163">     if (aCategoryMenuList.localName == &quot;menupopup&quot;) {</span>
<a href="#l11.164"></a><span id="l11.164">         menuitem.setAttribute(&quot;type&quot;, &quot;checkbox&quot;);</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineat">@@ -346,16 +367,25 @@ function appendCategoryItems(aItem, aCat</span>
<a href="#l11.166"></a><span id="l11.166">         }</span>
<a href="#l11.167"></a><span id="l11.167">         if (itemCategory &amp;&amp; categoriesList[i] == itemCategory) {</span>
<a href="#l11.168"></a><span id="l11.168">             indexToSelect = parseInt(i) + 1;  // Add 1 because of 'None'</span>
<a href="#l11.169"></a><span id="l11.169">         }</span>
<a href="#l11.170"></a><span id="l11.170">     }</span>
<a href="#l11.171"></a><span id="l11.171">     return indexToSelect;</span>
<a href="#l11.172"></a><span id="l11.172"> }</span>
<a href="#l11.173"></a><span id="l11.173"> </span>
<a href="#l11.174"></a><span id="l11.174" class="difflineplus">+/**</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineplus">+ * Helper function to add a menuitem to a menulist or similar.</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineplus">+ *</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineplus">+ * @param aParent     The XUL node to add the menuitem to.</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineplus">+ * @param aLabel      The label string of the menuitem.</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineplus">+ * @param aValue      The value attribute of the menuitem.</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineplus">+ * @param aCommand    The oncommand attribute of the menuitem.</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineplus">+ * @return            The newly created menuitem</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineplus">+ */</span>
<a href="#l11.183"></a><span id="l11.183"> function addMenuItem(aParent, aLabel, aValue, aCommand) {</span>
<a href="#l11.184"></a><span id="l11.184">     if (aParent.localName == &quot;menupopup&quot;) {</span>
<a href="#l11.185"></a><span id="l11.185">         var item = document.createElementNS(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;, &quot;menuitem&quot;);</span>
<a href="#l11.186"></a><span id="l11.186">         item.setAttribute(&quot;label&quot;, aLabel);</span>
<a href="#l11.187"></a><span id="l11.187">         if (aValue) {</span>
<a href="#l11.188"></a><span id="l11.188">             item.setAttribute(&quot;value&quot;, aValue);</span>
<a href="#l11.189"></a><span id="l11.189">         }</span>
<a href="#l11.190"></a><span id="l11.190">         if (aCommand) {</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineat">@@ -364,51 +394,50 @@ function addMenuItem(aParent, aLabel, aV</span>
<a href="#l11.192"></a><span id="l11.192">         aParent.appendChild(item);</span>
<a href="#l11.193"></a><span id="l11.193">     }</span>
<a href="#l11.194"></a><span id="l11.194">     else if (aParent.localName == &quot;menulist&quot;) {</span>
<a href="#l11.195"></a><span id="l11.195">         item = aParent.appendItem(aLabel, aValue);</span>
<a href="#l11.196"></a><span id="l11.196">     }</span>
<a href="#l11.197"></a><span id="l11.197">     return item;</span>
<a href="#l11.198"></a><span id="l11.198"> }</span>
<a href="#l11.199"></a><span id="l11.199"> </span>
<a href="#l11.200"></a><span id="l11.200" class="difflineminus">-</span>
<a href="#l11.201"></a><span id="l11.201"> /**</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineminus">- * sets a given attribute value on the children of a passed node</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineplus">+ * Sets a given attribute value on the children of a passed node</span>
<a href="#l11.204"></a><span id="l11.204">  *</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineminus">- * @param aParent           the parent node.</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineminus">- * @param aAttribute        the name of the attribute to be set.</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineminus">- * @param aValue            the value of the attribute.</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineminus">- * @param aFilterAttribute  OPTIONAL The name of an attribute that the child nodes carry</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineplus">+ * @param aParent           The parent node.</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineplus">+ * @param aAttribute        The name of the attribute to be set.</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineplus">+ * @param aValue            The value of the attribute.</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineplus">+ * @param aFilterAttribute  (optional) The name of an attribute that the child nodes carry</span>
<a href="#l11.213"></a><span id="l11.213">  *                            and that is used to filter the childnodes.</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineminus">- * @param aFilterValue      OPTIONAL The value of the filterattribute. If set only those</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineminus">- *                            childnodes are modified that have an attribute </span>
<a href="#l11.216"></a><span id="l11.216" class="difflineplus">+ * @param aFilterValue      (optional) The value of the filterattribute. If set only those</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineplus">+ *                            childnodes are modified that have an attribute</span>
<a href="#l11.218"></a><span id="l11.218">  *                            'aFilterAttribute' with the given value</span>
<a href="#l11.219"></a><span id="l11.219">  *                            'aFilterValue' set.</span>
<a href="#l11.220"></a><span id="l11.220">  */</span>
<a href="#l11.221"></a><span id="l11.221"> function setAttributeToChildren(aParent, aAttribute, aValue, aFilterAttribute, aFilterValue) {</span>
<a href="#l11.222"></a><span id="l11.222">     for (var i = 0; i &lt; aParent.childNodes.length; i++) {</span>
<a href="#l11.223"></a><span id="l11.223">         var element = aParent.childNodes[i];</span>
<a href="#l11.224"></a><span id="l11.224">         if (aFilterAttribute == null) {</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineminus">-            setElementValue(element, aValue, aAttribute);            </span>
<a href="#l11.226"></a><span id="l11.226" class="difflineplus">+            setElementValue(element, aValue, aAttribute);</span>
<a href="#l11.227"></a><span id="l11.227">         } else if (element.hasAttribute(aFilterAttribute)) {</span>
<a href="#l11.228"></a><span id="l11.228">             var compValue = element.getAttribute(aFilterAttribute);</span>
<a href="#l11.229"></a><span id="l11.229">             if (compValue === aFilterValue) {</span>
<a href="#l11.230"></a><span id="l11.230">                 setElementValue(element, aValue, aAttribute);</span>
<a href="#l11.231"></a><span id="l11.231">             }</span>
<a href="#l11.232"></a><span id="l11.232">         }</span>
<a href="#l11.233"></a><span id="l11.233">     }</span>
<a href="#l11.234"></a><span id="l11.234"> }</span>
<a href="#l11.235"></a><span id="l11.235"> </span>
<a href="#l11.236"></a><span id="l11.236"> /**</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineminus">- * checks a radio control or a radio-menuitem.</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineplus">+ * Checks a radio control or a radio-menuitem.</span>
<a href="#l11.239"></a><span id="l11.239">  *</span>
<a href="#l11.240"></a><span id="l11.240" class="difflineminus">- * @param aParent  the parent node of the 'radio controls', either radios</span>
<a href="#l11.241"></a><span id="l11.241" class="difflineplus">+ * @param aParent  The parent node of the 'radio controls', either radios</span>
<a href="#l11.242"></a><span id="l11.242">  *                  or menuitems of the type 'radio'.</span>
<a href="#l11.243"></a><span id="l11.243" class="difflineminus">- * @param avalue   the value of the radio control bound to be checked.</span>
<a href="#l11.244"></a><span id="l11.244" class="difflineminus">- * @return         true or false depending on if the a 'radio control' with the</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineplus">+ * @param avalue   The value of the radio control bound to be checked.</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineplus">+ * @return         True or false depending on if the a 'radio control' with the</span>
<a href="#l11.247"></a><span id="l11.247">  *                  given value could be checked.</span>
<a href="#l11.248"></a><span id="l11.248">  */</span>
<a href="#l11.249"></a><span id="l11.249"> function checkRadioControl(aParent, aValue) {</span>
<a href="#l11.250"></a><span id="l11.250">     for (var i = 0; i &lt; aParent.childNodes.length; i++) {</span>
<a href="#l11.251"></a><span id="l11.251">         var element = aParent.childNodes[i];</span>
<a href="#l11.252"></a><span id="l11.252">         if (element.hasAttribute(&quot;value&quot;)) {</span>
<a href="#l11.253"></a><span id="l11.253">             var compValue = element.getAttribute(&quot;value&quot;);</span>
<a href="#l11.254"></a><span id="l11.254">             if (compValue == aValue) {</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineat">@@ -423,42 +452,64 @@ function checkRadioControl(aParent, aVal</span>
<a href="#l11.256"></a><span id="l11.256">                     return true;</span>
<a href="#l11.257"></a><span id="l11.257">                 }</span>
<a href="#l11.258"></a><span id="l11.258">             }</span>
<a href="#l11.259"></a><span id="l11.259">         }</span>
<a href="#l11.260"></a><span id="l11.260">     }</span>
<a href="#l11.261"></a><span id="l11.261">     return false;</span>
<a href="#l11.262"></a><span id="l11.262"> }</span>
<a href="#l11.263"></a><span id="l11.263"> </span>
<a href="#l11.264"></a><span id="l11.264" class="difflineplus">+/**</span>
<a href="#l11.265"></a><span id="l11.265" class="difflineplus">+ * Sets the category on the given item, from the menuitem element.</span>
<a href="#l11.266"></a><span id="l11.266" class="difflineplus">+ *</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineplus">+ * @param aItem           The item to set the category on.</span>
<a href="#l11.268"></a><span id="l11.268" class="difflineplus">+ * @param aMenuElement    The menuitem to retrieve the category from.</span>
<a href="#l11.269"></a><span id="l11.269" class="difflineplus">+ */</span>
<a href="#l11.270"></a><span id="l11.270"> function setCategory(aItem, aMenuElement) {</span>
<a href="#l11.271"></a><span id="l11.271">     // Category</span>
<a href="#l11.272"></a><span id="l11.272">     var category = getElementValue(aMenuElement);</span>
<a href="#l11.273"></a><span id="l11.273">     // xxx todo: what about category &quot;NONE&quot;?</span>
<a href="#l11.274"></a><span id="l11.274">     if (category == &quot;NONE&quot;) {</span>
<a href="#l11.275"></a><span id="l11.275">         aItem.setCategories(0, []);</span>
<a href="#l11.276"></a><span id="l11.276">     } else {</span>
<a href="#l11.277"></a><span id="l11.277">         aItem.setCategories(1, [category]);</span>
<a href="#l11.278"></a><span id="l11.278">     }</span>
<a href="#l11.279"></a><span id="l11.279"> }</span>
<a href="#l11.280"></a><span id="l11.280"> </span>
<a href="#l11.281"></a><span id="l11.281" class="difflineplus">+/**</span>
<a href="#l11.282"></a><span id="l11.282" class="difflineplus">+ * Enables or disables the given element depending on the checkbox state.</span>
<a href="#l11.283"></a><span id="l11.283" class="difflineplus">+ *</span>
<a href="#l11.284"></a><span id="l11.284" class="difflineplus">+ * @param checkboxId    The ID of the XUL checkbox element.</span>
<a href="#l11.285"></a><span id="l11.285" class="difflineplus">+ * @param elementId     The element to change the disabled state on.</span>
<a href="#l11.286"></a><span id="l11.286" class="difflineplus">+ */</span>
<a href="#l11.287"></a><span id="l11.287"> function processEnableCheckbox(checkboxId, elementId) {</span>
<a href="#l11.288"></a><span id="l11.288">     var checked = document.getElementById(checkboxId).checked;</span>
<a href="#l11.289"></a><span id="l11.289">     setElementValue(elementId, !checked &amp;&amp; &quot;true&quot;, &quot;disabled&quot;);</span>
<a href="#l11.290"></a><span id="l11.290"> }</span>
<a href="#l11.291"></a><span id="l11.291"> </span>
<a href="#l11.292"></a><span id="l11.292"> /**</span>
<a href="#l11.293"></a><span id="l11.293" class="difflineminus">- *  Enable/disable button if there are children in a listbox</span>
<a href="#l11.294"></a><span id="l11.294" class="difflineplus">+ * Enable/disable button if there are children in a listbox</span>
<a href="#l11.295"></a><span id="l11.295" class="difflineplus">+ *</span>
<a href="#l11.296"></a><span id="l11.296" class="difflineplus">+ * XXX This function needs renaming, it can do more than just buttons.</span>
<a href="#l11.297"></a><span id="l11.297" class="difflineplus">+ *</span>
<a href="#l11.298"></a><span id="l11.298" class="difflineplus">+ * @param listboxId     The ID of the listbox to check.</span>
<a href="#l11.299"></a><span id="l11.299" class="difflineplus">+ * @param buttonId      The element to change the disabled state on.</span>
<a href="#l11.300"></a><span id="l11.300">  */</span>
<a href="#l11.301"></a><span id="l11.301"> function updateListboxDeleteButton(listboxId, buttonId) {</span>
<a href="#l11.302"></a><span id="l11.302">     var rowCount = document.getElementById(listboxId).getRowCount();</span>
<a href="#l11.303"></a><span id="l11.303">     setElementValue(buttonId, rowCount &lt; 1 &amp;&amp; &quot;true&quot;, &quot;disabled&quot;);</span>
<a href="#l11.304"></a><span id="l11.304"> }</span>
<a href="#l11.305"></a><span id="l11.305"> </span>
<a href="#l11.306"></a><span id="l11.306"> /**</span>
<a href="#l11.307"></a><span id="l11.307" class="difflineminus">- *  Update plural singular menu items</span>
<a href="#l11.308"></a><span id="l11.308" class="difflineplus">+ * Update plural singular menu items</span>
<a href="#l11.309"></a><span id="l11.309" class="difflineplus">+ *</span>
<a href="#l11.310"></a><span id="l11.310" class="difflineplus">+ * XXX This function needs fixing with PluralForm.jsm</span>
<a href="#l11.311"></a><span id="l11.311" class="difflineplus">+ *</span>
<a href="#l11.312"></a><span id="l11.312" class="difflineplus">+ * @param lengthFildId    The ID of the element containing the number</span>
<a href="#l11.313"></a><span id="l11.313" class="difflineplus">+ * @param menuId          The menu to update labels in.</span>
<a href="#l11.314"></a><span id="l11.314">  */</span>
<a href="#l11.315"></a><span id="l11.315"> function updateMenuLabels(lengthFieldId, menuId ) {</span>
<a href="#l11.316"></a><span id="l11.316">     var field = document.getElementById(lengthFieldId);</span>
<a href="#l11.317"></a><span id="l11.317">     var menu  = document.getElementById(menuId);</span>
<a href="#l11.318"></a><span id="l11.318"> </span>
<a href="#l11.319"></a><span id="l11.319">     // figure out whether we should use singular or plural</span>
<a href="#l11.320"></a><span id="l11.320">     var length = field.value;</span>
<a href="#l11.321"></a><span id="l11.321"> </span>
<a href="#l11.322"></a><span id="l11.322" class="difflineat">@@ -491,95 +542,111 @@ function updateMenuLabels(lengthFieldId,</span>
<a href="#l11.323"></a><span id="l11.323">         // force the menu selection to redraw</span>
<a href="#l11.324"></a><span id="l11.324">         var saveSelectedIndex = menu.selectedIndex;</span>
<a href="#l11.325"></a><span id="l11.325">         menu.selectedIndex = -1;</span>
<a href="#l11.326"></a><span id="l11.326">         menu.selectedIndex = saveSelectedIndex;</span>
<a href="#l11.327"></a><span id="l11.327">     }</span>
<a href="#l11.328"></a><span id="l11.328"> }</span>
<a href="#l11.329"></a><span id="l11.329"> </span>
<a href="#l11.330"></a><span id="l11.330"> /**</span>
<a href="#l11.331"></a><span id="l11.331" class="difflineminus">- * Select value in menuList.  Throws string if no such value.</span>
<a href="#l11.332"></a><span id="l11.332" class="difflineplus">+ * Select value in menuList. Throws string if no such value.</span>
<a href="#l11.333"></a><span id="l11.333" class="difflineplus">+ *</span>
<a href="#l11.334"></a><span id="l11.334" class="difflineplus">+ * XXX Isn't it enough to just do menuList.value = value ?</span>
<a href="#l11.335"></a><span id="l11.335" class="difflineplus">+ *</span>
<a href="#l11.336"></a><span id="l11.336" class="difflineplus">+ * @param menuListId    The ID of the menulist to check.</span>
<a href="#l11.337"></a><span id="l11.337" class="difflineplus">+ * @param value         The value to set.</span>
<a href="#l11.338"></a><span id="l11.338" class="difflineplus">+ * @throws              String error if value not found.</span>
<a href="#l11.339"></a><span id="l11.339">  */</span>
<a href="#l11.340"></a><span id="l11.340"> function menuListSelectItem(menuListId, value) {</span>
<a href="#l11.341"></a><span id="l11.341">     var menuList = document.getElementById(menuListId);</span>
<a href="#l11.342"></a><span id="l11.342">     var index = menuListIndexOf(menuList, value);</span>
<a href="#l11.343"></a><span id="l11.343">     if (index != -1) {</span>
<a href="#l11.344"></a><span id="l11.344">         menuList.selectedIndex = index;</span>
<a href="#l11.345"></a><span id="l11.345">     } else {</span>
<a href="#l11.346"></a><span id="l11.346">         throw &quot;menuListSelectItem: No such Element: &quot;+value;</span>
<a href="#l11.347"></a><span id="l11.347">     }</span>
<a href="#l11.348"></a><span id="l11.348"> }</span>
<a href="#l11.349"></a><span id="l11.349"> </span>
<a href="#l11.350"></a><span id="l11.350"> /**</span>
<a href="#l11.351"></a><span id="l11.351">  * Find index of menuitem with the given value, or return -1 if not found.</span>
<a href="#l11.352"></a><span id="l11.352" class="difflineplus">+ *</span>
<a href="#l11.353"></a><span id="l11.353" class="difflineplus">+ * @param menuListId    The XUL menulist node to check.</span>
<a href="#l11.354"></a><span id="l11.354" class="difflineplus">+ * @param value         The value to look for.</span>
<a href="#l11.355"></a><span id="l11.355" class="difflineplus">+ * @return              The child index of the node that matches, or -1.</span>
<a href="#l11.356"></a><span id="l11.356">  */</span>
<a href="#l11.357"></a><span id="l11.357"> function menuListIndexOf(menuList, value) {</span>
<a href="#l11.358"></a><span id="l11.358">     var items = menuList.menupopup.childNodes;</span>
<a href="#l11.359"></a><span id="l11.359">     var index = -1;</span>
<a href="#l11.360"></a><span id="l11.360">     for (var i = 0; i &lt; items.length; i++) {</span>
<a href="#l11.361"></a><span id="l11.361">         var element = items[i];</span>
<a href="#l11.362"></a><span id="l11.362">         if (element.nodeName == &quot;menuitem&quot;) {</span>
<a href="#l11.363"></a><span id="l11.363">             index++;</span>
<a href="#l11.364"></a><span id="l11.364">         }</span>
<a href="#l11.365"></a><span id="l11.365">         if (element.getAttribute(&quot;value&quot;) == value) {</span>
<a href="#l11.366"></a><span id="l11.366">             return index;</span>
<a href="#l11.367"></a><span id="l11.367">         }</span>
<a href="#l11.368"></a><span id="l11.368">     }</span>
<a href="#l11.369"></a><span id="l11.369">     return -1; // not found</span>
<a href="#l11.370"></a><span id="l11.370"> }</span>
<a href="#l11.371"></a><span id="l11.371"> </span>
<a href="#l11.372"></a><span id="l11.372" class="difflineplus">+/**</span>
<a href="#l11.373"></a><span id="l11.373" class="difflineplus">+ * Creates the given element in the XUL namespace.</span>
<a href="#l11.374"></a><span id="l11.374" class="difflineplus">+ *</span>
<a href="#l11.375"></a><span id="l11.375" class="difflineplus">+ * @param el    The local name of the element to create.</span>
<a href="#l11.376"></a><span id="l11.376" class="difflineplus">+ * @return      The XUL element requested.</span>
<a href="#l11.377"></a><span id="l11.377" class="difflineplus">+ */</span>
<a href="#l11.378"></a><span id="l11.378"> function createXULElement(el) {</span>
<a href="#l11.379"></a><span id="l11.379">     return document.createElementNS(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;, el);</span>
<a href="#l11.380"></a><span id="l11.380"> }</span>
<a href="#l11.381"></a><span id="l11.381"> </span>
<a href="#l11.382"></a><span id="l11.382"> /**</span>
<a href="#l11.383"></a><span id="l11.383">  * A helper function to calculate and add up certain css-values of a box.</span>
<a href="#l11.384"></a><span id="l11.384">  * It is required, that all css values can be converted to integers</span>
<a href="#l11.385"></a><span id="l11.385" class="difflineminus">- * see also </span>
<a href="#l11.386"></a><span id="l11.386" class="difflineplus">+ * see also</span>
<a href="#l11.387"></a><span id="l11.387">  * http://www.w3.org/TR/DOM-Level-2-Style/css.html#CSS-CSSview-getComputedStyle</span>
<a href="#l11.388"></a><span id="l11.388">  * @param aXULElement   The xul element to be inspected.</span>
<a href="#l11.389"></a><span id="l11.389">  * @param aStyleProps   The css style properties for which values are to be retrieved</span>
<a href="#l11.390"></a><span id="l11.390">  *                        e.g. 'font-size', 'min-width&quot; etc.</span>
<a href="#l11.391"></a><span id="l11.391">  * @return              An integer value denoting the optimal minimum width</span>
<a href="#l11.392"></a><span id="l11.392">  */</span>
<a href="#l11.393"></a><span id="l11.393"> function getSummarizedStyleValues(aXULElement, aStyleProps) {</span>
<a href="#l11.394"></a><span id="l11.394">     var retValue = 0;</span>
<a href="#l11.395"></a><span id="l11.395">     var cssStyleDeclares = document.defaultView.getComputedStyle(aXULElement, null);</span>
<a href="#l11.396"></a><span id="l11.396">     for each (var prop in aStyleProps) {</span>
<a href="#l11.397"></a><span id="l11.397">         retValue += parseInt(cssStyleDeclares.getPropertyValue(prop), 10);</span>
<a href="#l11.398"></a><span id="l11.398" class="difflineminus">-    }    </span>
<a href="#l11.399"></a><span id="l11.399" class="difflineplus">+    }</span>
<a href="#l11.400"></a><span id="l11.400">     return retValue;</span>
<a href="#l11.401"></a><span id="l11.401"> }</span>
<a href="#l11.402"></a><span id="l11.402"> </span>
<a href="#l11.403"></a><span id="l11.403"> /**</span>
<a href="#l11.404"></a><span id="l11.404">  * Calculates the optimal minimum width based on the set css style-rules</span>
<a href="#l11.405"></a><span id="l11.405" class="difflineminus">- * by considering the css rules for the min-width, padding, border, margin </span>
<a href="#l11.406"></a><span id="l11.406" class="difflineplus">+ * by considering the css rules for the min-width, padding, border, margin</span>
<a href="#l11.407"></a><span id="l11.407">  * and border of the box.</span>
<a href="#l11.408"></a><span id="l11.408">  *</span>
<a href="#l11.409"></a><span id="l11.409">  * @param aXULElement   The xul element to be inspected.</span>
<a href="#l11.410"></a><span id="l11.410">  * @return              An integer value denoting the optimal minimum width</span>
<a href="#l11.411"></a><span id="l11.411">  */</span>
<a href="#l11.412"></a><span id="l11.412"> function getOptimalMinimumWidth(aXULElement) {</span>
<a href="#l11.413"></a><span id="l11.413">     return getSummarizedStyleValues(aXULElement, [&quot;min-width&quot;,</span>
<a href="#l11.414"></a><span id="l11.414">                                                   &quot;padding-left&quot;, &quot;padding-right&quot;,</span>
<a href="#l11.415"></a><span id="l11.415">                                                   &quot;margin-left&quot;, &quot;margin-top&quot;,</span>
<a href="#l11.416"></a><span id="l11.416">                                                   &quot;border-left-width&quot;, &quot;border-right-width&quot;]);</span>
<a href="#l11.417"></a><span id="l11.417"> }</span>
<a href="#l11.418"></a><span id="l11.418"> </span>
<a href="#l11.419"></a><span id="l11.419"> /**</span>
<a href="#l11.420"></a><span id="l11.420">  * Calculates the optimal minimum height based on the set css style-rules</span>
<a href="#l11.421"></a><span id="l11.421" class="difflineminus">- * by considering the css rules for the font-size, padding, border, margin </span>
<a href="#l11.422"></a><span id="l11.422" class="difflineplus">+ * by considering the css rules for the font-size, padding, border, margin</span>
<a href="#l11.423"></a><span id="l11.423">  * and border of the box. In its current state the line-height is considered</span>
<a href="#l11.424"></a><span id="l11.424">  * by assuming that it's size is about one third of the size of the font-size</span>
<a href="#l11.425"></a><span id="l11.425">  *</span>
<a href="#l11.426"></a><span id="l11.426">  * @param aXULElement   The xul-element to be inspected.</span>
<a href="#l11.427"></a><span id="l11.427">  * @return              An integer value denoting the optimal minimum height</span>
<a href="#l11.428"></a><span id="l11.428">  */</span>
<a href="#l11.429"></a><span id="l11.429"> function getOptimalMinimumHeight(aXULElement) {</span>
<a href="#l11.430"></a><span id="l11.430" class="difflineminus">-    // the following line of code presumes that the line-height is set to &quot;normal&quot; </span>
<a href="#l11.431"></a><span id="l11.431" class="difflineplus">+    // the following line of code presumes that the line-height is set to &quot;normal&quot;</span>
<a href="#l11.432"></a><span id="l11.432">     // which is supposed to be a &quot;reasonable distance&quot; between the lines</span>
<a href="#l11.433"></a><span id="l11.433">     var firstEntity = parseInt(1.35 * getSummarizedStyleValues(aXULElement, [&quot;font-size&quot;]), 10);</span>
<a href="#l11.434"></a><span id="l11.434">     var secondEntity = getSummarizedStyleValues(aXULElement,</span>
<a href="#l11.435"></a><span id="l11.435">                                                 [&quot;padding-bottom&quot;, &quot;padding-top&quot;,</span>
<a href="#l11.436"></a><span id="l11.436">                                                 &quot;margin-bottom&quot;, &quot;margin-top&quot;,</span>
<a href="#l11.437"></a><span id="l11.437">                                                 &quot;border-bottom-width&quot;, &quot;border-top-width&quot;]);</span>
<a href="#l11.438"></a><span id="l11.438">     return (firstEntity + secondEntity);</span>
<a href="#l11.439"></a><span id="l11.439"> }</span>
<a href="#l11.440"></a><span id="l11.440" class="difflineat">@@ -629,16 +696,23 @@ function validateNaturalNums(event) {</span>
<a href="#l11.441"></a><span id="l11.441">     validateIntegers(event);</span>
<a href="#l11.442"></a><span id="l11.442">     var num = event.target.value;</span>
<a href="#l11.443"></a><span id="l11.443">     if (num &lt; 0) {</span>
<a href="#l11.444"></a><span id="l11.444">         event.target.value = -1 * num;</span>
<a href="#l11.445"></a><span id="l11.445">         event.preventDefault();</span>
<a href="#l11.446"></a><span id="l11.446">     }</span>
<a href="#l11.447"></a><span id="l11.447"> }</span>
<a href="#l11.448"></a><span id="l11.448"> </span>
<a href="#l11.449"></a><span id="l11.449" class="difflineplus">+/**</span>
<a href="#l11.450"></a><span id="l11.450" class="difflineplus">+ * Gets the &quot;other&quot; orientation value, i.e if &quot;horizontal&quot; is passed, &quot;vertical&quot;</span>
<a href="#l11.451"></a><span id="l11.451" class="difflineplus">+ * is returned and vice versa.</span>
<a href="#l11.452"></a><span id="l11.452" class="difflineplus">+ *</span>
<a href="#l11.453"></a><span id="l11.453" class="difflineplus">+ * @param aOrientation    The orientation value to turn around.</span>
<a href="#l11.454"></a><span id="l11.454" class="difflineplus">+ * @return                The opposite orientation value.</span>
<a href="#l11.455"></a><span id="l11.455" class="difflineplus">+ */</span>
<a href="#l11.456"></a><span id="l11.456"> function getOtherOrientation(aOrientation) {</span>
<a href="#l11.457"></a><span id="l11.457">      return (aOrientation == &quot;horizontal&quot; ? &quot;vertical&quot; : &quot;horizontal&quot;);</span>
<a href="#l11.458"></a><span id="l11.458"> }</span>
<a href="#l11.459"></a><span id="l11.459"> </span>
<a href="#l11.460"></a><span id="l11.460"> /**</span>
<a href="#l11.461"></a><span id="l11.461">  * Setting labels on a menuitem doesn't update the label that is shown when the</span>
<a href="#l11.462"></a><span id="l11.462">  * menuitem is selected. This function takes care by reselecting the item</span>
<a href="#l11.463"></a><span id="l11.463">  *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/calendar/base/content/calendar-views.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/calendar/base/content/calendar-views.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -37,26 +37,34 @@</span>
<a href="#l12.4"></a><span id="l12.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l12.5"></a><span id="l12.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l12.6"></a><span id="l12.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l12.7"></a><span id="l12.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l12.8"></a><span id="l12.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l12.9"></a><span id="l12.9">  *</span>
<a href="#l12.10"></a><span id="l12.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+/**</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+ * Controller for the views</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+ * @see calIcalendarViewController</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+ */</span>
<a href="#l12.16"></a><span id="l12.16"> var calendarViewController = {</span>
<a href="#l12.17"></a><span id="l12.17">     QueryInterface: function(aIID) {</span>
<a href="#l12.18"></a><span id="l12.18">         if (!aIID.equals(Components.interfaces.calICalendarViewController) &amp;&amp;</span>
<a href="#l12.19"></a><span id="l12.19">             !aIID.equals(Components.interfaces.nsISupports)) {</span>
<a href="#l12.20"></a><span id="l12.20">             throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l12.21"></a><span id="l12.21">         }</span>
<a href="#l12.22"></a><span id="l12.22"> </span>
<a href="#l12.23"></a><span id="l12.23">         return this;</span>
<a href="#l12.24"></a><span id="l12.24">     },</span>
<a href="#l12.25"></a><span id="l12.25"> </span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+    /**</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+     * Creates a new event</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+     * @see calICalendarViewController</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+     */</span>
<a href="#l12.30"></a><span id="l12.30">     createNewEvent: function (aCalendar, aStartTime, aEndTime, aForceAllday) {</span>
<a href="#l12.31"></a><span id="l12.31">         aCalendar = aCalendar || getSelectedCalendar();</span>
<a href="#l12.32"></a><span id="l12.32"> </span>
<a href="#l12.33"></a><span id="l12.33">         // if we're given both times, skip the dialog</span>
<a href="#l12.34"></a><span id="l12.34">         if (aStartTime &amp;&amp; aEndTime &amp;&amp; !aStartTime.isDate &amp;&amp; !aEndTime.isDate) {</span>
<a href="#l12.35"></a><span id="l12.35">             var event = createEvent();</span>
<a href="#l12.36"></a><span id="l12.36">             event.startDate = aStartTime;</span>
<a href="#l12.37"></a><span id="l12.37">             event.endDate = aEndTime;</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineat">@@ -68,20 +76,25 @@ var calendarViewController = {</span>
<a href="#l12.39"></a><span id="l12.39">             doTransaction('add', event, aCalendar, null, null);</span>
<a href="#l12.40"></a><span id="l12.40">         } else {</span>
<a href="#l12.41"></a><span id="l12.41">             createEventWithDialog(aCalendar, aStartTime, null, null, null, aForceAllday);</span>
<a href="#l12.42"></a><span id="l12.42">         }</span>
<a href="#l12.43"></a><span id="l12.43">     },</span>
<a href="#l12.44"></a><span id="l12.44"> </span>
<a href="#l12.45"></a><span id="l12.45">     pendingJobs: [],</span>
<a href="#l12.46"></a><span id="l12.46"> </span>
<a href="#l12.47"></a><span id="l12.47" class="difflineminus">-    // in order to initiate a modification for the occurrence passed as argument</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineminus">-    // we create an object that records the necessary details and store it in an</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineminus">-    // internal array ('pendingJobs'). this way we're in a position to terminate</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineminus">-    // any pending modification if need should be.</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+    /**</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+     * In order to initiate a modification for the occurrence passed as argument</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+     * we create an object that records the necessary details and store it in an</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+     * internal array ('pendingJobs'). this way we're in a position to terminate</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+     * any pending modification if need should be.</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+     *</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+     * @param aOccurrence       The occurrence to create the pending</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+     *                            modification for.</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+     */</span>
<a href="#l12.60"></a><span id="l12.60">     createPendingModification: function (aOccurrence) {</span>
<a href="#l12.61"></a><span id="l12.61">         // finalize a (possibly) pending modification. this will notify</span>
<a href="#l12.62"></a><span id="l12.62">         // an open dialog to save any outstanding modifications.</span>
<a href="#l12.63"></a><span id="l12.63">         aOccurrence = this.finalizePendingModification(aOccurrence);</span>
<a href="#l12.64"></a><span id="l12.64"> </span>
<a href="#l12.65"></a><span id="l12.65">         // XXX TODO logic to ask for which occurrence to modify is currently in</span>
<a href="#l12.66"></a><span id="l12.66">         // modifyEventWithDialog, since the type of transactions done depend on</span>
<a href="#l12.67"></a><span id="l12.67">         // this. This in turn makes the aOccurrence here be potentially wrong, I</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineat">@@ -101,20 +114,24 @@ var calendarViewController = {</span>
<a href="#l12.69"></a><span id="l12.69">             }</span>
<a href="#l12.70"></a><span id="l12.70">         }</span>
<a href="#l12.71"></a><span id="l12.71"> </span>
<a href="#l12.72"></a><span id="l12.72">         this.pendingJobs.push(pendingModification);</span>
<a href="#l12.73"></a><span id="l12.73"> </span>
<a href="#l12.74"></a><span id="l12.74">         modifyEventWithDialog(aOccurrence, pendingModification, true);</span>
<a href="#l12.75"></a><span id="l12.75">     },</span>
<a href="#l12.76"></a><span id="l12.76"> </span>
<a href="#l12.77"></a><span id="l12.77" class="difflineminus">-    // iterate the list of pending modifications and see if the occurrence</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineminus">-    // passed as argument is currently about to be modified (event dialog is</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineminus">-    // open with the item in question). if this should be the case we call</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineminus">-    // finalize() in order to bring the dialog down and avoid dataloss.</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+    /**</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+     * Iterate the list of pending modifications and see if the occurrence</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+     * passed as argument is currently about to be modified (event dialog is</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+     * open with the item in question). If this should be the case we call</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+     * finalize() in order to bring the dialog down and avoid dataloss.</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+     *</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+     * @param aOccurrence       The occurrence to finalize the modification for.</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+     */</span>
<a href="#l12.89"></a><span id="l12.89">     finalizePendingModification: function (aOccurrence) {</span>
<a href="#l12.90"></a><span id="l12.90"> </span>
<a href="#l12.91"></a><span id="l12.91">       for each (var job in this.pendingJobs) {</span>
<a href="#l12.92"></a><span id="l12.92">           var item = job.item;</span>
<a href="#l12.93"></a><span id="l12.93">           var parent = item.parent;</span>
<a href="#l12.94"></a><span id="l12.94">           if ((item.hashId == aOccurrence.hashId) ||</span>
<a href="#l12.95"></a><span id="l12.95">               (item.parentItem.hashId == aOccurrence.hashId) ||</span>
<a href="#l12.96"></a><span id="l12.96">               (item.hashId == aOccurrence.parentItem.hashId)) {</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineat">@@ -122,16 +139,20 @@ var calendarViewController = {</span>
<a href="#l12.98"></a><span id="l12.98">               aOccurrence = job.finalize();</span>
<a href="#l12.99"></a><span id="l12.99">               break;</span>
<a href="#l12.100"></a><span id="l12.100">         }</span>
<a href="#l12.101"></a><span id="l12.101">       }</span>
<a href="#l12.102"></a><span id="l12.102"> </span>
<a href="#l12.103"></a><span id="l12.103">       return aOccurrence;</span>
<a href="#l12.104"></a><span id="l12.104">     },</span>
<a href="#l12.105"></a><span id="l12.105"> </span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+    /**</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+     * Modifies the given occurrence</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+     * @see calICalendarViewController</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineplus">+     */</span>
<a href="#l12.110"></a><span id="l12.110">     modifyOccurrence: function (aOccurrence, aNewStartTime, aNewEndTime, aNewTitle) {</span>
<a href="#l12.111"></a><span id="l12.111"> </span>
<a href="#l12.112"></a><span id="l12.112">         aOccurrence = this.finalizePendingModification(aOccurrence);</span>
<a href="#l12.113"></a><span id="l12.113"> </span>
<a href="#l12.114"></a><span id="l12.114">         // if modifying this item directly (e.g. just dragged to new time),</span>
<a href="#l12.115"></a><span id="l12.115">         // then do so; otherwise pop up the dialog</span>
<a href="#l12.116"></a><span id="l12.116">         if (aNewStartTime || aNewEndTime || aNewTitle) {</span>
<a href="#l12.117"></a><span id="l12.117">             var instance = aOccurrence.clone();</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineat">@@ -166,16 +187,20 @@ var calendarViewController = {</span>
<a href="#l12.119"></a><span id="l12.119">             }</span>
<a href="#l12.120"></a><span id="l12.120"> </span>
<a href="#l12.121"></a><span id="l12.121">             doTransaction('modify', instance, instance.calendar, aOccurrence, null);</span>
<a href="#l12.122"></a><span id="l12.122">         } else {</span>
<a href="#l12.123"></a><span id="l12.123">             this.createPendingModification(aOccurrence);</span>
<a href="#l12.124"></a><span id="l12.124">         }</span>
<a href="#l12.125"></a><span id="l12.125">     },</span>
<a href="#l12.126"></a><span id="l12.126"> </span>
<a href="#l12.127"></a><span id="l12.127" class="difflineplus">+    /**</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineplus">+     * Deletes the given occurrences</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineplus">+     * @see calICalendarViewController</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineplus">+     */</span>
<a href="#l12.131"></a><span id="l12.131">     deleteOccurrences: function (aCount,</span>
<a href="#l12.132"></a><span id="l12.132">                                  aOccurrences,</span>
<a href="#l12.133"></a><span id="l12.133">                                  aUseParentItems,</span>
<a href="#l12.134"></a><span id="l12.134">                                  aDoNotConfirm) {</span>
<a href="#l12.135"></a><span id="l12.135">         startBatchTransaction();</span>
<a href="#l12.136"></a><span id="l12.136">         var recurringItems = {};</span>
<a href="#l12.137"></a><span id="l12.137"> </span>
<a href="#l12.138"></a><span id="l12.138">         function getSavedItem(aItemToDelete) {</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineat">@@ -245,41 +270,49 @@ var calendarViewController = {</span>
<a href="#l12.140"></a><span id="l12.140">     }</span>
<a href="#l12.141"></a><span id="l12.141"> };</span>
<a href="#l12.142"></a><span id="l12.142"> </span>
<a href="#l12.143"></a><span id="l12.143"> /**</span>
<a href="#l12.144"></a><span id="l12.144">  * This function provides a neutral way to switch between views.</span>
<a href="#l12.145"></a><span id="l12.145">  * XXX Kind of confusing. This function calls the app specific function, which</span>
<a href="#l12.146"></a><span id="l12.146">  * again calls the common switchToView function. They should be consolidated in</span>
<a href="#l12.147"></a><span id="l12.147">  * a different bug.</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineplus">+ *</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineplus">+ * @param type      The type of view to show</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineplus">+ * @param event     (optional) A DOM event that caused the view to show.</span>
<a href="#l12.151"></a><span id="l12.151">  */</span>
<a href="#l12.152"></a><span id="l12.152"> function showCalendarView(type, event) {</span>
<a href="#l12.153"></a><span id="l12.153">     if (isSunbird()) {</span>
<a href="#l12.154"></a><span id="l12.154">         sbSwitchToView(type, event);</span>
<a href="#l12.155"></a><span id="l12.155">     } else if (document.getElementById('switch2calendar').getAttribute('checked')) {</span>
<a href="#l12.156"></a><span id="l12.156">         ltnShowCalendarView(type, event);</span>
<a href="#l12.157"></a><span id="l12.157">     }</span>
<a href="#l12.158"></a><span id="l12.158">     onCalendarViewResize(event);</span>
<a href="#l12.159"></a><span id="l12.159"> }</span>
<a href="#l12.160"></a><span id="l12.160"> </span>
<a href="#l12.161"></a><span id="l12.161"> /**</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineminus">- * This function acts like the above, but does not bring the view to the front</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineplus">+ * This function acts like showCalendarView, but does not bring the view to the front</span>
<a href="#l12.164"></a><span id="l12.164">  * if the application is showing other elements (i.e Lightning).</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineplus">+ *</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineplus">+ * @see showCalendarView</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineplus">+ * @param type          The type of view to select.</span>
<a href="#l12.168"></a><span id="l12.168">  */</span>
<a href="#l12.169"></a><span id="l12.169"> function selectCalendarView(type) {</span>
<a href="#l12.170"></a><span id="l12.170">     if (isSunbird()) {</span>
<a href="#l12.171"></a><span id="l12.171">         sbSwitchToView(type);</span>
<a href="#l12.172"></a><span id="l12.172">     } else {</span>
<a href="#l12.173"></a><span id="l12.173">         ltnSelectCalendarView(type);</span>
<a href="#l12.174"></a><span id="l12.174">     }</span>
<a href="#l12.175"></a><span id="l12.175"> }</span>
<a href="#l12.176"></a><span id="l12.176"> </span>
<a href="#l12.177"></a><span id="l12.177"> /**</span>
<a href="#l12.178"></a><span id="l12.178">  * This function does the common steps to switch between views. Should be called</span>
<a href="#l12.179"></a><span id="l12.179">  * from app-specific view switching functions</span>
<a href="#l12.180"></a><span id="l12.180" class="difflineplus">+ *</span>
<a href="#l12.181"></a><span id="l12.181" class="difflineplus">+ * @param aViewType     The type of view to select.</span>
<a href="#l12.182"></a><span id="l12.182">  */</span>
<a href="#l12.183"></a><span id="l12.183"> function switchToView(aViewType) {</span>
<a href="#l12.184"></a><span id="l12.184">     var viewDeck = getViewDeck();</span>
<a href="#l12.185"></a><span id="l12.185">     var selectedDay;</span>
<a href="#l12.186"></a><span id="l12.186">     var currentSelection = [];</span>
<a href="#l12.187"></a><span id="l12.187"> </span>
<a href="#l12.188"></a><span id="l12.188">     // Set up the view commands</span>
<a href="#l12.189"></a><span id="l12.189">     var views = viewDeck.childNodes;</span>
<a href="#l12.190"></a><span id="l12.190" class="difflineat">@@ -332,41 +365,53 @@ function switchToView(aViewType) {</span>
<a href="#l12.191"></a><span id="l12.191">         view.controller = calendarViewController;</span>
<a href="#l12.192"></a><span id="l12.192">     }</span>
<a href="#l12.193"></a><span id="l12.193"> </span>
<a href="#l12.194"></a><span id="l12.194">     view.goToDay(selectedDay);</span>
<a href="#l12.195"></a><span id="l12.195">     view.setSelectedItems(currentSelection.length, currentSelection);</span>
<a href="#l12.196"></a><span id="l12.196"> }</span>
<a href="#l12.197"></a><span id="l12.197"> </span>
<a href="#l12.198"></a><span id="l12.198"> /**</span>
<a href="#l12.199"></a><span id="l12.199" class="difflineminus">- * Returns the calendar view deck.</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineplus">+ * Returns the calendar view deck XUL element.</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineplus">+ *</span>
<a href="#l12.202"></a><span id="l12.202" class="difflineplus">+ * @return      The view-deck element.</span>
<a href="#l12.203"></a><span id="l12.203">  */</span>
<a href="#l12.204"></a><span id="l12.204"> function getViewDeck() {</span>
<a href="#l12.205"></a><span id="l12.205">     return document.getElementById(&quot;view-deck&quot;);</span>
<a href="#l12.206"></a><span id="l12.206"> }</span>
<a href="#l12.207"></a><span id="l12.207"> </span>
<a href="#l12.208"></a><span id="l12.208"> /**</span>
<a href="#l12.209"></a><span id="l12.209" class="difflineminus">- * Returns the currently visible calendar view.</span>
<a href="#l12.210"></a><span id="l12.210" class="difflineplus">+ * Returns the currently selected calendar view.</span>
<a href="#l12.211"></a><span id="l12.211" class="difflineplus">+ *</span>
<a href="#l12.212"></a><span id="l12.212" class="difflineplus">+ * @return      The selected calendar view</span>
<a href="#l12.213"></a><span id="l12.213">  */</span>
<a href="#l12.214"></a><span id="l12.214"> function currentView() {</span>
<a href="#l12.215"></a><span id="l12.215">     return getViewDeck().selectedPanel;</span>
<a href="#l12.216"></a><span id="l12.216"> }</span>
<a href="#l12.217"></a><span id="l12.217"> </span>
<a href="#l12.218"></a><span id="l12.218"> /**</span>
<a href="#l12.219"></a><span id="l12.219" class="difflineminus">- * Returns the selected day in the views in a app (Sunbird vs. Lightning)</span>
<a href="#l12.220"></a><span id="l12.220" class="difflineminus">- * neutral way</span>
<a href="#l12.221"></a><span id="l12.221" class="difflineplus">+ * Returns the selected day in the current view.</span>
<a href="#l12.222"></a><span id="l12.222" class="difflineplus">+ *</span>
<a href="#l12.223"></a><span id="l12.223" class="difflineplus">+ * @return      The selected day</span>
<a href="#l12.224"></a><span id="l12.224">  */</span>
<a href="#l12.225"></a><span id="l12.225"> function getSelectedDay() {</span>
<a href="#l12.226"></a><span id="l12.226">     return currentView().selectedDay;</span>
<a href="#l12.227"></a><span id="l12.227"> }</span>
<a href="#l12.228"></a><span id="l12.228"> </span>
<a href="#l12.229"></a><span id="l12.229"> var gMidnightTimer;</span>
<a href="#l12.230"></a><span id="l12.230"> </span>
<a href="#l12.231"></a><span id="l12.231" class="difflineminus">-/** Creates a timer that will fire after midnight.  Pass in a function as</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineplus">+/**</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineplus">+ * Creates a timer that will fire after midnight.  Pass in a function as</span>
<a href="#l12.234"></a><span id="l12.234">  * aRefreshCallback that should be called at that time.</span>
<a href="#l12.235"></a><span id="l12.235" class="difflineplus">+ *</span>
<a href="#l12.236"></a><span id="l12.236" class="difflineplus">+ * XXX This function is not very usable, since there is only one midnight timer.</span>
<a href="#l12.237"></a><span id="l12.237" class="difflineplus">+ * Better would be a function that uses the observer service to notify at</span>
<a href="#l12.238"></a><span id="l12.238" class="difflineplus">+ * midnight.</span>
<a href="#l12.239"></a><span id="l12.239" class="difflineplus">+ *</span>
<a href="#l12.240"></a><span id="l12.240" class="difflineplus">+ * @param aRefreshCallback      A callback to be called at midnight.</span>
<a href="#l12.241"></a><span id="l12.241">  */</span>
<a href="#l12.242"></a><span id="l12.242"> function scheduleMidnightUpdate(aRefreshCallback) {</span>
<a href="#l12.243"></a><span id="l12.243">     var jsNow = new Date();</span>
<a href="#l12.244"></a><span id="l12.244">     var tomorrow = new Date(jsNow.getFullYear(), jsNow.getMonth(), jsNow.getDate() + 1);</span>
<a href="#l12.245"></a><span id="l12.245">     var msUntilTomorrow = tomorrow.getTime() - jsNow.getTime();</span>
<a href="#l12.246"></a><span id="l12.246"> </span>
<a href="#l12.247"></a><span id="l12.247">     // Is an nsITimer/callback extreme overkill here? Yes, but it's necessary to</span>
<a href="#l12.248"></a><span id="l12.248">     // workaround bug 291386.  If we don't, we stand a decent chance of getting</span>
<a href="#l12.249"></a><span id="l12.249" class="difflineat">@@ -408,35 +453,48 @@ function scheduleMidnightUpdate(aRefresh</span>
<a href="#l12.250"></a><span id="l12.250">         gMidnightTimer = Components.classes[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l12.251"></a><span id="l12.251">                                    .createInstance(Components.interfaces.nsITimer);</span>
<a href="#l12.252"></a><span id="l12.252">     } else {</span>
<a href="#l12.253"></a><span id="l12.253">         gMidnightTimer.cancel();</span>
<a href="#l12.254"></a><span id="l12.254">     }</span>
<a href="#l12.255"></a><span id="l12.255">     gMidnightTimer.initWithCallback(udCallback, msUntilTomorrow, gMidnightTimer.TYPE_ONE_SHOT);</span>
<a href="#l12.256"></a><span id="l12.256"> }</span>
<a href="#l12.257"></a><span id="l12.257"> </span>
<a href="#l12.258"></a><span id="l12.258" class="difflineminus">-// Returns the actual style sheet object with the specified path.  Callers are</span>
<a href="#l12.259"></a><span id="l12.259" class="difflineminus">-// responsible for any caching they may want to do.</span>
<a href="#l12.260"></a><span id="l12.260" class="difflineplus">+/**</span>
<a href="#l12.261"></a><span id="l12.261" class="difflineplus">+ * Returns the actual style sheet object with the specified path.  Callers are</span>
<a href="#l12.262"></a><span id="l12.262" class="difflineplus">+ * responsible for any caching they may want to do.</span>
<a href="#l12.263"></a><span id="l12.263" class="difflineplus">+ *</span>
<a href="#l12.264"></a><span id="l12.264" class="difflineplus">+ * @param aStyleSheetPath       The chrome:// uri of the stylesheet to retrieve.</span>
<a href="#l12.265"></a><span id="l12.265" class="difflineplus">+ * @return                      The stylesheet object from document.styleSheets.</span>
<a href="#l12.266"></a><span id="l12.266" class="difflineplus">+ */</span>
<a href="#l12.267"></a><span id="l12.267"> function getStyleSheet(aStyleSheetPath) {</span>
<a href="#l12.268"></a><span id="l12.268">     for each (var sheet in document.styleSheets) {</span>
<a href="#l12.269"></a><span id="l12.269">         if (sheet.href == aStyleSheetPath) {</span>
<a href="#l12.270"></a><span id="l12.270">             return sheet;</span>
<a href="#l12.271"></a><span id="l12.271">         }</span>
<a href="#l12.272"></a><span id="l12.272">     }</span>
<a href="#l12.273"></a><span id="l12.273" class="difflineminus">-    // Avoid the js strict &quot;function does not always return a value&quot; warning.</span>
<a href="#l12.274"></a><span id="l12.274">     return null;</span>
<a href="#l12.275"></a><span id="l12.275"> }</span>
<a href="#l12.276"></a><span id="l12.276"> </span>
<a href="#l12.277"></a><span id="l12.277"> /**</span>
<a href="#l12.278"></a><span id="l12.278">  * Updates the style rules for a particular object.  If the object is a</span>
<a href="#l12.279"></a><span id="l12.279">  * category (and hence doesn't have a uri), we set the category bar color.</span>
<a href="#l12.280"></a><span id="l12.280">  * If it's a calendar, we set the background color and contrasting text color.</span>
<a href="#l12.281"></a><span id="l12.281" class="difflineminus">- * @param aObject either a calendar (with a .uri), or the category color</span>
<a href="#l12.282"></a><span id="l12.282" class="difflineminus">- * pref key suffix [the non-unicode part after &quot;calendar.category.color.&quot;,</span>
<a href="#l12.283"></a><span id="l12.283" class="difflineminus">- * equivalent to formatStringForCSSRule(categoryNameInUnicode)].</span>
<a href="#l12.284"></a><span id="l12.284" class="difflineplus">+ *</span>
<a href="#l12.285"></a><span id="l12.285" class="difflineplus">+ * XXX This function is quite specific, needs some generalization and caller</span>
<a href="#l12.286"></a><span id="l12.286" class="difflineplus">+ * specific code for calendars and categories.</span>
<a href="#l12.287"></a><span id="l12.287" class="difflineplus">+ *</span>
<a href="#l12.288"></a><span id="l12.288" class="difflineplus">+ * TODO This function still uses the .uri, we are moving to using ids.</span>
<a href="#l12.289"></a><span id="l12.289" class="difflineplus">+ *</span>
<a href="#l12.290"></a><span id="l12.290" class="difflineplus">+ * @param aObject       Either a calendar (with a .uri), or the category color</span>
<a href="#l12.291"></a><span id="l12.291" class="difflineplus">+ *                        pref key suffix [the non-unicode part after</span>
<a href="#l12.292"></a><span id="l12.292" class="difflineplus">+ *                        &quot;calendar.category.color.&quot;, equivalent to</span>
<a href="#l12.293"></a><span id="l12.293" class="difflineplus">+ *                        formatStringForCSSRule(categoryNameInUnicode)].</span>
<a href="#l12.294"></a><span id="l12.294" class="difflineplus">+ * @param aSheet         The stylesheet to update.</span>
<a href="#l12.295"></a><span id="l12.295" class="difflineplus">+ *</span>
<a href="#l12.296"></a><span id="l12.296">  */</span>
<a href="#l12.297"></a><span id="l12.297"> function updateStyleSheetForObject(aObject, aSheet) {</span>
<a href="#l12.298"></a><span id="l12.298">     var selectorPrefix, name, ruleUpdaterFunc, classPrefix;</span>
<a href="#l12.299"></a><span id="l12.299">     if (aObject.uri) {</span>
<a href="#l12.300"></a><span id="l12.300">         // For a calendar, set background and contrasting text colors</span>
<a href="#l12.301"></a><span id="l12.301">         name = aObject.uri.spec;</span>
<a href="#l12.302"></a><span id="l12.302">         classPrefix = &quot;.calendar-color-box&quot;;</span>
<a href="#l12.303"></a><span id="l12.303">         selectorPrefix = &quot;item-calendar=&quot;;</span>
<a href="#l12.304"></a><span id="l12.304" class="difflineat">@@ -481,18 +539,21 @@ function updateStyleSheetForObject(aObje</span>
<a href="#l12.305"></a><span id="l12.305">         aSheet.insertRule(selector + ' { }', aSheet.cssRules.length);</span>
<a href="#l12.306"></a><span id="l12.306">         rule = aSheet.cssRules[aSheet.cssRules.length-1];</span>
<a href="#l12.307"></a><span id="l12.307">     }</span>
<a href="#l12.308"></a><span id="l12.308"> </span>
<a href="#l12.309"></a><span id="l12.309">     ruleUpdaterFunc(rule, ruleIndex);</span>
<a href="#l12.310"></a><span id="l12.310"> }</span>
<a href="#l12.311"></a><span id="l12.311"> </span>
<a href="#l12.312"></a><span id="l12.312"> /**</span>
<a href="#l12.313"></a><span id="l12.313" class="difflineminus">- *  Sets the selected day in the minimonth to the currently selected day</span>
<a href="#l12.314"></a><span id="l12.314" class="difflineminus">- *  in the embedded view.</span>
<a href="#l12.315"></a><span id="l12.315" class="difflineplus">+ * Handler function to set the selected day in the minimonth to the currently</span>
<a href="#l12.316"></a><span id="l12.316" class="difflineplus">+ * selected day in the current view.</span>
<a href="#l12.317"></a><span id="l12.317" class="difflineplus">+ *</span>
<a href="#l12.318"></a><span id="l12.318" class="difflineplus">+ * @param event     The &quot;dayselect&quot; event emitted from the views.</span>
<a href="#l12.319"></a><span id="l12.319" class="difflineplus">+ *</span>
<a href="#l12.320"></a><span id="l12.320">  */</span>
<a href="#l12.321"></a><span id="l12.321"> function observeViewDaySelect(event) {</span>
<a href="#l12.322"></a><span id="l12.322">     var date = event.detail;</span>
<a href="#l12.323"></a><span id="l12.323">     var jsDate = new Date(date.year, date.month, date.day);</span>
<a href="#l12.324"></a><span id="l12.324"> </span>
<a href="#l12.325"></a><span id="l12.325">     // for the month and multiweek view find the main month,</span>
<a href="#l12.326"></a><span id="l12.326">     // which is the month with the most visible days in the view;</span>
<a href="#l12.327"></a><span id="l12.327">     // note, that the main date is the first day of the main month</span>
<a href="#l12.328"></a><span id="l12.328" class="difflineat">@@ -520,18 +581,21 @@ function observeViewDaySelect(event) {</span>
<a href="#l12.329"></a><span id="l12.329">         }</span>
<a href="#l12.330"></a><span id="l12.330">         jsMainDate = new Date(mainDate.year, mainDate.month, mainDate.day);</span>
<a href="#l12.331"></a><span id="l12.331">     }</span>
<a href="#l12.332"></a><span id="l12.332"> </span>
<a href="#l12.333"></a><span id="l12.333">     getMinimonth().selectDate(jsDate, jsMainDate);</span>
<a href="#l12.334"></a><span id="l12.334">     currentView().focus();</span>
<a href="#l12.335"></a><span id="l12.335"> }</span>
<a href="#l12.336"></a><span id="l12.336"> </span>
<a href="#l12.337"></a><span id="l12.337" class="difflineminus">-/** Provides a neutral way to get the minimonth, regardless of whether we're in</span>
<a href="#l12.338"></a><span id="l12.338" class="difflineplus">+/**</span>
<a href="#l12.339"></a><span id="l12.339" class="difflineplus">+ * Provides a neutral way to get the minimonth, regardless of whether we're in</span>
<a href="#l12.340"></a><span id="l12.340">  * Sunbird or Lightning.</span>
<a href="#l12.341"></a><span id="l12.341" class="difflineplus">+ *</span>
<a href="#l12.342"></a><span id="l12.342" class="difflineplus">+ * @return          The XUL minimonth element.</span>
<a href="#l12.343"></a><span id="l12.343">  */</span>
<a href="#l12.344"></a><span id="l12.344"> function getMinimonth() {</span>
<a href="#l12.345"></a><span id="l12.345">     return document.getElementById(&quot;calMinimonth&quot;);</span>
<a href="#l12.346"></a><span id="l12.346"> }</span>
<a href="#l12.347"></a><span id="l12.347"> </span>
<a href="#l12.348"></a><span id="l12.348"> /**</span>
<a href="#l12.349"></a><span id="l12.349">  * Update the view orientation based on the checked state of the command</span>
<a href="#l12.350"></a><span id="l12.350">  */</span>
<a href="#l12.351"></a><span id="l12.351" class="difflineat">@@ -545,16 +609,19 @@ function toggleOrientation() {</span>
<a href="#l12.352"></a><span id="l12.352">         view.rotated = (newValue == &quot;true&quot;);</span>
<a href="#l12.353"></a><span id="l12.353">     }</span>
<a href="#l12.354"></a><span id="l12.354"> </span>
<a href="#l12.355"></a><span id="l12.355">     // orientation refreshes automatically</span>
<a href="#l12.356"></a><span id="l12.356"> }</span>
<a href="#l12.357"></a><span id="l12.357"> </span>
<a href="#l12.358"></a><span id="l12.358"> /**</span>
<a href="#l12.359"></a><span id="l12.359">  * Toggle the workdays only checkbox and refresh the current view</span>
<a href="#l12.360"></a><span id="l12.360" class="difflineplus">+ *</span>
<a href="#l12.361"></a><span id="l12.361" class="difflineplus">+ * XXX We shouldn't need to refresh the view just to toggle the workdays. This</span>
<a href="#l12.362"></a><span id="l12.362" class="difflineplus">+ * should happen automatically.</span>
<a href="#l12.363"></a><span id="l12.363">  */</span>
<a href="#l12.364"></a><span id="l12.364"> function toggleWorkdaysOnly() {</span>
<a href="#l12.365"></a><span id="l12.365">     var cmd = document.getElementById(&quot;calendar_toggle_workdays_only_command&quot;);</span>
<a href="#l12.366"></a><span id="l12.366">     var newValue = (cmd.getAttribute(&quot;checked&quot;) == &quot;true&quot; ? &quot;false&quot; : &quot;true&quot;);</span>
<a href="#l12.367"></a><span id="l12.367">     cmd.setAttribute(&quot;checked&quot;, newValue);</span>
<a href="#l12.368"></a><span id="l12.368"> </span>
<a href="#l12.369"></a><span id="l12.369">     var deck = getViewDeck();</span>
<a href="#l12.370"></a><span id="l12.370">     for each (var view in deck.childNodes) {</span>
<a href="#l12.371"></a><span id="l12.371" class="difflineat">@@ -595,64 +662,67 @@ function toggleShowCompletedInView() {</span>
<a href="#l12.372"></a><span id="l12.372">         view.showCompleted = (newValue == &quot;true&quot;);</span>
<a href="#l12.373"></a><span id="l12.373">     }</span>
<a href="#l12.374"></a><span id="l12.374"> </span>
<a href="#l12.375"></a><span id="l12.375">     // Refresh the current view</span>
<a href="#l12.376"></a><span id="l12.376">     currentView().goToDay(currentView().selectedDay);</span>
<a href="#l12.377"></a><span id="l12.377"> }</span>
<a href="#l12.378"></a><span id="l12.378"> </span>
<a href="#l12.379"></a><span id="l12.379"> /**</span>
<a href="#l12.380"></a><span id="l12.380" class="difflineminus">- * Provides a neutral way to go to the current day</span>
<a href="#l12.381"></a><span id="l12.381" class="difflineplus">+ * Provides a neutral way to go to the current day in the views and minimonth.</span>
<a href="#l12.382"></a><span id="l12.382" class="difflineplus">+ *</span>
<a href="#l12.383"></a><span id="l12.383" class="difflineplus">+ * @param aDate     The date to go.</span>
<a href="#l12.384"></a><span id="l12.384">  */</span>
<a href="#l12.385"></a><span id="l12.385"> function goToDate(aDate) {</span>
<a href="#l12.386"></a><span id="l12.386">     getMinimonth().value = aDate.jsDate;</span>
<a href="#l12.387"></a><span id="l12.387">     currentView().goToDay(aDate);</span>
<a href="#l12.388"></a><span id="l12.388"> }</span>
<a href="#l12.389"></a><span id="l12.389"> </span>
<a href="#l12.390"></a><span id="l12.390"> /**</span>
<a href="#l12.391"></a><span id="l12.391">  * Returns the calendar view that was selected before restart, or the current</span>
<a href="#l12.392"></a><span id="l12.392">  * calendar view if it has already been set in this session</span>
<a href="#l12.393"></a><span id="l12.393" class="difflineplus">+ *</span>
<a href="#l12.394"></a><span id="l12.394" class="difflineplus">+ * @return          The last calendar view.</span>
<a href="#l12.395"></a><span id="l12.395">  */</span>
<a href="#l12.396"></a><span id="l12.396"> function getLastCalendarView() {</span>
<a href="#l12.397"></a><span id="l12.397">     var deck = getViewDeck();</span>
<a href="#l12.398"></a><span id="l12.398">     if (deck.selectedIndex &gt; -1) {</span>
<a href="#l12.399"></a><span id="l12.399">         var viewNode = deck.childNodes[deck.selectedIndex];</span>
<a href="#l12.400"></a><span id="l12.400">         return viewNode.id.replace(/-view/, &quot;&quot;);</span>
<a href="#l12.401"></a><span id="l12.401">     }</span>
<a href="#l12.402"></a><span id="l12.402"> </span>
<a href="#l12.403"></a><span id="l12.403">     // No deck item was selected beforehand, default to week view.</span>
<a href="#l12.404"></a><span id="l12.404">     return &quot;week&quot;;</span>
<a href="#l12.405"></a><span id="l12.405"> }</span>
<a href="#l12.406"></a><span id="l12.406"> </span>
<a href="#l12.407"></a><span id="l12.407"> /**</span>
<a href="#l12.408"></a><span id="l12.408" class="difflineminus">- *  Deletes items currently selected in the view</span>
<a href="#l12.409"></a><span id="l12.409" class="difflineminus">- *  and clears selection.</span>
<a href="#l12.410"></a><span id="l12.410" class="difflineplus">+ * Deletes items currently selected in the view and clears selection.</span>
<a href="#l12.411"></a><span id="l12.411">  */</span>
<a href="#l12.412"></a><span id="l12.412"> function deleteSelectedEvents() {</span>
<a href="#l12.413"></a><span id="l12.413">     var selectedItems = currentView().getSelectedItems({});</span>
<a href="#l12.414"></a><span id="l12.414">     calendarViewController.deleteOccurrences(selectedItems.length,</span>
<a href="#l12.415"></a><span id="l12.415">                                              selectedItems,</span>
<a href="#l12.416"></a><span id="l12.416">                                              false,</span>
<a href="#l12.417"></a><span id="l12.417">                                              false);</span>
<a href="#l12.418"></a><span id="l12.418">     // clear selection</span>
<a href="#l12.419"></a><span id="l12.419">     currentView().setSelectedItems(0, [], true);</span>
<a href="#l12.420"></a><span id="l12.420"> }</span>
<a href="#l12.421"></a><span id="l12.421"> </span>
<a href="#l12.422"></a><span id="l12.422"> /**</span>
<a href="#l12.423"></a><span id="l12.423" class="difflineminus">- *  Edit the items currently selected in the view.</span>
<a href="#l12.424"></a><span id="l12.424" class="difflineplus">+ * Edit the items currently selected in the view with the event dialog.</span>
<a href="#l12.425"></a><span id="l12.425">  */</span>
<a href="#l12.426"></a><span id="l12.426"> function editSelectedEvents() {</span>
<a href="#l12.427"></a><span id="l12.427">     var selectedItems = currentView().getSelectedItems({});</span>
<a href="#l12.428"></a><span id="l12.428">     if (selectedItems &amp;&amp; selectedItems.length &gt;= 1) {</span>
<a href="#l12.429"></a><span id="l12.429">         modifyEventWithDialog(selectedItems[0], null, true);</span>
<a href="#l12.430"></a><span id="l12.430">     }</span>
<a href="#l12.431"></a><span id="l12.431"> }</span>
<a href="#l12.432"></a><span id="l12.432"> </span>
<a href="#l12.433"></a><span id="l12.433"> /**</span>
<a href="#l12.434"></a><span id="l12.434" class="difflineminus">- * Select all events from all calendars</span>
<a href="#l12.435"></a><span id="l12.435" class="difflineplus">+ * Select all events from all calendars. Use with care.</span>
<a href="#l12.436"></a><span id="l12.436">  */</span>
<a href="#l12.437"></a><span id="l12.437"> function selectAllEvents() {</span>
<a href="#l12.438"></a><span id="l12.438">     var items = [];</span>
<a href="#l12.439"></a><span id="l12.439">     var listener = {</span>
<a href="#l12.440"></a><span id="l12.440">         onOperationComplete: function selectAll_ooc(aCalendar, aStatus,</span>
<a href="#l12.441"></a><span id="l12.441">                                                     aOperationType, aId,</span>
<a href="#l12.442"></a><span id="l12.442">                                                     aDetail) {</span>
<a href="#l12.443"></a><span id="l12.443">             currentView().setSelectedItems(items.length, items, false);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-timezone.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-timezone.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -30,16 +30,20 @@</span>
<a href="#l13.4"></a><span id="l13.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l13.5"></a><span id="l13.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l13.6"></a><span id="l13.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l13.7"></a><span id="l13.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l13.8"></a><span id="l13.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l13.9"></a><span id="l13.9">  *</span>
<a href="#l13.10"></a><span id="l13.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+/**</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+ * Sets up the timezone dialog from the window arguments, also setting up all</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+ * dialog controls from the window's dates.</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+ */</span>
<a href="#l13.16"></a><span id="l13.16"> function onLoad() {</span>
<a href="#l13.17"></a><span id="l13.17">     var args = window.arguments[0];</span>
<a href="#l13.18"></a><span id="l13.18">     window.time = args.time;</span>
<a href="#l13.19"></a><span id="l13.19">     window.onAcceptCallback = args.onOk;</span>
<a href="#l13.20"></a><span id="l13.20"> </span>
<a href="#l13.21"></a><span id="l13.21">     var tzProvider = (args.calendar.getProperty(&quot;timezones.provider&quot;) ||</span>
<a href="#l13.22"></a><span id="l13.22">                       getTimezoneService());</span>
<a href="#l13.23"></a><span id="l13.23">     window.tzProvider = tzProvider;</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineat">@@ -84,29 +88,39 @@ function onLoad() {</span>
<a href="#l13.25"></a><span id="l13.25">     var menulist = document.getElementById(&quot;timezone-menulist&quot;);</span>
<a href="#l13.26"></a><span id="l13.26">     menulist.selectedIndex = index;</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28">     updateTimezone();</span>
<a href="#l13.29"></a><span id="l13.29"> </span>
<a href="#l13.30"></a><span id="l13.30">     opener.setCursor(&quot;auto&quot;);</span>
<a href="#l13.31"></a><span id="l13.31"> }</span>
<a href="#l13.32"></a><span id="l13.32"> </span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+/**</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+ * Find the index of the timezone menuitem corresponding to the given timezone.</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+ *</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+ * @param timezone      The calITimezone to look for.</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+ * @return              The index of the childnode below &quot;timezone-menulist&quot;</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+ */</span>
<a href="#l13.39"></a><span id="l13.39"> function findTimezone(timezone) {</span>
<a href="#l13.40"></a><span id="l13.40">     var tzid = timezone.tzid;</span>
<a href="#l13.41"></a><span id="l13.41">     var menulist = document.getElementById(&quot;timezone-menulist&quot;);</span>
<a href="#l13.42"></a><span id="l13.42">     var numChilds = menulist.childNodes[0].childNodes.length;</span>
<a href="#l13.43"></a><span id="l13.43">     for (var i=0; i&lt;numChilds; i++) {</span>
<a href="#l13.44"></a><span id="l13.44">         var menuitem = menulist.childNodes[0].childNodes[i];</span>
<a href="#l13.45"></a><span id="l13.45">         if (menuitem.getAttribute(&quot;value&quot;) == tzid) {</span>
<a href="#l13.46"></a><span id="l13.46">             return i;</span>
<a href="#l13.47"></a><span id="l13.47">         }</span>
<a href="#l13.48"></a><span id="l13.48">     }</span>
<a href="#l13.49"></a><span id="l13.49">     return -1;</span>
<a href="#l13.50"></a><span id="l13.50"> }</span>
<a href="#l13.51"></a><span id="l13.51"> </span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+/**</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+ * Handler function to call when the timezone selection has changed. Updates the</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+ * timezone-time field and the timezone-stack.</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+ */</span>
<a href="#l13.56"></a><span id="l13.56"> function updateTimezone() {</span>
<a href="#l13.57"></a><span id="l13.57">     var menulist = document.getElementById(&quot;timezone-menulist&quot;);</span>
<a href="#l13.58"></a><span id="l13.58">     var menuitem = menulist.selectedItem;</span>
<a href="#l13.59"></a><span id="l13.59">     var tz = window.tzProvider.getTimezone(menuitem.getAttribute(&quot;value&quot;));</span>
<a href="#l13.60"></a><span id="l13.60"> </span>
<a href="#l13.61"></a><span id="l13.61">     // convert the date/time to the currently selected timezone</span>
<a href="#l13.62"></a><span id="l13.62">     // and display the result in the appropriate control.</span>
<a href="#l13.63"></a><span id="l13.63">     // before feeding the date/time value into the control we need</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineat">@@ -137,20 +151,29 @@ function updateTimezone() {</span>
<a href="#l13.65"></a><span id="l13.65">                 image.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l13.66"></a><span id="l13.66">             } else {</span>
<a href="#l13.67"></a><span id="l13.67">                 image.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l13.68"></a><span id="l13.68">             }</span>
<a href="#l13.69"></a><span id="l13.69">         }</span>
<a href="#l13.70"></a><span id="l13.70">     }</span>
<a href="#l13.71"></a><span id="l13.71"> }</span>
<a href="#l13.72"></a><span id="l13.72"> </span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+/**</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+ * Handler function to be called when the accept button is pressed.</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+ *</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+ * @return      Returns true if the window should be closed</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+ */</span>
<a href="#l13.78"></a><span id="l13.78"> function onAccept() {</span>
<a href="#l13.79"></a><span id="l13.79">     var menulist = document.getElementById(&quot;timezone-menulist&quot;);</span>
<a href="#l13.80"></a><span id="l13.80">     var menuitem = menulist.selectedItem;</span>
<a href="#l13.81"></a><span id="l13.81">     var timezone = menuitem.getAttribute(&quot;value&quot;);</span>
<a href="#l13.82"></a><span id="l13.82">     var tz = window.tzProvider.getTimezone(timezone);</span>
<a href="#l13.83"></a><span id="l13.83">     var datetime = window.time.getInTimezone(tz);</span>
<a href="#l13.84"></a><span id="l13.84">     window.onAcceptCallback(datetime);</span>
<a href="#l13.85"></a><span id="l13.85">     return true;</span>
<a href="#l13.86"></a><span id="l13.86"> }</span>
<a href="#l13.87"></a><span id="l13.87"> </span>
<a href="#l13.88"></a><span id="l13.88" class="difflineplus">+/**</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineplus">+ * Handler function to be called when the cancel button is pressed.</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineplus">+ *</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineplus">+ */</span>
<a href="#l13.92"></a><span id="l13.92"> function onCancel() {</span>
<a href="#l13.93"></a><span id="l13.93"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/calendar/base/content/migration.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/calendar/base/content/migration.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -149,60 +149,79 @@ var gMigrateWizard = {</span>
<a href="#l14.4"></a><span id="l14.4">                 gMigrateWizard.setCanRewindFalse();</span>
<a href="#l14.5"></a><span id="l14.5">             }</span>
<a href="#l14.6"></a><span id="l14.6">          }</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8">         // And get the first migrator</span>
<a href="#l14.9"></a><span id="l14.9">         getNextMigrator();</span>
<a href="#l14.10"></a><span id="l14.10">    },</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+    /**</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+     * Makes sure the wizard &quot;back&quot; button can not be pressed.</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+     */</span>
<a href="#l14.15"></a><span id="l14.15">     setCanRewindFalse: function gmw_finish() {</span>
<a href="#l14.16"></a><span id="l14.16">         document.getElementById('migration-wizard').canRewind = false;</span>
<a href="#l14.17"></a><span id="l14.17">     }</span>
<a href="#l14.18"></a><span id="l14.18"> };</span>
<a href="#l14.19"></a><span id="l14.19"> </span>
<a href="#l14.20"></a><span id="l14.20"> //</span>
<a href="#l14.21"></a><span id="l14.21"> // The more back-end data detection bits</span>
<a href="#l14.22"></a><span id="l14.22"> //</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+/**</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+ * A data migrator prototype, holding the information for migration</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+ *</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+ * @class</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+ * @param aTitle    The title of the migrator</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+ * @param aMigrateFunction    The function to call when migrating</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+ * @param aArguments          The arguments to pass in.</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+ */</span>
<a href="#l14.33"></a><span id="l14.33"> function dataMigrator(aTitle, aMigrateFunction, aArguments) {</span>
<a href="#l14.34"></a><span id="l14.34">     this.title = aTitle;</span>
<a href="#l14.35"></a><span id="l14.35">     this.migrate = aMigrateFunction;</span>
<a href="#l14.36"></a><span id="l14.36">     this.args = aArguments;</span>
<a href="#l14.37"></a><span id="l14.37"> }</span>
<a href="#l14.38"></a><span id="l14.38"> </span>
<a href="#l14.39"></a><span id="l14.39"> var gDataMigrator = {</span>
<a href="#l14.40"></a><span id="l14.40">     mIsLightning: null,</span>
<a href="#l14.41"></a><span id="l14.41">     mIsInFirefox: false,</span>
<a href="#l14.42"></a><span id="l14.42">     mPlatform: null,</span>
<a href="#l14.43"></a><span id="l14.43">     mDirService: null,</span>
<a href="#l14.44"></a><span id="l14.44">     mIoService: null,</span>
<a href="#l14.45"></a><span id="l14.45"> </span>
<a href="#l14.46"></a><span id="l14.46">     /**</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-     * Properly caches the service so that it doesn't load on startup</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+     * Cached getter for the directory service.</span>
<a href="#l14.49"></a><span id="l14.49">      */</span>
<a href="#l14.50"></a><span id="l14.50">     get dirService() {</span>
<a href="#l14.51"></a><span id="l14.51">         if (!this.mDirService) {</span>
<a href="#l14.52"></a><span id="l14.52">             this.mDirService = Components.classes[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l14.53"></a><span id="l14.53">                                .getService(Components.interfaces.nsIProperties);</span>
<a href="#l14.54"></a><span id="l14.54">         }</span>
<a href="#l14.55"></a><span id="l14.55">         return this.mDirService;</span>
<a href="#l14.56"></a><span id="l14.56">     },</span>
<a href="#l14.57"></a><span id="l14.57"> </span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+    /**</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+     * Cached getter for the IO Service</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+     * XXX replace with cal.getIOService()</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+     */</span>
<a href="#l14.62"></a><span id="l14.62">     get ioService() {</span>
<a href="#l14.63"></a><span id="l14.63">         if (!this.mIoService) {</span>
<a href="#l14.64"></a><span id="l14.64">             this.mIoService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l14.65"></a><span id="l14.65">                               .getService(Components.interfaces.nsIIOService);</span>
<a href="#l14.66"></a><span id="l14.66">         }</span>
<a href="#l14.67"></a><span id="l14.67">         return this.mIoService;</span>
<a href="#l14.68"></a><span id="l14.68">     },</span>
<a href="#l14.69"></a><span id="l14.69"> </span>
<a href="#l14.70"></a><span id="l14.70">     /**</span>
<a href="#l14.71"></a><span id="l14.71">      * Gets the value for mIsLightning, and sets it if this.mIsLightning is</span>
<a href="#l14.72"></a><span id="l14.72">      * not initialized. This is used by objects outside gDataMigrator to</span>
<a href="#l14.73"></a><span id="l14.73">      * access the mIsLightning member.</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+     *</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+     * XXX replace with !cal.isSunbird()</span>
<a href="#l14.76"></a><span id="l14.76">      */</span>
<a href="#l14.77"></a><span id="l14.77">     isLightning: function is_ltn() {</span>
<a href="#l14.78"></a><span id="l14.78">         if (this.mIsLightning == null) {</span>
<a href="#l14.79"></a><span id="l14.79">             var appInfo = Components.classes[&quot;@mozilla.org/xre/app-info;1&quot;]</span>
<a href="#l14.80"></a><span id="l14.80">                           .getService(Components.interfaces.nsIXULAppInfo);</span>
<a href="#l14.81"></a><span id="l14.81">             this.mIsLightning = !(appInfo.ID == SUNBIRD_UID);</span>
<a href="#l14.82"></a><span id="l14.82">             return this.mIsLightning;</span>
<a href="#l14.83"></a><span id="l14.83">         }</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineat">@@ -569,16 +588,21 @@ var gDataMigrator = {</span>
<a href="#l14.85"></a><span id="l14.85"> </span>
<a href="#l14.86"></a><span id="l14.86">         var evoDir = this.dirService.get(&quot;Home&quot;, Components.interfaces.nsILocalFile);</span>
<a href="#l14.87"></a><span id="l14.87">         evoDir.append(&quot;.evolution&quot;);</span>
<a href="#l14.88"></a><span id="l14.88">         evoDir.append(&quot;calendar&quot;);</span>
<a href="#l14.89"></a><span id="l14.89">         evoDir.append(&quot;local&quot;);</span>
<a href="#l14.90"></a><span id="l14.90">         return (evoDir.exists() ? [new dataMigrator(&quot;Evolution&quot;, evoMigrate, [evoDir])] : []);</span>
<a href="#l14.91"></a><span id="l14.91">     },</span>
<a href="#l14.92"></a><span id="l14.92"> </span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+    /**</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+     * Creates and registers a storage calendar and imports the given ics file into it.</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+     *</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+     * @param icsFile     The nsI(Local)File to import.</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+     */</span>
<a href="#l14.98"></a><span id="l14.98">     importICSToStorage: function migrateIcsStorage(icsFile) {</span>
<a href="#l14.99"></a><span id="l14.99">         var calManager = getCalendarManager();</span>
<a href="#l14.100"></a><span id="l14.100">         var uris = [];</span>
<a href="#l14.101"></a><span id="l14.101">         for each (var oldCal in calManager.getCalendars({})) {</span>
<a href="#l14.102"></a><span id="l14.102">             uris.push(oldCal.uri.spec);</span>
<a href="#l14.103"></a><span id="l14.103">         }</span>
<a href="#l14.104"></a><span id="l14.104">         var uri = 'moz-profile-calendar://?id=';</span>
<a href="#l14.105"></a><span id="l14.105">         var i = 1;</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineat">@@ -638,16 +662,19 @@ var gDataMigrator = {</span>
<a href="#l14.107"></a><span id="l14.107">      *</span>
<a href="#l14.108"></a><span id="l14.108">      * Notice that Firefox and Sunbird follow essentially the same pattern, so</span>
<a href="#l14.109"></a><span id="l14.109">      * we group them with getNormalProfile</span>
<a href="#l14.110"></a><span id="l14.110">      */</span>
<a href="#l14.111"></a><span id="l14.111">     getFirefoxProfile: function gdm_getFF() {</span>
<a href="#l14.112"></a><span id="l14.112">         return this.getNormalProfile(&quot;Firefox&quot;);</span>
<a href="#l14.113"></a><span id="l14.113">     },</span>
<a href="#l14.114"></a><span id="l14.114"> </span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+    /**</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+     * @see getFirefoxProfile</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+     */</span>
<a href="#l14.118"></a><span id="l14.118">     getThunderbirdProfile: function gdm_getTB() {</span>
<a href="#l14.119"></a><span id="l14.119">         var localFile;</span>
<a href="#l14.120"></a><span id="l14.120">         var profileRoot = this.dirService.get(&quot;DefProfRt&quot;, Components.interfaces.nsILocalFile);</span>
<a href="#l14.121"></a><span id="l14.121">         LOG(&quot;profileRoot = &quot; + profileRoot.path);</span>
<a href="#l14.122"></a><span id="l14.122">         if (this.mIsLightning) {</span>
<a href="#l14.123"></a><span id="l14.123">             localFile = profileRoot;</span>
<a href="#l14.124"></a><span id="l14.124">         } else {</span>
<a href="#l14.125"></a><span id="l14.125">             // Now it gets ugly</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineat">@@ -662,20 +689,27 @@ var gDataMigrator = {</span>
<a href="#l14.127"></a><span id="l14.127">                     localFile = profileRoot.parent.parent;</span>
<a href="#l14.128"></a><span id="l14.128">                     localFile.append(&quot;.thunderbird&quot;);</span>
<a href="#l14.129"></a><span id="l14.129">             }</span>
<a href="#l14.130"></a><span id="l14.130">         }</span>
<a href="#l14.131"></a><span id="l14.131">         LOG(&quot;searching for Thunderbird in &quot; + localFile.path);</span>
<a href="#l14.132"></a><span id="l14.132">         return localFile.exists() ? localFile : null;</span>
<a href="#l14.133"></a><span id="l14.133">     },</span>
<a href="#l14.134"></a><span id="l14.134"> </span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+    /**</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineplus">+     * @see getFirefoxProfile</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineplus">+     */</span>
<a href="#l14.138"></a><span id="l14.138">     getSunbirdProfile: function gdm_getSB() {</span>
<a href="#l14.139"></a><span id="l14.139">         return this.getNormalProfile(&quot;Sunbird&quot;);</span>
<a href="#l14.140"></a><span id="l14.140">     },</span>
<a href="#l14.141"></a><span id="l14.141"> </span>
<a href="#l14.142"></a><span id="l14.142" class="difflineplus">+    /**</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineplus">+     * Common function to retrieve the profile directory for a given app.</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineplus">+     * @see getFirefoxProfile</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineplus">+     */</span>
<a href="#l14.146"></a><span id="l14.146">     getNormalProfile: function gdm_getNorm(aAppName) {</span>
<a href="#l14.147"></a><span id="l14.147">         var localFile;</span>
<a href="#l14.148"></a><span id="l14.148">         var profileRoot = this.dirService.get(&quot;DefProfRt&quot;, Components.interfaces.nsILocalFile);</span>
<a href="#l14.149"></a><span id="l14.149">         LOG(&quot;profileRoot = &quot; + profileRoot.path);</span>
<a href="#l14.150"></a><span id="l14.150"> </span>
<a href="#l14.151"></a><span id="l14.151">         if (this.isLightning()) {  // We're in Thunderbird</span>
<a href="#l14.152"></a><span id="l14.152">             switch (this.mPlatform) {</span>
<a href="#l14.153"></a><span id="l14.153">                 case &quot;darwin&quot;: // Mac OS X</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineat">@@ -712,16 +746,24 @@ var gDataMigrator = {</span>
<a href="#l14.155"></a><span id="l14.155">                     break;</span>
<a href="#l14.156"></a><span id="l14.156">             }</span>
<a href="#l14.157"></a><span id="l14.157">         }</span>
<a href="#l14.158"></a><span id="l14.158">         LOG(&quot;searching for &quot; + aAppName + &quot; in &quot; + localFile.path);</span>
<a href="#l14.159"></a><span id="l14.159">         return localFile.exists() ? localFile : null;</span>
<a href="#l14.160"></a><span id="l14.160">     }</span>
<a href="#l14.161"></a><span id="l14.161"> };</span>
<a href="#l14.162"></a><span id="l14.162"> </span>
<a href="#l14.163"></a><span id="l14.163" class="difflineplus">+/**</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineplus">+ * logs to system and error console, depending on the calendar.migration.log</span>
<a href="#l14.165"></a><span id="l14.165" class="difflineplus">+ * preference.</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineplus">+ *</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineplus">+ * XXX Consolidate with calUtils' LOG().</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineplus">+ *</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineplus">+ * @param aString   The string to log</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineplus">+ */</span>
<a href="#l14.171"></a><span id="l14.171"> function LOG(aString) {</span>
<a href="#l14.172"></a><span id="l14.172">     if (!getPrefSafe(&quot;calendar.migration.log&quot;, false)) {</span>
<a href="#l14.173"></a><span id="l14.173">         return;</span>
<a href="#l14.174"></a><span id="l14.174">     }</span>
<a href="#l14.175"></a><span id="l14.175">     var consoleService = Components.classes[&quot;@mozilla.org/consoleservice;1&quot;]</span>
<a href="#l14.176"></a><span id="l14.176">                          .getService(Components.interfaces.nsIConsoleService);</span>
<a href="#l14.177"></a><span id="l14.177">     consoleService.logStringMessage(aString);</span>
<a href="#l14.178"></a><span id="l14.178">     dump(aString+&quot;\n&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/calendar/base/content/today-pane.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/calendar/base/content/today-pane.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -30,38 +30,51 @@</span>
<a href="#l15.4"></a><span id="l15.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l15.5"></a><span id="l15.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l15.6"></a><span id="l15.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l15.7"></a><span id="l15.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l15.8"></a><span id="l15.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l15.9"></a><span id="l15.9">  *</span>
<a href="#l15.10"></a><span id="l15.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+/**</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+ * Namespace object to hold functions related to the today pane.</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+ *</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+ * XXX Please fix indentation in this file!</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+ */</span>
<a href="#l15.19"></a><span id="l15.19"> var TodayPane = {</span>
<a href="#l15.20"></a><span id="l15.20">     paneViews: null,</span>
<a href="#l15.21"></a><span id="l15.21">     start: null,</span>
<a href="#l15.22"></a><span id="l15.22">     cwlabel: null,</span>
<a href="#l15.23"></a><span id="l15.23"> </span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+  /**</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+   * Load Handler, sets up the today pane controls.</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+   */</span>
<a href="#l15.27"></a><span id="l15.27">   onLoad: function onLoad() {</span>
<a href="#l15.28"></a><span id="l15.28">       this.paneViews = [ calGetString(&quot;calendar&quot;, &quot;eventsandtasks&quot;), calGetString(&quot;calendar&quot;, &quot;tasksonly&quot;), calGetString(&quot;calendar&quot;, &quot;eventsonly&quot;) ];</span>
<a href="#l15.29"></a><span id="l15.29">       agendaListbox.setupCalendar();</span>
<a href="#l15.30"></a><span id="l15.30">       this.initializeMiniday();</span>
<a href="#l15.31"></a><span id="l15.31">       this.setShortWeekdays();</span>
<a href="#l15.32"></a><span id="l15.32">       document.getElementById(&quot;modeBroadcaster&quot;).addEventListener(&quot;DOMAttrModified&quot;, this.onModeModified, false);</span>
<a href="#l15.33"></a><span id="l15.33">       this.setTodayHeader();</span>
<a href="#l15.34"></a><span id="l15.34">       document.getElementById(&quot;today-splitter&quot;).addEventListener(&quot;command&quot;, onCalendarViewResize, false);</span>
<a href="#l15.35"></a><span id="l15.35">   },</span>
<a href="#l15.36"></a><span id="l15.36"> </span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+  /**</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+   * Unload handler, cleans up the today pane on window unload.</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+   */</span>
<a href="#l15.40"></a><span id="l15.40">   onUnload: function onUnload() {</span>
<a href="#l15.41"></a><span id="l15.41">       document.getElementById(&quot;modeBroadcaster&quot;).removeEventListener(&quot;DOMAttrModified&quot;, this.onModeModified, false);</span>
<a href="#l15.42"></a><span id="l15.42">       document.getElementById(&quot;today-splitter&quot;).removeEventListener(&quot;command&quot;, onCalendarViewResize, false);</span>
<a href="#l15.43"></a><span id="l15.43">   },</span>
<a href="#l15.44"></a><span id="l15.44"> </span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+  /**</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+   * Sets up the label for the switcher that allows switching between today pane</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+   * views. (event+task, task only, event only)</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+   */</span>
<a href="#l15.49"></a><span id="l15.49">   setTodayHeader: function setTodayHeader() {</span>
<a href="#l15.50"></a><span id="l15.50">       var currentMode = document.getElementById(&quot;modeBroadcaster&quot;).getAttribute(&quot;mode&quot;);</span>
<a href="#l15.51"></a><span id="l15.51">       var agendaIsVisible = document.getElementById(&quot;agenda-panel&quot;).isVisible(currentMode);</span>
<a href="#l15.52"></a><span id="l15.52">       var todoIsVisible = document.getElementById(&quot;todo-tab-panel&quot;).isVisible(currentMode);</span>
<a href="#l15.53"></a><span id="l15.53">       var index = 2;</span>
<a href="#l15.54"></a><span id="l15.54">       if (agendaIsVisible &amp;&amp; todoIsVisible) {</span>
<a href="#l15.55"></a><span id="l15.55">           index = 0;</span>
<a href="#l15.56"></a><span id="l15.56">       } else if (!agendaIsVisible &amp;&amp; (todoIsVisible)) {</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineat">@@ -81,16 +94,19 @@ var TodayPane = {</span>
<a href="#l15.58"></a><span id="l15.58">       todayHeader.setAttribute(&quot;value&quot;, this.paneViews[index]);</span>
<a href="#l15.59"></a><span id="l15.59">       var todayPaneSplitter = document.getElementById(&quot;today-pane-splitter&quot;);</span>
<a href="#l15.60"></a><span id="l15.60">       setBooleanAttribute(todayPaneSplitter, &quot;hidden&quot;, (index != 0));</span>
<a href="#l15.61"></a><span id="l15.61">       var todayIsVisible = document.getElementById(&quot;today-pane-panel&quot;).isVisible();</span>
<a href="#l15.62"></a><span id="l15.62">       this.disableMenuItems(!todayIsVisible || !agendaIsVisible);</span>
<a href="#l15.63"></a><span id="l15.63">       onCalendarViewResize();</span>
<a href="#l15.64"></a><span id="l15.64">   },</span>
<a href="#l15.65"></a><span id="l15.65"> </span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+  /**</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineplus">+   * Sets up the miniday display in the today pane.</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineplus">+   */</span>
<a href="#l15.69"></a><span id="l15.69">   initializeMiniday: function initializeMiniday() {</span>
<a href="#l15.70"></a><span id="l15.70">       // initialize the label denoting the current month, year and calendarweek</span>
<a href="#l15.71"></a><span id="l15.71">       // with numbers that are supposed to consume the largest width</span>
<a href="#l15.72"></a><span id="l15.72">       // in order to guarantee that the text will not be cropped when modified</span>
<a href="#l15.73"></a><span id="l15.73">       // during runtime</span>
<a href="#l15.74"></a><span id="l15.74">       const kYEARINIT= &quot;5555&quot;;</span>
<a href="#l15.75"></a><span id="l15.75">       const kCALWEEKINIT= &quot;55&quot;;</span>
<a href="#l15.76"></a><span id="l15.76">       var monthdisplaydeck = document.getElementById(&quot;monthNameContainer&quot;);</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineat">@@ -99,25 +115,39 @@ var TodayPane = {</span>
<a href="#l15.78"></a><span id="l15.78">       for (var i = 0; i &lt; childNodes.length; i++) {</span>
<a href="#l15.79"></a><span id="l15.79">           var monthlabel = childNodes[i];</span>
<a href="#l15.80"></a><span id="l15.80">           this.setMonthDescription(monthlabel, i,  kYEARINIT, kCALWEEKINIT);</span>
<a href="#l15.81"></a><span id="l15.81">       }</span>
<a href="#l15.82"></a><span id="l15.82">       agendaListbox.addListener(this);</span>
<a href="#l15.83"></a><span id="l15.83">       this.setDay(now());</span>
<a href="#l15.84"></a><span id="l15.84">   },</span>
<a href="#l15.85"></a><span id="l15.85"> </span>
<a href="#l15.86"></a><span id="l15.86" class="difflineplus">+  /**</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineplus">+   * Helper function to set the month description on the today pane header.</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineplus">+   *</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineplus">+   * @param aMonthLabel     The XUL node to set the month label on.</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineplus">+   * @param aIndex          The month number, 0-based.</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineplus">+   * @param aYear           The year this month should be displayed with</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineplus">+   * @param aCalWeek        The calendar week that should be shown.</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineplus">+   * @return                The value set on aMonthLabel.</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineplus">+   */</span>
<a href="#l15.95"></a><span id="l15.95">   setMonthDescription: function setMonthDescription(aMonthLabel, aIndex, aYear, aCalWeek) {</span>
<a href="#l15.96"></a><span id="l15.96">       if (this.cwlabel == null) {</span>
<a href="#l15.97"></a><span id="l15.97">           this.cwlabel = calGetString(&quot;calendar&quot;, &quot;shortcalendarweek&quot;);</span>
<a href="#l15.98"></a><span id="l15.98">       }</span>
<a href="#l15.99"></a><span id="l15.99">       return aMonthLabel.value = getDateFormatter().shortMonthName(aIndex)</span>
<a href="#l15.100"></a><span id="l15.100">               + &quot; &quot; + aYear +  &quot;, &quot; + this.cwlabel + &quot; &quot; +  aCalWeek;</span>
<a href="#l15.101"></a><span id="l15.101">   },</span>
<a href="#l15.102"></a><span id="l15.102"> </span>
<a href="#l15.103"></a><span id="l15.103" class="difflineminus">-  // we can cycle the pane view forward or backwards</span>
<a href="#l15.104"></a><span id="l15.104" class="difflineplus">+  /**</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineplus">+   * Cycle the view shown in the today pane (event+task, event, task).</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineplus">+   *</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineplus">+   * @param aCycleForward       If true, the views are cycled in the forward</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineplus">+   *                              direction, otherwise in the opposite direction</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineplus">+   */</span>
<a href="#l15.110"></a><span id="l15.110">   cyclePaneView: function cyclePaneView(aCycleForward) {</span>
<a href="#l15.111"></a><span id="l15.111">       if (this.paneViews == null) {</span>
<a href="#l15.112"></a><span id="l15.112">           return;</span>
<a href="#l15.113"></a><span id="l15.113">       }</span>
<a href="#l15.114"></a><span id="l15.114">       var index = parseInt(document.getElementById(&quot;today-pane-header&quot;).getAttribute(&quot;index&quot;));</span>
<a href="#l15.115"></a><span id="l15.115">       index = index + aCycleForward;</span>
<a href="#l15.116"></a><span id="l15.116">       var nViewLen = this.paneViews.length;</span>
<a href="#l15.117"></a><span id="l15.117">       if (index &gt;= nViewLen) {</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineat">@@ -130,35 +160,58 @@ var TodayPane = {</span>
<a href="#l15.119"></a><span id="l15.119">       var currentMode = document.getElementById(&quot;modeBroadcaster&quot;).getAttribute(&quot;mode&quot;);</span>
<a href="#l15.120"></a><span id="l15.120">       var isTodoPanelVisible = (index != 2 &amp;&amp; todoPanel.isVisibleInMode(currentMode));</span>
<a href="#l15.121"></a><span id="l15.121">       var isAgendaPanelVisible = (index != 1 &amp;&amp; agendaPanel.isVisibleInMode(currentMode));</span>
<a href="#l15.122"></a><span id="l15.122">       todoPanel.setVisible(isTodoPanelVisible);</span>
<a href="#l15.123"></a><span id="l15.123">       agendaPanel.setVisible(isAgendaPanelVisible);</span>
<a href="#l15.124"></a><span id="l15.124">       this.setTodayHeader();</span>
<a href="#l15.125"></a><span id="l15.125">   },</span>
<a href="#l15.126"></a><span id="l15.126"> </span>
<a href="#l15.127"></a><span id="l15.127" class="difflineplus">+  /**</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineplus">+   * Shows short weekday names in the weekdayNameContainer</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineplus">+   */</span>
<a href="#l15.130"></a><span id="l15.130">   setShortWeekdays: function setShortWeekdays() {</span>
<a href="#l15.131"></a><span id="l15.131">       var weekdisplaydeck = document.getElementById(&quot;weekdayNameContainer&quot;);</span>
<a href="#l15.132"></a><span id="l15.132">       var childNodes = weekdisplaydeck.childNodes;</span>
<a href="#l15.133"></a><span id="l15.133">       for (var i = 0; i &lt; childNodes.length; i++) {</span>
<a href="#l15.134"></a><span id="l15.134">           childNodes[i].setAttribute(&quot;value&quot;, calGetString(&quot;dateFormat&quot;,&quot;day.&quot; + (i+1) + &quot;.Mmm&quot;));</span>
<a href="#l15.135"></a><span id="l15.135">       }</span>
<a href="#l15.136"></a><span id="l15.136">   },</span>
<a href="#l15.137"></a><span id="l15.137"> </span>
<a href="#l15.138"></a><span id="l15.138" class="difflineplus">+  /**</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineplus">+   * Sets the shown date from a JSDate.</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineplus">+   *</span>
<a href="#l15.141"></a><span id="l15.141" class="difflineplus">+   * @param aNewDate        The date to show.</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineplus">+   */</span>
<a href="#l15.143"></a><span id="l15.143">   setDaywithjsDate: function setDaywithjsDate(aNewDate) {</span>
<a href="#l15.144"></a><span id="l15.144">       var newdatetime = jsDateToDateTime(aNewDate, floating());</span>
<a href="#l15.145"></a><span id="l15.145">       newdatetime = newdatetime.getInTimezone(calendarDefaultTimezone());</span>
<a href="#l15.146"></a><span id="l15.146" class="difflineplus">+</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineplus">+      // XXX this doesn't really fit into this function</span>
<a href="#l15.148"></a><span id="l15.148">       document.getElementById(&quot;aMinimonthPopupset&quot;).hidePopup();</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineplus">+</span>
<a href="#l15.150"></a><span id="l15.150">       return this.setDay(newdatetime, true);</span>
<a href="#l15.151"></a><span id="l15.151">   },</span>
<a href="#l15.152"></a><span id="l15.152"> </span>
<a href="#l15.153"></a><span id="l15.153" class="difflineminus">-  getDay: function getDay(aNewDate) {</span>
<a href="#l15.154"></a><span id="l15.154" class="difflineplus">+  /**</span>
<a href="#l15.155"></a><span id="l15.155" class="difflineplus">+   * Gets the first date shown in the today pane.</span>
<a href="#l15.156"></a><span id="l15.156" class="difflineplus">+   *</span>
<a href="#l15.157"></a><span id="l15.157" class="difflineplus">+   * @return        The first date shown.</span>
<a href="#l15.158"></a><span id="l15.158" class="difflineplus">+   */</span>
<a href="#l15.159"></a><span id="l15.159" class="difflineplus">+  getDay: function getDay() {</span>
<a href="#l15.160"></a><span id="l15.160">       return this.start;</span>
<a href="#l15.161"></a><span id="l15.161">   },</span>
<a href="#l15.162"></a><span id="l15.162"> </span>
<a href="#l15.163"></a><span id="l15.163" class="difflineplus">+  /**</span>
<a href="#l15.164"></a><span id="l15.164" class="difflineplus">+   * Sets the first day shown in the today pane.</span>
<a href="#l15.165"></a><span id="l15.165" class="difflineplus">+   *</span>
<a href="#l15.166"></a><span id="l15.166" class="difflineplus">+   * @param aNewDate                    The calIDateTime to set.</span>
<a href="#l15.167"></a><span id="l15.167" class="difflineplus">+   * @param aDontUpdateMinimonth        If true, the minimonth will not be</span>
<a href="#l15.168"></a><span id="l15.168" class="difflineplus">+   *                                      updated to show the same date.</span>
<a href="#l15.169"></a><span id="l15.169" class="difflineplus">+   */</span>
<a href="#l15.170"></a><span id="l15.170">   setDay: function setDay(aNewDate, aDontUpdateMinimonth) {</span>
<a href="#l15.171"></a><span id="l15.171">       this.start = aNewDate.clone();</span>
<a href="#l15.172"></a><span id="l15.172"> </span>
<a href="#l15.173"></a><span id="l15.173">       var daylabel = document.getElementById(&quot;datevalue-label&quot;);</span>
<a href="#l15.174"></a><span id="l15.174">       daylabel.value = this.start.day;</span>
<a href="#l15.175"></a><span id="l15.175">       var weekdaylabel = document.getElementById(&quot;weekdayNameContainer&quot;);</span>
<a href="#l15.176"></a><span id="l15.176">       weekdaylabel.selectedIndex = this.start.weekday;</span>
<a href="#l15.177"></a><span id="l15.177"> </span>
<a href="#l15.178"></a><span id="l15.178" class="difflineat">@@ -171,56 +224,94 @@ var TodayPane = {</span>
<a href="#l15.179"></a><span id="l15.179">                                this.start.year,</span>
<a href="#l15.180"></a><span id="l15.180">                                getWeekInfoService().getWeekTitle(this.start));</span>
<a href="#l15.181"></a><span id="l15.181">       if (!aDontUpdateMinimonth || !aDontUpdateMinimonth) {</span>
<a href="#l15.182"></a><span id="l15.182">           document.getElementById(&quot;today-Minimonth&quot;).value = this.start.jsDate;</span>
<a href="#l15.183"></a><span id="l15.183">       }</span>
<a href="#l15.184"></a><span id="l15.184">       this.updatePeriod();</span>
<a href="#l15.185"></a><span id="l15.185">   },</span>
<a href="#l15.186"></a><span id="l15.186"> </span>
<a href="#l15.187"></a><span id="l15.187" class="difflineplus">+  /**</span>
<a href="#l15.188"></a><span id="l15.188" class="difflineplus">+   * Advance by a given number of days in the today pane</span>
<a href="#l15.189"></a><span id="l15.189" class="difflineplus">+   *</span>
<a href="#l15.190"></a><span id="l15.190" class="difflineplus">+   * @param dir     The number of days to advance. Negative numbers advance</span>
<a href="#l15.191"></a><span id="l15.191" class="difflineplus">+   *                  backwards in time.</span>
<a href="#l15.192"></a><span id="l15.192" class="difflineplus">+   */</span>
<a href="#l15.193"></a><span id="l15.193">   advance: function advance(dir) {</span>
<a href="#l15.194"></a><span id="l15.194">       this.start.day += dir;</span>
<a href="#l15.195"></a><span id="l15.195">       this.setDay(this.start);</span>
<a href="#l15.196"></a><span id="l15.196">   },</span>
<a href="#l15.197"></a><span id="l15.197"> </span>
<a href="#l15.198"></a><span id="l15.198" class="difflineplus">+  /**</span>
<a href="#l15.199"></a><span id="l15.199" class="difflineplus">+   * Checks if the today pane is showing today's date.</span>
<a href="#l15.200"></a><span id="l15.200" class="difflineplus">+   */</span>
<a href="#l15.201"></a><span id="l15.201">   showsToday: function showsToday() {</span>
<a href="#l15.202"></a><span id="l15.202">       return (sameDay(now(), this.start));</span>
<a href="#l15.203"></a><span id="l15.203">   },</span>
<a href="#l15.204"></a><span id="l15.204"> </span>
<a href="#l15.205"></a><span id="l15.205" class="difflineplus">+  /**</span>
<a href="#l15.206"></a><span id="l15.206" class="difflineplus">+   * Checks if the today pane is showing yesterday's date.</span>
<a href="#l15.207"></a><span id="l15.207" class="difflineplus">+   */</span>
<a href="#l15.208"></a><span id="l15.208">   showsYesterday: function showsYesterday() {</span>
<a href="#l15.209"></a><span id="l15.209">       return (sameDay(yesterday(), this.start));</span>
<a href="#l15.210"></a><span id="l15.210">   },</span>
<a href="#l15.211"></a><span id="l15.211"> </span>
<a href="#l15.212"></a><span id="l15.212" class="difflineplus">+  /**</span>
<a href="#l15.213"></a><span id="l15.213" class="difflineplus">+   * Updates the period headers in the agenda listbox using the today pane's</span>
<a href="#l15.214"></a><span id="l15.214" class="difflineplus">+   * start date.</span>
<a href="#l15.215"></a><span id="l15.215" class="difflineplus">+   */</span>
<a href="#l15.216"></a><span id="l15.216">   updatePeriod: function updatePeriod() {</span>
<a href="#l15.217"></a><span id="l15.217">       var date = this.start.clone();</span>
<a href="#l15.218"></a><span id="l15.218">       return agendaListbox.refreshPeriodDates(date);</span>
<a href="#l15.219"></a><span id="l15.219">   },</span>
<a href="#l15.220"></a><span id="l15.220"> </span>
<a href="#l15.221"></a><span id="l15.221" class="difflineplus">+  /**</span>
<a href="#l15.222"></a><span id="l15.222" class="difflineplus">+   * Display a certain section in the minday/minimonth part of the todaypane.</span>
<a href="#l15.223"></a><span id="l15.223" class="difflineplus">+   *</span>
<a href="#l15.224"></a><span id="l15.224" class="difflineplus">+   * @param aIndex      A numeric value:</span>
<a href="#l15.225"></a><span id="l15.225" class="difflineplus">+   *                     - 1: Show the miniday</span>
<a href="#l15.226"></a><span id="l15.226" class="difflineplus">+   *                     - 2: show the minimonth</span>
<a href="#l15.227"></a><span id="l15.227" class="difflineplus">+   *                     - 3: show none of both</span>
<a href="#l15.228"></a><span id="l15.228" class="difflineplus">+   */</span>
<a href="#l15.229"></a><span id="l15.229">   displayMiniSection: function displayMiniSection(aIndex) {</span>
<a href="#l15.230"></a><span id="l15.230">       document.getElementById(&quot;today-minimonth-box&quot;).setVisible(aIndex == 2);</span>
<a href="#l15.231"></a><span id="l15.231">       document.getElementById(&quot;mini-day-box&quot;).setVisible(aIndex == 1);</span>
<a href="#l15.232"></a><span id="l15.232">       document.getElementById(&quot;today-none-box&quot;).setVisible(aIndex == 3);</span>
<a href="#l15.233"></a><span id="l15.233">       setBooleanAttribute(document.getElementById(&quot;today-Minimonth&quot;), &quot;freebusy&quot;, aIndex == 2);</span>
<a href="#l15.234"></a><span id="l15.234" class="difflineminus">-},</span>
<a href="#l15.235"></a><span id="l15.235" class="difflineplus">+  },</span>
<a href="#l15.236"></a><span id="l15.236"> </span>
<a href="#l15.237"></a><span id="l15.237" class="difflineplus">+  /**</span>
<a href="#l15.238"></a><span id="l15.238" class="difflineplus">+   * Disable or enable the today pane menuitems that have an attribute</span>
<a href="#l15.239"></a><span id="l15.239" class="difflineplus">+   * name=&quot;minidisplay&quot;</span>
<a href="#l15.240"></a><span id="l15.240" class="difflineplus">+   *</span>
<a href="#l15.241"></a><span id="l15.241" class="difflineplus">+   * @param disable         If true, items will be disabled, otherwise enabled.</span>
<a href="#l15.242"></a><span id="l15.242" class="difflineplus">+   */</span>
<a href="#l15.243"></a><span id="l15.243">   disableMenuItems: function disableMenuItems(disable) {</span>
<a href="#l15.244"></a><span id="l15.244">        var menu = document.getElementById(&quot;today-pane-menu&quot;);</span>
<a href="#l15.245"></a><span id="l15.245">        if (menu) {</span>
<a href="#l15.246"></a><span id="l15.246">            setAttributeToChildren(menu.firstChild, &quot;disabled&quot;, disable, &quot;name&quot;, &quot;minidisplay&quot;);</span>
<a href="#l15.247"></a><span id="l15.247">        }</span>
<a href="#l15.248"></a><span id="l15.248">   },</span>
<a href="#l15.249"></a><span id="l15.249"> </span>
<a href="#l15.250"></a><span id="l15.250" class="difflineminus">-  // DOMAttrModified handler that listens to the todaypane-splitter</span>
<a href="#l15.251"></a><span id="l15.251" class="difflineplus">+  /**</span>
<a href="#l15.252"></a><span id="l15.252" class="difflineplus">+   * Hanlder function for the DOMAttrModified event used to observe the</span>
<a href="#l15.253"></a><span id="l15.253" class="difflineplus">+   * todaypane-splitter.</span>
<a href="#l15.254"></a><span id="l15.254" class="difflineplus">+   *</span>
<a href="#l15.255"></a><span id="l15.255" class="difflineplus">+   * @param aEvent      The DOM event occurring on attribute modification.</span>
<a href="#l15.256"></a><span id="l15.256" class="difflineplus">+   */</span>
<a href="#l15.257"></a><span id="l15.257">   onModeModified: function onModeModified(aEvent) {</span>
<a href="#l15.258"></a><span id="l15.258">       if (aEvent.attrName == &quot;mode&quot;) {</span>
<a href="#l15.259"></a><span id="l15.259">           TodayPane.setTodayHeader();</span>
<a href="#l15.260"></a><span id="l15.260">           var todaypanebox = document.getElementById(&quot;today-pane-panel&quot;);</span>
<a href="#l15.261"></a><span id="l15.261">           if (todaypanebox.isVisible()) {</span>
<a href="#l15.262"></a><span id="l15.262">               document.getElementById(&quot;today-splitter&quot;).setAttribute(&quot;state&quot;, &quot;open&quot;);</span>
<a href="#l15.263"></a><span id="l15.263">           }</span>
<a href="#l15.264"></a><span id="l15.264">       }</span>
<a href="#l15.265"></a><span id="l15.265" class="difflineminus">-  }};</span>
<a href="#l15.266"></a><span id="l15.266" class="difflineplus">+  }</span>
<a href="#l15.267"></a><span id="l15.267" class="difflineplus">+};</span>
<a href="#l15.268"></a><span id="l15.268"> </span>
<a href="#l15.269"></a><span id="l15.269" class="difflineplus">+/**</span>
<a href="#l15.270"></a><span id="l15.270" class="difflineplus">+ * Wrapped load function called on window load</span>
<a href="#l15.271"></a><span id="l15.271" class="difflineplus">+ */</span>
<a href="#l15.272"></a><span id="l15.272"> function loadTodayPane() {</span>
<a href="#l15.273"></a><span id="l15.273">     TodayPane.onLoad();</span>
<a href="#l15.274"></a><span id="l15.274"> }</span>
<a href="#l15.275"></a><span id="l15.275" class="difflineminus">-</span>
<a href="#l15.276"></a><span id="l15.276"> window.addEventListener(&quot;load&quot;, loadTodayPane, false);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

