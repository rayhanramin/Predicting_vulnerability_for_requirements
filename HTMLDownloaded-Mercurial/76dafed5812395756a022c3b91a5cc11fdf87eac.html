<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 14511:76dafed5812395756a022c3b91a5cc11fdf87eac</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 76dafed5812395756a022c3b91a5cc11fdf87eac" />
<meta property="og:url" content="/comm-central/rev/76dafed5812395756a022c3b91a5cc11fdf87eac" />
<meta property="og:description" content="Implement the system messages related to status changes in JS so that JS protocols can share them." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 76dafed5812395756a022c3b91a5cc11fdf87eac 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/76dafed5812395756a022c3b91a5cc11fdf87eac">shortlog</a> |
<a href="/comm-central/log/76dafed5812395756a022c3b91a5cc11fdf87eac">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/76dafed5812395756a022c3b91a5cc11fdf87eac">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/76dafed5812395756a022c3b91a5cc11fdf87eac">files</a> |
changeset |
<a href="/comm-central/raw-rev/76dafed5812395756a022c3b91a5cc11fdf87eac">raw</a>  | <a href="/comm-central/archive/76dafed5812395756a022c3b91a5cc11fdf87eac.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Implement the system messages related to status changes in JS so that JS protocols can share them.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#70;&#108;&#111;&#114;&#105;&#97;&#110;&#32;&#81;&#117;&#232;&#122;&#101;&#32;&#60;&#102;&#108;&#111;&#114;&#105;&#97;&#110;&#64;&#105;&#110;&#115;&#116;&#97;&#110;&#116;&#98;&#105;&#114;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 14 Apr 2011 01:51:21 +0200</td></tr>

<tr>
 <td>changeset 14511</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/76dafed5812395756a022c3b91a5cc11fdf87eac">76dafed5812395756a022c3b91a5cc11fdf87eac</a></td>
</tr>



<tr>
<td>parent 14510</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/de741f361d72fcc6d260c110c99cf481f5259c67">de741f361d72fcc6d260c110c99cf481f5259c67</a>
</td>
</tr>

<tr>
<td>child 14512</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/af00f16a6fe7e1fcf70a5cc8217d8fab4fbd3e6b">af00f16a6fe7e1fcf70a5cc8217d8fab4fbd3e6b</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=76dafed5812395756a022c3b91a5cc11fdf87eac">9778</a></td></tr>
<tr><td>push user</td><td>florian@queze.net</td></tr>
<tr><td>push date</td><td class="date age">Sun, 12 Jan 2014 18:25:45 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@f81a23bfefcd [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>






</table></div>

<div class="page_body description">Implement the system messages related to status changes in JS so that JS protocols can share them.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/76dafed5812395756a022c3b91a5cc11fdf87eac/im/locales/en-US/chrome/instantbird/instantbird.properties">im/locales/en-US/chrome/instantbird/instantbird.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/76dafed5812395756a022c3b91a5cc11fdf87eac/im/locales/en-US/chrome/instantbird/instantbird.properties">file</a> |
<a href="/comm-central/annotate/76dafed5812395756a022c3b91a5cc11fdf87eac/im/locales/en-US/chrome/instantbird/instantbird.properties">annotate</a> |
<a href="/comm-central/diff/76dafed5812395756a022c3b91a5cc11fdf87eac/im/locales/en-US/chrome/instantbird/instantbird.properties">diff</a> |
<a href="/comm-central/comparison/76dafed5812395756a022c3b91a5cc11fdf87eac/im/locales/en-US/chrome/instantbird/instantbird.properties">comparison</a> |
<a href="/comm-central/log/76dafed5812395756a022c3b91a5cc11fdf87eac/im/locales/en-US/chrome/instantbird/instantbird.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/76dafed5812395756a022c3b91a5cc11fdf87eac/im/modules/Makefile.in">im/modules/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/76dafed5812395756a022c3b91a5cc11fdf87eac/im/modules/Makefile.in">file</a> |
<a href="/comm-central/annotate/76dafed5812395756a022c3b91a5cc11fdf87eac/im/modules/Makefile.in">annotate</a> |
<a href="/comm-central/diff/76dafed5812395756a022c3b91a5cc11fdf87eac/im/modules/Makefile.in">diff</a> |
<a href="/comm-central/comparison/76dafed5812395756a022c3b91a5cc11fdf87eac/im/modules/Makefile.in">comparison</a> |
<a href="/comm-central/log/76dafed5812395756a022c3b91a5cc11fdf87eac/im/modules/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/76dafed5812395756a022c3b91a5cc11fdf87eac/im/modules/imStatusUtils.jsm">im/modules/imStatusUtils.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/76dafed5812395756a022c3b91a5cc11fdf87eac/im/modules/imStatusUtils.jsm">diff</a> |
<a href="/comm-central/comparison/76dafed5812395756a022c3b91a5cc11fdf87eac/im/modules/imStatusUtils.jsm">comparison</a> |
<a href="/comm-central/log/76dafed5812395756a022c3b91a5cc11fdf87eac/im/modules/imStatusUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/76dafed5812395756a022c3b91a5cc11fdf87eac/purple/locales/en-US/conversations.properties">purple/locales/en-US/conversations.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/76dafed5812395756a022c3b91a5cc11fdf87eac/purple/locales/en-US/conversations.properties">file</a> |
<a href="/comm-central/annotate/76dafed5812395756a022c3b91a5cc11fdf87eac/purple/locales/en-US/conversations.properties">annotate</a> |
<a href="/comm-central/diff/76dafed5812395756a022c3b91a5cc11fdf87eac/purple/locales/en-US/conversations.properties">diff</a> |
<a href="/comm-central/comparison/76dafed5812395756a022c3b91a5cc11fdf87eac/purple/locales/en-US/conversations.properties">comparison</a> |
<a href="/comm-central/log/76dafed5812395756a022c3b91a5cc11fdf87eac/purple/locales/en-US/conversations.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/76dafed5812395756a022c3b91a5cc11fdf87eac/purple/locales/en-US/status.properties">purple/locales/en-US/status.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/76dafed5812395756a022c3b91a5cc11fdf87eac/purple/locales/en-US/status.properties">file</a> |
<a href="/comm-central/annotate/76dafed5812395756a022c3b91a5cc11fdf87eac/purple/locales/en-US/status.properties">annotate</a> |
<a href="/comm-central/diff/76dafed5812395756a022c3b91a5cc11fdf87eac/purple/locales/en-US/status.properties">diff</a> |
<a href="/comm-central/comparison/76dafed5812395756a022c3b91a5cc11fdf87eac/purple/locales/en-US/status.properties">comparison</a> |
<a href="/comm-central/log/76dafed5812395756a022c3b91a5cc11fdf87eac/purple/locales/en-US/status.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/76dafed5812395756a022c3b91a5cc11fdf87eac/purple/purplexpcom/public/imIConversationsService.idl">purple/purplexpcom/public/imIConversationsService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/76dafed5812395756a022c3b91a5cc11fdf87eac/purple/purplexpcom/public/imIConversationsService.idl">file</a> |
<a href="/comm-central/annotate/76dafed5812395756a022c3b91a5cc11fdf87eac/purple/purplexpcom/public/imIConversationsService.idl">annotate</a> |
<a href="/comm-central/diff/76dafed5812395756a022c3b91a5cc11fdf87eac/purple/purplexpcom/public/imIConversationsService.idl">diff</a> |
<a href="/comm-central/comparison/76dafed5812395756a022c3b91a5cc11fdf87eac/purple/purplexpcom/public/imIConversationsService.idl">comparison</a> |
<a href="/comm-central/log/76dafed5812395756a022c3b91a5cc11fdf87eac/purple/purplexpcom/public/imIConversationsService.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/76dafed5812395756a022c3b91a5cc11fdf87eac/purple/purplexpcom/src/imConversations.js">purple/purplexpcom/src/imConversations.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/76dafed5812395756a022c3b91a5cc11fdf87eac/purple/purplexpcom/src/imConversations.js">file</a> |
<a href="/comm-central/annotate/76dafed5812395756a022c3b91a5cc11fdf87eac/purple/purplexpcom/src/imConversations.js">annotate</a> |
<a href="/comm-central/diff/76dafed5812395756a022c3b91a5cc11fdf87eac/purple/purplexpcom/src/imConversations.js">diff</a> |
<a href="/comm-central/comparison/76dafed5812395756a022c3b91a5cc11fdf87eac/purple/purplexpcom/src/imConversations.js">comparison</a> |
<a href="/comm-central/log/76dafed5812395756a022c3b91a5cc11fdf87eac/purple/purplexpcom/src/imConversations.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/76dafed5812395756a022c3b91a5cc11fdf87eac/purple/purplexpcom/src/imStatusUtils.jsm">purple/purplexpcom/src/imStatusUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/76dafed5812395756a022c3b91a5cc11fdf87eac/purple/purplexpcom/src/imStatusUtils.jsm">file</a> |
<a href="/comm-central/annotate/76dafed5812395756a022c3b91a5cc11fdf87eac/purple/purplexpcom/src/imStatusUtils.jsm">annotate</a> |
<a href="/comm-central/diff/76dafed5812395756a022c3b91a5cc11fdf87eac/purple/purplexpcom/src/imStatusUtils.jsm">diff</a> |
<a href="/comm-central/comparison/76dafed5812395756a022c3b91a5cc11fdf87eac/purple/purplexpcom/src/imStatusUtils.jsm">comparison</a> |
<a href="/comm-central/log/76dafed5812395756a022c3b91a5cc11fdf87eac/purple/purplexpcom/src/imStatusUtils.jsm">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/im/locales/en-US/chrome/instantbird/instantbird.properties</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/im/locales/en-US/chrome/instantbird/instantbird.properties</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -47,27 +47,16 @@ group.hidePrompt.message=The tag '%S' will no longer be visible. Use the 'Visible Tags…' context menu item to show it again.\n\nContacts that have no visible tag will be displayed in the 'Other Contacts' special group at the bottom of the list.</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> #LOCALIZATION NOTE</span>
<a href="#l1.6"></a><span id="l1.6"> # the &amp; symbol indicates the position of the character that should be</span>
<a href="#l1.7"></a><span id="l1.7"> # used as the accesskey for this button.</span>
<a href="#l1.8"></a><span id="l1.8"> group.hidePrompt.button=&amp;Hide</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> group.hidePrompt.checkbox=Show next time</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-availableStatusType=Available</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-awayStatusType=Away</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-unavailableStatusType=Unavailable</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-offlineStatusType=Offline</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-invisibleStatusType=Invisible</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-idleStatusType=Idle</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-mobileStatusType=Mobile</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-#LOCALIZATION NOTE</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-# the status of a buddy is unknown when it's in the list of a disconnected account</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-unknownStatusType=Unknown</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-</span>
<a href="#l1.23"></a><span id="l1.23"> isTyping=%S is typing.</span>
<a href="#l1.24"></a><span id="l1.24"> hasStoppedTyping=%S has stopped typing.</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26"> #LOCALIZATION NOTE</span>
<a href="#l1.27"></a><span id="l1.27"> # this will be the away message put automatically when the user is idle</span>
<a href="#l1.28"></a><span id="l1.28"> messenger.status.defaultIdleAwayMessage=I am currently away from the computer.</span>
<a href="#l1.29"></a><span id="l1.29"> </span>
<a href="#l1.30"></a><span id="l1.30"> #LOCALIZATION NOTE</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/im/modules/Makefile.in</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/im/modules/Makefile.in</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -42,17 +42,16 @@ VPATH		= @srcdir@</span>
<a href="#l2.4"></a><span id="l2.4"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6"> EXTRA_JS_MODULES = \</span>
<a href="#l2.7"></a><span id="l2.7"> 	ibCore.jsm \</span>
<a href="#l2.8"></a><span id="l2.8"> 	ibNotifications.jsm \</span>
<a href="#l2.9"></a><span id="l2.9"> 	imContentSink.jsm \</span>
<a href="#l2.10"></a><span id="l2.10"> 	imServices.jsm \</span>
<a href="#l2.11"></a><span id="l2.11"> 	imSmileys.jsm \</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-	imStatusUtils.jsm \</span>
<a href="#l2.13"></a><span id="l2.13"> 	imWindows.jsm \</span>
<a href="#l2.14"></a><span id="l2.14"> 	$(NULL)</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16"> EXTRA_PP_JS_MODULES = \</span>
<a href="#l2.17"></a><span id="l2.17"> 	imThemes.jsm \</span>
<a href="#l2.18"></a><span id="l2.18"> 	imTextboxUtils.jsm \</span>
<a href="#l2.19"></a><span id="l2.19"> 	$(NULL)</span>
<a href="#l2.20"></a><span id="l2.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/purple/locales/en-US/conversations.properties</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/purple/locales/en-US/conversations.properties</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,4 +1,19 @@</span>
<a href="#l3.4"></a><span id="l3.4"> # LOCALIZATION NOTE (targetChanged):</span>
<a href="#l3.5"></a><span id="l3.5"> #  %1$S is the new conversation title (display name of the new target),</span>
<a href="#l3.6"></a><span id="l3.6"> #  %2$S is the protocol name used for the new target.</span>
<a href="#l3.7"></a><span id="l3.7"> targetChanged=The conversation will continue with %1$S, using %2$S.</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+# LOCALIZATION NOTE (statusChanged):</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+#  %1$S is the display name of the contact.</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+#  %2$S is the new status type (a value from status.properties).</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+statusChanged=%1$S is now %2$S.</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+# LOCALIZATION NOTE (statusChangedWithStatusText):</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+#  %1$S is the display name of the contact.</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+#  %2$S is the new status type (a value from status.properties).</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+#  %3$S is the status text (eg. &quot;I'm currently away from the computer&quot;).</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+statusChangedWithStatusText=%1$S is now %2$S: %3$S.</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+# LOCALIZATION NOTE (statusChangedWithStatusText):</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+#  %S is the display name of the contact.</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+statusUnknown=Your account is disconnected (the status of %S is no longer known).</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+accountDisconnected=Your account is disconnected.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/purple/locales/en-US/status.properties</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,13 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+#LOCALIZATION NOTE</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+# This used to be in instantbird.properties, you don't need to retranslate it.</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+availableStatusType=Available</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+awayStatusType=Away</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+unavailableStatusType=Unavailable</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+offlineStatusType=Offline</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+invisibleStatusType=Invisible</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+idleStatusType=Idle</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+mobileStatusType=Mobile</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+#LOCALIZATION NOTE</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+# the status of a buddy is unknown when it's in the list of a disconnected account</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+unknownStatusType=Unknown</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/purple/purplexpcom/public/imIConversationsService.idl</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/purple/purplexpcom/public/imIConversationsService.idl</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -52,13 +52,13 @@ interface imIConversationsService: nsISu</span>
<a href="#l5.4"></a><span id="l5.4">   void unInitConversations();</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6">   // register a conversation. This will create a unique id for the</span>
<a href="#l5.7"></a><span id="l5.7">   // conversation and set it.</span>
<a href="#l5.8"></a><span id="l5.8">   void addConversation(in purpleIConversation aConversation);</span>
<a href="#l5.9"></a><span id="l5.9">   void removeConversation(in purpleIConversation aConversation);</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11">   imIConversation getUIConversation(in purpleIConversation aConversation);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  imIConversation getUIConversationByContactId(in unsigned long aId);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  imIConversation getUIConversationByContactId(in long aId);</span>
<a href="#l5.14"></a><span id="l5.14"> </span>
<a href="#l5.15"></a><span id="l5.15">   nsISimpleEnumerator getConversations();</span>
<a href="#l5.16"></a><span id="l5.16">   purpleIConversation getConversationById(in unsigned long aId);</span>
<a href="#l5.17"></a><span id="l5.17"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/purple/purplexpcom/src/imConversations.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/purple/purplexpcom/src/imConversations.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -34,46 +34,52 @@</span>
<a href="#l6.4"></a><span id="l6.4">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l6.5"></a><span id="l6.5">  *</span>
<a href="#l6.6"></a><span id="l6.6">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8"> const {classes: Cc, interfaces: Ci, utils: Cu} = Components;</span>
<a href="#l6.9"></a><span id="l6.9"> Cu.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l6.10"></a><span id="l6.10"> Cu.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l6.11"></a><span id="l6.11"> Cu.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+Cu.import(&quot;resource:///modules/imStatusUtils.jsm&quot;);</span>
<a href="#l6.13"></a><span id="l6.13"> </span>
<a href="#l6.14"></a><span id="l6.14"> var gLastUIConvId = 0;</span>
<a href="#l6.15"></a><span id="l6.15"> var gLastPurpleConvId = 0;</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17"> XPCOMUtils.defineLazyGetter(this, &quot;bundle&quot;, function()</span>
<a href="#l6.18"></a><span id="l6.18">   Services.strings.createBundle(&quot;chrome://purple/locale/conversations.properties&quot;)</span>
<a href="#l6.19"></a><span id="l6.19"> );</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-function UIConversation(aPurpleConversation, aContactId)</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+function UIConversation(aPurpleConversation)</span>
<a href="#l6.23"></a><span id="l6.23"> {</span>
<a href="#l6.24"></a><span id="l6.24">   this._purpleConv = {};</span>
<a href="#l6.25"></a><span id="l6.25">   this.id = ++gLastUIConvId;</span>
<a href="#l6.26"></a><span id="l6.26">   this._observers = [];</span>
<a href="#l6.27"></a><span id="l6.27">   this._pendingMessages = [];</span>
<a href="#l6.28"></a><span id="l6.28">   this.changeTargetTo(aPurpleConversation);</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-  if (aContactId)</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-    this.contactId = aContactId;</span>
<a href="#l6.31"></a><span id="l6.31">   let iface = Ci[&quot;purpleIConv&quot; + (aPurpleConversation.isChat ? &quot;Chat&quot; : &quot;IM&quot;)];</span>
<a href="#l6.32"></a><span id="l6.32">   this._interfaces = this._interfaces.concat(iface);</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+  let contact = this.contact;</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+  if (contact) {</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+    // XPConnect will create a wrapper around 'this' here,</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+    // so the list of exposed interfaces shouldn't change anymore.</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+    contact.addObserver(this);</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+    this._observedContact = contact;</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+  }</span>
<a href="#l6.40"></a><span id="l6.40">   Services.obs.notifyObservers(this, &quot;new-ui-conversation&quot;, null);</span>
<a href="#l6.41"></a><span id="l6.41"> }</span>
<a href="#l6.42"></a><span id="l6.42"> </span>
<a href="#l6.43"></a><span id="l6.43"> UIConversation.prototype = {</span>
<a href="#l6.44"></a><span id="l6.44">   __proto__: ClassInfo([&quot;imIConversation&quot;, &quot;purpleIConversation&quot;, &quot;nsIObserver&quot;],</span>
<a href="#l6.45"></a><span id="l6.45">                        &quot;UI conversation&quot;),</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-  contactId: null,</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+  _observedContact: null,</span>
<a href="#l6.48"></a><span id="l6.48">   get contact() {</span>
<a href="#l6.49"></a><span id="l6.49">     let target = this.target;</span>
<a href="#l6.50"></a><span id="l6.50">     if (!target.isChat &amp;&amp; target.buddy)</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-      return target.buddy.contact;</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+      return target.buddy.buddy.contact;</span>
<a href="#l6.53"></a><span id="l6.53">     return null;</span>
<a href="#l6.54"></a><span id="l6.54">   },</span>
<a href="#l6.55"></a><span id="l6.55">   get target() this._purpleConv[this._currentTargetId],</span>
<a href="#l6.56"></a><span id="l6.56">   set target(aPurpleConversation) {</span>
<a href="#l6.57"></a><span id="l6.57">     this.changeTargetTo(aPurpleConversation);</span>
<a href="#l6.58"></a><span id="l6.58">   },</span>
<a href="#l6.59"></a><span id="l6.59">   _currentTargetId: 0,</span>
<a href="#l6.60"></a><span id="l6.60">   changeTargetTo: function(aPurpleConversation) {</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineat">@@ -92,31 +98,95 @@ UIConversation.prototype = {</span>
<a href="#l6.62"></a><span id="l6.62">       this.notifyObservers(this, &quot;target-purple-conversation-changed&quot;);</span>
<a href="#l6.63"></a><span id="l6.63">       let target = this.target;</span>
<a href="#l6.64"></a><span id="l6.64">       let params = [target.title, target.account.protocol.name];</span>
<a href="#l6.65"></a><span id="l6.65">       this.systemMessage(bundle.formatStringFromName(&quot;targetChanged&quot;,</span>
<a href="#l6.66"></a><span id="l6.66">                                                      params, params.length));</span>
<a href="#l6.67"></a><span id="l6.67">     }</span>
<a href="#l6.68"></a><span id="l6.68">   },</span>
<a href="#l6.69"></a><span id="l6.69">   // Returns a boolean indicating if the ui-conversation was closed.</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-  removeTarget: function(aPurpleConversation) {</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+  // If the conversation was closed, aContactId.value is set to the contact id</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+  // or 0 if no contact was associated with the conversation.</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+  removeTarget: function(aPurpleConversation, aContactId) {</span>
<a href="#l6.74"></a><span id="l6.74">     let id = aPurpleConversation.id;</span>
<a href="#l6.75"></a><span id="l6.75">     if (!(id in this._purpleConv))</span>
<a href="#l6.76"></a><span id="l6.76">       throw &quot;unknown purple conversation&quot;;</span>
<a href="#l6.77"></a><span id="l6.77"> </span>
<a href="#l6.78"></a><span id="l6.78">     delete this._purpleConv[id];</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-    if (this._currentTargetId == id) {</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-      for (let newId in this._purpleConv) {</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-        this.changeTargetTo(this._purpleConv[newId]);</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-        return false;</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+    if (this._currentTargetId != id)</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+      return false;</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+    for (let newId in this._purpleConv) {</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+      this.changeTargetTo(this._purpleConv[newId]);</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+      return false;</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+    }</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+    if (this._observedContact) {</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+      this._observedContact.removeObserver(this);</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+      aContactId.value = this._observedContact.id;</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+      delete this._observedContact;</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+    }</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+    else</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+      aContactId.value = 0;</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+    this.notifyObservers(this, &quot;ui-conversation-closed&quot;);</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+    Services.obs.notifyObservers(this, &quot;ui-conversation-closed&quot;, null);</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+    return true;</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+  },</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+  observe: function(aSubject, aTopic, aData) {</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+    if (aTopic == &quot;contact-no-longer-dummy&quot;) {</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+      let oldId = parseInt(aData);</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+      // gConversationsService is ugly... :(</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+      delete gConversationsService._uiConvByContactId[oldId];</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+      gConversationsService._uiConvByContactId[aSubject.id] = this;</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+      return;</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+    }</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+    if (aTopic != &quot;account-buddy-status-changed&quot; ||</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+        aSubject.account.id != this.account.id ||</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+        aSubject.buddy.id != this.buddy.buddy.id)</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+      return;</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+    this.notifyObservers(this, &quot;update-buddy-status&quot;);</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineplus">+    let statusType = aSubject.buddy.statusType;</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineplus">+    let msg;</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+    if (statusType == Ci.imIStatusInfo.STATUS_UNKNOWN)</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+      msg = bundle.formatStringFromName(&quot;statusUnknown&quot;, [this.title], 1);</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+    else {</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+      let status = Status.toLabel(statusType);</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+      let statusText = aSubject.buddy.statusText;</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+      if (statusText) {</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineplus">+        msg = bundle.formatStringFromName(&quot;statusChangedWithStatusText&quot;,</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineplus">+                                          [this.title, status, statusText],</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+                                          3);</span>
<a href="#l6.130"></a><span id="l6.130">       }</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineminus">-      this.notifyObservers(this, &quot;ui-conversation-closed&quot;);</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineminus">-      Services.obs.notifyObservers(this, &quot;ui-conversation-closed&quot;, null);</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineminus">-      return true;</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineplus">+      else {</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineplus">+        msg = bundle.formatStringFromName(&quot;statusChanged&quot;,</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineplus">+                                          [this.title, status], 2);</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineplus">+      }</span>
<a href="#l6.138"></a><span id="l6.138">     }</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+    this.systemMessage(msg);</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+  },</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineplus">+</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+  _disconnected: false,</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineplus">+  disconnecting: function() {</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineplus">+    if (this._disconnected)</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineplus">+      return;</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineplus">+</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineplus">+    this._disconnected = true;</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineplus">+    if (this.contact)</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+      return; // handled by the contact observer.</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineplus">+</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+    this.systemMessage(bundle.GetStringFromName(&quot;accountDisconnected&quot;));</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineplus">+    this.notifyObservers(this, &quot;update-buddy-status&quot;);</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+  },</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+  connected: function() {</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineplus">+    delete this._disconnected;</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineplus">+    this.notifyObservers(this, &quot;update-buddy-status&quot;);</span>
<a href="#l6.157"></a><span id="l6.157">   },</span>
<a href="#l6.158"></a><span id="l6.158"> </span>
<a href="#l6.159"></a><span id="l6.159">   observeConv: function(aTargetId, aSubject, aTopic, aData) {</span>
<a href="#l6.160"></a><span id="l6.160">     if (aTargetId != this._currentTargetId &amp;&amp;</span>
<a href="#l6.161"></a><span id="l6.161">         (aTopic == &quot;new-text&quot; ||</span>
<a href="#l6.162"></a><span id="l6.162">          (aTopic == &quot;update-typing&quot; &amp;&amp;</span>
<a href="#l6.163"></a><span id="l6.163">           this._purpleConv[aTargetId].typingState == Ci.purpleIConvIM.TYPING)))</span>
<a href="#l6.164"></a><span id="l6.164">       this.target = this._purpleConv[aTargetId];</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineat">@@ -168,33 +238,53 @@ UIConversation.prototype = {</span>
<a href="#l6.166"></a><span id="l6.166">   // Chat only</span>
<a href="#l6.167"></a><span id="l6.167">   getParticipants: function() this.target.getParticipants(),</span>
<a href="#l6.168"></a><span id="l6.168">   get topic() this.target.topic,</span>
<a href="#l6.169"></a><span id="l6.169">   get topicSetter() this.target.topicSetter,</span>
<a href="#l6.170"></a><span id="l6.170">   get nick() this.target.nick,</span>
<a href="#l6.171"></a><span id="l6.171">   get left() this.target.left</span>
<a href="#l6.172"></a><span id="l6.172"> };</span>
<a href="#l6.173"></a><span id="l6.173"> </span>
<a href="#l6.174"></a><span id="l6.174" class="difflineminus">-function ConversationsService() { }</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineplus">+var gConversationsService;</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineplus">+function ConversationsService() { gConversationsService = this; }</span>
<a href="#l6.177"></a><span id="l6.177"> ConversationsService.prototype = {</span>
<a href="#l6.178"></a><span id="l6.178">   initConversations: function() {</span>
<a href="#l6.179"></a><span id="l6.179">     this._uiConv = {};</span>
<a href="#l6.180"></a><span id="l6.180">     this._uiConvByContactId = {};</span>
<a href="#l6.181"></a><span id="l6.181">     this._purpleConversations = [];</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineplus">+    Services.obs.addObserver(this, &quot;account-disconnecting&quot;, false);</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineplus">+    Services.obs.addObserver(this, &quot;account-connected&quot;, false);</span>
<a href="#l6.184"></a><span id="l6.184">   },</span>
<a href="#l6.185"></a><span id="l6.185"> </span>
<a href="#l6.186"></a><span id="l6.186">   unInitConversations: function() {</span>
<a href="#l6.187"></a><span id="l6.187">     for each (let UIConv in this._uiConv)</span>
<a href="#l6.188"></a><span id="l6.188">       UIConv.unInit();</span>
<a href="#l6.189"></a><span id="l6.189">     delete this._uiConv;</span>
<a href="#l6.190"></a><span id="l6.190">     delete this._uiConvByContactId;</span>
<a href="#l6.191"></a><span id="l6.191">     // This should already be empty, but just to be sure...</span>
<a href="#l6.192"></a><span id="l6.192">     for each (let purpleConv in this._purpleConversations)</span>
<a href="#l6.193"></a><span id="l6.193">       purpleConv.unInit();</span>
<a href="#l6.194"></a><span id="l6.194">     delete this._purpleConversations;</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineplus">+    Services.obs.removeObserver(this, &quot;account-disconnecting&quot;);</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineplus">+    Services.obs.removeObserver(this, &quot;account-connected&quot;);</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineplus">+  },</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineplus">+</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineplus">+  observe: function(aSubject, aTopic, aData) {</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineplus">+    if (aTopic == &quot;account-connected&quot;) {</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineplus">+      for each (let conv in this._uiConv) {</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineplus">+        if (conv.account.id == aSubject.id)</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineplus">+          conv.connected();</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineplus">+      }</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineplus">+    }</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineplus">+    else if (aTopic == &quot;account-disconnecting&quot;) {</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineplus">+      for each (let conv in this._uiConv) {</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineplus">+        if (conv.account.id == aSubject.id)</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineplus">+          conv.disconnecting();</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineplus">+      }</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineplus">+    }</span>
<a href="#l6.212"></a><span id="l6.212">   },</span>
<a href="#l6.213"></a><span id="l6.213"> </span>
<a href="#l6.214"></a><span id="l6.214">   addConversation: function(aPurpleConversation) {</span>
<a href="#l6.215"></a><span id="l6.215">     // Give an id to the new conversation.</span>
<a href="#l6.216"></a><span id="l6.216">     aPurpleConversation.id = ++gLastPurpleConvId;</span>
<a href="#l6.217"></a><span id="l6.217">     this._purpleConversations.push(aPurpleConversation);</span>
<a href="#l6.218"></a><span id="l6.218"> </span>
<a href="#l6.219"></a><span id="l6.219">     // Notify observers.</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineat">@@ -212,31 +302,30 @@ ConversationsService.prototype = {</span>
<a href="#l6.221"></a><span id="l6.221">       if (contactId in this._uiConvByContactId) {</span>
<a href="#l6.222"></a><span id="l6.222">         let uiConv = this._uiConvByContactId[contactId];</span>
<a href="#l6.223"></a><span id="l6.223">         uiConv.target = aPurpleConversation;</span>
<a href="#l6.224"></a><span id="l6.224">         this._uiConv[aPurpleConversation.id] = uiConv;</span>
<a href="#l6.225"></a><span id="l6.225">         return;</span>
<a href="#l6.226"></a><span id="l6.226">       }</span>
<a href="#l6.227"></a><span id="l6.227">     }</span>
<a href="#l6.228"></a><span id="l6.228"> </span>
<a href="#l6.229"></a><span id="l6.229" class="difflineminus">-    // We store the contactId in the UIConversation because we can't reliably</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineminus">-    // get it from purpleIConvIM objects during removeConversation calls.</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineminus">-    let newUIConv = new UIConversation(aPurpleConversation, contactId);</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineplus">+    let newUIConv = new UIConversation(aPurpleConversation);</span>
<a href="#l6.233"></a><span id="l6.233">     this._uiConv[aPurpleConversation.id] = newUIConv;</span>
<a href="#l6.234"></a><span id="l6.234">     if (contactId)</span>
<a href="#l6.235"></a><span id="l6.235">       this._uiConvByContactId[contactId] = newUIConv;</span>
<a href="#l6.236"></a><span id="l6.236">   },</span>
<a href="#l6.237"></a><span id="l6.237">   removeConversation: function(aPurpleConversation) {</span>
<a href="#l6.238"></a><span id="l6.238">     Services.obs.notifyObservers(aPurpleConversation, &quot;conversation-closed&quot;, null);</span>
<a href="#l6.239"></a><span id="l6.239"> </span>
<a href="#l6.240"></a><span id="l6.240">     let uiConv = this.getUIConversation(aPurpleConversation);</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineminus">-    if (uiConv.removeTarget(aPurpleConversation)) {</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineplus">+    let contactId = {};</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineplus">+    if (uiConv.removeTarget(aPurpleConversation, contactId)) {</span>
<a href="#l6.244"></a><span id="l6.244">       delete this._uiConv[aPurpleConversation.id];</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineminus">-      if (uiConv.contactId)</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineminus">-        delete this._uiConvByContactId[uiConv.contactId];</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineplus">+      if (contactId.value)</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineplus">+        delete this._uiConvByContactId[contactId.value];</span>
<a href="#l6.249"></a><span id="l6.249">     }</span>
<a href="#l6.250"></a><span id="l6.250">     aPurpleConversation.unInit();</span>
<a href="#l6.251"></a><span id="l6.251"> </span>
<a href="#l6.252"></a><span id="l6.252">     this._purpleConversations =</span>
<a href="#l6.253"></a><span id="l6.253">       this._purpleConversations.filter(function(c) c !== aPurpleConversation);</span>
<a href="#l6.254"></a><span id="l6.254">   },</span>
<a href="#l6.255"></a><span id="l6.255"> </span>
<a href="#l6.256"></a><span id="l6.256">   getUIConversation: function(aPurpleConversation) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">rename from im/modules/imStatusUtils.jsm</span>
<a href="#l7.2"></a><span id="l7.2">rename to purple/purplexpcom/src/imStatusUtils.jsm</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineminus">--- a/im/modules/imStatusUtils.jsm</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineplus">+++ b/purple/purplexpcom/src/imStatusUtils.jsm</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineat">@@ -55,14 +55,14 @@ const Status = {</span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7">   _labels: {},</span>
<a href="#l7.8"></a><span id="l7.8">   toLabel: function(aStatusType) {</span>
<a href="#l7.9"></a><span id="l7.9">     if (!(typeof aStatusType == &quot;string&quot;))</span>
<a href="#l7.10"></a><span id="l7.10">       aStatusType = this.toAttribute(aStatusType);</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12">     if (!(aStatusType in this._labels)) {</span>
<a href="#l7.13"></a><span id="l7.13">       this._labels[aStatusType] =</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-        Services.strings.createBundle(&quot;chrome://instantbird/locale/instantbird.properties&quot;)</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+        Services.strings.createBundle(&quot;chrome://purple/locale/status.properties&quot;)</span>
<a href="#l7.16"></a><span id="l7.16">                 .GetStringFromName(aStatusType + &quot;StatusType&quot;);</span>
<a href="#l7.17"></a><span id="l7.17">     }</span>
<a href="#l7.18"></a><span id="l7.18">     return this._labels[aStatusType];</span>
<a href="#l7.19"></a><span id="l7.19">   }</span>
<a href="#l7.20"></a><span id="l7.20"> };</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

