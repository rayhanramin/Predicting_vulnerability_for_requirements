<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29826:b5234d4b31c387e45247c952be0166c270d76a30</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ b5234d4b31c387e45247c952be0166c270d76a30" />
<meta property="og:url" content="/comm-central/rev/b5234d4b31c387e45247c952be0166c270d76a30" />
<meta property="og:description" content="Bug 1582410 - message compose should use document.execCommand for editing commands. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / b5234d4b31c387e45247c952be0166c270d76a30 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/b5234d4b31c387e45247c952be0166c270d76a30">shortlog</a> |
<a href="/comm-central/log/b5234d4b31c387e45247c952be0166c270d76a30">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/b5234d4b31c387e45247c952be0166c270d76a30">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/b5234d4b31c387e45247c952be0166c270d76a30">files</a> |
changeset |
<a href="/comm-central/raw-rev/b5234d4b31c387e45247c952be0166c270d76a30">raw</a>  | <a href="/comm-central/archive/b5234d4b31c387e45247c952be0166c270d76a30.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1582410">Bug 1582410</a> - message compose should use document.execCommand for editing commands. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#75;&#104;&#117;&#115;&#104;&#105;&#108;&#32;&#77;&#105;&#115;&#116;&#114;&#121;&#32;&#60;&#107;&#104;&#117;&#115;&#104;&#105;&#108;&#51;&#50;&#52;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 10 Jun 2020 14:56:11 +0300</td></tr>

<tr>
 <td>changeset 29826</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/b5234d4b31c387e45247c952be0166c270d76a30">b5234d4b31c387e45247c952be0166c270d76a30</a></td>
</tr>



<tr>
<td>parent 29825</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b31d74b967798e5f0f5daa164574b38c1a48918f">b31d74b967798e5f0f5daa164574b38c1a48918f</a>
</td>
</tr>

<tr>
<td>child 29827</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ed7598393624bb4f42df85e4472d0852d5e9ab85">ed7598393624bb4f42df85e4472d0852d5e9ab85</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=b5234d4b31c387e45247c952be0166c270d76a30">17552</a></td></tr>
<tr><td>push user</td><td>mkmelin@iki.fi</td></tr>
<tr><td>push date</td><td class="date age">Wed, 10 Jun 2020 14:48:11 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@813ca5b455a8 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=813ca5b455a81aa0d94b0ccc9e4d4f7261e45a8e">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=813ca5b455a81aa0d94b0ccc9e4d4f7261e45a8e&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=813ca5b455a81aa0d94b0ccc9e4d4f7261e45a8e&newProject=comm-central&newRevision=b5234d4b31c387e45247c952be0166c270d76a30&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=813ca5b455a81aa0d94b0ccc9e4d4f7261e45a8e&newProject=comm-central&newRevision=b5234d4b31c387e45247c952be0166c270d76a30&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=813ca5b455a81aa0d94b0ccc9e4d4f7261e45a8e&newProject=comm-central&newRevision=b5234d4b31c387e45247c952be0166c270d76a30&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1582410">1582410</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1582410">Bug 1582410</a> - message compose should use document.execCommand for editing commands. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b5234d4b31c387e45247c952be0166c270d76a30/mail/components/compose/content/ComposerCommands.js">mail/components/compose/content/ComposerCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b5234d4b31c387e45247c952be0166c270d76a30/mail/components/compose/content/ComposerCommands.js">file</a> |
<a href="/comm-central/annotate/b5234d4b31c387e45247c952be0166c270d76a30/mail/components/compose/content/ComposerCommands.js">annotate</a> |
<a href="/comm-central/diff/b5234d4b31c387e45247c952be0166c270d76a30/mail/components/compose/content/ComposerCommands.js">diff</a> |
<a href="/comm-central/comparison/b5234d4b31c387e45247c952be0166c270d76a30/mail/components/compose/content/ComposerCommands.js">comparison</a> |
<a href="/comm-central/log/b5234d4b31c387e45247c952be0166c270d76a30/mail/components/compose/content/ComposerCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b5234d4b31c387e45247c952be0166c270d76a30/mail/components/compose/content/MsgComposeCommands.js">mail/components/compose/content/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b5234d4b31c387e45247c952be0166c270d76a30/mail/components/compose/content/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/b5234d4b31c387e45247c952be0166c270d76a30/mail/components/compose/content/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/b5234d4b31c387e45247c952be0166c270d76a30/mail/components/compose/content/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/b5234d4b31c387e45247c952be0166c270d76a30/mail/components/compose/content/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/b5234d4b31c387e45247c952be0166c270d76a30/mail/components/compose/content/MsgComposeCommands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b5234d4b31c387e45247c952be0166c270d76a30/mail/components/compose/content/editFormatButtons.inc.xhtml">mail/components/compose/content/editFormatButtons.inc.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b5234d4b31c387e45247c952be0166c270d76a30/mail/components/compose/content/editFormatButtons.inc.xhtml">file</a> |
<a href="/comm-central/annotate/b5234d4b31c387e45247c952be0166c270d76a30/mail/components/compose/content/editFormatButtons.inc.xhtml">annotate</a> |
<a href="/comm-central/diff/b5234d4b31c387e45247c952be0166c270d76a30/mail/components/compose/content/editFormatButtons.inc.xhtml">diff</a> |
<a href="/comm-central/comparison/b5234d4b31c387e45247c952be0166c270d76a30/mail/components/compose/content/editFormatButtons.inc.xhtml">comparison</a> |
<a href="/comm-central/log/b5234d4b31c387e45247c952be0166c270d76a30/mail/components/compose/content/editFormatButtons.inc.xhtml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b5234d4b31c387e45247c952be0166c270d76a30/mail/components/compose/content/editor.js">mail/components/compose/content/editor.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b5234d4b31c387e45247c952be0166c270d76a30/mail/components/compose/content/editor.js">file</a> |
<a href="/comm-central/annotate/b5234d4b31c387e45247c952be0166c270d76a30/mail/components/compose/content/editor.js">annotate</a> |
<a href="/comm-central/diff/b5234d4b31c387e45247c952be0166c270d76a30/mail/components/compose/content/editor.js">diff</a> |
<a href="/comm-central/comparison/b5234d4b31c387e45247c952be0166c270d76a30/mail/components/compose/content/editor.js">comparison</a> |
<a href="/comm-central/log/b5234d4b31c387e45247c952be0166c270d76a30/mail/components/compose/content/editor.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b5234d4b31c387e45247c952be0166c270d76a30/mail/components/compose/content/messengercompose.xhtml">mail/components/compose/content/messengercompose.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b5234d4b31c387e45247c952be0166c270d76a30/mail/components/compose/content/messengercompose.xhtml">file</a> |
<a href="/comm-central/annotate/b5234d4b31c387e45247c952be0166c270d76a30/mail/components/compose/content/messengercompose.xhtml">annotate</a> |
<a href="/comm-central/diff/b5234d4b31c387e45247c952be0166c270d76a30/mail/components/compose/content/messengercompose.xhtml">diff</a> |
<a href="/comm-central/comparison/b5234d4b31c387e45247c952be0166c270d76a30/mail/components/compose/content/messengercompose.xhtml">comparison</a> |
<a href="/comm-central/log/b5234d4b31c387e45247c952be0166c270d76a30/mail/components/compose/content/messengercompose.xhtml">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/compose/content/ComposerCommands.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/compose/content/ComposerCommands.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,26 +1,52 @@</span>
<a href="#l1.4"></a><span id="l1.4"> /* -*- Mode: Java; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l1.5"></a><span id="l1.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.6"></a><span id="l1.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.7"></a><span id="l1.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9" class="difflineminus">-/* Implementations of nsIControllerCommand for composer commands */</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineplus">+/**</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineplus">+ * Implementations of nsIControllerCommand for composer commands. These commands</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+ * are related to editing. You can fire these commands with following functions:</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+ * goDoCommand and goDoCommandParams(If command requires any parameters).</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+ *</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+ * Sometimes, we want to reflect the changes in the UI also. We have two functions</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+ * for that: pokeStyleUI and pokeMultiStateUI. The pokeStyleUI function is for those</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+ * commands which are boolean in nature for example &quot;cmd_bold&quot; command, text can</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+ * be bold or not. The pokeMultiStateUI function is for the commands which can have</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+ * multiple values for example &quot;cmd_fontFace&quot; can have different values like</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+ * arial, variable width etc.</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+ *</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+ * Here, some of the commands are getting executed by document.execCommand.</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+ * Those are listed in the gCommandMap Map object. In that also, some commands</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+ * are of type boolean and some are of multiple state. We have two functions to</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+ * execute them: doStatefulCommand and doStyleUICommand.</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+ *</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+ * All commands are not executable through document.execCommand.</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+ * In all those cases, we will use goDoCommand or goDoCommandParams.</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+ * The goDoCommandParams function is implemented in this file.</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+ * The goDoCOmmand function is from globalOverlay.js. For the Commands</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+ * which can be executed by document.execCommand, we will use doStatefulCommand</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+ * and doStyleUICommand.</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+ */</span>
<a href="#l1.34"></a><span id="l1.34"> </span>
<a href="#l1.35"></a><span id="l1.35"> // Linting is disabled in chunks of this file because it contains code that never</span>
<a href="#l1.36"></a><span id="l1.36"> // runs in Thunderbird, and references things that don't exist in Thunderbird.</span>
<a href="#l1.37"></a><span id="l1.37"> </span>
<a href="#l1.38"></a><span id="l1.38"> /* import-globals-from editor.js */</span>
<a href="#l1.39"></a><span id="l1.39"> /* import-globals-from editorUtilities.js */</span>
<a href="#l1.40"></a><span id="l1.40"> /* globals CreatePublishDataFromUrl editPage FormatDirForPublishing getTopWin</span>
<a href="#l1.41"></a><span id="l1.41">    goPreferences nsIPromptService openComposeWindow openNewPrivateWith</span>
<a href="#l1.42"></a><span id="l1.42">    PrintPreviewListener SavePublishDataToPrefs SavePassword savePWObj */</span>
<a href="#l1.43"></a><span id="l1.43"> </span>
<a href="#l1.44"></a><span id="l1.44"> var gComposerJSCommandControllerID = 0;</span>
<a href="#l1.45"></a><span id="l1.45"> </span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+/**</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+ * Used to register commands we have created manually.</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+ */</span>
<a href="#l1.49"></a><span id="l1.49"> function SetupHTMLEditorCommands() {</span>
<a href="#l1.50"></a><span id="l1.50">   var commandTable = GetComposerCommandTable();</span>
<a href="#l1.51"></a><span id="l1.51">   if (!commandTable) {</span>
<a href="#l1.52"></a><span id="l1.52">     return;</span>
<a href="#l1.53"></a><span id="l1.53">   }</span>
<a href="#l1.54"></a><span id="l1.54"> </span>
<a href="#l1.55"></a><span id="l1.55">   // Include everything a text editor does</span>
<a href="#l1.56"></a><span id="l1.56">   SetupTextEditorCommands();</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineat">@@ -49,17 +75,16 @@ function SetupHTMLEditorCommands() {</span>
<a href="#l1.58"></a><span id="l1.58">   commandTable.registerCommand(</span>
<a href="#l1.59"></a><span id="l1.59">     &quot;cmd_insertHTMLWithDialog&quot;,</span>
<a href="#l1.60"></a><span id="l1.60">     nsInsertHTMLWithDialogCommand</span>
<a href="#l1.61"></a><span id="l1.61">   );</span>
<a href="#l1.62"></a><span id="l1.62">   commandTable.registerCommand(</span>
<a href="#l1.63"></a><span id="l1.63">     &quot;cmd_insertMathWithDialog&quot;,</span>
<a href="#l1.64"></a><span id="l1.64">     nsInsertMathWithDialogCommand</span>
<a href="#l1.65"></a><span id="l1.65">   );</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_insertBreak&quot;, nsInsertBreakCommand);</span>
<a href="#l1.67"></a><span id="l1.67">   commandTable.registerCommand(&quot;cmd_insertBreakAll&quot;, nsInsertBreakAllCommand);</span>
<a href="#l1.68"></a><span id="l1.68"> </span>
<a href="#l1.69"></a><span id="l1.69">   commandTable.registerCommand(&quot;cmd_table&quot;, nsInsertOrEditTableCommand);</span>
<a href="#l1.70"></a><span id="l1.70">   commandTable.registerCommand(&quot;cmd_editTable&quot;, nsEditTableCommand);</span>
<a href="#l1.71"></a><span id="l1.71">   commandTable.registerCommand(&quot;cmd_SelectTable&quot;, nsSelectTableCommand);</span>
<a href="#l1.72"></a><span id="l1.72">   commandTable.registerCommand(&quot;cmd_SelectRow&quot;, nsSelectTableRowCommand);</span>
<a href="#l1.73"></a><span id="l1.73">   commandTable.registerCommand(&quot;cmd_SelectColumn&quot;, nsSelectTableColumnCommand);</span>
<a href="#l1.74"></a><span id="l1.74">   commandTable.registerCommand(&quot;cmd_SelectCell&quot;, nsSelectTableCellCommand);</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineat">@@ -121,79 +146,22 @@ function SetupTextEditorCommands() {</span>
<a href="#l1.76"></a><span id="l1.76">   commandTable.registerCommand(&quot;cmd_find&quot;, nsFindCommand);</span>
<a href="#l1.77"></a><span id="l1.77">   commandTable.registerCommand(&quot;cmd_findNext&quot;, nsFindAgainCommand);</span>
<a href="#l1.78"></a><span id="l1.78">   commandTable.registerCommand(&quot;cmd_findPrev&quot;, nsFindAgainCommand);</span>
<a href="#l1.79"></a><span id="l1.79">   commandTable.registerCommand(&quot;cmd_rewrap&quot;, nsRewrapCommand);</span>
<a href="#l1.80"></a><span id="l1.80">   commandTable.registerCommand(&quot;cmd_spelling&quot;, nsSpellingCommand);</span>
<a href="#l1.81"></a><span id="l1.81">   commandTable.registerCommand(&quot;cmd_insertChars&quot;, nsInsertCharsCommand);</span>
<a href="#l1.82"></a><span id="l1.82"> }</span>
<a href="#l1.83"></a><span id="l1.83"> </span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">-function SetupComposerWindowCommands() {</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineminus">-  // Don't need to do this if already done</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-  if (gComposerWindowControllerID) {</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineminus">-    return;</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-  }</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineminus">-</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineminus">-  // Create a command controller and register commands</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineminus">-  //   specific to Web Composer window (file-related commands, HTML Source...)</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineminus">-  //   We can't use the composer controller created on the content window else</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineminus">-  //     we can't process commands when in HTMLSource editor</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineminus">-</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineminus">-  var windowControllers = window.controllers;</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineminus">-</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineminus">-  if (!windowControllers) {</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineminus">-    return;</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineminus">-  }</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineminus">-</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">-  var commandTable;</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineminus">-  var composerController;</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineminus">-  var editorController;</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineminus">-  try {</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineminus">-    composerController = Cc[</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineminus">-      &quot;@mozilla.org/embedcomp/base-command-controller;1&quot;</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineminus">-    ].createInstance();</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineminus">-</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineminus">-    editorController = composerController.QueryInterface(</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineminus">-      Ci.nsIControllerContext</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineminus">-    );</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineminus">-</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineminus">-    // Get the nsIControllerCommandTable interface we need to register commands</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineminus">-    var interfaceRequestor = composerController.QueryInterface(</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineminus">-      Ci.nsIInterfaceRequestor</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineminus">-    );</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineminus">-    commandTable = interfaceRequestor.getInterface(</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineminus">-      Ci.nsIControllerCommandTable</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineminus">-    );</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineminus">-  } catch (e) {</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineminus">-    dump(&quot;Failed to create composerController\n&quot;);</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineminus">-    return;</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineminus">-  }</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineminus">-</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineminus">-  if (!commandTable) {</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineminus">-    dump(&quot;Failed to get interface for nsIControllerCommandManager\n&quot;);</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineminus">-    return;</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineminus">-  }</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineminus">-</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineminus">-  // File-related commands</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_open&quot;, nsOpenCommand);</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_save&quot;, nsSaveCommand);</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_saveAs&quot;, nsSaveAsCommand);</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_print&quot;, nsPrintCommand);</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_printpreview&quot;, nsPrintPreviewCommand);</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_printSetup&quot;, nsPrintSetupCommand);</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_close&quot;, nsCloseCommand);</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineminus">-  windowControllers.insertControllerAt(0, editorController);</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineminus">-</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineminus">-  // Store the controller ID so we can be sure to get the right one later</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineminus">-  gComposerWindowControllerID = windowControllers.getControllerId(</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineminus">-    editorController</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineminus">-  );</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineminus">-}</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineminus">-</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+/**</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+ * Used to register the command controller in the editor document.</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+ *</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+ * @returns {nsIControllerCommandTable|null} - A controller used to</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineplus">+ *   register the manually created commands.</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineplus">+ */</span>
<a href="#l1.153"></a><span id="l1.153"> function GetComposerCommandTable() {</span>
<a href="#l1.154"></a><span id="l1.154">   var controller;</span>
<a href="#l1.155"></a><span id="l1.155">   if (gComposerJSCommandControllerID) {</span>
<a href="#l1.156"></a><span id="l1.156">     try {</span>
<a href="#l1.157"></a><span id="l1.157">       controller = window.content.controllers.getControllerById(</span>
<a href="#l1.158"></a><span id="l1.158">         gComposerJSCommandControllerID</span>
<a href="#l1.159"></a><span id="l1.159">       );</span>
<a href="#l1.160"></a><span id="l1.160">     } catch (e) {}</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineat">@@ -219,16 +187,23 @@ function GetComposerCommandTable() {</span>
<a href="#l1.162"></a><span id="l1.162">       Ci.nsIInterfaceRequestor</span>
<a href="#l1.163"></a><span id="l1.163">     );</span>
<a href="#l1.164"></a><span id="l1.164">     return interfaceRequestor.getInterface(Ci.nsIControllerCommandTable);</span>
<a href="#l1.165"></a><span id="l1.165">   }</span>
<a href="#l1.166"></a><span id="l1.166">   return null;</span>
<a href="#l1.167"></a><span id="l1.167"> }</span>
<a href="#l1.168"></a><span id="l1.168"> </span>
<a href="#l1.169"></a><span id="l1.169"> /* eslint-disable complexity */</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineplus">+</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineplus">+/**</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineplus">+ * Get the state of the given command and call the pokeStyleUI or pokeMultiStateUI</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineplus">+ * according to the type of the command to reflect the UI changes in the editor.</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineplus">+ *</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineplus">+ * @param {string} command - The id of the command.</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineplus">+ */</span>
<a href="#l1.177"></a><span id="l1.177"> function goUpdateCommandState(command) {</span>
<a href="#l1.178"></a><span id="l1.178">   try {</span>
<a href="#l1.179"></a><span id="l1.179">     var controller = top.document.commandDispatcher.getControllerForCommand(</span>
<a href="#l1.180"></a><span id="l1.180">       command</span>
<a href="#l1.181"></a><span id="l1.181">     );</span>
<a href="#l1.182"></a><span id="l1.182">     if (!(controller instanceof Ci.nsICommandController)) {</span>
<a href="#l1.183"></a><span id="l1.183">       return;</span>
<a href="#l1.184"></a><span id="l1.184">     }</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineat">@@ -285,61 +260,78 @@ function goUpdateCommandState(command) {</span>
<a href="#l1.186"></a><span id="l1.186">         dump(&quot;no update for command: &quot; + command + &quot;\n&quot;);</span>
<a href="#l1.187"></a><span id="l1.187">     }</span>
<a href="#l1.188"></a><span id="l1.188">   } catch (e) {</span>
<a href="#l1.189"></a><span id="l1.189">     Cu.reportError(e);</span>
<a href="#l1.190"></a><span id="l1.190">   }</span>
<a href="#l1.191"></a><span id="l1.191"> }</span>
<a href="#l1.192"></a><span id="l1.192"> /* eslint-enable complexity */</span>
<a href="#l1.193"></a><span id="l1.193"> </span>
<a href="#l1.194"></a><span id="l1.194" class="difflineplus">+/**</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineplus">+ * Used in the oncommandupdate attribute of the goUpdateComposerMenuItems.</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineplus">+ * For any commandset events fired, this function will be called.</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineplus">+ * Used to update the UI state of the editor buttons and menulist.</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineplus">+ * Whenever you change your selection in the editor part, i.e. if you move</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineplus">+ * your cursor, you will find this functions getting called and</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineplus">+ * updating the editor UI of toolbarbuttons and menulists. This is mainly</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineplus">+ * to update the UI according to your selection in the editor part.</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineplus">+ *</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineplus">+ * @param {XULElement} commandset - The &lt;xul:commandset&gt; element to update for.</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineplus">+ */</span>
<a href="#l1.205"></a><span id="l1.205"> function goUpdateComposerMenuItems(commandset) {</span>
<a href="#l1.206"></a><span id="l1.206">   // dump(&quot;Updating commands for &quot; + commandset.id + &quot;\n&quot;);</span>
<a href="#l1.207"></a><span id="l1.207">   for (var i = 0; i &lt; commandset.children.length; i++) {</span>
<a href="#l1.208"></a><span id="l1.208">     var commandNode = commandset.children[i];</span>
<a href="#l1.209"></a><span id="l1.209">     var commandID = commandNode.id;</span>
<a href="#l1.210"></a><span id="l1.210">     if (commandID) {</span>
<a href="#l1.211"></a><span id="l1.211">       goUpdateCommand(commandID); // enable or disable</span>
<a href="#l1.212"></a><span id="l1.212">       if (commandNode.hasAttribute(&quot;state&quot;)) {</span>
<a href="#l1.213"></a><span id="l1.213">         goUpdateCommandState(commandID);</span>
<a href="#l1.214"></a><span id="l1.214">       }</span>
<a href="#l1.215"></a><span id="l1.215">     }</span>
<a href="#l1.216"></a><span id="l1.216">   }</span>
<a href="#l1.217"></a><span id="l1.217"> }</span>
<a href="#l1.218"></a><span id="l1.218"> </span>
<a href="#l1.219"></a><span id="l1.219" class="difflineminus">-function goDoCommandParams(command, params) {</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineplus">+/**</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineplus">+ * Execute the command with the provided parameters.</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineplus">+ * This is directly calling commands with multiple state attributes, which</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineplus">+ * are not supported by document.execCommand()</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineplus">+ *</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineplus">+ * @param {string} command - The command ID.</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineplus">+ * @param {string} paramValue - The parameter value.</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineplus">+ */</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineplus">+function goDoCommandParams(command, paramValue) {</span>
<a href="#l1.229"></a><span id="l1.229">   try {</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineminus">-    var controller = top.document.commandDispatcher.getControllerForCommand(</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineplus">+    let params = newCommandParams();</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineplus">+    params.setStringValue(&quot;state_attribute&quot;, paramValue);</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineplus">+    let controller = top.document.commandDispatcher.getControllerForCommand(</span>
<a href="#l1.234"></a><span id="l1.234">       command</span>
<a href="#l1.235"></a><span id="l1.235">     );</span>
<a href="#l1.236"></a><span id="l1.236">     if (controller &amp;&amp; controller.isCommandEnabled(command)) {</span>
<a href="#l1.237"></a><span id="l1.237">       if (controller instanceof Ci.nsICommandController) {</span>
<a href="#l1.238"></a><span id="l1.238">         controller.doCommandWithParams(command, params);</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineminus">-</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineminus">-        // the following two lines should be removed when we implement observers</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineminus">-        if (params) {</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineminus">-          controller.getCommandStateWithParams(command, params);</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineminus">-        }</span>
<a href="#l1.244"></a><span id="l1.244">       } else {</span>
<a href="#l1.245"></a><span id="l1.245">         controller.doCommand(command);</span>
<a href="#l1.246"></a><span id="l1.246">       }</span>
<a href="#l1.247"></a><span id="l1.247">     }</span>
<a href="#l1.248"></a><span id="l1.248">   } catch (e) {</span>
<a href="#l1.249"></a><span id="l1.249">     Cu.reportError(e);</span>
<a href="#l1.250"></a><span id="l1.250">   }</span>
<a href="#l1.251"></a><span id="l1.251"> }</span>
<a href="#l1.252"></a><span id="l1.252"> </span>
<a href="#l1.253"></a><span id="l1.253"> /**</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineminus">- * Update the UI to reflect setting a given state for a command.</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineplus">+ * Update the UI to reflect setting a given state for a command. This</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineplus">+ * is used for boolean type of commands.</span>
<a href="#l1.257"></a><span id="l1.257">  *</span>
<a href="#l1.258"></a><span id="l1.258">  * @param {string} uiID - The id of the command.</span>
<a href="#l1.259"></a><span id="l1.259">  * @param {boolean} desiredState - State to set for the command.</span>
<a href="#l1.260"></a><span id="l1.260">  */</span>
<a href="#l1.261"></a><span id="l1.261"> function pokeStyleUI(uiID, desiredState) {</span>
<a href="#l1.262"></a><span id="l1.262">   let commandNode = top.document.getElementById(uiID);</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineminus">-  let uiState = &quot;true&quot; == commandNode.getAttribute(&quot;state&quot;);</span>
<a href="#l1.264"></a><span id="l1.264" class="difflineplus">+  let uiState = commandNode.getAttribute(&quot;state&quot;) == &quot;true&quot;;</span>
<a href="#l1.265"></a><span id="l1.265">   if (desiredState != uiState) {</span>
<a href="#l1.266"></a><span id="l1.266">     commandNode.setAttribute(&quot;state&quot;, desiredState ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l1.267"></a><span id="l1.267">     switch (uiID) {</span>
<a href="#l1.268"></a><span id="l1.268">       case &quot;cmd_bold&quot;: {</span>
<a href="#l1.269"></a><span id="l1.269">         onButtonUpdate(document.getElementById(&quot;boldButton&quot;), &quot;cmd_bold&quot;);</span>
<a href="#l1.270"></a><span id="l1.270">         break;</span>
<a href="#l1.271"></a><span id="l1.271">       }</span>
<a href="#l1.272"></a><span id="l1.272">       case &quot;cmd_italic&quot;: {</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineat">@@ -360,38 +352,65 @@ function pokeStyleUI(uiID, desiredState)</span>
<a href="#l1.274"></a><span id="l1.274">       case &quot;cmd_ol&quot;: {</span>
<a href="#l1.275"></a><span id="l1.275">         onButtonUpdate(document.getElementById(&quot;olButton&quot;), &quot;cmd_ol&quot;);</span>
<a href="#l1.276"></a><span id="l1.276">         break;</span>
<a href="#l1.277"></a><span id="l1.277">       }</span>
<a href="#l1.278"></a><span id="l1.278">     }</span>
<a href="#l1.279"></a><span id="l1.279">   }</span>
<a href="#l1.280"></a><span id="l1.280"> }</span>
<a href="#l1.281"></a><span id="l1.281"> </span>
<a href="#l1.282"></a><span id="l1.282" class="difflineplus">+/**</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineplus">+ * Maps internal command names to their document.execCommand() command string.</span>
<a href="#l1.284"></a><span id="l1.284" class="difflineplus">+ */</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineplus">+let gCommandMap = new Map([</span>
<a href="#l1.286"></a><span id="l1.286" class="difflineplus">+  [&quot;cmd_bold&quot;, &quot;bold&quot;],</span>
<a href="#l1.287"></a><span id="l1.287" class="difflineplus">+  [&quot;cmd_italic&quot;, &quot;italic&quot;],</span>
<a href="#l1.288"></a><span id="l1.288" class="difflineplus">+  [&quot;cmd_underline&quot;, &quot;underline&quot;],</span>
<a href="#l1.289"></a><span id="l1.289" class="difflineplus">+  [&quot;cmd_strikethrough&quot;, &quot;strikethrough&quot;],</span>
<a href="#l1.290"></a><span id="l1.290" class="difflineplus">+  [&quot;cmd_superscript&quot;, &quot;superscript&quot;],</span>
<a href="#l1.291"></a><span id="l1.291" class="difflineplus">+  [&quot;cmd_subscript&quot;, &quot;subscript&quot;],</span>
<a href="#l1.292"></a><span id="l1.292" class="difflineplus">+  [&quot;cmd_ul&quot;, &quot;InsertUnorderedList&quot;],</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineplus">+  [&quot;cmd_ol&quot;, &quot;InsertOrderedList&quot;],</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineplus">+  [&quot;cmd_fontFace&quot;, &quot;fontName&quot;],</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineplus">+  // [&quot;cmd_paragraphState&quot;, &quot;formatBlock&quot;],</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineplus">+</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineplus">+  // This are currently implemented with the help of</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineplus">+  // color selection dialog box in the editor.js.</span>
<a href="#l1.299"></a><span id="l1.299" class="difflineplus">+  // [&quot;cmd_highlight&quot;, &quot;backColor&quot;],</span>
<a href="#l1.300"></a><span id="l1.300" class="difflineplus">+  // [&quot;cmd_fontColor&quot;, &quot;foreColor&quot;],</span>
<a href="#l1.301"></a><span id="l1.301" class="difflineplus">+]);</span>
<a href="#l1.302"></a><span id="l1.302" class="difflineplus">+</span>
<a href="#l1.303"></a><span id="l1.303" class="difflineplus">+/**</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineplus">+ * Used for the boolean type commands available through</span>
<a href="#l1.305"></a><span id="l1.305" class="difflineplus">+ * document.execCommand(). We will also call pokeStyleUI to update</span>
<a href="#l1.306"></a><span id="l1.306" class="difflineplus">+ * the UI.</span>
<a href="#l1.307"></a><span id="l1.307" class="difflineplus">+ *</span>
<a href="#l1.308"></a><span id="l1.308" class="difflineplus">+ * @param {string} cmdStr - The id of the command.</span>
<a href="#l1.309"></a><span id="l1.309" class="difflineplus">+ */</span>
<a href="#l1.310"></a><span id="l1.310"> function doStyleUICommand(cmdStr) {</span>
<a href="#l1.311"></a><span id="l1.311" class="difflineminus">-  try {</span>
<a href="#l1.312"></a><span id="l1.312" class="difflineminus">-    var cmdParams = newCommandParams();</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineminus">-    goDoCommandParams(cmdStr, cmdParams);</span>
<a href="#l1.314"></a><span id="l1.314" class="difflineminus">-    if (cmdParams) {</span>
<a href="#l1.315"></a><span id="l1.315" class="difflineminus">-      pokeStyleUI(cmdStr, cmdParams.getBooleanValue(&quot;state_all&quot;));</span>
<a href="#l1.316"></a><span id="l1.316" class="difflineminus">-    }</span>
<a href="#l1.317"></a><span id="l1.317" class="difflineminus">-  } catch (e) {}</span>
<a href="#l1.318"></a><span id="l1.318" class="difflineplus">+  top.document</span>
<a href="#l1.319"></a><span id="l1.319" class="difflineplus">+    .querySelector(&quot;editor&quot;)</span>
<a href="#l1.320"></a><span id="l1.320" class="difflineplus">+    .contentDocument.execCommand(gCommandMap.get(cmdStr), false, null);</span>
<a href="#l1.321"></a><span id="l1.321" class="difflineplus">+  let commandNode = top.document.getElementById(cmdStr);</span>
<a href="#l1.322"></a><span id="l1.322" class="difflineplus">+  let newState = commandNode.getAttribute(&quot;state&quot;) != &quot;true&quot;;</span>
<a href="#l1.323"></a><span id="l1.323" class="difflineplus">+  pokeStyleUI(cmdStr, newState);</span>
<a href="#l1.324"></a><span id="l1.324"> }</span>
<a href="#l1.325"></a><span id="l1.325"> </span>
<a href="#l1.326"></a><span id="l1.326"> // Copied from jsmime.js.</span>
<a href="#l1.327"></a><span id="l1.327"> function stringToTypedArray(buffer) {</span>
<a href="#l1.328"></a><span id="l1.328">   var typedarray = new Uint8Array(buffer.length);</span>
<a href="#l1.329"></a><span id="l1.329">   for (var i = 0; i &lt; buffer.length; i++) {</span>
<a href="#l1.330"></a><span id="l1.330">     typedarray[i] = buffer.charCodeAt(i);</span>
<a href="#l1.331"></a><span id="l1.331">   }</span>
<a href="#l1.332"></a><span id="l1.332">   return typedarray;</span>
<a href="#l1.333"></a><span id="l1.333"> }</span>
<a href="#l1.334"></a><span id="l1.334"> </span>
<a href="#l1.335"></a><span id="l1.335"> /**</span>
<a href="#l1.336"></a><span id="l1.336">  * Update the UI to reflect setting a given state for a command. This is used</span>
<a href="#l1.337"></a><span id="l1.337" class="difflineminus">- * when the command state has a string value.</span>
<a href="#l1.338"></a><span id="l1.338" class="difflineplus">+ * when the command state has a string value i.e. multiple state type commands.</span>
<a href="#l1.339"></a><span id="l1.339">  *</span>
<a href="#l1.340"></a><span id="l1.340">  * @param {string} uiID - The id of the command.</span>
<a href="#l1.341"></a><span id="l1.341">  * @param {nsICommandParams} cmdParams - Command parameters object.</span>
<a href="#l1.342"></a><span id="l1.342">  */</span>
<a href="#l1.343"></a><span id="l1.343"> function pokeMultiStateUI(uiID, cmdParams) {</span>
<a href="#l1.344"></a><span id="l1.344">   let isMixed = cmdParams.getBooleanValue(&quot;state_mixed&quot;);</span>
<a href="#l1.345"></a><span id="l1.345">   let desiredAttrib;</span>
<a href="#l1.346"></a><span id="l1.346">   if (isMixed) {</span>
<a href="#l1.347"></a><span id="l1.347" class="difflineat">@@ -410,56 +429,84 @@ function pokeMultiStateUI(uiID, cmdParam</span>
<a href="#l1.348"></a><span id="l1.348">   }</span>
<a href="#l1.349"></a><span id="l1.349"> </span>
<a href="#l1.350"></a><span id="l1.350">   let commandNode = document.getElementById(uiID);</span>
<a href="#l1.351"></a><span id="l1.351">   let uiState = commandNode.getAttribute(&quot;state&quot;);</span>
<a href="#l1.352"></a><span id="l1.352">   if (desiredAttrib != uiState) {</span>
<a href="#l1.353"></a><span id="l1.353">     commandNode.setAttribute(&quot;state&quot;, desiredAttrib);</span>
<a href="#l1.354"></a><span id="l1.354">     switch (uiID) {</span>
<a href="#l1.355"></a><span id="l1.355">       case &quot;cmd_paragraphState&quot;: {</span>
<a href="#l1.356"></a><span id="l1.356" class="difflineminus">-        let menulist = document.getElementById(&quot;ParagraphSelect&quot;);</span>
<a href="#l1.357"></a><span id="l1.357" class="difflineminus">-        onParagraphFormatChange(menulist, &quot;cmd_paragraphState&quot;);</span>
<a href="#l1.358"></a><span id="l1.358" class="difflineplus">+        onParagraphFormatChange();</span>
<a href="#l1.359"></a><span id="l1.359">         break;</span>
<a href="#l1.360"></a><span id="l1.360">       }</span>
<a href="#l1.361"></a><span id="l1.361">       case &quot;cmd_fontFace&quot;: {</span>
<a href="#l1.362"></a><span id="l1.362" class="difflineminus">-        let menulist = document.getElementById(&quot;FontFaceSelect&quot;);</span>
<a href="#l1.363"></a><span id="l1.363" class="difflineminus">-        onFontFaceChange(menulist, &quot;cmd_fontFace&quot;);</span>
<a href="#l1.364"></a><span id="l1.364" class="difflineplus">+        onFontFaceChange();</span>
<a href="#l1.365"></a><span id="l1.365">         break;</span>
<a href="#l1.366"></a><span id="l1.366">       }</span>
<a href="#l1.367"></a><span id="l1.367">       case &quot;cmd_fontColor&quot;: {</span>
<a href="#l1.368"></a><span id="l1.368">         onFontColorChange();</span>
<a href="#l1.369"></a><span id="l1.369">         break;</span>
<a href="#l1.370"></a><span id="l1.370">       }</span>
<a href="#l1.371"></a><span id="l1.371">       case &quot;cmd_backgroundColor&quot;: {</span>
<a href="#l1.372"></a><span id="l1.372">         onBackgroundColorChange();</span>
<a href="#l1.373"></a><span id="l1.373">         break;</span>
<a href="#l1.374"></a><span id="l1.374">       }</span>
<a href="#l1.375"></a><span id="l1.375">     }</span>
<a href="#l1.376"></a><span id="l1.376">   }</span>
<a href="#l1.377"></a><span id="l1.377"> }</span>
<a href="#l1.378"></a><span id="l1.378"> </span>
<a href="#l1.379"></a><span id="l1.379" class="difflineminus">-function doStatefulCommand(commandID, newState) {</span>
<a href="#l1.380"></a><span id="l1.380" class="difflineminus">-  var commandNode = document.getElementById(commandID);</span>
<a href="#l1.381"></a><span id="l1.381" class="difflineminus">-  if (commandNode) {</span>
<a href="#l1.382"></a><span id="l1.382" class="difflineminus">-    commandNode.setAttribute(&quot;state&quot;, newState);</span>
<a href="#l1.383"></a><span id="l1.383" class="difflineplus">+/**</span>
<a href="#l1.384"></a><span id="l1.384" class="difflineplus">+ * Perform the action of the multiple states type commands available through</span>
<a href="#l1.385"></a><span id="l1.385" class="difflineplus">+ * document.execCommand().</span>
<a href="#l1.386"></a><span id="l1.386" class="difflineplus">+ *</span>
<a href="#l1.387"></a><span id="l1.387" class="difflineplus">+ * @param {string} commandID - The id of the command.</span>
<a href="#l1.388"></a><span id="l1.388" class="difflineplus">+ * @param {string} newState - The parameter value.</span>
<a href="#l1.389"></a><span id="l1.389" class="difflineplus">+ * @param {boolean} updateUI - updates the UI if true. Used when</span>
<a href="#l1.390"></a><span id="l1.390" class="difflineplus">+ *   function is called in another JavaScript function.</span>
<a href="#l1.391"></a><span id="l1.391" class="difflineplus">+ */</span>
<a href="#l1.392"></a><span id="l1.392" class="difflineplus">+function doStatefulCommand(commandID, newState, updateUI) {</span>
<a href="#l1.393"></a><span id="l1.393" class="difflineplus">+  if (commandID == &quot;cmd_align&quot;) {</span>
<a href="#l1.394"></a><span id="l1.394" class="difflineplus">+    let command;</span>
<a href="#l1.395"></a><span id="l1.395" class="difflineplus">+    switch (newState) {</span>
<a href="#l1.396"></a><span id="l1.396" class="difflineplus">+      case &quot;left&quot;:</span>
<a href="#l1.397"></a><span id="l1.397" class="difflineplus">+        command = &quot;justifyLeft&quot;;</span>
<a href="#l1.398"></a><span id="l1.398" class="difflineplus">+        break;</span>
<a href="#l1.399"></a><span id="l1.399" class="difflineplus">+      case &quot;center&quot;:</span>
<a href="#l1.400"></a><span id="l1.400" class="difflineplus">+        command = &quot;justifyCenter&quot;;</span>
<a href="#l1.401"></a><span id="l1.401" class="difflineplus">+        break;</span>
<a href="#l1.402"></a><span id="l1.402" class="difflineplus">+      case &quot;right&quot;:</span>
<a href="#l1.403"></a><span id="l1.403" class="difflineplus">+        command = &quot;justifyRight&quot;;</span>
<a href="#l1.404"></a><span id="l1.404" class="difflineplus">+        break;</span>
<a href="#l1.405"></a><span id="l1.405" class="difflineplus">+      case &quot;justify&quot;:</span>
<a href="#l1.406"></a><span id="l1.406" class="difflineplus">+        command = &quot;justifyFull&quot;;</span>
<a href="#l1.407"></a><span id="l1.407" class="difflineplus">+        break;</span>
<a href="#l1.408"></a><span id="l1.408" class="difflineplus">+    }</span>
<a href="#l1.409"></a><span id="l1.409" class="difflineplus">+    top.document</span>
<a href="#l1.410"></a><span id="l1.410" class="difflineplus">+      .querySelector(&quot;editor&quot;)</span>
<a href="#l1.411"></a><span id="l1.411" class="difflineplus">+      .contentDocument.execCommand(command, false, null);</span>
<a href="#l1.412"></a><span id="l1.412" class="difflineplus">+  } else {</span>
<a href="#l1.413"></a><span id="l1.413" class="difflineplus">+    top.document</span>
<a href="#l1.414"></a><span id="l1.414" class="difflineplus">+      .querySelector(&quot;editor&quot;)</span>
<a href="#l1.415"></a><span id="l1.415" class="difflineplus">+      .contentDocument.execCommand(gCommandMap.get(commandID), false, newState);</span>
<a href="#l1.416"></a><span id="l1.416">   }</span>
<a href="#l1.417"></a><span id="l1.417" class="difflineminus">-  gContentWindow.focus(); // needed for command dispatch to work</span>
<a href="#l1.418"></a><span id="l1.418" class="difflineminus">-</span>
<a href="#l1.419"></a><span id="l1.419" class="difflineminus">-  try {</span>
<a href="#l1.420"></a><span id="l1.420" class="difflineminus">-    var cmdParams = newCommandParams();</span>
<a href="#l1.421"></a><span id="l1.421" class="difflineminus">-    if (!cmdParams) {</span>
<a href="#l1.422"></a><span id="l1.422" class="difflineminus">-      return;</span>
<a href="#l1.423"></a><span id="l1.423" class="difflineplus">+</span>
<a href="#l1.424"></a><span id="l1.424" class="difflineplus">+  if (updateUI) {</span>
<a href="#l1.425"></a><span id="l1.425" class="difflineplus">+    let commandNode = document.getElementById(commandID);</span>
<a href="#l1.426"></a><span id="l1.426" class="difflineplus">+    commandNode.setAttribute(&quot;state&quot;, newState);</span>
<a href="#l1.427"></a><span id="l1.427" class="difflineplus">+    switch (commandID) {</span>
<a href="#l1.428"></a><span id="l1.428" class="difflineplus">+      case &quot;cmd_fontFace&quot;: {</span>
<a href="#l1.429"></a><span id="l1.429" class="difflineplus">+        onFontFaceChange();</span>
<a href="#l1.430"></a><span id="l1.430" class="difflineplus">+        break;</span>
<a href="#l1.431"></a><span id="l1.431" class="difflineplus">+      }</span>
<a href="#l1.432"></a><span id="l1.432">     }</span>
<a href="#l1.433"></a><span id="l1.433" class="difflineminus">-</span>
<a href="#l1.434"></a><span id="l1.434" class="difflineminus">-    cmdParams.setStringValue(&quot;state_attribute&quot;, newState);</span>
<a href="#l1.435"></a><span id="l1.435" class="difflineminus">-    goDoCommandParams(commandID, cmdParams);</span>
<a href="#l1.436"></a><span id="l1.436" class="difflineminus">-</span>
<a href="#l1.437"></a><span id="l1.437" class="difflineminus">-    pokeMultiStateUI(commandID, cmdParams);</span>
<a href="#l1.438"></a><span id="l1.438" class="difflineminus">-  } catch (e) {</span>
<a href="#l1.439"></a><span id="l1.439" class="difflineminus">-    dump(&quot;error thrown in doStatefulCommand: &quot; + e + &quot;\n&quot;);</span>
<a href="#l1.440"></a><span id="l1.440" class="difflineplus">+  } else {</span>
<a href="#l1.441"></a><span id="l1.441" class="difflineplus">+    let commandNode = document.getElementById(commandID);</span>
<a href="#l1.442"></a><span id="l1.442" class="difflineplus">+    if (commandNode) {</span>
<a href="#l1.443"></a><span id="l1.443" class="difflineplus">+      commandNode.setAttribute(&quot;state&quot;, newState);</span>
<a href="#l1.444"></a><span id="l1.444" class="difflineplus">+    }</span>
<a href="#l1.445"></a><span id="l1.445">   }</span>
<a href="#l1.446"></a><span id="l1.446"> }</span>
<a href="#l1.447"></a><span id="l1.447"> </span>
<a href="#l1.448"></a><span id="l1.448"> function PrintObject(obj) {</span>
<a href="#l1.449"></a><span id="l1.449">   dump(&quot;-----&quot; + obj + &quot;------\n&quot;);</span>
<a href="#l1.450"></a><span id="l1.450">   var names = &quot;&quot;;</span>
<a href="#l1.451"></a><span id="l1.451">   for (var i in obj) {</span>
<a href="#l1.452"></a><span id="l1.452">     if (i == &quot;value&quot;) {</span>
<a href="#l1.453"></a><span id="l1.453" class="difflineat">@@ -2379,31 +2426,16 @@ var nsInsertCharsCommand = {</span>
<a href="#l1.454"></a><span id="l1.454">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.455"></a><span id="l1.455">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.456"></a><span id="l1.456"> </span>
<a href="#l1.457"></a><span id="l1.457">   doCommand(aCommand) {</span>
<a href="#l1.458"></a><span id="l1.458">     EditorFindOrCreateInsertCharWindow();</span>
<a href="#l1.459"></a><span id="l1.459">   },</span>
<a href="#l1.460"></a><span id="l1.460"> };</span>
<a href="#l1.461"></a><span id="l1.461"> </span>
<a href="#l1.462"></a><span id="l1.462" class="difflineminus">-var nsInsertBreakCommand = {</span>
<a href="#l1.463"></a><span id="l1.463" class="difflineminus">-  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.464"></a><span id="l1.464" class="difflineminus">-    return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l1.465"></a><span id="l1.465" class="difflineminus">-  },</span>
<a href="#l1.466"></a><span id="l1.466" class="difflineminus">-</span>
<a href="#l1.467"></a><span id="l1.467" class="difflineminus">-  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.468"></a><span id="l1.468" class="difflineminus">-  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.469"></a><span id="l1.469" class="difflineminus">-</span>
<a href="#l1.470"></a><span id="l1.470" class="difflineminus">-  doCommand(aCommand) {</span>
<a href="#l1.471"></a><span id="l1.471" class="difflineminus">-    try {</span>
<a href="#l1.472"></a><span id="l1.472" class="difflineminus">-      GetCurrentEditor().insertHTML(&quot;&lt;br&gt;&quot;);</span>
<a href="#l1.473"></a><span id="l1.473" class="difflineminus">-    } catch (e) {}</span>
<a href="#l1.474"></a><span id="l1.474" class="difflineminus">-  },</span>
<a href="#l1.475"></a><span id="l1.475" class="difflineminus">-};</span>
<a href="#l1.476"></a><span id="l1.476" class="difflineminus">-</span>
<a href="#l1.477"></a><span id="l1.477"> var nsInsertBreakAllCommand = {</span>
<a href="#l1.478"></a><span id="l1.478">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.479"></a><span id="l1.479">     return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l1.480"></a><span id="l1.480">   },</span>
<a href="#l1.481"></a><span id="l1.481"> </span>
<a href="#l1.482"></a><span id="l1.482">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.483"></a><span id="l1.483">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.484"></a><span id="l1.484"> </span>
<a href="#l1.485"></a><span id="l1.485" class="difflineat">@@ -2642,16 +2674,19 @@ var nsIncreaseFontCommand = {</span>
<a href="#l1.486"></a><span id="l1.486"> </span>
<a href="#l1.487"></a><span id="l1.487">   doCommand(aCommand) {</span>
<a href="#l1.488"></a><span id="l1.488">     var setIndex = getFontSizeIndex();</span>
<a href="#l1.489"></a><span id="l1.489">     if (setIndex &lt; 0 || setIndex &gt;= 5) {</span>
<a href="#l1.490"></a><span id="l1.490">       return;</span>
<a href="#l1.491"></a><span id="l1.491">     }</span>
<a href="#l1.492"></a><span id="l1.492">     var sizes = [&quot;x-small&quot;, &quot;small&quot;, &quot;medium&quot;, &quot;large&quot;, &quot;x-large&quot;, &quot;xx-large&quot;];</span>
<a href="#l1.493"></a><span id="l1.493">     EditorSetFontSize(sizes[setIndex + 1]);</span>
<a href="#l1.494"></a><span id="l1.494" class="difflineplus">+    // Enable or Disable the toolbar buttons according to the font size.</span>
<a href="#l1.495"></a><span id="l1.495" class="difflineplus">+    goUpdateCommand(&quot;cmd_decreaseFontStep&quot;);</span>
<a href="#l1.496"></a><span id="l1.496" class="difflineplus">+    goUpdateCommand(&quot;cmd_increaseFontStep&quot;);</span>
<a href="#l1.497"></a><span id="l1.497">   },</span>
<a href="#l1.498"></a><span id="l1.498"> };</span>
<a href="#l1.499"></a><span id="l1.499"> </span>
<a href="#l1.500"></a><span id="l1.500"> var nsDecreaseFontCommand = {</span>
<a href="#l1.501"></a><span id="l1.501">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.502"></a><span id="l1.502">     if (!(IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML())) {</span>
<a href="#l1.503"></a><span id="l1.503">       return false;</span>
<a href="#l1.504"></a><span id="l1.504">     }</span>
<a href="#l1.505"></a><span id="l1.505" class="difflineat">@@ -2664,16 +2699,19 @@ var nsDecreaseFontCommand = {</span>
<a href="#l1.506"></a><span id="l1.506"> </span>
<a href="#l1.507"></a><span id="l1.507">   doCommand(aCommand) {</span>
<a href="#l1.508"></a><span id="l1.508">     var setIndex = getFontSizeIndex();</span>
<a href="#l1.509"></a><span id="l1.509">     if (setIndex &lt;= 0) {</span>
<a href="#l1.510"></a><span id="l1.510">       return;</span>
<a href="#l1.511"></a><span id="l1.511">     }</span>
<a href="#l1.512"></a><span id="l1.512">     var sizes = [&quot;x-small&quot;, &quot;small&quot;, &quot;medium&quot;, &quot;large&quot;, &quot;x-large&quot;, &quot;xx-large&quot;];</span>
<a href="#l1.513"></a><span id="l1.513">     EditorSetFontSize(sizes[setIndex - 1]);</span>
<a href="#l1.514"></a><span id="l1.514" class="difflineplus">+    // Enable or Disable the toolbar buttons according to the font size.</span>
<a href="#l1.515"></a><span id="l1.515" class="difflineplus">+    goUpdateCommand(&quot;cmd_decreaseFontStep&quot;);</span>
<a href="#l1.516"></a><span id="l1.516" class="difflineplus">+    goUpdateCommand(&quot;cmd_increaseFontStep&quot;);</span>
<a href="#l1.517"></a><span id="l1.517">   },</span>
<a href="#l1.518"></a><span id="l1.518"> };</span>
<a href="#l1.519"></a><span id="l1.519"> </span>
<a href="#l1.520"></a><span id="l1.520"> var nsRemoveNamedAnchorsCommand = {</span>
<a href="#l1.521"></a><span id="l1.521">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.522"></a><span id="l1.522">     // We could see if there's any link in selection, but it doesn't seem worth the work!</span>
<a href="#l1.523"></a><span id="l1.523">     return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l1.524"></a><span id="l1.524">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -621,16 +621,17 @@ var stateListener = {</span>
<a href="#l2.4"></a><span id="l2.4">       document.getElementById(&quot;cmd_paragraphState&quot;).setAttribute(&quot;state&quot;, &quot;p&quot;);</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6">       editor.beginningOfDocument();</span>
<a href="#l2.7"></a><span id="l2.7">       editor.enableUndo(true);</span>
<a href="#l2.8"></a><span id="l2.8">       editor.resetModificationCount();</span>
<a href="#l2.9"></a><span id="l2.9">     } else {</span>
<a href="#l2.10"></a><span id="l2.10">       document.getElementById(&quot;cmd_paragraphState&quot;).setAttribute(&quot;state&quot;, &quot;&quot;);</span>
<a href="#l2.11"></a><span id="l2.11">     }</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+    onParagraphFormatChange();</span>
<a href="#l2.13"></a><span id="l2.13">   },</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15">   NotifyComposeBodyReadyReply() {</span>
<a href="#l2.16"></a><span id="l2.16">     // Control insertion of line breaks.</span>
<a href="#l2.17"></a><span id="l2.17">     let useParagraph = Services.prefs.getBoolPref(</span>
<a href="#l2.18"></a><span id="l2.18">       &quot;mail.compose.default_to_paragraph&quot;</span>
<a href="#l2.19"></a><span id="l2.19">     );</span>
<a href="#l2.20"></a><span id="l2.20">     if (gMsgCompose.composeHTML &amp;&amp; useParagraph) {</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineat">@@ -668,16 +669,17 @@ var stateListener = {</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23">       document.getElementById(&quot;cmd_paragraphState&quot;).setAttribute(&quot;state&quot;, &quot;p&quot;);</span>
<a href="#l2.24"></a><span id="l2.24"> </span>
<a href="#l2.25"></a><span id="l2.25">       editor.enableUndo(true);</span>
<a href="#l2.26"></a><span id="l2.26">       editor.resetModificationCount();</span>
<a href="#l2.27"></a><span id="l2.27">     } else {</span>
<a href="#l2.28"></a><span id="l2.28">       document.getElementById(&quot;cmd_paragraphState&quot;).setAttribute(&quot;state&quot;, &quot;&quot;);</span>
<a href="#l2.29"></a><span id="l2.29">     }</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+    onParagraphFormatChange();</span>
<a href="#l2.31"></a><span id="l2.31">   },</span>
<a href="#l2.32"></a><span id="l2.32"> </span>
<a href="#l2.33"></a><span id="l2.33">   NotifyComposeBodyReadyForwardInline() {</span>
<a href="#l2.34"></a><span id="l2.34">     let mailBody = getBrowser().contentDocument.querySelector(&quot;body&quot;);</span>
<a href="#l2.35"></a><span id="l2.35">     let editor = GetCurrentEditor();</span>
<a href="#l2.36"></a><span id="l2.36">     let selection = editor.selection;</span>
<a href="#l2.37"></a><span id="l2.37"> </span>
<a href="#l2.38"></a><span id="l2.38">     editor.enableUndo(false);</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineat">@@ -696,16 +698,17 @@ var stateListener = {</span>
<a href="#l2.40"></a><span id="l2.40">     } else {</span>
<a href="#l2.41"></a><span id="l2.41">       // insertLineBreak() has been observed to insert two &lt;br&gt; elements</span>
<a href="#l2.42"></a><span id="l2.42">       // instead of one before a &lt;div&gt;, so we'll do it ourselves here.</span>
<a href="#l2.43"></a><span id="l2.43">       let brElement = editor.createElementWithDefaults(&quot;br&quot;);</span>
<a href="#l2.44"></a><span id="l2.44">       editor.insertElementAtSelection(brElement, false);</span>
<a href="#l2.45"></a><span id="l2.45">       document.getElementById(&quot;cmd_paragraphState&quot;).setAttribute(&quot;state&quot;, &quot;&quot;);</span>
<a href="#l2.46"></a><span id="l2.46">     }</span>
<a href="#l2.47"></a><span id="l2.47"> </span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+    onParagraphFormatChange();</span>
<a href="#l2.49"></a><span id="l2.49">     editor.beginningOfDocument();</span>
<a href="#l2.50"></a><span id="l2.50">     editor.enableUndo(true);</span>
<a href="#l2.51"></a><span id="l2.51">     editor.resetModificationCount();</span>
<a href="#l2.52"></a><span id="l2.52">   },</span>
<a href="#l2.53"></a><span id="l2.53"> </span>
<a href="#l2.54"></a><span id="l2.54">   ComposeProcessDone(aResult) {</span>
<a href="#l2.55"></a><span id="l2.55">     ToggleWindowLock(false);</span>
<a href="#l2.56"></a><span id="l2.56"> </span>
<a href="#l2.57"></a><span id="l2.57" class="difflineat">@@ -8129,17 +8132,17 @@ function toggleAddressPicker(aFocus = tr</span>
<a href="#l2.58"></a><span id="l2.58">       SetMsgBodyFrameFocus();</span>
<a href="#l2.59"></a><span id="l2.59">     }</span>
<a href="#l2.60"></a><span id="l2.60">   }</span>
<a href="#l2.61"></a><span id="l2.61"> }</span>
<a href="#l2.62"></a><span id="l2.62"> </span>
<a href="#l2.63"></a><span id="l2.63"> function loadHTMLMsgPrefs() {</span>
<a href="#l2.64"></a><span id="l2.64">   let fontFace = Services.prefs.getStringPref(&quot;msgcompose.font_face&quot;, &quot;&quot;);</span>
<a href="#l2.65"></a><span id="l2.65">   if (fontFace) {</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-    doStatefulCommand(&quot;cmd_fontFace&quot;, fontFace);</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+    doStatefulCommand(&quot;cmd_fontFace&quot;, fontFace, true);</span>
<a href="#l2.68"></a><span id="l2.68">   }</span>
<a href="#l2.69"></a><span id="l2.69"> </span>
<a href="#l2.70"></a><span id="l2.70">   let fontSize = Services.prefs.getCharPref(&quot;msgcompose.font_size&quot;, &quot;&quot;);</span>
<a href="#l2.71"></a><span id="l2.71">   if (fontSize) {</span>
<a href="#l2.72"></a><span id="l2.72">     EditorSetFontSize(fontSize);</span>
<a href="#l2.73"></a><span id="l2.73">   }</span>
<a href="#l2.74"></a><span id="l2.74"> </span>
<a href="#l2.75"></a><span id="l2.75">   let bodyElement = GetBodyElement();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/compose/content/editFormatButtons.inc.xhtml</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/compose/content/editFormatButtons.inc.xhtml</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -2,17 +2,17 @@</span>
<a href="#l3.4"></a><span id="l3.4"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.5"></a><span id="l3.5"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7">         &lt;!-- Formatting toolbar items. &quot;value&quot; are HTML tagnames, don't translate --&gt;</span>
<a href="#l3.8"></a><span id="l3.8">         &lt;toolbaritem id=&quot;paragraph-select-container&quot;</span>
<a href="#l3.9"></a><span id="l3.9">                      class=&quot;formatting-button&quot;&gt;</span>
<a href="#l3.10"></a><span id="l3.10">           &lt;menulist id=&quot;ParagraphSelect&quot;</span>
<a href="#l3.11"></a><span id="l3.11">                     class=&quot;toolbar-focustarget&quot;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-                    oncommand=&quot;doStatefulCommand('cmd_paragraphState', event.target.value)&quot;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+                    oncommand=&quot;goDoCommandParams('cmd_paragraphState', event.target.value)&quot;</span>
<a href="#l3.14"></a><span id="l3.14">                     crop=&quot;right&quot;</span>
<a href="#l3.15"></a><span id="l3.15">                     tooltiptext=&quot;&amp;ParagraphSelect.tooltip;&quot;</span>
<a href="#l3.16"></a><span id="l3.16">                     observes=&quot;cmd_renderedHTMLEnabler&quot;&gt;</span>
<a href="#l3.17"></a><span id="l3.17">             &lt;menupopup id=&quot;ParagraphPopup&quot;&gt;</span>
<a href="#l3.18"></a><span id="l3.18">               &lt;menuitem id=&quot;toolbarmenu_bodyText&quot; label=&quot;&amp;bodyTextCmd.label;&quot; value=&quot;&quot;/&gt;</span>
<a href="#l3.19"></a><span id="l3.19">               &lt;menuitem id=&quot;toolbarmenu_paragraph&quot; label=&quot;&amp;paragraphParagraphCmd.label;&quot; value=&quot;p&quot;/&gt;</span>
<a href="#l3.20"></a><span id="l3.20">               &lt;menuitem id=&quot;toolbarmenu_h1&quot; label=&quot;&amp;heading1Cmd.label;&quot; value=&quot;h1&quot;/&gt;</span>
<a href="#l3.21"></a><span id="l3.21">               &lt;menuitem id=&quot;toolbarmenu_h2&quot; label=&quot;&amp;heading2Cmd.label;&quot; value=&quot;h2&quot;/&gt;</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -227,41 +227,41 @@</span>
<a href="#l3.23"></a><span id="l3.23">         &lt;toolbarbutton id=&quot;smileButtonMenu&quot;</span>
<a href="#l3.24"></a><span id="l3.24">                        type=&quot;menu&quot;</span>
<a href="#l3.25"></a><span id="l3.25">                        wantdropmarker=&quot;true&quot;</span>
<a href="#l3.26"></a><span id="l3.26">                        class=&quot;formatting-button&quot;</span>
<a href="#l3.27"></a><span id="l3.27">                        tooltiptext=&quot;&amp;SmileButton.tooltip;&quot;</span>
<a href="#l3.28"></a><span id="l3.28">                        observes=&quot;cmd_smiley&quot;&gt;</span>
<a href="#l3.29"></a><span id="l3.29">           &lt;menupopup id=&quot;smilyPopup&quot;&gt;</span>
<a href="#l3.30"></a><span id="l3.30">             &lt;menuitem id=&quot;smileySmile&quot; class=&quot;menuitem-iconic&quot; label=&quot;&amp;smiley1Cmd.label;&quot;</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-                      oncommand=&quot;doStatefulCommand('cmd_smiley', ':-)')&quot;/&gt;</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+                      oncommand=&quot;goDoCommandParams('cmd_smiley', ':-)')&quot;/&gt;</span>
<a href="#l3.33"></a><span id="l3.33">             &lt;menuitem id=&quot;smileyFrown&quot; class=&quot;menuitem-iconic&quot; label=&quot;&amp;smiley2Cmd.label;&quot;</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-                      oncommand=&quot;doStatefulCommand('cmd_smiley', ':-(')&quot;/&gt;</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+                      oncommand=&quot;goDoCommandParams('cmd_smiley', ':-(')&quot;/&gt;</span>
<a href="#l3.36"></a><span id="l3.36">             &lt;menuitem id=&quot;smileyWink&quot; class=&quot;menuitem-iconic&quot; label=&quot;&amp;smiley3Cmd.label;&quot;</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-                      oncommand=&quot;doStatefulCommand('cmd_smiley', ';-)')&quot;/&gt;</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+                      oncommand=&quot;goDoCommandParams('cmd_smiley', ';-)')&quot;/&gt;</span>
<a href="#l3.39"></a><span id="l3.39">             &lt;menuitem id=&quot;smileyTongue&quot; class=&quot;menuitem-iconic&quot; label=&quot;&amp;smiley4Cmd.label;&quot;</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-                      oncommand=&quot;doStatefulCommand('cmd_smiley', ':-P')&quot;/&gt;</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+                      oncommand=&quot;goDoCommandParams('cmd_smiley', ':-P')&quot;/&gt;</span>
<a href="#l3.42"></a><span id="l3.42">             &lt;menuitem id=&quot;smileyLaughing&quot; class=&quot;menuitem-iconic&quot; label=&quot;&amp;smiley5Cmd.label;&quot;</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-                      oncommand=&quot;doStatefulCommand('cmd_smiley', ':-D')&quot;/&gt;</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+                      oncommand=&quot;goDoCommandParams('cmd_smiley', ':-D')&quot;/&gt;</span>
<a href="#l3.45"></a><span id="l3.45">             &lt;menuitem id=&quot;smileyEmbarassed&quot; class=&quot;menuitem-iconic&quot; label=&quot;&amp;smiley6Cmd.label;&quot;</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-                      oncommand=&quot;doStatefulCommand('cmd_smiley', ':-[')&quot;/&gt;</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+                      oncommand=&quot;goDoCommandParams('cmd_smiley', ':-[')&quot;/&gt;</span>
<a href="#l3.48"></a><span id="l3.48">             &lt;menuitem id=&quot;smileyUndecided&quot; class=&quot;menuitem-iconic&quot; label=&quot;&amp;smiley7Cmd.label;&quot;</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-                      oncommand=&quot;doStatefulCommand('cmd_smiley', ':-\\')&quot;/&gt;</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+                      oncommand=&quot;goDoCommandParams('cmd_smiley', ':-\\')&quot;/&gt;</span>
<a href="#l3.51"></a><span id="l3.51">             &lt;menuitem id=&quot;smileySurprise&quot; class=&quot;menuitem-iconic&quot; label=&quot;&amp;smiley8Cmd.label;&quot;</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-                      oncommand=&quot;doStatefulCommand('cmd_smiley', '=-O')&quot;/&gt;</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+                      oncommand=&quot;goDoCommandParams('cmd_smiley', '=-O')&quot;/&gt;</span>
<a href="#l3.54"></a><span id="l3.54">             &lt;menuitem id=&quot;smileyKiss&quot; class=&quot;menuitem-iconic&quot; label=&quot;&amp;smiley9Cmd.label;&quot;</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-                      oncommand=&quot;doStatefulCommand('cmd_smiley', ':-*')&quot;/&gt;</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+                      oncommand=&quot;goDoCommandParams('cmd_smiley', ':-*')&quot;/&gt;</span>
<a href="#l3.57"></a><span id="l3.57">             &lt;menuitem id=&quot;smileyYell&quot; class=&quot;menuitem-iconic&quot; label=&quot;&amp;smiley10Cmd.label;&quot;</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-                      oncommand=&quot;doStatefulCommand('cmd_smiley', '&gt;:o')&quot;/&gt;</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+                      oncommand=&quot;goDoCommandParams('cmd_smiley', '&gt;:o')&quot;/&gt;</span>
<a href="#l3.60"></a><span id="l3.60">             &lt;menuitem id=&quot;smileyCool&quot; class=&quot;menuitem-iconic&quot; label=&quot;&amp;smiley11Cmd.label;&quot;</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-                      oncommand=&quot;doStatefulCommand('cmd_smiley', '8-)')&quot;/&gt;</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+                      oncommand=&quot;goDoCommandParams('cmd_smiley', '8-)')&quot;/&gt;</span>
<a href="#l3.63"></a><span id="l3.63">             &lt;menuitem id=&quot;smileyMoney&quot; class=&quot;menuitem-iconic&quot; label=&quot;&amp;smiley12Cmd.label;&quot;</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-                      oncommand=&quot;doStatefulCommand('cmd_smiley', ':-$')&quot;/&gt;</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+                      oncommand=&quot;goDoCommandParams('cmd_smiley', ':-$')&quot;/&gt;</span>
<a href="#l3.66"></a><span id="l3.66">             &lt;menuitem id=&quot;smileyFoot&quot; class=&quot;menuitem-iconic&quot; label=&quot;&amp;smiley13Cmd.label;&quot;</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-                      oncommand=&quot;doStatefulCommand('cmd_smiley', ':-!')&quot;/&gt;</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+                      oncommand=&quot;goDoCommandParams('cmd_smiley', ':-!')&quot;/&gt;</span>
<a href="#l3.69"></a><span id="l3.69">             &lt;menuitem id=&quot;smileyInnocent&quot; class=&quot;menuitem-iconic&quot; label=&quot;&amp;smiley14Cmd.label;&quot;</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-                      oncommand=&quot;doStatefulCommand('cmd_smiley', 'O:-)')&quot;/&gt;</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+                      oncommand=&quot;goDoCommandParams('cmd_smiley', 'O:-)')&quot;/&gt;</span>
<a href="#l3.72"></a><span id="l3.72">             &lt;menuitem id=&quot;smileyCry&quot; class=&quot;menuitem-iconic&quot; label=&quot;&amp;smiley15Cmd.label;&quot;</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-                      oncommand=&quot;doStatefulCommand('cmd_smiley', ':\'(')&quot;/&gt;</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+                      oncommand=&quot;goDoCommandParams('cmd_smiley', ':\'(')&quot;/&gt;</span>
<a href="#l3.75"></a><span id="l3.75">             &lt;menuitem id=&quot;smileySealed&quot; class=&quot;menuitem-iconic&quot; label=&quot;&amp;smiley16Cmd.label;&quot;</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-                      oncommand=&quot;doStatefulCommand('cmd_smiley', ':-X')&quot;/&gt;</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+                      oncommand=&quot;goDoCommandParams('cmd_smiley', ':-X')&quot;/&gt;</span>
<a href="#l3.78"></a><span id="l3.78">           &lt;/menupopup&gt;</span>
<a href="#l3.79"></a><span id="l3.79">         &lt;/toolbarbutton&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/compose/content/editor.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/compose/content/editor.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -418,22 +418,23 @@ async function CheckAndSaveDocument(comm</span>
<a href="#l4.4"></a><span id="l4.4">   }</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6">   // Default or result == 1 (Cancel)</span>
<a href="#l4.7"></a><span id="l4.7">   return false;</span>
<a href="#l4.8"></a><span id="l4.8"> }</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> // --------------------------- Text style ---------------------------</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-function onParagraphFormatChange(paraMenuList, commandID) {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+function onParagraphFormatChange() {</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+  let paraMenuList = document.getElementById(&quot;ParagraphSelect&quot;);</span>
<a href="#l4.15"></a><span id="l4.15">   if (!paraMenuList) {</span>
<a href="#l4.16"></a><span id="l4.16">     return;</span>
<a href="#l4.17"></a><span id="l4.17">   }</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-  var commandNode = document.getElementById(commandID);</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+  var commandNode = document.getElementById(&quot;cmd_paragraphState&quot;);</span>
<a href="#l4.21"></a><span id="l4.21">   var state = commandNode.getAttribute(&quot;state&quot;);</span>
<a href="#l4.22"></a><span id="l4.22"> </span>
<a href="#l4.23"></a><span id="l4.23">   // force match with &quot;normal&quot;</span>
<a href="#l4.24"></a><span id="l4.24">   if (state == &quot;body&quot;) {</span>
<a href="#l4.25"></a><span id="l4.25">     state = &quot;&quot;;</span>
<a href="#l4.26"></a><span id="l4.26">   }</span>
<a href="#l4.27"></a><span id="l4.27"> </span>
<a href="#l4.28"></a><span id="l4.28">   if (state == &quot;mixed&quot;) {</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineat">@@ -450,23 +451,20 @@ function onParagraphFormatChange(paraMen</span>
<a href="#l4.30"></a><span id="l4.30">         break;</span>
<a href="#l4.31"></a><span id="l4.31">       }</span>
<a href="#l4.32"></a><span id="l4.32">     }</span>
<a href="#l4.33"></a><span id="l4.33">   }</span>
<a href="#l4.34"></a><span id="l4.34"> }</span>
<a href="#l4.35"></a><span id="l4.35"> </span>
<a href="#l4.36"></a><span id="l4.36"> /**</span>
<a href="#l4.37"></a><span id="l4.37">  * Selects the current font face in the menulist.</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">- *</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">- * @param fontFaceMenuList  The menulist element containing the list of fonts.</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">- * @param commandID         The commandID which holds the current font name</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">- *                          in its &quot;state&quot; attribute.</span>
<a href="#l4.42"></a><span id="l4.42">  */</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-function onFontFaceChange(fontFaceMenuList, commandID) {</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-  var commandNode = document.getElementById(commandID);</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+function onFontFaceChange() {</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+  let fontFaceMenuList = document.getElementById(&quot;FontFaceSelect&quot;);</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+  var commandNode = document.getElementById(&quot;cmd_fontFace&quot;);</span>
<a href="#l4.48"></a><span id="l4.48">   var editorFont = commandNode.getAttribute(&quot;state&quot;);</span>
<a href="#l4.49"></a><span id="l4.49"> </span>
<a href="#l4.50"></a><span id="l4.50">   // Strip quotes in font names. Experiments have shown that we only</span>
<a href="#l4.51"></a><span id="l4.51">   // ever get double quotes around the font name, never single quotes,</span>
<a href="#l4.52"></a><span id="l4.52">   // even if they were in the HTML source. Also single or double</span>
<a href="#l4.53"></a><span id="l4.53">   // quotes within the font name are never returned.</span>
<a href="#l4.54"></a><span id="l4.54">   editorFont = editorFont.replace(/&quot;/g, &quot;&quot;);</span>
<a href="#l4.55"></a><span id="l4.55"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/compose/content/messengercompose.xhtml</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/compose/content/messengercompose.xhtml</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -144,17 +144,16 @@</span>
<a href="#l5.4"></a><span id="l5.4">     &lt;command id=&quot;cmd_image&quot; oncommand=&quot;goDoCommand('cmd_image')&quot;/&gt;</span>
<a href="#l5.5"></a><span id="l5.5">     &lt;command id=&quot;cmd_hline&quot; oncommand=&quot;goDoCommand('cmd_hline')&quot;/&gt;</span>
<a href="#l5.6"></a><span id="l5.6">     &lt;command id=&quot;cmd_table&quot; oncommand=&quot;goDoCommand('cmd_table')&quot;/&gt;</span>
<a href="#l5.7"></a><span id="l5.7">     &lt;command id=&quot;cmd_objectProperties&quot; oncommand=&quot;goDoCommand('cmd_objectProperties')&quot;/&gt;</span>
<a href="#l5.8"></a><span id="l5.8">     &lt;command id=&quot;cmd_insertChars&quot; oncommand=&quot;goDoCommand('cmd_insertChars')&quot; label=&quot;&amp;insertCharsCmd.label;&quot;/&gt;</span>
<a href="#l5.9"></a><span id="l5.9">     &lt;command id=&quot;cmd_insertHTMLWithDialog&quot; oncommand=&quot;goDoCommand('cmd_insertHTMLWithDialog')&quot; label=&quot;&amp;insertHTMLCmd.label;&quot;/&gt;</span>
<a href="#l5.10"></a><span id="l5.10">     &lt;command id=&quot;cmd_insertMathWithDialog&quot; oncommand=&quot;goDoCommand('cmd_insertMathWithDialog')&quot; label=&quot;&amp;insertMathCmd.label;&quot;/&gt;</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-    &lt;command id=&quot;cmd_insertBreak&quot; oncommand=&quot;goDoCommand('cmd_insertBreak')&quot;/&gt;</span>
<a href="#l5.13"></a><span id="l5.13">     &lt;command id=&quot;cmd_insertBreakAll&quot; oncommand=&quot;goDoCommand('cmd_insertBreakAll')&quot;/&gt;</span>
<a href="#l5.14"></a><span id="l5.14"> </span>
<a href="#l5.15"></a><span id="l5.15">     &lt;!-- dummy command used just to disable things in non-HTML modes --&gt;</span>
<a href="#l5.16"></a><span id="l5.16">     &lt;command id=&quot;cmd_renderedHTMLEnabler&quot;/&gt;</span>
<a href="#l5.17"></a><span id="l5.17">   &lt;/commandset&gt;</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19">   &lt;!-- edit menu commands. These get updated by code in globalOverlay.js --&gt;</span>
<a href="#l5.20"></a><span id="l5.20">   &lt;commandset id=&quot;composerEditMenuItems&quot;</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineat">@@ -174,41 +173,41 @@</span>
<a href="#l5.22"></a><span id="l5.22">   &lt;!-- style related commands that update on creation, and on selection change --&gt;</span>
<a href="#l5.23"></a><span id="l5.23">   &lt;commandset id=&quot;composerStyleMenuItems&quot;</span>
<a href="#l5.24"></a><span id="l5.24">               commandupdater=&quot;true&quot;</span>
<a href="#l5.25"></a><span id="l5.25">               events=&quot;create, style, mode_switch&quot;</span>
<a href="#l5.26"></a><span id="l5.26">               oncommandupdate=&quot;goUpdateComposerMenuItems(this)&quot;&gt;</span>
<a href="#l5.27"></a><span id="l5.27">     &lt;command id=&quot;cmd_bold&quot; state=&quot;false&quot; oncommand=&quot;doStyleUICommand('cmd_bold')&quot;/&gt;</span>
<a href="#l5.28"></a><span id="l5.28">     &lt;command id=&quot;cmd_italic&quot; state=&quot;false&quot; oncommand=&quot;doStyleUICommand('cmd_italic')&quot;/&gt;</span>
<a href="#l5.29"></a><span id="l5.29">     &lt;command id=&quot;cmd_underline&quot; state=&quot;false&quot; oncommand=&quot;doStyleUICommand('cmd_underline')&quot;/&gt;</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-    &lt;command id=&quot;cmd_tt&quot; state=&quot;false&quot; oncommand=&quot;doStyleUICommand('cmd_tt')&quot;/&gt;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+    &lt;command id=&quot;cmd_tt&quot; state=&quot;false&quot; oncommand=&quot;goDoCommand('cmd_tt')&quot;/&gt;</span>
<a href="#l5.32"></a><span id="l5.32">     &lt;command id=&quot;cmd_smiley&quot;/&gt;</span>
<a href="#l5.33"></a><span id="l5.33"> </span>
<a href="#l5.34"></a><span id="l5.34">     &lt;command id=&quot;cmd_strikethrough&quot; state=&quot;false&quot; oncommand=&quot;doStyleUICommand('cmd_strikethrough');&quot;/&gt;</span>
<a href="#l5.35"></a><span id="l5.35">     &lt;command id=&quot;cmd_superscript&quot; state=&quot;false&quot; oncommand=&quot;doStyleUICommand('cmd_superscript');&quot;/&gt;</span>
<a href="#l5.36"></a><span id="l5.36">     &lt;command id=&quot;cmd_subscript&quot; state=&quot;false&quot; oncommand=&quot;doStyleUICommand('cmd_subscript');&quot;/&gt;</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-    &lt;command id=&quot;cmd_nobreak&quot; state=&quot;false&quot; oncommand=&quot;doStyleUICommand('cmd_nobreak');&quot;/&gt;</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+    &lt;command id=&quot;cmd_nobreak&quot; state=&quot;false&quot; oncommand=&quot;goDoCommand('cmd_nobreak');&quot;/&gt;</span>
<a href="#l5.39"></a><span id="l5.39"> </span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-    &lt;command id=&quot;cmd_em&quot; state=&quot;false&quot; oncommand=&quot;doStyleUICommand('cmd_em')&quot;/&gt;</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-    &lt;command id=&quot;cmd_strong&quot; state=&quot;false&quot; oncommand=&quot;doStyleUICommand('cmd_strong')&quot;/&gt;</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-    &lt;command id=&quot;cmd_cite&quot; state=&quot;false&quot; oncommand=&quot;doStyleUICommand('cmd_cite')&quot;/&gt;</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-    &lt;command id=&quot;cmd_abbr&quot; state=&quot;false&quot; oncommand=&quot;doStyleUICommand('cmd_abbr')&quot;/&gt;</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-    &lt;command id=&quot;cmd_acronym&quot; state=&quot;false&quot; oncommand=&quot;doStyleUICommand('cmd_acronym')&quot;/&gt;</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-    &lt;command id=&quot;cmd_code&quot; state=&quot;false&quot; oncommand=&quot;doStyleUICommand('cmd_code')&quot;/&gt;</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-    &lt;command id=&quot;cmd_samp&quot; state=&quot;false&quot; oncommand=&quot;doStyleUICommand('cmd_samp')&quot;/&gt;</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-    &lt;command id=&quot;cmd_var&quot; state=&quot;false&quot; oncommand=&quot;doStyleUICommand('cmd_var')&quot;/&gt;</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+    &lt;command id=&quot;cmd_em&quot; state=&quot;false&quot; oncommand=&quot;goDoCommand('cmd_em')&quot;/&gt;</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+    &lt;command id=&quot;cmd_strong&quot; state=&quot;false&quot; oncommand=&quot;goDoCommand('cmd_strong')&quot;/&gt;</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+    &lt;command id=&quot;cmd_cite&quot; state=&quot;false&quot; oncommand=&quot;goDoCommand('cmd_cite')&quot;/&gt;</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+    &lt;command id=&quot;cmd_abbr&quot; state=&quot;false&quot; oncommand=&quot;goDoCommand('cmd_abbr')&quot;/&gt;</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+    &lt;command id=&quot;cmd_acronym&quot; state=&quot;false&quot; oncommand=&quot;goDoCommand('cmd_acronym')&quot;/&gt;</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+    &lt;command id=&quot;cmd_code&quot; state=&quot;false&quot; oncommand=&quot;goDoCommand('cmd_code')&quot;/&gt;</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+    &lt;command id=&quot;cmd_samp&quot; state=&quot;false&quot; oncommand=&quot;goDoCommand('cmd_samp')&quot;/&gt;</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+    &lt;command id=&quot;cmd_var&quot; state=&quot;false&quot; oncommand=&quot;goDoCommand('cmd_var')&quot;/&gt;</span>
<a href="#l5.56"></a><span id="l5.56"> </span>
<a href="#l5.57"></a><span id="l5.57">     &lt;command id=&quot;cmd_ul&quot; state=&quot;false&quot; oncommand=&quot;doStyleUICommand('cmd_ul')&quot;/&gt;</span>
<a href="#l5.58"></a><span id="l5.58">     &lt;command id=&quot;cmd_ol&quot; state=&quot;false&quot; oncommand=&quot;doStyleUICommand('cmd_ol')&quot;/&gt;</span>
<a href="#l5.59"></a><span id="l5.59"> </span>
<a href="#l5.60"></a><span id="l5.60">     &lt;command id=&quot;cmd_indent&quot; oncommand=&quot;goDoCommand('cmd_indent')&quot;/&gt;</span>
<a href="#l5.61"></a><span id="l5.61">     &lt;command id=&quot;cmd_outdent&quot; oncommand=&quot;goDoCommand('cmd_outdent')&quot;/&gt;</span>
<a href="#l5.62"></a><span id="l5.62"> </span>
<a href="#l5.63"></a><span id="l5.63">     &lt;!-- the state attribute gets filled with the paragraph format before the command is executed --&gt;</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">-    &lt;command id=&quot;cmd_paragraphState&quot; state=&quot;&quot; oncommand=&quot;doStatefulCommand('cmd_paragraphState', event.target.value)&quot;/&gt;</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+    &lt;command id=&quot;cmd_paragraphState&quot; state=&quot;&quot; oncommand=&quot;goDoCommandParams('cmd_paragraphState', event.target.value)&quot;/&gt;</span>
<a href="#l5.66"></a><span id="l5.66">     &lt;command id=&quot;cmd_fontFace&quot; state=&quot;&quot; oncommand=&quot;doStatefulCommand('cmd_fontFace', event.target.value)&quot;/&gt;</span>
<a href="#l5.67"></a><span id="l5.67"> </span>
<a href="#l5.68"></a><span id="l5.68">     &lt;!-- No &quot;oncommand&quot;, use EditorSelectColor() to bring up color dialog --&gt;</span>
<a href="#l5.69"></a><span id="l5.69">     &lt;command id=&quot;cmd_fontColor&quot; state=&quot;&quot; disabled=&quot;false&quot;/&gt;</span>
<a href="#l5.70"></a><span id="l5.70">     &lt;command id=&quot;cmd_backgroundColor&quot; state=&quot;&quot; disabled=&quot;false&quot;/&gt;</span>
<a href="#l5.71"></a><span id="l5.71">     &lt;command id=&quot;cmd_highlight&quot; state=&quot;transparent&quot; oncommand=&quot;EditorSelectColor('Highlight', event);&quot;/&gt;</span>
<a href="#l5.72"></a><span id="l5.72"> </span>
<a href="#l5.73"></a><span id="l5.73">     &lt;command id=&quot;cmd_align&quot; state=&quot;&quot;/&gt;</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineat">@@ -251,18 +250,18 @@</span>
<a href="#l5.75"></a><span id="l5.75">   &lt;/commandset&gt;</span>
<a href="#l5.76"></a><span id="l5.76"> </span>
<a href="#l5.77"></a><span id="l5.77">   &lt;!-- commands updated only when the menu gets created --&gt;</span>
<a href="#l5.78"></a><span id="l5.78">   &lt;commandset id=&quot;composerListMenuItems&quot;</span>
<a href="#l5.79"></a><span id="l5.79">               commandupdater=&quot;true&quot;</span>
<a href="#l5.80"></a><span id="l5.80">               events=&quot;create, mode_switch&quot;</span>
<a href="#l5.81"></a><span id="l5.81">               oncommandupdate=&quot;goUpdateComposerMenuItems(this)&quot;&gt;</span>
<a href="#l5.82"></a><span id="l5.82">     &lt;!-- List menu  --&gt;</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineminus">-    &lt;command id=&quot;cmd_dt&quot; oncommand=&quot;doStyleUICommand('cmd_dt')&quot;/&gt;</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineminus">-    &lt;command id=&quot;cmd_dd&quot; oncommand=&quot;doStyleUICommand('cmd_dd')&quot;/&gt;</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+    &lt;command id=&quot;cmd_dt&quot; oncommand=&quot;goDoCommand('cmd_dt')&quot;/&gt;</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+    &lt;command id=&quot;cmd_dd&quot; oncommand=&quot;goDoCommand('cmd_dd')&quot;/&gt;</span>
<a href="#l5.87"></a><span id="l5.87">     &lt;command id=&quot;cmd_removeList&quot; oncommand=&quot;goDoCommand('cmd_removeList')&quot;/&gt;</span>
<a href="#l5.88"></a><span id="l5.88">     &lt;!-- cmd_ul and cmd_ol are shared with toolbar and are in composerStyleMenuItems commandset --&gt;</span>
<a href="#l5.89"></a><span id="l5.89">   &lt;/commandset&gt;</span>
<a href="#l5.90"></a><span id="l5.90"> </span>
<a href="#l5.91"></a><span id="l5.91">   &lt;!-- File Menu --&gt;</span>
<a href="#l5.92"></a><span id="l5.92">   &lt;command id=&quot;cmd_new&quot; oncommand=&quot;goDoCommand('cmd_newMessage')&quot;/&gt;</span>
<a href="#l5.93"></a><span id="l5.93">   &lt;command id=&quot;cmd_attachFile&quot; oncommand=&quot;goDoCommand('cmd_attachFile')&quot;/&gt;</span>
<a href="#l5.94"></a><span id="l5.94">   &lt;command id=&quot;cmd_attachCloud&quot; oncommand=&quot;attachToCloud(event)&quot;/&gt;</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineat">@@ -1383,17 +1382,17 @@</span>
<a href="#l5.96"></a><span id="l5.96">                assume that the id = 'menu_'+tagName (the 'value' label),</span>
<a href="#l5.97"></a><span id="l5.97">                except for the first ('none') item</span>
<a href="#l5.98"></a><span id="l5.98">            --&gt;</span>
<a href="#l5.99"></a><span id="l5.99">           &lt;!-- Paragraph Style submenu --&gt;</span>
<a href="#l5.100"></a><span id="l5.100">           &lt;menu id=&quot;paragraphMenu&quot; label=&quot;&amp;paragraphMenu.label;&quot;</span>
<a href="#l5.101"></a><span id="l5.101">                 accesskey=&quot;&amp;paragraphMenu.accesskey;&quot;</span>
<a href="#l5.102"></a><span id="l5.102">                 position=&quot;10&quot; onpopupshowing=&quot;InitParagraphMenu()&quot;&gt;</span>
<a href="#l5.103"></a><span id="l5.103">             &lt;menupopup id=&quot;paragraphMenuPopup&quot;</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineminus">-                       oncommand=&quot;doStatefulCommand('cmd_paragraphState', event.target.getAttribute('value'))&quot;&gt;</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+                       oncommand=&quot;goDoCommandParams('cmd_paragraphState', event.target.getAttribute('value'))&quot;&gt;</span>
<a href="#l5.106"></a><span id="l5.106">               &lt;menuitem id=&quot;menu_bodyText&quot;</span>
<a href="#l5.107"></a><span id="l5.107">                         type=&quot;radio&quot;</span>
<a href="#l5.108"></a><span id="l5.108">                         name=&quot;1&quot;</span>
<a href="#l5.109"></a><span id="l5.109">                         label=&quot;&amp;bodyTextCmd.label;&quot;</span>
<a href="#l5.110"></a><span id="l5.110">                         accesskey=&quot;&amp;bodyTextCmd.accesskey;&quot;</span>
<a href="#l5.111"></a><span id="l5.111">                         value=&quot;&quot;</span>
<a href="#l5.112"></a><span id="l5.112">                         observes=&quot;cmd_renderedHTMLEnabler&quot;/&gt;</span>
<a href="#l5.113"></a><span id="l5.113">               &lt;menuitem id=&quot;menu_p&quot;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

