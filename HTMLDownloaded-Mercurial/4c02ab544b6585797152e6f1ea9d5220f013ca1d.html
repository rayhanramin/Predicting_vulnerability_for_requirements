<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 27691:4c02ab544b6585797152e6f1ea9d5220f013ca1d</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 4c02ab544b6585797152e6f1ea9d5220f013ca1d" />
<meta property="og:url" content="/comm-central/rev/4c02ab544b6585797152e6f1ea9d5220f013ca1d" />
<meta property="og:description" content="Bug 1534163 - Remove nsIRDF* use from newsfeed support. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 4c02ab544b6585797152e6f1ea9d5220f013ca1d 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/4c02ab544b6585797152e6f1ea9d5220f013ca1d">shortlog</a> |
<a href="/comm-central/log/4c02ab544b6585797152e6f1ea9d5220f013ca1d">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/4c02ab544b6585797152e6f1ea9d5220f013ca1d">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/4c02ab544b6585797152e6f1ea9d5220f013ca1d">files</a> |
changeset |
<a href="/comm-central/raw-rev/4c02ab544b6585797152e6f1ea9d5220f013ca1d">raw</a>  | <a href="/comm-central/archive/4c02ab544b6585797152e6f1ea9d5220f013ca1d.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1534163">Bug 1534163</a> - Remove nsIRDF* use from newsfeed support. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#66;&#101;&#110;&#32;&#67;&#97;&#109;&#112;&#98;&#101;&#108;&#108;&#32;&#60;&#98;&#101;&#110;&#99;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 29 May 2019 11:16:43 +1200</td></tr>

<tr>
 <td>changeset 27691</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/4c02ab544b6585797152e6f1ea9d5220f013ca1d">4c02ab544b6585797152e6f1ea9d5220f013ca1d</a></td>
</tr>



<tr>
<td>parent 27690</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/c4e121fd5c05d38752571c3fc439b13be8331dda">c4e121fd5c05d38752571c3fc439b13be8331dda</a>
</td>
</tr>

<tr>
<td>child 27692</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d8d02940a5f222502af98cbd27ea38aca9774af5">d8d02940a5f222502af98cbd27ea38aca9774af5</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=4c02ab544b6585797152e6f1ea9d5220f013ca1d">16448</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Tue, 24 Sep 2019 04:11:26 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@d8d02940a5f2 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=d8d02940a5f222502af98cbd27ea38aca9774af5">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=d8d02940a5f222502af98cbd27ea38aca9774af5&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d8d02940a5f222502af98cbd27ea38aca9774af5&newProject=comm-central&newRevision=c4e121fd5c05d38752571c3fc439b13be8331dda&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d8d02940a5f222502af98cbd27ea38aca9774af5&newProject=comm-central&newRevision=c4e121fd5c05d38752571c3fc439b13be8331dda&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d8d02940a5f222502af98cbd27ea38aca9774af5&newProject=comm-central&newRevision=c4e121fd5c05d38752571c3fc439b13be8331dda&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1534163">1534163</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1534163">Bug 1534163</a> - Remove nsIRDF* use from newsfeed support. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mail/base/modules/MailMigrator.jsm">mail/base/modules/MailMigrator.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mail/base/modules/MailMigrator.jsm">file</a> |
<a href="/comm-central/annotate/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mail/base/modules/MailMigrator.jsm">annotate</a> |
<a href="/comm-central/diff/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mail/base/modules/MailMigrator.jsm">diff</a> |
<a href="/comm-central/comparison/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mail/base/modules/MailMigrator.jsm">comparison</a> |
<a href="/comm-central/log/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mail/base/modules/MailMigrator.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/extensions/newsblog/content/Feed.js">mailnews/extensions/newsblog/content/Feed.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/extensions/newsblog/content/Feed.js">file</a> |
<a href="/comm-central/annotate/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/extensions/newsblog/content/Feed.js">annotate</a> |
<a href="/comm-central/diff/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/extensions/newsblog/content/Feed.js">diff</a> |
<a href="/comm-central/comparison/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/extensions/newsblog/content/Feed.js">comparison</a> |
<a href="/comm-central/log/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/extensions/newsblog/content/Feed.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/extensions/newsblog/content/FeedItem.js">mailnews/extensions/newsblog/content/FeedItem.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/extensions/newsblog/content/FeedItem.js">file</a> |
<a href="/comm-central/annotate/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/extensions/newsblog/content/FeedItem.js">annotate</a> |
<a href="/comm-central/diff/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/extensions/newsblog/content/FeedItem.js">diff</a> |
<a href="/comm-central/comparison/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/extensions/newsblog/content/FeedItem.js">comparison</a> |
<a href="/comm-central/log/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/extensions/newsblog/content/FeedItem.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/extensions/newsblog/content/FeedUtils.jsm">mailnews/extensions/newsblog/content/FeedUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/extensions/newsblog/content/FeedUtils.jsm">file</a> |
<a href="/comm-central/annotate/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/extensions/newsblog/content/FeedUtils.jsm">annotate</a> |
<a href="/comm-central/diff/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/extensions/newsblog/content/FeedUtils.jsm">diff</a> |
<a href="/comm-central/comparison/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/extensions/newsblog/content/FeedUtils.jsm">comparison</a> |
<a href="/comm-central/log/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/extensions/newsblog/content/FeedUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/extensions/newsblog/content/feed-subscriptions.js">mailnews/extensions/newsblog/content/feed-subscriptions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/extensions/newsblog/content/feed-subscriptions.js">file</a> |
<a href="/comm-central/annotate/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/extensions/newsblog/content/feed-subscriptions.js">annotate</a> |
<a href="/comm-central/diff/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/extensions/newsblog/content/feed-subscriptions.js">diff</a> |
<a href="/comm-central/comparison/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/extensions/newsblog/content/feed-subscriptions.js">comparison</a> |
<a href="/comm-central/log/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/extensions/newsblog/content/feed-subscriptions.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/extensions/newsblog/content/newsblogOverlay.js">mailnews/extensions/newsblog/content/newsblogOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/extensions/newsblog/content/newsblogOverlay.js">file</a> |
<a href="/comm-central/annotate/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/extensions/newsblog/content/newsblogOverlay.js">annotate</a> |
<a href="/comm-central/diff/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/extensions/newsblog/content/newsblogOverlay.js">diff</a> |
<a href="/comm-central/comparison/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/extensions/newsblog/content/newsblogOverlay.js">comparison</a> |
<a href="/comm-central/log/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/extensions/newsblog/content/newsblogOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/local/public/nsIRssIncomingServer.idl">mailnews/local/public/nsIRssIncomingServer.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/local/public/nsIRssIncomingServer.idl">file</a> |
<a href="/comm-central/annotate/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/local/public/nsIRssIncomingServer.idl">annotate</a> |
<a href="/comm-central/diff/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/local/public/nsIRssIncomingServer.idl">diff</a> |
<a href="/comm-central/comparison/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/local/public/nsIRssIncomingServer.idl">comparison</a> |
<a href="/comm-central/log/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/local/public/nsIRssIncomingServer.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/local/src/nsMsgLocalStoreUtils.cpp">mailnews/local/src/nsMsgLocalStoreUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/local/src/nsMsgLocalStoreUtils.cpp">file</a> |
<a href="/comm-central/annotate/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/local/src/nsMsgLocalStoreUtils.cpp">annotate</a> |
<a href="/comm-central/diff/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/local/src/nsMsgLocalStoreUtils.cpp">diff</a> |
<a href="/comm-central/comparison/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/local/src/nsMsgLocalStoreUtils.cpp">comparison</a> |
<a href="/comm-central/log/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/local/src/nsMsgLocalStoreUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/local/src/nsRssIncomingServer.cpp">mailnews/local/src/nsRssIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/local/src/nsRssIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/local/src/nsRssIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/local/src/nsRssIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/local/src/nsRssIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/4c02ab544b6585797152e6f1ea9d5220f013ca1d/mailnews/local/src/nsRssIncomingServer.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/modules/MailMigrator.jsm</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/modules/MailMigrator.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -6,16 +6,19 @@</span>
<a href="#l1.4"></a><span id="l1.4"> /**</span>
<a href="#l1.5"></a><span id="l1.5">  * This module handles migrating mail-specific preferences, etc. Migration has</span>
<a href="#l1.6"></a><span id="l1.6">  * traditionally been a part of msgMail3PaneWindow.js, but separating the code</span>
<a href="#l1.7"></a><span id="l1.7">  * out into a module makes unit testing much easier.</span>
<a href="#l1.8"></a><span id="l1.8">  */</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> var EXPORTED_SYMBOLS = [&quot;MailMigrator&quot;];</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+const { MailServices } = ChromeUtils.import(</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+  &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+);</span>
<a href="#l1.15"></a><span id="l1.15"> const { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l1.16"></a><span id="l1.16"> const { IOUtils } = ChromeUtils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l1.17"></a><span id="l1.17"> </span>
<a href="#l1.18"></a><span id="l1.18"> var MailMigrator = {</span>
<a href="#l1.19"></a><span id="l1.19">   /**</span>
<a href="#l1.20"></a><span id="l1.20">    * Switch the given fonts to the given encodings, but only if the current fonts</span>
<a href="#l1.21"></a><span id="l1.21">    * are defaults.</span>
<a href="#l1.22"></a><span id="l1.22">    */</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineat">@@ -405,16 +408,261 @@ var MailMigrator = {</span>
<a href="#l1.24"></a><span id="l1.24">           &quot; -- &quot; +</span>
<a href="#l1.25"></a><span id="l1.25">           &quot;Will reattempt on next start.&quot;</span>
<a href="#l1.26"></a><span id="l1.26">       );</span>
<a href="#l1.27"></a><span id="l1.27">     }</span>
<a href="#l1.28"></a><span id="l1.28">   },</span>
<a href="#l1.29"></a><span id="l1.29">   /* eslint-enable complexity */</span>
<a href="#l1.30"></a><span id="l1.30"> </span>
<a href="#l1.31"></a><span id="l1.31">   /**</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+   * RSS subscriptions and items used to be stored in .rdf files, but now</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+   * we've changed to use JSON files instead. This migration routine checks</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+   * for the old format files and upgrades them as appropriate.</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+   * The feeds and items migration are handled as separate (hopefully atomic)</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+   * steps. It is careful to not overwrite new-style .json files.</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+   *</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+   * @returns {void}</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+   */</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+  _migrateRSS() {</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+    // Find all the RSS IncomingServers.</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+    let rssServers = [];</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+    let allServers = MailServices.accounts.allServers;</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+    for (let i = 0; i &lt; allServers.length; i++) {</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+      let server = allServers.queryElementAt(i, Ci.nsIMsgIncomingServer);</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+      if (server &amp;&amp; server.type == &quot;rss&quot;) {</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+        rssServers.push(server);</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+      }</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+    }</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+    // For each one...</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+    for (let server of rssServers) {</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+      this._migrateRSSServer(server);</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+    }</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+  },</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+  _migrateRSSServer(server) {</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+    let rssServer = server.QueryInterface(Ci.nsIRssIncomingServer);</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+    // Convert feeds.rdf to feeds.json (if needed).</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+    let feedsFile = rssServer.subscriptionsPath;</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+    let legacyFeedsFile = server.localPath;</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+    legacyFeedsFile.append(&quot;feeds.rdf&quot;);</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+    if (!feedsFile.exists() &amp;&amp; legacyFeedsFile.exists()) {</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+      try {</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+        this._migrateRSSSubscriptions(legacyFeedsFile, feedsFile);</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+      } catch (err) {</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+        Cu.reportError(</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+          &quot;Failed to migrate '&quot; +</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+            feedsFile.path +</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+            &quot;' to '&quot; +</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+            legacyFeedsFile.path +</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+            &quot;': &quot; +</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+            err</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+        );</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+      }</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+    }</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+    // Convert feeditems.rdf to feeditems.json (if needed).</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+    let itemsFile = rssServer.feedItemsPath;</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+    let legacyItemsFile = server.localPath;</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+    legacyItemsFile.append(&quot;feeditems.rdf&quot;);</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+    if (!itemsFile.exists() &amp;&amp; legacyItemsFile.exists()) {</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+      try {</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+        this._migrateRSSItems(legacyItemsFile, itemsFile);</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+      } catch (err) {</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+        Cu.reportError(</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+          &quot;Failed to migrate '&quot; +</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+            itemsFile.path +</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+            &quot;' to '&quot; +</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+            legacyItemsFile.path +</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+            &quot;': &quot; +</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+            err</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+        );</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineplus">+      }</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineplus">+    }</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineplus">+  },</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineplus">+</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+  // Assorted namespace strings required for the feed migrations.</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+  FZ_NS: &quot;urn:forumzilla:&quot;,</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+  DC_NS: &quot;http://purl.org/dc/elements/1.1/&quot;,</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+  RSS_NS: &quot;http://purl.org/rss/1.0/&quot;,</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+  RDF_SYNTAX_NS: &quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;,</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+  RDF_SYNTAX_TYPE: &quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#type&quot;,</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineplus">+  /**</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineplus">+   * Convert rss subscriptions in a legacy feeds.rdf file into feeds.json.</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+   * If the conversion is successful, the legacy file will be removed.</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+   *</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+   * @param {nsIFile} legacyFile - Location of the rdf file.</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+   * @param {nsIFile} jsonFile - Location for the output JSON file.</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+   * @returns {void}</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineplus">+   * @throws Will throw an error if the conversion fails.</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+   */</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+  _migrateRSSSubscriptions(legacyFile, jsonFile) {</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+    // Load .rdf file into an XMLDocument.</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+    let rawXMLRDF = IOUtils.loadFileToString(legacyFile);</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineplus">+    let parser = new DOMParser();</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+    let doc = parser.parseFromString(rawXMLRDF, &quot;text/xml&quot;);</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+    let feeds = [];</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineplus">+    // Skip the fz:root-&gt;fz:feeds-&gt;etc structure. Just grab fz:feed nodes.</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+    let feedNodes = doc.documentElement.getElementsByTagNameNS(</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+      this.FZ_NS,</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+      &quot;feed&quot;</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineplus">+    );</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+    let toBool = function(val) {</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineplus">+      return val == &quot;true&quot;;</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+    };</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineplus">+</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineplus">+    // Map RDF feed property names to js.</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineplus">+    let propMap = [</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineplus">+      { ns: this.DC_NS, name: &quot;title&quot;, dest: &quot;title&quot; },</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineplus">+      { ns: this.DC_NS, name: &quot;lastModified&quot;, dest: &quot;lastModified&quot; },</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineplus">+      { ns: this.DC_NS, name: &quot;identifier&quot;, dest: &quot;url&quot; },</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineplus">+      { ns: this.FZ_NS, name: &quot;quickMode&quot;, dest: &quot;quickMode&quot;, cook: toBool },</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineplus">+      { ns: this.FZ_NS, name: &quot;options&quot;, dest: &quot;options&quot;, cook: JSON.parse },</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineplus">+      { ns: this.FZ_NS, name: &quot;destFolder&quot;, dest: &quot;destFolder&quot; },</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+      { ns: this.RSS_NS, name: &quot;link&quot;, dest: &quot;link&quot; },</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineplus">+    ];</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineplus">+</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+    for (let f of feedNodes) {</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+      let feed = {};</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+      for (let p of propMap) {</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineplus">+        // The data could be in either an attribute or an element.</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineplus">+        let val = f.getAttributeNS(p.ns, p.name);</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+        if (!val) {</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+          let el = f.getElementsByTagNameNS(p.ns, p.name).item(0);</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+          if (el) {</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+            // Might be a RDF:resource...</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineplus">+            val = el.getAttributeNS(this.RDF_SYNTAX_NS, &quot;resource&quot;);</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineplus">+            if (!val) {</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineplus">+              // ...or a literal string.</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineplus">+              val = el.textContent;</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineplus">+            }</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineplus">+          }</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineplus">+        }</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+        if (!val) {</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+          // log.warn(`feeds.rdf: ${p.name} missing`);</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+          continue;</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+        }</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineplus">+        // Conversion needed?</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineplus">+        if (&quot;cook&quot; in p) {</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineplus">+          val = p.cook(val);</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+        }</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineplus">+        feed[p.dest] = val;</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineplus">+      }</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineplus">+</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineplus">+      if (feed.url) {</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineplus">+        feeds.push(feed);</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineplus">+      }</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineplus">+    }</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineplus">+</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineplus">+    let data = JSON.stringify(feeds);</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineplus">+    IOUtils.saveStringToFile(jsonFile, data);</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineplus">+    legacyFile.remove(false);</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineplus">+  },</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineplus">+</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineplus">+  /**</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineplus">+   * Convert a legacy feeditems.rdf file into feeditems.json.</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineplus">+   * If the conversion is successful, the legacy file will be removed.</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineplus">+   *</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineplus">+   * @param {nsIFile} legacyFile - Location of the rdf file.</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineplus">+   * @param {nsIFile} jsonFile - Location for the output JSON file.</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineplus">+   * @returns {void}</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineplus">+   * @throws Will throw an error if the conversion fails.</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineplus">+   */</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineplus">+  _migrateRSSItems(legacyFile, jsonFile) {</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineplus">+    // Load .rdf file into an XMLDocument.</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineplus">+    let rawXMLRDF = IOUtils.loadFileToString(legacyFile);</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineplus">+    let parser = new DOMParser();</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineplus">+    let doc = parser.parseFromString(rawXMLRDF, &quot;text/xml&quot;);</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineplus">+</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineplus">+    let items = {};</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineplus">+</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineplus">+    let demangleURL = function(itemURI) {</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineplus">+      // Reverse the mapping that originally turned links/guids into URIs.</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineplus">+      let url = itemURI;</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineplus">+      url = url.replace(&quot;urn:feeditem:&quot;, &quot;&quot;);</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineplus">+      url = url.replace(/%23/g, &quot;#&quot;);</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineplus">+      url = url.replace(/%2f/g, &quot;/&quot;);</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineplus">+      url = url.replace(/%3f/g, &quot;?&quot;);</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineplus">+      url = url.replace(/%26/g, &quot;&amp;&quot;);</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineplus">+      url = url.replace(/%7e/g, &quot;~&quot;);</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineplus">+      url = decodeURI(url);</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineplus">+      return url;</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineplus">+    };</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineplus">+</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineplus">+    let toBool = function(s) {</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineplus">+      return s == &quot;true&quot;;</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineplus">+    };</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineplus">+</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineplus">+    let toInt = function(s) {</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineplus">+      let t = parseInt(s);</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineplus">+      return Number.isNaN(t) ? 0 : t;</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineplus">+    };</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineplus">+</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineplus">+    let itemNodes = doc.documentElement.getElementsByTagNameNS(</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineplus">+      this.RDF_SYNTAX_NS,</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineplus">+      &quot;Description&quot;</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineplus">+    );</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineplus">+</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineplus">+    // Map RDF feed property names to js.</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineplus">+    let propMap = [</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineplus">+      { ns: this.FZ_NS, name: &quot;stored&quot;, dest: &quot;stored&quot;, cook: toBool },</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineplus">+      { ns: this.FZ_NS, name: &quot;valid&quot;, dest: &quot;valid&quot;, cook: toBool },</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineplus">+      {</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineplus">+        ns: this.FZ_NS,</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineplus">+        name: &quot;last-seen-timestamp&quot;,</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineplus">+        dest: &quot;lastSeenTime&quot;,</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineplus">+        cook: toInt,</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineplus">+      },</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineplus">+    ];</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineplus">+</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineplus">+    for (let itemNode of itemNodes) {</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineplus">+      let item = {};</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineplus">+      for (let p of propMap) {</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineplus">+        // The data could be in either an attribute or an element.</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineplus">+        let val = itemNode.getAttributeNS(p.ns, p.name);</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineplus">+        if (!val) {</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineplus">+          let elements = itemNode.getElementsByTagNameNS(p.ns, p.name);</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineplus">+          if (elements.length &gt; 0) {</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineplus">+            val = elements.item(0).textContent;</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineplus">+          }</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineplus">+        }</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineplus">+        if (!val) {</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineplus">+          // log.warn(`feeditems.rdf: ${p.name} missing`);</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineplus">+          continue;</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineplus">+        }</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineplus">+        // Conversion needed?</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineplus">+        if (&quot;cook&quot; in p) {</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineplus">+          val = p.cook(val);</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineplus">+        }</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineplus">+        item[p.dest] = val;</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineplus">+      }</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineplus">+</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineplus">+      item.feedURLs = [];</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineplus">+      let feedNodes = itemNode.getElementsByTagNameNS(this.FZ_NS, &quot;feed&quot;);</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineplus">+      for (let feedNode of feedNodes) {</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineplus">+        let feedURL = feedNode.getAttributeNS(this.RDF_SYNTAX_NS, &quot;resource&quot;);</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineplus">+        item.feedURLs.push(feedURL);</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineplus">+      }</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineplus">+</span>
<a href="#l1.264"></a><span id="l1.264" class="difflineplus">+      let id = itemNode.getAttributeNS(this.RDF_SYNTAX_NS, &quot;about&quot;);</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineplus">+      id = demangleURL(id);</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineplus">+      if (id) {</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineplus">+        items[id] = item;</span>
<a href="#l1.268"></a><span id="l1.268" class="difflineplus">+      }</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineplus">+    }</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineplus">+</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineplus">+    let data = JSON.stringify(items);</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineplus">+    IOUtils.saveStringToFile(jsonFile, data);</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineplus">+    legacyFile.remove(false);</span>
<a href="#l1.274"></a><span id="l1.274" class="difflineplus">+  },</span>
<a href="#l1.275"></a><span id="l1.275" class="difflineplus">+</span>
<a href="#l1.276"></a><span id="l1.276" class="difflineplus">+  /**</span>
<a href="#l1.277"></a><span id="l1.277">    * Perform any migration work that needs to occur after the Account Wizard</span>
<a href="#l1.278"></a><span id="l1.278">    * has had a chance to appear.</span>
<a href="#l1.279"></a><span id="l1.279">    */</span>
<a href="#l1.280"></a><span id="l1.280">   migratePostAccountWizard() {</span>
<a href="#l1.281"></a><span id="l1.281">     this.migrateToClearTypeFonts();</span>
<a href="#l1.282"></a><span id="l1.282">   },</span>
<a href="#l1.283"></a><span id="l1.283"> </span>
<a href="#l1.284"></a><span id="l1.284">   /**</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineat">@@ -446,10 +694,11 @@ var MailMigrator = {</span>
<a href="#l1.286"></a><span id="l1.286"> </span>
<a href="#l1.287"></a><span id="l1.287">   /**</span>
<a href="#l1.288"></a><span id="l1.288">    * Perform any migration work that needs to occur once the user profile has</span>
<a href="#l1.289"></a><span id="l1.289">    * been loaded.</span>
<a href="#l1.290"></a><span id="l1.290">    */</span>
<a href="#l1.291"></a><span id="l1.291">   migrateAtProfileStartup() {</span>
<a href="#l1.292"></a><span id="l1.292">     this._migrateAddressBooks();</span>
<a href="#l1.293"></a><span id="l1.293">     this._migrateUI();</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineplus">+    this._migrateRSS();</span>
<a href="#l1.295"></a><span id="l1.295">   },</span>
<a href="#l1.296"></a><span id="l1.296"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/Feed.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/Feed.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -50,26 +50,25 @@ var FeedCache = {</span>
<a href="#l2.4"></a><span id="l2.4">  * existing aFolder, upon successful download() completion.</span>
<a href="#l2.5"></a><span id="l2.5">  *</span>
<a href="#l2.6"></a><span id="l2.6">  * @constructor</span>
<a href="#l2.7"></a><span id="l2.7">  * @param  {String} aFeedUrl        - feed url.</span>
<a href="#l2.8"></a><span id="l2.8">  * @param  {nsIMsgFolder} aFolder   - folder containing or to contain the feed</span>
<a href="#l2.9"></a><span id="l2.9">  *                                     subscription.</span>
<a href="#l2.10"></a><span id="l2.10">  */</span>
<a href="#l2.11"></a><span id="l2.11"> function Feed(aFeedUrl, aFolder) {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  this.resource = FeedUtils.rdf</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-    .GetResource(aFeedUrl)</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-    .QueryInterface(Ci.nsIRDFResource);</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+  this.url = aFeedUrl;</span>
<a href="#l2.16"></a><span id="l2.16">   this.server = aFolder.server;</span>
<a href="#l2.17"></a><span id="l2.17">   if (!aFolder.isServer) {</span>
<a href="#l2.18"></a><span id="l2.18">     this.mFolder = aFolder;</span>
<a href="#l2.19"></a><span id="l2.19">   }</span>
<a href="#l2.20"></a><span id="l2.20"> }</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22"> Feed.prototype = {</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+  url: null,</span>
<a href="#l2.24"></a><span id="l2.24">   description: null,</span>
<a href="#l2.25"></a><span id="l2.25">   author: null,</span>
<a href="#l2.26"></a><span id="l2.26">   request: null,</span>
<a href="#l2.27"></a><span id="l2.27">   server: null,</span>
<a href="#l2.28"></a><span id="l2.28">   downloadCallback: null,</span>
<a href="#l2.29"></a><span id="l2.29">   resource: null,</span>
<a href="#l2.30"></a><span id="l2.30">   itemsToStore: [],</span>
<a href="#l2.31"></a><span id="l2.31">   itemsStored: 0,</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineat">@@ -343,168 +342,94 @@ Feed.prototype = {</span>
<a href="#l2.33"></a><span id="l2.33">           &quot; - &quot; +</span>
<a href="#l2.34"></a><span id="l2.34">           this.folder.filePath.path</span>
<a href="#l2.35"></a><span id="l2.35">       );</span>
<a href="#l2.36"></a><span id="l2.36">     }</span>
<a href="#l2.37"></a><span id="l2.37">     // Continue.</span>
<a href="#l2.38"></a><span id="l2.38">     this.storeNextItem();</span>
<a href="#l2.39"></a><span id="l2.39">   },</span>
<a href="#l2.40"></a><span id="l2.40"> </span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-  get url() {</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-    let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-    let url = ds.GetTarget(this.resource, FeedUtils.DC_IDENTIFIER, true);</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-    if (url) {</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-      url = url.QueryInterface(Ci.nsIRDFLiteral).Value;</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-    } else {</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-      url = this.resource.ValueUTF8;</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-    }</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-    return url;</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-  },</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-</span>
<a href="#l2.53"></a><span id="l2.53">   get title() {</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-    let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-    let title = ds.GetTarget(this.resource, FeedUtils.DC_TITLE, true);</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-    if (title) {</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-      title = title.QueryInterface(Ci.nsIRDFLiteral).Value;</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-    }</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-    return title;</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+    return FeedUtils.getSubscriptionAttr(this.url, this.server, &quot;title&quot;, &quot;&quot;);</span>
<a href="#l2.62"></a><span id="l2.62">   },</span>
<a href="#l2.63"></a><span id="l2.63"> </span>
<a href="#l2.64"></a><span id="l2.64">   set title(aNewTitle) {</span>
<a href="#l2.65"></a><span id="l2.65">     if (!aNewTitle) {</span>
<a href="#l2.66"></a><span id="l2.66">       return;</span>
<a href="#l2.67"></a><span id="l2.67">     }</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-    let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-    aNewTitle = FeedUtils.rdf.GetLiteral(aNewTitle);</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-    let old_title = ds.GetTarget(this.resource, FeedUtils.DC_TITLE, true);</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-    if (old_title) {</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-      ds.Change(this.resource, FeedUtils.DC_TITLE, old_title, aNewTitle);</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-    } else {</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-      ds.Assert(this.resource, FeedUtils.DC_TITLE, aNewTitle, true);</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-    }</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+    FeedUtils.setSubscriptionAttr(this.url, this.server, &quot;title&quot;, aNewTitle);</span>
<a href="#l2.78"></a><span id="l2.78">   },</span>
<a href="#l2.79"></a><span id="l2.79"> </span>
<a href="#l2.80"></a><span id="l2.80">   get lastModified() {</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-    let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-    let lastModified = ds.GetTarget(</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-      this.resource,</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-      FeedUtils.DC_LASTMODIFIED,</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-      true</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+    return FeedUtils.getSubscriptionAttr(</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+      this.url,</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+      this.server,</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+      &quot;lastModified&quot;,</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+      &quot;&quot;</span>
<a href="#l2.91"></a><span id="l2.91">     );</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-    if (lastModified) {</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-      lastModified = lastModified.QueryInterface(Ci.nsIRDFLiteral).Value;</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-    }</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-    return lastModified;</span>
<a href="#l2.97"></a><span id="l2.97">   },</span>
<a href="#l2.98"></a><span id="l2.98"> </span>
<a href="#l2.99"></a><span id="l2.99">   set lastModified(aLastModified) {</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-    let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-    aLastModified = FeedUtils.rdf.GetLiteral(aLastModified);</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-    let old_lastmodified = ds.GetTarget(</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-      this.resource,</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-      FeedUtils.DC_LASTMODIFIED,</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-      true</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+    FeedUtils.setSubscriptionAttr(</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineplus">+      this.url,</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+      this.server,</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+      &quot;lastModified&quot;,</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+      aLastModified</span>
<a href="#l2.111"></a><span id="l2.111">     );</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineminus">-    if (old_lastmodified) {</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-      ds.Change(</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineminus">-        this.resource,</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineminus">-        FeedUtils.DC_LASTMODIFIED,</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineminus">-        old_lastmodified,</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineminus">-        aLastModified</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineminus">-      );</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineminus">-    } else {</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineminus">-      ds.Assert(this.resource, FeedUtils.DC_LASTMODIFIED, aLastModified, true);</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineminus">-    }</span>
<a href="#l2.122"></a><span id="l2.122">   },</span>
<a href="#l2.123"></a><span id="l2.123"> </span>
<a href="#l2.124"></a><span id="l2.124">   get quickMode() {</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineminus">-    let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineminus">-    let quickMode = ds.GetTarget(this.resource, FeedUtils.FZ_QUICKMODE, true);</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineminus">-    if (quickMode) {</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineminus">-      quickMode = quickMode.QueryInterface(Ci.nsIRDFLiteral);</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-      quickMode = quickMode.Value == &quot;true&quot;;</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineminus">-    }</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-    return quickMode;</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+    let defaultValue = this.server.getBoolValue(&quot;quickMode&quot;);</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+    return FeedUtils.getSubscriptionAttr(</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+      this.url,</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+      this.server,</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+      &quot;quickMode&quot;,</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineplus">+      defaultValue</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+    );</span>
<a href="#l2.140"></a><span id="l2.140">   },</span>
<a href="#l2.141"></a><span id="l2.141"> </span>
<a href="#l2.142"></a><span id="l2.142">   set quickMode(aNewQuickMode) {</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineminus">-    let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineminus">-    aNewQuickMode = FeedUtils.rdf.GetLiteral(aNewQuickMode);</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineminus">-    let old_quickMode = ds.GetTarget(</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineminus">-      this.resource,</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineminus">-      FeedUtils.FZ_QUICKMODE,</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineminus">-      true</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+    FeedUtils.setSubscriptionAttr(</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+      this.url,</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+      this.server,</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+      &quot;quickMode&quot;,</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+      aNewQuickMode</span>
<a href="#l2.154"></a><span id="l2.154">     );</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineminus">-    if (old_quickMode) {</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineminus">-      ds.Change(</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineminus">-        this.resource,</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineminus">-        FeedUtils.FZ_QUICKMODE,</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineminus">-        old_quickMode,</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineminus">-        aNewQuickMode</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineminus">-      );</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineminus">-    } else {</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineminus">-      ds.Assert(this.resource, FeedUtils.FZ_QUICKMODE, aNewQuickMode, true);</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineminus">-    }</span>
<a href="#l2.165"></a><span id="l2.165">   },</span>
<a href="#l2.166"></a><span id="l2.166"> </span>
<a href="#l2.167"></a><span id="l2.167">   get options() {</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineminus">-    let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineminus">-    let options = ds.GetTarget(this.resource, FeedUtils.FZ_OPTIONS, true);</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineminus">-    options = options</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineminus">-      ? JSON.parse(options.QueryInterface(Ci.nsIRDFLiteral).Value)</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineminus">-      : null;</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineplus">+    let options = FeedUtils.getSubscriptionAttr(</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+      this.url,</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+      this.server,</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineplus">+      &quot;options&quot;,</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineplus">+      null</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineplus">+    );</span>
<a href="#l2.179"></a><span id="l2.179">     if (options &amp;&amp; options.version == FeedUtils._optionsDefault.version) {</span>
<a href="#l2.180"></a><span id="l2.180">       return options;</span>
<a href="#l2.181"></a><span id="l2.181">     }</span>
<a href="#l2.182"></a><span id="l2.182"> </span>
<a href="#l2.183"></a><span id="l2.183">     let newOptions = FeedUtils.newOptions(options);</span>
<a href="#l2.184"></a><span id="l2.184">     this.options = newOptions;</span>
<a href="#l2.185"></a><span id="l2.185">     return newOptions;</span>
<a href="#l2.186"></a><span id="l2.186">   },</span>
<a href="#l2.187"></a><span id="l2.187"> </span>
<a href="#l2.188"></a><span id="l2.188">   set options(aOptions) {</span>
<a href="#l2.189"></a><span id="l2.189">     let newOptions = aOptions ? aOptions : FeedUtils.optionsTemplate;</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineminus">-    let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineminus">-    newOptions = FeedUtils.rdf.GetLiteral(JSON.stringify(newOptions));</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineminus">-    let oldOptions = ds.GetTarget(this.resource, FeedUtils.FZ_OPTIONS, true);</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineminus">-    if (oldOptions) {</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineminus">-      ds.Change(this.resource, FeedUtils.FZ_OPTIONS, oldOptions, newOptions);</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineminus">-    } else {</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineminus">-      ds.Assert(this.resource, FeedUtils.FZ_OPTIONS, newOptions, true);</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineminus">-    }</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineplus">+    FeedUtils.setSubscriptionAttr(this.url, this.server, &quot;options&quot;, newOptions);</span>
<a href="#l2.199"></a><span id="l2.199">   },</span>
<a href="#l2.200"></a><span id="l2.200"> </span>
<a href="#l2.201"></a><span id="l2.201">   get link() {</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineminus">-    let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineminus">-    let link = ds.GetTarget(this.resource, FeedUtils.RSS_LINK, true);</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineminus">-    if (link) {</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineminus">-      link = link.QueryInterface(Ci.nsIRDFLiteral).Value;</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineminus">-    }</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineminus">-</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineminus">-    return link;</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineplus">+    return FeedUtils.getSubscriptionAttr(this.url, this.server, &quot;link&quot;, &quot;&quot;);</span>
<a href="#l2.210"></a><span id="l2.210">   },</span>
<a href="#l2.211"></a><span id="l2.211"> </span>
<a href="#l2.212"></a><span id="l2.212">   set link(aNewLink) {</span>
<a href="#l2.213"></a><span id="l2.213">     if (!aNewLink) {</span>
<a href="#l2.214"></a><span id="l2.214">       return;</span>
<a href="#l2.215"></a><span id="l2.215">     }</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineminus">-</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineminus">-    let ds = FeedUtils.getSubscriptionsDS(this.server);</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineminus">-    aNewLink = FeedUtils.rdf.GetLiteral(aNewLink);</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineminus">-    let old_link = ds.GetTarget(this.resource, FeedUtils.RSS_LINK, true);</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineminus">-    if (old_link) {</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineminus">-      ds.Change(this.resource, FeedUtils.RSS_LINK, old_link, aNewLink);</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineminus">-    } else {</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineminus">-      ds.Assert(this.resource, FeedUtils.RSS_LINK, aNewLink, true);</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineminus">-    }</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineplus">+    FeedUtils.setSubscriptionAttr(this.url, this.server, &quot;link&quot;, aNewLink);</span>
<a href="#l2.226"></a><span id="l2.226">   },</span>
<a href="#l2.227"></a><span id="l2.227"> </span>
<a href="#l2.228"></a><span id="l2.228">   parse() {</span>
<a href="#l2.229"></a><span id="l2.229">     // Create a feed parser which will parse the feed.</span>
<a href="#l2.230"></a><span id="l2.230">     let parser = new FeedParser();</span>
<a href="#l2.231"></a><span id="l2.231">     this.itemsToStore = parser.parseFeed(this, this.request.responseXML);</span>
<a href="#l2.232"></a><span id="l2.232">     parser = null;</span>
<a href="#l2.233"></a><span id="l2.233"> </span>
<a href="#l2.234"></a><span id="l2.234" class="difflineat">@@ -529,88 +454,78 @@ Feed.prototype = {</span>
<a href="#l2.235"></a><span id="l2.235">       return;</span>
<a href="#l2.236"></a><span id="l2.236">     }</span>
<a href="#l2.237"></a><span id="l2.237"> </span>
<a href="#l2.238"></a><span id="l2.238">     // We have an msgDatabase; storeNextItem() will iterate through the parsed</span>
<a href="#l2.239"></a><span id="l2.239">     // items, storing each one.</span>
<a href="#l2.240"></a><span id="l2.240">     this.storeNextItem();</span>
<a href="#l2.241"></a><span id="l2.241">   },</span>
<a href="#l2.242"></a><span id="l2.242"> </span>
<a href="#l2.243"></a><span id="l2.243" class="difflineplus">+  /**</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineplus">+   * Clear the 'valid' field of all feeditems associated with this feed.</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineplus">+   *</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineplus">+   * @returns {void}</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineplus">+   */</span>
<a href="#l2.248"></a><span id="l2.248">   invalidateItems() {</span>
<a href="#l2.249"></a><span id="l2.249">     let ds = FeedUtils.getItemsDS(this.server);</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineminus">-    FeedUtils.log.debug(&quot;Feed.invalidateItems: for url - &quot; + this.url);</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineminus">-    let items = ds.GetSources(FeedUtils.FZ_FEED, this.resource, true);</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineminus">-    let item;</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineminus">-</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineminus">-    while (items.hasMoreElements()) {</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineminus">-      item = items.getNext();</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineminus">-      item = item.QueryInterface(Ci.nsIRDFResource);</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineminus">-      FeedUtils.log.trace(&quot;Feed.invalidateItems: item - &quot; + item.Value);</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineminus">-      let valid = ds.GetTarget(item, FeedUtils.FZ_VALID, true);</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineminus">-      if (valid) {</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineminus">-        ds.Unassert(item, FeedUtils.FZ_VALID, valid, true);</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineplus">+    for (let id in ds.data) {</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineplus">+      let item = ds.data[id];</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineplus">+      if (item.feedURLs.includes(this.url)) {</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineplus">+        item.valid = false;</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineplus">+        FeedUtils.log.trace(&quot;Feed.invalidateItems: item - &quot; + id);</span>
<a href="#l2.266"></a><span id="l2.266">       }</span>
<a href="#l2.267"></a><span id="l2.267">     }</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineplus">+    ds.saveSoon();</span>
<a href="#l2.269"></a><span id="l2.269">   },</span>
<a href="#l2.270"></a><span id="l2.270"> </span>
<a href="#l2.271"></a><span id="l2.271" class="difflineplus">+  /**</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineplus">+   * Discards invalid items (in the feed item store) associated with the</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineplus">+   * feed. There's a delay - invalid items are kept around for a set time</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineplus">+   * before being purged.</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineplus">+   *</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineplus">+   * @param {Boolean} aDeleteFeed - is the feed being deleted (bypasses</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineplus">+   *                                the delay time).</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineplus">+   * @returns {void}</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineplus">+   */</span>
<a href="#l2.280"></a><span id="l2.280">   removeInvalidItems(aDeleteFeed) {</span>
<a href="#l2.281"></a><span id="l2.281">     let ds = FeedUtils.getItemsDS(this.server);</span>
<a href="#l2.282"></a><span id="l2.282">     FeedUtils.log.debug(&quot;Feed.removeInvalidItems: for url - &quot; + this.url);</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineminus">-    let items = ds.GetSources(FeedUtils.FZ_FEED, this.resource, true);</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineminus">-    let item;</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineplus">+</span>
<a href="#l2.286"></a><span id="l2.286">     let currentTime = new Date().getTime();</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineminus">-    while (items.hasMoreElements()) {</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineminus">-      item = items.getNext();</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineminus">-      item = item.QueryInterface(Ci.nsIRDFResource);</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineminus">-</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineminus">-      if (</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineminus">-        ds.HasAssertion(</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineminus">-          item,</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineminus">-          FeedUtils.FZ_VALID,</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineminus">-          FeedUtils.RDF_LITERAL_TRUE,</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineminus">-          true</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineminus">-        )</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineminus">-      ) {</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineplus">+    for (let id in ds.data) {</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineplus">+      let item = ds.data[id];</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineplus">+      // skip valid items and ones not part of this feed.</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineplus">+      if (!item.feedURLs.includes(this.url) || item.valid) {</span>
<a href="#l2.303"></a><span id="l2.303">         continue;</span>
<a href="#l2.304"></a><span id="l2.304">       }</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineminus">-</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineminus">-      let lastSeenTime = ds.GetTarget(</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineminus">-        item,</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineminus">-        FeedUtils.FZ_LAST_SEEN_TIMESTAMP,</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineminus">-        true</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineminus">-      );</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineminus">-      if (lastSeenTime) {</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineminus">-        lastSeenTime = parseInt(</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineminus">-          lastSeenTime.QueryInterface(Ci.nsIRDFLiteral).Value</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineminus">-        );</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineminus">-      } else {</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineminus">-        lastSeenTime = 0;</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineminus">-      }</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineplus">+      let lastSeenTime = item.lastSeenTime || 0;</span>
<a href="#l2.319"></a><span id="l2.319"> </span>
<a href="#l2.320"></a><span id="l2.320">       if (</span>
<a href="#l2.321"></a><span id="l2.321">         currentTime - lastSeenTime &lt; FeedUtils.INVALID_ITEM_PURGE_DELAY &amp;&amp;</span>
<a href="#l2.322"></a><span id="l2.322">         !aDeleteFeed</span>
<a href="#l2.323"></a><span id="l2.323">       ) {</span>
<a href="#l2.324"></a><span id="l2.324">         // Don't immediately purge items in active feeds; do so for deleted feeds.</span>
<a href="#l2.325"></a><span id="l2.325">         continue;</span>
<a href="#l2.326"></a><span id="l2.326">       }</span>
<a href="#l2.327"></a><span id="l2.327"> </span>
<a href="#l2.328"></a><span id="l2.328" class="difflineminus">-      FeedUtils.log.trace(&quot;Feed.removeInvalidItems: item - &quot; + item.Value);</span>
<a href="#l2.329"></a><span id="l2.329" class="difflineminus">-      ds.Unassert(item, FeedUtils.FZ_FEED, this.resource, true);</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineminus">-      if (ds.hasArcOut(item, FeedUtils.FZ_FEED)) {</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineplus">+      FeedUtils.log.trace(&quot;Feed.removeInvalidItems: item - &quot; + id);</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineplus">+      // Detach the item from this feed (it could be shared by multiple feeds).</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineplus">+      item.feedURLs = item.feedURLs.filter(url =&gt; url != this.url);</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineplus">+      if (item.feedURLs.length &gt; 0) {</span>
<a href="#l2.335"></a><span id="l2.335">         FeedUtils.log.debug(</span>
<a href="#l2.336"></a><span id="l2.336">           &quot;Feed.removeInvalidItems: &quot; +</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineminus">-            item.Value +</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineplus">+            id +</span>
<a href="#l2.339"></a><span id="l2.339">             &quot; is from more than one feed; only the reference to&quot; +</span>
<a href="#l2.340"></a><span id="l2.340">             &quot; this feed removed&quot;</span>
<a href="#l2.341"></a><span id="l2.341">         );</span>
<a href="#l2.342"></a><span id="l2.342">       } else {</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineminus">-        FeedUtils.removeAssertions(ds, item);</span>
<a href="#l2.344"></a><span id="l2.344" class="difflineplus">+        delete ds.data[id];</span>
<a href="#l2.345"></a><span id="l2.345">       }</span>
<a href="#l2.346"></a><span id="l2.346">     }</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineplus">+    ds.saveSoon();</span>
<a href="#l2.348"></a><span id="l2.348">   },</span>
<a href="#l2.349"></a><span id="l2.349"> </span>
<a href="#l2.350"></a><span id="l2.350">   createFolder() {</span>
<a href="#l2.351"></a><span id="l2.351">     if (this.folder) {</span>
<a href="#l2.352"></a><span id="l2.352">       return;</span>
<a href="#l2.353"></a><span id="l2.353">     }</span>
<a href="#l2.354"></a><span id="l2.354"> </span>
<a href="#l2.355"></a><span id="l2.355">     try {</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineat">@@ -717,17 +632,17 @@ Feed.prototype = {</span>
<a href="#l2.357"></a><span id="l2.357">       aFeed.removeInvalidItems(false);</span>
<a href="#l2.358"></a><span id="l2.358"> </span>
<a href="#l2.359"></a><span id="l2.359">       if (aCode == FeedUtils.kNewsBlogSuccess &amp;&amp; aFeed.mLastModified) {</span>
<a href="#l2.360"></a><span id="l2.360">         aFeed.lastModified = aFeed.mLastModified;</span>
<a href="#l2.361"></a><span id="l2.361">       }</span>
<a href="#l2.362"></a><span id="l2.362"> </span>
<a href="#l2.363"></a><span id="l2.363">       // Flush any feed item changes to disk.</span>
<a href="#l2.364"></a><span id="l2.364">       let ds = FeedUtils.getItemsDS(aFeed.server);</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineminus">-      ds.Flush();</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineplus">+      ds.saveSoon();</span>
<a href="#l2.367"></a><span id="l2.367">       FeedUtils.log.debug(</span>
<a href="#l2.368"></a><span id="l2.368">         &quot;Feed.cleanupParsingState: items stored - &quot; + this.itemsStored</span>
<a href="#l2.369"></a><span id="l2.369">       );</span>
<a href="#l2.370"></a><span id="l2.370">     }</span>
<a href="#l2.371"></a><span id="l2.371"> </span>
<a href="#l2.372"></a><span id="l2.372">     // Force the xml http request to go away.  This helps reduce some nasty</span>
<a href="#l2.373"></a><span id="l2.373">     // assertions on shut down.</span>
<a href="#l2.374"></a><span id="l2.374">     this.request = null;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/FeedItem.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/FeedItem.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -77,40 +77,48 @@ FeedItem.prototype = {</span>
<a href="#l3.4"></a><span id="l3.4">     messageID = &quot;&lt;&quot; + messageID.trim() + &quot;@localhost.localdomain&gt;&quot;;</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6">     FeedUtils.log.trace(</span>
<a href="#l3.7"></a><span id="l3.7">       &quot;FeedItem.normalizeMessageID: messageID - &quot; + messageID</span>
<a href="#l3.8"></a><span id="l3.8">     );</span>
<a href="#l3.9"></a><span id="l3.9">     return messageID;</span>
<a href="#l3.10"></a><span id="l3.10">   },</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  get itemUniqueURI() {</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-    return this.createURN(this.id);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-  },</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-</span>
<a href="#l3.16"></a><span id="l3.16">   get contentBase() {</span>
<a href="#l3.17"></a><span id="l3.17">     if (this.xmlContentBase) {</span>
<a href="#l3.18"></a><span id="l3.18">       return this.xmlContentBase;</span>
<a href="#l3.19"></a><span id="l3.19">     }</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21">     return this.mURL;</span>
<a href="#l3.22"></a><span id="l3.22">   },</span>
<a href="#l3.23"></a><span id="l3.23"> </span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+  /**</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+   * Writes the item to the folder as a message and updates the feeditems db.</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+   *</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+   * @returns {void}</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+   */</span>
<a href="#l3.29"></a><span id="l3.29">   store() {</span>
<a href="#l3.30"></a><span id="l3.30">     // this.title and this.content contain HTML.</span>
<a href="#l3.31"></a><span id="l3.31">     // this.mUrl and this.contentBase contain plain text.</span>
<a href="#l3.32"></a><span id="l3.32"> </span>
<a href="#l3.33"></a><span id="l3.33">     let stored = false;</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+    let ds = FeedUtils.getItemsDS(this.feed.server);</span>
<a href="#l3.35"></a><span id="l3.35">     let resource = this.findStoredResource();</span>
<a href="#l3.36"></a><span id="l3.36">     if (!this.feed.folder) {</span>
<a href="#l3.37"></a><span id="l3.37">       return stored;</span>
<a href="#l3.38"></a><span id="l3.38">     }</span>
<a href="#l3.39"></a><span id="l3.39"> </span>
<a href="#l3.40"></a><span id="l3.40">     if (resource == null) {</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-      resource = FeedUtils.rdf.GetResource(this.itemUniqueURI);</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+      resource = {</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+        feedURLs: [this.feed.url],</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+        lastSeenTime: 0,</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+        valid: false,</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+        stored: false,</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+      };</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+      ds.data[this.url] = resource;</span>
<a href="#l3.49"></a><span id="l3.49">       if (!this.content) {</span>
<a href="#l3.50"></a><span id="l3.50">         FeedUtils.log.trace(</span>
<a href="#l3.51"></a><span id="l3.51">           &quot;FeedItem.store: &quot; +</span>
<a href="#l3.52"></a><span id="l3.52">             this.identity +</span>
<a href="#l3.53"></a><span id="l3.53">             &quot; no content; storing description or title&quot;</span>
<a href="#l3.54"></a><span id="l3.54">         );</span>
<a href="#l3.55"></a><span id="l3.55">         this.content = this.description || this.title;</span>
<a href="#l3.56"></a><span id="l3.56">       }</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineat">@@ -121,16 +129,17 @@ FeedItem.prototype = {</span>
<a href="#l3.58"></a><span id="l3.58">       content = content.replace(/%CONTENT%/, this.content);</span>
<a href="#l3.59"></a><span id="l3.59">       this.content = content;</span>
<a href="#l3.60"></a><span id="l3.60">       this.writeToFolder();</span>
<a href="#l3.61"></a><span id="l3.61">       this.markStored(resource);</span>
<a href="#l3.62"></a><span id="l3.62">       stored = true;</span>
<a href="#l3.63"></a><span id="l3.63">     }</span>
<a href="#l3.64"></a><span id="l3.64"> </span>
<a href="#l3.65"></a><span id="l3.65">     this.markValid(resource);</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+    ds.saveSoon();</span>
<a href="#l3.67"></a><span id="l3.67">     return stored;</span>
<a href="#l3.68"></a><span id="l3.68">   },</span>
<a href="#l3.69"></a><span id="l3.69"> </span>
<a href="#l3.70"></a><span id="l3.70">   findStoredResource() {</span>
<a href="#l3.71"></a><span id="l3.71">     // Checks to see if the item has already been stored in its feed's</span>
<a href="#l3.72"></a><span id="l3.72">     // message folder.</span>
<a href="#l3.73"></a><span id="l3.73">     FeedUtils.log.trace(</span>
<a href="#l3.74"></a><span id="l3.74">       &quot;FeedItem.findStoredResource: checking if stored - &quot; + this.identity</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineat">@@ -147,118 +156,41 @@ FeedItem.prototype = {</span>
<a href="#l3.76"></a><span id="l3.76">           server.rootMsgFolder.prettyName +</span>
<a href="#l3.77"></a><span id="l3.77">           &quot;\n&quot;</span>
<a href="#l3.78"></a><span id="l3.78">       );</span>
<a href="#l3.79"></a><span id="l3.79">       this.feed.createFolder();</span>
<a href="#l3.80"></a><span id="l3.80">       return null;</span>
<a href="#l3.81"></a><span id="l3.81">     }</span>
<a href="#l3.82"></a><span id="l3.82"> </span>
<a href="#l3.83"></a><span id="l3.83">     let ds = FeedUtils.getItemsDS(server);</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-    let itemURI = this.itemUniqueURI;</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-    let itemResource = FeedUtils.rdf.GetResource(itemURI);</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-    let downloaded = ds.GetTarget(itemResource, FeedUtils.FZ_STORED, true);</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-    if (</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-      !downloaded ||</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-      downloaded.QueryInterface(Ci.nsIRDFLiteral).Value == &quot;false&quot;</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-    ) {</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+    let item = ds.data[this.url];</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+    if (!item || !item.stored) {</span>
<a href="#l3.95"></a><span id="l3.95">       FeedUtils.log.trace(&quot;FeedItem.findStoredResource: not stored&quot;);</span>
<a href="#l3.96"></a><span id="l3.96">       return null;</span>
<a href="#l3.97"></a><span id="l3.97">     }</span>
<a href="#l3.98"></a><span id="l3.98"> </span>
<a href="#l3.99"></a><span id="l3.99">     FeedUtils.log.trace(&quot;FeedItem.findStoredResource: already stored&quot;);</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-    return itemResource;</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+    return item;</span>
<a href="#l3.102"></a><span id="l3.102">   },</span>
<a href="#l3.103"></a><span id="l3.103"> </span>
<a href="#l3.104"></a><span id="l3.104">   markValid(resource) {</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineminus">-    let ds = FeedUtils.getItemsDS(this.feed.server);</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineminus">-</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineminus">-    let newTimeStamp = FeedUtils.rdf.GetLiteral(new Date().getTime());</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineminus">-    let currentTimeStamp = ds.GetTarget(</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">-      resource,</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-      FeedUtils.FZ_LAST_SEEN_TIMESTAMP,</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineminus">-      true</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-    );</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineminus">-    if (currentTimeStamp) {</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineminus">-      ds.Change(</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-        resource,</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineminus">-        FeedUtils.FZ_LAST_SEEN_TIMESTAMP,</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineminus">-        currentTimeStamp,</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineminus">-        newTimeStamp</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineminus">-      );</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineminus">-    } else {</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-      ds.Assert(resource, FeedUtils.FZ_LAST_SEEN_TIMESTAMP, newTimeStamp, true);</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+    resource.lastSeenTime = new Date().getTime();</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+    // Items can be in multiple feeds.</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+    if (!resource.feedURLs.includes(this.feed.url)) {</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+      resource.feedURLs.push(this.feed.url);</span>
<a href="#l3.126"></a><span id="l3.126">     }</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-    if (</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineminus">-      !ds.HasAssertion(</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineminus">-        resource,</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-        FeedUtils.FZ_FEED,</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-        FeedUtils.rdf.GetResource(this.feed.url),</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineminus">-        true</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-      )</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineminus">-    ) {</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineminus">-      ds.Assert(</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineminus">-        resource,</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineminus">-        FeedUtils.FZ_FEED,</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineminus">-        FeedUtils.rdf.GetResource(this.feed.url),</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-        true</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-      );</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineminus">-    }</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineminus">-</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineminus">-    if (ds.hasArcOut(resource, FeedUtils.FZ_VALID)) {</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineminus">-      let currentValue = ds.GetTarget(resource, FeedUtils.FZ_VALID, true);</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineminus">-      ds.Change(</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineminus">-        resource,</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineminus">-        FeedUtils.FZ_VALID,</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-        currentValue,</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineminus">-        FeedUtils.RDF_LITERAL_TRUE</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineminus">-      );</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineminus">-    } else {</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineminus">-      ds.Assert(resource, FeedUtils.FZ_VALID, FeedUtils.RDF_LITERAL_TRUE, true);</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-    }</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+    resource.valid = true;</span>
<a href="#l3.156"></a><span id="l3.156">   },</span>
<a href="#l3.157"></a><span id="l3.157"> </span>
<a href="#l3.158"></a><span id="l3.158">   markStored(resource) {</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-    let ds = FeedUtils.getItemsDS(this.feed.server);</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">-</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">-    if (</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-      !ds.HasAssertion(</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-        resource,</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineminus">-        FeedUtils.FZ_FEED,</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineminus">-        FeedUtils.rdf.GetResource(this.feed.url),</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineminus">-        true</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineminus">-      )</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineminus">-    ) {</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineminus">-      ds.Assert(</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineminus">-        resource,</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineminus">-        FeedUtils.FZ_FEED,</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineminus">-        FeedUtils.rdf.GetResource(this.feed.url),</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineminus">-        true</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-      );</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineplus">+    // Items can be in multiple feeds.</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+    if (!resource.feedURLs.includes(this.feed.url)) {</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+      resource.feedURLs.push(this.feed.url);</span>
<a href="#l3.178"></a><span id="l3.178">     }</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineminus">-</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineminus">-    let currentValue;</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineminus">-    if (ds.hasArcOut(resource, FeedUtils.FZ_STORED)) {</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineminus">-      currentValue = ds.GetTarget(resource, FeedUtils.FZ_STORED, true);</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineminus">-      ds.Change(</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineminus">-        resource,</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-        FeedUtils.FZ_STORED,</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineminus">-        currentValue,</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineminus">-        FeedUtils.RDF_LITERAL_TRUE</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineminus">-      );</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineminus">-    } else {</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineminus">-      ds.Assert(</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineminus">-        resource,</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineminus">-        FeedUtils.FZ_STORED,</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineminus">-        FeedUtils.RDF_LITERAL_TRUE,</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineminus">-        true</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineminus">-      );</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineminus">-    }</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineplus">+    resource.stored = true;</span>
<a href="#l3.198"></a><span id="l3.198">   },</span>
<a href="#l3.199"></a><span id="l3.199"> </span>
<a href="#l3.200"></a><span id="l3.200">   writeToFolder() {</span>
<a href="#l3.201"></a><span id="l3.201">     FeedUtils.log.trace(</span>
<a href="#l3.202"></a><span id="l3.202">       &quot;FeedItem.writeToFolder: &quot; +</span>
<a href="#l3.203"></a><span id="l3.203">         this.identity +</span>
<a href="#l3.204"></a><span id="l3.204">         &quot; writing to message folder &quot; +</span>
<a href="#l3.205"></a><span id="l3.205">         this.feed.name</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineat">@@ -486,35 +418,16 @@ FeedItem.prototype = {</span>
<a href="#l3.207"></a><span id="l3.207">   htmlEscape(s) {</span>
<a href="#l3.208"></a><span id="l3.208">     s = s.replace(/&amp;/g, &quot;&amp;amp;&quot;);</span>
<a href="#l3.209"></a><span id="l3.209">     s = s.replace(/&gt;/g, &quot;&amp;gt;&quot;);</span>
<a href="#l3.210"></a><span id="l3.210">     s = s.replace(/&lt;/g, &quot;&amp;lt;&quot;);</span>
<a href="#l3.211"></a><span id="l3.211">     s = s.replace(/'/g, &quot;&amp;#39;&quot;);</span>
<a href="#l3.212"></a><span id="l3.212">     s = s.replace(/&quot;/g, &quot;&amp;quot;&quot;);</span>
<a href="#l3.213"></a><span id="l3.213">     return s;</span>
<a href="#l3.214"></a><span id="l3.214">   },</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineminus">-</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineminus">-  createURN(aName) {</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineminus">-    // Returns name as a URN in the 'feeditem' namespace. The returned URN is</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineminus">-    // (or is intended to be) RFC2141 compliant.</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineminus">-    // The builtin encodeURI provides nearly the exact encoding functionality</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineminus">-    // required by the RFC.  The exceptions are that NULL characters should not</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineminus">-    // appear, and that #, /, ?, &amp;, and ~ should be escaped.</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineminus">-    // NULL characters are removed before encoding.</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineminus">-</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineminus">-    let name = aName.replace(/\0/g, &quot;&quot;);</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineminus">-    let encoded = encodeURI(name);</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineminus">-    encoded = encoded.replace(/\#/g, &quot;%23&quot;);</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineminus">-    encoded = encoded.replace(/\//g, &quot;%2f&quot;);</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineminus">-    encoded = encoded.replace(/\?/g, &quot;%3f&quot;);</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineminus">-    encoded = encoded.replace(/\&amp;/g, &quot;%26&quot;);</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineminus">-    encoded = encoded.replace(/\~/g, &quot;%7e&quot;);</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineminus">-</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineminus">-    return FeedUtils.FZ_ITEM_NS + encoded;</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineminus">-  },</span>
<a href="#l3.234"></a><span id="l3.234"> };</span>
<a href="#l3.235"></a><span id="l3.235"> </span>
<a href="#l3.236"></a><span id="l3.236"> // A feed enclosure is to RSS what an attachment is for e-mail.  We make</span>
<a href="#l3.237"></a><span id="l3.237"> // enclosures look like attachments in the UI.</span>
<a href="#l3.238"></a><span id="l3.238"> function FeedEnclosure(aURL, aContentType, aLength, aTitle) {</span>
<a href="#l3.239"></a><span id="l3.239">   this.mURL = aURL;</span>
<a href="#l3.240"></a><span id="l3.240">   // Store a reasonable mimetype if content-type is not present.</span>
<a href="#l3.241"></a><span id="l3.241">   this.mContentType = aContentType || &quot;application/unknown&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/FeedUtils.jsm</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/FeedUtils.jsm</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -7,140 +7,56 @@ this.EXPORTED_SYMBOLS = [&quot;Feed&quot;, &quot;FeedIt</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> /* eslint-disable-next-line no-unused-vars */</span>
<a href="#l4.6"></a><span id="l4.6"> const { Log4Moz } = ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l4.7"></a><span id="l4.7"> const { MailServices } = ChromeUtils.import(</span>
<a href="#l4.8"></a><span id="l4.8">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l4.9"></a><span id="l4.9"> );</span>
<a href="#l4.10"></a><span id="l4.10"> const { MailUtils } = ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l4.11"></a><span id="l4.11"> const { jsmime } = ChromeUtils.import(&quot;resource:///modules/jsmime.jsm&quot;);</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-const { FileUtils } = ChromeUtils.import(</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-  &quot;resource://gre/modules/FileUtils.jsm&quot;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-);</span>
<a href="#l4.15"></a><span id="l4.15"> const { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.16"></a><span id="l4.16"> const { XPCOMUtils } = ChromeUtils.import(</span>
<a href="#l4.17"></a><span id="l4.17">   &quot;resource://gre/modules/XPCOMUtils.jsm&quot;</span>
<a href="#l4.18"></a><span id="l4.18"> );</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+const { JSONFile } = ChromeUtils.import(&quot;resource://gre/modules/JSONFile.jsm&quot;);</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21"> Services.scriptloader.loadSubScript(</span>
<a href="#l4.22"></a><span id="l4.22">   &quot;chrome://messenger-newsblog/content/Feed.js&quot;</span>
<a href="#l4.23"></a><span id="l4.23"> );</span>
<a href="#l4.24"></a><span id="l4.24"> Services.scriptloader.loadSubScript(</span>
<a href="#l4.25"></a><span id="l4.25">   &quot;chrome://messenger-newsblog/content/FeedItem.js&quot;</span>
<a href="#l4.26"></a><span id="l4.26"> );</span>
<a href="#l4.27"></a><span id="l4.27"> Services.scriptloader.loadSubScript(</span>
<a href="#l4.28"></a><span id="l4.28">   &quot;chrome://messenger-newsblog/content/feed-parser.js&quot;</span>
<a href="#l4.29"></a><span id="l4.29"> );</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31"> var FeedUtils = {</span>
<a href="#l4.32"></a><span id="l4.32">   MOZ_PARSERERROR_NS: &quot;http://www.mozilla.org/newlayout/xml/parsererror.xml&quot;,</span>
<a href="#l4.33"></a><span id="l4.33"> </span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-  /* eslint-disable no-multi-spaces */</span>
<a href="#l4.35"></a><span id="l4.35">   RDF_SYNTAX_NS: &quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;,</span>
<a href="#l4.36"></a><span id="l4.36">   RDF_SYNTAX_TYPE: &quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#type&quot;,</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-  get RDF_TYPE() {</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-    return this.rdf.GetResource(this.RDF_SYNTAX_TYPE);</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-  },</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-</span>
<a href="#l4.41"></a><span id="l4.41">   RSS_090_NS: &quot;http://my.netscape.com/rdf/simple/0.9/&quot;,</span>
<a href="#l4.42"></a><span id="l4.42"> </span>
<a href="#l4.43"></a><span id="l4.43">   RSS_NS: &quot;http://purl.org/rss/1.0/&quot;,</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-  get RSS_CHANNEL() {</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-    return this.rdf.GetResource(this.RSS_NS + &quot;channel&quot;);</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-  },</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-  get RSS_TITLE() {</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-    return this.rdf.GetResource(this.RSS_NS + &quot;title&quot;);</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-  },</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-  get RSS_DESCRIPTION() {</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-    return this.rdf.GetResource(this.RSS_NS + &quot;description&quot;);</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-  },</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-  get RSS_ITEMS() {</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-    return this.rdf.GetResource(this.RSS_NS + &quot;items&quot;);</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-  },</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-  get RSS_ITEM() {</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-    return this.rdf.GetResource(this.RSS_NS + &quot;item&quot;);</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineminus">-  },</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-  get RSS_LINK() {</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-    return this.rdf.GetResource(this.RSS_NS + &quot;link&quot;);</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-  },</span>
<a href="#l4.62"></a><span id="l4.62"> </span>
<a href="#l4.63"></a><span id="l4.63">   RSS_CONTENT_NS: &quot;http://purl.org/rss/1.0/modules/content/&quot;,</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineminus">-  get RSS_CONTENT_ENCODED() {</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineminus">-    return this.rdf.GetResource(this.RSS_CONTENT_NS + &quot;encoded&quot;);</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-  },</span>
<a href="#l4.67"></a><span id="l4.67"> </span>
<a href="#l4.68"></a><span id="l4.68">   RSS_SY_NS: &quot;http://purl.org/rss/1.0/modules/syndication/&quot;,</span>
<a href="#l4.69"></a><span id="l4.69">   RSS_SY_UNITS: [&quot;hourly&quot;, &quot;daily&quot;, &quot;weekly&quot;, &quot;monthly&quot;, &quot;yearly&quot;],</span>
<a href="#l4.70"></a><span id="l4.70">   kBiffUnitsMinutes: &quot;min&quot;,</span>
<a href="#l4.71"></a><span id="l4.71">   kBiffUnitsDays: &quot;d&quot;,</span>
<a href="#l4.72"></a><span id="l4.72"> </span>
<a href="#l4.73"></a><span id="l4.73">   DC_NS: &quot;http://purl.org/dc/elements/1.1/&quot;,</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-  get DC_PUBLISHER() {</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-    return this.rdf.GetResource(this.DC_NS + &quot;publisher&quot;);</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-  },</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-  get DC_CREATOR() {</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-    return this.rdf.GetResource(this.DC_NS + &quot;creator&quot;);</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineminus">-  },</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineminus">-  get DC_SUBJECT() {</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-    return this.rdf.GetResource(this.DC_NS + &quot;subject&quot;);</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-  },</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineminus">-  get DC_DATE() {</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineminus">-    return this.rdf.GetResource(this.DC_NS + &quot;date&quot;);</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineminus">-  },</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineminus">-  get DC_TITLE() {</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineminus">-    return this.rdf.GetResource(this.DC_NS + &quot;title&quot;);</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineminus">-  },</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineminus">-  get DC_LASTMODIFIED() {</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineminus">-    return this.rdf.GetResource(this.DC_NS + &quot;lastModified&quot;);</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineminus">-  },</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineminus">-  get DC_IDENTIFIER() {</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineminus">-    return this.rdf.GetResource(this.DC_NS + &quot;identifier&quot;);</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineminus">-  },</span>
<a href="#l4.95"></a><span id="l4.95"> </span>
<a href="#l4.96"></a><span id="l4.96">   MRSS_NS: &quot;http://search.yahoo.com/mrss/&quot;,</span>
<a href="#l4.97"></a><span id="l4.97">   FEEDBURNER_NS: &quot;http://rssnamespace.org/feedburner/ext/1.0&quot;,</span>
<a href="#l4.98"></a><span id="l4.98">   ITUNES_NS: &quot;http://www.itunes.com/dtds/podcast-1.0.dtd&quot;,</span>
<a href="#l4.99"></a><span id="l4.99"> </span>
<a href="#l4.100"></a><span id="l4.100">   FZ_NS: &quot;urn:forumzilla:&quot;,</span>
<a href="#l4.101"></a><span id="l4.101">   FZ_ITEM_NS: &quot;urn:feeditem:&quot;,</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineminus">-  get FZ_ROOT() {</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineminus">-    return this.rdf.GetResource(this.FZ_NS + &quot;root&quot;);</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineminus">-  },</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineminus">-  get FZ_FEEDS() {</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineminus">-    return this.rdf.GetResource(this.FZ_NS + &quot;feeds&quot;);</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineminus">-  },</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineminus">-  get FZ_FEED() {</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineminus">-    return this.rdf.GetResource(this.FZ_NS + &quot;feed&quot;);</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineminus">-  },</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineminus">-  get FZ_QUICKMODE() {</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineminus">-    return this.rdf.GetResource(this.FZ_NS + &quot;quickMode&quot;);</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineminus">-  },</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineminus">-  get FZ_DESTFOLDER() {</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineminus">-    return this.rdf.GetResource(this.FZ_NS + &quot;destFolder&quot;);</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineminus">-  },</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineminus">-  get FZ_STORED() {</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineminus">-    return this.rdf.GetResource(this.FZ_NS + &quot;stored&quot;);</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineminus">-  },</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineminus">-  get FZ_VALID() {</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineminus">-    return this.rdf.GetResource(this.FZ_NS + &quot;valid&quot;);</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineminus">-  },</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineminus">-  get FZ_OPTIONS() {</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineminus">-    return this.rdf.GetResource(this.FZ_NS + &quot;options&quot;);</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineminus">-  },</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineminus">-  get FZ_LAST_SEEN_TIMESTAMP() {</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineminus">-    return this.rdf.GetResource(this.FZ_NS + &quot;last-seen-timestamp&quot;);</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineminus">-  },</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineminus">-</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineminus">-  get RDF_LITERAL_TRUE() {</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineminus">-    return this.rdf.GetLiteral(&quot;true&quot;);</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineminus">-  },</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineminus">-  get RDF_LITERAL_FALSE() {</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineminus">-    return this.rdf.GetLiteral(&quot;false&quot;);</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineminus">-  },</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineminus">-  /* eslint-enable no-multi-spaces */</span>
<a href="#l4.137"></a><span id="l4.137"> </span>
<a href="#l4.138"></a><span id="l4.138">   // Atom constants</span>
<a href="#l4.139"></a><span id="l4.139">   ATOM_03_NS: &quot;http://purl.org/atom/ns#&quot;,</span>
<a href="#l4.140"></a><span id="l4.140">   ATOM_IETF_NS: &quot;http://www.w3.org/2005/Atom&quot;,</span>
<a href="#l4.141"></a><span id="l4.141">   ATOM_THREAD_NS: &quot;http://purl.org/syndication/thread/1.0&quot;,</span>
<a href="#l4.142"></a><span id="l4.142"> </span>
<a href="#l4.143"></a><span id="l4.143">   // Accept content mimetype preferences for feeds.</span>
<a href="#l4.144"></a><span id="l4.144">   REQUEST_ACCEPT:</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineat">@@ -162,17 +78,17 @@ var FeedUtils = {</span>
<a href="#l4.146"></a><span id="l4.146">       return Services.prefs.getIntPref(pref);</span>
<a href="#l4.147"></a><span id="l4.147">     }</span>
<a href="#l4.148"></a><span id="l4.148"> </span>
<a href="#l4.149"></a><span id="l4.149">     Services.prefs.setIntPref(pref, FeedUtils.kMaxConcurrentFeeds);</span>
<a href="#l4.150"></a><span id="l4.150">     return FeedUtils.kMaxConcurrentFeeds;</span>
<a href="#l4.151"></a><span id="l4.151">   },</span>
<a href="#l4.152"></a><span id="l4.152"> </span>
<a href="#l4.153"></a><span id="l4.153">   // The amount of time, specified in milliseconds, to leave an item in the</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineminus">-  // feeditems.rdf cache after the item has disappeared from the publisher's</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+  // feeditems cache after the item has disappeared from the publisher's</span>
<a href="#l4.156"></a><span id="l4.156">   // file. The default delay is one day.</span>
<a href="#l4.157"></a><span id="l4.157">   kInvalidItemPurgeDelayDays: 1,</span>
<a href="#l4.158"></a><span id="l4.158">   get INVALID_ITEM_PURGE_DELAY() {</span>
<a href="#l4.159"></a><span id="l4.159">     let pref = &quot;rss.invalid_item_purge_delay_days&quot;;</span>
<a href="#l4.160"></a><span id="l4.160">     if (Services.prefs.prefHasUserValue(pref)) {</span>
<a href="#l4.161"></a><span id="l4.161">       return Services.prefs.getIntPref(pref) * this.MILLISECONDS_PER_DAY;</span>
<a href="#l4.162"></a><span id="l4.162">     }</span>
<a href="#l4.163"></a><span id="l4.163"> </span>
<a href="#l4.164"></a><span id="l4.164" class="difflineat">@@ -296,25 +212,21 @@ var FeedUtils = {</span>
<a href="#l4.165"></a><span id="l4.165">    * user from subscribing to the same feed multiple times for the same server.</span>
<a href="#l4.166"></a><span id="l4.166">    *</span>
<a href="#l4.167"></a><span id="l4.167">    * @param {String} aUrl                  - The url.</span>
<a href="#l4.168"></a><span id="l4.168">    * @param {nsIMsgIncomingServer} aServer - Account server.</span>
<a href="#l4.169"></a><span id="l4.169">    * @returns {Boolean}                    - true if exists else false.</span>
<a href="#l4.170"></a><span id="l4.170">    */</span>
<a href="#l4.171"></a><span id="l4.171">   feedAlreadyExists(aUrl, aServer) {</span>
<a href="#l4.172"></a><span id="l4.172">     let ds = this.getSubscriptionsDS(aServer);</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineminus">-    let feeds = this.getSubscriptionsList(ds);</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineminus">-    let resource = this.rdf.GetResource(aUrl);</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineminus">-    if (feeds.IndexOf(resource) == -1) {</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+    let sub = ds.data.find(x =&gt; x.url == aUrl);</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+    if (sub === undefined) {</span>
<a href="#l4.178"></a><span id="l4.178">       return false;</span>
<a href="#l4.179"></a><span id="l4.179">     }</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineminus">-</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineminus">-    let folder = ds</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineminus">-      .GetTarget(resource, FeedUtils.FZ_DESTFOLDER, true)</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineminus">-      .QueryInterface(Ci.nsIRDFResource).ValueUTF8;</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineplus">+    let folder = sub.destFolder;</span>
<a href="#l4.185"></a><span id="l4.185">     this.log.info(</span>
<a href="#l4.186"></a><span id="l4.186">       &quot;FeedUtils.feedAlreadyExists: feed url &quot; +</span>
<a href="#l4.187"></a><span id="l4.187">         aUrl +</span>
<a href="#l4.188"></a><span id="l4.188">         &quot; subscribed in folder url &quot; +</span>
<a href="#l4.189"></a><span id="l4.189">         decodeURI(folder)</span>
<a href="#l4.190"></a><span id="l4.190">     );</span>
<a href="#l4.191"></a><span id="l4.191"> </span>
<a href="#l4.192"></a><span id="l4.192">     return true;</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineat">@@ -668,110 +580,69 @@ var FeedUtils = {</span>
<a href="#l4.194"></a><span id="l4.194">       win.FeedSubscriptions.refreshSubscriptionView();</span>
<a href="#l4.195"></a><span id="l4.195">       if (curItem.container) {</span>
<a href="#l4.196"></a><span id="l4.196">         win.FeedSubscriptions.selectFolder(curItem.folder);</span>
<a href="#l4.197"></a><span id="l4.197">       } else {</span>
<a href="#l4.198"></a><span id="l4.198">         let feed = new Feed(curItem.url, curItem.parentFolder);</span>
<a href="#l4.199"></a><span id="l4.199">         win.FeedSubscriptions.selectFeed(feed);</span>
<a href="#l4.200"></a><span id="l4.200">       }</span>
<a href="#l4.201"></a><span id="l4.201">     }</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineminus">-</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineminus">-    this.getSubscriptionsDS(aFolder.server).Flush();</span>
<a href="#l4.204"></a><span id="l4.204">   },</span>
<a href="#l4.205"></a><span id="l4.205"> </span>
<a href="#l4.206"></a><span id="l4.206">   /**</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineminus">-   * Add a feed record to the feeds.rdf database and update the folder's feedUrl</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineplus">+   * Add a feed record to the feeds database and update the folder's feedUrl</span>
<a href="#l4.209"></a><span id="l4.209">    * property.</span>
<a href="#l4.210"></a><span id="l4.210">    *</span>
<a href="#l4.211"></a><span id="l4.211">    * @param {Feed} aFeed - Our feed object.</span>
<a href="#l4.212"></a><span id="l4.212">    *</span>
<a href="#l4.213"></a><span id="l4.213">    * @returns {void}</span>
<a href="#l4.214"></a><span id="l4.214">    */</span>
<a href="#l4.215"></a><span id="l4.215">   addFeed(aFeed) {</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineplus">+    // Find or create subscription entry.</span>
<a href="#l4.217"></a><span id="l4.217">     let ds = this.getSubscriptionsDS(aFeed.server);</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineminus">-    let feeds = this.getSubscriptionsList(ds);</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineminus">-</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineminus">-    // Generate a unique ID for the feed.</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineminus">-    let id = aFeed.url;</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineminus">-    let i = 1;</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineminus">-    while (feeds.IndexOf(this.rdf.GetResource(id)) != -1 &amp;&amp; ++i &lt; 1000) {</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineminus">-      id = aFeed.url + i;</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineminus">-    }</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineminus">-</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineminus">-    if (i == 1000) {</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineminus">-      throw new Error(</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineminus">-        &quot;FeedUtils.addFeed: couldn't generate a unique ID &quot; +</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineminus">-          &quot;for feed &quot; +</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineminus">-          aFeed.url</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineminus">-      );</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineplus">+    let sub = ds.data.find(x =&gt; x.url == aFeed.url);</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineplus">+    if (sub === undefined) {</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineplus">+      sub = {};</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineplus">+      ds.data.push(sub);</span>
<a href="#l4.237"></a><span id="l4.237">     }</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineminus">-</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineminus">-    // Add the feed to the list.</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineminus">-    let feedResource = this.rdf.GetResource(id);</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineminus">-    feeds.AppendElement(feedResource);</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineminus">-    ds.Assert(feedResource, this.RDF_TYPE, this.FZ_FEED, true);</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineminus">-    ds.Assert(</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineminus">-      feedResource,</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineminus">-      this.DC_IDENTIFIER,</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineminus">-      this.rdf.GetLiteral(aFeed.url),</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineminus">-      true</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineminus">-    );</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineplus">+    sub.url = aFeed.url;</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineplus">+    sub.destFolder = aFeed.folder.URI;</span>
<a href="#l4.251"></a><span id="l4.251">     if (aFeed.title) {</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineminus">-      ds.Assert(</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineminus">-        feedResource,</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineminus">-        this.DC_TITLE,</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineminus">-        this.rdf.GetLiteral(aFeed.title),</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineminus">-        true</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineminus">-      );</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineplus">+      sub.title = aFeed.title;</span>
<a href="#l4.259"></a><span id="l4.259">     }</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineminus">-</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineminus">-    ds.Assert(feedResource, this.FZ_DESTFOLDER, aFeed.folder, true);</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineminus">-    ds.Flush();</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineplus">+    ds.saveSoon();</span>
<a href="#l4.264"></a><span id="l4.264"> </span>
<a href="#l4.265"></a><span id="l4.265">     // Update folderpane.</span>
<a href="#l4.266"></a><span id="l4.266">     this.setFolderPaneProperty(aFeed.folder, &quot;favicon&quot;, null, &quot;row&quot;);</span>
<a href="#l4.267"></a><span id="l4.267">   },</span>
<a href="#l4.268"></a><span id="l4.268"> </span>
<a href="#l4.269"></a><span id="l4.269">   /**</span>
<a href="#l4.270"></a><span id="l4.270" class="difflineminus">-   * Delete a feed record from the feeds.rdf database and update the folder's</span>
<a href="#l4.271"></a><span id="l4.271" class="difflineplus">+   * Delete a feed record from the feeds database and update the folder's</span>
<a href="#l4.272"></a><span id="l4.272">    * feedUrl property.</span>
<a href="#l4.273"></a><span id="l4.273">    *</span>
<a href="#l4.274"></a><span id="l4.274">    * @param {Feed} aFeed - Our feed object.</span>
<a href="#l4.275"></a><span id="l4.275">    *</span>
<a href="#l4.276"></a><span id="l4.276">    * @returns {void}</span>
<a href="#l4.277"></a><span id="l4.277">    */</span>
<a href="#l4.278"></a><span id="l4.278">   deleteFeed(aFeed) {</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineminus">-    let ds = this.getSubscriptionsDS(aFeed.server);</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineminus">-</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineminus">-    // Remove the feed from the subscriptions ds.</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineminus">-    let feeds = this.getSubscriptionsList(ds);</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineminus">-    let index = feeds.IndexOf(aFeed.resource);</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineminus">-    if (index != -1) {</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineminus">-      feeds.RemoveElementAt(index, false);</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineminus">-    }</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineminus">-</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineminus">-    // Remove all assertions about the feed from the subscriptions database.</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineminus">-    this.removeAssertions(ds, aFeed.resource);</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineminus">-    ds.Flush();</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineminus">-</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineminus">-    // Remove all assertions about items in the feed from the items database.</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineminus">-    let itemds = this.getItemsDS(aFeed.server);</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineplus">+    // Remove items associated with this feed from the items db.</span>
<a href="#l4.295"></a><span id="l4.295">     aFeed.invalidateItems();</span>
<a href="#l4.296"></a><span id="l4.296">     aFeed.removeInvalidItems(true);</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineminus">-    itemds.Flush();</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineplus">+</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineplus">+    // Remove the entry in the subscriptions db.</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineplus">+    let ds = this.getSubscriptionsDS(aFeed.server);</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineplus">+    ds.data = ds.data.filter(x =&gt; x.url != aFeed.url);</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineplus">+    ds.saveSoon();</span>
<a href="#l4.303"></a><span id="l4.303"> </span>
<a href="#l4.304"></a><span id="l4.304">     // Update folderpane.</span>
<a href="#l4.305"></a><span id="l4.305">     this.setFolderPaneProperty(aFeed.folder, &quot;favicon&quot;, null, &quot;row&quot;);</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineminus">-    // Remove from cache.</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineminus">-    delete this[aFeed.server.serverURI][aFeed.url];</span>
<a href="#l4.308"></a><span id="l4.308">   },</span>
<a href="#l4.309"></a><span id="l4.309"> </span>
<a href="#l4.310"></a><span id="l4.310">   /**</span>
<a href="#l4.311"></a><span id="l4.311" class="difflineminus">-   * Change an existing feed's url, as identified by FZ_FEED resource in the</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineminus">-   * feeds.rdf subscriptions database.</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineplus">+   * Change an existing feed's url.</span>
<a href="#l4.314"></a><span id="l4.314">    *</span>
<a href="#l4.315"></a><span id="l4.315">    * @param {Feed} aFeed      - The feed object.</span>
<a href="#l4.316"></a><span id="l4.316">    * @param {String} aNewUrl  - New url.</span>
<a href="#l4.317"></a><span id="l4.317">    *</span>
<a href="#l4.318"></a><span id="l4.318">    * @returns {Boolean}       - true if successful, else false.</span>
<a href="#l4.319"></a><span id="l4.319">    */</span>
<a href="#l4.320"></a><span id="l4.320">   changeUrlForFeed(aFeed, aNewUrl) {</span>
<a href="#l4.321"></a><span id="l4.321">     if (!aFeed || !aFeed.folder || !aNewUrl) {</span>
<a href="#l4.322"></a><span id="l4.322" class="difflineat">@@ -789,36 +660,33 @@ var FeedUtils = {</span>
<a href="#l4.323"></a><span id="l4.323">     }</span>
<a href="#l4.324"></a><span id="l4.324"> </span>
<a href="#l4.325"></a><span id="l4.325">     let title = aFeed.title;</span>
<a href="#l4.326"></a><span id="l4.326">     let link = aFeed.link;</span>
<a href="#l4.327"></a><span id="l4.327">     let quickMode = aFeed.quickMode;</span>
<a href="#l4.328"></a><span id="l4.328">     let options = aFeed.options;</span>
<a href="#l4.329"></a><span id="l4.329"> </span>
<a href="#l4.330"></a><span id="l4.330">     this.deleteFeed(aFeed);</span>
<a href="#l4.331"></a><span id="l4.331" class="difflineminus">-    aFeed.resource = this.rdf</span>
<a href="#l4.332"></a><span id="l4.332" class="difflineminus">-      .GetResource(aNewUrl)</span>
<a href="#l4.333"></a><span id="l4.333" class="difflineminus">-      .QueryInterface(Ci.nsIRDFResource);</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineplus">+    aFeed.url = aNewUrl;</span>
<a href="#l4.335"></a><span id="l4.335">     aFeed.title = title;</span>
<a href="#l4.336"></a><span id="l4.336">     aFeed.link = link;</span>
<a href="#l4.337"></a><span id="l4.337">     aFeed.quickMode = quickMode;</span>
<a href="#l4.338"></a><span id="l4.338">     aFeed.options = options;</span>
<a href="#l4.339"></a><span id="l4.339">     this.addFeed(aFeed);</span>
<a href="#l4.340"></a><span id="l4.340"> </span>
<a href="#l4.341"></a><span id="l4.341">     let win = Services.wm.getMostRecentWindow(&quot;Mail:News-BlogSubscriptions&quot;);</span>
<a href="#l4.342"></a><span id="l4.342">     if (win) {</span>
<a href="#l4.343"></a><span id="l4.343">       win.FeedSubscriptions.refreshSubscriptionView(aFeed.folder, aNewUrl);</span>
<a href="#l4.344"></a><span id="l4.344">     }</span>
<a href="#l4.345"></a><span id="l4.345"> </span>
<a href="#l4.346"></a><span id="l4.346">     return true;</span>
<a href="#l4.347"></a><span id="l4.347">   },</span>
<a href="#l4.348"></a><span id="l4.348"> </span>
<a href="#l4.349"></a><span id="l4.349">   /**</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineminus">-   * Get the list of feed urls for a folder, as identified by the FZ_DESTFOLDER</span>
<a href="#l4.351"></a><span id="l4.351" class="difflineminus">-   * tag, directly from the primary feeds.rdf subscriptions database.</span>
<a href="#l4.352"></a><span id="l4.352" class="difflineplus">+   * Get the list of feed urls for a folder.</span>
<a href="#l4.353"></a><span id="l4.353">    *</span>
<a href="#l4.354"></a><span id="l4.354">    * @param {nsIMsgFolder} aFolder - The folder.</span>
<a href="#l4.355"></a><span id="l4.355">    *</span>
<a href="#l4.356"></a><span id="l4.356">    * @returns {String}[]           - Array of urls, or null if none.</span>
<a href="#l4.357"></a><span id="l4.357">    */</span>
<a href="#l4.358"></a><span id="l4.358">   getFeedUrlsInFolder(aFolder) {</span>
<a href="#l4.359"></a><span id="l4.359">     if (</span>
<a href="#l4.360"></a><span id="l4.360">       !aFolder ||</span>
<a href="#l4.361"></a><span id="l4.361" class="difflineat">@@ -834,26 +702,25 @@ var FeedUtils = {</span>
<a href="#l4.362"></a><span id="l4.362">       return null;</span>
<a href="#l4.363"></a><span id="l4.363">     }</span>
<a href="#l4.364"></a><span id="l4.364"> </span>
<a href="#l4.365"></a><span id="l4.365">     let feedUrlArray = [];</span>
<a href="#l4.366"></a><span id="l4.366"> </span>
<a href="#l4.367"></a><span id="l4.367">     // Get the list from the feeds database.</span>
<a href="#l4.368"></a><span id="l4.368">     try {</span>
<a href="#l4.369"></a><span id="l4.369">       let ds = this.getSubscriptionsDS(aFolder.server);</span>
<a href="#l4.370"></a><span id="l4.370" class="difflineminus">-      let enumerator = ds.GetSources(this.FZ_DESTFOLDER, aFolder, true);</span>
<a href="#l4.371"></a><span id="l4.371" class="difflineminus">-      while (enumerator.hasMoreElements()) {</span>
<a href="#l4.372"></a><span id="l4.372" class="difflineminus">-        let containerArc = enumerator.getNext();</span>
<a href="#l4.373"></a><span id="l4.373" class="difflineminus">-        let uri = containerArc.QueryInterface(Ci.nsIRDFResource).ValueUTF8;</span>
<a href="#l4.374"></a><span id="l4.374" class="difflineminus">-        feedUrlArray.push(uri);</span>
<a href="#l4.375"></a><span id="l4.375" class="difflineplus">+      for (const sub of ds.data) {</span>
<a href="#l4.376"></a><span id="l4.376" class="difflineplus">+        if (sub.destFolder == aFolder.URI) {</span>
<a href="#l4.377"></a><span id="l4.377" class="difflineplus">+          feedUrlArray.push(sub.url);</span>
<a href="#l4.378"></a><span id="l4.378" class="difflineplus">+        }</span>
<a href="#l4.379"></a><span id="l4.379">       }</span>
<a href="#l4.380"></a><span id="l4.380">     } catch (ex) {</span>
<a href="#l4.381"></a><span id="l4.381" class="difflineminus">-      this.log.error(&quot;getFeedUrlsInFolder: feeds.rdf db error - &quot; + ex);</span>
<a href="#l4.382"></a><span id="l4.382" class="difflineplus">+      this.log.error(&quot;getFeedUrlsInFolder: feeds db error - &quot; + ex);</span>
<a href="#l4.383"></a><span id="l4.383">       this.log.error(</span>
<a href="#l4.384"></a><span id="l4.384" class="difflineminus">-        &quot;getFeedUrlsInFolder: feeds.rdf db error for account - &quot; +</span>
<a href="#l4.385"></a><span id="l4.385" class="difflineplus">+        &quot;getFeedUrlsInFolder: feeds db error for account - &quot; +</span>
<a href="#l4.386"></a><span id="l4.386">           aFolder.server.serverURI +</span>
<a href="#l4.387"></a><span id="l4.387">           &quot; : &quot; +</span>
<a href="#l4.388"></a><span id="l4.388">           aFolder.server.prettyName</span>
<a href="#l4.389"></a><span id="l4.389">       );</span>
<a href="#l4.390"></a><span id="l4.390">     }</span>
<a href="#l4.391"></a><span id="l4.391"> </span>
<a href="#l4.392"></a><span id="l4.392">     return feedUrlArray.length ? feedUrlArray : null;</span>
<a href="#l4.393"></a><span id="l4.393">   },</span>
<a href="#l4.394"></a><span id="l4.394" class="difflineat">@@ -1163,17 +1030,17 @@ var FeedUtils = {</span>
<a href="#l4.395"></a><span id="l4.395">     if (aCallback) {</span>
<a href="#l4.396"></a><span id="l4.396">       aCallback(iconUri.spec);</span>
<a href="#l4.397"></a><span id="l4.397">     }</span>
<a href="#l4.398"></a><span id="l4.398"> </span>
<a href="#l4.399"></a><span id="l4.399">     return iconUri.spec;</span>
<a href="#l4.400"></a><span id="l4.400">   },</span>
<a href="#l4.401"></a><span id="l4.401"> </span>
<a href="#l4.402"></a><span id="l4.402">   /**</span>
<a href="#l4.403"></a><span id="l4.403" class="difflineminus">-   * Update the feeds.rdf database for rename and move/copy folder name changes.</span>
<a href="#l4.404"></a><span id="l4.404" class="difflineplus">+   * Update the feeds database for rename and move/copy folder name changes.</span>
<a href="#l4.405"></a><span id="l4.405">    *</span>
<a href="#l4.406"></a><span id="l4.406">    * @param {nsIMsgFolder} aFolder      - The folder, new if rename or target of</span>
<a href="#l4.407"></a><span id="l4.407">    *                                      move/copy folder (new parent).</span>
<a href="#l4.408"></a><span id="l4.408">    * @param {nsIMsgFolder} aOrigFolder  - Original folder.</span>
<a href="#l4.409"></a><span id="l4.409">    * @param {String} aAction            - &quot;move&quot; or &quot;copy&quot; or &quot;rename&quot;.</span>
<a href="#l4.410"></a><span id="l4.410">    *</span>
<a href="#l4.411"></a><span id="l4.411">    * @returns {void}</span>
<a href="#l4.412"></a><span id="l4.412">    */</span>
<a href="#l4.413"></a><span id="l4.413" class="difflineat">@@ -1183,16 +1050,20 @@ var FeedUtils = {</span>
<a href="#l4.414"></a><span id="l4.414">         &quot;\nfolder changed - &quot; +</span>
<a href="#l4.415"></a><span id="l4.415">         aAction +</span>
<a href="#l4.416"></a><span id="l4.416">         &quot;\nnew folder  - &quot; +</span>
<a href="#l4.417"></a><span id="l4.417">         aFolder.filePath.path +</span>
<a href="#l4.418"></a><span id="l4.418">         &quot;\norig folder - &quot; +</span>
<a href="#l4.419"></a><span id="l4.419">         aOrigFolder.filePath.path</span>
<a href="#l4.420"></a><span id="l4.420">     );</span>
<a href="#l4.421"></a><span id="l4.421"> </span>
<a href="#l4.422"></a><span id="l4.422" class="difflineplus">+    this.log.debug(</span>
<a href="#l4.423"></a><span id="l4.423" class="difflineplus">+      `updateSubscriptions(${aFolder.name}, ${aOrigFolder.name}, ${aAction})`</span>
<a href="#l4.424"></a><span id="l4.424" class="difflineplus">+    );</span>
<a href="#l4.425"></a><span id="l4.425" class="difflineplus">+</span>
<a href="#l4.426"></a><span id="l4.426">     if (aFolder.server.type != &quot;rss&quot; || FeedUtils.isInTrash(aOrigFolder)) {</span>
<a href="#l4.427"></a><span id="l4.427">       // Target not a feed account folder; nothing to do, or move/rename in</span>
<a href="#l4.428"></a><span id="l4.428">       // trash; no subscriptions already.</span>
<a href="#l4.429"></a><span id="l4.429">       return;</span>
<a href="#l4.430"></a><span id="l4.430">     }</span>
<a href="#l4.431"></a><span id="l4.431"> </span>
<a href="#l4.432"></a><span id="l4.432">     let newFolder = aFolder;</span>
<a href="#l4.433"></a><span id="l4.433">     let newParentURI = aFolder.URI;</span>
<a href="#l4.434"></a><span id="l4.434" class="difflineat">@@ -1220,18 +1091,18 @@ var FeedUtils = {</span>
<a href="#l4.435"></a><span id="l4.435">         aOrigFolder,</span>
<a href="#l4.436"></a><span id="l4.436">         newParentURI,</span>
<a href="#l4.437"></a><span id="l4.437">         origParentURI</span>
<a href="#l4.438"></a><span id="l4.438">       );</span>
<a href="#l4.439"></a><span id="l4.439">     }</span>
<a href="#l4.440"></a><span id="l4.440">   },</span>
<a href="#l4.441"></a><span id="l4.441"> </span>
<a href="#l4.442"></a><span id="l4.442">   /**</span>
<a href="#l4.443"></a><span id="l4.443" class="difflineminus">-   * Update the feeds.rdf database with the new folder's or subfolder's location</span>
<a href="#l4.444"></a><span id="l4.444" class="difflineminus">-   * for rename and move/copy name changes. The feeds.rdf subscriptions db is</span>
<a href="#l4.445"></a><span id="l4.445" class="difflineplus">+   * Update the feeds database with the new folder's or subfolder's location</span>
<a href="#l4.446"></a><span id="l4.446" class="difflineplus">+   * for rename and move/copy name changes. The feeds subscriptions db is</span>
<a href="#l4.447"></a><span id="l4.447">    * also synced on cross account folder copies. Note that if a copied folder's</span>
<a href="#l4.448"></a><span id="l4.448">    * url exists in the new account, its active subscription will be switched to</span>
<a href="#l4.449"></a><span id="l4.449">    * the folder being copied, to enforce the one unique url per account design.</span>
<a href="#l4.450"></a><span id="l4.450">    *</span>
<a href="#l4.451"></a><span id="l4.451">    * @param {nsIMsgFolder} aFolder      - New folder.</span>
<a href="#l4.452"></a><span id="l4.452">    * @param {nsIMsgFolder} aOrigFolder  - Original folder.</span>
<a href="#l4.453"></a><span id="l4.453">    * @param {String} aNewAncestorURI    - For subfolders, ancestor new folder.</span>
<a href="#l4.454"></a><span id="l4.454">    * @param {String} aOrigAncestorURI   - For subfolders, ancestor original folder.</span>
<a href="#l4.455"></a><span id="l4.455" class="difflineat">@@ -1257,102 +1128,53 @@ var FeedUtils = {</span>
<a href="#l4.456"></a><span id="l4.456">     );</span>
<a href="#l4.457"></a><span id="l4.457"> </span>
<a href="#l4.458"></a><span id="l4.458">     // Get the original folder's URI.</span>
<a href="#l4.459"></a><span id="l4.459">     let folderURI = aFolder.URI;</span>
<a href="#l4.460"></a><span id="l4.460">     let origURI =</span>
<a href="#l4.461"></a><span id="l4.461">       aNewAncestorURI &amp;&amp; aOrigAncestorURI</span>
<a href="#l4.462"></a><span id="l4.462">         ? folderURI.replace(aNewAncestorURI, aOrigAncestorURI)</span>
<a href="#l4.463"></a><span id="l4.463">         : aOrigFolder.URI;</span>
<a href="#l4.464"></a><span id="l4.464" class="difflineminus">-    let origFolderRes = this.rdf.GetResource(origURI);</span>
<a href="#l4.465"></a><span id="l4.465">     this.log.debug(&quot;updateFolderChangeInFeedsDS: urls origURI  - &quot; + origURI);</span>
<a href="#l4.466"></a><span id="l4.466" class="difflineminus">-    // Get the original folder's url list from the feeds database.</span>
<a href="#l4.467"></a><span id="l4.467" class="difflineminus">-    let feedUrlArray = [];</span>
<a href="#l4.468"></a><span id="l4.468" class="difflineminus">-    let dsSrc = this.getSubscriptionsDS(aOrigFolder.server);</span>
<a href="#l4.469"></a><span id="l4.469" class="difflineminus">-    try {</span>
<a href="#l4.470"></a><span id="l4.470" class="difflineminus">-      let enumerator = dsSrc.GetSources(</span>
<a href="#l4.471"></a><span id="l4.471" class="difflineminus">-        this.FZ_DESTFOLDER,</span>
<a href="#l4.472"></a><span id="l4.472" class="difflineminus">-        origFolderRes,</span>
<a href="#l4.473"></a><span id="l4.473" class="difflineminus">-        true</span>
<a href="#l4.474"></a><span id="l4.474" class="difflineminus">-      );</span>
<a href="#l4.475"></a><span id="l4.475" class="difflineminus">-      while (enumerator.hasMoreElements()) {</span>
<a href="#l4.476"></a><span id="l4.476" class="difflineminus">-        let containerArc = enumerator.getNext();</span>
<a href="#l4.477"></a><span id="l4.477" class="difflineminus">-        let uri = containerArc.QueryInterface(Ci.nsIRDFResource).ValueUTF8;</span>
<a href="#l4.478"></a><span id="l4.478" class="difflineminus">-        feedUrlArray.push(uri);</span>
<a href="#l4.479"></a><span id="l4.479" class="difflineminus">-      }</span>
<a href="#l4.480"></a><span id="l4.480" class="difflineminus">-    } catch (ex) {</span>
<a href="#l4.481"></a><span id="l4.481" class="difflineminus">-      this.log.error(</span>
<a href="#l4.482"></a><span id="l4.482" class="difflineminus">-        &quot;updateFolderChangeInFeedsDS: feeds.rdf db error for account - &quot; +</span>
<a href="#l4.483"></a><span id="l4.483" class="difflineminus">-          aOrigFolder.server.prettyName +</span>
<a href="#l4.484"></a><span id="l4.484" class="difflineminus">-          &quot; : &quot; +</span>
<a href="#l4.485"></a><span id="l4.485" class="difflineminus">-          ex</span>
<a href="#l4.486"></a><span id="l4.486" class="difflineminus">-      );</span>
<a href="#l4.487"></a><span id="l4.487" class="difflineminus">-    }</span>
<a href="#l4.488"></a><span id="l4.488"> </span>
<a href="#l4.489"></a><span id="l4.489" class="difflineminus">-    if (!feedUrlArray.length) {</span>
<a href="#l4.490"></a><span id="l4.490" class="difflineplus">+    // Get affected feed subscriptions - all the ones in the original folder.</span>
<a href="#l4.491"></a><span id="l4.491" class="difflineplus">+    let origDS = this.getSubscriptionsDS(aOrigFolder.server);</span>
<a href="#l4.492"></a><span id="l4.492" class="difflineplus">+    let affectedSubs = origDS.data.filter(sub =&gt; sub.destFolder == origURI);</span>
<a href="#l4.493"></a><span id="l4.493" class="difflineplus">+    if (affectedSubs.length == 0) {</span>
<a href="#l4.494"></a><span id="l4.494">       this.log.debug(&quot;updateFolderChangeInFeedsDS: no feedUrls in this folder&quot;);</span>
<a href="#l4.495"></a><span id="l4.495">       return;</span>
<a href="#l4.496"></a><span id="l4.496">     }</span>
<a href="#l4.497"></a><span id="l4.497"> </span>
<a href="#l4.498"></a><span id="l4.498" class="difflineminus">-    let ds = this.getSubscriptionsDS(aFolder.server);</span>
<a href="#l4.499"></a><span id="l4.499" class="difflineminus">-    for (let feedUrl of feedUrlArray) {</span>
<a href="#l4.500"></a><span id="l4.500" class="difflineminus">-      this.log.debug(&quot;updateFolderChangeInFeedsDS: feedUrl - &quot; + feedUrl);</span>
<a href="#l4.501"></a><span id="l4.501" class="difflineminus">-      let feed = new Feed(feedUrl, aFolder);</span>
<a href="#l4.502"></a><span id="l4.502" class="difflineminus">-</span>
<a href="#l4.503"></a><span id="l4.503" class="difflineminus">-      // If move to trash, unsubscribe.</span>
<a href="#l4.504"></a><span id="l4.504" class="difflineminus">-      if (this.isInTrash(aFolder)) {</span>
<a href="#l4.505"></a><span id="l4.505" class="difflineminus">-        this.deleteFeed(feed);</span>
<a href="#l4.506"></a><span id="l4.506" class="difflineminus">-      } else {</span>
<a href="#l4.507"></a><span id="l4.507" class="difflineminus">-        let folderResource = this.rdf.GetResource(aFolder.URI);</span>
<a href="#l4.508"></a><span id="l4.508" class="difflineminus">-        // Get the node for the current folder URI.</span>
<a href="#l4.509"></a><span id="l4.509" class="difflineminus">-        let node = ds.GetTarget(feed.resource, this.FZ_DESTFOLDER, true);</span>
<a href="#l4.510"></a><span id="l4.510" class="difflineminus">-        if (node) {</span>
<a href="#l4.511"></a><span id="l4.511" class="difflineminus">-          ds.Change(feed.resource, this.FZ_DESTFOLDER, node, folderResource);</span>
<a href="#l4.512"></a><span id="l4.512" class="difflineminus">-        } else {</span>
<a href="#l4.513"></a><span id="l4.513" class="difflineminus">-          // If adding a new feed it's a cross account action; make sure to</span>
<a href="#l4.514"></a><span id="l4.514" class="difflineminus">-          // preserve all properties from the original datasource where</span>
<a href="#l4.515"></a><span id="l4.515" class="difflineminus">-          // available. Otherwise use the new folder's name and default server</span>
<a href="#l4.516"></a><span id="l4.516" class="difflineminus">-          // quickMode; preserve link and options.</span>
<a href="#l4.517"></a><span id="l4.517" class="difflineminus">-          let feedTitle = dsSrc.GetTarget(feed.resource, this.DC_TITLE, true);</span>
<a href="#l4.518"></a><span id="l4.518" class="difflineminus">-          feedTitle = feedTitle</span>
<a href="#l4.519"></a><span id="l4.519" class="difflineminus">-            ? feedTitle.QueryInterface(Ci.nsIRDFLiteral).Value</span>
<a href="#l4.520"></a><span id="l4.520" class="difflineminus">-            : folderResource.name;</span>
<a href="#l4.521"></a><span id="l4.521" class="difflineminus">-          let link = dsSrc.GetTarget(feed.resource, FeedUtils.RSS_LINK, true);</span>
<a href="#l4.522"></a><span id="l4.522" class="difflineminus">-          link = link ? link.QueryInterface(Ci.nsIRDFLiteral).Value : &quot;&quot;;</span>
<a href="#l4.523"></a><span id="l4.523" class="difflineminus">-          let quickMode = dsSrc.GetTarget(</span>
<a href="#l4.524"></a><span id="l4.524" class="difflineminus">-            feed.resource,</span>
<a href="#l4.525"></a><span id="l4.525" class="difflineminus">-            this.FZ_QUICKMODE,</span>
<a href="#l4.526"></a><span id="l4.526" class="difflineminus">-            true</span>
<a href="#l4.527"></a><span id="l4.527" class="difflineminus">-          );</span>
<a href="#l4.528"></a><span id="l4.528" class="difflineminus">-          quickMode = quickMode</span>
<a href="#l4.529"></a><span id="l4.529" class="difflineminus">-            ? quickMode.QueryInterface(Ci.nsIRDFLiteral).Value</span>
<a href="#l4.530"></a><span id="l4.530" class="difflineminus">-            : null;</span>
<a href="#l4.531"></a><span id="l4.531" class="difflineminus">-          if (quickMode == &quot;true&quot;) {</span>
<a href="#l4.532"></a><span id="l4.532" class="difflineminus">-            quickMode = true;</span>
<a href="#l4.533"></a><span id="l4.533" class="difflineminus">-          } else if (quickMode == &quot;false&quot;) {</span>
<a href="#l4.534"></a><span id="l4.534" class="difflineminus">-            quickMode = false;</span>
<a href="#l4.535"></a><span id="l4.535" class="difflineminus">-          } else {</span>
<a href="#l4.536"></a><span id="l4.536" class="difflineminus">-            quickMode = feed.server.getBoolValue(&quot;quickMode&quot;);</span>
<a href="#l4.537"></a><span id="l4.537" class="difflineminus">-          }</span>
<a href="#l4.538"></a><span id="l4.538" class="difflineminus">-</span>
<a href="#l4.539"></a><span id="l4.539" class="difflineminus">-          let options = dsSrc.GetTarget(feed.resource, this.FZ_OPTIONS, true);</span>
<a href="#l4.540"></a><span id="l4.540" class="difflineminus">-          options = options</span>
<a href="#l4.541"></a><span id="l4.541" class="difflineminus">-            ? JSON.parse(options.QueryInterface(Ci.nsIRDFLiteral).Value)</span>
<a href="#l4.542"></a><span id="l4.542" class="difflineminus">-            : this.optionsTemplate;</span>
<a href="#l4.543"></a><span id="l4.543" class="difflineminus">-          // Update the feedUrl feed properties.</span>
<a href="#l4.544"></a><span id="l4.544" class="difflineminus">-          feed.title = feedTitle;</span>
<a href="#l4.545"></a><span id="l4.545" class="difflineminus">-          feed.link = link;</span>
<a href="#l4.546"></a><span id="l4.546" class="difflineminus">-          feed.quickMode = quickMode;</span>
<a href="#l4.547"></a><span id="l4.547" class="difflineminus">-          feed.options = options;</span>
<a href="#l4.548"></a><span id="l4.548" class="difflineminus">-          this.addFeed(feed);</span>
<a href="#l4.549"></a><span id="l4.549" class="difflineminus">-        }</span>
<a href="#l4.550"></a><span id="l4.550" class="difflineminus">-      }</span>
<a href="#l4.551"></a><span id="l4.551" class="difflineplus">+    if (this.isInTrash(aFolder)) {</span>
<a href="#l4.552"></a><span id="l4.552" class="difflineplus">+      // Moving to trash. Unsubscribe.</span>
<a href="#l4.553"></a><span id="l4.553" class="difflineplus">+      affectedSubs.forEach(function(sub) {</span>
<a href="#l4.554"></a><span id="l4.554" class="difflineplus">+        let feed = new Feed(sub.url, aFolder);</span>
<a href="#l4.555"></a><span id="l4.555" class="difflineplus">+        FeedUtils.deleteFeed(feed);</span>
<a href="#l4.556"></a><span id="l4.556" class="difflineplus">+      });</span>
<a href="#l4.557"></a><span id="l4.557" class="difflineplus">+      // note: deleteFeed() calls saveSoon(), so we don't need to.</span>
<a href="#l4.558"></a><span id="l4.558" class="difflineplus">+    } else if (aFolder.server == aOrigFolder.server) {</span>
<a href="#l4.559"></a><span id="l4.559" class="difflineplus">+      // Staying in same account - just update destFolder as required</span>
<a href="#l4.560"></a><span id="l4.560" class="difflineplus">+      affectedSubs.forEach(function(sub) {</span>
<a href="#l4.561"></a><span id="l4.561" class="difflineplus">+        sub.destFolder = folderURI;</span>
<a href="#l4.562"></a><span id="l4.562" class="difflineplus">+      });</span>
<a href="#l4.563"></a><span id="l4.563" class="difflineplus">+      origDS.saveSoon();</span>
<a href="#l4.564"></a><span id="l4.564" class="difflineplus">+    } else {</span>
<a href="#l4.565"></a><span id="l4.565" class="difflineplus">+      // Moving between folders.</span>
<a href="#l4.566"></a><span id="l4.566" class="difflineplus">+      let destDS = this.getSubscriptionsDS(aFolder.server);</span>
<a href="#l4.567"></a><span id="l4.567" class="difflineplus">+      affectedSubs.forEach(function(sub) {</span>
<a href="#l4.568"></a><span id="l4.568" class="difflineplus">+        // Move to the new subscription db (replacing any existing entry).</span>
<a href="#l4.569"></a><span id="l4.569" class="difflineplus">+        origDS.data = origDS.data.filter(x =&gt; x.url != sub.url);</span>
<a href="#l4.570"></a><span id="l4.570" class="difflineplus">+        destDS.data = destDS.data.filter(x =&gt; x.url != sub.url);</span>
<a href="#l4.571"></a><span id="l4.571" class="difflineplus">+        sub.destFolder = folderURI;</span>
<a href="#l4.572"></a><span id="l4.572" class="difflineplus">+        destDS.push(sub);</span>
<a href="#l4.573"></a><span id="l4.573" class="difflineplus">+      });</span>
<a href="#l4.574"></a><span id="l4.574" class="difflineplus">+      this.setFolderPaneProperty(aFolder, &quot;favicon&quot;, null, &quot;row&quot;);</span>
<a href="#l4.575"></a><span id="l4.575" class="difflineplus">+      origDS.saveSoon();</span>
<a href="#l4.576"></a><span id="l4.576" class="difflineplus">+      destDS.saveSoon();</span>
<a href="#l4.577"></a><span id="l4.577">     }</span>
<a href="#l4.578"></a><span id="l4.578" class="difflineminus">-</span>
<a href="#l4.579"></a><span id="l4.579" class="difflineminus">-    ds.Flush();</span>
<a href="#l4.580"></a><span id="l4.580">   },</span>
<a href="#l4.581"></a><span id="l4.581"> </span>
<a href="#l4.582"></a><span id="l4.582">   /**</span>
<a href="#l4.583"></a><span id="l4.583">    * When subscribing to feeds by dnd on, or adding a url to, the account</span>
<a href="#l4.584"></a><span id="l4.584">    * folder (only), or creating folder structure via opml import, a subfolder is</span>
<a href="#l4.585"></a><span id="l4.585">    * autocreated and thus the derived/given name must be sanitized to prevent</span>
<a href="#l4.586"></a><span id="l4.586">    * filesystem errors. Hashing invalid chars based on OS rather than filesystem</span>
<a href="#l4.587"></a><span id="l4.587">    * is not strictly correct.</span>
<a href="#l4.588"></a><span id="l4.588" class="difflineat">@@ -1577,208 +1399,116 @@ var FeedUtils = {</span>
<a href="#l4.589"></a><span id="l4.589">         source,</span>
<a href="#l4.590"></a><span id="l4.590">         into(target) {</span>
<a href="#l4.591"></a><span id="l4.591">           meldin(this.source, target, keep, replace);</span>
<a href="#l4.592"></a><span id="l4.592">         },</span>
<a href="#l4.593"></a><span id="l4.593">       };</span>
<a href="#l4.594"></a><span id="l4.594">     },</span>
<a href="#l4.595"></a><span id="l4.595">   },</span>
<a href="#l4.596"></a><span id="l4.596"> </span>
<a href="#l4.597"></a><span id="l4.597" class="difflineplus">+  /**</span>
<a href="#l4.598"></a><span id="l4.598" class="difflineplus">+   * Returns a reference to the feed subscriptions store for the given server</span>
<a href="#l4.599"></a><span id="l4.599" class="difflineplus">+   * (the feeds.json data).</span>
<a href="#l4.600"></a><span id="l4.600" class="difflineplus">+   *</span>
<a href="#l4.601"></a><span id="l4.601" class="difflineplus">+   * @param {nsIMsgIncomingServer} aServer - server to fetch item data for.</span>
<a href="#l4.602"></a><span id="l4.602" class="difflineplus">+   * @returns {JSONFile} - a JSONFile holding the array of feed subscriptions</span>
<a href="#l4.603"></a><span id="l4.603" class="difflineplus">+   *                       in its data field.</span>
<a href="#l4.604"></a><span id="l4.604" class="difflineplus">+   */</span>
<a href="#l4.605"></a><span id="l4.605">   getSubscriptionsDS(aServer) {</span>
<a href="#l4.606"></a><span id="l4.606">     if (this[aServer.serverURI] &amp;&amp; this[aServer.serverURI].FeedsDS) {</span>
<a href="#l4.607"></a><span id="l4.607">       return this[aServer.serverURI].FeedsDS;</span>
<a href="#l4.608"></a><span id="l4.608">     }</span>
<a href="#l4.609"></a><span id="l4.609"> </span>
<a href="#l4.610"></a><span id="l4.610" class="difflineminus">-    let file = this.getSubscriptionsFile(aServer);</span>
<a href="#l4.611"></a><span id="l4.611" class="difflineminus">-    let url = Services.io</span>
<a href="#l4.612"></a><span id="l4.612" class="difflineminus">-      .getProtocolHandler(&quot;file&quot;)</span>
<a href="#l4.613"></a><span id="l4.613" class="difflineminus">-      .QueryInterface(Ci.nsIFileProtocolHandler)</span>
<a href="#l4.614"></a><span id="l4.614" class="difflineminus">-      .getURLSpecFromFile(file);</span>
<a href="#l4.615"></a><span id="l4.615" class="difflineminus">-</span>
<a href="#l4.616"></a><span id="l4.616" class="difflineminus">-    // GetDataSourceBlocking has a cache, so it's cheap to do this again</span>
<a href="#l4.617"></a><span id="l4.617" class="difflineminus">-    // once we've already done it once.</span>
<a href="#l4.618"></a><span id="l4.618" class="difflineminus">-    let ds = this.rdf.GetDataSourceBlocking(url);</span>
<a href="#l4.619"></a><span id="l4.619" class="difflineminus">-</span>
<a href="#l4.620"></a><span id="l4.620" class="difflineminus">-    if (!ds) {</span>
<a href="#l4.621"></a><span id="l4.621" class="difflineminus">-      throw new Error(</span>
<a href="#l4.622"></a><span id="l4.622" class="difflineminus">-        &quot;FeedUtils.getSubscriptionsDS: can't get feed &quot; +</span>
<a href="#l4.623"></a><span id="l4.623" class="difflineminus">-          &quot;subscriptions data source - &quot; +</span>
<a href="#l4.624"></a><span id="l4.624" class="difflineminus">-          url</span>
<a href="#l4.625"></a><span id="l4.625" class="difflineminus">-      );</span>
<a href="#l4.626"></a><span id="l4.626" class="difflineminus">-    }</span>
<a href="#l4.627"></a><span id="l4.627" class="difflineplus">+    let rssServer = aServer.QueryInterface(Ci.nsIRssIncomingServer);</span>
<a href="#l4.628"></a><span id="l4.628" class="difflineplus">+    let feedsFile = rssServer.subscriptionsPath; // Path to feeds.json</span>
<a href="#l4.629"></a><span id="l4.629" class="difflineplus">+    let exists = feedsFile.exists();</span>
<a href="#l4.630"></a><span id="l4.630" class="difflineplus">+    let ds = new JSONFile({ path: feedsFile.path });</span>
<a href="#l4.631"></a><span id="l4.631" class="difflineplus">+    ds.ensureDataReady();</span>
<a href="#l4.632"></a><span id="l4.632">     if (!this[aServer.serverURI]) {</span>
<a href="#l4.633"></a><span id="l4.633">       this[aServer.serverURI] = {};</span>
<a href="#l4.634"></a><span id="l4.634">     }</span>
<a href="#l4.635"></a><span id="l4.635" class="difflineminus">-</span>
<a href="#l4.636"></a><span id="l4.636" class="difflineminus">-    return (this[aServer.serverURI].FeedsDS = ds.QueryInterface(</span>
<a href="#l4.637"></a><span id="l4.637" class="difflineminus">-      Ci.nsIRDFRemoteDataSource</span>
<a href="#l4.638"></a><span id="l4.638" class="difflineminus">-    ));</span>
<a href="#l4.639"></a><span id="l4.639" class="difflineplus">+    this[aServer.serverURI].FeedsDS = ds;</span>
<a href="#l4.640"></a><span id="l4.640" class="difflineplus">+    if (!exists) {</span>
<a href="#l4.641"></a><span id="l4.641" class="difflineplus">+      // No feeds.json, so we need to initalise.</span>
<a href="#l4.642"></a><span id="l4.642" class="difflineplus">+      ds.data = [];</span>
<a href="#l4.643"></a><span id="l4.643" class="difflineplus">+    }</span>
<a href="#l4.644"></a><span id="l4.644" class="difflineplus">+    return ds;</span>
<a href="#l4.645"></a><span id="l4.645">   },</span>
<a href="#l4.646"></a><span id="l4.646"> </span>
<a href="#l4.647"></a><span id="l4.647" class="difflineminus">-  getSubscriptionsList(aDataSource) {</span>
<a href="#l4.648"></a><span id="l4.648" class="difflineminus">-    let list = aDataSource.GetTarget(this.FZ_ROOT, this.FZ_FEEDS, true);</span>
<a href="#l4.649"></a><span id="l4.649" class="difflineminus">-    list = list.QueryInterface(Ci.nsIRDFResource);</span>
<a href="#l4.650"></a><span id="l4.650" class="difflineminus">-    list = this.rdfContainerUtils.MakeSeq(aDataSource, list);</span>
<a href="#l4.651"></a><span id="l4.651" class="difflineminus">-    return list;</span>
<a href="#l4.652"></a><span id="l4.652" class="difflineplus">+  /**</span>
<a href="#l4.653"></a><span id="l4.653" class="difflineplus">+   * Fetch an attribute for a subscribed feed.</span>
<a href="#l4.654"></a><span id="l4.654" class="difflineplus">+   *</span>
<a href="#l4.655"></a><span id="l4.655" class="difflineplus">+   * @param {String} feedURL - URL of the feed.</span>
<a href="#l4.656"></a><span id="l4.656" class="difflineplus">+   * @param {nsIMsgIncomingServer} server - Server holding the subscription.</span>
<a href="#l4.657"></a><span id="l4.657" class="difflineplus">+   * @param {String} attrName - Name of attribute to fetch.</span>
<a href="#l4.658"></a><span id="l4.658" class="difflineplus">+   * @param {undefined} defaultValue - Value to return if not found.</span>
<a href="#l4.659"></a><span id="l4.659" class="difflineplus">+   *</span>
<a href="#l4.660"></a><span id="l4.660" class="difflineplus">+   * @returns {undefined} - the fetched value (defaultValue if the</span>
<a href="#l4.661"></a><span id="l4.661" class="difflineplus">+   *                        subscription or attribute doesn't exist).</span>
<a href="#l4.662"></a><span id="l4.662" class="difflineplus">+   */</span>
<a href="#l4.663"></a><span id="l4.663" class="difflineplus">+  getSubscriptionAttr(feedURL, server, attrName, defaultValue) {</span>
<a href="#l4.664"></a><span id="l4.664" class="difflineplus">+    let ds = this.getSubscriptionsDS(server);</span>
<a href="#l4.665"></a><span id="l4.665" class="difflineplus">+    let sub = ds.data.find(feed =&gt; feed.url == feedURL);</span>
<a href="#l4.666"></a><span id="l4.666" class="difflineplus">+    if (sub === undefined || sub[attrName] === undefined) {</span>
<a href="#l4.667"></a><span id="l4.667" class="difflineplus">+      return defaultValue;</span>
<a href="#l4.668"></a><span id="l4.668" class="difflineplus">+    }</span>
<a href="#l4.669"></a><span id="l4.669" class="difflineplus">+    return sub[attrName];</span>
<a href="#l4.670"></a><span id="l4.670">   },</span>
<a href="#l4.671"></a><span id="l4.671"> </span>
<a href="#l4.672"></a><span id="l4.672" class="difflineminus">-  getSubscriptionsFile(aServer) {</span>
<a href="#l4.673"></a><span id="l4.673" class="difflineminus">-    aServer.QueryInterface(Ci.nsIRssIncomingServer);</span>
<a href="#l4.674"></a><span id="l4.674" class="difflineminus">-    let file = aServer.subscriptionsDataSourcePath;</span>
<a href="#l4.675"></a><span id="l4.675" class="difflineminus">-</span>
<a href="#l4.676"></a><span id="l4.676" class="difflineminus">-    // If the file doesn't exist, create it.</span>
<a href="#l4.677"></a><span id="l4.677" class="difflineminus">-    if (!file.exists()) {</span>
<a href="#l4.678"></a><span id="l4.678" class="difflineminus">-      this.createFile(file, this.FEEDS_TEMPLATE);</span>
<a href="#l4.679"></a><span id="l4.679" class="difflineplus">+  /**</span>
<a href="#l4.680"></a><span id="l4.680" class="difflineplus">+   * Set an attribute for a feed in the subscriptions store.</span>
<a href="#l4.681"></a><span id="l4.681" class="difflineplus">+   * NOTE: If the feed is not already in the store, it will be</span>
<a href="#l4.682"></a><span id="l4.682" class="difflineplus">+   * added.</span>
<a href="#l4.683"></a><span id="l4.683" class="difflineplus">+   *</span>
<a href="#l4.684"></a><span id="l4.684" class="difflineplus">+   * @param {String} feedURL - URL of the feed.</span>
<a href="#l4.685"></a><span id="l4.685" class="difflineplus">+   * @param {nsIMsgIncomingServer} server - server holding subscription.</span>
<a href="#l4.686"></a><span id="l4.686" class="difflineplus">+   * @param {String} attrName - Name of attribute to fetch.</span>
<a href="#l4.687"></a><span id="l4.687" class="difflineplus">+   * @param {undefined} value - Value to store.</span>
<a href="#l4.688"></a><span id="l4.688" class="difflineplus">+   *</span>
<a href="#l4.689"></a><span id="l4.689" class="difflineplus">+   * @returns {void}</span>
<a href="#l4.690"></a><span id="l4.690" class="difflineplus">+   */</span>
<a href="#l4.691"></a><span id="l4.691" class="difflineplus">+  setSubscriptionAttr(feedURL, server, attrName, value) {</span>
<a href="#l4.692"></a><span id="l4.692" class="difflineplus">+    let ds = this.getSubscriptionsDS(server);</span>
<a href="#l4.693"></a><span id="l4.693" class="difflineplus">+    let sub = ds.data.find(feed =&gt; feed.url == feedURL);</span>
<a href="#l4.694"></a><span id="l4.694" class="difflineplus">+    if (sub === undefined) {</span>
<a href="#l4.695"></a><span id="l4.695" class="difflineplus">+      // Add a new entry.</span>
<a href="#l4.696"></a><span id="l4.696" class="difflineplus">+      sub = { url: feedURL };</span>
<a href="#l4.697"></a><span id="l4.697" class="difflineplus">+      ds.data.push(sub);</span>
<a href="#l4.698"></a><span id="l4.698">     }</span>
<a href="#l4.699"></a><span id="l4.699" class="difflineminus">-</span>
<a href="#l4.700"></a><span id="l4.700" class="difflineminus">-    return file;</span>
<a href="#l4.701"></a><span id="l4.701" class="difflineplus">+    sub[attrName] = value;</span>
<a href="#l4.702"></a><span id="l4.702" class="difflineplus">+    ds.saveSoon();</span>
<a href="#l4.703"></a><span id="l4.703">   },</span>
<a href="#l4.704"></a><span id="l4.704"> </span>
<a href="#l4.705"></a><span id="l4.705" class="difflineminus">-  FEEDS_TEMPLATE:</span>
<a href="#l4.706"></a><span id="l4.706" class="difflineminus">-    '&lt;?xml version=&quot;1.0&quot;?&gt;\n' +</span>
<a href="#l4.707"></a><span id="l4.707" class="difflineminus">-    '&lt;RDF:RDF xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot;\n' +</span>
<a href="#l4.708"></a><span id="l4.708" class="difflineminus">-    '         xmlns:fz=&quot;urn:forumzilla:&quot;\n' +</span>
<a href="#l4.709"></a><span id="l4.709" class="difflineminus">-    '         xmlns:RDF=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;&gt;\n' +</span>
<a href="#l4.710"></a><span id="l4.710" class="difflineminus">-    '  &lt;RDF:Description about=&quot;urn:forumzilla:root&quot;&gt;\n' +</span>
<a href="#l4.711"></a><span id="l4.711" class="difflineminus">-    &quot;    &lt;fz:feeds&gt;\n&quot; +</span>
<a href="#l4.712"></a><span id="l4.712" class="difflineminus">-    &quot;      &lt;RDF:Seq&gt;\n&quot; +</span>
<a href="#l4.713"></a><span id="l4.713" class="difflineminus">-    &quot;      &lt;/RDF:Seq&gt;\n&quot; +</span>
<a href="#l4.714"></a><span id="l4.714" class="difflineminus">-    &quot;    &lt;/fz:feeds&gt;\n&quot; +</span>
<a href="#l4.715"></a><span id="l4.715" class="difflineminus">-    &quot;  &lt;/RDF:Description&gt;\n&quot; +</span>
<a href="#l4.716"></a><span id="l4.716" class="difflineminus">-    &quot;&lt;/RDF:RDF&gt;\n&quot;,</span>
<a href="#l4.717"></a><span id="l4.717" class="difflineminus">-</span>
<a href="#l4.718"></a><span id="l4.718" class="difflineplus">+  /**</span>
<a href="#l4.719"></a><span id="l4.719" class="difflineplus">+   * Returns a reference to the feeditems store for the given server</span>
<a href="#l4.720"></a><span id="l4.720" class="difflineplus">+   * (the feeditems.json data).</span>
<a href="#l4.721"></a><span id="l4.721" class="difflineplus">+   *</span>
<a href="#l4.722"></a><span id="l4.722" class="difflineplus">+   * @param {nsIMsgIncomingServer} aServer - server to fetch item data for.</span>
<a href="#l4.723"></a><span id="l4.723" class="difflineplus">+   * @returns {JSONFile} - JSONFile with data field containing a collection</span>
<a href="#l4.724"></a><span id="l4.724" class="difflineplus">+   *                       of feeditems indexed by item url.</span>
<a href="#l4.725"></a><span id="l4.725" class="difflineplus">+   */</span>
<a href="#l4.726"></a><span id="l4.726">   getItemsDS(aServer) {</span>
<a href="#l4.727"></a><span id="l4.727">     if (this[aServer.serverURI] &amp;&amp; this[aServer.serverURI].FeedItemsDS) {</span>
<a href="#l4.728"></a><span id="l4.728">       return this[aServer.serverURI].FeedItemsDS;</span>
<a href="#l4.729"></a><span id="l4.729">     }</span>
<a href="#l4.730"></a><span id="l4.730"> </span>
<a href="#l4.731"></a><span id="l4.731" class="difflineminus">-    let file = this.getItemsFile(aServer);</span>
<a href="#l4.732"></a><span id="l4.732" class="difflineminus">-    let url = Services.io</span>
<a href="#l4.733"></a><span id="l4.733" class="difflineminus">-      .getProtocolHandler(&quot;file&quot;)</span>
<a href="#l4.734"></a><span id="l4.734" class="difflineminus">-      .QueryInterface(Ci.nsIFileProtocolHandler)</span>
<a href="#l4.735"></a><span id="l4.735" class="difflineminus">-      .getURLSpecFromFile(file);</span>
<a href="#l4.736"></a><span id="l4.736" class="difflineminus">-</span>
<a href="#l4.737"></a><span id="l4.737" class="difflineminus">-    // GetDataSourceBlocking has a cache, so it's cheap to do this again</span>
<a href="#l4.738"></a><span id="l4.738" class="difflineminus">-    // once we've already done it once.</span>
<a href="#l4.739"></a><span id="l4.739" class="difflineminus">-    let ds = this.rdf.GetDataSourceBlocking(url);</span>
<a href="#l4.740"></a><span id="l4.740" class="difflineminus">-    if (!ds) {</span>
<a href="#l4.741"></a><span id="l4.741" class="difflineminus">-      throw new Error(</span>
<a href="#l4.742"></a><span id="l4.742" class="difflineminus">-        &quot;FeedUtils.getItemsDS: can't get feed items data source - &quot; + url</span>
<a href="#l4.743"></a><span id="l4.743" class="difflineminus">-      );</span>
<a href="#l4.744"></a><span id="l4.744" class="difflineminus">-    }</span>
<a href="#l4.745"></a><span id="l4.745" class="difflineminus">-    // Note that it this point the datasource may not be loaded yet.</span>
<a href="#l4.746"></a><span id="l4.746" class="difflineminus">-    // You have to QueryInterface it to nsIRDFRemoteDataSource and check</span>
<a href="#l4.747"></a><span id="l4.747" class="difflineminus">-    // its &quot;loaded&quot; property to be sure.  You can also attach an observer</span>
<a href="#l4.748"></a><span id="l4.748" class="difflineminus">-    // which will get notified when the load is complete.</span>
<a href="#l4.749"></a><span id="l4.749" class="difflineplus">+    let rssServer = aServer.QueryInterface(Ci.nsIRssIncomingServer);</span>
<a href="#l4.750"></a><span id="l4.750" class="difflineplus">+    let itemsFile = rssServer.feedItemsPath; // Path to feeditems.json</span>
<a href="#l4.751"></a><span id="l4.751" class="difflineplus">+    let exists = itemsFile.exists();</span>
<a href="#l4.752"></a><span id="l4.752" class="difflineplus">+    let ds = new JSONFile({ path: itemsFile.path });</span>
<a href="#l4.753"></a><span id="l4.753" class="difflineplus">+    ds.ensureDataReady();</span>
<a href="#l4.754"></a><span id="l4.754">     if (!this[aServer.serverURI]) {</span>
<a href="#l4.755"></a><span id="l4.755">       this[aServer.serverURI] = {};</span>
<a href="#l4.756"></a><span id="l4.756">     }</span>
<a href="#l4.757"></a><span id="l4.757" class="difflineminus">-</span>
<a href="#l4.758"></a><span id="l4.758" class="difflineminus">-    return (this[aServer.serverURI].FeedItemsDS = ds.QueryInterface(</span>
<a href="#l4.759"></a><span id="l4.759" class="difflineminus">-      Ci.nsIRDFRemoteDataSource</span>
<a href="#l4.760"></a><span id="l4.760" class="difflineminus">-    ));</span>
<a href="#l4.761"></a><span id="l4.761" class="difflineminus">-  },</span>
<a href="#l4.762"></a><span id="l4.762" class="difflineminus">-</span>
<a href="#l4.763"></a><span id="l4.763" class="difflineminus">-  getItemsFile(aServer) {</span>
<a href="#l4.764"></a><span id="l4.764" class="difflineminus">-    aServer.QueryInterface(Ci.nsIRssIncomingServer);</span>
<a href="#l4.765"></a><span id="l4.765" class="difflineminus">-    let file = aServer.feedItemsDataSourcePath;</span>
<a href="#l4.766"></a><span id="l4.766" class="difflineminus">-</span>
<a href="#l4.767"></a><span id="l4.767" class="difflineminus">-    // If the file doesn't exist, create it.</span>
<a href="#l4.768"></a><span id="l4.768" class="difflineminus">-    if (!file.exists()) {</span>
<a href="#l4.769"></a><span id="l4.769" class="difflineminus">-      this.createFile(file, this.FEEDITEMS_TEMPLATE);</span>
<a href="#l4.770"></a><span id="l4.770" class="difflineminus">-      return file;</span>
<a href="#l4.771"></a><span id="l4.771" class="difflineminus">-    }</span>
<a href="#l4.772"></a><span id="l4.772" class="difflineminus">-</span>
<a href="#l4.773"></a><span id="l4.773" class="difflineminus">-    // If feeditems.rdf is not sane, duplicate messages will occur repeatedly</span>
<a href="#l4.774"></a><span id="l4.774" class="difflineminus">-    // until the file is corrected; check that the file is valid XML. This is</span>
<a href="#l4.775"></a><span id="l4.775" class="difflineminus">-    // done lazily only once in a session.</span>
<a href="#l4.776"></a><span id="l4.776" class="difflineminus">-    let fileUrl = Services.io</span>
<a href="#l4.777"></a><span id="l4.777" class="difflineminus">-      .getProtocolHandler(&quot;file&quot;)</span>
<a href="#l4.778"></a><span id="l4.778" class="difflineminus">-      .QueryInterface(Ci.nsIFileProtocolHandler)</span>
<a href="#l4.779"></a><span id="l4.779" class="difflineminus">-      .getURLSpecFromFile(file);</span>
<a href="#l4.780"></a><span id="l4.780" class="difflineminus">-    let request = new XMLHttpRequest();</span>
<a href="#l4.781"></a><span id="l4.781" class="difflineminus">-    request.open(&quot;GET&quot;, fileUrl, false);</span>
<a href="#l4.782"></a><span id="l4.782" class="difflineminus">-    request.responseType = &quot;document&quot;;</span>
<a href="#l4.783"></a><span id="l4.783" class="difflineminus">-    request.send();</span>
<a href="#l4.784"></a><span id="l4.784" class="difflineminus">-    let dom = request.responseXML;</span>
<a href="#l4.785"></a><span id="l4.785" class="difflineminus">-    if (</span>
<a href="#l4.786"></a><span id="l4.786" class="difflineminus">-      ChromeUtils.getClassName(dom) === &quot;XMLDocument&quot; &amp;&amp;</span>
<a href="#l4.787"></a><span id="l4.787" class="difflineminus">-      dom.documentElement.namespaceURI != this.MOZ_PARSERERROR_NS</span>
<a href="#l4.788"></a><span id="l4.788" class="difflineminus">-    ) {</span>
<a href="#l4.789"></a><span id="l4.789" class="difflineminus">-      return file;</span>
<a href="#l4.790"></a><span id="l4.790" class="difflineplus">+    this[aServer.serverURI].FeedItemsDS = ds;</span>
<a href="#l4.791"></a><span id="l4.791" class="difflineplus">+    if (!exists) {</span>
<a href="#l4.792"></a><span id="l4.792" class="difflineplus">+      // No feeditems.json, need to initialise our data.</span>
<a href="#l4.793"></a><span id="l4.793" class="difflineplus">+      ds.data = {};</span>
<a href="#l4.794"></a><span id="l4.794">     }</span>
<a href="#l4.795"></a><span id="l4.795" class="difflineminus">-</span>
<a href="#l4.796"></a><span id="l4.796" class="difflineminus">-    // Error on the file. Rename it and create a new one.</span>
<a href="#l4.797"></a><span id="l4.797" class="difflineminus">-    this.log.debug(&quot;FeedUtils.getItemsFile: error in feeditems.rdf&quot;);</span>
<a href="#l4.798"></a><span id="l4.798" class="difflineminus">-    let errName =</span>
<a href="#l4.799"></a><span id="l4.799" class="difflineminus">-      &quot;feeditems_error_&quot; + new Date().toISOString().replace(/\D/g, &quot;&quot;) + &quot;.rdf&quot;;</span>
<a href="#l4.800"></a><span id="l4.800" class="difflineminus">-    file.moveTo(file.parent, errName);</span>
<a href="#l4.801"></a><span id="l4.801" class="difflineminus">-    file = aServer.feedItemsDataSourcePath;</span>
<a href="#l4.802"></a><span id="l4.802" class="difflineminus">-    this.createFile(file, this.FEEDITEMS_TEMPLATE);</span>
<a href="#l4.803"></a><span id="l4.803" class="difflineminus">-    this.log.error(</span>
<a href="#l4.804"></a><span id="l4.804" class="difflineminus">-      &quot;FeedUtils.getItemsFile: error in feeditems.rdf in account '&quot; +</span>
<a href="#l4.805"></a><span id="l4.805" class="difflineminus">-        aServer.prettyName +</span>
<a href="#l4.806"></a><span id="l4.806" class="difflineminus">-        &quot;'; the file has been moved to &quot; +</span>
<a href="#l4.807"></a><span id="l4.807" class="difflineminus">-        errName +</span>
<a href="#l4.808"></a><span id="l4.808" class="difflineminus">-        &quot; and a new file has been created. Recent messages &quot; +</span>
<a href="#l4.809"></a><span id="l4.809" class="difflineminus">-        &quot;may be duplicated.&quot;</span>
<a href="#l4.810"></a><span id="l4.810" class="difflineminus">-    );</span>
<a href="#l4.811"></a><span id="l4.811" class="difflineminus">-    return file;</span>
<a href="#l4.812"></a><span id="l4.812" class="difflineminus">-  },</span>
<a href="#l4.813"></a><span id="l4.813" class="difflineminus">-</span>
<a href="#l4.814"></a><span id="l4.814" class="difflineminus">-  FEEDITEMS_TEMPLATE:</span>
<a href="#l4.815"></a><span id="l4.815" class="difflineminus">-    '&lt;?xml version=&quot;1.0&quot;?&gt;\n' +</span>
<a href="#l4.816"></a><span id="l4.816" class="difflineminus">-    '&lt;RDF:RDF xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot;\n' +</span>
<a href="#l4.817"></a><span id="l4.817" class="difflineminus">-    '         xmlns:fz=&quot;urn:forumzilla:&quot;\n' +</span>
<a href="#l4.818"></a><span id="l4.818" class="difflineminus">-    '         xmlns:RDF=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;&gt;\n' +</span>
<a href="#l4.819"></a><span id="l4.819" class="difflineminus">-    &quot;&lt;/RDF:RDF&gt;\n&quot;,</span>
<a href="#l4.820"></a><span id="l4.820" class="difflineminus">-</span>
<a href="#l4.821"></a><span id="l4.821" class="difflineminus">-  createFile(aFile, aTemplate) {</span>
<a href="#l4.822"></a><span id="l4.822" class="difflineminus">-    let fos = FileUtils.openSafeFileOutputStream(aFile);</span>
<a href="#l4.823"></a><span id="l4.823" class="difflineminus">-    fos.write(aTemplate, aTemplate.length);</span>
<a href="#l4.824"></a><span id="l4.824" class="difflineminus">-    FileUtils.closeSafeFileOutputStream(fos);</span>
<a href="#l4.825"></a><span id="l4.825" class="difflineminus">-  },</span>
<a href="#l4.826"></a><span id="l4.826" class="difflineminus">-</span>
<a href="#l4.827"></a><span id="l4.827" class="difflineminus">-  getParentTargetForChildResource(aChildResource, aParentTarget, aServer) {</span>
<a href="#l4.828"></a><span id="l4.828" class="difflineminus">-    // Generic get feed property, based on child value. Assumes 1 unique</span>
<a href="#l4.829"></a><span id="l4.829" class="difflineminus">-    // child value with 1 unique parent, valid for feeds.rdf structure.</span>
<a href="#l4.830"></a><span id="l4.830" class="difflineminus">-    let ds = this.getSubscriptionsDS(aServer);</span>
<a href="#l4.831"></a><span id="l4.831" class="difflineminus">-    let childRes = this.rdf.GetResource(aChildResource);</span>
<a href="#l4.832"></a><span id="l4.832" class="difflineminus">-    let parent = null;</span>
<a href="#l4.833"></a><span id="l4.833" class="difflineminus">-</span>
<a href="#l4.834"></a><span id="l4.834" class="difflineminus">-    let arcsIn = ds.ArcLabelsIn(childRes);</span>
<a href="#l4.835"></a><span id="l4.835" class="difflineminus">-    while (arcsIn.hasMoreElements()) {</span>
<a href="#l4.836"></a><span id="l4.836" class="difflineminus">-      let arc = arcsIn.getNext();</span>
<a href="#l4.837"></a><span id="l4.837" class="difflineminus">-      if (arc instanceof Ci.nsIRDFResource) {</span>
<a href="#l4.838"></a><span id="l4.838" class="difflineminus">-        parent = ds.GetSource(arc, childRes, true);</span>
<a href="#l4.839"></a><span id="l4.839" class="difflineminus">-        parent = parent.QueryInterface(Ci.nsIRDFResource);</span>
<a href="#l4.840"></a><span id="l4.840" class="difflineminus">-        break;</span>
<a href="#l4.841"></a><span id="l4.841" class="difflineminus">-      }</span>
<a href="#l4.842"></a><span id="l4.842" class="difflineminus">-    }</span>
<a href="#l4.843"></a><span id="l4.843" class="difflineminus">-</span>
<a href="#l4.844"></a><span id="l4.844" class="difflineminus">-    if (parent) {</span>
<a href="#l4.845"></a><span id="l4.845" class="difflineminus">-      let resource = this.rdf.GetResource(parent.Value);</span>
<a href="#l4.846"></a><span id="l4.846" class="difflineminus">-      return ds.GetTarget(resource, aParentTarget, true);</span>
<a href="#l4.847"></a><span id="l4.847" class="difflineminus">-    }</span>
<a href="#l4.848"></a><span id="l4.848" class="difflineminus">-</span>
<a href="#l4.849"></a><span id="l4.849" class="difflineminus">-    return null;</span>
<a href="#l4.850"></a><span id="l4.850" class="difflineminus">-  },</span>
<a href="#l4.851"></a><span id="l4.851" class="difflineminus">-</span>
<a href="#l4.852"></a><span id="l4.852" class="difflineminus">-  removeAssertions(aDataSource, aResource) {</span>
<a href="#l4.853"></a><span id="l4.853" class="difflineminus">-    let properties = aDataSource.ArcLabelsOut(aResource);</span>
<a href="#l4.854"></a><span id="l4.854" class="difflineminus">-    let property;</span>
<a href="#l4.855"></a><span id="l4.855" class="difflineminus">-    while (properties.hasMoreElements()) {</span>
<a href="#l4.856"></a><span id="l4.856" class="difflineminus">-      property = properties.getNext();</span>
<a href="#l4.857"></a><span id="l4.857" class="difflineminus">-      let values = aDataSource.GetTargets(aResource, property, true);</span>
<a href="#l4.858"></a><span id="l4.858" class="difflineminus">-      let value;</span>
<a href="#l4.859"></a><span id="l4.859" class="difflineminus">-      while (values.hasMoreElements()) {</span>
<a href="#l4.860"></a><span id="l4.860" class="difflineminus">-        value = values.getNext();</span>
<a href="#l4.861"></a><span id="l4.861" class="difflineminus">-        aDataSource.Unassert(aResource, property, value, true);</span>
<a href="#l4.862"></a><span id="l4.862" class="difflineminus">-      }</span>
<a href="#l4.863"></a><span id="l4.863" class="difflineminus">-    }</span>
<a href="#l4.864"></a><span id="l4.864" class="difflineplus">+    return ds;</span>
<a href="#l4.865"></a><span id="l4.865">   },</span>
<a href="#l4.866"></a><span id="l4.866"> </span>
<a href="#l4.867"></a><span id="l4.867">   /**</span>
<a href="#l4.868"></a><span id="l4.868">    * Dragging something from somewhere.  It may be a nice x-moz-url or from a</span>
<a href="#l4.869"></a><span id="l4.869">    * browser or app that provides a less nice dataTransfer object in the event.</span>
<a href="#l4.870"></a><span id="l4.870">    * Extract the url and if it passes the scheme test, try to subscribe.</span>
<a href="#l4.871"></a><span id="l4.871">    *</span>
<a href="#l4.872"></a><span id="l4.872">    * @param {nsISupports} aDataTransfer  - The dnd event's dataTransfer.</span>
<a href="#l4.873"></a><span id="l4.873" class="difflineat">@@ -2288,20 +2018,16 @@ var FeedUtils = {</span>
<a href="#l4.874"></a><span id="l4.874">       if (this.mStatusFeedback) {</span>
<a href="#l4.875"></a><span id="l4.875">         this.mStatusFeedback.showStatusString(message);</span>
<a href="#l4.876"></a><span id="l4.876">         this.mStatusFeedback.stopMeteors();</span>
<a href="#l4.877"></a><span id="l4.877">       }</span>
<a href="#l4.878"></a><span id="l4.878"> </span>
<a href="#l4.879"></a><span id="l4.879">       this.mNumPendingFeedDownloads--;</span>
<a href="#l4.880"></a><span id="l4.880"> </span>
<a href="#l4.881"></a><span id="l4.881">       if (this.mNumPendingFeedDownloads == 0) {</span>
<a href="#l4.882"></a><span id="l4.882" class="difflineminus">-        if (feed.server) {</span>
<a href="#l4.883"></a><span id="l4.883" class="difflineminus">-          FeedUtils.getSubscriptionsDS(feed.server).Flush();</span>
<a href="#l4.884"></a><span id="l4.884" class="difflineminus">-        }</span>
<a href="#l4.885"></a><span id="l4.885" class="difflineminus">-</span>
<a href="#l4.886"></a><span id="l4.886">         this.mFeeds = {};</span>
<a href="#l4.887"></a><span id="l4.887">         this.mSubscribeMode = false;</span>
<a href="#l4.888"></a><span id="l4.888">         FeedUtils.log.debug(&quot;downloaded: all pending downloads finished&quot;);</span>
<a href="#l4.889"></a><span id="l4.889"> </span>
<a href="#l4.890"></a><span id="l4.890">         // Should we do this on a timer so the text sticks around for a little</span>
<a href="#l4.891"></a><span id="l4.891">         // while?  It doesn't look like we do it on a timer for newsgroups so</span>
<a href="#l4.892"></a><span id="l4.892">         // we'll follow that model.  Don't clear the status text if we just</span>
<a href="#l4.893"></a><span id="l4.893">         // dumped an error to the status bar!</span>
<a href="#l4.894"></a><span id="l4.894" class="difflineat">@@ -2388,18 +2114,8 @@ XPCOMUtils.defineLazyGetter(FeedUtils, &quot;</span>
<a href="#l4.895"></a><span id="l4.895">   );</span>
<a href="#l4.896"></a><span id="l4.896"> });</span>
<a href="#l4.897"></a><span id="l4.897"> </span>
<a href="#l4.898"></a><span id="l4.898"> XPCOMUtils.defineLazyGetter(FeedUtils, &quot;stringsPrefs&quot;, function() {</span>
<a href="#l4.899"></a><span id="l4.899">   return Services.strings.createBundle(</span>
<a href="#l4.900"></a><span id="l4.900">     &quot;chrome://messenger/locale/prefs.properties&quot;</span>
<a href="#l4.901"></a><span id="l4.901">   );</span>
<a href="#l4.902"></a><span id="l4.902"> });</span>
<a href="#l4.903"></a><span id="l4.903" class="difflineminus">-</span>
<a href="#l4.904"></a><span id="l4.904" class="difflineminus">-XPCOMUtils.defineLazyGetter(FeedUtils, &quot;rdf&quot;, function() {</span>
<a href="#l4.905"></a><span id="l4.905" class="difflineminus">-  return Cc[&quot;@mozilla.org/rdf/rdf-service;1&quot;].getService(Ci.nsIRDFService);</span>
<a href="#l4.906"></a><span id="l4.906" class="difflineminus">-});</span>
<a href="#l4.907"></a><span id="l4.907" class="difflineminus">-</span>
<a href="#l4.908"></a><span id="l4.908" class="difflineminus">-XPCOMUtils.defineLazyGetter(FeedUtils, &quot;rdfContainerUtils&quot;, function() {</span>
<a href="#l4.909"></a><span id="l4.909" class="difflineminus">-  return Cc[&quot;@mozilla.org/rdf/container-utils;1&quot;].getService(</span>
<a href="#l4.910"></a><span id="l4.910" class="difflineminus">-    Ci.nsIRDFContainerUtils</span>
<a href="#l4.911"></a><span id="l4.911" class="difflineminus">-  );</span>
<a href="#l4.912"></a><span id="l4.912" class="difflineminus">-});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/feed-subscriptions.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/feed-subscriptions.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,13 +1,18 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l5.5"></a><span id="l5.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.6"></a><span id="l5.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.7"></a><span id="l5.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+/**</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+ * @file</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+ * GUI-side code for managing folder subscriptions.</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+ */</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+</span>
<a href="#l5.14"></a><span id="l5.14"> var { Feed, FeedItem, FeedParser, FeedUtils } = ChromeUtils.import(</span>
<a href="#l5.15"></a><span id="l5.15">   &quot;resource:///modules/FeedUtils.jsm&quot;</span>
<a href="#l5.16"></a><span id="l5.16"> );</span>
<a href="#l5.17"></a><span id="l5.17"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l5.18"></a><span id="l5.18">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l5.19"></a><span id="l5.19"> );</span>
<a href="#l5.20"></a><span id="l5.20"> var { AppConstants } = ChromeUtils.import(</span>
<a href="#l5.21"></a><span id="l5.21">   &quot;resource://gre/modules/AppConstants.jsm&quot;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -1012,19 +1017,22 @@ var FeedSubscriptions = {</span>
<a href="#l5.23"></a><span id="l5.23">   selectFeed(aFeed, aParentIndex) {</span>
<a href="#l5.24"></a><span id="l5.24">     let folder = aFeed.folder;</span>
<a href="#l5.25"></a><span id="l5.25">     let server = aFeed.server || aFeed.folder.server;</span>
<a href="#l5.26"></a><span id="l5.26">     let found = false;</span>
<a href="#l5.27"></a><span id="l5.27"> </span>
<a href="#l5.28"></a><span id="l5.28">     if (aFeed.folder.isServer) {</span>
<a href="#l5.29"></a><span id="l5.29">       // If passed the root folder, the caller wants to get the feed's folder</span>
<a href="#l5.30"></a><span id="l5.30">       // from the db (for cases of an ancestor folder rename/move).</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-      let itemResource = FeedUtils.rdf.GetResource(aFeed.url);</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-      let ds = FeedUtils.getSubscriptionsDS(server);</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-      folder = ds.GetTarget(itemResource, FeedUtils.FZ_DESTFOLDER, true);</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+      let destFolder = FeedUtils.getSubscriptionAttr(</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+        aFeed.url,</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+        server,</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+        &quot;destFolder&quot;</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+      );</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+      folder = server.rootFolder.getChildWithURI(destFolder, true, false);</span>
<a href="#l5.40"></a><span id="l5.40">     }</span>
<a href="#l5.41"></a><span id="l5.41"> </span>
<a href="#l5.42"></a><span id="l5.42">     if (this.selectFolder(folder, { parentIndex: aParentIndex })) {</span>
<a href="#l5.43"></a><span id="l5.43">       let seln = this.mView.selection;</span>
<a href="#l5.44"></a><span id="l5.44">       let item = this.mView.currentItem;</span>
<a href="#l5.45"></a><span id="l5.45">       if (item) {</span>
<a href="#l5.46"></a><span id="l5.46">         for (let i = seln.currentIndex + 1; i &lt; this.mView.rowCount; i++) {</span>
<a href="#l5.47"></a><span id="l5.47">           if (this.mView.getItemAtIndex(i).url == aFeed.url) {</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineat">@@ -1248,18 +1256,16 @@ var FeedSubscriptions = {</span>
<a href="#l5.49"></a><span id="l5.49">       // Update the feeds database, for each feed in the folder.</span>
<a href="#l5.50"></a><span id="l5.50">       feedsInFolder.forEach(function(feed) {</span>
<a href="#l5.51"></a><span id="l5.51">         feed.quickMode = aChecked;</span>
<a href="#l5.52"></a><span id="l5.52">       });</span>
<a href="#l5.53"></a><span id="l5.53">       // Update the folder's feeds properties in the tree map.</span>
<a href="#l5.54"></a><span id="l5.54">       item.children.forEach(function(feed) {</span>
<a href="#l5.55"></a><span id="l5.55">         feed.quickMode = aChecked;</span>
<a href="#l5.56"></a><span id="l5.56">       });</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-      let ds = FeedUtils.getSubscriptionsDS(item.folder.server);</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-      ds.Flush();</span>
<a href="#l5.59"></a><span id="l5.59">     }</span>
<a href="#l5.60"></a><span id="l5.60"> </span>
<a href="#l5.61"></a><span id="l5.61">     // Update the folder in the tree map.</span>
<a href="#l5.62"></a><span id="l5.62">     item.quickMode = aChecked;</span>
<a href="#l5.63"></a><span id="l5.63">     let message = FeedUtils.strings.GetStringFromName(&quot;subscribe-feedUpdated&quot;);</span>
<a href="#l5.64"></a><span id="l5.64">     this.updateStatusItem(&quot;statusText&quot;, message);</span>
<a href="#l5.65"></a><span id="l5.65">   },</span>
<a href="#l5.66"></a><span id="l5.66"> </span>
<a href="#l5.67"></a><span id="l5.67" class="difflineat">@@ -1343,18 +1349,16 @@ var FeedSubscriptions = {</span>
<a href="#l5.68"></a><span id="l5.68">     }</span>
<a href="#l5.69"></a><span id="l5.69"> </span>
<a href="#l5.70"></a><span id="l5.70">     if (isServer) {</span>
<a href="#l5.71"></a><span id="l5.71">       FeedUtils.setOptionsAcct(item.folder.server, item.options);</span>
<a href="#l5.72"></a><span id="l5.72">     } else {</span>
<a href="#l5.73"></a><span id="l5.73">       let feed = new Feed(item.url, item.parentFolder);</span>
<a href="#l5.74"></a><span id="l5.74">       feed.title = item.name;</span>
<a href="#l5.75"></a><span id="l5.75">       feed.options = item.options;</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineminus">-      let ds = FeedUtils.getSubscriptionsDS(item.parentFolder.server);</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineminus">-      ds.Flush();</span>
<a href="#l5.78"></a><span id="l5.78"> </span>
<a href="#l5.79"></a><span id="l5.79">       if (aNode.id == &quot;updateEnabled&quot;) {</span>
<a href="#l5.80"></a><span id="l5.80">         FeedUtils.setStatus(</span>
<a href="#l5.81"></a><span id="l5.81">           item.parentFolder,</span>
<a href="#l5.82"></a><span id="l5.82">           item.url,</span>
<a href="#l5.83"></a><span id="l5.83">           &quot;enabled&quot;,</span>
<a href="#l5.84"></a><span id="l5.84">           aNode.checked</span>
<a href="#l5.85"></a><span id="l5.85">         );</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineat">@@ -1794,44 +1798,37 @@ var FeedSubscriptions = {</span>
<a href="#l5.87"></a><span id="l5.87">       this.mView.getParentIndex(aOldFeedIndex) == aNewParentIndex</span>
<a href="#l5.88"></a><span id="l5.88">     ) {</span>
<a href="#l5.89"></a><span id="l5.89">       // If the new parent is the same as the current parent, then do nothing.</span>
<a href="#l5.90"></a><span id="l5.90">       return;</span>
<a href="#l5.91"></a><span id="l5.91">     }</span>
<a href="#l5.92"></a><span id="l5.92"> </span>
<a href="#l5.93"></a><span id="l5.93">     let currentParentIndex = this.mView.getParentIndex(aOldFeedIndex);</span>
<a href="#l5.94"></a><span id="l5.94">     let currentParentItem = this.mView.getItemAtIndex(currentParentIndex);</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineminus">-    let currentParentResource = FeedUtils.rdf.GetResource(</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">-      currentParentItem.url</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineminus">-    );</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineminus">-    let currentFolder = currentParentResource.QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+    let currentFolder = currentParentItem.folder;</span>
<a href="#l5.100"></a><span id="l5.100"> </span>
<a href="#l5.101"></a><span id="l5.101">     let newParentItem = this.mView.getItemAtIndex(aNewParentIndex);</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineminus">-    let newParentResource = FeedUtils.rdf.GetResource(newParentItem.url);</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineminus">-    let newFolder = newParentResource.QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+    let newFolder = newParentItem.folder;</span>
<a href="#l5.105"></a><span id="l5.105"> </span>
<a href="#l5.106"></a><span id="l5.106">     let accountMoveCopy = false;</span>
<a href="#l5.107"></a><span id="l5.107">     if (currentFolder.rootFolder.URI == newFolder.rootFolder.URI) {</span>
<a href="#l5.108"></a><span id="l5.108">       // Moving within the same account/feeds db.</span>
<a href="#l5.109"></a><span id="l5.109">       if (newFolder.isServer || !moveFeed) {</span>
<a href="#l5.110"></a><span id="l5.110">         // No moving to account folder if already in the account; can only move,</span>
<a href="#l5.111"></a><span id="l5.111">         // not copy, to folder in the same account.</span>
<a href="#l5.112"></a><span id="l5.112">         return;</span>
<a href="#l5.113"></a><span id="l5.113">       }</span>
<a href="#l5.114"></a><span id="l5.114"> </span>
<a href="#l5.115"></a><span id="l5.115" class="difflineminus">-      // Unassert the older URI, add an assertion for the new parent URI.</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineminus">-      let feedResource = FeedUtils.rdf.GetResource(currentItem.url);</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineminus">-      let ds = FeedUtils.getSubscriptionsDS(currentItem.parentFolder.server);</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineminus">-      ds.Change(</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineminus">-        feedResource,</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineminus">-        FeedUtils.FZ_DESTFOLDER,</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineminus">-        currentParentResource,</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineminus">-        newParentResource</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+      // Update the destFolder for this feed's subscription.</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+      FeedUtils.setSubscriptionAttr(</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+        currentItem.url,</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+        currentItem.parentFolder.server,</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+        &quot;destFolder&quot;,</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+        newFolder.URI</span>
<a href="#l5.129"></a><span id="l5.129">       );</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineminus">-      ds.Flush();</span>
<a href="#l5.131"></a><span id="l5.131"> </span>
<a href="#l5.132"></a><span id="l5.132">       // Update folderpane favicons.</span>
<a href="#l5.133"></a><span id="l5.133">       FeedUtils.setFolderPaneProperty(currentFolder, &quot;favicon&quot;, null, &quot;row&quot;);</span>
<a href="#l5.134"></a><span id="l5.134">       FeedUtils.setFolderPaneProperty(newFolder, &quot;favicon&quot;, null, &quot;row&quot;);</span>
<a href="#l5.135"></a><span id="l5.135">     } else {</span>
<a href="#l5.136"></a><span id="l5.136">       // Moving/copying to a new account.  If dropping on the account folder,</span>
<a href="#l5.137"></a><span id="l5.137">       // a new subfolder is created if necessary.</span>
<a href="#l5.138"></a><span id="l5.138">       accountMoveCopy = true;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/newsblogOverlay.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/newsblogOverlay.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -142,42 +142,31 @@ var FeedMessageHandler = {</span>
<a href="#l6.4"></a><span id="l6.4">     switch (this.onSelectPref) {</span>
<a href="#l6.5"></a><span id="l6.5">       case this.kSelectOverrideWebPage:</span>
<a href="#l6.6"></a><span id="l6.6">         showSummary = false;</span>
<a href="#l6.7"></a><span id="l6.7">         break;</span>
<a href="#l6.8"></a><span id="l6.8">       case this.kSelectOverrideSummary:</span>
<a href="#l6.9"></a><span id="l6.9">         showSummary = true;</span>
<a href="#l6.10"></a><span id="l6.10">         break;</span>
<a href="#l6.11"></a><span id="l6.11">       case this.kSelectFeedDefault:</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-        // Get quickmode per feed folder pref from feeds.rdf. If the feed</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+        // Get quickmode per feed folder pref from feed subscriptions. If the feed</span>
<a href="#l6.14"></a><span id="l6.14">         // message is not in a feed account folder (hence the folder is not in</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-        // the feeds database), or FZ_QUICKMODE property is not found (possible</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-        // in pre renovation urls), err on the side of showing the summary.</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+        // the feeds database), err on the side of showing the summary.</span>
<a href="#l6.18"></a><span id="l6.18">         // For the former, toggle or global override is necessary; for the</span>
<a href="#l6.19"></a><span id="l6.19">         // latter, a show summary checkbox toggle in Subscribe dialog will set</span>
<a href="#l6.20"></a><span id="l6.20">         // one on the path to bliss.</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-        let folder = aMsgHdr.folder,</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-          targetRes;</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-        try {</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-          targetRes = FeedUtils.getParentTargetForChildResource(</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-            folder.URI,</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-            FeedUtils.FZ_QUICKMODE,</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">-            folder.server</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">-          );</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-        } catch (ex) {</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-          // Not in a feed account folder or other error.</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-          FeedUtils.log.info(</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-            &quot;FeedMessageHandler.shouldShowSummary: could not &quot; +</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-              &quot;get summary pref for this folder&quot;</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-          );</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+        let folder = aMsgHdr.folder;</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+        showSummary = true;</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+        const ds = FeedUtils.getSubscriptionsDS(folder.server);</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+        for (let sub of ds.data) {</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+          if (sub.destFolder == folder.URI) {</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+            showSummary = sub.quickMode;</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+            break;</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+          }</span>
<a href="#l6.43"></a><span id="l6.43">         }</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-        showSummary =</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-          targetRes &amp;&amp;</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-          targetRes.QueryInterface(Ci.nsIRDFLiteral).Value != &quot;false&quot;;</span>
<a href="#l6.48"></a><span id="l6.48">         break;</span>
<a href="#l6.49"></a><span id="l6.49">     }</span>
<a href="#l6.50"></a><span id="l6.50"> </span>
<a href="#l6.51"></a><span id="l6.51">     gShowFeedSummary = this.gShowSummary = showSummary;</span>
<a href="#l6.52"></a><span id="l6.52"> </span>
<a href="#l6.53"></a><span id="l6.53">     if (messageWindow || messageTab) {</span>
<a href="#l6.54"></a><span id="l6.54">       // Message opened in either standalone window or tab, due to either</span>
<a href="#l6.55"></a><span id="l6.55">       // message open pref (we are here only if the pref is 0 or 1) or</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/local/public/nsIRssIncomingServer.idl</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/local/public/nsIRssIncomingServer.idl</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -3,14 +3,14 @@</span>
<a href="#l7.4"></a><span id="l7.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8"> interface nsIFile;</span>
<a href="#l7.9"></a><span id="l7.9"> </span>
<a href="#l7.10"></a><span id="l7.10"> [scriptable, uuid(6d744e7f-2218-45c6-8734-998a56cb3c6d)]</span>
<a href="#l7.11"></a><span id="l7.11"> interface nsIRssIncomingServer : nsISupports {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  // Path to the subscriptions data source for this RSS server</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-  readonly attribute nsIFile subscriptionsDataSourcePath;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+  // Path to the subscriptions file for this RSS server.</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+  readonly attribute nsIFile subscriptionsPath;</span>
<a href="#l7.16"></a><span id="l7.16"> </span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-  // Path to the feed items data source for this RSS server</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-  readonly attribute nsIFile feedItemsDataSourcePath;</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+  // Path to the feed items file for this RSS server.</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+  readonly attribute nsIFile feedItemsPath;</span>
<a href="#l7.21"></a><span id="l7.21"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/local/src/nsMsgLocalStoreUtils.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/local/src/nsMsgLocalStoreUtils.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -41,18 +41,20 @@ bool nsMsgLocalStoreUtils::nsShouldIgnor</span>
<a href="#l8.4"></a><span id="l8.4">   if (StringEndsWith(name, NS_LITERAL_STRING(&quot;.snm&quot;)) ||</span>
<a href="#l8.5"></a><span id="l8.5">       name.LowerCaseEqualsLiteral(&quot;popstate.dat&quot;) ||</span>
<a href="#l8.6"></a><span id="l8.6">       name.LowerCaseEqualsLiteral(&quot;sort.dat&quot;) ||</span>
<a href="#l8.7"></a><span id="l8.7">       name.LowerCaseEqualsLiteral(&quot;mailfilt.log&quot;) ||</span>
<a href="#l8.8"></a><span id="l8.8">       name.LowerCaseEqualsLiteral(&quot;filters.js&quot;) ||</span>
<a href="#l8.9"></a><span id="l8.9">       StringEndsWith(name, NS_LITERAL_STRING(&quot;.toc&quot;)))</span>
<a href="#l8.10"></a><span id="l8.10">     return true;</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  // ignore RSS data source files</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-  if (name.LowerCaseEqualsLiteral(&quot;feeds.rdf&quot;) ||</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+  // ignore RSS data source files (see FeedUtils.jsm)</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+  if (name.LowerCaseEqualsLiteral(&quot;feeds.json&quot;) ||</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+      name.LowerCaseEqualsLiteral(&quot;feeditems.json&quot;) ||</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+      name.LowerCaseEqualsLiteral(&quot;feeds.rdf&quot;) ||</span>
<a href="#l8.18"></a><span id="l8.18">       name.LowerCaseEqualsLiteral(&quot;feeditems.rdf&quot;) ||</span>
<a href="#l8.19"></a><span id="l8.19">       StringBeginsWith(name, NS_LITERAL_STRING(&quot;feeditems_error&quot;)))</span>
<a href="#l8.20"></a><span id="l8.20">     return true;</span>
<a href="#l8.21"></a><span id="l8.21"> </span>
<a href="#l8.22"></a><span id="l8.22">   // The .mozmsgs dir is for spotlight support</span>
<a href="#l8.23"></a><span id="l8.23">   return (StringEndsWith(name, NS_LITERAL_STRING(&quot;.mozmsgs&quot;)) ||</span>
<a href="#l8.24"></a><span id="l8.24">           StringEndsWith(name, NS_LITERAL_STRING(FOLDER_SUFFIX)) ||</span>
<a href="#l8.25"></a><span id="l8.25">           StringEndsWith(name, NS_LITERAL_STRING(SUMMARY_SUFFIX)));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/local/src/nsRssIncomingServer.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/local/src/nsRssIncomingServer.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -60,24 +60,24 @@ nsresult nsRssIncomingServer::FillInData</span>
<a href="#l9.4"></a><span id="l9.4"> </span>
<a href="#l9.5"></a><span id="l9.5">   // Append the name of the subscriptions data source.</span>
<a href="#l9.6"></a><span id="l9.6">   rv = localFile-&gt;Append(aDataSourceName);</span>
<a href="#l9.7"></a><span id="l9.7">   localFile.forget(aLocation);</span>
<a href="#l9.8"></a><span id="l9.8">   return rv;</span>
<a href="#l9.9"></a><span id="l9.9"> }</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11"> // nsIRSSIncomingServer methods</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-NS_IMETHODIMP nsRssIncomingServer::GetSubscriptionsDataSourcePath(</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+NS_IMETHODIMP nsRssIncomingServer::GetSubscriptionsPath(</span>
<a href="#l9.14"></a><span id="l9.14">     nsIFile **aLocation) {</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-  return FillInDataSourcePath(NS_LITERAL_STRING(&quot;feeds.rdf&quot;), aLocation);</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+  return FillInDataSourcePath(NS_LITERAL_STRING(&quot;feeds.json&quot;), aLocation);</span>
<a href="#l9.17"></a><span id="l9.17"> }</span>
<a href="#l9.18"></a><span id="l9.18"> </span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-NS_IMETHODIMP nsRssIncomingServer::GetFeedItemsDataSourcePath(</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+NS_IMETHODIMP nsRssIncomingServer::GetFeedItemsPath(</span>
<a href="#l9.21"></a><span id="l9.21">     nsIFile **aLocation) {</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-  return FillInDataSourcePath(NS_LITERAL_STRING(&quot;feeditems.rdf&quot;), aLocation);</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+  return FillInDataSourcePath(NS_LITERAL_STRING(&quot;feeditems.json&quot;), aLocation);</span>
<a href="#l9.24"></a><span id="l9.24"> }</span>
<a href="#l9.25"></a><span id="l9.25"> </span>
<a href="#l9.26"></a><span id="l9.26"> NS_IMETHODIMP nsRssIncomingServer::CreateDefaultMailboxes() {</span>
<a href="#l9.27"></a><span id="l9.27">   // For Feeds, all we have is Trash.</span>
<a href="#l9.28"></a><span id="l9.28">   return CreateLocalFolder(NS_LITERAL_STRING(&quot;Trash&quot;));</span>
<a href="#l9.29"></a><span id="l9.29"> }</span>
<a href="#l9.30"></a><span id="l9.30"> </span>
<a href="#l9.31"></a><span id="l9.31"> NS_IMETHODIMP nsRssIncomingServer::SetFlagsOnDefaultMailboxes() {</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

