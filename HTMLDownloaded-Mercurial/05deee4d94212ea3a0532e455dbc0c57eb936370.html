<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 28872:05deee4d94212ea3a0532e455dbc0c57eb936370</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 05deee4d94212ea3a0532e455dbc0c57eb936370" />
<meta property="og:url" content="/comm-central/rev/05deee4d94212ea3a0532e455dbc0c57eb936370" />
<meta property="og:description" content="Bug 1518166 - Add build script for libotr and dependencies." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 05deee4d94212ea3a0532e455dbc0c57eb936370 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/05deee4d94212ea3a0532e455dbc0c57eb936370">shortlog</a> |
<a href="/comm-central/log/05deee4d94212ea3a0532e455dbc0c57eb936370">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/05deee4d94212ea3a0532e455dbc0c57eb936370">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/05deee4d94212ea3a0532e455dbc0c57eb936370">files</a> |
changeset |
<a href="/comm-central/raw-rev/05deee4d94212ea3a0532e455dbc0c57eb936370">raw</a>  | <a href="/comm-central/archive/05deee4d94212ea3a0532e455dbc0c57eb936370.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1518166">Bug 1518166</a> - Add build script for libotr and dependencies.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#82;&#111;&#98;&#32;&#76;&#101;&#109;&#108;&#101;&#121;&#32;&#60;&#114;&#111;&#98;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 17 Dec 2019 19:35:36 -0500</td></tr>

<tr>
 <td>changeset 28872</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/05deee4d94212ea3a0532e455dbc0c57eb936370">05deee4d94212ea3a0532e455dbc0c57eb936370</a></td>
</tr>



<tr>
<td>parent 28871</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/bf1398d08b742253e4d5f2c0815608db02c02646">bf1398d08b742253e4d5f2c0815608db02c02646</a>
</td>
</tr>

<tr>
<td>child 28873</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/11a79da52f31a2f90b0c168c3de9a7a72a4d90fa">11a79da52f31a2f90b0c168c3de9a7a72a4d90fa</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=05deee4d94212ea3a0532e455dbc0c57eb936370">17087</a></td></tr>
<tr><td>push user</td><td>thunderbird@calypsoblue.org</td></tr>
<tr><td>push date</td><td class="date age">Mon, 02 Mar 2020 20:11:30 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@e0e05018f705 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e0e05018f705af08c3b98472483c02c69d25d9ec">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e0e05018f705af08c3b98472483c02c69d25d9ec&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e0e05018f705af08c3b98472483c02c69d25d9ec&newProject=comm-central&newRevision=05deee4d94212ea3a0532e455dbc0c57eb936370&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e0e05018f705af08c3b98472483c02c69d25d9ec&newProject=comm-central&newRevision=05deee4d94212ea3a0532e455dbc0c57eb936370&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e0e05018f705af08c3b98472483c02c69d25d9ec&newProject=comm-central&newRevision=05deee4d94212ea3a0532e455dbc0c57eb936370&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1518166">1518166</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1518166">Bug 1518166</a> - Add build script for libotr and dependencies.

Build libotr for OTR messaging feature. The script is intended to run on
Taskcluster, and will not be part of the normal build process.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/05deee4d94212ea3a0532e455dbc0c57eb936370/taskcluster/scripts/build-libotr.sh">taskcluster/scripts/build-libotr.sh</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/05deee4d94212ea3a0532e455dbc0c57eb936370/taskcluster/scripts/build-libotr.sh">file</a> |
<a href="/comm-central/annotate/05deee4d94212ea3a0532e455dbc0c57eb936370/taskcluster/scripts/build-libotr.sh">annotate</a> |
<a href="/comm-central/diff/05deee4d94212ea3a0532e455dbc0c57eb936370/taskcluster/scripts/build-libotr.sh">diff</a> |
<a href="/comm-central/comparison/05deee4d94212ea3a0532e455dbc0c57eb936370/taskcluster/scripts/build-libotr.sh">comparison</a> |
<a href="/comm-central/log/05deee4d94212ea3a0532e455dbc0c57eb936370/taskcluster/scripts/build-libotr.sh">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/05deee4d94212ea3a0532e455dbc0c57eb936370/third_party/clang/x86_64-apple-darwin.cfg">third_party/clang/x86_64-apple-darwin.cfg</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/05deee4d94212ea3a0532e455dbc0c57eb936370/third_party/clang/x86_64-apple-darwin.cfg">file</a> |
<a href="/comm-central/annotate/05deee4d94212ea3a0532e455dbc0c57eb936370/third_party/clang/x86_64-apple-darwin.cfg">annotate</a> |
<a href="/comm-central/diff/05deee4d94212ea3a0532e455dbc0c57eb936370/third_party/clang/x86_64-apple-darwin.cfg">diff</a> |
<a href="/comm-central/comparison/05deee4d94212ea3a0532e455dbc0c57eb936370/third_party/clang/x86_64-apple-darwin.cfg">comparison</a> |
<a href="/comm-central/log/05deee4d94212ea3a0532e455dbc0c57eb936370/third_party/clang/x86_64-apple-darwin.cfg">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1">new file mode 100755</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineminus">--- /dev/null</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineplus">+++ b/taskcluster/scripts/build-libotr.sh</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineat">@@ -0,0 +1,289 @@</span>
<a href="#l1.5"></a><span id="l1.5" class="difflineplus">+#!/bin/bash</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.7"></a><span id="l1.7" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.8"></a><span id="l1.8" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineplus">+</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineplus">+set -x -e -v</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineplus">+</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+_TARGET_OS=&quot;$1&quot;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+# Environment variables that are set by Taskcluster.</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+GECKO_PATH=${GECKO_PATH:-&quot;/builds/worker/checkouts/gecko&quot;}</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+MOZ_FETCHES_DIR=${MOZ_FETCHES_DIR:-&quot;/builds/worker/workspace/fetches&quot;}</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+UPLOAD_DIR=${UPLOAD_DIR:-&quot;/builds/worker/artifacts&quot;}</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+WORKSPACE=${WORKSPACE:-&quot;${HOME}/workspace&quot;}</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+cd &quot;$WORKSPACE&quot;</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+rm -rf build &amp;&amp; mkdir build</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+BUILD=&quot;${WORKSPACE}/build&quot;</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+COMPRESS_EXT=xz</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+_INSTDIR=&quot;build_prefix&quot;</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+_PREFIX=&quot;${BUILD}/${_INSTDIR}&quot;</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+_ARTIFACT_STAGEDIR=&quot;${BUILD}/libotr_stage&quot;</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+THIRD_PARTY_SRC=&quot;${GECKO_PATH}/comm/third_party&quot;</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+GPG_ERROR_SRC=&quot;${BUILD}/libgpg-error&quot;</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+GCRYPT_SRC=&quot;${BUILD}/libgcrypt&quot;</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+OTR_SRC=&quot;${BUILD}/libotr&quot;</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+# Set environment variables needed for all dependencies</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+_BASE_CONFIGURE=&quot;--build=x86_64-pc-linux --prefix=${_PREFIX} --disable-silent-rules&quot;</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+_OS_CONFIGURE_FLAGS=&quot;&quot; # May be overridden per target OS</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+_BASE_MAKE_FLAGS=&quot;-j$(nproc)&quot;</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+_OS_MAKE_FLAGS=&quot;&quot; # May be overridden per target OS</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+# Download the macOS SDK when building for macOS</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+if [[ -n &quot;$TOOLTOOL_MANIFEST&quot; ]]; then</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+    source &quot;${GECKO_PATH}/taskcluster/scripts/misc/tooltool-download.sh&quot;</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+fi</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+function clang_cfg_macos() {</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+    # autotools and friends seem to work better with Clang if the compiler</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+    # is named &lt;target&gt;-clang. This applies to macOS only. It does not seem</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+    # necessary when building for Linux.</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+    local _clang_cfg _clang_dir</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+    if [[ &quot;${_TARGET_OS}&quot; == &quot;macosx64&quot; ]]; then</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+        _clang_cfg=&quot;${THIRD_PARTY_SRC}/clang/x86_64-apple-darwin.cfg&quot;</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+        _clang_dir=&quot;${MOZ_FETCHES_DIR}/clang/bin&quot;</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+        cp -a ${_clang_cfg} &quot;${_clang_dir}&quot;</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+        ln -s clang &quot;${_clang_dir}/x86_64-apple-darwin-clang&quot;</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+    fi</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+    return 0</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+}</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+function copy_sources() {</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+    # The checkout directory should be treated readonly</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+    local _pkg</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+    cd &quot;${BUILD}&quot;</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+    for _pkg in libgpg-error libgcrypt libotr; do</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+        cp -a &quot;${THIRD_PARTY_SRC}/${_pkg}&quot; .</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+    done</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+}</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+function build_libgpg-error() {</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+    echo &quot;Building libgpg-error&quot;</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+    cd &quot;${GPG_ERROR_SRC}&quot;</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+    ./configure ${_CONFIGURE_FLAGS} ${_CONF_STATIC} \</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+        --disable-tests --disable-doc --with-pic</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+    make ${_MAKE_FLAGS} -C src code-to-errno.h</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+    make ${_MAKE_FLAGS} -C src code-from-errno.h</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+    make ${_MAKE_FLAGS} -C src gpg-error.h</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+    make ${_MAKE_FLAGS} -C src libgpg-error.la</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+    make -C src install-nodist_includeHEADERS install-pkgconfigDATA \</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+        install-m4dataDATA install-binSCRIPTS install-libLTLIBRARIES</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+    return $?</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+}</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+function build_libgcrypt() {</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+    echo &quot;Building libgcrypt&quot;</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+    cd &quot;${GCRYPT_SRC}&quot;</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineplus">+    ./configure ${_CONFIGURE_FLAGS} ${_CONF_STATIC} \</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineplus">+        --disable-doc --with-pic &quot;${_GCRYPT_CONF_FLAGS}&quot; \</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineplus">+        --with-libgpg-error-prefix=&quot;${_PREFIX}&quot;</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineplus">+</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+    make ${_MAKE_FLAGS} -C cipher libcipher.la</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+    make ${_MAKE_FLAGS} -C random librandom.la</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+    make ${_MAKE_FLAGS} -C mpi libmpi.la</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+    make ${_MAKE_FLAGS} -C compat libcompat.la</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+    make ${_MAKE_FLAGS} -C src libgcrypt.la</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineplus">+    make -C src install-nodist_includeHEADERS \</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineplus">+        install-m4dataDATA install-binSCRIPTS install-libLTLIBRARIES</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+    return $?</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+}</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+function build_libotr() {</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+    local _f</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineplus">+</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+    echo &quot;Building libotr&quot;</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+    cd &quot;${OTR_SRC}&quot;</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+    aclocal -I &quot;${_PREFIX}/share/aclocal&quot;</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineplus">+    autoconf</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+    automake</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+    CFLAGS=&quot;${CFLAGS_otr} ${CFLAGS}&quot;</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineplus">+    LDFLAGS=&quot;${LDFLAGS_otr} ${LDFLAGS}&quot;</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+    ./configure ${_CONFIGURE_FLAGS} --enable-shared \</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+        --with-libgcrypt-prefix=&quot;${_PREFIX}&quot;</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineplus">+</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+    make ${_MAKE_FLAGS} -C src</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineplus">+    case &quot;${_TARGET_OS}&quot; in</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+        win*)</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineplus">+            cd src</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineplus">+            &quot;${CC}&quot; -shared ${LDFLAGS} -o libotr-5.dll \</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineplus">+                *.o -lws2_32 -lssp -lgcrypt -lgpg-error</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineplus">+            cp libotr-5.dll &quot;${_PREFIX}/bin&quot;</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineplus">+            ;;</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineplus">+        *)</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineplus">+            make ${_MAKE_FLAGS} -C src install-libLTLIBRARIES</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineplus">+            ;;</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineplus">+    esac</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineplus">+    return $?</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineplus">+}</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+function package_libotr_artifact() {</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+    local _f</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineplus">+</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineplus">+    cd ${BUILD}</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+    rm -rf &quot;${_ARTIFACT_STAGEDIR}&quot;</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+    mkdir ${_ARTIFACT_STAGEDIR}</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineplus">+    for _f in ${_TARGET_LIBS}; do</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineplus">+        install &quot;${_INSTDIR}/${_f}&quot; ${_ARTIFACT_STAGEDIR}</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineplus">+    done</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineplus">+    case &quot;${_TARGET_OS}&quot; in</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineplus">+        win*)</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineplus">+            install &quot;${_LIBDIR}/libssp-0.dll&quot; ${_ARTIFACT_STAGEDIR}</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineplus">+            ;;</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+    esac</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+    rm -rf ${UPLOAD_DIR} &amp;&amp; mkdir -p &quot;${UPLOAD_DIR}&quot;</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+    TARFILE=&quot;${UPLOAD_DIR}/libotr.tar.${COMPRESS_EXT}&quot;</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineplus">+    tar -acf &quot;${TARFILE}&quot; -C ${_ARTIFACT_STAGEDIR} .</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineplus">+</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineplus">+    return 0</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+}</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineplus">+</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineplus">+# variables specific to an arch, but apply to all dependencies</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineplus">+case &quot;${_TARGET_OS}&quot; in</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineplus">+    win32)</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineplus">+        export PATH=&quot;${MOZ_FETCHES_DIR}/mingw32/bin:$PATH&quot;</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineplus">+        export _TARGET_TRIPLE=&quot;i686-w64-mingw32&quot;</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineplus">+        export CC=&quot;${_TARGET_TRIPLE}-gcc&quot;</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineplus">+        _LIBDIR=&quot;/usr/lib/gcc/${_TARGET_TRIPLE}/8.3-win32&quot;</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineplus">+        export LDFLAGS=&quot;-L${_LIBDIR}&quot;</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineplus">+        _OS_CONFIGURE_FLAGS=&quot;--host=${_TARGET_TRIPLE} --target=${_TARGET_TRIPLE}&quot;</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineplus">+        _CONF_STATIC=&quot;&quot;</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineplus">+</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineplus">+        LDFLAGS_otr=&quot;-Wl,-no-undefined,-L${_PREFIX}/lib,-lgcrypt,-lgpg-error,-lssp&quot;</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineplus">+        _TARGET_LIBS=&quot;bin/libotr-5.dll bin/libgcrypt-20.dll bin/libgpg-error-0.dll&quot;</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineplus">+        EXE=.exe</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineplus">+        ;;</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineplus">+    win64)</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineplus">+        export PATH=&quot;${MOZ_FETCHES_DIR}/mingw32/bin:$PATH&quot;</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineplus">+        export _TARGET_TRIPLE=&quot;x86_64-w64-mingw32&quot;</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineplus">+        export CC=&quot;${_TARGET_TRIPLE}-gcc&quot;</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineplus">+        _LIBDIR=&quot;/usr/lib/gcc/${_TARGET_TRIPLE}/8.3-win32&quot;</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineplus">+        export LDFLAGS=&quot;-L${_LIBDIR}&quot;</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineplus">+        _OS_CONFIGURE_FLAGS=&quot;--host=${_TARGET_TRIPLE} --target=${_TARGET_TRIPLE}&quot;</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineplus">+        _CONF_STATIC=&quot;&quot;</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineplus">+</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineplus">+        LDFLAGS_otr=&quot;-Wl,-no-undefined,-L${_PREFIX}/lib,-lgcrypt,-lgpg-error,-lssp&quot;</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineplus">+        _TARGET_LIBS=&quot;bin/libotr-5.dll bin/libgcrypt-20.dll bin/libgpg-error6-0.dll&quot;</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineplus">+        EXE=.exe</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineplus">+        ;;</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineplus">+    macosx64)</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineplus">+        for _t in cctools/bin clang/bin binutils/bin; do</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineplus">+            PATH=&quot;${MOZ_FETCHES_DIR}/${_t}:$PATH&quot;</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineplus">+        done</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineplus">+        export PATH</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineplus">+</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineplus">+        export _TARGET_TRIPLE=&quot;x86_64-apple-darwin&quot;</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineplus">+        export MACOS_SDK_DIR=&quot;${MOZ_FETCHES_DIR}/MacOSX10.11.sdk&quot;</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineplus">+        export CROSS_PRIVATE_FRAMEWORKS=&quot;${MACOS_SDK_DIR}/System/Library/PrivateFrameworks&quot;</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineplus">+        export CROSS_SYSROOT=&quot;${MACOS_SDK_DIR}&quot;</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineplus">+</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineplus">+        export CC=&quot;${_TARGET_TRIPLE}-clang&quot;</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineplus">+        export LD=&quot;${_TARGET_TRIPLE}-ld&quot;</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineplus">+        export CFLAGS=&quot;-isysroot ${CROSS_SYSROOT}&quot;</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineplus">+        export LDFLAGS=&quot;-isysroot ${CROSS_SYSROOT}&quot;</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineplus">+        export DSYMUTIL=&quot;${MOZ_FETCHES_DIR}/llvm-dsymutil/llvm-dsymutil&quot;</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineplus">+</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineplus">+        _OS_CONFIGURE_FLAGS=&quot;--host=${_TARGET_TRIPLE} --target=${_TARGET_TRIPLE}&quot;</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineplus">+        _CONF_STATIC=&quot;--enable-static --disable-shared&quot;</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineplus">+</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineplus">+        LDFLAGS_otr=&quot;-shared&quot;</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineplus">+</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineplus">+        _TARGET_LIBS=&quot;lib/libotr.5.dylib&quot;</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineplus">+        EXE=</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineplus">+        ;;</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineplus">+    linux32)</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineplus">+        for _t in clang/bin binutils/bin; do</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineplus">+            PATH=&quot;${MOZ_FETCHES_DIR}/${_t}:$PATH&quot;</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineplus">+        done</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineplus">+        export PATH</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineplus">+</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineplus">+        export _TARGET_TRIPLE=&quot;i686-pc-linux&quot;</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineplus">+        export CC=&quot;clang&quot;</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineplus">+        export CFLAGS=&quot;--target=${_TARGET_TRIPLE} -m32 -march=pentium-m -msse -msse2 -mfpmath=sse&quot;</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineplus">+        export LDFLAGS=&quot;--target=${_TARGET_TRIPLE} -m32 -march=pentium-m -msse -msse2 -mfpmath=sse&quot;</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineplus">+</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineplus">+        export AR=llvm-ar</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineplus">+        export RANLIB=llvm-ranlib</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineplus">+        export NM=llvm-nm</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineplus">+        export LD=ld.lld</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineplus">+        export STRIP=llvm-strip</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineplus">+</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineplus">+        CFLAGS_otr=&quot;-Wl,-Bstatic,-L${_PREFIX}/lib,-lgcrypt,-L${_PREFIX}/lib,-lgpg-error,-Bdynamic&quot;</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineplus">+        LDFLAGS_otr=&quot;-Wl,-Bstatic,-L${_PREFIX}/lib,-lgcrypt,-L${_PREFIX}/lib,-lgpg-error,-Bdynamic&quot;</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineplus">+</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineplus">+        _OS_CONFIGURE_FLAGS=&quot;--host=${_TARGET_TRIPLE} --target=${_TARGET_TRIPLE}&quot;</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineplus">+        _GCRYPT_CONF_FLAGS=&quot;--disable-asm&quot;</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineplus">+        _CONF_STATIC=&quot;--enable-static --disable-shared&quot;</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineplus">+        _TARGET_LIBS='lib/libotr.so.5'</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineplus">+        EXE=</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineplus">+        ;;</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineplus">+    linux64)</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineplus">+        for _t in clang/bin binutils/bin; do</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineplus">+            PATH=&quot;${MOZ_FETCHES_DIR}/${_t}:$PATH&quot;</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineplus">+        done</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineplus">+        export PATH</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineplus">+</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineplus">+        export _TARGET_TRIPLE=&quot;x86_64-pc-linux&quot;</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineplus">+        export CC=&quot;clang&quot;</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineplus">+        export AR=llvm-ar</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineplus">+        export RANLIB=llvm-ranlib</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineplus">+        export NM=llvm-nm</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineplus">+        export LD=ld.lld</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineplus">+        export STRIP=llvm-strip</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineplus">+</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineplus">+        CFLAGS_otr=&quot;-Wl,-Bstatic,-L${_PREFIX}/lib,-lgcrypt,-L${_PREFIX}/lib,-lgpg-error,-Bdynamic&quot;</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineplus">+        LDFLAGS_otr=&quot;-Wl,-Bstatic,-L${_PREFIX}/lib,-lgcrypt,-L${_PREFIX}/lib,-lgpg-error,-Bdynamic&quot;</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineplus">+</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineplus">+        _OS_CONFIGURE_FLAGS=&quot;--host=${_TARGET_TRIPLE} --target=${_TARGET_TRIPLE}&quot;</span>
<a href="#l1.264"></a><span id="l1.264" class="difflineplus">+        _CONF_STATIC=&quot;--enable-static --disable-shared&quot;</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineplus">+        _TARGET_LIBS='lib/libotr.so.5'</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineplus">+        EXE=</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineplus">+        ;;</span>
<a href="#l1.268"></a><span id="l1.268" class="difflineplus">+    *)</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineplus">+        echo &quot;Invalid target platform: ${_TARGET_OS}&quot;</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineplus">+        exit 1</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineplus">+        ;;</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineplus">+esac</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineplus">+</span>
<a href="#l1.274"></a><span id="l1.274" class="difflineplus">+_CONFIGURE_FLAGS=&quot;${_BASE_CONFIGURE} ${_OS_CONFIGURE_FLAGS}&quot;</span>
<a href="#l1.275"></a><span id="l1.275" class="difflineplus">+_MAKE_FLAGS=&quot;${_BASE_MAKE_FLAGS} ${_OS_MAKE_FLAGS}&quot;</span>
<a href="#l1.276"></a><span id="l1.276" class="difflineplus">+</span>
<a href="#l1.277"></a><span id="l1.277" class="difflineplus">+# Basic dependency structure.</span>
<a href="#l1.278"></a><span id="l1.278" class="difflineplus">+# Build block, followed by packaging block.</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineplus">+# Each step in a block depends on the previous completing successfully.</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineplus">+# The packaging block depends on the build block's success.</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineplus">+{</span>
<a href="#l1.282"></a><span id="l1.282" class="difflineplus">+    copy_sources &amp;&amp;</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineplus">+        clang_cfg_macos &amp;&amp;</span>
<a href="#l1.284"></a><span id="l1.284" class="difflineplus">+        build_libgpg-error &amp;&amp;</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineplus">+        build_libgcrypt &amp;&amp;</span>
<a href="#l1.286"></a><span id="l1.286" class="difflineplus">+        build_libotr</span>
<a href="#l1.287"></a><span id="l1.287" class="difflineplus">+} &amp;&amp; {</span>
<a href="#l1.288"></a><span id="l1.288" class="difflineplus">+    package_libotr_artifact</span>
<a href="#l1.289"></a><span id="l1.289" class="difflineplus">+} &amp;&amp; exit 0</span>
<a href="#l1.290"></a><span id="l1.290" class="difflineplus">+</span>
<a href="#l1.291"></a><span id="l1.291" class="difflineplus">+# Ideally, the &quot;exit 0&quot; above ran after the packaging block ran successfully.</span>
<a href="#l1.292"></a><span id="l1.292" class="difflineplus">+# In case it didn't, error out here so CI catches it.</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineplus">+exit 1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/third_party/clang/x86_64-apple-darwin.cfg</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,1 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+-target x86_64-apple-darwin</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

