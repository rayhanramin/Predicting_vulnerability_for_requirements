<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 17808:5996a8864a31857e7f41e7fd3d47ec98d42516e0</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 5996a8864a31857e7f41e7fd3d47ec98d42516e0" />
<meta property="og:url" content="/comm-central/rev/5996a8864a31857e7f41e7fd3d47ec98d42516e0" />
<meta property="og:description" content="Bug 1123124 - Part 2: Remove use of expression closure from mailnews/db/. r=jcranmer" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 5996a8864a31857e7f41e7fd3d47ec98d42516e0 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/5996a8864a31857e7f41e7fd3d47ec98d42516e0">shortlog</a> |
<a href="/comm-central/log/5996a8864a31857e7f41e7fd3d47ec98d42516e0">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/5996a8864a31857e7f41e7fd3d47ec98d42516e0">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/5996a8864a31857e7f41e7fd3d47ec98d42516e0">files</a> |
changeset |
<a href="/comm-central/raw-rev/5996a8864a31857e7f41e7fd3d47ec98d42516e0">raw</a>  | <a href="/comm-central/archive/5996a8864a31857e7f41e7fd3d47ec98d42516e0.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1123124">Bug 1123124</a> - Part 2: Remove use of expression closure from mailnews/db/. r=jcranmer
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#84;&#111;&#111;&#114;&#117;&#32;&#70;&#117;&#106;&#105;&#115;&#97;&#119;&#97;&#32;&#60;&#97;&#114;&#97;&#105;&#95;&#97;&#64;&#109;&#97;&#99;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 20 Apr 2015 00:16:23 +0900</td></tr>

<tr>
 <td>changeset 17808</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/5996a8864a31857e7f41e7fd3d47ec98d42516e0">5996a8864a31857e7f41e7fd3d47ec98d42516e0</a></td>
</tr>



<tr>
<td>parent 17807</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/05a8c7d3c908f687275458ed8b8a443ea954054d">05a8c7d3c908f687275458ed8b8a443ea954054d</a>
</td>
</tr>

<tr>
<td>child 17809</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/db3e708b2267baff9b6a85daa51e209dc2a0ae6a">db3e708b2267baff9b6a85daa51e209dc2a0ae6a</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=5996a8864a31857e7f41e7fd3d47ec98d42516e0">10953</a></td></tr>
<tr><td>push user</td><td>arai_a@mac.com</td></tr>
<tr><td>push date</td><td class="date age">Sun, 19 Apr 2015 15:17:20 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@1f40bc6a4a87 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1f40bc6a4a87b41a019be9d0f174ab64d0d7cf96">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1f40bc6a4a87b41a019be9d0f174ab64d0d7cf96&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1f40bc6a4a87b41a019be9d0f174ab64d0d7cf96&newProject=comm-central&newRevision=05a8c7d3c908f687275458ed8b8a443ea954054d&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1f40bc6a4a87b41a019be9d0f174ab64d0d7cf96&newProject=comm-central&newRevision=05a8c7d3c908f687275458ed8b8a443ea954054d&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1f40bc6a4a87b41a019be9d0f174ab64d0d7cf96&newProject=comm-central&newRevision=05a8c7d3c908f687275458ed8b8a443ea954054d&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28jcranmer%29&revcount=50">jcranmer</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1123124">1123124</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1123124">Bug 1123124</a> - Part 2: Remove use of expression closure from mailnews/db/. r=jcranmer</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/content/glodacomplete.xml">mailnews/db/gloda/content/glodacomplete.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/content/glodacomplete.xml">file</a> |
<a href="/comm-central/annotate/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/content/glodacomplete.xml">annotate</a> |
<a href="/comm-central/diff/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/content/glodacomplete.xml">diff</a> |
<a href="/comm-central/comparison/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/content/glodacomplete.xml">comparison</a> |
<a href="/comm-central/log/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/content/glodacomplete.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/modules/datastore.js">mailnews/db/gloda/modules/datastore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/modules/datastore.js">file</a> |
<a href="/comm-central/annotate/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/modules/datastore.js">annotate</a> |
<a href="/comm-central/diff/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/modules/datastore.js">diff</a> |
<a href="/comm-central/comparison/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/modules/datastore.js">comparison</a> |
<a href="/comm-central/log/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/modules/datastore.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/modules/fundattr.js">mailnews/db/gloda/modules/fundattr.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/modules/fundattr.js">file</a> |
<a href="/comm-central/annotate/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/modules/fundattr.js">annotate</a> |
<a href="/comm-central/diff/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/modules/fundattr.js">diff</a> |
<a href="/comm-central/comparison/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/modules/fundattr.js">comparison</a> |
<a href="/comm-central/log/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/modules/fundattr.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/modules/log4moz.js">mailnews/db/gloda/modules/log4moz.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/modules/log4moz.js">file</a> |
<a href="/comm-central/annotate/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/modules/log4moz.js">annotate</a> |
<a href="/comm-central/diff/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/modules/log4moz.js">diff</a> |
<a href="/comm-central/comparison/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/modules/log4moz.js">comparison</a> |
<a href="/comm-central/log/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/modules/log4moz.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/modules/mimemsg.js">mailnews/db/gloda/modules/mimemsg.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/modules/mimemsg.js">file</a> |
<a href="/comm-central/annotate/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/modules/mimemsg.js">annotate</a> |
<a href="/comm-central/diff/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/modules/mimemsg.js">diff</a> |
<a href="/comm-central/comparison/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/modules/mimemsg.js">comparison</a> |
<a href="/comm-central/log/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/modules/mimemsg.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/test/unit/base_index_messages.js">mailnews/db/gloda/test/unit/base_index_messages.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/test/unit/base_index_messages.js">file</a> |
<a href="/comm-central/annotate/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/test/unit/base_index_messages.js">annotate</a> |
<a href="/comm-central/diff/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/test/unit/base_index_messages.js">diff</a> |
<a href="/comm-central/comparison/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/test/unit/base_index_messages.js">comparison</a> |
<a href="/comm-central/log/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/test/unit/base_index_messages.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/test/unit/test_index_compaction.js">mailnews/db/gloda/test/unit/test_index_compaction.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/test/unit/test_index_compaction.js">file</a> |
<a href="/comm-central/annotate/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/test/unit/test_index_compaction.js">annotate</a> |
<a href="/comm-central/diff/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/test/unit/test_index_compaction.js">diff</a> |
<a href="/comm-central/comparison/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/test/unit/test_index_compaction.js">comparison</a> |
<a href="/comm-central/log/5996a8864a31857e7f41e7fd3d47ec98d42516e0/mailnews/db/gloda/test/unit/test_index_compaction.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/db/gloda/content/glodacomplete.xml</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/db/gloda/content/glodacomplete.xml</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -57,24 +57,24 @@</span>
<a href="#l1.4"></a><span id="l1.4">             // in the xbl constructor</span>
<a href="#l1.5"></a><span id="l1.5">             item.className = &quot;autocomplete-richlistitem&quot;;</span>
<a href="#l1.6"></a><span id="l1.6">             this.richlistbox.appendChild(item);</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8">             this._currentIndex++;</span>
<a href="#l1.9"></a><span id="l1.9">           }</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11">           // yield after each batch of items so that typing the url bar is responsive</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-          setTimeout(function (self) { self._appendCurrentResult(); }, 0, this);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+          setTimeout(() =&gt; this._appendCurrentResult(), 0);</span>
<a href="#l1.14"></a><span id="l1.14">         ]]&gt;</span>
<a href="#l1.15"></a><span id="l1.15">         &lt;/body&gt;</span>
<a href="#l1.16"></a><span id="l1.16">       &lt;/method&gt;</span>
<a href="#l1.17"></a><span id="l1.17">       &lt;method name=&quot;_invalidate&quot;&gt;</span>
<a href="#l1.18"></a><span id="l1.18">         &lt;body&gt;</span>
<a href="#l1.19"></a><span id="l1.19">           &lt;![CDATA[</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-          setTimeout(function(self) self.adjustHeight(), 0, this);</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+          setTimeout(() =&gt; this.adjustHeight(), 0);</span>
<a href="#l1.22"></a><span id="l1.22"> </span>
<a href="#l1.23"></a><span id="l1.23">           // remove all child nodes because we never want to reuse them.</span>
<a href="#l1.24"></a><span id="l1.24">           while (this.richlistbox.hasChildNodes())</span>
<a href="#l1.25"></a><span id="l1.25">             this.richlistbox.lastChild.remove();</span>
<a href="#l1.26"></a><span id="l1.26"> </span>
<a href="#l1.27"></a><span id="l1.27">           this._currentIndex = 0;</span>
<a href="#l1.28"></a><span id="l1.28">           this._appendCurrentResult();</span>
<a href="#l1.29"></a><span id="l1.29">         ]]&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/db/gloda/modules/datastore.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/datastore.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1686,35 +1686,35 @@ var GlodaDatastore = {</span>
<a href="#l2.4"></a><span id="l2.4">   _transactionDepth: 0,</span>
<a href="#l2.5"></a><span id="l2.5">   _transactionGood: false,</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7">   /**</span>
<a href="#l2.8"></a><span id="l2.8">    * Self-memoizing BEGIN TRANSACTION statement.</span>
<a href="#l2.9"></a><span id="l2.9">    */</span>
<a href="#l2.10"></a><span id="l2.10">   get _beginTransactionStatement() {</span>
<a href="#l2.11"></a><span id="l2.11">     let statement = this._createAsyncStatement(&quot;BEGIN TRANSACTION&quot;);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    this.__defineGetter__(&quot;_beginTransactionStatement&quot;, function() statement);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    this.__defineGetter__(&quot;_beginTransactionStatement&quot;, () =&gt; statement);</span>
<a href="#l2.14"></a><span id="l2.14">     return this._beginTransactionStatement;</span>
<a href="#l2.15"></a><span id="l2.15">   },</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17">   /**</span>
<a href="#l2.18"></a><span id="l2.18">    * Self-memoizing COMMIT statement.</span>
<a href="#l2.19"></a><span id="l2.19">    */</span>
<a href="#l2.20"></a><span id="l2.20">   get _commitTransactionStatement() {</span>
<a href="#l2.21"></a><span id="l2.21">     let statement = this._createAsyncStatement(&quot;COMMIT&quot;);</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-    this.__defineGetter__(&quot;_commitTransactionStatement&quot;, function() statement);</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+    this.__defineGetter__(&quot;_commitTransactionStatement&quot;, () =&gt; statement);</span>
<a href="#l2.24"></a><span id="l2.24">     return this._commitTransactionStatement;</span>
<a href="#l2.25"></a><span id="l2.25">   },</span>
<a href="#l2.26"></a><span id="l2.26"> </span>
<a href="#l2.27"></a><span id="l2.27">   /**</span>
<a href="#l2.28"></a><span id="l2.28">    * Self-memoizing ROLLBACK statement.</span>
<a href="#l2.29"></a><span id="l2.29">    */</span>
<a href="#l2.30"></a><span id="l2.30">   get _rollbackTransactionStatement() {</span>
<a href="#l2.31"></a><span id="l2.31">     let statement = this._createAsyncStatement(&quot;ROLLBACK&quot;);</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-    this.__defineGetter__(&quot;_rollbackTransactionStatement&quot;, function() statement);</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+    this.__defineGetter__(&quot;_rollbackTransactionStatement&quot;, () =&gt; statement);</span>
<a href="#l2.34"></a><span id="l2.34">     return this._rollbackTransactionStatement;</span>
<a href="#l2.35"></a><span id="l2.35">   },</span>
<a href="#l2.36"></a><span id="l2.36"> </span>
<a href="#l2.37"></a><span id="l2.37">   _pendingPostCommitCallbacks: null,</span>
<a href="#l2.38"></a><span id="l2.38">   /**</span>
<a href="#l2.39"></a><span id="l2.39">    * Register a callback to be invoked when the current transaction's commit</span>
<a href="#l2.40"></a><span id="l2.40">    *  completes.</span>
<a href="#l2.41"></a><span id="l2.41">    */</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineat">@@ -1848,17 +1848,17 @@ var GlodaDatastore = {</span>
<a href="#l2.43"></a><span id="l2.43">     stmt.finalize();</span>
<a href="#l2.44"></a><span id="l2.44">   },</span>
<a href="#l2.45"></a><span id="l2.45"> </span>
<a href="#l2.46"></a><span id="l2.46">   get _insertAttributeDefStatement() {</span>
<a href="#l2.47"></a><span id="l2.47">     let statement = this._createAsyncStatement(</span>
<a href="#l2.48"></a><span id="l2.48">       &quot;INSERT INTO attributeDefinitions (id, attributeType, extensionName, \</span>
<a href="#l2.49"></a><span id="l2.49">                                   name, parameter) \</span>
<a href="#l2.50"></a><span id="l2.50">               VALUES (?1, ?2, ?3, ?4, ?5)&quot;);</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-    this.__defineGetter__(&quot;_insertAttributeDefStatement&quot;, function() statement);</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+    this.__defineGetter__(&quot;_insertAttributeDefStatement&quot;, () =&gt; statement);</span>
<a href="#l2.53"></a><span id="l2.53">     return this._insertAttributeDefStatement;</span>
<a href="#l2.54"></a><span id="l2.54">   },</span>
<a href="#l2.55"></a><span id="l2.55"> </span>
<a href="#l2.56"></a><span id="l2.56">   /**</span>
<a href="#l2.57"></a><span id="l2.57">    * Create an attribute definition and return the row ID.  Special/atypical</span>
<a href="#l2.58"></a><span id="l2.58">    *  in that it doesn't directly return a GlodaAttributeDBDef; we leave that up</span>
<a href="#l2.59"></a><span id="l2.59">    *  to the caller since they know much more than actually needs to go in the</span>
<a href="#l2.60"></a><span id="l2.60">    *  database.</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineat">@@ -1953,17 +1953,17 @@ var GlodaDatastore = {</span>
<a href="#l2.62"></a><span id="l2.62">   _nextFolderId: 1,</span>
<a href="#l2.63"></a><span id="l2.63"> </span>
<a href="#l2.64"></a><span id="l2.64">   get _insertFolderLocationStatement() {</span>
<a href="#l2.65"></a><span id="l2.65">     let statement = this._createAsyncStatement(</span>
<a href="#l2.66"></a><span id="l2.66">       &quot;INSERT INTO folderLocations (id, folderURI, dirtyStatus, name, \</span>
<a href="#l2.67"></a><span id="l2.67">                                     indexingPriority) VALUES \</span>
<a href="#l2.68"></a><span id="l2.68">         (?1, ?2, ?3, ?4, ?5)&quot;);</span>
<a href="#l2.69"></a><span id="l2.69">     this.__defineGetter__(&quot;_insertFolderLocationStatement&quot;,</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-      function() statement);</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+      () =&gt; statement);</span>
<a href="#l2.72"></a><span id="l2.72">     return this._insertFolderLocationStatement;</span>
<a href="#l2.73"></a><span id="l2.73">   },</span>
<a href="#l2.74"></a><span id="l2.74"> </span>
<a href="#l2.75"></a><span id="l2.75">   /**</span>
<a href="#l2.76"></a><span id="l2.76">    * Authoritative map from folder URI to folder ID.  (Authoritative in the</span>
<a href="#l2.77"></a><span id="l2.77">    *  sense that this map exactly represents the state of the underlying</span>
<a href="#l2.78"></a><span id="l2.78">    *  database.  If it does not, it's a bug in updating the database.)</span>
<a href="#l2.79"></a><span id="l2.79">    */</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineat">@@ -2129,49 +2129,49 @@ var GlodaDatastore = {</span>
<a href="#l2.81"></a><span id="l2.81">     delete this._folderByID[aGlodaFolder.id];</span>
<a href="#l2.82"></a><span id="l2.82">   },</span>
<a href="#l2.83"></a><span id="l2.83"> </span>
<a href="#l2.84"></a><span id="l2.84">   get _updateFolderDirtyStatusStatement() {</span>
<a href="#l2.85"></a><span id="l2.85">     let statement = this._createAsyncStatement(</span>
<a href="#l2.86"></a><span id="l2.86">       &quot;UPDATE folderLocations SET dirtyStatus = ?1 \</span>
<a href="#l2.87"></a><span id="l2.87">               WHERE id = ?2&quot;);</span>
<a href="#l2.88"></a><span id="l2.88">     this.__defineGetter__(&quot;_updateFolderDirtyStatusStatement&quot;,</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-      function() statement);</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+      () =&gt; statement);</span>
<a href="#l2.91"></a><span id="l2.91">     return this._updateFolderDirtyStatusStatement;</span>
<a href="#l2.92"></a><span id="l2.92">   },</span>
<a href="#l2.93"></a><span id="l2.93"> </span>
<a href="#l2.94"></a><span id="l2.94">   updateFolderDirtyStatus: function gloda_ds_updateFolderDirtyStatus(aFolder) {</span>
<a href="#l2.95"></a><span id="l2.95">     let ufds = this._updateFolderDirtyStatusStatement;</span>
<a href="#l2.96"></a><span id="l2.96">     ufds.bindInt64Parameter(1, aFolder.id);</span>
<a href="#l2.97"></a><span id="l2.97">     ufds.bindInt64Parameter(0, aFolder.dirtyStatus);</span>
<a href="#l2.98"></a><span id="l2.98">     ufds.executeAsync(this.trackAsync());</span>
<a href="#l2.99"></a><span id="l2.99">   },</span>
<a href="#l2.100"></a><span id="l2.100"> </span>
<a href="#l2.101"></a><span id="l2.101">   get _updateFolderIndexingPriorityStatement() {</span>
<a href="#l2.102"></a><span id="l2.102">     let statement = this._createAsyncStatement(</span>
<a href="#l2.103"></a><span id="l2.103">       &quot;UPDATE folderLocations SET indexingPriority = ?1 \</span>
<a href="#l2.104"></a><span id="l2.104">               WHERE id = ?2&quot;);</span>
<a href="#l2.105"></a><span id="l2.105">     this.__defineGetter__(&quot;_updateFolderIndexingPriorityStatement&quot;,</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-      function() statement);</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineplus">+      () =&gt; statement);</span>
<a href="#l2.108"></a><span id="l2.108">     return this._updateFolderIndexingPriorityStatement;</span>
<a href="#l2.109"></a><span id="l2.109">   },</span>
<a href="#l2.110"></a><span id="l2.110"> </span>
<a href="#l2.111"></a><span id="l2.111">   updateFolderIndexingPriority: function gloda_ds_updateFolderIndexingPriority(aFolder) {</span>
<a href="#l2.112"></a><span id="l2.112">     let ufip = this._updateFolderIndexingPriorityStatement;</span>
<a href="#l2.113"></a><span id="l2.113">     ufip.bindInt64Parameter(1, aFolder.id);</span>
<a href="#l2.114"></a><span id="l2.114">     ufip.bindInt64Parameter(0, aFolder.indexingPriority);</span>
<a href="#l2.115"></a><span id="l2.115">     ufip.executeAsync(this.trackAsync());</span>
<a href="#l2.116"></a><span id="l2.116">   },</span>
<a href="#l2.117"></a><span id="l2.117"> </span>
<a href="#l2.118"></a><span id="l2.118">   get _updateFolderLocationStatement() {</span>
<a href="#l2.119"></a><span id="l2.119">     let statement = this._createAsyncStatement(</span>
<a href="#l2.120"></a><span id="l2.120">       &quot;UPDATE folderLocations SET folderURI = ?1 \</span>
<a href="#l2.121"></a><span id="l2.121">               WHERE id = ?2&quot;);</span>
<a href="#l2.122"></a><span id="l2.122">     this.__defineGetter__(&quot;_updateFolderLocationStatement&quot;,</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-      function() statement);</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+      () =&gt; statement);</span>
<a href="#l2.125"></a><span id="l2.125">     return this._updateFolderLocationStatement;</span>
<a href="#l2.126"></a><span id="l2.126">   },</span>
<a href="#l2.127"></a><span id="l2.127"> </span>
<a href="#l2.128"></a><span id="l2.128">   /**</span>
<a href="#l2.129"></a><span id="l2.129">    * Non-recursive asynchronous folder renaming based on the URI.</span>
<a href="#l2.130"></a><span id="l2.130">    *</span>
<a href="#l2.131"></a><span id="l2.131">    * @TODO provide a mechanism for recursive folder renames or have a higher</span>
<a href="#l2.132"></a><span id="l2.132">    *     layer deal with it and remove this note.</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineat">@@ -2190,17 +2190,17 @@ var GlodaDatastore = {</span>
<a href="#l2.134"></a><span id="l2.134"> </span>
<a href="#l2.135"></a><span id="l2.135">     delete this._folderByURI[oldURI];</span>
<a href="#l2.136"></a><span id="l2.136">   },</span>
<a href="#l2.137"></a><span id="l2.137"> </span>
<a href="#l2.138"></a><span id="l2.138">   get _deleteFolderByIDStatement() {</span>
<a href="#l2.139"></a><span id="l2.139">     let statement = this._createAsyncStatement(</span>
<a href="#l2.140"></a><span id="l2.140">       &quot;DELETE FROM folderLocations WHERE id = ?1&quot;);</span>
<a href="#l2.141"></a><span id="l2.141">     this.__defineGetter__(&quot;_deleteFolderByIDStatement&quot;,</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineminus">-      function() statement);</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineplus">+      () =&gt; statement);</span>
<a href="#l2.144"></a><span id="l2.144">     return this._deleteFolderByIDStatement;</span>
<a href="#l2.145"></a><span id="l2.145">   },</span>
<a href="#l2.146"></a><span id="l2.146"> </span>
<a href="#l2.147"></a><span id="l2.147">   deleteFolderByID: function gloda_ds_deleteFolder(aFolderID) {</span>
<a href="#l2.148"></a><span id="l2.148">     let dfbis = this._deleteFolderByIDStatement;</span>
<a href="#l2.149"></a><span id="l2.149">     dfbis.bindInt64Parameter(0, aFolderID);</span>
<a href="#l2.150"></a><span id="l2.150">     dfbis.executeAsync(this.trackAsync());</span>
<a href="#l2.151"></a><span id="l2.151">   },</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineat">@@ -2289,26 +2289,26 @@ var GlodaDatastore = {</span>
<a href="#l2.153"></a><span id="l2.153">     stmt.finalize();</span>
<a href="#l2.154"></a><span id="l2.154">   },</span>
<a href="#l2.155"></a><span id="l2.155"> </span>
<a href="#l2.156"></a><span id="l2.156">   get _insertConversationStatement() {</span>
<a href="#l2.157"></a><span id="l2.157">     let statement = this._createAsyncStatement(</span>
<a href="#l2.158"></a><span id="l2.158">       &quot;INSERT INTO conversations (id, subject, oldestMessageDate, \</span>
<a href="#l2.159"></a><span id="l2.159">                                   newestMessageDate) \</span>
<a href="#l2.160"></a><span id="l2.160">               VALUES (?1, ?2, ?3, ?4)&quot;);</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineminus">-    this.__defineGetter__(&quot;_insertConversationStatement&quot;, function() statement);</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineplus">+    this.__defineGetter__(&quot;_insertConversationStatement&quot;, () =&gt; statement);</span>
<a href="#l2.163"></a><span id="l2.163">     return this._insertConversationStatement;</span>
<a href="#l2.164"></a><span id="l2.164">   },</span>
<a href="#l2.165"></a><span id="l2.165"> </span>
<a href="#l2.166"></a><span id="l2.166">   get _insertConversationTextStatement() {</span>
<a href="#l2.167"></a><span id="l2.167">     let statement = this._createAsyncStatement(</span>
<a href="#l2.168"></a><span id="l2.168">       &quot;INSERT INTO conversationsText (docid, subject) \</span>
<a href="#l2.169"></a><span id="l2.169">               VALUES (?1, ?2)&quot;);</span>
<a href="#l2.170"></a><span id="l2.170">     this.__defineGetter__(&quot;_insertConversationTextStatement&quot;,</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineminus">-      function() statement);</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineplus">+      () =&gt; statement);</span>
<a href="#l2.173"></a><span id="l2.173">     return this._insertConversationTextStatement;</span>
<a href="#l2.174"></a><span id="l2.174">   },</span>
<a href="#l2.175"></a><span id="l2.175"> </span>
<a href="#l2.176"></a><span id="l2.176">   /**</span>
<a href="#l2.177"></a><span id="l2.177">    * Asynchronously create a conversation.</span>
<a href="#l2.178"></a><span id="l2.178">    */</span>
<a href="#l2.179"></a><span id="l2.179">   createConversation: function gloda_ds_createConversation(aSubject,</span>
<a href="#l2.180"></a><span id="l2.180">         aOldestMessageDate, aNewestMessageDate) {</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineat">@@ -2343,17 +2343,17 @@ var GlodaDatastore = {</span>
<a href="#l2.182"></a><span id="l2.182">     // return it</span>
<a href="#l2.183"></a><span id="l2.183">     return conversation;</span>
<a href="#l2.184"></a><span id="l2.184">   },</span>
<a href="#l2.185"></a><span id="l2.185"> </span>
<a href="#l2.186"></a><span id="l2.186">   get _deleteConversationByIDStatement() {</span>
<a href="#l2.187"></a><span id="l2.187">     let statement = this._createAsyncStatement(</span>
<a href="#l2.188"></a><span id="l2.188">       &quot;DELETE FROM conversations WHERE id = ?1&quot;);</span>
<a href="#l2.189"></a><span id="l2.189">     this.__defineGetter__(&quot;_deleteConversationByIDStatement&quot;,</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineminus">-                          function() statement);</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineplus">+                          () =&gt; statement);</span>
<a href="#l2.192"></a><span id="l2.192">     return this._deleteConversationByIDStatement;</span>
<a href="#l2.193"></a><span id="l2.193">   },</span>
<a href="#l2.194"></a><span id="l2.194"> </span>
<a href="#l2.195"></a><span id="l2.195">   /**</span>
<a href="#l2.196"></a><span id="l2.196">    * Asynchronously delete a conversation given its ID.</span>
<a href="#l2.197"></a><span id="l2.197">    */</span>
<a href="#l2.198"></a><span id="l2.198">   deleteConversationByID: function gloda_ds_deleteConversationByID(</span>
<a href="#l2.199"></a><span id="l2.199">                                       aConversationID) {</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineat">@@ -2401,26 +2401,26 @@ var GlodaDatastore = {</span>
<a href="#l2.201"></a><span id="l2.201">     stmt.finalize();</span>
<a href="#l2.202"></a><span id="l2.202">   },</span>
<a href="#l2.203"></a><span id="l2.203"> </span>
<a href="#l2.204"></a><span id="l2.204">   get _insertMessageStatement() {</span>
<a href="#l2.205"></a><span id="l2.205">     let statement = this._createAsyncStatement(</span>
<a href="#l2.206"></a><span id="l2.206">       &quot;INSERT INTO messages (id, folderID, messageKey, conversationID, date, \</span>
<a href="#l2.207"></a><span id="l2.207">                              headerMessageID, jsonAttributes, notability) \</span>
<a href="#l2.208"></a><span id="l2.208">               VALUES (?1, ?2, ?3, ?4, ?5, ?6, ?7, ?8)&quot;);</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineminus">-    this.__defineGetter__(&quot;_insertMessageStatement&quot;, function() statement);</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineplus">+    this.__defineGetter__(&quot;_insertMessageStatement&quot;, () =&gt; statement);</span>
<a href="#l2.211"></a><span id="l2.211">     return this._insertMessageStatement;</span>
<a href="#l2.212"></a><span id="l2.212">   },</span>
<a href="#l2.213"></a><span id="l2.213"> </span>
<a href="#l2.214"></a><span id="l2.214">   get _insertMessageTextStatement() {</span>
<a href="#l2.215"></a><span id="l2.215">     let statement = this._createAsyncStatement(</span>
<a href="#l2.216"></a><span id="l2.216">       &quot;INSERT INTO messagesText (docid, subject, body, attachmentNames, \</span>
<a href="#l2.217"></a><span id="l2.217">                                  author, recipients) \</span>
<a href="#l2.218"></a><span id="l2.218">               VALUES (?1, ?2, ?3, ?4, ?5, ?6)&quot;);</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineminus">-    this.__defineGetter__(&quot;_insertMessageTextStatement&quot;, function() statement);</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineplus">+    this.__defineGetter__(&quot;_insertMessageTextStatement&quot;, () =&gt; statement);</span>
<a href="#l2.221"></a><span id="l2.221">     return this._insertMessageTextStatement;</span>
<a href="#l2.222"></a><span id="l2.222">   },</span>
<a href="#l2.223"></a><span id="l2.223"> </span>
<a href="#l2.224"></a><span id="l2.224">   /**</span>
<a href="#l2.225"></a><span id="l2.225">    * Create a GlodaMessage with the given properties.  Because this is only half</span>
<a href="#l2.226"></a><span id="l2.226">    *  of the process of creating a message (the attributes still need to be</span>
<a href="#l2.227"></a><span id="l2.227">    *  completed), it's on the caller's head to call GlodaCollectionManager's</span>
<a href="#l2.228"></a><span id="l2.228">    *  itemAdded method once the message is fully created.</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineat">@@ -2538,27 +2538,27 @@ var GlodaDatastore = {</span>
<a href="#l2.230"></a><span id="l2.230">                            messageKey = ?2, \</span>
<a href="#l2.231"></a><span id="l2.231">                            conversationID = ?3, \</span>
<a href="#l2.232"></a><span id="l2.232">                            date = ?4, \</span>
<a href="#l2.233"></a><span id="l2.233">                            headerMessageID = ?5, \</span>
<a href="#l2.234"></a><span id="l2.234">                            jsonAttributes = ?6, \</span>
<a href="#l2.235"></a><span id="l2.235">                            notability = ?7, \</span>
<a href="#l2.236"></a><span id="l2.236">                            deleted = ?8 \</span>
<a href="#l2.237"></a><span id="l2.237">               WHERE id = ?9&quot;);</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineminus">-    this.__defineGetter__(&quot;_updateMessageStatement&quot;, function() statement);</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineplus">+    this.__defineGetter__(&quot;_updateMessageStatement&quot;, () =&gt; statement);</span>
<a href="#l2.240"></a><span id="l2.240">     return this._updateMessageStatement;</span>
<a href="#l2.241"></a><span id="l2.241">   },</span>
<a href="#l2.242"></a><span id="l2.242"> </span>
<a href="#l2.243"></a><span id="l2.243">   get _updateMessageTextStatement() {</span>
<a href="#l2.244"></a><span id="l2.244">     let statement = this._createAsyncStatement(</span>
<a href="#l2.245"></a><span id="l2.245">       &quot;UPDATE messagesText SET body = ?1, \</span>
<a href="#l2.246"></a><span id="l2.246">                                attachmentNames = ?2 \</span>
<a href="#l2.247"></a><span id="l2.247">               WHERE docid = ?3&quot;);</span>
<a href="#l2.248"></a><span id="l2.248"> </span>
<a href="#l2.249"></a><span id="l2.249" class="difflineminus">-    this.__defineGetter__(&quot;_updateMessageTextStatement&quot;, function() statement);</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineplus">+    this.__defineGetter__(&quot;_updateMessageTextStatement&quot;, () =&gt; statement);</span>
<a href="#l2.251"></a><span id="l2.251">     return this._updateMessageTextStatement;</span>
<a href="#l2.252"></a><span id="l2.252">   },</span>
<a href="#l2.253"></a><span id="l2.253"> </span>
<a href="#l2.254"></a><span id="l2.254">   /**</span>
<a href="#l2.255"></a><span id="l2.255">    * Update the database row associated with the message. If the message is</span>
<a href="#l2.256"></a><span id="l2.256">    * not a ghost and has _isNew defined, messagesText is affected.</span>
<a href="#l2.257"></a><span id="l2.257">    *</span>
<a href="#l2.258"></a><span id="l2.258">    * aMessage._isNew is currently equivalent to the fact that there is no</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineat">@@ -2643,17 +2643,17 @@ var GlodaDatastore = {</span>
<a href="#l2.260"></a><span id="l2.260">             this.asyncConnection.lastErrorString + &quot; - &quot; + ex);</span>
<a href="#l2.261"></a><span id="l2.261">     }</span>
<a href="#l2.262"></a><span id="l2.262">   },</span>
<a href="#l2.263"></a><span id="l2.263"> </span>
<a href="#l2.264"></a><span id="l2.264">   get _updateMessageLocationStatement() {</span>
<a href="#l2.265"></a><span id="l2.265">     let statement = this._createAsyncStatement(</span>
<a href="#l2.266"></a><span id="l2.266">       &quot;UPDATE messages SET folderID = ?1, messageKey = ?2 WHERE id = ?3&quot;);</span>
<a href="#l2.267"></a><span id="l2.267">     this.__defineGetter__(&quot;_updateMessageLocationStatement&quot;,</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineminus">-                          function() statement);</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineplus">+                          () =&gt; statement);</span>
<a href="#l2.270"></a><span id="l2.270">     return this._updateMessageLocationStatement;</span>
<a href="#l2.271"></a><span id="l2.271">   },</span>
<a href="#l2.272"></a><span id="l2.272"> </span>
<a href="#l2.273"></a><span id="l2.273">   /**</span>
<a href="#l2.274"></a><span id="l2.274">    * Given a list of gloda message ids, and a list of their new message keys in</span>
<a href="#l2.275"></a><span id="l2.275">    *  the given new folder location, asynchronously update the message's</span>
<a href="#l2.276"></a><span id="l2.276">    *  database locations.  Also, update the in-memory representations.</span>
<a href="#l2.277"></a><span id="l2.277">    */</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineat">@@ -2696,17 +2696,17 @@ var GlodaDatastore = {</span>
<a href="#l2.279"></a><span id="l2.279">                                            modifiedItems);</span>
<a href="#l2.280"></a><span id="l2.280">     }</span>
<a href="#l2.281"></a><span id="l2.281">   },</span>
<a href="#l2.282"></a><span id="l2.282"> </span>
<a href="#l2.283"></a><span id="l2.283">   get _updateMessageKeyStatement() {</span>
<a href="#l2.284"></a><span id="l2.284">     let statement = this._createAsyncStatement(</span>
<a href="#l2.285"></a><span id="l2.285">       &quot;UPDATE messages SET messageKey = ?1 WHERE id = ?2&quot;);</span>
<a href="#l2.286"></a><span id="l2.286">     this.__defineGetter__(&quot;_updateMessageKeyStatement&quot;,</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineminus">-                          function() statement);</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineplus">+                          () =&gt; statement);</span>
<a href="#l2.289"></a><span id="l2.289">     return this._updateMessageKeyStatement;</span>
<a href="#l2.290"></a><span id="l2.290">   },</span>
<a href="#l2.291"></a><span id="l2.291"> </span>
<a href="#l2.292"></a><span id="l2.292">   /**</span>
<a href="#l2.293"></a><span id="l2.293">    * Update the message keys for the gloda messages with the given id's.  This</span>
<a href="#l2.294"></a><span id="l2.294">    *  is to be used in response to msgKeyChanged notifications and is similar to</span>
<a href="#l2.295"></a><span id="l2.295">    *  `updateMessageLocations` except that we do not update the folder and we</span>
<a href="#l2.296"></a><span id="l2.296">    *  do not perform itemsModified notifications (because message keys are not</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineat">@@ -2817,17 +2817,17 @@ var GlodaDatastore = {</span>
<a href="#l2.298"></a><span id="l2.298"> </span>
<a href="#l2.299"></a><span id="l2.299">   get _updateMessagesMarkDeletedByFolderID() {</span>
<a href="#l2.300"></a><span id="l2.300">     // When marking deleted clear the folderID and messageKey so that the</span>
<a href="#l2.301"></a><span id="l2.301">     //  indexing process can reuse it without any location constraints.</span>
<a href="#l2.302"></a><span id="l2.302">     let statement = this._createAsyncStatement(</span>
<a href="#l2.303"></a><span id="l2.303">       &quot;UPDATE messages SET folderID = NULL, messageKey = NULL, \</span>
<a href="#l2.304"></a><span id="l2.304">               deleted = 1 WHERE folderID = ?1&quot;);</span>
<a href="#l2.305"></a><span id="l2.305">     this.__defineGetter__(&quot;_updateMessagesMarkDeletedByFolderID&quot;,</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineminus">-      function() statement);</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineplus">+      () =&gt; statement);</span>
<a href="#l2.308"></a><span id="l2.308">     return this._updateMessagesMarkDeletedByFolderID;</span>
<a href="#l2.309"></a><span id="l2.309">   },</span>
<a href="#l2.310"></a><span id="l2.310"> </span>
<a href="#l2.311"></a><span id="l2.311">   /**</span>
<a href="#l2.312"></a><span id="l2.312">    * Efficiently mark all the messages in a folder as deleted.  Unfortunately,</span>
<a href="#l2.313"></a><span id="l2.313">    *  we obviously do not know the id's of the messages affected by this which</span>
<a href="#l2.314"></a><span id="l2.314">    *  complicates in-memory updates.  The options are sending out to the SQL</span>
<a href="#l2.315"></a><span id="l2.315">    *  database for a list of the message id's or some form of in-memory</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineat">@@ -2841,17 +2841,17 @@ var GlodaDatastore = {</span>
<a href="#l2.317"></a><span id="l2.317">     let statement = this._updateMessagesMarkDeletedByFolderID;</span>
<a href="#l2.318"></a><span id="l2.318">     statement.bindInt64Parameter(0, aFolderID);</span>
<a href="#l2.319"></a><span id="l2.319">     statement.executeAsync(this.trackAsync());</span>
<a href="#l2.320"></a><span id="l2.320"> </span>
<a href="#l2.321"></a><span id="l2.321">     // Have the collection manager generate itemsRemoved events for any</span>
<a href="#l2.322"></a><span id="l2.322">     //  in-memory messages in that folder.</span>
<a href="#l2.323"></a><span id="l2.323">     GlodaCollectionManager.itemsDeletedByAttribute(</span>
<a href="#l2.324"></a><span id="l2.324">       GlodaMessage.prototype.NOUN_ID,</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineminus">-      function(aMsg) aMsg._folderID == aFolderID);</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineplus">+      aMsg =&gt; aMsg._folderID == aFolderID);</span>
<a href="#l2.327"></a><span id="l2.327">   },</span>
<a href="#l2.328"></a><span id="l2.328"> </span>
<a href="#l2.329"></a><span id="l2.329">   /**</span>
<a href="#l2.330"></a><span id="l2.330">    * Mark all the gloda messages as deleted blind-fire.  Check if any of the</span>
<a href="#l2.331"></a><span id="l2.331">    *  messages are known to the collection manager and update them to be deleted</span>
<a href="#l2.332"></a><span id="l2.332">    *  along with the requisite collection notifications.</span>
<a href="#l2.333"></a><span id="l2.333">    */</span>
<a href="#l2.334"></a><span id="l2.334">   markMessagesDeletedByIDs: function gloda_ds_markMessagesDeletedByIDs(</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineat">@@ -2869,41 +2869,41 @@ var GlodaDatastore = {</span>
<a href="#l2.336"></a><span id="l2.336">     GlodaCollectionManager.itemsDeleted(GlodaMessage.prototype.NOUN_ID,</span>
<a href="#l2.337"></a><span id="l2.337">                                         aMessageIDs);</span>
<a href="#l2.338"></a><span id="l2.338">   },</span>
<a href="#l2.339"></a><span id="l2.339"> </span>
<a href="#l2.340"></a><span id="l2.340">   get _countDeletedMessagesStatement() {</span>
<a href="#l2.341"></a><span id="l2.341">     let statement = this._createAsyncStatement(</span>
<a href="#l2.342"></a><span id="l2.342">       &quot;SELECT COUNT(*) FROM messages WHERE deleted = 1&quot;);</span>
<a href="#l2.343"></a><span id="l2.343">     this.__defineGetter__(&quot;_countDeletedMessagesStatement&quot;,</span>
<a href="#l2.344"></a><span id="l2.344" class="difflineminus">-                          function() statement);</span>
<a href="#l2.345"></a><span id="l2.345" class="difflineplus">+                          () =&gt; statement);</span>
<a href="#l2.346"></a><span id="l2.346">     return this._countDeletedMessagesStatement;</span>
<a href="#l2.347"></a><span id="l2.347">   },</span>
<a href="#l2.348"></a><span id="l2.348"> </span>
<a href="#l2.349"></a><span id="l2.349">   /**</span>
<a href="#l2.350"></a><span id="l2.350">    * Count how many messages are currently marked as deleted in the database.</span>
<a href="#l2.351"></a><span id="l2.351">    */</span>
<a href="#l2.352"></a><span id="l2.352">   countDeletedMessages: function gloda_ds_countDeletedMessages(aCallback) {</span>
<a href="#l2.353"></a><span id="l2.353">     let cms = this._countDeletedMessagesStatement;</span>
<a href="#l2.354"></a><span id="l2.354">     cms.executeAsync(new SingletonResultValueHandler(aCallback));</span>
<a href="#l2.355"></a><span id="l2.355">   },</span>
<a href="#l2.356"></a><span id="l2.356"> </span>
<a href="#l2.357"></a><span id="l2.357">   get _deleteMessageByIDStatement() {</span>
<a href="#l2.358"></a><span id="l2.358">     let statement = this._createAsyncStatement(</span>
<a href="#l2.359"></a><span id="l2.359">       &quot;DELETE FROM messages WHERE id = ?1&quot;);</span>
<a href="#l2.360"></a><span id="l2.360">     this.__defineGetter__(&quot;_deleteMessageByIDStatement&quot;,</span>
<a href="#l2.361"></a><span id="l2.361" class="difflineminus">-                          function() statement);</span>
<a href="#l2.362"></a><span id="l2.362" class="difflineplus">+                          () =&gt; statement);</span>
<a href="#l2.363"></a><span id="l2.363">     return this._deleteMessageByIDStatement;</span>
<a href="#l2.364"></a><span id="l2.364">   },</span>
<a href="#l2.365"></a><span id="l2.365"> </span>
<a href="#l2.366"></a><span id="l2.366">   get _deleteMessageTextByIDStatement() {</span>
<a href="#l2.367"></a><span id="l2.367">     let statement = this._createAsyncStatement(</span>
<a href="#l2.368"></a><span id="l2.368">       &quot;DELETE FROM messagesText WHERE docid = ?1&quot;);</span>
<a href="#l2.369"></a><span id="l2.369">     this.__defineGetter__(&quot;_deleteMessageTextByIDStatement&quot;,</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineminus">-                          function() statement);</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineplus">+                          () =&gt; statement);</span>
<a href="#l2.372"></a><span id="l2.372">     return this._deleteMessageTextByIDStatement;</span>
<a href="#l2.373"></a><span id="l2.373">   },</span>
<a href="#l2.374"></a><span id="l2.374"> </span>
<a href="#l2.375"></a><span id="l2.375">   /**</span>
<a href="#l2.376"></a><span id="l2.376">    * Delete a message and its fulltext from the database.  It is assumed that</span>
<a href="#l2.377"></a><span id="l2.377">    *  the message was already marked as deleted and so is not visible to the</span>
<a href="#l2.378"></a><span id="l2.378">    *  collection manager and so nothing needs to be done about that.</span>
<a href="#l2.379"></a><span id="l2.379">    */</span>
<a href="#l2.380"></a><span id="l2.380" class="difflineat">@@ -2922,17 +2922,17 @@ var GlodaDatastore = {</span>
<a href="#l2.381"></a><span id="l2.381">   },</span>
<a href="#l2.382"></a><span id="l2.382"> </span>
<a href="#l2.383"></a><span id="l2.383">   get _folderCompactionStatement() {</span>
<a href="#l2.384"></a><span id="l2.384">     let statement = this._createAsyncStatement(</span>
<a href="#l2.385"></a><span id="l2.385">       &quot;SELECT id, messageKey, headerMessageID FROM messages \</span>
<a href="#l2.386"></a><span id="l2.386">         WHERE folderID = ?1 AND \</span>
<a href="#l2.387"></a><span id="l2.387">           messageKey &gt;= ?2 AND +deleted = 0 ORDER BY messageKey LIMIT ?3&quot;);</span>
<a href="#l2.388"></a><span id="l2.388">     this.__defineGetter__(&quot;_folderCompactionStatement&quot;,</span>
<a href="#l2.389"></a><span id="l2.389" class="difflineminus">-                          function() statement);</span>
<a href="#l2.390"></a><span id="l2.390" class="difflineplus">+                          () =&gt; statement);</span>
<a href="#l2.391"></a><span id="l2.391">     return this._folderCompactionStatement;</span>
<a href="#l2.392"></a><span id="l2.392">   },</span>
<a href="#l2.393"></a><span id="l2.393"> </span>
<a href="#l2.394"></a><span id="l2.394">   folderCompactionPassBlockFetch:</span>
<a href="#l2.395"></a><span id="l2.395">       function gloda_ds_folderCompactionPassBlockFetch(</span>
<a href="#l2.396"></a><span id="l2.396">         aFolderID, aStartingMessageKey, aLimit, aCallback) {</span>
<a href="#l2.397"></a><span id="l2.397">     let fcs = this._folderCompactionStatement;</span>
<a href="#l2.398"></a><span id="l2.398">     fcs.bindInt64Parameter(0, aFolderID);</span>
<a href="#l2.399"></a><span id="l2.399" class="difflineat">@@ -2943,26 +2943,26 @@ var GlodaDatastore = {</span>
<a href="#l2.400"></a><span id="l2.400"> </span>
<a href="#l2.401"></a><span id="l2.401">   /* ********** Message Attributes ********** */</span>
<a href="#l2.402"></a><span id="l2.402">   get _insertMessageAttributeStatement() {</span>
<a href="#l2.403"></a><span id="l2.403">     let statement = this._createAsyncStatement(</span>
<a href="#l2.404"></a><span id="l2.404">       &quot;INSERT INTO messageAttributes (conversationID, messageID, attributeID, \</span>
<a href="#l2.405"></a><span id="l2.405">                              value) \</span>
<a href="#l2.406"></a><span id="l2.406">               VALUES (?1, ?2, ?3, ?4)&quot;);</span>
<a href="#l2.407"></a><span id="l2.407">     this.__defineGetter__(&quot;_insertMessageAttributeStatement&quot;,</span>
<a href="#l2.408"></a><span id="l2.408" class="difflineminus">-      function() statement);</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineplus">+      () =&gt; statement);</span>
<a href="#l2.410"></a><span id="l2.410">     return this._insertMessageAttributeStatement;</span>
<a href="#l2.411"></a><span id="l2.411">   },</span>
<a href="#l2.412"></a><span id="l2.412"> </span>
<a href="#l2.413"></a><span id="l2.413">   get _deleteMessageAttributeStatement() {</span>
<a href="#l2.414"></a><span id="l2.414">     let statement = this._createAsyncStatement(</span>
<a href="#l2.415"></a><span id="l2.415">       &quot;DELETE FROM messageAttributes WHERE attributeID = ?1 AND value = ?2 \</span>
<a href="#l2.416"></a><span id="l2.416">          AND conversationID = ?3 AND messageID = ?4&quot;);</span>
<a href="#l2.417"></a><span id="l2.417">     this.__defineGetter__(&quot;_deleteMessageAttributeStatement&quot;,</span>
<a href="#l2.418"></a><span id="l2.418" class="difflineminus">-      function() statement);</span>
<a href="#l2.419"></a><span id="l2.419" class="difflineplus">+      () =&gt; statement);</span>
<a href="#l2.420"></a><span id="l2.420">     return this._deleteMessageAttributeStatement;</span>
<a href="#l2.421"></a><span id="l2.421">   },</span>
<a href="#l2.422"></a><span id="l2.422"> </span>
<a href="#l2.423"></a><span id="l2.423">   /**</span>
<a href="#l2.424"></a><span id="l2.424">    * Insert and remove attributes relating to a GlodaMessage.  This is performed</span>
<a href="#l2.425"></a><span id="l2.425">    *  inside a pseudo-transaction (we create one if we aren't in one, using</span>
<a href="#l2.426"></a><span id="l2.426">    *  our _beginTransaction wrapper, but if we are in one, no additional</span>
<a href="#l2.427"></a><span id="l2.427">    *  meaningful semantics are added).</span>
<a href="#l2.428"></a><span id="l2.428" class="difflineat">@@ -3029,17 +3029,17 @@ var GlodaDatastore = {</span>
<a href="#l2.429"></a><span id="l2.429">       throw ex;</span>
<a href="#l2.430"></a><span id="l2.430">     }</span>
<a href="#l2.431"></a><span id="l2.431">   },</span>
<a href="#l2.432"></a><span id="l2.432"> </span>
<a href="#l2.433"></a><span id="l2.433">   get _deleteMessageAttributesByMessageIDStatement() {</span>
<a href="#l2.434"></a><span id="l2.434">     let statement = this._createAsyncStatement(</span>
<a href="#l2.435"></a><span id="l2.435">       &quot;DELETE FROM messageAttributes WHERE messageID = ?1&quot;);</span>
<a href="#l2.436"></a><span id="l2.436">     this.__defineGetter__(&quot;_deleteMessageAttributesByMessageIDStatement&quot;,</span>
<a href="#l2.437"></a><span id="l2.437" class="difflineminus">-      function() statement);</span>
<a href="#l2.438"></a><span id="l2.438" class="difflineplus">+      () =&gt; statement);</span>
<a href="#l2.439"></a><span id="l2.439">     return this._deleteMessageAttributesByMessageIDStatement;</span>
<a href="#l2.440"></a><span id="l2.440">   },</span>
<a href="#l2.441"></a><span id="l2.441"> </span>
<a href="#l2.442"></a><span id="l2.442">   /**</span>
<a href="#l2.443"></a><span id="l2.443">    * Clear all the message attributes for a given GlodaMessage.  No changes</span>
<a href="#l2.444"></a><span id="l2.444">    *  are made to the in-memory representation of the message; it is up to the</span>
<a href="#l2.445"></a><span id="l2.445">    *  caller to ensure that it handles things correctly.</span>
<a href="#l2.446"></a><span id="l2.446">    *</span>
<a href="#l2.447"></a><span id="l2.447" class="difflineat">@@ -3141,17 +3141,17 @@ var GlodaDatastore = {</span>
<a href="#l2.448"></a><span id="l2.448"> </span>
<a href="#l2.449"></a><span id="l2.449">   /**</span>
<a href="#l2.450"></a><span id="l2.450">    * escapeStringForLIKE is only available on statements, and sometimes we want</span>
<a href="#l2.451"></a><span id="l2.451">    *  to use it before we create our statement, so we create a statement just</span>
<a href="#l2.452"></a><span id="l2.452">    *  for this reason.</span>
<a href="#l2.453"></a><span id="l2.453">    */</span>
<a href="#l2.454"></a><span id="l2.454">   get _escapeLikeStatement() {</span>
<a href="#l2.455"></a><span id="l2.455">     let statement = this._createAsyncStatement(&quot;SELECT 0&quot;);</span>
<a href="#l2.456"></a><span id="l2.456" class="difflineminus">-    this.__defineGetter__(&quot;_escapeLikeStatement&quot;, function() statement);</span>
<a href="#l2.457"></a><span id="l2.457" class="difflineplus">+    this.__defineGetter__(&quot;_escapeLikeStatement&quot;, () =&gt; statement);</span>
<a href="#l2.458"></a><span id="l2.458">     return this._escapeLikeStatement;</span>
<a href="#l2.459"></a><span id="l2.459">   },</span>
<a href="#l2.460"></a><span id="l2.460"> </span>
<a href="#l2.461"></a><span id="l2.461">   _convertToDBValuesAndGroupByAttributeID:</span>
<a href="#l2.462"></a><span id="l2.462">     function gloda_ds__convertToDBValuesAndGroupByAttributeID(aAttrDef,</span>
<a href="#l2.463"></a><span id="l2.463">                                                               aValues) {</span>
<a href="#l2.464"></a><span id="l2.464">     let objectNounDef = aAttrDef.objectNounDef;</span>
<a href="#l2.465"></a><span id="l2.465">     if (!objectNounDef.usesParameter) {</span>
<a href="#l2.466"></a><span id="l2.466" class="difflineat">@@ -3767,17 +3767,17 @@ var GlodaDatastore = {</span>
<a href="#l2.467"></a><span id="l2.467">     stmt.finalize();</span>
<a href="#l2.468"></a><span id="l2.468">   },</span>
<a href="#l2.469"></a><span id="l2.469"> </span>
<a href="#l2.470"></a><span id="l2.470">   get _insertContactStatement() {</span>
<a href="#l2.471"></a><span id="l2.471">     let statement = this._createAsyncStatement(</span>
<a href="#l2.472"></a><span id="l2.472">       &quot;INSERT INTO contacts (id, directoryUUID, contactUUID, name, popularity,\</span>
<a href="#l2.473"></a><span id="l2.473">                              frecency, jsonAttributes) \</span>
<a href="#l2.474"></a><span id="l2.474">               VALUES (?1, ?2, ?3, ?4, ?5, ?6, ?7)&quot;);</span>
<a href="#l2.475"></a><span id="l2.475" class="difflineminus">-    this.__defineGetter__(&quot;_insertContactStatement&quot;, function() statement);</span>
<a href="#l2.476"></a><span id="l2.476" class="difflineplus">+    this.__defineGetter__(&quot;_insertContactStatement&quot;, () =&gt; statement);</span>
<a href="#l2.477"></a><span id="l2.477">     return this._insertContactStatement;</span>
<a href="#l2.478"></a><span id="l2.478">   },</span>
<a href="#l2.479"></a><span id="l2.479"> </span>
<a href="#l2.480"></a><span id="l2.480">   createContact: function gloda_ds_createContact(aDirectoryUUID, aContactUUID,</span>
<a href="#l2.481"></a><span id="l2.481">       aName, aPopularity, aFrecency) {</span>
<a href="#l2.482"></a><span id="l2.482">     let contactID = this._nextContactId++;</span>
<a href="#l2.483"></a><span id="l2.483">     let contact = new GlodaContact(this, contactID,</span>
<a href="#l2.484"></a><span id="l2.484">                                    aDirectoryUUID, aContactUUID, aName,</span>
<a href="#l2.485"></a><span id="l2.485" class="difflineat">@@ -3813,17 +3813,17 @@ var GlodaDatastore = {</span>
<a href="#l2.486"></a><span id="l2.486">     let statement = this._createAsyncStatement(</span>
<a href="#l2.487"></a><span id="l2.487">       &quot;UPDATE contacts SET directoryUUID = ?1, \</span>
<a href="#l2.488"></a><span id="l2.488">                            contactUUID = ?2, \</span>
<a href="#l2.489"></a><span id="l2.489">                            name = ?3, \</span>
<a href="#l2.490"></a><span id="l2.490">                            popularity = ?4, \</span>
<a href="#l2.491"></a><span id="l2.491">                            frecency = ?5, \</span>
<a href="#l2.492"></a><span id="l2.492">                            jsonAttributes = ?6 \</span>
<a href="#l2.493"></a><span id="l2.493">                        WHERE id = ?7&quot;);</span>
<a href="#l2.494"></a><span id="l2.494" class="difflineminus">-    this.__defineGetter__(&quot;_updateContactStatement&quot;, function() statement);</span>
<a href="#l2.495"></a><span id="l2.495" class="difflineplus">+    this.__defineGetter__(&quot;_updateContactStatement&quot;, () =&gt; statement);</span>
<a href="#l2.496"></a><span id="l2.496">     return this._updateContactStatement;</span>
<a href="#l2.497"></a><span id="l2.497">   },</span>
<a href="#l2.498"></a><span id="l2.498"> </span>
<a href="#l2.499"></a><span id="l2.499">   updateContact: function gloda_ds_updateContact(aContact) {</span>
<a href="#l2.500"></a><span id="l2.500">     let ucs = this._updateContactStatement;</span>
<a href="#l2.501"></a><span id="l2.501">     ucs.bindInt64Parameter(6, aContact.id);</span>
<a href="#l2.502"></a><span id="l2.502">     ucs.bindStringParameter(0, aContact.directoryUUID);</span>
<a href="#l2.503"></a><span id="l2.503">     ucs.bindStringParameter(1, aContact.contactUUID);</span>
<a href="#l2.504"></a><span id="l2.504" class="difflineat">@@ -3857,17 +3857,17 @@ var GlodaDatastore = {</span>
<a href="#l2.505"></a><span id="l2.505">                             contactUUID, aRow.getString(5),</span>
<a href="#l2.506"></a><span id="l2.506">                             aRow.getInt64(3), aRow.getInt64(4), jsonText);</span>
<a href="#l2.507"></a><span id="l2.507">   },</span>
<a href="#l2.508"></a><span id="l2.508"> </span>
<a href="#l2.509"></a><span id="l2.509">   get _selectContactByIDStatement() {</span>
<a href="#l2.510"></a><span id="l2.510">     let statement = this._createSyncStatement(</span>
<a href="#l2.511"></a><span id="l2.511">       &quot;SELECT * FROM contacts WHERE id = ?1&quot;);</span>
<a href="#l2.512"></a><span id="l2.512">     this.__defineGetter__(&quot;_selectContactByIDStatement&quot;,</span>
<a href="#l2.513"></a><span id="l2.513" class="difflineminus">-      function() statement);</span>
<a href="#l2.514"></a><span id="l2.514" class="difflineplus">+      () =&gt; statement);</span>
<a href="#l2.515"></a><span id="l2.515">     return this._selectContactByIDStatement;</span>
<a href="#l2.516"></a><span id="l2.516">   },</span>
<a href="#l2.517"></a><span id="l2.517"> </span>
<a href="#l2.518"></a><span id="l2.518">   /**</span>
<a href="#l2.519"></a><span id="l2.519">    * Synchronous contact lookup currently only for use by gloda's creation</span>
<a href="#l2.520"></a><span id="l2.520">    *  of the concept of &quot;me&quot;.  It is okay for it to be doing synchronous work</span>
<a href="#l2.521"></a><span id="l2.521">    *  because it is part of the startup process before any user code could</span>
<a href="#l2.522"></a><span id="l2.522">    *  have gotten a reference to Gloda, but no one else should do this.</span>
<a href="#l2.523"></a><span id="l2.523" class="difflineat">@@ -3900,17 +3900,17 @@ var GlodaDatastore = {</span>
<a href="#l2.524"></a><span id="l2.524">     }</span>
<a href="#l2.525"></a><span id="l2.525">     stmt.finalize();</span>
<a href="#l2.526"></a><span id="l2.526">   },</span>
<a href="#l2.527"></a><span id="l2.527"> </span>
<a href="#l2.528"></a><span id="l2.528">   get _insertIdentityStatement() {</span>
<a href="#l2.529"></a><span id="l2.529">     let statement = this._createAsyncStatement(</span>
<a href="#l2.530"></a><span id="l2.530">       &quot;INSERT INTO identities (id, contactID, kind, value, description, relay) \</span>
<a href="#l2.531"></a><span id="l2.531">               VALUES (?1, ?2, ?3, ?4, ?5, ?6)&quot;);</span>
<a href="#l2.532"></a><span id="l2.532" class="difflineminus">-    this.__defineGetter__(&quot;_insertIdentityStatement&quot;, function() statement);</span>
<a href="#l2.533"></a><span id="l2.533" class="difflineplus">+    this.__defineGetter__(&quot;_insertIdentityStatement&quot;, () =&gt; statement);</span>
<a href="#l2.534"></a><span id="l2.534">     return this._insertIdentityStatement;</span>
<a href="#l2.535"></a><span id="l2.535">   },</span>
<a href="#l2.536"></a><span id="l2.536"> </span>
<a href="#l2.537"></a><span id="l2.537">   createIdentity: function gloda_ds_createIdentity(aContactID, aContact, aKind,</span>
<a href="#l2.538"></a><span id="l2.538">                                                    aValue, aDescription,</span>
<a href="#l2.539"></a><span id="l2.539">                                                    aIsRelay) {</span>
<a href="#l2.540"></a><span id="l2.540">     let identityID = this._nextIdentityId++;</span>
<a href="#l2.541"></a><span id="l2.541">     let iis = this._insertIdentityStatement;</span>
<a href="#l2.542"></a><span id="l2.542" class="difflineat">@@ -3935,17 +3935,17 @@ var GlodaDatastore = {</span>
<a href="#l2.543"></a><span id="l2.543">                              aRow.getString(4),</span>
<a href="#l2.544"></a><span id="l2.544">                              aRow.getInt32(5) ? true : false);</span>
<a href="#l2.545"></a><span id="l2.545">   },</span>
<a href="#l2.546"></a><span id="l2.546"> </span>
<a href="#l2.547"></a><span id="l2.547">   get _selectIdentityByKindValueStatement() {</span>
<a href="#l2.548"></a><span id="l2.548">     let statement = this._createSyncStatement(</span>
<a href="#l2.549"></a><span id="l2.549">       &quot;SELECT * FROM identities WHERE kind = ?1 AND value = ?2&quot;);</span>
<a href="#l2.550"></a><span id="l2.550">     this.__defineGetter__(&quot;_selectIdentityByKindValueStatement&quot;,</span>
<a href="#l2.551"></a><span id="l2.551" class="difflineminus">-      function() statement);</span>
<a href="#l2.552"></a><span id="l2.552" class="difflineplus">+      () =&gt; statement);</span>
<a href="#l2.553"></a><span id="l2.553">     return this._selectIdentityByKindValueStatement;</span>
<a href="#l2.554"></a><span id="l2.554">   },</span>
<a href="#l2.555"></a><span id="l2.555"> </span>
<a href="#l2.556"></a><span id="l2.556">   /**</span>
<a href="#l2.557"></a><span id="l2.557">    * Synchronous lookup of an identity by kind and value, only for use by</span>
<a href="#l2.558"></a><span id="l2.558">    *  the legacy gloda core code that creates a concept of &quot;me&quot;.</span>
<a href="#l2.559"></a><span id="l2.559">    *  Ex: (email, foo@example.com)</span>
<a href="#l2.560"></a><span id="l2.560">    */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/db/gloda/modules/fundattr.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/fundattr.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -516,17 +516,17 @@ var GlodaFundAttr = {</span>
<a href="#l3.4"></a><span id="l3.4">     aGlodaMessage.to = toIdentities;</span>
<a href="#l3.5"></a><span id="l3.5">     aGlodaMessage.cc = ccIdentities;</span>
<a href="#l3.6"></a><span id="l3.6">     aGlodaMessage.bcc = bccIdentities;</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8">     // -- Mailing List</span>
<a href="#l3.9"></a><span id="l3.9">     if (listIdentities.length)</span>
<a href="#l3.10"></a><span id="l3.10">       aGlodaMessage.mailingLists = listIdentities;</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    let findIsEncrypted = function (x)</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+    let findIsEncrypted = x =&gt;</span>
<a href="#l3.14"></a><span id="l3.14">       x.isEncrypted || (x.parts ? x.parts.some(findIsEncrypted) : false);</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16">     // -- Encryption</span>
<a href="#l3.17"></a><span id="l3.17">     aGlodaMessage.isEncrypted = false;</span>
<a href="#l3.18"></a><span id="l3.18">     if (aMimeMsg) {</span>
<a href="#l3.19"></a><span id="l3.19">       aGlodaMessage.isEncrypted = findIsEncrypted(aMimeMsg);</span>
<a href="#l3.20"></a><span id="l3.20">     }</span>
<a href="#l3.21"></a><span id="l3.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/db/gloda/modules/log4moz.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/log4moz.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -283,17 +283,17 @@ Logger.prototype = {</span>
<a href="#l4.4"></a><span id="l4.4">     dump(&quot;log4moz warning: root logger configuration error: no level defined\n&quot;);</span>
<a href="#l4.5"></a><span id="l4.5">     return Log4Moz.Level.All;</span>
<a href="#l4.6"></a><span id="l4.6">   },</span>
<a href="#l4.7"></a><span id="l4.7">   set level(level) {</span>
<a href="#l4.8"></a><span id="l4.8">     this._level = level;</span>
<a href="#l4.9"></a><span id="l4.9">   },</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11">   _parent: null,</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  get parent() this._parent,</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  get parent() { return this._parent; },</span>
<a href="#l4.14"></a><span id="l4.14">   set parent(parent) {</span>
<a href="#l4.15"></a><span id="l4.15">     if (this._parent == parent) {</span>
<a href="#l4.16"></a><span id="l4.16">       return;</span>
<a href="#l4.17"></a><span id="l4.17">     }</span>
<a href="#l4.18"></a><span id="l4.18">     // Remove ourselves from parent's children</span>
<a href="#l4.19"></a><span id="l4.19">     if (this._parent) {</span>
<a href="#l4.20"></a><span id="l4.20">       let index = this._parent.children.indexOf(this);</span>
<a href="#l4.21"></a><span id="l4.21">       if (index != -1) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/db/gloda/modules/mimemsg.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/mimemsg.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -200,17 +200,17 @@ function MsgHdrToMimeMessage(aMsgHdr, aC</span>
<a href="#l5.4"></a><span id="l5.4">   // decrypts data. In order to protect sensitive data (e.g. not index it in</span>
<a href="#l5.5"></a><span id="l5.5">   // Gloda), unless the client asked for encrypted data, we pass to the client</span>
<a href="#l5.6"></a><span id="l5.6">   // callback a stripped-down version of the MIME structure where encrypted</span>
<a href="#l5.7"></a><span id="l5.7">   // parts have been removed.</span>
<a href="#l5.8"></a><span id="l5.8">   let wrapCallback = function (aCallback, aCallbackThis) {</span>
<a href="#l5.9"></a><span id="l5.9">     if (aOptions &amp;&amp; aOptions.examineEncryptedParts)</span>
<a href="#l5.10"></a><span id="l5.10">       return aCallback;</span>
<a href="#l5.11"></a><span id="l5.11">     else</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-      return (function (aMsgHdr, aMimeMsg)</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+      return ((aMsgHdr, aMimeMsg) =&gt;</span>
<a href="#l5.14"></a><span id="l5.14">         aCallback.call(aCallbackThis, aMsgHdr, stripEncryptedParts(aMimeMsg))</span>
<a href="#l5.15"></a><span id="l5.15">       );</span>
<a href="#l5.16"></a><span id="l5.16">   };</span>
<a href="#l5.17"></a><span id="l5.17"> </span>
<a href="#l5.18"></a><span id="l5.18">   // Apparently there used to be an old syntax where the callback was the second</span>
<a href="#l5.19"></a><span id="l5.19">   // argument...</span>
<a href="#l5.20"></a><span id="l5.20">   let callback = aCallback ? aCallback : aCallbackThis;</span>
<a href="#l5.21"></a><span id="l5.21">   let callbackThis = aCallback ? aCallbackThis : null;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -380,25 +380,25 @@ MimeMessage.prototype = {</span>
<a href="#l5.23"></a><span id="l5.23">    */</span>
<a href="#l5.24"></a><span id="l5.24">   get allUserAttachments() {</span>
<a href="#l5.25"></a><span id="l5.25">     if (this.url)</span>
<a href="#l5.26"></a><span id="l5.26">       // The jsmimeemitter camouflaged us as a MimeAttachment</span>
<a href="#l5.27"></a><span id="l5.27">       return [this];</span>
<a href="#l5.28"></a><span id="l5.28">     else</span>
<a href="#l5.29"></a><span id="l5.29">       // Why is there no flatten method for arrays?</span>
<a href="#l5.30"></a><span id="l5.30">       return [child.allUserAttachments for each ([, child] in Iterator(this.parts))]</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-        .reduce(function (a, b) a.concat(b), []);</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+        .reduce((a, b) =&gt; a.concat(b), []);</span>
<a href="#l5.33"></a><span id="l5.33">   },</span>
<a href="#l5.34"></a><span id="l5.34"> </span>
<a href="#l5.35"></a><span id="l5.35">   /**</span>
<a href="#l5.36"></a><span id="l5.36">    * @return the total size of this message, that is, the size of all subparts</span>
<a href="#l5.37"></a><span id="l5.37">    */</span>
<a href="#l5.38"></a><span id="l5.38">   get size () {</span>
<a href="#l5.39"></a><span id="l5.39">     return [child.size for each ([, child] in Iterator(this.parts))]</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-      .reduce(function (a, b) a + Math.max(b, 0), 0);</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+      .reduce((a, b) =&gt; a + Math.max(b, 0), 0);</span>
<a href="#l5.42"></a><span id="l5.42">   },</span>
<a href="#l5.43"></a><span id="l5.43"> </span>
<a href="#l5.44"></a><span id="l5.44">   /**</span>
<a href="#l5.45"></a><span id="l5.45">    * In the case of attached messages, libmime considers them as attachments,</span>
<a href="#l5.46"></a><span id="l5.46">    * and if the body is, say, quoted-printable encoded, then libmime will start</span>
<a href="#l5.47"></a><span id="l5.47">    * counting bytes and notify the js mime emitter about it. The JS mime emitter</span>
<a href="#l5.48"></a><span id="l5.48">    * being a nice guy, it will try to set a size on us. While this is the</span>
<a href="#l5.49"></a><span id="l5.49">    * expected behavior for MimeMsgAttachments, we must make sure we can handle</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineat">@@ -486,21 +486,21 @@ MimeContainer.prototype = {</span>
<a href="#l5.51"></a><span id="l5.51">     for (let iChild = 0; iChild &lt; this.parts.length; iChild++) {</span>
<a href="#l5.52"></a><span id="l5.52">       let child = this.parts[iChild];</span>
<a href="#l5.53"></a><span id="l5.53">       results = results.concat(child.allAttachments);</span>
<a href="#l5.54"></a><span id="l5.54">     }</span>
<a href="#l5.55"></a><span id="l5.55">     return results;</span>
<a href="#l5.56"></a><span id="l5.56">   },</span>
<a href="#l5.57"></a><span id="l5.57">   get allUserAttachments () {</span>
<a href="#l5.58"></a><span id="l5.58">     return [child.allUserAttachments for each ([, child] in Iterator(this.parts))]</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-      .reduce(function (a, b) a.concat(b), []);</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+      .reduce((a, b) =&gt; a.concat(b), []);</span>
<a href="#l5.61"></a><span id="l5.61">   },</span>
<a href="#l5.62"></a><span id="l5.62">   get size () {</span>
<a href="#l5.63"></a><span id="l5.63">     return [child.size for each ([, child] in Iterator(this.parts))]</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">-      .reduce(function (a, b) a + Math.max(b, 0), 0);</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+      .reduce((a, b) =&gt; a + Math.max(b, 0), 0);</span>
<a href="#l5.66"></a><span id="l5.66">   },</span>
<a href="#l5.67"></a><span id="l5.67">   set size (whatever) {</span>
<a href="#l5.68"></a><span id="l5.68">     // nop</span>
<a href="#l5.69"></a><span id="l5.69">   },</span>
<a href="#l5.70"></a><span id="l5.70">   coerceBodyToPlaintext:</span>
<a href="#l5.71"></a><span id="l5.71">       function MimeContainer_coerceBodyToPlaintext(aMsgFolder) {</span>
<a href="#l5.72"></a><span id="l5.72">     if (this.contentType == &quot;multipart/alternative&quot;) {</span>
<a href="#l5.73"></a><span id="l5.73">       let htmlPart;</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineat">@@ -626,25 +626,25 @@ function MimeUnknown(aContentType) {</span>
<a href="#l5.75"></a><span id="l5.75">   // topmost part.</span>
<a href="#l5.76"></a><span id="l5.76">   this.parts = [];</span>
<a href="#l5.77"></a><span id="l5.77"> }</span>
<a href="#l5.78"></a><span id="l5.78"> </span>
<a href="#l5.79"></a><span id="l5.79"> MimeUnknown.prototype = {</span>
<a href="#l5.80"></a><span id="l5.80">   __proto__: HeaderHandlerBase,</span>
<a href="#l5.81"></a><span id="l5.81">   get allAttachments() {</span>
<a href="#l5.82"></a><span id="l5.82">     return [child.allAttachments for each ([, child] in Iterator(this.parts))]</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineminus">-      .reduce(function (a, b) a.concat(b), []);</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+      .reduce((a, b) =&gt; a.concat(b), []);</span>
<a href="#l5.85"></a><span id="l5.85">   },</span>
<a href="#l5.86"></a><span id="l5.86">   get allUserAttachments() {</span>
<a href="#l5.87"></a><span id="l5.87">     return [child.allUserAttachments for each ([, child] in Iterator(this.parts))]</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineminus">-      .reduce(function (a, b) a.concat(b), []);</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+      .reduce((a, b) =&gt; a.concat(b), []);</span>
<a href="#l5.90"></a><span id="l5.90">   },</span>
<a href="#l5.91"></a><span id="l5.91">   get size() {</span>
<a href="#l5.92"></a><span id="l5.92">     return this._size + [child.size for each ([, child] in Iterator(this.parts))]</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineminus">-      .reduce(function (a, b) a + Math.max(b, 0), 0);</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+      .reduce((a, b) =&gt; a + Math.max(b, 0), 0);</span>
<a href="#l5.95"></a><span id="l5.95">   },</span>
<a href="#l5.96"></a><span id="l5.96">   set size(aSize) {</span>
<a href="#l5.97"></a><span id="l5.97">     this._size = aSize;</span>
<a href="#l5.98"></a><span id="l5.98">   },</span>
<a href="#l5.99"></a><span id="l5.99">   prettyString: function MimeUnknown_prettyString(aVerbose, aIndent,</span>
<a href="#l5.100"></a><span id="l5.100">                                                   aDumpBody) {</span>
<a href="#l5.101"></a><span id="l5.101">     let nextIndent = aIndent + &quot;  &quot;;</span>
<a href="#l5.102"></a><span id="l5.102"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/db/gloda/test/unit/base_index_messages.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/base_index_messages.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -118,34 +118,34 @@ function test_indexing_sweep() {</span>
<a href="#l6.4"></a><span id="l6.4">   let [folderB, setB1, setB2] = make_folder_with_sets([{count: 3},</span>
<a href="#l6.5"></a><span id="l6.5">                                                        {count: 2}]);</span>
<a href="#l6.6"></a><span id="l6.6">   yield wait_for_message_injection();</span>
<a href="#l6.7"></a><span id="l6.7">   let [folderC, setC1, setC2] = make_folder_with_sets([{count: 3},</span>
<a href="#l6.8"></a><span id="l6.8">                                                        {count: 2}]);</span>
<a href="#l6.9"></a><span id="l6.9">   yield wait_for_message_injection();</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11">   // Make sure that event-driven job gets nuked out of existence</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  GlodaIndexer.purgeJobsUsingFilter(function() true);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  GlodaIndexer.purgeJobsUsingFilter(() =&gt; true);</span>
<a href="#l6.14"></a><span id="l6.14"> </span>
<a href="#l6.15"></a><span id="l6.15">   // turn on event-driven indexing again; this will trigger a sweep.</span>
<a href="#l6.16"></a><span id="l6.16">   configure_gloda_indexing({event: true});</span>
<a href="#l6.17"></a><span id="l6.17">   GlodaMsgIndexer.indexingSweepNeeded = true;</span>
<a href="#l6.18"></a><span id="l6.18">   yield wait_for_gloda_indexer([setA1, setA2, setB1, setB2, setC1, setC2]);</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21">   // -- Folders with some changes, pending commits</span>
<a href="#l6.22"></a><span id="l6.22">   mark_sub_test_start(&quot;folders with some changes, pending commits&quot;);</span>
<a href="#l6.23"></a><span id="l6.23">   // indexing off</span>
<a href="#l6.24"></a><span id="l6.24">   configure_gloda_indexing({event: false});</span>
<a href="#l6.25"></a><span id="l6.25"> </span>
<a href="#l6.26"></a><span id="l6.26">   setA1.setRead(true);</span>
<a href="#l6.27"></a><span id="l6.27">   setB2.setRead(true);</span>
<a href="#l6.28"></a><span id="l6.28"> </span>
<a href="#l6.29"></a><span id="l6.29">   // indexing on, killing all outstanding jobs, trigger sweep</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-  GlodaIndexer.purgeJobsUsingFilter(function() true);</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+  GlodaIndexer.purgeJobsUsingFilter(() =&gt; true);</span>
<a href="#l6.32"></a><span id="l6.32">   configure_gloda_indexing({event: true});</span>
<a href="#l6.33"></a><span id="l6.33">   GlodaMsgIndexer.indexingSweepNeeded = true;</span>
<a href="#l6.34"></a><span id="l6.34"> </span>
<a href="#l6.35"></a><span id="l6.35">   yield wait_for_gloda_indexer([setA1, setB2]);</span>
<a href="#l6.36"></a><span id="l6.36"> </span>
<a href="#l6.37"></a><span id="l6.37"> </span>
<a href="#l6.38"></a><span id="l6.38">   // -- Folders with some changes, no pending commits</span>
<a href="#l6.39"></a><span id="l6.39">   mark_sub_test_start(&quot;folders with some changes, no pending commits&quot;);</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineat">@@ -153,17 +153,17 @@ function test_indexing_sweep() {</span>
<a href="#l6.41"></a><span id="l6.41">   yield wait_for_gloda_db_flush();</span>
<a href="#l6.42"></a><span id="l6.42">   // indexing off</span>
<a href="#l6.43"></a><span id="l6.43">   configure_gloda_indexing({event: false});</span>
<a href="#l6.44"></a><span id="l6.44"> </span>
<a href="#l6.45"></a><span id="l6.45">   setA2.setRead(true);</span>
<a href="#l6.46"></a><span id="l6.46">   setB1.setRead(true);</span>
<a href="#l6.47"></a><span id="l6.47"> </span>
<a href="#l6.48"></a><span id="l6.48">   // indexing on, killing all outstanding jobs, trigger sweep</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-  GlodaIndexer.purgeJobsUsingFilter(function() true);</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+  GlodaIndexer.purgeJobsUsingFilter(() =&gt; true);</span>
<a href="#l6.51"></a><span id="l6.51">   configure_gloda_indexing({event: true});</span>
<a href="#l6.52"></a><span id="l6.52">   GlodaMsgIndexer.indexingSweepNeeded = true;</span>
<a href="#l6.53"></a><span id="l6.53"> </span>
<a href="#l6.54"></a><span id="l6.54">   yield wait_for_gloda_indexer([setA2, setB1]);</span>
<a href="#l6.55"></a><span id="l6.55"> </span>
<a href="#l6.56"></a><span id="l6.56"> </span>
<a href="#l6.57"></a><span id="l6.57">   // -- Filthy foldering indexing</span>
<a href="#l6.58"></a><span id="l6.58">   // Just mark the folder filthy and make sure that we reindex everyone.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/db/gloda/test/unit/test_index_compaction.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_index_compaction.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -129,17 +129,17 @@ function test_sweep_performs_compaction(</span>
<a href="#l7.4"></a><span id="l7.4">   let msgFolder = get_real_injection_folder(folder);</span>
<a href="#l7.5"></a><span id="l7.5">   mark_action(&quot;actual&quot;, &quot;triggering compaction&quot;,</span>
<a href="#l7.6"></a><span id="l7.6">               [&quot;folder&quot;, msgFolder,</span>
<a href="#l7.7"></a><span id="l7.7">                &quot;gloda folder&quot;, Gloda.getFolderForFolder(msgFolder)]);</span>
<a href="#l7.8"></a><span id="l7.8">   msgFolder.compact(asyncUrlListener, null);</span>
<a href="#l7.9"></a><span id="l7.9">   yield false;</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11">   // Erase the compaction job.</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  GlodaIndexer.purgeJobsUsingFilter(function() true);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+  GlodaIndexer.purgeJobsUsingFilter(() =&gt; true);</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15">   // Make sure the folder is marked compacted...</span>
<a href="#l7.16"></a><span id="l7.16">   let glodaFolder = Gloda.getFolderForFolder(msgFolder);</span>
<a href="#l7.17"></a><span id="l7.17">   do_check_true(glodaFolder.compacted);</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19">   // Re-enable indexing and fire up an indexing pass</span>
<a href="#l7.20"></a><span id="l7.20">   configure_gloda_indexing({event: true});</span>
<a href="#l7.21"></a><span id="l7.21">   GlodaMsgIndexer.indexingSweepNeeded = true;</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -173,31 +173,31 @@ function test_moves_and_deletions_on_com</span>
<a href="#l7.23"></a><span id="l7.23">   let msgFolder = get_real_injection_folder(folder);</span>
<a href="#l7.24"></a><span id="l7.24">   mark_action(&quot;actual&quot;, &quot;triggering compaction&quot;,</span>
<a href="#l7.25"></a><span id="l7.25">               [&quot;folder&quot;, msgFolder,</span>
<a href="#l7.26"></a><span id="l7.26">                &quot;gloda folder&quot;, Gloda.getFolderForFolder(msgFolder)]);</span>
<a href="#l7.27"></a><span id="l7.27">   msgFolder.compact(asyncUrlListener, null);</span>
<a href="#l7.28"></a><span id="l7.28">   yield false;</span>
<a href="#l7.29"></a><span id="l7.29"> </span>
<a href="#l7.30"></a><span id="l7.30">   // Erase the compaction job.</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-  GlodaIndexer.purgeJobsUsingFilter(function() true);</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+  GlodaIndexer.purgeJobsUsingFilter(() =&gt; true);</span>
<a href="#l7.33"></a><span id="l7.33"> </span>
<a href="#l7.34"></a><span id="l7.34">   // - Delete</span>
<a href="#l7.35"></a><span id="l7.35">   // Because of the compaction, the PendingCommitTracker forgot that the message</span>
<a href="#l7.36"></a><span id="l7.36">   //  we are deleting got indexed; we will receive no event.</span>
<a href="#l7.37"></a><span id="l7.37">   yield async_delete_messages(delSet);</span>
<a href="#l7.38"></a><span id="l7.38"> </span>
<a href="#l7.39"></a><span id="l7.39">   // - Move</span>
<a href="#l7.40"></a><span id="l7.40">   // Same deal on the move, except that it will try and trigger event-based</span>
<a href="#l7.41"></a><span id="l7.41">   //  indexing in the target folder...</span>
<a href="#l7.42"></a><span id="l7.42">   yield async_move_messages(moveSet, otherFolder);</span>
<a href="#l7.43"></a><span id="l7.43">   // Kill the event-based indexing job of the target; we want the indexing sweep</span>
<a href="#l7.44"></a><span id="l7.44">   //  to see it as a move.</span>
<a href="#l7.45"></a><span id="l7.45">   mark_action(&quot;actual&quot;, &quot;killing all indexing jobs&quot;, []);</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-  GlodaIndexer.purgeJobsUsingFilter(function() true);</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+  GlodaIndexer.purgeJobsUsingFilter(() =&gt; true);</span>
<a href="#l7.48"></a><span id="l7.48"> </span>
<a href="#l7.49"></a><span id="l7.49">   // - Indexing pass</span>
<a href="#l7.50"></a><span id="l7.50">   // Reenable indexing so we can do a sweep.</span>
<a href="#l7.51"></a><span id="l7.51">   configure_gloda_indexing({event: true});</span>
<a href="#l7.52"></a><span id="l7.52"> </span>
<a href="#l7.53"></a><span id="l7.53">   // This will trigger compaction (per the previous unit test) which should mark</span>
<a href="#l7.54"></a><span id="l7.54">   //  moveSet and delSet as deleted.  Then it should happen in to the next</span>
<a href="#l7.55"></a><span id="l7.55">   //  folder and add moveSet again...</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

