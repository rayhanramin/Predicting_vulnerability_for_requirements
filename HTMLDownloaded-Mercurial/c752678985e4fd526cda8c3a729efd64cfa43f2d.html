<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 10112:c752678985e4fd526cda8c3a729efd64cfa43f2d</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ c752678985e4fd526cda8c3a729efd64cfa43f2d" />
<meta property="og:url" content="/comm-central/rev/c752678985e4fd526cda8c3a729efd64cfa43f2d" />
<meta property="og:description" content="make mail import use pluggable store, bug 729676, r=hiikezoe, sr=standard8" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / c752678985e4fd526cda8c3a729efd64cfa43f2d 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/c752678985e4fd526cda8c3a729efd64cfa43f2d">shortlog</a> |
<a href="/comm-central/log/c752678985e4fd526cda8c3a729efd64cfa43f2d">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/c752678985e4fd526cda8c3a729efd64cfa43f2d">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/c752678985e4fd526cda8c3a729efd64cfa43f2d">files</a> |
changeset |
<a href="/comm-central/raw-rev/c752678985e4fd526cda8c3a729efd64cfa43f2d">raw</a>  | <a href="/comm-central/archive/c752678985e4fd526cda8c3a729efd64cfa43f2d.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
make mail import use pluggable store, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=729676">bug 729676</a>, r=hiikezoe, sr=standard8
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#68;&#97;&#118;&#105;&#100;&#32;&#66;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#32;&#60;&#98;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#64;&#110;&#118;&#101;&#110;&#116;&#117;&#114;&#101;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 09 May 2012 09:54:24 -0700</td></tr>

<tr>
 <td>changeset 10112</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/c752678985e4fd526cda8c3a729efd64cfa43f2d">c752678985e4fd526cda8c3a729efd64cfa43f2d</a></td>
</tr>



<tr>
<td>parent 10111</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/6909d61b41b86a8b4e0c0cbb0f309e816fe058c4">6909d61b41b86a8b4e0c0cbb0f309e816fe058c4</a>
</td>
</tr>

<tr>
<td>child 10113</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/363f59461e361137236e616228322ee373650fbc">363f59461e361137236e616228322ee373650fbc</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=c752678985e4fd526cda8c3a729efd64cfa43f2d">7694</a></td></tr>
<tr><td>push user</td><td>bienvenu@nventure.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 09 May 2012 16:54:29 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@c752678985e4 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c752678985e4fd526cda8c3a729efd64cfa43f2d">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c752678985e4fd526cda8c3a729efd64cfa43f2d&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c752678985e4fd526cda8c3a729efd64cfa43f2d&newProject=comm-central&newRevision=c752678985e4fd526cda8c3a729efd64cfa43f2d&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c752678985e4fd526cda8c3a729efd64cfa43f2d&newProject=comm-central&newRevision=c752678985e4fd526cda8c3a729efd64cfa43f2d&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c752678985e4fd526cda8c3a729efd64cfa43f2d&newProject=comm-central&newRevision=c752678985e4fd526cda8c3a729efd64cfa43f2d&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28hiikezoe%29&revcount=50">hiikezoe</a>, <a href="/comm-central/log?rev=reviewer%28standard8%29&revcount=50">standard8</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=729676">729676</a></td></tr>




</table></div>

<div class="page_body description">make mail import use pluggable store, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=729676">bug 729676</a>, r=hiikezoe, sr=standard8</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mail/locales/en-US/chrome/messenger/eudoraImportMsgs.properties">mail/locales/en-US/chrome/messenger/eudoraImportMsgs.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c752678985e4fd526cda8c3a729efd64cfa43f2d/mail/locales/en-US/chrome/messenger/eudoraImportMsgs.properties">file</a> |
<a href="/comm-central/annotate/c752678985e4fd526cda8c3a729efd64cfa43f2d/mail/locales/en-US/chrome/messenger/eudoraImportMsgs.properties">annotate</a> |
<a href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mail/locales/en-US/chrome/messenger/eudoraImportMsgs.properties">diff</a> |
<a href="/comm-central/comparison/c752678985e4fd526cda8c3a729efd64cfa43f2d/mail/locales/en-US/chrome/messenger/eudoraImportMsgs.properties">comparison</a> |
<a href="/comm-central/log/c752678985e4fd526cda8c3a729efd64cfa43f2d/mail/locales/en-US/chrome/messenger/eudoraImportMsgs.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/applemail/src/nsAppleMailImport.cpp">mailnews/import/applemail/src/nsAppleMailImport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/applemail/src/nsAppleMailImport.cpp">file</a> |
<a href="/comm-central/annotate/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/applemail/src/nsAppleMailImport.cpp">annotate</a> |
<a href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/applemail/src/nsAppleMailImport.cpp">diff</a> |
<a href="/comm-central/comparison/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/applemail/src/nsAppleMailImport.cpp">comparison</a> |
<a href="/comm-central/log/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/applemail/src/nsAppleMailImport.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/eudora/src/nsEudoraImport.cpp">mailnews/import/eudora/src/nsEudoraImport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/eudora/src/nsEudoraImport.cpp">file</a> |
<a href="/comm-central/annotate/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/eudora/src/nsEudoraImport.cpp">annotate</a> |
<a href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/eudora/src/nsEudoraImport.cpp">diff</a> |
<a href="/comm-central/comparison/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/eudora/src/nsEudoraImport.cpp">comparison</a> |
<a href="/comm-central/log/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/eudora/src/nsEudoraImport.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/eudora/src/nsEudoraMailbox.cpp">mailnews/import/eudora/src/nsEudoraMailbox.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/eudora/src/nsEudoraMailbox.cpp">file</a> |
<a href="/comm-central/annotate/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/eudora/src/nsEudoraMailbox.cpp">annotate</a> |
<a href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/eudora/src/nsEudoraMailbox.cpp">diff</a> |
<a href="/comm-central/comparison/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/eudora/src/nsEudoraMailbox.cpp">comparison</a> |
<a href="/comm-central/log/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/eudora/src/nsEudoraMailbox.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/eudora/src/nsEudoraMailbox.h">mailnews/import/eudora/src/nsEudoraMailbox.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/eudora/src/nsEudoraMailbox.h">file</a> |
<a href="/comm-central/annotate/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/eudora/src/nsEudoraMailbox.h">annotate</a> |
<a href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/eudora/src/nsEudoraMailbox.h">diff</a> |
<a href="/comm-central/comparison/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/eudora/src/nsEudoraMailbox.h">comparison</a> |
<a href="/comm-central/log/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/eudora/src/nsEudoraMailbox.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/oexpress/nsOE5File.cpp">mailnews/import/oexpress/nsOE5File.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/oexpress/nsOE5File.cpp">file</a> |
<a href="/comm-central/annotate/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/oexpress/nsOE5File.cpp">annotate</a> |
<a href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/oexpress/nsOE5File.cpp">diff</a> |
<a href="/comm-central/comparison/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/oexpress/nsOE5File.cpp">comparison</a> |
<a href="/comm-central/log/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/oexpress/nsOE5File.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/oexpress/nsOE5File.h">mailnews/import/oexpress/nsOE5File.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/oexpress/nsOE5File.h">file</a> |
<a href="/comm-central/annotate/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/oexpress/nsOE5File.h">annotate</a> |
<a href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/oexpress/nsOE5File.h">diff</a> |
<a href="/comm-central/comparison/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/oexpress/nsOE5File.h">comparison</a> |
<a href="/comm-central/log/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/oexpress/nsOE5File.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/oexpress/nsOEImport.cpp">mailnews/import/oexpress/nsOEImport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/oexpress/nsOEImport.cpp">file</a> |
<a href="/comm-central/annotate/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/oexpress/nsOEImport.cpp">annotate</a> |
<a href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/oexpress/nsOEImport.cpp">diff</a> |
<a href="/comm-central/comparison/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/oexpress/nsOEImport.cpp">comparison</a> |
<a href="/comm-central/log/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/oexpress/nsOEImport.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/oexpress/nsOEMailbox.cpp">mailnews/import/oexpress/nsOEMailbox.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/oexpress/nsOEMailbox.cpp">file</a> |
<a href="/comm-central/annotate/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/oexpress/nsOEMailbox.cpp">annotate</a> |
<a href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/oexpress/nsOEMailbox.cpp">diff</a> |
<a href="/comm-central/comparison/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/oexpress/nsOEMailbox.cpp">comparison</a> |
<a href="/comm-central/log/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/oexpress/nsOEMailbox.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/oexpress/nsOEMailbox.h">mailnews/import/oexpress/nsOEMailbox.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/oexpress/nsOEMailbox.h">file</a> |
<a href="/comm-central/annotate/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/oexpress/nsOEMailbox.h">annotate</a> |
<a href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/oexpress/nsOEMailbox.h">diff</a> |
<a href="/comm-central/comparison/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/oexpress/nsOEMailbox.h">comparison</a> |
<a href="/comm-central/log/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/oexpress/nsOEMailbox.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/outlook/src/nsOutlookImport.cpp">mailnews/import/outlook/src/nsOutlookImport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/outlook/src/nsOutlookImport.cpp">file</a> |
<a href="/comm-central/annotate/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/outlook/src/nsOutlookImport.cpp">annotate</a> |
<a href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/outlook/src/nsOutlookImport.cpp">diff</a> |
<a href="/comm-central/comparison/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/outlook/src/nsOutlookImport.cpp">comparison</a> |
<a href="/comm-central/log/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/outlook/src/nsOutlookImport.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/outlook/src/nsOutlookMail.cpp">mailnews/import/outlook/src/nsOutlookMail.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/outlook/src/nsOutlookMail.cpp">file</a> |
<a href="/comm-central/annotate/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/outlook/src/nsOutlookMail.cpp">annotate</a> |
<a href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/outlook/src/nsOutlookMail.cpp">diff</a> |
<a href="/comm-central/comparison/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/outlook/src/nsOutlookMail.cpp">comparison</a> |
<a href="/comm-central/log/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/outlook/src/nsOutlookMail.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/outlook/src/nsOutlookMail.h">mailnews/import/outlook/src/nsOutlookMail.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/outlook/src/nsOutlookMail.h">file</a> |
<a href="/comm-central/annotate/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/outlook/src/nsOutlookMail.h">annotate</a> |
<a href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/outlook/src/nsOutlookMail.h">diff</a> |
<a href="/comm-central/comparison/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/outlook/src/nsOutlookMail.h">comparison</a> |
<a href="/comm-central/log/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/outlook/src/nsOutlookMail.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/public/nsIImportMail.idl">mailnews/import/public/nsIImportMail.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/public/nsIImportMail.idl">file</a> |
<a href="/comm-central/annotate/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/public/nsIImportMail.idl">annotate</a> |
<a href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/public/nsIImportMail.idl">diff</a> |
<a href="/comm-central/comparison/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/public/nsIImportMail.idl">comparison</a> |
<a href="/comm-central/log/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/public/nsIImportMail.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/src/nsImportMail.cpp">mailnews/import/src/nsImportMail.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/src/nsImportMail.cpp">file</a> |
<a href="/comm-central/annotate/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/src/nsImportMail.cpp">annotate</a> |
<a href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/src/nsImportMail.cpp">diff</a> |
<a href="/comm-central/comparison/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/src/nsImportMail.cpp">comparison</a> |
<a href="/comm-central/log/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/src/nsImportMail.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/winlivemail/nsWMImport.cpp">mailnews/import/winlivemail/nsWMImport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/winlivemail/nsWMImport.cpp">file</a> |
<a href="/comm-central/annotate/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/winlivemail/nsWMImport.cpp">annotate</a> |
<a href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/winlivemail/nsWMImport.cpp">diff</a> |
<a href="/comm-central/comparison/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/winlivemail/nsWMImport.cpp">comparison</a> |
<a href="/comm-central/log/c752678985e4fd526cda8c3a729efd64cfa43f2d/mailnews/import/winlivemail/nsWMImport.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/suite/locales/en-US/chrome/mailnews/eudoraImportMsgs.properties">suite/locales/en-US/chrome/mailnews/eudoraImportMsgs.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c752678985e4fd526cda8c3a729efd64cfa43f2d/suite/locales/en-US/chrome/mailnews/eudoraImportMsgs.properties">file</a> |
<a href="/comm-central/annotate/c752678985e4fd526cda8c3a729efd64cfa43f2d/suite/locales/en-US/chrome/mailnews/eudoraImportMsgs.properties">annotate</a> |
<a href="/comm-central/diff/c752678985e4fd526cda8c3a729efd64cfa43f2d/suite/locales/en-US/chrome/mailnews/eudoraImportMsgs.properties">diff</a> |
<a href="/comm-central/comparison/c752678985e4fd526cda8c3a729efd64cfa43f2d/suite/locales/en-US/chrome/mailnews/eudoraImportMsgs.properties">comparison</a> |
<a href="/comm-central/log/c752678985e4fd526cda8c3a729efd64cfa43f2d/suite/locales/en-US/chrome/mailnews/eudoraImportMsgs.properties">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/eudoraImportMsgs.properties</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/eudoraImportMsgs.properties</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -54,21 +54,16 @@ 2029=Eudora mail, address books, and set</span>
<a href="#l1.4"></a><span id="l1.4"> ## @loc None</span>
<a href="#l1.5"></a><span id="l1.5"> # LOCALIZATION NOTE (2002): In the following sentence,</span>
<a href="#l1.6"></a><span id="l1.6"> # the %S represents a string to be inserted at runtime (the name of the Mailbox), </span>
<a href="#l1.7"></a><span id="l1.7"> # and the %d is a number (the number of messages imported). Do not translate %d or %S, but</span>
<a href="#l1.8"></a><span id="l1.8"> # instead insert them in your text at the appropriate places.</span>
<a href="#l1.9"></a><span id="l1.9"> 2002=Mailbox %S, imported %d messages</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> # Error message</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-## @name EUDORAIMPORT_MAILBOX_BADPARAM</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-## @loc None</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-2003=Bad parameter passed to import mailbox.</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-# Error message</span>
<a href="#l1.17"></a><span id="l1.17"> ## @name EUDORAIMPORT_MAILBOX_BADSOURCEFILE</span>
<a href="#l1.18"></a><span id="l1.18"> ## @loc None</span>
<a href="#l1.19"></a><span id="l1.19"> # LOCALIZATION NOTE (2004): In the following sentence, do not translate the &quot;%S&quot;. Instead,</span>
<a href="#l1.20"></a><span id="l1.20"> # place it in your sentence where you wish to display the name of the mailbox.</span>
<a href="#l1.21"></a><span id="l1.21"> 2004=Error accessing file for mailbox %S.</span>
<a href="#l1.22"></a><span id="l1.22"> </span>
<a href="#l1.23"></a><span id="l1.23"> # Error message</span>
<a href="#l1.24"></a><span id="l1.24"> ## @name EUDORAIMPORT_MAILBOX_CONVERTERROR</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/import/applemail/src/nsAppleMailImport.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/import/applemail/src/nsAppleMailImport.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -43,16 +43,19 @@</span>
<a href="#l2.4"></a><span id="l2.4"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l2.5"></a><span id="l2.5"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l2.6"></a><span id="l2.6"> #include &quot;nsISupportsPrimitives.h&quot;</span>
<a href="#l2.7"></a><span id="l2.7"> #include &quot;nsIImportService.h&quot;</span>
<a href="#l2.8"></a><span id="l2.8"> #include &quot;nsIImportMailboxDescriptor.h&quot;</span>
<a href="#l2.9"></a><span id="l2.9"> #include &quot;nsIImportGeneric.h&quot;</span>
<a href="#l2.10"></a><span id="l2.10"> #include &quot;nsILocalFile.h&quot;</span>
<a href="#l2.11"></a><span id="l2.11"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+#include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+#include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+#include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l2.15"></a><span id="l2.15"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l2.16"></a><span id="l2.16"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l2.17"></a><span id="l2.17"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19"> #include &quot;nsEmlxHelperUtils.h&quot;</span>
<a href="#l2.20"></a><span id="l2.20"> #include &quot;nsAppleMailImport.h&quot;</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22"> PRLogModuleInfo *APPLEMAILLOGMODULE = nsnull;</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineat">@@ -496,18 +499,21 @@ nsresult nsAppleMailImportMail::FindMbox</span>
<a href="#l2.24"></a><span id="l2.24">         mCurDepth--;</span>
<a href="#l2.25"></a><span id="l2.25">       }</span>
<a href="#l2.26"></a><span id="l2.26">     } </span>
<a href="#l2.27"></a><span id="l2.27">   } </span>
<a href="#l2.28"></a><span id="l2.28"> </span>
<a href="#l2.29"></a><span id="l2.29">   return NS_OK;</span>
<a href="#l2.30"></a><span id="l2.30"> }</span>
<a href="#l2.31"></a><span id="l2.31"> </span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-NS_IMETHODIMP nsAppleMailImportMail::ImportMailbox(nsIImportMailboxDescriptor *aMailbox, nsIFile *aDestination, </span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-                                                   PRUnichar **aErrorLog, PRUnichar **aSuccessLog, bool *aFatalError)</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+nsAppleMailImportMail::ImportMailbox(nsIImportMailboxDescriptor *aMailbox,</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+                                     nsIMsgFolder *aDstFolder,</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+                                     PRUnichar **aErrorLog,</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+                                     PRUnichar **aSuccessLog, bool *aFatalError)</span>
<a href="#l2.39"></a><span id="l2.39"> {</span>
<a href="#l2.40"></a><span id="l2.40">   nsAutoString errorLog, successLog;</span>
<a href="#l2.41"></a><span id="l2.41"> </span>
<a href="#l2.42"></a><span id="l2.42">   // reset progress</span>
<a href="#l2.43"></a><span id="l2.43">   mProgress = 0;</span>
<a href="#l2.44"></a><span id="l2.44"> </span>
<a href="#l2.45"></a><span id="l2.45">   nsAutoString mailboxName;</span>
<a href="#l2.46"></a><span id="l2.46">   aMailbox-&gt;GetDisplayName(getter_Copies(mailboxName));</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineat">@@ -551,25 +557,27 @@ NS_IMETHODIMP nsAppleMailImportMail::Imp</span>
<a href="#l2.48"></a><span id="l2.48">     rv = messagesFolder-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l2.49"></a><span id="l2.49">     if (NS_FAILED(rv)) {</span>
<a href="#l2.50"></a><span id="l2.50">       ReportStatus(APPLEMAILIMPORT_MAILBOX_CONVERTERROR, mailboxName, errorLog);</span>
<a href="#l2.51"></a><span id="l2.51">       SetLogs(successLog, errorLog, aSuccessLog, aErrorLog);</span>
<a href="#l2.52"></a><span id="l2.52">       return NS_ERROR_FAILURE;</span>
<a href="#l2.53"></a><span id="l2.53">     }</span>
<a href="#l2.54"></a><span id="l2.54"> </span>
<a href="#l2.55"></a><span id="l2.55">     // prepare an outstream to the destination file</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-    nsCOMPtr&lt;nsIOutputStream&gt; outStream;</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-    rv = MsgNewBufferedFileOutputStream(getter_AddRefs(outStream), aDestination);</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-    if (!outStream || NS_FAILED(rv)) {</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+    nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+    rv = aDstFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+    if (!msgStore || NS_FAILED(rv)) {</span>
<a href="#l2.62"></a><span id="l2.62">       ReportStatus(APPLEMAILIMPORT_MAILBOX_CONVERTERROR, mailboxName, errorLog);</span>
<a href="#l2.63"></a><span id="l2.63">       SetLogs(successLog, errorLog, aSuccessLog, aErrorLog);</span>
<a href="#l2.64"></a><span id="l2.64">       return NS_ERROR_FAILURE;</span>
<a href="#l2.65"></a><span id="l2.65">     }</span>
<a href="#l2.66"></a><span id="l2.66"> </span>
<a href="#l2.67"></a><span id="l2.67">     bool hasMore = false;</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+    nsCOMPtr&lt;nsIOutputStream&gt; outStream;</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+</span>
<a href="#l2.70"></a><span id="l2.70">     while (NS_SUCCEEDED(directoryEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l2.71"></a><span id="l2.71">       // get the next file entry</span>
<a href="#l2.72"></a><span id="l2.72">       nsCOMPtr&lt;nsILocalFile&gt; currentEntry;</span>
<a href="#l2.73"></a><span id="l2.73">       {</span>
<a href="#l2.74"></a><span id="l2.74">         nsCOMPtr&lt;nsISupports&gt; rawSupports;</span>
<a href="#l2.75"></a><span id="l2.75">         directoryEnumerator-&gt;GetNext(getter_AddRefs(rawSupports));</span>
<a href="#l2.76"></a><span id="l2.76">         if (!rawSupports)</span>
<a href="#l2.77"></a><span id="l2.77">           continue;</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineat">@@ -584,22 +592,39 @@ NS_IMETHODIMP nsAppleMailImportMail::Imp</span>
<a href="#l2.79"></a><span id="l2.79">       if (!isFile)</span>
<a href="#l2.80"></a><span id="l2.80">         continue;</span>
<a href="#l2.81"></a><span id="l2.81"> </span>
<a href="#l2.82"></a><span id="l2.82">       nsAutoString leafName;</span>
<a href="#l2.83"></a><span id="l2.83">       currentEntry-&gt;GetLeafName(leafName);</span>
<a href="#l2.84"></a><span id="l2.84">       if (!StringEndsWith(leafName, NS_LITERAL_STRING(&quot;.emlx&quot;)))</span>
<a href="#l2.85"></a><span id="l2.85">         continue;</span>
<a href="#l2.86"></a><span id="l2.86"> </span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+      bool reusable;</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+      rv = msgStore-&gt;GetNewMsgOutputStream(aDstFolder, getter_AddRefs(msgHdr),</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+                                           &amp;reusable,</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+                                           getter_AddRefs(outStream));</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+      if (NS_FAILED(rv))</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+        break;</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+</span>
<a href="#l2.95"></a><span id="l2.95">       // add the data to the mbox stream</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-      if (NS_SUCCEEDED(nsEmlxHelperUtils::AddEmlxMessageToStream(currentEntry, outStream)))</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+      if (NS_SUCCEEDED(nsEmlxHelperUtils::AddEmlxMessageToStream(currentEntry, outStream))) {</span>
<a href="#l2.98"></a><span id="l2.98">         mProgress++;</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+        msgStore-&gt;FinishNewMessage(outStream, msgHdr);</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+      }</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineplus">+      else {</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+        msgStore-&gt;DiscardNewMessage(outStream, msgHdr);</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+        break;</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+      }</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+      if (!reusable)</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+        outStream-&gt;Close();</span>
<a href="#l2.107"></a><span id="l2.107">     }</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+    if (outStream)</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+      outStream-&gt;Close();</span>
<a href="#l2.110"></a><span id="l2.110">   }</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-</span>
<a href="#l2.112"></a><span id="l2.112">   // just indicate that we're done, using the same number that we used to estimate</span>
<a href="#l2.113"></a><span id="l2.113">   // number of messages earlier.</span>
<a href="#l2.114"></a><span id="l2.114">   PRUint32 finalSize;</span>
<a href="#l2.115"></a><span id="l2.115">   aMailbox-&gt;GetSize(&amp;finalSize);</span>
<a href="#l2.116"></a><span id="l2.116">   mProgress = finalSize;</span>
<a href="#l2.117"></a><span id="l2.117"> </span>
<a href="#l2.118"></a><span id="l2.118">   // report that we successfully imported this mailbox</span>
<a href="#l2.119"></a><span id="l2.119">   ReportStatus(APPLEMAILIMPORT_MAILBOX_SUCCESS, mailboxName, successLog);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraImport.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/import/eudora/src/nsEudoraImport.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -107,19 +107,20 @@ public:</span>
<a href="#l3.4"></a><span id="l3.4">   // nsIImportmail interface</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6">   /* void GetDefaultLocation (out nsIFile location, out boolean found, out boolean userVerify); */</span>
<a href="#l3.7"></a><span id="l3.7">   NS_IMETHOD GetDefaultLocation(nsIFile **location, bool *found, bool *userVerify);</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9">   /* nsISupportsArray FindMailboxes (in nsIFile location); */</span>
<a href="#l3.10"></a><span id="l3.10">   NS_IMETHOD FindMailboxes(nsIFile *location, nsISupportsArray **_retval);</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  /* void ImportMailbox (in nsIImportMailboxDescriptor source, in nsIFile destination, out boolean fatalError); */</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-  NS_IMETHOD ImportMailbox(nsIImportMailboxDescriptor *source, nsIFile *destination,</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-                PRUnichar **pErrorLog, PRUnichar **pSuccessLog, bool *fatalError);</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+  NS_IMETHOD ImportMailbox(nsIImportMailboxDescriptor *source,</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+                           nsIMsgFolder *dstFolder,</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+                           PRUnichar **pErrorLog, PRUnichar **pSuccessLog,</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+                           bool *fatalError);</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20">   /* unsigned long GetImportProgress (); */</span>
<a href="#l3.21"></a><span id="l3.21">   NS_IMETHOD GetImportProgress(PRUint32 *_retval);</span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23">   NS_IMETHOD TranslateFolderName(const nsAString &amp; aFolderName, nsAString &amp; _retval);</span>
<a href="#l3.24"></a><span id="l3.24"> </span>
<a href="#l3.25"></a><span id="l3.25"> public:</span>
<a href="#l3.26"></a><span id="l3.26">   static void  AddLinebreak(nsString *pStream);</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineat">@@ -511,38 +512,29 @@ void ImportEudoraMailImpl::ReportError(P</span>
<a href="#l3.28"></a><span id="l3.28"> void ImportEudoraMailImpl::SetLogs(nsString&amp; success, nsString&amp; error, PRUnichar **pError, PRUnichar **pSuccess)</span>
<a href="#l3.29"></a><span id="l3.29"> {</span>
<a href="#l3.30"></a><span id="l3.30">   if (pError)</span>
<a href="#l3.31"></a><span id="l3.31">     *pError = ToNewUnicode(error);</span>
<a href="#l3.32"></a><span id="l3.32">   if (pSuccess)</span>
<a href="#l3.33"></a><span id="l3.33">     *pSuccess = ToNewUnicode(success);</span>
<a href="#l3.34"></a><span id="l3.34"> }</span>
<a href="#l3.35"></a><span id="l3.35"> </span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-NS_IMETHODIMP ImportEudoraMailImpl::ImportMailbox(nsIImportMailboxDescriptor *pSource,</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-            nsIFile *pDestination,</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-            PRUnichar **pErrorLog,</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-            PRUnichar **pSuccessLog,</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-            bool *fatalError)</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+ImportEudoraMailImpl::ImportMailbox(nsIImportMailboxDescriptor *pSource,</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+                                    nsIMsgFolder *pDstFolder,</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+                                    PRUnichar **pErrorLog,</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+                                    PRUnichar **pSuccessLog,</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+                                    bool *fatalError)</span>
<a href="#l3.47"></a><span id="l3.47"> {</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-  NS_PRECONDITION(pSource != nsnull, &quot;null ptr&quot;);</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-  NS_PRECONDITION(pDestination != nsnull, &quot;null ptr&quot;);</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-  NS_PRECONDITION(fatalError != nsnull, &quot;null ptr&quot;);</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+  NS_ENSURE_ARG_POINTER(pSource);</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+  NS_ENSURE_ARG_POINTER(pDstFolder);</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+  NS_ENSURE_ARG_POINTER(fatalError);</span>
<a href="#l3.54"></a><span id="l3.54"> </span>
<a href="#l3.55"></a><span id="l3.55">   nsString  success;</span>
<a href="#l3.56"></a><span id="l3.56">   nsString  error;</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-  if (!pSource || !pDestination || !fatalError)</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-  {</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-    IMPORT_LOG0(&quot;*** Bad param passed to eudora mailbox import\n&quot;);</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-    nsEudoraStringBundle::GetStringByID(EUDORAIMPORT_MAILBOX_BADPARAM, error);</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-    if (fatalError)</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-      *fatalError = true;</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-    SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-  }</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-</span>
<a href="#l3.67"></a><span id="l3.67">   bool      abort = false;</span>
<a href="#l3.68"></a><span id="l3.68">   nsString  name;</span>
<a href="#l3.69"></a><span id="l3.69">   PRUnichar *  pName;</span>
<a href="#l3.70"></a><span id="l3.70">   if (NS_SUCCEEDED(pSource-&gt;GetDisplayName(&amp;pName)))</span>
<a href="#l3.71"></a><span id="l3.71">   {</span>
<a href="#l3.72"></a><span id="l3.72">     name = pName;</span>
<a href="#l3.73"></a><span id="l3.73">     NS_Free(pName);</span>
<a href="#l3.74"></a><span id="l3.74">   }</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineat">@@ -572,17 +564,17 @@ NS_IMETHODIMP ImportEudoraMailImpl::Impo</span>
<a href="#l3.76"></a><span id="l3.76">   IMPORT_LOG1(&quot;Import mailbox: %s\n&quot;, pPath.get());</span>
<a href="#l3.77"></a><span id="l3.77"> #endif</span>
<a href="#l3.78"></a><span id="l3.78"> </span>
<a href="#l3.79"></a><span id="l3.79"> </span>
<a href="#l3.80"></a><span id="l3.80">   PRInt32  msgCount = 0;</span>
<a href="#l3.81"></a><span id="l3.81">   nsresult rv = NS_OK;</span>
<a href="#l3.82"></a><span id="l3.82"> </span>
<a href="#l3.83"></a><span id="l3.83">   m_bytes = 0;</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-  rv = m_eudora.ImportMailbox(&amp;m_bytes, &amp;abort, name.get(), inFile, pDestination, &amp;msgCount);</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+  rv = m_eudora.ImportMailbox( &amp;m_bytes, &amp;abort, name.get(), inFile, pDstFolder, &amp;msgCount);</span>
<a href="#l3.86"></a><span id="l3.86">   if (NS_SUCCEEDED(rv))</span>
<a href="#l3.87"></a><span id="l3.87">     ReportSuccess(name, msgCount, &amp;success);</span>
<a href="#l3.88"></a><span id="l3.88">   else</span>
<a href="#l3.89"></a><span id="l3.89">     ReportError(EUDORAIMPORT_MAILBOX_CONVERTERROR, name, &amp;error);</span>
<a href="#l3.90"></a><span id="l3.90"> </span>
<a href="#l3.91"></a><span id="l3.91">   SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l3.92"></a><span id="l3.92"> </span>
<a href="#l3.93"></a><span id="l3.93">   IMPORT_LOG0(&quot;*** Returning from eudora mailbox import\n&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraMailbox.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/import/eudora/src/nsEudoraMailbox.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -41,17 +41,19 @@</span>
<a href="#l4.4"></a><span id="l4.4"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l4.5"></a><span id="l4.5"> #include &quot;nsEudoraMailbox.h&quot;</span>
<a href="#l4.6"></a><span id="l4.6"> #include &quot;nsDirectoryServiceDefs.h&quot;</span>
<a href="#l4.7"></a><span id="l4.7"> #include &quot;nsEudoraCompose.h&quot;</span>
<a href="#l4.8"></a><span id="l4.8"> #include &quot;nspr.h&quot;</span>
<a href="#l4.9"></a><span id="l4.9"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l4.10"></a><span id="l4.10"> #include &quot;nsMailHeaders.h&quot;</span>
<a href="#l4.11"></a><span id="l4.11"> #include &quot;nsMsgLocalFolderHdrs.h&quot;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+#include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+#include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+#include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l4.16"></a><span id="l4.16"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l4.17"></a><span id="l4.17"> #include &quot;nsCRT.h&quot;</span>
<a href="#l4.18"></a><span id="l4.18"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l4.19"></a><span id="l4.19"> #include &quot;EudoraDebugLog.h&quot;</span>
<a href="#l4.20"></a><span id="l4.20"> #include &quot;nsISeekableStream.h&quot;</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22"> #define  kCopyBufferSize    8192</span>
<a href="#l4.23"></a><span id="l4.23"> #define  kMailReadBufferSize  16384</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineat">@@ -224,49 +226,49 @@ nsresult nsEudoraMailbox::DeleteFile(nsI</span>
<a href="#l4.25"></a><span id="l4.25">     }</span>
<a href="#l4.26"></a><span id="l4.26">   }</span>
<a href="#l4.27"></a><span id="l4.27">   return rv;</span>
<a href="#l4.28"></a><span id="l4.28"> }</span>
<a href="#l4.29"></a><span id="l4.29"> </span>
<a href="#l4.30"></a><span id="l4.30"> #define kComposeErrorStr  &quot;X-Eudora-Compose-Error: *****&quot; &quot;\x0D\x0A&quot;</span>
<a href="#l4.31"></a><span id="l4.31"> #define kHTMLTag &quot;&lt;html&gt;&quot;</span>
<a href="#l4.32"></a><span id="l4.32"> </span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-nsresult nsEudoraMailbox::ImportMailbox(PRUint32 *pBytes, bool *pAbort, const PRUnichar *pName, nsIFile *pSrc, nsIFile *pDst, PRInt32 *pMsgCount)</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+nsresult nsEudoraMailbox::ImportMailbox(PRUint32 *pBytes, bool *pAbort,</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+                                        const PRUnichar *pName, nsIFile *pSrc,</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+                                        nsIMsgFolder *dstFolder,</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+                                        PRInt32 *pMsgCount)</span>
<a href="#l4.38"></a><span id="l4.38"> {</span>
<a href="#l4.39"></a><span id="l4.39">   nsCOMPtr&lt;nsIFile&gt;   tocFile;</span>
<a href="#l4.40"></a><span id="l4.40">   nsCOMPtr&lt;nsIInputStream&gt; srcInputStream;</span>
<a href="#l4.41"></a><span id="l4.41">   nsCOMPtr&lt;nsIInputStream&gt; tocInputStream;</span>
<a href="#l4.42"></a><span id="l4.42">   nsCOMPtr&lt;nsIOutputStream&gt; mailOutputStream;</span>
<a href="#l4.43"></a><span id="l4.43">   bool                importWithoutToc = true;</span>
<a href="#l4.44"></a><span id="l4.44">   bool                deleteToc = false;</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-  nsresult            rv;</span>
<a href="#l4.46"></a><span id="l4.46">   nsCOMPtr&lt;nsIFile&gt;   mailFile;</span>
<a href="#l4.47"></a><span id="l4.47"> </span>
<a href="#l4.48"></a><span id="l4.48">   if (pMsgCount)</span>
<a href="#l4.49"></a><span id="l4.49">     *pMsgCount = 0;</span>
<a href="#l4.50"></a><span id="l4.50"> </span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-  rv = pSrc-&gt;GetFileSize(&amp;m_mailSize);</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+  nsresult rv = pSrc-&gt;GetFileSize(&amp;m_mailSize);</span>
<a href="#l4.53"></a><span id="l4.53"> </span>
<a href="#l4.54"></a><span id="l4.54">   rv = NS_NewLocalFileInputStream(getter_AddRefs(srcInputStream), pSrc);</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-    return rv;</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.58"></a><span id="l4.58"> </span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-  NS_ADDREF(pSrc);</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; srcFile(pSrc);</span>
<a href="#l4.61"></a><span id="l4.61"> </span>
<a href="#l4.62"></a><span id="l4.62">   // First, get the index file for this mailbox</span>
<a href="#l4.63"></a><span id="l4.63">   rv = FindTOCFile(pSrc, getter_AddRefs(tocFile), &amp;deleteToc);</span>
<a href="#l4.64"></a><span id="l4.64">   if (NS_SUCCEEDED(rv) &amp;&amp; tocFile)</span>
<a href="#l4.65"></a><span id="l4.65">   {</span>
<a href="#l4.66"></a><span id="l4.66">     IMPORT_LOG0(&quot;Reading euroda toc file: &quot;);</span>
<a href="#l4.67"></a><span id="l4.67">     DUMP_FILENAME(tocFile, true);</span>
<a href="#l4.68"></a><span id="l4.68"> </span>
<a href="#l4.69"></a><span id="l4.69" class="difflineminus">-    rv = MsgNewBufferedFileOutputStream(getter_AddRefs(mailOutputStream), pDst);</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.71"></a><span id="l4.71">     // Read the toc and import the messages</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineminus">-    rv = ImportMailboxUsingTOC(pBytes, pAbort, srcInputStream, tocFile, mailOutputStream, pMsgCount);</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+    rv = ImportMailboxUsingTOC(pBytes, pAbort, srcInputStream, tocFile,</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+                               dstFolder, pMsgCount);</span>
<a href="#l4.75"></a><span id="l4.75"> </span>
<a href="#l4.76"></a><span id="l4.76">     // clean up</span>
<a href="#l4.77"></a><span id="l4.77">     if (deleteToc)</span>
<a href="#l4.78"></a><span id="l4.78">       DeleteFile(tocFile);</span>
<a href="#l4.79"></a><span id="l4.79"> </span>
<a href="#l4.80"></a><span id="l4.80">     // If we were able to import with the TOC, then we don't need to bother</span>
<a href="#l4.81"></a><span id="l4.81">     // importing without the TOC.</span>
<a href="#l4.82"></a><span id="l4.82">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineat">@@ -303,59 +305,79 @@ nsresult nsEudoraMailbox::ImportMailbox(</span>
<a href="#l4.84"></a><span id="l4.84">     ReadFileState      state;</span>
<a href="#l4.85"></a><span id="l4.85">     state.offset = 0;</span>
<a href="#l4.86"></a><span id="l4.86">     state.size = m_mailSize;</span>
<a href="#l4.87"></a><span id="l4.87">     state.pFile = pSrc;</span>
<a href="#l4.88"></a><span id="l4.88"> </span>
<a href="#l4.89"></a><span id="l4.89">     IMPORT_LOG0(&quot;Reading mailbox\n&quot;);</span>
<a href="#l4.90"></a><span id="l4.90"> </span>
<a href="#l4.91"></a><span id="l4.91">     if (NS_SUCCEEDED(rv))</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineminus">-                {</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+    {</span>
<a href="#l4.94"></a><span id="l4.94">       nsCString defaultDate;</span>
<a href="#l4.95"></a><span id="l4.95">       nsCAutoString bodyType;</span>
<a href="#l4.96"></a><span id="l4.96"> </span>
<a href="#l4.97"></a><span id="l4.97">       IMPORT_LOG0(&quot;Reading first message\n&quot;);</span>
<a href="#l4.98"></a><span id="l4.98"> </span>
<a href="#l4.99"></a><span id="l4.99" class="difflineminus">-      while (!*pAbort &amp;&amp; NS_SUCCEEDED(rv = ReadNextMessage(&amp;state, readBuffer, headers, body, defaultDate, bodyType, NULL))) {</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+      nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+      nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+      rv = dstFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+      while (!*pAbort &amp;&amp; NS_SUCCEEDED(rv = ReadNextMessage( &amp;state, readBuffer, headers, body, defaultDate, bodyType, NULL))) {</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+        if (pBytes)</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+          *pBytes += body.m_writeOffset - 1 + headers.m_writeOffset - 1;</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+        nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+        bool reusable;</span>
<a href="#l4.112"></a><span id="l4.112"> </span>
<a href="#l4.113"></a><span id="l4.113" class="difflineminus">-        if (pBytes) {</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineminus">-          *pBytes += body.m_writeOffset - 1 + headers.m_writeOffset - 1;</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+        rv = msgStore-&gt;GetNewMsgOutputStream(dstFolder, getter_AddRefs(msgHdr), &amp;reusable,</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+                                             getter_AddRefs(outputStream));</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+        if (NS_FAILED(rv))</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+          break;</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+        rv = ImportMessage(headers, body, defaultDate, bodyType, outputStream, pMsgCount);</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+        if (NS_SUCCEEDED(rv))</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+          msgStore-&gt;FinishNewMessage(outputStream, msgHdr);</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+        else {</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+          msgStore-&gt;DiscardNewMessage(outputStream, msgHdr);</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+          IMPORT_LOG0( &quot;*** Error importing message\n&quot;);</span>
<a href="#l4.127"></a><span id="l4.127">         }</span>
<a href="#l4.128"></a><span id="l4.128"> </span>
<a href="#l4.129"></a><span id="l4.129" class="difflineminus">-        rv = ImportMessage(headers, body, defaultDate, bodyType, mailOutputStream, pMsgCount);</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+        if (!reusable)</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+          outputStream-&gt;Close();</span>
<a href="#l4.132"></a><span id="l4.132"> </span>
<a href="#l4.133"></a><span id="l4.133">         if (!readBuffer.m_bytesInBuf &amp;&amp; (state.offset &gt;= state.size))</span>
<a href="#l4.134"></a><span id="l4.134">           break;</span>
<a href="#l4.135"></a><span id="l4.135">       }</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineminus">-</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+      if (outputStream)</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+        outputStream-&gt;Close();</span>
<a href="#l4.139"></a><span id="l4.139">     }</span>
<a href="#l4.140"></a><span id="l4.140">     else {</span>
<a href="#l4.141"></a><span id="l4.141">       IMPORT_LOG0(&quot;*** Error creating file spec for composition\n&quot;);</span>
<a href="#l4.142"></a><span id="l4.142">     }</span>
<a href="#l4.143"></a><span id="l4.143">   }</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineminus">-</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineminus">-  pSrc-&gt;Release();</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineminus">-</span>
<a href="#l4.147"></a><span id="l4.147">   return rv;</span>
<a href="#l4.148"></a><span id="l4.148"> }</span>
<a href="#l4.149"></a><span id="l4.149"> </span>
<a href="#l4.150"></a><span id="l4.150"> #ifdef XP_MACOSX</span>
<a href="#l4.151"></a><span id="l4.151"> #define kMsgHeaderSize    220</span>
<a href="#l4.152"></a><span id="l4.152"> #define  kMsgFirstOffset    278</span>
<a href="#l4.153"></a><span id="l4.153"> #else</span>
<a href="#l4.154"></a><span id="l4.154"> #define  kMsgHeaderSize    218</span>
<a href="#l4.155"></a><span id="l4.155"> #define kMsgFirstOffset    104</span>
<a href="#l4.156"></a><span id="l4.156"> #endif</span>
<a href="#l4.157"></a><span id="l4.157"> </span>
<a href="#l4.158"></a><span id="l4.158"> nsresult nsEudoraMailbox::ImportMailboxUsingTOC(</span>
<a href="#l4.159"></a><span id="l4.159">   PRUint32 *pBytes,</span>
<a href="#l4.160"></a><span id="l4.160">   bool *pAbort,</span>
<a href="#l4.161"></a><span id="l4.161">   nsIInputStream *pInputStream,</span>
<a href="#l4.162"></a><span id="l4.162">   nsIFile *tocFile,</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineminus">-  nsIOutputStream *pDst,</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+  nsIMsgFolder *dstFolder,</span>
<a href="#l4.165"></a><span id="l4.165">   PRInt32 *pMsgCount)</span>
<a href="#l4.166"></a><span id="l4.166"> {</span>
<a href="#l4.167"></a><span id="l4.167">   nsresult        rv = NS_OK;</span>
<a href="#l4.168"></a><span id="l4.168"> </span>
<a href="#l4.169"></a><span id="l4.169">   PRInt64  mailSize = m_mailSize;</span>
<a href="#l4.170"></a><span id="l4.170">   PRInt64  tocSize = 0;</span>
<a href="#l4.171"></a><span id="l4.171">   PRUint32  saveBytes = pBytes ? *pBytes : 0;</span>
<a href="#l4.172"></a><span id="l4.172">   nsCOMPtr &lt;nsIInputStream&gt; tocInputStream;</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineat">@@ -377,25 +399,39 @@ nsresult nsEudoraMailbox::ImportMailboxU</span>
<a href="#l4.174"></a><span id="l4.174">   EudoraTOCEntry tocEntry;</span>
<a href="#l4.175"></a><span id="l4.175"> </span>
<a href="#l4.176"></a><span id="l4.176">   copy.Allocate(kCopyBufferSize);</span>
<a href="#l4.177"></a><span id="l4.177">   readBuffer.Allocate(kMailReadBufferSize);</span>
<a href="#l4.178"></a><span id="l4.178"> </span>
<a href="#l4.179"></a><span id="l4.179">   IMPORT_LOG0(&quot;Importing mailbox using TOC: &quot;);</span>
<a href="#l4.180"></a><span id="l4.180">   DUMP_FILENAME(tocFile, true);</span>
<a href="#l4.181"></a><span id="l4.181"> </span>
<a href="#l4.182"></a><span id="l4.182" class="difflineminus">-  nsCOMPtr &lt;nsISeekableStream&gt; tocSeekableStream = do_QueryInterface(tocInputStream);</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineminus">-  nsCOMPtr &lt;nsISeekableStream&gt; mailboxSeekableStream = do_QueryInterface(pInputStream);</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineplus">+  nsCOMPtr&lt;nsISeekableStream&gt; tocSeekableStream = do_QueryInterface(tocInputStream);</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineplus">+  nsCOMPtr&lt;nsISeekableStream&gt; mailboxSeekableStream = do_QueryInterface(pInputStream);</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+  rv = dstFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineplus">+</span>
<a href="#l4.192"></a><span id="l4.192">   while (!*pAbort &amp;&amp; (tocOffset &lt; (PRInt32)tocSize)) {</span>
<a href="#l4.193"></a><span id="l4.193">     if (NS_FAILED(rv = tocSeekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, tocOffset)))</span>
<a href="#l4.194"></a><span id="l4.194">       break;</span>
<a href="#l4.195"></a><span id="l4.195"> </span>
<a href="#l4.196"></a><span id="l4.196">     if (NS_FAILED(rv = ReadTOCEntry(tocInputStream, tocEntry)))</span>
<a href="#l4.197"></a><span id="l4.197">       break;</span>
<a href="#l4.198"></a><span id="l4.198"> </span>
<a href="#l4.199"></a><span id="l4.199" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineplus">+    bool reusable;</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineplus">+</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+    rv = msgStore-&gt;GetNewMsgOutputStream(dstFolder, getter_AddRefs(msgHdr), &amp;reusable,</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineplus">+                                         getter_AddRefs(outputStream));</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineplus">+      break;</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineplus">+</span>
<a href="#l4.207"></a><span id="l4.207">     // Quick and dirty way to read in and parse the message the way the rest</span>
<a href="#l4.208"></a><span id="l4.208">     // of the code expects.</span>
<a href="#l4.209"></a><span id="l4.209">     nsCString              defaultDate;</span>
<a href="#l4.210"></a><span id="l4.210">     nsCAutoString            bodyType;</span>
<a href="#l4.211"></a><span id="l4.211">     ReadFileState            state;</span>
<a href="#l4.212"></a><span id="l4.212"> </span>
<a href="#l4.213"></a><span id="l4.213">     // Seek to the start of the email message.</span>
<a href="#l4.214"></a><span id="l4.214">     mailboxSeekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, tocEntry.m_Offset);</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineat">@@ -406,28 +442,40 @@ nsresult nsEudoraMailbox::ImportMailboxU</span>
<a href="#l4.216"></a><span id="l4.216">     // exactly how big the message is, so we simply set the &quot;size&quot; to be</span>
<a href="#l4.217"></a><span id="l4.217">     // immediately where the message ends.</span>
<a href="#l4.218"></a><span id="l4.218">     state.offset = tocEntry.m_Offset;</span>
<a href="#l4.219"></a><span id="l4.219">     state.pInputStream = pInputStream;</span>
<a href="#l4.220"></a><span id="l4.220">     state.size = state.offset + tocEntry.m_Length;</span>
<a href="#l4.221"></a><span id="l4.221"> </span>
<a href="#l4.222"></a><span id="l4.222">     if (NS_SUCCEEDED(rv = ReadNextMessage(&amp;state, readBuffer, headers, body, defaultDate, bodyType, &amp;tocEntry)))</span>
<a href="#l4.223"></a><span id="l4.223">     {</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineminus">-      rv = ImportMessage(headers, body, defaultDate, bodyType, pDst, pMsgCount);</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineplus">+      rv = ImportMessage(headers, body, defaultDate, bodyType, outputStream,</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineplus">+                         pMsgCount);</span>
<a href="#l4.227"></a><span id="l4.227"> </span>
<a href="#l4.228"></a><span id="l4.228">       if (pBytes)</span>
<a href="#l4.229"></a><span id="l4.229">         *pBytes += tocEntry.m_Length;</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineplus">+        msgStore-&gt;FinishNewMessage(outputStream, msgHdr);</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineplus">+      else {</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineplus">+        msgStore-&gt;DiscardNewMessage(outputStream, msgHdr);</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineplus">+        IMPORT_LOG0( &quot;*** Error importing message\n&quot;);</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineplus">+      }</span>
<a href="#l4.236"></a><span id="l4.236">     }</span>
<a href="#l4.237"></a><span id="l4.237"> </span>
<a href="#l4.238"></a><span id="l4.238">     // We currently don't consider an error from ReadNextMessage or ImportMessage to be fatal.</span>
<a href="#l4.239"></a><span id="l4.239">     // Reset the error back to no error in case this is the last time through the loop.</span>
<a href="#l4.240"></a><span id="l4.240">     rv = NS_OK;</span>
<a href="#l4.241"></a><span id="l4.241"> </span>
<a href="#l4.242"></a><span id="l4.242">     tocOffset += kMsgHeaderSize;</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineplus">+</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineplus">+    if (!reusable)</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineplus">+      outputStream-&gt;Close();</span>
<a href="#l4.246"></a><span id="l4.246">   }</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineplus">+  if (outputStream)</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineplus">+    outputStream-&gt;Close();</span>
<a href="#l4.249"></a><span id="l4.249"> </span>
<a href="#l4.250"></a><span id="l4.250">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l4.251"></a><span id="l4.251">     IMPORT_LOG0(&quot; finished\n&quot;);</span>
<a href="#l4.252"></a><span id="l4.252">   }</span>
<a href="#l4.253"></a><span id="l4.253">   else {</span>
<a href="#l4.254"></a><span id="l4.254">     // We failed somewhere important enough that we kept the error.</span>
<a href="#l4.255"></a><span id="l4.255">     // Bail on all that we imported since we'll be importing everything</span>
<a href="#l4.256"></a><span id="l4.256">     // again using just the mailbox.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraMailbox.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/import/eudora/src/nsEudoraMailbox.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -176,28 +176,34 @@ public:</span>
<a href="#l5.4"></a><span id="l5.4">   virtual nsresult  FindMailboxes(nsIFile *pRoot, nsISupportsArray **ppArray) { return NS_ERROR_FAILURE;}</span>
<a href="#l5.5"></a><span id="l5.5">     // get the toc file corresponding to this mailbox</span>
<a href="#l5.6"></a><span id="l5.6">   virtual nsresult  FindTOCFile(nsIFile *pMailFile, nsIFile **pTOCFile, bool *pDeleteToc) { return NS_ERROR_FAILURE;}</span>
<a href="#l5.7"></a><span id="l5.7">     // interpret the attachment line and return the attached file</span>
<a href="#l5.8"></a><span id="l5.8">   virtual nsresult  GetAttachmentInfo(const char *pFileName, nsIFile *pFile, nsCString&amp; mimeType, nsCString&amp; aAttachment) { return NS_ERROR_FAILURE;}</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10">   // Non-platform specific common stuff</span>
<a href="#l5.11"></a><span id="l5.11">     // import a mailbox</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  nsresult ImportMailbox(PRUint32 *pBytes, bool *pAbort, const PRUnichar *pName, nsIFile *pSrc, nsIFile *pDst, PRInt32 *pMsgCount);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  nsresult ImportMailbox(PRUint32 *pBytes, bool *pAbort, const PRUnichar *pName,</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+                         nsIFile *pSrc, nsIMsgFolder *pDst, PRInt32 *pMsgCount);</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+ </span>
<a href="#l5.16"></a><span id="l5.16"> </span>
<a href="#l5.17"></a><span id="l5.17">   static PRInt32    IsEudoraFromSeparator(const char *pData, PRInt32 maxLen, nsCString&amp; defaultDate);</span>
<a href="#l5.18"></a><span id="l5.18">   static bool      IsEudoraTag(const char *pChar, PRInt32 maxLen, bool &amp;insideEudoraTags, nsCString &amp;bodyType, PRInt32&amp; tagLength);</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20"> protected:</span>
<a href="#l5.21"></a><span id="l5.21">   nsresult  CreateTempFile(nsIFile **ppFile);</span>
<a href="#l5.22"></a><span id="l5.22">   nsresult  DeleteFile(nsIFile *pFile);</span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25"> private:</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-   nsresult  ImportMailboxUsingTOC(PRUint32 *pBytes, bool *pAbort, nsIInputStream *pInputStream, nsIFile *tocFile, nsIOutputStream *pDst, PRInt32 *pMsgCount);</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+  nsresult ImportMailboxUsingTOC(PRUint32 *pBytes, bool *pAbort,</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+                                 nsIInputStream *pInputStream,</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+                                 nsIFile *tocFile,</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+                                 nsIMsgFolder *pDstFolder, PRInt32 *pMsgCount);</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+</span>
<a href="#l5.32"></a><span id="l5.32">    nsresult  ReadTOCEntry(nsIInputStream *pToc, EudoraTOCEntry&amp; tocEntry);</span>
<a href="#l5.33"></a><span id="l5.33">    nsresult  ImportMessage(SimpleBufferTonyRCopiedOnce&amp; headers, SimpleBufferTonyRCopiedOnce&amp; body, nsCString&amp; defaultDate, nsCAutoString&amp; bodyType, nsIOutputStream *pDst, PRInt32 *pMsgCount);</span>
<a href="#l5.34"></a><span id="l5.34">    nsresult  ReadNextMessage(ReadFileState *pState, SimpleBufferTonyRCopiedOnce&amp; copy, SimpleBufferTonyRCopiedOnce&amp; header,</span>
<a href="#l5.35"></a><span id="l5.35">                                         SimpleBufferTonyRCopiedOnce&amp; body, nsCString&amp; defaultDate,</span>
<a href="#l5.36"></a><span id="l5.36">                                         nsCString &amp;defBodyType, EudoraTOCEntry *pTocEntry);</span>
<a href="#l5.37"></a><span id="l5.37">   PRInt32    FindStartLine(SimpleBufferTonyRCopiedOnce&amp; data);</span>
<a href="#l5.38"></a><span id="l5.38">   PRInt32    FindNextEndLine(SimpleBufferTonyRCopiedOnce&amp; data);</span>
<a href="#l5.39"></a><span id="l5.39">   PRInt32    IsEndHeaders(SimpleBufferTonyRCopiedOnce&amp; data);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/import/oexpress/nsOE5File.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/import/oexpress/nsOE5File.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -38,16 +38,18 @@</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5"> #include &quot;nsOE5File.h&quot;</span>
<a href="#l6.6"></a><span id="l6.6"> #include &quot;OEDebugLog.h&quot;</span>
<a href="#l6.7"></a><span id="l6.7"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l6.8"></a><span id="l6.8"> #include &quot;msgCore.h&quot;</span>
<a href="#l6.9"></a><span id="l6.9"> #include &quot;prprf.h&quot;</span>
<a href="#l6.10"></a><span id="l6.10"> #include &quot;nsMsgLocalFolderHdrs.h&quot;</span>
<a href="#l6.11"></a><span id="l6.11"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+#include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+#include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l6.14"></a><span id="l6.14"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l6.15"></a><span id="l6.15"> #include &quot;nsISeekableStream.h&quot;</span>
<a href="#l6.16"></a><span id="l6.16"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l6.17"></a><span id="l6.17"> #include &lt;windows.h&gt;</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19"> #define  kIndexGrowBy    100</span>
<a href="#l6.20"></a><span id="l6.20"> #define  kSignatureSize    12</span>
<a href="#l6.21"></a><span id="l6.21"> #define  kDontSeek      0xFFFFFFFF</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -265,31 +267,30 @@ bool nsOE5File::IsFromLine(char *pLine, </span>
<a href="#l6.23"></a><span id="l6.23">    return (len &gt; 5 &amp;&amp; (pLine[0] == 'F') &amp;&amp; (pLine[1] == 'r') &amp;&amp; (pLine[2] == 'o') &amp;&amp; (pLine[3] == 'm') &amp;&amp; (pLine[4] == ' '));</span>
<a href="#l6.24"></a><span id="l6.24"> }</span>
<a href="#l6.25"></a><span id="l6.25"> </span>
<a href="#l6.26"></a><span id="l6.26"> // Anything over 16K will be assumed BAD, BAD, BAD!</span>
<a href="#l6.27"></a><span id="l6.27"> #define  kMailboxBufferSize  0x4000</span>
<a href="#l6.28"></a><span id="l6.28"> #define  kMaxAttrCount       0x0030</span>
<a href="#l6.29"></a><span id="l6.29"> const char *nsOE5File::m_pFromLineSep = &quot;From - Mon Jan 1 00:00:00 1965\x0D\x0A&quot;;</span>
<a href="#l6.30"></a><span id="l6.30"> </span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-nsresult nsOE5File::ImportMailbox(PRUint32 *pBytesDone, bool *pAbort, nsString&amp; name, nsIFile *inFile, nsIFile *pDestination, PRUint32 *pCount)</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+nsresult nsOE5File::ImportMailbox(PRUint32 *pBytesDone, bool *pAbort,</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+                                  nsString&amp; name, nsIFile *inFile,</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+                                  nsIMsgFolder *dstFolder, PRUint32 *pCount)</span>
<a href="#l6.35"></a><span id="l6.35"> {</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-  nsresult  rv;</span>
<a href="#l6.37"></a><span id="l6.37">   PRInt32    msgCount = 0;</span>
<a href="#l6.38"></a><span id="l6.38">   if (pCount)</span>
<a href="#l6.39"></a><span id="l6.39">     *pCount = 0;</span>
<a href="#l6.40"></a><span id="l6.40"> </span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-  nsCOMPtr &lt;nsIInputStream&gt; inputStream;</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-  rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), inFile);</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-    return rv;</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-  nsCOMPtr &lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-  rv = MsgNewBufferedFileOutputStream(getter_AddRefs(outputStream), pDestination, -1, 0600);</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-    return rv;</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+  nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+  nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), inFile);</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+  rv = dstFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.55"></a><span id="l6.55"> </span>
<a href="#l6.56"></a><span id="l6.56">   PRUint32 *  pIndex;</span>
<a href="#l6.57"></a><span id="l6.57">   PRUint32  indexSize;</span>
<a href="#l6.58"></a><span id="l6.58">   PRUint32 *  pFlags;</span>
<a href="#l6.59"></a><span id="l6.59">   PRUint64  *  pTime;</span>
<a href="#l6.60"></a><span id="l6.60"> </span>
<a href="#l6.61"></a><span id="l6.61">   if (!ReadIndex(inputStream, &amp;pIndex, &amp;indexSize)) {</span>
<a href="#l6.62"></a><span id="l6.62">     IMPORT_LOG1(&quot;No messages found in mailbox: %s\n&quot;, NS_LossyConvertUTF16toASCII(name.get()));</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineat">@@ -326,23 +327,35 @@ nsresult nsOE5File::ImportMailbox(PRUint</span>
<a href="#l6.64"></a><span id="l6.64">       current block and write out this line separately.</span>
<a href="#l6.65"></a><span id="l6.65">       5. Reset some of the control variables and repeat step #3.</span>
<a href="#l6.66"></a><span id="l6.66">   */</span>
<a href="#l6.67"></a><span id="l6.67"> </span>
<a href="#l6.68"></a><span id="l6.68">   PRUint32  didBytes = 0;</span>
<a href="#l6.69"></a><span id="l6.69">   PRUint32  next, size;</span>
<a href="#l6.70"></a><span id="l6.70">   char *pStart, *pEnd, *partialLineStart;</span>
<a href="#l6.71"></a><span id="l6.71">   nsCAutoString partialLine, tempLine;</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l6.73"></a><span id="l6.73">   rv = NS_OK;</span>
<a href="#l6.74"></a><span id="l6.74"> </span>
<a href="#l6.75"></a><span id="l6.75">   for (PRUint32 i = 0; (i &lt; indexSize) &amp;&amp; !(*pAbort); i++)</span>
<a href="#l6.76"></a><span id="l6.76">   {</span>
<a href="#l6.77"></a><span id="l6.77">     if (! pIndex[i])</span>
<a href="#l6.78"></a><span id="l6.78">       continue;</span>
<a href="#l6.79"></a><span id="l6.79"> </span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+    bool reusable;</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+    rv = msgStore-&gt;GetNewMsgOutputStream(dstFolder, getter_AddRefs(msgHdr), &amp;reusable,</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+                                         getter_AddRefs(outputStream));</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+    {</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+      IMPORT_LOG1( &quot;Mbx getting outputstream error: 0x%lx\n&quot;, rv);</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+      break;</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+    }</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+</span>
<a href="#l6.91"></a><span id="l6.91">     if (ReadBytes(inputStream, block, pIndex[i], 16) &amp;&amp; (block[0] == pIndex[i]) &amp;&amp;</span>
<a href="#l6.92"></a><span id="l6.92">       (block[2] &lt; kMailboxBufferSize) &amp;&amp; (ReadBytes(inputStream, pBuffer, kDontSeek, block[2])))</span>
<a href="#l6.93"></a><span id="l6.93">     {</span>
<a href="#l6.94"></a><span id="l6.94">       // block[2] contains the chars in the buffer (ie, buf content size).</span>
<a href="#l6.95"></a><span id="l6.95">       // block[3] contains offset to the next block of data (0 means no more data).</span>
<a href="#l6.96"></a><span id="l6.96">       size = block[2];</span>
<a href="#l6.97"></a><span id="l6.97">       pStart = pBuffer;</span>
<a href="#l6.98"></a><span id="l6.98">       pEnd = pStart + size;</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineat">@@ -477,32 +490,41 @@ nsresult nsOE5File::ImportMailbox(PRUint</span>
<a href="#l6.100"></a><span id="l6.100">       // From - Jan 1965 00:00:00     &lt;&lt;&lt;--- 2nd msg starts here</span>
<a href="#l6.101"></a><span id="l6.101">       // Subject: How are you</span>
<a href="#l6.102"></a><span id="l6.102">       // . . .(more headers)</span>
<a href="#l6.103"></a><span id="l6.103">       //</span>
<a href="#l6.104"></a><span id="l6.104">       // In this case, the 1st msg is not recognized as a msg (it's skipped)</span>
<a href="#l6.105"></a><span id="l6.105">       // when you open the folder.</span>
<a href="#l6.106"></a><span id="l6.106">       rv = outputStream-&gt;Write(&quot;\x0D\x0A&quot;, 2, &amp;written);</span>
<a href="#l6.107"></a><span id="l6.107"> </span>
<a href="#l6.108"></a><span id="l6.108" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+      if (NS_FAILED(rv)) {</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+        IMPORT_LOG0( &quot;Error writing message during OE import\n&quot;);</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+        msgStore-&gt;DiscardNewMessage(outputStream, msgHdr);</span>
<a href="#l6.112"></a><span id="l6.112">         break;</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+      }</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+      msgStore-&gt;FinishNewMessage(outputStream, msgHdr);</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+      if (!reusable)</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+        outputStream-&gt;Close();</span>
<a href="#l6.119"></a><span id="l6.119"> </span>
<a href="#l6.120"></a><span id="l6.120">       msgCount++;</span>
<a href="#l6.121"></a><span id="l6.121">       if (pCount)</span>
<a href="#l6.122"></a><span id="l6.122">         *pCount = msgCount;</span>
<a href="#l6.123"></a><span id="l6.123">       if (pBytesDone)</span>
<a href="#l6.124"></a><span id="l6.124">         *pBytesDone = didBytes;</span>
<a href="#l6.125"></a><span id="l6.125">     }</span>
<a href="#l6.126"></a><span id="l6.126">     else {</span>
<a href="#l6.127"></a><span id="l6.127">       // Error reading message, should this be logged???</span>
<a href="#l6.128"></a><span id="l6.128">       IMPORT_LOG2(&quot;Error reading message from %s at 0x%lx\n&quot;, NS_LossyConvertUTF16toASCII(name.get()), pIndex[i]);</span>
<a href="#l6.129"></a><span id="l6.129">       *pAbort = true;</span>
<a href="#l6.130"></a><span id="l6.130">     }</span>
<a href="#l6.131"></a><span id="l6.131">   }</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineminus">-</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineplus">+  if (outputStream)</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineplus">+    outputStream-&gt;Close();</span>
<a href="#l6.135"></a><span id="l6.135">   delete [] pBuffer;</span>
<a href="#l6.136"></a><span id="l6.136">   delete [] pFlags;</span>
<a href="#l6.137"></a><span id="l6.137">   delete [] pTime;</span>
<a href="#l6.138"></a><span id="l6.138"> </span>
<a href="#l6.139"></a><span id="l6.139">   if (NS_FAILED(rv))</span>
<a href="#l6.140"></a><span id="l6.140">     *pAbort = true;</span>
<a href="#l6.141"></a><span id="l6.141"> </span>
<a href="#l6.142"></a><span id="l6.142">   return rv;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/import/oexpress/nsOE5File.h</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/import/oexpress/nsOE5File.h</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -35,31 +35,34 @@</span>
<a href="#l7.4"></a><span id="l7.4">  *</span>
<a href="#l7.5"></a><span id="l7.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7"> #ifndef nsOE5File_h___</span>
<a href="#l7.8"></a><span id="l7.8"> #define nsOE5File_h___</span>
<a href="#l7.9"></a><span id="l7.9"> </span>
<a href="#l7.10"></a><span id="l7.10"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l7.11"></a><span id="l7.11"> #include &quot;nsIFile.h&quot;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+#include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l7.13"></a><span id="l7.13"> #include &lt;windows.h&gt;</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15"> class nsIInputStream;</span>
<a href="#l7.16"></a><span id="l7.16"> </span>
<a href="#l7.17"></a><span id="l7.17"> class nsOE5File</span>
<a href="#l7.18"></a><span id="l7.18"> {</span>
<a href="#l7.19"></a><span id="l7.19"> public:</span>
<a href="#l7.20"></a><span id="l7.20">     /* pFile must already be open for reading. */</span>
<a href="#l7.21"></a><span id="l7.21">   static bool    VerifyLocalMailFile(nsIFile *pFile);</span>
<a href="#l7.22"></a><span id="l7.22">     /* pFile must NOT be open for reading   */</span>
<a href="#l7.23"></a><span id="l7.23">   static bool    IsLocalMailFile(nsIFile *pFile);</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25">   static bool    ReadIndex(nsIInputStream *pFile, PRUint32 **ppIndex, PRUint32 *pSize);</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-  static nsresult  ImportMailbox(PRUint32 *pBytesDone, bool *pAbort, nsString&amp; name, nsIFile *inFile, nsIFile *pDestination, PRUint32 *pCount);</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+  static nsresult ImportMailbox(PRUint32 *pBytesDone, bool *pAbort,</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+                                nsString&amp; name, nsIFile *inFile,</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+                                nsIMsgFolder *pDstFolder, PRUint32 *pCount);</span>
<a href="#l7.31"></a><span id="l7.31"> </span>
<a href="#l7.32"></a><span id="l7.32">   static void FileTimeToPRTime(const FILETIME *filetime, PRTime *prtm);</span>
<a href="#l7.33"></a><span id="l7.33"> </span>
<a href="#l7.34"></a><span id="l7.34"> private:</span>
<a href="#l7.35"></a><span id="l7.35">   typedef struct {</span>
<a href="#l7.36"></a><span id="l7.36">     PRUint32 *  pIndex;</span>
<a href="#l7.37"></a><span id="l7.37">     PRUint32  count;</span>
<a href="#l7.38"></a><span id="l7.38">     PRUint32  alloc;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/import/oexpress/nsOEImport.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/import/oexpress/nsOEImport.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -95,19 +95,20 @@ public:</span>
<a href="#l8.4"></a><span id="l8.4">   // nsIImportmail interface</span>
<a href="#l8.5"></a><span id="l8.5"> </span>
<a href="#l8.6"></a><span id="l8.6">   /* void GetDefaultLocation (out nsIFile location, out boolean found, out boolean userVerify); */</span>
<a href="#l8.7"></a><span id="l8.7">   NS_IMETHOD GetDefaultLocation(nsIFile **location, bool *found, bool *userVerify);</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9">   /* nsISupportsArray FindMailboxes (in nsIFile location); */</span>
<a href="#l8.10"></a><span id="l8.10">   NS_IMETHOD FindMailboxes(nsIFile *location, nsISupportsArray **_retval);</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  /* void ImportMailbox (in nsIImportMailboxDescriptor source, in nsIFile destination, out boolean fatalError); */</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-  NS_IMETHOD ImportMailbox(nsIImportMailboxDescriptor *source, nsIFile *destination,</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-                PRUnichar **pErrorLog, PRUnichar **pSuccessLog, bool *fatalError);</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+  NS_IMETHOD ImportMailbox(nsIImportMailboxDescriptor *source,</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+                           nsIMsgFolder *dstFolder,</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+                           PRUnichar **pErrorLog, PRUnichar **pSuccessLog,</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+                           bool *fatalError);</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20">   /* unsigned long GetImportProgress (); */</span>
<a href="#l8.21"></a><span id="l8.21">   NS_IMETHOD GetImportProgress(PRUint32 *_retval);</span>
<a href="#l8.22"></a><span id="l8.22"> </span>
<a href="#l8.23"></a><span id="l8.23">     NS_IMETHOD TranslateFolderName(const nsAString &amp; aFolderName, nsAString &amp; _retval);</span>
<a href="#l8.24"></a><span id="l8.24"> </span>
<a href="#l8.25"></a><span id="l8.25"> public:</span>
<a href="#l8.26"></a><span id="l8.26">   static void ReportSuccess(nsString&amp; name, PRInt32 count, nsString *pStream);</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineat">@@ -415,35 +416,27 @@ void ImportOEMailImpl::SetLogs(nsString&amp;</span>
<a href="#l8.28"></a><span id="l8.28"> {</span>
<a href="#l8.29"></a><span id="l8.29">   if (pError)</span>
<a href="#l8.30"></a><span id="l8.30">     *pError = ToNewUnicode(error);</span>
<a href="#l8.31"></a><span id="l8.31">   if (pSuccess)</span>
<a href="#l8.32"></a><span id="l8.32">     *pSuccess = ToNewUnicode(success);</span>
<a href="#l8.33"></a><span id="l8.33"> }</span>
<a href="#l8.34"></a><span id="l8.34"> </span>
<a href="#l8.35"></a><span id="l8.35"> NS_IMETHODIMP ImportOEMailImpl::ImportMailbox(nsIImportMailboxDescriptor *pSource,</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-                                              nsIFile *pDestination,</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+                                              nsIMsgFolder *dstFolder,</span>
<a href="#l8.38"></a><span id="l8.38">                                               PRUnichar **pErrorLog,</span>
<a href="#l8.39"></a><span id="l8.39">                                               PRUnichar **pSuccessLog,</span>
<a href="#l8.40"></a><span id="l8.40">                                               bool *fatalError)</span>
<a href="#l8.41"></a><span id="l8.41"> {</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-  NS_PRECONDITION(pSource != nsnull, &quot;null ptr&quot;);</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-  NS_PRECONDITION(pDestination != nsnull, &quot;null ptr&quot;);</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-  NS_PRECONDITION(fatalError != nsnull, &quot;null ptr&quot;);</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+  NS_ENSURE_ARG_POINTER(pSource);</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+  NS_ENSURE_ARG_POINTER(dstFolder);</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+  NS_ENSURE_ARG_POINTER(fatalError);</span>
<a href="#l8.48"></a><span id="l8.48"> </span>
<a href="#l8.49"></a><span id="l8.49">   nsString success;</span>
<a href="#l8.50"></a><span id="l8.50">   nsString error;</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-  if (!pSource || !pDestination || !fatalError) {</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-    nsOEStringBundle::GetStringByID(OEIMPORT_MAILBOX_BADPARAM, error);</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-    if (fatalError)</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-      *fatalError = true;</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-    SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-  }</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-</span>
<a href="#l8.59"></a><span id="l8.59">   bool abort = false;</span>
<a href="#l8.60"></a><span id="l8.60">   nsString name;</span>
<a href="#l8.61"></a><span id="l8.61">   nsString pName;</span>
<a href="#l8.62"></a><span id="l8.62">   if (NS_SUCCEEDED(pSource-&gt;GetDisplayName(getter_Copies(pName))))</span>
<a href="#l8.63"></a><span id="l8.63">     name = pName;</span>
<a href="#l8.64"></a><span id="l8.64"> </span>
<a href="#l8.65"></a><span id="l8.65">   PRUint32 mailSize = 0;</span>
<a href="#l8.66"></a><span id="l8.66">   pSource-&gt;GetSize(&amp;mailSize);</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineat">@@ -464,21 +457,21 @@ NS_IMETHODIMP ImportOEMailImpl::ImportMa</span>
<a href="#l8.68"></a><span id="l8.68">   inFile-&gt;GetNativePath(pPath);</span>
<a href="#l8.69"></a><span id="l8.69">   IMPORT_LOG1(&quot;Importing Outlook Express mailbox: %s\n&quot;, pPath.get());</span>
<a href="#l8.70"></a><span id="l8.70"> </span>
<a href="#l8.71"></a><span id="l8.71">   m_bytesDone = 0;</span>
<a href="#l8.72"></a><span id="l8.72">   PRUint32 msgCount = 0;</span>
<a href="#l8.73"></a><span id="l8.73">   nsresult rv;</span>
<a href="#l8.74"></a><span id="l8.74">   if (nsOE5File::IsLocalMailFile(inFile)) {</span>
<a href="#l8.75"></a><span id="l8.75">     IMPORT_LOG1(&quot;Importing OE5 mailbox: %s!\n&quot;, NS_LossyConvertUTF16toASCII(name.get()));</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-    rv = nsOE5File::ImportMailbox(&amp;m_bytesDone, &amp;abort, name, inFile, pDestination, &amp;msgCount);</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+    rv = nsOE5File::ImportMailbox( &amp;m_bytesDone, &amp;abort, name, inFile, dstFolder, &amp;msgCount);</span>
<a href="#l8.78"></a><span id="l8.78">   }</span>
<a href="#l8.79"></a><span id="l8.79">   else {</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-    if (CImportMailbox::ImportMailbox(&amp;m_bytesDone, &amp;abort, name, inFile, pDestination, &amp;msgCount))</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-      rv = NS_OK;</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+    if (CImportMailbox::ImportMailbox( &amp;m_bytesDone, &amp;abort, name, inFile, dstFolder, &amp;msgCount))</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+       rv = NS_OK;</span>
<a href="#l8.84"></a><span id="l8.84">     else</span>
<a href="#l8.85"></a><span id="l8.85">       rv = NS_ERROR_FAILURE;</span>
<a href="#l8.86"></a><span id="l8.86">   }</span>
<a href="#l8.87"></a><span id="l8.87"> </span>
<a href="#l8.88"></a><span id="l8.88">   if (NS_SUCCEEDED(rv))</span>
<a href="#l8.89"></a><span id="l8.89">     ReportSuccess(name, msgCount, &amp;success);</span>
<a href="#l8.90"></a><span id="l8.90">   else</span>
<a href="#l8.91"></a><span id="l8.91">     ReportError(OEIMPORT_MAILBOX_CONVERTERROR, name, &amp;error);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/import/oexpress/nsOEMailbox.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/import/oexpress/nsOEMailbox.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -38,66 +38,70 @@</span>
<a href="#l9.4"></a><span id="l9.4"> #include &quot;nsOEMailbox.h&quot;</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6"> #include &quot;OEDebugLog.h&quot;</span>
<a href="#l9.7"></a><span id="l9.7"> #include &quot;msgCore.h&quot;</span>
<a href="#l9.8"></a><span id="l9.8"> #include &quot;prprf.h&quot;</span>
<a href="#l9.9"></a><span id="l9.9"> #include &quot;nsMsgLocalFolderHdrs.h&quot;</span>
<a href="#l9.10"></a><span id="l9.10"> #include &quot;nsCRT.h&quot;</span>
<a href="#l9.11"></a><span id="l9.11"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+#include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+#include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+#include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l9.15"></a><span id="l9.15"> #include &quot;nsISeekableStream.h&quot;</span>
<a href="#l9.16"></a><span id="l9.16"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18"> class CMbxScanner {</span>
<a href="#l9.19"></a><span id="l9.19"> public:</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-  CMbxScanner(nsString&amp; name, nsIFile * mbxFile, nsIFile * dstFile);</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+  CMbxScanner(nsString&amp; name, nsIFile * mbxFile, nsIMsgFolder *dstFolder);</span>
<a href="#l9.22"></a><span id="l9.22">   ~CMbxScanner();</span>
<a href="#l9.23"></a><span id="l9.23"> </span>
<a href="#l9.24"></a><span id="l9.24">   virtual bool    Initialize(void);</span>
<a href="#l9.25"></a><span id="l9.25">   virtual bool    DoWork(bool *pAbort, PRUint32 *pDone, PRUint32 *pCount);</span>
<a href="#l9.26"></a><span id="l9.26"> </span>
<a href="#l9.27"></a><span id="l9.27">   bool      WasErrorFatal(void) { return m_fatalError;}</span>
<a href="#l9.28"></a><span id="l9.28">   PRUint32  BytesProcessed(void) { return m_didBytes;}</span>
<a href="#l9.29"></a><span id="l9.29"> </span>
<a href="#l9.30"></a><span id="l9.30"> protected:</span>
<a href="#l9.31"></a><span id="l9.31">   bool    WriteMailItem(PRUint32 flags, PRUint32 offset, PRUint32 size, PRUint32 *pTotalMsgSize = nsnull);</span>
<a href="#l9.32"></a><span id="l9.32">   virtual void  CleanUp(void);</span>
<a href="#l9.33"></a><span id="l9.33"> </span>
<a href="#l9.34"></a><span id="l9.34"> private:</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-  void  ReportWriteError(nsIFile * file, bool fatal = true);</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+  void  ReportWriteError(nsIMsgFolder *folder, bool fatal = true);</span>
<a href="#l9.37"></a><span id="l9.37">   void  ReportReadError(nsIFile * file, bool fatal = true);</span>
<a href="#l9.38"></a><span id="l9.38">   bool CopyMbxFileBytes(PRUint32 flags, PRUint32 numBytes);</span>
<a href="#l9.39"></a><span id="l9.39">   bool IsFromLineKey(PRUint8 *pBuf, PRUint32 max);</span>
<a href="#l9.40"></a><span id="l9.40"> </span>
<a href="#l9.41"></a><span id="l9.41"> public:</span>
<a href="#l9.42"></a><span id="l9.42">   PRUint32      m_msgCount;</span>
<a href="#l9.43"></a><span id="l9.43"> </span>
<a href="#l9.44"></a><span id="l9.44"> protected:</span>
<a href="#l9.45"></a><span id="l9.45">   PRUint32 *    m_pDone;</span>
<a href="#l9.46"></a><span id="l9.46">   nsString      m_name;</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; m_mbxFile;</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; m_dstFile;</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-  nsCOMPtr &lt;nsIInputStream&gt; m_mbxFileInputStream;</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-  nsCOMPtr &lt;nsIOutputStream&gt; m_dstFileOutputStream;</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; m_mbxFile;</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_dstFolder;</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+  nsCOMPtr&lt;nsIInputStream&gt; m_mbxFileInputStream;</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; m_dstOutputStream;</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; m_msgStore;</span>
<a href="#l9.56"></a><span id="l9.56">   PRUint8 *     m_pInBuffer;</span>
<a href="#l9.57"></a><span id="l9.57">   PRUint8 *     m_pOutBuffer;</span>
<a href="#l9.58"></a><span id="l9.58">   PRUint32      m_bufSz;</span>
<a href="#l9.59"></a><span id="l9.59">   PRUint32      m_didBytes;</span>
<a href="#l9.60"></a><span id="l9.60">   bool          m_fatalError;</span>
<a href="#l9.61"></a><span id="l9.61">   PRInt64      m_mbxFileSize;</span>
<a href="#l9.62"></a><span id="l9.62">   PRUint32      m_mbxOffset;</span>
<a href="#l9.63"></a><span id="l9.63"> </span>
<a href="#l9.64"></a><span id="l9.64">   static const char *  m_pFromLine;</span>
<a href="#l9.65"></a><span id="l9.65"> </span>
<a href="#l9.66"></a><span id="l9.66"> };</span>
<a href="#l9.67"></a><span id="l9.67"> </span>
<a href="#l9.68"></a><span id="l9.68"> </span>
<a href="#l9.69"></a><span id="l9.69"> class CIndexScanner : public CMbxScanner {</span>
<a href="#l9.70"></a><span id="l9.70"> public:</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-  CIndexScanner(nsString&amp; name, nsIFile * idxFile, nsIFile * mbxFile, nsIFile *dstFile);</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+  CIndexScanner(nsString&amp; name, nsIFile * idxFile, nsIFile * mbxFile, nsIMsgFolder *dstFolder);</span>
<a href="#l9.73"></a><span id="l9.73">   ~CIndexScanner();</span>
<a href="#l9.74"></a><span id="l9.74"> </span>
<a href="#l9.75"></a><span id="l9.75">   virtual bool    Initialize(void);</span>
<a href="#l9.76"></a><span id="l9.76">   virtual bool    DoWork(bool *pAbort, PRUint32 *pDone, PRUint32 *pCount);</span>
<a href="#l9.77"></a><span id="l9.77"> </span>
<a href="#l9.78"></a><span id="l9.78"> protected:</span>
<a href="#l9.79"></a><span id="l9.79">   virtual void    CleanUp(void);</span>
<a href="#l9.80"></a><span id="l9.80"> </span>
<a href="#l9.81"></a><span id="l9.81" class="difflineat">@@ -110,34 +114,36 @@ private:</span>
<a href="#l9.82"></a><span id="l9.82">   nsCOMPtr &lt;nsIFile&gt;   m_idxFile;</span>
<a href="#l9.83"></a><span id="l9.83">   nsCOMPtr &lt;nsIInputStream&gt; m_idxFileInputStream;</span>
<a href="#l9.84"></a><span id="l9.84">   PRUint32        m_numMessages;</span>
<a href="#l9.85"></a><span id="l9.85">   PRUint32        m_idxOffset;</span>
<a href="#l9.86"></a><span id="l9.86">   PRUint32        m_curItemIndex;</span>
<a href="#l9.87"></a><span id="l9.87"> };</span>
<a href="#l9.88"></a><span id="l9.88"> </span>
<a href="#l9.89"></a><span id="l9.89"> </span>
<a href="#l9.90"></a><span id="l9.90" class="difflineminus">-bool CImportMailbox::ImportMailbox(PRUint32 *pDone, bool *pAbort, nsString&amp; name, nsIFile * inFile, nsIFile * outFile, PRUint32 *pCount)</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+bool CImportMailbox::ImportMailbox(PRUint32 *pDone, bool *pAbort,</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineplus">+                                   nsString&amp; name, nsIFile * inFile,</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineplus">+                                   nsIMsgFolder *outFolder, PRUint32 *pCount)</span>
<a href="#l9.94"></a><span id="l9.94"> {</span>
<a href="#l9.95"></a><span id="l9.95">   bool    done = false;</span>
<a href="#l9.96"></a><span id="l9.96">   nsresult rv;</span>
<a href="#l9.97"></a><span id="l9.97">   nsCOMPtr &lt;nsILocalFile&gt; localInFile = do_QueryInterface(inFile, &amp;rv);</span>
<a href="#l9.98"></a><span id="l9.98">   nsCOMPtr &lt;nsILocalFile&gt; idxFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l9.99"></a><span id="l9.99">   if (NS_SUCCEEDED(rv))</span>
<a href="#l9.100"></a><span id="l9.100">     rv  = idxFile-&gt;InitWithFile(localInFile);</span>
<a href="#l9.101"></a><span id="l9.101">   if (NS_FAILED(rv)) {</span>
<a href="#l9.102"></a><span id="l9.102">     IMPORT_LOG0(&quot;New file spec failed!\n&quot;);</span>
<a href="#l9.103"></a><span id="l9.103">     return false;</span>
<a href="#l9.104"></a><span id="l9.104">   }</span>
<a href="#l9.105"></a><span id="l9.105"> </span>
<a href="#l9.106"></a><span id="l9.106">   if (GetIndexFile(idxFile)) {</span>
<a href="#l9.107"></a><span id="l9.107"> </span>
<a href="#l9.108"></a><span id="l9.108">     IMPORT_LOG1(&quot;Using index file for: %S\n&quot;, name.get());</span>
<a href="#l9.109"></a><span id="l9.109"> </span>
<a href="#l9.110"></a><span id="l9.110" class="difflineminus">-    CIndexScanner *pIdxScanner = new CIndexScanner(name, idxFile, inFile, outFile);</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineplus">+    CIndexScanner *pIdxScanner = new CIndexScanner(name, idxFile, inFile, outFolder);</span>
<a href="#l9.112"></a><span id="l9.112">     if (pIdxScanner-&gt;Initialize()) {</span>
<a href="#l9.113"></a><span id="l9.113">       if (pIdxScanner-&gt;DoWork(pAbort, pDone, pCount)) {</span>
<a href="#l9.114"></a><span id="l9.114">         done = true;</span>
<a href="#l9.115"></a><span id="l9.115">       }</span>
<a href="#l9.116"></a><span id="l9.116">       else {</span>
<a href="#l9.117"></a><span id="l9.117">         IMPORT_LOG0(&quot;CIndexScanner::DoWork() failed\n&quot;);</span>
<a href="#l9.118"></a><span id="l9.118">       }</span>
<a href="#l9.119"></a><span id="l9.119">     }</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineat">@@ -150,17 +156,17 @@ bool CImportMailbox::ImportMailbox(PRUin</span>
<a href="#l9.121"></a><span id="l9.121"> </span>
<a href="#l9.122"></a><span id="l9.122">   if (done)</span>
<a href="#l9.123"></a><span id="l9.123">     return done;</span>
<a href="#l9.124"></a><span id="l9.124"> </span>
<a href="#l9.125"></a><span id="l9.125">     /*</span>
<a href="#l9.126"></a><span id="l9.126">     something went wrong with the index file, just scan the mailbox</span>
<a href="#l9.127"></a><span id="l9.127">     file itself.</span>
<a href="#l9.128"></a><span id="l9.128">   */</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineminus">-  CMbxScanner *pMbx = new CMbxScanner(name, inFile, outFile);</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineplus">+  CMbxScanner *pMbx = new CMbxScanner(name, inFile, outFolder);</span>
<a href="#l9.131"></a><span id="l9.131">   if (pMbx-&gt;Initialize()) {</span>
<a href="#l9.132"></a><span id="l9.132">     if (pMbx-&gt;DoWork(pAbort, pDone, pCount)) {</span>
<a href="#l9.133"></a><span id="l9.133">       done = true;</span>
<a href="#l9.134"></a><span id="l9.134">     }</span>
<a href="#l9.135"></a><span id="l9.135">     else {</span>
<a href="#l9.136"></a><span id="l9.136">       IMPORT_LOG0(&quot;CMbxScanner::DoWork() failed\n&quot;);</span>
<a href="#l9.137"></a><span id="l9.137">     }</span>
<a href="#l9.138"></a><span id="l9.138">   }</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineat">@@ -198,37 +204,38 @@ bool CImportMailbox::GetIndexFile(nsIFil</span>
<a href="#l9.140"></a><span id="l9.140"> }</span>
<a href="#l9.141"></a><span id="l9.141"> </span>
<a href="#l9.142"></a><span id="l9.142"> </span>
<a href="#l9.143"></a><span id="l9.143"> const char *CMbxScanner::m_pFromLine = &quot;From - Mon Jan 1 00:00:00 1965\x0D\x0A&quot;;</span>
<a href="#l9.144"></a><span id="l9.144"> // let's try a 16K buffer and see how well that works?</span>
<a href="#l9.145"></a><span id="l9.145"> #define  kBufferKB  16</span>
<a href="#l9.146"></a><span id="l9.146"> </span>
<a href="#l9.147"></a><span id="l9.147"> </span>
<a href="#l9.148"></a><span id="l9.148" class="difflineminus">-CMbxScanner::CMbxScanner(nsString&amp; name, nsIFile* mbxFile, nsIFile* dstFile)</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineplus">+CMbxScanner::CMbxScanner(nsString&amp; name, nsIFile* mbxFile,</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineplus">+                         nsIMsgFolder* dstFolder)</span>
<a href="#l9.151"></a><span id="l9.151"> {</span>
<a href="#l9.152"></a><span id="l9.152">   m_msgCount = 0;</span>
<a href="#l9.153"></a><span id="l9.153">   m_name = name;</span>
<a href="#l9.154"></a><span id="l9.154">   m_mbxFile = mbxFile;</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineminus">-  m_dstFile = dstFile;</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineplus">+  m_dstFolder = dstFolder;</span>
<a href="#l9.157"></a><span id="l9.157">   m_pInBuffer = nsnull;</span>
<a href="#l9.158"></a><span id="l9.158">   m_pOutBuffer = nsnull;</span>
<a href="#l9.159"></a><span id="l9.159">   m_bufSz = 0;</span>
<a href="#l9.160"></a><span id="l9.160">   m_fatalError = false;</span>
<a href="#l9.161"></a><span id="l9.161">   m_didBytes = 0;</span>
<a href="#l9.162"></a><span id="l9.162">   m_mbxFileSize = 0;</span>
<a href="#l9.163"></a><span id="l9.163">   m_mbxOffset = 0;</span>
<a href="#l9.164"></a><span id="l9.164"> }</span>
<a href="#l9.165"></a><span id="l9.165"> </span>
<a href="#l9.166"></a><span id="l9.166"> CMbxScanner::~CMbxScanner()</span>
<a href="#l9.167"></a><span id="l9.167"> {</span>
<a href="#l9.168"></a><span id="l9.168">   CleanUp();</span>
<a href="#l9.169"></a><span id="l9.169"> }</span>
<a href="#l9.170"></a><span id="l9.170"> </span>
<a href="#l9.171"></a><span id="l9.171" class="difflineminus">-void CMbxScanner::ReportWriteError(nsIFile * file, bool fatal)</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineplus">+void CMbxScanner::ReportWriteError(nsIMsgFolder * folder, bool fatal)</span>
<a href="#l9.173"></a><span id="l9.173"> {</span>
<a href="#l9.174"></a><span id="l9.174">   m_fatalError = fatal;</span>
<a href="#l9.175"></a><span id="l9.175"> }</span>
<a href="#l9.176"></a><span id="l9.176"> </span>
<a href="#l9.177"></a><span id="l9.177"> void CMbxScanner::ReportReadError(nsIFile * file, bool fatal)</span>
<a href="#l9.178"></a><span id="l9.178"> {</span>
<a href="#l9.179"></a><span id="l9.179">   m_fatalError = fatal;</span>
<a href="#l9.180"></a><span id="l9.180"> }</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineat">@@ -244,17 +251,17 @@ bool CMbxScanner::Initialize(void)</span>
<a href="#l9.182"></a><span id="l9.182"> </span>
<a href="#l9.183"></a><span id="l9.183">   m_mbxFile-&gt;GetFileSize(&amp;m_mbxFileSize);</span>
<a href="#l9.184"></a><span id="l9.184">   // open the mailbox file...</span>
<a href="#l9.185"></a><span id="l9.185">   if (NS_FAILED(NS_NewLocalFileInputStream(getter_AddRefs(m_mbxFileInputStream), m_mbxFile))) {</span>
<a href="#l9.186"></a><span id="l9.186">     CleanUp();</span>
<a href="#l9.187"></a><span id="l9.187">     return false;</span>
<a href="#l9.188"></a><span id="l9.188">   }</span>
<a href="#l9.189"></a><span id="l9.189"> </span>
<a href="#l9.190"></a><span id="l9.190" class="difflineminus">-  if (NS_FAILED(MsgNewBufferedFileOutputStream(getter_AddRefs(m_dstFileOutputStream), m_dstFile, -1, 0600))) {</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineplus">+  if (NS_FAILED(m_dstFolder-&gt;GetMsgStore(getter_AddRefs(m_msgStore)))) {</span>
<a href="#l9.192"></a><span id="l9.192">     CleanUp();</span>
<a href="#l9.193"></a><span id="l9.193">     return false;</span>
<a href="#l9.194"></a><span id="l9.194">   }</span>
<a href="#l9.195"></a><span id="l9.195"> </span>
<a href="#l9.196"></a><span id="l9.196">   return true;</span>
<a href="#l9.197"></a><span id="l9.197"> }</span>
<a href="#l9.198"></a><span id="l9.198"> </span>
<a href="#l9.199"></a><span id="l9.199"> </span>
<a href="#l9.200"></a><span id="l9.200" class="difflineat">@@ -287,30 +294,31 @@ bool CMbxScanner::DoWork(bool *pAbort, P</span>
<a href="#l9.201"></a><span id="l9.201">   return true;</span>
<a href="#l9.202"></a><span id="l9.202"> }</span>
<a href="#l9.203"></a><span id="l9.203"> </span>
<a href="#l9.204"></a><span id="l9.204"> </span>
<a href="#l9.205"></a><span id="l9.205"> void CMbxScanner::CleanUp(void)</span>
<a href="#l9.206"></a><span id="l9.206"> {</span>
<a href="#l9.207"></a><span id="l9.207">   if (m_mbxFileInputStream)</span>
<a href="#l9.208"></a><span id="l9.208">     m_mbxFileInputStream-&gt;Close();</span>
<a href="#l9.209"></a><span id="l9.209" class="difflineminus">-  if (m_dstFileOutputStream)</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineminus">-    m_dstFileOutputStream-&gt;Close();</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineplus">+  if (m_dstOutputStream)</span>
<a href="#l9.212"></a><span id="l9.212" class="difflineplus">+    m_dstOutputStream-&gt;Close();</span>
<a href="#l9.213"></a><span id="l9.213"> </span>
<a href="#l9.214"></a><span id="l9.214">   delete [] m_pInBuffer;</span>
<a href="#l9.215"></a><span id="l9.215">   m_pInBuffer = nsnull;</span>
<a href="#l9.216"></a><span id="l9.216"> </span>
<a href="#l9.217"></a><span id="l9.217">   delete [] m_pOutBuffer;</span>
<a href="#l9.218"></a><span id="l9.218">   m_pOutBuffer = nsnull;</span>
<a href="#l9.219"></a><span id="l9.219"> }</span>
<a href="#l9.220"></a><span id="l9.220"> </span>
<a href="#l9.221"></a><span id="l9.221"> </span>
<a href="#l9.222"></a><span id="l9.222"> #define  kNumMbxLongsToRead  4</span>
<a href="#l9.223"></a><span id="l9.223"> </span>
<a href="#l9.224"></a><span id="l9.224" class="difflineminus">-bool CMbxScanner::WriteMailItem(PRUint32 flags, PRUint32 offset, PRUint32 size, PRUint32 *pTotalMsgSize)</span>
<a href="#l9.225"></a><span id="l9.225" class="difflineplus">+bool CMbxScanner::WriteMailItem(PRUint32 flags, PRUint32 offset, PRUint32 size,</span>
<a href="#l9.226"></a><span id="l9.226" class="difflineplus">+                                PRUint32 *pTotalMsgSize)</span>
<a href="#l9.227"></a><span id="l9.227"> {</span>
<a href="#l9.228"></a><span id="l9.228">   PRUint32  values[kNumMbxLongsToRead];</span>
<a href="#l9.229"></a><span id="l9.229">   PRInt32    cnt = kNumMbxLongsToRead * sizeof(PRUint32);</span>
<a href="#l9.230"></a><span id="l9.230">   nsresult  rv;</span>
<a href="#l9.231"></a><span id="l9.231">   PRUint32    cntRead;</span>
<a href="#l9.232"></a><span id="l9.232">   PRInt8 *  pChar = (PRInt8 *) values;</span>
<a href="#l9.233"></a><span id="l9.233"> </span>
<a href="#l9.234"></a><span id="l9.234">   nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(m_mbxFileInputStream);</span>
<a href="#l9.235"></a><span id="l9.235" class="difflineat">@@ -332,19 +340,42 @@ bool CMbxScanner::WriteMailItem(PRUint32</span>
<a href="#l9.236"></a><span id="l9.236">   if (size &amp;&amp; (values[2] != size)) {</span>
<a href="#l9.237"></a><span id="l9.237">     IMPORT_LOG3(&quot;Mbx size doesn't match idx, mbx: %ld, idx: %ld, at offset: 0x%lx\n&quot;, values[2], size, offset);</span>
<a href="#l9.238"></a><span id="l9.238">     return false;</span>
<a href="#l9.239"></a><span id="l9.239">   }</span>
<a href="#l9.240"></a><span id="l9.240"> </span>
<a href="#l9.241"></a><span id="l9.241">   if (pTotalMsgSize != nsnull)</span>
<a href="#l9.242"></a><span id="l9.242">     *pTotalMsgSize = values[2];</span>
<a href="#l9.243"></a><span id="l9.243"> </span>
<a href="#l9.244"></a><span id="l9.244" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l9.245"></a><span id="l9.245" class="difflineplus">+  bool reusable;</span>
<a href="#l9.246"></a><span id="l9.246" class="difflineplus">+</span>
<a href="#l9.247"></a><span id="l9.247" class="difflineplus">+  rv = m_msgStore-&gt;GetNewMsgOutputStream(m_dstFolder, getter_AddRefs(msgHdr), &amp;reusable,</span>
<a href="#l9.248"></a><span id="l9.248" class="difflineplus">+                                         getter_AddRefs(m_dstOutputStream));</span>
<a href="#l9.249"></a><span id="l9.249" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l9.250"></a><span id="l9.250" class="difflineplus">+  {</span>
<a href="#l9.251"></a><span id="l9.251" class="difflineplus">+    IMPORT_LOG1( &quot;Mbx getting outputstream error: 0x%lx\n&quot;, rv);</span>
<a href="#l9.252"></a><span id="l9.252" class="difflineplus">+    return false;</span>
<a href="#l9.253"></a><span id="l9.253" class="difflineplus">+  }</span>
<a href="#l9.254"></a><span id="l9.254" class="difflineplus">+</span>
<a href="#l9.255"></a><span id="l9.255">   // everything looks kosher...</span>
<a href="#l9.256"></a><span id="l9.256">   // the actual message text follows and is values[3] bytes long...</span>
<a href="#l9.257"></a><span id="l9.257" class="difflineminus">-  return CopyMbxFileBytes(flags,  values[3]);</span>
<a href="#l9.258"></a><span id="l9.258" class="difflineplus">+  bool copyOK = CopyMbxFileBytes(flags,  values[3]);</span>
<a href="#l9.259"></a><span id="l9.259" class="difflineplus">+  if (copyOK)</span>
<a href="#l9.260"></a><span id="l9.260" class="difflineplus">+    m_msgStore-&gt;FinishNewMessage(m_dstOutputStream, msgHdr);</span>
<a href="#l9.261"></a><span id="l9.261" class="difflineplus">+  else {</span>
<a href="#l9.262"></a><span id="l9.262" class="difflineplus">+    m_msgStore-&gt;DiscardNewMessage(m_dstOutputStream, msgHdr);</span>
<a href="#l9.263"></a><span id="l9.263" class="difflineplus">+    IMPORT_LOG0( &quot;Mbx CopyMbxFileBytes failed\n&quot;);</span>
<a href="#l9.264"></a><span id="l9.264" class="difflineplus">+  }</span>
<a href="#l9.265"></a><span id="l9.265" class="difflineplus">+  if (!reusable)</span>
<a href="#l9.266"></a><span id="l9.266" class="difflineplus">+  {</span>
<a href="#l9.267"></a><span id="l9.267" class="difflineplus">+    m_dstOutputStream-&gt;Close();</span>
<a href="#l9.268"></a><span id="l9.268" class="difflineplus">+    m_dstOutputStream = nsnull;</span>
<a href="#l9.269"></a><span id="l9.269" class="difflineplus">+  }</span>
<a href="#l9.270"></a><span id="l9.270" class="difflineplus">+  return copyOK;</span>
<a href="#l9.271"></a><span id="l9.271"> }</span>
<a href="#l9.272"></a><span id="l9.272"> </span>
<a href="#l9.273"></a><span id="l9.273"> bool CMbxScanner::IsFromLineKey(PRUint8 * pBuf, PRUint32 max)</span>
<a href="#l9.274"></a><span id="l9.274"> {</span>
<a href="#l9.275"></a><span id="l9.275">   return (max &gt; 5 &amp;&amp; (pBuf[0] == 'F') &amp;&amp; (pBuf[1] == 'r') &amp;&amp; (pBuf[2] == 'o') &amp;&amp; (pBuf[3] == 'm') &amp;&amp; (pBuf[4] == ' '));</span>
<a href="#l9.276"></a><span id="l9.276"> }</span>
<a href="#l9.277"></a><span id="l9.277"> </span>
<a href="#l9.278"></a><span id="l9.278"> </span>
<a href="#l9.279"></a><span id="l9.279" class="difflineat">@@ -405,32 +436,32 @@ bool CMbxScanner::CopyMbxFileBytes(PRUin</span>
<a href="#l9.280"></a><span id="l9.280">           // with a From separator line that is longer than our</span>
<a href="#l9.281"></a><span id="l9.281">           // file buffer!  In this bizarre case, just skip this message</span>
<a href="#l9.282"></a><span id="l9.282">           // since it is probably bogus anyway.</span>
<a href="#l9.283"></a><span id="l9.283">           return true;</span>
<a href="#l9.284"></a><span id="l9.284">         }</span>
<a href="#l9.285"></a><span id="l9.285"> </span>
<a href="#l9.286"></a><span id="l9.286">       }</span>
<a href="#l9.287"></a><span id="l9.287">       // Begin every message with a From separator</span>
<a href="#l9.288"></a><span id="l9.288" class="difflineminus">-      rv = m_dstFileOutputStream-&gt;Write(m_pFromLine, fromLen, &amp;cntRead);</span>
<a href="#l9.289"></a><span id="l9.289" class="difflineplus">+      rv = m_dstOutputStream-&gt;Write(m_pFromLine, fromLen, &amp;cntRead);</span>
<a href="#l9.290"></a><span id="l9.290">       if (NS_FAILED(rv) || (cntRead != fromLen)) {</span>
<a href="#l9.291"></a><span id="l9.291" class="difflineminus">-        ReportWriteError(m_dstFile);</span>
<a href="#l9.292"></a><span id="l9.292" class="difflineplus">+        ReportWriteError(m_dstFolder);</span>
<a href="#l9.293"></a><span id="l9.293">         return false;</span>
<a href="#l9.294"></a><span id="l9.294">       }</span>
<a href="#l9.295"></a><span id="l9.295">       char statusLine[50];</span>
<a href="#l9.296"></a><span id="l9.296">       PRUint32 msgFlags = flags; // need to convert from OE flags to mozilla flags</span>
<a href="#l9.297"></a><span id="l9.297">       PR_snprintf(statusLine, sizeof(statusLine), X_MOZILLA_STATUS_FORMAT MSG_LINEBREAK, msgFlags &amp; 0xFFFF);</span>
<a href="#l9.298"></a><span id="l9.298" class="difflineminus">-      rv = m_dstFileOutputStream-&gt;Write(statusLine, strlen(statusLine), &amp;cntRead);</span>
<a href="#l9.299"></a><span id="l9.299" class="difflineplus">+      rv = m_dstOutputStream-&gt;Write(statusLine, strlen(statusLine), &amp;cntRead);</span>
<a href="#l9.300"></a><span id="l9.300">       if (NS_SUCCEEDED(rv) &amp;&amp; cntRead == fromLen)</span>
<a href="#l9.301"></a><span id="l9.301">       {</span>
<a href="#l9.302"></a><span id="l9.302">         PR_snprintf(statusLine, sizeof(statusLine), X_MOZILLA_STATUS2_FORMAT MSG_LINEBREAK, msgFlags &amp; 0xFFFF0000);</span>
<a href="#l9.303"></a><span id="l9.303" class="difflineminus">-        rv = m_dstFileOutputStream-&gt;Write(statusLine, strlen(statusLine), &amp;cntRead);</span>
<a href="#l9.304"></a><span id="l9.304" class="difflineplus">+        rv = m_dstOutputStream-&gt;Write(statusLine, strlen(statusLine), &amp;cntRead);</span>
<a href="#l9.305"></a><span id="l9.305">       }</span>
<a href="#l9.306"></a><span id="l9.306">       if (NS_FAILED(rv) || (cntRead != fromLen)) {</span>
<a href="#l9.307"></a><span id="l9.307" class="difflineminus">-        ReportWriteError(m_dstFile);</span>
<a href="#l9.308"></a><span id="l9.308" class="difflineplus">+        ReportWriteError(m_dstFolder);</span>
<a href="#l9.309"></a><span id="l9.309">         return false;</span>
<a href="#l9.310"></a><span id="l9.310">       }</span>
<a href="#l9.311"></a><span id="l9.311">       first = false;</span>
<a href="#l9.312"></a><span id="l9.312">     }</span>
<a href="#l9.313"></a><span id="l9.313"> </span>
<a href="#l9.314"></a><span id="l9.314">     // Handle generic data, escape any lines that begin with &quot;From &quot;</span>
<a href="#l9.315"></a><span id="l9.315">     pIn = m_pInBuffer + inIdx;</span>
<a href="#l9.316"></a><span id="l9.316">     numBytes -= cnt;</span>
<a href="#l9.317"></a><span id="l9.317" class="difflineat">@@ -443,69 +474,69 @@ bool CMbxScanner::CopyMbxFileBytes(PRUin</span>
<a href="#l9.318"></a><span id="l9.318">         // need more in buffer?</span>
<a href="#l9.319"></a><span id="l9.319">         if ((cnt &lt; 7) &amp;&amp; numBytes)</span>
<a href="#l9.320"></a><span id="l9.320">           break;</span>
<a href="#l9.321"></a><span id="l9.321"> </span>
<a href="#l9.322"></a><span id="l9.322">         if (cnt &gt; 6) {</span>
<a href="#l9.323"></a><span id="l9.323">           if ((pIn[1] == nsCRT::LF) &amp;&amp; IsFromLineKey(pIn + 2, cnt)) {</span>
<a href="#l9.324"></a><span id="l9.324">             inIdx += 2;</span>
<a href="#l9.325"></a><span id="l9.325">             // Match, escape it</span>
<a href="#l9.326"></a><span id="l9.326" class="difflineminus">-            rv = m_dstFileOutputStream-&gt;Write((const char *)pStart, (PRInt32)inIdx, &amp;cntRead);</span>
<a href="#l9.327"></a><span id="l9.327" class="difflineplus">+            rv = m_dstOutputStream-&gt;Write((const char *)pStart, (PRInt32)inIdx, &amp;cntRead);</span>
<a href="#l9.328"></a><span id="l9.328">             if (NS_SUCCEEDED(rv) &amp;&amp; (cntRead == (PRInt32)inIdx))</span>
<a href="#l9.329"></a><span id="l9.329" class="difflineminus">-              rv = m_dstFileOutputStream-&gt;Write(&quot;&gt;&quot;, 1, &amp;cntRead);</span>
<a href="#l9.330"></a><span id="l9.330" class="difflineplus">+              rv = m_dstOutputStream-&gt;Write(&quot;&gt;&quot;, 1, &amp;cntRead);</span>
<a href="#l9.331"></a><span id="l9.331">             if (NS_FAILED(rv) || (cntRead != 1)) {</span>
<a href="#l9.332"></a><span id="l9.332" class="difflineminus">-              ReportWriteError(m_dstFile);</span>
<a href="#l9.333"></a><span id="l9.333" class="difflineplus">+              ReportWriteError(m_dstFolder);</span>
<a href="#l9.334"></a><span id="l9.334">               return false;</span>
<a href="#l9.335"></a><span id="l9.335">             }</span>
<a href="#l9.336"></a><span id="l9.336"> </span>
<a href="#l9.337"></a><span id="l9.337">             cnt -= 2;</span>
<a href="#l9.338"></a><span id="l9.338">             pIn += 2;</span>
<a href="#l9.339"></a><span id="l9.339">             inIdx = 0;</span>
<a href="#l9.340"></a><span id="l9.340">             pStart = pIn;</span>
<a href="#l9.341"></a><span id="l9.341">             continue;</span>
<a href="#l9.342"></a><span id="l9.342">           }</span>
<a href="#l9.343"></a><span id="l9.343">         }</span>
<a href="#l9.344"></a><span id="l9.344">       } // == nsCRT::CR</span>
<a href="#l9.345"></a><span id="l9.345"> </span>
<a href="#l9.346"></a><span id="l9.346">       cnt--;</span>
<a href="#l9.347"></a><span id="l9.347">       inIdx++;</span>
<a href="#l9.348"></a><span id="l9.348">       pIn++;</span>
<a href="#l9.349"></a><span id="l9.349">     }</span>
<a href="#l9.350"></a><span id="l9.350" class="difflineminus">-    rv = m_dstFileOutputStream-&gt;Write((const char *)pStart, (PRInt32)inIdx, &amp;cntRead);</span>
<a href="#l9.351"></a><span id="l9.351" class="difflineplus">+    rv = m_dstOutputStream-&gt;Write((const char *)pStart, (PRInt32)inIdx, &amp;cntRead);</span>
<a href="#l9.352"></a><span id="l9.352">     if (NS_FAILED(rv) || (cntRead != (PRInt32)inIdx)) {</span>
<a href="#l9.353"></a><span id="l9.353" class="difflineminus">-      ReportWriteError(m_dstFile);</span>
<a href="#l9.354"></a><span id="l9.354" class="difflineplus">+      ReportWriteError(m_dstFolder);</span>
<a href="#l9.355"></a><span id="l9.355">       return false;</span>
<a href="#l9.356"></a><span id="l9.356">     }</span>
<a href="#l9.357"></a><span id="l9.357"> </span>
<a href="#l9.358"></a><span id="l9.358">     if (cnt) {</span>
<a href="#l9.359"></a><span id="l9.359">       inIdx = cnt;</span>
<a href="#l9.360"></a><span id="l9.360">       memcpy(m_pInBuffer, pIn, cnt);</span>
<a href="#l9.361"></a><span id="l9.361">     }</span>
<a href="#l9.362"></a><span id="l9.362">     else</span>
<a href="#l9.363"></a><span id="l9.363">       inIdx = 0;</span>
<a href="#l9.364"></a><span id="l9.364">   }</span>
<a href="#l9.365"></a><span id="l9.365"> </span>
<a href="#l9.366"></a><span id="l9.366">   // I used to check for an eol before writing one but</span>
<a href="#l9.367"></a><span id="l9.367">   // it turns out that adding a proper EOL before the next</span>
<a href="#l9.368"></a><span id="l9.368">   // separator never really hurts so better to be safe</span>
<a href="#l9.369"></a><span id="l9.369">   // and always do it.</span>
<a href="#l9.370"></a><span id="l9.370">   //  if ((last[0] != nsCRT::CR) || (last[1] != nsCRT::LF)) {</span>
<a href="#l9.371"></a><span id="l9.371" class="difflineminus">-  rv = m_dstFileOutputStream-&gt;Write(&quot;\x0D\x0A&quot;, 2, &amp;cntRead);</span>
<a href="#l9.372"></a><span id="l9.372" class="difflineplus">+  rv = m_dstOutputStream-&gt;Write(&quot;\x0D\x0A&quot;, 2, &amp;cntRead);</span>
<a href="#l9.373"></a><span id="l9.373">   if (NS_FAILED(rv) || (cntRead != 2)) {</span>
<a href="#l9.374"></a><span id="l9.374" class="difflineminus">-    ReportWriteError(m_dstFile);</span>
<a href="#l9.375"></a><span id="l9.375" class="difflineplus">+    ReportWriteError(m_dstFolder);</span>
<a href="#l9.376"></a><span id="l9.376">     return false;</span>
<a href="#l9.377"></a><span id="l9.377">   }</span>
<a href="#l9.378"></a><span id="l9.378">   //  } // != nsCRT::CR || != nsCRT::LF</span>
<a href="#l9.379"></a><span id="l9.379"> </span>
<a href="#l9.380"></a><span id="l9.380">   return true;</span>
<a href="#l9.381"></a><span id="l9.381"> }</span>
<a href="#l9.382"></a><span id="l9.382"> </span>
<a href="#l9.383"></a><span id="l9.383" class="difflineminus">-</span>
<a href="#l9.384"></a><span id="l9.384" class="difflineminus">-CIndexScanner::CIndexScanner(nsString&amp; name, nsIFile * idxFile, nsIFile * mbxFile, nsIFile * dstFile)</span>
<a href="#l9.385"></a><span id="l9.385" class="difflineminus">-: CMbxScanner(name, mbxFile, dstFile)</span>
<a href="#l9.386"></a><span id="l9.386" class="difflineplus">+CIndexScanner::CIndexScanner(nsString&amp; name, nsIFile * idxFile,</span>
<a href="#l9.387"></a><span id="l9.387" class="difflineplus">+                             nsIFile * mbxFile, nsIMsgFolder * dstFolder)</span>
<a href="#l9.388"></a><span id="l9.388" class="difflineplus">+  : CMbxScanner( name, mbxFile, dstFolder)</span>
<a href="#l9.389"></a><span id="l9.389"> {</span>
<a href="#l9.390"></a><span id="l9.390">   m_idxFile = idxFile;</span>
<a href="#l9.391"></a><span id="l9.391">   m_curItemIndex = 0;</span>
<a href="#l9.392"></a><span id="l9.392">   m_idxOffset = 0;</span>
<a href="#l9.393"></a><span id="l9.393"> }</span>
<a href="#l9.394"></a><span id="l9.394"> </span>
<a href="#l9.395"></a><span id="l9.395"> CIndexScanner::~CIndexScanner()</span>
<a href="#l9.396"></a><span id="l9.396"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/import/oexpress/nsOEMailbox.h</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/import/oexpress/nsOEMailbox.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -38,19 +38,23 @@</span>
<a href="#l10.4"></a><span id="l10.4"> #ifndef nsOEMailbox_h___</span>
<a href="#l10.5"></a><span id="l10.5"> #define nsOEMailbox_h___</span>
<a href="#l10.6"></a><span id="l10.6"> </span>
<a href="#l10.7"></a><span id="l10.7"> #include &quot;nscore.h&quot;</span>
<a href="#l10.8"></a><span id="l10.8"> #include &quot;prtypes.h&quot;</span>
<a href="#l10.9"></a><span id="l10.9"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l10.10"></a><span id="l10.10"> #include &quot;nsIFile.h&quot;</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+class nsIMsgFolder;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+</span>
<a href="#l10.14"></a><span id="l10.14"> class CImportMailbox {</span>
<a href="#l10.15"></a><span id="l10.15"> public:</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-  static bool    ImportMailbox(PRUint32 *pDone, bool *pAbort, nsString&amp; name, nsIFile * inFile, nsIFile * outFile, PRUint32 *pCount);</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+  static bool ImportMailbox(PRUint32 *pDone, bool *pAbort, nsString&amp; name,</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+                            nsIFile * inFile, nsIMsgFolder * outFolder,</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+                            PRUint32 *pCount);</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21"> private:</span>
<a href="#l10.22"></a><span id="l10.22">   static bool    GetIndexFile(nsIFile* mbxFile);</span>
<a href="#l10.23"></a><span id="l10.23"> };</span>
<a href="#l10.24"></a><span id="l10.24"> </span>
<a href="#l10.25"></a><span id="l10.25"> </span>
<a href="#l10.26"></a><span id="l10.26"> </span>
<a href="#l10.27"></a><span id="l10.27"> #endif // nsOEMailbox_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookImport.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookImport.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -91,19 +91,20 @@ public:</span>
<a href="#l11.4"></a><span id="l11.4">   // nsIImportmail interface</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6">   /* void GetDefaultLocation (out nsIFile location, out boolean found, out boolean userVerify); */</span>
<a href="#l11.7"></a><span id="l11.7">   NS_IMETHOD GetDefaultLocation(nsIFile **location, bool *found, bool *userVerify);</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9">   /* nsISupportsArray FindMailboxes (in nsIFile location); */</span>
<a href="#l11.10"></a><span id="l11.10">   NS_IMETHOD FindMailboxes(nsIFile *location, nsISupportsArray **_retval);</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  /* void ImportMailbox (in nsIImportMailboxDescriptor source, in nsIFile destination, out boolean fatalError); */</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-  NS_IMETHOD ImportMailbox(nsIImportMailboxDescriptor *source, nsIFile *destination,</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-                PRUnichar **pErrorLog, PRUnichar **pSuccessLog, bool *fatalError);</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+  NS_IMETHOD ImportMailbox(nsIImportMailboxDescriptor *source,</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+                           nsIMsgFolder *dstFolder,</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+                           PRUnichar **pErrorLog, PRUnichar **pSuccessLog,</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+                           bool *fatalError);</span>
<a href="#l11.19"></a><span id="l11.19"> </span>
<a href="#l11.20"></a><span id="l11.20">   /* unsigned long GetImportProgress (); */</span>
<a href="#l11.21"></a><span id="l11.21">   NS_IMETHOD GetImportProgress(PRUint32 *_retval);</span>
<a href="#l11.22"></a><span id="l11.22"> </span>
<a href="#l11.23"></a><span id="l11.23">   NS_IMETHOD TranslateFolderName(const nsAString &amp; aFolderName, nsAString &amp; _retval);</span>
<a href="#l11.24"></a><span id="l11.24"> </span>
<a href="#l11.25"></a><span id="l11.25"> public:</span>
<a href="#l11.26"></a><span id="l11.26">   static void  ReportSuccess(nsString&amp; name, PRInt32 count, nsString *pStream);</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineat">@@ -415,69 +416,63 @@ void ImportOutlookMailImpl::ReportError(</span>
<a href="#l11.28"></a><span id="l11.28"> void ImportOutlookMailImpl::SetLogs(nsString&amp; success, nsString&amp; error, PRUnichar **pError, PRUnichar **pSuccess)</span>
<a href="#l11.29"></a><span id="l11.29"> {</span>
<a href="#l11.30"></a><span id="l11.30">   if (pError)</span>
<a href="#l11.31"></a><span id="l11.31">     *pError = ToNewUnicode(error);</span>
<a href="#l11.32"></a><span id="l11.32">   if (pSuccess)</span>
<a href="#l11.33"></a><span id="l11.33">     *pSuccess = ToNewUnicode(success);</span>
<a href="#l11.34"></a><span id="l11.34"> }</span>
<a href="#l11.35"></a><span id="l11.35"> </span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-NS_IMETHODIMP ImportOutlookMailImpl::ImportMailbox( nsIImportMailboxDescriptor *pSource,</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-                        nsIFile *pDestination,</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-                        PRUnichar **pErrorLog,</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-                        PRUnichar **pSuccessLog,</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-                        bool *fatalError)</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+ImportOutlookMailImpl::ImportMailbox(nsIImportMailboxDescriptor *pSource,</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+                                     nsIMsgFolder *dstFolder,</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+                                     PRUnichar **pErrorLog,</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+                                     PRUnichar **pSuccessLog,</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+                                     bool *fatalError)</span>
<a href="#l11.47"></a><span id="l11.47"> {</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-  NS_PRECONDITION(pSource != nsnull, &quot;null ptr&quot;);</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-  NS_PRECONDITION(pDestination != nsnull, &quot;null ptr&quot;);</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-  NS_PRECONDITION(fatalError != nsnull, &quot;null ptr&quot;);</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+  NS_ENSURE_ARG_POINTER(pSource);</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+  NS_ENSURE_ARG_POINTER(dstFolder);</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+  NS_ENSURE_ARG_POINTER(fatalError);</span>
<a href="#l11.54"></a><span id="l11.54"> </span>
<a href="#l11.55"></a><span id="l11.55">   nsString  success;</span>
<a href="#l11.56"></a><span id="l11.56">   nsString  error;</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-  if (!pSource || !pDestination || !fatalError) {</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-    nsOutlookStringBundle::GetStringByID(OUTLOOKIMPORT_MAILBOX_BADPARAM, error);</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-    if (fatalError)</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-      *fatalError = true;</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-    SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-      return NS_ERROR_NULL_POINTER;</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-  }</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineminus">-</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-    bool      abort = false;</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-    nsString  name;</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineminus">-    PRUnichar *  pName;</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-    if (NS_SUCCEEDED(pSource-&gt;GetDisplayName(&amp;pName))) {</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-      name = pName;</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-      NS_Free(pName);</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-    }</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+  bool abort = false;</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+  nsString name;</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+  PRUnichar *pName;</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+  if (NS_SUCCEEDED( pSource-&gt;GetDisplayName( &amp;pName))) {</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+    name = pName;</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+    NS_Free( pName);</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+ }</span>
<a href="#l11.79"></a><span id="l11.79"> </span>
<a href="#l11.80"></a><span id="l11.80">   PRUint32 mailSize = 0;</span>
<a href="#l11.81"></a><span id="l11.81">   pSource-&gt;GetSize(&amp;mailSize);</span>
<a href="#l11.82"></a><span id="l11.82">   if (mailSize == 0) {</span>
<a href="#l11.83"></a><span id="l11.83">     ReportSuccess(name, 0, &amp;success);</span>
<a href="#l11.84"></a><span id="l11.84">     SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l11.85"></a><span id="l11.85">     return NS_OK;</span>
<a href="#l11.86"></a><span id="l11.86">   }</span>
<a href="#l11.87"></a><span id="l11.87"> </span>
<a href="#l11.88"></a><span id="l11.88">   PRUint32 index = 0;</span>
<a href="#l11.89"></a><span id="l11.89">   pSource-&gt;GetIdentifier(&amp;index);</span>
<a href="#l11.90"></a><span id="l11.90">   PRInt32  msgCount = 0;</span>
<a href="#l11.91"></a><span id="l11.91">   nsresult rv = NS_OK;</span>
<a href="#l11.92"></a><span id="l11.92"> </span>
<a href="#l11.93"></a><span id="l11.93">   m_bytesDone = 0;</span>
<a href="#l11.94"></a><span id="l11.94"> </span>
<a href="#l11.95"></a><span id="l11.95" class="difflineminus">-  rv = m_mail.ImportMailbox(&amp;m_bytesDone, &amp;abort, (PRInt32)index, name.get(), pDestination, &amp;msgCount);</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+  rv = m_mail.ImportMailbox(&amp;m_bytesDone, &amp;abort, (PRInt32)index, name.get(),</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+                            dstFolder, &amp;msgCount);</span>
<a href="#l11.98"></a><span id="l11.98"> </span>
<a href="#l11.99"></a><span id="l11.99">   if (NS_SUCCEEDED(rv))</span>
<a href="#l11.100"></a><span id="l11.100">     ReportSuccess(name, msgCount, &amp;success);</span>
<a href="#l11.101"></a><span id="l11.101">   else</span>
<a href="#l11.102"></a><span id="l11.102">     ReportError(OUTLOOKIMPORT_MAILBOX_CONVERTERROR, name, &amp;error);</span>
<a href="#l11.103"></a><span id="l11.103"> </span>
<a href="#l11.104"></a><span id="l11.104">   SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l11.105"></a><span id="l11.105"> </span>
<a href="#l11.106"></a><span id="l11.106" class="difflineminus">-    return rv;</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+  return rv;</span>
<a href="#l11.108"></a><span id="l11.108"> }</span>
<a href="#l11.109"></a><span id="l11.109"> </span>
<a href="#l11.110"></a><span id="l11.110"> </span>
<a href="#l11.111"></a><span id="l11.111"> NS_IMETHODIMP ImportOutlookMailImpl::GetImportProgress(PRUint32 *pDoneSoFar)</span>
<a href="#l11.112"></a><span id="l11.112"> {</span>
<a href="#l11.113"></a><span id="l11.113">   NS_PRECONDITION(pDoneSoFar != nsnull, &quot;null ptr&quot;);</span>
<a href="#l11.114"></a><span id="l11.114">   if (! pDoneSoFar)</span>
<a href="#l11.115"></a><span id="l11.115">     return NS_ERROR_NULL_POINTER;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookMail.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookMail.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -51,16 +51,19 @@</span>
<a href="#l12.4"></a><span id="l12.4"> #include &quot;nsOutlookStringBundle.h&quot;</span>
<a href="#l12.5"></a><span id="l12.5"> #include &quot;nsABBaseCID.h&quot;</span>
<a href="#l12.6"></a><span id="l12.6"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l12.7"></a><span id="l12.7"> #include &quot;mdb.h&quot;</span>
<a href="#l12.8"></a><span id="l12.8"> #include &quot;OutlookDebugLog.h&quot;</span>
<a href="#l12.9"></a><span id="l12.9"> #include &quot;nsOutlookMail.h&quot;</span>
<a href="#l12.10"></a><span id="l12.10"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l12.11"></a><span id="l12.11"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+#include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+#include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+#include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l12.15"></a><span id="l12.15"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l12.16"></a><span id="l12.16"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l12.17"></a><span id="l12.17"> </span>
<a href="#l12.18"></a><span id="l12.18"> static NS_DEFINE_IID(kISupportsIID,      NS_ISUPPORTS_IID);</span>
<a href="#l12.19"></a><span id="l12.19"> </span>
<a href="#l12.20"></a><span id="l12.20"> /* ------------ Address book stuff ----------------- */</span>
<a href="#l12.21"></a><span id="l12.21"> typedef struct {</span>
<a href="#l12.22"></a><span id="l12.22">   PRInt32    mozField;</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineat">@@ -351,27 +354,30 @@ void nsOutlookMail::OpenMessageStore(CMa</span>
<a href="#l12.24"></a><span id="l12.24"> // nsOutlookMail</span>
<a href="#l12.25"></a><span id="l12.25"> //   - Connect to Outlook</span>
<a href="#l12.26"></a><span id="l12.26"> //   - Enumerate the mailboxes</span>
<a href="#l12.27"></a><span id="l12.27"> //   - Iterate the mailboxes</span>
<a href="#l12.28"></a><span id="l12.28"> //   - For each mail, create one nsOutlookCompose object</span>
<a href="#l12.29"></a><span id="l12.29"> //   - For each mail, create one CMapiMessage object</span>
<a href="#l12.30"></a><span id="l12.30"> //</span>
<a href="#l12.31"></a><span id="l12.31"> // nsOutlookCompose</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-//   - Establich a TB session</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+//   - Establish a TB session</span>
<a href="#l12.34"></a><span id="l12.34"> //   - Connect to all required services</span>
<a href="#l12.35"></a><span id="l12.35"> //   - Perform the composition of the RC822 document from the data gathered by CMapiMessage</span>
<a href="#l12.36"></a><span id="l12.36"> //   - Save the composed message to the TB mailbox</span>
<a href="#l12.37"></a><span id="l12.37"> //   - Ensure the proper cleanup</span>
<a href="#l12.38"></a><span id="l12.38"> //</span>
<a href="#l12.39"></a><span id="l12.39"> // CMapiMessage</span>
<a href="#l12.40"></a><span id="l12.40"> //   - Encapsulate the MAPI message interface</span>
<a href="#l12.41"></a><span id="l12.41"> //   - Gather the information required to (re)compose the message</span>
<a href="#l12.42"></a><span id="l12.42"> </span>
<a href="#l12.43"></a><span id="l12.43" class="difflineminus">-nsresult nsOutlookMail::ImportMailbox(PRUint32 *pDoneSoFar, bool *pAbort, PRInt32 index, const PRUnichar *pName, nsIFile *pDest, PRInt32 *pMsgCount)</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+nsresult nsOutlookMail::ImportMailbox(PRUint32 *pDoneSoFar, bool *pAbort,</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+                                      PRInt32 index, const PRUnichar *pName,</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+                                      nsIMsgFolder *dstFolder,</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+                                      PRInt32 *pMsgCount)</span>
<a href="#l12.48"></a><span id="l12.48"> {</span>
<a href="#l12.49"></a><span id="l12.49">   if ((index &lt; 0) || (index &gt;= m_folderList.GetSize())) {</span>
<a href="#l12.50"></a><span id="l12.50">     IMPORT_LOG0(&quot;*** Bad mailbox identifier, unable to import\n&quot;);</span>
<a href="#l12.51"></a><span id="l12.51">     *pAbort = true;</span>
<a href="#l12.52"></a><span id="l12.52">     return NS_ERROR_FAILURE;</span>
<a href="#l12.53"></a><span id="l12.53">   }</span>
<a href="#l12.54"></a><span id="l12.54"> </span>
<a href="#l12.55"></a><span id="l12.55">   PRInt32    dummyMsgCount = 0;</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineat">@@ -385,39 +391,43 @@ nsresult nsOutlookMail::ImportMailbox(PR</span>
<a href="#l12.57"></a><span id="l12.57">   if (!m_lpMdb) {</span>
<a href="#l12.58"></a><span id="l12.58">     IMPORT_LOG1(&quot;*** Unable to obtain mapi message store for mailbox: %S\n&quot;, pName);</span>
<a href="#l12.59"></a><span id="l12.59">     return NS_ERROR_FAILURE;</span>
<a href="#l12.60"></a><span id="l12.60">   }</span>
<a href="#l12.61"></a><span id="l12.61"> </span>
<a href="#l12.62"></a><span id="l12.62">   if (pFolder-&gt;IsStore())</span>
<a href="#l12.63"></a><span id="l12.63">     return NS_OK;</span>
<a href="#l12.64"></a><span id="l12.64"> </span>
<a href="#l12.65"></a><span id="l12.65" class="difflineminus">-  nsresult  rv;</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineminus">-</span>
<a href="#l12.67"></a><span id="l12.67">   // now what?</span>
<a href="#l12.68"></a><span id="l12.68">   CMapiFolderContents    contents(m_lpMdb, pFolder-&gt;GetCBEntryID(), pFolder-&gt;GetEntryID());</span>
<a href="#l12.69"></a><span id="l12.69"> </span>
<a href="#l12.70"></a><span id="l12.70">   BOOL    done = FALSE;</span>
<a href="#l12.71"></a><span id="l12.71">   ULONG    cbEid;</span>
<a href="#l12.72"></a><span id="l12.72">   LPENTRYID  lpEid;</span>
<a href="#l12.73"></a><span id="l12.73">   ULONG    oType;</span>
<a href="#l12.74"></a><span id="l12.74">   LPMESSAGE  lpMsg = nsnull;</span>
<a href="#l12.75"></a><span id="l12.75">   ULONG    totalCount;</span>
<a href="#l12.76"></a><span id="l12.76">   PRFloat64  doneCalc;</span>
<a href="#l12.77"></a><span id="l12.77"> </span>
<a href="#l12.78"></a><span id="l12.78" class="difflineminus">-  nsCOMPtr&lt;nsIOutputStream&gt; destOutputStream;</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineminus">-  rv = MsgNewBufferedFileOutputStream(getter_AddRefs(destOutputStream), pDest, -1, 0600);</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+  nsresult rv = dstFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l12.83"></a><span id="l12.83">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.84"></a><span id="l12.84"> </span>
<a href="#l12.85"></a><span id="l12.85">   while (!done) {</span>
<a href="#l12.86"></a><span id="l12.86">     if (!contents.GetNext(&amp;cbEid, &amp;lpEid, &amp;oType, &amp;done)) {</span>
<a href="#l12.87"></a><span id="l12.87">       IMPORT_LOG1(&quot;*** Error iterating mailbox: %S\n&quot;, pName);</span>
<a href="#l12.88"></a><span id="l12.88">       return NS_ERROR_FAILURE;</span>
<a href="#l12.89"></a><span id="l12.89">     }</span>
<a href="#l12.90"></a><span id="l12.90"> </span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+    bool reusable;</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+    rv = msgStore-&gt;GetNewMsgOutputStream(dstFolder, getter_AddRefs(msgHdr), &amp;reusable,</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+                                         getter_AddRefs(outputStream));</span>
<a href="#l12.96"></a><span id="l12.96">     totalCount = contents.GetCount();</span>
<a href="#l12.97"></a><span id="l12.97">     doneCalc = *pMsgCount;</span>
<a href="#l12.98"></a><span id="l12.98">     doneCalc /= totalCount;</span>
<a href="#l12.99"></a><span id="l12.99">     doneCalc *= 1000;</span>
<a href="#l12.100"></a><span id="l12.100">     if (pDoneSoFar) {</span>
<a href="#l12.101"></a><span id="l12.101">       *pDoneSoFar = (PRUint32) doneCalc;</span>
<a href="#l12.102"></a><span id="l12.102">       if (*pDoneSoFar &gt; 1000)</span>
<a href="#l12.103"></a><span id="l12.103">         *pDoneSoFar = 1000;</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineat">@@ -432,24 +442,32 @@ nsresult nsOutlookMail::ImportMailbox(PR</span>
<a href="#l12.105"></a><span id="l12.105">       // See if it's a drafts folder. Outlook doesn't allow drafts</span>
<a href="#l12.106"></a><span id="l12.106">       // folder to be configured so it's ok to hard code it here.</span>
<a href="#l12.107"></a><span id="l12.107">       nsAutoString folderName(pName);</span>
<a href="#l12.108"></a><span id="l12.108">       nsMsgDeliverMode mode = nsIMsgSend::nsMsgDeliverNow;</span>
<a href="#l12.109"></a><span id="l12.109">       mode = nsIMsgSend::nsMsgSaveAsDraft;</span>
<a href="#l12.110"></a><span id="l12.110">       if (folderName.LowerCaseEqualsLiteral(&quot;drafts&quot;))</span>
<a href="#l12.111"></a><span id="l12.111">         mode = nsIMsgSend::nsMsgSaveAsDraft;</span>
<a href="#l12.112"></a><span id="l12.112"> </span>
<a href="#l12.113"></a><span id="l12.113" class="difflineminus">-      rv = ImportMessage(lpMsg, destOutputStream, mode);</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineminus">-      if (NS_SUCCEEDED(rv)) // No errors &amp; really imported</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineminus">-        (*pMsgCount)++;</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineminus">-      else</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineminus">-        IMPORT_LOG1(&quot;*** Error reading message from mailbox: %S\n&quot;, pName);</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+      rv = ImportMessage(lpMsg, outputStream, mode);</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineplus">+      if (NS_SUCCEEDED(rv)){ // No errors &amp; really imported</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineplus">+         (*pMsgCount)++;</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineplus">+        msgStore-&gt;FinishNewMessage(outputStream, msgHdr);</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineplus">+      }</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineplus">+      else {</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineplus">+        IMPORT_LOG1( &quot;*** Error reading message from mailbox: %S\n&quot;, pName);</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineplus">+        msgStore-&gt;DiscardNewMessage(outputStream, msgHdr);</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineplus">+      }</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineplus">+      if (!reusable)</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineplus">+        outputStream-&gt;Close();</span>
<a href="#l12.129"></a><span id="l12.129">     }</span>
<a href="#l12.130"></a><span id="l12.130">   }</span>
<a href="#l12.131"></a><span id="l12.131"> </span>
<a href="#l12.132"></a><span id="l12.132" class="difflineplus">+  if (outputStream)</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineplus">+    outputStream-&gt;Close();</span>
<a href="#l12.134"></a><span id="l12.134">   return NS_OK;</span>
<a href="#l12.135"></a><span id="l12.135"> }</span>
<a href="#l12.136"></a><span id="l12.136"> </span>
<a href="#l12.137"></a><span id="l12.137"> nsresult nsOutlookMail::ImportMessage(LPMESSAGE lpMsg, nsIOutputStream *pDest, nsMsgDeliverMode mode)</span>
<a href="#l12.138"></a><span id="l12.138"> {</span>
<a href="#l12.139"></a><span id="l12.139">   CMapiMessage  msg(lpMsg);</span>
<a href="#l12.140"></a><span id="l12.140">   // If we wanted to skip messages that were downloaded in header only mode, we</span>
<a href="#l12.141"></a><span id="l12.141">   // would return NS_ERROR_FAILURE if !msg.FullMessageDownloaded. However, we</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookMail.h</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookMail.h</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -52,17 +52,19 @@ class nsIImportFieldMap;</span>
<a href="#l13.4"></a><span id="l13.4"> </span>
<a href="#l13.5"></a><span id="l13.5"> class nsOutlookMail {</span>
<a href="#l13.6"></a><span id="l13.6"> public:</span>
<a href="#l13.7"></a><span id="l13.7">   nsOutlookMail();</span>
<a href="#l13.8"></a><span id="l13.8">   ~nsOutlookMail();</span>
<a href="#l13.9"></a><span id="l13.9">   </span>
<a href="#l13.10"></a><span id="l13.10">   nsresult GetMailFolders(nsISupportsArray **pArray);</span>
<a href="#l13.11"></a><span id="l13.11">   nsresult GetAddressBooks(nsISupportsArray **pArray);</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-  nsresult ImportMailbox(PRUint32 *pDoneSoFar, bool *pAbort, PRInt32 index, const PRUnichar *pName, nsIFile *pDest, PRInt32 *pMsgCount);</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+  nsresult ImportMailbox(PRUint32 *pDoneSoFar, bool *pAbort, PRInt32 index,</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+                         const PRUnichar *pName, nsIMsgFolder *pDest,</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+                         PRInt32 *pMsgCount);</span>
<a href="#l13.16"></a><span id="l13.16">   static nsresult ImportMessage(LPMESSAGE lpMsg, nsIOutputStream *destOutputStream, nsMsgDeliverMode mode);</span>
<a href="#l13.17"></a><span id="l13.17">   nsresult ImportAddresses(PRUint32 *pCount, PRUint32 *pTotal, const PRUnichar *pName, PRUint32 id, nsIAddrDatabase *pDb, nsString&amp; errors);</span>
<a href="#l13.18"></a><span id="l13.18"> private:</span>
<a href="#l13.19"></a><span id="l13.19">   void  OpenMessageStore(CMapiFolder *pNextFolder);</span>
<a href="#l13.20"></a><span id="l13.20">   static BOOL  WriteData(nsIOutputStream *pDest, const char *pData, PRInt32 len);</span>
<a href="#l13.21"></a><span id="l13.21">   </span>
<a href="#l13.22"></a><span id="l13.22">   bool      IsAddressBookNameUnique(nsString&amp; name, nsString&amp; list);</span>
<a href="#l13.23"></a><span id="l13.23">   void      MakeAddressBookNameUnique(nsString&amp; name, nsString&amp; list);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/import/public/nsIImportMail.idl</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/import/public/nsIImportMail.idl</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -62,22 +62,23 @@</span>
<a href="#l14.4"></a><span id="l14.4">   always be less than the mailbox size until you are done.  This</span>
<a href="#l14.5"></a><span id="l14.5">   is used for progress bar updating and MAY BE CALLED FROM ANOTHER</span>
<a href="#l14.6"></a><span id="l14.6">   THREAD!</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8"> */</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-interface   nsIFile;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-interface   nsISupportsArray;</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-interface  nsIImportMailboxDescriptor;</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-interface  nsIOutputStream;</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+interface nsIFile;</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+interface nsISupportsArray;</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+interface nsIImportMailboxDescriptor;</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+interface nsIOutputStream;</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+interface nsIMsgFolder;</span>
<a href="#l14.21"></a><span id="l14.21"> </span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-[scriptable, uuid(cf208fac-b275-449d-9dc9-0d8f16c59fe1)]</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+[scriptable, uuid(306561d3-ed2f-425d-87ee-eb129a84a6af)]</span>
<a href="#l14.24"></a><span id="l14.24"> interface nsIImportMail : nsISupports</span>
<a href="#l14.25"></a><span id="l14.25"> {</span>
<a href="#l14.26"></a><span id="l14.26"> </span>
<a href="#l14.27"></a><span id="l14.27">   /*</span>
<a href="#l14.28"></a><span id="l14.28">     If found and userVerify BOTH return false, then it is assumed that this</span>
<a href="#l14.29"></a><span id="l14.29">     means an error - mail cannot be found on this machine.</span>
<a href="#l14.30"></a><span id="l14.30">     If userVerify is true, the user will have an opportunity to specify</span>
<a href="#l14.31"></a><span id="l14.31">     a different location to import mail from.</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineat">@@ -87,26 +88,26 @@ interface nsIImportMail : nsISupports</span>
<a href="#l14.33"></a><span id="l14.33">                 out boolean  userVerify);</span>
<a href="#l14.34"></a><span id="l14.34">   /*</span>
<a href="#l14.35"></a><span id="l14.35">     Returns an nsISupportsArray which contains an nsIImportMailboxID for each</span>
<a href="#l14.36"></a><span id="l14.36">     mailbox.  The array is not sorted before display to the user.</span>
<a href="#l14.37"></a><span id="l14.37">   */</span>
<a href="#l14.38"></a><span id="l14.38">   nsISupportsArray FindMailboxes( in nsIFile location);</span>
<a href="#l14.39"></a><span id="l14.39"> </span>
<a href="#l14.40"></a><span id="l14.40">   /*</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-    Import a specific mailbox into the destination file supplied.  If an error</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+    Import a specific mailbox into the destination folder supplied.  If an error</span>
<a href="#l14.43"></a><span id="l14.43">     occurs that is non-fatal, the destination will be deleted and other mailboxes</span>
<a href="#l14.44"></a><span id="l14.44">     will be imported.  If a fatal error occurs, the destination will be deleted</span>
<a href="#l14.45"></a><span id="l14.45">     and the import operation will abort.</span>
<a href="#l14.46"></a><span id="l14.46">   */</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-  void   ImportMailbox( in nsIImportMailboxDescriptor source,</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-               in nsIFile destination,</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineminus">-               out wstring errorLog,</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-               out wstring successLog,</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineminus">-               out boolean fatalError);</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+  void   ImportMailbox(in nsIImportMailboxDescriptor source,</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+                       in nsIMsgFolder dstFolder,</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+                       out wstring errorLog,</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+                       out wstring successLog,</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+                       out boolean fatalError);</span>
<a href="#l14.57"></a><span id="l14.57"> </span>
<a href="#l14.58"></a><span id="l14.58">   /*</span>
<a href="#l14.59"></a><span id="l14.59">     Return the amount of the mailbox that has been imported so far.  This number</span>
<a href="#l14.60"></a><span id="l14.60">     is used to present progress information and must never be larger than the</span>
<a href="#l14.61"></a><span id="l14.61">     size specified in nsIImportMailboxID.GetSize();  May be called from</span>
<a href="#l14.62"></a><span id="l14.62">     a different thread than ImportMailbox()</span>
<a href="#l14.63"></a><span id="l14.63">   */</span>
<a href="#l14.64"></a><span id="l14.64">   unsigned long GetImportProgress();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/import/src/nsImportMail.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/import/src/nsImportMail.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -758,17 +758,16 @@ ImportMailThread(void *stuff)</span>
<a href="#l15.4"></a><span id="l15.4">   PRUint32    depth = 1;</span>
<a href="#l15.5"></a><span id="l15.5">   PRUint32    newDepth;</span>
<a href="#l15.6"></a><span id="l15.6">   nsString    lastName;</span>
<a href="#l15.7"></a><span id="l15.7">   PRUnichar *    pName;</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9">   nsCOMPtr&lt;nsIMsgFolder&gt;    curFolder(destRoot);</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11">   nsCOMPtr&lt;nsIMsgFolder&gt;          newFolder;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt;          outBox;</span>
<a href="#l15.13"></a><span id="l15.13">   nsCOMPtr&lt;nsIMsgFolder&gt;          subFolder;</span>
<a href="#l15.14"></a><span id="l15.14">   nsCOMPtr&lt;nsISimpleEnumerator&gt;   enumerator;</span>
<a href="#l15.15"></a><span id="l15.15"> </span>
<a href="#l15.16"></a><span id="l15.16">   bool              exists;</span>
<a href="#l15.17"></a><span id="l15.17"> </span>
<a href="#l15.18"></a><span id="l15.18">   nsString  success;</span>
<a href="#l15.19"></a><span id="l15.19">   nsString  error;</span>
<a href="#l15.20"></a><span id="l15.20"> </span>
<a href="#l15.21"></a><span id="l15.21" class="difflineat">@@ -859,32 +858,28 @@ ImportMailThread(void *stuff)</span>
<a href="#l15.22"></a><span id="l15.22">         if (!subName.IsEmpty())</span>
<a href="#l15.23"></a><span id="l15.23">           lastName.Assign(subName);</span>
<a href="#l15.24"></a><span id="l15.24">       }</span>
<a href="#l15.25"></a><span id="l15.25"> </span>
<a href="#l15.26"></a><span id="l15.26">       IMPORT_LOG1(&quot;ImportMailThread: Creating new import folder '%s'.&quot;, NS_ConvertUTF16toUTF8(lastName).get());</span>
<a href="#l15.27"></a><span id="l15.27">       ProxyCreateSubfolder(curFolder, lastName); // this may fail if the folder already exists..that's ok</span>
<a href="#l15.28"></a><span id="l15.28"> </span>
<a href="#l15.29"></a><span id="l15.29">       rv = ProxyGetChildNamed(curFolder, lastName, getter_AddRefs(newFolder));</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-        newFolder-&gt;GetFilePath(getter_AddRefs(outBox));</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">-      else</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+      if (NS_FAILED(rv)) {</span>
<a href="#l15.34"></a><span id="l15.34">         IMPORT_LOG1(&quot;*** ImportMailThread: Failed to locate subfolder '%s' after it's been created.&quot;, lastName.get());</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineminus">-</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineminus">-      if (NS_FAILED(rv)) {</span>
<a href="#l15.37"></a><span id="l15.37">         nsImportGenericMail::ReportError(IMPORT_ERROR_MB_CREATE, lastName.get(),</span>
<a href="#l15.38"></a><span id="l15.38">                                          &amp;error, pData-&gt;stringBundle);</span>
<a href="#l15.39"></a><span id="l15.39">       }</span>
<a href="#l15.40"></a><span id="l15.40"> </span>
<a href="#l15.41"></a><span id="l15.41" class="difflineminus">-      if (size &amp;&amp; import &amp;&amp; newFolder &amp;&amp; outBox &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+      if (size &amp;&amp; import &amp;&amp; newFolder &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l15.43"></a><span id="l15.43">         bool fatalError = false;</span>
<a href="#l15.44"></a><span id="l15.44">         pData-&gt;currentSize = size;</span>
<a href="#l15.45"></a><span id="l15.45">         PRUnichar *pSuccess = nsnull;</span>
<a href="#l15.46"></a><span id="l15.46">         PRUnichar *pError = nsnull;</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineminus">-        rv = pData-&gt;mailImport-&gt;ImportMailbox(box, outBox, &amp;pError, &amp;pSuccess, &amp;fatalError);</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+        rv = pData-&gt;mailImport-&gt;ImportMailbox(box, newFolder, &amp;pError, &amp;pSuccess, &amp;fatalError);</span>
<a href="#l15.49"></a><span id="l15.49">         if (pError) {</span>
<a href="#l15.50"></a><span id="l15.50">           error.Append(pError);</span>
<a href="#l15.51"></a><span id="l15.51">           NS_Free(pError);</span>
<a href="#l15.52"></a><span id="l15.52">         }</span>
<a href="#l15.53"></a><span id="l15.53">         if (pSuccess) {</span>
<a href="#l15.54"></a><span id="l15.54">           success.Append(pSuccess);</span>
<a href="#l15.55"></a><span id="l15.55">           NS_Free(pSuccess);</span>
<a href="#l15.56"></a><span id="l15.56">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/import/winlivemail/nsWMImport.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/import/winlivemail/nsWMImport.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -90,24 +90,25 @@ public:</span>
<a href="#l16.4"></a><span id="l16.4">   // nsIImportmail interface</span>
<a href="#l16.5"></a><span id="l16.5"> </span>
<a href="#l16.6"></a><span id="l16.6">   /* void GetDefaultLocation (out nsIFile location, out boolean found, out boolean userVerify); */</span>
<a href="#l16.7"></a><span id="l16.7">   NS_IMETHOD GetDefaultLocation(nsIFile **location, bool *found, bool *userVerify);</span>
<a href="#l16.8"></a><span id="l16.8"> </span>
<a href="#l16.9"></a><span id="l16.9">   /* nsISupportsArray FindMailboxes (in nsIFile location); */</span>
<a href="#l16.10"></a><span id="l16.10">   NS_IMETHOD FindMailboxes(nsIFile *location, nsISupportsArray **_retval);</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-  /* void ImportMailbox (in nsIImportMailboxDescriptor source, in nsIFile destination, out boolean fatalError); */</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-  NS_IMETHOD ImportMailbox(nsIImportMailboxDescriptor *source, nsIFile *destination,</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-                PRUnichar **pErrorLog, PRUnichar **pSuccessLog, bool *fatalError);</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+  NS_IMETHOD ImportMailbox(nsIImportMailboxDescriptor *source,</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+                           nsIMsgFolder *dstFolder,</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+                           PRUnichar **pErrorLog, PRUnichar **pSuccessLog,</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+                           bool *fatalError);</span>
<a href="#l16.19"></a><span id="l16.19"> </span>
<a href="#l16.20"></a><span id="l16.20">   /* unsigned long GetImportProgress (); */</span>
<a href="#l16.21"></a><span id="l16.21">   NS_IMETHOD GetImportProgress(PRUint32 *_retval);</span>
<a href="#l16.22"></a><span id="l16.22"> </span>
<a href="#l16.23"></a><span id="l16.23" class="difflineminus">-    NS_IMETHOD TranslateFolderName(const nsAString &amp; aFolderName, nsAString &amp; _retval);</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineplus">+  NS_IMETHOD TranslateFolderName(const nsAString &amp; aFolderName, nsAString &amp; _retval);</span>
<a href="#l16.25"></a><span id="l16.25"> </span>
<a href="#l16.26"></a><span id="l16.26"> public:</span>
<a href="#l16.27"></a><span id="l16.27">   static void ReportSuccess(nsString&amp; name, PRInt32 count, nsString *pStream);</span>
<a href="#l16.28"></a><span id="l16.28">   static void ReportError(PRInt32 errorNum, nsString&amp; name, nsString *pStream);</span>
<a href="#l16.29"></a><span id="l16.29">   static void AddLinebreak(nsString *pStream);</span>
<a href="#l16.30"></a><span id="l16.30">   static void SetLogs(nsString&amp; success, nsString&amp; error, PRUnichar **pError, PRUnichar **pSuccess);</span>
<a href="#l16.31"></a><span id="l16.31"> </span>
<a href="#l16.32"></a><span id="l16.32"> private:</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineat">@@ -266,17 +267,17 @@ void ImportWMMailImpl::SetLogs(nsString&amp;</span>
<a href="#l16.34"></a><span id="l16.34"> {</span>
<a href="#l16.35"></a><span id="l16.35">   if (pError)</span>
<a href="#l16.36"></a><span id="l16.36">     *pError = ToNewUnicode(error);</span>
<a href="#l16.37"></a><span id="l16.37">   if (pSuccess)</span>
<a href="#l16.38"></a><span id="l16.38">     *pSuccess = ToNewUnicode(success);</span>
<a href="#l16.39"></a><span id="l16.39"> }</span>
<a href="#l16.40"></a><span id="l16.40"> </span>
<a href="#l16.41"></a><span id="l16.41"> NS_IMETHODIMP ImportWMMailImpl::ImportMailbox(nsIImportMailboxDescriptor *pSource,</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineminus">-                                              nsIFile *pDestination,</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+                                              nsIMsgFolder *pDstFolder,</span>
<a href="#l16.44"></a><span id="l16.44">                                               PRUnichar **pErrorLog,</span>
<a href="#l16.45"></a><span id="l16.45">                                               PRUnichar **pSuccessLog,</span>
<a href="#l16.46"></a><span id="l16.46">                                               bool *fatalError)</span>
<a href="#l16.47"></a><span id="l16.47"> {</span>
<a href="#l16.48"></a><span id="l16.48">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l16.49"></a><span id="l16.49"> }</span>
<a href="#l16.50"></a><span id="l16.50"> </span>
<a href="#l16.51"></a><span id="l16.51"> NS_IMETHODIMP ImportWMMailImpl::GetImportProgress(PRUint32 *pDoneSoFar)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/suite/locales/en-US/chrome/mailnews/eudoraImportMsgs.properties</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/mailnews/eudoraImportMsgs.properties</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -55,22 +55,16 @@ 2029=Eudora mail, address books, and set</span>
<a href="#l17.4"></a><span id="l17.4"> # LOCALIZATION NOTE (2002): In the following sentence,</span>
<a href="#l17.5"></a><span id="l17.5"> # the %S represents a string to be inserted at runtime (the name of the Mailbox), </span>
<a href="#l17.6"></a><span id="l17.6"> # and the %d is a number (the number of messages imported). Do not translate %d or %S, but</span>
<a href="#l17.7"></a><span id="l17.7"> # instead insert them in your text at the appropriate places.</span>
<a href="#l17.8"></a><span id="l17.8"> </span>
<a href="#l17.9"></a><span id="l17.9"> 2002=Mailbox %S, imported %d messages</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11"> # Error message</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-## @name EUDORAIMPORT_MAILBOX_BADPARAM</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-## @loc None</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-2003=Bad parameter passed to import mailbox.</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-# Error message</span>
<a href="#l17.18"></a><span id="l17.18"> ## @name EUDORAIMPORT_MAILBOX_BADSOURCEFILE</span>
<a href="#l17.19"></a><span id="l17.19"> ## @loc None</span>
<a href="#l17.20"></a><span id="l17.20"> # LOCALIZATION NOTE (2004): In the following sentence, do not translate the &quot;%S&quot;. Instead,</span>
<a href="#l17.21"></a><span id="l17.21"> # place it in your sentence where you wish to display the name of the mailbox.</span>
<a href="#l17.22"></a><span id="l17.22"> </span>
<a href="#l17.23"></a><span id="l17.23"> 2004=Error accessing file for mailbox %S.</span>
<a href="#l17.24"></a><span id="l17.24"> </span>
<a href="#l17.25"></a><span id="l17.25"> # Error message</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

