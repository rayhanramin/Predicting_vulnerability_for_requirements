<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 25384:1403c0fa3d1ac8b10ec74adb92b245575059298f</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 1403c0fa3d1ac8b10ec74adb92b245575059298f" />
<meta property="og:url" content="/comm-central/rev/1403c0fa3d1ac8b10ec74adb92b245575059298f" />
<meta property="og:description" content="Bug 1500105 - Support Exchange AutoDiscover and parallelize network calls. r=aceman,mkmelin,Neil" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 1403c0fa3d1ac8b10ec74adb92b245575059298f 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/1403c0fa3d1ac8b10ec74adb92b245575059298f">shortlog</a> |
<a href="/comm-central/log/1403c0fa3d1ac8b10ec74adb92b245575059298f">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/1403c0fa3d1ac8b10ec74adb92b245575059298f">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/1403c0fa3d1ac8b10ec74adb92b245575059298f">files</a> |
changeset |
<a href="/comm-central/raw-rev/1403c0fa3d1ac8b10ec74adb92b245575059298f">raw</a>  | <a href="/comm-central/archive/1403c0fa3d1ac8b10ec74adb92b245575059298f.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1500105">Bug 1500105</a> - Support Exchange AutoDiscover and parallelize network calls. r=aceman,mkmelin,Neil
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#66;&#101;&#110;&#32;&#66;&#117;&#99;&#107;&#115;&#99;&#104;&#32;&#60;&#98;&#101;&#110;&#46;&#98;&#117;&#99;&#107;&#115;&#99;&#104;&#64;&#98;&#101;&#111;&#110;&#101;&#120;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 14 Dec 2018 12:05:14 +0100</td></tr>

<tr>
 <td>changeset 25384</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/1403c0fa3d1ac8b10ec74adb92b245575059298f">1403c0fa3d1ac8b10ec74adb92b245575059298f</a></td>
</tr>



<tr>
<td>parent 25383</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f5c4404b29d27444dfd885fa781fe44351c0c18a">f5c4404b29d27444dfd885fa781fe44351c0c18a</a>
</td>
</tr>

<tr>
<td>child 25385</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/480eb7e81d39fddb4af9779d5d1ea3bc7a51a54c">480eb7e81d39fddb4af9779d5d1ea3bc7a51a54c</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=1403c0fa3d1ac8b10ec74adb92b245575059298f">15231</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 14 Dec 2018 16:34:58 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@1403c0fa3d1a [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1403c0fa3d1ac8b10ec74adb92b245575059298f">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1403c0fa3d1ac8b10ec74adb92b245575059298f&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1403c0fa3d1ac8b10ec74adb92b245575059298f&newProject=comm-central&newRevision=f5c4404b29d27444dfd885fa781fe44351c0c18a&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1403c0fa3d1ac8b10ec74adb92b245575059298f&newProject=comm-central&newRevision=f5c4404b29d27444dfd885fa781fe44351c0c18a&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1403c0fa3d1ac8b10ec74adb92b245575059298f&newProject=comm-central&newRevision=f5c4404b29d27444dfd885fa781fe44351c0c18a&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28aceman%29&revcount=50">aceman</a>, <a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a>, <a href="/comm-central/log?rev=reviewer%28Neil%29&revcount=50">Neil</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1500105">1500105</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1500105">Bug 1500105</a> - Support Exchange AutoDiscover and parallelize network calls. r=aceman,mkmelin,Neil

Summary:
* Parallelize network calls
* Exchange AutoDiscover protocol implementation
* Try to find IMAP servers in the server response
* Offer to install an extension which supports the Exchange protocol to get mails

Runs all the ISP config lookup network calls in parallel. Class
PriorityOrderAbortable (subclass of ParallelAbortable) implements a
policy that waits until one of the calls returns successfully, then takes
that result and cancels all pending less desirable calls.

Implements the Exchange AutoDiscover protocol to detect Exchange servers.
If the server gives an IMAP configuration, we offer that to the user.
Alternatively, we offer a compatible verified extension that implements the
specific Exchange protocol that the Exchange server returned.
Exchange has at least 7 protocols, and we show extensions that support the
protocols that the server listed and that are known to work well and actively
maintained. The setup process then continues without interruption.

Test plan:
Exchange autoconfig:
1. To test Exchange AutoDiscover with an hotmail/outlook.com account
   (which has an IMAP config in our ISPDB), set these prefs:
   mailnews.auto_config.guess.enabled = false
   mailnews.auto_config_url = &quot;&quot;
   mailnews.mx_service_url = &quot;&quot;
2. Enter you@outlook.com and a valid password (it will not work without
   valid password, due to the Exchange AutoDiscover protocol design)
3. [Continue]
4. -&gt; TB should find an Exchange server with hostname
5. -&gt; TB will offer you to install an extension that supports this protocol type,
      with explanatory text and a link
6. Click [Install]
7. -&gt; The password is checked, the dialog closes, and the account appears,
      and your emails are downloaded.

Parallel network calls:
1. Open account creation dialog
2. Enter &quot;foo@gmail.com&quot;, &quot;foo@yahoo.com&quot;, &quot;foo@sys4.de&quot;,
   &quot;foo@example.com&quot;, or any other domain
3. -&gt; It works functionally as before, see https://developer.mozilla.org/en-US/docs/Mozilla/Thunderbird/Autoconfiguration
4. -&gt; It's faster than before

Differential Revision: <a href="https://phabricator.services.mozilla.com/D9215">https://phabricator.services.mozilla.com/D9215</a></div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/.eslintrc.js">mail/components/accountcreation/content/.eslintrc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/.eslintrc.js">file</a> |
<a href="/comm-central/annotate/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/.eslintrc.js">annotate</a> |
<a href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/.eslintrc.js">diff</a> |
<a href="/comm-central/comparison/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/.eslintrc.js">comparison</a> |
<a href="/comm-central/log/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/.eslintrc.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/accountConfig.js">mail/components/accountcreation/content/accountConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/accountConfig.js">file</a> |
<a href="/comm-central/annotate/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/accountConfig.js">annotate</a> |
<a href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/accountConfig.js">diff</a> |
<a href="/comm-central/comparison/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/accountConfig.js">comparison</a> |
<a href="/comm-central/log/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/accountConfig.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/createInBackend.js">mail/components/accountcreation/content/createInBackend.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/createInBackend.js">file</a> |
<a href="/comm-central/annotate/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/createInBackend.js">annotate</a> |
<a href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/createInBackend.js">diff</a> |
<a href="/comm-central/comparison/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/createInBackend.js">comparison</a> |
<a href="/comm-central/log/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/createInBackend.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/emailWizard.js">mail/components/accountcreation/content/emailWizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/emailWizard.js">file</a> |
<a href="/comm-central/annotate/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/emailWizard.js">annotate</a> |
<a href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/emailWizard.js">diff</a> |
<a href="/comm-central/comparison/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/emailWizard.js">comparison</a> |
<a href="/comm-central/log/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/emailWizard.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/emailWizard.xul">mail/components/accountcreation/content/emailWizard.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/emailWizard.xul">file</a> |
<a href="/comm-central/annotate/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/emailWizard.xul">annotate</a> |
<a href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/emailWizard.xul">diff</a> |
<a href="/comm-central/comparison/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/emailWizard.xul">comparison</a> |
<a href="/comm-central/log/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/emailWizard.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/exchangeAutoDiscover.js">mail/components/accountcreation/content/exchangeAutoDiscover.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/exchangeAutoDiscover.js">file</a> |
<a href="/comm-central/annotate/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/exchangeAutoDiscover.js">annotate</a> |
<a href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/exchangeAutoDiscover.js">diff</a> |
<a href="/comm-central/comparison/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/exchangeAutoDiscover.js">comparison</a> |
<a href="/comm-central/log/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/exchangeAutoDiscover.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/fetchConfig.js">mail/components/accountcreation/content/fetchConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/fetchConfig.js">file</a> |
<a href="/comm-central/annotate/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/fetchConfig.js">annotate</a> |
<a href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/fetchConfig.js">diff</a> |
<a href="/comm-central/comparison/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/fetchConfig.js">comparison</a> |
<a href="/comm-central/log/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/fetchConfig.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/fetchhttp.js">mail/components/accountcreation/content/fetchhttp.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/fetchhttp.js">file</a> |
<a href="/comm-central/annotate/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/fetchhttp.js">annotate</a> |
<a href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/fetchhttp.js">diff</a> |
<a href="/comm-central/comparison/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/fetchhttp.js">comparison</a> |
<a href="/comm-central/log/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/fetchhttp.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/guessConfig.js">mail/components/accountcreation/content/guessConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/guessConfig.js">file</a> |
<a href="/comm-central/annotate/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/guessConfig.js">annotate</a> |
<a href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/guessConfig.js">diff</a> |
<a href="/comm-central/comparison/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/guessConfig.js">comparison</a> |
<a href="/comm-central/log/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/guessConfig.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/readFromXML.js">mail/components/accountcreation/content/readFromXML.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/readFromXML.js">file</a> |
<a href="/comm-central/annotate/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/readFromXML.js">annotate</a> |
<a href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/readFromXML.js">diff</a> |
<a href="/comm-central/comparison/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/readFromXML.js">comparison</a> |
<a href="/comm-central/log/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/readFromXML.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/util.js">mail/components/accountcreation/content/util.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/util.js">file</a> |
<a href="/comm-central/annotate/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/util.js">annotate</a> |
<a href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/util.js">diff</a> |
<a href="/comm-central/comparison/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/util.js">comparison</a> |
<a href="/comm-central/log/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/util.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/verifyConfig.js">mail/components/accountcreation/content/verifyConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/verifyConfig.js">file</a> |
<a href="/comm-central/annotate/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/verifyConfig.js">annotate</a> |
<a href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/verifyConfig.js">diff</a> |
<a href="/comm-central/comparison/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/verifyConfig.js">comparison</a> |
<a href="/comm-central/log/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/content/verifyConfig.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/jar.mn">mail/components/accountcreation/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/jar.mn">file</a> |
<a href="/comm-central/annotate/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/jar.mn">annotate</a> |
<a href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/jar.mn">diff</a> |
<a href="/comm-central/comparison/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/jar.mn">comparison</a> |
<a href="/comm-central/log/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/components/accountcreation/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/locales/en-US/chrome/messenger/accountCreation.dtd">mail/locales/en-US/chrome/messenger/accountCreation.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/locales/en-US/chrome/messenger/accountCreation.dtd">file</a> |
<a href="/comm-central/annotate/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/locales/en-US/chrome/messenger/accountCreation.dtd">annotate</a> |
<a href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/locales/en-US/chrome/messenger/accountCreation.dtd">diff</a> |
<a href="/comm-central/comparison/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/locales/en-US/chrome/messenger/accountCreation.dtd">comparison</a> |
<a href="/comm-central/log/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/locales/en-US/chrome/messenger/accountCreation.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/locales/en-US/chrome/messenger/accountCreation.properties">mail/locales/en-US/chrome/messenger/accountCreation.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/locales/en-US/chrome/messenger/accountCreation.properties">file</a> |
<a href="/comm-central/annotate/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/locales/en-US/chrome/messenger/accountCreation.properties">annotate</a> |
<a href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/locales/en-US/chrome/messenger/accountCreation.properties">diff</a> |
<a href="/comm-central/comparison/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/locales/en-US/chrome/messenger/accountCreation.properties">comparison</a> |
<a href="/comm-central/log/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/locales/en-US/chrome/messenger/accountCreation.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/locales/en-US/chrome/messenger/accountCreationModel.properties">mail/locales/en-US/chrome/messenger/accountCreationModel.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/locales/en-US/chrome/messenger/accountCreationModel.properties">file</a> |
<a href="/comm-central/annotate/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/locales/en-US/chrome/messenger/accountCreationModel.properties">annotate</a> |
<a href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/locales/en-US/chrome/messenger/accountCreationModel.properties">diff</a> |
<a href="/comm-central/comparison/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/locales/en-US/chrome/messenger/accountCreationModel.properties">comparison</a> |
<a href="/comm-central/log/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/locales/en-US/chrome/messenger/accountCreationModel.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/themes/linux/mail/accountCreation.css">mail/themes/linux/mail/accountCreation.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/themes/linux/mail/accountCreation.css">file</a> |
<a href="/comm-central/annotate/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/themes/linux/mail/accountCreation.css">annotate</a> |
<a href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/themes/linux/mail/accountCreation.css">diff</a> |
<a href="/comm-central/comparison/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/themes/linux/mail/accountCreation.css">comparison</a> |
<a href="/comm-central/log/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/themes/linux/mail/accountCreation.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/themes/osx/mail/accountCreation.css">mail/themes/osx/mail/accountCreation.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/themes/osx/mail/accountCreation.css">file</a> |
<a href="/comm-central/annotate/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/themes/osx/mail/accountCreation.css">annotate</a> |
<a href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/themes/osx/mail/accountCreation.css">diff</a> |
<a href="/comm-central/comparison/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/themes/osx/mail/accountCreation.css">comparison</a> |
<a href="/comm-central/log/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/themes/osx/mail/accountCreation.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/themes/shared/jar.inc.mn">mail/themes/shared/jar.inc.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/themes/shared/jar.inc.mn">file</a> |
<a href="/comm-central/annotate/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/themes/shared/jar.inc.mn">annotate</a> |
<a href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/themes/shared/jar.inc.mn">diff</a> |
<a href="/comm-central/comparison/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/themes/shared/jar.inc.mn">comparison</a> |
<a href="/comm-central/log/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/themes/shared/jar.inc.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/themes/shared/mail/accountCreation.css">mail/themes/shared/mail/accountCreation.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/themes/shared/mail/accountCreation.css">file</a> |
<a href="/comm-central/annotate/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/themes/shared/mail/accountCreation.css">annotate</a> |
<a href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/themes/shared/mail/accountCreation.css">diff</a> |
<a href="/comm-central/comparison/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/themes/shared/mail/accountCreation.css">comparison</a> |
<a href="/comm-central/log/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/themes/shared/mail/accountCreation.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/themes/windows/mail/accountCreation.css">mail/themes/windows/mail/accountCreation.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/themes/windows/mail/accountCreation.css">file</a> |
<a href="/comm-central/annotate/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/themes/windows/mail/accountCreation.css">annotate</a> |
<a href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/themes/windows/mail/accountCreation.css">diff</a> |
<a href="/comm-central/comparison/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/themes/windows/mail/accountCreation.css">comparison</a> |
<a href="/comm-central/log/1403c0fa3d1ac8b10ec74adb92b245575059298f/mail/themes/windows/mail/accountCreation.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mailnews/mailnews.js">mailnews/mailnews.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1403c0fa3d1ac8b10ec74adb92b245575059298f/mailnews/mailnews.js">file</a> |
<a href="/comm-central/annotate/1403c0fa3d1ac8b10ec74adb92b245575059298f/mailnews/mailnews.js">annotate</a> |
<a href="/comm-central/diff/1403c0fa3d1ac8b10ec74adb92b245575059298f/mailnews/mailnews.js">diff</a> |
<a href="/comm-central/comparison/1403c0fa3d1ac8b10ec74adb92b245575059298f/mailnews/mailnews.js">comparison</a> |
<a href="/comm-central/log/1403c0fa3d1ac8b10ec74adb92b245575059298f/mailnews/mailnews.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/accountcreation/content/.eslintrc.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/accountcreation/content/.eslintrc.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,22 +1,24 @@</span>
<a href="#l1.4"></a><span id="l1.4"> &quot;use strict&quot;;</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> module.exports = {</span>
<a href="#l1.7"></a><span id="l1.7">   &quot;globals&quot;: {</span>
<a href="#l1.8"></a><span id="l1.8">     &quot;Abortable&quot;: true,</span>
<a href="#l1.9"></a><span id="l1.9">     &quot;AccountConfig&quot;: true,</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineplus">+    &quot;AddonInstaller&quot;: true,</span>
<a href="#l1.11"></a><span id="l1.11">     &quot;BadCertHandler&quot;: true,</span>
<a href="#l1.12"></a><span id="l1.12">     &quot;CancelledException&quot;: true,</span>
<a href="#l1.13"></a><span id="l1.13">     &quot;Exception&quot;: true,</span>
<a href="#l1.14"></a><span id="l1.14">     &quot;FetchHTTP&quot;: true,</span>
<a href="#l1.15"></a><span id="l1.15">     &quot;Log4Moz&quot;: true,</span>
<a href="#l1.16"></a><span id="l1.16">     &quot;MailServices&quot;: true,</span>
<a href="#l1.17"></a><span id="l1.17">     &quot;NewMailAccountProvisioner&quot;: true,</span>
<a href="#l1.18"></a><span id="l1.18">     &quot;NotReached&quot;: true,</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+    &quot;PriorityOrderAbortable&quot;: true,</span>
<a href="#l1.20"></a><span id="l1.20">     &quot;Services&quot;: true,</span>
<a href="#l1.21"></a><span id="l1.21">     &quot;SuccessiveAbortable&quot;: true,</span>
<a href="#l1.22"></a><span id="l1.22">     &quot;TimeoutAbortable&quot;: true,</span>
<a href="#l1.23"></a><span id="l1.23">     &quot;UserCancelledException&quot;: true,</span>
<a href="#l1.24"></a><span id="l1.24">     &quot;alertPrompt&quot;: true,</span>
<a href="#l1.25"></a><span id="l1.25">     &quot;assert&quot;: true,</span>
<a href="#l1.26"></a><span id="l1.26">     &quot;checkIncomingServerAlreadyExists&quot;: true,</span>
<a href="#l1.27"></a><span id="l1.27">     &quot;checkOutgoingServerAlreadyExists&quot;: true,</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineat">@@ -24,16 +26,17 @@ module.exports = {</span>
<a href="#l1.29"></a><span id="l1.29">     &quot;createAccountInBackend&quot;: true,</span>
<a href="#l1.30"></a><span id="l1.30">     &quot;ddump&quot;: true,</span>
<a href="#l1.31"></a><span id="l1.31">     &quot;debugObject&quot;: true,</span>
<a href="#l1.32"></a><span id="l1.32">     &quot;deepCopy&quot;: true,</span>
<a href="#l1.33"></a><span id="l1.33">     &quot;errorWithDebug&quot;: true,</span>
<a href="#l1.34"></a><span id="l1.34">     &quot;fetchConfigForMX&quot;: true,</span>
<a href="#l1.35"></a><span id="l1.35">     &quot;fetchConfigFromDB&quot;: true,</span>
<a href="#l1.36"></a><span id="l1.36">     &quot;fetchConfigFromDisk&quot;: true,</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+    &quot;fetchConfigFromExchange&quot;: true,</span>
<a href="#l1.38"></a><span id="l1.38">     &quot;fetchConfigFromISP&quot;: true,</span>
<a href="#l1.39"></a><span id="l1.39">     &quot;getStringBundle&quot;: true,</span>
<a href="#l1.40"></a><span id="l1.40">     &quot;guessConfig&quot;: true,</span>
<a href="#l1.41"></a><span id="l1.41">     &quot;isLegalHostName&quot;: true,</span>
<a href="#l1.42"></a><span id="l1.42">     &quot;isLegalHostNameOrIP&quot;: true,</span>
<a href="#l1.43"></a><span id="l1.43">     &quot;isLegalIPAddress&quot;: true,</span>
<a href="#l1.44"></a><span id="l1.44">     &quot;isLegalIPv4Address&quot;: true,</span>
<a href="#l1.45"></a><span id="l1.45">     &quot;isLegalIPv6Address&quot;: true,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/accountcreation/content/accountConfig.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/accountcreation/content/accountConfig.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -63,17 +63,17 @@ AccountConfig.prototype =</span>
<a href="#l2.4"></a><span id="l2.4">   // { Array of Strings }</span>
<a href="#l2.5"></a><span id="l2.5">   domains: null,</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7">   /**</span>
<a href="#l2.8"></a><span id="l2.8">    * Factory function for incoming and incomingAlternatives</span>
<a href="#l2.9"></a><span id="l2.9">    */</span>
<a href="#l2.10"></a><span id="l2.10">   createNewIncoming() {</span>
<a href="#l2.11"></a><span id="l2.11">     return {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-      // { String-enum: &quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot; }</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+      // { String-enum: &quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;, &quot;exchange&quot; }</span>
<a href="#l2.14"></a><span id="l2.14">       type: null,</span>
<a href="#l2.15"></a><span id="l2.15">       hostname: null,</span>
<a href="#l2.16"></a><span id="l2.16">       // { Integer }</span>
<a href="#l2.17"></a><span id="l2.17">       port: null,</span>
<a href="#l2.18"></a><span id="l2.18">       // May be a placeholder (starts and ends with %). { String }</span>
<a href="#l2.19"></a><span id="l2.19">       username: null,</span>
<a href="#l2.20"></a><span id="l2.20">       password: null,</span>
<a href="#l2.21"></a><span id="l2.21">       // { enum: 1 = plain, 2 = SSL/TLS, 3 = STARTTLS always, 0 = not inited }</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -107,16 +107,21 @@ AccountConfig.prototype =</span>
<a href="#l2.23"></a><span id="l2.23">       // Not yet implemented. { Boolean }</span>
<a href="#l2.24"></a><span id="l2.24">       useGlobalInbox: false,</span>
<a href="#l2.25"></a><span id="l2.25">       leaveMessagesOnServer: true,</span>
<a href="#l2.26"></a><span id="l2.26">       daysToLeaveMessagesOnServer: 14,</span>
<a href="#l2.27"></a><span id="l2.27">       deleteByAgeFromServer: true,</span>
<a href="#l2.28"></a><span id="l2.28">       // When user hits delete, delete from local store and from server</span>
<a href="#l2.29"></a><span id="l2.29">       deleteOnServerWhenLocalDelete: true,</span>
<a href="#l2.30"></a><span id="l2.30">       downloadOnBiff: true,</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+      // for Microsoft Exchange servers. Optional.</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+      owaURL: null,</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+      ewsURL: null,</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+      easURL: null,</span>
<a href="#l2.36"></a><span id="l2.36">     };</span>
<a href="#l2.37"></a><span id="l2.37">   },</span>
<a href="#l2.38"></a><span id="l2.38">   /**</span>
<a href="#l2.39"></a><span id="l2.39">    * Factory function for outgoing and outgoingAlternatives</span>
<a href="#l2.40"></a><span id="l2.40">    */</span>
<a href="#l2.41"></a><span id="l2.41">   createNewOutgoing() {</span>
<a href="#l2.42"></a><span id="l2.42">     return {</span>
<a href="#l2.43"></a><span id="l2.43">       type: &quot;smtp&quot;,</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineat">@@ -135,45 +140,95 @@ AccountConfig.prototype =</span>
<a href="#l2.45"></a><span id="l2.45">       // nsISmtpServer.key</span>
<a href="#l2.46"></a><span id="l2.46">       existingServerKey: null,</span>
<a href="#l2.47"></a><span id="l2.47">       // user display value for existingServerKey</span>
<a href="#l2.48"></a><span id="l2.48">       existingServerLabel: null,</span>
<a href="#l2.49"></a><span id="l2.49">     };</span>
<a href="#l2.50"></a><span id="l2.50">   },</span>
<a href="#l2.51"></a><span id="l2.51"> </span>
<a href="#l2.52"></a><span id="l2.52">   /**</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+   * The configuration needs an addon to handle the account type.</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+   * The addon needs to be installed before the account can be created</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+   * in the backend.</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+   * You can choose one, if there are several addons in the list.</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+   * (Optional)</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+   *</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+   * Array of:</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+   * {</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+   *   id: &quot;owl@example.com&quot; {string},</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+   *</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+   *   // already localized string</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+   *   name: &quot;Owl&quot; {string},</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+   *</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+   *   // already localized string</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+   *   description: &quot;A third party addon that allows you to connect to Exchange servers&quot; {string}</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+   *</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+   *   // Minimal version of the addon. Needed in case the addon is already installed,</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+   *   // to verify that the installed version is sufficient.</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+   *   // The XPI URL below must satisfy this.</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+   *   // Must satisfy &lt;https://developer.mozilla.org/en-US/docs/Mozilla/Toolkit_version_format&gt;</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+   *   minVersion: &quot;0.2&quot; {string}</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+   *</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+   *   xpiURL: &quot;https://live.thunderbird.net/autoconfig/owl.xpi&quot; {URL},</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+   *   websiteURL: &quot;https://www.beonex.com/owl/&quot; {URL},</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+   *   icon32: &quot;https://www.beonex.com/owl/owl-32x32.png&quot; {URL},</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+   *</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+   *   useType : {</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+   *     // Type shown as radio button to user in the config result.</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+   *     // Users won't understand OWA vs. EWS vs. EAS etc., so this is an abstraction</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+   *     // from the end user perspective.</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+   *     generalType: &quot;exchange&quot; {string},</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+   *</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+   *     // Protocol</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+   *     // Independent of the addon</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+   *     protocolType: &quot;owa&quot; {string},</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+   *</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+   *     // Account type in the Thunderbird backend.</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+   *     // What nsIMsgAccount.type will be set to when creating the account.</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+   *     // This is specific to the addon.</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+   *     addonAccountType: &quot;owl-owa&quot; {string},</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+   *   }</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+   * }</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+   */</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+  addons: null,</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+  /**</span>
<a href="#l2.99"></a><span id="l2.99">    * Returns a deep copy of this object,</span>
<a href="#l2.100"></a><span id="l2.100">    * i.e. modifying the copy will not affect the original object.</span>
<a href="#l2.101"></a><span id="l2.101">    */</span>
<a href="#l2.102"></a><span id="l2.102">   copy() {</span>
<a href="#l2.103"></a><span id="l2.103">     // Workaround: deepCopy() fails to preserve base obj (instanceof)</span>
<a href="#l2.104"></a><span id="l2.104">     var result = new AccountConfig();</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-    for (var prop in this)</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+    for (let prop in this) {</span>
<a href="#l2.107"></a><span id="l2.107">       result[prop] = deepCopy(this[prop]);</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+    }</span>
<a href="#l2.109"></a><span id="l2.109"> </span>
<a href="#l2.110"></a><span id="l2.110">     return result;</span>
<a href="#l2.111"></a><span id="l2.111">   },</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+</span>
<a href="#l2.113"></a><span id="l2.113">   isComplete() {</span>
<a href="#l2.114"></a><span id="l2.114">     return (!!this.incoming.hostname &amp;&amp; !!this.incoming.port &amp;&amp;</span>
<a href="#l2.115"></a><span id="l2.115">          !!this.incoming.socketType &amp;&amp; !!this.incoming.auth &amp;&amp;</span>
<a href="#l2.116"></a><span id="l2.116">          !!this.incoming.username &amp;&amp;</span>
<a href="#l2.117"></a><span id="l2.117">          (!!this.outgoing.existingServerKey ||</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+          this.outgoing.useGlobalPreferredServer ||</span>
<a href="#l2.119"></a><span id="l2.119">           (!!this.outgoing.hostname &amp;&amp; !!this.outgoing.port &amp;&amp;</span>
<a href="#l2.120"></a><span id="l2.120">            !!this.outgoing.socketType &amp;&amp; !!this.outgoing.auth &amp;&amp;</span>
<a href="#l2.121"></a><span id="l2.121">            !!this.outgoing.username)));</span>
<a href="#l2.122"></a><span id="l2.122">   },</span>
<a href="#l2.123"></a><span id="l2.123"> };</span>
<a href="#l2.124"></a><span id="l2.124"> </span>
<a href="#l2.125"></a><span id="l2.125"> </span>
<a href="#l2.126"></a><span id="l2.126"> // enum consts</span>
<a href="#l2.127"></a><span id="l2.127"> </span>
<a href="#l2.128"></a><span id="l2.128"> // .source</span>
<a href="#l2.129"></a><span id="l2.129"> AccountConfig.kSourceUser = 1; // user manually entered the config</span>
<a href="#l2.130"></a><span id="l2.130"> AccountConfig.kSourceXML = 2; // config from XML from ISP or Mozilla DB</span>
<a href="#l2.131"></a><span id="l2.131"> AccountConfig.kSourceGuess = 3; // guessConfig()</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineplus">+AccountConfig.kSourceExchange = 4; // from Microsoft Exchange AutoDiscover</span>
<a href="#l2.133"></a><span id="l2.133"> </span>
<a href="#l2.134"></a><span id="l2.134"> </span>
<a href="#l2.135"></a><span id="l2.135"> /**</span>
<a href="#l2.136"></a><span id="l2.136">  * Some fields on the account config accept placeholders (when coming from XML).</span>
<a href="#l2.137"></a><span id="l2.137">  *</span>
<a href="#l2.138"></a><span id="l2.138">  * These are the predefined ones</span>
<a href="#l2.139"></a><span id="l2.139">  * * %EMAILADDRESS% (full email address of the user, usually entered by user)</span>
<a href="#l2.140"></a><span id="l2.140">  * * %EMAILLOCALPART% (email address, part before @)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/accountcreation/content/createInBackend.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/accountcreation/content/createInBackend.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,32 +1,31 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l3.5"></a><span id="l3.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.6"></a><span id="l3.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.7"></a><span id="l3.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+/* eslint-disable complexity */</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+</span>
<a href="#l3.14"></a><span id="l3.14"> /**</span>
<a href="#l3.15"></a><span id="l3.15">  * Takes an |AccountConfig| JS object and creates that account in the</span>
<a href="#l3.16"></a><span id="l3.16">  * Thunderbird backend (which also writes it to prefs).</span>
<a href="#l3.17"></a><span id="l3.17">  *</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">- * @param config {AccountConfig} The account to create</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">- *</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">- * @return - the account created.</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+ * @param {AccountConfig} config - The account to create</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+ * @return {nsIMsgAccount} - the newly created account</span>
<a href="#l3.23"></a><span id="l3.23">  */</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-/* eslint-disable complexity */</span>
<a href="#l3.29"></a><span id="l3.29"> function createAccountInBackend(config) {</span>
<a href="#l3.30"></a><span id="l3.30">   // incoming server</span>
<a href="#l3.31"></a><span id="l3.31">   let inServer = MailServices.accounts.createIncomingServer(</span>
<a href="#l3.32"></a><span id="l3.32">       config.incoming.username,</span>
<a href="#l3.33"></a><span id="l3.33">       config.incoming.hostname,</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-      sanitize.enum(config.incoming.type, [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]));</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+      config.incoming.type);</span>
<a href="#l3.36"></a><span id="l3.36">   inServer.port = config.incoming.port;</span>
<a href="#l3.37"></a><span id="l3.37">   inServer.authMethod = config.incoming.auth;</span>
<a href="#l3.38"></a><span id="l3.38">   inServer.password = config.incoming.password;</span>
<a href="#l3.39"></a><span id="l3.39">   if (config.rememberPassword &amp;&amp; config.incoming.password.length)</span>
<a href="#l3.40"></a><span id="l3.40">     rememberPassword(inServer, config.incoming.password);</span>
<a href="#l3.41"></a><span id="l3.41"> </span>
<a href="#l3.42"></a><span id="l3.42">   if (inServer.authMethod == Ci.nsMsgAuthMethod.OAuth2) {</span>
<a href="#l3.43"></a><span id="l3.43">     inServer.setCharValue(&quot;oauth2.scope&quot;, config.oauthSettings.scope);</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineat">@@ -249,25 +248,25 @@ function rememberPassword(server, passwo</span>
<a href="#l3.45"></a><span id="l3.45">  *     object is returned.</span>
<a href="#l3.46"></a><span id="l3.46">  *     If it's a new server, |null| is returned.</span>
<a href="#l3.47"></a><span id="l3.47">  */</span>
<a href="#l3.48"></a><span id="l3.48"> function checkIncomingServerAlreadyExists(config) {</span>
<a href="#l3.49"></a><span id="l3.49">   assert(config instanceof AccountConfig);</span>
<a href="#l3.50"></a><span id="l3.50">   let incoming = config.incoming;</span>
<a href="#l3.51"></a><span id="l3.51">   let existing = MailServices.accounts.findRealServer(incoming.username,</span>
<a href="#l3.52"></a><span id="l3.52">         incoming.hostname,</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-        sanitize.enum(incoming.type, [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]),</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+        incoming.type,</span>
<a href="#l3.55"></a><span id="l3.55">         incoming.port);</span>
<a href="#l3.56"></a><span id="l3.56"> </span>
<a href="#l3.57"></a><span id="l3.57">   // if username does not have an '@', also check the e-mail</span>
<a href="#l3.58"></a><span id="l3.58">   // address form of the name.</span>
<a href="#l3.59"></a><span id="l3.59">   if (!existing &amp;&amp; !incoming.username.includes(&quot;@&quot;))</span>
<a href="#l3.60"></a><span id="l3.60">     existing = MailServices.accounts.findRealServer(config.identity.emailAddress,</span>
<a href="#l3.61"></a><span id="l3.61">           incoming.hostname,</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-          sanitize.enum(incoming.type, [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]),</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+          incoming.type,</span>
<a href="#l3.64"></a><span id="l3.64">           incoming.port);</span>
<a href="#l3.65"></a><span id="l3.65">   return existing;</span>
<a href="#l3.66"></a><span id="l3.66"> }</span>
<a href="#l3.67"></a><span id="l3.67"> </span>
<a href="#l3.68"></a><span id="l3.68"> /**</span>
<a href="#l3.69"></a><span id="l3.69">  * Check whether the user's setup already has an outgoing server</span>
<a href="#l3.70"></a><span id="l3.70">  * which matches (hostname, port, username) the primary one</span>
<a href="#l3.71"></a><span id="l3.71">  * in the config.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/accountcreation/content/emailWizard.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/accountcreation/content/emailWizard.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -31,17 +31,20 @@ ChromeUtils.import(&quot;resource:///modules/</span>
<a href="#l4.4"></a><span id="l4.4">  * - If user clicks OK, create the account</span>
<a href="#l4.5"></a><span id="l4.5">  */</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7"> // from http://xyfer.blogspot.com/2005/01/javascript-regexp-email-validator.html</span>
<a href="#l4.8"></a><span id="l4.8"> var emailRE = /^[-_a-z0-9\'+*$^&amp;%=~!?{}]+(?:\.[-_a-z0-9\'+*$^&amp;%=~!?{}]+)*@(?:[-a-z0-9.]+\.[a-z]{2,20}|\d{1,3}(?:\.\d{1,3}){3})(?::\d+)?$/i;</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> if (typeof gEmailWizardLogger == &quot;undefined&quot;) {</span>
<a href="#l4.11"></a><span id="l4.11">   ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  var gEmailWizardLogger = Log4Moz.getConfiguredLogger(&quot;mail.wizard&quot;);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  var gEmailWizardLogger = Log4Moz.getConfiguredLogger(&quot;mail.setup&quot;);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+  gEmailWizardLogger.level = Log4Moz.Level.Info;</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+  gEmailWizardLogger.addAppender(new Log4Moz.ConsoleAppender(new Log4Moz.BasicFormatter())); // browser console</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+  gEmailWizardLogger.addAppender(new Log4Moz.DumpAppender(new Log4Moz.BasicFormatter())); // stdout</span>
<a href="#l4.17"></a><span id="l4.17"> }</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19"> var gStringsBundle;</span>
<a href="#l4.20"></a><span id="l4.20"> var gMessengerBundle;</span>
<a href="#l4.21"></a><span id="l4.21"> var gBrandShortName;</span>
<a href="#l4.22"></a><span id="l4.22"> </span>
<a href="#l4.23"></a><span id="l4.23"> /**</span>
<a href="#l4.24"></a><span id="l4.24"> TODO for bug 549045:</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineat">@@ -108,16 +111,22 @@ function setText(id, value) {</span>
<a href="#l4.26"></a><span id="l4.26">     throw new NotReached(&quot;XUL element type not supported&quot;);</span>
<a href="#l4.27"></a><span id="l4.27">   }</span>
<a href="#l4.28"></a><span id="l4.28"> }</span>
<a href="#l4.29"></a><span id="l4.29"> </span>
<a href="#l4.30"></a><span id="l4.30"> function setLabelFromStringBundle(elementID, stringName) {</span>
<a href="#l4.31"></a><span id="l4.31">   e(elementID).label = gMessengerBundle.getString(stringName);</span>
<a href="#l4.32"></a><span id="l4.32"> }</span>
<a href="#l4.33"></a><span id="l4.33"> </span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+function removeChildNodes(el) {</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+  while (el.hasChildNodes()) {</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+    el.lastChild.remove();</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+  }</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+}</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+</span>
<a href="#l4.40"></a><span id="l4.40"> function EmailConfigWizard() {</span>
<a href="#l4.41"></a><span id="l4.41">   this._init();</span>
<a href="#l4.42"></a><span id="l4.42"> }</span>
<a href="#l4.43"></a><span id="l4.43"> EmailConfigWizard.prototype =</span>
<a href="#l4.44"></a><span id="l4.44"> {</span>
<a href="#l4.45"></a><span id="l4.45">   _init() {</span>
<a href="#l4.46"></a><span id="l4.46">     gEmailWizardLogger.info(&quot;Initializing setup wizard&quot;);</span>
<a href="#l4.47"></a><span id="l4.47">     this._abortable = null;</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineat">@@ -285,41 +294,44 @@ EmailConfigWizard.prototype =</span>
<a href="#l4.49"></a><span id="l4.49"> </span>
<a href="#l4.50"></a><span id="l4.50">       _show(&quot;next_button&quot;);</span>
<a href="#l4.51"></a><span id="l4.51">       _disable(&quot;next_button&quot;);</span>
<a href="#l4.52"></a><span id="l4.52">       _hide(&quot;half-manual-test_button&quot;);</span>
<a href="#l4.53"></a><span id="l4.53">       _hide(&quot;create_button&quot;);</span>
<a href="#l4.54"></a><span id="l4.54">       _show(&quot;stop_button&quot;);</span>
<a href="#l4.55"></a><span id="l4.55">       this.onStop = this.onStopFindConfig;</span>
<a href="#l4.56"></a><span id="l4.56">       _show(&quot;manual-edit_button&quot;);</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+      _hide(&quot;provisioner_button&quot;);</span>
<a href="#l4.58"></a><span id="l4.58">       _hide(&quot;advanced-setup_button&quot;);</span>
<a href="#l4.59"></a><span id="l4.59">     } else if (modename == &quot;result&quot;) {</span>
<a href="#l4.60"></a><span id="l4.60">       _show(&quot;status_area&quot;);</span>
<a href="#l4.61"></a><span id="l4.61">       _show(&quot;result_area&quot;);</span>
<a href="#l4.62"></a><span id="l4.62">       _hide(&quot;manual-edit_area&quot;);</span>
<a href="#l4.63"></a><span id="l4.63"> </span>
<a href="#l4.64"></a><span id="l4.64">       _hide(&quot;next_button&quot;);</span>
<a href="#l4.65"></a><span id="l4.65">       _hide(&quot;half-manual-test_button&quot;);</span>
<a href="#l4.66"></a><span id="l4.66">       _show(&quot;create_button&quot;);</span>
<a href="#l4.67"></a><span id="l4.67">       _enable(&quot;create_button&quot;);</span>
<a href="#l4.68"></a><span id="l4.68">       _hide(&quot;stop_button&quot;);</span>
<a href="#l4.69"></a><span id="l4.69">       _show(&quot;manual-edit_button&quot;);</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+      _hide(&quot;provisioner_button&quot;);</span>
<a href="#l4.71"></a><span id="l4.71">       _hide(&quot;advanced-setup_button&quot;);</span>
<a href="#l4.72"></a><span id="l4.72">     } else if (modename == &quot;manual-edit&quot;) {</span>
<a href="#l4.73"></a><span id="l4.73">       _show(&quot;status_area&quot;);</span>
<a href="#l4.74"></a><span id="l4.74">       _hide(&quot;result_area&quot;);</span>
<a href="#l4.75"></a><span id="l4.75">       _show(&quot;manual-edit_area&quot;);</span>
<a href="#l4.76"></a><span id="l4.76"> </span>
<a href="#l4.77"></a><span id="l4.77">       _hide(&quot;next_button&quot;);</span>
<a href="#l4.78"></a><span id="l4.78">       _show(&quot;half-manual-test_button&quot;);</span>
<a href="#l4.79"></a><span id="l4.79">       _disable(&quot;half-manual-test_button&quot;);</span>
<a href="#l4.80"></a><span id="l4.80">       _show(&quot;create_button&quot;);</span>
<a href="#l4.81"></a><span id="l4.81">       _disable(&quot;create_button&quot;);</span>
<a href="#l4.82"></a><span id="l4.82">       _hide(&quot;stop_button&quot;);</span>
<a href="#l4.83"></a><span id="l4.83">       _hide(&quot;manual-edit_button&quot;);</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+      _hide(&quot;provisioner_button&quot;);</span>
<a href="#l4.85"></a><span id="l4.85">       _show(&quot;advanced-setup_button&quot;);</span>
<a href="#l4.86"></a><span id="l4.86">       _disable(&quot;advanced-setup_button&quot;);</span>
<a href="#l4.87"></a><span id="l4.87">     } else if (modename == &quot;manual-edit-have-hostname&quot;) {</span>
<a href="#l4.88"></a><span id="l4.88">       _show(&quot;status_area&quot;);</span>
<a href="#l4.89"></a><span id="l4.89">       _hide(&quot;result_area&quot;);</span>
<a href="#l4.90"></a><span id="l4.90">       _show(&quot;manual-edit_area&quot;);</span>
<a href="#l4.91"></a><span id="l4.91">       _hide(&quot;manual-edit_button&quot;);</span>
<a href="#l4.92"></a><span id="l4.92">       _hide(&quot;next_button&quot;);</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineat">@@ -339,45 +351,48 @@ EmailConfigWizard.prototype =</span>
<a href="#l4.94"></a><span id="l4.94">       _hide(&quot;next_button&quot;);</span>
<a href="#l4.95"></a><span id="l4.95">       _show(&quot;create_button&quot;);</span>
<a href="#l4.96"></a><span id="l4.96"> </span>
<a href="#l4.97"></a><span id="l4.97">       _show(&quot;half-manual-test_button&quot;);</span>
<a href="#l4.98"></a><span id="l4.98">       _disable(&quot;half-manual-test_button&quot;);</span>
<a href="#l4.99"></a><span id="l4.99">       _disable(&quot;create_button&quot;);</span>
<a href="#l4.100"></a><span id="l4.100">       _show(&quot;stop_button&quot;);</span>
<a href="#l4.101"></a><span id="l4.101">       this.onStop = this.onStopHalfManualTesting;</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+      _hide(&quot;provisioner_button&quot;);</span>
<a href="#l4.103"></a><span id="l4.103">       _show(&quot;advanced-setup_button&quot;);</span>
<a href="#l4.104"></a><span id="l4.104">       _disable(&quot;advanced-setup_button&quot;);</span>
<a href="#l4.105"></a><span id="l4.105">     } else if (modename == &quot;manual-edit-complete&quot;) {</span>
<a href="#l4.106"></a><span id="l4.106">       _show(&quot;status_area&quot;);</span>
<a href="#l4.107"></a><span id="l4.107">       _hide(&quot;result_area&quot;);</span>
<a href="#l4.108"></a><span id="l4.108">       _show(&quot;manual-edit_area&quot;);</span>
<a href="#l4.109"></a><span id="l4.109">       _hide(&quot;manual-edit_button&quot;);</span>
<a href="#l4.110"></a><span id="l4.110">       _hide(&quot;next_button&quot;);</span>
<a href="#l4.111"></a><span id="l4.111">       _show(&quot;create_button&quot;);</span>
<a href="#l4.112"></a><span id="l4.112"> </span>
<a href="#l4.113"></a><span id="l4.113">       _show(&quot;half-manual-test_button&quot;);</span>
<a href="#l4.114"></a><span id="l4.114">       _enable(&quot;half-manual-test_button&quot;);</span>
<a href="#l4.115"></a><span id="l4.115">       _enable(&quot;create_button&quot;);</span>
<a href="#l4.116"></a><span id="l4.116">       _hide(&quot;stop_button&quot;);</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+      _hide(&quot;provisioner_button&quot;);</span>
<a href="#l4.118"></a><span id="l4.118">       _show(&quot;advanced-setup_button&quot;);</span>
<a href="#l4.119"></a><span id="l4.119">       _enable(&quot;advanced-setup_button&quot;);</span>
<a href="#l4.120"></a><span id="l4.120">     } else {</span>
<a href="#l4.121"></a><span id="l4.121">       throw new NotReached(&quot;unknown mode&quot;);</span>
<a href="#l4.122"></a><span id="l4.122">     }</span>
<a href="#l4.123"></a><span id="l4.123">     // If we're offline, we're going to disable the create button, but enable</span>
<a href="#l4.124"></a><span id="l4.124">     // the advanced config button if we have a current config.</span>
<a href="#l4.125"></a><span id="l4.125">     if (Services.io.offline) {</span>
<a href="#l4.126"></a><span id="l4.126">       if (this._currentConfig != null) {</span>
<a href="#l4.127"></a><span id="l4.127">         _show(&quot;advanced-setup_button&quot;);</span>
<a href="#l4.128"></a><span id="l4.128">         _enable(&quot;advanced-setup_button&quot;);</span>
<a href="#l4.129"></a><span id="l4.129">         _hide(&quot;half-manual-test_button&quot;);</span>
<a href="#l4.130"></a><span id="l4.130">         _hide(&quot;create_button&quot;);</span>
<a href="#l4.131"></a><span id="l4.131">         _hide(&quot;manual-edit_button&quot;);</span>
<a href="#l4.132"></a><span id="l4.132">       }</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+      _hide(&quot;provisioner_button&quot;);</span>
<a href="#l4.134"></a><span id="l4.134">     }</span>
<a href="#l4.135"></a><span id="l4.135">     window.sizeToContent();</span>
<a href="#l4.136"></a><span id="l4.136">   },</span>
<a href="#l4.137"></a><span id="l4.137"> </span>
<a href="#l4.138"></a><span id="l4.138">   /**</span>
<a href="#l4.139"></a><span id="l4.139">    * Start from beginning with possibly new email address.</span>
<a href="#l4.140"></a><span id="l4.140">    */</span>
<a href="#l4.141"></a><span id="l4.141">   onStartOver() {</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineat">@@ -522,81 +537,90 @@ EmailConfigWizard.prototype =</span>
<a href="#l4.143"></a><span id="l4.143"> </span>
<a href="#l4.144"></a><span id="l4.144">   // --------------</span>
<a href="#l4.145"></a><span id="l4.145">   // Detection step</span>
<a href="#l4.146"></a><span id="l4.146"> </span>
<a href="#l4.147"></a><span id="l4.147">   /**</span>
<a href="#l4.148"></a><span id="l4.148">    * Try to find an account configuration for this email address.</span>
<a href="#l4.149"></a><span id="l4.149">    * This is the function which runs the autoconfig.</span>
<a href="#l4.150"></a><span id="l4.150">    */</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineminus">-  findConfig(domain, email) {</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+  findConfig(domain, emailAddress) {</span>
<a href="#l4.153"></a><span id="l4.153">     gEmailWizardLogger.info(&quot;findConfig()&quot;);</span>
<a href="#l4.154"></a><span id="l4.154">     if (this._abortable) {</span>
<a href="#l4.155"></a><span id="l4.155">       this.onStop();</span>
<a href="#l4.156"></a><span id="l4.156">     }</span>
<a href="#l4.157"></a><span id="l4.157">     this.switchToMode(&quot;find-config&quot;);</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineminus">-    this.startSpinner(&quot;looking_up_settings_disk&quot;);</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineplus">+    this.startSpinner(&quot;looking_up_settings&quot;);</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+</span>
<a href="#l4.161"></a><span id="l4.161">     var self = this;</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineminus">-    this._abortable = fetchConfigFromDisk(domain,</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineminus">-      function(config) { // success</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+    var call = null;</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineplus">+    var fetch = null;</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineplus">+</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+    var priority = this._abortable = new PriorityOrderAbortable(</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineplus">+      function(config, call) { // success</span>
<a href="#l4.169"></a><span id="l4.169">         self._abortable = null;</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineplus">+        self.removeStatusLines();</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineplus">+        self.stopSpinner(call.foundMsg);</span>
<a href="#l4.172"></a><span id="l4.172">         self.foundConfig(config);</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineminus">-        self.stopSpinner(&quot;found_settings_disk&quot;);</span>
<a href="#l4.174"></a><span id="l4.174">       },</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineminus">-      function(e) { // fetchConfigFromDisk failed</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+      function(e) { // all failed</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+        self._abortable = null;</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+        self.removeStatusLines();</span>
<a href="#l4.179"></a><span id="l4.179">         if (e instanceof CancelledException) {</span>
<a href="#l4.180"></a><span id="l4.180">           return;</span>
<a href="#l4.181"></a><span id="l4.181">         }</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineminus">-        gEmailWizardLogger.info(&quot;fetchConfigFromDisk failed: &quot; + e);</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineminus">-        self.startSpinner(&quot;looking_up_settings_isp&quot;);</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineminus">-        self._abortable = fetchConfigFromISP(domain, email,</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineminus">-          function(config) { // success</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineminus">-            self._abortable = null;</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineminus">-            self.foundConfig(config);</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineminus">-            self.stopSpinner(&quot;found_settings_isp&quot;);</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineminus">-          },</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineminus">-          function(e) { // fetchConfigFromISP failed</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineminus">-            if (e instanceof CancelledException) {</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineminus">-              return;</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineminus">-            }</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineminus">-            gEmailWizardLogger.info(&quot;fetchConfigFromISP failed: &quot; + e);</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineminus">-            logException(e);</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineminus">-            self.startSpinner(&quot;looking_up_settings_db&quot;);</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineminus">-            self._abortable = fetchConfigFromDB(domain,</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineminus">-              function(config) { // success</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineminus">-                self._abortable = null;</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineminus">-                self.foundConfig(config);</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineminus">-                self.stopSpinner(&quot;found_settings_db&quot;);</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineminus">-              },</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineminus">-              function(e) { // fetchConfigFromDB failed</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineminus">-                if (e instanceof CancelledException) {</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineminus">-                  return;</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineminus">-                }</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineminus">-                logException(e);</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineminus">-                gEmailWizardLogger.info(&quot;fetchConfigFromDB failed: &quot; + e);</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineminus">-                self.startSpinner(&quot;looking_up_settings_db&quot;);</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineminus">-                self._abortable = fetchConfigForMX(domain,</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineminus">-                  function(config) { // success</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineminus">-                    self._abortable = null;</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineminus">-                    self.foundConfig(config);</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineminus">-                    self.stopSpinner(&quot;found_settings_db&quot;);</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineminus">-                  },</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineminus">-                  function(e) { // fetchConfigForMX failed</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineminus">-                    if (e instanceof CancelledException) {</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineminus">-                      return;</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineminus">-                    }</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineminus">-                    logException(e);</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineminus">-                    gEmailWizardLogger.info(&quot;fetchConfigForMX failed: &quot; + e);</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineminus">-                    var initialConfig = new AccountConfig();</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineminus">-                    self._prefillConfig(initialConfig);</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineminus">-                    self._guessConfig(domain, initialConfig);</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineminus">-                  });</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineminus">-              });</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineminus">-          });</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineplus">+</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineplus">+        // guess config</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineplus">+        let initialConfig = new AccountConfig();</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineplus">+        self._prefillConfig(initialConfig);</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineplus">+        self._guessConfig(domain, initialConfig);</span>
<a href="#l4.233"></a><span id="l4.233">       });</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineplus">+    priority.addOneFinishedObserver(call =&gt; this.updateStatusLine(call));</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineplus">+</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineplus">+    try {</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineplus">+      call = priority.addCall();</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineplus">+      this.addStatusLine(&quot;looking_up_settings_disk&quot;, call);</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineplus">+      call.foundMsg = &quot;found_settings_disk&quot;;</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineplus">+      fetch = fetchConfigFromDisk(domain,</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineplus">+        call.successCallback(), call.errorCallback());</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineplus">+      call.setAbortable(fetch);</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineplus">+</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineplus">+      call = priority.addCall();</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineplus">+      this.addStatusLine(&quot;looking_up_settings_isp&quot;, call);</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineplus">+      call.foundMsg = &quot;found_settings_isp&quot;;</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineplus">+      fetch = fetchConfigFromISP(domain, emailAddress,</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineplus">+        call.successCallback(), call.errorCallback());</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineplus">+      call.setAbortable(fetch);</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineplus">+</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineplus">+      call = priority.addCall();</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineplus">+      this.addStatusLine(&quot;looking_up_settings_db&quot;, call);</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineplus">+      call.foundMsg = &quot;found_settings_db&quot;;</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineplus">+      fetch = fetchConfigFromDB(domain,</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineplus">+        call.successCallback(), call.errorCallback());</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineplus">+      call.setAbortable(fetch);</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineplus">+</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineplus">+      call = priority.addCall();</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineplus">+      this.addStatusLine(&quot;looking_up_settings_mx&quot;, call);</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineplus">+      call.foundMsg = &quot;found_settings_db&quot;;</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineplus">+      fetch = fetchConfigForMX(domain,</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineplus">+        call.successCallback(), call.errorCallback());</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineplus">+      call.setAbortable(fetch);</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineplus">+</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineplus">+      call = priority.addCall();</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineplus">+      this.addStatusLine(&quot;looking_up_settings_exchange&quot;, call);</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineplus">+      call.foundMsg = &quot;found_settings_exchange&quot;;</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineplus">+      fetch = fetchConfigFromExchange(domain, emailAddress, self._password,</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineplus">+        call.successCallback(), call.errorCallback());</span>
<a href="#l4.270"></a><span id="l4.270" class="difflineplus">+      call.setAbortable(fetch);</span>
<a href="#l4.271"></a><span id="l4.271" class="difflineplus">+</span>
<a href="#l4.272"></a><span id="l4.272" class="difflineplus">+    } catch (e) { // e.g. when entering an invalid domain like &quot;c@c.-com&quot;</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineplus">+      this.showErrorMsg(e);</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineplus">+      this.removeStatusLines();</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineplus">+      this.onStop();</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineplus">+    }</span>
<a href="#l4.277"></a><span id="l4.277">   },</span>
<a href="#l4.278"></a><span id="l4.278"> </span>
<a href="#l4.279"></a><span id="l4.279">   /**</span>
<a href="#l4.280"></a><span id="l4.280">    * Just a continuation of findConfig()</span>
<a href="#l4.281"></a><span id="l4.281">    */</span>
<a href="#l4.282"></a><span id="l4.282">   _guessConfig(domain, initialConfig) {</span>
<a href="#l4.283"></a><span id="l4.283">     this.startSpinner(&quot;looking_up_settings_guess&quot;);</span>
<a href="#l4.284"></a><span id="l4.284">     var self = this;</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineat">@@ -625,29 +649,26 @@ EmailConfigWizard.prototype =</span>
<a href="#l4.286"></a><span id="l4.286">   },</span>
<a href="#l4.287"></a><span id="l4.287"> </span>
<a href="#l4.288"></a><span id="l4.288">   /**</span>
<a href="#l4.289"></a><span id="l4.289">    * When findConfig() was successful, it calls this.</span>
<a href="#l4.290"></a><span id="l4.290">    * This displays the config to the user.</span>
<a href="#l4.291"></a><span id="l4.291">    */</span>
<a href="#l4.292"></a><span id="l4.292">   foundConfig(config) {</span>
<a href="#l4.293"></a><span id="l4.293">     gEmailWizardLogger.info(&quot;foundConfig()&quot;);</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineplus">+    gEmailWizardLogger.info(debugObject(config, &quot;foundConfig&quot;));</span>
<a href="#l4.295"></a><span id="l4.295">     assert(config instanceof AccountConfig,</span>
<a href="#l4.296"></a><span id="l4.296">         &quot;BUG: Arg 'config' needs to be an AccountConfig object&quot;);</span>
<a href="#l4.297"></a><span id="l4.297"> </span>
<a href="#l4.298"></a><span id="l4.298">     this._haveValidConfigForDomain = this._email.split(&quot;@&quot;)[1];</span>
<a href="#l4.299"></a><span id="l4.299"> </span>
<a href="#l4.300"></a><span id="l4.300">     if (!this._realname || !this._email) {</span>
<a href="#l4.301"></a><span id="l4.301">       return;</span>
<a href="#l4.302"></a><span id="l4.302">     }</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineminus">-    this._foundConfig2(config);</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineminus">-  },</span>
<a href="#l4.305"></a><span id="l4.305"> </span>
<a href="#l4.306"></a><span id="l4.306" class="difflineminus">-  // Continuation of foundConfig2() after custom fields.</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineminus">-  _foundConfig2(config) {</span>
<a href="#l4.308"></a><span id="l4.308">     this.displayConfigResult(config);</span>
<a href="#l4.309"></a><span id="l4.309">   },</span>
<a href="#l4.310"></a><span id="l4.310"> </span>
<a href="#l4.311"></a><span id="l4.311">   /**</span>
<a href="#l4.312"></a><span id="l4.312">    * [Stop] button click handler.</span>
<a href="#l4.313"></a><span id="l4.313">    * This allows the user to abort any longer operation, esp. network activity.</span>
<a href="#l4.314"></a><span id="l4.314">    * We currently have 3 such cases here:</span>
<a href="#l4.315"></a><span id="l4.315">    * 1. findConfig(), i.e. fetch config from DB, guessConfig etc.</span>
<a href="#l4.316"></a><span id="l4.316" class="difflineat">@@ -698,45 +719,199 @@ EmailConfigWizard.prototype =</span>
<a href="#l4.317"></a><span id="l4.317">   },</span>
<a href="#l4.318"></a><span id="l4.318"> </span>
<a href="#l4.319"></a><span id="l4.319">   showErrorStatus(actionStrName) {</span>
<a href="#l4.320"></a><span id="l4.320">     e(&quot;status_area&quot;).setAttribute(&quot;status&quot;, &quot;error&quot;);</span>
<a href="#l4.321"></a><span id="l4.321">     gEmailWizardLogger.warn(&quot;status error &quot; + actionStrName);</span>
<a href="#l4.322"></a><span id="l4.322">     this._showStatusTitle(actionStrName);</span>
<a href="#l4.323"></a><span id="l4.323">   },</span>
<a href="#l4.324"></a><span id="l4.324"> </span>
<a href="#l4.325"></a><span id="l4.325" class="difflineplus">+  showErrorMsg(errorMsg) {</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineplus">+    gEmailWizardLogger.warn(&quot;error &quot; + errorMsg);</span>
<a href="#l4.327"></a><span id="l4.327" class="difflineplus">+    e(&quot;status_area&quot;).setAttribute(&quot;status&quot;, &quot;error&quot;);</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineplus">+    e(&quot;status_msg&quot;).textContent = errorMsg;</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineplus">+  },</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineplus">+</span>
<a href="#l4.331"></a><span id="l4.331">   _showStatusTitle(msgName) {</span>
<a href="#l4.332"></a><span id="l4.332">     let msg = &quot; &quot;; // assure height. Do via min-height in CSS, for 2 lines?</span>
<a href="#l4.333"></a><span id="l4.333">     try {</span>
<a href="#l4.334"></a><span id="l4.334">       if (msgName) {</span>
<a href="#l4.335"></a><span id="l4.335">         msg = gStringsBundle.getFormattedString(msgName, [gBrandShortName]);</span>
<a href="#l4.336"></a><span id="l4.336">       }</span>
<a href="#l4.337"></a><span id="l4.337">     } catch (ex) {</span>
<a href="#l4.338"></a><span id="l4.338">       gEmailWizardLogger.error(&quot;missing string for &quot; + msgName);</span>
<a href="#l4.339"></a><span id="l4.339">       msg = msgName + &quot; (missing string in translation!)&quot;;</span>
<a href="#l4.340"></a><span id="l4.340">     }</span>
<a href="#l4.341"></a><span id="l4.341"> </span>
<a href="#l4.342"></a><span id="l4.342">     e(&quot;status_msg&quot;).textContent = msg;</span>
<a href="#l4.343"></a><span id="l4.343">     gEmailWizardLogger.info(&quot;status msg: &quot; + msg);</span>
<a href="#l4.344"></a><span id="l4.344">   },</span>
<a href="#l4.345"></a><span id="l4.345"> </span>
<a href="#l4.346"></a><span id="l4.346" class="difflineplus">+  // UI to show status updates in parallel</span>
<a href="#l4.347"></a><span id="l4.347" class="difflineplus">+</span>
<a href="#l4.348"></a><span id="l4.348" class="difflineplus">+  addStatusLine(msgID, call) {</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineplus">+    _show(&quot;status-lines&quot;);</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineplus">+    var statusLine = document.createElement(&quot;hbox&quot;);</span>
<a href="#l4.351"></a><span id="l4.351" class="difflineplus">+    e(&quot;status-lines&quot;).appendChild(statusLine);</span>
<a href="#l4.352"></a><span id="l4.352" class="difflineplus">+    statusLine.classList.add(&quot;status-line&quot;);</span>
<a href="#l4.353"></a><span id="l4.353" class="difflineplus">+    var statusDescr = document.createElement(&quot;description&quot;);</span>
<a href="#l4.354"></a><span id="l4.354" class="difflineplus">+    statusDescr.classList.add(&quot;status_msg&quot;);</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineplus">+    statusLine.appendChild(statusDescr);</span>
<a href="#l4.356"></a><span id="l4.356" class="difflineplus">+    var statusImg = document.createElement(&quot;vbox&quot;);</span>
<a href="#l4.357"></a><span id="l4.357" class="difflineplus">+    statusImg.classList.add(&quot;status-img&quot;);</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineplus">+    statusImg.setAttribute(&quot;pack&quot;, &quot;start&quot;);</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineplus">+    statusLine.appendChild(statusImg);</span>
<a href="#l4.360"></a><span id="l4.360" class="difflineplus">+    let msg = msgID;</span>
<a href="#l4.361"></a><span id="l4.361" class="difflineplus">+    try {</span>
<a href="#l4.362"></a><span id="l4.362" class="difflineplus">+      msg = gStringsBundle.getFormattedString(msgID, [gBrandShortName]);</span>
<a href="#l4.363"></a><span id="l4.363" class="difflineplus">+    } catch (e) {</span>
<a href="#l4.364"></a><span id="l4.364" class="difflineplus">+      console.error(e);</span>
<a href="#l4.365"></a><span id="l4.365" class="difflineplus">+    }</span>
<a href="#l4.366"></a><span id="l4.366" class="difflineplus">+    statusDescr.textContent = msg;</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineplus">+    call.statusLine = statusLine;</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineplus">+    statusLine.setAttribute(&quot;status&quot;, &quot;loading&quot;);</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineplus">+  },</span>
<a href="#l4.370"></a><span id="l4.370" class="difflineplus">+</span>
<a href="#l4.371"></a><span id="l4.371" class="difflineplus">+  updateStatusLine(call) {</span>
<a href="#l4.372"></a><span id="l4.372" class="difflineplus">+    console.log(&quot;update status line for call &quot; + call.position);</span>
<a href="#l4.373"></a><span id="l4.373" class="difflineplus">+    let line = [...document.querySelectorAll(&quot;#status-lines &gt; .status-line&quot;)]</span>
<a href="#l4.374"></a><span id="l4.374" class="difflineplus">+      .find(line =&gt; line == call.statusLine);</span>
<a href="#l4.375"></a><span id="l4.375" class="difflineplus">+    if (!line) {</span>
<a href="#l4.376"></a><span id="l4.376" class="difflineplus">+      return;</span>
<a href="#l4.377"></a><span id="l4.377" class="difflineplus">+    }</span>
<a href="#l4.378"></a><span id="l4.378" class="difflineplus">+    if (!call.finished) {</span>
<a href="#l4.379"></a><span id="l4.379" class="difflineplus">+      line.setAttribute(&quot;status&quot;, &quot;loading&quot;);</span>
<a href="#l4.380"></a><span id="l4.380" class="difflineplus">+    } else if (!call.succeeded) {</span>
<a href="#l4.381"></a><span id="l4.381" class="difflineplus">+      line.setAttribute(&quot;status&quot;, &quot;failed&quot;);</span>
<a href="#l4.382"></a><span id="l4.382" class="difflineplus">+    } else {</span>
<a href="#l4.383"></a><span id="l4.383" class="difflineplus">+      line.setAttribute(&quot;status&quot;, &quot;succeeded&quot;);</span>
<a href="#l4.384"></a><span id="l4.384" class="difflineplus">+    }</span>
<a href="#l4.385"></a><span id="l4.385" class="difflineplus">+  },</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineplus">+</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineplus">+  removeStatusLines() {</span>
<a href="#l4.388"></a><span id="l4.388" class="difflineplus">+    removeChildNodes(e(&quot;status-lines&quot;));</span>
<a href="#l4.389"></a><span id="l4.389" class="difflineplus">+    _hide(&quot;status-lines&quot;);</span>
<a href="#l4.390"></a><span id="l4.390" class="difflineplus">+  },</span>
<a href="#l4.391"></a><span id="l4.391" class="difflineplus">+</span>
<a href="#l4.392"></a><span id="l4.392">   // -----------</span>
<a href="#l4.393"></a><span id="l4.393">   // Result area</span>
<a href="#l4.394"></a><span id="l4.394"> </span>
<a href="#l4.395"></a><span id="l4.395">   /**</span>
<a href="#l4.396"></a><span id="l4.396">    * Displays a (probed) config to the user,</span>
<a href="#l4.397"></a><span id="l4.397">    * in the result config details area.</span>
<a href="#l4.398"></a><span id="l4.398">    *</span>
<a href="#l4.399"></a><span id="l4.399">    * @param config {AccountConfig} The config to present to user</span>
<a href="#l4.400"></a><span id="l4.400">    */</span>
<a href="#l4.401"></a><span id="l4.401">   displayConfigResult(config) {</span>
<a href="#l4.402"></a><span id="l4.402">     assert(config instanceof AccountConfig);</span>
<a href="#l4.403"></a><span id="l4.403">     this._currentConfig = config;</span>
<a href="#l4.404"></a><span id="l4.404">     var configFilledIn = this.getConcreteConfig();</span>
<a href="#l4.405"></a><span id="l4.405"> </span>
<a href="#l4.406"></a><span id="l4.406" class="difflineplus">+    // IMAP / POP3 server type radio buttons</span>
<a href="#l4.407"></a><span id="l4.407" class="difflineplus">+    let alternatives = config.incomingAlternatives.filter(alt =&gt;</span>
<a href="#l4.408"></a><span id="l4.408" class="difflineplus">+        (alt.type == &quot;imap&quot; || alt.type == &quot;pop3&quot; || alt.type == &quot;exchange&quot;) &amp;&amp;</span>
<a href="#l4.409"></a><span id="l4.409" class="difflineplus">+        alt.type != config.incoming.type</span>
<a href="#l4.410"></a><span id="l4.410" class="difflineplus">+      );</span>
<a href="#l4.411"></a><span id="l4.411" class="difflineplus">+    let alternative = alternatives[0];</span>
<a href="#l4.412"></a><span id="l4.412" class="difflineplus">+    if (alternative) {</span>
<a href="#l4.413"></a><span id="l4.413" class="difflineplus">+      _show(&quot;result_servertype&quot;);</span>
<a href="#l4.414"></a><span id="l4.414" class="difflineplus">+      _hide(&quot;result_select_imap&quot;);</span>
<a href="#l4.415"></a><span id="l4.415" class="difflineplus">+      _hide(&quot;result_select_pop3&quot;);</span>
<a href="#l4.416"></a><span id="l4.416" class="difflineplus">+      _hide(&quot;result_select_exchange&quot;);</span>
<a href="#l4.417"></a><span id="l4.417" class="difflineplus">+      _show(&quot;result_select_&quot; + alternative.type);</span>
<a href="#l4.418"></a><span id="l4.418" class="difflineplus">+      _show(&quot;result_select_&quot; + config.incoming.type);</span>
<a href="#l4.419"></a><span id="l4.419" class="difflineplus">+      e(&quot;result_select_&quot; + alternative.type).configIncoming = alternative;</span>
<a href="#l4.420"></a><span id="l4.420" class="difflineplus">+      e(&quot;result_select_&quot; + config.incoming.type).configIncoming =</span>
<a href="#l4.421"></a><span id="l4.421" class="difflineplus">+          config.incoming;</span>
<a href="#l4.422"></a><span id="l4.422" class="difflineplus">+      e(&quot;result_servertype&quot;).value = config.incoming.type;</span>
<a href="#l4.423"></a><span id="l4.423" class="difflineplus">+    } else {</span>
<a href="#l4.424"></a><span id="l4.424" class="difflineplus">+      _hide(&quot;result_servertype&quot;);</span>
<a href="#l4.425"></a><span id="l4.425" class="difflineplus">+    }</span>
<a href="#l4.426"></a><span id="l4.426" class="difflineplus">+</span>
<a href="#l4.427"></a><span id="l4.427" class="difflineplus">+    if (config.incoming.type == &quot;exchange&quot;) {</span>
<a href="#l4.428"></a><span id="l4.428" class="difflineplus">+      _hide(&quot;result_hostnames&quot;);</span>
<a href="#l4.429"></a><span id="l4.429" class="difflineplus">+      _show(&quot;result_exchange&quot;);</span>
<a href="#l4.430"></a><span id="l4.430" class="difflineplus">+      setText(&quot;result_exchange_hostname&quot;, config.incoming.hostname);</span>
<a href="#l4.431"></a><span id="l4.431" class="difflineplus">+      _disable(&quot;create_button&quot;);</span>
<a href="#l4.432"></a><span id="l4.432" class="difflineplus">+      removeChildNodes(e(&quot;result_addon_install_rows&quot;));</span>
<a href="#l4.433"></a><span id="l4.433" class="difflineplus">+      this.switchToMode(&quot;result&quot;);</span>
<a href="#l4.434"></a><span id="l4.434" class="difflineplus">+</span>
<a href="#l4.435"></a><span id="l4.435" class="difflineplus">+      (async () =&gt; {</span>
<a href="#l4.436"></a><span id="l4.436" class="difflineplus">+        for (let addon of config.addons) {</span>
<a href="#l4.437"></a><span id="l4.437" class="difflineplus">+          let installer = new AddonInstaller(addon);</span>
<a href="#l4.438"></a><span id="l4.438" class="difflineplus">+          addon.isInstalled = await installer.isInstalled();</span>
<a href="#l4.439"></a><span id="l4.439" class="difflineplus">+        }</span>
<a href="#l4.440"></a><span id="l4.440" class="difflineplus">+        let installedAddon = config.addons.find(addon =&gt; addon.isInstalled);</span>
<a href="#l4.441"></a><span id="l4.441" class="difflineplus">+        if (installedAddon) {</span>
<a href="#l4.442"></a><span id="l4.442" class="difflineplus">+          _hide(&quot;result_addon_intro&quot;);</span>
<a href="#l4.443"></a><span id="l4.443" class="difflineplus">+          _hide(&quot;result_addon_install&quot;);</span>
<a href="#l4.444"></a><span id="l4.444" class="difflineplus">+          _enable(&quot;create_button&quot;);</span>
<a href="#l4.445"></a><span id="l4.445" class="difflineplus">+          this.onCreate = () =&gt; { // TODO</span>
<a href="#l4.446"></a><span id="l4.446" class="difflineplus">+            this._currentConfig.incoming.type = installedAddon.useType.addonAccountType;</span>
<a href="#l4.447"></a><span id="l4.447" class="difflineplus">+            this.validateAndFinish();</span>
<a href="#l4.448"></a><span id="l4.448" class="difflineplus">+          };</span>
<a href="#l4.449"></a><span id="l4.449" class="difflineplus">+        } else {</span>
<a href="#l4.450"></a><span id="l4.450" class="difflineplus">+          _hide(&quot;status_area&quot;);</span>
<a href="#l4.451"></a><span id="l4.451" class="difflineplus">+          _show(&quot;result_addon_intro&quot;);</span>
<a href="#l4.452"></a><span id="l4.452" class="difflineplus">+          var msg = gStringsBundle.getString(&quot;addon-intro&quot;);</span>
<a href="#l4.453"></a><span id="l4.453" class="difflineplus">+          if (!config.incomingAlternatives.find(alt =&gt; (alt.type == &quot;imap&quot; || alt.type == &quot;pop3&quot;))) {</span>
<a href="#l4.454"></a><span id="l4.454" class="difflineplus">+            msg = gStringsBundle.getString(&quot;no-open-protocols&quot;) + &quot; &quot; + msg;</span>
<a href="#l4.455"></a><span id="l4.455" class="difflineplus">+          }</span>
<a href="#l4.456"></a><span id="l4.456" class="difflineplus">+          setText(&quot;result_addon_intro&quot;, msg);</span>
<a href="#l4.457"></a><span id="l4.457" class="difflineplus">+</span>
<a href="#l4.458"></a><span id="l4.458" class="difflineplus">+          let containerE = e(&quot;result_addon_install_rows&quot;);</span>
<a href="#l4.459"></a><span id="l4.459" class="difflineplus">+          for (let addon of config.addons) {</span>
<a href="#l4.460"></a><span id="l4.460" class="difflineplus">+            // Creates</span>
<a href="#l4.461"></a><span id="l4.461" class="difflineplus">+            // &lt;row&gt;</span>
<a href="#l4.462"></a><span id="l4.462" class="difflineplus">+            //   &lt;image src=&quot;https://live.thunderbird.net/owl32.png&quot; /&gt;</span>
<a href="#l4.463"></a><span id="l4.463" class="difflineplus">+            //   &lt;label class=&quot;text-link&quot; href=&quot;https://live.thunderbird.net/owl&quot;&gt;</span>
<a href="#l4.464"></a><span id="l4.464" class="difflineplus">+            //     A third party addon that ...</span>
<a href="#l4.465"></a><span id="l4.465" class="difflineplus">+            //   &lt;/label&gt;</span>
<a href="#l4.466"></a><span id="l4.466" class="difflineplus">+            //   &lt;button</span>
<a href="#l4.467"></a><span id="l4.467" class="difflineplus">+            //     class=&quot;larger-button&quot;</span>
<a href="#l4.468"></a><span id="l4.468" class="difflineplus">+            //     orient=&quot;vertical&quot; crop=&quot;right&quot;</span>
<a href="#l4.469"></a><span id="l4.469" class="difflineplus">+            //     label=&quot;Install&quot;</span>
<a href="#l4.470"></a><span id="l4.470" class="difflineplus">+            //     oncommand=&quot;…&quot; /&gt;</span>
<a href="#l4.471"></a><span id="l4.471" class="difflineplus">+            // &lt;/row&gt;</span>
<a href="#l4.472"></a><span id="l4.472" class="difflineplus">+            let addonE = document.createElement(&quot;row&quot;);</span>
<a href="#l4.473"></a><span id="l4.473" class="difflineplus">+            let iconE = document.createElement(&quot;image&quot;);</span>
<a href="#l4.474"></a><span id="l4.474" class="difflineplus">+            let descrE = document.createElement(&quot;label&quot;); // must be &lt;label&gt; to be clickable</span>
<a href="#l4.475"></a><span id="l4.475" class="difflineplus">+            let buttonE = document.createElement(&quot;button&quot;);</span>
<a href="#l4.476"></a><span id="l4.476" class="difflineplus">+            addonE.appendChild(iconE);</span>
<a href="#l4.477"></a><span id="l4.477" class="difflineplus">+            addonE.appendChild(descrE);</span>
<a href="#l4.478"></a><span id="l4.478" class="difflineplus">+            addonE.appendChild(buttonE);</span>
<a href="#l4.479"></a><span id="l4.479" class="difflineplus">+            containerE.appendChild(addonE);</span>
<a href="#l4.480"></a><span id="l4.480" class="difflineplus">+            addonE.setAttribute(&quot;align&quot;, &quot;center&quot;);</span>
<a href="#l4.481"></a><span id="l4.481" class="difflineplus">+            iconE.classList.add(&quot;icon&quot;);</span>
<a href="#l4.482"></a><span id="l4.482" class="difflineplus">+            if (addon.icon32) {</span>
<a href="#l4.483"></a><span id="l4.483" class="difflineplus">+              iconE.setAttribute(&quot;src&quot;, addon.icon32);</span>
<a href="#l4.484"></a><span id="l4.484" class="difflineplus">+            }</span>
<a href="#l4.485"></a><span id="l4.485" class="difflineplus">+            descrE.classList.add(&quot;text-link&quot;);</span>
<a href="#l4.486"></a><span id="l4.486" class="difflineplus">+            descrE.setAttribute(&quot;href&quot;, addon.websiteURL);</span>
<a href="#l4.487"></a><span id="l4.487" class="difflineplus">+            descrE.textContent = addon.description;</span>
<a href="#l4.488"></a><span id="l4.488" class="difflineplus">+            buttonE.classList.add(&quot;larger-button&quot;);</span>
<a href="#l4.489"></a><span id="l4.489" class="difflineplus">+            buttonE.setAttribute(&quot;orient&quot;, &quot;vertical&quot;);</span>
<a href="#l4.490"></a><span id="l4.490" class="difflineplus">+            buttonE.setAttribute(&quot;crop&quot;, &quot;right&quot;);</span>
<a href="#l4.491"></a><span id="l4.491" class="difflineplus">+            buttonE.setAttribute(&quot;label&quot;, gStringsBundle.getString(&quot;addonInstallShortLabel&quot;));</span>
<a href="#l4.492"></a><span id="l4.492" class="difflineplus">+            buttonE.setAttribute(&quot;oncommand&quot;, &quot;gEmailConfigWizard.addonInstall(this.addon);&quot;);</span>
<a href="#l4.493"></a><span id="l4.493" class="difflineplus">+            buttonE.addon = addon;</span>
<a href="#l4.494"></a><span id="l4.494" class="difflineplus">+          }</span>
<a href="#l4.495"></a><span id="l4.495" class="difflineplus">+          _show(&quot;result_addon_install&quot;);</span>
<a href="#l4.496"></a><span id="l4.496" class="difflineplus">+          _disable(&quot;create_button&quot;);</span>
<a href="#l4.497"></a><span id="l4.497" class="difflineplus">+        }</span>
<a href="#l4.498"></a><span id="l4.498" class="difflineplus">+</span>
<a href="#l4.499"></a><span id="l4.499" class="difflineplus">+        window.sizeToContent();</span>
<a href="#l4.500"></a><span id="l4.500" class="difflineplus">+      })();</span>
<a href="#l4.501"></a><span id="l4.501" class="difflineplus">+      return;</span>
<a href="#l4.502"></a><span id="l4.502" class="difflineplus">+    }</span>
<a href="#l4.503"></a><span id="l4.503" class="difflineplus">+</span>
<a href="#l4.504"></a><span id="l4.504" class="difflineplus">+    _show(&quot;result_hostnames&quot;);</span>
<a href="#l4.505"></a><span id="l4.505" class="difflineplus">+    _hide(&quot;result_exchange&quot;);</span>
<a href="#l4.506"></a><span id="l4.506" class="difflineplus">+    _enable(&quot;create_button&quot;);</span>
<a href="#l4.507"></a><span id="l4.507" class="difflineplus">+</span>
<a href="#l4.508"></a><span id="l4.508">     var unknownString = gStringsBundle.getString(&quot;resultUnknown&quot;);</span>
<a href="#l4.509"></a><span id="l4.509"> </span>
<a href="#l4.510"></a><span id="l4.510">     function _makeHostDisplayString(server, stringName) {</span>
<a href="#l4.511"></a><span id="l4.511">       let type = gStringsBundle.getString(sanitize.translate(server.type,</span>
<a href="#l4.512"></a><span id="l4.512">           { imap: &quot;resultIMAP&quot;, pop3: &quot;resultPOP3&quot;, smtp: &quot;resultSMTP&quot; }),</span>
<a href="#l4.513"></a><span id="l4.513">           unknownString);</span>
<a href="#l4.514"></a><span id="l4.514">       let host = server.hostname +</span>
<a href="#l4.515"></a><span id="l4.515">           (isStandardPort(server.port) ? &quot;&quot; : &quot;:&quot; + server.port);</span>
<a href="#l4.516"></a><span id="l4.516" class="difflineat">@@ -776,64 +951,70 @@ EmailConfigWizard.prototype =</span>
<a href="#l4.517"></a><span id="l4.517">             [ configFilledIn.incoming.username || unknownString,</span>
<a href="#l4.518"></a><span id="l4.518">               configFilledIn.outgoing.username || unknownString ]);</span>
<a href="#l4.519"></a><span id="l4.519">     }</span>
<a href="#l4.520"></a><span id="l4.520"> </span>
<a href="#l4.521"></a><span id="l4.521">     setText(&quot;result-incoming&quot;, incomingResult);</span>
<a href="#l4.522"></a><span id="l4.522">     setText(&quot;result-outgoing&quot;, outgoingResult);</span>
<a href="#l4.523"></a><span id="l4.523">     setText(&quot;result-username&quot;, usernameResult);</span>
<a href="#l4.524"></a><span id="l4.524"> </span>
<a href="#l4.525"></a><span id="l4.525" class="difflineminus">-    gEmailWizardLogger.info(debugObject(config, &quot;config&quot;));</span>
<a href="#l4.526"></a><span id="l4.526" class="difflineminus">-    // IMAP / POP dropdown</span>
<a href="#l4.527"></a><span id="l4.527" class="difflineminus">-    var lookForAltType =</span>
<a href="#l4.528"></a><span id="l4.528" class="difflineminus">-        config.incoming.type == &quot;imap&quot; ? &quot;pop3&quot; : &quot;imap&quot;;</span>
<a href="#l4.529"></a><span id="l4.529" class="difflineminus">-    var alternative = null;</span>
<a href="#l4.530"></a><span id="l4.530" class="difflineminus">-    for (let i = 0; i &lt; config.incomingAlternatives.length; i++) {</span>
<a href="#l4.531"></a><span id="l4.531" class="difflineminus">-      let alt = config.incomingAlternatives[i];</span>
<a href="#l4.532"></a><span id="l4.532" class="difflineminus">-      if (alt.type == lookForAltType) {</span>
<a href="#l4.533"></a><span id="l4.533" class="difflineminus">-        alternative = alt;</span>
<a href="#l4.534"></a><span id="l4.534" class="difflineminus">-        break;</span>
<a href="#l4.535"></a><span id="l4.535" class="difflineminus">-      }</span>
<a href="#l4.536"></a><span id="l4.536" class="difflineminus">-    }</span>
<a href="#l4.537"></a><span id="l4.537" class="difflineminus">-    if (alternative) {</span>
<a href="#l4.538"></a><span id="l4.538" class="difflineminus">-      _show(&quot;result_imappop&quot;);</span>
<a href="#l4.539"></a><span id="l4.539" class="difflineminus">-      e(&quot;result_select_&quot; + alternative.type).configIncoming = alternative;</span>
<a href="#l4.540"></a><span id="l4.540" class="difflineminus">-      e(&quot;result_select_&quot; + config.incoming.type).configIncoming =</span>
<a href="#l4.541"></a><span id="l4.541" class="difflineminus">-          config.incoming;</span>
<a href="#l4.542"></a><span id="l4.542" class="difflineminus">-      e(&quot;result_imappop&quot;).value =</span>
<a href="#l4.543"></a><span id="l4.543" class="difflineminus">-          config.incoming.type == &quot;imap&quot; ? 1 : 2;</span>
<a href="#l4.544"></a><span id="l4.544" class="difflineminus">-    } else {</span>
<a href="#l4.545"></a><span id="l4.545" class="difflineminus">-      _hide(&quot;result_imappop&quot;);</span>
<a href="#l4.546"></a><span id="l4.546" class="difflineminus">-    }</span>
<a href="#l4.547"></a><span id="l4.547" class="difflineminus">-</span>
<a href="#l4.548"></a><span id="l4.548">     this.switchToMode(&quot;result&quot;);</span>
<a href="#l4.549"></a><span id="l4.549">   },</span>
<a href="#l4.550"></a><span id="l4.550"> </span>
<a href="#l4.551"></a><span id="l4.551">   /**</span>
<a href="#l4.552"></a><span id="l4.552">    * Handle the user switching between IMAP and POP3 settings using the</span>
<a href="#l4.553"></a><span id="l4.553">    * radio buttons.</span>
<a href="#l4.554"></a><span id="l4.554">    *</span>
<a href="#l4.555"></a><span id="l4.555">    * Note: This function must only be called by user action, not by setting</span>
<a href="#l4.556"></a><span id="l4.556">    *       the value or selectedItem or selectedIndex of the radiogroup!</span>
<a href="#l4.557"></a><span id="l4.557">    *       This is why we use the oncommand attribute of the radio elements</span>
<a href="#l4.558"></a><span id="l4.558">    *       instead of the onselect attribute of the radiogroup.</span>
<a href="#l4.559"></a><span id="l4.559">    */</span>
<a href="#l4.560"></a><span id="l4.560" class="difflineminus">-  onResultIMAPOrPOP3() {</span>
<a href="#l4.561"></a><span id="l4.561" class="difflineplus">+  onResultServerTypeChanged() {</span>
<a href="#l4.562"></a><span id="l4.562">     var config = this._currentConfig;</span>
<a href="#l4.563"></a><span id="l4.563" class="difflineminus">-    var radiogroup = e(&quot;result_imappop&quot;);</span>
<a href="#l4.564"></a><span id="l4.564">     // add current server as best alternative to start of array</span>
<a href="#l4.565"></a><span id="l4.565">     config.incomingAlternatives.unshift(config.incoming);</span>
<a href="#l4.566"></a><span id="l4.566">     // use selected server (stored as special property on the &lt;radio&gt; node)</span>
<a href="#l4.567"></a><span id="l4.567" class="difflineminus">-    config.incoming = radiogroup.selectedItem.configIncoming;</span>
<a href="#l4.568"></a><span id="l4.568" class="difflineplus">+    config.incoming = e(&quot;result_servertype&quot;).selectedItem.configIncoming;</span>
<a href="#l4.569"></a><span id="l4.569">     // remove newly selected server from list of alternatives</span>
<a href="#l4.570"></a><span id="l4.570" class="difflineminus">-    config.incomingAlternatives = config.incomingAlternatives.filter(</span>
<a href="#l4.571"></a><span id="l4.571" class="difflineminus">-        function(e) { return e != config.incoming; });</span>
<a href="#l4.572"></a><span id="l4.572" class="difflineplus">+    config.incomingAlternatives = config.incomingAlternatives.filter(alt =&gt;</span>
<a href="#l4.573"></a><span id="l4.573" class="difflineplus">+      alt != config.incoming);</span>
<a href="#l4.574"></a><span id="l4.574">     this.displayConfigResult(config);</span>
<a href="#l4.575"></a><span id="l4.575">   },</span>
<a href="#l4.576"></a><span id="l4.576"> </span>
<a href="#l4.577"></a><span id="l4.577" class="difflineplus">+  /**</span>
<a href="#l4.578"></a><span id="l4.578" class="difflineplus">+   * Install the addon</span>
<a href="#l4.579"></a><span id="l4.579" class="difflineplus">+   * Called when user clicks [Install] button.</span>
<a href="#l4.580"></a><span id="l4.580" class="difflineplus">+   *</span>
<a href="#l4.581"></a><span id="l4.581" class="difflineplus">+   * @param {AddonInfo} addon - @see AccountConfig.addons</span>
<a href="#l4.582"></a><span id="l4.582" class="difflineplus">+   */</span>
<a href="#l4.583"></a><span id="l4.583" class="difflineplus">+  async addonInstall(addon) {</span>
<a href="#l4.584"></a><span id="l4.584" class="difflineplus">+    _hide(&quot;result_addon_install&quot;);</span>
<a href="#l4.585"></a><span id="l4.585" class="difflineplus">+    _hide(&quot;result_addon_intro&quot;);</span>
<a href="#l4.586"></a><span id="l4.586" class="difflineplus">+    _disable(&quot;create_button&quot;);</span>
<a href="#l4.587"></a><span id="l4.587" class="difflineplus">+    _show(&quot;status_area&quot;);</span>
<a href="#l4.588"></a><span id="l4.588" class="difflineplus">+    this.startSpinner(&quot;addonInstallStarted&quot;);</span>
<a href="#l4.589"></a><span id="l4.589" class="difflineplus">+</span>
<a href="#l4.590"></a><span id="l4.590" class="difflineplus">+    try {</span>
<a href="#l4.591"></a><span id="l4.591" class="difflineplus">+      var installer = this._abortable = new AddonInstaller(addon);</span>
<a href="#l4.592"></a><span id="l4.592" class="difflineplus">+      await installer.install();</span>
<a href="#l4.593"></a><span id="l4.593" class="difflineplus">+</span>
<a href="#l4.594"></a><span id="l4.594" class="difflineplus">+      this._abortable = null;</span>
<a href="#l4.595"></a><span id="l4.595" class="difflineplus">+      this.stopSpinner(&quot;addonInstallSuccess&quot;);</span>
<a href="#l4.596"></a><span id="l4.596" class="difflineplus">+      _enable(&quot;create_button&quot;);</span>
<a href="#l4.597"></a><span id="l4.597" class="difflineplus">+</span>
<a href="#l4.598"></a><span id="l4.598" class="difflineplus">+      this._currentConfig.incoming.type = addon.useType.addonAccountType;</span>
<a href="#l4.599"></a><span id="l4.599" class="difflineplus">+      this.validateAndFinish();</span>
<a href="#l4.600"></a><span id="l4.600" class="difflineplus">+    } catch (e) {</span>
<a href="#l4.601"></a><span id="l4.601" class="difflineplus">+      this.showErrorMsg(e + &quot;&quot;);</span>
<a href="#l4.602"></a><span id="l4.602" class="difflineplus">+      _show(&quot;result_addon_install&quot;);</span>
<a href="#l4.603"></a><span id="l4.603" class="difflineplus">+    }</span>
<a href="#l4.604"></a><span id="l4.604" class="difflineplus">+  },</span>
<a href="#l4.605"></a><span id="l4.605" class="difflineplus">+</span>
<a href="#l4.606"></a><span id="l4.606" class="difflineplus">+</span>
<a href="#l4.607"></a><span id="l4.607">   // ----------------</span>
<a href="#l4.608"></a><span id="l4.608">   // Manual Edit area</span>
<a href="#l4.609"></a><span id="l4.609"> </span>
<a href="#l4.610"></a><span id="l4.610">   /**</span>
<a href="#l4.611"></a><span id="l4.611">    * Gets the values from the user in the manual edit area.</span>
<a href="#l4.612"></a><span id="l4.612">    *</span>
<a href="#l4.613"></a><span id="l4.613">    * Realname and password are not part of that area and still</span>
<a href="#l4.614"></a><span id="l4.614">    * placeholders, but hostname and username are concrete and</span>
<a href="#l4.615"></a><span id="l4.615" class="difflineat">@@ -1145,20 +1326,18 @@ EmailConfigWizard.prototype =</span>
<a href="#l4.616"></a><span id="l4.616">   /**</span>
<a href="#l4.617"></a><span id="l4.617">    * Sets the prefilled values of the port fields.</span>
<a href="#l4.618"></a><span id="l4.618">    * Filled statically with the standard ports for the given protocol,</span>
<a href="#l4.619"></a><span id="l4.619">    * plus &quot;Auto&quot;.</span>
<a href="#l4.620"></a><span id="l4.620">    */</span>
<a href="#l4.621"></a><span id="l4.621">   fillPortDropdown(protocolType) {</span>
<a href="#l4.622"></a><span id="l4.622">     var menu = e(protocolType == &quot;smtp&quot; ? &quot;outgoing_port&quot; : &quot;incoming_port&quot;);</span>
<a href="#l4.623"></a><span id="l4.623"> </span>
<a href="#l4.624"></a><span id="l4.624" class="difflineminus">-    // menulist.removeAllItems() is nice, but nicely clears the user value, too</span>
<a href="#l4.625"></a><span id="l4.625" class="difflineminus">-    var popup = menu.menupopup;</span>
<a href="#l4.626"></a><span id="l4.626" class="difflineminus">-    while (popup.hasChildNodes())</span>
<a href="#l4.627"></a><span id="l4.627" class="difflineminus">-      popup.lastChild.remove();</span>
<a href="#l4.628"></a><span id="l4.628" class="difflineplus">+    // menulist.removeAllItems() is nice, but &quot;nicely&quot; clears the user value, too</span>
<a href="#l4.629"></a><span id="l4.629" class="difflineplus">+    removeChildNodes(menu.menupopup);</span>
<a href="#l4.630"></a><span id="l4.630"> </span>
<a href="#l4.631"></a><span id="l4.631">     // add standard ports</span>
<a href="#l4.632"></a><span id="l4.632">     var autoPort = gStringsBundle.getString(&quot;port_auto&quot;);</span>
<a href="#l4.633"></a><span id="l4.633">     menu.appendItem(autoPort, autoPort, &quot;&quot;); // label,value,descr</span>
<a href="#l4.634"></a><span id="l4.634">     for (let port of getStandardPorts(protocolType)) {</span>
<a href="#l4.635"></a><span id="l4.635">       menu.appendItem(port, port, &quot;&quot;); // label,value,descr</span>
<a href="#l4.636"></a><span id="l4.636">     }</span>
<a href="#l4.637"></a><span id="l4.637">   },</span>
<a href="#l4.638"></a><span id="l4.638" class="difflineat">@@ -1521,35 +1700,39 @@ EmailConfigWizard.prototype =</span>
<a href="#l4.639"></a><span id="l4.639">         self._currentConfig.incoming.username = successfulConfig.incoming.username;</span>
<a href="#l4.640"></a><span id="l4.640">         self._currentConfig.outgoing.username = successfulConfig.outgoing.username;</span>
<a href="#l4.641"></a><span id="l4.641"> </span>
<a href="#l4.642"></a><span id="l4.642">         // We loaded dynamic client registration, fill this data back in to the</span>
<a href="#l4.643"></a><span id="l4.643">         // config set.</span>
<a href="#l4.644"></a><span id="l4.644">         if (successfulConfig.oauthSettings)</span>
<a href="#l4.645"></a><span id="l4.645">           self._currentConfig.oauthSettings = successfulConfig.oauthSettings;</span>
<a href="#l4.646"></a><span id="l4.646"> </span>
<a href="#l4.647"></a><span id="l4.647" class="difflineminus">-        self.finish();</span>
<a href="#l4.648"></a><span id="l4.648" class="difflineplus">+        self.finish(configFilledIn);</span>
<a href="#l4.649"></a><span id="l4.649">       },</span>
<a href="#l4.650"></a><span id="l4.650">       function(e) { // failed</span>
<a href="#l4.651"></a><span id="l4.651">         self.showErrorStatus(&quot;config_unverifiable&quot;);</span>
<a href="#l4.652"></a><span id="l4.652">         // TODO bug 555448: wrong error msg, there may be a 1000 other</span>
<a href="#l4.653"></a><span id="l4.653">         // reasons why this failed, and this is misleading users.</span>
<a href="#l4.654"></a><span id="l4.654">         self.setError(&quot;passworderror&quot;, &quot;user_pass_invalid&quot;);</span>
<a href="#l4.655"></a><span id="l4.655">         // TODO use switchToMode(), see above</span>
<a href="#l4.656"></a><span id="l4.656">         // give user something to proceed after fixing</span>
<a href="#l4.657"></a><span id="l4.657">         _enable(&quot;create_button&quot;);</span>
<a href="#l4.658"></a><span id="l4.658">         // hidden in non-manual mode, so it's fine to enable</span>
<a href="#l4.659"></a><span id="l4.659">         _enable(&quot;half-manual-test_button&quot;);</span>
<a href="#l4.660"></a><span id="l4.660">         _enable(&quot;advanced-setup_button&quot;);</span>
<a href="#l4.661"></a><span id="l4.661">       });</span>
<a href="#l4.662"></a><span id="l4.662">   },</span>
<a href="#l4.663"></a><span id="l4.663"> </span>
<a href="#l4.664"></a><span id="l4.664" class="difflineminus">-  finish() {</span>
<a href="#l4.665"></a><span id="l4.665" class="difflineplus">+  finish(concreteConfig) {</span>
<a href="#l4.666"></a><span id="l4.666">     gEmailWizardLogger.info(&quot;creating account in backend&quot;);</span>
<a href="#l4.667"></a><span id="l4.667" class="difflineminus">-    createAccountInBackend(this.getConcreteConfig());</span>
<a href="#l4.668"></a><span id="l4.668" class="difflineplus">+    var account = createAccountInBackend(concreteConfig);</span>
<a href="#l4.669"></a><span id="l4.669" class="difflineplus">+</span>
<a href="#l4.670"></a><span id="l4.670" class="difflineplus">+    // Trigger first login, to get folder structure, show account, etc..</span>
<a href="#l4.671"></a><span id="l4.671" class="difflineplus">+    account.incomingServer.rootFolder.getNewMessages(null, null);</span>
<a href="#l4.672"></a><span id="l4.672" class="difflineplus">+</span>
<a href="#l4.673"></a><span id="l4.673">     window.close();</span>
<a href="#l4.674"></a><span id="l4.674">   },</span>
<a href="#l4.675"></a><span id="l4.675"> };</span>
<a href="#l4.676"></a><span id="l4.676"> </span>
<a href="#l4.677"></a><span id="l4.677"> var gEmailConfigWizard = new EmailConfigWizard();</span>
<a href="#l4.678"></a><span id="l4.678"> </span>
<a href="#l4.679"></a><span id="l4.679"> function serverMatches(a, b) {</span>
<a href="#l4.680"></a><span id="l4.680">   return a.type == b.type &amp;&amp;</span>
<a href="#l4.681"></a><span id="l4.681" class="difflineat">@@ -1558,18 +1741,21 @@ function serverMatches(a, b) {</span>
<a href="#l4.682"></a><span id="l4.682">          a.socketType == b.socketType &amp;&amp;</span>
<a href="#l4.683"></a><span id="l4.683">          a.auth == b.auth;</span>
<a href="#l4.684"></a><span id="l4.684"> }</span>
<a href="#l4.685"></a><span id="l4.685"> </span>
<a href="#l4.686"></a><span id="l4.686"> var _gStandardPorts = {};</span>
<a href="#l4.687"></a><span id="l4.687"> _gStandardPorts.imap = [ 143, 993 ];</span>
<a href="#l4.688"></a><span id="l4.688"> _gStandardPorts.pop3 = [ 110, 995 ];</span>
<a href="#l4.689"></a><span id="l4.689"> _gStandardPorts.smtp = [ 587, 25, 465 ]; // order matters</span>
<a href="#l4.690"></a><span id="l4.690" class="difflineplus">+_gStandardPorts.exchange = [ 443 ];</span>
<a href="#l4.691"></a><span id="l4.691"> var _gAllStandardPorts = _gStandardPorts.smtp</span>
<a href="#l4.692"></a><span id="l4.692" class="difflineminus">-    .concat(_gStandardPorts.imap).concat(_gStandardPorts.pop3);</span>
<a href="#l4.693"></a><span id="l4.693" class="difflineplus">+    .concat(_gStandardPorts.imap)</span>
<a href="#l4.694"></a><span id="l4.694" class="difflineplus">+    .concat(_gStandardPorts.pop3)</span>
<a href="#l4.695"></a><span id="l4.695" class="difflineplus">+    .concat(_gStandardPorts.exchange);</span>
<a href="#l4.696"></a><span id="l4.696"> </span>
<a href="#l4.697"></a><span id="l4.697"> function isStandardPort(port) {</span>
<a href="#l4.698"></a><span id="l4.698">   return _gAllStandardPorts.includes(port);</span>
<a href="#l4.699"></a><span id="l4.699"> }</span>
<a href="#l4.700"></a><span id="l4.700"> </span>
<a href="#l4.701"></a><span id="l4.701"> function getStandardPorts(protocolType) {</span>
<a href="#l4.702"></a><span id="l4.702">   return _gStandardPorts[protocolType];</span>
<a href="#l4.703"></a><span id="l4.703"> }</span>
<a href="#l4.704"></a><span id="l4.704" class="difflineat">@@ -1623,17 +1809,17 @@ SecurityWarningDialog.prototype =</span>
<a href="#l4.705"></a><span id="l4.705">     assert(configSchema instanceof AccountConfig);</span>
<a href="#l4.706"></a><span id="l4.706">     assert(configFilledIn instanceof AccountConfig);</span>
<a href="#l4.707"></a><span id="l4.707">     assert(configSchema.isComplete());</span>
<a href="#l4.708"></a><span id="l4.708">     assert(configFilledIn.isComplete());</span>
<a href="#l4.709"></a><span id="l4.709"> </span>
<a href="#l4.710"></a><span id="l4.710">     var incomingBad = ((configFilledIn.incoming.socketType &gt; 1) ? 0 : this._inSecurityBad) |</span>
<a href="#l4.711"></a><span id="l4.711">                       ((configFilledIn.incoming.badCert) ? this._inCertBad : 0);</span>
<a href="#l4.712"></a><span id="l4.712">     var outgoingBad = 0;</span>
<a href="#l4.713"></a><span id="l4.713" class="difflineminus">-    if (!configFilledIn.outgoing.existingServerKey) {</span>
<a href="#l4.714"></a><span id="l4.714" class="difflineplus">+    if (configFilledIn.outgoing.addThisServer) {</span>
<a href="#l4.715"></a><span id="l4.715">       outgoingBad = ((configFilledIn.outgoing.socketType &gt; 1) ? 0 : this._outSecurityBad) |</span>
<a href="#l4.716"></a><span id="l4.716">                     ((configFilledIn.outgoing.badCert) ? this._outCertBad : 0);</span>
<a href="#l4.717"></a><span id="l4.717">     }</span>
<a href="#l4.718"></a><span id="l4.718"> </span>
<a href="#l4.719"></a><span id="l4.719">     if (incomingBad &gt; 0) {</span>
<a href="#l4.720"></a><span id="l4.720">       if (this._acknowledged.some(</span>
<a href="#l4.721"></a><span id="l4.721">           function(ackServer) {</span>
<a href="#l4.722"></a><span id="l4.722">             return serverMatches(ackServer, configFilledIn.incoming);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/accountcreation/content/emailWizard.xul</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/accountcreation/content/emailWizard.xul</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -48,16 +48,18 @@</span>
<a href="#l5.4"></a><span id="l5.4">           src=&quot;chrome://messenger/content/accountcreation/readFromXML.js&quot;/&gt;</span>
<a href="#l5.5"></a><span id="l5.5">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l5.6"></a><span id="l5.6">           src=&quot;chrome://messenger/content/accountcreation/guessConfig.js&quot;/&gt;</span>
<a href="#l5.7"></a><span id="l5.7">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l5.8"></a><span id="l5.8">           src=&quot;chrome://messenger/content/accountcreation/verifyConfig.js&quot;/&gt;</span>
<a href="#l5.9"></a><span id="l5.9">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l5.10"></a><span id="l5.10">           src=&quot;chrome://messenger/content/accountcreation/fetchConfig.js&quot;/&gt;</span>
<a href="#l5.11"></a><span id="l5.11">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+          src=&quot;chrome://messenger/content/accountcreation/exchangeAutoDiscover.js&quot;/&gt;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l5.14"></a><span id="l5.14">           src=&quot;chrome://messenger/content/accountcreation/createInBackend.js&quot;/&gt;</span>
<a href="#l5.15"></a><span id="l5.15">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l5.16"></a><span id="l5.16">           src=&quot;chrome://messenger/content/accountcreation/MyBadCertHandler.js&quot;/&gt;</span>
<a href="#l5.17"></a><span id="l5.17">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l5.18"></a><span id="l5.18">           src=&quot;chrome://messenger/content/accountUtils.js&quot; /&gt;</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20">   &lt;keyset id=&quot;mailKeys&quot;&gt;</span>
<a href="#l5.21"></a><span id="l5.21">     &lt;key keycode=&quot;VK_ESCAPE&quot; oncommand=&quot;window.close();&quot;/&gt;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -196,33 +198,36 @@</span>
<a href="#l5.23"></a><span id="l5.23">                     label=&quot;&amp;rememberPassword.label;&quot;</span>
<a href="#l5.24"></a><span id="l5.24">                     accesskey=&quot;&amp;rememberPassword.accesskey;&quot;</span>
<a href="#l5.25"></a><span id="l5.25">                     checked=&quot;true&quot;/&gt;</span>
<a href="#l5.26"></a><span id="l5.26">         &lt;/row&gt;</span>
<a href="#l5.27"></a><span id="l5.27">       &lt;/rows&gt;</span>
<a href="#l5.28"></a><span id="l5.28">     &lt;/grid&gt;</span>
<a href="#l5.29"></a><span id="l5.29">     &lt;spacer flex=&quot;1&quot; /&gt;</span>
<a href="#l5.30"></a><span id="l5.30"> </span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-     &lt;hbox id=&quot;status_area&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+    &lt;hbox id=&quot;status_area&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l5.33"></a><span id="l5.33">       &lt;vbox id=&quot;status_img_before&quot; pack=&quot;start&quot;/&gt;</span>
<a href="#l5.34"></a><span id="l5.34">       &lt;description id=&quot;status_msg&quot;&gt;&amp;#160;&lt;/description&gt;</span>
<a href="#l5.35"></a><span id="l5.35">               &lt;!-- Include 160 = nbsp, to make the element occupy the</span>
<a href="#l5.36"></a><span id="l5.36">                    full height, for at least one line. With a normal space,</span>
<a href="#l5.37"></a><span id="l5.37">                    it does not have sufficient height. --&gt;</span>
<a href="#l5.38"></a><span id="l5.38">       &lt;vbox id=&quot;status_img_after&quot; pack=&quot;start&quot;/&gt;</span>
<a href="#l5.39"></a><span id="l5.39">     &lt;/hbox&gt;</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+    &lt;vbox id=&quot;status-lines&quot;/&gt;</span>
<a href="#l5.41"></a><span id="l5.41"> </span>
<a href="#l5.42"></a><span id="l5.42">     &lt;groupbox id=&quot;result_area&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-      &lt;radiogroup id=&quot;result_imappop&quot; orient=&quot;horizontal&quot;&gt;</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-        &lt;radio id=&quot;result_select_imap&quot; label=&quot;&amp;imapLong.label;&quot; value=&quot;1&quot;</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-               oncommand=&quot;gEmailConfigWizard.onResultIMAPOrPOP3();&quot;/&gt;</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-        &lt;radio id=&quot;result_select_pop3&quot; label=&quot;&amp;pop3Long.label;&quot; value=&quot;2&quot;</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-               oncommand=&quot;gEmailConfigWizard.onResultIMAPOrPOP3();&quot;/&gt;</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+      &lt;radiogroup id=&quot;result_servertype&quot; orient=&quot;horizontal&quot;&gt;</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+        &lt;radio id=&quot;result_select_imap&quot; label=&quot;&amp;imapLong.label;&quot; value=&quot;imap&quot;</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+               oncommand=&quot;gEmailConfigWizard.onResultServerTypeChanged();&quot;/&gt;</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+        &lt;radio id=&quot;result_select_pop3&quot; label=&quot;&amp;pop3Long.label;&quot; value=&quot;pop3&quot;</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+               oncommand=&quot;gEmailConfigWizard.onResultServerTypeChanged();&quot;/&gt;</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+        &lt;radio id=&quot;result_select_exchange&quot; label=&quot;&amp;exchange.label;&quot; value=&quot;exchange&quot;</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+               oncommand=&quot;gEmailConfigWizard.onResultServerTypeChanged();&quot;/&gt;</span>
<a href="#l5.55"></a><span id="l5.55">       &lt;/radiogroup&gt;</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-      &lt;grid&gt;</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+      &lt;grid id=&quot;result_hostnames&quot;&gt;</span>
<a href="#l5.58"></a><span id="l5.58">         &lt;columns&gt;</span>
<a href="#l5.59"></a><span id="l5.59">           &lt;column/&gt;</span>
<a href="#l5.60"></a><span id="l5.60">           &lt;column flex=&quot;1&quot;/&gt;</span>
<a href="#l5.61"></a><span id="l5.61">         &lt;/columns&gt;</span>
<a href="#l5.62"></a><span id="l5.62">         &lt;rows&gt;</span>
<a href="#l5.63"></a><span id="l5.63">           &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l5.64"></a><span id="l5.64">             &lt;label class=&quot;textbox-label&quot; value=&quot;&amp;incoming.label;&quot;</span>
<a href="#l5.65"></a><span id="l5.65">                    control=&quot;result-incoming&quot;/&gt;</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineat">@@ -235,16 +240,33 @@</span>
<a href="#l5.67"></a><span id="l5.67">           &lt;/row&gt;</span>
<a href="#l5.68"></a><span id="l5.68">           &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l5.69"></a><span id="l5.69">             &lt;label class=&quot;textbox-label&quot; value=&quot;&amp;username.label;&quot;</span>
<a href="#l5.70"></a><span id="l5.70">                    control=&quot;result-username&quot;/&gt;</span>
<a href="#l5.71"></a><span id="l5.71">             &lt;textbox id=&quot;result-username&quot; disabled=&quot;true&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l5.72"></a><span id="l5.72">           &lt;/row&gt;</span>
<a href="#l5.73"></a><span id="l5.73">         &lt;/rows&gt;</span>
<a href="#l5.74"></a><span id="l5.74">       &lt;/grid&gt;</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+      &lt;vbox id=&quot;result_exchange&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+        &lt;hbox id=&quot;result_exchange_hostname_container&quot; align=&quot;center&quot;&gt;</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+          &lt;label class=&quot;textbox-label&quot; value=&quot;&amp;exchange-hostname.label;&quot;</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+                 control=&quot;result_exchange_hostname&quot;/&gt;</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+          &lt;textbox id=&quot;result_exchange_hostname&quot; disabled=&quot;true&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+        &lt;/hbox&gt;</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+        &lt;description id=&quot;result_addon_intro&quot;/&gt;</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+        &lt;grid id=&quot;result_addon_install&quot;&gt;</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+          &lt;columns&gt;</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+            &lt;column id=&quot;result_addon_install_column_icon&quot; pack=&quot;start&quot; align=&quot;center&quot; /&gt;</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+            &lt;column id=&quot;result_addon_install_column_link&quot; pack=&quot;start&quot; align=&quot;center&quot; /&gt;</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+            &lt;column id=&quot;result_addon_install_column_button&quot; pack=&quot;start&quot; align=&quot;center&quot; /&gt;</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+          &lt;/columns&gt;</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+          &lt;rows id=&quot;result_addon_install_rows&quot;&gt;</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+          &lt;/rows&gt;</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+        &lt;/grid&gt;</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+      &lt;/vbox&gt;</span>
<a href="#l5.92"></a><span id="l5.92">     &lt;/groupbox&gt;</span>
<a href="#l5.93"></a><span id="l5.93"> </span>
<a href="#l5.94"></a><span id="l5.94">     &lt;groupbox id=&quot;manual-edit_area&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l5.95"></a><span id="l5.95">       &lt;grid&gt;</span>
<a href="#l5.96"></a><span id="l5.96">         &lt;columns&gt;</span>
<a href="#l5.97"></a><span id="l5.97">           &lt;column/&gt;&lt;!-- row label, e.g. &quot;incoming&quot; --&gt;</span>
<a href="#l5.98"></a><span id="l5.98">           &lt;column/&gt;&lt;!-- protocol, e.g. &quot;IMAP&quot; --&gt;</span>
<a href="#l5.99"></a><span id="l5.99">           &lt;column/&gt;&lt;!-- hostname / username --&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/mail/components/accountcreation/content/exchangeAutoDiscover.js</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,411 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/JXON.js&quot;);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;AddonManager&quot;, &quot;resource://gre/modules/AddonManager.jsm&quot;);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+/* eslint-disable complexity, no-lonely-if */</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+/**</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+ * Tries to get a configuration from an MS Exchange server</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+ * using Microsoft AutoDiscover protocol.</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+ *</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+ * Disclaimers:</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+ * - To support domain hosters, we cannot use SSL. That means we</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+ *   rely on insecure DNS and http, which means the results may be</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+ *   forged when under attack. The same is true for guessConfig(), though.</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+ *</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+ * @param {string} domain - The domain part of the user's email address</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+ * @param {string} emailAddress - The user's email address</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+ * @param {string} password - The user's password for that email address</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+ * @param {Function(config {AccountConfig})} successCallback - A callback that</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+ *         will be called when we could retrieve a configuration.</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+ *         The AccountConfig object will be passed in as first parameter.</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+ * @param {Function(ex)} errorCallback - A callback that</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+ *         will be called when we could not retrieve a configuration,</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+ *         for whatever reason. This is expected (e.g. when there's no config</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+ *         for this domain at this location),</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+ *         so do not unconditionally show this to the user.</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+ *         The first parameter will be an exception object or error string.</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+ */</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+function fetchConfigFromExchange(domain, emailAddress, password,</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+                                 successCallback, errorCallback) {</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+  assert(typeof(successCallback) == &quot;function&quot;);</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+  assert(typeof(errorCallback) == &quot;function&quot;);</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+  if (!Services.prefs.getBoolPref(</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+      &quot;mailnews.auto_config.fetchFromExchange.enabled&quot;, true)) {</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+    errorCallback(&quot;Exchange AutoDiscover disabled per user preference&quot;);</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+    return new Abortable();</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+  }</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+  // &lt;https://technet.microsoft.com/en-us/library/bb124251(v=exchg.160).aspx#Autodiscover%20services%20in%20Outlook&gt;</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+  // &lt;https://docs.microsoft.com/en-us/previous-versions/office/developer/exchange-server-interoperability-guidance/hh352638(v%3Dexchg.140)&gt;</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+  let url1 = &quot;https://&quot; + sanitize.hostname(domain) +</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+             &quot;/autodiscover/autodiscover.xml&quot;;</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+  let url2 = &quot;https://autodiscover.&quot; + sanitize.hostname(domain) +</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+             &quot;/autodiscover/autodiscover.xml&quot;;</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+  let url3 = &quot;http://autodiscover.&quot; + sanitize.hostname(domain) +</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+             &quot;/autodiscover/autodiscover.xml&quot;; // needed by email hosters</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+  let body =</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+    `&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+    &lt;Autodiscover xmlns=&quot;http://schemas.microsoft.com/exchange/autodiscover/outlook/requestschema/2006&quot;&gt;</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+      &lt;Request&gt;</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+        &lt;EMailAddress&gt;${emailAddress}&lt;/EMailAddress&gt;</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+        &lt;AcceptableResponseSchema&gt;http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a&lt;/AcceptableResponseSchema&gt;</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+      &lt;/Request&gt;</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+    &lt;/Autodiscover&gt;`;</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+  let callArgs = {</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+    uploadBody: body,</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+    post: true,</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+    headers: {</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+      // outlook.com needs this exact string, with space and lower case &quot;utf&quot;.</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+      // Compare bug 1454325 comment 15.</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+      &quot;Content-Type&quot;: &quot;text/xml; charset=utf-8&quot;,</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+    },</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+    username: emailAddress,</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+    password,</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+    // url3 is HTTP (not HTTPS), so suppress password. Even MS spec demands so.</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+    requireSecureAuth: true,</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+    allowAuthPrompt: false,</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+  };</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+  let call;</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+  let fetch;</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+  let fetch3;</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+  let successive = new SuccessiveAbortable();</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+  let priority = new PriorityOrderAbortable(</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+    function(xml, call) { // success</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+      readAutoDiscoverResponse(xml, successive, password, function(config) {</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+        successive.current = getAddonsList(config, successCallback, errorCallback);</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+      }, errorCallback);</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+    },</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+    errorCallback); // all failed</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+  call = priority.addCall();</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+  fetch = new FetchHTTP(url1, callArgs,</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+    call.successCallback(), call.errorCallback());</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+  fetch.start();</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+  call.setAbortable(fetch);</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+  call = priority.addCall();</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+  fetch = new FetchHTTP(url2, callArgs,</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+    call.successCallback(), call.errorCallback());</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+  fetch.start();</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+  call.setAbortable(fetch);</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+  call = priority.addCall();</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+  fetch3 = new FetchHTTP(url3, callArgs,</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+    call.successCallback(), call.errorCallback());</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+  fetch3.start();</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+  call.setAbortable(fetch3);</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+  // url3 is an HTTP URL that will redirect to the real one, usually a HTTPS</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+  // URL of the hoster. XMLHttpRequest unfortunately loses the call</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+  // parameters, drops the auth, drops the body, and turns POST into GET,</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+  // which cause the call to fail, but FetchHTTP fixes this and automatically</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+  // repeats the call. We need that, otherwise the whole AutoDiscover</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+  // mechanism doesn't work.</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+  successive.current = priority;</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+  return successive;</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+}</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineplus">+var gLoopCounter = 0;</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineplus">+</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+/**</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+ * @param {JXON} xml - The Exchange server AutoDiscover response</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+ * @param {Function(config {AccountConfig})} successCallback - @see accountConfig.js</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+ */</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+function readAutoDiscoverResponse(autoDiscoverXML,</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+  successive, password, successCallback, errorCallback) {</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineplus">+  assert(successive instanceof SuccessiveAbortable);</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineplus">+  assert(typeof(successCallback) == &quot;function&quot;);</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+  assert(typeof(errorCallback) == &quot;function&quot;);</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineplus">+  // redirect to other email address</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+  if (&quot;Action&quot; in autoDiscoverXML.Autodiscover.Response &amp;&amp;</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineplus">+      &quot;Redirect&quot; in autoDiscoverXML.Autodiscover.Response.Action) {</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineplus">+    // &lt;https://docs.microsoft.com/en-us/previous-versions/office/developer/exchange-server-interoperability-guidance/hh352638(v%3Dexchg.140)&gt;</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineplus">+    let redirectEmailAddress = sanitize.emailAddress(</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineplus">+        autoDiscoverXML.Autodiscover.Response.Action.Redirect);</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineplus">+    let domain = redirectEmailAddress.split(&quot;@&quot;).pop();</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineplus">+    if (++gLoopCounter &gt; 2) {</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+      throw new Exception(&quot;Too many redirects in XML response&quot;);</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+    }</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineplus">+    successive.current = fetchConfigFromExchange(domain,</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+      redirectEmailAddress, password,</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineplus">+      successCallback, errorCallback);</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineplus">+  }</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineplus">+</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineplus">+  let config = readAutoDiscoverXML(autoDiscoverXML);</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineplus">+</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineplus">+  if (config.isComplete()) {</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+    successCallback(config);</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineplus">+  } else {</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+    errorCallback(new Exception(&quot;No valid configs found in AutoDiscover XML&quot;));</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineplus">+  }</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+}</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineplus">+/**</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineplus">+ * @param {JXON} xml - The Exchange server AutoDiscover response</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineplus">+ * @returns {AccountConfig} - @see accountConfig.js</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineplus">+ *</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineplus">+ * @see &lt;https://www.msxfaq.de/exchange/autodiscover/autodiscover_xml.htm&gt;</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineplus">+ */</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineplus">+function readAutoDiscoverXML(autoDiscoverXML) {</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineplus">+  if (typeof(autoDiscoverXML) != &quot;object&quot; ||</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineplus">+      !(&quot;Autodiscover&quot; in autoDiscoverXML) ||</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineplus">+      !(&quot;Response&quot; in autoDiscoverXML.Autodiscover) ||</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+      !(&quot;Account&quot; in autoDiscoverXML.Autodiscover.Response) ||</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineplus">+      !(&quot;Protocol&quot; in autoDiscoverXML.Autodiscover.Response.Account)) {</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineplus">+    let stringBundle = getStringBundle(</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineplus">+      &quot;chrome://messenger/locale/accountCreationModel.properties&quot;);</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineplus">+    throw new Exception(stringBundle.GetStringFromName(&quot;no_autodiscover.error&quot;));</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineplus">+  }</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineplus">+  var xml = autoDiscoverXML.Autodiscover.Response.Account;</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineplus">+</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineplus">+  function array_or_undef(value) {</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineplus">+    return value === undefined ? [] : value;</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineplus">+  }</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineplus">+</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineplus">+  var config = new AccountConfig();</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineplus">+  config.source = AccountConfig.kSourceExchange;</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineplus">+  config.incoming.username = &quot;%EMAILADDRESS%&quot;;</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineplus">+  config.incoming.socketType = 2; // only https supported</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineplus">+  config.incoming.port = 443;</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineplus">+  config.incoming.auth = Ci.nsMsgAuthMethod.passwordCleartext;</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineplus">+  config.incoming.authAlternatives = [ Ci.nsMsgAuthMethod.OAuth2 ];</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineplus">+  config.oauthSettings = {};</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineplus">+  config.outgoing.addThisServer = false;</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineplus">+  config.outgoing.useGlobalPreferredServer = true;</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineplus">+</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineplus">+  for (let protocolX of array_or_undef(xml.$Protocol)) {</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineplus">+    try {</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineplus">+      let type = sanitize.enum(protocolX.Type,</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineplus">+                               [&quot;WEB&quot;, &quot;EXHTTP&quot;, &quot;EXCH&quot;, &quot;EXPR&quot;, &quot;POP3&quot;, &quot;IMAP&quot;, &quot;SMTP&quot;],</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineplus">+                               &quot;unknown&quot;);</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineplus">+      if (type == &quot;WEB&quot;) {</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineplus">+        let urlsX;</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineplus">+        if (&quot;External&quot; in protocolX) {</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineplus">+          urlsX = protocolX.External;</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineplus">+        } else if (&quot;Internal&quot; in protocolX) {</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineplus">+          urlsX = protocolX.Internal;</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineplus">+        }</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineplus">+        if (urlsX) {</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineplus">+          config.incoming.owaURL = sanitize.url(urlsX.OWAUrl.value);</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineplus">+          if (!config.incoming.ewsURL &amp;&amp;</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineplus">+              &quot;Protocol&quot; in urlsX &amp;&amp;</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineplus">+              &quot;ASUrl&quot; in urlsX.Protocol) {</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineplus">+            config.incoming.ewsURL = sanitize.url(urlsX.Protocol.ASUrl);</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineplus">+          }</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineplus">+          config.incoming.type = &quot;exchange&quot;;</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineplus">+          let parsedURL = new URL(config.incoming.owaURL);</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineplus">+          config.incoming.hostname = sanitize.hostname(parsedURL.hostname);</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineplus">+          if (parsedURL.port) {</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineplus">+            config.incoming.port =  sanitize.integer(parsedURL.port);</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineplus">+          }</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineplus">+        }</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineplus">+      } else if (type == &quot;EXHTTP&quot; || type == &quot;EXCH&quot;) {</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineplus">+        config.incoming.ewsURL = sanitize.url(protocolX.EwsUrl);</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineplus">+        if (!config.incoming.ewsURL) {</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineplus">+          config.incoming.ewsURL = sanitize.url(protocolX.ASUrl);</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineplus">+        }</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineplus">+        config.incoming.type = &quot;exchange&quot;;</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineplus">+        let parsedURL = new URL(config.incoming.ewsURL);</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineplus">+        config.incoming.hostname = sanitize.hostname(parsedURL.hostname);</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineplus">+        if (parsedURL.port) {</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineplus">+          config.incoming.port =  sanitize.integer(parsedURL.port);</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineplus">+        }</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineplus">+      } else if (type == &quot;POP3&quot; || type == &quot;IMAP&quot; || type == &quot;SMTP&quot;) {</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineplus">+        let server;</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineplus">+        if (type == &quot;SMTP&quot;) {</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineplus">+          server = config.createNewOutgoing();</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineplus">+        } else {</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineplus">+          server = config.createNewIncoming();</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineplus">+        }</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineplus">+</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineplus">+        server.type = sanitize.translate(type, { POP3: &quot;pop3&quot;, IMAP: &quot;imap&quot;, SMTP: &quot;smtp&quot; });</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineplus">+        server.hostname = sanitize.hostname(protocolX.Server);</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineplus">+        server.port = sanitize.integer(protocolX.Port);</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineplus">+        server.socketType = 1; // plain</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineplus">+        if (&quot;SSL&quot; in protocolX &amp;&amp;</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineplus">+            sanitize.enum(protocolX.SSL, [&quot;on&quot;, &quot;off&quot;]) == &quot;on&quot;) {</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineplus">+          // SSL is too unspecific. Do they mean STARTTLS or normal TLS?</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineplus">+          // For now, assume normal TLS, unless it's a standard plain port.</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineplus">+          switch (server.port) {</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineplus">+            case 143: // IMAP standard</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineplus">+            case 110: // POP3 standard</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineplus">+            case 25:  // SMTP standard</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineplus">+            case 587: // SMTP standard</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineplus">+              server.socketType = 3; // STARTTLS</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineplus">+              break;</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineplus">+            case 993: // IMAP SSL</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineplus">+            case 995: // POP3 SSL</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineplus">+            case 465: // SMTP SSL</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineplus">+            default: // if non-standard port, assume normal TLS, not STARTTLS</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineplus">+              server.socketType = 2; // normal TLS</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineplus">+              break;</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineplus">+          }</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineplus">+        }</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineplus">+        if (&quot;SPA&quot; in protocolX &amp;&amp;</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineplus">+            sanitize.enum(protocolX.SPA, [&quot;on&quot;, &quot;off&quot;]) == &quot;on&quot;) {</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineplus">+          // Secure Password Authentication = NTLM or GSSAPI/Kerberos</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineplus">+          server.auth = 8; // secure (not really, but this is MS...)</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineplus">+        }</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineplus">+        if (&quot;LoginName&quot; in protocolX) {</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineplus">+          server.username = sanitize.nonemptystring(protocolX.LoginName);</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineplus">+        } else {</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineplus">+          server.username = &quot;%EMAILADDRESS%&quot;;</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineplus">+        }</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineplus">+</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineplus">+        if (type == &quot;SMTP&quot;) {</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineplus">+          if (!config.outgoing.hostname) {</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineplus">+            config.outgoing = server;</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineplus">+          } else {</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineplus">+            config.outgoingAlternatives.push(server);</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineplus">+          }</span>
<a href="#l6.273"></a><span id="l6.273" class="difflineplus">+        } else {</span>
<a href="#l6.274"></a><span id="l6.274" class="difflineplus">+          if (!config.incoming.hostname) {</span>
<a href="#l6.275"></a><span id="l6.275" class="difflineplus">+            config.incoming = server;</span>
<a href="#l6.276"></a><span id="l6.276" class="difflineplus">+          } else {</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineplus">+            config.incomingAlternatives.push(server);</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineplus">+          }</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineplus">+        }</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineplus">+      }</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineplus">+</span>
<a href="#l6.282"></a><span id="l6.282" class="difflineplus">+      // else unknown or unsupported protocol</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineplus">+</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineplus">+    } catch (e) { logException(e); }</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineplus">+  }</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineplus">+</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineplus">+  // OAuth2 settings, so that createInBackend() doesn't bail out</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineplus">+  if (config.incoming.owaURL || config.incoming.ewsURL) {</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineplus">+    config.oauthSettings = {</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineplus">+      issuer: config.incoming.hostname,</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineplus">+      scope: config.incoming.owaURL || config.incoming.ewsURL,</span>
<a href="#l6.292"></a><span id="l6.292" class="difflineplus">+    };</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineplus">+  }</span>
<a href="#l6.294"></a><span id="l6.294" class="difflineplus">+</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineplus">+  return config;</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineplus">+}</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineplus">+</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineplus">+/**</span>
<a href="#l6.299"></a><span id="l6.299" class="difflineplus">+ * Ask server which addons can handle this config.</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineplus">+ * @param {AccountConfig} config</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineplus">+ * @param {Function(config {AccountConfig})} successCallback</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineplus">+ * @returns {Abortable}</span>
<a href="#l6.303"></a><span id="l6.303" class="difflineplus">+ */</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineplus">+function getAddonsList(config, successCallback, errorCallback) {</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineplus">+  let url = Services.prefs.getCharPref(&quot;mailnews.auto_config.addons_url&quot;);</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineplus">+  if (!url) {</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineplus">+    errorCallback(new Exception(&quot;no URL for addons list configured&quot;));</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineplus">+    return new Abortable();</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineplus">+  }</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineplus">+  let fetch = new FetchHTTP(url, { allowCache: true }, function(json) {</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineplus">+    let addons = readAddonsJSON(json);</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineplus">+    addons = addons.filter(addon =&gt; {</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineplus">+      // Find types matching the current config.</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineplus">+      // Pick the first in the list as the preferred one and</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineplus">+      // tell the UI to use that one.</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineplus">+      addon.useType = addon.supportedTypes.find(type =&gt;</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineplus">+        config.incoming.owaURL &amp;&amp; type.protocolType == &quot;owa&quot; ||</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineplus">+        config.incoming.ewsURL &amp;&amp; type.protocolType == &quot;ews&quot; ||</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineplus">+        config.incoming.easURL &amp;&amp; type.protocolType == &quot;eas&quot;);</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineplus">+      return !!addon.useType;</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineplus">+    });</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineplus">+    if (addons.length == 0) {</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineplus">+      errorCallback(new Exception(&quot;Config found, but no addons known to handle the config&quot;));</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineplus">+      return;</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineplus">+    }</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineplus">+    config.addons = addons;</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineplus">+    successCallback(config);</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineplus">+  }, errorCallback);</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineplus">+  fetch.start();</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineplus">+  return fetch;</span>
<a href="#l6.331"></a><span id="l6.331" class="difflineplus">+}</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineplus">+</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineplus">+/**</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineplus">+ * This reads the addons list JSON and makes security validations,</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineplus">+ * e.g. that the URLs are not chrome: URLs, which could lead to exploits.</span>
<a href="#l6.336"></a><span id="l6.336" class="difflineplus">+ * It also chooses the right language etc..</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineplus">+ *</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineplus">+ * @param {JSON} json - the addons.json file contents</span>
<a href="#l6.339"></a><span id="l6.339" class="difflineplus">+ * @returns {Array of AddonInfo} - @see AccountConfig.addons</span>
<a href="#l6.340"></a><span id="l6.340" class="difflineplus">+ *</span>
<a href="#l6.341"></a><span id="l6.341" class="difflineplus">+ * accountTypes are listed in order of decreasing preference.</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineplus">+ * Languages are 2-letter codes. If a language is not available,</span>
<a href="#l6.343"></a><span id="l6.343" class="difflineplus">+ * the first name or description will be used.</span>
<a href="#l6.344"></a><span id="l6.344" class="difflineplus">+ *</span>
<a href="#l6.345"></a><span id="l6.345" class="difflineplus">+ * Parse e.g.</span>
<a href="#l6.346"></a><span id="l6.346" class="difflineplus">+[</span>
<a href="#l6.347"></a><span id="l6.347" class="difflineplus">+  {</span>
<a href="#l6.348"></a><span id="l6.348" class="difflineplus">+    &quot;id&quot;: &quot;owl@beonex.com&quot;,</span>
<a href="#l6.349"></a><span id="l6.349" class="difflineplus">+    &quot;name&quot;: {</span>
<a href="#l6.350"></a><span id="l6.350" class="difflineplus">+      &quot;en&quot;: &quot;Owl&quot;,</span>
<a href="#l6.351"></a><span id="l6.351" class="difflineplus">+      &quot;de&quot;: &quot;Eule&quot;</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineplus">+    },</span>
<a href="#l6.353"></a><span id="l6.353" class="difflineplus">+    &quot;description&quot;: {</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineplus">+      &quot;en&quot;: &quot;Owl is a paid third-party addon that allows you to access your email account on Exchange servers. See the website for prices.&quot;,</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineplus">+      &quot;de&quot;: &quot;Eule ist eine Erweiterung von einem Drittanbieter, die Ihnen erlaubt, Exchange server zu benutzen. Sie ist kostenpflichtig. Die Preise finden sie auf der Website.&quot;</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineplus">+    },</span>
<a href="#l6.357"></a><span id="l6.357" class="difflineplus">+    &quot;minVersion&quot;: &quot;0.2&quot;,</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineplus">+    &quot;xpiURL&quot;: &quot;http://www.beonex.com/owl/latest.xpi&quot;,</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineplus">+    &quot;websiteURL&quot;: &quot;http://www.beonex.com/owl/&quot;,</span>
<a href="#l6.360"></a><span id="l6.360" class="difflineplus">+    &quot;icon32&quot;: &quot;http://www.beonex.com/owl/owl-32.png&quot;,</span>
<a href="#l6.361"></a><span id="l6.361" class="difflineplus">+    &quot;accountTypes&quot;: [</span>
<a href="#l6.362"></a><span id="l6.362" class="difflineplus">+      {</span>
<a href="#l6.363"></a><span id="l6.363" class="difflineplus">+        &quot;generalType&quot;: &quot;exchange&quot;,</span>
<a href="#l6.364"></a><span id="l6.364" class="difflineplus">+        &quot;protocolType&quot;: &quot;owa&quot;,</span>
<a href="#l6.365"></a><span id="l6.365" class="difflineplus">+        &quot;addonAccountType&quot;: &quot;owl-owa&quot;</span>
<a href="#l6.366"></a><span id="l6.366" class="difflineplus">+      },</span>
<a href="#l6.367"></a><span id="l6.367" class="difflineplus">+      {</span>
<a href="#l6.368"></a><span id="l6.368" class="difflineplus">+        &quot;generalType&quot;: &quot;exchange&quot;,</span>
<a href="#l6.369"></a><span id="l6.369" class="difflineplus">+        &quot;protocolType&quot;: &quot;eas&quot;,</span>
<a href="#l6.370"></a><span id="l6.370" class="difflineplus">+        &quot;addonAccountType&quot;: &quot;owl-eas&quot;</span>
<a href="#l6.371"></a><span id="l6.371" class="difflineplus">+      }</span>
<a href="#l6.372"></a><span id="l6.372" class="difflineplus">+    ]</span>
<a href="#l6.373"></a><span id="l6.373" class="difflineplus">+  }</span>
<a href="#l6.374"></a><span id="l6.374" class="difflineplus">+]</span>
<a href="#l6.375"></a><span id="l6.375" class="difflineplus">+ */</span>
<a href="#l6.376"></a><span id="l6.376" class="difflineplus">+function readAddonsJSON(json) {</span>
<a href="#l6.377"></a><span id="l6.377" class="difflineplus">+  let addons = [];</span>
<a href="#l6.378"></a><span id="l6.378" class="difflineplus">+  function ensureArray(value) {</span>
<a href="#l6.379"></a><span id="l6.379" class="difflineplus">+    return Array.isArray(value) ? value : [];</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineplus">+  }</span>
<a href="#l6.381"></a><span id="l6.381" class="difflineplus">+  let xulLocale = Services.locale.requestedLocale;</span>
<a href="#l6.382"></a><span id="l6.382" class="difflineplus">+  let locale = xulLocale ? xulLocale.substring(0, 5) : &quot;default&quot;;</span>
<a href="#l6.383"></a><span id="l6.383" class="difflineplus">+  for (let addonJSON of ensureArray(json)) {</span>
<a href="#l6.384"></a><span id="l6.384" class="difflineplus">+    try {</span>
<a href="#l6.385"></a><span id="l6.385" class="difflineplus">+      let addon = {</span>
<a href="#l6.386"></a><span id="l6.386" class="difflineplus">+        id: addonJSON.id,</span>
<a href="#l6.387"></a><span id="l6.387" class="difflineplus">+        minVersion: addonJSON.minVersion,</span>
<a href="#l6.388"></a><span id="l6.388" class="difflineplus">+        xpiURL: sanitize.url(addonJSON.xpiURL),</span>
<a href="#l6.389"></a><span id="l6.389" class="difflineplus">+        websiteURL: sanitize.url(addonJSON.websiteURL),</span>
<a href="#l6.390"></a><span id="l6.390" class="difflineplus">+        icon32: addonJSON.icon32 ? sanitize.url(addonJSON.icon32) : null,</span>
<a href="#l6.391"></a><span id="l6.391" class="difflineplus">+        supportedTypes: [],</span>
<a href="#l6.392"></a><span id="l6.392" class="difflineplus">+      };</span>
<a href="#l6.393"></a><span id="l6.393" class="difflineplus">+      assert(new URL(addon.xpiURL).protocol == &quot;https:&quot;, &quot;XPI download URL needs to be https&quot;);</span>
<a href="#l6.394"></a><span id="l6.394" class="difflineplus">+      addon.name = (locale in addonJSON.name) ?</span>
<a href="#l6.395"></a><span id="l6.395" class="difflineplus">+        addonJSON.name[locale] : addonJSON.name[0];</span>
<a href="#l6.396"></a><span id="l6.396" class="difflineplus">+      addon.description = (locale in addonJSON.description) ?</span>
<a href="#l6.397"></a><span id="l6.397" class="difflineplus">+        addonJSON.description[locale] : addonJSON.description[0];</span>
<a href="#l6.398"></a><span id="l6.398" class="difflineplus">+      for (let typeJSON of ensureArray(addonJSON.accountTypes)) {</span>
<a href="#l6.399"></a><span id="l6.399" class="difflineplus">+        try {</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineplus">+          addon.supportedTypes.push({</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineplus">+            generalType: sanitize.alphanumdash(typeJSON.generalType),</span>
<a href="#l6.402"></a><span id="l6.402" class="difflineplus">+            protocolType: sanitize.alphanumdash(typeJSON.protocolType),</span>
<a href="#l6.403"></a><span id="l6.403" class="difflineplus">+            addonAccountType: sanitize.alphanumdash(typeJSON.addonAccountType),</span>
<a href="#l6.404"></a><span id="l6.404" class="difflineplus">+          });</span>
<a href="#l6.405"></a><span id="l6.405" class="difflineplus">+        } catch (e) {</span>
<a href="#l6.406"></a><span id="l6.406" class="difflineplus">+          ddump(e);</span>
<a href="#l6.407"></a><span id="l6.407" class="difflineplus">+        }</span>
<a href="#l6.408"></a><span id="l6.408" class="difflineplus">+      }</span>
<a href="#l6.409"></a><span id="l6.409" class="difflineplus">+      addons.push(addon);</span>
<a href="#l6.410"></a><span id="l6.410" class="difflineplus">+    } catch (e) {</span>
<a href="#l6.411"></a><span id="l6.411" class="difflineplus">+      ddump(e);</span>
<a href="#l6.412"></a><span id="l6.412" class="difflineplus">+    }</span>
<a href="#l6.413"></a><span id="l6.413" class="difflineplus">+  }</span>
<a href="#l6.414"></a><span id="l6.414" class="difflineplus">+  return addons;</span>
<a href="#l6.415"></a><span id="l6.415" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/components/accountcreation/content/fetchConfig.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/components/accountcreation/content/fetchConfig.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,33 +1,32 @@</span>
<a href="#l7.4"></a><span id="l7.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l7.5"></a><span id="l7.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.6"></a><span id="l7.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.7"></a><span id="l7.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/JXON.js&quot;);</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+</span>
<a href="#l7.13"></a><span id="l7.13"> /**</span>
<a href="#l7.14"></a><span id="l7.14">  * Tries to find a configuration for this ISP on the local harddisk, in the</span>
<a href="#l7.15"></a><span id="l7.15">  * application install directory's &quot;isp&quot; subdirectory.</span>
<a href="#l7.16"></a><span id="l7.16">  * Params @see fetchConfigFromISP()</span>
<a href="#l7.17"></a><span id="l7.17">  */</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/JXON.js&quot;);</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-</span>
<a href="#l7.23"></a><span id="l7.23"> function fetchConfigFromDisk(domain, successCallback, errorCallback) {</span>
<a href="#l7.24"></a><span id="l7.24">   return new TimeoutAbortable(runAsync(function() {</span>
<a href="#l7.25"></a><span id="l7.25">     try {</span>
<a href="#l7.26"></a><span id="l7.26">       // &lt;TB installdir&gt;/isp/example.com.xml</span>
<a href="#l7.27"></a><span id="l7.27">       var configLocation = Services.dirsvc.get(&quot;CurProcD&quot;, Ci.nsIFile);</span>
<a href="#l7.28"></a><span id="l7.28">       configLocation.append(&quot;isp&quot;);</span>
<a href="#l7.29"></a><span id="l7.29">       configLocation.append(sanitize.hostname(domain) + &quot;.xml&quot;);</span>
<a href="#l7.30"></a><span id="l7.30"> </span>
<a href="#l7.31"></a><span id="l7.31">       if (!configLocation.exists() || !configLocation.isReadable()) {</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-        errorCallback(&quot;local file not found&quot;);</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+        errorCallback(new Exception(&quot;local file not found&quot;));</span>
<a href="#l7.34"></a><span id="l7.34">         return;</span>
<a href="#l7.35"></a><span id="l7.35">       }</span>
<a href="#l7.36"></a><span id="l7.36">       var contents =</span>
<a href="#l7.37"></a><span id="l7.37">         readURLasUTF8(Services.io.newFileURI(configLocation));</span>
<a href="#l7.38"></a><span id="l7.38">       let domParser = new DOMParser();</span>
<a href="#l7.39"></a><span id="l7.39">       successCallback(readFromXML(JXON.build(</span>
<a href="#l7.40"></a><span id="l7.40">         domParser.parseFromString(contents, &quot;text/xml&quot;))));</span>
<a href="#l7.41"></a><span id="l7.41">     } catch (e) { errorCallback(e); }</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineat">@@ -53,88 +52,80 @@ function fetchConfigFromDisk(domain, suc</span>
<a href="#l7.43"></a><span id="l7.43">  *         for this domain at this location),</span>
<a href="#l7.44"></a><span id="l7.44">  *         so do not unconditionally show this to the user.</span>
<a href="#l7.45"></a><span id="l7.45">  *         The first parameter will be an exception object or error string.</span>
<a href="#l7.46"></a><span id="l7.46">  */</span>
<a href="#l7.47"></a><span id="l7.47"> function fetchConfigFromISP(domain, emailAddress, successCallback,</span>
<a href="#l7.48"></a><span id="l7.48">                             errorCallback) {</span>
<a href="#l7.49"></a><span id="l7.49">   if (!Services.prefs.getBoolPref(</span>
<a href="#l7.50"></a><span id="l7.50">       &quot;mailnews.auto_config.fetchFromISP.enabled&quot;)) {</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-    errorCallback(&quot;ISP fetch disabled per user preference&quot;);</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-    return null;</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+    errorCallback(new Exception(&quot;ISP fetch disabled per user preference&quot;));</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+    return new Abortable();</span>
<a href="#l7.55"></a><span id="l7.55">   }</span>
<a href="#l7.56"></a><span id="l7.56"> </span>
<a href="#l7.57"></a><span id="l7.57">   let url1 = &quot;http://autoconfig.&quot; + sanitize.hostname(domain) +</span>
<a href="#l7.58"></a><span id="l7.58">              &quot;/mail/config-v1.1.xml&quot;;</span>
<a href="#l7.59"></a><span id="l7.59">   // .well-known/ &lt;http://tools.ietf.org/html/draft-nottingham-site-meta-04&gt;</span>
<a href="#l7.60"></a><span id="l7.60">   let url2 = &quot;http://&quot; + sanitize.hostname(domain) +</span>
<a href="#l7.61"></a><span id="l7.61">              &quot;/.well-known/autoconfig/mail/config-v1.1.xml&quot;;</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-  let sucAbortable = new SuccessiveAbortable();</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-  var time = Date.now();</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-  var urlArgs = { emailaddress: emailAddress };</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+  let callArgs = {</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+    urlArgs: {</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+      emailaddress: emailAddress,</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+    },</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+  };</span>
<a href="#l7.70"></a><span id="l7.70">   if (!Services.prefs.getBoolPref(</span>
<a href="#l7.71"></a><span id="l7.71">       &quot;mailnews.auto_config.fetchFromISP.sendEmailAddress&quot;)) {</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-    delete urlArgs.emailaddress;</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+    delete callArgs.urlArgs.emailaddress;</span>
<a href="#l7.74"></a><span id="l7.74">   }</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-  let fetch1 = new FetchHTTP(url1, urlArgs, false,</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-    function(result) {</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineminus">-      successCallback(readFromXML(result));</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-    },</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-    function(e1) { // fetch1 failed</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-      ddump(&quot;fetchisp 1 &lt;&quot; + url1 + &quot;&gt; took &quot; + (Date.now() - time) +</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-          &quot;ms and failed with &quot; + e1);</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-      time = Date.now();</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-      if (e1 instanceof CancelledException) {</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-        errorCallback(e1);</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-        return;</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineminus">-      }</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+  let call;</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+  let fetch;</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+  let priority = new PriorityOrderAbortable(</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+      xml =&gt; successCallback(readFromXML(xml)),</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+      errorCallback);</span>
<a href="#l7.93"></a><span id="l7.93"> </span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-      let fetch2 = new FetchHTTP(url2, urlArgs, false,</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineminus">-        function(result) {</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineminus">-          successCallback(readFromXML(result));</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineminus">-        },</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineminus">-        function(e2) {</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-          ddump(&quot;fetchisp 2 &lt;&quot; + url2 + &quot;&gt; took &quot; + (Date.now() - time) +</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-              &quot;ms and failed with &quot; + e2);</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineminus">-          // return the error for the primary call,</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineminus">-          // unless the fetch was cancelled</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineminus">-          errorCallback(e2 instanceof CancelledException ? e2 : e1);</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineminus">-        });</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineminus">-      sucAbortable.current = fetch2;</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineminus">-      fetch2.start();</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineminus">-    });</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-  sucAbortable.current = fetch1;</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-  fetch1.start();</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineminus">-  return sucAbortable;</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+  call = priority.addCall();</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+  fetch = new FetchHTTP(url1, callArgs,</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+      call.successCallback(), call.errorCallback());</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+  call.setAbortable(fetch);</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+  fetch.start();</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+  call = priority.addCall();</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+  fetch = new FetchHTTP(url2, callArgs,</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+      call.successCallback(), call.errorCallback());</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+  call.setAbortable(fetch);</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+  fetch.start();</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+  return priority;</span>
<a href="#l7.124"></a><span id="l7.124"> }</span>
<a href="#l7.125"></a><span id="l7.125"> </span>
<a href="#l7.126"></a><span id="l7.126"> /**</span>
<a href="#l7.127"></a><span id="l7.127">  * Tries to get a configuration for this ISP from a central database at</span>
<a href="#l7.128"></a><span id="l7.128">  * Mozilla servers.</span>
<a href="#l7.129"></a><span id="l7.129">  * Params @see fetchConfigFromISP()</span>
<a href="#l7.130"></a><span id="l7.130">  */</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineminus">-</span>
<a href="#l7.132"></a><span id="l7.132"> function fetchConfigFromDB(domain, successCallback, errorCallback) {</span>
<a href="#l7.133"></a><span id="l7.133">   let url = Services.prefs.getCharPref(&quot;mailnews.auto_config_url&quot;);</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+  if (!url) {</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+    errorCallback(new Exception(&quot;no URL for ISP DB configured&quot;));</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+    return new Abortable();</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+  }</span>
<a href="#l7.138"></a><span id="l7.138">   domain = sanitize.hostname(domain);</span>
<a href="#l7.139"></a><span id="l7.139"> </span>
<a href="#l7.140"></a><span id="l7.140">   // If we don't specify a place to put the domain, put it at the end.</span>
<a href="#l7.141"></a><span id="l7.141">   if (!url.includes(&quot;{{domain}}&quot;))</span>
<a href="#l7.142"></a><span id="l7.142">     url = url + domain;</span>
<a href="#l7.143"></a><span id="l7.143">   else</span>
<a href="#l7.144"></a><span id="l7.144">     url = url.replace(&quot;{{domain}}&quot;, domain);</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineminus">-  url = url.replace(&quot;{{accounts}}&quot;, MailServices.accounts.accounts.length);</span>
<a href="#l7.146"></a><span id="l7.146"> </span>
<a href="#l7.147"></a><span id="l7.147" class="difflineminus">-  if (!url.length)</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineminus">-    return errorCallback(&quot;no fetch url set&quot;);</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineminus">-  let fetch = new FetchHTTP(url, null, false,</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-                            function(result) {</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-                              successCallback(readFromXML(result));</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineminus">-                            },</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineminus">-                            errorCallback);</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineplus">+  let fetch = new FetchHTTP(url, {},</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineplus">+    function(result) {</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+      successCallback(readFromXML(result));</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+    },</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+    errorCallback);</span>
<a href="#l7.159"></a><span id="l7.159">   fetch.start();</span>
<a href="#l7.160"></a><span id="l7.160">   return fetch;</span>
<a href="#l7.161"></a><span id="l7.161"> }</span>
<a href="#l7.162"></a><span id="l7.162"> </span>
<a href="#l7.163"></a><span id="l7.163"> /**</span>
<a href="#l7.164"></a><span id="l7.164">  * Does a lookup of DNS MX, to get the server who is responsible for</span>
<a href="#l7.165"></a><span id="l7.165">  * receiving mail for this domain. Then it takes the domain of that</span>
<a href="#l7.166"></a><span id="l7.166">  * server, and does another lookup (in ISPDB and possible at ISP autoconfig</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineat">@@ -161,17 +152,17 @@ function fetchConfigForMX(domain, succes</span>
<a href="#l7.168"></a><span id="l7.168">   var sucAbortable = new SuccessiveAbortable();</span>
<a href="#l7.169"></a><span id="l7.169">   var time = Date.now();</span>
<a href="#l7.170"></a><span id="l7.170">   sucAbortable.current = getMX(domain,</span>
<a href="#l7.171"></a><span id="l7.171">     function(mxHostname) { // success</span>
<a href="#l7.172"></a><span id="l7.172">       ddump(&quot;getmx took &quot; + (Date.now() - time) + &quot;ms&quot;);</span>
<a href="#l7.173"></a><span id="l7.173">       let sld = Services.eTLD.getBaseDomainFromHost(mxHostname);</span>
<a href="#l7.174"></a><span id="l7.174">       ddump(&quot;base domain &quot; + sld + &quot; for &quot; + mxHostname);</span>
<a href="#l7.175"></a><span id="l7.175">       if (sld == domain) {</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineminus">-        errorCallback(&quot;MX lookup would be no different from domain&quot;);</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineplus">+        errorCallback(new Exception(&quot;MX lookup would be no different from domain&quot;));</span>
<a href="#l7.178"></a><span id="l7.178">         return;</span>
<a href="#l7.179"></a><span id="l7.179">       }</span>
<a href="#l7.180"></a><span id="l7.180">       sucAbortable.current = fetchConfigFromDB(sld, successCallback,</span>
<a href="#l7.181"></a><span id="l7.181">                                                errorCallback);</span>
<a href="#l7.182"></a><span id="l7.182">     },</span>
<a href="#l7.183"></a><span id="l7.183">     errorCallback);</span>
<a href="#l7.184"></a><span id="l7.184">   return sucAbortable;</span>
<a href="#l7.185"></a><span id="l7.185"> }</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineat">@@ -197,30 +188,32 @@ function fetchConfigForMX(domain, succes</span>
<a href="#l7.187"></a><span id="l7.187">  *   For |hostname|, see description above.</span>
<a href="#l7.188"></a><span id="l7.188">  * @param errorCallback @see fetchConfigFromISP()</span>
<a href="#l7.189"></a><span id="l7.189">  * @returns @see fetchConfigFromISP()</span>
<a href="#l7.190"></a><span id="l7.190">  */</span>
<a href="#l7.191"></a><span id="l7.191"> function getMX(domain, successCallback, errorCallback) {</span>
<a href="#l7.192"></a><span id="l7.192">   domain = sanitize.hostname(domain);</span>
<a href="#l7.193"></a><span id="l7.193"> </span>
<a href="#l7.194"></a><span id="l7.194">   let url = Services.prefs.getCharPref(&quot;mailnews.mx_service_url&quot;);</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineminus">-  if (!url)</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-    errorCallback(&quot;no URL for MX service configured&quot;);</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+  if (!url) {</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+    errorCallback(new Exception(&quot;no URL for MX service configured&quot;));</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+    return new Abortable();</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+  }</span>
<a href="#l7.201"></a><span id="l7.201">   url += domain;</span>
<a href="#l7.202"></a><span id="l7.202"> </span>
<a href="#l7.203"></a><span id="l7.203" class="difflineminus">-  let fetch = new FetchHTTP(url, null, false,</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+  let fetch = new FetchHTTP(url, {},</span>
<a href="#l7.205"></a><span id="l7.205">     function(result) {</span>
<a href="#l7.206"></a><span id="l7.206">       // result is plain text, with one line per server.</span>
<a href="#l7.207"></a><span id="l7.207">       // So just take the first line</span>
<a href="#l7.208"></a><span id="l7.208">       ddump(&quot;MX query result: \n&quot; + result + &quot;(end)&quot;);</span>
<a href="#l7.209"></a><span id="l7.209">       assert(typeof(result) == &quot;string&quot;);</span>
<a href="#l7.210"></a><span id="l7.210">       let first = result.split(&quot;\n&quot;)[0];</span>
<a href="#l7.211"></a><span id="l7.211">       first.toLowerCase().replace(/[^a-z0-9\-_\.]*/g, &quot;&quot;);</span>
<a href="#l7.212"></a><span id="l7.212">       if (first.length == 0) {</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineminus">-        errorCallback(&quot;no MX found&quot;);</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineplus">+        errorCallback(new Exception(&quot;no MX found&quot;));</span>
<a href="#l7.215"></a><span id="l7.215">         return;</span>
<a href="#l7.216"></a><span id="l7.216">       }</span>
<a href="#l7.217"></a><span id="l7.217">       successCallback(first);</span>
<a href="#l7.218"></a><span id="l7.218">     },</span>
<a href="#l7.219"></a><span id="l7.219">     errorCallback);</span>
<a href="#l7.220"></a><span id="l7.220">   fetch.start();</span>
<a href="#l7.221"></a><span id="l7.221">   return fetch;</span>
<a href="#l7.222"></a><span id="l7.222"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/components/accountcreation/content/fetchhttp.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/components/accountcreation/content/fetchhttp.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -15,139 +15,241 @@</span>
<a href="#l8.4"></a><span id="l8.4">  * but not for bigger file downloads.</span>
<a href="#l8.5"></a><span id="l8.5">  */</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7"> ChromeUtils.import(&quot;resource:///modules/JXON.js&quot;);</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9"> /**</span>
<a href="#l8.10"></a><span id="l8.10">  * Set up a fetch.</span>
<a href="#l8.11"></a><span id="l8.11">  *</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">- * @param url {String}   URL of the server function.</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+ * @param {string} url - URL of the server function.</span>
<a href="#l8.14"></a><span id="l8.14">  *    ATTENTION: The caller needs to make sure that the URL is secure to call.</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">- * @param urlArgs {Object, associative array} Parameters to add</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">- *   to the end of the URL as query string. E.g.</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">- *   { foo: &quot;bla&quot;, bar: &quot;blub blub&quot; } will add &quot;?foo=bla&amp;bar=blub%20blub&quot;</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">- *   to the URL</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">- *   (unless the URL already has a &quot;?&quot;, then it adds &quot;&amp;foo...&quot;).</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">- *   The values will be urlComponentEncoded, so pass them unencoded.</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">- * @param post {Boolean}   HTTP GET or POST</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">- *   Only influences the HTTP request method,</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">- *   i.e. first line of the HTTP request, not the body or parameters.</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">- *   Use POST when you modify server state,</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineminus">- *   GET when you only request information.</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+ * @param {Object} args - Additional parameters as properties, see below</span>
<a href="#l8.27"></a><span id="l8.27">  *</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">- * @param successCallback {Function(result {String})}</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+ * @param {Function({string} result)} successCallback</span>
<a href="#l8.30"></a><span id="l8.30">  *   Called when the server call worked (no errors).</span>
<a href="#l8.31"></a><span id="l8.31">  *   |result| will contain the body of the HTTP response, as string.</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">- * @param errorCallback {Function(ex)}</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+ * @param {Function(ex)} errorCallback</span>
<a href="#l8.34"></a><span id="l8.34">  *   Called in case of error. ex contains the error</span>
<a href="#l8.35"></a><span id="l8.35">  *   with a user-displayable but not localized |.message| and maybe a</span>
<a href="#l8.36"></a><span id="l8.36">  *   |.code|, which can be either</span>
<a href="#l8.37"></a><span id="l8.37">  *  - an nsresult error code,</span>
<a href="#l8.38"></a><span id="l8.38">  *  - an HTTP result error code (0...1000) or</span>
<a href="#l8.39"></a><span id="l8.39">  *  - negative: 0...-100 :</span>
<a href="#l8.40"></a><span id="l8.40">  *     -2 = can't resolve server in DNS etc.</span>
<a href="#l8.41"></a><span id="l8.41">  *     -4 = response body (e.g. XML) malformed</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">- */</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-/* not yet supported:</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">- * @param headers {Object, associative array} Like urlArgs,</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">- *   just that the params will be added as HTTP headers.</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">- *   { foo: &quot;blub blub&quot; } will add &quot;Foo: Blub blub&quot;</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">- *   The values will be urlComponentEncoded, apart from space,</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">- *   so pass them unencoded.</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">- * @param headerArgs {Object, associative array} Like urlArgs,</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">- *   just that the params will be added as HTTP headers.</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">- *   { foo: &quot;blub blub&quot; } will add &quot;X-Moz-Arg-Foo: Blub blub&quot;</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">- *   The values will be urlComponentEncoded, apart from space,</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">- *   so pass them unencoded.</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">- * @param bodyArgs {Object, associative array} Like urlArgs,</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+ *</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+ * The following optional parameters are supported as properties of the |args| object:</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+ *</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+ * @param {Object, associative array} urlArgs - Parameters to add</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+ *   to the end of the URL as query string. E.g.</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+ *   { foo: &quot;bla&quot;, bar: &quot;blub blub&quot; } will add &quot;?foo=bla&amp;bar=blub%20blub&quot;</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+ *   to the URL</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+ *   (unless the URL already has a &quot;?&quot;, then it adds &quot;&amp;foo...&quot;).</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+ *   The values will be urlComponentEncoded, so pass them unencoded.</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+ * @param {Object, associative array} headers - HTTP headers to be added</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+ *   to the HTTP request.</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+ *   { foo: &quot;blub blub&quot; } will add HTTP header &quot;Foo: Blub blub&quot;.</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+ *   The values will be passed verbatim.</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+ * @param {boolean} post - HTTP GET or POST</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+ *   Only influences the HTTP request method,</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+ *   i.e. first line of the HTTP request, not the body or parameters.</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+ *   Use POST when you modify server state,</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+ *   GET when you only request information.</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+ *   Default is GET.</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+ * @param {Object, associative array} bodyFormArgs - Like urlArgs,</span>
<a href="#l8.75"></a><span id="l8.75">  *   just that the params will be sent x-url-encoded in the body,</span>
<a href="#l8.76"></a><span id="l8.76">  *   like a HTML form post.</span>
<a href="#l8.77"></a><span id="l8.77">  *   The values will be urlComponentEncoded, so pass them unencoded.</span>
<a href="#l8.78"></a><span id="l8.78">  *   This cannot be used together with |uploadBody|.</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">- * @param uploadbody {Object}   Arbitrary object, which to use as</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+ * @param {Object} uploadBody - Arbitrary object, which to use as</span>
<a href="#l8.81"></a><span id="l8.81">  *   body of the HTTP request. Will also set the mimetype accordingly.</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">- *   Only supported object types, currently only E4X is supported</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+ *   Only supported object types, currently only JXON is supported</span>
<a href="#l8.84"></a><span id="l8.84">  *   (sending XML).</span>
<a href="#l8.85"></a><span id="l8.85">  *   Usually, you have nothing to upload, so just pass |null|.</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+ *   Only supported object types, currently supported:</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+ *   JXON -&gt; sending XML</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+ *   JS object -&gt; sending JSON</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+ *   string -&gt; sending text/plain</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+ *   If you want to override the body mimetype, set header Content-Type below.</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+ *   Usually, you have nothing to upload, so just leave it at |null|.</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+ *   Default |null|.</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+ * @param {boolean} allowCache (default true)</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+ * @param {string} username (default null = no authentication)</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+ * @param {string} password (default null = no authentication)</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+ * @param {boolean} allowAuthPrompt (default true)</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+ * @param {boolean} requireSecureAuth (default false)</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+ *   Ignore the username and password unless we are using https:</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+ *   This also applies to both https: to http: and http: to https: redirects.</span>
<a href="#l8.100"></a><span id="l8.100">  */</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineminus">-function FetchHTTP(url, urlArgs, post, successCallback, errorCallback) {</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+function FetchHTTP(url, args, successCallback, errorCallback) {</span>
<a href="#l8.103"></a><span id="l8.103">   assert(typeof(successCallback) == &quot;function&quot;, &quot;BUG: successCallback&quot;);</span>
<a href="#l8.104"></a><span id="l8.104">   assert(typeof(errorCallback) == &quot;function&quot;, &quot;BUG: errorCallback&quot;);</span>
<a href="#l8.105"></a><span id="l8.105">   this._url = sanitize.string(url);</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineminus">-  if (!urlArgs)</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineminus">-    urlArgs = {};</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+  if (!args) {</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+    args = {};</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+  }</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+  if (!args.urlArgs) {</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+    args.urlArgs = {};</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+  }</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+  if (!args.headers) {</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+    args.headers = {};</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+  }</span>
<a href="#l8.117"></a><span id="l8.117"> </span>
<a href="#l8.118"></a><span id="l8.118" class="difflineminus">-  this._urlArgs = urlArgs;</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-  this._post = sanitize.boolean(post);</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+  this._args = args;</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+  this._args.post = sanitize.boolean(args.post || false); // default false</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+  this._args.allowCache = &quot;allowCache&quot; in args ? sanitize.boolean(args.allowCache) : true; // default true</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+  this._args.allowAuthPrompt = sanitize.boolean(args.allowAuthPrompt || false); // default false</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+  this._args.requireSecureAuth = sanitize.boolean(args.requireSecureAuth || false); // default false</span>
<a href="#l8.125"></a><span id="l8.125">   this._successCallback = successCallback;</span>
<a href="#l8.126"></a><span id="l8.126">   this._errorCallback = errorCallback;</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+  this._logger = Log4Moz.getConfiguredLogger(&quot;mail.setup&quot;);</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+  this._logger.info(&quot;Requesting &lt;&quot; + url + &quot;&gt;&quot;);</span>
<a href="#l8.129"></a><span id="l8.129"> }</span>
<a href="#l8.130"></a><span id="l8.130"> FetchHTTP.prototype =</span>
<a href="#l8.131"></a><span id="l8.131"> {</span>
<a href="#l8.132"></a><span id="l8.132">   __proto__: Abortable.prototype,</span>
<a href="#l8.133"></a><span id="l8.133">   _url: null, // URL as passed to ctor, without arguments</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineminus">-  _urlArgs: null,</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineminus">-  _post: null,</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+  _args: null,</span>
<a href="#l8.137"></a><span id="l8.137">   _successCallback: null,</span>
<a href="#l8.138"></a><span id="l8.138">   _errorCallback: null,</span>
<a href="#l8.139"></a><span id="l8.139">   _request: null, // the XMLHttpRequest object</span>
<a href="#l8.140"></a><span id="l8.140">   result: null,</span>
<a href="#l8.141"></a><span id="l8.141"> </span>
<a href="#l8.142"></a><span id="l8.142">   start() {</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineminus">-    var url = this._url;</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineminus">-    for (var name in this._urlArgs) {</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+    let url = this._url;</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+    for (let name in this._args.urlArgs) {</span>
<a href="#l8.147"></a><span id="l8.147">       url += (!url.includes(&quot;?&quot;) ? &quot;?&quot; : &quot;&amp;&quot;) +</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineminus">-              name + &quot;=&quot; + encodeURIComponent(this._urlArgs[name]);</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+             name + &quot;=&quot; + encodeURIComponent(this._args.urlArgs[name]);</span>
<a href="#l8.150"></a><span id="l8.150">     }</span>
<a href="#l8.151"></a><span id="l8.151">     this._request = new XMLHttpRequest();</span>
<a href="#l8.152"></a><span id="l8.152">     let request = this._request;</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineminus">-    request.open(this._post ? &quot;POST&quot; : &quot;GET&quot;, url);</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+    request.mozBackgroundRequest = !this._args.allowAuthPrompt;</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+    let username = null, password = null;</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineplus">+    if (url.startsWith(&quot;https:&quot;) || !this._args.requireSecureAuth) {</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+      username = this._args.username;</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+      password = this._args.password;</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+    }</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+    request.open(this._args.post ? &quot;POST&quot; : &quot;GET&quot;, url, true, username, password);</span>
<a href="#l8.161"></a><span id="l8.161">     request.channel.loadGroup = null;</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineplus">+    request.timeout = 5000; // 5 seconds</span>
<a href="#l8.163"></a><span id="l8.163">     // needs bug 407190 patch v4 (or higher) - uncomment if that lands.</span>
<a href="#l8.164"></a><span id="l8.164">     // try {</span>
<a href="#l8.165"></a><span id="l8.165">     //    var channel = request.channel.QueryInterface(Ci.nsIHttpChannel2);</span>
<a href="#l8.166"></a><span id="l8.166">     //    channel.connectTimeout = 5;</span>
<a href="#l8.167"></a><span id="l8.167">     //    channel.requestTimeout = 5;</span>
<a href="#l8.168"></a><span id="l8.168">     //    } catch (e) { dump(e + &quot;\n&quot;); }</span>
<a href="#l8.169"></a><span id="l8.169"> </span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+    if (!this._args.allowCache) {</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+      // Disable Mozilla HTTP cache</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+      request.channel.loadFlags |= Ci.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+    }</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+    // body</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+    let mimetype = null;</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+    let body = this._args.uploadBody;</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+    if (typeof(body) == &quot;object&quot; &amp;&amp; &quot;nodeType&quot; in body) {</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineplus">+      // XML</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineplus">+      mimetype = &quot;text/xml; charset=UTF-8&quot;;</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineplus">+      body = new XMLSerializer().serializeToString(body);</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineplus">+    } else if (typeof(body) == &quot;object&quot;) {</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineplus">+      // JSON</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineplus">+      mimetype = &quot;text/json; charset=UTF-8&quot;;</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineplus">+      body = JSON.stringify(body);</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineplus">+    } else if (typeof(body) == &quot;string&quot;) {</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineplus">+      // Plaintext</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineplus">+      // You can override the mimetype with { headers: {&quot;Content-Type&quot; : &quot;text/foo&quot; } }</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineplus">+      mimetype = &quot;text/plain; charset=UTF-8&quot;;</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineplus">+      // body already set above</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineplus">+    } else if (this._args.bodyFormArgs) {</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineplus">+      mimetype = &quot;application/x-www-form-urlencoded; charset=UTF-8&quot;;</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineplus">+      body = &quot;&quot;;</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineplus">+      for (let name in this._args.bodyFormArgs) {</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineplus">+        body += (body ? &quot;&amp;&quot; : &quot;&quot;) + name + &quot;=&quot; +</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineplus">+            encodeURIComponent(this._args.bodyFormArgs[name]);</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineplus">+      }</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineplus">+    }</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineplus">+    if (body) {</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineplus">+      this._logger.info(&quot;with body:\n&quot; + body);</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineplus">+    }</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineplus">+</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineplus">+    // Headers</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineplus">+    if (mimetype &amp;&amp; !(&quot;Content-Type&quot; in this._args.headers)) {</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineplus">+      request.setRequestHeader(&quot;Content-Type&quot;, mimetype);</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineplus">+    }</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineplus">+    if (username &amp;&amp; password) {</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineplus">+      // workaround, because open(..., username, password) does not work.</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineplus">+      request.setRequestHeader(&quot;Authorization&quot;, &quot;Basic &quot; + btoa(username + &quot;:&quot; + password));</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineplus">+    }</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineplus">+    for (let name in this._args.headers) {</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineplus">+      request.setRequestHeader(name, this._args.headers[name]);</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineplus">+      if (name == &quot;Cookie&quot;) {</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineplus">+        // Websites are not allowed to set this, but chrome is.</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineplus">+        // Nevertheless, the cookie lib later overwrites our header.</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineplus">+        // request.channel.setCookie(this._args.headers[name]); -- crashes</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineplus">+        // So, deactivate that Firefox cookie lib.</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineplus">+        request.channel.loadFlags |= Ci.nsIRequest.LOAD_ANONYMOUS;</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineplus">+      }</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineplus">+    }</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineplus">+    this._logger.info(debugObject(this._args, &quot;args&quot;));</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineplus">+</span>
<a href="#l8.223"></a><span id="l8.223">     var me = this;</span>
<a href="#l8.224"></a><span id="l8.224">     request.onload = function() { me._response(true); };</span>
<a href="#l8.225"></a><span id="l8.225">     request.onerror = function() { me._response(false); };</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineminus">-    request.send(null);</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineplus">+    request.ontimeout = function() { me._response(false); };</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineplus">+    request.send(body);</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineplus">+    // Store the original stack so we can use it if there is an exception</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineplus">+    this._callStack = Error().stack;</span>
<a href="#l8.231"></a><span id="l8.231">   },</span>
<a href="#l8.232"></a><span id="l8.232">   _response(success, exStored) {</span>
<a href="#l8.233"></a><span id="l8.233">     try {</span>
<a href="#l8.234"></a><span id="l8.234">     var errorCode = null;</span>
<a href="#l8.235"></a><span id="l8.235">     var errorStr = null;</span>
<a href="#l8.236"></a><span id="l8.236"> </span>
<a href="#l8.237"></a><span id="l8.237">     if (success &amp;&amp; this._request.status &gt;= 200 &amp;&amp;</span>
<a href="#l8.238"></a><span id="l8.238">         this._request.status &lt; 300) { // HTTP level success</span>
<a href="#l8.239"></a><span id="l8.239">       try {</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineplus">+</span>
<a href="#l8.241"></a><span id="l8.241">         // response</span>
<a href="#l8.242"></a><span id="l8.242">         var mimetype = this._request.getResponseHeader(&quot;Content-Type&quot;);</span>
<a href="#l8.243"></a><span id="l8.243">         if (!mimetype)</span>
<a href="#l8.244"></a><span id="l8.244">           mimetype = &quot;&quot;;</span>
<a href="#l8.245"></a><span id="l8.245">         mimetype = mimetype.split(&quot;;&quot;)[0];</span>
<a href="#l8.246"></a><span id="l8.246">         if (mimetype == &quot;text/xml&quot; ||</span>
<a href="#l8.247"></a><span id="l8.247">             mimetype == &quot;application/xml&quot; ||</span>
<a href="#l8.248"></a><span id="l8.248">             mimetype == &quot;text/rdf&quot;) {</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineplus">+          // XML</span>
<a href="#l8.250"></a><span id="l8.250">           this.result = JXON.build(this._request.responseXML);</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineplus">+        } else if (mimetype == &quot;text/json&quot; ||</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineplus">+                   mimetype == &quot;application/json&quot;) {</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineplus">+          // JSON</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineplus">+          this.result = JSON.parse(this._request.responseText);</span>
<a href="#l8.255"></a><span id="l8.255">         } else {</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineplus">+          // Plaintext (fallback)</span>
<a href="#l8.257"></a><span id="l8.257">           // ddump(&quot;mimetype: &quot; + mimetype + &quot; only supported as text&quot;);</span>
<a href="#l8.258"></a><span id="l8.258">           this.result = this._request.responseText;</span>
<a href="#l8.259"></a><span id="l8.259">         }</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineminus">-        // ddump(&quot;result:\n&quot; + this.result);</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineplus">+</span>
<a href="#l8.262"></a><span id="l8.262">       } catch (e) {</span>
<a href="#l8.263"></a><span id="l8.263">         success = false;</span>
<a href="#l8.264"></a><span id="l8.264">         errorStr = getStringBundle(</span>
<a href="#l8.265"></a><span id="l8.265">                    &quot;chrome://messenger/locale/accountCreationUtil.properties&quot;)</span>
<a href="#l8.266"></a><span id="l8.266">                    .GetStringFromName(&quot;bad_response_content.error&quot;);</span>
<a href="#l8.267"></a><span id="l8.267">         errorCode = -4;</span>
<a href="#l8.268"></a><span id="l8.268">       }</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineplus">+    } else if (this._args.username &amp;&amp;</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineplus">+               this._request.responseURL.replace(/\/\/.*@/, &quot;//&quot;) != this._url &amp;&amp;</span>
<a href="#l8.271"></a><span id="l8.271" class="difflineplus">+               this._request.responseURL.startsWith(this._args.requireSecureAuth ? &quot;https&quot; : &quot;http&quot;) &amp;&amp;</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineplus">+               !this._isRetry) {</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineplus">+      // Redirects lack auth, see &lt;https://stackoverflow.com/a/28411170&gt;</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineplus">+      this._logger.info(&quot;Call to &lt;&quot; + this._url + &quot;&gt; was redirected to &lt;&quot; + this._request.responseURL + &quot;&gt;, and failed. Re-trying the new URL with authentication again.&quot;);</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineplus">+      this._url = this._request.responseURL;</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineplus">+      this._isRetry = true;</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineplus">+      this.start();</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineplus">+      return;</span>
<a href="#l8.279"></a><span id="l8.279">     } else {</span>
<a href="#l8.280"></a><span id="l8.280">       success = false;</span>
<a href="#l8.281"></a><span id="l8.281">       try {</span>
<a href="#l8.282"></a><span id="l8.282">         errorCode = this._request.status;</span>
<a href="#l8.283"></a><span id="l8.283">         errorStr = this._request.statusText;</span>
<a href="#l8.284"></a><span id="l8.284">       } catch (e) {</span>
<a href="#l8.285"></a><span id="l8.285">         // If we can't resolve the hostname in DNS etc., .statusText throws</span>
<a href="#l8.286"></a><span id="l8.286">         errorCode = -2;</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineat">@@ -159,30 +261,33 @@ FetchHTTP.prototype =</span>
<a href="#l8.288"></a><span id="l8.288">     }</span>
<a href="#l8.289"></a><span id="l8.289"> </span>
<a href="#l8.290"></a><span id="l8.290">     // Callbacks</span>
<a href="#l8.291"></a><span id="l8.291">     if (success) {</span>
<a href="#l8.292"></a><span id="l8.292">       try {</span>
<a href="#l8.293"></a><span id="l8.293">         this._successCallback(this.result);</span>
<a href="#l8.294"></a><span id="l8.294">       } catch (e) {</span>
<a href="#l8.295"></a><span id="l8.295">         logException(e);</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineplus">+        e.stack = this._callStack;</span>
<a href="#l8.297"></a><span id="l8.297">         this._error(e);</span>
<a href="#l8.298"></a><span id="l8.298">       }</span>
<a href="#l8.299"></a><span id="l8.299">     } else if (exStored) {</span>
<a href="#l8.300"></a><span id="l8.300">       this._error(exStored);</span>
<a href="#l8.301"></a><span id="l8.301">     } else {</span>
<a href="#l8.302"></a><span id="l8.302" class="difflineminus">-      this._error(new ServerException(errorStr, errorCode, this._url));</span>
<a href="#l8.303"></a><span id="l8.303" class="difflineplus">+      // Put the caller's stack into the exception</span>
<a href="#l8.304"></a><span id="l8.304" class="difflineplus">+      let e = new ServerException(errorStr, errorCode, this._url);</span>
<a href="#l8.305"></a><span id="l8.305" class="difflineplus">+      e.stack = this._callStack;</span>
<a href="#l8.306"></a><span id="l8.306" class="difflineplus">+      this._error(e);</span>
<a href="#l8.307"></a><span id="l8.307">     }</span>
<a href="#l8.308"></a><span id="l8.308"> </span>
<a href="#l8.309"></a><span id="l8.309">     if (this._finishedCallback) {</span>
<a href="#l8.310"></a><span id="l8.310">       try {</span>
<a href="#l8.311"></a><span id="l8.311">         this._finishedCallback(this);</span>
<a href="#l8.312"></a><span id="l8.312">       } catch (e) {</span>
<a href="#l8.313"></a><span id="l8.313">         logException(e);</span>
<a href="#l8.314"></a><span id="l8.314" class="difflineminus">-        this._error(e);</span>
<a href="#l8.315"></a><span id="l8.315">       }</span>
<a href="#l8.316"></a><span id="l8.316">     }</span>
<a href="#l8.317"></a><span id="l8.317"> </span>
<a href="#l8.318"></a><span id="l8.318">     } catch (e) {</span>
<a href="#l8.319"></a><span id="l8.319">       // error in our fetchhttp._response() code</span>
<a href="#l8.320"></a><span id="l8.320">       logException(e);</span>
<a href="#l8.321"></a><span id="l8.321">       this._error(e);</span>
<a href="#l8.322"></a><span id="l8.322">     }</span>
<a href="#l8.323"></a><span id="l8.323" class="difflineat">@@ -236,9 +341,8 @@ UserCancelledException.prototype.constru</span>
<a href="#l8.324"></a><span id="l8.324"> </span>
<a href="#l8.325"></a><span id="l8.325"> function ServerException(msg, code, uri) {</span>
<a href="#l8.326"></a><span id="l8.326">   Exception.call(this, msg);</span>
<a href="#l8.327"></a><span id="l8.327">   this.code = code;</span>
<a href="#l8.328"></a><span id="l8.328">   this.uri = uri;</span>
<a href="#l8.329"></a><span id="l8.329"> }</span>
<a href="#l8.330"></a><span id="l8.330"> ServerException.prototype = Object.create(Exception.prototype);</span>
<a href="#l8.331"></a><span id="l8.331"> ServerException.prototype.constructor = ServerException;</span>
<a href="#l8.332"></a><span id="l8.332" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/components/accountcreation/content/guessConfig.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/components/accountcreation/content/guessConfig.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -57,27 +57,31 @@ function guessConfig(domain, progressCal</span>
<a href="#l9.4"></a><span id="l9.4">                      resultConfig, which) {</span>
<a href="#l9.5"></a><span id="l9.5">   assert(typeof(progressCallback) == &quot;function&quot;, &quot;need progressCallback&quot;);</span>
<a href="#l9.6"></a><span id="l9.6">   assert(typeof(successCallback) == &quot;function&quot;, &quot;need successCallback&quot;);</span>
<a href="#l9.7"></a><span id="l9.7">   assert(typeof(errorCallback) == &quot;function&quot;, &quot;need errorCallback&quot;);</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9">   // Servers that we know enough that they support OAuth2 do not need guessing.</span>
<a href="#l9.10"></a><span id="l9.10">   if (resultConfig.incoming.auth == Ci.nsMsgAuthMethod.OAuth2) {</span>
<a href="#l9.11"></a><span id="l9.11">     successCallback(resultConfig);</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-    return null;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+    return new Abortable();</span>
<a href="#l9.14"></a><span id="l9.14">   }</span>
<a href="#l9.15"></a><span id="l9.15"> </span>
<a href="#l9.16"></a><span id="l9.16">   if (!resultConfig)</span>
<a href="#l9.17"></a><span id="l9.17">     resultConfig = new AccountConfig();</span>
<a href="#l9.18"></a><span id="l9.18">   resultConfig.source = AccountConfig.kSourceGuess;</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+  if (!which) {</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+    which = &quot;both&quot;;</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+  }</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+</span>
<a href="#l9.24"></a><span id="l9.24">   if (!Services.prefs.getBoolPref(</span>
<a href="#l9.25"></a><span id="l9.25">       &quot;mailnews.auto_config.guess.enabled&quot;)) {</span>
<a href="#l9.26"></a><span id="l9.26">     errorCallback(&quot;Guessing config disabled per user preference&quot;);</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-    return null;</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+    return new Abortable();</span>
<a href="#l9.29"></a><span id="l9.29">   }</span>
<a href="#l9.30"></a><span id="l9.30"> </span>
<a href="#l9.31"></a><span id="l9.31">   var incomingHostDetector = null;</span>
<a href="#l9.32"></a><span id="l9.32">   var outgoingHostDetector = null;</span>
<a href="#l9.33"></a><span id="l9.33">   var incomingEx = null; // if incoming had error, store ex here</span>
<a href="#l9.34"></a><span id="l9.34">   var outgoingEx = null; // if incoming had error, store ex here</span>
<a href="#l9.35"></a><span id="l9.35">   var incomingDone = (which == &quot;outgoing&quot;);</span>
<a href="#l9.36"></a><span id="l9.36">   var outgoingDone = (which == &quot;incoming&quot;);</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineat">@@ -100,17 +104,17 @@ function guessConfig(domain, progressCal</span>
<a href="#l9.38"></a><span id="l9.38">       hostname: &quot;mail.&quot; + domain,</span>
<a href="#l9.39"></a><span id="l9.39">       username: resultConfig.identity.emailAddress,</span>
<a href="#l9.40"></a><span id="l9.40">       type: &quot;pop3&quot;,</span>
<a href="#l9.41"></a><span id="l9.41">       port: 110,</span>
<a href="#l9.42"></a><span id="l9.42">       socketType: 3,</span>
<a href="#l9.43"></a><span id="l9.43">       auth: Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l9.44"></a><span id="l9.44">     });</span>
<a href="#l9.45"></a><span id="l9.45">     successCallback(resultConfig);</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-    return null;</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+    return new Abortable();</span>
<a href="#l9.48"></a><span id="l9.48">   }</span>
<a href="#l9.49"></a><span id="l9.49">   var progress = function(thisTry) {</span>
<a href="#l9.50"></a><span id="l9.50">     progressCallback(protocolToString(thisTry.protocol), thisTry.hostname,</span>
<a href="#l9.51"></a><span id="l9.51">                      thisTry.port, sslConvertToSocketType(thisTry.ssl), false,</span>
<a href="#l9.52"></a><span id="l9.52">                      resultConfig);</span>
<a href="#l9.53"></a><span id="l9.53">   };</span>
<a href="#l9.54"></a><span id="l9.54"> </span>
<a href="#l9.55"></a><span id="l9.55">   var updateConfig = function(config) {</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineat">@@ -143,17 +147,17 @@ function guessConfig(domain, progressCal</span>
<a href="#l9.57"></a><span id="l9.57">         try {</span>
<a href="#l9.58"></a><span id="l9.58">           errorCallback(e);</span>
<a href="#l9.59"></a><span id="l9.59">         } catch (e) { errorInCallback(e); }</span>
<a href="#l9.60"></a><span id="l9.60">       }</span>
<a href="#l9.61"></a><span id="l9.61"> </span>
<a href="#l9.62"></a><span id="l9.62">     }</span>
<a href="#l9.63"></a><span id="l9.63">   };</span>
<a href="#l9.64"></a><span id="l9.64"> </span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-  var logger = Log4Moz.getConfiguredLogger(&quot;mail.wizard&quot;);</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+  var logger = Log4Moz.getConfiguredLogger(&quot;mail.setup&quot;);</span>
<a href="#l9.67"></a><span id="l9.67">   var HostTryToAccountServer = function(thisTry, server) {</span>
<a href="#l9.68"></a><span id="l9.68">     server.type = protocolToString(thisTry.protocol);</span>
<a href="#l9.69"></a><span id="l9.69">     server.hostname = thisTry.hostname;</span>
<a href="#l9.70"></a><span id="l9.70">     server.port = thisTry.port;</span>
<a href="#l9.71"></a><span id="l9.71">     server.socketType = sslConvertToSocketType(thisTry.ssl);</span>
<a href="#l9.72"></a><span id="l9.72">     server.auth = chooseBestAuthMethod(thisTry.authMethods);</span>
<a href="#l9.73"></a><span id="l9.73">     server.authAlternatives = thisTry.authMethods;</span>
<a href="#l9.74"></a><span id="l9.74">     // TODO</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/components/accountcreation/content/readFromXML.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/components/accountcreation/content/readFromXML.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1,30 +1,30 @@</span>
<a href="#l10.4"></a><span id="l10.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l10.5"></a><span id="l10.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.6"></a><span id="l10.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.7"></a><span id="l10.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/hostnameUtils.jsm&quot;);</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+/* eslint-disable complexity */</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+</span>
<a href="#l10.12"></a><span id="l10.12"> /**</span>
<a href="#l10.13"></a><span id="l10.13">  * Takes an XML snipplet (as JXON) and reads the values into</span>
<a href="#l10.14"></a><span id="l10.14">  * a new AccountConfig object.</span>
<a href="#l10.15"></a><span id="l10.15">  * It does so securely (or tries to), by trying to avoid remote execution</span>
<a href="#l10.16"></a><span id="l10.16">  * and similar holes which can appear when reading too naively.</span>
<a href="#l10.17"></a><span id="l10.17">  * Of course it cannot tell whether the actual values are correct,</span>
<a href="#l10.18"></a><span id="l10.18">  * e.g. it can't tell whether the host name is a good server.</span>
<a href="#l10.19"></a><span id="l10.19">  *</span>
<a href="#l10.20"></a><span id="l10.20">  * The XML format is documented at</span>
<a href="#l10.21"></a><span id="l10.21">  * &lt;https://wiki.mozilla.org/Thunderbird:Autoconfiguration:ConfigFileFormat&gt;</span>
<a href="#l10.22"></a><span id="l10.22">  *</span>
<a href="#l10.23"></a><span id="l10.23">  * @param clientConfigXML {JXON}  The &lt;clientConfig&gt; node.</span>
<a href="#l10.24"></a><span id="l10.24">  * @return AccountConfig   object filled with the data from XML</span>
<a href="#l10.25"></a><span id="l10.25">  */</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/hostnameUtils.jsm&quot;);</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-/* eslint-disable complexity */</span>
<a href="#l10.29"></a><span id="l10.29"> function readFromXML(clientConfigXML) {</span>
<a href="#l10.30"></a><span id="l10.30">   function array_or_undef(value) {</span>
<a href="#l10.31"></a><span id="l10.31">     return value === undefined ? [] : value;</span>
<a href="#l10.32"></a><span id="l10.32">   }</span>
<a href="#l10.33"></a><span id="l10.33">   var exception;</span>
<a href="#l10.34"></a><span id="l10.34">   if (typeof(clientConfigXML) != &quot;object&quot; ||</span>
<a href="#l10.35"></a><span id="l10.35">       !(&quot;clientConfig&quot; in clientConfigXML) ||</span>
<a href="#l10.36"></a><span id="l10.36">       !(&quot;emailProvider&quot; in clientConfigXML.clientConfig)) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/components/accountcreation/content/util.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/components/accountcreation/content/util.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -3,49 +3,53 @@</span>
<a href="#l11.4"></a><span id="l11.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.5"></a><span id="l11.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.6"></a><span id="l11.6"> /**</span>
<a href="#l11.7"></a><span id="l11.7">  * Some common, generic functions</span>
<a href="#l11.8"></a><span id="l11.8">  */</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10"> ChromeUtils.import(&quot;resource:///modules/errUtils.js&quot;);</span>
<a href="#l11.11"></a><span id="l11.11"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+/* eslint-disable spaced-comment */</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+/////////////////////////////////////////</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+// Low level, basic functions</span>
<a href="#l11.17"></a><span id="l11.17"> </span>
<a href="#l11.18"></a><span id="l11.18"> function assert(test, errorMsg) {</span>
<a href="#l11.19"></a><span id="l11.19">   if (!test)</span>
<a href="#l11.20"></a><span id="l11.20">     throw new NotReached(errorMsg ? errorMsg :</span>
<a href="#l11.21"></a><span id="l11.21">           &quot;Programming bug. Assertion failed, see log.&quot;);</span>
<a href="#l11.22"></a><span id="l11.22"> }</span>
<a href="#l11.23"></a><span id="l11.23"> </span>
<a href="#l11.24"></a><span id="l11.24"> function makeCallback(obj, func) {</span>
<a href="#l11.25"></a><span id="l11.25">   return func.bind(obj);</span>
<a href="#l11.26"></a><span id="l11.26"> }</span>
<a href="#l11.27"></a><span id="l11.27"> </span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-</span>
<a href="#l11.29"></a><span id="l11.29"> /**</span>
<a href="#l11.30"></a><span id="l11.30">  * Runs the given function sometime later</span>
<a href="#l11.31"></a><span id="l11.31">  *</span>
<a href="#l11.32"></a><span id="l11.32">  * Currently implemented using setTimeout(), but</span>
<a href="#l11.33"></a><span id="l11.33">  * can later be replaced with an nsITimer impl,</span>
<a href="#l11.34"></a><span id="l11.34">  * when code wants to use it in a module.</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+ *</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+ * @see |TimeoutAbortable|</span>
<a href="#l11.37"></a><span id="l11.37">  */</span>
<a href="#l11.38"></a><span id="l11.38"> function runAsync(func) {</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-  setTimeout(func, 0);</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+  return setTimeout(func, 0);</span>
<a href="#l11.41"></a><span id="l11.41"> }</span>
<a href="#l11.42"></a><span id="l11.42"> </span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-</span>
<a href="#l11.44"></a><span id="l11.44"> /**</span>
<a href="#l11.45"></a><span id="l11.45">  * @param uriStr {String}</span>
<a href="#l11.46"></a><span id="l11.46">  * @result {nsIURI}</span>
<a href="#l11.47"></a><span id="l11.47">  */</span>
<a href="#l11.48"></a><span id="l11.48"> function makeNSIURI(uriStr) {</span>
<a href="#l11.49"></a><span id="l11.49">   return Services.io.newURI(uriStr);</span>
<a href="#l11.50"></a><span id="l11.50"> }</span>
<a href="#l11.51"></a><span id="l11.51"> </span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-</span>
<a href="#l11.53"></a><span id="l11.53"> /**</span>
<a href="#l11.54"></a><span id="l11.54">  * Reads UTF8 data from a URL.</span>
<a href="#l11.55"></a><span id="l11.55">  *</span>
<a href="#l11.56"></a><span id="l11.56">  * @param uri {nsIURI}   what you want to read</span>
<a href="#l11.57"></a><span id="l11.57">  * @return {Array of String}   the contents of the file, one string per line</span>
<a href="#l11.58"></a><span id="l11.58">  */</span>
<a href="#l11.59"></a><span id="l11.59"> function readURLasUTF8(uri) {</span>
<a href="#l11.60"></a><span id="l11.60">   assert(uri instanceof Ci.nsIURI, &quot;uri must be an nsIURI&quot;);</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineat">@@ -105,16 +109,19 @@ function getStringBundle(bundleURI) {</span>
<a href="#l11.62"></a><span id="l11.62">     return Services.strings.createBundle(bundleURI);</span>
<a href="#l11.63"></a><span id="l11.63">   } catch (e) {</span>
<a href="#l11.64"></a><span id="l11.64">     throw new Exception(&quot;Failed to get stringbundle URI &lt;&quot; + bundleURI +</span>
<a href="#l11.65"></a><span id="l11.65">                         &quot;&gt;. Error: &quot; + e);</span>
<a href="#l11.66"></a><span id="l11.66">   }</span>
<a href="#l11.67"></a><span id="l11.67"> }</span>
<a href="#l11.68"></a><span id="l11.68"> </span>
<a href="#l11.69"></a><span id="l11.69"> </span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+/////////////////////////////////////////</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+// Exception</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+</span>
<a href="#l11.73"></a><span id="l11.73"> function Exception(msg) {</span>
<a href="#l11.74"></a><span id="l11.74">   this._message = msg;</span>
<a href="#l11.75"></a><span id="l11.75">   this.stack = Components.stack.formattedStack;</span>
<a href="#l11.76"></a><span id="l11.76"> }</span>
<a href="#l11.77"></a><span id="l11.77"> Exception.prototype =</span>
<a href="#l11.78"></a><span id="l11.78"> {</span>
<a href="#l11.79"></a><span id="l11.79">   get message() {</span>
<a href="#l11.80"></a><span id="l11.80">     return this._message;</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineat">@@ -127,75 +134,426 @@ Exception.prototype =</span>
<a href="#l11.82"></a><span id="l11.82"> function NotReached(msg) {</span>
<a href="#l11.83"></a><span id="l11.83">   Exception.call(this, msg); // call super constructor</span>
<a href="#l11.84"></a><span id="l11.84">   logException(this);</span>
<a href="#l11.85"></a><span id="l11.85"> }</span>
<a href="#l11.86"></a><span id="l11.86"> // Make NotReached extend Exception.</span>
<a href="#l11.87"></a><span id="l11.87"> NotReached.prototype = Object.create(Exception.prototype);</span>
<a href="#l11.88"></a><span id="l11.88"> NotReached.prototype.constructor = NotReached;</span>
<a href="#l11.89"></a><span id="l11.89"> </span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+/////////////////////////////////////////</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+// Abortable</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+</span>
<a href="#l11.94"></a><span id="l11.94"> /**</span>
<a href="#l11.95"></a><span id="l11.95">  * A handle for an async function which you can cancel.</span>
<a href="#l11.96"></a><span id="l11.96">  * The async function will return an object of this type (a subtype)</span>
<a href="#l11.97"></a><span id="l11.97">  * and you can call cancel() when you feel like killing the function.</span>
<a href="#l11.98"></a><span id="l11.98">  */</span>
<a href="#l11.99"></a><span id="l11.99"> function Abortable() {</span>
<a href="#l11.100"></a><span id="l11.100"> }</span>
<a href="#l11.101"></a><span id="l11.101"> Abortable.prototype =</span>
<a href="#l11.102"></a><span id="l11.102"> {</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-  cancel() {</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+  cancel(e) {</span>
<a href="#l11.105"></a><span id="l11.105">   },</span>
<a href="#l11.106"></a><span id="l11.106"> };</span>
<a href="#l11.107"></a><span id="l11.107"> </span>
<a href="#l11.108"></a><span id="l11.108" class="difflineplus">+function CancelledException(msg) {</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineplus">+  Exception.call(this, msg);</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+}</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineplus">+CancelledException.prototype = Object.create(Exception.prototype);</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineplus">+CancelledException.prototype.constructor = CancelledException;</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+</span>
<a href="#l11.114"></a><span id="l11.114"> /**</span>
<a href="#l11.115"></a><span id="l11.115">  * Utility implementation, for allowing to abort a setTimeout.</span>
<a href="#l11.116"></a><span id="l11.116">  * Use like: return new TimeoutAbortable(setTimeout(function(){ ... }, 0));</span>
<a href="#l11.117"></a><span id="l11.117">  * @param setTimeoutID {Integer}  Return value of setTimeout()</span>
<a href="#l11.118"></a><span id="l11.118">  */</span>
<a href="#l11.119"></a><span id="l11.119"> function TimeoutAbortable(setTimeoutID) {</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineminus">-  Abortable.call(this, setTimeoutID); // call super constructor</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineplus">+  Abortable.call(this); // call super constructor</span>
<a href="#l11.122"></a><span id="l11.122">   this._id = setTimeoutID;</span>
<a href="#l11.123"></a><span id="l11.123"> }</span>
<a href="#l11.124"></a><span id="l11.124"> TimeoutAbortable.prototype = Object.create(Abortable.prototype);</span>
<a href="#l11.125"></a><span id="l11.125"> TimeoutAbortable.prototype.constructor = TimeoutAbortable;</span>
<a href="#l11.126"></a><span id="l11.126"> TimeoutAbortable.prototype.cancel = function() { clearTimeout(this._id); };</span>
<a href="#l11.127"></a><span id="l11.127"> </span>
<a href="#l11.128"></a><span id="l11.128"> /**</span>
<a href="#l11.129"></a><span id="l11.129">  * Utility implementation, for allowing to abort a setTimeout.</span>
<a href="#l11.130"></a><span id="l11.130">  * Use like: return new TimeoutAbortable(setTimeout(function(){ ... }, 0));</span>
<a href="#l11.131"></a><span id="l11.131">  * @param setIntervalID {Integer}  Return value of setInterval()</span>
<a href="#l11.132"></a><span id="l11.132">  */</span>
<a href="#l11.133"></a><span id="l11.133"> function IntervalAbortable(setIntervalID) {</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineminus">-  Abortable.call(this, setIntervalID); // call super constructor</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineplus">+  Abortable.call(this); // call super constructor</span>
<a href="#l11.136"></a><span id="l11.136">   this._id = setIntervalID;</span>
<a href="#l11.137"></a><span id="l11.137"> }</span>
<a href="#l11.138"></a><span id="l11.138"> IntervalAbortable.prototype = Object.create(Abortable.prototype);</span>
<a href="#l11.139"></a><span id="l11.139"> IntervalAbortable.prototype.constructor = IntervalAbortable;</span>
<a href="#l11.140"></a><span id="l11.140"> IntervalAbortable.prototype.cancel = function() { clearInterval(this._id); };</span>
<a href="#l11.141"></a><span id="l11.141"> </span>
<a href="#l11.142"></a><span id="l11.142" class="difflineminus">-// Allows you to make several network calls, but return</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineminus">-// only one Abortable object.</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineplus">+/**</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineplus">+ * Allows you to make several network calls,</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineplus">+ * but return only one |Abortable| object.</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineplus">+ */</span>
<a href="#l11.148"></a><span id="l11.148"> function SuccessiveAbortable() {</span>
<a href="#l11.149"></a><span id="l11.149">   Abortable.call(this); // call super constructor</span>
<a href="#l11.150"></a><span id="l11.150">   this._current = null;</span>
<a href="#l11.151"></a><span id="l11.151"> }</span>
<a href="#l11.152"></a><span id="l11.152"> SuccessiveAbortable.prototype = {</span>
<a href="#l11.153"></a><span id="l11.153">   __proto__: Abortable.prototype,</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineminus">-  get current() { return this._current; },</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineplus">+  get current() {</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineplus">+    return this._current;</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineplus">+  },</span>
<a href="#l11.158"></a><span id="l11.158">   set current(abortable) {</span>
<a href="#l11.159"></a><span id="l11.159">     assert(abortable instanceof Abortable || abortable == null,</span>
<a href="#l11.160"></a><span id="l11.160">         &quot;need an Abortable object (or null)&quot;);</span>
<a href="#l11.161"></a><span id="l11.161">     this._current = abortable;</span>
<a href="#l11.162"></a><span id="l11.162">   },</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineminus">-  cancel() {</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineminus">-    if (this._current)</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineminus">-      this._current.cancel();</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineplus">+  cancel(e) {</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineplus">+    if (this._current) {</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineplus">+      this._current.cancel(e);</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineplus">+    }</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineplus">+  },</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineplus">+};</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineplus">+</span>
<a href="#l11.173"></a><span id="l11.173" class="difflineplus">+/**</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineplus">+ * Allows you to make several network calls in parallel.</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineplus">+ */</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineplus">+function ParallelAbortable() {</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineplus">+  Abortable.call(this); // call super constructor</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineplus">+  // { Array of ParallelCall }</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineplus">+  this._calls = [];</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineplus">+  // { Array of Function }</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineplus">+  this._finishedObservers = [];</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineplus">+}</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineplus">+ParallelAbortable.prototype = {</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineplus">+  __proto__: Abortable.prototype,</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineplus">+  /**</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineplus">+   * @returns {Array of ParallelCall}</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineplus">+   */</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineplus">+  get results() {</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineplus">+    return this._calls;</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineplus">+  },</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineplus">+  /**</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineplus">+   * @returns {ParallelCall}</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineplus">+   */</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineplus">+  addCall() {</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineplus">+    let call = new ParallelCall(this);</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineplus">+    call.position = this._calls.length;</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineplus">+    this._calls.push(call);</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineplus">+    return call;</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineplus">+  },</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineplus">+  /**</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineplus">+   * Observers will be called once one of the functions</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineplus">+   * finishes, i.e. returns successfully or fails.</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineplus">+   * @param {Function({ParallelCall} call)} func</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineplus">+   */</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineplus">+  addOneFinishedObserver(func) {</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineplus">+    assert(typeof(func) == &quot;function&quot;);</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineplus">+    this._finishedObservers.push(func);</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineplus">+  },</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineplus">+  /**</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineplus">+   * Will be called once *all* of the functions finished,</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineplus">+   * It gives you a list of all functions that succeeded or failed,</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineplus">+   * respectively.</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineplus">+   * @param {Function(</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineplus">+   *    {Array of ParallelCall} succeeded,</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineplus">+   *    {Array of ParallelCall} failed</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineplus">+   *   )} func</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineplus">+   */</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineplus">+  addAllFinishedObserver(func) {</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineplus">+    assert(typeof(func) == &quot;function&quot;);</span>
<a href="#l11.220"></a><span id="l11.220" class="difflineplus">+    this.addOneFinishedObserver(() =&gt; {</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineplus">+      if (this._calls.some(call =&gt; !call.finished)) {</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineplus">+        return;</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineplus">+      }</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineplus">+      let succeeded = this._calls.filter(call =&gt; call.succeeded);</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineplus">+      let failed = this._calls.filter(call =&gt; !call.succeeded);</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineplus">+      func(succeeded, failed);</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineplus">+    });</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineplus">+  },</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineplus">+  _notifyFinished(call) {</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineplus">+    for (let observer of this._finishedObservers) {</span>
<a href="#l11.231"></a><span id="l11.231" class="difflineplus">+      try {</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineplus">+        observer(call);</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineplus">+      } catch (e) {</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineplus">+        console.error(e);</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineplus">+      }</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineplus">+    }</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineplus">+  },</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineplus">+  cancel(e) {</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineplus">+    for (let call of this._calls) {</span>
<a href="#l11.240"></a><span id="l11.240" class="difflineplus">+      if (!call.finished &amp;&amp; call.callerAbortable) {</span>
<a href="#l11.241"></a><span id="l11.241" class="difflineplus">+        call.callerAbortable.cancel(e);</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineplus">+      }</span>
<a href="#l11.243"></a><span id="l11.243" class="difflineplus">+    }</span>
<a href="#l11.244"></a><span id="l11.244" class="difflineplus">+  },</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineplus">+};</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineplus">+</span>
<a href="#l11.247"></a><span id="l11.247" class="difflineplus">+/**</span>
<a href="#l11.248"></a><span id="l11.248" class="difflineplus">+ * Returned by ParallelAbortable.addCall().</span>
<a href="#l11.249"></a><span id="l11.249" class="difflineplus">+ * Do not create this object directly</span>
<a href="#l11.250"></a><span id="l11.250" class="difflineplus">+ * @param {ParallelAbortable} parallelAbortable - The controlling ParallelAbortable</span>
<a href="#l11.251"></a><span id="l11.251" class="difflineplus">+ */</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineplus">+function ParallelCall(parallelAbortable) {</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineplus">+  assert(parallelAbortable instanceof ParallelAbortable);</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineplus">+  // {ParallelAbortable} the parent</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineplus">+  this._parallelAbortable = parallelAbortable;</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineplus">+  // {Abortable} Abortable of the caller function that should run in parallel</span>
<a href="#l11.257"></a><span id="l11.257" class="difflineplus">+  this.callerAbortable = null;</span>
<a href="#l11.258"></a><span id="l11.258" class="difflineplus">+  // {Integer} the order in which the function was added, and its priority</span>
<a href="#l11.259"></a><span id="l11.259" class="difflineplus">+  this.position = null;</span>
<a href="#l11.260"></a><span id="l11.260" class="difflineplus">+  // {boolean} false = running, pending, false = success or failure</span>
<a href="#l11.261"></a><span id="l11.261" class="difflineplus">+  this.finished = false;</span>
<a href="#l11.262"></a><span id="l11.262" class="difflineplus">+  // {boolean} if finished: true = returned with success, false = returned with error</span>
<a href="#l11.263"></a><span id="l11.263" class="difflineplus">+  this.succeeded = false;</span>
<a href="#l11.264"></a><span id="l11.264" class="difflineplus">+  // {Exception} if failed: the error or exception that the caller function returned</span>
<a href="#l11.265"></a><span id="l11.265" class="difflineplus">+  this.e = null;</span>
<a href="#l11.266"></a><span id="l11.266" class="difflineplus">+  // {Object} if succeeded: the result of the caller function</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineplus">+  this.result = null;</span>
<a href="#l11.268"></a><span id="l11.268" class="difflineplus">+</span>
<a href="#l11.269"></a><span id="l11.269" class="difflineplus">+  this._time = Date.now();</span>
<a href="#l11.270"></a><span id="l11.270" class="difflineplus">+}</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineplus">+ParallelCall.prototype = {</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineplus">+  /**</span>
<a href="#l11.273"></a><span id="l11.273" class="difflineplus">+   * Returns a successCallback(result) function that you pass</span>
<a href="#l11.274"></a><span id="l11.274" class="difflineplus">+   * to your function that runs in parallel.</span>
<a href="#l11.275"></a><span id="l11.275" class="difflineplus">+   * @returns {Function(result)} successCallback</span>
<a href="#l11.276"></a><span id="l11.276" class="difflineplus">+   */</span>
<a href="#l11.277"></a><span id="l11.277" class="difflineplus">+  successCallback() {</span>
<a href="#l11.278"></a><span id="l11.278" class="difflineplus">+    return result =&gt; {</span>
<a href="#l11.279"></a><span id="l11.279" class="difflineplus">+      ddump(&quot;call &quot; + this.position + &quot; took &quot; + (Date.now() - this._time) + &quot;ms and succeeded&quot; +</span>
<a href="#l11.280"></a><span id="l11.280" class="difflineplus">+          (this.callerAbortable &amp;&amp; this.callerAbortable._url ? &quot; at &lt;&quot; + this.callerAbortable._url + &quot;&gt;&quot; : &quot;&quot;));</span>
<a href="#l11.281"></a><span id="l11.281" class="difflineplus">+      this.result = result;</span>
<a href="#l11.282"></a><span id="l11.282" class="difflineplus">+      this.finished = true;</span>
<a href="#l11.283"></a><span id="l11.283" class="difflineplus">+      this.succeeded = true;</span>
<a href="#l11.284"></a><span id="l11.284" class="difflineplus">+      this._parallelAbortable._notifyFinished(this);</span>
<a href="#l11.285"></a><span id="l11.285" class="difflineplus">+    };</span>
<a href="#l11.286"></a><span id="l11.286" class="difflineplus">+  },</span>
<a href="#l11.287"></a><span id="l11.287" class="difflineplus">+  /**</span>
<a href="#l11.288"></a><span id="l11.288" class="difflineplus">+   * Returns an errorCallback(e) function that you pass</span>
<a href="#l11.289"></a><span id="l11.289" class="difflineplus">+   * to your function that runs in parallel.</span>
<a href="#l11.290"></a><span id="l11.290" class="difflineplus">+   * @returns {Function(e)} errorCallback</span>
<a href="#l11.291"></a><span id="l11.291" class="difflineplus">+   */</span>
<a href="#l11.292"></a><span id="l11.292" class="difflineplus">+  errorCallback() {</span>
<a href="#l11.293"></a><span id="l11.293" class="difflineplus">+    return e =&gt; {</span>
<a href="#l11.294"></a><span id="l11.294" class="difflineplus">+      ddump(&quot;call &quot; + this.position + &quot; took &quot; + (Date.now() - this._time) + &quot;ms and failed with &quot; + e +</span>
<a href="#l11.295"></a><span id="l11.295" class="difflineplus">+          (this.callerAbortable &amp;&amp; this.callerAbortable._url ? &quot; at &lt;&quot; + this.callerAbortable._url + &quot;&gt;&quot; : &quot;&quot;));</span>
<a href="#l11.296"></a><span id="l11.296" class="difflineplus">+      this.e = e;</span>
<a href="#l11.297"></a><span id="l11.297" class="difflineplus">+      this.finished = true;</span>
<a href="#l11.298"></a><span id="l11.298" class="difflineplus">+      this.succeeded = false;</span>
<a href="#l11.299"></a><span id="l11.299" class="difflineplus">+      this._parallelAbortable._notifyFinished(this);</span>
<a href="#l11.300"></a><span id="l11.300" class="difflineplus">+    };</span>
<a href="#l11.301"></a><span id="l11.301" class="difflineplus">+  },</span>
<a href="#l11.302"></a><span id="l11.302" class="difflineplus">+  /**</span>
<a href="#l11.303"></a><span id="l11.303" class="difflineplus">+   * Call your function that needs to run in parallel</span>
<a href="#l11.304"></a><span id="l11.304" class="difflineplus">+   * and pass the resulting |Abortable| of your function here.</span>
<a href="#l11.305"></a><span id="l11.305" class="difflineplus">+   * @param {Abortable} abortable</span>
<a href="#l11.306"></a><span id="l11.306" class="difflineplus">+   */</span>
<a href="#l11.307"></a><span id="l11.307" class="difflineplus">+  setAbortable(abortable) {</span>
<a href="#l11.308"></a><span id="l11.308" class="difflineplus">+    assert(abortable instanceof Abortable);</span>
<a href="#l11.309"></a><span id="l11.309" class="difflineplus">+    this.callerAbortable = abortable;</span>
<a href="#l11.310"></a><span id="l11.310">   },</span>
<a href="#l11.311"></a><span id="l11.311"> };</span>
<a href="#l11.312"></a><span id="l11.312"> </span>
<a href="#l11.313"></a><span id="l11.313" class="difflineplus">+/**</span>
<a href="#l11.314"></a><span id="l11.314" class="difflineplus">+ * Runs several calls in parallel.</span>
<a href="#l11.315"></a><span id="l11.315" class="difflineplus">+ * Returns the result of the &quot;highest&quot; priority call that succeeds.</span>
<a href="#l11.316"></a><span id="l11.316" class="difflineplus">+ * Unlike Promise.race(), does not return the fastest,</span>
<a href="#l11.317"></a><span id="l11.317" class="difflineplus">+ * but the first in the order they were added.</span>
<a href="#l11.318"></a><span id="l11.318" class="difflineplus">+ * So, the order in which the calls were added determines their priority,</span>
<a href="#l11.319"></a><span id="l11.319" class="difflineplus">+ * with the first to be added being the most desirable.</span>
<a href="#l11.320"></a><span id="l11.320" class="difflineplus">+ *</span>
<a href="#l11.321"></a><span id="l11.321" class="difflineplus">+ * E.g. the first failed, the second is pending, the third succeeded, and the forth is pending.</span>
<a href="#l11.322"></a><span id="l11.322" class="difflineplus">+ * It aborts the forth (because the third succeeded), and it waits for the second to return.</span>
<a href="#l11.323"></a><span id="l11.323" class="difflineplus">+ * If the second succeeds, it is the result, otherwise the third is the result.</span>
<a href="#l11.324"></a><span id="l11.324" class="difflineplus">+ *</span>
<a href="#l11.325"></a><span id="l11.325" class="difflineplus">+ * @param {Function(</span>
<a href="#l11.326"></a><span id="l11.326" class="difflineplus">+ *     {Object} result - Result of winner call</span>
<a href="#l11.327"></a><span id="l11.327" class="difflineplus">+ *     {ParallelCall} call - Winner call info</span>
<a href="#l11.328"></a><span id="l11.328" class="difflineplus">+ *   )} successCallback -  A call returned successfully</span>
<a href="#l11.329"></a><span id="l11.329" class="difflineplus">+ * @param {Function(e)} errorCallback - All functions failed. The exception is from the first one.</span>
<a href="#l11.330"></a><span id="l11.330" class="difflineplus">+ */</span>
<a href="#l11.331"></a><span id="l11.331" class="difflineplus">+function PriorityOrderAbortable(successCallback, errorCallback) {</span>
<a href="#l11.332"></a><span id="l11.332" class="difflineplus">+  assert(typeof(successCallback) == &quot;function&quot;);</span>
<a href="#l11.333"></a><span id="l11.333" class="difflineplus">+  assert(typeof(errorCallback) == &quot;function&quot;);</span>
<a href="#l11.334"></a><span id="l11.334" class="difflineplus">+  ParallelAbortable.call(this); // call super constructor</span>
<a href="#l11.335"></a><span id="l11.335" class="difflineplus">+</span>
<a href="#l11.336"></a><span id="l11.336" class="difflineplus">+  this.addOneFinishedObserver(finishedCall =&gt; {</span>
<a href="#l11.337"></a><span id="l11.337" class="difflineplus">+    let haveHigherPending = false;</span>
<a href="#l11.338"></a><span id="l11.338" class="difflineplus">+    let haveHigherSuccess = false;</span>
<a href="#l11.339"></a><span id="l11.339" class="difflineplus">+    for (let call of this._calls) {</span>
<a href="#l11.340"></a><span id="l11.340" class="difflineplus">+      if (!call.finished) {</span>
<a href="#l11.341"></a><span id="l11.341" class="difflineplus">+        if (haveHigherSuccess) {</span>
<a href="#l11.342"></a><span id="l11.342" class="difflineplus">+          // abort</span>
<a href="#l11.343"></a><span id="l11.343" class="difflineplus">+          if (call.callerAbortable) {</span>
<a href="#l11.344"></a><span id="l11.344" class="difflineplus">+            call.callerAbortable.cancel(NoLongerNeededException(&quot;Another higher call succeeded&quot;));</span>
<a href="#l11.345"></a><span id="l11.345" class="difflineplus">+          }</span>
<a href="#l11.346"></a><span id="l11.346" class="difflineplus">+          continue;</span>
<a href="#l11.347"></a><span id="l11.347" class="difflineplus">+        }</span>
<a href="#l11.348"></a><span id="l11.348" class="difflineplus">+        // it's pending. ignore it for now and wait.</span>
<a href="#l11.349"></a><span id="l11.349" class="difflineplus">+        haveHigherPending = true;</span>
<a href="#l11.350"></a><span id="l11.350" class="difflineplus">+        continue;</span>
<a href="#l11.351"></a><span id="l11.351" class="difflineplus">+      }</span>
<a href="#l11.352"></a><span id="l11.352" class="difflineplus">+      if (!call.succeeded) {</span>
<a href="#l11.353"></a><span id="l11.353" class="difflineplus">+        // it failed. ignore it.</span>
<a href="#l11.354"></a><span id="l11.354" class="difflineplus">+        continue;</span>
<a href="#l11.355"></a><span id="l11.355" class="difflineplus">+      }</span>
<a href="#l11.356"></a><span id="l11.356" class="difflineplus">+      if (haveHigherSuccess) {</span>
<a href="#l11.357"></a><span id="l11.357" class="difflineplus">+        // another successful call was higher. ignore it.</span>
<a href="#l11.358"></a><span id="l11.358" class="difflineplus">+        continue;</span>
<a href="#l11.359"></a><span id="l11.359" class="difflineplus">+      }</span>
<a href="#l11.360"></a><span id="l11.360" class="difflineplus">+      haveHigherSuccess = true;</span>
<a href="#l11.361"></a><span id="l11.361" class="difflineplus">+      if (!haveHigherPending) {</span>
<a href="#l11.362"></a><span id="l11.362" class="difflineplus">+        // this is the winner</span>
<a href="#l11.363"></a><span id="l11.363" class="difflineplus">+        try {</span>
<a href="#l11.364"></a><span id="l11.364" class="difflineplus">+          successCallback(call.result, call);</span>
<a href="#l11.365"></a><span id="l11.365" class="difflineplus">+        } catch (e) {</span>
<a href="#l11.366"></a><span id="l11.366" class="difflineplus">+          console.error(e);</span>
<a href="#l11.367"></a><span id="l11.367" class="difflineplus">+          // if the handler failed with this data, treat this call as failed</span>
<a href="#l11.368"></a><span id="l11.368" class="difflineplus">+          call.e = e;</span>
<a href="#l11.369"></a><span id="l11.369" class="difflineplus">+          call.succeeded = false;</span>
<a href="#l11.370"></a><span id="l11.370" class="difflineplus">+          haveHigherSuccess = false;</span>
<a href="#l11.371"></a><span id="l11.371" class="difflineplus">+        }</span>
<a href="#l11.372"></a><span id="l11.372" class="difflineplus">+      }</span>
<a href="#l11.373"></a><span id="l11.373" class="difflineplus">+    }</span>
<a href="#l11.374"></a><span id="l11.374" class="difflineplus">+    if (!haveHigherPending &amp;&amp; !haveHigherSuccess) {</span>
<a href="#l11.375"></a><span id="l11.375" class="difflineplus">+      // all failed</span>
<a href="#l11.376"></a><span id="l11.376" class="difflineplus">+      errorCallback(this._calls[0].e);</span>
<a href="#l11.377"></a><span id="l11.377" class="difflineplus">+    }</span>
<a href="#l11.378"></a><span id="l11.378" class="difflineplus">+  });</span>
<a href="#l11.379"></a><span id="l11.379" class="difflineplus">+}</span>
<a href="#l11.380"></a><span id="l11.380" class="difflineplus">+PriorityOrderAbortable.prototype = Object.create(ParallelAbortable.prototype);</span>
<a href="#l11.381"></a><span id="l11.381" class="difflineplus">+PriorityOrderAbortable.prototype.constructor = PriorityOrderAbortable;</span>
<a href="#l11.382"></a><span id="l11.382" class="difflineplus">+</span>
<a href="#l11.383"></a><span id="l11.383" class="difflineplus">+function NoLongerNeededException(msg) {</span>
<a href="#l11.384"></a><span id="l11.384" class="difflineplus">+  CancelledException.call(this, msg);</span>
<a href="#l11.385"></a><span id="l11.385" class="difflineplus">+}</span>
<a href="#l11.386"></a><span id="l11.386" class="difflineplus">+NoLongerNeededException.prototype = Object.create(CancelledException.prototype);</span>
<a href="#l11.387"></a><span id="l11.387" class="difflineplus">+NoLongerNeededException.prototype.constructor = NoLongerNeededException;</span>
<a href="#l11.388"></a><span id="l11.388" class="difflineplus">+</span>
<a href="#l11.389"></a><span id="l11.389" class="difflineplus">+</span>
<a href="#l11.390"></a><span id="l11.390" class="difflineplus">+/////////////////////////////////////////</span>
<a href="#l11.391"></a><span id="l11.391" class="difflineplus">+// High level features</span>
<a href="#l11.392"></a><span id="l11.392" class="difflineplus">+</span>
<a href="#l11.393"></a><span id="l11.393" class="difflineplus">+/**</span>
<a href="#l11.394"></a><span id="l11.394" class="difflineplus">+ * Allows you to install an addon.</span>
<a href="#l11.395"></a><span id="l11.395" class="difflineplus">+ *</span>
<a href="#l11.396"></a><span id="l11.396" class="difflineplus">+ * Example:</span>
<a href="#l11.397"></a><span id="l11.397" class="difflineplus">+ * var installer = new AddonInstaller({ xpiURL : &quot;https://...xpi&quot;, id: &quot;...&quot;, ...});</span>
<a href="#l11.398"></a><span id="l11.398" class="difflineplus">+ * installer.install();</span>
<a href="#l11.399"></a><span id="l11.399" class="difflineplus">+ *</span>
<a href="#l11.400"></a><span id="l11.400" class="difflineplus">+ * @param {Object} args - Contains parameters:</span>
<a href="#l11.401"></a><span id="l11.401" class="difflineplus">+ * @param {string} name (Optional) - Name of the addon (not important)</span>
<a href="#l11.402"></a><span id="l11.402" class="difflineplus">+ * @param {string} id (Optional) - Addon ID</span>
<a href="#l11.403"></a><span id="l11.403" class="difflineplus">+ * If you pass an ID, and the addon is already installed (and the version matches),</span>
<a href="#l11.404"></a><span id="l11.404" class="difflineplus">+ * then install() will do nothing.</span>
<a href="#l11.405"></a><span id="l11.405" class="difflineplus">+ * After the XPI is downloaded, the ID will be verified. If it doesn't match, the</span>
<a href="#l11.406"></a><span id="l11.406" class="difflineplus">+ * install will fail.</span>
<a href="#l11.407"></a><span id="l11.407" class="difflineplus">+ * If you don't pass an ID, these checks will be skipped and the addon be installed</span>
<a href="#l11.408"></a><span id="l11.408" class="difflineplus">+ * unconditionally.</span>
<a href="#l11.409"></a><span id="l11.409" class="difflineplus">+ * It is recommended to pass at least an ID, because it can confuse some addons</span>
<a href="#l11.410"></a><span id="l11.410" class="difflineplus">+ * to be reloaded at runtime.</span>
<a href="#l11.411"></a><span id="l11.411" class="difflineplus">+ * @param {string} minVersion (Optional) - Minimum version of the addon</span>
<a href="#l11.412"></a><span id="l11.412" class="difflineplus">+ * If you pass a minVersion (in addition to ID), and the installed addon is older than this,</span>
<a href="#l11.413"></a><span id="l11.413" class="difflineplus">+ * the install will be done anyway. If the downloaded addon has a lower version,</span>
<a href="#l11.414"></a><span id="l11.414" class="difflineplus">+ * the install will fail.</span>
<a href="#l11.415"></a><span id="l11.415" class="difflineplus">+ * If you do not pass a minVersion, there will be no version check.</span>
<a href="#l11.416"></a><span id="l11.416" class="difflineplus">+ * @param {URL} xpiURL - Where to download the XPI from</span>
<a href="#l11.417"></a><span id="l11.417" class="difflineplus">+ */</span>
<a href="#l11.418"></a><span id="l11.418" class="difflineplus">+function AddonInstaller(args) {</span>
<a href="#l11.419"></a><span id="l11.419" class="difflineplus">+  Abortable.call(this);</span>
<a href="#l11.420"></a><span id="l11.420" class="difflineplus">+  this._name = sanitize.label(args.name);</span>
<a href="#l11.421"></a><span id="l11.421" class="difflineplus">+  this._id = sanitize.string(args.id);</span>
<a href="#l11.422"></a><span id="l11.422" class="difflineplus">+  this._minVersion = sanitize.string(args.minVersion);</span>
<a href="#l11.423"></a><span id="l11.423" class="difflineplus">+  this._url = sanitize.url(args.xpiURL);</span>
<a href="#l11.424"></a><span id="l11.424" class="difflineplus">+}</span>
<a href="#l11.425"></a><span id="l11.425" class="difflineplus">+AddonInstaller.prototype = Object.create(Abortable.prototype);</span>
<a href="#l11.426"></a><span id="l11.426" class="difflineplus">+AddonInstaller.prototype.constructor = AddonInstaller;</span>
<a href="#l11.427"></a><span id="l11.427" class="difflineplus">+</span>
<a href="#l11.428"></a><span id="l11.428" class="difflineplus">+/**</span>
<a href="#l11.429"></a><span id="l11.429" class="difflineplus">+ * Checks whether the passed-in addon matches the</span>
<a href="#l11.430"></a><span id="l11.430" class="difflineplus">+ * id and minVersion requested by the caller.</span>
<a href="#l11.431"></a><span id="l11.431" class="difflineplus">+ * @param {nsIAddon} addon</span>
<a href="#l11.432"></a><span id="l11.432" class="difflineplus">+ * @returns {Boolean} is OK</span>
<a href="#l11.433"></a><span id="l11.433" class="difflineplus">+ */</span>
<a href="#l11.434"></a><span id="l11.434" class="difflineplus">+AddonInstaller.prototype.matches = function(addon) {</span>
<a href="#l11.435"></a><span id="l11.435" class="difflineplus">+  return !this._id || (this._id == addon.id &amp;&amp;</span>
<a href="#l11.436"></a><span id="l11.436" class="difflineplus">+    (!this._minVersion || Services.vc.compare(addon.version, this._minVersion) &gt;= 0));</span>
<a href="#l11.437"></a><span id="l11.437" class="difflineplus">+};</span>
<a href="#l11.438"></a><span id="l11.438" class="difflineplus">+</span>
<a href="#l11.439"></a><span id="l11.439" class="difflineplus">+/**</span>
<a href="#l11.440"></a><span id="l11.440" class="difflineplus">+ * Start the installation</span>
<a href="#l11.441"></a><span id="l11.441" class="difflineplus">+ * @throws Exception in case of failure</span>
<a href="#l11.442"></a><span id="l11.442" class="difflineplus">+ */</span>
<a href="#l11.443"></a><span id="l11.443" class="difflineplus">+AddonInstaller.prototype.install = async function() {</span>
<a href="#l11.444"></a><span id="l11.444" class="difflineplus">+  if (await this.isInstalled()) {</span>
<a href="#l11.445"></a><span id="l11.445" class="difflineplus">+    return;</span>
<a href="#l11.446"></a><span id="l11.446" class="difflineplus">+  }</span>
<a href="#l11.447"></a><span id="l11.447" class="difflineplus">+  await this._installDirect();</span>
<a href="#l11.448"></a><span id="l11.448" class="difflineplus">+};</span>
<a href="#l11.449"></a><span id="l11.449" class="difflineplus">+</span>
<a href="#l11.450"></a><span id="l11.450" class="difflineplus">+/**</span>
<a href="#l11.451"></a><span id="l11.451" class="difflineplus">+ * Checks whether we already have an addon installed that matches the</span>
<a href="#l11.452"></a><span id="l11.452" class="difflineplus">+ * id and minVersion requested by the caller.</span>
<a href="#l11.453"></a><span id="l11.453" class="difflineplus">+ * @returns {boolean} is already installed and enabled</span>
<a href="#l11.454"></a><span id="l11.454" class="difflineplus">+ */</span>
<a href="#l11.455"></a><span id="l11.455" class="difflineplus">+AddonInstaller.prototype.isInstalled = async function() {</span>
<a href="#l11.456"></a><span id="l11.456" class="difflineplus">+  if (!this._id) {</span>
<a href="#l11.457"></a><span id="l11.457" class="difflineplus">+    return false;</span>
<a href="#l11.458"></a><span id="l11.458" class="difflineplus">+  }</span>
<a href="#l11.459"></a><span id="l11.459" class="difflineplus">+  var addon = await AddonManager.getAddonByID(this._id);</span>
<a href="#l11.460"></a><span id="l11.460" class="difflineplus">+  return addon &amp;&amp; this.matches(addon) &amp;&amp; addon.isActive;</span>
<a href="#l11.461"></a><span id="l11.461" class="difflineplus">+};</span>
<a href="#l11.462"></a><span id="l11.462" class="difflineplus">+</span>
<a href="#l11.463"></a><span id="l11.463" class="difflineplus">+/**</span>
<a href="#l11.464"></a><span id="l11.464" class="difflineplus">+ * Downloads and installs the addon.</span>
<a href="#l11.465"></a><span id="l11.465" class="difflineplus">+ * The downloaded XPI will be checked using prompt().</span>
<a href="#l11.466"></a><span id="l11.466" class="difflineplus">+ */</span>
<a href="#l11.467"></a><span id="l11.467" class="difflineplus">+AddonInstaller.prototype._installDirect = async function() {</span>
<a href="#l11.468"></a><span id="l11.468" class="difflineplus">+  var installer = this._installer = await AddonManager.getInstallForURL(</span>
<a href="#l11.469"></a><span id="l11.469" class="difflineplus">+    this._url, &quot;application/x-xpinstall&quot;, null, this._name);</span>
<a href="#l11.470"></a><span id="l11.470" class="difflineplus">+  installer.promptHandler = makeCallback(this, this.prompt);</span>
<a href="#l11.471"></a><span id="l11.471" class="difflineplus">+  await installer.install(); // throws, if failed</span>
<a href="#l11.472"></a><span id="l11.472" class="difflineplus">+</span>
<a href="#l11.473"></a><span id="l11.473" class="difflineplus">+  var addon = await AddonManager.getAddonByID(this._id);</span>
<a href="#l11.474"></a><span id="l11.474" class="difflineplus">+  await addon.enable();</span>
<a href="#l11.475"></a><span id="l11.475" class="difflineplus">+</span>
<a href="#l11.476"></a><span id="l11.476" class="difflineplus">+  // Wait for addon startup code to finish</span>
<a href="#l11.477"></a><span id="l11.477" class="difflineplus">+  // Fixes: verify password fails with NOT_AVAILABLE in createIncomingServer()</span>
<a href="#l11.478"></a><span id="l11.478" class="difflineplus">+  if (&quot;startupPromise&quot; in addon) {</span>
<a href="#l11.479"></a><span id="l11.479" class="difflineplus">+    await addon.startupPromise;</span>
<a href="#l11.480"></a><span id="l11.480" class="difflineplus">+  }</span>
<a href="#l11.481"></a><span id="l11.481" class="difflineplus">+  let wait = ms =&gt; new Promise(resolve =&gt; setTimeout(resolve, ms));</span>
<a href="#l11.482"></a><span id="l11.482" class="difflineplus">+  await wait(1000);</span>
<a href="#l11.483"></a><span id="l11.483" class="difflineplus">+};</span>
<a href="#l11.484"></a><span id="l11.484" class="difflineplus">+</span>
<a href="#l11.485"></a><span id="l11.485" class="difflineplus">+/**</span>
<a href="#l11.486"></a><span id="l11.486" class="difflineplus">+ * Install confirmation. You may override this, if needed.</span>
<a href="#l11.487"></a><span id="l11.487" class="difflineplus">+ * @throws Exception If you want to cancel install, then throw an exception.</span>
<a href="#l11.488"></a><span id="l11.488" class="difflineplus">+ */</span>
<a href="#l11.489"></a><span id="l11.489" class="difflineplus">+AddonInstaller.prototype.prompt = async function(info) {</span>
<a href="#l11.490"></a><span id="l11.490" class="difflineplus">+  if (!this.matches(info.addon)) {</span>
<a href="#l11.491"></a><span id="l11.491" class="difflineplus">+    // happens only when we got the wrong XPI</span>
<a href="#l11.492"></a><span id="l11.492" class="difflineplus">+    throw new Exception(&quot;The downloaded addon XPI does not match the minimum requirements&quot;);</span>
<a href="#l11.493"></a><span id="l11.493" class="difflineplus">+  }</span>
<a href="#l11.494"></a><span id="l11.494" class="difflineplus">+};</span>
<a href="#l11.495"></a><span id="l11.495" class="difflineplus">+</span>
<a href="#l11.496"></a><span id="l11.496" class="difflineplus">+AddonInstaller.prototype.cancel = function() {</span>
<a href="#l11.497"></a><span id="l11.497" class="difflineplus">+  if (this._installer) {</span>
<a href="#l11.498"></a><span id="l11.498" class="difflineplus">+    try {</span>
<a href="#l11.499"></a><span id="l11.499" class="difflineplus">+      this._installer.cancel();</span>
<a href="#l11.500"></a><span id="l11.500" class="difflineplus">+    } catch (e) { // if install failed</span>
<a href="#l11.501"></a><span id="l11.501" class="difflineplus">+      ddump(e);</span>
<a href="#l11.502"></a><span id="l11.502" class="difflineplus">+    }</span>
<a href="#l11.503"></a><span id="l11.503" class="difflineplus">+  }</span>
<a href="#l11.504"></a><span id="l11.504" class="difflineplus">+};</span>
<a href="#l11.505"></a><span id="l11.505" class="difflineplus">+</span>
<a href="#l11.506"></a><span id="l11.506" class="difflineplus">+/////////////////////////////////////////</span>
<a href="#l11.507"></a><span id="l11.507" class="difflineplus">+// Debug output</span>
<a href="#l11.508"></a><span id="l11.508" class="difflineplus">+</span>
<a href="#l11.509"></a><span id="l11.509"> function deepCopy(org) {</span>
<a href="#l11.510"></a><span id="l11.510">   if (typeof(org) == &quot;undefined&quot;)</span>
<a href="#l11.511"></a><span id="l11.511">     return undefined;</span>
<a href="#l11.512"></a><span id="l11.512">   if (org == null)</span>
<a href="#l11.513"></a><span id="l11.513">     return null;</span>
<a href="#l11.514"></a><span id="l11.514">   if (typeof(org) == &quot;string&quot;)</span>
<a href="#l11.515"></a><span id="l11.515">     return org;</span>
<a href="#l11.516"></a><span id="l11.516">   if (typeof(org) == &quot;number&quot;)</span>
<a href="#l11.517"></a><span id="l11.517" class="difflineat">@@ -214,18 +572,22 @@ function deepCopy(org) {</span>
<a href="#l11.518"></a><span id="l11.518">     result = [];</span>
<a href="#l11.519"></a><span id="l11.519">   for (var prop in org)</span>
<a href="#l11.520"></a><span id="l11.520">     result[prop] = deepCopy(org[prop]);</span>
<a href="#l11.521"></a><span id="l11.521">   return result;</span>
<a href="#l11.522"></a><span id="l11.522"> }</span>
<a href="#l11.523"></a><span id="l11.523"> </span>
<a href="#l11.524"></a><span id="l11.524"> if (typeof gEmailWizardLogger == &quot;undefined&quot;) {</span>
<a href="#l11.525"></a><span id="l11.525">   ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l11.526"></a><span id="l11.526" class="difflineminus">-  var gEmailWizardLogger = Log4Moz.getConfiguredLogger(&quot;mail.wizard&quot;);</span>
<a href="#l11.527"></a><span id="l11.527" class="difflineplus">+  var gEmailWizardLogger = Log4Moz.getConfiguredLogger(&quot;mail.setup&quot;);</span>
<a href="#l11.528"></a><span id="l11.528" class="difflineplus">+  gEmailWizardLogger.level = Log4Moz.Level.Info;</span>
<a href="#l11.529"></a><span id="l11.529" class="difflineplus">+  gEmailWizardLogger.addAppender(new Log4Moz.ConsoleAppender(new Log4Moz.BasicFormatter())); // browser console</span>
<a href="#l11.530"></a><span id="l11.530" class="difflineplus">+  gEmailWizardLogger.addAppender(new Log4Moz.DumpAppender(new Log4Moz.BasicFormatter())); // stdout</span>
<a href="#l11.531"></a><span id="l11.531"> }</span>
<a href="#l11.532"></a><span id="l11.532" class="difflineplus">+</span>
<a href="#l11.533"></a><span id="l11.533"> function ddump(text) {</span>
<a href="#l11.534"></a><span id="l11.534">   gEmailWizardLogger.info(text);</span>
<a href="#l11.535"></a><span id="l11.535"> }</span>
<a href="#l11.536"></a><span id="l11.536"> </span>
<a href="#l11.537"></a><span id="l11.537"> function debugObject(obj, name, maxDepth, curDepth) {</span>
<a href="#l11.538"></a><span id="l11.538">   if (curDepth == undefined)</span>
<a href="#l11.539"></a><span id="l11.539">     curDepth = 0;</span>
<a href="#l11.540"></a><span id="l11.540">   if (maxDepth != undefined &amp;&amp; curDepth &gt; maxDepth)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/components/accountcreation/content/verifyConfig.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/components/accountcreation/content/verifyConfig.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1,13 +1,21 @@</span>
<a href="#l12.4"></a><span id="l12.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l12.5"></a><span id="l12.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.6"></a><span id="l12.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.7"></a><span id="l12.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+ChromeUtils.import(&quot;resource:///modules/OAuth2Providers.jsm&quot;);</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+if (typeof gEmailWizardLogger == &quot;undefined&quot;) {</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+  ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+  var gEmailWizardLogger = Log4Moz.getConfiguredLogger(&quot;mail.wizard&quot;);</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+}</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+</span>
<a href="#l12.17"></a><span id="l12.17"> /**</span>
<a href="#l12.18"></a><span id="l12.18">  * This checks a given config, by trying a real connection and login,</span>
<a href="#l12.19"></a><span id="l12.19">  * with username and password.</span>
<a href="#l12.20"></a><span id="l12.20">  *</span>
<a href="#l12.21"></a><span id="l12.21">  * TODO</span>
<a href="#l12.22"></a><span id="l12.22">  * - give specific errors, bug 555448</span>
<a href="#l12.23"></a><span id="l12.23">  * - return a working |Abortable| to allow cancel</span>
<a href="#l12.24"></a><span id="l12.24">  *</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineat">@@ -23,48 +31,37 @@</span>
<a href="#l12.26"></a><span id="l12.26">  *   Called when we could guess the config.</span>
<a href="#l12.27"></a><span id="l12.27">  *   For accountConfig, see below.</span>
<a href="#l12.28"></a><span id="l12.28">  * @param errorCallback function(ex)</span>
<a href="#l12.29"></a><span id="l12.29">  *   Called when we could guess not the config, either</span>
<a href="#l12.30"></a><span id="l12.30">  *   because we have not found anything or</span>
<a href="#l12.31"></a><span id="l12.31">  *   because there was an error (e.g. no network connection).</span>
<a href="#l12.32"></a><span id="l12.32">  *   The ex.message will contain a user-presentable message.</span>
<a href="#l12.33"></a><span id="l12.33">  */</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/OAuth2Providers.jsm&quot;);</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineminus">-if (typeof gEmailWizardLogger == &quot;undefined&quot;) {</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineminus">-  ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineminus">-  var gEmailWizardLogger = Log4Moz.getConfiguredLogger(&quot;mail.wizard&quot;);</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineminus">-}</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineminus">-</span>
<a href="#l12.43"></a><span id="l12.43"> function verifyConfig(config, alter, msgWindow, successCallback, errorCallback) {</span>
<a href="#l12.44"></a><span id="l12.44">   ddump(debugObject(config, &quot;config&quot;, 3));</span>
<a href="#l12.45"></a><span id="l12.45">   assert(config instanceof AccountConfig,</span>
<a href="#l12.46"></a><span id="l12.46">          &quot;BUG: Arg 'config' needs to be an AccountConfig object&quot;);</span>
<a href="#l12.47"></a><span id="l12.47">   assert(typeof(alter) == &quot;boolean&quot;);</span>
<a href="#l12.48"></a><span id="l12.48">   assert(typeof(successCallback) == &quot;function&quot;);</span>
<a href="#l12.49"></a><span id="l12.49">   assert(typeof(errorCallback) == &quot;function&quot;);</span>
<a href="#l12.50"></a><span id="l12.50"> </span>
<a href="#l12.51"></a><span id="l12.51">   if (MailServices.accounts.findRealServer(config.incoming.username,</span>
<a href="#l12.52"></a><span id="l12.52">                                            config.incoming.hostname,</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineminus">-                                           sanitize.enum(config.incoming.type,</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineminus">-                                                         [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]),</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+                                           config.incoming.type,</span>
<a href="#l12.56"></a><span id="l12.56">                                            config.incoming.port)) {</span>
<a href="#l12.57"></a><span id="l12.57">     errorCallback(&quot;Incoming server exists&quot;);</span>
<a href="#l12.58"></a><span id="l12.58">     return;</span>
<a href="#l12.59"></a><span id="l12.59">   }</span>
<a href="#l12.60"></a><span id="l12.60"> </span>
<a href="#l12.61"></a><span id="l12.61">   // incoming server</span>
<a href="#l12.62"></a><span id="l12.62">   let inServer =</span>
<a href="#l12.63"></a><span id="l12.63">     MailServices.accounts.createIncomingServer(config.incoming.username,</span>
<a href="#l12.64"></a><span id="l12.64">                                                config.incoming.hostname,</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineminus">-                                               sanitize.enum(config.incoming.type,</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineminus">-                                                             [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]));</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+                                               config.incoming.type);</span>
<a href="#l12.68"></a><span id="l12.68">   inServer.port = config.incoming.port;</span>
<a href="#l12.69"></a><span id="l12.69">   inServer.password = config.incoming.password;</span>
<a href="#l12.70"></a><span id="l12.70">   if (config.incoming.socketType == 1) // plain</span>
<a href="#l12.71"></a><span id="l12.71">     inServer.socketType = Ci.nsMsgSocketType.plain;</span>
<a href="#l12.72"></a><span id="l12.72">   else if (config.incoming.socketType == 2) // SSL</span>
<a href="#l12.73"></a><span id="l12.73">     inServer.socketType = Ci.nsMsgSocketType.SSL;</span>
<a href="#l12.74"></a><span id="l12.74">   else if (config.incoming.socketType == 3) // STARTTLS</span>
<a href="#l12.75"></a><span id="l12.75">     inServer.socketType = Ci.nsMsgSocketType.alwaysSTARTTLS;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/components/accountcreation/jar.mn</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/components/accountcreation/jar.mn</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -2,16 +2,17 @@</span>
<a href="#l13.4"></a><span id="l13.4"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.5"></a><span id="l13.5"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l13.6"></a><span id="l13.6"> </span>
<a href="#l13.7"></a><span id="l13.7"> messenger.jar:</span>
<a href="#l13.8"></a><span id="l13.8">   content/messenger/accountcreation/accountConfig.js      (content/accountConfig.js)</span>
<a href="#l13.9"></a><span id="l13.9">   content/messenger/accountcreation/createInBackend.js    (content/createInBackend.js)</span>
<a href="#l13.10"></a><span id="l13.10">   content/messenger/accountcreation/emailWizard.js        (content/emailWizard.js)</span>
<a href="#l13.11"></a><span id="l13.11">   content/messenger/accountcreation/emailWizard.xul       (content/emailWizard.xul)</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+  content/messenger/accountcreation/exchangeAutoDiscover.js        (content/exchangeAutoDiscover.js)</span>
<a href="#l13.13"></a><span id="l13.13">   content/messenger/accountcreation/fetchConfig.js        (content/fetchConfig.js)</span>
<a href="#l13.14"></a><span id="l13.14">   content/messenger/accountcreation/fetchhttp.js          (content/fetchhttp.js)</span>
<a href="#l13.15"></a><span id="l13.15">   content/messenger/accountcreation/guessConfig.js        (content/guessConfig.js)</span>
<a href="#l13.16"></a><span id="l13.16">   content/messenger/accountcreation/MyBadCertHandler.js   (content/MyBadCertHandler.js)</span>
<a href="#l13.17"></a><span id="l13.17">   content/messenger/accountcreation/readFromXML.js        (content/readFromXML.js)</span>
<a href="#l13.18"></a><span id="l13.18">   content/messenger/accountcreation/sanitizeDatatypes.js  (content/sanitizeDatatypes.js)</span>
<a href="#l13.19"></a><span id="l13.19">   content/messenger/accountcreation/util.js               (content/util.js)</span>
<a href="#l13.20"></a><span id="l13.20">   content/messenger/accountcreation/verifyConfig.js       (content/verifyConfig.js)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/accountCreation.dtd</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/accountCreation.dtd</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -25,25 +25,30 @@</span>
<a href="#l14.4"></a><span id="l14.4"> &lt;!ENTITY incoming.label                  &quot;Incoming:&quot;&gt;</span>
<a href="#l14.5"></a><span id="l14.5"> &lt;!ENTITY outgoing.label                  &quot;Outgoing:&quot;&gt;</span>
<a href="#l14.6"></a><span id="l14.6"> &lt;!ENTITY username.label                  &quot;Username:&quot;&gt;</span>
<a href="#l14.7"></a><span id="l14.7"> &lt;!ENTITY hostname.label                  &quot;Server hostname&quot;&gt;</span>
<a href="#l14.8"></a><span id="l14.8"> &lt;!ENTITY port.label                      &quot;Port&quot;&gt;</span>
<a href="#l14.9"></a><span id="l14.9"> &lt;!ENTITY ssl.label                       &quot;SSL&quot;&gt;</span>
<a href="#l14.10"></a><span id="l14.10"> &lt;!ENTITY auth.label                      &quot;Authentication&quot;&gt;</span>
<a href="#l14.11"></a><span id="l14.11"> &lt;!ENTITY imap.label                      &quot;IMAP&quot;&gt;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-&lt;!ENTITY pop3.label                       &quot;POP3&quot;&gt;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+&lt;!ENTITY pop3.label                      &quot;POP3&quot;&gt;</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+&lt;!-- LOCALIZATION NOTE(exchange.label): Do not translate Exchange, it is a product name. --&gt;</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+&lt;!ENTITY exchange.label                  &quot;Exchange&quot;&gt;</span>
<a href="#l14.16"></a><span id="l14.16"> &lt;!ENTITY smtp.label                      &quot;SMTP&quot;&gt;</span>
<a href="#l14.17"></a><span id="l14.17"> &lt;!ENTITY autodetect.label                &quot;Autodetect&quot;&gt;</span>
<a href="#l14.18"></a><span id="l14.18"> &lt;!-- LOCALIZATION NOTE(noEncryption.label): Neither SSL/TLS nor STARTTLS.</span>
<a href="#l14.19"></a><span id="l14.19">      Transmission of emails in cleartext over the Internet. --&gt;</span>
<a href="#l14.20"></a><span id="l14.20"> &lt;!ENTITY noEncryption.label              &quot;None&quot;&gt;</span>
<a href="#l14.21"></a><span id="l14.21"> &lt;!ENTITY starttls.label                  &quot;STARTTLS&quot;&gt;</span>
<a href="#l14.22"></a><span id="l14.22"> &lt;!ENTITY sslTls.label                    &quot;SSL/TLS&quot;&gt;</span>
<a href="#l14.23"></a><span id="l14.23"> </span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+&lt;!-- LOCALIZATION NOTE(exchange-hostname.label): Do not translate Exchange, it is a product name. --&gt;</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+&lt;!ENTITY exchange-hostname.label         &quot;Exchange server:&quot;&gt;</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+</span>
<a href="#l14.27"></a><span id="l14.27"> &lt;!ENTITY advancedSetup.label             &quot;Advanced config&quot;&gt;</span>
<a href="#l14.28"></a><span id="l14.28"> &lt;!ENTITY advancedSetup.accesskey         &quot;A&quot;&gt;</span>
<a href="#l14.29"></a><span id="l14.29"> &lt;!ENTITY cancel.label                    &quot;Cancel&quot;&gt;</span>
<a href="#l14.30"></a><span id="l14.30"> &lt;!ENTITY cancel.accesskey                &quot;a&quot;&gt;</span>
<a href="#l14.31"></a><span id="l14.31"> &lt;!ENTITY continue.label                  &quot;Continue&quot;&gt;</span>
<a href="#l14.32"></a><span id="l14.32"> &lt;!ENTITY continue.accesskey              &quot;C&quot;&gt;</span>
<a href="#l14.33"></a><span id="l14.33"> &lt;!ENTITY stop.label                      &quot;Stop&quot;&gt;</span>
<a href="#l14.34"></a><span id="l14.34"> &lt;!ENTITY stop.accesskey                  &quot;S&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/accountCreation.properties</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/accountCreation.properties</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -13,29 +13,37 @@ cleartext_details=Insecure mail servers </span>
<a href="#l15.4"></a><span id="l15.4"> # LOCALIZATION NOTE(default_server_tag): Used to indicate the default smtp server in the server dropdown list.</span>
<a href="#l15.5"></a><span id="l15.5"> default_server_tag= (default)</span>
<a href="#l15.6"></a><span id="l15.6"> # LOCALIZATION NOTE(port_auto): It must be short (4-5 characters max.).</span>
<a href="#l15.7"></a><span id="l15.7"> # Content of server port field (usually a number), used when the user didn't</span>
<a href="#l15.8"></a><span id="l15.8"> # enter anything yet and we'll automatically detect it later.</span>
<a href="#l15.9"></a><span id="l15.9"> port_auto=Auto</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11"> # config titles</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+looking_up_settings=Looking up configuration…</span>
<a href="#l15.13"></a><span id="l15.13"> # LOCALIZATION NOTE(looking_up_settings_disk): Referring to Thunderbird installation folder on user's harddisk. %1$S will be the brandShortName.</span>
<a href="#l15.14"></a><span id="l15.14"> looking_up_settings_disk=Looking up configuration: %1$S installation</span>
<a href="#l15.15"></a><span id="l15.15"> looking_up_settings_isp=Looking up configuration: Email provider</span>
<a href="#l15.16"></a><span id="l15.16"> # LOCALIZATION NOTE(looking_up_settings_db): Do not translate or replace Mozilla. It stands for the public project mozilla.org, not Mozilla Corporation. The database is a generic, public domain facility usable by any client.</span>
<a href="#l15.17"></a><span id="l15.17"> looking_up_settings_db=Looking up configuration: Mozilla ISP database</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+looking_up_settings_mx=Looking up configuration: Incoming mail domain</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+# LOCALIZATION NOTE(looking_up_settings_exchange): Exchange is a product name</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+looking_up_settings_exchange=Looking up configuration: Exchange server</span>
<a href="#l15.21"></a><span id="l15.21"> # LOCALIZATION NOTE(looking_up_settings_guess): We are checking common server names like pop., pop3., smtp., mail., without knowing whether they exist or really serve this email account. If a server responds, we try to talk to it via POP/IMAP/SMTP protocols and query its capabilities. If that succeeds, we assume we found a configuration. Of course, it may still be wrong, but it often works.</span>
<a href="#l15.22"></a><span id="l15.22"> looking_up_settings_guess=Looking up configuration: Trying common server names</span>
<a href="#l15.23"></a><span id="l15.23"> looking_up_settings_halfmanual=Looking up configuration: Probing server</span>
<a href="#l15.24"></a><span id="l15.24"> # LOCALIZATION NOTE(found_settings_disk): Referring to Thunderbird installation folder on user's harddisk. %1$S will be the brandShortName.</span>
<a href="#l15.25"></a><span id="l15.25"> found_settings_disk=Configuration found on %1$S installation</span>
<a href="#l15.26"></a><span id="l15.26"> found_settings_isp=Configuration found at email provider</span>
<a href="#l15.27"></a><span id="l15.27"> # LOCALIZATION NOTE(found_settings_db): Do not translate or replace Mozilla. It stands for the public project mozilla.org, not Mozilla Corporation. The database is a generic, public domain facility usable by any client.</span>
<a href="#l15.28"></a><span id="l15.28"> found_settings_db=Configuration found in Mozilla ISP database</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+# LOCALIZATION NOTE(found_settings_exchange): Microsoft Exchange is a product name.</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+found_settings_exchange=Configuration found for a Microsoft Exchange server</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+no-open-protocols=This email server unfortunately does not support open protocols.</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+addon-intro=A third-party add-on can allow you to access your email account on this server:</span>
<a href="#l15.33"></a><span id="l15.33"> # LOCALIZATION NOTE(found_settings_guess): We tried common mail server names and we found a mail server and talked to it and it responded properly, so we think we found a suitable configuration, but we are only about 80% certain that it is the correct setting for this email address. There's a chance that email address may not actually be served by this server and it won't work, or that there is a better server.</span>
<a href="#l15.34"></a><span id="l15.34"> found_settings_guess=Configuration found by trying common server names</span>
<a href="#l15.35"></a><span id="l15.35"> found_settings_halfmanual=The following settings were found by probing the given server</span>
<a href="#l15.36"></a><span id="l15.36"> # LOCALIZATION NOTE(failed_to_find_settings): %1$S will be the brandShortName.</span>
<a href="#l15.37"></a><span id="l15.37"> failed_to_find_settings=%1$S failed to find the settings for your email account.</span>
<a href="#l15.38"></a><span id="l15.38"> manually_edit_config=Editing Config</span>
<a href="#l15.39"></a><span id="l15.39"> # LOCALIZATION NOTE(guessed_settings_offline) User is offline, so we just took a wild guess and the user will have to enter the right settings.</span>
<a href="#l15.40"></a><span id="l15.40"> guessed_settings_offline=You are offline. We guessed some settings but you will need to enter the right settings.</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineat">@@ -52,28 +60,34 @@ guessing_from_email=guessing configuration…</span>
<a href="#l15.42"></a><span id="l15.42"> config_details_found=Your configuration details have been found!</span>
<a href="#l15.43"></a><span id="l15.43"> config_unverifiable=Configuration could not be verified — is the username or password wrong?</span>
<a href="#l15.44"></a><span id="l15.44"> incoming_found_specify_outgoing=Your incoming server configuration details have been found, please specify the sending hostname.</span>
<a href="#l15.45"></a><span id="l15.45"> outgoing_found_specify_incoming=Your outgoing server configuration details have been found, please specify the receiving hostname.</span>
<a href="#l15.46"></a><span id="l15.46"> please_enter_missing_hostnames=Could not guess settings — please enter missing hostnames.</span>
<a href="#l15.47"></a><span id="l15.47"> incoming_failed_trying_outgoing=Could not automatically configure incoming server, still trying for outgoing server.</span>
<a href="#l15.48"></a><span id="l15.48"> outgoing_failed_trying_incoming=Could not automatically configure outgoing server, still trying for incoming server.</span>
<a href="#l15.49"></a><span id="l15.49"> checking_password=Checking password…</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">-password_ok=Password ok!</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+password_ok=Password OK</span>
<a href="#l15.52"></a><span id="l15.52"> user_pass_invalid=Username or password invalid</span>
<a href="#l15.53"></a><span id="l15.53"> check_server_details=Checking server details</span>
<a href="#l15.54"></a><span id="l15.54"> check_in_server_details=Checking incoming server details</span>
<a href="#l15.55"></a><span id="l15.55"> check_out_server_details=Checking outgoing server details</span>
<a href="#l15.56"></a><span id="l15.56"> </span>
<a href="#l15.57"></a><span id="l15.57"> error_creating_account=Error Creating Account</span>
<a href="#l15.58"></a><span id="l15.58"> incoming_server_exists=Incoming server already exists.</span>
<a href="#l15.59"></a><span id="l15.59"> </span>
<a href="#l15.60"></a><span id="l15.60"> please_enter_name=Please enter your name.</span>
<a href="#l15.61"></a><span id="l15.61"> double_check_email=Double-check this email address!</span>
<a href="#l15.62"></a><span id="l15.62"> </span>
<a href="#l15.63"></a><span id="l15.63" class="difflineplus">+# add-on install</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+addonInstallStarted=Downloading and installing add-on…</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineplus">+addonInstallSuccess=Successfully installed the add-on.</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+# LOCALIZATION NOTE(addonInstallLabel): %1$S will be the add-on name</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineplus">+addonInstallShortLabel=Install</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineplus">+</span>
<a href="#l15.69"></a><span id="l15.69"> #config result display</span>
<a href="#l15.70"></a><span id="l15.70"> # LOCALIZATION NOTE(resultUnknown): Displayed instead of resultIncoming,</span>
<a href="#l15.71"></a><span id="l15.71"> # resultOutgoing or resultUsername when we don't have a proper value.</span>
<a href="#l15.72"></a><span id="l15.72"> resultUnknown=Unknown</span>
<a href="#l15.73"></a><span id="l15.73"> # LOCALIZATION NOTE(resultIncoming):</span>
<a href="#l15.74"></a><span id="l15.74"> # %1$S will be replaced with either resultIMAP, resultPOP3 or resultSMTP.</span>
<a href="#l15.75"></a><span id="l15.75"> # %2$S will be replaced with the server hostname</span>
<a href="#l15.76"></a><span id="l15.76"> #   with possibly a port appended as &quot;:&quot;+port.</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineat">@@ -85,16 +99,17 @@ resultUnknown=Unknown</span>
<a href="#l15.78"></a><span id="l15.78"> # You may adjust the strings to be a real sentence.</span>
<a href="#l15.79"></a><span id="l15.79"> resultIncoming=%1$S, %2$S, %3$S%4$S</span>
<a href="#l15.80"></a><span id="l15.80"> # LOCALIZATION NOTE(resultOutgoing): see resultIncoming</span>
<a href="#l15.81"></a><span id="l15.81"> resultOutgoing=%1$S, %2$S, %3$S%4$S</span>
<a href="#l15.82"></a><span id="l15.82"> resultOutgoingExisting=Use existing outgoing SMTP server</span>
<a href="#l15.83"></a><span id="l15.83"> resultIMAP=IMAP</span>
<a href="#l15.84"></a><span id="l15.84"> resultPOP3=POP3</span>
<a href="#l15.85"></a><span id="l15.85"> resultSMTP=SMTP</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineplus">+resultExchange=Exchange</span>
<a href="#l15.87"></a><span id="l15.87"> # LOCALIZATION NOTE(resultNoEncryption): Neither SSL/TLS nor STARTTLS. Transmission of emails in cleartext over the Internet.</span>
<a href="#l15.88"></a><span id="l15.88"> resultNoEncryption=No Encryption</span>
<a href="#l15.89"></a><span id="l15.89"> resultSSL=SSL</span>
<a href="#l15.90"></a><span id="l15.90"> resultSTARTTLS=STARTTLS</span>
<a href="#l15.91"></a><span id="l15.91"> # LOCALIZATION NOTE(resultSSLCertWeak): \u0020 is just a space</span>
<a href="#l15.92"></a><span id="l15.92"> resultSSLCertWeak=\u0020(Warning: Could not verify server)</span>
<a href="#l15.93"></a><span id="l15.93"> resultSSLCertOK=</span>
<a href="#l15.94"></a><span id="l15.94"> resultUsernameBoth=%1$S</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/accountCreationModel.properties</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/accountCreationModel.properties</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -8,11 +8,13 @@</span>
<a href="#l16.4"></a><span id="l16.4"> </span>
<a href="#l16.5"></a><span id="l16.5"> # readFromXML.js</span>
<a href="#l16.6"></a><span id="l16.6"> no_emailProvider.error=The config file XML does not contain an email account configuration.</span>
<a href="#l16.7"></a><span id="l16.7"> outgoing_not_smtp.error=The outgoing server must be of type SMTP</span>
<a href="#l16.8"></a><span id="l16.8"> </span>
<a href="#l16.9"></a><span id="l16.9"> # verifyConfig.js</span>
<a href="#l16.10"></a><span id="l16.10"> cannot_login.error=Unable to log in at server. Probably wrong configuration, username or password.</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-</span>
<a href="#l16.13"></a><span id="l16.13"> # guessConfig.js</span>
<a href="#l16.14"></a><span id="l16.14"> cannot_find_server.error=Can't find a server</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+# exchangeAutoDiscover.js</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+no_autodiscover.error=The Exchange AutoDiscover XML is invalid.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/themes/linux/mail/accountCreation.css</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/themes/linux/mail/accountCreation.css</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -1,12 +1,14 @@</span>
<a href="#l17.4"></a><span id="l17.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.5"></a><span id="l17.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.6"></a><span id="l17.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.7"></a><span id="l17.7"> </span>
<a href="#l17.8"></a><span id="l17.8" class="difflineplus">+@import url(&quot;chrome://messenger/skin/shared/accountCreation.css&quot;);</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineplus">+</span>
<a href="#l17.10"></a><span id="l17.10"> /* ::::: BUTTONS ::::: */</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12"> .important-button {</span>
<a href="#l17.13"></a><span id="l17.13">   font-weight: bold;</span>
<a href="#l17.14"></a><span id="l17.14"> }</span>
<a href="#l17.15"></a><span id="l17.15"> </span>
<a href="#l17.16"></a><span id="l17.16"> .errordescription {</span>
<a href="#l17.17"></a><span id="l17.17">   color: InfoText;</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineat">@@ -237,24 +239,8 @@ textbox.port[disabled=&quot;true&quot;] {</span>
<a href="#l17.19"></a><span id="l17.19"> </span>
<a href="#l17.20"></a><span id="l17.20"> #outgoing_server_area {</span>
<a href="#l17.21"></a><span id="l17.21">   padding-top: 2px;</span>
<a href="#l17.22"></a><span id="l17.22"> }</span>
<a href="#l17.23"></a><span id="l17.23"> </span>
<a href="#l17.24"></a><span id="l17.24"> #incoming_protocol[disabled=&quot;true&quot;] {</span>
<a href="#l17.25"></a><span id="l17.25">   padding-left: 5px;</span>
<a href="#l17.26"></a><span id="l17.26"> }</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineminus">-</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineminus">-#initialSettings, #status_area {</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineminus">-  margin-bottom: 1em;</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineminus">-}</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-#result_area, #result_imappop {</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-  margin-bottom: 1.5em;</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineminus">-}</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineminus">-</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineminus">-#manual-edit_area {</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineminus">-  margin-bottom: 2em;</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineminus">-}</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineminus">-</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineminus">-#status_msg {</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineminus">-  min-height: 2em;</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mail/themes/osx/mail/accountCreation.css</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mail/themes/osx/mail/accountCreation.css</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1,12 +1,14 @@</span>
<a href="#l18.4"></a><span id="l18.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.5"></a><span id="l18.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.6"></a><span id="l18.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.7"></a><span id="l18.7"> </span>
<a href="#l18.8"></a><span id="l18.8" class="difflineplus">+@import url(&quot;chrome://messenger/skin/shared/accountCreation.css&quot;);</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineplus">+</span>
<a href="#l18.10"></a><span id="l18.10"> /* Missing:</span>
<a href="#l18.11"></a><span id="l18.11">  * .important-button</span>
<a href="#l18.12"></a><span id="l18.12">  */</span>
<a href="#l18.13"></a><span id="l18.13"> </span>
<a href="#l18.14"></a><span id="l18.14"> .errordescription {</span>
<a href="#l18.15"></a><span id="l18.15">   padding-inline-start: 3px;</span>
<a href="#l18.16"></a><span id="l18.16">   margin-top: 3px;</span>
<a href="#l18.17"></a><span id="l18.17"> }</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineat">@@ -220,24 +222,8 @@ menulist {</span>
<a href="#l18.19"></a><span id="l18.19"> </span>
<a href="#l18.20"></a><span id="l18.20"> textbox.port[disabled=&quot;true&quot;] {</span>
<a href="#l18.21"></a><span id="l18.21">   padding-top: 4px;</span>
<a href="#l18.22"></a><span id="l18.22"> }</span>
<a href="#l18.23"></a><span id="l18.23"> </span>
<a href="#l18.24"></a><span id="l18.24"> #incoming_protocol[disabled=&quot;true&quot;] {</span>
<a href="#l18.25"></a><span id="l18.25">   padding-left: 5px;</span>
<a href="#l18.26"></a><span id="l18.26"> }</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineminus">-</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineminus">-#initialSettings, #status_area {</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineminus">-  margin-bottom: 1em;</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineminus">-}</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineminus">-#result_area, #result_imappop {</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-  margin-bottom: 1.5em;</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineminus">-}</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineminus">-</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineminus">-#manual-edit_area {</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineminus">-  margin-bottom: 2em;</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineminus">-}</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineminus">-</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineminus">-#status_msg {</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineminus">-  min-height: 2em;</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mail/themes/shared/jar.inc.mn</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mail/themes/shared/jar.inc.mn</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -78,16 +78,17 @@</span>
<a href="#l19.4"></a><span id="l19.4">   skin/classic/messenger/icons/starred.svg                    (../shared/mail/icons/starred.svg)</span>
<a href="#l19.5"></a><span id="l19.5">   skin/classic/messenger/icons/sticky.svg                     (../shared/mail/icons/sticky.svg)</span>
<a href="#l19.6"></a><span id="l19.6">   skin/classic/messenger/icons/stop.svg                       (../shared/mail/icons/stop.svg)</span>
<a href="#l19.7"></a><span id="l19.7">   skin/classic/messenger/icons/tag.svg                        (../shared/mail/icons/tag.svg)</span>
<a href="#l19.8"></a><span id="l19.8">   skin/classic/messenger/icons/thread-col.svg                 (../shared/mail/icons/thread-col.svg)</span>
<a href="#l19.9"></a><span id="l19.9">   skin/classic/messenger/icons/timeline.svg                   (../shared/mail/icons/timeline.svg)</span>
<a href="#l19.10"></a><span id="l19.10">   skin/classic/messenger/icons/toolbarbutton-arrow.svg        (../shared/mail/icons/toolbarbutton-arrow.svg)</span>
<a href="#l19.11"></a><span id="l19.11">   skin/classic/messenger/icons/waiting.svg                    (../shared/mail/icons/waiting.svg)</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+  skin/classic/messenger/shared/accountCreation.css           (../shared/mail/accountCreation.css)</span>
<a href="#l19.13"></a><span id="l19.13">   skin/classic/messenger/shared/accountProvisioner.css        (../shared/mail/accountProvisioner.css)</span>
<a href="#l19.14"></a><span id="l19.14">   skin/classic/messenger/shared/addressbook.css               (../shared/mail/addressbook.css)</span>
<a href="#l19.15"></a><span id="l19.15">   skin/classic/messenger/shared/compacttheme.css              (../shared/mail/compacttheme.css)</span>
<a href="#l19.16"></a><span id="l19.16">   skin/classic/messenger/shared/in-content/dialog.css         (../shared/mail/incontentprefs/dialog.css)</span>
<a href="#l19.17"></a><span id="l19.17">   skin/classic/messenger/shared/in-content/aboutPreferences.css (../shared/mail/incontentprefs/aboutPreferences.css)</span>
<a href="#l19.18"></a><span id="l19.18">   skin/classic/messenger/shared/in-content/account.svg        (../shared/mail/incontentprefs/account.svg)</span>
<a href="#l19.19"></a><span id="l19.19">   skin/classic/messenger/shared/in-content/advanced.svg       (../shared/mail/incontentprefs/advanced.svg)</span>
<a href="#l19.20"></a><span id="l19.20">   skin/classic/messenger/shared/in-content/attachment.svg     (../shared/mail/incontentprefs/attachment.svg)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1">new file mode 100644</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineminus">--- /dev/null</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineplus">+++ b/mail/themes/shared/mail/accountCreation.css</span>
<a href="#l20.4"></a><span id="l20.4" class="difflineat">@@ -0,0 +1,79 @@</span>
<a href="#l20.5"></a><span id="l20.5" class="difflineplus">+#initialSettings {</span>
<a href="#l20.6"></a><span id="l20.6" class="difflineplus">+  margin-bottom: 1em;</span>
<a href="#l20.7"></a><span id="l20.7" class="difflineplus">+}</span>
<a href="#l20.8"></a><span id="l20.8" class="difflineplus">+</span>
<a href="#l20.9"></a><span id="l20.9" class="difflineplus">+#manual-edit_area {</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineplus">+  margin-bottom: 2em;</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineplus">+}</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+/* status area */</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+#status_msg {</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+  min-height: 1.5em;</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineplus">+}</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineplus">+</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineplus">+#status-lines {</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineplus">+  -moz-box-pack: start;</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineplus">+  -moz-box-flex: 10;</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineplus">+  margin-left: 10em;</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineplus">+}</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineplus">+</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineplus">+.status-line[status=&quot;loading&quot;] .status-img {</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineplus">+  background: url(&quot;chrome://global/skin/icons/loading.png&quot;) no-repeat;</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineplus">+  width: 16px;</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineplus">+  height: 16px;</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineplus">+}</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineplus">+</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+.status-line[status=&quot;failed&quot;] .status-img {</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+  background: url(&quot;chrome://messenger/skin/icons/exclude.png&quot;) no-repeat;</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+  width: 16px;</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+  height: 16px;</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineplus">+}</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineplus">+</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+.status-line[status=&quot;succeeded&quot;] .status-img {</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+  background: url(&quot;chrome://messenger/skin/icons/tick.png&quot;) no-repeat;</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+  width: 16px;</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineplus">+  height: 16px;</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+}</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineplus">+/* result area */</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineplus">+</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineplus">+#result_area {</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineplus">+  margin-bottom: 1em;</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineplus">+}</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineplus">+</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineplus">+#result_servertype {</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineplus">+  margin-bottom: 1.5em;</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineplus">+}</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineplus">+</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineplus">+#result_exchange_hostname_container {</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineplus">+  margin-bottom: 0.5em;</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineplus">+}</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineplus">+</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+#result_area description {</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineplus">+  margin-top: 0px;</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineplus">+  margin-bottom: 0px;</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineplus">+}</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineplus">+</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineplus">+#result_addon_intro {</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineplus">+  max-width: 40em;</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineplus">+}</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineplus">+</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineplus">+#result_addon_install {</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineplus">+  margin-top: 4px;</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineplus">+}</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineplus">+</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineplus">+#result_addon_install image.icon {</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineplus">+  width: 32px;</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineplus">+  height: 32px;</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineplus">+  margin-left: 0.4em;</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineplus">+  margin-right: 0.4em;</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineplus">+}</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineplus">+</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineplus">+#result_addon_install_column_link {</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineplus">+  max-width: 30em;</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineplus">+}</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineplus">+#result_addon_install_column_button {</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineplus">+  max-width: 10em;</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mail/themes/windows/mail/accountCreation.css</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mail/themes/windows/mail/accountCreation.css</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l21.4"></a><span id="l21.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l21.5"></a><span id="l21.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l21.6"></a><span id="l21.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l21.7"></a><span id="l21.7"> </span>
<a href="#l21.8"></a><span id="l21.8"> @namespace html url(&quot;http://www.w3.org/1999/xhtml&quot;);</span>
<a href="#l21.9"></a><span id="l21.9" class="difflineplus">+@import url(&quot;chrome://messenger/skin/shared/accountCreation.css&quot;);</span>
<a href="#l21.10"></a><span id="l21.10"> </span>
<a href="#l21.11"></a><span id="l21.11"> /* ::::: BUTTONS ::::: */</span>
<a href="#l21.12"></a><span id="l21.12"> </span>
<a href="#l21.13"></a><span id="l21.13"> .important-button {</span>
<a href="#l21.14"></a><span id="l21.14">   font-weight: bold;</span>
<a href="#l21.15"></a><span id="l21.15"> }</span>
<a href="#l21.16"></a><span id="l21.16"> </span>
<a href="#l21.17"></a><span id="l21.17"> /* Set the order of the buttons to: (stop|re-test), (continue|create account), cancel */</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineat">@@ -254,24 +255,8 @@ textbox.port[disabled=&quot;true&quot;] {</span>
<a href="#l21.19"></a><span id="l21.19"> </span>
<a href="#l21.20"></a><span id="l21.20"> #outgoing_server_area {</span>
<a href="#l21.21"></a><span id="l21.21">   padding-top: 2px;</span>
<a href="#l21.22"></a><span id="l21.22"> }</span>
<a href="#l21.23"></a><span id="l21.23"> </span>
<a href="#l21.24"></a><span id="l21.24"> #incoming_protocol[disabled=&quot;true&quot;] {</span>
<a href="#l21.25"></a><span id="l21.25">   padding-left: 6px;</span>
<a href="#l21.26"></a><span id="l21.26"> }</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineminus">-</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineminus">-#initialSettings, #status_area {</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineminus">-  margin-bottom: 1em;</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineminus">-}</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-#result_area, #result_imappop {</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineminus">-  margin-bottom: 1.5em;</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineminus">-}</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineminus">-</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineminus">-#manual-edit_area {</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineminus">-  margin-bottom: 2em;</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineminus">-}</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineminus">-</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineminus">-#status_msg {</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineminus">-  min-height: 2em;</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/mailnews.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/mailnews.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -894,23 +894,35 @@ pref(&quot;dom.max_chrome_script_run_time&quot;, 0</span>
<a href="#l22.4"></a><span id="l22.4"> // For the Empty Junk/Trash confirmation dialogs.</span>
<a href="#l22.5"></a><span id="l22.5"> pref(&quot;mailnews.emptyJunk.dontAskAgain&quot;, false);</span>
<a href="#l22.6"></a><span id="l22.6"> pref(&quot;mailnews.emptyTrash.dontAskAgain&quot;, false);</span>
<a href="#l22.7"></a><span id="l22.7"> </span>
<a href="#l22.8"></a><span id="l22.8"> // where to fetch auto config information from.</span>
<a href="#l22.9"></a><span id="l22.9"> pref(&quot;mailnews.auto_config_url&quot;, &quot;https://live.thunderbird.net/autoconfig/v1.1/&quot;);</span>
<a href="#l22.10"></a><span id="l22.10"> // Added in bug 551519. Remove when bug 545866 is fixed.</span>
<a href="#l22.11"></a><span id="l22.11"> pref(&quot;mailnews.mx_service_url&quot;, &quot;https://live.thunderbird.net/dns/mx/&quot;);</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+// The list of addons which can handle certain account types</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+#ifdef RELEASE_OR_BETA</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineplus">+pref(&quot;mailnews.auto_config.addons_url&quot;, &quot;https://live.thunderbird.net/autoconfig/addons.json&quot;);</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+#else</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+pref(&quot;mailnews.auto_config.addons_url&quot;, &quot;http://www.beonex.com/owl/addons-test.json&quot;);</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineplus">+#endif</span>
<a href="#l22.18"></a><span id="l22.18"> // Allow to contact ISP (email address domain)</span>
<a href="#l22.19"></a><span id="l22.19"> // This happens via insecure means (HTTP), so the config cannot be trusted,</span>
<a href="#l22.20"></a><span id="l22.20"> // and also contains the email address</span>
<a href="#l22.21"></a><span id="l22.21"> pref(&quot;mailnews.auto_config.fetchFromISP.enabled&quot;, true);</span>
<a href="#l22.22"></a><span id="l22.22"> // Allow the fetch from ISP via HTTP, but not the email address</span>
<a href="#l22.23"></a><span id="l22.23"> pref(&quot;mailnews.auto_config.fetchFromISP.sendEmailAddress&quot;, true);</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineplus">+// Allow the Microsoft Exchange AutoDiscover protocol.</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineplus">+// This also sends the email address and password to the server,</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineplus">+// which the protocol unfortunately requires in practice.</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineplus">+pref(&quot;mailnews.auto_config.fetchFromExchange.enabled&quot;, true);</span>
<a href="#l22.28"></a><span id="l22.28"> pref(&quot;mailnews.auto_config.guess.enabled&quot;, true);</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineplus">+// Work around bug 1454325 by disabling mimetype mungling in XmlHttpRequest</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineplus">+pref(&quot;dom.xhr.standard_content_type_normalization&quot;, false);</span>
<a href="#l22.31"></a><span id="l22.31"> </span>
<a href="#l22.32"></a><span id="l22.32"> // -- Summary Database options</span>
<a href="#l22.33"></a><span id="l22.33"> // dontPreserveOnCopy: a space separated list of properties that are not</span>
<a href="#l22.34"></a><span id="l22.34"> //                     copied to the new nsIMsgHdr when a message is copied.</span>
<a href="#l22.35"></a><span id="l22.35"> //                     Allows extensions to control preservation of properties.</span>
<a href="#l22.36"></a><span id="l22.36"> pref(&quot;mailnews.database.summary.dontPreserveOnCopy&quot;,</span>
<a href="#l22.37"></a><span id="l22.37">   &quot;account msgOffset threadParent msgThreadId statusOfset flags size numLines ProtoThreadFlags label gloda-id gloda-dirty storeToken&quot;);</span>
<a href="#l22.38"></a><span id="l22.38"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

