<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 2160:99320ed86776308bad01657cd5655caaf2ede04a</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 99320ed86776308bad01657cd5655caaf2ede04a" />
<meta property="og:url" content="/comm-central/rev/99320ed86776308bad01657cd5655caaf2ede04a" />
<meta property="og:description" content="Bug 479214 - Gloda JS mime emitter needs to deal with character set and encoding issues. revised v2 convert startAttachment/writeBody/write signatures on nsIMimeEmitter. r=neil,sr=bienvenu." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 99320ed86776308bad01657cd5655caaf2ede04a 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/99320ed86776308bad01657cd5655caaf2ede04a">shortlog</a> |
<a href="/comm-central/log/99320ed86776308bad01657cd5655caaf2ede04a">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/99320ed86776308bad01657cd5655caaf2ede04a">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/99320ed86776308bad01657cd5655caaf2ede04a">files</a> |
changeset |
<a href="/comm-central/raw-rev/99320ed86776308bad01657cd5655caaf2ede04a">raw</a>  | <a href="/comm-central/archive/99320ed86776308bad01657cd5655caaf2ede04a.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=479214">Bug 479214</a> - Gloda JS mime emitter needs to deal with character set and encoding issues. revised v2 convert startAttachment/writeBody/write signatures on nsIMimeEmitter. r=neil,sr=bienvenu.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 08 Mar 2009 15:25:01 -0700</td></tr>

<tr>
 <td>changeset 2160</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/99320ed86776308bad01657cd5655caaf2ede04a">99320ed86776308bad01657cd5655caaf2ede04a</a></td>
</tr>



<tr>
<td>parent 2159</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/694a773f7a8a9526b97422fd45e3de9d30ce6366">694a773f7a8a9526b97422fd45e3de9d30ce6366</a>
</td>
</tr>

<tr>
<td>child 2161</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/36423d81646ff720872cd053fb41457282cdcc64">36423d81646ff720872cd053fb41457282cdcc64</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=99320ed86776308bad01657cd5655caaf2ede04a">1749</a></td></tr>
<tr><td>push user</td><td>bugmail@asutherland.org</td></tr>
<tr><td>push date</td><td class="date age">Sun, 08 Mar 2009 22:25:19 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@99320ed86776 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=99320ed86776308bad01657cd5655caaf2ede04a">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=99320ed86776308bad01657cd5655caaf2ede04a&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=99320ed86776308bad01657cd5655caaf2ede04a&newProject=comm-central&newRevision=99320ed86776308bad01657cd5655caaf2ede04a&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=99320ed86776308bad01657cd5655caaf2ede04a&newProject=comm-central&newRevision=99320ed86776308bad01657cd5655caaf2ede04a&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=99320ed86776308bad01657cd5655caaf2ede04a&newProject=comm-central&newRevision=99320ed86776308bad01657cd5655caaf2ede04a&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28neil%29&revcount=50">neil</a>, <a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=479214">479214</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=479214">Bug 479214</a> - Gloda JS mime emitter needs to deal with character set and encoding issues. revised v2 convert startAttachment/writeBody/write signatures on nsIMimeEmitter. r=neil,sr=bienvenu.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/components/jsmimeemitter.js">mailnews/db/gloda/components/jsmimeemitter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/components/jsmimeemitter.js">file</a> |
<a href="/comm-central/annotate/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/components/jsmimeemitter.js">annotate</a> |
<a href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/components/jsmimeemitter.js">diff</a> |
<a href="/comm-central/comparison/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/components/jsmimeemitter.js">comparison</a> |
<a href="/comm-central/log/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/components/jsmimeemitter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/modules/indexer.js">mailnews/db/gloda/modules/indexer.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/modules/indexer.js">file</a> |
<a href="/comm-central/annotate/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/modules/indexer.js">annotate</a> |
<a href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/modules/indexer.js">diff</a> |
<a href="/comm-central/comparison/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/modules/indexer.js">comparison</a> |
<a href="/comm-central/log/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/modules/indexer.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/test/resources/glodaTestHelper.js">mailnews/db/gloda/test/resources/glodaTestHelper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/test/resources/glodaTestHelper.js">file</a> |
<a href="/comm-central/annotate/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/test/resources/glodaTestHelper.js">annotate</a> |
<a href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/test/resources/glodaTestHelper.js">diff</a> |
<a href="/comm-central/comparison/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/test/resources/glodaTestHelper.js">comparison</a> |
<a href="/comm-central/log/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/test/resources/glodaTestHelper.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/test/resources/messageGenerator.js">mailnews/db/gloda/test/resources/messageGenerator.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/test/resources/messageGenerator.js">file</a> |
<a href="/comm-central/annotate/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/test/resources/messageGenerator.js">annotate</a> |
<a href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/test/resources/messageGenerator.js">diff</a> |
<a href="/comm-central/comparison/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/test/resources/messageGenerator.js">comparison</a> |
<a href="/comm-central/log/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/test/resources/messageGenerator.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/test/unit/test_intl.js">mailnews/db/gloda/test/unit/test_intl.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/test/unit/test_intl.js">file</a> |
<a href="/comm-central/annotate/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/test/unit/test_intl.js">annotate</a> |
<a href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/test/unit/test_intl.js">diff</a> |
<a href="/comm-central/comparison/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/test/unit/test_intl.js">comparison</a> |
<a href="/comm-central/log/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/test/unit/test_intl.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/test/unit/test_query_messages.js">mailnews/db/gloda/test/unit/test_query_messages.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/test/unit/test_query_messages.js">file</a> |
<a href="/comm-central/annotate/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/test/unit/test_query_messages.js">annotate</a> |
<a href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/test/unit/test_query_messages.js">diff</a> |
<a href="/comm-central/comparison/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/test/unit/test_query_messages.js">comparison</a> |
<a href="/comm-central/log/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/db/gloda/test/unit/test_query_messages.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeBaseEmitter.cpp">mailnews/mime/emitters/src/nsMimeBaseEmitter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeBaseEmitter.cpp">file</a> |
<a href="/comm-central/annotate/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeBaseEmitter.cpp">annotate</a> |
<a href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeBaseEmitter.cpp">diff</a> |
<a href="/comm-central/comparison/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeBaseEmitter.cpp">comparison</a> |
<a href="/comm-central/log/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeBaseEmitter.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeBaseEmitter.h">mailnews/mime/emitters/src/nsMimeBaseEmitter.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeBaseEmitter.h">file</a> |
<a href="/comm-central/annotate/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeBaseEmitter.h">annotate</a> |
<a href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeBaseEmitter.h">diff</a> |
<a href="/comm-central/comparison/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeBaseEmitter.h">comparison</a> |
<a href="/comm-central/log/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeBaseEmitter.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeHtmlEmitter.cpp">mailnews/mime/emitters/src/nsMimeHtmlEmitter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeHtmlEmitter.cpp">file</a> |
<a href="/comm-central/annotate/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeHtmlEmitter.cpp">annotate</a> |
<a href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeHtmlEmitter.cpp">diff</a> |
<a href="/comm-central/comparison/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeHtmlEmitter.cpp">comparison</a> |
<a href="/comm-central/log/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeHtmlEmitter.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeHtmlEmitter.h">mailnews/mime/emitters/src/nsMimeHtmlEmitter.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeHtmlEmitter.h">file</a> |
<a href="/comm-central/annotate/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeHtmlEmitter.h">annotate</a> |
<a href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeHtmlEmitter.h">diff</a> |
<a href="/comm-central/comparison/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeHtmlEmitter.h">comparison</a> |
<a href="/comm-central/log/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeHtmlEmitter.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimePlainEmitter.cpp">mailnews/mime/emitters/src/nsMimePlainEmitter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimePlainEmitter.cpp">file</a> |
<a href="/comm-central/annotate/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimePlainEmitter.cpp">annotate</a> |
<a href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimePlainEmitter.cpp">diff</a> |
<a href="/comm-central/comparison/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimePlainEmitter.cpp">comparison</a> |
<a href="/comm-central/log/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimePlainEmitter.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimePlainEmitter.h">mailnews/mime/emitters/src/nsMimePlainEmitter.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimePlainEmitter.h">file</a> |
<a href="/comm-central/annotate/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimePlainEmitter.h">annotate</a> |
<a href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimePlainEmitter.h">diff</a> |
<a href="/comm-central/comparison/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimePlainEmitter.h">comparison</a> |
<a href="/comm-central/log/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimePlainEmitter.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeRawEmitter.cpp">mailnews/mime/emitters/src/nsMimeRawEmitter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeRawEmitter.cpp">file</a> |
<a href="/comm-central/annotate/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeRawEmitter.cpp">annotate</a> |
<a href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeRawEmitter.cpp">diff</a> |
<a href="/comm-central/comparison/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeRawEmitter.cpp">comparison</a> |
<a href="/comm-central/log/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeRawEmitter.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeRawEmitter.h">mailnews/mime/emitters/src/nsMimeRawEmitter.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeRawEmitter.h">file</a> |
<a href="/comm-central/annotate/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeRawEmitter.h">annotate</a> |
<a href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeRawEmitter.h">diff</a> |
<a href="/comm-central/comparison/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeRawEmitter.h">comparison</a> |
<a href="/comm-central/log/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeRawEmitter.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeXmlEmitter.cpp">mailnews/mime/emitters/src/nsMimeXmlEmitter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeXmlEmitter.cpp">file</a> |
<a href="/comm-central/annotate/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeXmlEmitter.cpp">annotate</a> |
<a href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeXmlEmitter.cpp">diff</a> |
<a href="/comm-central/comparison/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeXmlEmitter.cpp">comparison</a> |
<a href="/comm-central/log/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeXmlEmitter.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeXmlEmitter.h">mailnews/mime/emitters/src/nsMimeXmlEmitter.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeXmlEmitter.h">file</a> |
<a href="/comm-central/annotate/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeXmlEmitter.h">annotate</a> |
<a href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeXmlEmitter.h">diff</a> |
<a href="/comm-central/comparison/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeXmlEmitter.h">comparison</a> |
<a href="/comm-central/log/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/emitters/src/nsMimeXmlEmitter.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/public/nsIMimeEmitter.idl">mailnews/mime/public/nsIMimeEmitter.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/public/nsIMimeEmitter.idl">file</a> |
<a href="/comm-central/annotate/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/public/nsIMimeEmitter.idl">annotate</a> |
<a href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/public/nsIMimeEmitter.idl">diff</a> |
<a href="/comm-central/comparison/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/public/nsIMimeEmitter.idl">comparison</a> |
<a href="/comm-central/log/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/public/nsIMimeEmitter.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/src/mimemoz2.cpp">mailnews/mime/src/mimemoz2.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/src/mimemoz2.cpp">file</a> |
<a href="/comm-central/annotate/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/src/mimemoz2.cpp">annotate</a> |
<a href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/src/mimemoz2.cpp">diff</a> |
<a href="/comm-central/comparison/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/src/mimemoz2.cpp">comparison</a> |
<a href="/comm-central/log/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/src/mimemoz2.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/src/nsStreamConverter.cpp">mailnews/mime/src/nsStreamConverter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/src/nsStreamConverter.cpp">file</a> |
<a href="/comm-central/annotate/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/src/nsStreamConverter.cpp">annotate</a> |
<a href="/comm-central/diff/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/src/nsStreamConverter.cpp">diff</a> |
<a href="/comm-central/comparison/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/src/nsStreamConverter.cpp">comparison</a> |
<a href="/comm-central/log/99320ed86776308bad01657cd5655caaf2ede04a/mailnews/mime/src/nsStreamConverter.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/db/gloda/components/jsmimeemitter.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/db/gloda/components/jsmimeemitter.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -375,18 +375,17 @@ MimeMessageEmitter.prototype = {</span>
<a href="#l1.4"></a><span id="l1.4">     if (this._parentMsg.partName == &quot;&quot;)</span>
<a href="#l1.5"></a><span id="l1.5">       this._curPart.partName = &quot;1&quot;;</span>
<a href="#l1.6"></a><span id="l1.6">     else</span>
<a href="#l1.7"></a><span id="l1.7">       this._curPart.partName = this._curMsg.partName + &quot;.1&quot;;</span>
<a href="#l1.8"></a><span id="l1.8">     this._placePart(this._curPart);</span>
<a href="#l1.9"></a><span id="l1.9">   },</span>
<a href="#l1.10"></a><span id="l1.10">   </span>
<a href="#l1.11"></a><span id="l1.11">   writeBody: function mime_emitter_writeBody(aBuf, aSize, aOutAmountWritten) {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    if (this._curBodyPart)</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-      this._curBodyPart.body += aBuf;</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+    this._curBodyPart.body += aBuf;</span>
<a href="#l1.15"></a><span id="l1.15">   },</span>
<a href="#l1.16"></a><span id="l1.16">   </span>
<a href="#l1.17"></a><span id="l1.17">   endBody: function mime_emitter_endBody() {</span>
<a href="#l1.18"></a><span id="l1.18">     this._messageStack.pop();</span>
<a href="#l1.19"></a><span id="l1.19">     this._parentMsg = this._messageStack[this._messageStack.length - 1];</span>
<a href="#l1.20"></a><span id="l1.20">   },</span>
<a href="#l1.21"></a><span id="l1.21">   </span>
<a href="#l1.22"></a><span id="l1.22">   // ----- Generic Write (confusing)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/db/gloda/modules/indexer.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/indexer.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -2328,20 +2328,22 @@ var GlodaIndexer = {</span>
<a href="#l2.4"></a><span id="l2.4">   </span>
<a href="#l2.5"></a><span id="l2.5">   _indexMessage: function gloda_indexMessage(aMsgHdr, aCallbackHandle) {</span>
<a href="#l2.6"></a><span id="l2.6">     this._log.debug(&quot;*** Indexing message: &quot; + aMsgHdr.messageKey + &quot; : &quot; +</span>
<a href="#l2.7"></a><span id="l2.7">                     aMsgHdr.subject);</span>
<a href="#l2.8"></a><span id="l2.8">     MsgHdrToMimeMessage(aMsgHdr, aCallbackHandle.callbackThis,</span>
<a href="#l2.9"></a><span id="l2.9">         aCallbackHandle.callback);</span>
<a href="#l2.10"></a><span id="l2.10">     let [,aMimeMsg] = yield this.kWorkAsync;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    if (aMimeMsg)</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-      this._log.debug(&quot;  * Got Mime Message!&quot;);</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-    else</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-      this._log.debug(&quot;  * Did not get body!&quot;);</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+    if (this._unitTestSuperVerbose) {</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+      if (aMimeMsg)</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+        this._log.debug(&quot;  * Got Mime &quot; + aMimeMsg.prettyString());</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+      else</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+        this._log.debug(&quot;  * NO MIME MESSAGE!!!\n&quot;);</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+    }</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23">     // -- Find/create the conversation the message belongs to.</span>
<a href="#l2.24"></a><span id="l2.24">     // Our invariant is that all messages that exist in the database belong to</span>
<a href="#l2.25"></a><span id="l2.25">     //  a conversation.</span>
<a href="#l2.26"></a><span id="l2.26">     </span>
<a href="#l2.27"></a><span id="l2.27">     // - See if any of the ancestors exist and have a conversationID...</span>
<a href="#l2.28"></a><span id="l2.28">     // (references are ordered from old [0] to new [n-1])</span>
<a href="#l2.29"></a><span id="l2.29">     let references = [aMsgHdr.getStringReference(i) for each</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/db/gloda/test/resources/glodaTestHelper.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/db/gloda/test/resources/glodaTestHelper.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -215,16 +215,18 @@ function imsInit() {</span>
<a href="#l3.4"></a><span id="l3.4">     prefSvc.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l3.5"></a><span id="l3.5">     prefSvc.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l3.6"></a><span id="l3.6">     prefSvc.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l3.7"></a><span id="l3.7">   </span>
<a href="#l3.8"></a><span id="l3.8">     Gloda.addIndexerListener(messageIndexerListener.onIndexNotification);</span>
<a href="#l3.9"></a><span id="l3.9">     ims.catchAllCollection = Gloda._wildcardCollection(Gloda.NOUN_MESSAGE);</span>
<a href="#l3.10"></a><span id="l3.10">     ims.catchAllCollection.listener = messageCollectionListener;</span>
<a href="#l3.11"></a><span id="l3.11">     </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+    // Make the indexer be more verbose about indexing for us...</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+    GlodaIndexer._unitTestSuperVerbose = true;</span>
<a href="#l3.14"></a><span id="l3.14">     // The indexer doesn't need to worry about load; zero his rescheduling time. </span>
<a href="#l3.15"></a><span id="l3.15">     GlodaIndexer._indexInterval = 0;</span>
<a href="#l3.16"></a><span id="l3.16">     // And it doesn't need to adjust its performance, either.</span>
<a href="#l3.17"></a><span id="l3.17">     GlodaIndexer._PERF_SAMPLE_RATE_MS = 24 * 60 * 60 * 1000;</span>
<a href="#l3.18"></a><span id="l3.18">     </span>
<a href="#l3.19"></a><span id="l3.19">     if (ims.injectMechanism == INJECT_FAKE_SERVER) {</span>
<a href="#l3.20"></a><span id="l3.20">       // set up POP3 fakeserver to feed things in...</span>
<a href="#l3.21"></a><span id="l3.21">       [ims.daemon, ims.server] = setupServerDaemon();</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -808,16 +810,17 @@ QueryExpectationListener.prototype = {</span>
<a href="#l3.23"></a><span id="l3.23">     //  is, so let's become explicit to avoid related troubles.</span>
<a href="#l3.24"></a><span id="l3.24">     aCollection.becomeExplicit();</span>
<a href="#l3.25"></a><span id="l3.25">     </span>
<a href="#l3.26"></a><span id="l3.26">     // expectedSet should now be empty</span>
<a href="#l3.27"></a><span id="l3.27">     for each (let [key, value] in this.expectedSet) {</span>
<a href="#l3.28"></a><span id="l3.28">       do_throw(&quot;Query should have returned &quot; + key + &quot;(&quot; + value + &quot;)&quot;);</span>
<a href="#l3.29"></a><span id="l3.29">     }</span>
<a href="#l3.30"></a><span id="l3.30">     </span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+    dump(&quot;&gt;&gt;&gt; queryCompleted, advancing to next test\n&quot;);</span>
<a href="#l3.32"></a><span id="l3.32">     next_test();</span>
<a href="#l3.33"></a><span id="l3.33">   },</span>
<a href="#l3.34"></a><span id="l3.34"> }</span>
<a href="#l3.35"></a><span id="l3.35"> </span>
<a href="#l3.36"></a><span id="l3.36"> /**</span>
<a href="#l3.37"></a><span id="l3.37">  * Execute the given query, verifying that the result set contains exactly the</span>
<a href="#l3.38"></a><span id="l3.38">  *  contents of the expected set; no more, no less.  Since we expect that the</span>
<a href="#l3.39"></a><span id="l3.39">  *  query will result in gloda objects, but your expectations will not be posed</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineat">@@ -910,18 +913,30 @@ function notifyWhenDatastoreDone(aCallba</span>
<a href="#l3.41"></a><span id="l3.41"> </span>
<a href="#l3.42"></a><span id="l3.42"> var glodaHelperTests = [];</span>
<a href="#l3.43"></a><span id="l3.43"> var glodaHelperIterator = null;</span>
<a href="#l3.44"></a><span id="l3.44"> </span>
<a href="#l3.45"></a><span id="l3.45"> function _gh_test_iterator() {</span>
<a href="#l3.46"></a><span id="l3.46">   do_test_pending();</span>
<a href="#l3.47"></a><span id="l3.47"> </span>
<a href="#l3.48"></a><span id="l3.48">   for (let iTest=0; iTest &lt; glodaHelperTests.length; iTest++) {</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-    dump(&quot;====== Test function: &quot; + glodaHelperTests[iTest].name + &quot;\n&quot;);</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-    yield glodaHelperTests[iTest]();</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+    let test = glodaHelperTests[iTest];</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+    // deal with parameterized tests (via parameterizeTest)</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+    if (test.length) {</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+      let [testFunc, parameters] = test;</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+      for each (let [, parameter] in Iterator(parameters)) {</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+        dump(&quot;====== Test function: &quot; + testFunc.name + &quot; Parameter: &quot; +</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+             parameter.name + &quot;\n&quot;);</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+        yield testFunc(parameter);</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+      }</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+    }</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+    else {</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+      dump(&quot;====== Test function: &quot; + test.name + &quot;\n&quot;);</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+      yield test();</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+    }</span>
<a href="#l3.65"></a><span id="l3.65">   }</span>
<a href="#l3.66"></a><span id="l3.66"> </span>
<a href="#l3.67"></a><span id="l3.67">   if (indexMessageState.injectMechanism == INJECT_FAKE_SERVER) {</span>
<a href="#l3.68"></a><span id="l3.68">     killFakeServer();</span>
<a href="#l3.69"></a><span id="l3.69">   }</span>
<a href="#l3.70"></a><span id="l3.70"> </span>
<a href="#l3.71"></a><span id="l3.71">   do_test_finished();</span>
<a href="#l3.72"></a><span id="l3.72">   </span>
<a href="#l3.73"></a><span id="l3.73" class="difflineat">@@ -948,16 +963,28 @@ function next_test() {</span>
<a href="#l3.74"></a><span id="l3.74">     do_throw(&quot;Caught an exception during execution of next_test: &quot; + ex);</span>
<a href="#l3.75"></a><span id="l3.75">   }</span>
<a href="#l3.76"></a><span id="l3.76">   _next_test_currently_in_test = false;</span>
<a href="#l3.77"></a><span id="l3.77"> }</span>
<a href="#l3.78"></a><span id="l3.78"> </span>
<a href="#l3.79"></a><span id="l3.79"> DEFAULT_LONGEST_TEST_RUN_CONCEIVABLE_SECS = 180;</span>
<a href="#l3.80"></a><span id="l3.80"> </span>
<a href="#l3.81"></a><span id="l3.81"> /**</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+ * Purely decorative function to help explain to people reading lists of tests</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+ *  using glodaHelperRunTests what is going on.  We just return a tuple of our</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+ *  arguments and _gh_test_iterator understands what to do with this, namely</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+ *  to run the test once for each element in the aParameters list.  If the</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+ *  elements in the aParameters list have a 'name' attribute, it will get</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+ *  printed out to help figure out what is actually happening.</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+ */</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+function parameterizeTest(aTestFunc, aParameters) {</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+  return [aTestFunc, aParameters];</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+}</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+/**</span>
<a href="#l3.94"></a><span id="l3.94">  * Test driving logic that takes a list of tests to run.  Every completed test</span>
<a href="#l3.95"></a><span id="l3.95">  *  needs to call (or cause to be called) next_test.</span>
<a href="#l3.96"></a><span id="l3.96">  * </span>
<a href="#l3.97"></a><span id="l3.97">  * @param aTests A list of test functions to call.</span>
<a href="#l3.98"></a><span id="l3.98">  * @param aLongestTestRunTimeConceivableInSecs Optional parameter </span>
<a href="#l3.99"></a><span id="l3.99">  */</span>
<a href="#l3.100"></a><span id="l3.100"> function glodaHelperRunTests(aTests, aLongestTestRunTimeConceivableInSecs) {</span>
<a href="#l3.101"></a><span id="l3.101">   if (aLongestTestRunTimeConceivableInSecs == null)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/db/gloda/test/resources/messageGenerator.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/db/gloda/test/resources/messageGenerator.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,16 +1,16 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l4.5"></a><span id="l4.5">  *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l4.6"></a><span id="l4.6">  *</span>
<a href="#l4.7"></a><span id="l4.7">  * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l4.8"></a><span id="l4.8">  * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l4.9"></a><span id="l4.9">  * the License. You may obtain a copy of the License at</span>
<a href="#l4.10"></a><span id="l4.10">  * http://www.mozilla.org/MPL/</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineminus">- * </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+ *</span>
<a href="#l4.13"></a><span id="l4.13">  * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l4.14"></a><span id="l4.14">  * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l4.15"></a><span id="l4.15">  * for the specific language governing rights and limitations under the</span>
<a href="#l4.16"></a><span id="l4.16">  * License.</span>
<a href="#l4.17"></a><span id="l4.17">  *</span>
<a href="#l4.18"></a><span id="l4.18">  * The Original Code is Thunderbird Global Database.</span>
<a href="#l4.19"></a><span id="l4.19">  *</span>
<a href="#l4.20"></a><span id="l4.20">  * The Initial Developer of the Original Code is</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineat">@@ -93,25 +93,130 @@ const SUBJECT_NOUNS = [</span>
<a href="#l4.22"></a><span id="l4.22">  *  your additions don't break the secret Monty Python reference!</span>
<a href="#l4.23"></a><span id="l4.23">  */</span>
<a href="#l4.24"></a><span id="l4.24"> const SUBJECT_SUFFIXES = [</span>
<a href="#l4.25"></a><span id="l4.25">   &quot;Today&quot;, &quot;Tomorrow&quot;, &quot;Yesterday&quot;, &quot;In a Fortnight&quot;,</span>
<a href="#l4.26"></a><span id="l4.26">   &quot;Needs Attention&quot;, &quot;Very Important&quot;, &quot;Highest Priority&quot;, &quot;Full Of Eels&quot;,</span>
<a href="#l4.27"></a><span id="l4.27">   &quot;In The Lobby&quot;, &quot;On Your Desk&quot;, &quot;In Your Car&quot;, &quot;Hiding Behind The Door&quot;,</span>
<a href="#l4.28"></a><span id="l4.28">   ];</span>
<a href="#l4.29"></a><span id="l4.29"> </span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+/**</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+ * Base class for MIME Part representation.</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+ */</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+function SyntheticPart(aProperties) {</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+  if (aProperties) {</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+    if (aProperties.charset)</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+      this._charset = aProperties.charset;</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+    if (aProperties.format)</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+      this._format = aProperties.format;</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+    if (aProperties.filename)</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+      this._filename = aProperties.filename;</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+    if (aProperties.boundary)</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+      this._boundary = aProperties.boundary;</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+  }</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+}</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+SyntheticPart.prototype = {</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+  get contentTypeHeaderValue() {</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+    s = this._contentType;</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+    if (this._charset)</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+      s += '; charset=' + this._charset;</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+    if (this._format)</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+      s += '; format=' + this._format;</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+    if (this._filename)</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+      s += ';\r\n name=&quot;' + this._filename +'&quot;'</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+    if (this._boundary)</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+      s += ';\r\n boundary=&quot;' + this._boundary + '&quot;';</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+    return s;</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+  },</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+  get hasTransferEncoding() {</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+    return this._encoding;</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+  },</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+  get contentTransferEncodingHeaderValue() {</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+    return this._encoding;</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+  },</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+  get hasDisposition() {</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+    return this._filename;</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+  },</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+  get contentDispositionHeaderValue() {</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+    s = '';</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+    if (this._filename)</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+      s += 'attachment;\r\n filename=&quot;' + this._filename + '&quot;';</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+    return s;</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+  },</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+};</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+/**</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+ * Leaf MIME part, defaulting to text/plain.</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+ */</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+function SyntheticPartLeaf(aBody, aProperties) {</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+  SyntheticPart.call(this, aProperties);</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+  this.body = aBody;</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+}</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+SyntheticPartLeaf.prototype = {</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+  __proto__: SyntheticPart.prototype,</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+  _contentType: 'text/plain',</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+  _charset: 'ISO-8859-1',</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+  _format: 'flowed',</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+  _encoding: '7bit',</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+  toMessageString: function() {</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+    return this.body;</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+  }</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+}</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+/**</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+ * Multipart (multipart/*) MIME part base class.</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+ */</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+function SyntheticPartMulti(aParts, aProperties) {</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+  SyntheticPart.call(this, aProperties);</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+  this._boundary = '--------------CHOPCHOP' + this.BOUNDARY_COUNTER;</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+  this.__proto__.BOUNDARY_COUNTER += 1;</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+  this.parts = (aParts != null) ? aParts : [];</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+}</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+SyntheticPartMulti.prototype = {</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+  __proto__: SyntheticPart.prototype,</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+  BOUNDARY_COUNTER: 0,</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+  toMessageString: function() {</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+    s = &quot;This is a multi-part message in MIME format.\r\n&quot;;</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+    for (let [,part] in Iterator(this.parts)) {</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+      s += &quot;--&quot; + this._boundary + &quot;\r\n&quot;;</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+      s += &quot;Content-Type: &quot; + part.contentTypeHeaderValue + '\r\n';</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+      if (part.hasTransferEncoding)</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+        s += 'Content-Transfer-Encoding: ' +</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+             part.contentTransferEncodingHeaderValue + '\r\n';</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+      if (part.hasDisposition)</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+        s += 'Content-Disposition: ' + part.contentDispositionHeaderValue +</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+             '\r\n';</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+      s += '\r\n';</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+      s += part.toMessageString() + '\r\n\r\n';</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+    }</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+    s += &quot;--&quot; + this._boundary + '--';</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+    return s;</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+  },</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+};</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+/**</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+ * Multipart mixed (multipart/mixed) MIME part.</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+ */</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+function SyntheticPartMultiMixed() {</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+  SyntheticPartMulti.apply(this, arguments);</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+}</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+SyntheticPartMultiMixed.prototype = {</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+  __proto__: SyntheticPartMulti.prototype,</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+  _contentType: 'multipart/mixed',</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+}</span>
<a href="#l4.135"></a><span id="l4.135"> </span>
<a href="#l4.136"></a><span id="l4.136"> /**</span>
<a href="#l4.137"></a><span id="l4.137">  * A synthetic message, created by the MessageGenerator.  Captures both the</span>
<a href="#l4.138"></a><span id="l4.138">  *  ingredients that went into the synthetic message as well as the rfc822 form</span>
<a href="#l4.139"></a><span id="l4.139">  *  of the message.</span>
<a href="#l4.140"></a><span id="l4.140">  */</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineminus">-function SyntheticMessage(aHeaders, aBody) {</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+function SyntheticMessage(aHeaders, aBodyPart) {</span>
<a href="#l4.143"></a><span id="l4.143">   this.headers = aHeaders || {};</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineminus">-  this.body = aBody || &quot;&quot;;</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+  this.bodyPart = aBodyPart || new SyntheticPartLeaf(&quot;&quot;);</span>
<a href="#l4.146"></a><span id="l4.146"> }</span>
<a href="#l4.147"></a><span id="l4.147"> </span>
<a href="#l4.148"></a><span id="l4.148"> SyntheticMessage.prototype = {</span>
<a href="#l4.149"></a><span id="l4.149">   /** @returns the Message-Id header value. */</span>
<a href="#l4.150"></a><span id="l4.150">   get messageId() { return this._messageId; },</span>
<a href="#l4.151"></a><span id="l4.151">   /**</span>
<a href="#l4.152"></a><span id="l4.152">    * Sets the Message-Id header value.</span>
<a href="#l4.153"></a><span id="l4.153">    *</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineat">@@ -236,31 +341,39 @@ SyntheticMessage.prototype = {</span>
<a href="#l4.155"></a><span id="l4.155">    */</span>
<a href="#l4.156"></a><span id="l4.156">   set cc(aNameAndAddresses) {</span>
<a href="#l4.157"></a><span id="l4.157">     this._cc = aNameAndAddresses;</span>
<a href="#l4.158"></a><span id="l4.158">     this.headers[&quot;Cc&quot;] = this._commaize(</span>
<a href="#l4.159"></a><span id="l4.159">                            [this._formatMailFromNameAndAddress(nameAndAddr)</span>
<a href="#l4.160"></a><span id="l4.160">                             for each (nameAndAddr in aNameAndAddresses)]);</span>
<a href="#l4.161"></a><span id="l4.161">   },</span>
<a href="#l4.162"></a><span id="l4.162"> </span>
<a href="#l4.163"></a><span id="l4.163" class="difflineplus">+  get bodyPart() {</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+    return this._bodyPart;</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineplus">+  },</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineplus">+  set bodyPart(aBodyPart) {</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+    this._bodyPart = aBodyPart;</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineplus">+    this.headers[&quot;Content-Type&quot;] = this._bodyPart.contentTypeHeaderValue;</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineplus">+  },</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineplus">+</span>
<a href="#l4.171"></a><span id="l4.171">   /**</span>
<a href="#l4.172"></a><span id="l4.172">    * Normalizes header values, which may be strings or arrays of strings, into</span>
<a href="#l4.173"></a><span id="l4.173">    *  a suitable string suitable for appending to the header name/key.</span>
<a href="#l4.174"></a><span id="l4.174">    *</span>
<a href="#l4.175"></a><span id="l4.175">    * @returns a normalized string representation of the header value(s), which</span>
<a href="#l4.176"></a><span id="l4.176">    *     may include spanning multiple lines.</span>
<a href="#l4.177"></a><span id="l4.177">    */</span>
<a href="#l4.178"></a><span id="l4.178">   _formatHeaderValues: function(aHeaderValues) {</span>
<a href="#l4.179"></a><span id="l4.179">     // may not be an array</span>
<a href="#l4.180"></a><span id="l4.180">     if (!(aHeaderValues instanceof Array))</span>
<a href="#l4.181"></a><span id="l4.181">       return aHeaderValues;</span>
<a href="#l4.182"></a><span id="l4.182">     // it's an array!</span>
<a href="#l4.183"></a><span id="l4.183">     if (aHeaderValues.length == 1)</span>
<a href="#l4.184"></a><span id="l4.184">       return aHeaderValues[0];</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineminus">-    return aHeaderValues.join(&quot;\n\t&quot;);</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineplus">+    return aHeaderValues.join(&quot;\r\n\t&quot;);</span>
<a href="#l4.187"></a><span id="l4.187">   },</span>
<a href="#l4.188"></a><span id="l4.188"> </span>
<a href="#l4.189"></a><span id="l4.189">   /**</span>
<a href="#l4.190"></a><span id="l4.190">    * @returns a string uniquely identifying this message, at least as long as</span>
<a href="#l4.191"></a><span id="l4.191">    *     the messageId is set and unique.</span>
<a href="#l4.192"></a><span id="l4.192">    */</span>
<a href="#l4.193"></a><span id="l4.193">   toString: function() {</span>
<a href="#l4.194"></a><span id="l4.194">     return &quot;msg:&quot; + this._messageId;</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineat">@@ -268,17 +381,18 @@ SyntheticMessage.prototype = {</span>
<a href="#l4.196"></a><span id="l4.196"> </span>
<a href="#l4.197"></a><span id="l4.197">   /**</span>
<a href="#l4.198"></a><span id="l4.198">    * @returns this messages in rfc822 format, or something close enough.</span>
<a href="#l4.199"></a><span id="l4.199">    */</span>
<a href="#l4.200"></a><span id="l4.200">   toMessageString: function() {</span>
<a href="#l4.201"></a><span id="l4.201">     let lines = [headerKey + &quot;: &quot; + this._formatHeaderValues(headerValues)</span>
<a href="#l4.202"></a><span id="l4.202">                  for each ([headerKey, headerValues] in Iterator(this.headers))];</span>
<a href="#l4.203"></a><span id="l4.203"> </span>
<a href="#l4.204"></a><span id="l4.204" class="difflineminus">-    return lines.join(&quot;\n&quot;) + &quot;\n\n&quot; + this.body + &quot;\n&quot;;</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineplus">+    return lines.join(&quot;\r\n&quot;) + &quot;\r\n\r\n&quot; + this.bodyPart.toMessageString() +</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineplus">+      &quot;\r\n&quot;;</span>
<a href="#l4.207"></a><span id="l4.207">   },</span>
<a href="#l4.208"></a><span id="l4.208"> </span>
<a href="#l4.209"></a><span id="l4.209">   /**</span>
<a href="#l4.210"></a><span id="l4.210">    * @returns this message in rfc822 format in a string stream.</span>
<a href="#l4.211"></a><span id="l4.211">    */</span>
<a href="#l4.212"></a><span id="l4.212">   toStream: function () {</span>
<a href="#l4.213"></a><span id="l4.213">     let stream = Cc[&quot;@mozilla.org/io/string-input-stream;1&quot;]</span>
<a href="#l4.214"></a><span id="l4.214">                    .createInstance(Ci.nsIStringInputStream);</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineat">@@ -287,17 +401,18 @@ SyntheticMessage.prototype = {</span>
<a href="#l4.216"></a><span id="l4.216">     return stream;</span>
<a href="#l4.217"></a><span id="l4.217">   },</span>
<a href="#l4.218"></a><span id="l4.218"> </span>
<a href="#l4.219"></a><span id="l4.219">   /**</span>
<a href="#l4.220"></a><span id="l4.220">    * Writes this message to an mbox stream.  This means adding a &quot;From &quot; line</span>
<a href="#l4.221"></a><span id="l4.221">    *  and making sure we've got a trailing newline.</span>
<a href="#l4.222"></a><span id="l4.222">    */</span>
<a href="#l4.223"></a><span id="l4.223">   writeToMboxStream: function (aStream) {</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineminus">-    let str = &quot;From &quot; + this._from[1] + &quot;\n&quot; + this.toMessageString() + &quot;\n&quot;;</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineplus">+    let str = &quot;From &quot; + this._from[1] + &quot;\r\n&quot; + this.toMessageString() +</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineplus">+      &quot;\r\n&quot;;</span>
<a href="#l4.227"></a><span id="l4.227">     aStream.write(str, str.length);</span>
<a href="#l4.228"></a><span id="l4.228">   }</span>
<a href="#l4.229"></a><span id="l4.229"> }</span>
<a href="#l4.230"></a><span id="l4.230"> </span>
<a href="#l4.231"></a><span id="l4.231"> /**</span>
<a href="#l4.232"></a><span id="l4.232">  * Write a list of messages in mbox format to a file</span>
<a href="#l4.233"></a><span id="l4.233">  *</span>
<a href="#l4.234"></a><span id="l4.234">  * @param aMessages The list of SyntheticMessages instances to write.</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineat">@@ -361,36 +476,36 @@ MessageGenerator.prototype = {</span>
<a href="#l4.236"></a><span id="l4.236">    *</span>
<a href="#l4.237"></a><span id="l4.237">    * @param aNameNumber The 'number' of the name you want which must be less</span>
<a href="#l4.238"></a><span id="l4.238">    *     than MAX_VALID_NAMES.</span>
<a href="#l4.239"></a><span id="l4.239">    * @returns The unique name corresponding to the name number.</span>
<a href="#l4.240"></a><span id="l4.240">    */</span>
<a href="#l4.241"></a><span id="l4.241">   makeName: function(aNameNumber) {</span>
<a href="#l4.242"></a><span id="l4.242">     let iFirst = aNameNumber % FIRST_NAMES.length;</span>
<a href="#l4.243"></a><span id="l4.243">     let iLast = (iFirst + Math.floor(aNameNumber / FIRST_NAMES.length)) %</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineminus">-	            LAST_NAMES.length;</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineminus">-	</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineplus">+                LAST_NAMES.length;</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineplus">+</span>
<a href="#l4.248"></a><span id="l4.248">     return FIRST_NAMES[iFirst] + &quot; &quot; + LAST_NAMES[iLast];</span>
<a href="#l4.249"></a><span id="l4.249">   },</span>
<a href="#l4.250"></a><span id="l4.250"> </span>
<a href="#l4.251"></a><span id="l4.251">   /**</span>
<a href="#l4.252"></a><span id="l4.252">    * Generate a consistently determined (and reversible) e-mail address from</span>
<a href="#l4.253"></a><span id="l4.253">    *  a unique value; intended to work in parallel with makeName.  Currently</span>
<a href="#l4.254"></a><span id="l4.254">    *  up to 26*26 unique addresses can be generated, but if your code cares,</span>
<a href="#l4.255"></a><span id="l4.255">    *  check against MAX_VALID_MAIL_ADDRESSES.</span>
<a href="#l4.256"></a><span id="l4.256">    *</span>
<a href="#l4.257"></a><span id="l4.257">    * @param aNameNumber The 'number' of the mail address you want which must be</span>
<a href="#l4.258"></a><span id="l4.258">    *     less than MAX_VALID_MAIL_ADDRESSES.</span>
<a href="#l4.259"></a><span id="l4.259">    * @returns The unique name corresponding to the name mail address.</span>
<a href="#l4.260"></a><span id="l4.260">    */</span>
<a href="#l4.261"></a><span id="l4.261">   makeMailAddress: function(aNameNumber) {</span>
<a href="#l4.262"></a><span id="l4.262">     let iFirst = aNameNumber % FIRST_NAMES.length;</span>
<a href="#l4.263"></a><span id="l4.263">     let iLast = (iFirst + Math.floor(aNameNumber / FIRST_NAMES.length)) %</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineminus">-	      LAST_NAMES.length;</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineminus">-		</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineplus">+                LAST_NAMES.length;</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineplus">+</span>
<a href="#l4.268"></a><span id="l4.268">     return FIRST_NAMES[iFirst].toLowerCase() + &quot;@&quot; +</span>
<a href="#l4.269"></a><span id="l4.269">            LAST_NAMES[iLast].toLowerCase() + &quot;.nul&quot;;</span>
<a href="#l4.270"></a><span id="l4.270">   },</span>
<a href="#l4.271"></a><span id="l4.271"> </span>
<a href="#l4.272"></a><span id="l4.272">   /**</span>
<a href="#l4.273"></a><span id="l4.273">    * Generate a pair of name and e-mail address.</span>
<a href="#l4.274"></a><span id="l4.274">    *</span>
<a href="#l4.275"></a><span id="l4.275">    * @param aNameNumber The optional 'number' of the name and mail address you</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineat">@@ -483,34 +598,44 @@ MessageGenerator.prototype = {</span>
<a href="#l4.277"></a><span id="l4.277">   },</span>
<a href="#l4.278"></a><span id="l4.278"> </span>
<a href="#l4.279"></a><span id="l4.279">   /**</span>
<a href="#l4.280"></a><span id="l4.280">    * Create a SyntheticMessage.  All arguments are optional, but allow</span>
<a href="#l4.281"></a><span id="l4.281">    *  additional control.  With no arguments specified, a new name/address will</span>
<a href="#l4.282"></a><span id="l4.282">    *  be generated that has not been used before, and sent to a new name/address</span>
<a href="#l4.283"></a><span id="l4.283">    *  that has not been used before.</span>
<a href="#l4.284"></a><span id="l4.284">    *</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineminus">-   * @param aInReplyTo the SyntheticMessage this message should be in reply-to.</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineminus">-   *     If that message was in reply to another message, we will appropriately</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineminus">-   *     compensate for that.</span>
<a href="#l4.288"></a><span id="l4.288">    * @param aArgs An object with any of the following attributes provided:</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineplus">+   *     attachments: A list of dictionaries suitable for passing to</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineplus">+   *         syntheticPartLeaf, plus a 'body' attribute that has already been</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineplus">+   *         encoded.  Line chopping is on you FOR NOW.</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineplus">+   *     body: A dictionary suitable for passing to SyntheticPart plus a 'body'</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineplus">+   *         attribute that has already been encoded (if encoding is required).</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineplus">+   *         Line chopping is on you FOR NOW.</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineplus">+   *     callerData: A value to propagate to the callerData attribute on the</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineplus">+   *         resulting message.</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineplus">+   *     inReplyTo: the SyntheticMessage this message should be in reply-to.</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineplus">+   *         If that message was in reply to another message, we will</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineplus">+   *         appropriately compensate for that.</span>
<a href="#l4.300"></a><span id="l4.300">    *     replyAll: a boolean indicating whether this should be a reply-to-all or</span>
<a href="#l4.301"></a><span id="l4.301">    *         just to the author of the message.  (er, to-only, not cc.)</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineplus">+   *     subject: The subject to use; you are responsible for doing any encoding</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineplus">+   *         before passing it in.</span>
<a href="#l4.304"></a><span id="l4.304">    *     toCount: the number of people who the message should be to.</span>
<a href="#l4.305"></a><span id="l4.305">    * @returns a SyntheticMessage fashioned just to your liking.</span>
<a href="#l4.306"></a><span id="l4.306">    */</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineminus">-  makeMessage: function(aInReplyTo, aArgs) {</span>
<a href="#l4.308"></a><span id="l4.308" class="difflineplus">+  makeMessage: function(aArgs) {</span>
<a href="#l4.309"></a><span id="l4.309">     aArgs = aArgs || {};</span>
<a href="#l4.310"></a><span id="l4.310">     let msg = new SyntheticMessage();</span>
<a href="#l4.311"></a><span id="l4.311"> </span>
<a href="#l4.312"></a><span id="l4.312" class="difflineminus">-    if (aInReplyTo) {</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineminus">-      msg.parent = aInReplyTo;</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineplus">+    if (aArgs.inReplyTo) {</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineplus">+      msg.parent = aArgs.inReplyTo;</span>
<a href="#l4.316"></a><span id="l4.316">       msg.parent.children.push(msg);</span>
<a href="#l4.317"></a><span id="l4.317"> </span>
<a href="#l4.318"></a><span id="l4.318" class="difflineminus">-      let srcMsg = aInReplyTo;</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineplus">+      let srcMsg = aArgs.inReplyTo;</span>
<a href="#l4.320"></a><span id="l4.320"> </span>
<a href="#l4.321"></a><span id="l4.321">       msg.subject = (srcMsg.subject.substring(0, 4) == &quot;Re: &quot;) ? srcMsg.subject</span>
<a href="#l4.322"></a><span id="l4.322">                     : (&quot;Re: &quot; + srcMsg.subject);</span>
<a href="#l4.323"></a><span id="l4.323">       if (aArgs.replyAll)</span>
<a href="#l4.324"></a><span id="l4.324">         msg.to = [srcMsg.from].concat(srcMsg.to.slice(1));</span>
<a href="#l4.325"></a><span id="l4.325">       else</span>
<a href="#l4.326"></a><span id="l4.326">         msg.to = [srcMsg.from];</span>
<a href="#l4.327"></a><span id="l4.327">       msg.from = srcMsg.to[0];</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineat">@@ -518,26 +643,45 @@ MessageGenerator.prototype = {</span>
<a href="#l4.329"></a><span id="l4.329">       // we want the &lt;&gt;'s.</span>
<a href="#l4.330"></a><span id="l4.330">       msg.headers[&quot;In-Reply-To&quot;] = srcMsg.headers[&quot;Message-Id&quot;];</span>
<a href="#l4.331"></a><span id="l4.331">       msg.headers[&quot;References&quot;] = (srcMsg.headers[&quot;References&quot;] || []).concat(</span>
<a href="#l4.332"></a><span id="l4.332">                                    [srcMsg.headers[&quot;Message-Id&quot;]]);</span>
<a href="#l4.333"></a><span id="l4.333">     }</span>
<a href="#l4.334"></a><span id="l4.334">     else {</span>
<a href="#l4.335"></a><span id="l4.335">       msg.parent = null;</span>
<a href="#l4.336"></a><span id="l4.336"> </span>
<a href="#l4.337"></a><span id="l4.337" class="difflineminus">-      msg.subject = this.makeSubject();</span>
<a href="#l4.338"></a><span id="l4.338" class="difflineplus">+      msg.subject = aArgs.subject || this.makeSubject();</span>
<a href="#l4.339"></a><span id="l4.339">       msg.from = this.makeNameAndAddress();</span>
<a href="#l4.340"></a><span id="l4.340">       msg.to = this.makeNamesAndAddresses(aArgs.toCount || 1);</span>
<a href="#l4.341"></a><span id="l4.341">     }</span>
<a href="#l4.342"></a><span id="l4.342"> </span>
<a href="#l4.343"></a><span id="l4.343">     msg.children = [];</span>
<a href="#l4.344"></a><span id="l4.344">     msg.messageId = this.makeMessageId(msg);</span>
<a href="#l4.345"></a><span id="l4.345">     msg.date = this.makeDate();</span>
<a href="#l4.346"></a><span id="l4.346"> </span>
<a href="#l4.347"></a><span id="l4.347" class="difflineminus">-    msg.body = &quot;I am an e-mail.&quot;;</span>
<a href="#l4.348"></a><span id="l4.348" class="difflineplus">+    let bodyPart;</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineplus">+    if (aArgs.bodyPart)</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineplus">+      bodyPart = aArgs.bodyPart;</span>
<a href="#l4.351"></a><span id="l4.351" class="difflineplus">+    else if (aArgs.body)</span>
<a href="#l4.352"></a><span id="l4.352" class="difflineplus">+      bodyPart = new SyntheticPartLeaf(aArgs.body.body, aArgs.body);</span>
<a href="#l4.353"></a><span id="l4.353" class="difflineplus">+    else</span>
<a href="#l4.354"></a><span id="l4.354" class="difflineplus">+      bodyPart = new SyntheticPartLeaf(&quot;I am an e-mail.&quot;);</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineplus">+</span>
<a href="#l4.356"></a><span id="l4.356" class="difflineplus">+    // if it has any attachments, create a multipart/mixed to be the body and</span>
<a href="#l4.357"></a><span id="l4.357" class="difflineplus">+    //  have it be the parent of the existing body and all the attachments</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineplus">+    if (aArgs.attachments) {</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineplus">+      let parts = [bodyPart];</span>
<a href="#l4.360"></a><span id="l4.360" class="difflineplus">+      for each (let [,attachDesc] in Iterator(aArgs.attachments))</span>
<a href="#l4.361"></a><span id="l4.361" class="difflineplus">+        parts.push(new SyntheticPartLeaf(attachDesc.body, attachDesc));</span>
<a href="#l4.362"></a><span id="l4.362" class="difflineplus">+      bodyPart = new SyntheticPartMultiMixed(parts);</span>
<a href="#l4.363"></a><span id="l4.363" class="difflineplus">+    }</span>
<a href="#l4.364"></a><span id="l4.364" class="difflineplus">+</span>
<a href="#l4.365"></a><span id="l4.365" class="difflineplus">+    msg.bodyPart = bodyPart;</span>
<a href="#l4.366"></a><span id="l4.366" class="difflineplus">+</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineplus">+    msg.callerData = aArgs.callerData;</span>
<a href="#l4.368"></a><span id="l4.368"> </span>
<a href="#l4.369"></a><span id="l4.369">     return msg;</span>
<a href="#l4.370"></a><span id="l4.370">   }</span>
<a href="#l4.371"></a><span id="l4.371"> }</span>
<a href="#l4.372"></a><span id="l4.372"> </span>
<a href="#l4.373"></a><span id="l4.373"> /**</span>
<a href="#l4.374"></a><span id="l4.374">  * Repository of generative message scenarios.  Uses the magic bindMethods</span>
<a href="#l4.375"></a><span id="l4.375">  *  function below to allow you to reference methods/attributes without worrying</span>
<a href="#l4.376"></a><span id="l4.376" class="difflineat">@@ -560,49 +704,49 @@ function MessageScenarioFactory(aMessage</span>
<a href="#l4.377"></a><span id="l4.377"> }</span>
<a href="#l4.378"></a><span id="l4.378"> </span>
<a href="#l4.379"></a><span id="l4.379"> MessageScenarioFactory.prototype = {</span>
<a href="#l4.380"></a><span id="l4.380">   /** Create a chain of direct-reply messages of the given length. */</span>
<a href="#l4.381"></a><span id="l4.381">   directReply: function(aNumMessages) {</span>
<a href="#l4.382"></a><span id="l4.382">     aNumMessages = aNumMessages || 2;</span>
<a href="#l4.383"></a><span id="l4.383">     let messages = [this._msgGen.makeMessage()];</span>
<a href="#l4.384"></a><span id="l4.384">     for (let i = 1; i &lt; aNumMessages; i++) {</span>
<a href="#l4.385"></a><span id="l4.385" class="difflineminus">-      messages.push(msgGen.makeMessage(messages[i-1]));</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineplus">+      messages.push(this._msgGen.makeMessage({inReplyTo: messages[i-1]}));</span>
<a href="#l4.387"></a><span id="l4.387">     }</span>
<a href="#l4.388"></a><span id="l4.388">     return messages;</span>
<a href="#l4.389"></a><span id="l4.389">   },</span>
<a href="#l4.390"></a><span id="l4.390"> </span>
<a href="#l4.391"></a><span id="l4.391">   /** Two siblings (present), one parent (missing). */</span>
<a href="#l4.392"></a><span id="l4.392">   siblingsMissingParent: function() {</span>
<a href="#l4.393"></a><span id="l4.393">     let missingParent = this._msgGen.makeMessage();</span>
<a href="#l4.394"></a><span id="l4.394" class="difflineminus">-    let msg1 = this._msgGen.makeMessage(missingParent);</span>
<a href="#l4.395"></a><span id="l4.395" class="difflineminus">-    let msg2 = this._msgGen.makeMessage(missingParent);</span>
<a href="#l4.396"></a><span id="l4.396" class="difflineplus">+    let msg1 = this._msgGen.makeMessage({inReplyTo: missingParent});</span>
<a href="#l4.397"></a><span id="l4.397" class="difflineplus">+    let msg2 = this._msgGen.makeMessage({inReplyTo: missingParent});</span>
<a href="#l4.398"></a><span id="l4.398">     return [msg1, msg2];</span>
<a href="#l4.399"></a><span id="l4.399">   },</span>
<a href="#l4.400"></a><span id="l4.400"> </span>
<a href="#l4.401"></a><span id="l4.401">   /** Present parent, missing child, present grand-child. */</span>
<a href="#l4.402"></a><span id="l4.402">   missingIntermediary: function() {</span>
<a href="#l4.403"></a><span id="l4.403">     let msg1 = this._msgGen.makeMessage();</span>
<a href="#l4.404"></a><span id="l4.404" class="difflineminus">-    let msg2 = this._msgGen.makeMessage(msg1);</span>
<a href="#l4.405"></a><span id="l4.405" class="difflineminus">-    let msg3 = this._msgGen.makeMessage(msg2);</span>
<a href="#l4.406"></a><span id="l4.406" class="difflineplus">+    let msg2 = this._msgGen.makeMessage({inReplyTo: msg1});</span>
<a href="#l4.407"></a><span id="l4.407" class="difflineplus">+    let msg3 = this._msgGen.makeMessage({inReplyTo: msg2});</span>
<a href="#l4.408"></a><span id="l4.408">     return [msg1, msg3];</span>
<a href="#l4.409"></a><span id="l4.409">   },</span>
<a href="#l4.410"></a><span id="l4.410"> </span>
<a href="#l4.411"></a><span id="l4.411">   /**</span>
<a href="#l4.412"></a><span id="l4.412">    * The root message and all non-leaf nodes have aChildrenPerParent children,</span>
<a href="#l4.413"></a><span id="l4.413">    *  for a total of aHeight layers.  (If aHeight is 1, we have just the root;</span>
<a href="#l4.414"></a><span id="l4.414">    *  if aHeight is 2, the root and his aChildrePerParent children.)</span>
<a href="#l4.415"></a><span id="l4.415">    */</span>
<a href="#l4.416"></a><span id="l4.416">   fullPyramid: function(aChildrenPerParent, aHeight) {</span>
<a href="#l4.417"></a><span id="l4.417">     let msgGen = this._msgGen;</span>
<a href="#l4.418"></a><span id="l4.418">     let root = msgGen.makeMessage();</span>
<a href="#l4.419"></a><span id="l4.419">     let messages = [root];</span>
<a href="#l4.420"></a><span id="l4.420">     function helper(aParent, aRemDepth) {</span>
<a href="#l4.421"></a><span id="l4.421">       for (let iChild = 0; iChild &lt; aChildrenPerParent; iChild++) {</span>
<a href="#l4.422"></a><span id="l4.422" class="difflineminus">-        let child = msgGen.makeMessage(aParent);</span>
<a href="#l4.423"></a><span id="l4.423" class="difflineplus">+        let child = msgGen.makeMessage({inReplyTo: aParent});</span>
<a href="#l4.424"></a><span id="l4.424">         messages.push(child);</span>
<a href="#l4.425"></a><span id="l4.425">         if (aRemDepth)</span>
<a href="#l4.426"></a><span id="l4.426">           helper(child, aRemDepth - 1);</span>
<a href="#l4.427"></a><span id="l4.427">       }</span>
<a href="#l4.428"></a><span id="l4.428">     }</span>
<a href="#l4.429"></a><span id="l4.429">     if (aHeight &gt; 1)</span>
<a href="#l4.430"></a><span id="l4.430">       helper(root, aHeight - 2);</span>
<a href="#l4.431"></a><span id="l4.431">     return messages;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_intl.js</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,93 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+/*</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+ * Test that i18n goes through das pipes acceptably.  Currently this means:</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+ * - Subject, Body, and Attachment names are properly indexed.</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+ */</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+do_import_script(&quot;../mailnews/db/gloda/test/resources/messageGenerator.js&quot;);</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+//these are imported by glodaTestHelper's import of head_maillocal</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+// do_import_script(&quot;../mailnews/test/resources/mailDirService.js&quot;);</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+// do_import_script(&quot;../mailnews/test/resources/mailTestUtils.js&quot;);</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+do_import_script(&quot;../mailnews/db/gloda/test/resources/glodaTestHelper.js&quot;);</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+// Create a message generator</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+var msgGen = new MessageGenerator();</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+/* ===== Tests ===== */</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+var intlPhrases = [</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+  {</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+    name: &quot;Vending Machine&quot;,</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+    actual: '\u81ea\u52d5\u552e\u8ca8\u6a5f',</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+    encodings: {</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+      'utf-8': ['=?utf-8?b?6Ieq5YuV5ZSu6LKo5qmf?=',</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+                '\xe8\x87\xaa\xe5\x8b\x95\xe5\x94\xae\xe8\xb2\xa8\xe6\xa9\x9f'],</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+      'euc-jp': ['=?shift-jis?b?jqmTrppTid2LQA==?=',</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+                 '\xbc\xab\xc6\xb0\xd3\xb4\xb2\xdf\xb5\xa1'],</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+      'shift-jis': ['=?shift-jis?b?jqmTrppTid2LQA==?=',</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+                    '\x8e\xa9\x93\xae\x9aS\x89\xdd\x8b@']</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+    }</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+  }</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+];</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+/**</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+ * For each phrase in the intlPhrases array (we are parameterized over it using</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+ *  parameterizeTest in the 'tests' declaration), create a message where the</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+ *  subject, body, and attachment name are populated using the encodings in</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+ *  the phrase's &quot;encodings&quot; attribute, one encoding per message.  Make sure</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+ *  that the strings as exposed by the gloda representation are equal to the</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+ *  expected/actual value.</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+ */</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+function test_index(aPhrase) {</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+  // create a synthetic message for each of the delightful encoding types</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+  let messages = [];</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+  for each (let [charset, encodings] in Iterator(aPhrase.encodings)) {</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+    let [quoted, bodyEncoded] = encodings;</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+    let smsg = msgGen.makeMessage({</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+      subject: quoted,</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+      body: {charset: charset, encoding: &quot;8bit&quot;, body: bodyEncoded},</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+      attachments: [</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+        {filename: quoted, body: &quot;gabba gabba hey&quot;},</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+      ],</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+      // save off the actual value for checking</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+      callerData: [charset, aPhrase.actual]</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+    });</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+    messages.push(smsg);</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+  }</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+  indexMessages(messages, verify_index, next_test);</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+}</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+/**</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+ * Does the per-message verification for test_index.  Knows what is right for</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+ *  each message because of the callerData attribute on the synthetic message.</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+ */</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+function verify_index(smsg, gmsg) {</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+  let [charset, actual] = smsg.callerData;</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+  let subject = gmsg.subject;</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+  let indexedBodyText = gmsg.indexedBodyText.trim();</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+  let attachmentName = gmsg.attachmentNames[0];</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+  LOG.debug(&quot;using character set: &quot; + charset + &quot; actual: &quot; + actual);</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+  LOG.debug(&quot;subject: &quot; + subject + &quot; (len: &quot; + subject.length + &quot;)&quot;);</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+  do_check_eq(actual, subject);</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+  LOG.debug(&quot;body: &quot; + indexedBodyText +</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+      &quot; (len: &quot; + indexedBodyText.length + &quot;)&quot;);</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+  do_check_eq(actual, indexedBodyText);</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+  LOG.debug(&quot;attachment name:&quot; + attachmentName +</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+      &quot; (len: &quot; + attachmentName.length + &quot;)&quot;);</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+  do_check_eq(actual, attachmentName);</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+}</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+/* ===== Driver ===== */</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+var tests = [</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+  parameterizeTest(test_index, intlPhrases),</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+];</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+function run_test() {</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+  // use mbox injection because the fake server chokes sometimes right now</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+  injectMessagesUsing(INJECT_MBOX);</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+  glodaHelperRunTests(tests);</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/db/gloda/test/unit/test_query_messages.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_query_messages.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -68,21 +68,23 @@ function categorizeMessage(aSynthMessage</span>
<a href="#l6.4"></a><span id="l6.4">  * Generate messages in a single folder, categorizing them as we go.</span>
<a href="#l6.5"></a><span id="l6.5">  */</span>
<a href="#l6.6"></a><span id="l6.6"> function generateFolderMessages() {</span>
<a href="#l6.7"></a><span id="l6.7">   let messages = [];</span>
<a href="#l6.8"></a><span id="l6.8">   </span>
<a href="#l6.9"></a><span id="l6.9">   let iAuthor = 0;</span>
<a href="#l6.10"></a><span id="l6.10">   for (let iMessage = 0; iMessage &lt; world.MESSAGES_PER_FOLDER; iMessage++) {</span>
<a href="#l6.11"></a><span id="l6.11">     let iConvo = iMessage % world.NUM_CONVERSATIONS;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    let smsg = msgGen.makeMessage(world.lastMessagesInConvos[iConvo]);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+    let smsg = msgGen.makeMessage({</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+      inReplyTo: world.lastMessagesInConvos[iConvo]</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+    });</span>
<a href="#l6.16"></a><span id="l6.16">     // we need missing messages to create ghosts, so periodically add an extra</span>
<a href="#l6.17"></a><span id="l6.17">     //  unknown into the equation</span>
<a href="#l6.18"></a><span id="l6.18">     if ((iMessage % 3) == 0)</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-      smsg = msgGen.makeMessage(smsg);</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+      smsg = msgGen.makeMessage({inReplyTo: smsg});</span>
<a href="#l6.21"></a><span id="l6.21">     </span>
<a href="#l6.22"></a><span id="l6.22">     // makeMessage is not exceedingly clever right now, we need to overwrite</span>
<a href="#l6.23"></a><span id="l6.23">     //  From and To...</span>
<a href="#l6.24"></a><span id="l6.24">     smsg.from = world.peoples[iAuthor];</span>
<a href="#l6.25"></a><span id="l6.25">     iAuthor = (iAuthor + iConvo + 1) % world.NUM_AUTHORS;</span>
<a href="#l6.26"></a><span id="l6.26">     // so, everyone is talking to everyone for this stuff</span>
<a href="#l6.27"></a><span id="l6.27">     smsg.to = world.peoples;</span>
<a href="#l6.28"></a><span id="l6.28">     world.lastMessagesInConvos[iConvo] = smsg;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/mime/emitters/src/nsMimeBaseEmitter.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/mime/emitters/src/nsMimeBaseEmitter.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -144,17 +144,18 @@ nsMimeBaseEmitter::~nsMimeBaseEmitter(vo</span>
<a href="#l7.4"></a><span id="l7.4">   {</span>
<a href="#l7.5"></a><span id="l7.5">     for (i=0; i&lt;mAttachArray-&gt;Count(); i++)</span>
<a href="#l7.6"></a><span id="l7.6">     {</span>
<a href="#l7.7"></a><span id="l7.7">       attachmentInfoType *attachInfo = (attachmentInfoType *)mAttachArray-&gt;ElementAt(i);</span>
<a href="#l7.8"></a><span id="l7.8">       if (!attachInfo)</span>
<a href="#l7.9"></a><span id="l7.9">         continue;</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11">       PR_FREEIF(attachInfo-&gt;contentType);</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-      PR_FREEIF(attachInfo-&gt;displayName);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+      if (attachInfo-&gt;displayName)</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+        NS_Free(attachInfo-&gt;displayName);</span>
<a href="#l7.15"></a><span id="l7.15">       PR_FREEIF(attachInfo-&gt;urlSpec);</span>
<a href="#l7.16"></a><span id="l7.16">       PR_FREEIF(attachInfo);</span>
<a href="#l7.17"></a><span id="l7.17">     }</span>
<a href="#l7.18"></a><span id="l7.18">     delete mAttachArray;</span>
<a href="#l7.19"></a><span id="l7.19">   }</span>
<a href="#l7.20"></a><span id="l7.20"> </span>
<a href="#l7.21"></a><span id="l7.21">   // Cleanup allocated header arrays...</span>
<a href="#l7.22"></a><span id="l7.22">   CleanupHeaderArray(mHeaderArray);</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineat">@@ -383,26 +384,28 @@ nsMimeBaseEmitter::GetOutputListener(nsI</span>
<a href="#l7.24"></a><span id="l7.24">     NS_IF_ADDREF(*listener);</span>
<a href="#l7.25"></a><span id="l7.25">   }</span>
<a href="#l7.26"></a><span id="l7.26">   return NS_OK;</span>
<a href="#l7.27"></a><span id="l7.27"> }</span>
<a href="#l7.28"></a><span id="l7.28"> </span>
<a href="#l7.29"></a><span id="l7.29"> </span>
<a href="#l7.30"></a><span id="l7.30"> // Attachment handling routines</span>
<a href="#l7.31"></a><span id="l7.31"> nsresult</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-nsMimeBaseEmitter::StartAttachment(const char *name, const char *contentType, const char *url,</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+nsMimeBaseEmitter::StartAttachment(const nsACString &amp;name,</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+                                   const char *contentType,</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+                                   const char *url,</span>
<a href="#l7.36"></a><span id="l7.36">                                    PRBool aIsExternalAttachment)</span>
<a href="#l7.37"></a><span id="l7.37"> {</span>
<a href="#l7.38"></a><span id="l7.38">   // Ok, now we will setup the attachment info</span>
<a href="#l7.39"></a><span id="l7.39">   mCurrentAttachment = (attachmentInfoType *) PR_NEWZAP(attachmentInfoType);</span>
<a href="#l7.40"></a><span id="l7.40">   if ( (mCurrentAttachment) &amp;&amp; mAttachArray)</span>
<a href="#l7.41"></a><span id="l7.41">   {</span>
<a href="#l7.42"></a><span id="l7.42">     ++mAttachCount;</span>
<a href="#l7.43"></a><span id="l7.43"> </span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-    mCurrentAttachment-&gt;displayName = strdup(name);</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+    mCurrentAttachment-&gt;displayName = ToNewCString(name);</span>
<a href="#l7.46"></a><span id="l7.46">     mCurrentAttachment-&gt;urlSpec = strdup(url);</span>
<a href="#l7.47"></a><span id="l7.47">     mCurrentAttachment-&gt;contentType = strdup(contentType);</span>
<a href="#l7.48"></a><span id="l7.48">     mCurrentAttachment-&gt;isExternalAttachment = aIsExternalAttachment;</span>
<a href="#l7.49"></a><span id="l7.49">   }</span>
<a href="#l7.50"></a><span id="l7.50"> </span>
<a href="#l7.51"></a><span id="l7.51">   return NS_OK;</span>
<a href="#l7.52"></a><span id="l7.52"> }</span>
<a href="#l7.53"></a><span id="l7.53"> </span>
<a href="#l7.54"></a><span id="l7.54" class="difflineat">@@ -429,49 +432,51 @@ NS_IMETHODIMP</span>
<a href="#l7.55"></a><span id="l7.55"> nsMimeBaseEmitter::AddAttachmentField(const char *field, const char *value)</span>
<a href="#l7.56"></a><span id="l7.56"> {</span>
<a href="#l7.57"></a><span id="l7.57">   return NS_OK;</span>
<a href="#l7.58"></a><span id="l7.58"> }</span>
<a href="#l7.59"></a><span id="l7.59"> </span>
<a href="#l7.60"></a><span id="l7.60"> NS_IMETHODIMP</span>
<a href="#l7.61"></a><span id="l7.61"> nsMimeBaseEmitter::UtilityWrite(const char *buf)</span>
<a href="#l7.62"></a><span id="l7.62"> {</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-  PRInt32     tmpLen = strlen(buf);</span>
<a href="#l7.64"></a><span id="l7.64">   PRUint32    written;</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+  Write(nsDependentCString(buf), &amp;written);</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+}</span>
<a href="#l7.68"></a><span id="l7.68"> </span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-  Write(buf, tmpLen, &amp;written);</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+nsMimeBaseEmitter::UtilityWrite(const nsACString &amp;buf)</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+{</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+  PRUint32    written;</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+  Write(buf, &amp;written);</span>
<a href="#l7.76"></a><span id="l7.76">   return NS_OK;</span>
<a href="#l7.77"></a><span id="l7.77"> }</span>
<a href="#l7.78"></a><span id="l7.78"> </span>
<a href="#l7.79"></a><span id="l7.79"> NS_IMETHODIMP</span>
<a href="#l7.80"></a><span id="l7.80"> nsMimeBaseEmitter::UtilityWriteCRLF(const char *buf)</span>
<a href="#l7.81"></a><span id="l7.81"> {</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-  PRInt32     tmpLen = strlen(buf);</span>
<a href="#l7.83"></a><span id="l7.83">   PRUint32    written;</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-  Write(buf, tmpLen, &amp;written);</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineminus">-  Write(CRLF, 2, &amp;written);</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineminus">-</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+  Write(nsDependentCString(buf), &amp;written);</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+  Write(NS_LITERAL_CSTRING(CRLF), &amp;written);</span>
<a href="#l7.90"></a><span id="l7.90">   return NS_OK;</span>
<a href="#l7.91"></a><span id="l7.91"> }</span>
<a href="#l7.92"></a><span id="l7.92"> </span>
<a href="#l7.93"></a><span id="l7.93"> NS_IMETHODIMP</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-nsMimeBaseEmitter::Write(const char *buf, PRUint32 size, PRUint32 *amountWritten)</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+nsMimeBaseEmitter::Write(const nsACString &amp;buf, PRUint32 *amountWritten)</span>
<a href="#l7.96"></a><span id="l7.96"> {</span>
<a href="#l7.97"></a><span id="l7.97">   unsigned int        written = 0;</span>
<a href="#l7.98"></a><span id="l7.98">   nsresult rv = NS_OK;</span>
<a href="#l7.99"></a><span id="l7.99">   PRUint32            needToWrite;</span>
<a href="#l7.100"></a><span id="l7.100"> </span>
<a href="#l7.101"></a><span id="l7.101"> #ifdef DEBUG_BenB</span>
<a href="#l7.102"></a><span id="l7.102">   // If you want to see libmime output...</span>
<a href="#l7.103"></a><span id="l7.103">   printf(&quot;%s&quot;, buf);</span>
<a href="#l7.104"></a><span id="l7.104"> #endif</span>
<a href="#l7.105"></a><span id="l7.105"> </span>
<a href="#l7.106"></a><span id="l7.106" class="difflineminus">-  PR_LOG(gMimeEmitterLogModule, PR_LOG_ALWAYS, (buf));</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+  PR_LOG(gMimeEmitterLogModule, PR_LOG_ALWAYS, (PromiseFlatCString(buf).get()));</span>
<a href="#l7.108"></a><span id="l7.108">   //</span>
<a href="#l7.109"></a><span id="l7.109">   // Make sure that the buffer we are &quot;pushing&quot; into has enough room</span>
<a href="#l7.110"></a><span id="l7.110">   // for the write operation. If not, we have to buffer, return, and get</span>
<a href="#l7.111"></a><span id="l7.111">   // it on the next time through</span>
<a href="#l7.112"></a><span id="l7.112">   //</span>
<a href="#l7.113"></a><span id="l7.113">   *amountWritten = 0;</span>
<a href="#l7.114"></a><span id="l7.114"> </span>
<a href="#l7.115"></a><span id="l7.115">   needToWrite = mBufferMgr-&gt;GetSize();</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineat">@@ -483,30 +488,32 @@ nsMimeBaseEmitter::Write(const char *buf</span>
<a href="#l7.117"></a><span id="l7.117">     mTotalWritten += written;</span>
<a href="#l7.118"></a><span id="l7.118">     mBufferMgr-&gt;ReduceBuffer(written);</span>
<a href="#l7.119"></a><span id="l7.119">     *amountWritten = written;</span>
<a href="#l7.120"></a><span id="l7.120"> </span>
<a href="#l7.121"></a><span id="l7.121">     // if we couldn't write all the old data, buffer the new data</span>
<a href="#l7.122"></a><span id="l7.122">     // and return</span>
<a href="#l7.123"></a><span id="l7.123">     if (mBufferMgr-&gt;GetSize() &gt; 0)</span>
<a href="#l7.124"></a><span id="l7.124">     {</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineminus">-      mBufferMgr-&gt;IncreaseBuffer(buf, size);</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+      mBufferMgr-&gt;IncreaseBuffer(buf.BeginReading(), buf.Length());</span>
<a href="#l7.127"></a><span id="l7.127">       return rv;</span>
<a href="#l7.128"></a><span id="l7.128">     }</span>
<a href="#l7.129"></a><span id="l7.129">   }</span>
<a href="#l7.130"></a><span id="l7.130"> </span>
<a href="#l7.131"></a><span id="l7.131"> </span>
<a href="#l7.132"></a><span id="l7.132">   // if we get here, we are dealing with new data...try to write</span>
<a href="#l7.133"></a><span id="l7.133">   // and then do the right thing...</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineminus">-  rv = WriteHelper(buf, size, &amp;written);</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+  rv = WriteHelper(buf.BeginReading(), buf.Length(), &amp;written);</span>
<a href="#l7.136"></a><span id="l7.136">   *amountWritten = written;</span>
<a href="#l7.137"></a><span id="l7.137">   mTotalWritten += written;</span>
<a href="#l7.138"></a><span id="l7.138"> </span>
<a href="#l7.139"></a><span id="l7.139" class="difflineminus">-  if (written &lt; size)</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineminus">-    mBufferMgr-&gt;IncreaseBuffer(buf+written, (size-written));</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+  if (written &lt; buf.Length()) {</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+    const nsACString &amp;remainder = Substring(buf, written);</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+    mBufferMgr-&gt;IncreaseBuffer(remainder.BeginReading(), remainder.Length());</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+  }</span>
<a href="#l7.145"></a><span id="l7.145"> </span>
<a href="#l7.146"></a><span id="l7.146">   return rv;</span>
<a href="#l7.147"></a><span id="l7.147"> }</span>
<a href="#l7.148"></a><span id="l7.148"> </span>
<a href="#l7.149"></a><span id="l7.149"> nsresult</span>
<a href="#l7.150"></a><span id="l7.150"> nsMimeBaseEmitter::WriteHelper(const char *buf, PRUint32 count, PRUint32 *countWritten)</span>
<a href="#l7.151"></a><span id="l7.151"> {</span>
<a href="#l7.152"></a><span id="l7.152">   nsresult rv;</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineat">@@ -922,17 +929,17 @@ nsMimeBaseEmitter::Complete()</span>
<a href="#l7.154"></a><span id="l7.154"> {</span>
<a href="#l7.155"></a><span id="l7.155">   // If we are here and still have data to write, we should try</span>
<a href="#l7.156"></a><span id="l7.156">   // to flush it...if we try and fail, we should probably return</span>
<a href="#l7.157"></a><span id="l7.157">   // an error!</span>
<a href="#l7.158"></a><span id="l7.158">   PRUint32      written;</span>
<a href="#l7.159"></a><span id="l7.159"> </span>
<a href="#l7.160"></a><span id="l7.160">   nsresult rv = NS_OK;</span>
<a href="#l7.161"></a><span id="l7.161">   while ( NS_SUCCEEDED(rv) &amp;&amp; (mBufferMgr) &amp;&amp; (mBufferMgr-&gt;GetSize() &gt; 0))</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineminus">-    rv = Write(&quot;&quot;, 0, &amp;written);</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+    rv = Write(EmptyCString(), &amp;written);</span>
<a href="#l7.164"></a><span id="l7.164"> </span>
<a href="#l7.165"></a><span id="l7.165">   if (mOutListener)</span>
<a href="#l7.166"></a><span id="l7.166">   {</span>
<a href="#l7.167"></a><span id="l7.167">     PRUint32 bytesInStream = 0;</span>
<a href="#l7.168"></a><span id="l7.168">     nsresult rv2 = mInputStream-&gt;Available(&amp;bytesInStream);</span>
<a href="#l7.169"></a><span id="l7.169">     NS_ASSERTION(NS_SUCCEEDED(rv2), &quot;Available failed&quot;);</span>
<a href="#l7.170"></a><span id="l7.170">     if (bytesInStream)</span>
<a href="#l7.171"></a><span id="l7.171">     {</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineat">@@ -958,17 +965,17 @@ nsMimeBaseEmitter::EndHeader()</span>
<a href="#l7.173"></a><span id="l7.173"> // body handling routines</span>
<a href="#l7.174"></a><span id="l7.174"> NS_IMETHODIMP</span>
<a href="#l7.175"></a><span id="l7.175"> nsMimeBaseEmitter::StartBody(PRBool bodyOnly, const char *msgID, const char *outCharset)</span>
<a href="#l7.176"></a><span id="l7.176"> {</span>
<a href="#l7.177"></a><span id="l7.177">   return NS_OK;</span>
<a href="#l7.178"></a><span id="l7.178"> }</span>
<a href="#l7.179"></a><span id="l7.179"> </span>
<a href="#l7.180"></a><span id="l7.180"> NS_IMETHODIMP</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineminus">-nsMimeBaseEmitter::WriteBody(const char *buf, PRUint32 size, PRUint32 *amountWritten)</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineplus">+nsMimeBaseEmitter::WriteBody(const nsACString &amp;buf, PRUint32 *amountWritten)</span>
<a href="#l7.183"></a><span id="l7.183"> {</span>
<a href="#l7.184"></a><span id="l7.184">   return NS_OK;</span>
<a href="#l7.185"></a><span id="l7.185"> }</span>
<a href="#l7.186"></a><span id="l7.186"> </span>
<a href="#l7.187"></a><span id="l7.187"> NS_IMETHODIMP</span>
<a href="#l7.188"></a><span id="l7.188"> nsMimeBaseEmitter::EndBody()</span>
<a href="#l7.189"></a><span id="l7.189"> {</span>
<a href="#l7.190"></a><span id="l7.190">   return NS_OK;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/mime/emitters/src/nsMimeBaseEmitter.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/mime/emitters/src/nsMimeBaseEmitter.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -91,16 +91,17 @@ public:</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5">   // nsISupports interface</span>
<a href="#l8.6"></a><span id="l8.6">   NS_DECL_ISUPPORTS</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8">   NS_DECL_NSIMIMEEMITTER</span>
<a href="#l8.9"></a><span id="l8.9">   NS_DECL_NSIINTERFACEREQUESTOR</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11">   // Utility output functions...</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+  NS_IMETHOD          UtilityWrite(const nsACString &amp;buf);</span>
<a href="#l8.13"></a><span id="l8.13">   NS_IMETHOD          UtilityWriteCRLF(const char *buf);</span>
<a href="#l8.14"></a><span id="l8.14"> </span>
<a href="#l8.15"></a><span id="l8.15">   // For string bundle usage...</span>
<a href="#l8.16"></a><span id="l8.16">   char                *MimeGetStringByName(const char *aHeaderName);</span>
<a href="#l8.17"></a><span id="l8.17">   char                *MimeGetStringByID(PRInt32 aID);</span>
<a href="#l8.18"></a><span id="l8.18">   char                *LocalizeHeaderName(const char *aHeaderName, const char *aDefaultName);</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20">   // For header processing...</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/mime/emitters/src/nsMimeHtmlEmitter.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/mime/emitters/src/nsMimeHtmlEmitter.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -409,17 +409,17 @@ nsMimeHtmlDisplayEmitter::EndHeader()</span>
<a href="#l9.4"></a><span id="l9.4">     UtilityWriteCRLF(&quot;&lt;body&gt;&quot;);</span>
<a href="#l9.5"></a><span id="l9.5">   }</span>
<a href="#l9.6"></a><span id="l9.6"> </span>
<a href="#l9.7"></a><span id="l9.7">   WriteHTMLHeaders();</span>
<a href="#l9.8"></a><span id="l9.8">   return NS_OK;</span>
<a href="#l9.9"></a><span id="l9.9"> }</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11"> nsresult</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-nsMimeHtmlDisplayEmitter::StartAttachment(const char *name,</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+nsMimeHtmlDisplayEmitter::StartAttachment(const nsACString &amp;name,</span>
<a href="#l9.14"></a><span id="l9.14">                                           const char *contentType,</span>
<a href="#l9.15"></a><span id="l9.15">                                           const char *url,</span>
<a href="#l9.16"></a><span id="l9.16">                                           PRBool aIsExternalAttachment)</span>
<a href="#l9.17"></a><span id="l9.17"> {</span>
<a href="#l9.18"></a><span id="l9.18">   nsresult rv = NS_OK;</span>
<a href="#l9.19"></a><span id="l9.19">   nsCOMPtr&lt;nsIMsgHeaderSink&gt; headerSink;</span>
<a href="#l9.20"></a><span id="l9.20">   rv = GetHeaderSink(getter_AddRefs(headerSink));</span>
<a href="#l9.21"></a><span id="l9.21"> </span>
<a href="#l9.22"></a><span id="l9.22" class="difflineat">@@ -435,33 +435,21 @@ nsMimeHtmlDisplayEmitter::StartAttachmen</span>
<a href="#l9.23"></a><span id="l9.23">       nsCOMPtr&lt;nsINntpUrl&gt; nntpUrl (do_QueryInterface(mURL, &amp;rv));</span>
<a href="#l9.24"></a><span id="l9.24">       if (NS_SUCCEEDED(rv) &amp;&amp; nntpUrl)</span>
<a href="#l9.25"></a><span id="l9.25">         rv = msgurl-&gt;GetOriginalSpec(getter_Copies(uriString));</span>
<a href="#l9.26"></a><span id="l9.26">       else</span>
<a href="#l9.27"></a><span id="l9.27">         rv = msgurl-&gt;GetUri(getter_Copies(uriString));</span>
<a href="#l9.28"></a><span id="l9.28">     }</span>
<a href="#l9.29"></a><span id="l9.29"> </span>
<a href="#l9.30"></a><span id="l9.30">     // we need to convert the attachment name from UTF-8 to unicode before</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-    // we emit it...</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+    // we emit it.  The attachment name has already been rfc2047 processed</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+    // upstream of us.  (Namely, mime_decode_filename has been called, deferring</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+    // to nsIMimeHeaderParam.decodeParameter.)</span>
<a href="#l9.35"></a><span id="l9.35">     nsString unicodeHeaderValue;</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-    rv = NS_ERROR_FAILURE;  // use failure to mean that we couldn't decode</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-    if (mUnicodeConverter)</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-      rv = mUnicodeConverter-&gt;DecodeMimeHeader(name, nsnull, PR_FALSE, PR_TRUE,</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-                                               unicodeHeaderValue);</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-    {</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-      CopyUTF8toUTF16(nsDependentCString(name), unicodeHeaderValue);</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-      // but it's not really a failure if we didn't have a converter</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-      // in the first place</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-      if ( !mUnicodeConverter )</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-        rv = NS_OK;</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-    }</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+    CopyUTF8toUTF16(nsDependentCString(name), unicodeHeaderValue);</span>
<a href="#l9.52"></a><span id="l9.52"> </span>
<a href="#l9.53"></a><span id="l9.53">     headerSink-&gt;HandleAttachment(contentType, url /* was escapedUrl */,</span>
<a href="#l9.54"></a><span id="l9.54">                                  unicodeHeaderValue.get(), uriString.get(),</span>
<a href="#l9.55"></a><span id="l9.55">                                  aIsExternalAttachment);</span>
<a href="#l9.56"></a><span id="l9.56"> </span>
<a href="#l9.57"></a><span id="l9.57">     mSkipAttachment = PR_TRUE;</span>
<a href="#l9.58"></a><span id="l9.58">   }</span>
<a href="#l9.59"></a><span id="l9.59">   else if (mFormat == nsMimeOutput::nsMimeMessagePrintOutput)</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineat">@@ -481,17 +469,19 @@ nsMimeHtmlDisplayEmitter::StartAttachmen</span>
<a href="#l9.61"></a><span id="l9.61"> }</span>
<a href="#l9.62"></a><span id="l9.62"> </span>
<a href="#l9.63"></a><span id="l9.63"> // Attachment handling routines</span>
<a href="#l9.64"></a><span id="l9.64"> // Ok, we are changing the way we handle these now...It used to be that we output</span>
<a href="#l9.65"></a><span id="l9.65"> // HTML to make a clickable link, etc... but now, this should just be informational</span>
<a href="#l9.66"></a><span id="l9.66"> // and only show up during printing</span>
<a href="#l9.67"></a><span id="l9.67"> // XXX should they also show up during quoting?</span>
<a href="#l9.68"></a><span id="l9.68"> nsresult</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-nsMimeHtmlDisplayEmitter::StartAttachmentInBody(const char *name, const char *contentType, const char *url)</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+nsMimeHtmlDisplayEmitter::StartAttachmentInBody(const nsACString &amp;name,</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+                                                const char *contentType,</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+                                                const char *url)</span>
<a href="#l9.73"></a><span id="l9.73"> {</span>
<a href="#l9.74"></a><span id="l9.74">   mSkipAttachment = PR_FALSE;</span>
<a href="#l9.75"></a><span id="l9.75"> </span>
<a href="#l9.76"></a><span id="l9.76">   if ( (contentType) &amp;&amp;</span>
<a href="#l9.77"></a><span id="l9.77">        ((!strcmp(contentType, APPLICATION_XPKCS7_MIME)) ||</span>
<a href="#l9.78"></a><span id="l9.78">         (!strcmp(contentType, APPLICATION_XPKCS7_SIGNATURE)) ||</span>
<a href="#l9.79"></a><span id="l9.79">         (!strcmp(contentType, TEXT_VCARD)))</span>
<a href="#l9.80"></a><span id="l9.80">      ) {</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineat">@@ -587,19 +577,20 @@ nsMimeHtmlDisplayEmitter::EndAllAttachme</span>
<a href="#l9.82"></a><span id="l9.82">   nsCOMPtr&lt;nsIMsgHeaderSink&gt; headerSink;</span>
<a href="#l9.83"></a><span id="l9.83">   rv = GetHeaderSink(getter_AddRefs(headerSink));</span>
<a href="#l9.84"></a><span id="l9.84">   if (headerSink)</span>
<a href="#l9.85"></a><span id="l9.85">     headerSink-&gt;OnEndAllAttachments();</span>
<a href="#l9.86"></a><span id="l9.86">   return rv;</span>
<a href="#l9.87"></a><span id="l9.87"> }</span>
<a href="#l9.88"></a><span id="l9.88"> </span>
<a href="#l9.89"></a><span id="l9.89"> nsresult</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineminus">-nsMimeHtmlDisplayEmitter::WriteBody(const char *buf, PRUint32 size, PRUint32 *amountWritten)</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+nsMimeHtmlDisplayEmitter::WriteBody(const nsACString &amp;buf,</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineplus">+                                    PRUint32 *amountWritten)</span>
<a href="#l9.93"></a><span id="l9.93"> {</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">-  Write(buf, size, amountWritten);</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineplus">+  Write(buf, amountWritten);</span>
<a href="#l9.96"></a><span id="l9.96">   return NS_OK;</span>
<a href="#l9.97"></a><span id="l9.97"> }</span>
<a href="#l9.98"></a><span id="l9.98"> </span>
<a href="#l9.99"></a><span id="l9.99"> nsresult</span>
<a href="#l9.100"></a><span id="l9.100"> nsMimeHtmlDisplayEmitter::EndBody()</span>
<a href="#l9.101"></a><span id="l9.101"> {</span>
<a href="#l9.102"></a><span id="l9.102">   if (mFormat != nsMimeOutput::nsMimeMessageFilterSniffer)</span>
<a href="#l9.103"></a><span id="l9.103">   {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/mime/emitters/src/nsMimeHtmlEmitter.h</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/mime/emitters/src/nsMimeHtmlEmitter.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -56,40 +56,42 @@ public:</span>
<a href="#l10.4"></a><span id="l10.4">     nsresult Init();</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6">     virtual       ~nsMimeHtmlDisplayEmitter (void);</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8">     // Header handling routines.</span>
<a href="#l10.9"></a><span id="l10.9">     NS_IMETHOD    EndHeader();</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11">     // Attachment handling routines</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-    NS_IMETHOD    StartAttachment(const char *name, const char *contentType, const char *url,</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+    NS_IMETHOD    StartAttachment(const nsACString &amp;name,</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+                                  const char *contentType, const char *url,</span>
<a href="#l10.15"></a><span id="l10.15">                                   PRBool aIsExternalAttachment);</span>
<a href="#l10.16"></a><span id="l10.16">     NS_IMETHOD    AddAttachmentField(const char *field, const char *value);</span>
<a href="#l10.17"></a><span id="l10.17">     NS_IMETHOD    EndAttachment();</span>
<a href="#l10.18"></a><span id="l10.18">     NS_IMETHOD    EndAllAttachments();</span>
<a href="#l10.19"></a><span id="l10.19"> </span>
<a href="#l10.20"></a><span id="l10.20">     // Body handling routines</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-    NS_IMETHOD    WriteBody(const char *buf, PRUint32 size, PRUint32 *amountWritten);</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+    NS_IMETHOD    WriteBody(const nsACString &amp;buf, PRUint32 *amountWritten);</span>
<a href="#l10.23"></a><span id="l10.23">     NS_IMETHOD    EndBody();</span>
<a href="#l10.24"></a><span id="l10.24">     NS_IMETHOD WriteHTMLHeaders();</span>
<a href="#l10.25"></a><span id="l10.25"> </span>
<a href="#l10.26"></a><span id="l10.26">     virtual nsresult            WriteHeaderFieldHTMLPrefix();</span>
<a href="#l10.27"></a><span id="l10.27">     virtual nsresult            WriteHeaderFieldHTML(const char *field, const char *value);</span>
<a href="#l10.28"></a><span id="l10.28">     virtual nsresult            WriteHeaderFieldHTMLPostfix();</span>
<a href="#l10.29"></a><span id="l10.29"> </span>
<a href="#l10.30"></a><span id="l10.30"> protected:</span>
<a href="#l10.31"></a><span id="l10.31">     PRBool        mFirst;  // Attachment flag...</span>
<a href="#l10.32"></a><span id="l10.32">     PRBool        mSkipAttachment;  // attachments we shouldn't show...</span>
<a href="#l10.33"></a><span id="l10.33"> </span>
<a href="#l10.34"></a><span id="l10.34">     nsCOMPtr&lt;nsIMsgHeaderSink&gt; mHeaderSink;</span>
<a href="#l10.35"></a><span id="l10.35"> </span>
<a href="#l10.36"></a><span id="l10.36">     nsresult GetHeaderSink(nsIMsgHeaderSink ** aHeaderSink);</span>
<a href="#l10.37"></a><span id="l10.37">     PRBool BroadCastHeadersAndAttachments();</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-    nsresult StartAttachmentInBody(const char *name, const char *contentType, const char *url);</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+    nsresult StartAttachmentInBody(const nsACString &amp;name,</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+                                   const char *contentType, const char *url);</span>
<a href="#l10.41"></a><span id="l10.41"> </span>
<a href="#l10.42"></a><span id="l10.42">     nsCOMPtr&lt;nsIDateTimeFormat&gt; mDateFormatter;</span>
<a href="#l10.43"></a><span id="l10.43">     nsresult GenerateDateString(const char * dateString, nsACString&amp; formattedDate);</span>
<a href="#l10.44"></a><span id="l10.44">     nsresult BroadcastHeaders(nsIMsgHeaderSink * aHeaderSink, PRInt32 aHeaderMode, PRBool aFromNewsgroup);</span>
<a href="#l10.45"></a><span id="l10.45"> };</span>
<a href="#l10.46"></a><span id="l10.46"> </span>
<a href="#l10.47"></a><span id="l10.47"> </span>
<a href="#l10.48"></a><span id="l10.48"> #endif /* _nsMimeHtmlEmitter_h_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/mime/emitters/src/nsMimePlainEmitter.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/mime/emitters/src/nsMimePlainEmitter.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -83,14 +83,14 @@ nsMimePlainEmitter::AddHeaderField(const</span>
<a href="#l11.4"></a><span id="l11.4"> nsresult</span>
<a href="#l11.5"></a><span id="l11.5"> nsMimePlainEmitter::EndHeader()</span>
<a href="#l11.6"></a><span id="l11.6"> {</span>
<a href="#l11.7"></a><span id="l11.7">   UtilityWriteCRLF(&quot;&quot;);</span>
<a href="#l11.8"></a><span id="l11.8">   return NS_OK; </span>
<a href="#l11.9"></a><span id="l11.9"> }</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11"> NS_IMETHODIMP</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-nsMimePlainEmitter::WriteBody(const char *buf, PRUint32 size, PRUint32 *amountWritten)</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+nsMimePlainEmitter::WriteBody(const nsACString &amp;buf, PRUint32 *amountWritten)</span>
<a href="#l11.14"></a><span id="l11.14"> {</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-  Write(buf, size, amountWritten);</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+  Write(buf, amountWritten);</span>
<a href="#l11.17"></a><span id="l11.17">   return NS_OK;</span>
<a href="#l11.18"></a><span id="l11.18"> }</span>
<a href="#l11.19"></a><span id="l11.19"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/mime/emitters/src/nsMimePlainEmitter.h</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/mime/emitters/src/nsMimePlainEmitter.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -52,12 +52,12 @@ public:</span>
<a href="#l12.4"></a><span id="l12.4">     virtual       ~nsMimePlainEmitter (void);</span>
<a href="#l12.5"></a><span id="l12.5"> </span>
<a href="#l12.6"></a><span id="l12.6">     // Header handling routines.</span>
<a href="#l12.7"></a><span id="l12.7">     NS_IMETHOD    StartHeader(PRBool rootMailHeader, PRBool headerOnly, const char *msgID,</span>
<a href="#l12.8"></a><span id="l12.8">                               const char *outCharset);</span>
<a href="#l12.9"></a><span id="l12.9">     NS_IMETHOD    AddHeaderField(const char *field, const char *value);</span>
<a href="#l12.10"></a><span id="l12.10">     NS_IMETHOD    EndHeader();</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-    NS_IMETHOD    WriteBody(const char *buf, PRUint32 size, PRUint32 *amountWritten);</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+    NS_IMETHOD    WriteBody(const nsACString &amp;buf, PRUint32 *amountWritten);</span>
<a href="#l12.14"></a><span id="l12.14"> };</span>
<a href="#l12.15"></a><span id="l12.15"> </span>
<a href="#l12.16"></a><span id="l12.16"> #endif /* _nsMimePlainEmitter_h_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/mime/emitters/src/nsMimeRawEmitter.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/mime/emitters/src/nsMimeRawEmitter.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -53,14 +53,14 @@ nsMimeRawEmitter::nsMimeRawEmitter()</span>
<a href="#l13.4"></a><span id="l13.4"> }</span>
<a href="#l13.5"></a><span id="l13.5"> </span>
<a href="#l13.6"></a><span id="l13.6"> </span>
<a href="#l13.7"></a><span id="l13.7"> nsMimeRawEmitter::~nsMimeRawEmitter(void)</span>
<a href="#l13.8"></a><span id="l13.8"> {</span>
<a href="#l13.9"></a><span id="l13.9"> }</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11"> NS_IMETHODIMP</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-nsMimeRawEmitter::WriteBody(const char *buf, PRUint32 size, PRUint32 *amountWritten)</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+nsMimeRawEmitter::WriteBody(const nsACString &amp;buf, PRUint32 *amountWritten)</span>
<a href="#l13.14"></a><span id="l13.14"> {</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-  Write(buf, size, amountWritten);</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+  Write(buf, amountWritten);</span>
<a href="#l13.17"></a><span id="l13.17">   return NS_OK;</span>
<a href="#l13.18"></a><span id="l13.18"> }</span>
<a href="#l13.19"></a><span id="l13.19"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/mime/emitters/src/nsMimeRawEmitter.h</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/mime/emitters/src/nsMimeRawEmitter.h</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -46,15 +46,15 @@</span>
<a href="#l14.4"></a><span id="l14.4"> #include &quot;nsIURI.h&quot;</span>
<a href="#l14.5"></a><span id="l14.5"> #include &quot;nsIChannel.h&quot;</span>
<a href="#l14.6"></a><span id="l14.6"> </span>
<a href="#l14.7"></a><span id="l14.7"> class nsMimeRawEmitter : public nsMimeBaseEmitter {</span>
<a href="#l14.8"></a><span id="l14.8"> public: </span>
<a href="#l14.9"></a><span id="l14.9">     nsMimeRawEmitter ();</span>
<a href="#l14.10"></a><span id="l14.10">     virtual       ~nsMimeRawEmitter (void);</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-    NS_IMETHOD    WriteBody(const char *buf, PRUint32 size, PRUint32 *amountWritten);</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+    NS_IMETHOD    WriteBody(const nsACString &amp;buf, PRUint32 *amountWritten);</span>
<a href="#l14.14"></a><span id="l14.14"> </span>
<a href="#l14.15"></a><span id="l14.15"> protected:</span>
<a href="#l14.16"></a><span id="l14.16"> };</span>
<a href="#l14.17"></a><span id="l14.17"> </span>
<a href="#l14.18"></a><span id="l14.18"> </span>
<a href="#l14.19"></a><span id="l14.19"> #endif /* _nsMimeRawEmitter_h_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/mime/emitters/src/nsMimeXmlEmitter.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/mime/emitters/src/nsMimeXmlEmitter.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -178,27 +178,29 @@ nsMimeXmlEmitter::EndHeader()</span>
<a href="#l15.4"></a><span id="l15.4"> {</span>
<a href="#l15.5"></a><span id="l15.5">   UtilityWrite(&quot;&lt;/mailheader&gt;&quot;);</span>
<a href="#l15.6"></a><span id="l15.6">   return NS_OK;</span>
<a href="#l15.7"></a><span id="l15.7"> }</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9"> </span>
<a href="#l15.10"></a><span id="l15.10"> // Attachment handling routines</span>
<a href="#l15.11"></a><span id="l15.11"> nsresult</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-nsMimeXmlEmitter::StartAttachment(const char *name, const char *contentType, const char *url,</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+nsMimeXmlEmitter::StartAttachment(const nsACString &amp;name,</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+                                  const char *contentType,</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+                                  const char *url,</span>
<a href="#l15.16"></a><span id="l15.16">                                   PRBool aIsExternalAttachment)</span>
<a href="#l15.17"></a><span id="l15.17"> {</span>
<a href="#l15.18"></a><span id="l15.18">   char    buf[128];</span>
<a href="#l15.19"></a><span id="l15.19"> </span>
<a href="#l15.20"></a><span id="l15.20">   ++mAttachCount;</span>
<a href="#l15.21"></a><span id="l15.21"> </span>
<a href="#l15.22"></a><span id="l15.22">   sprintf(buf, &quot;&lt;mailattachment id=\&quot;%d\&quot;&gt;&quot;, mAttachCount);</span>
<a href="#l15.23"></a><span id="l15.23">   UtilityWrite(buf);</span>
<a href="#l15.24"></a><span id="l15.24"> </span>
<a href="#l15.25"></a><span id="l15.25" class="difflineminus">-  AddAttachmentField(HEADER_PARM_FILENAME, name);</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+  AddAttachmentField(HEADER_PARM_FILENAME, PromiseFlatCString(name).get());</span>
<a href="#l15.27"></a><span id="l15.27">   return NS_OK;</span>
<a href="#l15.28"></a><span id="l15.28"> }</span>
<a href="#l15.29"></a><span id="l15.29"> </span>
<a href="#l15.30"></a><span id="l15.30"> nsresult</span>
<a href="#l15.31"></a><span id="l15.31"> nsMimeXmlEmitter::AddAttachmentField(const char *field, const char *value)</span>
<a href="#l15.32"></a><span id="l15.32"> {</span>
<a href="#l15.33"></a><span id="l15.33">   WriteXMLTag(field, value);</span>
<a href="#l15.34"></a><span id="l15.34">   return NS_OK;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/mime/emitters/src/nsMimeXmlEmitter.h</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/mime/emitters/src/nsMimeXmlEmitter.h</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -55,17 +55,18 @@ public:</span>
<a href="#l16.4"></a><span id="l16.4"> </span>
<a href="#l16.5"></a><span id="l16.5">     // Header handling routines.</span>
<a href="#l16.6"></a><span id="l16.6">     NS_IMETHOD    StartHeader(PRBool rootMailHeader, PRBool headerOnly, const char *msgID,</span>
<a href="#l16.7"></a><span id="l16.7">                               const char *outCharset);</span>
<a href="#l16.8"></a><span id="l16.8">     NS_IMETHOD    AddHeaderField(const char *field, const char *value);</span>
<a href="#l16.9"></a><span id="l16.9">     NS_IMETHOD    EndHeader();</span>
<a href="#l16.10"></a><span id="l16.10"> </span>
<a href="#l16.11"></a><span id="l16.11">     // Attachment handling routines</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-    NS_IMETHOD    StartAttachment(const char *name, const char *contentType, const char *url,</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+    NS_IMETHOD    StartAttachment(const nsACString &amp;name,</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+                                  const char *contentType, const char *url,</span>
<a href="#l16.15"></a><span id="l16.15">                                   PRBool aIsExternalAttachment);</span>
<a href="#l16.16"></a><span id="l16.16">     NS_IMETHOD    AddAttachmentField(const char *field, const char *value);</span>
<a href="#l16.17"></a><span id="l16.17">     NS_IMETHOD    EndAttachment();</span>
<a href="#l16.18"></a><span id="l16.18"> </span>
<a href="#l16.19"></a><span id="l16.19">     NS_IMETHOD    WriteXMLHeader(const char *msgID);</span>
<a href="#l16.20"></a><span id="l16.20">     NS_IMETHOD    WriteXMLTag(const char *tagName, const char *value);</span>
<a href="#l16.21"></a><span id="l16.21"> </span>
<a href="#l16.22"></a><span id="l16.22"> protected:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/mime/public/nsIMimeEmitter.idl</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/mime/public/nsIMimeEmitter.idl</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -50,17 +50,17 @@ interface nsMimeHeaderDisplayTypes</span>
<a href="#l17.4"></a><span id="l17.4">     const long NormalHeaders = 1;</span>
<a href="#l17.5"></a><span id="l17.5">     const long AllHeaders = 2;</span>
<a href="#l17.6"></a><span id="l17.6"> };</span>
<a href="#l17.7"></a><span id="l17.7"> </span>
<a href="#l17.8"></a><span id="l17.8"> %{C++</span>
<a href="#l17.9"></a><span id="l17.9"> #define NS_IMIME_MISC_STATUS_KEY       &quot;@mozilla.org/MimeMiscStatus;1?type=&quot;</span>
<a href="#l17.10"></a><span id="l17.10"> %}</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-[scriptable, uuid(c470b05e-9006-43a4-aa84-0da080360675)]</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+[scriptable, uuid(7a57166f-2891-4122-9a74-6c3fab0caac3)]</span>
<a href="#l17.14"></a><span id="l17.14"> interface nsIMimeEmitter : nsISupports {</span>
<a href="#l17.15"></a><span id="l17.15"> </span>
<a href="#l17.16"></a><span id="l17.16">     // Output listener to allow access to it from mime.</span>
<a href="#l17.17"></a><span id="l17.17">     attribute nsIStreamListener outputListener;</span>
<a href="#l17.18"></a><span id="l17.18"> </span>
<a href="#l17.19"></a><span id="l17.19">     // These will be called to start and stop the total operation.</span>
<a href="#l17.20"></a><span id="l17.20">     void initialize(in nsIURI url, in nsIChannel aChannel, in long aFormat);</span>
<a href="#l17.21"></a><span id="l17.21">     void complete();</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineat">@@ -73,26 +73,27 @@ interface nsIMimeEmitter : nsISupports {</span>
<a href="#l17.23"></a><span id="l17.23">                      [const] in string msgID, [const] in string outCharset);</span>
<a href="#l17.24"></a><span id="l17.24">     void addHeaderField([const] in string field, [const] in string value);</span>
<a href="#l17.25"></a><span id="l17.25">     void addAllHeaders(in ACString allheaders);</span>
<a href="#l17.26"></a><span id="l17.26">     void writeHTMLHeaders(); // Book case this with an EndHeader call.</span>
<a href="#l17.27"></a><span id="l17.27">     void endHeader();</span>
<a href="#l17.28"></a><span id="l17.28">     void updateCharacterSet([const] in string aCharset);</span>
<a href="#l17.29"></a><span id="l17.29"> </span>
<a href="#l17.30"></a><span id="l17.30">     // Attachment handling routines.</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-    void startAttachment([const] in string name, [const] in string contentType,</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+    void startAttachment([const] in AUTF8String name,</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+                         [const] in string contentType,</span>
<a href="#l17.34"></a><span id="l17.34">                          [const] in string url, in PRBool aNotDownloaded);</span>
<a href="#l17.35"></a><span id="l17.35">     void addAttachmentField([const] in string field, [const] in string value);</span>
<a href="#l17.36"></a><span id="l17.36">     void endAttachment();</span>
<a href="#l17.37"></a><span id="l17.37"> </span>
<a href="#l17.38"></a><span id="l17.38">     void endAllAttachments();</span>
<a href="#l17.39"></a><span id="l17.39"> </span>
<a href="#l17.40"></a><span id="l17.40">     // Body handling routines.</span>
<a href="#l17.41"></a><span id="l17.41">     void startBody(in PRBool bodyOnly, [const] in string msgID, [const] in string outCharset);</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineminus">-    void writeBody([const] in string buf, in PRUint32 size, out PRUint32 amountWritten);</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+    void writeBody([const] in AUTF8String buf, out PRUint32 amountWritten);</span>
<a href="#l17.44"></a><span id="l17.44">     void endBody();</span>
<a href="#l17.45"></a><span id="l17.45"> </span>
<a href="#l17.46"></a><span id="l17.46">     // Generic write routine. This is necessary for output that</span>
<a href="#l17.47"></a><span id="l17.47">     // libmime needs to pass through without any particular parsing</span>
<a href="#l17.48"></a><span id="l17.48">     // involved (i.e. decoded images, HTML Body Text, etc...</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineminus">-    void write([const] in string buf, in PRUint32 size, out PRUint32 amountWritten);</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+    void write([const] in ACString buf, out PRUint32 amountWritten);</span>
<a href="#l17.51"></a><span id="l17.51">     void utilityWrite([const] in string buf);</span>
<a href="#l17.52"></a><span id="l17.52"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/mime/src/mimemoz2.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/mime/src/mimemoz2.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -888,24 +888,25 @@ mime_output_fn(const char *buf, PRInt32 </span>
<a href="#l18.4"></a><span id="l18.4"> </span>
<a href="#l18.5"></a><span id="l18.5"> </span>
<a href="#l18.6"></a><span id="l18.6">   // Now, write to the WriteBody method if this is a message body and not</span>
<a href="#l18.7"></a><span id="l18.7">   // a part retrevial</span>
<a href="#l18.8"></a><span id="l18.8">   if (!msd-&gt;options-&gt;part_to_load || msd-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageBodyDisplay)</span>
<a href="#l18.9"></a><span id="l18.9">   {</span>
<a href="#l18.10"></a><span id="l18.10">     if (msd-&gt;output_emitter)</span>
<a href="#l18.11"></a><span id="l18.11">     {</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-      msd-&gt;output_emitter-&gt;WriteBody(buf, (PRUint32) size, &amp;written);</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+      msd-&gt;output_emitter-&gt;WriteBody(Substring(buf, buf+size),</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+                                     &amp;written);</span>
<a href="#l18.15"></a><span id="l18.15">     }</span>
<a href="#l18.16"></a><span id="l18.16">   }</span>
<a href="#l18.17"></a><span id="l18.17">   else</span>
<a href="#l18.18"></a><span id="l18.18">   {</span>
<a href="#l18.19"></a><span id="l18.19">     if (msd-&gt;output_emitter)</span>
<a href="#l18.20"></a><span id="l18.20">     {</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineminus">-      msd-&gt;output_emitter-&gt;Write(buf, (PRUint32) size, &amp;written);</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineplus">+      msd-&gt;output_emitter-&gt;Write(Substring(buf, buf+size), &amp;written);</span>
<a href="#l18.23"></a><span id="l18.23">     }</span>
<a href="#l18.24"></a><span id="l18.24">   }</span>
<a href="#l18.25"></a><span id="l18.25">   return written;</span>
<a href="#l18.26"></a><span id="l18.26"> }</span>
<a href="#l18.27"></a><span id="l18.27"> </span>
<a href="#l18.28"></a><span id="l18.28"> extern &quot;C&quot; int</span>
<a href="#l18.29"></a><span id="l18.29"> mime_display_stream_write (nsMIMESession *stream,</span>
<a href="#l18.30"></a><span id="l18.30">                            const char* buf,</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineat">@@ -1794,17 +1795,18 @@ mimeEmitterStartAttachment(MimeDisplayOp</span>
<a href="#l18.32"></a><span id="l18.32"> </span>
<a href="#l18.33"></a><span id="l18.33">   mime_stream_data  *msd = GetMSD(opt);</span>
<a href="#l18.34"></a><span id="l18.34">   if (!msd)</span>
<a href="#l18.35"></a><span id="l18.35">     return NS_ERROR_FAILURE;</span>
<a href="#l18.36"></a><span id="l18.36"> </span>
<a href="#l18.37"></a><span id="l18.37">   if (msd-&gt;output_emitter)</span>
<a href="#l18.38"></a><span id="l18.38">   {</span>
<a href="#l18.39"></a><span id="l18.39">     nsIMimeEmitter *emitter = (nsIMimeEmitter *)msd-&gt;output_emitter;</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineminus">-    return emitter-&gt;StartAttachment(name, contentType, url, aIsExternalAttachment);</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+    return emitter-&gt;StartAttachment(nsDependentCString(name), contentType, url,</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+                                    aIsExternalAttachment);</span>
<a href="#l18.43"></a><span id="l18.43">   }</span>
<a href="#l18.44"></a><span id="l18.44"> </span>
<a href="#l18.45"></a><span id="l18.45">   return NS_ERROR_FAILURE;</span>
<a href="#l18.46"></a><span id="l18.46"> }</span>
<a href="#l18.47"></a><span id="l18.47"> </span>
<a href="#l18.48"></a><span id="l18.48"> extern &quot;C&quot; nsresult</span>
<a href="#l18.49"></a><span id="l18.49"> mimeEmitterEndAttachment(MimeDisplayOptions *opt)</span>
<a href="#l18.50"></a><span id="l18.50"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/mime/src/nsStreamConverter.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/mime/src/nsStreamConverter.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -884,17 +884,17 @@ const char output[] = &quot;\</span>
<a href="#l19.4"></a><span id="l19.4"> </span>
<a href="#l19.5"></a><span id="l19.5">     nsCAutoString url;</span>
<a href="#l19.6"></a><span id="l19.6">     if (NS_FAILED(mURI-&gt;GetSpec(url)))</span>
<a href="#l19.7"></a><span id="l19.7">       return NS_ERROR_FAILURE;</span>
<a href="#l19.8"></a><span id="l19.8"> </span>
<a href="#l19.9"></a><span id="l19.9">     PR_snprintf(outBuf, sizeof(outBuf), output, url.get(), url.get());</span>
<a href="#l19.10"></a><span id="l19.10"> </span>
<a href="#l19.11"></a><span id="l19.11">     if (mEmitter)</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-      mEmitter-&gt;Write(outBuf, strlen(outBuf), &amp;written);</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+      mEmitter-&gt;Write(nsDependentCString(outBuf), &amp;written);</span>
<a href="#l19.14"></a><span id="l19.14"> </span>
<a href="#l19.15"></a><span id="l19.15">     // rhp: will this stop the stream???? Not sure.</span>
<a href="#l19.16"></a><span id="l19.16">     return NS_ERROR_FAILURE;</span>
<a href="#l19.17"></a><span id="l19.17">   }</span>
<a href="#l19.18"></a><span id="l19.18"> </span>
<a href="#l19.19"></a><span id="l19.19">   char *buf = (char *)PR_Malloc(aLength);</span>
<a href="#l19.20"></a><span id="l19.20">   if (!buf)</span>
<a href="#l19.21"></a><span id="l19.21">     return NS_ERROR_OUT_OF_MEMORY; /* we couldn't allocate the object */</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineat">@@ -925,17 +925,19 @@ const char output[] = &quot;\</span>
<a href="#l19.23"></a><span id="l19.23">     }</span>
<a href="#l19.24"></a><span id="l19.24">     readLen = writePtr - buf;</span>
<a href="#l19.25"></a><span id="l19.25">   }</span>
<a href="#l19.26"></a><span id="l19.26"> </span>
<a href="#l19.27"></a><span id="l19.27">   if (mOutputType == nsMimeOutput::nsMimeMessageSource)</span>
<a href="#l19.28"></a><span id="l19.28">   {</span>
<a href="#l19.29"></a><span id="l19.29">     rc = NS_OK;</span>
<a href="#l19.30"></a><span id="l19.30">     if (mEmitter)</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-      rc = mEmitter-&gt;Write(buf, readLen, &amp;written);</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+    {</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineplus">+      rc = mEmitter-&gt;Write(Substring(buf, buf+readLen), &amp;written);</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineplus">+    }</span>
<a href="#l19.35"></a><span id="l19.35">   }</span>
<a href="#l19.36"></a><span id="l19.36">   else if (mBridgeStream)</span>
<a href="#l19.37"></a><span id="l19.37">   {</span>
<a href="#l19.38"></a><span id="l19.38">     nsMIMESession   *tSession = (nsMIMESession *) mBridgeStream;</span>
<a href="#l19.39"></a><span id="l19.39">     rc = tSession-&gt;put_block((nsMIMESession *)mBridgeStream, buf, readLen);</span>
<a href="#l19.40"></a><span id="l19.40">   }</span>
<a href="#l19.41"></a><span id="l19.41"> </span>
<a href="#l19.42"></a><span id="l19.42">   PR_FREEIF(buf);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

