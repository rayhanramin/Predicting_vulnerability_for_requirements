<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 27291:6429eb3600985b668f133ab744934ae402a1db44</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 6429eb3600985b668f133ab744934ae402a1db44" />
<meta property="og:url" content="/comm-central/rev/6429eb3600985b668f133ab744934ae402a1db44" />
<meta property="og:description" content="Bug 1547508 - add logging of message filter actions. r=jorgk" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 6429eb3600985b668f133ab744934ae402a1db44 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/6429eb3600985b668f133ab744934ae402a1db44">shortlog</a> |
<a href="/comm-central/log/6429eb3600985b668f133ab744934ae402a1db44">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/6429eb3600985b668f133ab744934ae402a1db44">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/6429eb3600985b668f133ab744934ae402a1db44">files</a> |
changeset |
<a href="/comm-central/raw-rev/6429eb3600985b668f133ab744934ae402a1db44">raw</a>  | <a href="/comm-central/archive/6429eb3600985b668f133ab744934ae402a1db44.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1547508">Bug 1547508</a> - add logging of message filter actions. r=jorgk
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#97;&#99;&#101;&#109;&#97;&#110;&#32;&#60;&#97;&#99;&#101;&#108;&#105;&#115;&#116;&#115;&#64;&#97;&#116;&#108;&#97;&#115;&#46;&#115;&#107;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 27 Jul 2019 21:55:50 +0200</td></tr>

<tr>
 <td>changeset 27291</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/6429eb3600985b668f133ab744934ae402a1db44">6429eb3600985b668f133ab744934ae402a1db44</a></td>
</tr>



<tr>
<td>parent 27290</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/fed5e95f3b950195dbdd1ff59376c7741528c11d">fed5e95f3b950195dbdd1ff59376c7741528c11d</a>
</td>
</tr>

<tr>
<td>child 27292</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/97f7da2882410009b4249e7b16905caedf52588c">97f7da2882410009b4249e7b16905caedf52588c</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=6429eb3600985b668f133ab744934ae402a1db44">16271</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Sat, 10 Aug 2019 21:38:23 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@6429eb360098 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=6429eb3600985b668f133ab744934ae402a1db44">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=6429eb3600985b668f133ab744934ae402a1db44&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6429eb3600985b668f133ab744934ae402a1db44&newProject=comm-central&newRevision=c0c1b35d4b8bb63a986f2b88eee1efeda8a5a63d&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6429eb3600985b668f133ab744934ae402a1db44&newProject=comm-central&newRevision=c0c1b35d4b8bb63a986f2b88eee1efeda8a5a63d&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6429eb3600985b668f133ab744934ae402a1db44&newProject=comm-central&newRevision=c0c1b35d4b8bb63a986f2b88eee1efeda8a5a63d&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28jorgk%29&revcount=50">jorgk</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1547508">1547508</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1547508">Bug 1547508</a> - add logging of message filter actions. r=jorgk</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6429eb3600985b668f133ab744934ae402a1db44/mail/locales/en-US/chrome/messenger/filter.properties">mail/locales/en-US/chrome/messenger/filter.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6429eb3600985b668f133ab744934ae402a1db44/mail/locales/en-US/chrome/messenger/filter.properties">file</a> |
<a href="/comm-central/annotate/6429eb3600985b668f133ab744934ae402a1db44/mail/locales/en-US/chrome/messenger/filter.properties">annotate</a> |
<a href="/comm-central/diff/6429eb3600985b668f133ab744934ae402a1db44/mail/locales/en-US/chrome/messenger/filter.properties">diff</a> |
<a href="/comm-central/comparison/6429eb3600985b668f133ab744934ae402a1db44/mail/locales/en-US/chrome/messenger/filter.properties">comparison</a> |
<a href="/comm-central/log/6429eb3600985b668f133ab744934ae402a1db44/mail/locales/en-US/chrome/messenger/filter.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6429eb3600985b668f133ab744934ae402a1db44/mailnews/base/search/src/nsMsgFilter.cpp">mailnews/base/search/src/nsMsgFilter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6429eb3600985b668f133ab744934ae402a1db44/mailnews/base/search/src/nsMsgFilter.cpp">file</a> |
<a href="/comm-central/annotate/6429eb3600985b668f133ab744934ae402a1db44/mailnews/base/search/src/nsMsgFilter.cpp">annotate</a> |
<a href="/comm-central/diff/6429eb3600985b668f133ab744934ae402a1db44/mailnews/base/search/src/nsMsgFilter.cpp">diff</a> |
<a href="/comm-central/comparison/6429eb3600985b668f133ab744934ae402a1db44/mailnews/base/search/src/nsMsgFilter.cpp">comparison</a> |
<a href="/comm-central/log/6429eb3600985b668f133ab744934ae402a1db44/mailnews/base/search/src/nsMsgFilter.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6429eb3600985b668f133ab744934ae402a1db44/mailnews/base/search/src/nsMsgFilterList.cpp">mailnews/base/search/src/nsMsgFilterList.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6429eb3600985b668f133ab744934ae402a1db44/mailnews/base/search/src/nsMsgFilterList.cpp">file</a> |
<a href="/comm-central/annotate/6429eb3600985b668f133ab744934ae402a1db44/mailnews/base/search/src/nsMsgFilterList.cpp">annotate</a> |
<a href="/comm-central/diff/6429eb3600985b668f133ab744934ae402a1db44/mailnews/base/search/src/nsMsgFilterList.cpp">diff</a> |
<a href="/comm-central/comparison/6429eb3600985b668f133ab744934ae402a1db44/mailnews/base/search/src/nsMsgFilterList.cpp">comparison</a> |
<a href="/comm-central/log/6429eb3600985b668f133ab744934ae402a1db44/mailnews/base/search/src/nsMsgFilterList.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6429eb3600985b668f133ab744934ae402a1db44/mailnews/base/search/src/nsMsgFilterService.cpp">mailnews/base/search/src/nsMsgFilterService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6429eb3600985b668f133ab744934ae402a1db44/mailnews/base/search/src/nsMsgFilterService.cpp">file</a> |
<a href="/comm-central/annotate/6429eb3600985b668f133ab744934ae402a1db44/mailnews/base/search/src/nsMsgFilterService.cpp">annotate</a> |
<a href="/comm-central/diff/6429eb3600985b668f133ab744934ae402a1db44/mailnews/base/search/src/nsMsgFilterService.cpp">diff</a> |
<a href="/comm-central/comparison/6429eb3600985b668f133ab744934ae402a1db44/mailnews/base/search/src/nsMsgFilterService.cpp">comparison</a> |
<a href="/comm-central/log/6429eb3600985b668f133ab744934ae402a1db44/mailnews/base/search/src/nsMsgFilterService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6429eb3600985b668f133ab744934ae402a1db44/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6429eb3600985b668f133ab744934ae402a1db44/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/6429eb3600985b668f133ab744934ae402a1db44/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/6429eb3600985b668f133ab744934ae402a1db44/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/6429eb3600985b668f133ab744934ae402a1db44/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/6429eb3600985b668f133ab744934ae402a1db44/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6429eb3600985b668f133ab744934ae402a1db44/mailnews/local/src/nsParseMailbox.cpp">mailnews/local/src/nsParseMailbox.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6429eb3600985b668f133ab744934ae402a1db44/mailnews/local/src/nsParseMailbox.cpp">file</a> |
<a href="/comm-central/annotate/6429eb3600985b668f133ab744934ae402a1db44/mailnews/local/src/nsParseMailbox.cpp">annotate</a> |
<a href="/comm-central/diff/6429eb3600985b668f133ab744934ae402a1db44/mailnews/local/src/nsParseMailbox.cpp">diff</a> |
<a href="/comm-central/comparison/6429eb3600985b668f133ab744934ae402a1db44/mailnews/local/src/nsParseMailbox.cpp">comparison</a> |
<a href="/comm-central/log/6429eb3600985b668f133ab744934ae402a1db44/mailnews/local/src/nsParseMailbox.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6429eb3600985b668f133ab744934ae402a1db44/mailnews/news/src/nsNNTPNewsgroupList.cpp">mailnews/news/src/nsNNTPNewsgroupList.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6429eb3600985b668f133ab744934ae402a1db44/mailnews/news/src/nsNNTPNewsgroupList.cpp">file</a> |
<a href="/comm-central/annotate/6429eb3600985b668f133ab744934ae402a1db44/mailnews/news/src/nsNNTPNewsgroupList.cpp">annotate</a> |
<a href="/comm-central/diff/6429eb3600985b668f133ab744934ae402a1db44/mailnews/news/src/nsNNTPNewsgroupList.cpp">diff</a> |
<a href="/comm-central/comparison/6429eb3600985b668f133ab744934ae402a1db44/mailnews/news/src/nsNNTPNewsgroupList.cpp">comparison</a> |
<a href="/comm-central/log/6429eb3600985b668f133ab744934ae402a1db44/mailnews/news/src/nsNNTPNewsgroupList.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6429eb3600985b668f133ab744934ae402a1db44/suite/locales/en-US/chrome/mailnews/filter.properties">suite/locales/en-US/chrome/mailnews/filter.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6429eb3600985b668f133ab744934ae402a1db44/suite/locales/en-US/chrome/mailnews/filter.properties">file</a> |
<a href="/comm-central/annotate/6429eb3600985b668f133ab744934ae402a1db44/suite/locales/en-US/chrome/mailnews/filter.properties">annotate</a> |
<a href="/comm-central/diff/6429eb3600985b668f133ab744934ae402a1db44/suite/locales/en-US/chrome/mailnews/filter.properties">diff</a> |
<a href="/comm-central/comparison/6429eb3600985b668f133ab744934ae402a1db44/suite/locales/en-US/chrome/mailnews/filter.properties">comparison</a> |
<a href="/comm-central/log/6429eb3600985b668f133ab744934ae402a1db44/suite/locales/en-US/chrome/mailnews/filter.properties">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/filter.properties</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/filter.properties</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -36,16 +36,17 @@ contextPeriodic.label=Periodically, ever</span>
<a href="#l1.4"></a><span id="l1.4"> # LOCALIZATION NOTE(filterFailureWarningPrefix)</span>
<a href="#l1.5"></a><span id="l1.5"> # %1$S=filter error action</span>
<a href="#l1.6"></a><span id="l1.6"> # %2$S=error code as hexadecimal string.</span>
<a href="#l1.7"></a><span id="l1.7"> filterFailureWarningPrefix=Filter action failed: &quot;%1$S&quot; with error code=%2$S while attempting:</span>
<a href="#l1.8"></a><span id="l1.8"> filterFailureSendingReplyError=Error sending reply</span>
<a href="#l1.9"></a><span id="l1.9"> filterFailureSendingReplyAborted=Sending reply aborted</span>
<a href="#l1.10"></a><span id="l1.10"> filterFailureMoveFailed=Move failed</span>
<a href="#l1.11"></a><span id="l1.11"> filterFailureCopyFailed=Copy failed</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+filterFailureAction=Failed applying the filter action</span>
<a href="#l1.13"></a><span id="l1.13"> </span>
<a href="#l1.14"></a><span id="l1.14"> searchTermsInvalidTitle=Search Terms Invalid</span>
<a href="#l1.15"></a><span id="l1.15"> # LOCALIZATION NOTE(searchTermsInvalidRule)</span>
<a href="#l1.16"></a><span id="l1.16"> # %1$S=search attribute name from the invalid rule</span>
<a href="#l1.17"></a><span id="l1.17"> # %2$S=search operator from the bad rule</span>
<a href="#l1.18"></a><span id="l1.18"> searchTermsInvalidRule=This filter cannot be saved because the search term &quot;%1$S %2$S&quot; is invalid in the current context.</span>
<a href="#l1.19"></a><span id="l1.19"> # LOCALIZATION NOTE(filterActionOrderExplanation)</span>
<a href="#l1.20"></a><span id="l1.20"> # Keep the \n\n that mean 2 linebreaks.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilter.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilter.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -568,18 +568,17 @@ nsresult nsMsgFilter::LogRuleHitGeneric(</span>
<a href="#l2.4"></a><span id="l2.4">     filterActionID.AppendInt(actionType);</span>
<a href="#l2.5"></a><span id="l2.5">     rv = bundle-&gt;GetStringFromName(filterActionID.get(), actionValue);</span>
<a href="#l2.6"></a><span id="l2.6">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8">     buffer += actionValue;</span>
<a href="#l2.9"></a><span id="l2.9">   }</span>
<a href="#l2.10"></a><span id="l2.10">   buffer.AppendLiteral(&quot;\n&quot;);</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  m_filterList-&gt;LogFilterMessage(buffer, nullptr);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-  return NS_OK;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+  return m_filterList-&gt;LogFilterMessage(buffer, nullptr);</span>
<a href="#l2.15"></a><span id="l2.15"> }</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> NS_IMETHODIMP nsMsgFilter::LogRuleHit(nsIMsgRuleAction *aFilterAction,</span>
<a href="#l2.18"></a><span id="l2.18">                                       nsIMsgDBHdr *aMsgHdr) {</span>
<a href="#l2.19"></a><span id="l2.19">   return nsMsgFilter::LogRuleHitGeneric(aFilterAction, aMsgHdr, NS_OK,</span>
<a href="#l2.20"></a><span id="l2.20">                                         EmptyCString());</span>
<a href="#l2.21"></a><span id="l2.21"> }</span>
<a href="#l2.22"></a><span id="l2.22"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilterList.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilterList.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -310,19 +310,21 @@ nsMsgFilterList::ApplyFiltersToHdr(nsMsg</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5">   for (uint32_t filterIndex = 0; filterIndex &lt; filterCount; filterIndex++) {</span>
<a href="#l3.6"></a><span id="l3.6">     if (NS_SUCCEEDED(GetFilterAt(filterIndex, getter_AddRefs(filter)))) {</span>
<a href="#l3.7"></a><span id="l3.7">       bool isEnabled;</span>
<a href="#l3.8"></a><span id="l3.8">       nsMsgFilterTypeType curFilterType;</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10">       filter-&gt;GetEnabled(&amp;isEnabled);</span>
<a href="#l3.11"></a><span id="l3.11">       if (!isEnabled) {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-        MOZ_LOG(</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-            FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-            (&quot;(Auto) Skipping disabled filter at index %&quot; PRIu32, filterIndex));</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+        // clang-format off</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+        MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+                (&quot;(Auto) Skipping disabled filter at index %&quot; PRIu32,</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+                 filterIndex));</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+        // clang-format on</span>
<a href="#l3.20"></a><span id="l3.20">         continue;</span>
<a href="#l3.21"></a><span id="l3.21">       }</span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23">       nsString filterName;</span>
<a href="#l3.24"></a><span id="l3.24">       filter-&gt;GetFilterName(filterName);</span>
<a href="#l3.25"></a><span id="l3.25">       filter-&gt;GetFilterType(&amp;curFilterType);</span>
<a href="#l3.26"></a><span id="l3.26">       if (curFilterType &amp; filterType) {</span>
<a href="#l3.27"></a><span id="l3.27">         MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineat">@@ -344,51 +346,55 @@ nsMsgFilterList::ApplyFiltersToHdr(nsMsg</span>
<a href="#l3.29"></a><span id="l3.29">           MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l3.30"></a><span id="l3.30">                   (&quot;(Auto) Filter matched message with key %&quot; PRIu32,</span>
<a href="#l3.31"></a><span id="l3.31">                    msgKeyToInt(msgKey)));</span>
<a href="#l3.32"></a><span id="l3.32">           MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l3.33"></a><span id="l3.33">                   (&quot;(Auto) Matched message ID: %s&quot;, msgId.get()));</span>
<a href="#l3.34"></a><span id="l3.34"> </span>
<a href="#l3.35"></a><span id="l3.35">           bool applyMore = true;</span>
<a href="#l3.36"></a><span id="l3.36">           rv = listener-&gt;ApplyFilterHit(filter, msgWindow, &amp;applyMore);</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+          if (NS_FAILED(rv)) {</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+            MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+                    (&quot;(Auto) Applying filter actions failed&quot;));</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+            LogFilterMessage(</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+                NS_LITERAL_STRING(&quot;Applying filter actions failed&quot;), filter);</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+          } else {</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+            MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+                    (&quot;(Auto) Applying filter actions succeeded&quot;));</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+          }</span>
<a href="#l3.46"></a><span id="l3.46">           if (NS_FAILED(rv) || !applyMore) {</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-            if (NS_FAILED(rv)) {</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-              MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-                      (&quot;(Auto) Applying filter actions failed&quot;));</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-              LogFilterMessage(</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-                  NS_LITERAL_STRING(&quot;Applying filter actions failed&quot;), filter);</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-            }</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-            MOZ_LOG(</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-                FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-                (&quot;(Auto) Stopping further filter execution on this message&quot;));</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+            MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+                    (&quot;(Auto) Stopping further filter execution&quot;</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+                     &quot; on this message&quot;));</span>
<a href="#l3.59"></a><span id="l3.59">             break;</span>
<a href="#l3.60"></a><span id="l3.60">           }</span>
<a href="#l3.61"></a><span id="l3.61">         } else {</span>
<a href="#l3.62"></a><span id="l3.62">           if (NS_FAILED(matchTermStatus)) {</span>
<a href="#l3.63"></a><span id="l3.63">             MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,</span>
<a href="#l3.64"></a><span id="l3.64">                     (&quot;(Auto) Filter evaluation failed&quot;));</span>
<a href="#l3.65"></a><span id="l3.65">             LogFilterMessage(NS_LITERAL_STRING(&quot;Filter evaluation failed&quot;),</span>
<a href="#l3.66"></a><span id="l3.66">                              filter);</span>
<a href="#l3.67"></a><span id="l3.67">           }</span>
<a href="#l3.68"></a><span id="l3.68">           if (!result)</span>
<a href="#l3.69"></a><span id="l3.69">             MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l3.70"></a><span id="l3.70">                     (&quot;(Auto) Filter didn't match&quot;));</span>
<a href="#l3.71"></a><span id="l3.71">         }</span>
<a href="#l3.72"></a><span id="l3.72">       } else {</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-        MOZ_LOG(</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-            FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-            (&quot;(Auto) Skipping filter of non-matching type at index %&quot; PRIu32,</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-             filterIndex));</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+        MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+                (&quot;(Auto) Skipping filter of non-matching type&quot;</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+                 &quot; at index %&quot; PRIu32,</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+                 filterIndex));</span>
<a href="#l3.81"></a><span id="l3.81">       }</span>
<a href="#l3.82"></a><span id="l3.82">     }</span>
<a href="#l3.83"></a><span id="l3.83">   }</span>
<a href="#l3.84"></a><span id="l3.84">   if (NS_FAILED(rv)) {</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-    MOZ_LOG(</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-        FILTERLOGMODULE, LogLevel::Error,</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-        (&quot;(Auto) Filter run failed (%&quot; PRIx32 &quot;)&quot;, static_cast&lt;uint32_t&gt;(rv)));</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+    // clang-format off</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+            (&quot;(Auto) Filter run failed (%&quot; PRIx32 &quot;)&quot;, static_cast&lt;uint32_t&gt;(rv)));</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+    // clang-format on</span>
<a href="#l3.92"></a><span id="l3.92">     LogFilterMessage(NS_LITERAL_STRING(&quot;Filter run failed&quot;), nullptr);</span>
<a href="#l3.93"></a><span id="l3.93">   }</span>
<a href="#l3.94"></a><span id="l3.94">   return rv;</span>
<a href="#l3.95"></a><span id="l3.95"> }</span>
<a href="#l3.96"></a><span id="l3.96"> </span>
<a href="#l3.97"></a><span id="l3.97"> NS_IMETHODIMP</span>
<a href="#l3.98"></a><span id="l3.98"> nsMsgFilterList::SetDefaultFile(nsIFile *aFile) {</span>
<a href="#l3.99"></a><span id="l3.99">   m_defaultFile = aFile;</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineat">@@ -1196,20 +1202,20 @@ NS_IMETHODIMP nsMsgFilterList::LogFilter</span>
<a href="#l3.101"></a><span id="l3.101">   nsAppendEscapedHTML(NS_ConvertUTF16toUTF8(tempMessage), escapedBuffer);</span>
<a href="#l3.102"></a><span id="l3.102"> </span>
<a href="#l3.103"></a><span id="l3.103">   // Print timestamp and the message.</span>
<a href="#l3.104"></a><span id="l3.104">   AutoTArray&lt;nsString, 2&gt; logFormatStrings = {dateValue};</span>
<a href="#l3.105"></a><span id="l3.105">   CopyUTF8toUTF16(escapedBuffer, *logFormatStrings.AppendElement());</span>
<a href="#l3.106"></a><span id="l3.106">   nsString filterLogMessage;</span>
<a href="#l3.107"></a><span id="l3.107">   rv = bundle-&gt;FormatStringFromName(&quot;filterLogLine&quot;, logFormatStrings,</span>
<a href="#l3.108"></a><span id="l3.108">                                     filterLogMessage);</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.110"></a><span id="l3.110"> </span>
<a href="#l3.111"></a><span id="l3.111">   // Write message into log stream.</span>
<a href="#l3.112"></a><span id="l3.112">   uint32_t writeCount;</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineminus">-</span>
<a href="#l3.114"></a><span id="l3.114">   rv = logStream-&gt;Write(LOG_ENTRY_START_TAG, LOG_ENTRY_START_TAG_LEN,</span>
<a href="#l3.115"></a><span id="l3.115">                         &amp;writeCount);</span>
<a href="#l3.116"></a><span id="l3.116">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.117"></a><span id="l3.117">   NS_ASSERTION(writeCount == LOG_ENTRY_START_TAG_LEN,</span>
<a href="#l3.118"></a><span id="l3.118">                &quot;failed to write out start log tag&quot;);</span>
<a href="#l3.119"></a><span id="l3.119"> </span>
<a href="#l3.120"></a><span id="l3.120">   NS_ConvertUTF16toUTF8 buffer(filterLogMessage);</span>
<a href="#l3.121"></a><span id="l3.121">   uint32_t escapedBufferLen = buffer.Length();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilterService.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilterService.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -70,36 +70,57 @@ LazyLogModule FILTERLOGMODULE(&quot;Filters&quot;)</span>
<a href="#l4.4"></a><span id="l4.4">     m_filters-&gt;LogFilterMessage(NS_LITERAL_STRING(_text), m_curFilter);     \</span>
<a href="#l4.5"></a><span id="l4.5">     NS_WARNING(_text);                                                      \</span>
<a href="#l4.6"></a><span id="l4.6">     mFinalResult = _rv;                                                     \</span>
<a href="#l4.7"></a><span id="l4.7">     if (m_msgWindow &amp;&amp; !ContinueExecutionPrompt()) return OnEndExecution(); \</span>
<a href="#l4.8"></a><span id="l4.8">     continue;                                                               \</span>
<a href="#l4.9"></a><span id="l4.9">   }</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11"> #define BREAK_IF_FALSE(_assertTrue, _text)                              \</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  if (!(_assertTrue)) {                                                 \</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  if (MOZ_UNLIKELY(!(_assertTrue))) {                                   \</span>
<a href="#l4.14"></a><span id="l4.14">     MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,                           \</span>
<a href="#l4.15"></a><span id="l4.15">             (&quot;(Post) Filter error: %s&quot;, _text));                        \</span>
<a href="#l4.16"></a><span id="l4.16">     m_filters-&gt;LogFilterMessage(NS_LITERAL_STRING(_text), m_curFilter); \</span>
<a href="#l4.17"></a><span id="l4.17">     NS_WARNING(_text);                                                  \</span>
<a href="#l4.18"></a><span id="l4.18">     mFinalResult = NS_ERROR_FAILURE;                                    \</span>
<a href="#l4.19"></a><span id="l4.19">     break;                                                              \</span>
<a href="#l4.20"></a><span id="l4.20">   }</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22"> #define CONTINUE_IF_FALSE(_assertTrue, _text)                               \</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-  if (!(_assertTrue)) {                                                     \</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+  if (MOZ_UNLIKELY(!(_assertTrue))) {                                       \</span>
<a href="#l4.25"></a><span id="l4.25">     MOZ_LOG(FILTERLOGMODULE, LogLevel::Warning,                             \</span>
<a href="#l4.26"></a><span id="l4.26">             (&quot;(Post) Filter problem: %s&quot;, _text));                          \</span>
<a href="#l4.27"></a><span id="l4.27">     m_filters-&gt;LogFilterMessage(NS_LITERAL_STRING(_text), m_curFilter);     \</span>
<a href="#l4.28"></a><span id="l4.28">     NS_WARNING(_text);                                                      \</span>
<a href="#l4.29"></a><span id="l4.29">     mFinalResult = NS_ERROR_FAILURE;                                        \</span>
<a href="#l4.30"></a><span id="l4.30">     if (m_msgWindow &amp;&amp; !ContinueExecutionPrompt()) return OnEndExecution(); \</span>
<a href="#l4.31"></a><span id="l4.31">     continue;                                                               \</span>
<a href="#l4.32"></a><span id="l4.32">   }</span>
<a href="#l4.33"></a><span id="l4.33"> </span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+#define BREAK_ACTION(_text)                                               \</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,                               \</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+          (&quot;(Post) Filter Error: %s&quot;, _text));                            \</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+  if (loggingEnabled)                                                     \</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+    m_filters-&gt;LogFilterMessage(NS_LITERAL_STRING(_text), m_curFilter);   \</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+  NS_WARNING(_text);                                                      \</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+  if (m_msgWindow &amp;&amp; !ContinueExecutionPrompt()) return OnEndExecution(); \</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+  break;</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+#define BREAK_ACTION_IF_FALSE(_assertTrue, _text) \</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+  if (MOZ_UNLIKELY(!(_assertTrue))) {             \</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+    finalResult = NS_ERROR_FAILURE;               \</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+    BREAK_ACTION(_text);                          \</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+  }</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+#define BREAK_ACTION_IF_FAILURE(_rv, _text) \</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+  if (NS_FAILED(_rv)) {                     \</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+    finalResult = _rv;                      \</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+    BREAK_ACTION(_text);                    \</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+  }</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+</span>
<a href="#l4.55"></a><span id="l4.55"> NS_IMPL_ISUPPORTS(nsMsgFilterService, nsIMsgFilterService)</span>
<a href="#l4.56"></a><span id="l4.56"> </span>
<a href="#l4.57"></a><span id="l4.57"> nsMsgFilterService::nsMsgFilterService() {</span>
<a href="#l4.58"></a><span id="l4.58">   MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;nsMsgFilterService&quot;));</span>
<a href="#l4.59"></a><span id="l4.59"> }</span>
<a href="#l4.60"></a><span id="l4.60"> </span>
<a href="#l4.61"></a><span id="l4.61"> nsMsgFilterService::~nsMsgFilterService() {</span>
<a href="#l4.62"></a><span id="l4.62">   MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;~nsMsgFilterService&quot;));</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineat">@@ -635,36 +656,51 @@ nsresult nsMsgFilterAfterTheFact::ApplyF</span>
<a href="#l4.64"></a><span id="l4.64"> </span>
<a href="#l4.65"></a><span id="l4.65">     nsCOMPtr&lt;nsIArray&gt; actionList;</span>
<a href="#l4.66"></a><span id="l4.66">     rv = m_curFilter-&gt;GetSortedActionList(getter_AddRefs(actionList));</span>
<a href="#l4.67"></a><span id="l4.67">     BREAK_IF_FAILURE(rv, &quot;Could not get action list for filter&quot;);</span>
<a href="#l4.68"></a><span id="l4.68"> </span>
<a href="#l4.69"></a><span id="l4.69">     uint32_t numActions;</span>
<a href="#l4.70"></a><span id="l4.70">     actionList-&gt;GetLength(&amp;numActions);</span>
<a href="#l4.71"></a><span id="l4.71"> </span>
<a href="#l4.72"></a><span id="l4.72" class="difflineminus">-    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineminus">-            (&quot;(Post) Applying filter actions to %&quot; PRIu32 &quot; matched messages&quot;,</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-             static_cast&lt;uint32_t&gt;(m_searchHits.Length())));</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+    if (m_nextAction == 0) {</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+      MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+              (&quot;(Post) Applying %&quot; PRIu32 &quot; filter actions to %&quot; PRIu32</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+               &quot; matched messages&quot;,</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+               numActions, static_cast&lt;uint32_t&gt;(m_searchHits.Length())));</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+    } else if (m_nextAction &lt; numActions) {</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+      MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+              (&quot;(Post) Applying remaining %&quot; PRIu32</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+               &quot; filter actions to %&quot; PRIu32 &quot; matched messages&quot;,</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+               numActions - m_nextAction,</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+               static_cast&lt;uint32_t&gt;(m_searchHits.Length())));</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+    }</span>
<a href="#l4.87"></a><span id="l4.87"> </span>
<a href="#l4.88"></a><span id="l4.88">     // We start from m_nextAction to allow us to continue applying actions</span>
<a href="#l4.89"></a><span id="l4.89">     // after the return from an async copy.</span>
<a href="#l4.90"></a><span id="l4.90">     while (m_nextAction &lt; numActions) {</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+      nsresult finalResult = NS_OK;</span>
<a href="#l4.92"></a><span id="l4.92">       nsCOMPtr&lt;nsIMsgRuleAction&gt; filterAction(</span>
<a href="#l4.93"></a><span id="l4.93">           do_QueryElementAt(actionList, m_nextAction++, &amp;rv));</span>
<a href="#l4.94"></a><span id="l4.94">       CONTINUE_IF_FAILURE(rv, &quot;actionList cannot QI element&quot;);</span>
<a href="#l4.95"></a><span id="l4.95"> </span>
<a href="#l4.96"></a><span id="l4.96">       nsMsgRuleActionType actionType;</span>
<a href="#l4.97"></a><span id="l4.97">       rv = filterAction-&gt;GetType(&amp;actionType);</span>
<a href="#l4.98"></a><span id="l4.98">       CONTINUE_IF_FAILURE(rv, &quot;Could not get type for filter action&quot;);</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+      MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+              (&quot;(Post) Running filter action at index %&quot; PRIu32</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+               &quot;, action type = %i&quot;,</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+               m_nextAction - 1, actionType));</span>
<a href="#l4.103"></a><span id="l4.103"> </span>
<a href="#l4.104"></a><span id="l4.104">       nsCString actionTargetFolderUri;</span>
<a href="#l4.105"></a><span id="l4.105">       if (actionType == nsMsgFilterAction::MoveToFolder ||</span>
<a href="#l4.106"></a><span id="l4.106">           actionType == nsMsgFilterAction::CopyToFolder) {</span>
<a href="#l4.107"></a><span id="l4.107">         rv = filterAction-&gt;GetTargetFolderUri(actionTargetFolderUri);</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineminus">-        CONTINUE_IF_FALSE(NS_SUCCEEDED(rv) &amp;&amp; !actionTargetFolderUri.IsEmpty(),</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+        CONTINUE_IF_FAILURE(rv, &quot;GetTargetFolderUri failed&quot;);</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+        CONTINUE_IF_FALSE(!actionTargetFolderUri.IsEmpty(),</span>
<a href="#l4.111"></a><span id="l4.111">                           &quot;actionTargetFolderUri is empty&quot;);</span>
<a href="#l4.112"></a><span id="l4.112">       }</span>
<a href="#l4.113"></a><span id="l4.113"> </span>
<a href="#l4.114"></a><span id="l4.114">       if (loggingEnabled) {</span>
<a href="#l4.115"></a><span id="l4.115">         for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length();</span>
<a href="#l4.116"></a><span id="l4.116">              msgIndex++) {</span>
<a href="#l4.117"></a><span id="l4.117">           nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr =</span>
<a href="#l4.118"></a><span id="l4.118">               do_QueryElementAt(m_searchHitHdrs, msgIndex);</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineat">@@ -683,18 +719,19 @@ nsresult nsMsgFilterAfterTheFact::ApplyF</span>
<a href="#l4.120"></a><span id="l4.120">         case nsMsgFilterAction::Delete:</span>
<a href="#l4.121"></a><span id="l4.121">           // we can't pass ourselves in as a copy service listener because the</span>
<a href="#l4.122"></a><span id="l4.122">           // copy service listener won't get called in several situations (e.g.,</span>
<a href="#l4.123"></a><span id="l4.123">           // the delete model is imap delete) and we rely on the listener</span>
<a href="#l4.124"></a><span id="l4.124">           // getting called to continue the filter application. This means we're</span>
<a href="#l4.125"></a><span id="l4.125">           // going to end up firing off the delete, and then subsequently</span>
<a href="#l4.126"></a><span id="l4.126">           // issuing a search for the next filter, which will block until the</span>
<a href="#l4.127"></a><span id="l4.127">           // delete finishes.</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineminus">-          curFolder-&gt;DeleteMessages(m_searchHitHdrs, m_msgWindow, false, false,</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineminus">-                                    nullptr, false /*allow Undo*/);</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+          rv = curFolder-&gt;DeleteMessages(m_searchHitHdrs, m_msgWindow, false,</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+                                         false, nullptr, false /*allow Undo*/);</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+          BREAK_ACTION_IF_FAILURE(rv, &quot;Deleting messages failed&quot;);</span>
<a href="#l4.133"></a><span id="l4.133"> </span>
<a href="#l4.134"></a><span id="l4.134">           // don't allow any more filters on this message</span>
<a href="#l4.135"></a><span id="l4.135">           m_stopFiltering.AppendElements(m_searchHits);</span>
<a href="#l4.136"></a><span id="l4.136">           for (uint32_t i = 0; i &lt; m_searchHits.Length(); i++)</span>
<a href="#l4.137"></a><span id="l4.137">             curFolder-&gt;OrProcessingFlags(m_searchHits[i],</span>
<a href="#l4.138"></a><span id="l4.138">                                          nsMsgProcessingFlags::FilterToMove);</span>
<a href="#l4.139"></a><span id="l4.139">           // if we are deleting then we couldn't care less about applying</span>
<a href="#l4.140"></a><span id="l4.140">           // remaining filter actions</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineat">@@ -705,281 +742,327 @@ nsresult nsMsgFilterAfterTheFact::ApplyF</span>
<a href="#l4.142"></a><span id="l4.142">           // Even if move fails we will not run additional actions, as they</span>
<a href="#l4.143"></a><span id="l4.143">           // would not have run if move succeeded.</span>
<a href="#l4.144"></a><span id="l4.144">           m_nextAction = numActions;</span>
<a href="#l4.145"></a><span id="l4.145">           // Fall through to the copy case.</span>
<a href="#l4.146"></a><span id="l4.146">           MOZ_FALLTHROUGH;</span>
<a href="#l4.147"></a><span id="l4.147">         case nsMsgFilterAction::CopyToFolder: {</span>
<a href="#l4.148"></a><span id="l4.148">           nsCString uri;</span>
<a href="#l4.149"></a><span id="l4.149">           curFolder-&gt;GetURI(uri);</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineminus">-          if (!actionTargetFolderUri.IsEmpty() &amp;&amp;</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineminus">-              !uri.Equals(actionTargetFolderUri)) {</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineminus">-            nsCOMPtr&lt;nsIMsgFolder&gt; destIFolder;</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineminus">-            rv = GetOrCreateFolder(actionTargetFolderUri,</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineminus">-                                   getter_AddRefs(destIFolder));</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineminus">-            CONTINUE_IF_FAILURE(rv, &quot;Could not get action folder&quot;);</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+          BREAK_ACTION_IF_FALSE(!uri.Equals(actionTargetFolderUri),</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+                                &quot;Target folder is the same as source folder&quot;);</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineplus">+</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineplus">+          nsCOMPtr&lt;nsIMsgFolder&gt; destIFolder;</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+          rv = GetOrCreateFolder(actionTargetFolderUri,</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+                                 getter_AddRefs(destIFolder));</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineplus">+          BREAK_ACTION_IF_FAILURE(rv, &quot;Could not get action folder&quot;);</span>
<a href="#l4.163"></a><span id="l4.163"> </span>
<a href="#l4.164"></a><span id="l4.164" class="difflineminus">-            bool canFileMessages = true;</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineminus">-            nsCOMPtr&lt;nsIMsgFolder&gt; parentFolder;</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineminus">-            destIFolder-&gt;GetParent(getter_AddRefs(parentFolder));</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineminus">-            if (parentFolder) destIFolder-&gt;GetCanFileMessages(&amp;canFileMessages);</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineminus">-            if (!parentFolder || !canFileMessages) {</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineminus">-              m_curFilter-&gt;SetEnabled(false);</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineminus">-              destIFolder-&gt;ThrowAlertMsg(&quot;filterDisabled&quot;, m_msgWindow);</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineminus">-              // we need to explicitly save the filter file.</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineminus">-              m_filters-&gt;SaveToDefaultFile();</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineminus">-              // In the case of applying multiple filters</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineminus">-              // we might want to remove the filter from the list, but</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineminus">-              // that's a bit evil since we really don't know that we own</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineminus">-              // the list. Disabling it doesn't do a lot of good since</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineminus">-              // we still apply disabled filters. Currently, we don't</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineminus">-              // have any clients that apply filters to multiple folders,</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineminus">-              // so this might be the edge case of an edge case.</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineminus">-              m_nextAction = numActions;</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineminus">-              mFinalResult = NS_ERROR_FAILURE;</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineminus">-              break;</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineminus">-            }</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineminus">-            nsCOMPtr&lt;nsIMsgCopyService&gt; copyService =</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineminus">-                do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineminus">-            CONTINUE_IF_FAILURE(rv, &quot;Could not get copy service&quot;)</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineplus">+          bool canFileMessages = true;</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+          nsCOMPtr&lt;nsIMsgFolder&gt; parentFolder;</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+          destIFolder-&gt;GetParent(getter_AddRefs(parentFolder));</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+          if (parentFolder) destIFolder-&gt;GetCanFileMessages(&amp;canFileMessages);</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineplus">+          if (!parentFolder || !canFileMessages) {</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineplus">+            m_curFilter-&gt;SetEnabled(false);</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+            destIFolder-&gt;ThrowAlertMsg(&quot;filterDisabled&quot;, m_msgWindow);</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineplus">+            // we need to explicitly save the filter file.</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+            m_filters-&gt;SaveToDefaultFile();</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineplus">+            // In the case of applying multiple filters</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+            // we might want to remove the filter from the list, but</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineplus">+            // that's a bit evil since we really don't know that we own</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineplus">+            // the list. Disabling it doesn't do a lot of good since</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineplus">+            // we still apply disabled filters. Currently, we don't</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineplus">+            // have any clients that apply filters to multiple folders,</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+            // so this might be the edge case of an edge case.</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineplus">+            m_nextAction = numActions;</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineplus">+            BREAK_ACTION_IF_FALSE(false,</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineplus">+                                  &quot;No parent folder or folder can't file &quot;</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineplus">+                                  &quot;messages, disabling the filter&quot;);</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineplus">+          }</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineplus">+          nsCOMPtr&lt;nsIMsgCopyService&gt; copyService =</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineplus">+              do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineplus">+          BREAK_ACTION_IF_FAILURE(rv, &quot;Could not get copy service&quot;);</span>
<a href="#l4.211"></a><span id="l4.211"> </span>
<a href="#l4.212"></a><span id="l4.212" class="difflineminus">-            if (actionType == nsMsgFilterAction::MoveToFolder) {</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineminus">-              m_stopFiltering.AppendElements(m_searchHits);</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineminus">-              for (uint32_t i = 0; i &lt; m_searchHits.Length(); i++)</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineminus">-                curFolder-&gt;OrProcessingFlags(</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineminus">-                    m_searchHits[i], nsMsgProcessingFlags::FilterToMove);</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineminus">-            }</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineplus">+          if (actionType == nsMsgFilterAction::MoveToFolder) {</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineplus">+            m_stopFiltering.AppendElements(m_searchHits);</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineplus">+            for (uint32_t i = 0; i &lt; m_searchHits.Length(); i++)</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineplus">+              curFolder-&gt;OrProcessingFlags(m_searchHits[i],</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineplus">+                                           nsMsgProcessingFlags::FilterToMove);</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineplus">+          }</span>
<a href="#l4.224"></a><span id="l4.224"> </span>
<a href="#l4.225"></a><span id="l4.225" class="difflineminus">-            rv = copyService-&gt;CopyMessages(</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineminus">-                curFolder, m_searchHitHdrs, destIFolder,</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineminus">-                actionType == nsMsgFilterAction::MoveToFolder, this,</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineminus">-                m_msgWindow, false);</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineminus">-            CONTINUE_IF_FAILURE(rv, &quot;CopyMessages failed&quot;);</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineminus">-            return NS_OK;  // OnStopCopy callback to continue;</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineminus">-          } else</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineminus">-            NS_WARNING(&quot;Move or copy failed, empty or unchanged destination&quot;);</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineplus">+          rv = copyService-&gt;CopyMessages(</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineplus">+              curFolder, m_searchHitHdrs, destIFolder,</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineplus">+              actionType == nsMsgFilterAction::MoveToFolder, this, m_msgWindow,</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineplus">+              false);</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineplus">+          BREAK_ACTION_IF_FAILURE(rv, &quot;CopyMessages failed&quot;);</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineplus">+          MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineplus">+                  (&quot;(Post) Action execution continues async&quot;));</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineplus">+          return NS_OK;  // OnStopCopy callback to continue;</span>
<a href="#l4.241"></a><span id="l4.241">         } break;</span>
<a href="#l4.242"></a><span id="l4.242">         case nsMsgFilterAction::MarkRead:</span>
<a href="#l4.243"></a><span id="l4.243">           // crud, no listener support here - we'll probably just need to go on</span>
<a href="#l4.244"></a><span id="l4.244">           // and apply the next filter, and, in the imap case, rely on multiple</span>
<a href="#l4.245"></a><span id="l4.245">           // connection and url queueing to stay out of trouble</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineminus">-          curFolder-&gt;MarkMessagesRead(m_searchHitHdrs, true);</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineplus">+          rv = curFolder-&gt;MarkMessagesRead(m_searchHitHdrs, true);</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineplus">+          BREAK_ACTION_IF_FAILURE(rv, &quot;Setting message flags failed&quot;);</span>
<a href="#l4.249"></a><span id="l4.249">           break;</span>
<a href="#l4.250"></a><span id="l4.250">         case nsMsgFilterAction::MarkUnread:</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineminus">-          curFolder-&gt;MarkMessagesRead(m_searchHitHdrs, false);</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineplus">+          rv = curFolder-&gt;MarkMessagesRead(m_searchHitHdrs, false);</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineplus">+          BREAK_ACTION_IF_FAILURE(rv, &quot;Setting message flags failed&quot;);</span>
<a href="#l4.254"></a><span id="l4.254">           break;</span>
<a href="#l4.255"></a><span id="l4.255">         case nsMsgFilterAction::MarkFlagged:</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineminus">-          curFolder-&gt;MarkMessagesFlagged(m_searchHitHdrs, true);</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineplus">+          rv = curFolder-&gt;MarkMessagesFlagged(m_searchHitHdrs, true);</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineplus">+          BREAK_ACTION_IF_FAILURE(rv, &quot;Setting message flags failed&quot;);</span>
<a href="#l4.259"></a><span id="l4.259">           break;</span>
<a href="#l4.260"></a><span id="l4.260">         case nsMsgFilterAction::KillThread:</span>
<a href="#l4.261"></a><span id="l4.261">         case nsMsgFilterAction::WatchThread: {</span>
<a href="#l4.262"></a><span id="l4.262">           for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length();</span>
<a href="#l4.263"></a><span id="l4.263">                msgIndex++) {</span>
<a href="#l4.264"></a><span id="l4.264">             nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr =</span>
<a href="#l4.265"></a><span id="l4.265">                 do_QueryElementAt(m_searchHitHdrs, msgIndex);</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineminus">-            CONTINUE_IF_FALSE(msgHdr, &quot;Could not get msg header&quot;);</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineplus">+            BREAK_ACTION_IF_FALSE(msgHdr, &quot;Could not get msg header&quot;);</span>
<a href="#l4.268"></a><span id="l4.268"> </span>
<a href="#l4.269"></a><span id="l4.269">             nsCOMPtr&lt;nsIMsgThread&gt; msgThread;</span>
<a href="#l4.270"></a><span id="l4.270">             nsMsgKey threadKey;</span>
<a href="#l4.271"></a><span id="l4.271">             m_curFolderDB-&gt;GetThreadContainingMsgHdr(msgHdr,</span>
<a href="#l4.272"></a><span id="l4.272">                                                      getter_AddRefs(msgThread));</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineminus">-            CONTINUE_IF_FALSE(msgThread, &quot;Could not find msg thread&quot;);</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineplus">+            BREAK_ACTION_IF_FALSE(msgThread, &quot;Could not find msg thread&quot;);</span>
<a href="#l4.275"></a><span id="l4.275">             msgThread-&gt;GetThreadKey(&amp;threadKey);</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineminus">-            if (actionType == nsMsgFilterAction::KillThread)</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineminus">-              m_curFolderDB-&gt;MarkThreadIgnored(msgThread, threadKey, true,</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineminus">-                                               nullptr);</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineminus">-            else</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineminus">-              m_curFolderDB-&gt;MarkThreadWatched(msgThread, threadKey, true,</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineminus">-                                               nullptr);</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineplus">+            if (actionType == nsMsgFilterAction::KillThread) {</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineplus">+              rv = m_curFolderDB-&gt;MarkThreadIgnored(msgThread, threadKey, true,</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineplus">+                                                    nullptr);</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineplus">+              BREAK_ACTION_IF_FAILURE(rv, &quot;Setting message flags failed&quot;);</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineplus">+            } else {</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineplus">+              rv = m_curFolderDB-&gt;MarkThreadWatched(msgThread, threadKey, true,</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineplus">+                                                    nullptr);</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineplus">+              BREAK_ACTION_IF_FAILURE(rv, &quot;Setting message flags failed&quot;);</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineplus">+            }</span>
<a href="#l4.291"></a><span id="l4.291">           }</span>
<a href="#l4.292"></a><span id="l4.292">         } break;</span>
<a href="#l4.293"></a><span id="l4.293">         case nsMsgFilterAction::KillSubthread: {</span>
<a href="#l4.294"></a><span id="l4.294">           for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length();</span>
<a href="#l4.295"></a><span id="l4.295">                msgIndex++) {</span>
<a href="#l4.296"></a><span id="l4.296">             nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr =</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineminus">-                do_QueryElementAt(m_searchHitHdrs, msgIndex);</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineminus">-            CONTINUE_IF_FALSE(msgHdr, &quot;Could not get msg header&quot;);</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineminus">-            m_curFolderDB-&gt;MarkHeaderKilled(msgHdr, true, nullptr);</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineplus">+                do_QueryElementAt(m_searchHitHdrs, msgIndex, &amp;rv);</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineplus">+            BREAK_ACTION_IF_FAILURE(rv, &quot;Could not get msg header&quot;);</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineplus">+            BREAK_ACTION_IF_FALSE(msgHdr, &quot;Could not get msg header&quot;);</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineplus">+            rv = m_curFolderDB-&gt;MarkHeaderKilled(msgHdr, true, nullptr);</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineplus">+            BREAK_ACTION_IF_FAILURE(rv, &quot;Setting message flags failed&quot;);</span>
<a href="#l4.305"></a><span id="l4.305">           }</span>
<a href="#l4.306"></a><span id="l4.306">         } break;</span>
<a href="#l4.307"></a><span id="l4.307">         case nsMsgFilterAction::ChangePriority: {</span>
<a href="#l4.308"></a><span id="l4.308">           nsMsgPriorityValue filterPriority;</span>
<a href="#l4.309"></a><span id="l4.309">           filterAction-&gt;GetPriority(&amp;filterPriority);</span>
<a href="#l4.310"></a><span id="l4.310">           for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length();</span>
<a href="#l4.311"></a><span id="l4.311">                msgIndex++) {</span>
<a href="#l4.312"></a><span id="l4.312">             nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr =</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineminus">-                do_QueryElementAt(m_searchHitHdrs, msgIndex);</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineminus">-            CONTINUE_IF_FALSE(msgHdr, &quot;Could not get msg header&quot;);</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineminus">-            msgHdr-&gt;SetPriority(filterPriority);</span>
<a href="#l4.316"></a><span id="l4.316" class="difflineplus">+                do_QueryElementAt(m_searchHitHdrs, msgIndex, &amp;rv);</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineplus">+            BREAK_ACTION_IF_FAILURE(rv, &quot;Could not get msg header&quot;);</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineplus">+            BREAK_ACTION_IF_FALSE(msgHdr, &quot;Could not get msg header&quot;);</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineplus">+            rv = msgHdr-&gt;SetPriority(filterPriority);</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineplus">+            BREAK_ACTION_IF_FAILURE(rv, &quot;Setting message flags failed&quot;);</span>
<a href="#l4.321"></a><span id="l4.321">           }</span>
<a href="#l4.322"></a><span id="l4.322">         } break;</span>
<a href="#l4.323"></a><span id="l4.323">         case nsMsgFilterAction::Label: {</span>
<a href="#l4.324"></a><span id="l4.324">           nsMsgLabelValue filterLabel;</span>
<a href="#l4.325"></a><span id="l4.325">           filterAction-&gt;GetLabel(&amp;filterLabel);</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineminus">-          curFolder-&gt;SetLabelForMessages(m_searchHitHdrs, filterLabel);</span>
<a href="#l4.327"></a><span id="l4.327" class="difflineplus">+          rv = curFolder-&gt;SetLabelForMessages(m_searchHitHdrs, filterLabel);</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineplus">+          BREAK_ACTION_IF_FAILURE(rv, &quot;Setting message flags failed&quot;);</span>
<a href="#l4.329"></a><span id="l4.329">         } break;</span>
<a href="#l4.330"></a><span id="l4.330">         case nsMsgFilterAction::AddTag: {</span>
<a href="#l4.331"></a><span id="l4.331">           nsCString keyword;</span>
<a href="#l4.332"></a><span id="l4.332">           filterAction-&gt;GetStrValue(keyword);</span>
<a href="#l4.333"></a><span id="l4.333" class="difflineminus">-          curFolder-&gt;AddKeywordsToMessages(m_searchHitHdrs, keyword);</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineplus">+          rv = curFolder-&gt;AddKeywordsToMessages(m_searchHitHdrs, keyword);</span>
<a href="#l4.335"></a><span id="l4.335" class="difflineplus">+          BREAK_ACTION_IF_FAILURE(rv, &quot;Setting message flags failed&quot;);</span>
<a href="#l4.336"></a><span id="l4.336">         } break;</span>
<a href="#l4.337"></a><span id="l4.337">         case nsMsgFilterAction::JunkScore: {</span>
<a href="#l4.338"></a><span id="l4.338">           nsAutoCString junkScoreStr;</span>
<a href="#l4.339"></a><span id="l4.339">           int32_t junkScore;</span>
<a href="#l4.340"></a><span id="l4.340">           filterAction-&gt;GetJunkScore(&amp;junkScore);</span>
<a href="#l4.341"></a><span id="l4.341">           junkScoreStr.AppendInt(junkScore);</span>
<a href="#l4.342"></a><span id="l4.342" class="difflineminus">-          curFolder-&gt;SetJunkScoreForMessages(m_searchHitHdrs, junkScoreStr);</span>
<a href="#l4.343"></a><span id="l4.343" class="difflineplus">+          rv =</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineplus">+              curFolder-&gt;SetJunkScoreForMessages(m_searchHitHdrs, junkScoreStr);</span>
<a href="#l4.345"></a><span id="l4.345" class="difflineplus">+          BREAK_ACTION_IF_FAILURE(rv, &quot;Setting message flags failed&quot;);</span>
<a href="#l4.346"></a><span id="l4.346">         } break;</span>
<a href="#l4.347"></a><span id="l4.347">         case nsMsgFilterAction::Forward: {</span>
<a href="#l4.348"></a><span id="l4.348">           nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l4.349"></a><span id="l4.349">           rv = curFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineminus">-          CONTINUE_IF_FAILURE(rv, &quot;Could not get server&quot;);</span>
<a href="#l4.351"></a><span id="l4.351" class="difflineplus">+          BREAK_ACTION_IF_FAILURE(rv, &quot;Could not get server&quot;);</span>
<a href="#l4.352"></a><span id="l4.352">           nsCString forwardTo;</span>
<a href="#l4.353"></a><span id="l4.353">           filterAction-&gt;GetStrValue(forwardTo);</span>
<a href="#l4.354"></a><span id="l4.354" class="difflineminus">-          CONTINUE_IF_FALSE(!forwardTo.IsEmpty(), &quot;blank forwardTo URI&quot;);</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineplus">+          BREAK_ACTION_IF_FALSE(!forwardTo.IsEmpty(), &quot;blank forwardTo URI&quot;);</span>
<a href="#l4.356"></a><span id="l4.356">           nsCOMPtr&lt;nsIMsgComposeService&gt; compService =</span>
<a href="#l4.357"></a><span id="l4.357">               do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineminus">-          CONTINUE_IF_FAILURE(rv, &quot;Could not get compose service&quot;);</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineplus">+          BREAK_ACTION_IF_FAILURE(rv, &quot;Could not get compose service&quot;);</span>
<a href="#l4.360"></a><span id="l4.360"> </span>
<a href="#l4.361"></a><span id="l4.361">           for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length();</span>
<a href="#l4.362"></a><span id="l4.362">                msgIndex++) {</span>
<a href="#l4.363"></a><span id="l4.363">             nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr(</span>
<a href="#l4.364"></a><span id="l4.364">                 do_QueryElementAt(m_searchHitHdrs, msgIndex));</span>
<a href="#l4.365"></a><span id="l4.365">             if (msgHdr)</span>
<a href="#l4.366"></a><span id="l4.366">               rv = compService-&gt;ForwardMessage(</span>
<a href="#l4.367"></a><span id="l4.367">                   NS_ConvertASCIItoUTF16(forwardTo), msgHdr, m_msgWindow,</span>
<a href="#l4.368"></a><span id="l4.368">                   server, nsIMsgComposeService::kForwardAsDefault);</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineminus">-            CONTINUE_IF_FALSE(msgHdr &amp;&amp; NS_SUCCEEDED(rv),</span>
<a href="#l4.370"></a><span id="l4.370" class="difflineminus">-                              &quot;Forward action failed&quot;);</span>
<a href="#l4.371"></a><span id="l4.371" class="difflineplus">+            BREAK_ACTION_IF_FAILURE(rv, &quot;Forward action failed&quot;);</span>
<a href="#l4.372"></a><span id="l4.372" class="difflineplus">+            BREAK_ACTION_IF_FALSE(msgHdr, &quot;Forward action failed&quot;);</span>
<a href="#l4.373"></a><span id="l4.373">           }</span>
<a href="#l4.374"></a><span id="l4.374">         } break;</span>
<a href="#l4.375"></a><span id="l4.375">         case nsMsgFilterAction::Reply: {</span>
<a href="#l4.376"></a><span id="l4.376">           nsCString replyTemplateUri;</span>
<a href="#l4.377"></a><span id="l4.377">           filterAction-&gt;GetStrValue(replyTemplateUri);</span>
<a href="#l4.378"></a><span id="l4.378" class="difflineminus">-          CONTINUE_IF_FALSE(!replyTemplateUri.IsEmpty(),</span>
<a href="#l4.379"></a><span id="l4.379" class="difflineminus">-                            &quot;Empty reply template URI&quot;);</span>
<a href="#l4.380"></a><span id="l4.380" class="difflineplus">+          BREAK_ACTION_IF_FALSE(!replyTemplateUri.IsEmpty(),</span>
<a href="#l4.381"></a><span id="l4.381" class="difflineplus">+                                &quot;Empty reply template URI&quot;);</span>
<a href="#l4.382"></a><span id="l4.382"> </span>
<a href="#l4.383"></a><span id="l4.383">           nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l4.384"></a><span id="l4.384">           rv = curFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l4.385"></a><span id="l4.385" class="difflineminus">-          CONTINUE_IF_FAILURE(rv, &quot;Could not get server&quot;);</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineplus">+          BREAK_ACTION_IF_FAILURE(rv, &quot;Could not get server&quot;);</span>
<a href="#l4.387"></a><span id="l4.387"> </span>
<a href="#l4.388"></a><span id="l4.388">           nsCOMPtr&lt;nsIMsgComposeService&gt; compService =</span>
<a href="#l4.389"></a><span id="l4.389">               do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l4.390"></a><span id="l4.390" class="difflineminus">-          CONTINUE_IF_FAILURE(rv, &quot;Could not get compose service&quot;);</span>
<a href="#l4.391"></a><span id="l4.391" class="difflineplus">+          BREAK_ACTION_IF_FAILURE(rv, &quot;Could not get compose service&quot;);</span>
<a href="#l4.392"></a><span id="l4.392">           for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length();</span>
<a href="#l4.393"></a><span id="l4.393">                msgIndex++) {</span>
<a href="#l4.394"></a><span id="l4.394">             nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr =</span>
<a href="#l4.395"></a><span id="l4.395" class="difflineminus">-                do_QueryElementAt(m_searchHitHdrs, msgIndex);</span>
<a href="#l4.396"></a><span id="l4.396" class="difflineminus">-            CONTINUE_IF_FALSE(msgHdr, &quot;Could not get msgHdr&quot;);</span>
<a href="#l4.397"></a><span id="l4.397" class="difflineplus">+                do_QueryElementAt(m_searchHitHdrs, msgIndex, &amp;rv);</span>
<a href="#l4.398"></a><span id="l4.398" class="difflineplus">+            BREAK_ACTION_IF_FAILURE(rv, &quot;Could not get msgHdr&quot;);</span>
<a href="#l4.399"></a><span id="l4.399" class="difflineplus">+            BREAK_ACTION_IF_FALSE(msgHdr, &quot;Could not get msgHdr&quot;);</span>
<a href="#l4.400"></a><span id="l4.400">             rv = compService-&gt;ReplyWithTemplate(msgHdr, replyTemplateUri.get(),</span>
<a href="#l4.401"></a><span id="l4.401">                                                 m_msgWindow, server);</span>
<a href="#l4.402"></a><span id="l4.402">             if (NS_FAILED(rv)) {</span>
<a href="#l4.403"></a><span id="l4.403">               if (rv == NS_ERROR_ABORT) {</span>
<a href="#l4.404"></a><span id="l4.404">                 (void)m_curFilter-&gt;LogRuleHitFail(</span>
<a href="#l4.405"></a><span id="l4.405">                     filterAction, msgHdr, rv,</span>
<a href="#l4.406"></a><span id="l4.406">                     NS_LITERAL_CSTRING(&quot;filterFailureSendingReplyAborted&quot;));</span>
<a href="#l4.407"></a><span id="l4.407">               } else {</span>
<a href="#l4.408"></a><span id="l4.408">                 (void)m_curFilter-&gt;LogRuleHitFail(</span>
<a href="#l4.409"></a><span id="l4.409">                     filterAction, msgHdr, rv,</span>
<a href="#l4.410"></a><span id="l4.410">                     NS_LITERAL_CSTRING(&quot;filterFailureSendingReplyError&quot;));</span>
<a href="#l4.411"></a><span id="l4.411">               }</span>
<a href="#l4.412"></a><span id="l4.412">             }</span>
<a href="#l4.413"></a><span id="l4.413" class="difflineminus">-            CONTINUE_IF_FAILURE(rv, &quot;ReplyWithTemplate failed&quot;);</span>
<a href="#l4.414"></a><span id="l4.414" class="difflineplus">+            BREAK_ACTION_IF_FAILURE(rv, &quot;ReplyWithTemplate failed&quot;);</span>
<a href="#l4.415"></a><span id="l4.415">           }</span>
<a href="#l4.416"></a><span id="l4.416">         } break;</span>
<a href="#l4.417"></a><span id="l4.417">         case nsMsgFilterAction::DeleteFromPop3Server: {</span>
<a href="#l4.418"></a><span id="l4.418">           nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder =</span>
<a href="#l4.419"></a><span id="l4.419" class="difflineminus">-              do_QueryInterface(curFolder);</span>
<a href="#l4.420"></a><span id="l4.420" class="difflineminus">-          CONTINUE_IF_FALSE(localFolder, &quot;Current folder not a local folder&quot;);</span>
<a href="#l4.421"></a><span id="l4.421" class="difflineplus">+              do_QueryInterface(curFolder, &amp;rv);</span>
<a href="#l4.422"></a><span id="l4.422" class="difflineplus">+          BREAK_ACTION_IF_FAILURE(rv, &quot;Current folder not a local folder&quot;);</span>
<a href="#l4.423"></a><span id="l4.423" class="difflineplus">+          BREAK_ACTION_IF_FALSE(localFolder,</span>
<a href="#l4.424"></a><span id="l4.424" class="difflineplus">+                                &quot;Current folder not a local folder&quot;);</span>
<a href="#l4.425"></a><span id="l4.425">           // This action ignores the deleteMailLeftOnServer preference</span>
<a href="#l4.426"></a><span id="l4.426">           rv = localFolder-&gt;MarkMsgsOnPop3Server(m_searchHitHdrs,</span>
<a href="#l4.427"></a><span id="l4.427">                                                  POP3_FORCE_DEL);</span>
<a href="#l4.428"></a><span id="l4.428" class="difflineminus">-          CONTINUE_IF_FAILURE(rv, &quot;MarkMsgsOnPop3Server failed&quot;);</span>
<a href="#l4.429"></a><span id="l4.429" class="difflineplus">+          BREAK_ACTION_IF_FAILURE(rv, &quot;MarkMsgsOnPop3Server failed&quot;);</span>
<a href="#l4.430"></a><span id="l4.430"> </span>
<a href="#l4.431"></a><span id="l4.431">           nsCOMPtr&lt;nsIMutableArray&gt; partialMsgs;</span>
<a href="#l4.432"></a><span id="l4.432">           // Delete the partial headers. They're useless now</span>
<a href="#l4.433"></a><span id="l4.433">           //   that the server copy is being deleted.</span>
<a href="#l4.434"></a><span id="l4.434">           for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length();</span>
<a href="#l4.435"></a><span id="l4.435">                msgIndex++) {</span>
<a href="#l4.436"></a><span id="l4.436">             nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr =</span>
<a href="#l4.437"></a><span id="l4.437" class="difflineminus">-                do_QueryElementAt(m_searchHitHdrs, msgIndex);</span>
<a href="#l4.438"></a><span id="l4.438" class="difflineminus">-            CONTINUE_IF_FALSE(msgHdr, &quot;Could not get msgHdr&quot;);</span>
<a href="#l4.439"></a><span id="l4.439" class="difflineplus">+                do_QueryElementAt(m_searchHitHdrs, msgIndex, &amp;rv);</span>
<a href="#l4.440"></a><span id="l4.440" class="difflineplus">+            BREAK_ACTION_IF_FAILURE(rv, &quot;Could not get msgHdr&quot;);</span>
<a href="#l4.441"></a><span id="l4.441" class="difflineplus">+            BREAK_ACTION_IF_FALSE(msgHdr, &quot;Could not get msgHdr&quot;);</span>
<a href="#l4.442"></a><span id="l4.442">             uint32_t flags;</span>
<a href="#l4.443"></a><span id="l4.443">             msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l4.444"></a><span id="l4.444">             if (flags &amp; nsMsgMessageFlags::Partial) {</span>
<a href="#l4.445"></a><span id="l4.445" class="difflineminus">-              if (!partialMsgs)</span>
<a href="#l4.446"></a><span id="l4.446" class="difflineminus">-                partialMsgs = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l4.447"></a><span id="l4.447" class="difflineminus">-              CONTINUE_IF_FALSE(partialMsgs,</span>
<a href="#l4.448"></a><span id="l4.448" class="difflineminus">-                                &quot;Could not create partialMsgs array&quot;);</span>
<a href="#l4.449"></a><span id="l4.449" class="difflineplus">+              if (!partialMsgs) {</span>
<a href="#l4.450"></a><span id="l4.450" class="difflineplus">+                partialMsgs = do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l4.451"></a><span id="l4.451" class="difflineplus">+                BREAK_ACTION_IF_FALSE(partialMsgs,</span>
<a href="#l4.452"></a><span id="l4.452" class="difflineplus">+                                      &quot;Could not create partialMsgs array&quot;);</span>
<a href="#l4.453"></a><span id="l4.453" class="difflineplus">+              }</span>
<a href="#l4.454"></a><span id="l4.454">               partialMsgs-&gt;AppendElement(msgHdr);</span>
<a href="#l4.455"></a><span id="l4.455">               m_stopFiltering.AppendElement(m_searchHits[msgIndex]);</span>
<a href="#l4.456"></a><span id="l4.456">               curFolder-&gt;OrProcessingFlags(m_searchHits[msgIndex],</span>
<a href="#l4.457"></a><span id="l4.457">                                            nsMsgProcessingFlags::FilterToMove);</span>
<a href="#l4.458"></a><span id="l4.458">             }</span>
<a href="#l4.459"></a><span id="l4.459">           }</span>
<a href="#l4.460"></a><span id="l4.460">           if (partialMsgs) {</span>
<a href="#l4.461"></a><span id="l4.461" class="difflineminus">-            curFolder-&gt;DeleteMessages(partialMsgs, m_msgWindow, true, false,</span>
<a href="#l4.462"></a><span id="l4.462" class="difflineminus">-                                      nullptr, false);</span>
<a href="#l4.463"></a><span id="l4.463" class="difflineminus">-            CONTINUE_IF_FAILURE(rv, &quot;Delete messages failed&quot;);</span>
<a href="#l4.464"></a><span id="l4.464" class="difflineplus">+            rv = curFolder-&gt;DeleteMessages(partialMsgs, m_msgWindow, true,</span>
<a href="#l4.465"></a><span id="l4.465" class="difflineplus">+                                           false, nullptr, false);</span>
<a href="#l4.466"></a><span id="l4.466" class="difflineplus">+            BREAK_ACTION_IF_FAILURE(rv, &quot;Delete messages failed&quot;);</span>
<a href="#l4.467"></a><span id="l4.467">           }</span>
<a href="#l4.468"></a><span id="l4.468">         } break;</span>
<a href="#l4.469"></a><span id="l4.469">         case nsMsgFilterAction::FetchBodyFromPop3Server: {</span>
<a href="#l4.470"></a><span id="l4.470">           nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder =</span>
<a href="#l4.471"></a><span id="l4.471" class="difflineminus">-              do_QueryInterface(curFolder);</span>
<a href="#l4.472"></a><span id="l4.472" class="difflineminus">-          CONTINUE_IF_FALSE(localFolder, &quot;current folder not local&quot;);</span>
<a href="#l4.473"></a><span id="l4.473" class="difflineplus">+              do_QueryInterface(curFolder, &amp;rv);</span>
<a href="#l4.474"></a><span id="l4.474" class="difflineplus">+          BREAK_ACTION_IF_FAILURE(rv, &quot;current folder not local&quot;);</span>
<a href="#l4.475"></a><span id="l4.475" class="difflineplus">+          BREAK_ACTION_IF_FALSE(localFolder, &quot;current folder not local&quot;);</span>
<a href="#l4.476"></a><span id="l4.476">           nsCOMPtr&lt;nsIMutableArray&gt; messages(</span>
<a href="#l4.477"></a><span id="l4.477">               do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l4.478"></a><span id="l4.478" class="difflineminus">-          CONTINUE_IF_FAILURE(rv, &quot;Could not create messages array&quot;);</span>
<a href="#l4.479"></a><span id="l4.479" class="difflineplus">+          BREAK_ACTION_IF_FAILURE(rv, &quot;Could not create messages array&quot;);</span>
<a href="#l4.480"></a><span id="l4.480">           for (uint32_t msgIndex = 0; msgIndex &lt; m_searchHits.Length();</span>
<a href="#l4.481"></a><span id="l4.481">                msgIndex++) {</span>
<a href="#l4.482"></a><span id="l4.482">             nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr =</span>
<a href="#l4.483"></a><span id="l4.483" class="difflineminus">-                do_QueryElementAt(m_searchHitHdrs, msgIndex);</span>
<a href="#l4.484"></a><span id="l4.484" class="difflineminus">-            CONTINUE_IF_FALSE(msgHdr, &quot;Could not get msgHdr&quot;);</span>
<a href="#l4.485"></a><span id="l4.485" class="difflineplus">+                do_QueryElementAt(m_searchHitHdrs, msgIndex, &amp;rv);</span>
<a href="#l4.486"></a><span id="l4.486" class="difflineplus">+            BREAK_ACTION_IF_FAILURE(rv, &quot;Could not get msgHdr&quot;);</span>
<a href="#l4.487"></a><span id="l4.487" class="difflineplus">+            BREAK_ACTION_IF_FALSE(msgHdr, &quot;Could not get msgHdr&quot;);</span>
<a href="#l4.488"></a><span id="l4.488">             uint32_t flags = 0;</span>
<a href="#l4.489"></a><span id="l4.489">             msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l4.490"></a><span id="l4.490">             if (flags &amp; nsMsgMessageFlags::Partial)</span>
<a href="#l4.491"></a><span id="l4.491">               messages-&gt;AppendElement(msgHdr);</span>
<a href="#l4.492"></a><span id="l4.492">           }</span>
<a href="#l4.493"></a><span id="l4.493">           uint32_t msgsToFetch;</span>
<a href="#l4.494"></a><span id="l4.494">           messages-&gt;GetLength(&amp;msgsToFetch);</span>
<a href="#l4.495"></a><span id="l4.495">           if (msgsToFetch &gt; 0) {</span>
<a href="#l4.496"></a><span id="l4.496">             rv = curFolder-&gt;DownloadMessagesForOffline(messages, m_msgWindow);</span>
<a href="#l4.497"></a><span id="l4.497" class="difflineminus">-            CONTINUE_IF_FAILURE(rv, &quot;DownloadMessagesForOffline failed&quot;);</span>
<a href="#l4.498"></a><span id="l4.498" class="difflineplus">+            BREAK_ACTION_IF_FAILURE(rv, &quot;DownloadMessagesForOffline failed&quot;);</span>
<a href="#l4.499"></a><span id="l4.499">           }</span>
<a href="#l4.500"></a><span id="l4.500">         } break;</span>
<a href="#l4.501"></a><span id="l4.501"> </span>
<a href="#l4.502"></a><span id="l4.502">         case nsMsgFilterAction::StopExecution: {</span>
<a href="#l4.503"></a><span id="l4.503">           // don't apply any more filters</span>
<a href="#l4.504"></a><span id="l4.504">           m_stopFiltering.AppendElements(m_searchHits);</span>
<a href="#l4.505"></a><span id="l4.505">           m_nextAction = numActions;</span>
<a href="#l4.506"></a><span id="l4.506">         } break;</span>
<a href="#l4.507"></a><span id="l4.507"> </span>
<a href="#l4.508"></a><span id="l4.508">         case nsMsgFilterAction::Custom: {</span>
<a href="#l4.509"></a><span id="l4.509">           nsMsgFilterTypeType filterType;</span>
<a href="#l4.510"></a><span id="l4.510">           m_curFilter-&gt;GetFilterType(&amp;filterType);</span>
<a href="#l4.511"></a><span id="l4.511">           nsCOMPtr&lt;nsIMsgFilterCustomAction&gt; customAction;</span>
<a href="#l4.512"></a><span id="l4.512">           rv = filterAction-&gt;GetCustomAction(getter_AddRefs(customAction));</span>
<a href="#l4.513"></a><span id="l4.513" class="difflineminus">-          CONTINUE_IF_FAILURE(rv, &quot;Could not get custom action&quot;);</span>
<a href="#l4.514"></a><span id="l4.514" class="difflineplus">+          BREAK_ACTION_IF_FAILURE(rv, &quot;Could not get custom action&quot;);</span>
<a href="#l4.515"></a><span id="l4.515"> </span>
<a href="#l4.516"></a><span id="l4.516">           nsAutoCString value;</span>
<a href="#l4.517"></a><span id="l4.517" class="difflineminus">-          filterAction-&gt;GetStrValue(value);</span>
<a href="#l4.518"></a><span id="l4.518" class="difflineplus">+          rv = filterAction-&gt;GetStrValue(value);</span>
<a href="#l4.519"></a><span id="l4.519" class="difflineplus">+          BREAK_ACTION_IF_FAILURE(rv, &quot;Cound not get custom action value&quot;);</span>
<a href="#l4.520"></a><span id="l4.520">           bool isAsync = false;</span>
<a href="#l4.521"></a><span id="l4.521">           customAction-&gt;GetIsAsync(&amp;isAsync);</span>
<a href="#l4.522"></a><span id="l4.522">           rv = customAction-&gt;Apply(m_searchHitHdrs, value, this, filterType,</span>
<a href="#l4.523"></a><span id="l4.523">                                    m_msgWindow);</span>
<a href="#l4.524"></a><span id="l4.524" class="difflineminus">-          CONTINUE_IF_FAILURE(rv, &quot;custom action failed to apply&quot;);</span>
<a href="#l4.525"></a><span id="l4.525" class="difflineminus">-          if (isAsync)</span>
<a href="#l4.526"></a><span id="l4.526" class="difflineplus">+          BREAK_ACTION_IF_FAILURE(rv, &quot;custom action failed to apply&quot;);</span>
<a href="#l4.527"></a><span id="l4.527" class="difflineplus">+          if (isAsync) {</span>
<a href="#l4.528"></a><span id="l4.528" class="difflineplus">+            MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l4.529"></a><span id="l4.529" class="difflineplus">+                    (&quot;(Post) Action execution continues async&quot;));</span>
<a href="#l4.530"></a><span id="l4.530">             return NS_OK;  // custom action should call ApplyFilter on callback</span>
<a href="#l4.531"></a><span id="l4.531" class="difflineplus">+          }</span>
<a href="#l4.532"></a><span id="l4.532">         } break;</span>
<a href="#l4.533"></a><span id="l4.533"> </span>
<a href="#l4.534"></a><span id="l4.534">         default:</span>
<a href="#l4.535"></a><span id="l4.535" class="difflineminus">-          break;</span>
<a href="#l4.536"></a><span id="l4.536" class="difflineplus">+          NS_ERROR(&quot;unexpected filter action&quot;);</span>
<a href="#l4.537"></a><span id="l4.537" class="difflineplus">+          BREAK_ACTION_IF_FAILURE(NS_ERROR_UNEXPECTED,</span>
<a href="#l4.538"></a><span id="l4.538" class="difflineplus">+                                  &quot;Unexpected filter action&quot;);</span>
<a href="#l4.539"></a><span id="l4.539" class="difflineplus">+      }</span>
<a href="#l4.540"></a><span id="l4.540" class="difflineplus">+      if (NS_FAILED(finalResult)) {</span>
<a href="#l4.541"></a><span id="l4.541" class="difflineplus">+        mFinalResult = finalResult;</span>
<a href="#l4.542"></a><span id="l4.542" class="difflineplus">+        MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,</span>
<a href="#l4.543"></a><span id="l4.543" class="difflineplus">+                (&quot;(Post) Action execution failed with error: %&quot; PRIx32,</span>
<a href="#l4.544"></a><span id="l4.544" class="difflineplus">+                 static_cast&lt;uint32_t&gt;(mFinalResult)));</span>
<a href="#l4.545"></a><span id="l4.545" class="difflineplus">+        if (loggingEnabled) {</span>
<a href="#l4.546"></a><span id="l4.546" class="difflineplus">+          nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(m_searchHitHdrs, 0);</span>
<a href="#l4.547"></a><span id="l4.547" class="difflineplus">+          (void)m_curFilter-&gt;LogRuleHitFail(</span>
<a href="#l4.548"></a><span id="l4.548" class="difflineplus">+              filterAction, msgHdr, mFinalResult,</span>
<a href="#l4.549"></a><span id="l4.549" class="difflineplus">+              NS_LITERAL_CSTRING(&quot;filterActionFailed&quot;));</span>
<a href="#l4.550"></a><span id="l4.550" class="difflineplus">+        }</span>
<a href="#l4.551"></a><span id="l4.551" class="difflineplus">+      } else {</span>
<a href="#l4.552"></a><span id="l4.552" class="difflineplus">+        MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l4.553"></a><span id="l4.553" class="difflineplus">+                (&quot;(Post) Action execution succeeded&quot;));</span>
<a href="#l4.554"></a><span id="l4.554">       }</span>
<a href="#l4.555"></a><span id="l4.555">     }</span>
<a href="#l4.556"></a><span id="l4.556">   } while (false);  // end error management block</span>
<a href="#l4.557"></a><span id="l4.557" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l4.558"></a><span id="l4.558" class="difflineplus">+          (&quot;(Post) Finished executing actions&quot;));</span>
<a href="#l4.559"></a><span id="l4.559">   return RunNextFilter();</span>
<a href="#l4.560"></a><span id="l4.560"> }</span>
<a href="#l4.561"></a><span id="l4.561"> </span>
<a href="#l4.562"></a><span id="l4.562"> NS_IMETHODIMP nsMsgFilterService::GetTempFilterList(</span>
<a href="#l4.563"></a><span id="l4.563">     nsIMsgFolder *aFolder, nsIMsgFilterList **aFilterList) {</span>
<a href="#l4.564"></a><span id="l4.564">   NS_ENSURE_ARG_POINTER(aFilterList);</span>
<a href="#l4.565"></a><span id="l4.565"> </span>
<a href="#l4.566"></a><span id="l4.566">   nsMsgFilterList *filterList = new nsMsgFilterList;</span>
<a href="#l4.567"></a><span id="l4.567" class="difflineat">@@ -1319,17 +1402,26 @@ NS_IMETHODIMP nsMsgFilterAfterTheFact::S</span>
<a href="#l4.568"></a><span id="l4.568"> }</span>
<a href="#l4.569"></a><span id="l4.569"> </span>
<a href="#l4.570"></a><span id="l4.570"> NS_IMETHODIMP nsMsgFilterAfterTheFact::GetMessageId(nsACString &amp;messageId) {</span>
<a href="#l4.571"></a><span id="l4.571">   return NS_OK;</span>
<a href="#l4.572"></a><span id="l4.572"> }</span>
<a href="#l4.573"></a><span id="l4.573"> </span>
<a href="#l4.574"></a><span id="l4.574"> /* void OnStopCopy (in nsresult aStatus); */</span>
<a href="#l4.575"></a><span id="l4.575"> NS_IMETHODIMP nsMsgFilterAfterTheFact::OnStopCopy(nsresult aStatus) {</span>
<a href="#l4.576"></a><span id="l4.576" class="difflineminus">-  if (NS_SUCCEEDED(aStatus)) return ApplyFilter();</span>
<a href="#l4.577"></a><span id="l4.577" class="difflineplus">+  if (NS_SUCCEEDED(aStatus)) {</span>
<a href="#l4.578"></a><span id="l4.578" class="difflineplus">+    // clang-format off</span>
<a href="#l4.579"></a><span id="l4.579" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l4.580"></a><span id="l4.580" class="difflineplus">+            (&quot;(Post) Async message copy from filter action finished successfully&quot;));</span>
<a href="#l4.581"></a><span id="l4.581" class="difflineplus">+    // clang-format on</span>
<a href="#l4.582"></a><span id="l4.582" class="difflineplus">+    return ApplyFilter();</span>
<a href="#l4.583"></a><span id="l4.583" class="difflineplus">+  }</span>
<a href="#l4.584"></a><span id="l4.584" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,</span>
<a href="#l4.585"></a><span id="l4.585" class="difflineplus">+          (&quot;(Post) Async message copy from filter action failed (%&quot; PRIx32 &quot;)&quot;,</span>
<a href="#l4.586"></a><span id="l4.586" class="difflineplus">+           static_cast&lt;uint32_t&gt;(aStatus)));</span>
<a href="#l4.587"></a><span id="l4.587"> </span>
<a href="#l4.588"></a><span id="l4.588">   mFinalResult = aStatus;</span>
<a href="#l4.589"></a><span id="l4.589">   if (m_msgWindow &amp;&amp; !ContinueExecutionPrompt()) return OnEndExecution();</span>
<a href="#l4.590"></a><span id="l4.590"> </span>
<a href="#l4.591"></a><span id="l4.591">   // Copy failed, so run the next filter</span>
<a href="#l4.592"></a><span id="l4.592">   return RunNextFilter();</span>
<a href="#l4.593"></a><span id="l4.593"> }</span>
<a href="#l4.594"></a><span id="l4.594"> </span>
<a href="#l4.595"></a><span id="l4.595" class="difflineat">@@ -1347,16 +1439,20 @@ bool nsMsgFilterAfterTheFact::ContinueEx</span>
<a href="#l4.596"></a><span id="l4.596">   nsString formatString;</span>
<a href="#l4.597"></a><span id="l4.597">   nsString confirmText;</span>
<a href="#l4.598"></a><span id="l4.598">   AutoTArray&lt;nsString, 1&gt; formatStrings = {filterName};</span>
<a href="#l4.599"></a><span id="l4.599">   nsresult rv = bundle-&gt;FormatStringFromName(&quot;continueFilterExecution&quot;,</span>
<a href="#l4.600"></a><span id="l4.600">                                              formatStrings, confirmText);</span>
<a href="#l4.601"></a><span id="l4.601">   if (NS_FAILED(rv)) return false;</span>
<a href="#l4.602"></a><span id="l4.602">   bool returnVal = false;</span>
<a href="#l4.603"></a><span id="l4.603">   (void)DisplayConfirmationPrompt(m_msgWindow, confirmText.get(), &amp;returnVal);</span>
<a href="#l4.604"></a><span id="l4.604" class="difflineplus">+  if (!returnVal) {</span>
<a href="#l4.605"></a><span id="l4.605" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Warning,</span>
<a href="#l4.606"></a><span id="l4.606" class="difflineplus">+            (&quot;(Post) User aborted further filter execution on prompt&quot;));</span>
<a href="#l4.607"></a><span id="l4.607" class="difflineplus">+  }</span>
<a href="#l4.608"></a><span id="l4.608">   return returnVal;</span>
<a href="#l4.609"></a><span id="l4.609"> }</span>
<a href="#l4.610"></a><span id="l4.610"> </span>
<a href="#l4.611"></a><span id="l4.611"> nsresult nsMsgFilterAfterTheFact::DisplayConfirmationPrompt(</span>
<a href="#l4.612"></a><span id="l4.612">     nsIMsgWindow *msgWindow, const char16_t *confirmString, bool *confirmed) {</span>
<a href="#l4.613"></a><span id="l4.613">   if (msgWindow) {</span>
<a href="#l4.614"></a><span id="l4.614">     nsCOMPtr&lt;nsIDocShell&gt; docShell;</span>
<a href="#l4.615"></a><span id="l4.615">     msgWindow-&gt;GetRootDocShell(getter_AddRefs(docShell));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -3178,204 +3178,238 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l5.4"></a><span id="l5.4">   rv = filterActionList-&gt;GetLength(&amp;numActions);</span>
<a href="#l5.5"></a><span id="l5.5">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7">   nsCString msgId;</span>
<a href="#l5.8"></a><span id="l5.8">   msgHdr-&gt;GetMessageId(getter_Copies(msgId));</span>
<a href="#l5.9"></a><span id="l5.9">   nsMsgKey msgKey;</span>
<a href="#l5.10"></a><span id="l5.10">   msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l5.11"></a><span id="l5.11">   MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-          (&quot;(Imap) Applying filter actions on message with key %&quot; PRIu32,</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-           msgKeyToInt(msgKey)));</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+          (&quot;(Imap) Applying %&quot; PRIu32</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+           &quot; filter actions on message with key %&quot; PRIu32,</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+           numActions, msgKeyToInt(msgKey)));</span>
<a href="#l5.17"></a><span id="l5.17">   MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l5.18"></a><span id="l5.18">           (&quot;(Imap) Message ID: %s&quot;, msgId.get()));</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20">   bool loggingEnabled = false;</span>
<a href="#l5.21"></a><span id="l5.21">   if (m_filterList &amp;&amp; numActions)</span>
<a href="#l5.22"></a><span id="l5.22">     (void)m_filterList-&gt;GetLoggingEnabled(&amp;loggingEnabled);</span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24">   bool msgIsNew = true;</span>
<a href="#l5.25"></a><span id="l5.25"> </span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+  rv = GetDatabase();</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+  nsresult finalResult = NS_OK;  // result of all actions</span>
<a href="#l5.30"></a><span id="l5.30">   for (uint32_t actionIndex = 0; actionIndex &lt; numActions; actionIndex++) {</span>
<a href="#l5.31"></a><span id="l5.31">     nsCOMPtr&lt;nsIMsgRuleAction&gt; filterAction =</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-        do_QueryElementAt(filterActionList, actionIndex);</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-    if (NS_FAILED(rv) || !filterAction) continue;</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+        do_QueryElementAt(filterActionList, actionIndex, &amp;rv);</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+    if (NS_FAILED(rv) || !filterAction) {</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+      MOZ_LOG(FILTERLOGMODULE, LogLevel::Warning,</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+              (&quot;(Imap) Filter action at index %&quot; PRIu32 &quot; invalid, skipping&quot;,</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+               actionIndex));</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+      continue;</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+    }</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+    rv = NS_OK;  // result of the current action</span>
<a href="#l5.44"></a><span id="l5.44">     nsMsgRuleActionType actionType;</span>
<a href="#l5.45"></a><span id="l5.45">     if (NS_SUCCEEDED(filterAction-&gt;GetType(&amp;actionType))) {</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+      MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+              (&quot;(Imap) Running filter action at index %&quot; PRIu32</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+               &quot;, action type = %i&quot;,</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+               actionIndex, actionType));</span>
<a href="#l5.50"></a><span id="l5.50">       if (loggingEnabled) (void)filter-&gt;LogRuleHit(filterAction, msgHdr);</span>
<a href="#l5.51"></a><span id="l5.51"> </span>
<a href="#l5.52"></a><span id="l5.52">       nsCString actionTargetFolderUri;</span>
<a href="#l5.53"></a><span id="l5.53">       if (actionType == nsMsgFilterAction::MoveToFolder ||</span>
<a href="#l5.54"></a><span id="l5.54">           actionType == nsMsgFilterAction::CopyToFolder) {</span>
<a href="#l5.55"></a><span id="l5.55">         rv = filterAction-&gt;GetTargetFolderUri(actionTargetFolderUri);</span>
<a href="#l5.56"></a><span id="l5.56">         if (NS_FAILED(rv) || actionTargetFolderUri.IsEmpty()) {</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+          // clang-format off</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+          MOZ_LOG(FILTERLOGMODULE, LogLevel::Warning,</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+                  (&quot;(Imap) Target URI for Copy/Move action is empty, skipping&quot;));</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+          // clang-format on</span>
<a href="#l5.61"></a><span id="l5.61">           NS_ASSERTION(false, &quot;actionTargetFolderUri is empty&quot;);</span>
<a href="#l5.62"></a><span id="l5.62">           continue;</span>
<a href="#l5.63"></a><span id="l5.63">         }</span>
<a href="#l5.64"></a><span id="l5.64">       }</span>
<a href="#l5.65"></a><span id="l5.65"> </span>
<a href="#l5.66"></a><span id="l5.66">       uint32_t msgFlags;</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineminus">-      nsMsgKey msgKey;</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineminus">-      nsAutoCString trashNameVal;</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">-</span>
<a href="#l5.70"></a><span id="l5.70">       msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineminus">-      msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l5.72"></a><span id="l5.72">       bool isRead = (msgFlags &amp; nsMsgMessageFlags::Read);</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">-      nsresult rv = GetDatabase();</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+</span>
<a href="#l5.76"></a><span id="l5.76">       switch (actionType) {</span>
<a href="#l5.77"></a><span id="l5.77">         case nsMsgFilterAction::Delete: {</span>
<a href="#l5.78"></a><span id="l5.78">           if (deleteToTrash) {</span>
<a href="#l5.79"></a><span id="l5.79">             // set value to trash folder</span>
<a href="#l5.80"></a><span id="l5.80">             nsCOMPtr&lt;nsIMsgFolder&gt; mailTrash;</span>
<a href="#l5.81"></a><span id="l5.81">             rv = GetTrashFolder(getter_AddRefs(mailTrash));</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineminus">-            if (NS_SUCCEEDED(rv) &amp;&amp; mailTrash)</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+            if (NS_SUCCEEDED(rv) &amp;&amp; mailTrash) {</span>
<a href="#l5.84"></a><span id="l5.84">               rv = mailTrash-&gt;GetURI(actionTargetFolderUri);</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+              if (NS_FAILED(rv)) break;</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+            }</span>
<a href="#l5.87"></a><span id="l5.87">             // msgHdr-&gt;OrFlags(nsMsgMessageFlags::Read, &amp;newFlags);  // mark</span>
<a href="#l5.88"></a><span id="l5.88">             // read in trash.</span>
<a href="#l5.89"></a><span id="l5.89">           } else {</span>
<a href="#l5.90"></a><span id="l5.90">             mDatabase-&gt;MarkHdrRead(msgHdr, true, nullptr);</span>
<a href="#l5.91"></a><span id="l5.91">             mDatabase-&gt;MarkImapDeleted(msgKey, true, nullptr);</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineminus">-            StoreImapFlags(kImapMsgSeenFlag | kImapMsgDeletedFlag, true,</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineminus">-                           &amp;msgKey, 1, nullptr);</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineminus">-            m_msgMovedByFilter =</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineminus">-                true;  // this will prevent us from adding the header to the db.</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+            rv = StoreImapFlags(kImapMsgSeenFlag | kImapMsgDeletedFlag, true,</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+                                &amp;msgKey, 1, nullptr);</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+            if (NS_FAILED(rv)) break;</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+            // this will prevent us from adding the header to the db.</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+            m_msgMovedByFilter = true;</span>
<a href="#l5.101"></a><span id="l5.101">           }</span>
<a href="#l5.102"></a><span id="l5.102">           msgIsNew = false;</span>
<a href="#l5.103"></a><span id="l5.103">         }</span>
<a href="#l5.104"></a><span id="l5.104">           // note that delete falls through to move.</span>
<a href="#l5.105"></a><span id="l5.105">           MOZ_FALLTHROUGH;</span>
<a href="#l5.106"></a><span id="l5.106">         case nsMsgFilterAction::MoveToFolder: {</span>
<a href="#l5.107"></a><span id="l5.107">           // if moving to a different file, do it.</span>
<a href="#l5.108"></a><span id="l5.108">           nsCString uri;</span>
<a href="#l5.109"></a><span id="l5.109">           rv = GetURI(uri);</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+          if (NS_FAILED(rv)) break;</span>
<a href="#l5.111"></a><span id="l5.111"> </span>
<a href="#l5.112"></a><span id="l5.112">           if (!actionTargetFolderUri.Equals(uri)) {</span>
<a href="#l5.113"></a><span id="l5.113">             msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineminus">-</span>
<a href="#l5.115"></a><span id="l5.115">             if (msgFlags &amp; nsMsgMessageFlags::MDNReportNeeded &amp;&amp; !isRead) {</span>
<a href="#l5.116"></a><span id="l5.116">               mDatabase-&gt;MarkMDNNeeded(msgKey, false, nullptr);</span>
<a href="#l5.117"></a><span id="l5.117">               mDatabase-&gt;MarkMDNSent(msgKey, true, nullptr);</span>
<a href="#l5.118"></a><span id="l5.118">             }</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineminus">-            nsresult err = MoveIncorporatedMessage(</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+            nsresult rv = MoveIncorporatedMessage(</span>
<a href="#l5.121"></a><span id="l5.121">                 msgHdr, mDatabase, actionTargetFolderUri, filter, msgWindow);</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineminus">-            if (NS_SUCCEEDED(err)) m_msgMovedByFilter = true;</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+            if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+              m_msgMovedByFilter = true;</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+            } else {</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+              if (loggingEnabled) {</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+                (void)filter-&gt;LogRuleHitFail(</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+                    filterAction, msgHdr, rv,</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+                    NS_LITERAL_CSTRING(&quot;filterFailureMoveFailed&quot;));</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+              }</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+            }</span>
<a href="#l5.132"></a><span id="l5.132">           }</span>
<a href="#l5.133"></a><span id="l5.133">           // don't apply any more filters, even if it was a move to the same</span>
<a href="#l5.134"></a><span id="l5.134">           // folder</span>
<a href="#l5.135"></a><span id="l5.135">           *applyMore = false;</span>
<a href="#l5.136"></a><span id="l5.136">         } break;</span>
<a href="#l5.137"></a><span id="l5.137">         case nsMsgFilterAction::CopyToFolder: {</span>
<a href="#l5.138"></a><span id="l5.138">           nsCString uri;</span>
<a href="#l5.139"></a><span id="l5.139">           rv = GetURI(uri);</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineplus">+          if (NS_FAILED(rv)) break;</span>
<a href="#l5.141"></a><span id="l5.141"> </span>
<a href="#l5.142"></a><span id="l5.142">           if (!actionTargetFolderUri.Equals(uri)) {</span>
<a href="#l5.143"></a><span id="l5.143">             // XXXshaver I'm not actually 100% what the right semantics are for</span>
<a href="#l5.144"></a><span id="l5.144">             // MDNs and copied messages, but I suspect deep down inside that</span>
<a href="#l5.145"></a><span id="l5.145">             // we probably want to suppress them only on the copies.</span>
<a href="#l5.146"></a><span id="l5.146">             msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l5.147"></a><span id="l5.147">             if (msgFlags &amp; nsMsgMessageFlags::MDNReportNeeded &amp;&amp; !isRead) {</span>
<a href="#l5.148"></a><span id="l5.148">               mDatabase-&gt;MarkMDNNeeded(msgKey, false, nullptr);</span>
<a href="#l5.149"></a><span id="l5.149">               mDatabase-&gt;MarkMDNSent(msgKey, true, nullptr);</span>
<a href="#l5.150"></a><span id="l5.150">             }</span>
<a href="#l5.151"></a><span id="l5.151"> </span>
<a href="#l5.152"></a><span id="l5.152">             nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l5.153"></a><span id="l5.153">                 do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineminus">-            NS_ENSURE_TRUE(messageArray, rv);</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineplus">+            if (NS_FAILED(rv) || !messageArray) break;</span>
<a href="#l5.156"></a><span id="l5.156">             messageArray-&gt;AppendElement(msgHdr);</span>
<a href="#l5.157"></a><span id="l5.157"> </span>
<a href="#l5.158"></a><span id="l5.158">             nsCOMPtr&lt;nsIMsgFolder&gt; dstFolder;</span>
<a href="#l5.159"></a><span id="l5.159">             rv = GetExistingFolder(actionTargetFolderUri,</span>
<a href="#l5.160"></a><span id="l5.160">                                    getter_AddRefs(dstFolder));</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineplus">+            if (NS_FAILED(rv)) break;</span>
<a href="#l5.163"></a><span id="l5.163"> </span>
<a href="#l5.164"></a><span id="l5.164">             nsCOMPtr&lt;nsIMsgCopyService&gt; copyService =</span>
<a href="#l5.165"></a><span id="l5.165">                 do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineplus">+            if (NS_FAILED(rv)) break;</span>
<a href="#l5.168"></a><span id="l5.168">             rv = copyService-&gt;CopyMessages(this, messageArray, dstFolder, false,</span>
<a href="#l5.169"></a><span id="l5.169">                                            nullptr, msgWindow, false);</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineplus">+            if (NS_FAILED(rv)) {</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineplus">+              if (loggingEnabled) {</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineplus">+                (void)filter-&gt;LogRuleHitFail(</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineplus">+                    filterAction, msgHdr, rv,</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineplus">+                    NS_LITERAL_CSTRING(&quot;filterFailureCopyFailed&quot;));</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineplus">+              }</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineplus">+            }</span>
<a href="#l5.178"></a><span id="l5.178">           }</span>
<a href="#l5.179"></a><span id="l5.179">         } break;</span>
<a href="#l5.180"></a><span id="l5.180">         case nsMsgFilterAction::MarkRead: {</span>
<a href="#l5.181"></a><span id="l5.181">           mDatabase-&gt;MarkHdrRead(msgHdr, true, nullptr);</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineminus">-          StoreImapFlags(kImapMsgSeenFlag, true, &amp;msgKey, 1, nullptr);</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineplus">+          rv = StoreImapFlags(kImapMsgSeenFlag, true, &amp;msgKey, 1, nullptr);</span>
<a href="#l5.184"></a><span id="l5.184">           msgIsNew = false;</span>
<a href="#l5.185"></a><span id="l5.185">         } break;</span>
<a href="#l5.186"></a><span id="l5.186">         case nsMsgFilterAction::MarkUnread: {</span>
<a href="#l5.187"></a><span id="l5.187">           mDatabase-&gt;MarkHdrRead(msgHdr, false, nullptr);</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineminus">-          StoreImapFlags(kImapMsgSeenFlag, false, &amp;msgKey, 1, nullptr);</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineplus">+          rv = StoreImapFlags(kImapMsgSeenFlag, false, &amp;msgKey, 1, nullptr);</span>
<a href="#l5.190"></a><span id="l5.190">           msgIsNew = true;</span>
<a href="#l5.191"></a><span id="l5.191">         } break;</span>
<a href="#l5.192"></a><span id="l5.192">         case nsMsgFilterAction::MarkFlagged: {</span>
<a href="#l5.193"></a><span id="l5.193">           mDatabase-&gt;MarkHdrMarked(msgHdr, true, nullptr);</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineminus">-          StoreImapFlags(kImapMsgFlaggedFlag, true, &amp;msgKey, 1, nullptr);</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineplus">+          rv = StoreImapFlags(kImapMsgFlaggedFlag, true, &amp;msgKey, 1, nullptr);</span>
<a href="#l5.196"></a><span id="l5.196">         } break;</span>
<a href="#l5.197"></a><span id="l5.197">         case nsMsgFilterAction::KillThread:</span>
<a href="#l5.198"></a><span id="l5.198">         case nsMsgFilterAction::WatchThread: {</span>
<a href="#l5.199"></a><span id="l5.199">           nsCOMPtr&lt;nsIMsgThread&gt; msgThread;</span>
<a href="#l5.200"></a><span id="l5.200">           nsMsgKey threadKey;</span>
<a href="#l5.201"></a><span id="l5.201">           mDatabase-&gt;GetThreadContainingMsgHdr(msgHdr,</span>
<a href="#l5.202"></a><span id="l5.202">                                                getter_AddRefs(msgThread));</span>
<a href="#l5.203"></a><span id="l5.203">           if (msgThread) {</span>
<a href="#l5.204"></a><span id="l5.204">             msgThread-&gt;GetThreadKey(&amp;threadKey);</span>
<a href="#l5.205"></a><span id="l5.205">             if (actionType == nsMsgFilterAction::KillThread)</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineminus">-              mDatabase-&gt;MarkThreadIgnored(msgThread, threadKey, true, nullptr);</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineplus">+              rv = mDatabase-&gt;MarkThreadIgnored(msgThread, threadKey, true,</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineplus">+                                                nullptr);</span>
<a href="#l5.209"></a><span id="l5.209">             else</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineminus">-              mDatabase-&gt;MarkThreadWatched(msgThread, threadKey, true, nullptr);</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineplus">+              rv = mDatabase-&gt;MarkThreadWatched(msgThread, threadKey, true,</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineplus">+                                                nullptr);</span>
<a href="#l5.213"></a><span id="l5.213">           } else {</span>
<a href="#l5.214"></a><span id="l5.214">             if (actionType == nsMsgFilterAction::KillThread)</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineminus">-              msgHdr-&gt;SetUint32Property(&quot;ProtoThreadFlags&quot;,</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineminus">-                                        nsMsgMessageFlags::Ignored);</span>
<a href="#l5.217"></a><span id="l5.217" class="difflineplus">+              rv = msgHdr-&gt;SetUint32Property(&quot;ProtoThreadFlags&quot;,</span>
<a href="#l5.218"></a><span id="l5.218" class="difflineplus">+                                             nsMsgMessageFlags::Ignored);</span>
<a href="#l5.219"></a><span id="l5.219">             else</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineminus">-              msgHdr-&gt;SetUint32Property(&quot;ProtoThreadFlags&quot;,</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineminus">-                                        nsMsgMessageFlags::Watched);</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineplus">+              rv = msgHdr-&gt;SetUint32Property(&quot;ProtoThreadFlags&quot;,</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineplus">+                                             nsMsgMessageFlags::Watched);</span>
<a href="#l5.224"></a><span id="l5.224">           }</span>
<a href="#l5.225"></a><span id="l5.225">           if (actionType == nsMsgFilterAction::KillThread) {</span>
<a href="#l5.226"></a><span id="l5.226">             mDatabase-&gt;MarkHdrRead(msgHdr, true, nullptr);</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineminus">-            StoreImapFlags(kImapMsgSeenFlag, true, &amp;msgKey, 1, nullptr);</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineplus">+            rv = StoreImapFlags(kImapMsgSeenFlag, true, &amp;msgKey, 1, nullptr);</span>
<a href="#l5.229"></a><span id="l5.229">             msgIsNew = false;</span>
<a href="#l5.230"></a><span id="l5.230">           }</span>
<a href="#l5.231"></a><span id="l5.231">         } break;</span>
<a href="#l5.232"></a><span id="l5.232">         case nsMsgFilterAction::KillSubthread: {</span>
<a href="#l5.233"></a><span id="l5.233">           mDatabase-&gt;MarkHeaderKilled(msgHdr, true, nullptr);</span>
<a href="#l5.234"></a><span id="l5.234">           mDatabase-&gt;MarkHdrRead(msgHdr, true, nullptr);</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineminus">-          StoreImapFlags(kImapMsgSeenFlag, true, &amp;msgKey, 1, nullptr);</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineplus">+          rv = StoreImapFlags(kImapMsgSeenFlag, true, &amp;msgKey, 1, nullptr);</span>
<a href="#l5.237"></a><span id="l5.237">           msgIsNew = false;</span>
<a href="#l5.238"></a><span id="l5.238">         } break;</span>
<a href="#l5.239"></a><span id="l5.239">         case nsMsgFilterAction::ChangePriority: {</span>
<a href="#l5.240"></a><span id="l5.240">           nsMsgPriorityValue filterPriority;  // a int32_t</span>
<a href="#l5.241"></a><span id="l5.241">           filterAction-&gt;GetPriority(&amp;filterPriority);</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineminus">-          mDatabase-&gt;SetUint32PropertyByHdr(</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineplus">+          rv = mDatabase-&gt;SetUint32PropertyByHdr(</span>
<a href="#l5.244"></a><span id="l5.244">               msgHdr, &quot;priority&quot;, static_cast&lt;uint32_t&gt;(filterPriority));</span>
<a href="#l5.245"></a><span id="l5.245">         } break;</span>
<a href="#l5.246"></a><span id="l5.246">         case nsMsgFilterAction::Label: {</span>
<a href="#l5.247"></a><span id="l5.247">           nsMsgLabelValue filterLabel;</span>
<a href="#l5.248"></a><span id="l5.248">           filterAction-&gt;GetLabel(&amp;filterLabel);</span>
<a href="#l5.249"></a><span id="l5.249">           mDatabase-&gt;SetUint32PropertyByHdr(msgHdr, &quot;label&quot;,</span>
<a href="#l5.250"></a><span id="l5.250">                                             static_cast&lt;uint32_t&gt;(filterLabel));</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineminus">-          StoreImapFlags((filterLabel &lt;&lt; 9), true, &amp;msgKey, 1, nullptr);</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineplus">+          rv = StoreImapFlags((filterLabel &lt;&lt; 9), true, &amp;msgKey, 1, nullptr);</span>
<a href="#l5.253"></a><span id="l5.253">         } break;</span>
<a href="#l5.254"></a><span id="l5.254">         case nsMsgFilterAction::AddTag: {</span>
<a href="#l5.255"></a><span id="l5.255">           nsCString keyword;</span>
<a href="#l5.256"></a><span id="l5.256">           filterAction-&gt;GetStrValue(keyword);</span>
<a href="#l5.257"></a><span id="l5.257">           nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l5.258"></a><span id="l5.258">               do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l5.259"></a><span id="l5.259" class="difflineminus">-          NS_ENSURE_TRUE(messageArray, rv);</span>
<a href="#l5.260"></a><span id="l5.260" class="difflineplus">+          if (NS_FAILED(rv) || !messageArray) break;</span>
<a href="#l5.261"></a><span id="l5.261">           messageArray-&gt;AppendElement(msgHdr);</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineminus">-          AddKeywordsToMessages(messageArray, keyword);</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineminus">-          break;</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineminus">-        }</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineplus">+          rv = AddKeywordsToMessages(messageArray, keyword);</span>
<a href="#l5.266"></a><span id="l5.266" class="difflineplus">+        } break;</span>
<a href="#l5.267"></a><span id="l5.267">         case nsMsgFilterAction::JunkScore: {</span>
<a href="#l5.268"></a><span id="l5.268">           nsAutoCString junkScoreStr;</span>
<a href="#l5.269"></a><span id="l5.269">           int32_t junkScore;</span>
<a href="#l5.270"></a><span id="l5.270">           filterAction-&gt;GetJunkScore(&amp;junkScore);</span>
<a href="#l5.271"></a><span id="l5.271">           junkScoreStr.AppendInt(junkScore);</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineminus">-          mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscore&quot;, junkScoreStr.get());</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineplus">+          rv = mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscore&quot;,</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineplus">+                                            junkScoreStr.get());</span>
<a href="#l5.275"></a><span id="l5.275">           mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscoreorigin&quot;, &quot;filter&quot;);</span>
<a href="#l5.276"></a><span id="l5.276"> </span>
<a href="#l5.277"></a><span id="l5.277">           // If score is available, set up to store junk status on server.</span>
<a href="#l5.278"></a><span id="l5.278">           if (junkScore == nsIJunkMailPlugin::IS_SPAM_SCORE ||</span>
<a href="#l5.279"></a><span id="l5.279">               junkScore == nsIJunkMailPlugin::IS_HAM_SCORE) {</span>
<a href="#l5.280"></a><span id="l5.280">             nsTArray&lt;nsMsgKey&gt; *keysToClassify = m_moveCoalescer-&gt;GetKeyBucket(</span>
<a href="#l5.281"></a><span id="l5.281">                 (junkScore == nsIJunkMailPlugin::IS_SPAM_SCORE) ? 0 : 1);</span>
<a href="#l5.282"></a><span id="l5.282">             NS_ASSERTION(keysToClassify, &quot;error getting key bucket&quot;);</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineat">@@ -3401,37 +3435,37 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l5.284"></a><span id="l5.284">             }</span>
<a href="#l5.285"></a><span id="l5.285">           }</span>
<a href="#l5.286"></a><span id="l5.286">         } break;</span>
<a href="#l5.287"></a><span id="l5.287">         case nsMsgFilterAction::Forward: {</span>
<a href="#l5.288"></a><span id="l5.288">           nsCString forwardTo;</span>
<a href="#l5.289"></a><span id="l5.289">           filterAction-&gt;GetStrValue(forwardTo);</span>
<a href="#l5.290"></a><span id="l5.290">           nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l5.291"></a><span id="l5.291">           rv = GetServer(getter_AddRefs(server));</span>
<a href="#l5.292"></a><span id="l5.292" class="difflineminus">-          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.293"></a><span id="l5.293" class="difflineplus">+          if (NS_FAILED(rv)) break;</span>
<a href="#l5.294"></a><span id="l5.294">           if (!forwardTo.IsEmpty()) {</span>
<a href="#l5.295"></a><span id="l5.295">             nsCOMPtr&lt;nsIMsgComposeService&gt; compService =</span>
<a href="#l5.296"></a><span id="l5.296">                 do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l5.297"></a><span id="l5.297" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineplus">+            if (NS_FAILED(rv)) break;</span>
<a href="#l5.299"></a><span id="l5.299">             rv = compService-&gt;ForwardMessage(</span>
<a href="#l5.300"></a><span id="l5.300">                 NS_ConvertASCIItoUTF16(forwardTo), msgHdr, msgWindow, server,</span>
<a href="#l5.301"></a><span id="l5.301">                 nsIMsgComposeService::kForwardAsDefault);</span>
<a href="#l5.302"></a><span id="l5.302">           }</span>
<a href="#l5.303"></a><span id="l5.303">         } break;</span>
<a href="#l5.304"></a><span id="l5.304"> </span>
<a href="#l5.305"></a><span id="l5.305">         case nsMsgFilterAction::Reply: {</span>
<a href="#l5.306"></a><span id="l5.306">           nsCString replyTemplateUri;</span>
<a href="#l5.307"></a><span id="l5.307">           filterAction-&gt;GetStrValue(replyTemplateUri);</span>
<a href="#l5.308"></a><span id="l5.308">           nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l5.309"></a><span id="l5.309" class="difflineminus">-          GetServer(getter_AddRefs(server));</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineminus">-          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineplus">+          rv = GetServer(getter_AddRefs(server));</span>
<a href="#l5.312"></a><span id="l5.312" class="difflineplus">+          if (NS_FAILED(rv)) break;</span>
<a href="#l5.313"></a><span id="l5.313">           if (!replyTemplateUri.IsEmpty()) {</span>
<a href="#l5.314"></a><span id="l5.314">             nsCOMPtr&lt;nsIMsgComposeService&gt; compService =</span>
<a href="#l5.315"></a><span id="l5.315" class="difflineminus">-                do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID);</span>
<a href="#l5.316"></a><span id="l5.316" class="difflineminus">-            if (compService) {</span>
<a href="#l5.317"></a><span id="l5.317" class="difflineplus">+                do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l5.318"></a><span id="l5.318" class="difflineplus">+            if (NS_SUCCEEDED(rv) &amp;&amp; compService) {</span>
<a href="#l5.319"></a><span id="l5.319">               rv = compService-&gt;ReplyWithTemplate(</span>
<a href="#l5.320"></a><span id="l5.320">                   msgHdr, replyTemplateUri.get(), msgWindow, server);</span>
<a href="#l5.321"></a><span id="l5.321">               if (NS_FAILED(rv)) {</span>
<a href="#l5.322"></a><span id="l5.322">                 NS_WARNING(&quot;ReplyWithTemplate failed&quot;);</span>
<a href="#l5.323"></a><span id="l5.323">                 if (rv == NS_ERROR_ABORT) {</span>
<a href="#l5.324"></a><span id="l5.324">                   (void)filter-&gt;LogRuleHitFail(</span>
<a href="#l5.325"></a><span id="l5.325">                       filterAction, msgHdr, rv,</span>
<a href="#l5.326"></a><span id="l5.326">                       NS_LITERAL_CSTRING(&quot;filterFailureSendingReplyAborted&quot;));</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineat">@@ -3443,53 +3477,75 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l5.328"></a><span id="l5.328">               }</span>
<a href="#l5.329"></a><span id="l5.329">             }</span>
<a href="#l5.330"></a><span id="l5.330">           }</span>
<a href="#l5.331"></a><span id="l5.331">         } break;</span>
<a href="#l5.332"></a><span id="l5.332"> </span>
<a href="#l5.333"></a><span id="l5.333">         case nsMsgFilterAction::StopExecution: {</span>
<a href="#l5.334"></a><span id="l5.334">           // don't apply any more filters</span>
<a href="#l5.335"></a><span id="l5.335">           *applyMore = false;</span>
<a href="#l5.336"></a><span id="l5.336" class="difflineplus">+          rv = NS_OK;</span>
<a href="#l5.337"></a><span id="l5.337">         } break;</span>
<a href="#l5.338"></a><span id="l5.338"> </span>
<a href="#l5.339"></a><span id="l5.339">         case nsMsgFilterAction::Custom: {</span>
<a href="#l5.340"></a><span id="l5.340">           nsCOMPtr&lt;nsIMsgFilterCustomAction&gt; customAction;</span>
<a href="#l5.341"></a><span id="l5.341">           rv = filterAction-&gt;GetCustomAction(getter_AddRefs(customAction));</span>
<a href="#l5.342"></a><span id="l5.342" class="difflineminus">-          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.343"></a><span id="l5.343" class="difflineplus">+          if (NS_FAILED(rv)) break;</span>
<a href="#l5.344"></a><span id="l5.344"> </span>
<a href="#l5.345"></a><span id="l5.345">           nsAutoCString value;</span>
<a href="#l5.346"></a><span id="l5.346" class="difflineminus">-          filterAction-&gt;GetStrValue(value);</span>
<a href="#l5.347"></a><span id="l5.347" class="difflineplus">+          rv = filterAction-&gt;GetStrValue(value);</span>
<a href="#l5.348"></a><span id="l5.348" class="difflineplus">+          if (NS_FAILED(rv)) break;</span>
<a href="#l5.349"></a><span id="l5.349"> </span>
<a href="#l5.350"></a><span id="l5.350">           nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l5.351"></a><span id="l5.351">               do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l5.352"></a><span id="l5.352">           NS_ENSURE_TRUE(messageArray, rv);</span>
<a href="#l5.353"></a><span id="l5.353" class="difflineplus">+          if (NS_FAILED(rv) || !messageArray) break;</span>
<a href="#l5.354"></a><span id="l5.354">           messageArray-&gt;AppendElement(msgHdr);</span>
<a href="#l5.355"></a><span id="l5.355"> </span>
<a href="#l5.356"></a><span id="l5.356" class="difflineminus">-          customAction-&gt;Apply(messageArray, value, nullptr,</span>
<a href="#l5.357"></a><span id="l5.357" class="difflineminus">-                              nsMsgFilterType::InboxRule, msgWindow);</span>
<a href="#l5.358"></a><span id="l5.358" class="difflineplus">+          rv = customAction-&gt;Apply(messageArray, value, nullptr,</span>
<a href="#l5.359"></a><span id="l5.359" class="difflineplus">+                                   nsMsgFilterType::InboxRule, msgWindow);</span>
<a href="#l5.360"></a><span id="l5.360">           // allow custom action to affect new</span>
<a href="#l5.361"></a><span id="l5.361">           msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l5.362"></a><span id="l5.362">           if (!(msgFlags &amp; nsMsgMessageFlags::New)) msgIsNew = false;</span>
<a href="#l5.363"></a><span id="l5.363">         } break;</span>
<a href="#l5.364"></a><span id="l5.364"> </span>
<a href="#l5.365"></a><span id="l5.365">         default:</span>
<a href="#l5.366"></a><span id="l5.366" class="difflineplus">+          NS_ERROR(&quot;unexpected filter action&quot;);</span>
<a href="#l5.367"></a><span id="l5.367" class="difflineplus">+          rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l5.368"></a><span id="l5.368">           break;</span>
<a href="#l5.369"></a><span id="l5.369">       }</span>
<a href="#l5.370"></a><span id="l5.370">     }</span>
<a href="#l5.371"></a><span id="l5.371" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l5.372"></a><span id="l5.372" class="difflineplus">+      finalResult = rv;</span>
<a href="#l5.373"></a><span id="l5.373" class="difflineplus">+      MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,</span>
<a href="#l5.374"></a><span id="l5.374" class="difflineplus">+              (&quot;(Imap) Action execution failed with error: %&quot; PRIx32,</span>
<a href="#l5.375"></a><span id="l5.375" class="difflineplus">+               static_cast&lt;uint32_t&gt;(rv)));</span>
<a href="#l5.376"></a><span id="l5.376" class="difflineplus">+      if (loggingEnabled) {</span>
<a href="#l5.377"></a><span id="l5.377" class="difflineplus">+        (void)filter-&gt;LogRuleHitFail(filterAction, msgHdr, rv,</span>
<a href="#l5.378"></a><span id="l5.378" class="difflineplus">+                                     NS_LITERAL_CSTRING(&quot;filterFailureAction&quot;));</span>
<a href="#l5.379"></a><span id="l5.379" class="difflineplus">+      }</span>
<a href="#l5.380"></a><span id="l5.380" class="difflineplus">+    } else {</span>
<a href="#l5.381"></a><span id="l5.381" class="difflineplus">+      MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l5.382"></a><span id="l5.382" class="difflineplus">+              (&quot;(Imap) Action execution succeeded&quot;));</span>
<a href="#l5.383"></a><span id="l5.383" class="difflineplus">+    }</span>
<a href="#l5.384"></a><span id="l5.384">   }</span>
<a href="#l5.385"></a><span id="l5.385">   if (!msgIsNew) {</span>
<a href="#l5.386"></a><span id="l5.386">     int32_t numNewMessages;</span>
<a href="#l5.387"></a><span id="l5.387">     GetNumNewMessages(false, &amp;numNewMessages);</span>
<a href="#l5.388"></a><span id="l5.388">     // When database notifications are active, new counts will be reset</span>
<a href="#l5.389"></a><span id="l5.389">     // to zero in nsMsgDBFolder::SendFlagNotifications by the call to</span>
<a href="#l5.390"></a><span id="l5.390">     // SetBiffState(nsMsgBiffState_NoMail), so don't repeat them here.</span>
<a href="#l5.391"></a><span id="l5.391">     if (!m_filterListRequiresBody) SetNumNewMessages(--numNewMessages);</span>
<a href="#l5.392"></a><span id="l5.392">     if (mDatabase) mDatabase-&gt;MarkHdrNotNew(msgHdr, nullptr);</span>
<a href="#l5.393"></a><span id="l5.393" class="difflineminus">-  }</span>
<a href="#l5.394"></a><span id="l5.394" class="difflineminus">-  return NS_OK;</span>
<a href="#l5.395"></a><span id="l5.395" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l5.396"></a><span id="l5.396" class="difflineplus">+            (&quot;(Imap) Message will not be marked new&quot;));</span>
<a href="#l5.397"></a><span id="l5.397" class="difflineplus">+  }</span>
<a href="#l5.398"></a><span id="l5.398" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l5.399"></a><span id="l5.399" class="difflineplus">+          (&quot;(Imap) Finished executing actions&quot;));</span>
<a href="#l5.400"></a><span id="l5.400" class="difflineplus">+  return finalResult;</span>
<a href="#l5.401"></a><span id="l5.401"> }</span>
<a href="#l5.402"></a><span id="l5.402"> </span>
<a href="#l5.403"></a><span id="l5.403"> NS_IMETHODIMP nsImapMailFolder::SetImapFlags(const char *uids, int32_t flags,</span>
<a href="#l5.404"></a><span id="l5.404">                                              nsIURI **url) {</span>
<a href="#l5.405"></a><span id="l5.405">   nsresult rv;</span>
<a href="#l5.406"></a><span id="l5.406">   nsCOMPtr&lt;nsIImapService&gt; imapService =</span>
<a href="#l5.407"></a><span id="l5.407">       do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l5.408"></a><span id="l5.408">   NS_ENSURE_SUCCESS(rv, rv);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1832,126 +1832,154 @@ NS_IMETHODIMP nsParseNewMailState::Apply</span>
<a href="#l6.4"></a><span id="l6.4">   rv = filterActionList-&gt;GetLength(&amp;numActions);</span>
<a href="#l6.5"></a><span id="l6.5">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7">   nsCString msgId;</span>
<a href="#l6.8"></a><span id="l6.8">   msgHdr-&gt;GetMessageId(getter_Copies(msgId));</span>
<a href="#l6.9"></a><span id="l6.9">   nsMsgKey msgKey;</span>
<a href="#l6.10"></a><span id="l6.10">   msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l6.11"></a><span id="l6.11">   MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-          (&quot;(Local) Applying filter actions on message with key %&quot; PRIu32,</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-           msgKeyToInt(msgKey)));</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+          (&quot;(Local) Applying %&quot; PRIu32</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+           &quot; filter actions on message with key %&quot; PRIu32,</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+           numActions, msgKeyToInt(msgKey)));</span>
<a href="#l6.17"></a><span id="l6.17">   MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l6.18"></a><span id="l6.18">           (&quot;(Local) Message ID: %s&quot;, msgId.get()));</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20">   bool loggingEnabled = false;</span>
<a href="#l6.21"></a><span id="l6.21">   if (m_filterList &amp;&amp; numActions)</span>
<a href="#l6.22"></a><span id="l6.22">     m_filterList-&gt;GetLoggingEnabled(&amp;loggingEnabled);</span>
<a href="#l6.23"></a><span id="l6.23"> </span>
<a href="#l6.24"></a><span id="l6.24">   bool msgIsNew = true;</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+  nsresult finalResult = NS_OK;  // result of all actions</span>
<a href="#l6.26"></a><span id="l6.26">   for (uint32_t actionIndex = 0; actionIndex &lt; numActions &amp;&amp; *applyMore;</span>
<a href="#l6.27"></a><span id="l6.27">        actionIndex++) {</span>
<a href="#l6.28"></a><span id="l6.28">     nsCOMPtr&lt;nsIMsgRuleAction&gt; filterAction =</span>
<a href="#l6.29"></a><span id="l6.29">         do_QueryElementAt(filterActionList, actionIndex, &amp;rv);</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-    if (NS_FAILED(rv) || !filterAction) continue;</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+    if (NS_FAILED(rv) || !filterAction) {</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+      MOZ_LOG(FILTERLOGMODULE, LogLevel::Warning,</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+              (&quot;(Local) Filter action at index %&quot; PRIu32 &quot; invalid, skipping&quot;,</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+               actionIndex));</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+      continue;</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+    }</span>
<a href="#l6.37"></a><span id="l6.37"> </span>
<a href="#l6.38"></a><span id="l6.38">     nsMsgRuleActionType actionType;</span>
<a href="#l6.39"></a><span id="l6.39">     if (NS_SUCCEEDED(filterAction-&gt;GetType(&amp;actionType))) {</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+      MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+              (&quot;(Local) Running filter action at index %&quot; PRIu32</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+               &quot;, action type = %i&quot;,</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+               actionIndex, actionType));</span>
<a href="#l6.44"></a><span id="l6.44">       if (loggingEnabled) (void)filter-&gt;LogRuleHit(filterAction, msgHdr);</span>
<a href="#l6.45"></a><span id="l6.45"> </span>
<a href="#l6.46"></a><span id="l6.46">       nsCString actionTargetFolderUri;</span>
<a href="#l6.47"></a><span id="l6.47">       if (actionType == nsMsgFilterAction::MoveToFolder ||</span>
<a href="#l6.48"></a><span id="l6.48">           actionType == nsMsgFilterAction::CopyToFolder) {</span>
<a href="#l6.49"></a><span id="l6.49">         rv = filterAction-&gt;GetTargetFolderUri(actionTargetFolderUri);</span>
<a href="#l6.50"></a><span id="l6.50">         if (NS_FAILED(rv) || actionTargetFolderUri.IsEmpty()) {</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+          // clang-format off</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+          MOZ_LOG(FILTERLOGMODULE, LogLevel::Warning,</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+                  (&quot;(Local) Target URI for Copy/Move action is empty, skipping&quot;));</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+          // clang-format on</span>
<a href="#l6.55"></a><span id="l6.55">           NS_ASSERTION(false, &quot;actionTargetFolderUri is empty&quot;);</span>
<a href="#l6.56"></a><span id="l6.56">           continue;</span>
<a href="#l6.57"></a><span id="l6.57">         }</span>
<a href="#l6.58"></a><span id="l6.58">       }</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+      rv = NS_OK;  // result of the current action</span>
<a href="#l6.61"></a><span id="l6.61">       switch (actionType) {</span>
<a href="#l6.62"></a><span id="l6.62">         case nsMsgFilterAction::Delete: {</span>
<a href="#l6.63"></a><span id="l6.63">           nsCOMPtr&lt;nsIMsgFolder&gt; trash;</span>
<a href="#l6.64"></a><span id="l6.64">           // set value to trash folder</span>
<a href="#l6.65"></a><span id="l6.65">           rv = GetTrashFolder(getter_AddRefs(trash));</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-          if (NS_SUCCEEDED(rv) &amp;&amp; trash)</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+          if (NS_SUCCEEDED(rv) &amp;&amp; trash) {</span>
<a href="#l6.68"></a><span id="l6.68">             rv = trash-&gt;GetURI(actionTargetFolderUri);</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+            if (NS_FAILED(rv)) break;</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+          }</span>
<a href="#l6.71"></a><span id="l6.71"> </span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-          msgHdr-&gt;OrFlags(nsMsgMessageFlags::Read,</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-                          &amp;newFlags);  // mark read in trash.</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+          rv = msgHdr-&gt;OrFlags(nsMsgMessageFlags::Read,</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+                               &amp;newFlags);  // mark read in trash.</span>
<a href="#l6.76"></a><span id="l6.76">           msgIsNew = false;</span>
<a href="#l6.77"></a><span id="l6.77">         }</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-</span>
<a href="#l6.79"></a><span id="l6.79">           // FALLTHROUGH</span>
<a href="#l6.80"></a><span id="l6.80">           MOZ_FALLTHROUGH;</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-        case nsMsgFilterAction::MoveToFolder:</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+        case nsMsgFilterAction::MoveToFolder: {</span>
<a href="#l6.83"></a><span id="l6.83">           // if moving to a different file, do it.</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-          if (actionTargetFolderUri.get() &amp;&amp;</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+          if (!actionTargetFolderUri.IsEmpty() &amp;&amp;</span>
<a href="#l6.86"></a><span id="l6.86">               !m_inboxUri.Equals(actionTargetFolderUri,</span>
<a href="#l6.87"></a><span id="l6.87">                                  nsCaseInsensitiveCStringComparator())) {</span>
<a href="#l6.88"></a><span id="l6.88">             nsCOMPtr&lt;nsIMsgFolder&gt; destIFolder;</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-            nsresult err = GetOrCreateFolder(actionTargetFolderUri,</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineminus">-                                             getter_AddRefs(destIFolder));</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-            NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+            // XXX TODO: why do we create the folder here, while we do not in</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+            // the Copy action?</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+            rv = GetOrCreateFolder(actionTargetFolderUri,</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+                                   getter_AddRefs(destIFolder));</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+            if (NS_FAILED(rv)) {</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+              MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+                      (&quot;(Local) Target Folder for Move action does not exist&quot;));</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+              break;</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+            }</span>
<a href="#l6.101"></a><span id="l6.101">             bool msgMoved = false;</span>
<a href="#l6.102"></a><span id="l6.102">             // If we're moving to an imap folder, or this message has already</span>
<a href="#l6.103"></a><span id="l6.103">             // has a pending copy action, use the imap coalescer so that</span>
<a href="#l6.104"></a><span id="l6.104">             // we won't truncate the inbox before the copy fires.</span>
<a href="#l6.105"></a><span id="l6.105">             if (m_msgCopiedByFilter ||</span>
<a href="#l6.106"></a><span id="l6.106">                 StringBeginsWith(actionTargetFolderUri,</span>
<a href="#l6.107"></a><span id="l6.107">                                  NS_LITERAL_CSTRING(&quot;imap:&quot;))) {</span>
<a href="#l6.108"></a><span id="l6.108">               if (!m_moveCoalescer)</span>
<a href="#l6.109"></a><span id="l6.109">                 m_moveCoalescer =</span>
<a href="#l6.110"></a><span id="l6.110">                     new nsImapMoveCoalescer(m_downloadFolder, m_msgWindow);</span>
<a href="#l6.111"></a><span id="l6.111">               NS_ENSURE_TRUE(m_moveCoalescer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineminus">-              nsMsgKey msgKey;</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineminus">-              (void)msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineminus">-              m_moveCoalescer-&gt;AddMove(destIFolder, msgKey);</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-              err = NS_OK;</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+              rv = m_moveCoalescer-&gt;AddMove(destIFolder, msgKey);</span>
<a href="#l6.117"></a><span id="l6.117">               msgIsNew = false;</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+              if (NS_FAILED(rv)) break;</span>
<a href="#l6.119"></a><span id="l6.119">             } else {</span>
<a href="#l6.120"></a><span id="l6.120">               nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineminus">-              err = m_downloadFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-              if (NS_SUCCEEDED(err))</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">-                err = msgStore-&gt;MoveNewlyDownloadedMessage(msgHdr, destIFolder,</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineminus">-                                                           &amp;msgMoved);</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineminus">-              if (NS_SUCCEEDED(err) &amp;&amp; !msgMoved)</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineminus">-                err = MoveIncorporatedMessage(msgHdr, m_mailDB, destIFolder,</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineminus">-                                              filter, msgWindow);</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineminus">-              m_msgMovedByFilter = NS_SUCCEEDED(err);</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+              rv = m_downloadFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+              if (NS_SUCCEEDED(rv))</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineplus">+                rv = msgStore-&gt;MoveNewlyDownloadedMessage(msgHdr, destIFolder,</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+                                                          &amp;msgMoved);</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineplus">+              if (NS_SUCCEEDED(rv) &amp;&amp; !msgMoved)</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineplus">+                rv = MoveIncorporatedMessage(msgHdr, m_mailDB, destIFolder,</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineplus">+                                             filter, msgWindow);</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineplus">+              m_msgMovedByFilter = NS_SUCCEEDED(rv);</span>
<a href="#l6.137"></a><span id="l6.137">               if (!m_msgMovedByFilter /* == NS_FAILED(err) */) {</span>
<a href="#l6.138"></a><span id="l6.138">                 // XXX: Invoke MSG_LOG_TO_CONSOLE once bug 1135265 lands.</span>
<a href="#l6.139"></a><span id="l6.139">                 if (loggingEnabled) {</span>
<a href="#l6.140"></a><span id="l6.140">                   (void)filter-&gt;LogRuleHitFail(</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineminus">-                      filterAction, msgHdr, err,</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+                      filterAction, msgHdr, rv,</span>
<a href="#l6.143"></a><span id="l6.143">                       NS_LITERAL_CSTRING(&quot;filterFailureMoveFailed&quot;));</span>
<a href="#l6.144"></a><span id="l6.144">                 }</span>
<a href="#l6.145"></a><span id="l6.145">               }</span>
<a href="#l6.146"></a><span id="l6.146">             }</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineplus">+          } else {</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineplus">+            MOZ_LOG(FILTERLOGMODULE, LogLevel::Warning,</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+                    (&quot;(Local) Target folder is the same as source folder&quot;));</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineplus">+            rv = NS_OK;</span>
<a href="#l6.151"></a><span id="l6.151">           }</span>
<a href="#l6.152"></a><span id="l6.152">           *applyMore = false;</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineminus">-          break;</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineminus">-</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineplus">+        } break;</span>
<a href="#l6.156"></a><span id="l6.156">         case nsMsgFilterAction::CopyToFolder: {</span>
<a href="#l6.157"></a><span id="l6.157">           nsCString uri;</span>
<a href="#l6.158"></a><span id="l6.158">           rv = m_rootFolder-&gt;GetURI(uri);</span>
<a href="#l6.159"></a><span id="l6.159"> </span>
<a href="#l6.160"></a><span id="l6.160">           if (!actionTargetFolderUri.IsEmpty() &amp;&amp;</span>
<a href="#l6.161"></a><span id="l6.161">               !actionTargetFolderUri.Equals(uri)) {</span>
<a href="#l6.162"></a><span id="l6.162">             nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineminus">-                do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineplus">+                do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+            if (NS_FAILED(rv) || !messageArray) break;</span>
<a href="#l6.166"></a><span id="l6.166">             messageArray-&gt;AppendElement(msgHdr);</span>
<a href="#l6.167"></a><span id="l6.167"> </span>
<a href="#l6.168"></a><span id="l6.168">             nsCOMPtr&lt;nsIMsgFolder&gt; dstFolder;</span>
<a href="#l6.169"></a><span id="l6.169">             nsCOMPtr&lt;nsIMsgCopyService&gt; copyService;</span>
<a href="#l6.170"></a><span id="l6.170">             rv = GetExistingFolder(actionTargetFolderUri,</span>
<a href="#l6.171"></a><span id="l6.171">                                    getter_AddRefs(dstFolder));</span>
<a href="#l6.172"></a><span id="l6.172">             if (NS_FAILED(rv)) {</span>
<a href="#l6.173"></a><span id="l6.173">               // Let's show a more specific warning.</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineplus">+              MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineplus">+                      (&quot;(Local) Target Folder for Copy action does not exist&quot;));</span>
<a href="#l6.176"></a><span id="l6.176">               NS_WARNING(&quot;Target Folder does not exist.&quot;);</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineminus">-              return rv;</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineplus">+              break;</span>
<a href="#l6.179"></a><span id="l6.179">             }</span>
<a href="#l6.180"></a><span id="l6.180"> </span>
<a href="#l6.181"></a><span id="l6.181">             copyService = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l6.182"></a><span id="l6.182">             if (NS_SUCCEEDED(rv))</span>
<a href="#l6.183"></a><span id="l6.183">               rv = copyService-&gt;CopyMessages(m_downloadFolder, messageArray,</span>
<a href="#l6.184"></a><span id="l6.184">                                              dstFolder, false, nullptr,</span>
<a href="#l6.185"></a><span id="l6.185">                                              msgWindow, false);</span>
<a href="#l6.186"></a><span id="l6.186"> </span>
<a href="#l6.187"></a><span id="l6.187" class="difflineat">@@ -1959,181 +1987,205 @@ NS_IMETHODIMP nsParseNewMailState::Apply</span>
<a href="#l6.188"></a><span id="l6.188">               // XXX: Invoke MSG_LOG_TO_CONSOLE once bug 1135265 lands.</span>
<a href="#l6.189"></a><span id="l6.189">               if (loggingEnabled) {</span>
<a href="#l6.190"></a><span id="l6.190">                 (void)filter-&gt;LogRuleHitFail(</span>
<a href="#l6.191"></a><span id="l6.191">                     filterAction, msgHdr, rv,</span>
<a href="#l6.192"></a><span id="l6.192">                     NS_LITERAL_CSTRING(&quot;filterFailureCopyFailed&quot;));</span>
<a href="#l6.193"></a><span id="l6.193">               }</span>
<a href="#l6.194"></a><span id="l6.194">             } else</span>
<a href="#l6.195"></a><span id="l6.195">               m_msgCopiedByFilter = true;</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineplus">+          } else {</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineplus">+            MOZ_LOG(FILTERLOGMODULE, LogLevel::Warning,</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineplus">+                    (&quot;(Local) Target folder is the same as source folder&quot;));</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineplus">+            break;</span>
<a href="#l6.200"></a><span id="l6.200">           }</span>
<a href="#l6.201"></a><span id="l6.201">         } break;</span>
<a href="#l6.202"></a><span id="l6.202">         case nsMsgFilterAction::MarkRead:</span>
<a href="#l6.203"></a><span id="l6.203">           msgIsNew = false;</span>
<a href="#l6.204"></a><span id="l6.204">           MarkFilteredMessageRead(msgHdr);</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineplus">+          rv = NS_OK;</span>
<a href="#l6.206"></a><span id="l6.206">           break;</span>
<a href="#l6.207"></a><span id="l6.207">         case nsMsgFilterAction::MarkUnread:</span>
<a href="#l6.208"></a><span id="l6.208">           msgIsNew = true;</span>
<a href="#l6.209"></a><span id="l6.209">           MarkFilteredMessageUnread(msgHdr);</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineplus">+          rv = NS_OK;</span>
<a href="#l6.211"></a><span id="l6.211">           break;</span>
<a href="#l6.212"></a><span id="l6.212">         case nsMsgFilterAction::KillThread:</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineminus">-          msgHdr-&gt;SetUint32Property(&quot;ProtoThreadFlags&quot;,</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineminus">-                                    nsMsgMessageFlags::Ignored);</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineplus">+          rv = msgHdr-&gt;SetUint32Property(&quot;ProtoThreadFlags&quot;,</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineplus">+                                         nsMsgMessageFlags::Ignored);</span>
<a href="#l6.217"></a><span id="l6.217">           break;</span>
<a href="#l6.218"></a><span id="l6.218">         case nsMsgFilterAction::KillSubthread:</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineminus">-          msgHdr-&gt;OrFlags(nsMsgMessageFlags::Ignored, &amp;newFlags);</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineplus">+          rv = msgHdr-&gt;OrFlags(nsMsgMessageFlags::Ignored, &amp;newFlags);</span>
<a href="#l6.221"></a><span id="l6.221">           break;</span>
<a href="#l6.222"></a><span id="l6.222">         case nsMsgFilterAction::WatchThread:</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineminus">-          msgHdr-&gt;OrFlags(nsMsgMessageFlags::Watched, &amp;newFlags);</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineplus">+          rv = msgHdr-&gt;OrFlags(nsMsgMessageFlags::Watched, &amp;newFlags);</span>
<a href="#l6.225"></a><span id="l6.225">           break;</span>
<a href="#l6.226"></a><span id="l6.226">         case nsMsgFilterAction::MarkFlagged: {</span>
<a href="#l6.227"></a><span id="l6.227">           nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineminus">-              do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineplus">+              do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineplus">+          if (NS_FAILED(rv) || !messageArray) break;</span>
<a href="#l6.231"></a><span id="l6.231">           messageArray-&gt;AppendElement(msgHdr);</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineminus">-          m_downloadFolder-&gt;MarkMessagesFlagged(messageArray, true);</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineplus">+          rv = m_downloadFolder-&gt;MarkMessagesFlagged(messageArray, true);</span>
<a href="#l6.234"></a><span id="l6.234">         } break;</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineminus">-        case nsMsgFilterAction::ChangePriority:</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineplus">+        case nsMsgFilterAction::ChangePriority: {</span>
<a href="#l6.237"></a><span id="l6.237">           nsMsgPriorityValue filterPriority;</span>
<a href="#l6.238"></a><span id="l6.238">           filterAction-&gt;GetPriority(&amp;filterPriority);</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineminus">-          msgHdr-&gt;SetPriority(filterPriority);</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineminus">-          break;</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineplus">+          rv = msgHdr-&gt;SetPriority(filterPriority);</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineplus">+        } break;</span>
<a href="#l6.243"></a><span id="l6.243">         case nsMsgFilterAction::AddTag: {</span>
<a href="#l6.244"></a><span id="l6.244">           nsCString keyword;</span>
<a href="#l6.245"></a><span id="l6.245">           filterAction-&gt;GetStrValue(keyword);</span>
<a href="#l6.246"></a><span id="l6.246">           nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineminus">-              do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineplus">+              do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineplus">+          if (NS_FAILED(rv) || !messageArray) break;</span>
<a href="#l6.250"></a><span id="l6.250">           messageArray-&gt;AppendElement(msgHdr);</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineminus">-          m_downloadFolder-&gt;AddKeywordsToMessages(messageArray, keyword);</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineplus">+          rv = m_downloadFolder-&gt;AddKeywordsToMessages(messageArray, keyword);</span>
<a href="#l6.253"></a><span id="l6.253">           break;</span>
<a href="#l6.254"></a><span id="l6.254">         }</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineminus">-        case nsMsgFilterAction::Label:</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineplus">+        case nsMsgFilterAction::Label: {</span>
<a href="#l6.257"></a><span id="l6.257">           nsMsgLabelValue filterLabel;</span>
<a href="#l6.258"></a><span id="l6.258">           filterAction-&gt;GetLabel(&amp;filterLabel);</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineminus">-          nsMsgKey msgKey;</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineminus">-          msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineminus">-          m_mailDB-&gt;SetLabel(msgKey, filterLabel);</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineminus">-          break;</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineplus">+          rv = m_mailDB-&gt;SetLabel(msgKey, filterLabel);</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineplus">+        } break;</span>
<a href="#l6.265"></a><span id="l6.265">         case nsMsgFilterAction::JunkScore: {</span>
<a href="#l6.266"></a><span id="l6.266">           nsAutoCString junkScoreStr;</span>
<a href="#l6.267"></a><span id="l6.267">           int32_t junkScore;</span>
<a href="#l6.268"></a><span id="l6.268">           filterAction-&gt;GetJunkScore(&amp;junkScore);</span>
<a href="#l6.269"></a><span id="l6.269">           junkScoreStr.AppendInt(junkScore);</span>
<a href="#l6.270"></a><span id="l6.270">           if (junkScore == nsIJunkMailPlugin::IS_SPAM_SCORE) msgIsNew = false;</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineminus">-          nsMsgKey msgKey;</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineminus">-          msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l6.273"></a><span id="l6.273" class="difflineminus">-          msgHdr-&gt;SetStringProperty(&quot;junkscore&quot;, junkScoreStr.get());</span>
<a href="#l6.274"></a><span id="l6.274" class="difflineplus">+          rv = msgHdr-&gt;SetStringProperty(&quot;junkscore&quot;, junkScoreStr.get());</span>
<a href="#l6.275"></a><span id="l6.275">           msgHdr-&gt;SetStringProperty(&quot;junkscoreorigin&quot;, &quot;filter&quot;);</span>
<a href="#l6.276"></a><span id="l6.276" class="difflineminus">-          break;</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineminus">-        }</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineplus">+        } break;</span>
<a href="#l6.279"></a><span id="l6.279">         case nsMsgFilterAction::Forward: {</span>
<a href="#l6.280"></a><span id="l6.280">           nsCString forwardTo;</span>
<a href="#l6.281"></a><span id="l6.281">           filterAction-&gt;GetStrValue(forwardTo);</span>
<a href="#l6.282"></a><span id="l6.282">           m_forwardTo.AppendElement(forwardTo);</span>
<a href="#l6.283"></a><span id="l6.283">           m_msgToForwardOrReply = msgHdr;</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineplus">+          rv = NS_OK;</span>
<a href="#l6.285"></a><span id="l6.285">         } break;</span>
<a href="#l6.286"></a><span id="l6.286">         case nsMsgFilterAction::Reply: {</span>
<a href="#l6.287"></a><span id="l6.287">           nsCString replyTemplateUri;</span>
<a href="#l6.288"></a><span id="l6.288">           filterAction-&gt;GetStrValue(replyTemplateUri);</span>
<a href="#l6.289"></a><span id="l6.289">           m_replyTemplateUri.AppendElement(replyTemplateUri);</span>
<a href="#l6.290"></a><span id="l6.290">           m_msgToForwardOrReply = msgHdr;</span>
<a href="#l6.291"></a><span id="l6.291">           m_ruleAction = filterAction;</span>
<a href="#l6.292"></a><span id="l6.292">           m_filter = filter;</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineplus">+          rv = NS_OK;</span>
<a href="#l6.294"></a><span id="l6.294">         } break;</span>
<a href="#l6.295"></a><span id="l6.295">         case nsMsgFilterAction::DeleteFromPop3Server: {</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineminus">-          uint32_t flags = 0;</span>
<a href="#l6.297"></a><span id="l6.297">           nsCOMPtr&lt;nsIMsgFolder&gt; downloadFolder;</span>
<a href="#l6.298"></a><span id="l6.298">           msgHdr-&gt;GetFolder(getter_AddRefs(downloadFolder));</span>
<a href="#l6.299"></a><span id="l6.299">           nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder =</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineminus">-              do_QueryInterface(downloadFolder);</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineplus">+              do_QueryInterface(downloadFolder, &amp;rv);</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineplus">+          if (NS_FAILED(rv) || !localFolder) {</span>
<a href="#l6.303"></a><span id="l6.303" class="difflineplus">+            MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineplus">+                    (&quot;(Local) Couldn't find local mail folder&quot;));</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineplus">+            break;</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineplus">+          }</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineplus">+          nsCOMPtr&lt;nsIMutableArray&gt; messages =</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineplus">+              do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineplus">+          if (NS_FAILED(rv) || !messages) break;</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineplus">+          messages-&gt;AppendElement(msgHdr);</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineplus">+          // This action ignores the deleteMailLeftOnServer preference</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineplus">+          rv = localFolder-&gt;MarkMsgsOnPop3Server(messages, POP3_FORCE_DEL);</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineplus">+</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineplus">+          // If this is just a header, throw it away. It's useless now</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineplus">+          // that the server copy is being deleted.</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineplus">+          uint32_t flags = 0;</span>
<a href="#l6.317"></a><span id="l6.317">           msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineminus">-          if (localFolder) {</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineminus">-            nsCOMPtr&lt;nsIMutableArray&gt; messages =</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineminus">-                do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineminus">-            messages-&gt;AppendElement(msgHdr);</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineminus">-            // This action ignores the deleteMailLeftOnServer preference</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineminus">-            localFolder-&gt;MarkMsgsOnPop3Server(messages, POP3_FORCE_DEL);</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineminus">-</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineminus">-            // If this is just a header, throw it away. It's useless now</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineminus">-            // that the server copy is being deleted.</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineminus">-            if (flags &amp; nsMsgMessageFlags::Partial) {</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineminus">-              m_msgMovedByFilter = true;</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineminus">-              msgIsNew = false;</span>
<a href="#l6.331"></a><span id="l6.331" class="difflineminus">-            }</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineplus">+          if (flags &amp; nsMsgMessageFlags::Partial) {</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineplus">+            m_msgMovedByFilter = true;</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineplus">+            msgIsNew = false;</span>
<a href="#l6.335"></a><span id="l6.335">           }</span>
<a href="#l6.336"></a><span id="l6.336">         } break;</span>
<a href="#l6.337"></a><span id="l6.337">         case nsMsgFilterAction::FetchBodyFromPop3Server: {</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineminus">-          uint32_t flags = 0;</span>
<a href="#l6.339"></a><span id="l6.339">           nsCOMPtr&lt;nsIMsgFolder&gt; downloadFolder;</span>
<a href="#l6.340"></a><span id="l6.340">           msgHdr-&gt;GetFolder(getter_AddRefs(downloadFolder));</span>
<a href="#l6.341"></a><span id="l6.341">           nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder =</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineminus">-              do_QueryInterface(downloadFolder);</span>
<a href="#l6.343"></a><span id="l6.343" class="difflineplus">+              do_QueryInterface(downloadFolder, &amp;rv);</span>
<a href="#l6.344"></a><span id="l6.344" class="difflineplus">+          if (NS_FAILED(rv) || !localFolder) {</span>
<a href="#l6.345"></a><span id="l6.345" class="difflineplus">+            MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,</span>
<a href="#l6.346"></a><span id="l6.346" class="difflineplus">+                    (&quot;(Local) Couldn't find local mail folder&quot;));</span>
<a href="#l6.347"></a><span id="l6.347" class="difflineplus">+            break;</span>
<a href="#l6.348"></a><span id="l6.348" class="difflineplus">+          }</span>
<a href="#l6.349"></a><span id="l6.349" class="difflineplus">+          uint32_t flags = 0;</span>
<a href="#l6.350"></a><span id="l6.350">           msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l6.351"></a><span id="l6.351" class="difflineminus">-          if (localFolder &amp;&amp; (flags &amp; nsMsgMessageFlags::Partial)) {</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineplus">+          if (flags &amp; nsMsgMessageFlags::Partial) {</span>
<a href="#l6.353"></a><span id="l6.353">             nsCOMPtr&lt;nsIMutableArray&gt; messages =</span>
<a href="#l6.354"></a><span id="l6.354">                 do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineplus">+            if (NS_FAILED(rv) || !messages) break;</span>
<a href="#l6.357"></a><span id="l6.357">             messages-&gt;AppendElement(msgHdr);</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineminus">-            localFolder-&gt;MarkMsgsOnPop3Server(messages, POP3_FETCH_BODY);</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineplus">+            rv = localFolder-&gt;MarkMsgsOnPop3Server(messages, POP3_FETCH_BODY);</span>
<a href="#l6.360"></a><span id="l6.360">             // Don't add this header to the DB, we're going to replace it</span>
<a href="#l6.361"></a><span id="l6.361">             // with the full message.</span>
<a href="#l6.362"></a><span id="l6.362">             m_msgMovedByFilter = true;</span>
<a href="#l6.363"></a><span id="l6.363">             msgIsNew = false;</span>
<a href="#l6.364"></a><span id="l6.364">             // Don't do anything else in this filter, wait until we</span>
<a href="#l6.365"></a><span id="l6.365">             // have the full message.</span>
<a href="#l6.366"></a><span id="l6.366">             *applyMore = false;</span>
<a href="#l6.367"></a><span id="l6.367">           }</span>
<a href="#l6.368"></a><span id="l6.368">         } break;</span>
<a href="#l6.369"></a><span id="l6.369"> </span>
<a href="#l6.370"></a><span id="l6.370">         case nsMsgFilterAction::StopExecution: {</span>
<a href="#l6.371"></a><span id="l6.371">           // don't apply any more filters</span>
<a href="#l6.372"></a><span id="l6.372">           *applyMore = false;</span>
<a href="#l6.373"></a><span id="l6.373" class="difflineplus">+          rv = NS_OK;</span>
<a href="#l6.374"></a><span id="l6.374">         } break;</span>
<a href="#l6.375"></a><span id="l6.375"> </span>
<a href="#l6.376"></a><span id="l6.376">         case nsMsgFilterAction::Custom: {</span>
<a href="#l6.377"></a><span id="l6.377">           nsCOMPtr&lt;nsIMsgFilterCustomAction&gt; customAction;</span>
<a href="#l6.378"></a><span id="l6.378">           rv = filterAction-&gt;GetCustomAction(getter_AddRefs(customAction));</span>
<a href="#l6.379"></a><span id="l6.379" class="difflineminus">-          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineplus">+          if (NS_FAILED(rv)) break;</span>
<a href="#l6.381"></a><span id="l6.381"> </span>
<a href="#l6.382"></a><span id="l6.382">           nsAutoCString value;</span>
<a href="#l6.383"></a><span id="l6.383" class="difflineminus">-          filterAction-&gt;GetStrValue(value);</span>
<a href="#l6.384"></a><span id="l6.384" class="difflineplus">+          rv = filterAction-&gt;GetStrValue(value);</span>
<a href="#l6.385"></a><span id="l6.385" class="difflineplus">+          if (NS_FAILED(rv)) break;</span>
<a href="#l6.386"></a><span id="l6.386"> </span>
<a href="#l6.387"></a><span id="l6.387">           nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l6.388"></a><span id="l6.388">               do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l6.389"></a><span id="l6.389" class="difflineminus">-          NS_ENSURE_TRUE(messageArray, rv);</span>
<a href="#l6.390"></a><span id="l6.390" class="difflineminus">-          if (NS_SUCCEEDED(rv)) rv = messageArray-&gt;AppendElement(msgHdr);</span>
<a href="#l6.391"></a><span id="l6.391" class="difflineplus">+          if (NS_FAILED(rv) || !messageArray) break;</span>
<a href="#l6.392"></a><span id="l6.392" class="difflineplus">+          messageArray-&gt;AppendElement(msgHdr);</span>
<a href="#l6.393"></a><span id="l6.393"> </span>
<a href="#l6.394"></a><span id="l6.394" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l6.395"></a><span id="l6.395" class="difflineminus">-            rv = customAction-&gt;Apply(messageArray, value, nullptr,</span>
<a href="#l6.396"></a><span id="l6.396" class="difflineminus">-                                     nsMsgFilterType::InboxRule, msgWindow);</span>
<a href="#l6.397"></a><span id="l6.397" class="difflineminus">-          if (NS_FAILED(rv)) {</span>
<a href="#l6.398"></a><span id="l6.398" class="difflineminus">-            // XXX: Invoke MSG_LOG_TO_CONSOLE once bug 1135265 lands.</span>
<a href="#l6.399"></a><span id="l6.399" class="difflineminus">-            if (loggingEnabled) {</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineminus">-              (void)filter-&gt;LogRuleHitFail(</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineminus">-                  filterAction, msgHdr, rv,</span>
<a href="#l6.402"></a><span id="l6.402" class="difflineminus">-                  NS_LITERAL_CSTRING(&quot;filterFailureCopyFailed&quot;));</span>
<a href="#l6.403"></a><span id="l6.403" class="difflineminus">-            }</span>
<a href="#l6.404"></a><span id="l6.404" class="difflineminus">-          }</span>
<a href="#l6.405"></a><span id="l6.405" class="difflineplus">+          rv = customAction-&gt;Apply(messageArray, value, nullptr,</span>
<a href="#l6.406"></a><span id="l6.406" class="difflineplus">+                                   nsMsgFilterType::InboxRule, msgWindow);</span>
<a href="#l6.407"></a><span id="l6.407">         } break;</span>
<a href="#l6.408"></a><span id="l6.408"> </span>
<a href="#l6.409"></a><span id="l6.409">         default:</span>
<a href="#l6.410"></a><span id="l6.410">           // XXX should not be reached. Check in debug build.</span>
<a href="#l6.411"></a><span id="l6.411" class="difflineminus">-          NS_ERROR(&quot;This default should not be reached.&quot;);</span>
<a href="#l6.412"></a><span id="l6.412" class="difflineplus">+          NS_ERROR(&quot;unexpected filter action&quot;);</span>
<a href="#l6.413"></a><span id="l6.413" class="difflineplus">+          rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l6.414"></a><span id="l6.414">           break;</span>
<a href="#l6.415"></a><span id="l6.415">       }</span>
<a href="#l6.416"></a><span id="l6.416">     }</span>
<a href="#l6.417"></a><span id="l6.417" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l6.418"></a><span id="l6.418" class="difflineplus">+      finalResult = rv;</span>
<a href="#l6.419"></a><span id="l6.419" class="difflineplus">+      MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,</span>
<a href="#l6.420"></a><span id="l6.420" class="difflineplus">+              (&quot;(Local) Action execution failed with error: %&quot; PRIx32,</span>
<a href="#l6.421"></a><span id="l6.421" class="difflineplus">+               static_cast&lt;uint32_t&gt;(rv)));</span>
<a href="#l6.422"></a><span id="l6.422" class="difflineplus">+      if (loggingEnabled) {</span>
<a href="#l6.423"></a><span id="l6.423" class="difflineplus">+        (void)filter-&gt;LogRuleHitFail(filterAction, msgHdr, rv,</span>
<a href="#l6.424"></a><span id="l6.424" class="difflineplus">+                                     NS_LITERAL_CSTRING(&quot;filterFailureAction&quot;));</span>
<a href="#l6.425"></a><span id="l6.425" class="difflineplus">+      }</span>
<a href="#l6.426"></a><span id="l6.426" class="difflineplus">+    } else {</span>
<a href="#l6.427"></a><span id="l6.427" class="difflineplus">+      MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l6.428"></a><span id="l6.428" class="difflineplus">+              (&quot;(Local) Action execution succeeded&quot;));</span>
<a href="#l6.429"></a><span id="l6.429" class="difflineplus">+    }</span>
<a href="#l6.430"></a><span id="l6.430">   }</span>
<a href="#l6.431"></a><span id="l6.431">   if (!msgIsNew) {</span>
<a href="#l6.432"></a><span id="l6.432">     int32_t numNewMessages;</span>
<a href="#l6.433"></a><span id="l6.433">     m_downloadFolder-&gt;GetNumNewMessages(false, &amp;numNewMessages);</span>
<a href="#l6.434"></a><span id="l6.434">     if (numNewMessages &gt; 0)</span>
<a href="#l6.435"></a><span id="l6.435">       m_downloadFolder-&gt;SetNumNewMessages(numNewMessages - 1);</span>
<a href="#l6.436"></a><span id="l6.436">     m_numNotNewMessages++;</span>
<a href="#l6.437"></a><span id="l6.437" class="difflineplus">+    MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l6.438"></a><span id="l6.438" class="difflineplus">+            (&quot;(Local) Message will not be marked new&quot;));</span>
<a href="#l6.439"></a><span id="l6.439">   }</span>
<a href="#l6.440"></a><span id="l6.440" class="difflineminus">-  return rv;</span>
<a href="#l6.441"></a><span id="l6.441" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l6.442"></a><span id="l6.442" class="difflineplus">+          (&quot;(Local) Finished executing actions&quot;));</span>
<a href="#l6.443"></a><span id="l6.443" class="difflineplus">+  return finalResult;</span>
<a href="#l6.444"></a><span id="l6.444"> }</span>
<a href="#l6.445"></a><span id="l6.445"> </span>
<a href="#l6.446"></a><span id="l6.446"> // this gets run in a second pass, after apply filters to a header.</span>
<a href="#l6.447"></a><span id="l6.447"> nsresult nsParseNewMailState::ApplyForwardAndReplyFilter(</span>
<a href="#l6.448"></a><span id="l6.448">     nsIMsgWindow *msgWindow) {</span>
<a href="#l6.449"></a><span id="l6.449">   nsresult rv = NS_OK;</span>
<a href="#l6.450"></a><span id="l6.450">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l6.451"></a><span id="l6.451"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPNewsgroupList.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPNewsgroupList.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -590,102 +590,136 @@ NS_IMETHODIMP nsNNTPNewsgroupList::Apply</span>
<a href="#l7.4"></a><span id="l7.4">           (&quot;(News) Message ID: %s&quot;, msgId.get()));</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6">   bool loggingEnabled = false;</span>
<a href="#l7.7"></a><span id="l7.7">   nsCOMPtr&lt;nsIMsgFilterList&gt; currentFilterList;</span>
<a href="#l7.8"></a><span id="l7.8">   rv = aFilter-&gt;GetFilterList(getter_AddRefs(currentFilterList));</span>
<a href="#l7.9"></a><span id="l7.9">   if (NS_SUCCEEDED(rv) &amp;&amp; currentFilterList &amp;&amp; numActions)</span>
<a href="#l7.10"></a><span id="l7.10">     currentFilterList-&gt;GetLoggingEnabled(&amp;loggingEnabled);</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+  nsresult finalResult = NS_OK;  // result of all actions</span>
<a href="#l7.13"></a><span id="l7.13">   for (uint32_t actionIndex = 0; actionIndex &lt; numActions; actionIndex++) {</span>
<a href="#l7.14"></a><span id="l7.14">     nsCOMPtr&lt;nsIMsgRuleAction&gt; filterAction =</span>
<a href="#l7.15"></a><span id="l7.15">         do_QueryElementAt(filterActionList, actionIndex, &amp;rv);</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-    if (NS_FAILED(rv) || !filterAction) continue;</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+    if (NS_FAILED(rv) || !filterAction) {</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+      MOZ_LOG(FILTERLOGMODULE, LogLevel::Warning,</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+              (&quot;(News) Filter action at index %&quot; PRIu32 &quot; invalid, skipping&quot;,</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+               actionIndex));</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+      continue;</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+    }</span>
<a href="#l7.23"></a><span id="l7.23"> </span>
<a href="#l7.24"></a><span id="l7.24">     nsMsgRuleActionType actionType;</span>
<a href="#l7.25"></a><span id="l7.25">     if (NS_SUCCEEDED(filterAction-&gt;GetType(&amp;actionType))) {</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+      MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+              (&quot;(News) Running filter action at index %&quot; PRIu32</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+               &quot;, action type = %i&quot;,</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+               actionIndex, actionType));</span>
<a href="#l7.30"></a><span id="l7.30">       if (loggingEnabled) (void)aFilter-&gt;LogRuleHit(filterAction, m_newMsgHdr);</span>
<a href="#l7.31"></a><span id="l7.31"> </span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+      rv = NS_OK;  // result of the current action</span>
<a href="#l7.33"></a><span id="l7.33">       switch (actionType) {</span>
<a href="#l7.34"></a><span id="l7.34">         case nsMsgFilterAction::Delete:</span>
<a href="#l7.35"></a><span id="l7.35">           m_addHdrToDB = false;</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+          rv = NS_OK;</span>
<a href="#l7.37"></a><span id="l7.37">           break;</span>
<a href="#l7.38"></a><span id="l7.38">         case nsMsgFilterAction::MarkRead:</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-          m_newsDB-&gt;MarkHdrRead(m_newMsgHdr, true, nullptr);</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+          rv = m_newsDB-&gt;MarkHdrRead(m_newMsgHdr, true, nullptr);</span>
<a href="#l7.41"></a><span id="l7.41">           break;</span>
<a href="#l7.42"></a><span id="l7.42">         case nsMsgFilterAction::MarkUnread:</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-          m_newsDB-&gt;MarkHdrRead(m_newMsgHdr, false, nullptr);</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+          rv = m_newsDB-&gt;MarkHdrRead(m_newMsgHdr, false, nullptr);</span>
<a href="#l7.45"></a><span id="l7.45">           break;</span>
<a href="#l7.46"></a><span id="l7.46">         case nsMsgFilterAction::KillThread:</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-          m_newMsgHdr-&gt;SetUint32Property(&quot;ProtoThreadFlags&quot;,</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-                                         nsMsgMessageFlags::Ignored);</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+          rv = m_newMsgHdr-&gt;SetUint32Property(&quot;ProtoThreadFlags&quot;,</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+                                              nsMsgMessageFlags::Ignored);</span>
<a href="#l7.51"></a><span id="l7.51">           break;</span>
<a href="#l7.52"></a><span id="l7.52">         case nsMsgFilterAction::KillSubthread: {</span>
<a href="#l7.53"></a><span id="l7.53">           uint32_t newFlags;</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-          m_newMsgHdr-&gt;OrFlags(nsMsgMessageFlags::Ignored, &amp;newFlags);</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+          rv = m_newMsgHdr-&gt;OrFlags(nsMsgMessageFlags::Ignored, &amp;newFlags);</span>
<a href="#l7.56"></a><span id="l7.56">         } break;</span>
<a href="#l7.57"></a><span id="l7.57">         case nsMsgFilterAction::WatchThread: {</span>
<a href="#l7.58"></a><span id="l7.58">           uint32_t newFlags;</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-          m_newMsgHdr-&gt;OrFlags(nsMsgMessageFlags::Watched, &amp;newFlags);</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+          rv = m_newMsgHdr-&gt;OrFlags(nsMsgMessageFlags::Watched, &amp;newFlags);</span>
<a href="#l7.61"></a><span id="l7.61">         } break;</span>
<a href="#l7.62"></a><span id="l7.62">         case nsMsgFilterAction::MarkFlagged:</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-          m_newMsgHdr-&gt;MarkFlagged(true);</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+          rv = m_newMsgHdr-&gt;MarkFlagged(true);</span>
<a href="#l7.65"></a><span id="l7.65">           break;</span>
<a href="#l7.66"></a><span id="l7.66">         case nsMsgFilterAction::ChangePriority: {</span>
<a href="#l7.67"></a><span id="l7.67">           nsMsgPriorityValue filterPriority;</span>
<a href="#l7.68"></a><span id="l7.68">           filterAction-&gt;GetPriority(&amp;filterPriority);</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-          m_newMsgHdr-&gt;SetPriority(filterPriority);</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+          rv = m_newMsgHdr-&gt;SetPriority(filterPriority);</span>
<a href="#l7.71"></a><span id="l7.71">         } break;</span>
<a href="#l7.72"></a><span id="l7.72">         case nsMsgFilterAction::AddTag: {</span>
<a href="#l7.73"></a><span id="l7.73">           nsCString keyword;</span>
<a href="#l7.74"></a><span id="l7.74">           filterAction-&gt;GetStrValue(keyword);</span>
<a href="#l7.75"></a><span id="l7.75">           nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l7.76"></a><span id="l7.76">               do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l7.77"></a><span id="l7.77">           messageArray-&gt;AppendElement(m_newMsgHdr);</span>
<a href="#l7.78"></a><span id="l7.78">           nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryInterface(m_newsFolder, &amp;rv);</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-          if (folder) folder-&gt;AddKeywordsToMessages(messageArray, keyword);</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-          break;</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-        }</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+          if (NS_SUCCEEDED(rv) &amp;&amp; folder) {</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+            rv = folder-&gt;AddKeywordsToMessages(messageArray, keyword);</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+          } else {</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+            rv = NS_MSG_FOLDER_UNREADABLE;</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+            MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+                    (&quot;(News) Target folder for AddTag not found, skipping&quot;));</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+          }</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+        } break;</span>
<a href="#l7.90"></a><span id="l7.90">         case nsMsgFilterAction::Label: {</span>
<a href="#l7.91"></a><span id="l7.91">           nsMsgLabelValue filterLabel;</span>
<a href="#l7.92"></a><span id="l7.92">           filterAction-&gt;GetLabel(&amp;filterLabel);</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-          nsMsgKey msgKey;</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-          m_newMsgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineminus">-          m_newsDB-&gt;SetLabel(msgKey, filterLabel);</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+          rv = m_newsDB-&gt;SetLabel(msgKey, filterLabel);</span>
<a href="#l7.97"></a><span id="l7.97">         } break;</span>
<a href="#l7.98"></a><span id="l7.98"> </span>
<a href="#l7.99"></a><span id="l7.99">         case nsMsgFilterAction::StopExecution: {</span>
<a href="#l7.100"></a><span id="l7.100">           // don't apply any more filters</span>
<a href="#l7.101"></a><span id="l7.101">           *aApplyMore = false;</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+          rv = NS_OK;</span>
<a href="#l7.103"></a><span id="l7.103">         } break;</span>
<a href="#l7.104"></a><span id="l7.104"> </span>
<a href="#l7.105"></a><span id="l7.105">         case nsMsgFilterAction::Custom: {</span>
<a href="#l7.106"></a><span id="l7.106">           nsCOMPtr&lt;nsIMsgFilterCustomAction&gt; customAction;</span>
<a href="#l7.107"></a><span id="l7.107">           rv = filterAction-&gt;GetCustomAction(getter_AddRefs(customAction));</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+          if (NS_FAILED(rv)) break;</span>
<a href="#l7.110"></a><span id="l7.110"> </span>
<a href="#l7.111"></a><span id="l7.111">           nsAutoCString value;</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineminus">-          filterAction-&gt;GetStrValue(value);</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+          rv = filterAction-&gt;GetStrValue(value);</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+          if (NS_FAILED(rv)) break;</span>
<a href="#l7.115"></a><span id="l7.115"> </span>
<a href="#l7.116"></a><span id="l7.116">           nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l7.117"></a><span id="l7.117">               do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineminus">-          NS_ENSURE_TRUE(messageArray, rv);</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+          if (NS_FAILED(rv) || !messageArray) break;</span>
<a href="#l7.120"></a><span id="l7.120">           messageArray-&gt;AppendElement(m_newMsgHdr);</span>
<a href="#l7.121"></a><span id="l7.121"> </span>
<a href="#l7.122"></a><span id="l7.122" class="difflineminus">-          customAction-&gt;Apply(messageArray, value, nullptr,</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineminus">-                              nsMsgFilterType::NewsRule, aMsgWindow);</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+          rv = customAction-&gt;Apply(messageArray, value, nullptr,</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+                                   nsMsgFilterType::NewsRule, aMsgWindow);</span>
<a href="#l7.126"></a><span id="l7.126">         } break;</span>
<a href="#l7.127"></a><span id="l7.127"> </span>
<a href="#l7.128"></a><span id="l7.128">         default:</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-          NS_ERROR(&quot;unexpected action&quot;);</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+          NS_ERROR(&quot;unexpected filter action&quot;);</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+          rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l7.132"></a><span id="l7.132">           break;</span>
<a href="#l7.133"></a><span id="l7.133">       }</span>
<a href="#l7.134"></a><span id="l7.134">     }</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+      finalResult = rv;</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+      MOZ_LOG(FILTERLOGMODULE, LogLevel::Error,</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+              (&quot;(News) Action execution failed with error: %&quot; PRIx32,</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+               static_cast&lt;uint32_t&gt;(rv)));</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+      if (loggingEnabled) {</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+        (void)aFilter-&gt;LogRuleHitFail(filterAction, m_newMsgHdr, rv,</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+                                      NS_LITERAL_CSTRING(&quot;filterActionFailed&quot;));</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+      }</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+    } else {</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+      MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+              (&quot;(News) Action execution succeeded&quot;));</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+    }</span>
<a href="#l7.149"></a><span id="l7.149">   }</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-  return NS_OK;</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+          (&quot;(News) Finished executing actions&quot;));</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineplus">+  return finalResult;</span>
<a href="#l7.154"></a><span id="l7.154"> }</span>
<a href="#l7.155"></a><span id="l7.155"> </span>
<a href="#l7.156"></a><span id="l7.156"> nsresult nsNNTPNewsgroupList::ProcessXOVERLINE(const char *line,</span>
<a href="#l7.157"></a><span id="l7.157">                                                uint32_t *status) {</span>
<a href="#l7.158"></a><span id="l7.158">   uint32_t message_number = 0;</span>
<a href="#l7.159"></a><span id="l7.159">   //  int32_t lines;</span>
<a href="#l7.160"></a><span id="l7.160">   nsresult rv = NS_OK;</span>
<a href="#l7.161"></a><span id="l7.161"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/suite/locales/en-US/chrome/mailnews/filter.properties</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/mailnews/filter.properties</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -32,16 +32,17 @@ contextPeriodic.label=Periodically, ever</span>
<a href="#l8.4"></a><span id="l8.4"> # LOCALIZATION NOTE(filterFailureWarningPrefix)</span>
<a href="#l8.5"></a><span id="l8.5"> # %1$S=filter error action</span>
<a href="#l8.6"></a><span id="l8.6"> # %2$S=error code as hexadecimal string.</span>
<a href="#l8.7"></a><span id="l8.7"> filterFailureWarningPrefix=Filter action failed: &quot;%1$S&quot; with error code=%2$S while attempting:</span>
<a href="#l8.8"></a><span id="l8.8"> filterFailureSendingReplyError=Error sending reply</span>
<a href="#l8.9"></a><span id="l8.9"> filterFailureSendingReplyAborted=Sending reply aborted</span>
<a href="#l8.10"></a><span id="l8.10"> filterFailureMoveFailed=Move failed</span>
<a href="#l8.11"></a><span id="l8.11"> filterFailureCopyFailed=Copy failed</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+filterFailureAction=Failed applying the filter action</span>
<a href="#l8.13"></a><span id="l8.13"> </span>
<a href="#l8.14"></a><span id="l8.14"> searchTermsInvalidTitle=Search Terms Invalid</span>
<a href="#l8.15"></a><span id="l8.15"> # LOCALIZATION NOTE(searchTermsInvalidRule)</span>
<a href="#l8.16"></a><span id="l8.16"> # %1$S=search attribute name from the invalid rule</span>
<a href="#l8.17"></a><span id="l8.17"> # %2$S=search operator from the bad rule</span>
<a href="#l8.18"></a><span id="l8.18"> searchTermsInvalidRule=This filter cannot be saved because the search term &quot;%1$S %2$S&quot; is invalid in the current context.</span>
<a href="#l8.19"></a><span id="l8.19"> # LOCALIZATION NOTE(filterActionOrderExplanation)</span>
<a href="#l8.20"></a><span id="l8.20"> # Keep the \n\n that mean 2 linebreaks.</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

