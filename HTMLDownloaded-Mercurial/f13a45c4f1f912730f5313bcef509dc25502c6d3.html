<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 1624:f13a45c4f1f912730f5313bcef509dc25502c6d3</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ f13a45c4f1f912730f5313bcef509dc25502c6d3" />
<meta property="og:url" content="/comm-central/rev/f13a45c4f1f912730f5313bcef509dc25502c6d3" />
<meta property="og:description" content="Bug 419595 nsLDAPURL implementation is incorrect. r=bienvenu,sr=dmose" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / f13a45c4f1f912730f5313bcef509dc25502c6d3 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/f13a45c4f1f912730f5313bcef509dc25502c6d3">shortlog</a> |
<a href="/comm-central/log/f13a45c4f1f912730f5313bcef509dc25502c6d3">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/f13a45c4f1f912730f5313bcef509dc25502c6d3">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/f13a45c4f1f912730f5313bcef509dc25502c6d3">files</a> |
changeset |
<a href="/comm-central/raw-rev/f13a45c4f1f912730f5313bcef509dc25502c6d3">raw</a>  | <a href="/comm-central/archive/f13a45c4f1f912730f5313bcef509dc25502c6d3.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=419595">Bug 419595</a> nsLDAPURL implementation is incorrect. r=bienvenu,sr=dmose
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#97;&#114;&#107;&#32;&#66;&#97;&#110;&#110;&#101;&#114;&#32;&#60;&#98;&#117;&#103;&#122;&#105;&#108;&#108;&#97;&#64;&#115;&#116;&#97;&#110;&#100;&#97;&#114;&#100;&#56;&#46;&#112;&#108;&#117;&#115;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 13 Jan 2009 10:37:12 +0000</td></tr>

<tr>
 <td>changeset 1624</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/f13a45c4f1f912730f5313bcef509dc25502c6d3">f13a45c4f1f912730f5313bcef509dc25502c6d3</a></td>
</tr>



<tr>
<td>parent 1623</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/306be9e163b0b3a26e9b225a234616790f8df844">306be9e163b0b3a26e9b225a234616790f8df844</a>
</td>
</tr>

<tr>
<td>child 1625</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a048b5420d62dea34f3d8ee230922a6ea736353b">a048b5420d62dea34f3d8ee230922a6ea736353b</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=f13a45c4f1f912730f5313bcef509dc25502c6d3">1300</a></td></tr>
<tr><td>push user</td><td>bugzilla@standard8.plus.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 13 Jan 2009 10:41:08 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@f13a45c4f1f9 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f13a45c4f1f912730f5313bcef509dc25502c6d3">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f13a45c4f1f912730f5313bcef509dc25502c6d3&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f13a45c4f1f912730f5313bcef509dc25502c6d3&newProject=comm-central&newRevision=f13a45c4f1f912730f5313bcef509dc25502c6d3&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f13a45c4f1f912730f5313bcef509dc25502c6d3&newProject=comm-central&newRevision=f13a45c4f1f912730f5313bcef509dc25502c6d3&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f13a45c4f1f912730f5313bcef509dc25502c6d3&newProject=comm-central&newRevision=f13a45c4f1f912730f5313bcef509dc25502c6d3&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a>, <a href="/comm-central/log?rev=reviewer%28dmose%29&revcount=50">dmose</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=419595">419595</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=419595">Bug 419595</a> nsLDAPURL implementation is incorrect. r=bienvenu,sr=dmose</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/Makefile.in">directory/xpcom/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/Makefile.in">file</a> |
<a href="/comm-central/annotate/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/Makefile.in">annotate</a> |
<a href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/Makefile.in">diff</a> |
<a href="/comm-central/comparison/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/Makefile.in">comparison</a> |
<a href="/comm-central/log/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/public/nsILDAPURL.idl">directory/xpcom/base/public/nsILDAPURL.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/public/nsILDAPURL.idl">file</a> |
<a href="/comm-central/annotate/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/public/nsILDAPURL.idl">annotate</a> |
<a href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/public/nsILDAPURL.idl">diff</a> |
<a href="/comm-central/comparison/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/public/nsILDAPURL.idl">comparison</a> |
<a href="/comm-central/log/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/public/nsILDAPURL.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/Makefile.in">directory/xpcom/base/src/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/Makefile.in">file</a> |
<a href="/comm-central/annotate/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/Makefile.in">annotate</a> |
<a href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/Makefile.in">diff</a> |
<a href="/comm-central/comparison/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/Makefile.in">comparison</a> |
<a href="/comm-central/log/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPChannel.h">directory/xpcom/base/src/nsLDAPChannel.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPChannel.h">file</a> |
<a href="/comm-central/annotate/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPChannel.h">annotate</a> |
<a href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPChannel.h">diff</a> |
<a href="/comm-central/comparison/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPChannel.h">comparison</a> |
<a href="/comm-central/log/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPChannel.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPProtocolHandler.cpp">directory/xpcom/base/src/nsLDAPProtocolHandler.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPProtocolHandler.cpp">diff</a> |
<a href="/comm-central/comparison/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPProtocolHandler.cpp">comparison</a> |
<a href="/comm-central/log/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPProtocolHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPProtocolHandler.h">directory/xpcom/base/src/nsLDAPProtocolHandler.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPProtocolHandler.h">diff</a> |
<a href="/comm-central/comparison/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPProtocolHandler.h">comparison</a> |
<a href="/comm-central/log/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPProtocolHandler.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPProtocolHandler.js">directory/xpcom/base/src/nsLDAPProtocolHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPProtocolHandler.js">file</a> |
<a href="/comm-central/annotate/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPProtocolHandler.js">annotate</a> |
<a href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPProtocolHandler.js">diff</a> |
<a href="/comm-central/comparison/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPProtocolHandler.js">comparison</a> |
<a href="/comm-central/log/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPProtocolHandler.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPProtocolModule.cpp">directory/xpcom/base/src/nsLDAPProtocolModule.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPProtocolModule.cpp">file</a> |
<a href="/comm-central/annotate/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPProtocolModule.cpp">annotate</a> |
<a href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPProtocolModule.cpp">diff</a> |
<a href="/comm-central/comparison/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPProtocolModule.cpp">comparison</a> |
<a href="/comm-central/log/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPProtocolModule.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPURL.cpp">directory/xpcom/base/src/nsLDAPURL.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPURL.cpp">file</a> |
<a href="/comm-central/annotate/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPURL.cpp">annotate</a> |
<a href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPURL.cpp">diff</a> |
<a href="/comm-central/comparison/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPURL.cpp">comparison</a> |
<a href="/comm-central/log/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPURL.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPURL.h">directory/xpcom/base/src/nsLDAPURL.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPURL.h">file</a> |
<a href="/comm-central/annotate/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPURL.h">annotate</a> |
<a href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPURL.h">diff</a> |
<a href="/comm-central/comparison/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPURL.h">comparison</a> |
<a href="/comm-central/log/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/base/src/nsLDAPURL.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/tests/Makefile.in">directory/xpcom/tests/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/tests/Makefile.in">file</a> |
<a href="/comm-central/annotate/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/tests/Makefile.in">annotate</a> |
<a href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/tests/Makefile.in">diff</a> |
<a href="/comm-central/comparison/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/tests/Makefile.in">comparison</a> |
<a href="/comm-central/log/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/tests/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/tests/jar.mn">directory/xpcom/tests/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/tests/jar.mn">file</a> |
<a href="/comm-central/annotate/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/tests/jar.mn">annotate</a> |
<a href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/tests/jar.mn">diff</a> |
<a href="/comm-central/comparison/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/tests/jar.mn">comparison</a> |
<a href="/comm-central/log/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/tests/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/tests/unit/test_nsLDAPURL.js">directory/xpcom/tests/unit/test_nsLDAPURL.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/tests/unit/test_nsLDAPURL.js">file</a> |
<a href="/comm-central/annotate/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/tests/unit/test_nsLDAPURL.js">annotate</a> |
<a href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/tests/unit/test_nsLDAPURL.js">diff</a> |
<a href="/comm-central/comparison/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/tests/unit/test_nsLDAPURL.js">comparison</a> |
<a href="/comm-central/log/f13a45c4f1f912730f5313bcef509dc25502c6d3/directory/xpcom/tests/unit/test_nsLDAPURL.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/prefs/resources/content/pref-directory-add.js">mailnews/addrbook/prefs/resources/content/pref-directory-add.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/prefs/resources/content/pref-directory-add.js">file</a> |
<a href="/comm-central/annotate/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/prefs/resources/content/pref-directory-add.js">annotate</a> |
<a href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/prefs/resources/content/pref-directory-add.js">diff</a> |
<a href="/comm-central/comparison/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/prefs/resources/content/pref-directory-add.js">comparison</a> |
<a href="/comm-central/log/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/prefs/resources/content/pref-directory-add.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/public/nsIAbLDAPAttributeMap.idl">mailnews/addrbook/public/nsIAbLDAPAttributeMap.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/public/nsIAbLDAPAttributeMap.idl">file</a> |
<a href="/comm-central/annotate/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/public/nsIAbLDAPAttributeMap.idl">annotate</a> |
<a href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/public/nsIAbLDAPAttributeMap.idl">diff</a> |
<a href="/comm-central/comparison/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/public/nsIAbLDAPAttributeMap.idl">comparison</a> |
<a href="/comm-central/log/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/public/nsIAbLDAPAttributeMap.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/src/Makefile.in">mailnews/addrbook/src/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/src/Makefile.in">file</a> |
<a href="/comm-central/annotate/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/src/Makefile.in">annotate</a> |
<a href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/src/Makefile.in">diff</a> |
<a href="/comm-central/comparison/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/src/Makefile.in">comparison</a> |
<a href="/comm-central/log/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/src/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/src/nsAbLDAPAttributeMap.js">mailnews/addrbook/src/nsAbLDAPAttributeMap.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/src/nsAbLDAPAttributeMap.js">file</a> |
<a href="/comm-central/annotate/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/src/nsAbLDAPAttributeMap.js">annotate</a> |
<a href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/src/nsAbLDAPAttributeMap.js">diff</a> |
<a href="/comm-central/comparison/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/src/nsAbLDAPAttributeMap.js">comparison</a> |
<a href="/comm-central/log/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/src/nsAbLDAPAttributeMap.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">mailnews/addrbook/src/nsAbLDAPDirectory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">file</a> |
<a href="/comm-central/annotate/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">annotate</a> |
<a href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">diff</a> |
<a href="/comm-central/comparison/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">comparison</a> |
<a href="/comm-central/log/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">file</a> |
<a href="/comm-central/annotate/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">annotate</a> |
<a href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">diff</a> |
<a href="/comm-central/comparison/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">comparison</a> |
<a href="/comm-central/log/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp">mailnews/addrbook/src/nsAbLDAPListenerBase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp">file</a> |
<a href="/comm-central/annotate/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp">annotate</a> |
<a href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp">diff</a> |
<a href="/comm-central/comparison/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp">comparison</a> |
<a href="/comm-central/log/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/test/unit/test_ldap1.js">mailnews/addrbook/test/unit/test_ldap1.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/test/unit/test_ldap1.js">file</a> |
<a href="/comm-central/annotate/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/test/unit/test_ldap1.js">annotate</a> |
<a href="/comm-central/diff/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/test/unit/test_ldap1.js">diff</a> |
<a href="/comm-central/comparison/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/test/unit/test_ldap1.js">comparison</a> |
<a href="/comm-central/log/f13a45c4f1f912730f5313bcef509dc25502c6d3/mailnews/addrbook/test/unit/test_ldap1.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/directory/xpcom/Makefile.in</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/directory/xpcom/Makefile.in</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -38,27 +38,24 @@</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> DEPTH		= ../..</span>
<a href="#l1.6"></a><span id="l1.6"> topsrcdir	= @top_srcdir@</span>
<a href="#l1.7"></a><span id="l1.7"> srcdir		= @srcdir@</span>
<a href="#l1.8"></a><span id="l1.8"> VPATH		= @srcdir@</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-# Note that for the time being &quot;tests&quot; require LDAP Experimental</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-#</span>
<a href="#l1.14"></a><span id="l1.14"> DIRS		= \</span>
<a href="#l1.15"></a><span id="l1.15"> 		base \</span>
<a href="#l1.16"></a><span id="l1.16"> 		$(NULL)</span>
<a href="#l1.17"></a><span id="l1.17"> </span>
<a href="#l1.18"></a><span id="l1.18"> ifdef MOZ_LDAP_XPCOM_EXPERIMENTAL</span>
<a href="#l1.19"></a><span id="l1.19"> DIRS		+= \</span>
<a href="#l1.20"></a><span id="l1.20"> 		datasource \</span>
<a href="#l1.21"></a><span id="l1.21"> 		$(NULL)</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+endif</span>
<a href="#l1.23"></a><span id="l1.23"> </span>
<a href="#l1.24"></a><span id="l1.24"> ifdef ENABLE_TESTS</span>
<a href="#l1.25"></a><span id="l1.25"> DIRS		+= \</span>
<a href="#l1.26"></a><span id="l1.26"> 		tests</span>
<a href="#l1.27"></a><span id="l1.27"> endif</span>
<a href="#l1.28"></a><span id="l1.28"> </span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-endif</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-</span>
<a href="#l1.31"></a><span id="l1.31"> include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/directory/xpcom/base/public/nsILDAPURL.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/directory/xpcom/base/public/nsILDAPURL.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -47,18 +47,43 @@</span>
<a href="#l2.4"></a><span id="l2.4"> /**</span>
<a href="#l2.5"></a><span id="l2.5">  * Strings in methods inherited from nsIURI, which are using XPIDL</span>
<a href="#l2.6"></a><span id="l2.6">  * |string| types, are expected to be UTF8 encoded. All such strings</span>
<a href="#l2.7"></a><span id="l2.7">  * in this interface, except attribute types (e.g. &quot;cn&quot;), should in fact</span>
<a href="#l2.8"></a><span id="l2.8">  * be UTF8. It's important to remember that attributes can not be UTF8,</span>
<a href="#l2.9"></a><span id="l2.9">  * they can only be of a limited subset of ASCII (see RFC 2251).</span>
<a href="#l2.10"></a><span id="l2.10">  */</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-[scriptable, uuid(7310562d-1567-43c7-a123-633c1ba3663e)]</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+[scriptable, uuid(1018ee06-f708-4bd7-b7df-11285332a404)]</span>
<a href="#l2.14"></a><span id="l2.14"> interface nsILDAPURL : nsIURI {</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+    /**</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+     * Initialize an LDAP URL</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+     *</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+     * @param aUrlType       - one of the URLTYPE_ flags @seealso nsIStandardURL</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+     * @param aDefaultPort   - if the port parsed from the URL string matches</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+     *                         this port, then the port will be removed from the</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+     *                         canonical form of the URL.</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+     * @param aSpec          - URL string.</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+     * @param aOriginCharset - the charset from which this URI string</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+     *                         originated.  this corresponds to the charset</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+     *                         that should be used when communicating this</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+     *                         URI to an origin server, for example.  if</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+     *                         null, then provide aBaseURI implements this</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+     *                         interface, the origin charset of aBaseURI will</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+     *                         be assumed, otherwise defaulting to UTF-8 (i.e.,</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+     *                         no charset transformation from aSpec).</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+     * @param aBaseURI       - if null, aSpec must specify an absolute URI.</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+     *                         otherwise, aSpec will be resolved relative</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+     *                         to aBaseURI.</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+     */</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+    void init(in unsigned long aUrlType,</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+              in long aDefaultPort,</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+              in AUTF8String aSpec,</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+              in string aOriginCharset,</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+              in nsIURI aBaseURI);</span>
<a href="#l2.40"></a><span id="l2.40"> </span>
<a href="#l2.41"></a><span id="l2.41">     /**</span>
<a href="#l2.42"></a><span id="l2.42">      * The distinguished name of the URL (ie the base DN for the search).</span>
<a href="#l2.43"></a><span id="l2.43">      * This string is expected to be a valid UTF8 string.</span>
<a href="#l2.44"></a><span id="l2.44">      *</span>
<a href="#l2.45"></a><span id="l2.45">      * for the getter:</span>
<a href="#l2.46"></a><span id="l2.46">      *</span>
<a href="#l2.47"></a><span id="l2.47">      * @exception NS_ERROR_NULL_POINTER     NULL pointer to GET method</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineat">@@ -146,10 +171,9 @@ interface nsILDAPURL : nsIURI {</span>
<a href="#l2.49"></a><span id="l2.49">      * @exception NS_ERROR_OUT_OF_MEMORY    Ran out of memory</span>
<a href="#l2.50"></a><span id="l2.50">      */</span>
<a href="#l2.51"></a><span id="l2.51">     attribute unsigned long options;</span>
<a href="#l2.52"></a><span id="l2.52"> </span>
<a href="#l2.53"></a><span id="l2.53">     /**</span>
<a href="#l2.54"></a><span id="l2.54">      * If this is set/true, this is an ldaps: URL, not an ldap: URL</span>
<a href="#l2.55"></a><span id="l2.55">      */</span>
<a href="#l2.56"></a><span id="l2.56">     const unsigned long OPT_SECURE = 0x01;</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-</span>
<a href="#l2.58"></a><span id="l2.58"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/directory/xpcom/base/src/Makefile.in</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/directory/xpcom/base/src/Makefile.in</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -51,30 +51,32 @@ IS_COMPONENT	= 1</span>
<a href="#l3.4"></a><span id="l3.4"> MODULE_NAME	= nsLDAPProtocolModule</span>
<a href="#l3.5"></a><span id="l3.5"> MOZILLA_INTERNAL_API = 1</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> REQUIRES	= xpcom \</span>
<a href="#l3.8"></a><span id="l3.8"> 		  string \</span>
<a href="#l3.9"></a><span id="l3.9"> 		  necko \</span>
<a href="#l3.10"></a><span id="l3.10"> 		  $(NULL)</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+EXTRA_PP_COMPONENTS = \</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+		nsLDAPProtocolHandler.js \</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+		$(NULL)</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16"> CPPSRCS		= \</span>
<a href="#l3.17"></a><span id="l3.17"> 		nsLDAPProtocolModule.cpp \</span>
<a href="#l3.18"></a><span id="l3.18"> 		nsLDAPMessage.cpp \</span>
<a href="#l3.19"></a><span id="l3.19"> 		nsLDAPConnection.cpp \</span>
<a href="#l3.20"></a><span id="l3.20"> 		nsLDAPOperation.cpp \</span>
<a href="#l3.21"></a><span id="l3.21"> 		nsLDAPURL.cpp \</span>
<a href="#l3.22"></a><span id="l3.22"> 		nsLDAPServer.cpp \</span>
<a href="#l3.23"></a><span id="l3.23"> 		nsLDAPService.cpp \</span>
<a href="#l3.24"></a><span id="l3.24"> 		nsLDAPBERValue.cpp \</span>
<a href="#l3.25"></a><span id="l3.25"> 		nsLDAPControl.cpp \</span>
<a href="#l3.26"></a><span id="l3.26"> 		nsLDAPBERElement.cpp \</span>
<a href="#l3.27"></a><span id="l3.27"> 		nsLDAPModification.cpp \</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-		nsLDAPProtocolHandler.cpp \</span>
<a href="#l3.29"></a><span id="l3.29"> 		$(NULL)</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31"> ifdef MOZ_LDAP_XPCOM_EXPERIMENTAL</span>
<a href="#l3.32"></a><span id="l3.32"> DEFINES		+= -DMOZ_LDAP_XPCOM_EXPERIMENTAL</span>
<a href="#l3.33"></a><span id="l3.33"> </span>
<a href="#l3.34"></a><span id="l3.34"> CPPSRCS		+= \</span>
<a href="#l3.35"></a><span id="l3.35"> 		nsLDAPChannel.cpp \</span>
<a href="#l3.36"></a><span id="l3.36"> 		$(NULL)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/directory/xpcom/base/src/nsLDAPChannel.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/directory/xpcom/base/src/nsLDAPChannel.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -57,16 +57,21 @@</span>
<a href="#l4.4"></a><span id="l4.4"> #include &quot;nsILDAPURL.h&quot;</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> // if the code related to the following #define ever gets removed, also</span>
<a href="#l4.7"></a><span id="l4.7"> // be sure to remove mCallback as well as the most (but not all) of the </span>
<a href="#l4.8"></a><span id="l4.8"> // various mUnproxied stuff</span>
<a href="#l4.9"></a><span id="l4.9"> //</span>
<a href="#l4.10"></a><span id="l4.10"> #define INVOKE_LDAP_CALLBACKS_ON_MAIN_THREAD 0</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+// {97cce72b-8ce9-466e-b21d-05da7c1e02a6}</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+#define NS_LDAPCHANNEL_CID \</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+  { 0x97cce72b, 0x8ce9, 0x466e, \</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+      { 0xb2, 0x1d, 0x05, 0xda, 0x7c, 0x1e, 0x02, 0xa6 } }</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+</span>
<a href="#l4.17"></a><span id="l4.17"> class nsLDAPChannel : public nsIChannel, public nsILDAPMessageListener</span>
<a href="#l4.18"></a><span id="l4.18"> {</span>
<a href="#l4.19"></a><span id="l4.19">   public:</span>
<a href="#l4.20"></a><span id="l4.20">     NS_DECL_ISUPPORTS</span>
<a href="#l4.21"></a><span id="l4.21">     NS_DECL_NSIREQUEST</span>
<a href="#l4.22"></a><span id="l4.22">     NS_DECL_NSICHANNEL</span>
<a href="#l4.23"></a><span id="l4.23">     NS_DECL_NSILDAPMESSAGELISTENER</span>
<a href="#l4.24"></a><span id="l4.24"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">deleted file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- a/directory/xpcom/base/src/nsLDAPProtocolHandler.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ /dev/null</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -1,155 +0,0 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineminus">- * </span>
<a href="#l5.7"></a><span id="l5.7" class="difflineminus">- * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineminus">- *</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">- *</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">- * License.</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">- *</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">- * The Original Code is the mozilla.org LDAP XPCOM SDK.</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">- *</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">- * Netscape Communications Corporation.</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 2000</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">- *</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">- * Contributor(s):</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">- *   Dan Mosedale &lt;dmose@mozilla.org&gt;</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">- *   Brian Ryner &lt;bryner@brianryner.com&gt;</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">- *</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">- * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">- * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">- *</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-#include &quot;nsLDAPProtocolHandler.h&quot;</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-#include &quot;nsCRT.h&quot;</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-#include &quot;nsIComponentManager.h&quot;</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-#include &quot;nsLDAPURL.h&quot;</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-#include &quot;nsLDAPChannel.h&quot;</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">-static NS_DEFINE_CID(kLDAPURLCID, NS_LDAPURL_CID);</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">-</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-// QueryInterface, AddRef, and Release</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-//</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-NS_IMPL_ISUPPORTS1(nsLDAPProtocolHandler, nsIProtocolHandler)</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-nsLDAPProtocolHandler::nsLDAPProtocolHandler()</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-{</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-}</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineminus">-nsLDAPProtocolHandler::~nsLDAPProtocolHandler()</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineminus">-{</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineminus">-}</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">-</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-// nsIProtocolHandler methods</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineminus">-</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineminus">-// getter method for scheme attr</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineminus">-//</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineminus">-nsLDAPProtocolHandler::GetScheme(nsACString &amp;result)</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineminus">-{</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">-  result = &quot;ldap&quot;;</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">-  return NS_OK;</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineminus">-}</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineminus">-</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineminus">-// getter method for defaultPort attribute</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineminus">-//</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineminus">-nsLDAPProtocolHandler::GetDefaultPort(PRInt32 *result)</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineminus">-{</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineminus">-  *result = 389;</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineminus">-  return NS_OK;</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineminus">-}</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineminus">-</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineminus">-// getter method for protocol flags attribute</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineminus">-//</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineminus">-nsLDAPProtocolHandler::GetProtocolFlags(PRUint32 *result)</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineminus">-{</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineminus">-  *result = URI_NORELATIVE | URI_DANGEROUS_TO_LOAD;</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineminus">-  return NS_OK;</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineminus">-}</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineminus">-</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineminus">-// construct an appropriate URI</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineminus">-//</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineminus">-nsLDAPProtocolHandler::NewURI(const nsACString &amp;aSpec,</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineminus">-                              const char *aOriginCharset, // ignored</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">-                              nsIURI *aBaseURI,</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineminus">-                              nsIURI **result) </span>
<a href="#l5.101"></a><span id="l5.101" class="difflineminus">-{</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineminus">-    nsCOMPtr&lt;nsILDAPURL&gt; url;</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineminus">-    nsresult rv;</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineminus">-</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineminus">-    url = do_CreateInstance(kLDAPURLCID, &amp;rv);</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineminus">-</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineminus">-    // XXX - better error handling</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineminus">-    //</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineminus">-    rv = url-&gt;SetSpec(aSpec);</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineminus">-</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineminus">-    // this is a getter, so we need to AddRef on the way out</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineminus">-    //</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineminus">-    *result = url;</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineminus">-    NS_ADDREF(*result);</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineminus">-</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineminus">-}</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineminus">-</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineminus">-nsLDAPProtocolHandler::NewChannel(nsIURI* uri, </span>
<a href="#l5.123"></a><span id="l5.123" class="difflineminus">-                                  nsIChannel* *result)</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineminus">-{</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineminus">-#ifdef MOZ_LDAP_XPCOM_EXPERIMENTAL</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineminus">-    NS_ENSURE_ARG_POINTER(uri);</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineminus">-    nsresult rv;</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineminus">-    nsLDAPChannel *channel;</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineminus">-</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineminus">-    rv = nsLDAPChannel::Create(0, NS_GET_IID(nsIChannel),</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineminus">-                               reinterpret_cast&lt;void **&gt;(&amp;channel));</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineminus">-  </span>
<a href="#l5.134"></a><span id="l5.134" class="difflineminus">-    rv = channel-&gt;Init(uri);</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineminus">-        NS_RELEASE(channel);</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineminus">-        return rv;</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineminus">-    }</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineminus">-    // the channel was already AddRefed for us, and since this function itself</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineminus">-    // is a getter, there's no need to release it here.</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineminus">-    //</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineminus">-    *result = channel;</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineminus">-</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineminus">-#else</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineminus">-#endif</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineminus">-}</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineminus">-</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l5.151"></a><span id="l5.151" class="difflineminus">-nsLDAPProtocolHandler::AllowPort(PRInt32 port, const char *scheme, PRBool *_retval)</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineminus">-{</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineminus">-    if (port == 389 || port == 636)  // 636 is LDAP/SSL</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineminus">-        *_retval = PR_TRUE;</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineminus">-    else</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineminus">-        *_retval = PR_FALSE;</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineminus">-}</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">deleted file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- a/directory/xpcom/base/src/nsLDAPProtocolHandler.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ /dev/null</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -1,61 +0,0 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineminus">- * </span>
<a href="#l6.7"></a><span id="l6.7" class="difflineminus">- * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineminus">- *</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">- *</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">- * License.</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">- *</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">- * The Original Code is the mozilla.org LDAP XPCOM SDK.</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">- *</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">- * Netscape Communications Corporation.</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 2000</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">- *</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">- * Contributor(s):</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">- *   Dan Mosedale &lt;dmose@mozilla.org&gt;</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">- *</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">- * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">- * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">- *</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-#ifndef nsLDAPProtocolHandler_h__</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-#define nsLDAPProtocolHandler_h__</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-#include &quot;nsIProtocolHandler.h&quot;</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-// 9817dcda-8a67-4c30-b96f-ec4e647b0043 </span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-#define NS_LDAPPROTOCOLHANDLER_CID \</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-{ 0x9817dcda, 0x8a67, 0x4c30, \</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-  {0xb9, 0x6f, 0xec, 0x4e, 0x64, 0x7b, 0x00, 0x43} \</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-} </span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-class nsLDAPProtocolHandler : public nsIProtocolHandler</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-{</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-  public:</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-    NS_DECL_NSIPROTOCOLHANDLER</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-    nsLDAPProtocolHandler();</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-    virtual ~nsLDAPProtocolHandler();</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-};</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineminus">-</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-#endif // nsLDAPProtocolHandler_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/directory/xpcom/base/src/nsLDAPProtocolHandler.js</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,100 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+ *</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+ *</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+ * License.</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+ *</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+ * The Original Code is LDAP Protocol Handler.</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+ *</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+ * Mozilla Messaging.</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+ *</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+ *   Mark Banner &lt;bugzilla@standard8.plus.com&gt;</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+ *</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+ *</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+const kNetworkProtocolCIDPrefix = &quot;@mozilla.org/network/protocol;1?name=&quot;;</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+const nsIProtocolHandler = Components.interfaces.nsIProtocolHandler;</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+function makeProtocolHandler(aProtocol, aDefaultPort) {</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+  return {</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+    classDescription: &quot;LDAP Protocol Handler&quot;,</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+    contractID: kNetworkProtocolCIDPrefix + aProtocol,</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+    classID: Components.ID(&quot;{b3de9249-b0e5-4c12-8d91-c9a434fd80f5}&quot;),</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+    QueryInterface: XPCOMUtils.generateQI([nsIProtocolHandler]),</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+    scheme: aProtocol,</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+    defaultPort: aDefaultPort,</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+    protocolFlags: nsIProtocolHandler.URI_NORELATIVE |</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+                   nsIProtocolHandler.URI_DANGEROUS_TO_LOAD |</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+                   nsIProtocolHandler.ALLOWS_PROXY,</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+    newURI: function (aSpec, aOriginCharset, aBaseURI) {</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+      var url = Components.classes[&quot;@mozilla.org/network/ldap-url;1&quot;]</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+                          .createInstance(Components.interfaces.nsIURI);</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+      if (url instanceof Components.interfaces.nsILDAPURL)</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+#ifdef USE_TK_LOGIN_MANAGER</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+	url.init(Components.interfaces.nsIStandardURL.URLTYPE_STANDARD,</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+		 aDefaultPort, aSpec, aOriginCharset, aBaseURI);</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+#else</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+	url.init(Components.interfaces.nsIStandardURL.URLTYPE_STANDARD,</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+		 -1, aSpec, aOriginCharset, aBaseURI);</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+#endif</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+      return url;</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+    },</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+    newChannel: function (aURI) {</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+      if (&quot;@mozilla.org/network/ldap-channel;1&quot; in Components.classes) {</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+        var channel = Components.classes[&quot;@mozilla.org/network/ldap-channel;1&quot;]</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+                                .createInstance(Components.interfaces.nsIChannel);</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+        channel.init(aURI);</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+        return channel;</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+      }</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+      throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+    },</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+    allowPort: function (port, scheme) {</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+      return port == aDefaultPort;</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+    }</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+  };</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+}</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+function nsLDAPProtocolHandler() {}</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+nsLDAPProtocolHandler.prototype = makeProtocolHandler(&quot;ldap&quot;, 389);</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+function nsLDAPSProtocolHandler() {}</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+nsLDAPSProtocolHandler.prototype = makeProtocolHandler(&quot;ldaps&quot;, 636);</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+function NSGetModule(compMgr, fileSpec) {</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+  return XPCOMUtils.generateModule([nsLDAPProtocolHandler,</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+                                    nsLDAPSProtocolHandler]);</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/directory/xpcom/base/src/nsLDAPProtocolModule.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/directory/xpcom/base/src/nsLDAPProtocolModule.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -47,37 +47,38 @@</span>
<a href="#l8.4"></a><span id="l8.4"> #include &quot;nsLDAPOperation.h&quot;</span>
<a href="#l8.5"></a><span id="l8.5"> #include &quot;nsLDAPMessage.h&quot;</span>
<a href="#l8.6"></a><span id="l8.6"> #include &quot;nsLDAPModification.h&quot;</span>
<a href="#l8.7"></a><span id="l8.7"> #include &quot;nsLDAPServer.h&quot;</span>
<a href="#l8.8"></a><span id="l8.8"> #include &quot;nsLDAPService.h&quot;</span>
<a href="#l8.9"></a><span id="l8.9"> #include &quot;nsLDAPBERValue.h&quot;</span>
<a href="#l8.10"></a><span id="l8.10"> #include &quot;nsLDAPBERElement.h&quot;</span>
<a href="#l8.11"></a><span id="l8.11"> #include &quot;nsLDAPControl.h&quot;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-#include &quot;nsLDAPProtocolHandler.h&quot;</span>
<a href="#l8.13"></a><span id="l8.13"> </span>
<a href="#l8.14"></a><span id="l8.14"> #include &quot;ldappr.h&quot;</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16"> #ifdef MOZ_LDAP_XPCOM_EXPERIMENTAL</span>
<a href="#l8.17"></a><span id="l8.17"> #include &quot;nsLDAPChannel.h&quot;</span>
<a href="#l8.18"></a><span id="l8.18"> #endif</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20"> // use the default constructor</span>
<a href="#l8.21"></a><span id="l8.21"> //</span>
<a href="#l8.22"></a><span id="l8.22"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsLDAPConnection)</span>
<a href="#l8.23"></a><span id="l8.23"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsLDAPOperation)</span>
<a href="#l8.24"></a><span id="l8.24"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsLDAPMessage)</span>
<a href="#l8.25"></a><span id="l8.25"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsLDAPModification, Init)</span>
<a href="#l8.26"></a><span id="l8.26"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsLDAPServer)</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsLDAPURL, Init)</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+NS_GENERIC_FACTORY_CONSTRUCTOR(nsLDAPURL)</span>
<a href="#l8.29"></a><span id="l8.29"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsLDAPService, Init)</span>
<a href="#l8.30"></a><span id="l8.30"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsLDAPBERValue)</span>
<a href="#l8.31"></a><span id="l8.31"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsLDAPBERElement)</span>
<a href="#l8.32"></a><span id="l8.32"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsLDAPControl)</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-NS_GENERIC_FACTORY_CONSTRUCTOR(nsLDAPProtocolHandler)</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+#ifdef MOZ_LDAP_XPCOM_EXPERIMENTAL</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+NS_GENERIC_FACTORY_CONSTRUCTOR(nsLDAPChannel)</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+#endif</span>
<a href="#l8.37"></a><span id="l8.37"> </span>
<a href="#l8.38"></a><span id="l8.38"> NS_DECL_CLASSINFO(nsLDAPMessage)</span>
<a href="#l8.39"></a><span id="l8.39"> NS_DECL_CLASSINFO(nsLDAPOperation)</span>
<a href="#l8.40"></a><span id="l8.40"> NS_DECL_CLASSINFO(nsLDAPConnection)</span>
<a href="#l8.41"></a><span id="l8.41"> </span>
<a href="#l8.42"></a><span id="l8.42"> // a table of the CIDs implemented by this module</span>
<a href="#l8.43"></a><span id="l8.43"> //</span>
<a href="#l8.44"></a><span id="l8.44"> static const nsModuleComponentInfo components[] =</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineat">@@ -110,25 +111,26 @@ static const nsModuleComponentInfo compo</span>
<a href="#l8.46"></a><span id="l8.46">       &amp;NS_CLASSINFO_NAME(nsLDAPMessage),</span>
<a href="#l8.47"></a><span id="l8.47">       nsIClassInfo::THREADSAFE },</span>
<a href="#l8.48"></a><span id="l8.48">     { &quot;LDAP Modification&quot;, NS_LDAPMODIFICATION_CID,</span>
<a href="#l8.49"></a><span id="l8.49">           &quot;@mozilla.org/network/ldap-modification;1&quot;, nsLDAPModificationConstructor },</span>
<a href="#l8.50"></a><span id="l8.50">     { &quot;LDAP Server&quot;, NS_LDAPSERVER_CID,</span>
<a href="#l8.51"></a><span id="l8.51">           &quot;@mozilla.org/network/ldap-server;1&quot;, nsLDAPServerConstructor },</span>
<a href="#l8.52"></a><span id="l8.52">     { &quot;LDAP Service&quot;, NS_LDAPSERVICE_CID,</span>
<a href="#l8.53"></a><span id="l8.53">           &quot;@mozilla.org/network/ldap-service;1&quot;, nsLDAPServiceConstructor },</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-    { &quot;LDAP Protocol Handler&quot;, NS_LDAPPROTOCOLHANDLER_CID, </span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-          NS_NETWORK_PROTOCOL_CONTRACTID_PREFIX &quot;ldap&quot;, </span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-          nsLDAPProtocolHandlerConstructor },   </span>
<a href="#l8.57"></a><span id="l8.57">     { &quot;LDAP URL&quot;, NS_LDAPURL_CID,</span>
<a href="#l8.58"></a><span id="l8.58">           &quot;@mozilla.org/network/ldap-url;1&quot;, nsLDAPURLConstructor },</span>
<a href="#l8.59"></a><span id="l8.59">     { &quot;LDAP BER Value&quot;, NS_LDAPBERVALUE_CID,</span>
<a href="#l8.60"></a><span id="l8.60">       &quot;@mozilla.org/network/ldap-ber-value;1&quot;, nsLDAPBERValueConstructor },</span>
<a href="#l8.61"></a><span id="l8.61">     { &quot;LDAP BER Element&quot;, NS_LDAPBERELEMENT_CID,</span>
<a href="#l8.62"></a><span id="l8.62">       &quot;@mozilla.org/network/ldap-ber-element;1&quot;, nsLDAPBERElementConstructor },</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+#ifdef MOZ_LDAP_XPCOM_EXPERIMENTAL</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+    { &quot;LDAP Channel&quot;, NS_LDAPCHANNEL_CID,</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+      &quot;@mozilla.org/network/ldap-channel;1&quot;, nsLDAPChannelConstructor },</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+#endif</span>
<a href="#l8.67"></a><span id="l8.67">     { &quot;LDAP Control&quot;, NS_LDAPCONTROL_CID,</span>
<a href="#l8.68"></a><span id="l8.68">       &quot;@mozilla.org/network/ldap-control;1&quot;, nsLDAPControlConstructor}</span>
<a href="#l8.69"></a><span id="l8.69"> };</span>
<a href="#l8.70"></a><span id="l8.70"> </span>
<a href="#l8.71"></a><span id="l8.71"> static nsresult</span>
<a href="#l8.72"></a><span id="l8.72"> nsLDAPInitialize(nsIModule *aSelf)</span>
<a href="#l8.73"></a><span id="l8.73"> {</span>
<a href="#l8.74"></a><span id="l8.74"> #ifdef PR_LOGGING</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/directory/xpcom/base/src/nsLDAPURL.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/directory/xpcom/base/src/nsLDAPURL.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -38,339 +38,367 @@</span>
<a href="#l9.4"></a><span id="l9.4">  *</span>
<a href="#l9.5"></a><span id="l9.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l9.6"></a><span id="l9.6"> </span>
<a href="#l9.7"></a><span id="l9.7"> #include &quot;nsLDAPURL.h&quot;</span>
<a href="#l9.8"></a><span id="l9.8"> #include &quot;nsReadableUtils.h&quot;</span>
<a href="#l9.9"></a><span id="l9.9"> #include &quot;netCore.h&quot;</span>
<a href="#l9.10"></a><span id="l9.10"> #include &quot;plstr.h&quot;</span>
<a href="#l9.11"></a><span id="l9.11"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+#include &quot;nsNetCID.h&quot;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+#include &quot;nsIStandardURL.h&quot;</span>
<a href="#l9.15"></a><span id="l9.15"> </span>
<a href="#l9.16"></a><span id="l9.16"> // The two schemes we support, LDAP and LDAPS</span>
<a href="#l9.17"></a><span id="l9.17"> //</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-static const char kLDAPScheme[] = &quot;ldap&quot;;</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-static const char kLDAPSSLScheme[] = &quot;ldaps&quot;;</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+NS_NAMED_LITERAL_CSTRING(LDAP_SCHEME, &quot;ldap&quot;);</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+NS_NAMED_LITERAL_CSTRING(LDAP_SSL_SCHEME, &quot;ldaps&quot;);</span>
<a href="#l9.22"></a><span id="l9.22"> </span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-// Constructor and destructor</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-//</span>
<a href="#l9.25"></a><span id="l9.25"> NS_IMPL_THREADSAFE_ISUPPORTS2(nsLDAPURL, nsILDAPURL, nsIURI)</span>
<a href="#l9.26"></a><span id="l9.26"> </span>
<a href="#l9.27"></a><span id="l9.27"> nsLDAPURL::nsLDAPURL()</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-    : mPort(0),</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-      mScope(SCOPE_BASE),</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-      mOptions(0),</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-      mAttributes(0)</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+    : mScope(SCOPE_BASE),</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+      mOptions(0)</span>
<a href="#l9.34"></a><span id="l9.34"> {</span>
<a href="#l9.35"></a><span id="l9.35"> }</span>
<a href="#l9.36"></a><span id="l9.36"> </span>
<a href="#l9.37"></a><span id="l9.37"> nsLDAPURL::~nsLDAPURL()</span>
<a href="#l9.38"></a><span id="l9.38"> {</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-    // Delete the array of attributes</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-    delete mAttributes;</span>
<a href="#l9.41"></a><span id="l9.41"> }</span>
<a href="#l9.42"></a><span id="l9.42"> </span>
<a href="#l9.43"></a><span id="l9.43"> nsresult</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-nsLDAPURL::Init()</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+nsLDAPURL::Init(PRUint32 aUrlType, PRInt32 aDefaultPort,</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+                const nsACString &amp;aSpec, const char* aOriginCharset,</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+                nsIURI *aBaseURI)</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+{</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+  if (!mBaseURL)</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+  {</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+    mBaseURL = do_CreateInstance(NS_STANDARDURL_CONTRACTID);</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+    if (!mBaseURL)</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+  }</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+  nsresult rv;</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+  nsCOMPtr&lt;nsIStandardURL&gt; standardURL(do_QueryInterface(mBaseURL, &amp;rv));</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+  rv = standardURL-&gt;Init(aUrlType, aDefaultPort, aSpec, aOriginCharset,</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+                         aBaseURI);</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+  // Now get the spec from the mBaseURL in case it was a relative one</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+  nsCString spec;</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+  rv = mBaseURL-&gt;GetSpec(spec);</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+  return SetSpec(spec);</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+}</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+void</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+nsLDAPURL::GetPathInternal(nsCString &amp;aPath)</span>
<a href="#l9.74"></a><span id="l9.74"> {</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-    if (!mAttributes) {</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-        mAttributes = new nsCStringArray();</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-        if (!mAttributes) {</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineminus">-            NS_ERROR(&quot;nsLDAPURL::Init: out of memory &quot;);</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineminus">-            return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineminus">-        }</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+  aPath.Assign('/');</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+  if (!mDN.IsEmpty())</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+    aPath.Append(mDN);</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+  PRUint32 count = mAttributes.Count();</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+  if (count)</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineplus">+  {</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineplus">+    aPath.Append('?');</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+    PRUint32 index = 0;</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineplus">+    while (index &lt; count)</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineplus">+    {</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineplus">+      aPath.Append(*(mAttributes.CStringAt(index++)));</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineplus">+      if (index &lt; count)</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+        aPath.Append(',');</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+    }</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+  }</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineplus">+</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineplus">+  if (mScope || !mFilter.IsEmpty())</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineplus">+  {</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineplus">+    aPath.Append((count ? &quot;?&quot; : &quot;??&quot;));</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineplus">+    if (mScope)</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineplus">+    {</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineplus">+      if (mScope == SCOPE_ONELEVEL)</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineplus">+        aPath.Append(&quot;one&quot;);</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineplus">+      else if (mScope == SCOPE_SUBTREE)</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineplus">+        aPath.Append(&quot;sub&quot;);</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineplus">+    }</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineplus">+    if (!mFilter.IsEmpty())</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineplus">+    {</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineplus">+      aPath.Append('?');</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineplus">+      aPath.Append(mFilter);</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineplus">+    }</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineplus">+  }</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineplus">+}</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineplus">+nsresult</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineplus">+nsLDAPURL::SetPathInternal(const nsCString &amp;aPath)</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineplus">+{</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineplus">+  PRUint32 rv, count;</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineplus">+  LDAPURLDesc *desc;</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineplus">+  nsCString str;</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+  char **attributes;</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineplus">+</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineplus">+  // This is from the LDAP C-SDK, which currently doesn't</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineplus">+  // support everything from RFC 2255... :(</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineplus">+  //</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineplus">+  rv = ldap_url_parse(aPath.get(), &amp;desc);</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineplus">+  switch (rv) {</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineplus">+  case LDAP_SUCCESS:</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineplus">+    // The base URL can pick up the host &amp; port details and deal with them</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineplus">+    // better than we can</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineplus">+    mDN = desc-&gt;lud_dn;</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineplus">+    mScope = desc-&gt;lud_scope;</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineplus">+    mFilter = desc-&gt;lud_filter;</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineplus">+    mOptions = desc-&gt;lud_options;</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineplus">+</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineplus">+    // Set the attributes array, need to count it first.</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineplus">+    //</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineplus">+    count = 0;</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineplus">+    attributes = desc-&gt;lud_attrs;</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineplus">+    while (attributes &amp;&amp; *attributes++)</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineplus">+      count++;</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineplus">+</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineplus">+    if (count) {</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineplus">+      rv = SetAttributes(count, const_cast&lt;const char **&gt;(desc-&gt;lud_attrs));</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineplus">+      // This error could only be out-of-memory, so pass it up</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineplus">+      //</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineplus">+      if (NS_FAILED(rv)) {</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineplus">+        return rv;</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineplus">+      }</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineplus">+    } else {</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineplus">+      mAttributes.Clear();</span>
<a href="#l9.155"></a><span id="l9.155">     }</span>
<a href="#l9.156"></a><span id="l9.156"> </span>
<a href="#l9.157"></a><span id="l9.157" class="difflineplus">+    ldap_free_urldesc(desc);</span>
<a href="#l9.158"></a><span id="l9.158">     return NS_OK;</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineplus">+</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineplus">+  case LDAP_URL_ERR_NOTLDAP:</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineplus">+  case LDAP_URL_ERR_NODN:</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineplus">+  case LDAP_URL_ERR_BADSCOPE:</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineplus">+    return NS_ERROR_MALFORMED_URI;</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineplus">+</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineplus">+  case LDAP_URL_ERR_MEM:</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineplus">+    NS_ERROR(&quot;nsLDAPURL::SetSpec: out of memory &quot;);</span>
<a href="#l9.167"></a><span id="l9.167" class="difflineplus">+    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineplus">+</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineplus">+  case LDAP_URL_ERR_PARAM: </span>
<a href="#l9.170"></a><span id="l9.170" class="difflineplus">+    return NS_ERROR_INVALID_POINTER;</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineplus">+  }</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineplus">+</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineplus">+  // This shouldn't happen...</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineplus">+  return NS_ERROR_UNEXPECTED;</span>
<a href="#l9.175"></a><span id="l9.175"> }</span>
<a href="#l9.176"></a><span id="l9.176"> </span>
<a href="#l9.177"></a><span id="l9.177"> // A string representation of the URI. Setting the spec </span>
<a href="#l9.178"></a><span id="l9.178"> // causes the new spec to be parsed, initializing the URI. Setting</span>
<a href="#l9.179"></a><span id="l9.179"> // the spec (or any of the accessors) causes also any currently</span>
<a href="#l9.180"></a><span id="l9.180"> // open streams on the URI's channel to be closed.</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineminus">-//</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineminus">-// attribute string spec;</span>
<a href="#l9.183"></a><span id="l9.183" class="difflineminus">-//</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineplus">+</span>
<a href="#l9.185"></a><span id="l9.185"> NS_IMETHODIMP </span>
<a href="#l9.186"></a><span id="l9.186"> nsLDAPURL::GetSpec(nsACString &amp;_retval)</span>
<a href="#l9.187"></a><span id="l9.187"> {</span>
<a href="#l9.188"></a><span id="l9.188" class="difflineminus">-    nsCAutoString spec;</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineminus">-    PRUint32 count;</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineminus">-    </span>
<a href="#l9.191"></a><span id="l9.191" class="difflineminus">-    spec = ((mOptions &amp; OPT_SECURE) ? kLDAPSSLScheme : kLDAPScheme);</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineminus">-    spec.Append(&quot;://&quot;);</span>
<a href="#l9.193"></a><span id="l9.193" class="difflineminus">-    if (!mHost.IsEmpty()) {</span>
<a href="#l9.194"></a><span id="l9.194" class="difflineminus">-        spec.Append(mHost);</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineminus">-    }</span>
<a href="#l9.196"></a><span id="l9.196" class="difflineminus">-    if (mPort &gt; 0) {</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineminus">-        spec.Append(':');</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineminus">-        spec.AppendInt(mPort);</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineminus">-    }</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineminus">-    spec.Append('/');</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineminus">-    if (!mDN.IsEmpty()) {</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineminus">-        spec.Append(mDN);</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineminus">-    }</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineminus">-</span>
<a href="#l9.205"></a><span id="l9.205" class="difflineminus">-    if ((count = mAttributes-&gt;Count())) {</span>
<a href="#l9.206"></a><span id="l9.206" class="difflineminus">-        PRUint32 index = 0;</span>
<a href="#l9.207"></a><span id="l9.207" class="difflineplus">+  if (!mBaseURL)</span>
<a href="#l9.208"></a><span id="l9.208" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.209"></a><span id="l9.209"> </span>
<a href="#l9.210"></a><span id="l9.210" class="difflineminus">-        spec.Append('?');</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineminus">-        while (index &lt; count) {</span>
<a href="#l9.212"></a><span id="l9.212" class="difflineminus">-            spec.Append(*(mAttributes-&gt;CStringAt(index++)));</span>
<a href="#l9.213"></a><span id="l9.213" class="difflineminus">-            if (index &lt; count) {</span>
<a href="#l9.214"></a><span id="l9.214" class="difflineminus">-                spec.Append(',');</span>
<a href="#l9.215"></a><span id="l9.215" class="difflineminus">-            }</span>
<a href="#l9.216"></a><span id="l9.216" class="difflineminus">-        }</span>
<a href="#l9.217"></a><span id="l9.217" class="difflineminus">-    }</span>
<a href="#l9.218"></a><span id="l9.218" class="difflineplus">+  return mBaseURL-&gt;GetSpec(_retval);</span>
<a href="#l9.219"></a><span id="l9.219" class="difflineplus">+}</span>
<a href="#l9.220"></a><span id="l9.220"> </span>
<a href="#l9.221"></a><span id="l9.221" class="difflineminus">-    if (mScope || !mFilter.IsEmpty()) {</span>
<a href="#l9.222"></a><span id="l9.222" class="difflineminus">-        spec.Append((count ? &quot;?&quot; : &quot;??&quot;));</span>
<a href="#l9.223"></a><span id="l9.223" class="difflineminus">-        if (mScope) {</span>
<a href="#l9.224"></a><span id="l9.224" class="difflineminus">-            if (mScope == SCOPE_ONELEVEL) {</span>
<a href="#l9.225"></a><span id="l9.225" class="difflineminus">-                spec.Append(&quot;one&quot;);</span>
<a href="#l9.226"></a><span id="l9.226" class="difflineminus">-            } else if (mScope == SCOPE_SUBTREE) {</span>
<a href="#l9.227"></a><span id="l9.227" class="difflineminus">-                spec.Append(&quot;sub&quot;);</span>
<a href="#l9.228"></a><span id="l9.228" class="difflineminus">-            }</span>
<a href="#l9.229"></a><span id="l9.229" class="difflineminus">-        }</span>
<a href="#l9.230"></a><span id="l9.230" class="difflineminus">-        if (!mFilter.IsEmpty()) {</span>
<a href="#l9.231"></a><span id="l9.231" class="difflineminus">-            spec.Append('?');</span>
<a href="#l9.232"></a><span id="l9.232" class="difflineminus">-            spec.Append(mFilter);</span>
<a href="#l9.233"></a><span id="l9.233" class="difflineminus">-        }</span>
<a href="#l9.234"></a><span id="l9.234" class="difflineminus">-    }</span>
<a href="#l9.235"></a><span id="l9.235" class="difflineminus">-</span>
<a href="#l9.236"></a><span id="l9.236" class="difflineminus">-    _retval = spec;</span>
<a href="#l9.237"></a><span id="l9.237" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.238"></a><span id="l9.238" class="difflineminus">-}</span>
<a href="#l9.239"></a><span id="l9.239"> NS_IMETHODIMP </span>
<a href="#l9.240"></a><span id="l9.240"> nsLDAPURL::SetSpec(const nsACString &amp;aSpec)</span>
<a href="#l9.241"></a><span id="l9.241"> {</span>
<a href="#l9.242"></a><span id="l9.242" class="difflineminus">-    PRUint32 rv, count;</span>
<a href="#l9.243"></a><span id="l9.243" class="difflineminus">-    LDAPURLDesc *desc;</span>
<a href="#l9.244"></a><span id="l9.244" class="difflineminus">-    nsCString str;</span>
<a href="#l9.245"></a><span id="l9.245" class="difflineminus">-    char **attributes;</span>
<a href="#l9.246"></a><span id="l9.246" class="difflineplus">+  if (!mBaseURL)</span>
<a href="#l9.247"></a><span id="l9.247" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.248"></a><span id="l9.248"> </span>
<a href="#l9.249"></a><span id="l9.249" class="difflineminus">-    // This is from the LDAP C-SDK, which currently doesn't</span>
<a href="#l9.250"></a><span id="l9.250" class="difflineminus">-    // support everything from RFC 2255... :(</span>
<a href="#l9.251"></a><span id="l9.251" class="difflineminus">-    //</span>
<a href="#l9.252"></a><span id="l9.252" class="difflineminus">-    rv = ldap_url_parse(PromiseFlatCString(aSpec).get(), &amp;desc);</span>
<a href="#l9.253"></a><span id="l9.253" class="difflineminus">-    switch (rv) {</span>
<a href="#l9.254"></a><span id="l9.254" class="difflineminus">-    case LDAP_SUCCESS:</span>
<a href="#l9.255"></a><span id="l9.255" class="difflineminus">-        mHost = desc-&gt;lud_host;</span>
<a href="#l9.256"></a><span id="l9.256" class="difflineminus">-        mPort = desc-&gt;lud_port;</span>
<a href="#l9.257"></a><span id="l9.257" class="difflineminus">-        mDN = desc-&gt;lud_dn;</span>
<a href="#l9.258"></a><span id="l9.258" class="difflineminus">-        mScope = desc-&gt;lud_scope;</span>
<a href="#l9.259"></a><span id="l9.259" class="difflineminus">-        mFilter = desc-&gt;lud_filter;</span>
<a href="#l9.260"></a><span id="l9.260" class="difflineminus">-        mOptions = desc-&gt;lud_options;</span>
<a href="#l9.261"></a><span id="l9.261" class="difflineplus">+  // Cache the original spec in case we don't like what we've been passed and</span>
<a href="#l9.262"></a><span id="l9.262" class="difflineplus">+  // need to reset ourselves.</span>
<a href="#l9.263"></a><span id="l9.263" class="difflineplus">+  nsCString originalSpec;</span>
<a href="#l9.264"></a><span id="l9.264" class="difflineplus">+  nsresult rv = mBaseURL-&gt;GetSpec(originalSpec);</span>
<a href="#l9.265"></a><span id="l9.265" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.266"></a><span id="l9.266"> </span>
<a href="#l9.267"></a><span id="l9.267" class="difflineminus">-        // Set the attributes array, need to count it first.</span>
<a href="#l9.268"></a><span id="l9.268" class="difflineminus">-        //</span>
<a href="#l9.269"></a><span id="l9.269" class="difflineminus">-        count = 0;</span>
<a href="#l9.270"></a><span id="l9.270" class="difflineminus">-        attributes = desc-&gt;lud_attrs;</span>
<a href="#l9.271"></a><span id="l9.271" class="difflineminus">-        while (attributes &amp;&amp; *attributes++) {</span>
<a href="#l9.272"></a><span id="l9.272" class="difflineminus">-            count++;</span>
<a href="#l9.273"></a><span id="l9.273" class="difflineminus">-        }</span>
<a href="#l9.274"></a><span id="l9.274" class="difflineminus">-        if (count) {</span>
<a href="#l9.275"></a><span id="l9.275" class="difflineminus">-            rv = SetAttributes(count,</span>
<a href="#l9.276"></a><span id="l9.276" class="difflineminus">-                               const_cast&lt;const char **&gt;(desc-&gt;lud_attrs));</span>
<a href="#l9.277"></a><span id="l9.277" class="difflineminus">-            // This error could only be out-of-memory, so pass it up</span>
<a href="#l9.278"></a><span id="l9.278" class="difflineminus">-            //</span>
<a href="#l9.279"></a><span id="l9.279" class="difflineminus">-            if (NS_FAILED(rv)) {</span>
<a href="#l9.280"></a><span id="l9.280" class="difflineminus">-                return rv;</span>
<a href="#l9.281"></a><span id="l9.281" class="difflineminus">-            }</span>
<a href="#l9.282"></a><span id="l9.282" class="difflineminus">-        } else {</span>
<a href="#l9.283"></a><span id="l9.283" class="difflineminus">-            mAttributes-&gt;Clear();</span>
<a href="#l9.284"></a><span id="l9.284" class="difflineminus">-        }</span>
<a href="#l9.285"></a><span id="l9.285" class="difflineplus">+  rv = mBaseURL-&gt;SetSpec(aSpec);</span>
<a href="#l9.286"></a><span id="l9.286" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.287"></a><span id="l9.287"> </span>
<a href="#l9.288"></a><span id="l9.288" class="difflineminus">-        ldap_free_urldesc(desc);</span>
<a href="#l9.289"></a><span id="l9.289" class="difflineminus">-        return NS_OK;</span>
<a href="#l9.290"></a><span id="l9.290" class="difflineminus">-</span>
<a href="#l9.291"></a><span id="l9.291" class="difflineminus">-    case LDAP_URL_ERR_NOTLDAP:</span>
<a href="#l9.292"></a><span id="l9.292" class="difflineminus">-    case LDAP_URL_ERR_NODN:</span>
<a href="#l9.293"></a><span id="l9.293" class="difflineminus">-    case LDAP_URL_ERR_BADSCOPE:</span>
<a href="#l9.294"></a><span id="l9.294" class="difflineminus">-        return NS_ERROR_MALFORMED_URI;</span>
<a href="#l9.295"></a><span id="l9.295" class="difflineplus">+  rv = SetPathInternal(nsPromiseFlatCString(aSpec));</span>
<a href="#l9.296"></a><span id="l9.296" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l9.297"></a><span id="l9.297" class="difflineplus">+    mBaseURL-&gt;SetSpec(originalSpec);</span>
<a href="#l9.298"></a><span id="l9.298"> </span>
<a href="#l9.299"></a><span id="l9.299" class="difflineminus">-    case LDAP_URL_ERR_MEM:</span>
<a href="#l9.300"></a><span id="l9.300" class="difflineminus">-        NS_ERROR(&quot;nsLDAPURL::SetSpec: out of memory &quot;);</span>
<a href="#l9.301"></a><span id="l9.301" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.302"></a><span id="l9.302" class="difflineminus">-</span>
<a href="#l9.303"></a><span id="l9.303" class="difflineminus">-    case LDAP_URL_ERR_PARAM: </span>
<a href="#l9.304"></a><span id="l9.304" class="difflineminus">-        return NS_ERROR_INVALID_POINTER;</span>
<a href="#l9.305"></a><span id="l9.305" class="difflineminus">-    }</span>
<a href="#l9.306"></a><span id="l9.306" class="difflineminus">-</span>
<a href="#l9.307"></a><span id="l9.307" class="difflineminus">-    // This shouldn't happen...</span>
<a href="#l9.308"></a><span id="l9.308" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l9.309"></a><span id="l9.309" class="difflineplus">+  return rv;</span>
<a href="#l9.310"></a><span id="l9.310"> }</span>
<a href="#l9.311"></a><span id="l9.311"> </span>
<a href="#l9.312"></a><span id="l9.312" class="difflineminus">-// attribute string prePath;</span>
<a href="#l9.313"></a><span id="l9.313" class="difflineminus">-//</span>
<a href="#l9.314"></a><span id="l9.314"> NS_IMETHODIMP nsLDAPURL::GetPrePath(nsACString &amp;_retval)</span>
<a href="#l9.315"></a><span id="l9.315"> {</span>
<a href="#l9.316"></a><span id="l9.316" class="difflineminus">-    _retval.Truncate();</span>
<a href="#l9.317"></a><span id="l9.317" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.318"></a><span id="l9.318" class="difflineplus">+  if (!mBaseURL)</span>
<a href="#l9.319"></a><span id="l9.319" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.320"></a><span id="l9.320" class="difflineplus">+</span>
<a href="#l9.321"></a><span id="l9.321" class="difflineplus">+  return mBaseURL-&gt;GetPrePath(_retval);</span>
<a href="#l9.322"></a><span id="l9.322"> }</span>
<a href="#l9.323"></a><span id="l9.323"> </span>
<a href="#l9.324"></a><span id="l9.324" class="difflineminus">-// attribute string scheme;</span>
<a href="#l9.325"></a><span id="l9.325" class="difflineminus">-//</span>
<a href="#l9.326"></a><span id="l9.326"> NS_IMETHODIMP nsLDAPURL::GetScheme(nsACString &amp;_retval)</span>
<a href="#l9.327"></a><span id="l9.327"> {</span>
<a href="#l9.328"></a><span id="l9.328" class="difflineminus">-    _retval = (mOptions &amp; OPT_SECURE) ? kLDAPSSLScheme : kLDAPScheme;</span>
<a href="#l9.329"></a><span id="l9.329" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.330"></a><span id="l9.330" class="difflineplus">+  if (!mBaseURL)</span>
<a href="#l9.331"></a><span id="l9.331" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.332"></a><span id="l9.332" class="difflineplus">+</span>
<a href="#l9.333"></a><span id="l9.333" class="difflineplus">+  return mBaseURL-&gt;GetScheme(_retval);</span>
<a href="#l9.334"></a><span id="l9.334"> }</span>
<a href="#l9.335"></a><span id="l9.335" class="difflineplus">+</span>
<a href="#l9.336"></a><span id="l9.336"> NS_IMETHODIMP nsLDAPURL::SetScheme(const nsACString &amp;aScheme)</span>
<a href="#l9.337"></a><span id="l9.337"> {</span>
<a href="#l9.338"></a><span id="l9.338" class="difflineminus">-    if (aScheme.Equals(kLDAPScheme, nsCaseInsensitiveCStringComparator())) {</span>
<a href="#l9.339"></a><span id="l9.339" class="difflineminus">-        mOptions ^= OPT_SECURE;</span>
<a href="#l9.340"></a><span id="l9.340" class="difflineminus">-    } else if (aScheme.Equals(kLDAPSSLScheme, nsCaseInsensitiveCStringComparator())) {</span>
<a href="#l9.341"></a><span id="l9.341" class="difflineminus">-        mOptions |= OPT_SECURE;</span>
<a href="#l9.342"></a><span id="l9.342" class="difflineminus">-    } else {</span>
<a href="#l9.343"></a><span id="l9.343" class="difflineminus">-        return NS_ERROR_MALFORMED_URI;</span>
<a href="#l9.344"></a><span id="l9.344" class="difflineminus">-    }</span>
<a href="#l9.345"></a><span id="l9.345" class="difflineplus">+  if (!mBaseURL)</span>
<a href="#l9.346"></a><span id="l9.346" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.347"></a><span id="l9.347"> </span>
<a href="#l9.348"></a><span id="l9.348" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.349"></a><span id="l9.349" class="difflineplus">+  if (aScheme.Equals(LDAP_SCHEME, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l9.350"></a><span id="l9.350" class="difflineplus">+    mOptions &amp;= !OPT_SECURE;</span>
<a href="#l9.351"></a><span id="l9.351" class="difflineplus">+  else if (aScheme.Equals(LDAP_SSL_SCHEME,</span>
<a href="#l9.352"></a><span id="l9.352" class="difflineplus">+                          nsCaseInsensitiveCStringComparator()))</span>
<a href="#l9.353"></a><span id="l9.353" class="difflineplus">+    mOptions |= OPT_SECURE;</span>
<a href="#l9.354"></a><span id="l9.354" class="difflineplus">+  else</span>
<a href="#l9.355"></a><span id="l9.355" class="difflineplus">+    return NS_ERROR_MALFORMED_URI;</span>
<a href="#l9.356"></a><span id="l9.356" class="difflineplus">+</span>
<a href="#l9.357"></a><span id="l9.357" class="difflineplus">+  return mBaseURL-&gt;SetScheme(aScheme);</span>
<a href="#l9.358"></a><span id="l9.358"> }</span>
<a href="#l9.359"></a><span id="l9.359"> </span>
<a href="#l9.360"></a><span id="l9.360" class="difflineminus">-// attribute string userPass;</span>
<a href="#l9.361"></a><span id="l9.361" class="difflineminus">-//</span>
<a href="#l9.362"></a><span id="l9.362"> NS_IMETHODIMP </span>
<a href="#l9.363"></a><span id="l9.363"> nsLDAPURL::GetUserPass(nsACString &amp;_retval)</span>
<a href="#l9.364"></a><span id="l9.364"> {</span>
<a href="#l9.365"></a><span id="l9.365" class="difflineminus">-    _retval.Truncate();</span>
<a href="#l9.366"></a><span id="l9.366" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.367"></a><span id="l9.367" class="difflineminus">-}</span>
<a href="#l9.368"></a><span id="l9.368" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l9.369"></a><span id="l9.369" class="difflineminus">-nsLDAPURL::SetUserPass(const nsACString &amp;aPreHost)</span>
<a href="#l9.370"></a><span id="l9.370" class="difflineminus">-{</span>
<a href="#l9.371"></a><span id="l9.371" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l9.372"></a><span id="l9.372" class="difflineplus">+  _retval.Truncate();</span>
<a href="#l9.373"></a><span id="l9.373" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.374"></a><span id="l9.374"> }</span>
<a href="#l9.375"></a><span id="l9.375"> </span>
<a href="#l9.376"></a><span id="l9.376" class="difflineminus">-// attribute string username</span>
<a href="#l9.377"></a><span id="l9.377" class="difflineminus">-//</span>
<a href="#l9.378"></a><span id="l9.378" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l9.379"></a><span id="l9.379" class="difflineplus">+nsLDAPURL::SetUserPass(const nsACString &amp;aUserPass)</span>
<a href="#l9.380"></a><span id="l9.380" class="difflineplus">+{</span>
<a href="#l9.381"></a><span id="l9.381" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.382"></a><span id="l9.382" class="difflineplus">+}</span>
<a href="#l9.383"></a><span id="l9.383" class="difflineplus">+</span>
<a href="#l9.384"></a><span id="l9.384"> NS_IMETHODIMP</span>
<a href="#l9.385"></a><span id="l9.385"> nsLDAPURL::GetUsername(nsACString &amp;_retval)</span>
<a href="#l9.386"></a><span id="l9.386"> {</span>
<a href="#l9.387"></a><span id="l9.387" class="difflineminus">-    _retval.Truncate();</span>
<a href="#l9.388"></a><span id="l9.388" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.389"></a><span id="l9.389" class="difflineplus">+  _retval.Truncate();</span>
<a href="#l9.390"></a><span id="l9.390" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.391"></a><span id="l9.391"> }</span>
<a href="#l9.392"></a><span id="l9.392" class="difflineplus">+</span>
<a href="#l9.393"></a><span id="l9.393"> NS_IMETHODIMP</span>
<a href="#l9.394"></a><span id="l9.394"> nsLDAPURL::SetUsername(const nsACString &amp;aUsername)</span>
<a href="#l9.395"></a><span id="l9.395"> {</span>
<a href="#l9.396"></a><span id="l9.396" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l9.397"></a><span id="l9.397" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.398"></a><span id="l9.398"> }</span>
<a href="#l9.399"></a><span id="l9.399"> </span>
<a href="#l9.400"></a><span id="l9.400" class="difflineminus">-// attribute string password;</span>
<a href="#l9.401"></a><span id="l9.401" class="difflineminus">-//</span>
<a href="#l9.402"></a><span id="l9.402"> NS_IMETHODIMP </span>
<a href="#l9.403"></a><span id="l9.403"> nsLDAPURL::GetPassword(nsACString &amp;_retval)</span>
<a href="#l9.404"></a><span id="l9.404"> {</span>
<a href="#l9.405"></a><span id="l9.405" class="difflineminus">-    _retval.Truncate();</span>
<a href="#l9.406"></a><span id="l9.406" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.407"></a><span id="l9.407" class="difflineplus">+  _retval.Truncate();</span>
<a href="#l9.408"></a><span id="l9.408" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.409"></a><span id="l9.409"> }</span>
<a href="#l9.410"></a><span id="l9.410" class="difflineplus">+</span>
<a href="#l9.411"></a><span id="l9.411"> NS_IMETHODIMP </span>
<a href="#l9.412"></a><span id="l9.412"> nsLDAPURL::SetPassword(const nsACString &amp;aPassword)</span>
<a href="#l9.413"></a><span id="l9.413"> {</span>
<a href="#l9.414"></a><span id="l9.414" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l9.415"></a><span id="l9.415" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.416"></a><span id="l9.416"> }</span>
<a href="#l9.417"></a><span id="l9.417"> </span>
<a href="#l9.418"></a><span id="l9.418" class="difflineminus">-// attribute string hostPort;</span>
<a href="#l9.419"></a><span id="l9.419" class="difflineminus">-//</span>
<a href="#l9.420"></a><span id="l9.420"> NS_IMETHODIMP </span>
<a href="#l9.421"></a><span id="l9.421"> nsLDAPURL::GetHostPort(nsACString &amp;_retval)</span>
<a href="#l9.422"></a><span id="l9.422"> {</span>
<a href="#l9.423"></a><span id="l9.423" class="difflineminus">-  nsCString result(mHost);</span>
<a href="#l9.424"></a><span id="l9.424" class="difflineminus">-  result.AppendLiteral(&quot;:&quot;);</span>
<a href="#l9.425"></a><span id="l9.425" class="difflineminus">-  if (mPort)</span>
<a href="#l9.426"></a><span id="l9.426" class="difflineminus">-    result.AppendInt(mPort);</span>
<a href="#l9.427"></a><span id="l9.427" class="difflineplus">+  if (!mBaseURL)</span>
<a href="#l9.428"></a><span id="l9.428" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.429"></a><span id="l9.429"> </span>
<a href="#l9.430"></a><span id="l9.430" class="difflineminus">-  _retval.Assign(result);</span>
<a href="#l9.431"></a><span id="l9.431" class="difflineplus">+  return mBaseURL-&gt;GetHostPort(_retval);</span>
<a href="#l9.432"></a><span id="l9.432" class="difflineplus">+}</span>
<a href="#l9.433"></a><span id="l9.433"> </span>
<a href="#l9.434"></a><span id="l9.434" class="difflineminus">-  return NS_OK;</span>
<a href="#l9.435"></a><span id="l9.435" class="difflineminus">-}</span>
<a href="#l9.436"></a><span id="l9.436"> NS_IMETHODIMP </span>
<a href="#l9.437"></a><span id="l9.437"> nsLDAPURL::SetHostPort(const nsACString &amp;aHostPort)</span>
<a href="#l9.438"></a><span id="l9.438"> {</span>
<a href="#l9.439"></a><span id="l9.439" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l9.440"></a><span id="l9.440" class="difflineplus">+  if (!mBaseURL)</span>
<a href="#l9.441"></a><span id="l9.441" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.442"></a><span id="l9.442" class="difflineplus">+</span>
<a href="#l9.443"></a><span id="l9.443" class="difflineplus">+  return mBaseURL-&gt;SetHostPort(aHostPort);</span>
<a href="#l9.444"></a><span id="l9.444"> }</span>
<a href="#l9.445"></a><span id="l9.445"> </span>
<a href="#l9.446"></a><span id="l9.446" class="difflineminus">-// attribute string host;</span>
<a href="#l9.447"></a><span id="l9.447" class="difflineminus">-//</span>
<a href="#l9.448"></a><span id="l9.448"> NS_IMETHODIMP </span>
<a href="#l9.449"></a><span id="l9.449"> nsLDAPURL::GetHost(nsACString &amp;_retval)</span>
<a href="#l9.450"></a><span id="l9.450"> {</span>
<a href="#l9.451"></a><span id="l9.451" class="difflineminus">-    _retval = mHost;</span>
<a href="#l9.452"></a><span id="l9.452" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.453"></a><span id="l9.453" class="difflineplus">+  if (!mBaseURL)</span>
<a href="#l9.454"></a><span id="l9.454" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.455"></a><span id="l9.455" class="difflineplus">+</span>
<a href="#l9.456"></a><span id="l9.456" class="difflineplus">+  return mBaseURL-&gt;GetHost(_retval);</span>
<a href="#l9.457"></a><span id="l9.457"> }</span>
<a href="#l9.458"></a><span id="l9.458" class="difflineplus">+</span>
<a href="#l9.459"></a><span id="l9.459"> NS_IMETHODIMP </span>
<a href="#l9.460"></a><span id="l9.460"> nsLDAPURL::SetHost(const nsACString &amp;aHost)</span>
<a href="#l9.461"></a><span id="l9.461"> {</span>
<a href="#l9.462"></a><span id="l9.462" class="difflineminus">-    mHost = aHost;</span>
<a href="#l9.463"></a><span id="l9.463" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.464"></a><span id="l9.464" class="difflineplus">+  if (!mBaseURL)</span>
<a href="#l9.465"></a><span id="l9.465" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.466"></a><span id="l9.466" class="difflineplus">+</span>
<a href="#l9.467"></a><span id="l9.467" class="difflineplus">+  return mBaseURL-&gt;SetHost(aHost);</span>
<a href="#l9.468"></a><span id="l9.468"> }</span>
<a href="#l9.469"></a><span id="l9.469"> </span>
<a href="#l9.470"></a><span id="l9.470" class="difflineminus">-// C-SDK URL parser defaults port 389 as &quot;0&quot;, while nsIURI</span>
<a href="#l9.471"></a><span id="l9.471" class="difflineminus">-// specifies the default to be &quot;-1&quot;, hence the translations.</span>
<a href="#l9.472"></a><span id="l9.472" class="difflineminus">-//</span>
<a href="#l9.473"></a><span id="l9.473" class="difflineminus">-// attribute long port;</span>
<a href="#l9.474"></a><span id="l9.474" class="difflineminus">-//</span>
<a href="#l9.475"></a><span id="l9.475"> NS_IMETHODIMP </span>
<a href="#l9.476"></a><span id="l9.476"> nsLDAPURL::GetPort(PRInt32 *_retval)</span>
<a href="#l9.477"></a><span id="l9.477"> {</span>
<a href="#l9.478"></a><span id="l9.478" class="difflineminus">-    if (!_retval) {</span>
<a href="#l9.479"></a><span id="l9.479" class="difflineminus">-        NS_ERROR(&quot;nsLDAPURL::GetPort: null pointer &quot;);</span>
<a href="#l9.480"></a><span id="l9.480" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l9.481"></a><span id="l9.481" class="difflineminus">-    }</span>
<a href="#l9.482"></a><span id="l9.482" class="difflineplus">+  if (!mBaseURL)</span>
<a href="#l9.483"></a><span id="l9.483" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.484"></a><span id="l9.484"> </span>
<a href="#l9.485"></a><span id="l9.485" class="difflineminus">-    if (!mPort) {</span>
<a href="#l9.486"></a><span id="l9.486" class="difflineminus">-        *_retval = -1;</span>
<a href="#l9.487"></a><span id="l9.487" class="difflineminus">-    } else {</span>
<a href="#l9.488"></a><span id="l9.488" class="difflineminus">-        *_retval = mPort;</span>
<a href="#l9.489"></a><span id="l9.489" class="difflineminus">-    }</span>
<a href="#l9.490"></a><span id="l9.490" class="difflineminus">-        </span>
<a href="#l9.491"></a><span id="l9.491" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.492"></a><span id="l9.492" class="difflineplus">+  return mBaseURL-&gt;GetPort(_retval);</span>
<a href="#l9.493"></a><span id="l9.493"> }</span>
<a href="#l9.494"></a><span id="l9.494" class="difflineplus">+</span>
<a href="#l9.495"></a><span id="l9.495"> NS_IMETHODIMP </span>
<a href="#l9.496"></a><span id="l9.496"> nsLDAPURL::SetPort(PRInt32 aPort)</span>
<a href="#l9.497"></a><span id="l9.497"> {</span>
<a href="#l9.498"></a><span id="l9.498" class="difflineminus">-    if (aPort == -1) {</span>
<a href="#l9.499"></a><span id="l9.499" class="difflineminus">-        mPort = 0;</span>
<a href="#l9.500"></a><span id="l9.500" class="difflineminus">-    } else if (aPort &gt;= 0) {</span>
<a href="#l9.501"></a><span id="l9.501" class="difflineminus">-        mPort = aPort;</span>
<a href="#l9.502"></a><span id="l9.502" class="difflineminus">-    } else {</span>
<a href="#l9.503"></a><span id="l9.503" class="difflineminus">-        return NS_ERROR_MALFORMED_URI;</span>
<a href="#l9.504"></a><span id="l9.504" class="difflineminus">-    }</span>
<a href="#l9.505"></a><span id="l9.505" class="difflineminus">-    </span>
<a href="#l9.506"></a><span id="l9.506" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.507"></a><span id="l9.507" class="difflineplus">+  if (!mBaseURL)</span>
<a href="#l9.508"></a><span id="l9.508" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.509"></a><span id="l9.509" class="difflineplus">+</span>
<a href="#l9.510"></a><span id="l9.510" class="difflineplus">+  return mBaseURL-&gt;SetPort(aPort);</span>
<a href="#l9.511"></a><span id="l9.511"> }</span>
<a href="#l9.512"></a><span id="l9.512"> </span>
<a href="#l9.513"></a><span id="l9.513" class="difflineminus">-// attribute string path;</span>
<a href="#l9.514"></a><span id="l9.514" class="difflineminus">-// XXXleif: For now, these are identical to SetDn()/GetDn().</span>
<a href="#l9.515"></a><span id="l9.515"> NS_IMETHODIMP nsLDAPURL::GetPath(nsACString &amp;_retval)</span>
<a href="#l9.516"></a><span id="l9.516"> {</span>
<a href="#l9.517"></a><span id="l9.517" class="difflineminus">-    _retval = mDN;</span>
<a href="#l9.518"></a><span id="l9.518" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.519"></a><span id="l9.519" class="difflineminus">-}</span>
<a href="#l9.520"></a><span id="l9.520" class="difflineminus">-NS_IMETHODIMP nsLDAPURL::SetPath(const nsACString &amp;aPath)</span>
<a href="#l9.521"></a><span id="l9.521" class="difflineminus">-{</span>
<a href="#l9.522"></a><span id="l9.522" class="difflineminus">-    mDN = aPath;</span>
<a href="#l9.523"></a><span id="l9.523" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.524"></a><span id="l9.524" class="difflineplus">+  if (!mBaseURL)</span>
<a href="#l9.525"></a><span id="l9.525" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.526"></a><span id="l9.526" class="difflineplus">+</span>
<a href="#l9.527"></a><span id="l9.527" class="difflineplus">+  return mBaseURL-&gt;GetPath(_retval);</span>
<a href="#l9.528"></a><span id="l9.528"> }</span>
<a href="#l9.529"></a><span id="l9.529"> </span>
<a href="#l9.530"></a><span id="l9.530" class="difflineminus">-// attribute string specA</span>
<a href="#l9.531"></a><span id="l9.531" class="difflineplus">+NS_IMETHODIMP nsLDAPURL::SetPath(const nsACString &amp;aPath)</span>
<a href="#l9.532"></a><span id="l9.532" class="difflineplus">+{</span>
<a href="#l9.533"></a><span id="l9.533" class="difflineplus">+  if (!mBaseURL)</span>
<a href="#l9.534"></a><span id="l9.534" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.535"></a><span id="l9.535" class="difflineplus">+</span>
<a href="#l9.536"></a><span id="l9.536" class="difflineplus">+  nsresult rv = SetPathInternal(nsPromiseFlatCString(aPath));</span>
<a href="#l9.537"></a><span id="l9.537" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.538"></a><span id="l9.538" class="difflineplus">+</span>
<a href="#l9.539"></a><span id="l9.539" class="difflineplus">+  return mBaseURL-&gt;SetPath(aPath);</span>
<a href="#l9.540"></a><span id="l9.540" class="difflineplus">+}</span>
<a href="#l9.541"></a><span id="l9.541" class="difflineplus">+</span>
<a href="#l9.542"></a><span id="l9.542"> NS_IMETHODIMP nsLDAPURL::GetAsciiSpec(nsACString &amp;_retval)</span>
<a href="#l9.543"></a><span id="l9.543"> {</span>
<a href="#l9.544"></a><span id="l9.544" class="difflineminus">-    return GetSpec(_retval);</span>
<a href="#l9.545"></a><span id="l9.545" class="difflineplus">+  if (!mBaseURL)</span>
<a href="#l9.546"></a><span id="l9.546" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.547"></a><span id="l9.547" class="difflineplus">+</span>
<a href="#l9.548"></a><span id="l9.548" class="difflineplus">+  // XXX handle extra items?</span>
<a href="#l9.549"></a><span id="l9.549" class="difflineplus">+  return mBaseURL-&gt;GetAsciiSpec(_retval);</span>
<a href="#l9.550"></a><span id="l9.550"> }</span>
<a href="#l9.551"></a><span id="l9.551" class="difflineminus">-// attribute string hostA</span>
<a href="#l9.552"></a><span id="l9.552" class="difflineplus">+</span>
<a href="#l9.553"></a><span id="l9.553"> NS_IMETHODIMP nsLDAPURL::GetAsciiHost(nsACString &amp;_retval)</span>
<a href="#l9.554"></a><span id="l9.554"> {</span>
<a href="#l9.555"></a><span id="l9.555" class="difflineminus">-    return GetHost(_retval);</span>
<a href="#l9.556"></a><span id="l9.556" class="difflineplus">+  if (!mBaseURL)</span>
<a href="#l9.557"></a><span id="l9.557" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.558"></a><span id="l9.558" class="difflineplus">+</span>
<a href="#l9.559"></a><span id="l9.559" class="difflineplus">+  return mBaseURL-&gt;GetAsciiHost(_retval);</span>
<a href="#l9.560"></a><span id="l9.560"> }</span>
<a href="#l9.561"></a><span id="l9.561"> </span>
<a href="#l9.562"></a><span id="l9.562"> NS_IMETHODIMP nsLDAPURL::GetOriginCharset(nsACString &amp;result)</span>
<a href="#l9.563"></a><span id="l9.563"> {</span>
<a href="#l9.564"></a><span id="l9.564" class="difflineminus">-    result.Truncate();</span>
<a href="#l9.565"></a><span id="l9.565" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.566"></a><span id="l9.566" class="difflineplus">+  if (!mBaseURL)</span>
<a href="#l9.567"></a><span id="l9.567" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.568"></a><span id="l9.568" class="difflineplus">+</span>
<a href="#l9.569"></a><span id="l9.569" class="difflineplus">+  return mBaseURL-&gt;GetOriginCharset(result);</span>
<a href="#l9.570"></a><span id="l9.570"> }</span>
<a href="#l9.571"></a><span id="l9.571"> </span>
<a href="#l9.572"></a><span id="l9.572"> // boolean equals (in nsIURI other)</span>
<a href="#l9.573"></a><span id="l9.573"> // (based on nsSimpleURI::Equals)</span>
<a href="#l9.574"></a><span id="l9.574"> NS_IMETHODIMP nsLDAPURL::Equals(nsIURI *other, PRBool *_retval)</span>
<a href="#l9.575"></a><span id="l9.575"> {</span>
<a href="#l9.576"></a><span id="l9.576">   *_retval = PR_FALSE;</span>
<a href="#l9.577"></a><span id="l9.577">   if (other)</span>
<a href="#l9.578"></a><span id="l9.578" class="difflineat">@@ -395,211 +423,261 @@ NS_IMETHODIMP nsLDAPURL::Equals(nsIURI *</span>
<a href="#l9.579"></a><span id="l9.579">         *_retval = PR_TRUE;</span>
<a href="#l9.580"></a><span id="l9.580">     }</span>
<a href="#l9.581"></a><span id="l9.581">   }</span>
<a href="#l9.582"></a><span id="l9.582">   return NS_OK;</span>
<a href="#l9.583"></a><span id="l9.583"> }</span>
<a href="#l9.584"></a><span id="l9.584"> </span>
<a href="#l9.585"></a><span id="l9.585"> // boolean schemeIs(in const char * scheme);</span>
<a href="#l9.586"></a><span id="l9.586"> //</span>
<a href="#l9.587"></a><span id="l9.587" class="difflineminus">-NS_IMETHODIMP nsLDAPURL::SchemeIs(const char *i_Scheme, PRBool *o_Equals)</span>
<a href="#l9.588"></a><span id="l9.588" class="difflineplus">+NS_IMETHODIMP nsLDAPURL::SchemeIs(const char *aScheme, PRBool *aEquals)</span>
<a href="#l9.589"></a><span id="l9.589"> {</span>
<a href="#l9.590"></a><span id="l9.590" class="difflineminus">-    if (!i_Scheme) return NS_ERROR_INVALID_ARG;</span>
<a href="#l9.591"></a><span id="l9.591" class="difflineminus">-    if (*i_Scheme == 'l' || *i_Scheme == 'L') {</span>
<a href="#l9.592"></a><span id="l9.592" class="difflineminus">-        *o_Equals = PL_strcasecmp(&quot;ldap&quot;, i_Scheme) ? PR_FALSE : PR_TRUE;</span>
<a href="#l9.593"></a><span id="l9.593" class="difflineminus">-    } else {</span>
<a href="#l9.594"></a><span id="l9.594" class="difflineminus">-        *o_Equals = PR_FALSE;</span>
<a href="#l9.595"></a><span id="l9.595" class="difflineminus">-    }</span>
<a href="#l9.596"></a><span id="l9.596" class="difflineplus">+  if (!mBaseURL)</span>
<a href="#l9.597"></a><span id="l9.597" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.598"></a><span id="l9.598"> </span>
<a href="#l9.599"></a><span id="l9.599" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.600"></a><span id="l9.600" class="difflineplus">+  return mBaseURL-&gt;SchemeIs(aScheme, aEquals);</span>
<a href="#l9.601"></a><span id="l9.601"> }</span>
<a href="#l9.602"></a><span id="l9.602"> </span>
<a href="#l9.603"></a><span id="l9.603"> // nsIURI clone ();</span>
<a href="#l9.604"></a><span id="l9.604"> //</span>
<a href="#l9.605"></a><span id="l9.605" class="difflineminus">-NS_IMETHODIMP nsLDAPURL::Clone(nsIURI **_retval)</span>
<a href="#l9.606"></a><span id="l9.606" class="difflineplus">+NS_IMETHODIMP nsLDAPURL::Clone(nsIURI **aResult)</span>
<a href="#l9.607"></a><span id="l9.607"> {</span>
<a href="#l9.608"></a><span id="l9.608" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l9.609"></a><span id="l9.609" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l9.610"></a><span id="l9.610" class="difflineplus">+</span>
<a href="#l9.611"></a><span id="l9.611" class="difflineplus">+  nsLDAPURL *clone;</span>
<a href="#l9.612"></a><span id="l9.612" class="difflineplus">+  NS_NEWXPCOM(clone, nsLDAPURL);</span>
<a href="#l9.613"></a><span id="l9.613" class="difflineplus">+  if (!clone)</span>
<a href="#l9.614"></a><span id="l9.614" class="difflineplus">+    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.615"></a><span id="l9.615" class="difflineplus">+</span>
<a href="#l9.616"></a><span id="l9.616" class="difflineplus">+  clone-&gt;mDN = mDN;</span>
<a href="#l9.617"></a><span id="l9.617" class="difflineplus">+  clone-&gt;mScope = mScope;</span>
<a href="#l9.618"></a><span id="l9.618" class="difflineplus">+  clone-&gt;mFilter = mFilter;</span>
<a href="#l9.619"></a><span id="l9.619" class="difflineplus">+  clone-&gt;mOptions = mOptions;</span>
<a href="#l9.620"></a><span id="l9.620" class="difflineplus">+  clone-&gt;mAttributes = mAttributes;</span>
<a href="#l9.621"></a><span id="l9.621" class="difflineplus">+</span>
<a href="#l9.622"></a><span id="l9.622" class="difflineplus">+  nsresult rv = mBaseURL-&gt;Clone(getter_AddRefs(clone-&gt;mBaseURL));</span>
<a href="#l9.623"></a><span id="l9.623" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.624"></a><span id="l9.624" class="difflineplus">+</span>
<a href="#l9.625"></a><span id="l9.625" class="difflineplus">+  NS_ADDREF(*aResult = clone);</span>
<a href="#l9.626"></a><span id="l9.626" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.627"></a><span id="l9.627"> }</span>
<a href="#l9.628"></a><span id="l9.628"> </span>
<a href="#l9.629"></a><span id="l9.629"> // string resolve (in string relativePath);</span>
<a href="#l9.630"></a><span id="l9.630"> //</span>
<a href="#l9.631"></a><span id="l9.631"> NS_IMETHODIMP nsLDAPURL::Resolve(const nsACString &amp;relativePath,</span>
<a href="#l9.632"></a><span id="l9.632">                                  nsACString &amp;_retval)</span>
<a href="#l9.633"></a><span id="l9.633"> {</span>
<a href="#l9.634"></a><span id="l9.634" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l9.635"></a><span id="l9.635" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l9.636"></a><span id="l9.636"> }</span>
<a href="#l9.637"></a><span id="l9.637"> </span>
<a href="#l9.638"></a><span id="l9.638"> // The following attributes come from nsILDAPURL</span>
<a href="#l9.639"></a><span id="l9.639"> </span>
<a href="#l9.640"></a><span id="l9.640"> // attribute AUTF8String dn;</span>
<a href="#l9.641"></a><span id="l9.641"> //</span>
<a href="#l9.642"></a><span id="l9.642"> NS_IMETHODIMP nsLDAPURL::GetDn(nsACString&amp; _retval)</span>
<a href="#l9.643"></a><span id="l9.643"> {</span>
<a href="#l9.644"></a><span id="l9.644">     _retval.Assign(mDN);</span>
<a href="#l9.645"></a><span id="l9.645">     return NS_OK;</span>
<a href="#l9.646"></a><span id="l9.646"> }</span>
<a href="#l9.647"></a><span id="l9.647"> NS_IMETHODIMP nsLDAPURL::SetDn(const nsACString&amp; aDn)</span>
<a href="#l9.648"></a><span id="l9.648"> {</span>
<a href="#l9.649"></a><span id="l9.649" class="difflineminus">-    mDN.Assign(aDn);</span>
<a href="#l9.650"></a><span id="l9.650" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.651"></a><span id="l9.651" class="difflineplus">+  if (!mBaseURL)</span>
<a href="#l9.652"></a><span id="l9.652" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.653"></a><span id="l9.653" class="difflineplus">+</span>
<a href="#l9.654"></a><span id="l9.654" class="difflineplus">+  mDN.Assign(aDn);</span>
<a href="#l9.655"></a><span id="l9.655" class="difflineplus">+</span>
<a href="#l9.656"></a><span id="l9.656" class="difflineplus">+  // Now get the current path</span>
<a href="#l9.657"></a><span id="l9.657" class="difflineplus">+  nsCString newPath;</span>
<a href="#l9.658"></a><span id="l9.658" class="difflineplus">+  GetPathInternal(newPath);</span>
<a href="#l9.659"></a><span id="l9.659" class="difflineplus">+</span>
<a href="#l9.660"></a><span id="l9.660" class="difflineplus">+  // and update the base url</span>
<a href="#l9.661"></a><span id="l9.661" class="difflineplus">+  return mBaseURL-&gt;SetPath(newPath);</span>
<a href="#l9.662"></a><span id="l9.662"> }</span>
<a href="#l9.663"></a><span id="l9.663"> </span>
<a href="#l9.664"></a><span id="l9.664"> // void getAttributes (out unsigned long aCount, </span>
<a href="#l9.665"></a><span id="l9.665"> //                     [array, size_is (aCount), retval] out string aAttrs);</span>
<a href="#l9.666"></a><span id="l9.666"> //</span>
<a href="#l9.667"></a><span id="l9.667"> NS_IMETHODIMP nsLDAPURL::GetAttributes(PRUint32 *aCount, char ***_retval)</span>
<a href="#l9.668"></a><span id="l9.668"> {</span>
<a href="#l9.669"></a><span id="l9.669" class="difflineplus">+    NS_ENSURE_ARG_POINTER(aCount);</span>
<a href="#l9.670"></a><span id="l9.670" class="difflineplus">+    NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l9.671"></a><span id="l9.671" class="difflineplus">+</span>
<a href="#l9.672"></a><span id="l9.672">     PRUint32 index = 0;</span>
<a href="#l9.673"></a><span id="l9.673">     PRUint32 count;</span>
<a href="#l9.674"></a><span id="l9.674">     char **cArray = nsnull;</span>
<a href="#l9.675"></a><span id="l9.675"> </span>
<a href="#l9.676"></a><span id="l9.676">     if (!_retval) {</span>
<a href="#l9.677"></a><span id="l9.677">         NS_ERROR(&quot;nsLDAPURL::GetAttributes: null pointer &quot;);</span>
<a href="#l9.678"></a><span id="l9.678">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l9.679"></a><span id="l9.679">     }</span>
<a href="#l9.680"></a><span id="l9.680"> </span>
<a href="#l9.681"></a><span id="l9.681" class="difflineminus">-    count = mAttributes-&gt;Count();</span>
<a href="#l9.682"></a><span id="l9.682" class="difflineplus">+    count = mAttributes.Count();</span>
<a href="#l9.683"></a><span id="l9.683">     if (count &gt; 0) {</span>
<a href="#l9.684"></a><span id="l9.684">         cArray = static_cast&lt;char **&gt;(nsMemory::Alloc(count * sizeof(char *)));</span>
<a href="#l9.685"></a><span id="l9.685">         if (!cArray) {</span>
<a href="#l9.686"></a><span id="l9.686">             NS_ERROR(&quot;nsLDAPURL::GetAttributes: out of memory &quot;);</span>
<a href="#l9.687"></a><span id="l9.687">             return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.688"></a><span id="l9.688">         }</span>
<a href="#l9.689"></a><span id="l9.689"> </span>
<a href="#l9.690"></a><span id="l9.690">         // Loop through the string array, and build up the C-array.</span>
<a href="#l9.691"></a><span id="l9.691">         //</span>
<a href="#l9.692"></a><span id="l9.692">         while (index &lt; count) {</span>
<a href="#l9.693"></a><span id="l9.693" class="difflineminus">-            if (!(cArray[index] = ToNewCString(*(mAttributes-&gt;CStringAt(index))))) {</span>
<a href="#l9.694"></a><span id="l9.694" class="difflineplus">+            if (!(cArray[index] = ToNewCString(*(mAttributes.CStringAt(index))))) {</span>
<a href="#l9.695"></a><span id="l9.695">                 NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(index, cArray);</span>
<a href="#l9.696"></a><span id="l9.696">                 NS_ERROR(&quot;nsLDAPURL::GetAttributes: out of memory &quot;);</span>
<a href="#l9.697"></a><span id="l9.697">                 return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.698"></a><span id="l9.698">             }</span>
<a href="#l9.699"></a><span id="l9.699">             index++;</span>
<a href="#l9.700"></a><span id="l9.700">         }</span>
<a href="#l9.701"></a><span id="l9.701">     }</span>
<a href="#l9.702"></a><span id="l9.702">     *aCount = count;</span>
<a href="#l9.703"></a><span id="l9.703">     *_retval = cArray;</span>
<a href="#l9.704"></a><span id="l9.704"> </span>
<a href="#l9.705"></a><span id="l9.705">     return NS_OK;</span>
<a href="#l9.706"></a><span id="l9.706"> }</span>
<a href="#l9.707"></a><span id="l9.707"> // void setAttributes (in unsigned long aCount,</span>
<a href="#l9.708"></a><span id="l9.708"> //                     [array, size_is (aCount)] in string aAttrs); */</span>
<a href="#l9.709"></a><span id="l9.709"> NS_IMETHODIMP nsLDAPURL::SetAttributes(PRUint32 count, const char **aAttrs)</span>
<a href="#l9.710"></a><span id="l9.710"> {</span>
<a href="#l9.711"></a><span id="l9.711" class="difflineminus">-    PRUint32 index = 0;</span>
<a href="#l9.712"></a><span id="l9.712" class="difflineminus">-    nsCString str;</span>
<a href="#l9.713"></a><span id="l9.713" class="difflineminus">-    </span>
<a href="#l9.714"></a><span id="l9.714" class="difflineminus">-    mAttributes-&gt;Clear();</span>
<a href="#l9.715"></a><span id="l9.715" class="difflineminus">-    while (index &lt; count) {</span>
<a href="#l9.716"></a><span id="l9.716" class="difflineminus">-        // Have to assign the str into this temporary nsCString, to make</span>
<a href="#l9.717"></a><span id="l9.717" class="difflineminus">-        // the compilers happy...</span>
<a href="#l9.718"></a><span id="l9.718" class="difflineminus">-        //</span>
<a href="#l9.719"></a><span id="l9.719" class="difflineminus">-        str = nsDependentCString(aAttrs[index]);</span>
<a href="#l9.720"></a><span id="l9.720" class="difflineminus">-        if (!mAttributes-&gt;InsertCStringAt(str, index++)) {</span>
<a href="#l9.721"></a><span id="l9.721" class="difflineminus">-            NS_ERROR(&quot;nsLDAPURL::SetAttributes: out of memory &quot;);</span>
<a href="#l9.722"></a><span id="l9.722" class="difflineminus">-            return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.723"></a><span id="l9.723" class="difflineminus">-        }</span>
<a href="#l9.724"></a><span id="l9.724" class="difflineplus">+  if (!mBaseURL)</span>
<a href="#l9.725"></a><span id="l9.725" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.726"></a><span id="l9.726" class="difflineplus">+</span>
<a href="#l9.727"></a><span id="l9.727" class="difflineplus">+  if (count)</span>
<a href="#l9.728"></a><span id="l9.728" class="difflineplus">+    NS_ENSURE_ARG_POINTER(aAttrs);</span>
<a href="#l9.729"></a><span id="l9.729" class="difflineplus">+</span>
<a href="#l9.730"></a><span id="l9.730" class="difflineplus">+  mAttributes.Clear();</span>
<a href="#l9.731"></a><span id="l9.731" class="difflineplus">+  for (PRUint32 i = 0; i &lt; count; ++i)</span>
<a href="#l9.732"></a><span id="l9.732" class="difflineplus">+  {</span>
<a href="#l9.733"></a><span id="l9.733" class="difflineplus">+    if (!mAttributes.AppendCString(nsDependentCString(aAttrs[i])))</span>
<a href="#l9.734"></a><span id="l9.734" class="difflineplus">+    {</span>
<a href="#l9.735"></a><span id="l9.735" class="difflineplus">+      NS_ERROR(&quot;nsLDAPURL::SetAttributes: out of memory &quot;);</span>
<a href="#l9.736"></a><span id="l9.736" class="difflineplus">+      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.737"></a><span id="l9.737">     }</span>
<a href="#l9.738"></a><span id="l9.738" class="difflineplus">+  }</span>
<a href="#l9.739"></a><span id="l9.739"> </span>
<a href="#l9.740"></a><span id="l9.740" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.741"></a><span id="l9.741" class="difflineplus">+  // Now get the current path</span>
<a href="#l9.742"></a><span id="l9.742" class="difflineplus">+  nsCString newPath;</span>
<a href="#l9.743"></a><span id="l9.743" class="difflineplus">+  GetPathInternal(newPath);</span>
<a href="#l9.744"></a><span id="l9.744" class="difflineplus">+</span>
<a href="#l9.745"></a><span id="l9.745" class="difflineplus">+  // and update the base url</span>
<a href="#l9.746"></a><span id="l9.746" class="difflineplus">+  return mBaseURL-&gt;SetPath(newPath);</span>
<a href="#l9.747"></a><span id="l9.747"> }</span>
<a href="#l9.748"></a><span id="l9.748" class="difflineminus">-// void addAttribute (in string aAttribute);</span>
<a href="#l9.749"></a><span id="l9.749" class="difflineminus">-//</span>
<a href="#l9.750"></a><span id="l9.750" class="difflineplus">+</span>
<a href="#l9.751"></a><span id="l9.751"> NS_IMETHODIMP nsLDAPURL::AddAttribute(const char *aAttribute)</span>
<a href="#l9.752"></a><span id="l9.752"> {</span>
<a href="#l9.753"></a><span id="l9.753" class="difflineminus">-    nsCString str;</span>
<a href="#l9.754"></a><span id="l9.754" class="difflineplus">+  if (!mBaseURL)</span>
<a href="#l9.755"></a><span id="l9.755" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.756"></a><span id="l9.756" class="difflineplus">+</span>
<a href="#l9.757"></a><span id="l9.757" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aAttribute);</span>
<a href="#l9.758"></a><span id="l9.758"> </span>
<a href="#l9.759"></a><span id="l9.759" class="difflineminus">-    str = nsDependentCString(aAttribute);</span>
<a href="#l9.760"></a><span id="l9.760" class="difflineminus">-    if (mAttributes-&gt;IndexOfIgnoreCase(str) &gt;= 0) {</span>
<a href="#l9.761"></a><span id="l9.761" class="difflineminus">-        return NS_OK;</span>
<a href="#l9.762"></a><span id="l9.762" class="difflineminus">-    }</span>
<a href="#l9.763"></a><span id="l9.763" class="difflineplus">+  nsDependentCString str(aAttribute);</span>
<a href="#l9.764"></a><span id="l9.764" class="difflineplus">+</span>
<a href="#l9.765"></a><span id="l9.765" class="difflineplus">+  if (mAttributes.IndexOfIgnoreCase(str) &gt;= 0)</span>
<a href="#l9.766"></a><span id="l9.766" class="difflineplus">+    return NS_OK;</span>
<a href="#l9.767"></a><span id="l9.767"> </span>
<a href="#l9.768"></a><span id="l9.768" class="difflineminus">-    if (!mAttributes-&gt;InsertCStringAt(str, mAttributes-&gt;Count())) {</span>
<a href="#l9.769"></a><span id="l9.769" class="difflineminus">-        NS_ERROR(&quot;nsLDAPURL::AddAttribute: out of memory &quot;);</span>
<a href="#l9.770"></a><span id="l9.770" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.771"></a><span id="l9.771" class="difflineminus">-    }</span>
<a href="#l9.772"></a><span id="l9.772" class="difflineplus">+  if (!mAttributes.AppendCString(str)) {</span>
<a href="#l9.773"></a><span id="l9.773" class="difflineplus">+    NS_ERROR(&quot;nsLDAPURL::AddAttribute: out of memory &quot;);</span>
<a href="#l9.774"></a><span id="l9.774" class="difflineplus">+    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.775"></a><span id="l9.775" class="difflineplus">+  }</span>
<a href="#l9.776"></a><span id="l9.776"> </span>
<a href="#l9.777"></a><span id="l9.777" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.778"></a><span id="l9.778" class="difflineplus">+  // Now get the current path</span>
<a href="#l9.779"></a><span id="l9.779" class="difflineplus">+  nsCString newPath;</span>
<a href="#l9.780"></a><span id="l9.780" class="difflineplus">+  GetPathInternal(newPath);</span>
<a href="#l9.781"></a><span id="l9.781" class="difflineplus">+</span>
<a href="#l9.782"></a><span id="l9.782" class="difflineplus">+  // and update the base url</span>
<a href="#l9.783"></a><span id="l9.783" class="difflineplus">+  return mBaseURL-&gt;SetPath(newPath);</span>
<a href="#l9.784"></a><span id="l9.784"> }</span>
<a href="#l9.785"></a><span id="l9.785" class="difflineminus">-// void removeAttribute (in string aAttribute);</span>
<a href="#l9.786"></a><span id="l9.786" class="difflineminus">-//</span>
<a href="#l9.787"></a><span id="l9.787" class="difflineplus">+</span>
<a href="#l9.788"></a><span id="l9.788"> NS_IMETHODIMP nsLDAPURL::RemoveAttribute(const char *aAttribute)</span>
<a href="#l9.789"></a><span id="l9.789"> {</span>
<a href="#l9.790"></a><span id="l9.790" class="difflineminus">-    nsCString str;</span>
<a href="#l9.791"></a><span id="l9.791" class="difflineplus">+  if (!mBaseURL)</span>
<a href="#l9.792"></a><span id="l9.792" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.793"></a><span id="l9.793"> </span>
<a href="#l9.794"></a><span id="l9.794" class="difflineminus">-    str = nsDependentCString(aAttribute);</span>
<a href="#l9.795"></a><span id="l9.795" class="difflineminus">-    mAttributes-&gt;RemoveCString(str);</span>
<a href="#l9.796"></a><span id="l9.796" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aAttribute);</span>
<a href="#l9.797"></a><span id="l9.797" class="difflineplus">+  mAttributes.RemoveCString(nsDependentCString(aAttribute));</span>
<a href="#l9.798"></a><span id="l9.798"> </span>
<a href="#l9.799"></a><span id="l9.799" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.800"></a><span id="l9.800" class="difflineplus">+  // Now get the current path</span>
<a href="#l9.801"></a><span id="l9.801" class="difflineplus">+  nsCString newPath;</span>
<a href="#l9.802"></a><span id="l9.802" class="difflineplus">+  GetPathInternal(newPath);</span>
<a href="#l9.803"></a><span id="l9.803" class="difflineplus">+</span>
<a href="#l9.804"></a><span id="l9.804" class="difflineplus">+  // and update the base url</span>
<a href="#l9.805"></a><span id="l9.805" class="difflineplus">+  return mBaseURL-&gt;SetPath(newPath);</span>
<a href="#l9.806"></a><span id="l9.806"> }</span>
<a href="#l9.807"></a><span id="l9.807" class="difflineminus">-// boolean hasAttribute (in string aAttribute);</span>
<a href="#l9.808"></a><span id="l9.808" class="difflineminus">-//</span>
<a href="#l9.809"></a><span id="l9.809" class="difflineplus">+</span>
<a href="#l9.810"></a><span id="l9.810"> NS_IMETHODIMP nsLDAPURL::HasAttribute(const char *aAttribute, PRBool *_retval)</span>
<a href="#l9.811"></a><span id="l9.811"> {</span>
<a href="#l9.812"></a><span id="l9.812" class="difflineminus">-    nsCString str;</span>
<a href="#l9.813"></a><span id="l9.813" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aAttribute);</span>
<a href="#l9.814"></a><span id="l9.814" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l9.815"></a><span id="l9.815"> </span>
<a href="#l9.816"></a><span id="l9.816" class="difflineminus">-    if (!_retval) {</span>
<a href="#l9.817"></a><span id="l9.817" class="difflineminus">-        NS_ERROR(&quot;nsLDAPURL::HasAttribute: null pointer &quot;);</span>
<a href="#l9.818"></a><span id="l9.818" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l9.819"></a><span id="l9.819" class="difflineminus">-    }</span>
<a href="#l9.820"></a><span id="l9.820" class="difflineminus">-</span>
<a href="#l9.821"></a><span id="l9.821" class="difflineminus">-    str = nsDependentCString(aAttribute);</span>
<a href="#l9.822"></a><span id="l9.822" class="difflineminus">-    *_retval = mAttributes-&gt;IndexOfIgnoreCase(str) &gt;= 0;</span>
<a href="#l9.823"></a><span id="l9.823" class="difflineminus">-    </span>
<a href="#l9.824"></a><span id="l9.824" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.825"></a><span id="l9.825" class="difflineplus">+  *_retval = mAttributes.IndexOfIgnoreCase(nsDependentCString(aAttribute)) &gt;= 0;</span>
<a href="#l9.826"></a><span id="l9.826" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.827"></a><span id="l9.827"> }</span>
<a href="#l9.828"></a><span id="l9.828"> </span>
<a href="#l9.829"></a><span id="l9.829" class="difflineminus">-// attribute long scope;</span>
<a href="#l9.830"></a><span id="l9.830" class="difflineminus">-//</span>
<a href="#l9.831"></a><span id="l9.831"> NS_IMETHODIMP nsLDAPURL::GetScope(PRInt32 *_retval)</span>
<a href="#l9.832"></a><span id="l9.832"> {</span>
<a href="#l9.833"></a><span id="l9.833" class="difflineminus">-    if (!_retval) {</span>
<a href="#l9.834"></a><span id="l9.834" class="difflineminus">-        NS_ERROR(&quot;nsLDAPURL::GetScope: null pointer &quot;);</span>
<a href="#l9.835"></a><span id="l9.835" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l9.836"></a><span id="l9.836" class="difflineminus">-    }</span>
<a href="#l9.837"></a><span id="l9.837" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l9.838"></a><span id="l9.838" class="difflineplus">+  *_retval = mScope;</span>
<a href="#l9.839"></a><span id="l9.839" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.840"></a><span id="l9.840" class="difflineplus">+}</span>
<a href="#l9.841"></a><span id="l9.841"> </span>
<a href="#l9.842"></a><span id="l9.842" class="difflineminus">-    *_retval = mScope;</span>
<a href="#l9.843"></a><span id="l9.843" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.844"></a><span id="l9.844" class="difflineminus">-}</span>
<a href="#l9.845"></a><span id="l9.845"> NS_IMETHODIMP nsLDAPURL::SetScope(PRInt32 aScope)</span>
<a href="#l9.846"></a><span id="l9.846"> {</span>
<a href="#l9.847"></a><span id="l9.847" class="difflineminus">-    // Only allow scopes supported by the C-SDK</span>
<a href="#l9.848"></a><span id="l9.848" class="difflineminus">-    if ((aScope != SCOPE_BASE) &amp;&amp;</span>
<a href="#l9.849"></a><span id="l9.849" class="difflineminus">-        (aScope != SCOPE_ONELEVEL) &amp;&amp;</span>
<a href="#l9.850"></a><span id="l9.850" class="difflineminus">-        (aScope != SCOPE_SUBTREE)) {</span>
<a href="#l9.851"></a><span id="l9.851" class="difflineminus">-        return NS_ERROR_MALFORMED_URI;</span>
<a href="#l9.852"></a><span id="l9.852" class="difflineminus">-    }</span>
<a href="#l9.853"></a><span id="l9.853" class="difflineplus">+  if (!mBaseURL)</span>
<a href="#l9.854"></a><span id="l9.854" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.855"></a><span id="l9.855" class="difflineplus">+</span>
<a href="#l9.856"></a><span id="l9.856" class="difflineplus">+  // Only allow scopes supported by the C-SDK</span>
<a href="#l9.857"></a><span id="l9.857" class="difflineplus">+  if ((aScope != SCOPE_BASE) &amp;&amp; (aScope != SCOPE_ONELEVEL) &amp;&amp;</span>
<a href="#l9.858"></a><span id="l9.858" class="difflineplus">+      (aScope != SCOPE_SUBTREE))</span>
<a href="#l9.859"></a><span id="l9.859" class="difflineplus">+    return NS_ERROR_MALFORMED_URI;</span>
<a href="#l9.860"></a><span id="l9.860"> </span>
<a href="#l9.861"></a><span id="l9.861" class="difflineminus">-    mScope = aScope;</span>
<a href="#l9.862"></a><span id="l9.862" class="difflineplus">+  mScope = aScope;</span>
<a href="#l9.863"></a><span id="l9.863"> </span>
<a href="#l9.864"></a><span id="l9.864" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.865"></a><span id="l9.865" class="difflineplus">+  // Now get the current path</span>
<a href="#l9.866"></a><span id="l9.866" class="difflineplus">+  nsCString newPath;</span>
<a href="#l9.867"></a><span id="l9.867" class="difflineplus">+  GetPathInternal(newPath);</span>
<a href="#l9.868"></a><span id="l9.868" class="difflineplus">+</span>
<a href="#l9.869"></a><span id="l9.869" class="difflineplus">+  // and update the base url</span>
<a href="#l9.870"></a><span id="l9.870" class="difflineplus">+  return mBaseURL-&gt;SetPath(newPath);</span>
<a href="#l9.871"></a><span id="l9.871"> }</span>
<a href="#l9.872"></a><span id="l9.872"> </span>
<a href="#l9.873"></a><span id="l9.873" class="difflineminus">-// attribute string filter;</span>
<a href="#l9.874"></a><span id="l9.874" class="difflineminus">-//</span>
<a href="#l9.875"></a><span id="l9.875"> NS_IMETHODIMP nsLDAPURL::GetFilter(nsACString&amp; _retval)</span>
<a href="#l9.876"></a><span id="l9.876"> {</span>
<a href="#l9.877"></a><span id="l9.877">     _retval.Assign(mFilter);</span>
<a href="#l9.878"></a><span id="l9.878">     return NS_OK;</span>
<a href="#l9.879"></a><span id="l9.879"> }</span>
<a href="#l9.880"></a><span id="l9.880"> NS_IMETHODIMP nsLDAPURL::SetFilter(const nsACString&amp; aFilter)</span>
<a href="#l9.881"></a><span id="l9.881"> {</span>
<a href="#l9.882"></a><span id="l9.882" class="difflineminus">-    mFilter.Assign(aFilter);</span>
<a href="#l9.883"></a><span id="l9.883" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.884"></a><span id="l9.884" class="difflineplus">+  if (!mBaseURL)</span>
<a href="#l9.885"></a><span id="l9.885" class="difflineplus">+    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l9.886"></a><span id="l9.886" class="difflineplus">+</span>
<a href="#l9.887"></a><span id="l9.887" class="difflineplus">+  mFilter.Assign(aFilter);</span>
<a href="#l9.888"></a><span id="l9.888" class="difflineplus">+</span>
<a href="#l9.889"></a><span id="l9.889" class="difflineplus">+  if (mFilter.IsEmpty())</span>
<a href="#l9.890"></a><span id="l9.890" class="difflineplus">+    mFilter.AssignLiteral(&quot;(objectclass=*)&quot;);</span>
<a href="#l9.891"></a><span id="l9.891" class="difflineplus">+</span>
<a href="#l9.892"></a><span id="l9.892" class="difflineplus">+  // Now get the current path</span>
<a href="#l9.893"></a><span id="l9.893" class="difflineplus">+  nsCString newPath;</span>
<a href="#l9.894"></a><span id="l9.894" class="difflineplus">+  GetPathInternal(newPath);</span>
<a href="#l9.895"></a><span id="l9.895" class="difflineplus">+</span>
<a href="#l9.896"></a><span id="l9.896" class="difflineplus">+  // and update the base url</span>
<a href="#l9.897"></a><span id="l9.897" class="difflineplus">+  return mBaseURL-&gt;SetPath(newPath);</span>
<a href="#l9.898"></a><span id="l9.898"> }</span>
<a href="#l9.899"></a><span id="l9.899"> </span>
<a href="#l9.900"></a><span id="l9.900" class="difflineminus">-// attribute unsigned long options;</span>
<a href="#l9.901"></a><span id="l9.901" class="difflineminus">-//</span>
<a href="#l9.902"></a><span id="l9.902"> NS_IMETHODIMP nsLDAPURL::GetOptions(PRUint32 *_retval)</span>
<a href="#l9.903"></a><span id="l9.903"> {</span>
<a href="#l9.904"></a><span id="l9.904" class="difflineminus">-    if (!_retval) {</span>
<a href="#l9.905"></a><span id="l9.905" class="difflineminus">-        NS_ERROR(&quot;nsLDAPURL::GetOptions: null pointer &quot;);</span>
<a href="#l9.906"></a><span id="l9.906" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l9.907"></a><span id="l9.907" class="difflineminus">-    }</span>
<a href="#l9.908"></a><span id="l9.908" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l9.909"></a><span id="l9.909" class="difflineplus">+  *_retval = mOptions;</span>
<a href="#l9.910"></a><span id="l9.910" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.911"></a><span id="l9.911" class="difflineplus">+}</span>
<a href="#l9.912"></a><span id="l9.912"> </span>
<a href="#l9.913"></a><span id="l9.913" class="difflineminus">-    *_retval = mOptions;</span>
<a href="#l9.914"></a><span id="l9.914" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.915"></a><span id="l9.915" class="difflineminus">-}</span>
<a href="#l9.916"></a><span id="l9.916"> NS_IMETHODIMP nsLDAPURL::SetOptions(PRUint32 aOptions)</span>
<a href="#l9.917"></a><span id="l9.917"> {</span>
<a href="#l9.918"></a><span id="l9.918" class="difflineminus">-    mOptions = aOptions;</span>
<a href="#l9.919"></a><span id="l9.919" class="difflineplus">+  // Secure is the only option supported at the moment</span>
<a href="#l9.920"></a><span id="l9.920" class="difflineplus">+  if (mOptions &amp; OPT_SECURE == aOptions &amp; OPT_SECURE)</span>
<a href="#l9.921"></a><span id="l9.921">     return NS_OK;</span>
<a href="#l9.922"></a><span id="l9.922" class="difflineplus">+</span>
<a href="#l9.923"></a><span id="l9.923" class="difflineplus">+  mOptions = aOptions;</span>
<a href="#l9.924"></a><span id="l9.924" class="difflineplus">+</span>
<a href="#l9.925"></a><span id="l9.925" class="difflineplus">+  if (aOptions &amp; OPT_SECURE == OPT_SECURE)</span>
<a href="#l9.926"></a><span id="l9.926" class="difflineplus">+    return SetScheme(LDAP_SSL_SCHEME);</span>
<a href="#l9.927"></a><span id="l9.927" class="difflineplus">+</span>
<a href="#l9.928"></a><span id="l9.928" class="difflineplus">+  return SetScheme(LDAP_SCHEME);</span>
<a href="#l9.929"></a><span id="l9.929"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/directory/xpcom/base/src/nsLDAPURL.h</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/directory/xpcom/base/src/nsLDAPURL.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1,9 +1,9 @@</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l10.6"></a><span id="l10.6">  * </span>
<a href="#l10.7"></a><span id="l10.7">  * ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l10.8"></a><span id="l10.8">  * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l10.9"></a><span id="l10.9">  *</span>
<a href="#l10.10"></a><span id="l10.10">  * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l10.11"></a><span id="l10.11">  * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l10.12"></a><span id="l10.12">  * the License. You may obtain a copy of the License at</span>
<a href="#l10.13"></a><span id="l10.13">  * http://www.mozilla.org/MPL/</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineat">@@ -37,34 +37,52 @@</span>
<a href="#l10.15"></a><span id="l10.15">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l10.16"></a><span id="l10.16">  *</span>
<a href="#l10.17"></a><span id="l10.17">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19"> #include &quot;ldap.h&quot;</span>
<a href="#l10.20"></a><span id="l10.20"> #include &quot;nsString.h&quot;</span>
<a href="#l10.21"></a><span id="l10.21"> #include &quot;nsVoidArray.h&quot;</span>
<a href="#l10.22"></a><span id="l10.22"> #include &quot;nsILDAPURL.h&quot;</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l10.24"></a><span id="l10.24"> </span>
<a href="#l10.25"></a><span id="l10.25"> // cb7c67f8-0053-4072-89e9-501cbd1b35ab</span>
<a href="#l10.26"></a><span id="l10.26"> #define NS_LDAPURL_CID \</span>
<a href="#l10.27"></a><span id="l10.27"> { 0xcb7c67f8, 0x0053, 0x4072, \</span>
<a href="#l10.28"></a><span id="l10.28">   { 0x89, 0xe9, 0x50, 0x1c, 0xbd, 0x1b, 0x35, 0xab}}</span>
<a href="#l10.29"></a><span id="l10.29"> </span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+/**</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+ * nsLDAPURL</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+ *</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+ * nsLDAPURL uses an nsStandardURL stored in mBaseURL as its main url formatter.</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+ * </span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+ * This is done to ensure that the pre-path sections of the URI are correctly</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+ * formatted and to re-use the functions for nsIURI as appropriate.</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+ *</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+ * Handling of the path sections of the URI are done within nsLDAPURL/parts of</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+ * the LDAP c-sdk. nsLDAPURL holds the individual sections of the path of the</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+ * URI locally (to allow convenient get/set), but always updates the mBaseURL</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+ * when one changes to ensure that mBaseURL.spec and the local data are kept</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+ * consistent.</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+ */</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+</span>
<a href="#l10.45"></a><span id="l10.45"> class nsLDAPURL : public nsILDAPURL</span>
<a href="#l10.46"></a><span id="l10.46"> {</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-  public:</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-    NS_DECL_NSIURI</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-    NS_DECL_NSILDAPURL</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+public:</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+  NS_DECL_NSIURI</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+  NS_DECL_NSILDAPURL</span>
<a href="#l10.55"></a><span id="l10.55"> </span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-    nsLDAPURL();</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-    virtual ~nsLDAPURL();</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-    nsresult Init();</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+  nsLDAPURL();</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+  virtual ~nsLDAPURL();</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+protected:</span>
<a href="#l10.63"></a><span id="l10.63"> </span>
<a href="#l10.64"></a><span id="l10.64" class="difflineminus">-  protected:</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineminus">-    nsCString mHost;              // Host name of this Directory server</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineminus">-    PRInt32 mPort;                // LDAP port number</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineminus">-    nsCString mDN;                // Base Distinguished Name (Base DN)</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineminus">-    PRInt32 mScope;               // Search scope (base, one or sub)</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-    nsCString mFilter;            // LDAP search filter</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineminus">-    PRUint32 mOptions;            // Options</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-    nsCStringArray *mAttributes;  // List of attributes</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+  void GetPathInternal(nsCString &amp;aPath);</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+  nsresult SetPathInternal(const nsCString &amp;aPath);</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+  nsCString mDN;                // Base Distinguished Name (Base DN)</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+  PRInt32 mScope;               // Search scope (base, one or sub)</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+  nsCString mFilter;            // LDAP search filter</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+  PRUint32 mOptions;            // Options</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+  nsCStringArray mAttributes;  // List of attributes</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; mBaseURL;</span>
<a href="#l10.81"></a><span id="l10.81"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/directory/xpcom/tests/Makefile.in</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/directory/xpcom/tests/Makefile.in</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -38,27 +38,37 @@</span>
<a href="#l11.4"></a><span id="l11.4"> </span>
<a href="#l11.5"></a><span id="l11.5"> DEPTH		= ../../..</span>
<a href="#l11.6"></a><span id="l11.6"> topsrcdir	= @top_srcdir@</span>
<a href="#l11.7"></a><span id="l11.7"> srcdir		= @srcdir@</span>
<a href="#l11.8"></a><span id="l11.8"> VPATH		= @srcdir@</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-MODULE		= rdfldapds</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+# Module name for xpcshell tests.</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+MODULE		= test_ldapxpcom</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+XPCSHELL_TESTS	= unit</span>
<a href="#l11.17"></a><span id="l11.17"> </span>
<a href="#l11.18"></a><span id="l11.18"> include $(topsrcdir)/config/rules.mk</span>
<a href="#l11.19"></a><span id="l11.19"> </span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+# Note that for the time being &quot;ldapshell&quot; requires LDAP Experimental</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+#</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+ifdef MOZ_LDAP_XPCOM_EXPERIMENTAL</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+DEFINES += -DMOZ_LDAP_XPCOM_EXPERIMENTAL</span>
<a href="#l11.26"></a><span id="l11.26"> </span>
<a href="#l11.27"></a><span id="l11.27"> ifeq ($(OS_ARCH),WINNT)</span>
<a href="#l11.28"></a><span id="l11.28"> # need this because xpcshell built with readline won't work in cygwin shells</span>
<a href="#l11.29"></a><span id="l11.29"> RUN		= cmd /c start</span>
<a href="#l11.30"></a><span id="l11.30"> else</span>
<a href="#l11.31"></a><span id="l11.31"> RUN		= $(DIST)/bin/run-mozilla.sh</span>
<a href="#l11.32"></a><span id="l11.32"> endif</span>
<a href="#l11.33"></a><span id="l11.33"> </span>
<a href="#l11.34"></a><span id="l11.34"> XPCSHELL	= $(DIST)/bin/xpcshell</span>
<a href="#l11.35"></a><span id="l11.35"> </span>
<a href="#l11.36"></a><span id="l11.36"> .PHONY: ldapshell</span>
<a href="#l11.37"></a><span id="l11.37"> ldapshell:</span>
<a href="#l11.38"></a><span id="l11.38"> 	$(CYGWIN_WRAPPER) $(RUN) $(XPCSHELL) \</span>
<a href="#l11.39"></a><span id="l11.39"> 		-f $(srcdir)/ldapshell.js \</span>
<a href="#l11.40"></a><span id="l11.40"> 		-f -</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/directory/xpcom/tests/jar.mn</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/directory/xpcom/tests/jar.mn</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1,3 +1,5 @@</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineplus">+#ifdef MOZ_LDAP_XPCOM_EXPERIMENTAL</span>
<a href="#l12.5"></a><span id="l12.5"> comm.jar:</span>
<a href="#l12.6"></a><span id="l12.6">     content/communicator/ldapviewer/example.xul</span>
<a href="#l12.7"></a><span id="l12.7">     content/communicator/ldapviewer/example.rdf</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- /dev/null</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ b/directory/xpcom/tests/unit/test_nsLDAPURL.js</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -0,0 +1,283 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+/*</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineplus">+ * Test suite for nsLDAPURL functions.</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+ */</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+// If we are still using the wallet service, then default port numbers</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+// are still visible in the password manager, and therefore we need to have</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+// them in the url. The toolkit login manager doesn't do this.</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+const usingWallet = &quot;nsIWalletService&quot; in Ci;</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+const portAdpt = usingWallet ? &quot;:389&quot; : &quot;&quot;;</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+const ldapURLs =</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+  [ { url: &quot;ldap://localhost/dc=test&quot;,</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+      spec: &quot;ldap://localhost/dc=test&quot;,</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+      asciiSpec: &quot;ldap://localhost/dc=test&quot;,</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+      host: &quot;localhost&quot;,</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+      asciiHost: &quot;localhost&quot;,</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+      port: -1,</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+      scheme: &quot;ldap&quot;,</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+      path: &quot;/dc=test&quot;,</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+      prePath: &quot;ldap://localhost&quot;,</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+      hostPort: &quot;localhost&quot;,</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+      dn: &quot;dc=test&quot;,</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+      scope: Ci.nsILDAPURL.SCOPE_BASE,</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+      filter: &quot;(objectclass=*)&quot;,</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+      options: 0</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+    },</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+    { url: &quot;ldap://localhost:389/dc=test,dc=abc??sub?(objectclass=*)&quot;,</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+      spec: &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=test,dc=abc??sub?(objectclass=*)&quot;,</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+      asciiSpec: &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=test,dc=abc??sub?(objectclass=*)&quot;,</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+      host: &quot;localhost&quot;,</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+      asciiHost: &quot;localhost&quot;,</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+      port: usingWallet ? 389 : -1,</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+      scheme: &quot;ldap&quot;,</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+      path: &quot;/dc=test,dc=abc??sub?(objectclass=*)&quot;,</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+      prePath: &quot;ldap://localhost&quot; + portAdpt,</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+      hostPort: &quot;localhost&quot; + portAdpt,</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+      dn: &quot;dc=test,dc=abc&quot;,</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+      scope: Ci.nsILDAPURL.SCOPE_SUBTREE,</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+      filter: &quot;(objectclass=*)&quot;,</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+      options: 0</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+    },</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+    { url: &quot;ldap://\u65e5\u672c\u8a93.jp:389/dc=tes\u65e5t??one?(oc=xyz)&quot;,</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+      spec: &quot;ldap://\u65e5\u672c\u8a93.jp&quot; + portAdpt + &quot;/dc=tes%E6%97%A5t??one?(oc=xyz)&quot;,</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+      asciiSpec: &quot;ldap://xn--wgv71a309e.jp&quot; + portAdpt + &quot;/dc=tes%E6%97%A5t??one?(oc=xyz)&quot;,</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+      host: &quot;\u65e5\u672c\u8a93.jp&quot;,</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+      asciiHost: &quot;xn--wgv71a309e.jp&quot;,</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+      port: usingWallet ? 389 : -1,</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+      scheme: &quot;ldap&quot;,</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+      path: &quot;/dc=tes%E6%97%A5t??one?(oc=xyz)&quot;,</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+      prePath: &quot;ldap://\u65e5\u672c\u8a93.jp&quot; + portAdpt,</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+      hostPort: &quot;\u65e5\u672c\u8a93.jp&quot; + portAdpt,</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+      dn: &quot;dc=tes\u65e5t&quot;,</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+      scope: Ci.nsILDAPURL.SCOPE_ONELEVEL,</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+      filter: &quot;(oc=xyz)&quot;,</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+      options: 0</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+    },</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+    { url: &quot;ldaps://localhost/dc=test&quot;,</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+      spec: &quot;ldaps://localhost/dc=test&quot;,</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+      asciiSpec: &quot;ldaps://localhost/dc=test&quot;,</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+      host: &quot;localhost&quot;,</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+      asciiHost: &quot;localhost&quot;,</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+      port: -1,</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+      scheme: &quot;ldaps&quot;,</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+      path: &quot;/dc=test&quot;,</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+      prePath: &quot;ldaps://localhost&quot;,</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+      hostPort: &quot;localhost&quot;,</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+      dn: &quot;dc=test&quot;,</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+      scope: Ci.nsILDAPURL.SCOPE_BASE,</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+      filter: &quot;(objectclass=*)&quot;,</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineplus">+      options: Ci.nsILDAPURL.OPT_SECURE</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+    }</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+  ];</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineplus">+</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+function run_test() {</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+  var url;</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineplus">+</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineplus">+  // Get the IO service;</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineplus">+  var ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineplus">+                    .getService(Ci.nsIIOService);</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineplus">+</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineplus">+  // Test - get and check urls.</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineplus">+</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineplus">+  var part = 0;</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineplus">+  for (part = 0; part &lt; ldapURLs.length; ++part)</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineplus">+  {</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineplus">+    dump(&quot;url: &quot; + ldapURLs[part].url + &quot;\n&quot;);</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineplus">+    url = ioService.newURI(ldapURLs[part].url, null, null);</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineplus">+</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineplus">+    do_check_eq(url.spec, ldapURLs[part].spec);</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineplus">+    do_check_eq(url.asciiSpec, ldapURLs[part].asciiSpec);</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineplus">+    do_check_eq(url.scheme, ldapURLs[part].scheme);</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineplus">+    do_check_eq(url.host, ldapURLs[part].host);</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineplus">+    do_check_eq(url.asciiHost, ldapURLs[part].asciiHost);</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineplus">+    do_check_eq(url.port, ldapURLs[part].port);</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineplus">+    do_check_eq(url.path, ldapURLs[part].path);</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineplus">+    do_check_eq(url.prePath, ldapURLs[part].prePath);</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineplus">+    do_check_eq(url.hostPort, ldapURLs[part].hostPort);</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+    // XXX nsLDAPURL ought to have classinfo.</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineplus">+    url = url.QueryInterface(Ci.nsILDAPURL);</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineplus">+    do_check_eq(url.dn, ldapURLs[part].dn);</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineplus">+    do_check_eq(url.scope, ldapURLs[part].scope);</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineplus">+    do_check_eq(url.filter, ldapURLs[part].filter);</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineplus">+    do_check_eq(url.options, ldapURLs[part].options);</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineplus">+  }</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineplus">+</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineplus">+  // Test - Check changing ldap values</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineplus">+  dump(&quot;Other Tests\n&quot;);</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineplus">+</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineplus">+  // Start off with a base url</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineplus">+  const kBaseURL = &quot;ldap://localhost:389/dc=test,dc=abc??sub?(objectclass=*)&quot;;</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineplus">+</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineplus">+  url = ioService.newURI(kBaseURL, null, null)</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineplus">+                 .QueryInterface(Ci.nsILDAPURL);</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineplus">+</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineplus">+  // Test - dn</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineplus">+</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineplus">+  url.dn = &quot;dc=short&quot;;</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineplus">+</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineplus">+  do_check_eq(url.dn, &quot;dc=short&quot;);</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineplus">+  do_check_eq(url.spec, &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??sub?(objectclass=*)&quot;);</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineplus">+</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineplus">+  // Test - scope</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineplus">+</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineplus">+  url.scope = Ci.nsILDAPURL.SCOPE_BASE;</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineplus">+</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineplus">+  do_check_eq(url.scope, Ci.nsILDAPURL.SCOPE_BASE);</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineplus">+  do_check_eq(url.spec, &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short???(objectclass=*)&quot;);</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineplus">+</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineplus">+  url.scope = Ci.nsILDAPURL.SCOPE_ONELEVEL;</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineplus">+</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineplus">+  do_check_eq(url.scope, Ci.nsILDAPURL.SCOPE_ONELEVEL);</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineplus">+  do_check_eq(url.spec, &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;);</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineplus">+</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineplus">+  // Test - filter</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineplus">+</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineplus">+  url.filter = &quot;(oc=ygh)&quot;;</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineplus">+</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineplus">+  do_check_eq(url.filter, &quot;(oc=ygh)&quot;);</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineplus">+  do_check_eq(url.spec, &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??one?(oc=ygh)&quot;);</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineplus">+</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineplus">+  url.filter = &quot;&quot;;</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineplus">+</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineplus">+  do_check_eq(url.filter, &quot;(objectclass=*)&quot;);</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineplus">+  do_check_eq(url.spec, &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;);</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineplus">+</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineplus">+  // Test - scheme</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineplus">+</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineplus">+  // An old version used to have a bug whereby if you set the scheme to the</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineplus">+  // same thing twice, you'd get the options set wrongly.</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineplus">+  url.scheme = &quot;ldaps&quot;;</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineplus">+  do_check_eq(url.options, 1);</span>
<a href="#l13.160"></a><span id="l13.160" class="difflineplus">+  do_check_eq(url.spec, &quot;ldaps://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;);</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineplus">+  url.scheme = &quot;ldaps&quot;;</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineplus">+  do_check_eq(url.options, 1);</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineplus">+  do_check_eq(url.spec, &quot;ldaps://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;);</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineplus">+</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineplus">+  do_check_true(url.schemeIs(&quot;ldaps&quot;));</span>
<a href="#l13.166"></a><span id="l13.166" class="difflineplus">+  do_check_false(url.schemeIs(&quot;ldap&quot;));</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineplus">+</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineplus">+  url.scheme = &quot;ldap&quot;;</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineplus">+  do_check_eq(url.options, 0);</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineplus">+  do_check_eq(url.spec, &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;);</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineplus">+  url.scheme = &quot;ldap&quot;;</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineplus">+  do_check_eq(url.options, 0);</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineplus">+  do_check_eq(url.spec, &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;);</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineplus">+</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineplus">+  do_check_true(url.schemeIs(&quot;ldap&quot;));</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineplus">+  do_check_false(url.schemeIs(&quot;ldaps&quot;));</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineplus">+</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineplus">+  // Test - Options</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineplus">+</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineplus">+  url.options = Ci.nsILDAPURL.OPT_SECURE;</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineplus">+</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineplus">+  do_check_eq(url.options, Ci.nsILDAPURL.OPT_SECURE);</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineplus">+  do_check_eq(url.spec, &quot;ldaps://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;);</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineplus">+</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineplus">+  url.options = 0;</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineplus">+</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineplus">+  do_check_eq(url.options, 0);</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineplus">+  do_check_eq(url.spec, &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;);</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineplus">+</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineplus">+  // Test - Equals</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineplus">+</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineplus">+  var url2 = ioService.newURI(&quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;, null, null)</span>
<a href="#l13.193"></a><span id="l13.193" class="difflineplus">+                      .QueryInterface(Ci.nsILDAPURL);</span>
<a href="#l13.194"></a><span id="l13.194" class="difflineplus">+</span>
<a href="#l13.195"></a><span id="l13.195" class="difflineplus">+  do_check_true(url.equals(url2));</span>
<a href="#l13.196"></a><span id="l13.196" class="difflineplus">+</span>
<a href="#l13.197"></a><span id="l13.197" class="difflineplus">+  url2.spec = &quot;ldap://localhost:389/dc=short??sub?(objectclass=*)&quot;;</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineplus">+</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineplus">+  do_check_false(url.equals(url2));</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineplus">+</span>
<a href="#l13.201"></a><span id="l13.201" class="difflineplus">+  // Test Attributes</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineplus">+</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineplus">+  var attrs = url.getAttributes({});</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineplus">+</span>
<a href="#l13.205"></a><span id="l13.205" class="difflineplus">+  do_check_eq(attrs.length, 0);</span>
<a href="#l13.206"></a><span id="l13.206" class="difflineplus">+</span>
<a href="#l13.207"></a><span id="l13.207" class="difflineplus">+  // Nothing should happend if the attribute doesn't exist</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineplus">+  url.removeAttribute(&quot;abc&quot;);</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineplus">+</span>
<a href="#l13.210"></a><span id="l13.210" class="difflineplus">+  attrs = url.getAttributes({});</span>
<a href="#l13.211"></a><span id="l13.211" class="difflineplus">+  do_check_eq(attrs.length, 0);</span>
<a href="#l13.212"></a><span id="l13.212" class="difflineplus">+  do_check_eq(url.spec, &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;);</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineplus">+</span>
<a href="#l13.214"></a><span id="l13.214" class="difflineplus">+  url.addAttribute(&quot;dn&quot;);</span>
<a href="#l13.215"></a><span id="l13.215" class="difflineplus">+  do_check_eq(url.spec, &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short?dn?one?(objectclass=*)&quot;);</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineplus">+</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineplus">+  attrs = url.getAttributes({});</span>
<a href="#l13.218"></a><span id="l13.218" class="difflineplus">+  do_check_eq(attrs.length, 1);</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineplus">+  do_check_eq(attrs[0], &quot;dn&quot;);</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineplus">+</span>
<a href="#l13.221"></a><span id="l13.221" class="difflineplus">+  url.removeAttribute(&quot;dn&quot;);</span>
<a href="#l13.222"></a><span id="l13.222" class="difflineplus">+</span>
<a href="#l13.223"></a><span id="l13.223" class="difflineplus">+  attrs = url.getAttributes({});</span>
<a href="#l13.224"></a><span id="l13.224" class="difflineplus">+  do_check_eq(attrs.length, 0);</span>
<a href="#l13.225"></a><span id="l13.225" class="difflineplus">+  do_check_eq(url.spec, &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;);</span>
<a href="#l13.226"></a><span id="l13.226" class="difflineplus">+</span>
<a href="#l13.227"></a><span id="l13.227" class="difflineplus">+  var newAttrs = [ &quot;abc&quot;, &quot;def&quot;, &quot;ghi&quot;, &quot;jkl&quot; ];</span>
<a href="#l13.228"></a><span id="l13.228" class="difflineplus">+</span>
<a href="#l13.229"></a><span id="l13.229" class="difflineplus">+  url.setAttributes(newAttrs.length, newAttrs);</span>
<a href="#l13.230"></a><span id="l13.230" class="difflineplus">+</span>
<a href="#l13.231"></a><span id="l13.231" class="difflineplus">+  var i;</span>
<a href="#l13.232"></a><span id="l13.232" class="difflineplus">+</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineplus">+  attrs = url.getAttributes({});</span>
<a href="#l13.234"></a><span id="l13.234" class="difflineplus">+  do_check_eq(attrs.length, newAttrs.length);</span>
<a href="#l13.235"></a><span id="l13.235" class="difflineplus">+  for (i = 0; i &lt; newAttrs.length; ++i)</span>
<a href="#l13.236"></a><span id="l13.236" class="difflineplus">+    do_check_eq(attrs[i], newAttrs[i]);</span>
<a href="#l13.237"></a><span id="l13.237" class="difflineplus">+</span>
<a href="#l13.238"></a><span id="l13.238" class="difflineplus">+  do_check_eq(url.spec, &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short?abc,def,ghi,jkl?one?(objectclass=*)&quot;);</span>
<a href="#l13.239"></a><span id="l13.239" class="difflineplus">+</span>
<a href="#l13.240"></a><span id="l13.240" class="difflineplus">+  do_check_true(url.hasAttribute(&quot;jkl&quot;));</span>
<a href="#l13.241"></a><span id="l13.241" class="difflineplus">+  do_check_true(url.hasAttribute(&quot;def&quot;));</span>
<a href="#l13.242"></a><span id="l13.242" class="difflineplus">+  do_check_true(url.hasAttribute(&quot;ABC&quot;));</span>
<a href="#l13.243"></a><span id="l13.243" class="difflineplus">+  do_check_false(url.hasAttribute(&quot;cde&quot;));</span>
<a href="#l13.244"></a><span id="l13.244" class="difflineplus">+  do_check_false(url.hasAttribute(&quot;3446&quot;));</span>
<a href="#l13.245"></a><span id="l13.245" class="difflineplus">+</span>
<a href="#l13.246"></a><span id="l13.246" class="difflineplus">+  url.removeAttribute(&quot;abc&quot;);</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineplus">+</span>
<a href="#l13.248"></a><span id="l13.248" class="difflineplus">+  attrs = url.getAttributes({});</span>
<a href="#l13.249"></a><span id="l13.249" class="difflineplus">+  do_check_eq(attrs.length, newAttrs.length - 1);</span>
<a href="#l13.250"></a><span id="l13.250" class="difflineplus">+  for (i = 0; i &lt; newAttrs.length - 1; ++i)</span>
<a href="#l13.251"></a><span id="l13.251" class="difflineplus">+    do_check_eq(attrs[i], newAttrs[i + 1]);</span>
<a href="#l13.252"></a><span id="l13.252" class="difflineplus">+</span>
<a href="#l13.253"></a><span id="l13.253" class="difflineplus">+  do_check_eq(url.spec, &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short?def,ghi,jkl?one?(objectclass=*)&quot;);</span>
<a href="#l13.254"></a><span id="l13.254" class="difflineplus">+</span>
<a href="#l13.255"></a><span id="l13.255" class="difflineplus">+  // This shouldn't fail, just clear the list</span>
<a href="#l13.256"></a><span id="l13.256" class="difflineplus">+  url.setAttributes(0, []);</span>
<a href="#l13.257"></a><span id="l13.257" class="difflineplus">+</span>
<a href="#l13.258"></a><span id="l13.258" class="difflineplus">+  attrs = url.getAttributes({});</span>
<a href="#l13.259"></a><span id="l13.259" class="difflineplus">+  do_check_eq(attrs.length, 0);</span>
<a href="#l13.260"></a><span id="l13.260" class="difflineplus">+  do_check_eq(url.spec, &quot;ldap://localhost&quot; + portAdpt + &quot;/dc=short??one?(objectclass=*)&quot;);</span>
<a href="#l13.261"></a><span id="l13.261" class="difflineplus">+</span>
<a href="#l13.262"></a><span id="l13.262" class="difflineplus">+  // Set attributes via the url spec</span>
<a href="#l13.263"></a><span id="l13.263" class="difflineplus">+</span>
<a href="#l13.264"></a><span id="l13.264" class="difflineplus">+  url.spec = &quot;ldap://localhost/dc=short?abc,def,ghi,jkl?one?(objectclass=*)&quot;;</span>
<a href="#l13.265"></a><span id="l13.265" class="difflineplus">+</span>
<a href="#l13.266"></a><span id="l13.266" class="difflineplus">+  attrs = url.getAttributes({});</span>
<a href="#l13.267"></a><span id="l13.267" class="difflineplus">+  do_check_eq(attrs.length, newAttrs.length);</span>
<a href="#l13.268"></a><span id="l13.268" class="difflineplus">+  for (i = 0; i &lt; newAttrs.length; ++i)</span>
<a href="#l13.269"></a><span id="l13.269" class="difflineplus">+    do_check_eq(attrs[i], newAttrs[i]);</span>
<a href="#l13.270"></a><span id="l13.270" class="difflineplus">+</span>
<a href="#l13.271"></a><span id="l13.271" class="difflineplus">+  do_check_eq(url.spec, &quot;ldap://localhost/dc=short?abc,def,ghi,jkl?one?(objectclass=*)&quot;);</span>
<a href="#l13.272"></a><span id="l13.272" class="difflineplus">+</span>
<a href="#l13.273"></a><span id="l13.273" class="difflineplus">+  url.spec = &quot;ldap://localhost/dc=short??one?(objectclass=*)&quot;;</span>
<a href="#l13.274"></a><span id="l13.274" class="difflineplus">+</span>
<a href="#l13.275"></a><span id="l13.275" class="difflineplus">+  attrs = url.getAttributes({});</span>
<a href="#l13.276"></a><span id="l13.276" class="difflineplus">+  do_check_eq(attrs.length, 0);</span>
<a href="#l13.277"></a><span id="l13.277" class="difflineplus">+  do_check_eq(url.spec, &quot;ldap://localhost/dc=short??one?(objectclass=*)&quot;);</span>
<a href="#l13.278"></a><span id="l13.278" class="difflineplus">+</span>
<a href="#l13.279"></a><span id="l13.279" class="difflineplus">+  // Test - clone</span>
<a href="#l13.280"></a><span id="l13.280" class="difflineplus">+</span>
<a href="#l13.281"></a><span id="l13.281" class="difflineplus">+  url.spec = &quot;ldap://localhost/dc=short?abc,def,ghi,jkl?one?(objectclass=*)&quot;;</span>
<a href="#l13.282"></a><span id="l13.282" class="difflineplus">+</span>
<a href="#l13.283"></a><span id="l13.283" class="difflineplus">+  var newUrl = url.clone();</span>
<a href="#l13.284"></a><span id="l13.284" class="difflineplus">+</span>
<a href="#l13.285"></a><span id="l13.285" class="difflineplus">+  do_check_eq(newUrl.spec,</span>
<a href="#l13.286"></a><span id="l13.286" class="difflineplus">+              &quot;ldap://localhost/dc=short?abc,def,ghi,jkl?one?(objectclass=*)&quot;);</span>
<a href="#l13.287"></a><span id="l13.287" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/addrbook/prefs/resources/content/pref-directory-add.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/addrbook/prefs/resources/content/pref-directory-add.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -183,32 +183,38 @@ function fillSettings()</span>
<a href="#l14.4"></a><span id="l14.4">   document.getElementById(&quot;description&quot;).value = gCurrentDirectory.dirName;</span>
<a href="#l14.5"></a><span id="l14.5"> </span>
<a href="#l14.6"></a><span id="l14.6">   if (gCurrentDirectory instanceof Components.interfaces.nsIAbLDAPDirectory) {</span>
<a href="#l14.7"></a><span id="l14.7">     var ldapUrl = gCurrentDirectory.lDAPURL;</span>
<a href="#l14.8"></a><span id="l14.8"> </span>
<a href="#l14.9"></a><span id="l14.9">     document.getElementById(&quot;results&quot;).value = gCurrentDirectory.maxHits;</span>
<a href="#l14.10"></a><span id="l14.10">     document.getElementById(&quot;login&quot;).value = gCurrentDirectory.authDn;</span>
<a href="#l14.11"></a><span id="l14.11">     document.getElementById(&quot;hostname&quot;).value = ldapUrl.host;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-    document.getElementById(&quot;port&quot;).value = ldapUrl.port;</span>
<a href="#l14.13"></a><span id="l14.13">     document.getElementById(&quot;basedn&quot;).value = ldapUrl.dn;</span>
<a href="#l14.14"></a><span id="l14.14">     document.getElementById(&quot;search&quot;).value = ldapUrl.filter;</span>
<a href="#l14.15"></a><span id="l14.15"> </span>
<a href="#l14.16"></a><span id="l14.16">     var sub = document.getElementById(&quot;sub&quot;);</span>
<a href="#l14.17"></a><span id="l14.17">     switch(ldapUrl.scope) {</span>
<a href="#l14.18"></a><span id="l14.18">     case Components.interfaces.nsILDAPURL.SCOPE_ONELEVEL:</span>
<a href="#l14.19"></a><span id="l14.19">       sub.radioGroup.selectedItem = document.getElementById(&quot;one&quot;);</span>
<a href="#l14.20"></a><span id="l14.20">       break;</span>
<a href="#l14.21"></a><span id="l14.21">     default:</span>
<a href="#l14.22"></a><span id="l14.22">       sub.radioGroup.selectedItem = sub;</span>
<a href="#l14.23"></a><span id="l14.23">       break;</span>
<a href="#l14.24"></a><span id="l14.24">     }</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineminus">-    </span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-    if (ldapUrl.options &amp; ldapUrl.OPT_SECURE)</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+    var secure = ldapUrl.options &amp; ldapUrl.OPT_SECURE</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+    if (secure)</span>
<a href="#l14.30"></a><span id="l14.30">       document.getElementById(&quot;secure&quot;).setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+    if (ldapUrl.port == -1)</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+      document.getElementById(&quot;port&quot;).value =</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+        (secure ? kDefaultSecureLDAPPort : kDefaultLDAPPort);</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+    else</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+      document.getElementById(&quot;port&quot;).value = ldapUrl.port;</span>
<a href="#l14.37"></a><span id="l14.37">   }</span>
<a href="#l14.38"></a><span id="l14.38"> </span>
<a href="#l14.39"></a><span id="l14.39">   // check if any of the preferences for this server are locked.</span>
<a href="#l14.40"></a><span id="l14.40">   //If they are locked disable them</span>
<a href="#l14.41"></a><span id="l14.41">   DisableUriFields(gCurrentDirectory.dirPrefId + &quot;.uri&quot;);</span>
<a href="#l14.42"></a><span id="l14.42">   DisableElementIfPrefIsLocked(gCurrentDirectory.dirPrefId + &quot;.description&quot;, &quot;description&quot;);</span>
<a href="#l14.43"></a><span id="l14.43">   DisableElementIfPrefIsLocked(gCurrentDirectory.dirPrefId + &quot;.disable_button_download&quot;, &quot;download&quot;);</span>
<a href="#l14.44"></a><span id="l14.44">   DisableElementIfPrefIsLocked(gCurrentDirectory.dirPrefId + &quot;.maxHits&quot;, &quot;results&quot;);</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineat">@@ -280,59 +286,55 @@ function onAccept()</span>
<a href="#l14.46"></a><span id="l14.46"> {</span>
<a href="#l14.47"></a><span id="l14.47">   var addressbook = Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l14.48"></a><span id="l14.48">                               .getService(Components.interfaces.nsIAbManager);</span>
<a href="#l14.49"></a><span id="l14.49"> </span>
<a href="#l14.50"></a><span id="l14.50">   try {</span>
<a href="#l14.51"></a><span id="l14.51">     var pref_string_content = &quot;&quot;;</span>
<a href="#l14.52"></a><span id="l14.52">     var pref_string_title = &quot;&quot;;</span>
<a href="#l14.53"></a><span id="l14.53"> </span>
<a href="#l14.54"></a><span id="l14.54" class="difflineminus">-    var ldapUrl = Components.classes[&quot;@mozilla.org/network/ldap-url;1&quot;];</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineminus">-    ldapUrl = ldapUrl.createInstance().</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineminus">-      QueryInterface(Components.interfaces.nsILDAPURL);</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineminus">-</span>
<a href="#l14.58"></a><span id="l14.58">     var description = document.getElementById(&quot;description&quot;).value;</span>
<a href="#l14.59"></a><span id="l14.59">     var hostname = document.getElementById(&quot;hostname&quot;).value;</span>
<a href="#l14.60"></a><span id="l14.60">     var port = document.getElementById(&quot;port&quot;).value;</span>
<a href="#l14.61"></a><span id="l14.61">     var secure = document.getElementById(&quot;secure&quot;);</span>
<a href="#l14.62"></a><span id="l14.62">     var results = document.getElementById(&quot;results&quot;).value;</span>
<a href="#l14.63"></a><span id="l14.63">     var errorValue = null;</span>
<a href="#l14.64"></a><span id="l14.64">     if ((!description) || hasOnlyWhitespaces(description))</span>
<a href="#l14.65"></a><span id="l14.65">       errorValue = &quot;invalidName&quot;;</span>
<a href="#l14.66"></a><span id="l14.66">     else if ((!hostname) || hasOnlyWhitespaces(hostname))</span>
<a href="#l14.67"></a><span id="l14.67">       errorValue = &quot;invalidHostname&quot;;</span>
<a href="#l14.68"></a><span id="l14.68">     // XXX write isValidDn and call it on the dn string here?</span>
<a href="#l14.69"></a><span id="l14.69">     else if (port &amp;&amp; hasCharacters(port))</span>
<a href="#l14.70"></a><span id="l14.70">       errorValue = &quot;invalidPortNumber&quot;;</span>
<a href="#l14.71"></a><span id="l14.71">     else if (results &amp;&amp; hasCharacters(results))</span>
<a href="#l14.72"></a><span id="l14.72">       errorValue = &quot;invalidResults&quot;;</span>
<a href="#l14.73"></a><span id="l14.73">     if (!errorValue) {</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+      // XXX Due to the LDAP c-sdk pass a dummy url to the IO service, then</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+      // update the parts (bug 473351).</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+      var ldapUrl = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+        .getService(Components.interfaces.nsIIOService)</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+        .newURI((secure.checked ? &quot;ldaps://&quot; : &quot;ldap://&quot;) + &quot;localhost/dc=???&quot;,</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+                null, null)</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+        .QueryInterface(Components.interfaces.nsILDAPURL);</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+</span>
<a href="#l14.82"></a><span id="l14.82">       ldapUrl.host = hostname;</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+      ldapUrl.port = port ? port :</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+                            (secure.checked ? kDefaultSecureLDAPPort :</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+                                              kDefaultLDAPPort);</span>
<a href="#l14.86"></a><span id="l14.86">       ldapUrl.dn = document.getElementById(&quot;basedn&quot;).value;</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+      ldapUrl.scope = document.getElementById(&quot;one&quot;).selected ?</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+                      Components.interfaces.nsILDAPURL.SCOPE_ONELEVEL :</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+                      Components.interfaces.nsILDAPURL.SCOPE_SUBTREE;</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+</span>
<a href="#l14.91"></a><span id="l14.91">       ldapUrl.filter = document.getElementById(&quot;search&quot;).value;</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineminus">-      if (!port) {</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineminus">-        if (secure.checked)</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineminus">-          ldapUrl.port = kDefaultSecureLDAPPort;</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineminus">-        else</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineminus">-          ldapUrl.port = kDefaultLDAPPort;</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineminus">-      } else {</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineminus">-        ldapUrl.port = port;</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineminus">-      }</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineminus">-      if (document.getElementById(&quot;one&quot;).selected) {</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineminus">-        ldapUrl.scope = Components.interfaces.nsILDAPURL.SCOPE_ONELEVEL;</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineminus">-      } else {</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineminus">-        ldapUrl.scope = Components.interfaces.nsILDAPURL.SCOPE_SUBTREE;</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineminus">-      }</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineminus">-      if (secure.checked)</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineminus">-        ldapUrl.options |= ldapUrl.OPT_SECURE;</span>
<a href="#l14.107"></a><span id="l14.107"> </span>
<a href="#l14.108"></a><span id="l14.108">       // check if we are modifying an existing directory or adding a new directory</span>
<a href="#l14.109"></a><span id="l14.109">       if (gCurrentDirectory) {</span>
<a href="#l14.110"></a><span id="l14.110">         gCurrentDirectory.dirName = description;</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineminus">-        gCurrentDirectory.lDAPURL = ldapUrl;</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineplus">+        gCurrentDirectory.lDAPURL = ldapUrl.QueryInterface(Components.interfaces.nsILDAPURL);</span>
<a href="#l14.113"></a><span id="l14.113">         window.opener.gNewServerString = gCurrentDirectory.dirPrefId;</span>
<a href="#l14.114"></a><span id="l14.114">       }</span>
<a href="#l14.115"></a><span id="l14.115">       else { // adding a new directory</span>
<a href="#l14.116"></a><span id="l14.116">         window.opener.gNewServerString =</span>
<a href="#l14.117"></a><span id="l14.117">           addressbook.newAddressBook(description, ldapUrl.spec, kLDAPDirectory);</span>
<a href="#l14.118"></a><span id="l14.118">       }</span>
<a href="#l14.119"></a><span id="l14.119"> </span>
<a href="#l14.120"></a><span id="l14.120">       // the rdf service</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/addrbook/public/nsIAbLDAPAttributeMap.idl</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsIAbLDAPAttributeMap.idl</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -62,17 +62,17 @@ interface nsIAbCard;</span>
<a href="#l15.4"></a><span id="l15.4">  * property.  The checkState method is a useful tool in enforcing</span>
<a href="#l15.5"></a><span id="l15.5">  * this.  Failure to enforce it may make it impossible to guarantee</span>
<a href="#l15.6"></a><span id="l15.6">  * that getProperty will do something consistent and reasonable.</span>
<a href="#l15.7"></a><span id="l15.7">  *</span>
<a href="#l15.8"></a><span id="l15.8">  * Maybe someday once we support ldap autoconfig stuff (ie</span>
<a href="#l15.9"></a><span id="l15.9">  * draft-joslin-config-schema-11.txt), we can simplify this and other</span>
<a href="#l15.10"></a><span id="l15.10">  * code and only allow a property to map to a single attribute.</span>
<a href="#l15.11"></a><span id="l15.11">  */</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-[scriptable, uuid(bc543118-db5d-4616-b2d4-9a8667609a7c)]</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+[scriptable, uuid(dbfb9974-45ee-41c3-a005-2e8f002c1c9f)]</span>
<a href="#l15.14"></a><span id="l15.14"> interface nsIAbLDAPAttributeMap : nsISupports</span>
<a href="#l15.15"></a><span id="l15.15"> {</span>
<a href="#l15.16"></a><span id="l15.16">   /**</span>
<a href="#l15.17"></a><span id="l15.17">    * Get all the LDAP attributes associated with a given property</span>
<a href="#l15.18"></a><span id="l15.18">    * name, in order of precedence (highest to lowest).</span>
<a href="#l15.19"></a><span id="l15.19">    *</span>
<a href="#l15.20"></a><span id="l15.20">    * @param       aProperty   the address book property to return attrs for   </span>
<a href="#l15.21"></a><span id="l15.21">    *    </span>
<a href="#l15.22"></a><span id="l15.22" class="difflineat">@@ -134,21 +134,22 @@ interface nsIAbLDAPAttributeMap : nsISup</span>
<a href="#l15.23"></a><span id="l15.23">    */</span>
<a href="#l15.24"></a><span id="l15.24">   ACString getProperty(in ACString aAttribute);</span>
<a href="#l15.25"></a><span id="l15.25"> </span>
<a href="#l15.26"></a><span id="l15.26">   /**</span>
<a href="#l15.27"></a><span id="l15.27">    * Get all attributes that may be used in an addressbook card via this</span>
<a href="#l15.28"></a><span id="l15.28">    * property map (used for passing to to an LDAP search when you want</span>
<a href="#l15.29"></a><span id="l15.29">    * everything that could be in a card returned).</span>
<a href="#l15.30"></a><span id="l15.30">    *</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-   * @return                      a comma-separated list of attribute names</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+   * @return                      an array of attribute names</span>
<a href="#l15.33"></a><span id="l15.33">    *</span>
<a href="#l15.34"></a><span id="l15.34">    * @exception NS_ERROR_FAILURE  there are no attributes in this property map</span>
<a href="#l15.35"></a><span id="l15.35">    */</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineminus">-  ACString getAllCardAttributes();</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+  void getAllCardAttributes(out unsigned long aCount,</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+                            [retval, array, size_is(aCount)] out string aAttrs);</span>
<a href="#l15.39"></a><span id="l15.39">   </span>
<a href="#l15.40"></a><span id="l15.40">   /**</span>
<a href="#l15.41"></a><span id="l15.41">    * Get all properties that may be used in an addressbook card via this</span>
<a href="#l15.42"></a><span id="l15.42">    * property map.</span>
<a href="#l15.43"></a><span id="l15.43">    *</span>
<a href="#l15.44"></a><span id="l15.44">    * @return                      an array of properties</span>
<a href="#l15.45"></a><span id="l15.45">    *</span>
<a href="#l15.46"></a><span id="l15.46">    * @exception NS_ERROR_FAILURE  there are no attributes in this property map</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/addrbook/src/Makefile.in</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/addrbook/src/Makefile.in</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -65,16 +65,17 @@ REQUIRES	= xpcom \</span>
<a href="#l16.4"></a><span id="l16.4"> 		  uconv \</span>
<a href="#l16.5"></a><span id="l16.5"> 		  msgbase \</span>
<a href="#l16.6"></a><span id="l16.6"> 		  msgbaseutil \</span>
<a href="#l16.7"></a><span id="l16.7"> 		  mime \</span>
<a href="#l16.8"></a><span id="l16.8"> 		  intl \</span>
<a href="#l16.9"></a><span id="l16.9"> 		  windowwatcher \</span>
<a href="#l16.10"></a><span id="l16.10"> 		  uriloader \</span>
<a href="#l16.11"></a><span id="l16.11"> 		  embed_base \</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+		  loginmgr \</span>
<a href="#l16.13"></a><span id="l16.13"> 		  $(NULL)</span>
<a href="#l16.14"></a><span id="l16.14"> </span>
<a href="#l16.15"></a><span id="l16.15"> CPPSRCS		= \</span>
<a href="#l16.16"></a><span id="l16.16"> 		nsAbManager.cpp \</span>
<a href="#l16.17"></a><span id="l16.17"> 		nsAbRDFDataSource.cpp \</span>
<a href="#l16.18"></a><span id="l16.18"> 		nsDirectoryDataSource.cpp \</span>
<a href="#l16.19"></a><span id="l16.19"> 		nsAbCardProperty.cpp \</span>
<a href="#l16.20"></a><span id="l16.20"> 		nsDirPrefs.cpp \</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPAttributeMap.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPAttributeMap.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -114,27 +114,28 @@ nsAbLDAPAttributeMap.prototype = {</span>
<a href="#l17.4"></a><span id="l17.4"> </span>
<a href="#l17.5"></a><span id="l17.5">     if (!(aAttribute in this.mAttrMap)) {</span>
<a href="#l17.6"></a><span id="l17.6">       return null;</span>
<a href="#l17.7"></a><span id="l17.7">     }</span>
<a href="#l17.8"></a><span id="l17.8"> </span>
<a href="#l17.9"></a><span id="l17.9">     return this.mAttrMap[aAttribute];</span>
<a href="#l17.10"></a><span id="l17.10">   },</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  getAllCardAttributes: function getAllCardAttributes() {</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+  getAllCardAttributes: function getAllCardAttributes(aCount) {</span>
<a href="#l17.14"></a><span id="l17.14">     var attrs = [];</span>
<a href="#l17.15"></a><span id="l17.15">     for each (var prop in this.mPropertyMap) {</span>
<a href="#l17.16"></a><span id="l17.16">       attrs.push(prop);</span>
<a href="#l17.17"></a><span id="l17.17">     }</span>
<a href="#l17.18"></a><span id="l17.18"> </span>
<a href="#l17.19"></a><span id="l17.19">     if (!attrs.length) {</span>
<a href="#l17.20"></a><span id="l17.20">       throw Components.results.NS_ERROR_FAILURE;</span>
<a href="#l17.21"></a><span id="l17.21">     }</span>
<a href="#l17.22"></a><span id="l17.22"> </span>
<a href="#l17.23"></a><span id="l17.23" class="difflineminus">-    return attrs.join(&quot;,&quot;);</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+    aCount.value = attrs.length;</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+    return attrs;</span>
<a href="#l17.26"></a><span id="l17.26">   },</span>
<a href="#l17.27"></a><span id="l17.27">   </span>
<a href="#l17.28"></a><span id="l17.28">   getAllCardProperties: function getAllCardProperties(aCount) {</span>
<a href="#l17.29"></a><span id="l17.29">     </span>
<a href="#l17.30"></a><span id="l17.30">     var props = [];</span>
<a href="#l17.31"></a><span id="l17.31">     for (var prop in this.mPropertyMap) {</span>
<a href="#l17.32"></a><span id="l17.32">       props.push(prop);</span>
<a href="#l17.33"></a><span id="l17.33">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirectory.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPDirectory.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -205,29 +205,25 @@ NS_IMETHODIMP nsAbLDAPDirectory::HasCard</span>
<a href="#l18.4"></a><span id="l18.4"> </span>
<a href="#l18.5"></a><span id="l18.5">   *hasCard = mCache.Get(card, nsnull);</span>
<a href="#l18.6"></a><span id="l18.6">   if (!*hasCard &amp;&amp; mPerformingQuery)</span>
<a href="#l18.7"></a><span id="l18.7">     return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l18.8"></a><span id="l18.8"> </span>
<a href="#l18.9"></a><span id="l18.9">   return NS_OK;</span>
<a href="#l18.10"></a><span id="l18.10"> }</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-NS_IMETHODIMP nsAbLDAPDirectory::GetLDAPURL(nsILDAPURL** url)</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+NS_IMETHODIMP nsAbLDAPDirectory::GetLDAPURL(nsILDAPURL** aResult)</span>
<a href="#l18.14"></a><span id="l18.14"> {</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">-  NS_ENSURE_ARG_POINTER(url);</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineminus">-</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineminus">-  nsresult rv;</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineminus">-  nsCOMPtr&lt;nsILDAPURL&gt; result = do_CreateInstance(NS_LDAPURL_CONTRACTID, &amp;rv);</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l18.21"></a><span id="l18.21"> </span>
<a href="#l18.22"></a><span id="l18.22">   // Rather than using GetURI here we call GetStringValue directly so</span>
<a href="#l18.23"></a><span id="l18.23">   // we can handle the case where the URI isn't specified (see comments</span>
<a href="#l18.24"></a><span id="l18.24">   // below)</span>
<a href="#l18.25"></a><span id="l18.25">   nsCAutoString URI;</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineminus">-  rv = GetStringValue(&quot;uri&quot;, EmptyCString(), URI);</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineplus">+  nsresult rv = GetStringValue(&quot;uri&quot;, EmptyCString(), URI);</span>
<a href="#l18.28"></a><span id="l18.28">   if (NS_FAILED(rv) || URI.IsEmpty())</span>
<a href="#l18.29"></a><span id="l18.29">   {</span>
<a href="#l18.30"></a><span id="l18.30">     /*</span>
<a href="#l18.31"></a><span id="l18.31">      * A recent change in Mozilla now means that the LDAP Address Book</span>
<a href="#l18.32"></a><span id="l18.32">      * RDF Resource URI is based on the unique preference name value i.e.  </span>
<a href="#l18.33"></a><span id="l18.33">      * [moz-abldapdirectory://prefName]</span>
<a href="#l18.34"></a><span id="l18.34">      * Prior to this valid change it was based on the actual uri i.e. </span>
<a href="#l18.35"></a><span id="l18.35">      * [moz-abldapdirectory://host:port/basedn]</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineat">@@ -238,30 +234,29 @@ NS_IMETHODIMP nsAbLDAPDirectory::GetLDAP</span>
<a href="#l18.37"></a><span id="l18.37">      * products could integrate with Mozilla's LDAP Address Books</span>
<a href="#l18.38"></a><span id="l18.38">      * without necessarily having an entry in the preferences file</span>
<a href="#l18.39"></a><span id="l18.39">      * or more importantly needing to be able to change the</span>
<a href="#l18.40"></a><span id="l18.40">      * preferences entries. Thus to set the URI Spec now, it is</span>
<a href="#l18.41"></a><span id="l18.41">      * only necessary to read the uri pref entry, while in the</span>
<a href="#l18.42"></a><span id="l18.42">      * case where it is not a preference, we need to replace the</span>
<a href="#l18.43"></a><span id="l18.43">      * &quot;moz-abldapdirectory&quot;.</span>
<a href="#l18.44"></a><span id="l18.44">      */</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineminus">-    nsCAutoString tempLDAPURL(mURINoQuery);</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineminus">-    if (StringBeginsWith(tempLDAPURL, NS_LITERAL_CSTRING(kLDAPDirectoryRoot)))</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineminus">-      tempLDAPURL.Replace(0, kLDAPDirectoryRootLen, NS_LITERAL_CSTRING(&quot;ldap://&quot;));</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineplus">+    URI = mURINoQuery;</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineplus">+    if (StringBeginsWith(URI, NS_LITERAL_CSTRING(kLDAPDirectoryRoot)))</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+      URI.Replace(0, kLDAPDirectoryRootLen, NS_LITERAL_CSTRING(&quot;ldap://&quot;));</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+  }</span>
<a href="#l18.52"></a><span id="l18.52"> </span>
<a href="#l18.53"></a><span id="l18.53" class="difflineminus">-    rv = result-&gt;SetSpec(tempLDAPURL);</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineminus">-  }</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineminus">-  else</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineminus">-  {</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineminus">-    rv = result-&gt;SetSpec(URI);</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineminus">-  }</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineplus">+  nsCOMPtr&lt;nsIIOService&gt; ioService(do_GetService(NS_IOSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l18.60"></a><span id="l18.60">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.61"></a><span id="l18.61"> </span>
<a href="#l18.62"></a><span id="l18.62" class="difflineminus">-  result.swap(*url);</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineminus">-  return rv;</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; result;</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineplus">+  rv = ioService-&gt;NewURI(URI, nsnull, nsnull, getter_AddRefs(result));</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineplus">+</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineplus">+  return CallQueryInterface(result, aResult);</span>
<a href="#l18.69"></a><span id="l18.69"> }</span>
<a href="#l18.70"></a><span id="l18.70"> </span>
<a href="#l18.71"></a><span id="l18.71"> NS_IMETHODIMP nsAbLDAPDirectory::SetLDAPURL(nsILDAPURL *aUrl)</span>
<a href="#l18.72"></a><span id="l18.72"> {</span>
<a href="#l18.73"></a><span id="l18.73">   NS_ENSURE_ARG_POINTER(aUrl);</span>
<a href="#l18.74"></a><span id="l18.74"> </span>
<a href="#l18.75"></a><span id="l18.75">   nsCAutoString oldUrl;</span>
<a href="#l18.76"></a><span id="l18.76">   // Note, it doesn't matter if GetStringValue fails - we'll just send an</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPDirectoryQuery.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -421,42 +421,48 @@ NS_IMETHODIMP nsAbLDAPDirectoryQuery::Do</span>
<a href="#l19.4"></a><span id="l19.4">       if (login != mCurrentLogin || protocolVersion != mCurrentProtocolVersion)</span>
<a href="#l19.5"></a><span id="l19.5">       {</span>
<a href="#l19.6"></a><span id="l19.6">         redoConnection = PR_TRUE;</span>
<a href="#l19.7"></a><span id="l19.7">         mCurrentLogin = login;</span>
<a href="#l19.8"></a><span id="l19.8">         mCurrentProtocolVersion = protocolVersion;</span>
<a href="#l19.9"></a><span id="l19.9">       }</span>
<a href="#l19.10"></a><span id="l19.10">     }</span>
<a href="#l19.11"></a><span id="l19.11">   }</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-  </span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-  // Now formulate the search string</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-  </span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">-  // Get the scope</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineminus">-  nsCAutoString scope;</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineminus">-  PRBool doSubDirectories;</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineminus">-  rv = aArguments-&gt;GetQuerySubDirectories (&amp;doSubDirectories);</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineplus">+  rv = mDirectoryUrl-&gt;Clone(getter_AddRefs(uri));</span>
<a href="#l19.22"></a><span id="l19.22">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineminus">-  scope = (doSubDirectories) ? &quot;sub&quot; : &quot;one&quot;;</span>
<a href="#l19.24"></a><span id="l19.24"> </span>
<a href="#l19.25"></a><span id="l19.25" class="difflineminus">-  // Get the return attributes</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineplus">+  nsCOMPtr&lt;nsILDAPURL&gt; url(do_QueryInterface(uri, &amp;rv));</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineplus">+</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineplus">+  // Get/Set the return attributes</span>
<a href="#l19.30"></a><span id="l19.30">   nsCOMPtr&lt;nsISupports&gt; iSupportsMap;</span>
<a href="#l19.31"></a><span id="l19.31">   rv = aArguments-&gt;GetTypeSpecificArg(getter_AddRefs(iSupportsMap));</span>
<a href="#l19.32"></a><span id="l19.32">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.33"></a><span id="l19.33"> </span>
<a href="#l19.34"></a><span id="l19.34">   nsCOMPtr&lt;nsIAbLDAPAttributeMap&gt; map = do_QueryInterface(iSupportsMap, &amp;rv);</span>
<a href="#l19.35"></a><span id="l19.35">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.36"></a><span id="l19.36"> </span>
<a href="#l19.37"></a><span id="l19.37">   // Require all attributes that are mapped to card properties</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineminus">-  nsCAutoString returnAttributes;</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineminus">-  rv = map-&gt;GetAllCardAttributes(returnAttributes);</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineminus">-  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;GetAllCardAttributes failed&quot;);</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineplus">+  PRUint32 returnAttrsCount;</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+  char** returnAttrsArray;</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+  rv = map-&gt;GetAllCardAttributes(&amp;returnAttrsCount, &amp;returnAttrsArray);</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineplus">+</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineplus">+  rv = url-&gt;SetAttributes(returnAttrsCount,</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineplus">+                          const_cast&lt;const char**&gt;(returnAttrsArray));</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineplus">+  // First free the array</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineplus">+  NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(returnAttrsCount, returnAttrsArray);</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineplus">+  // Now do the error check</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.52"></a><span id="l19.52"> </span>
<a href="#l19.53"></a><span id="l19.53">   // Also require the objectClass attribute, it is used by</span>
<a href="#l19.54"></a><span id="l19.54">   // nsAbLDAPCard::SetMetaProperties</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineminus">-  returnAttributes.AppendLiteral(&quot;,objectClass&quot;);</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineplus">+  rv = url-&gt;AddAttribute(&quot;objectClass&quot;);</span>
<a href="#l19.57"></a><span id="l19.57"> </span>
<a href="#l19.58"></a><span id="l19.58">   // Get the filter</span>
<a href="#l19.59"></a><span id="l19.59">   nsCOMPtr&lt;nsISupports&gt; supportsExpression;</span>
<a href="#l19.60"></a><span id="l19.60">   rv = aArguments-&gt;GetExpression (getter_AddRefs (supportsExpression));</span>
<a href="#l19.61"></a><span id="l19.61">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.62"></a><span id="l19.62">   </span>
<a href="#l19.63"></a><span id="l19.63">   nsCOMPtr&lt;nsIAbBooleanExpression&gt; expression (do_QueryInterface (supportsExpression, &amp;rv));</span>
<a href="#l19.64"></a><span id="l19.64">   nsCAutoString filter;</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineat">@@ -474,37 +480,21 @@ NS_IMETHODIMP nsAbLDAPDirectoryQuery::Do</span>
<a href="#l19.66"></a><span id="l19.66">    *</span>
<a href="#l19.67"></a><span id="l19.67">    * Default the filter string if blank, otherwise it gets</span>
<a href="#l19.68"></a><span id="l19.68">    * set to (objectclass=*) which returns everything. Set </span>
<a href="#l19.69"></a><span id="l19.69">    * the default to (objectclass=inetorgperson) as this </span>
<a href="#l19.70"></a><span id="l19.70">    * is the most appropriate default objectclass which is </span>
<a href="#l19.71"></a><span id="l19.71">    * central to the makeup of the mozilla ldap address book </span>
<a href="#l19.72"></a><span id="l19.72">    * entries.</span>
<a href="#l19.73"></a><span id="l19.73">    */</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineminus">-  if(filter.IsEmpty())</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineplus">+  if (filter.IsEmpty())</span>
<a href="#l19.76"></a><span id="l19.76">   {</span>
<a href="#l19.77"></a><span id="l19.77">     filter.AssignLiteral(&quot;(objectclass=inetorgperson)&quot;);</span>
<a href="#l19.78"></a><span id="l19.78">   }</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineminus">-  </span>
<a href="#l19.80"></a><span id="l19.80" class="difflineminus">-  nsCAutoString host;</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineminus">-  rv = mDirectoryUrl-&gt;GetAsciiHost(host);</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineminus">-  </span>
<a href="#l19.84"></a><span id="l19.84" class="difflineminus">-  PRInt32 port;</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineminus">-  rv = mDirectoryUrl-&gt;GetPort(&amp;port);</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineminus">-  </span>
<a href="#l19.88"></a><span id="l19.88" class="difflineminus">-  nsCAutoString dn;</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineminus">-  rv = mDirectoryUrl-&gt;GetDn(dn);</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineminus">-  </span>
<a href="#l19.92"></a><span id="l19.92" class="difflineminus">-  PRUint32 options;</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineminus">-  rv = mDirectoryUrl-&gt;GetOptions(&amp;options);</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineminus">-  </span>
<a href="#l19.96"></a><span id="l19.96" class="difflineplus">+</span>
<a href="#l19.97"></a><span id="l19.97">   // get the directoryFilter from the directory url and merge it with the user's</span>
<a href="#l19.98"></a><span id="l19.98">   // search filter</span>
<a href="#l19.99"></a><span id="l19.99">   nsCAutoString urlFilter;</span>
<a href="#l19.100"></a><span id="l19.100">   rv = mDirectoryUrl-&gt;GetFilter(urlFilter);</span>
<a href="#l19.101"></a><span id="l19.101">   </span>
<a href="#l19.102"></a><span id="l19.102">   // if urlFilter is unset (or set to the default &quot;objectclass=*&quot;), there's</span>
<a href="#l19.103"></a><span id="l19.103">   // no need to AND in an empty search term, so leave prefix and suffix empty</span>
<a href="#l19.104"></a><span id="l19.104">   </span>
<a href="#l19.105"></a><span id="l19.105" class="difflineat">@@ -527,38 +517,30 @@ NS_IMETHODIMP nsAbLDAPDirectoryQuery::Do</span>
<a href="#l19.106"></a><span id="l19.106">     }</span>
<a href="#l19.107"></a><span id="l19.107">   </span>
<a href="#l19.108"></a><span id="l19.108">     searchFilter += filter;</span>
<a href="#l19.109"></a><span id="l19.109">     searchFilter += ')';</span>
<a href="#l19.110"></a><span id="l19.110">   } </span>
<a href="#l19.111"></a><span id="l19.111">   else</span>
<a href="#l19.112"></a><span id="l19.112">     searchFilter = filter;</span>
<a href="#l19.113"></a><span id="l19.113"> </span>
<a href="#l19.114"></a><span id="l19.114" class="difflineminus">-  nsCString ldapSearchUrlString;</span>
<a href="#l19.115"></a><span id="l19.115" class="difflineminus">-  char* _ldapSearchUrlString = </span>
<a href="#l19.116"></a><span id="l19.116" class="difflineminus">-    PR_smprintf(&quot;ldap%s://%s:%d/%s?%s?%s?%s&quot;,</span>
<a href="#l19.117"></a><span id="l19.117" class="difflineminus">-                (options &amp; nsILDAPURL::OPT_SECURE) ? &quot;s&quot; : &quot;&quot;,</span>
<a href="#l19.118"></a><span id="l19.118" class="difflineminus">-                host.get(),</span>
<a href="#l19.119"></a><span id="l19.119" class="difflineminus">-                port,</span>
<a href="#l19.120"></a><span id="l19.120" class="difflineminus">-                dn.get(),</span>
<a href="#l19.121"></a><span id="l19.121" class="difflineminus">-                returnAttributes.get(),</span>
<a href="#l19.122"></a><span id="l19.122" class="difflineminus">-                scope.get(),</span>
<a href="#l19.123"></a><span id="l19.123" class="difflineminus">-                searchFilter.get());</span>
<a href="#l19.124"></a><span id="l19.124" class="difflineminus">-</span>
<a href="#l19.125"></a><span id="l19.125" class="difflineminus">-  if (!_ldapSearchUrlString)</span>
<a href="#l19.126"></a><span id="l19.126" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l19.127"></a><span id="l19.127" class="difflineminus">-</span>
<a href="#l19.128"></a><span id="l19.128" class="difflineminus">-  ldapSearchUrlString = _ldapSearchUrlString;</span>
<a href="#l19.129"></a><span id="l19.129" class="difflineminus">-  PR_smprintf_free(_ldapSearchUrlString);</span>
<a href="#l19.130"></a><span id="l19.130" class="difflineminus">-</span>
<a href="#l19.131"></a><span id="l19.131" class="difflineminus">-  nsCOMPtr&lt;nsILDAPURL&gt; url;</span>
<a href="#l19.132"></a><span id="l19.132" class="difflineminus">-  url = do_CreateInstance(NS_LDAPURL_CONTRACTID, &amp;rv);</span>
<a href="#l19.133"></a><span id="l19.133" class="difflineplus">+  rv = url-&gt;SetFilter(searchFilter);</span>
<a href="#l19.134"></a><span id="l19.134">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.135"></a><span id="l19.135"> </span>
<a href="#l19.136"></a><span id="l19.136" class="difflineminus">-  rv = url-&gt;SetSpec(ldapSearchUrlString);</span>
<a href="#l19.137"></a><span id="l19.137" class="difflineplus">+  // Now formulate the search string</span>
<a href="#l19.138"></a><span id="l19.138" class="difflineplus">+  </span>
<a href="#l19.139"></a><span id="l19.139" class="difflineplus">+  // Get the scope</span>
<a href="#l19.140"></a><span id="l19.140" class="difflineplus">+  PRInt32 scope;</span>
<a href="#l19.141"></a><span id="l19.141" class="difflineplus">+  PRBool doSubDirectories;</span>
<a href="#l19.142"></a><span id="l19.142" class="difflineplus">+  rv = aArguments-&gt;GetQuerySubDirectories (&amp;doSubDirectories);</span>
<a href="#l19.143"></a><span id="l19.143" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.144"></a><span id="l19.144" class="difflineplus">+  scope = doSubDirectories ? nsILDAPURL::SCOPE_SUBTREE :</span>
<a href="#l19.145"></a><span id="l19.145" class="difflineplus">+                             nsILDAPURL::SCOPE_ONELEVEL;</span>
<a href="#l19.146"></a><span id="l19.146" class="difflineplus">+</span>
<a href="#l19.147"></a><span id="l19.147" class="difflineplus">+  rv = url-&gt;SetScope(scope);</span>
<a href="#l19.148"></a><span id="l19.148">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.149"></a><span id="l19.149"> </span>
<a href="#l19.150"></a><span id="l19.150">   // too soon? Do we need a new listener?</span>
<a href="#l19.151"></a><span id="l19.151">   // If we already have a connection, and don't need to re-do it, give it the</span>
<a href="#l19.152"></a><span id="l19.152">   // new search details and go for it...</span>
<a href="#l19.153"></a><span id="l19.153">   if (!redoConnection)</span>
<a href="#l19.154"></a><span id="l19.154">   {</span>
<a href="#l19.155"></a><span id="l19.155">     nsAbQueryLDAPMessageListener *msgListener = </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPListenerBase.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -41,18 +41,23 @@</span>
<a href="#l20.4"></a><span id="l20.4"> #include &quot;nsAbLDAPListenerBase.h&quot;</span>
<a href="#l20.5"></a><span id="l20.5"> #include &quot;nsIWindowWatcher.h&quot;</span>
<a href="#l20.6"></a><span id="l20.6"> #include &quot;nsIDOMWindow.h&quot;</span>
<a href="#l20.7"></a><span id="l20.7"> #include &quot;nsIAuthPrompt.h&quot;</span>
<a href="#l20.8"></a><span id="l20.8"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l20.9"></a><span id="l20.9"> #include &quot;nsIProxyObjectManager.h&quot;</span>
<a href="#l20.10"></a><span id="l20.10"> #include &quot;nsILDAPMessage.h&quot;</span>
<a href="#l20.11"></a><span id="l20.11"> #include &quot;nsILDAPErrors.h&quot;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+#ifdef USE_TK_LOGIN_MANAGER</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+#include &quot;nsILoginManager.h&quot;</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+#include &quot;nsILoginInfo.h&quot;</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+#else</span>
<a href="#l20.16"></a><span id="l20.16"> #include &quot;nsCategoryManagerUtils.h&quot;</span>
<a href="#l20.17"></a><span id="l20.17"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineplus">+#endif</span>
<a href="#l20.19"></a><span id="l20.19"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l20.20"></a><span id="l20.20"> #include &quot;nsXPCOMCIDInternal.h&quot;</span>
<a href="#l20.21"></a><span id="l20.21"> </span>
<a href="#l20.22"></a><span id="l20.22"> nsAbLDAPListenerBase::nsAbLDAPListenerBase(nsILDAPURL* url,</span>
<a href="#l20.23"></a><span id="l20.23">                                            nsILDAPConnection* connection,</span>
<a href="#l20.24"></a><span id="l20.24">                                            const nsACString &amp;login,</span>
<a href="#l20.25"></a><span id="l20.25">                                            const PRInt32 timeOut) :</span>
<a href="#l20.26"></a><span id="l20.26">   mDirectoryUrl(url), mConnection(connection), mLogin(login),</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineat">@@ -318,16 +323,54 @@ nsresult nsAbLDAPListenerBase::OnLDAPMes</span>
<a href="#l20.28"></a><span id="l20.28"> </span>
<a href="#l20.29"></a><span id="l20.29">   if (errCode != nsILDAPErrors::SUCCESS)</span>
<a href="#l20.30"></a><span id="l20.30">   {</span>
<a href="#l20.31"></a><span id="l20.31">     // if the login failed, tell the wallet to forget this password</span>
<a href="#l20.32"></a><span id="l20.32">     //</span>
<a href="#l20.33"></a><span id="l20.33">     if (errCode == nsILDAPErrors::INAPPROPRIATE_AUTH ||</span>
<a href="#l20.34"></a><span id="l20.34">         errCode == nsILDAPErrors::INVALID_CREDENTIALS)</span>
<a href="#l20.35"></a><span id="l20.35">     {</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineplus">+#ifdef USE_TK_LOGIN_MANAGER</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+      // Login failed, so try again - but first remove the existing login(s)</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+      // so that the user gets prompted. This may not be the best way of doing</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+      // things, we need to review that later.</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineplus">+</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+      nsCOMPtr&lt;nsILoginManager&gt; loginMgr =</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+        do_GetService(NS_LOGINMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineplus">+</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineplus">+      nsCString spec;</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineplus">+      rv = mDirectoryUrl-&gt;GetSpec(spec);</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineplus">+</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineplus">+      nsCString prePath;</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineplus">+      rv = mDirectoryUrl-&gt;GetPrePath(prePath);</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineplus">+</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineplus">+      PRUint32 count;</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineplus">+      nsILoginInfo** logins;</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineplus">+</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineplus">+      rv = loginMgr-&gt;FindLogins(&amp;count, NS_ConvertUTF8toUTF16(prePath),</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+                                EmptyString(),</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineplus">+                                NS_ConvertUTF8toUTF16(spec), &amp;logins);</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineplus">+</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineplus">+      // Typically there should only be one-login stored for this url, however,</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineplus">+      // just in case there isn't.</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineplus">+      for (PRUint32 i = 0; i &lt; count; ++i)</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineplus">+      {</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineplus">+        rv = loginMgr-&gt;RemoveLogin(logins[i]);</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineplus">+        if (NS_FAILED(rv))</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineplus">+        {</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineplus">+          NS_FREE_XPCOM_ISUPPORTS_POINTER_ARRAY(count, logins);</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineplus">+          return rv;</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineplus">+        }</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineplus">+      }</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineplus">+      NS_FREE_XPCOM_ISUPPORTS_POINTER_ARRAY(count, logins);</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineplus">+#else</span>
<a href="#l20.74"></a><span id="l20.74">       // make sure the wallet service has been created, and in doing so,</span>
<a href="#l20.75"></a><span id="l20.75">       // pass in a login-failed message to tell it to forget this passwd.</span>
<a href="#l20.76"></a><span id="l20.76">       //</span>
<a href="#l20.77"></a><span id="l20.77">       // apparently getting passwords stored in the wallet</span>
<a href="#l20.78"></a><span id="l20.78">       // doesn't require the service to be running, which is why</span>
<a href="#l20.79"></a><span id="l20.79">       // this might not exist yet.</span>
<a href="#l20.80"></a><span id="l20.80">       //</span>
<a href="#l20.81"></a><span id="l20.81">       rv = NS_CreateServicesFromCategory(&quot;passwordmanager&quot;,</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineat">@@ -337,17 +380,20 @@ nsresult nsAbLDAPListenerBase::OnLDAPMes</span>
<a href="#l20.83"></a><span id="l20.83">       {</span>
<a href="#l20.84"></a><span id="l20.84">         NS_ERROR(&quot;nsLDAPAutoCompleteSession::ForgetPassword(): error&quot;</span>
<a href="#l20.85"></a><span id="l20.85">                  &quot; creating password manager service&quot;);</span>
<a href="#l20.86"></a><span id="l20.86">         // not much to do at this point, though conceivably we could </span>
<a href="#l20.87"></a><span id="l20.87">         // pop up a dialog telling the user to go manually delete</span>
<a href="#l20.88"></a><span id="l20.88">         // this password in the password manager.</span>
<a href="#l20.89"></a><span id="l20.89">         return rv;</span>
<a href="#l20.90"></a><span id="l20.90">       }</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineplus">+</span>
<a href="#l20.92"></a><span id="l20.92">       // Login failed, so try again</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineplus">+#endif</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineplus">+</span>
<a href="#l20.95"></a><span id="l20.95">       // XXX We should probably pop up an error dialog telling</span>
<a href="#l20.96"></a><span id="l20.96">       // the user that the login failed here, rather than just bringing </span>
<a href="#l20.97"></a><span id="l20.97">       // up the password dialog again, which is what calling OnLDAPInit()</span>
<a href="#l20.98"></a><span id="l20.98">       // does.</span>
<a href="#l20.99"></a><span id="l20.99">       return OnLDAPInit(nsnull, NS_OK);</span>
<a href="#l20.100"></a><span id="l20.100">     }</span>
<a href="#l20.101"></a><span id="l20.101"> </span>
<a href="#l20.102"></a><span id="l20.102">     // Don't know how to handle this, so use the message error code in</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_ldap1.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_ldap1.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -7,22 +7,17 @@ const kLDAPDirectory = 0; // defined in </span>
<a href="#l21.4"></a><span id="l21.4"> const kLDAPUriPrefix = &quot;moz-abldapdirectory://&quot;;</span>
<a href="#l21.5"></a><span id="l21.5"> const kLDAPTestSpec = &quot;ldap://invalidhost:389//dc=intranet??sub?(objectclass=*)&quot;;</span>
<a href="#l21.6"></a><span id="l21.6"> </span>
<a href="#l21.7"></a><span id="l21.7"> function run_test() {</span>
<a href="#l21.8"></a><span id="l21.8">   // Test - Create an LDAP directory</span>
<a href="#l21.9"></a><span id="l21.9">   var abManager = Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l21.10"></a><span id="l21.10">                             .getService(Components.interfaces.nsIAbManager);</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-  var ldapUrl = Components.classes[&quot;@mozilla.org/network/ldap-url;1&quot;]</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-                          .createInstance(Components.interfaces.nsILDAPURL);</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-  ldapUrl.spec = kLDAPTestSpec;</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineminus">-  var abUri = abManager.newAddressBook(&quot;test&quot;, ldapUrl.spec, kLDAPDirectory);</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+  var abUri = abManager.newAddressBook(&quot;test&quot;, kLDAPTestSpec, kLDAPDirectory);</span>
<a href="#l21.19"></a><span id="l21.19"> </span>
<a href="#l21.20"></a><span id="l21.20">   // Test - Check we have the directory.</span>
<a href="#l21.21"></a><span id="l21.21">   var abDir = abManager.getDirectory(kLDAPUriPrefix + abUri)</span>
<a href="#l21.22"></a><span id="l21.22">                        .QueryInterface(Components.interfaces.nsIAbLDAPDirectory);</span>
<a href="#l21.23"></a><span id="l21.23"> </span>
<a href="#l21.24"></a><span id="l21.24">   // Test - Check various fields</span>
<a href="#l21.25"></a><span id="l21.25">   do_check_eq(abDir.dirName, &quot;test&quot;);</span>
<a href="#l21.26"></a><span id="l21.26">   do_check_eq(abDir.lDAPURL.spec, kLDAPTestSpec);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

