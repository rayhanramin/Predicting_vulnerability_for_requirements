<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 2367:2f6be5c008331d2757276fd065eef1f879e06d93</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 2f6be5c008331d2757276fd065eef1f879e06d93" />
<meta property="og:url" content="/comm-central/rev/2f6be5c008331d2757276fd065eef1f879e06d93" />
<meta property="og:description" content="add autoconfig to trunk, npob, 422814" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 2f6be5c008331d2757276fd065eef1f879e06d93 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/2f6be5c008331d2757276fd065eef1f879e06d93">shortlog</a> |
<a href="/comm-central/log/2f6be5c008331d2757276fd065eef1f879e06d93">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/2f6be5c008331d2757276fd065eef1f879e06d93">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/2f6be5c008331d2757276fd065eef1f879e06d93">files</a> |
changeset |
<a href="/comm-central/raw-rev/2f6be5c008331d2757276fd065eef1f879e06d93">raw</a>  | <a href="/comm-central/archive/2f6be5c008331d2757276fd065eef1f879e06d93.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
add autoconfig to trunk, npob, 422814
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#68;&#97;&#118;&#105;&#100;&#32;&#66;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#32;&#60;&#98;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#64;&#110;&#118;&#101;&#110;&#116;&#117;&#114;&#101;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 09 Apr 2009 16:43:40 -0700</td></tr>

<tr>
 <td>changeset 2367</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/2f6be5c008331d2757276fd065eef1f879e06d93">2f6be5c008331d2757276fd065eef1f879e06d93</a></td>
</tr>



<tr>
<td>parent 2366</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9c76df358a518e609c22e1273eabbaa37cdd8211">9c76df358a518e609c22e1273eabbaa37cdd8211</a>
</td>
</tr>

<tr>
<td>child 2368</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/40a55918155e65bacf937d36dee505257be3144a">40a55918155e65bacf937d36dee505257be3144a</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=2f6be5c008331d2757276fd065eef1f879e06d93">1920</a></td></tr>
<tr><td>push user</td><td>bienvenu@nventure.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 09 Apr 2009 23:43:00 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@2f6be5c00833 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=2f6be5c008331d2757276fd065eef1f879e06d93">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=2f6be5c008331d2757276fd065eef1f879e06d93&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2f6be5c008331d2757276fd065eef1f879e06d93&newProject=comm-central&newRevision=2f6be5c008331d2757276fd065eef1f879e06d93&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2f6be5c008331d2757276fd065eef1f879e06d93&newProject=comm-central&newRevision=2f6be5c008331d2757276fd065eef1f879e06d93&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2f6be5c008331d2757276fd065eef1f879e06d93&newProject=comm-central&newRevision=2f6be5c008331d2757276fd065eef1f879e06d93&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=422814">422814</a></td></tr>




</table></div>

<div class="page_body description">add autoconfig to trunk, npob, 422814</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/MyBadCertHandler.js">mailnews/base/prefs/resources/content/accountcreation/MyBadCertHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/MyBadCertHandler.js">file</a> |
<a href="/comm-central/annotate/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/MyBadCertHandler.js">annotate</a> |
<a href="/comm-central/diff/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/MyBadCertHandler.js">diff</a> |
<a href="/comm-central/comparison/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/MyBadCertHandler.js">comparison</a> |
<a href="/comm-central/log/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/MyBadCertHandler.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/accountConfig.js">mailnews/base/prefs/resources/content/accountcreation/accountConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/accountConfig.js">file</a> |
<a href="/comm-central/annotate/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/accountConfig.js">annotate</a> |
<a href="/comm-central/diff/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/accountConfig.js">diff</a> |
<a href="/comm-central/comparison/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/accountConfig.js">comparison</a> |
<a href="/comm-central/log/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/accountConfig.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/createInBackend.js">mailnews/base/prefs/resources/content/accountcreation/createInBackend.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/createInBackend.js">file</a> |
<a href="/comm-central/annotate/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/createInBackend.js">annotate</a> |
<a href="/comm-central/diff/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/createInBackend.js">diff</a> |
<a href="/comm-central/comparison/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/createInBackend.js">comparison</a> |
<a href="/comm-central/log/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/createInBackend.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/emailWizard.js">mailnews/base/prefs/resources/content/accountcreation/emailWizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/emailWizard.js">file</a> |
<a href="/comm-central/annotate/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/emailWizard.js">annotate</a> |
<a href="/comm-central/diff/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/emailWizard.js">diff</a> |
<a href="/comm-central/comparison/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/emailWizard.js">comparison</a> |
<a href="/comm-central/log/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/emailWizard.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/emailWizard.xul">mailnews/base/prefs/resources/content/accountcreation/emailWizard.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/emailWizard.xul">file</a> |
<a href="/comm-central/annotate/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/emailWizard.xul">annotate</a> |
<a href="/comm-central/diff/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/emailWizard.xul">diff</a> |
<a href="/comm-central/comparison/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/emailWizard.xul">comparison</a> |
<a href="/comm-central/log/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/emailWizard.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/fetchConfig.js">mailnews/base/prefs/resources/content/accountcreation/fetchConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/fetchConfig.js">file</a> |
<a href="/comm-central/annotate/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/fetchConfig.js">annotate</a> |
<a href="/comm-central/diff/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/fetchConfig.js">diff</a> |
<a href="/comm-central/comparison/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/fetchConfig.js">comparison</a> |
<a href="/comm-central/log/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/fetchConfig.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/fetchhttp.js">mailnews/base/prefs/resources/content/accountcreation/fetchhttp.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/fetchhttp.js">file</a> |
<a href="/comm-central/annotate/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/fetchhttp.js">annotate</a> |
<a href="/comm-central/diff/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/fetchhttp.js">diff</a> |
<a href="/comm-central/comparison/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/fetchhttp.js">comparison</a> |
<a href="/comm-central/log/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/fetchhttp.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/guessConfig.js">mailnews/base/prefs/resources/content/accountcreation/guessConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/guessConfig.js">file</a> |
<a href="/comm-central/annotate/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/guessConfig.js">annotate</a> |
<a href="/comm-central/diff/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/guessConfig.js">diff</a> |
<a href="/comm-central/comparison/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/guessConfig.js">comparison</a> |
<a href="/comm-central/log/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/guessConfig.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/readFromXML.js">mailnews/base/prefs/resources/content/accountcreation/readFromXML.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/readFromXML.js">file</a> |
<a href="/comm-central/annotate/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/readFromXML.js">annotate</a> |
<a href="/comm-central/diff/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/readFromXML.js">diff</a> |
<a href="/comm-central/comparison/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/readFromXML.js">comparison</a> |
<a href="/comm-central/log/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/readFromXML.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/sanitizeDatatypes.js">mailnews/base/prefs/resources/content/accountcreation/sanitizeDatatypes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/sanitizeDatatypes.js">file</a> |
<a href="/comm-central/annotate/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/sanitizeDatatypes.js">annotate</a> |
<a href="/comm-central/diff/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/sanitizeDatatypes.js">diff</a> |
<a href="/comm-central/comparison/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/sanitizeDatatypes.js">comparison</a> |
<a href="/comm-central/log/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/sanitizeDatatypes.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/util.js">mailnews/base/prefs/resources/content/accountcreation/util.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/util.js">file</a> |
<a href="/comm-central/annotate/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/util.js">annotate</a> |
<a href="/comm-central/diff/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/util.js">diff</a> |
<a href="/comm-central/comparison/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/util.js">comparison</a> |
<a href="/comm-central/log/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/util.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/verifyConfig.js">mailnews/base/prefs/resources/content/accountcreation/verifyConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/verifyConfig.js">file</a> |
<a href="/comm-central/annotate/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/verifyConfig.js">annotate</a> |
<a href="/comm-central/diff/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/verifyConfig.js">diff</a> |
<a href="/comm-central/comparison/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/verifyConfig.js">comparison</a> |
<a href="/comm-central/log/2f6be5c008331d2757276fd065eef1f879e06d93/mailnews/base/prefs/resources/content/accountcreation/verifyConfig.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1">new file mode 100644</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineminus">--- /dev/null</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineplus">+++ b/mailnews/base/prefs/resources/content/accountcreation/MyBadCertHandler.js</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineat">@@ -0,0 +1,82 @@</span>
<a href="#l1.5"></a><span id="l1.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l1.7"></a><span id="l1.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l1.8"></a><span id="l1.8" class="difflineplus">+ *</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+ *</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+ * License.</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+ *</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+ * The Original Code is the Update Service.</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+ *</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+ * The Initial Developer of the Original Code is Ben Goodger.</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2004</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+ *</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+ *  Darin Fisher &lt;darin@meer.net&gt;</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+ *  Daniel Veditz &lt;dveditz@mozilla.com&gt;</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+ *  David Ascher &lt;dascher@mozilla.com&gt;</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+ *</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+ *</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+/**</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+ * This class implements nsIBadCertListener.  It's job is to prevent &quot;bad cert&quot;</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+ * security dialogs from being shown to the user.  We call back to the</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+ * 'callback' object's methods &quot;processCertError&quot; and &quot;processSSLError&quot;, so</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+ * that it can deal with it as needed (in the case of autoconfig, setting up</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+ * temporary overrides).</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+ */</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+function BadCertHandler(callback)</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+{</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+  this._init(callback);</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+}</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+BadCertHandler.prototype =</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+{</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+  _init: function(callback) {</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+    this._callback = callback;</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+  },</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+  // Suppress any certificate errors</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+  notifyCertProblem: function(socketInfo, status, targetSite) {</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+    return this._callback.processCertError(socketInfo, status, targetSite);</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+  },</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+  // Suppress any ssl errors</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+  notifySSLError: function(socketInfo, error, targetSite) {</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+    return this._callback.processSSLError(socketInfo, status, targetSite);</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+  },</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+  // nsIInterfaceRequestor</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+  getInterface: function(iid) {</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+    return this.QueryInterface(iid);</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+  },</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+  // nsISupports</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+  QueryInterface: function(iid) {</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+    if (!iid.equals(Components.interfaces.nsIBadCertListener2) &amp;&amp;</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+        !iid.equals(Components.interfaces.nsISSLErrorListener) &amp;&amp;</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+        !iid.equals(Components.interfaces.nsIInterfaceRequestor) &amp;&amp;</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+        !iid.equals(Components.interfaces.nsISupports))</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+      throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+    return this;</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+  }</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/mailnews/base/prefs/resources/content/accountcreation/accountConfig.js</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,228 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+ *</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+ *</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+ * License.</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+ *</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+ *</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+ * Ben Bucksch &lt;ben.bucksch  beonex.com&gt;</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008-2009</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+ *</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+ *</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+ * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+ * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+ *</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+/**</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+ * This file creates the class AccountConfig, which is a JS object that holds</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+ * a configuration for a certain account. It is *not* created in the backend</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+ * yet (use aw-createAccount.js for that), and it may be incomplete.</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+ *</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+ * Several AccountConfig objects may co-exist, e.g. for autoconfig.</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+ * One AccountConfig object is used to prefill and read the widgets</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+ * in the Wizard UI.</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+ * When we autoconfigure, we autoconfig writes the values into a</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+ * new object and returns that, and the caller can copy these</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+ * values into the object used by the UI.</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+ *</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+ * See also &lt;https://wiki.mozilla.org/Thunderbird:Autoconfiguration:ConfigFileFormat&gt;</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+ * for values stored.</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+ */</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+function AccountConfig()</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+{</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+  this.incoming =</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+  {</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+    type : null, // string-enum: &quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+    hostname: null,</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+    port : null, // Integer</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+    username : null, // String. May be a placeholder (starts and ends with %).</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+    password : null,</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+    // enum: 1 = plain, 2 = SSL/TLS, 3 = STARTTLS always</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+    // ('TLS when available' is insecure and not supported here)</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+    socketType : null,</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+    auth : null, // enum: 1 = plain, 2 = &quot;secure&quot;</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+    checkInterval : 10, // Integer, in seconds</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+    // POP3 only:</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+    useGlobalInbox : false, // boolean. Not yet implemented.</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+    leaveMessagesOnServer : true,</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+    daysToLeaveMessagesOnServer : 14,</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+    deleteByAgeFromServer : true,</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+    // When user hits delete, delete from local store and from server</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+    deleteOnServerWhenLocalDelete: true</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+  },</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+  this.outgoing =</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+  {</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+    hostname: null,</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+    port : null, // see incoming</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+    username : null, // see incoming. may be null, if auth is 0.</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+    password : null, // see incoming. may be null, if auth is 0.</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+    socketType : null, // see incoming</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+    auth : null, // see incoming. 0 for no auth.</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+    addThisServer: true, // if we already have an SMTP server, add this or not.</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+    // if we already have an SMTP server, use it.</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+    useGlobalPreferredServer : false,</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+    existingServerKey : null, // we should reuse an already configures SMTP server. This is nsISmtpServer.key.</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+    existingServerLabel : null // user display value for existingServerKey</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+  },</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+  this.identity =</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+  {</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+    // displayed real name of user</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+    realname : &quot;%REALNAME%&quot;,</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+    // email address of user, as shown in From of outgoing mails</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+    emailAddress : &quot;%EMAILADDRESS%&quot;</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+  };</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineplus">+  this.inputFields = [];</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+  this.enableURLs = [];</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+  this.domains = [];</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+};</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+AccountConfig.prototype =</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineplus">+{</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+  incoming : null, // see ctor</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+  outgoing : null, // see ctor</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+  id : null, // just an internal string to refer to this. Do not show to user.</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+  source : 0, // who created the config. kSource*</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+  displayName : null,</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+  displayShortName : null,</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+  // Array of Objects with properties varname (value without %), displayName, exampleValue</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+  inputFields : null,</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineplus">+  // Array of Objects with properties url {String}, instruction {String}</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+  enableURLs : null,</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+  // Array of Strings - email address domains for which this config is applicable</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+  domains : null,</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+  /**</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+   * Returns a deep copy of this object,</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+   * i.e. modifying the copy will not affect the original object.</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineplus">+   */</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+  copy : function()</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+  {</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+    // Workaround: deepCopy() fails to preserve base obj (instanceof)</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+    var result = new AccountConfig();</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+    for (var prop in this)</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+      result[prop] = deepCopy(this[prop]);</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineplus">+    return result;</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineplus">+  }</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+};</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+// enum consts</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineplus">+// .source</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+AccountConfig.kSourceUser = 1; // user manually entered the config</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineplus">+AccountConfig.kSourceXML = 2; // config from XML from ISP or Mozilla DB</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineplus">+AccountConfig.kSourceGuess = 3; // guessConfig()</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineplus">+</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineplus">+</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineplus">+/**</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineplus">+ * Some fields on the account config accept placeholders (when coming from XML).</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineplus">+ *</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineplus">+ * These are the predefined ones</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+ * * %EMAILADDRESS% (full email address of the user, usually entered by the user)</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+ * * %EMAILLOCALPART% (email address, part before @)</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+ * * %EMAILDOMAIN% (email address, part after @)</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+ * * %REALNAME%</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+ * as well as those defined in account.inputFields.*.varname, with % added</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+ * before and after.</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+ *</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+ * These must replaced with real values, supplied by the user or app,</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+ * before the account is created. This is done here. You call this function once</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineplus">+ * you have all the data - gathered the standard vars mentioned above as well as</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineplus">+ * all listed in account.inputFields, and pass them in here. This function will</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineplus">+ * insert them in the fields, returning a fully filled-out account ready to be</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineplus">+ * created.</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+ *</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineplus">+ * @param account {AccountConfig}</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineplus">+ * The account data to be modified. It may or may not contain placeholders.</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineplus">+ * After this function, it should not contain placeholders anymore.</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+ * This object will be modified in-place.</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineplus">+ *</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+ * @param emailfull {String}</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineplus">+ * Full email address of this account, e.g. &quot;joe@example.com&quot;.</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+ * Empty of incomplete email addresses will/may be rejected.</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineplus">+ *</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineplus">+ * @param realname {String}</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineplus">+ * Real name of user, as will appear in From of outgoing messages</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineplus">+ *</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+ * @param password {String}</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+ * The password for the incoming server and (if necessary) the outgoing server</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineplus">+ *</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineplus">+ * @param otherVariables {Object}</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineplus">+ * Associative array of variable name</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineplus">+ * (without %) and value, e.g. var name &quot;username&quot; with value &quot;fred&quot;</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineplus">+ * would be passed as JS object { username: &quot;fred&quot; } .</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineplus">+ * The var names must exactly match account.inputFields (all vars supplied,</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineplus">+ * no other vars). If account.inputFields is empty or null, pass {} .</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineplus">+ */</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineplus">+function replaceVariables(account, realname, emailfull, password, otherVariables)</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineplus">+{</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineplus">+  sanitize.nonemptystring(emailfull);</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineplus">+  let emailsplit = emailfull.split(&quot;@&quot;);</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineplus">+  assert(emailsplit.length == 2,</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineplus">+         &quot;email address not in expected format: must contain exactly one @&quot;);</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineplus">+  let emaillocal = sanitize.nonemptystring(emailsplit[0]);</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineplus">+  let emaildomain = sanitize.hostname(emailsplit[1]);</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineplus">+  sanitize.label(realname);</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineplus">+  sanitize.nonemptystring(realname);</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineplus">+</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineplus">+  otherVariables.EMAILADDRESS = emailfull;</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineplus">+  otherVariables.EMAILLOCALPART = emaillocal;</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineplus">+  otherVariables.EMAILDOMAIN = emaildomain;</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineplus">+  otherVariables.REALNAME = realname;</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineplus">+</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineplus">+  account.incoming.password = password;</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineplus">+  account.outgoing.password = password; // set member only if auth required?</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineplus">+  account.incoming.username = _replaceVariable(account.incoming.username,</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineplus">+                                               otherVariables);</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineplus">+  account.outgoing.username = _replaceVariable(account.outgoing.username,</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineplus">+                                               otherVariables);</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineplus">+  account.incoming.hostname =</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineplus">+    sanitize.hostname(_replaceVariable(account.incoming.hostname,</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineplus">+                                       otherVariables));</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineplus">+  if (account.outgoing.hostname) // will be null if user picked existing server.</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineplus">+    account.outgoing.hostname =</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineplus">+      sanitize.hostname(_replaceVariable(account.outgoing.hostname,</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineplus">+                                         otherVariables));</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineplus">+  account.identity.realname =</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineplus">+    _replaceVariable(account.identity.realname, otherVariables);</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineplus">+  account.identity.emailAddress =</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineplus">+    _replaceVariable(account.identity.emailAddress, otherVariables);</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineplus">+  account.displayName = _replaceVariable(account.displayName, otherVariables);</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineplus">+  account.displayShortName =</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineplus">+    _replaceVariable(account.displayShortName, otherVariables);</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineplus">+}</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineplus">+</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineplus">+function _replaceVariable(variable, values)</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineplus">+{</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineplus">+  let str = variable;</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineplus">+  if (typeof(str) != &quot;string&quot;)</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineplus">+    return str;</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineplus">+</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineplus">+  for (let varname in values)</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineplus">+      str = str.replace(&quot;%&quot; + varname + &quot;%&quot;, values[varname]);</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineplus">+</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineplus">+  return str;</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/mailnews/base/prefs/resources/content/accountcreation/createInBackend.js</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,234 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+ *</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+ *</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+ * License.</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+ *</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+ *</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+ * Ben Bucksch &lt;ben.bucksch beonex.com&gt;</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008-2009</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+ *</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+ *   David Bienvenu &lt;bienvenu@davidbienvenu.org&gt;</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+ *</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+ * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+ * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+ *</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+/**</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+ * Takes an AccountConfig JS object and creates that account in the</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+ * Thunderbird backend (which also writes it to prefs).</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+ *</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+ * @param config {AccountConfig} The account to create</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+ *</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+ * @ret - the account created.</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+ */</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+function createAccountInBackend(config)</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+{</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+  const Cc = Components.classes;</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+  const Ci = Components.interfaces;</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+  var accountManager = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+                       .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+  var smtpManager = Cc[&quot;@mozilla.org/messengercompose/smtp;1&quot;]</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+                    .getService(Ci.nsISmtpService);</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+  // incoming server</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+  var inServer = accountManager.createIncomingServer(</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+      config.incoming.username,</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+      config.incoming.hostname,</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+      sanitize.enum(config.incoming.type, [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]));</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+  inServer.port = config.incoming.port;</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+  if (config.rememberPassword);</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+    rememberPassword(inServer, config.incoming.password);</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+  // SSL</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+  inServer.isSecureServer = config.incoming.socketType &gt; 1;</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+  if (config.incoming.socketType == 1) // plain</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+    inServer.socketType = Ci.nsIMsgIncomingServer.defaultSocket;</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+  else if (config.incoming.socketType == 2) // SSL / TLS</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+    inServer.socketType = Ci.nsIMsgIncomingServer.useSSL;</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+  else if (config.incoming.socketType == 3) // STARTTLS</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+    inServer.socketType = Ci.nsIMsgIncomingServer.alwaysUseTLS;</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+  // auth</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+  if (config.incoming.auth == 2) // &quot;secure&quot; auth</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+    inServer.useSecAuth = true;</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+  //inServer.prettyName = config.displayName;</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+  inServer.prettyName = config.identity.emailAddress;</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+  inServer.doBiff = true;</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+  inServer.biffMinutes = config.incoming.checkInterval;</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+  if (config.incoming.type == &quot;pop3&quot;)</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+  {</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+    const leaveOnServerPrefTemplate =</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+      &quot;mail.server.%serverkey%.leave_on_server&quot;;</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+    const daysToLeaveOnServerPrefTemplate =</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+      &quot;mail.server.%serverkey%.num_days_to_leave_on_server&quot;;</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+    const deleteFromServerPrefTemplate =</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+      &quot;mail.server.%serverkey%.delete_mail_left_on_server&quot;;</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+    const deleteByAgeFromServerPrefTemplate =</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+      &quot;mail.server.%serverkey%.delete_by_age_from_server&quot;;</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+    var leaveOnServerPref =</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+      leaveOnServerPrefTemplate.replace(&quot;%serverkey%&quot;, inServer.key);</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+    var ageFromServerPref =</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+      deleteByAgeFromServerPrefTemplate.replace(&quot;%serverkey%&quot;, inServer.key);</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+    var daysToLeaveOnServerPref =</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+      daysToLeaveOnServerPrefTemplate.replace(&quot;%serverkey%&quot;, inServer.key);</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+    var deleteFromServerPref =</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+      deleteFromServerPrefTemplate.replace(&quot;%serverkey%&quot;, inServer.key);</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+    let prefs = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+                .getService(Ci.nsIPrefBranch);</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+    prefs.setBoolPref(leaveOnServerPref,</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+                      config.incoming.leaveMessagesOnServer);</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+    prefs.setIntPref(daysToLeaveOnServerPref,</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+                     config.incoming.daysToLeaveMessagesOnServer);</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+    prefs.setBoolPref(deleteFromServerPref,</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+                      config.incoming.deleteOnServerWhenLocalDelete);</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+    prefs.setBoolPref(ageFromServerPref,</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+                      config.incoming.deleteByAgeFromServer);</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+  }</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+  inServer.valid = true;</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+  // outgoing server</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+  var outServer = null;</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+  assert(config.outgoing.addThisServer ||</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+         config.outgoing.useGlobalPreferredServer ||</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+         config.outgoing.existingServerKey,</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+         &quot;No SMTP server: inconsistent flags&quot;);</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+  if (config.outgoing.addThisServer &amp;&amp;</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+      !smtpManager.findServer(config.outgoing.username,</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+                              config.outgoing.hostname))</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+  {</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineplus">+    var outServer = smtpManager.createSmtpServer();</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineplus">+    outServer.hostname = config.outgoing.hostname;</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+    outServer.port = config.outgoing.port;</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+    if (config.outgoing.auth &gt; 0)</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+    {</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+      outServer.authMethod = 1;</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+      outServer.useSecAuth = config.outgoing.auth == 2;</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+      outServer.username = config.outgoing.username;</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+      outServer.password = config.outgoing.password;</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+      if (config.rememberPassword)</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+        rememberPassword(outServer, config.outgoing.password);</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+    }</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+    else</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+      outServer.authMethod = 0;</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+    if (config.outgoing.socketType == 1) // no SSL</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+      outServer.trySSL = 0; // nsSmtpProtocol.h, line 115</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+    else if (config.outgoing.socketType == 2) // SSL / TLS</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+      outServer.trySSL = 3;</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+    else if (config.outgoing.socketType == 3) // STARTTLS</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+      outServer.trySSL = 2;</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineplus">+    // API problem: &lt;http://mxr.mozilla.org/seamonkey/source/mailnews/compose/public/nsISmtpServer.idl#93&gt;</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineplus">+    outServer.description = config.displayName;</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+    if (config.password)</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+      outServer.password = config.outgoing.password;</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+    // If this is the first SMTP server, set it as default</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineplus">+    if (!smtpManager.defaultServer ||</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+        !smtpManager.defaultServer.hostname)</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+      smtpManager.defaultServer = outServer;</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineplus">+  }</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineplus">+</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineplus">+  // identity</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineplus">+  // TODO accounts without identity?</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineplus">+  var identity = accountManager.createIdentity();</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineplus">+  identity.identityName = config.identity.emailAddress;</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+  identity.fullName = config.identity.realname;</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+  identity.email = config.identity.emailAddress;</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+  if (config.incoming.type == &quot;nntp&quot;)</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+    identity.composeHtml = false;</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+  identity.valid = true;</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineplus">+  // account and hook up</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineplus">+  var account = accountManager.createAccount();</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+  account.incomingServer = inServer;</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineplus">+  account.addIdentity(identity);</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineplus">+  if (!accountManager.defaultAccount)</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineplus">+    accountManager.defaultAccount = account;</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+  if (config.outgoing.existingServerKey)</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+    identity.smtpServerKey = config.outgoing.existingServerKey;</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineplus">+  else if ( ! config.outgoing.useGlobalPreferredServer)</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineplus">+    identity.smtpServerKey = outServer.key;</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+  setFolders(identity, inServer);</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineplus">+</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineplus">+  // save</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineplus">+  accountManager.saveAccountInfo();</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+  try {</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineplus">+    Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineplus">+    .getService(Ci.nsIPrefService)</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+    .savePrefFile(null);</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+  } catch (ex) {</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+    ddump(&quot;Could not write out prefs: &quot; + ex);</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineplus">+  }</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineplus">+  return account;</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineplus">+}</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineplus">+</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineplus">+function setFolders(identity, server)</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineplus">+{</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineplus">+  // TODO: support for local folders for global inbox (or use smart search folder instead)</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineplus">+</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineplus">+  var baseURI = server.serverURI + &quot;/&quot;;</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineplus">+</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineplus">+  // Names will be localized in UI, not in folder names on server/disk</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+  // TODO allow to override these names in the XML config file,</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineplus">+  // in case e.g. Google or AOL use different names?</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineplus">+  // Workaround: Let user fix it :)</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineplus">+  var fccName = &quot;Sent&quot;;</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineplus">+  var draftName = &quot;Drafts&quot;;</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineplus">+  var templatesName = &quot;Templates&quot;;</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineplus">+</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineplus">+  identity.draftFolder = baseURI + draftName;</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineplus">+  identity.stationeryFolder = baseURI + templatesName;</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineplus">+  identity.fccFolder = baseURI + fccName;</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineplus">+</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineplus">+  identity.fccFolderPickerMode = 0;</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+  identity.draftsFolderPickerMode = 0;</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+  identity.tmplFolderPickerMode = 0;</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineplus">+}</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineplus">+</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineplus">+function rememberPassword(server, password)</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineplus">+{</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineplus">+  if (server instanceof Components.interfaces.nsIMsgIncomingServer)</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineplus">+    var passwordURI = server.type + &quot;://&quot; + server.hostName;</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineplus">+  else if (server instanceof Components.interfaces.nsISmtpServer)</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineplus">+    var passwordURI = &quot;smtp://&quot; + server.hostname;</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineplus">+  else</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineplus">+    throw new NotReached(&quot;Server type not supported&quot;);</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineplus">+</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineplus">+  let lm = Cc[&quot;@mozilla.org/login-manager;1&quot;]</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineplus">+           .getService(Ci.nsILoginManager);</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineplus">+  let login = Cc[&quot;@mozilla.org/login-manager/loginInfo;1&quot;]</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineplus">+              .createInstance(Ci.nsILoginInfo);</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineplus">+  login.init(passwordURI, null, passwordURI, server.username, password, &quot;&quot;, &quot;&quot;);</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineplus">+  try {</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineplus">+    lm.addLogin(login);</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineplus">+  } catch (e if e.message.indexOf(&quot;This login already exists&quot;) != -1) {</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineplus">+    // TODO modify</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineplus">+  }</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/mailnews/base/prefs/resources/content/accountcreation/emailWizard.js</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,1625 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+ *</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+ *</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+ * License.</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+ *</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+ *</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+ * David Ascher &lt;davida@mozilla.com&gt; and</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+ * Ben Bucksch &lt;mozilla bucksch.org&gt;</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008-2009</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+ *</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+ * Contributor(s):</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+ *</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+ * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+ * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+ *</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+/**</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+ * This is the dialog opened by menu File | New account | Mail... .</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+ *</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+ * It gets the user's realname, email address and password,</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+ * and tries to automatically configure the account from that,</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+ * using various mechanisms. If all fails, the user can enter/edit</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+ * the config, then we create the account.</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+ *</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+ * Steps:</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+ * - User enters realname, email address and password</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+ * - check for config files on disk</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+ *   (shipping with Thunderbird, for enterprise deployments)</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+ * - (if fails) try to get the config file from the ISP via a</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+ *   fixed URL on the domain of the email address</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+ * - (if fails) try to get the config file from our own database</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+ *   at MoMo servers, maintained by the community</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+ * - (if fails) try to guess the config, by guessing hostnames,</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+ *    probing ports, checking config via server's CAPS line etc..</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+ * - verify the setup, by trying to login to the configured servers</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+ * - let user verify and maybe edit the server names and ports</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+ * - If user clicks OK, create the account</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+ */</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+// from http://xyfer.blogspot.com/2005/01/javascript-regexp-email-validator.html</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+var emailRE = /^[-_a-z0-9\'+*$^&amp;%=~!?{}]+(?:\.[-_a-z0-9\'+*$^&amp;%=~!?{}]+)*@(?:[-a-z0-9.]+\.[a-z]{2,6}|\d{1,3}(?:\.\d{1,3}){3})(?::\d+)?$/i;</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+var domainRE = /^((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$|(\[?(\d{1,3}\.){3}\d{1,3}\]?)$/i</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+const kHighestPort = 65535;</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+Cu.import(&quot;resource://app/modules/gloda/log4moz.js&quot;);</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+let gSmtpManager = Cc[&quot;@mozilla.org/messengercompose/smtp;1&quot;]</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+                   .getService(Ci.nsISmtpService);</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+let gAccountMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+let gEmailWizardLogger = Log4Moz.getConfiguredLogger(&quot;emailwizard&quot;);</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+let gStringsBundle;</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+// debugging aid</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+if (kDebug) {</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+  function getElementById(id)</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+  {</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+    let elt = document.getElementById(id);</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+    if (!elt)</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+    {</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+      gEmailWizardLogger.error(&quot;Can't find element ID: &quot; + id);</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+      return null;</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+    }</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+    return elt;</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+  }</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+} else // production</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+  getElementById = document.getElementById;</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+function _hide(id)</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+{</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+  getElementById(id).hidden = true;</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+}</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+function _show(id)</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+{</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+  getElementById(id).hidden = false;</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+}</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+function EmailConfigWizard()</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+{</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+  this._init();</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+}</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+EmailConfigWizard.prototype =</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+{</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+  _init : function EmailConfigWizard__init()</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+  {</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+    gEmailWizardLogger.info(&quot;Initializing setup wizard&quot;);</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+    this._probeAbortable = null;</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+  },</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+  onLoad : function ()</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+  {</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+    this._email = &quot;&quot;;</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+    this._realname = &quot;&quot;;</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+    this._password = &quot;&quot;;</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+    this._verifiedConfig = false;</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+    this._incomingWarning = 'cleartext';</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+    this._outgoingWarning = 'cleartext';</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+    this._userPickedOutgoingServer = false;</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+    this._userEnteredUsername = null;</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+    this._userEnteredHostname = null;</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+    this._customFields = {}; // map of: field ID from config file {String} -&gt; field value entered by user {String}</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+    this._visitedEnableURLs = {}; // map of: URL {String} -&gt; visited {bool}</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+    if (window.arguments &amp;&amp; window.arguments[0] &amp;&amp;</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+        window.arguments[0].msgWindow)</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+      this._parentMsgWindow = window.arguments[0].msgWindow;</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+    gStringsBundle = getElementById(&quot;strings&quot;);</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+    // Populate SMTP server dropdown with already configured SMTP servers from</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+    // other accounts.</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+    let gSmtpManager = Cc[&quot;@mozilla.org/messengercompose/smtp;1&quot;]</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+                       .getService(Ci.nsISmtpService);</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineplus">+    this._smtpServers = gSmtpManager.smtpServers;</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+    var menupopup = getElementById(&quot;smtp_menupopup&quot;);</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+    while (this._smtpServers.hasMoreElements())</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+    {</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+      var server = this._smtpServers.getNext().QueryInterface(Ci.nsISmtpServer);</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+      var menuitem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+      var label = server.displayname;</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineplus">+      if (server.key == gSmtpManager.defaultServer.key)</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+        label += &quot; &quot; + gStringsBundle.getString(&quot;defaultServerTag&quot;);</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+      menuitem.setAttribute(&quot;label&quot;, label);</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+      menuitem.setAttribute(&quot;value&quot;, server.key);</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+      menuitem.hostname = server.hostname;</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+      menupopup.appendChild(menuitem);</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+    }</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+    var menulist = getElementById(&quot;outgoing_server&quot;);</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+    menulist.addEventListener(&quot;command&quot;,</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+      function() { gEmailConfigWizard.userChangedOutgoing(); }, true);</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineplus">+    menulist.inputField.onmousedown =</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineplus">+      function() { gEmailConfigWizard.clickOnOutgoingServer(); return true; };</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+    menulist.inputField.onchange =</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+      function() { gEmailConfigWizard.setHost(&quot;outgoing_server&quot;); };</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineplus">+    menulist.inputField.oninput =</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineplus">+      function() { gEmailConfigWizard.stopProbing(&quot;outgoing_server&quot;); };</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+  },</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineplus">+</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineplus">+  /* When the next button is clicked we've moved from the initial account</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+   * information stage to using that information to configure account details.</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineplus">+   */</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineplus">+  onNext : function()</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineplus">+  {</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineplus">+    // change the inputs to a flat look</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineplus">+    this._accountInfoInputs(true);</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineplus">+</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineplus">+    this._email = getElementById(&quot;email&quot;).value;</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineplus">+    this._realname = getElementById(&quot;realname&quot;).value;</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+    this._password = getElementById(&quot;password&quot;).value;</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+    this.showConfigDetails();</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineplus">+    let domain = this._email.split(&quot;@&quot;)[1];</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+    this.findConfig(domain, this._email);</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineplus">+    // swap out buttons</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineplus">+    _hide(&quot;next_button&quot;);</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineplus">+    _show(&quot;back_button&quot;);</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineplus">+  },</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineplus">+</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+  /* The back button can be clicked at anytime and should stop all probing of</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+   * account details.  This allows the person to return to their account</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+   * information details in case anything was incorrect.</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineplus">+   *</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineplus">+   * Any account details that were manually entered should be remembered even</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+   * when this back button is clicked</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineplus">+   */</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+  onBack : function()</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineplus">+  {</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+    this.hideConfigDetails();</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineplus">+    this.clearConfigDetails();</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineplus">+</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineplus">+    // change the inputs back to regular</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineplus">+    this._accountInfoInputs(false);</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineplus">+    // swap buttons back</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineplus">+    _show(&quot;next_button&quot;);</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineplus">+    _hide(&quot;back_button&quot;);</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineplus">+  },</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineplus">+</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineplus">+  /* Helper method that enables or disabled all the account information inputs</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineplus">+   *</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineplus">+   * NOTE: The remember password input was skipped purposefully, people should</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineplus">+   *        continue to be able to change that setting even as account details</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineplus">+   *        are determined.</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+   */</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+  _accountInfoInputs : function(disabled)</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineplus">+  {</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineplus">+    let ids = [&quot;realname&quot;,&quot;email&quot;,&quot;password&quot;];</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineplus">+    for ( let i = 0; i &lt; ids.length; i++ )</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineplus">+      getElementById(ids[i]).disabled = disabled;</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineplus">+  },</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineplus">+</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineplus">+  userChangedOutgoing : function ()</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineplus">+  {</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineplus">+    this._outgoingState = 'done';</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineplus">+    this._outgoingWarning = '';</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineplus">+</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineplus">+    if (this._probeAbortable)</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineplus">+      this._probeAbortable.cancel('outgoing');</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineplus">+</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineplus">+    this._userPickedOutgoingServer = true;</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineplus">+    if (this._incomingState == 'done')</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineplus">+      this.foundConfig(this.getUserConfig());</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineplus">+  },</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineplus">+</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineplus">+  setUsername : function(eltId)</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineplus">+  {</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineplus">+    gEmailWizardLogger.info(&quot;doing setUsername: &quot; + eltId);</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineplus">+    let elt = getElementById(eltId);</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineplus">+    this._userEnteredUsername = elt.value;</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineplus">+    // if user edits the username, we should cancel the probing.</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineplus">+    if (this._probeAbortable)</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineplus">+      this._probeAbortable.cancel();</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineplus">+    dump(&quot;in set username, username = &quot; + this._userEnteredUsername + &quot;\n&quot;);</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineplus">+  },</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineplus">+</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineplus">+  /* This does very little other than to check that a name was entered at all</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineplus">+   * Since this is such an insignificant test we should be using a very light</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineplus">+   * or even jovial warning.</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineplus">+   */</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineplus">+  validateRealname : function ()</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineplus">+  {</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineplus">+    if (getElementById('realname').value.toString().length &gt; 0)</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineplus">+      this.clearError('nameerror');</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineplus">+    else</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineplus">+      this.setError(&quot;nameerror&quot;, &quot;name.error&quot;);</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineplus">+  },</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineplus">+</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineplus">+  /* This check is done on blur and is only done as an informative warning</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineplus">+   * we don't want to block the person if they've entered and email that</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineplus">+   * doesn't conform to our regex</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineplus">+   */</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineplus">+  validateEmail : function ()</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineplus">+  {</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineplus">+    if (getElementById('email').value.toString().length &lt;= 0)</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineplus">+      return;</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineplus">+</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineplus">+    if (emailRE.test(getElementById('email').value))</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineplus">+      this.clearError('emailerror');</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineplus">+    else</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineplus">+      this.setError(&quot;emailerror&quot;, &quot;email.error&quot;);</span>
<a href="#l4.270"></a><span id="l4.270" class="difflineplus">+  },</span>
<a href="#l4.271"></a><span id="l4.271" class="difflineplus">+</span>
<a href="#l4.272"></a><span id="l4.272" class="difflineplus">+  /* This check is done on blur and only done as an informative warning,</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineplus">+   *  assuming empty passwords are in fact possible.</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineplus">+   */</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineplus">+  validatePassword : function ()</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineplus">+  {</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineplus">+    if (getElementById('password').value.toString().length &gt; 0)</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineplus">+      this.clearError('passworderror');</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineplus">+    else</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineplus">+      this.setError(&quot;passworderror&quot;, &quot;password.error&quot;);</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineplus">+  },</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineplus">+</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineplus">+  findConfig : function(domain, email)</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineplus">+  {</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineplus">+    gEmailWizardLogger.info(&quot;findConfig()&quot;);</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineplus">+    this.startSpinner(&quot;searching_for_configs&quot;);</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineplus">+    this.setSpinnerStatus(&quot;check_preconfig&quot;);</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineplus">+    if (this._probeAbortable)</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineplus">+    {</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineplus">+      gEmailWizardLogger.info(&quot;aborting existing config search&quot;);</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineplus">+      this._probeAbortable.cancel();</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineplus">+    }</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineplus">+    var me = this;</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineplus">+    this._probeAbortable = fetchConfigFromDisk(domain,</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineplus">+    function(config) // success</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineplus">+    {</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineplus">+      me.foundConfig(config);</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineplus">+      me.stopSpinner(&quot;finished_with_success&quot;);</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineplus">+      me.setSpinnerStatus(&quot;found_preconfig&quot;);</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineplus">+      me._probeAbortable = null;</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineplus">+    },</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineplus">+    function(e) // fetchConfigFromDisk failed</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineplus">+    {</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineplus">+      gEmailWizardLogger.info(&quot;fetchConfigFromDisk failed: &quot; + e);</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineplus">+      me.startSpinner(&quot;searching_for_configs&quot;);</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineplus">+      me.setSpinnerStatus(&quot;checking_config&quot;);</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineplus">+      me._probeAbortable = fetchConfigFromISP(domain, email,</span>
<a href="#l4.308"></a><span id="l4.308" class="difflineplus">+      function(config) // success</span>
<a href="#l4.309"></a><span id="l4.309" class="difflineplus">+      {</span>
<a href="#l4.310"></a><span id="l4.310" class="difflineplus">+        me.foundConfig(config);</span>
<a href="#l4.311"></a><span id="l4.311" class="difflineplus">+        if ((me._incomingState != 'failed') &amp;&amp; (me._outgoingState != 'failed'))</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineplus">+        {</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineplus">+          me.stopSpinner(&quot;finished_with_success&quot;);</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineplus">+          me.setSpinnerStatus(&quot;found_config&quot;);</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineplus">+          me.showEditButton();</span>
<a href="#l4.316"></a><span id="l4.316" class="difflineplus">+        }</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineplus">+        me._probeAbortable = null;</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineplus">+      },</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineplus">+      function(e) // fetchConfigFromISP failed</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineplus">+      {</span>
<a href="#l4.321"></a><span id="l4.321" class="difflineplus">+        gEmailWizardLogger.info(&quot;fetchConfigFromISP failed: &quot; + e);</span>
<a href="#l4.322"></a><span id="l4.322" class="difflineplus">+        me.startSpinner(&quot;searching_for_configs&quot;);</span>
<a href="#l4.323"></a><span id="l4.323" class="difflineplus">+        me.setSpinnerStatus(&quot;checking_mozilla_config&quot;);</span>
<a href="#l4.324"></a><span id="l4.324" class="difflineplus">+        me._probeAbortable = fetchConfigFromDB(domain,</span>
<a href="#l4.325"></a><span id="l4.325" class="difflineplus">+        function(config) // success</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineplus">+        {</span>
<a href="#l4.327"></a><span id="l4.327" class="difflineplus">+          me.foundConfig(config);</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineplus">+          me.stopSpinner(&quot;finished_with_success&quot;);</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineplus">+          me.setSpinnerStatus(&quot;found_isp_config&quot;);</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineplus">+          me.showEditButton();</span>
<a href="#l4.331"></a><span id="l4.331" class="difflineplus">+          me._probeAbortable = null;</span>
<a href="#l4.332"></a><span id="l4.332" class="difflineplus">+        },</span>
<a href="#l4.333"></a><span id="l4.333" class="difflineplus">+        function(e) // fetchConfigFromDB failed</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineplus">+        {</span>
<a href="#l4.335"></a><span id="l4.335" class="difflineplus">+          ddump(&quot;fetchConfigFromDB failed: &quot; + e);</span>
<a href="#l4.336"></a><span id="l4.336" class="difflineplus">+          gEmailWizardLogger.info(&quot;fetchConfigFromDB failed: &quot; + e);</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineplus">+          me.setSpinnerStatus(&quot;probing_config&quot;);</span>
<a href="#l4.338"></a><span id="l4.338" class="difflineplus">+          var initialConfig = new AccountConfig();</span>
<a href="#l4.339"></a><span id="l4.339" class="difflineplus">+          me._prefillConfig(initialConfig);</span>
<a href="#l4.340"></a><span id="l4.340" class="difflineplus">+          me.startSpinner(&quot;searching_for_configs&quot;)</span>
<a href="#l4.341"></a><span id="l4.341" class="difflineplus">+          me.setSpinnerStatus(&quot;guessing_from_email&quot;);</span>
<a href="#l4.342"></a><span id="l4.342" class="difflineplus">+          me._guessConfig(domain, initialConfig, 'both');</span>
<a href="#l4.343"></a><span id="l4.343" class="difflineplus">+        });</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineplus">+      });</span>
<a href="#l4.345"></a><span id="l4.345" class="difflineplus">+    });</span>
<a href="#l4.346"></a><span id="l4.346" class="difflineplus">+  },</span>
<a href="#l4.347"></a><span id="l4.347" class="difflineplus">+</span>
<a href="#l4.348"></a><span id="l4.348" class="difflineplus">+  _guessConfig : function(domain, initialConfig, which)</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineplus">+  {</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineplus">+    let me = this;</span>
<a href="#l4.351"></a><span id="l4.351" class="difflineplus">+    //ddumpObject(initialConfig, &quot;initial config&quot;, 3);</span>
<a href="#l4.352"></a><span id="l4.352" class="difflineplus">+    // guessConfig takes several callback functions, which we define inline.</span>
<a href="#l4.353"></a><span id="l4.353" class="difflineplus">+    me._probeAbortable = guessConfig(domain,</span>
<a href="#l4.354"></a><span id="l4.354" class="difflineplus">+          function(type, hostname, port, ssl, done, config) // progress</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineplus">+          {</span>
<a href="#l4.356"></a><span id="l4.356" class="difflineplus">+            gEmailWizardLogger.info(&quot;progress callback host &quot; + hostname +</span>
<a href="#l4.357"></a><span id="l4.357" class="difflineplus">+                                    &quot;port &quot; +  port + &quot; type &quot; + type);</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineplus">+            if (type == &quot;imap&quot; || type == &quot;pop3&quot;)</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineplus">+            {</span>
<a href="#l4.360"></a><span id="l4.360" class="difflineplus">+              config.incoming.type = type;</span>
<a href="#l4.361"></a><span id="l4.361" class="difflineplus">+              config.incoming.hostname = hostname;</span>
<a href="#l4.362"></a><span id="l4.362" class="difflineplus">+              config.incoming.port = port;</span>
<a href="#l4.363"></a><span id="l4.363" class="difflineplus">+              config.incoming.socketType = ssl;</span>
<a href="#l4.364"></a><span id="l4.364" class="difflineplus">+              config.incoming._inprogress = ! done; // XXX not nice to change the AccountConfig object</span>
<a href="#l4.365"></a><span id="l4.365" class="difflineplus">+            }</span>
<a href="#l4.366"></a><span id="l4.366" class="difflineplus">+            else if (type == &quot;smtp&quot; &amp;&amp; !me._userPickedOutgoingServer)</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineplus">+            {</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineplus">+              dump(&quot;setting outgoing hostname to &quot; + hostname + &quot;\n&quot;);</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineplus">+              config.outgoing.hostname = hostname;</span>
<a href="#l4.370"></a><span id="l4.370" class="difflineplus">+              config.outgoing.port = port;</span>
<a href="#l4.371"></a><span id="l4.371" class="difflineplus">+              config.outgoing.socketType = ssl;</span>
<a href="#l4.372"></a><span id="l4.372" class="difflineplus">+              config.outgoing._inprogress = !done;</span>
<a href="#l4.373"></a><span id="l4.373" class="difflineplus">+            }</span>
<a href="#l4.374"></a><span id="l4.374" class="difflineplus">+            me.updateConfig(config);</span>
<a href="#l4.375"></a><span id="l4.375" class="difflineplus">+          },</span>
<a href="#l4.376"></a><span id="l4.376" class="difflineplus">+          function(config) // success</span>
<a href="#l4.377"></a><span id="l4.377" class="difflineplus">+          {</span>
<a href="#l4.378"></a><span id="l4.378" class="difflineplus">+            me.foundConfig(config);</span>
<a href="#l4.379"></a><span id="l4.379" class="difflineplus">+            dump(&quot;in success, incomingSTate = &quot; + me._incomingState + &quot;outgoing = &quot; + me._outgoingState + &quot;\n&quot;);</span>
<a href="#l4.380"></a><span id="l4.380" class="difflineplus">+            if (me._incomingState == 'done' &amp;&amp; me._outgoingState == 'done')</span>
<a href="#l4.381"></a><span id="l4.381" class="difflineplus">+            {</span>
<a href="#l4.382"></a><span id="l4.382" class="difflineplus">+              me.stopSpinner(&quot;finished_with_success&quot;);</span>
<a href="#l4.383"></a><span id="l4.383" class="difflineplus">+              me.setSpinnerStatus(&quot;config_details_found&quot;);</span>
<a href="#l4.384"></a><span id="l4.384" class="difflineplus">+            }</span>
<a href="#l4.385"></a><span id="l4.385" class="difflineplus">+            else if (me._incomingState == 'done' &amp;&amp; me._outgoingState != 'probing')</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineplus">+            {</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineplus">+              me.stopSpinner(&quot;finished_with_success&quot;);</span>
<a href="#l4.388"></a><span id="l4.388" class="difflineplus">+              me.setSpinnerStatus(&quot;incoming_found_specify_outgoing&quot;);</span>
<a href="#l4.389"></a><span id="l4.389" class="difflineplus">+            }</span>
<a href="#l4.390"></a><span id="l4.390" class="difflineplus">+            else if (me._outgoingState == 'done' &amp;&amp; me._incomingState != 'probing')</span>
<a href="#l4.391"></a><span id="l4.391" class="difflineplus">+            {</span>
<a href="#l4.392"></a><span id="l4.392" class="difflineplus">+              me.stopSpinner(&quot;finished_with_success&quot;);</span>
<a href="#l4.393"></a><span id="l4.393" class="difflineplus">+              me.setSpinnerStatus(&quot;outgoing_found_specify_incoming&quot;);</span>
<a href="#l4.394"></a><span id="l4.394" class="difflineplus">+            }</span>
<a href="#l4.395"></a><span id="l4.395" class="difflineplus">+            if (me._outgoingState != 'probing' &amp;&amp;</span>
<a href="#l4.396"></a><span id="l4.396" class="difflineplus">+                me._incomingState != 'probing')</span>
<a href="#l4.397"></a><span id="l4.397" class="difflineplus">+              me._probeAbortable = null;</span>
<a href="#l4.398"></a><span id="l4.398" class="difflineplus">+</span>
<a href="#l4.399"></a><span id="l4.399" class="difflineplus">+            _hide(&quot;stop_button&quot;);</span>
<a href="#l4.400"></a><span id="l4.400" class="difflineplus">+            _show(&quot;edit_button&quot;);</span>
<a href="#l4.401"></a><span id="l4.401" class="difflineplus">+          },</span>
<a href="#l4.402"></a><span id="l4.402" class="difflineplus">+          function(e, config) // guessconfig failed</span>
<a href="#l4.403"></a><span id="l4.403" class="difflineplus">+          {</span>
<a href="#l4.404"></a><span id="l4.404" class="difflineplus">+            gEmailWizardLogger.info(&quot;guessConfig failed: &quot; + e);</span>
<a href="#l4.405"></a><span id="l4.405" class="difflineplus">+            me.updateConfig(config);</span>
<a href="#l4.406"></a><span id="l4.406" class="difflineplus">+            me.stopSpinner(&quot;finished_with_errors&quot;);</span>
<a href="#l4.407"></a><span id="l4.407" class="difflineplus">+            me.setSpinnerStatus(&quot;enter_missing_hostnames&quot;);</span>
<a href="#l4.408"></a><span id="l4.408" class="difflineplus">+            me._probeAbortable = null;</span>
<a href="#l4.409"></a><span id="l4.409" class="difflineplus">+            me.editConfigDetails();</span>
<a href="#l4.410"></a><span id="l4.410" class="difflineplus">+          },</span>
<a href="#l4.411"></a><span id="l4.411" class="difflineplus">+          function(e, config) // guessconfig failed for incoming</span>
<a href="#l4.412"></a><span id="l4.412" class="difflineplus">+          {</span>
<a href="#l4.413"></a><span id="l4.413" class="difflineplus">+            gEmailWizardLogger.info(&quot;guessConfig failed for incoming: &quot; + e);</span>
<a href="#l4.414"></a><span id="l4.414" class="difflineplus">+            me.setSpinnerStatus(&quot;incoming_failed_trying_outgoing&quot;);</span>
<a href="#l4.415"></a><span id="l4.415" class="difflineplus">+            config.incoming.hostname = -1;</span>
<a href="#l4.416"></a><span id="l4.416" class="difflineplus">+            me.updateConfig(config);</span>
<a href="#l4.417"></a><span id="l4.417" class="difflineplus">+            me.editConfigDetails();</span>
<a href="#l4.418"></a><span id="l4.418" class="difflineplus">+          },</span>
<a href="#l4.419"></a><span id="l4.419" class="difflineplus">+          function(e, config) // guessconfig failed for outgoing</span>
<a href="#l4.420"></a><span id="l4.420" class="difflineplus">+          {</span>
<a href="#l4.421"></a><span id="l4.421" class="difflineplus">+            gEmailWizardLogger.info(&quot;guessConfig failed for outgoing: &quot; + e);</span>
<a href="#l4.422"></a><span id="l4.422" class="difflineplus">+            me.setSpinnerStatus(&quot;outgoing_failed_trying_incoming&quot;);</span>
<a href="#l4.423"></a><span id="l4.423" class="difflineplus">+            if (!me._userPickedOutgoingServer)</span>
<a href="#l4.424"></a><span id="l4.424" class="difflineplus">+              config.outgoing.hostname = -1;</span>
<a href="#l4.425"></a><span id="l4.425" class="difflineplus">+</span>
<a href="#l4.426"></a><span id="l4.426" class="difflineplus">+            me.updateConfig(config);</span>
<a href="#l4.427"></a><span id="l4.427" class="difflineplus">+            me.editConfigDetails();</span>
<a href="#l4.428"></a><span id="l4.428" class="difflineplus">+          },</span>
<a href="#l4.429"></a><span id="l4.429" class="difflineplus">+    initialConfig, which);</span>
<a href="#l4.430"></a><span id="l4.430" class="difflineplus">+  },</span>
<a href="#l4.431"></a><span id="l4.431" class="difflineplus">+</span>
<a href="#l4.432"></a><span id="l4.432" class="difflineplus">+  foundConfig : function(config)</span>
<a href="#l4.433"></a><span id="l4.433" class="difflineplus">+  {</span>
<a href="#l4.434"></a><span id="l4.434" class="difflineplus">+    gEmailWizardLogger.info(&quot;foundConfig()&quot;);</span>
<a href="#l4.435"></a><span id="l4.435" class="difflineplus">+    assert(config instanceof AccountConfig, &quot;BUG: Arg 'config' needs to be an AccountConfig object&quot;);</span>
<a href="#l4.436"></a><span id="l4.436" class="difflineplus">+</span>
<a href="#l4.437"></a><span id="l4.437" class="difflineplus">+    if (!config)</span>
<a href="#l4.438"></a><span id="l4.438" class="difflineplus">+      config = new AccountConfig();</span>
<a href="#l4.439"></a><span id="l4.439" class="difflineplus">+</span>
<a href="#l4.440"></a><span id="l4.440" class="difflineplus">+    this._currentConfig = config;</span>
<a href="#l4.441"></a><span id="l4.441" class="difflineplus">+    this._haveValidConfigForDomain = this._email.split(&quot;@&quot;)[1];;</span>
<a href="#l4.442"></a><span id="l4.442" class="difflineplus">+</span>
<a href="#l4.443"></a><span id="l4.443" class="difflineplus">+    if (!this._realname || !this._email)</span>
<a href="#l4.444"></a><span id="l4.444" class="difflineplus">+      return;</span>
<a href="#l4.445"></a><span id="l4.445" class="difflineplus">+</span>
<a href="#l4.446"></a><span id="l4.446" class="difflineplus">+    return this._foundConfig2(config);</span>
<a href="#l4.447"></a><span id="l4.447" class="difflineplus">+  },</span>
<a href="#l4.448"></a><span id="l4.448" class="difflineplus">+  // Continuation of foundConfig2() after custom fields and enableURLs.</span>
<a href="#l4.449"></a><span id="l4.449" class="difflineplus">+  _foundConfig2 : function(config)</span>
<a href="#l4.450"></a><span id="l4.450" class="difflineplus">+  {</span>
<a href="#l4.451"></a><span id="l4.451" class="difflineplus">+    this._currentConfigFilledIn = config.copy();</span>
<a href="#l4.452"></a><span id="l4.452" class="difflineplus">+    replaceVariables(this._currentConfigFilledIn, this._realname, this._email,</span>
<a href="#l4.453"></a><span id="l4.453" class="difflineplus">+                     this._password, this._customFields);</span>
<a href="#l4.454"></a><span id="l4.454" class="difflineplus">+</span>
<a href="#l4.455"></a><span id="l4.455" class="difflineplus">+    this.updateConfig(this._currentConfigFilledIn);</span>
<a href="#l4.456"></a><span id="l4.456" class="difflineplus">+</span>
<a href="#l4.457"></a><span id="l4.457" class="difflineplus">+    getElementById('create_button').disabled = false;</span>
<a href="#l4.458"></a><span id="l4.458" class="difflineplus">+    getElementById('create_button').hidden = false;</span>
<a href="#l4.459"></a><span id="l4.459" class="difflineplus">+</span>
<a href="#l4.460"></a><span id="l4.460" class="difflineplus">+  },</span>
<a href="#l4.461"></a><span id="l4.461" class="difflineplus">+</span>
<a href="#l4.462"></a><span id="l4.462" class="difflineplus">+  checkOutgoingAccountIsNew : function()</span>
<a href="#l4.463"></a><span id="l4.463" class="difflineplus">+  {</span>
<a href="#l4.464"></a><span id="l4.464" class="difflineplus">+    var smtpServers = gSmtpManager.smtpServers;</span>
<a href="#l4.465"></a><span id="l4.465" class="difflineplus">+    while (smtpServers.hasMoreElements())</span>
<a href="#l4.466"></a><span id="l4.466" class="difflineplus">+    {</span>
<a href="#l4.467"></a><span id="l4.467" class="difflineplus">+      let existingServer = smtpServers.getNext().QueryInterface(Components.interfaces.nsISmtpServer);</span>
<a href="#l4.468"></a><span id="l4.468" class="difflineplus">+      if (existingServer.hostname == this._currentConfigFilledIn.outgoing.hostname &amp;&amp;</span>
<a href="#l4.469"></a><span id="l4.469" class="difflineplus">+          existingServer.port == this._currentConfigFilledIn.outgoing.port &amp;&amp;</span>
<a href="#l4.470"></a><span id="l4.470" class="difflineplus">+          existingServer.username == this._currentConfigFilledIn.outgoing.username)</span>
<a href="#l4.471"></a><span id="l4.471" class="difflineplus">+        return false;</span>
<a href="#l4.472"></a><span id="l4.472" class="difflineplus">+    }</span>
<a href="#l4.473"></a><span id="l4.473" class="difflineplus">+    return true;</span>
<a href="#l4.474"></a><span id="l4.474" class="difflineplus">+  },</span>
<a href="#l4.475"></a><span id="l4.475" class="difflineplus">+</span>
<a href="#l4.476"></a><span id="l4.476" class="difflineplus">+  checkIncomingAccountIsNew : function()</span>
<a href="#l4.477"></a><span id="l4.477" class="difflineplus">+  {</span>
<a href="#l4.478"></a><span id="l4.478" class="difflineplus">+    let incoming = this._currentConfigFilledIn.incoming;</span>
<a href="#l4.479"></a><span id="l4.479" class="difflineplus">+    return gAccountMgr.findRealServer(incoming.username,</span>
<a href="#l4.480"></a><span id="l4.480" class="difflineplus">+                                      incoming.hostname,</span>
<a href="#l4.481"></a><span id="l4.481" class="difflineplus">+                                      sanitize.enum(incoming.type,</span>
<a href="#l4.482"></a><span id="l4.482" class="difflineplus">+                                                    [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]),</span>
<a href="#l4.483"></a><span id="l4.483" class="difflineplus">+                                      incoming.port) == null;</span>
<a href="#l4.484"></a><span id="l4.484" class="difflineplus">+  },</span>
<a href="#l4.485"></a><span id="l4.485" class="difflineplus">+</span>
<a href="#l4.486"></a><span id="l4.486" class="difflineplus">+  toggleAcknowledgeIncoming : function()</span>
<a href="#l4.487"></a><span id="l4.487" class="difflineplus">+  {</span>
<a href="#l4.488"></a><span id="l4.488" class="difflineplus">+    this._incomingWarningAcknowledged =</span>
<a href="#l4.489"></a><span id="l4.489" class="difflineplus">+      getElementById('acknowledge_incoming').checked;</span>
<a href="#l4.490"></a><span id="l4.490" class="difflineplus">+    this.checkEnableIKnow();</span>
<a href="#l4.491"></a><span id="l4.491" class="difflineplus">+  },</span>
<a href="#l4.492"></a><span id="l4.492" class="difflineplus">+</span>
<a href="#l4.493"></a><span id="l4.493" class="difflineplus">+  toggleAcknowledgeOutgoing : function()</span>
<a href="#l4.494"></a><span id="l4.494" class="difflineplus">+  {</span>
<a href="#l4.495"></a><span id="l4.495" class="difflineplus">+    this._outgoingWarningAcknowledged =</span>
<a href="#l4.496"></a><span id="l4.496" class="difflineplus">+      getElementById('acknowledge_outgoing').checked;</span>
<a href="#l4.497"></a><span id="l4.497" class="difflineplus">+    this.checkEnableIKnow();</span>
<a href="#l4.498"></a><span id="l4.498" class="difflineplus">+  },</span>
<a href="#l4.499"></a><span id="l4.499" class="difflineplus">+</span>
<a href="#l4.500"></a><span id="l4.500" class="difflineplus">+  checkEnableIKnow: function()</span>
<a href="#l4.501"></a><span id="l4.501" class="difflineplus">+  {</span>
<a href="#l4.502"></a><span id="l4.502" class="difflineplus">+    if ((!this._incomingWarning || this._incomingWarningAcknowledged) &amp;&amp;</span>
<a href="#l4.503"></a><span id="l4.503" class="difflineplus">+        (!this._outgoingWarning || this._outgoingWarningAcknowledged))</span>
<a href="#l4.504"></a><span id="l4.504" class="difflineplus">+      document.getElementById('iknow').disabled = false;</span>
<a href="#l4.505"></a><span id="l4.505" class="difflineplus">+    else</span>
<a href="#l4.506"></a><span id="l4.506" class="difflineplus">+      document.getElementById('iknow').disabled = true;</span>
<a href="#l4.507"></a><span id="l4.507" class="difflineplus">+  },</span>
<a href="#l4.508"></a><span id="l4.508" class="difflineplus">+</span>
<a href="#l4.509"></a><span id="l4.509" class="difflineplus">+  onOK : function()</span>
<a href="#l4.510"></a><span id="l4.510" class="difflineplus">+  {</span>
<a href="#l4.511"></a><span id="l4.511" class="difflineplus">+    try {</span>
<a href="#l4.512"></a><span id="l4.512" class="difflineplus">+</span>
<a href="#l4.513"></a><span id="l4.513" class="difflineplus">+      gEmailWizardLogger.info(&quot;OK/Create button clicked&quot;);</span>
<a href="#l4.514"></a><span id="l4.514" class="difflineplus">+</span>
<a href="#l4.515"></a><span id="l4.515" class="difflineplus">+      // we can't check if the account already exists here, because</span>
<a href="#l4.516"></a><span id="l4.516" class="difflineplus">+      // we created it to test the password already.</span>
<a href="#l4.517"></a><span id="l4.517" class="difflineplus">+      if (this._outgoingWarning || this._incomingWarning)</span>
<a href="#l4.518"></a><span id="l4.518" class="difflineplus">+      {</span>
<a href="#l4.519"></a><span id="l4.519" class="difflineplus">+        _hide('mastervbox');</span>
<a href="#l4.520"></a><span id="l4.520" class="difflineplus">+        _show('warningbox');</span>
<a href="#l4.521"></a><span id="l4.521" class="difflineplus">+</span>
<a href="#l4.522"></a><span id="l4.522" class="difflineplus">+        let incomingwarningstring;</span>
<a href="#l4.523"></a><span id="l4.523" class="difflineplus">+        let outgoingwarningstring;</span>
<a href="#l4.524"></a><span id="l4.524" class="difflineplus">+        let incoming = this._currentConfigFilledIn.incoming;</span>
<a href="#l4.525"></a><span id="l4.525" class="difflineplus">+        let incoming_settings = incoming.hostname + ':' + incoming.port +</span>
<a href="#l4.526"></a><span id="l4.526" class="difflineplus">+                                ' (' + sslLabel(incoming.socketType) + ')';</span>
<a href="#l4.527"></a><span id="l4.527" class="difflineplus">+        let outgoing = this._currentConfigFilledIn.outgoing;</span>
<a href="#l4.528"></a><span id="l4.528" class="difflineplus">+        let outgoing_settings = outgoing.hostname + ':' + outgoing.port +</span>
<a href="#l4.529"></a><span id="l4.529" class="difflineplus">+                                ' (' + sslLabel(outgoing.socketType) + ')';</span>
<a href="#l4.530"></a><span id="l4.530" class="difflineplus">+        switch (this._incomingWarning)</span>
<a href="#l4.531"></a><span id="l4.531" class="difflineplus">+        {</span>
<a href="#l4.532"></a><span id="l4.532" class="difflineplus">+          case 'cleartext':</span>
<a href="#l4.533"></a><span id="l4.533" class="difflineplus">+            incomingwarningstring = gStringsBundle.getString(&quot;cleartext_incoming&quot;);</span>
<a href="#l4.534"></a><span id="l4.534" class="difflineplus">+            setText('warning_incoming', incomingwarningstring);</span>
<a href="#l4.535"></a><span id="l4.535" class="difflineplus">+            _show('incoming_box');</span>
<a href="#l4.536"></a><span id="l4.536" class="difflineplus">+            setText('incoming_settings', incoming_settings);</span>
<a href="#l4.537"></a><span id="l4.537" class="difflineplus">+            _show('acknowledge_incoming');</span>
<a href="#l4.538"></a><span id="l4.538" class="difflineplus">+            break;</span>
<a href="#l4.539"></a><span id="l4.539" class="difflineplus">+          case 'selfsigned':</span>
<a href="#l4.540"></a><span id="l4.540" class="difflineplus">+            incomingwarningstring = gStringsBundle.getString(&quot;selfsigned_incoming&quot;);</span>
<a href="#l4.541"></a><span id="l4.541" class="difflineplus">+            setText('warning_incoming', incomingwarningstring);</span>
<a href="#l4.542"></a><span id="l4.542" class="difflineplus">+            setText('incoming_settings', incoming_settings);</span>
<a href="#l4.543"></a><span id="l4.543" class="difflineplus">+            _show('incoming_box');</span>
<a href="#l4.544"></a><span id="l4.544" class="difflineplus">+            _show('acknowledge_incoming');</span>
<a href="#l4.545"></a><span id="l4.545" class="difflineplus">+            break;</span>
<a href="#l4.546"></a><span id="l4.546" class="difflineplus">+          case '':</span>
<a href="#l4.547"></a><span id="l4.547" class="difflineplus">+            _hide('incoming_box');</span>
<a href="#l4.548"></a><span id="l4.548" class="difflineplus">+            _hide('acknowledge_incoming');</span>
<a href="#l4.549"></a><span id="l4.549" class="difflineplus">+        }</span>
<a href="#l4.550"></a><span id="l4.550" class="difflineplus">+        switch (this._outgoingWarning)</span>
<a href="#l4.551"></a><span id="l4.551" class="difflineplus">+        {</span>
<a href="#l4.552"></a><span id="l4.552" class="difflineplus">+          case 'cleartext':</span>
<a href="#l4.553"></a><span id="l4.553" class="difflineplus">+            outgoingwarningstring = gStringsBundle.getString(&quot;cleartext_outgoing&quot;);</span>
<a href="#l4.554"></a><span id="l4.554" class="difflineplus">+            setText('warning_outgoing', outgoingwarningstring);</span>
<a href="#l4.555"></a><span id="l4.555" class="difflineplus">+            setText('outgoing_settings', outgoing_settings);</span>
<a href="#l4.556"></a><span id="l4.556" class="difflineplus">+            _show('outgoing_box');</span>
<a href="#l4.557"></a><span id="l4.557" class="difflineplus">+            _show('acknowledge_outgoing');</span>
<a href="#l4.558"></a><span id="l4.558" class="difflineplus">+            break;</span>
<a href="#l4.559"></a><span id="l4.559" class="difflineplus">+          case 'selfsigned':</span>
<a href="#l4.560"></a><span id="l4.560" class="difflineplus">+            outgoingwarningstring = gStringsBundle.getString(&quot;selfsigned_outgoing&quot;);</span>
<a href="#l4.561"></a><span id="l4.561" class="difflineplus">+            setText('warning_outgoing', outgoingwarningstring);</span>
<a href="#l4.562"></a><span id="l4.562" class="difflineplus">+            setText('outgoing_settings', outgoing_settings);</span>
<a href="#l4.563"></a><span id="l4.563" class="difflineplus">+            _show('outgoing_box');</span>
<a href="#l4.564"></a><span id="l4.564" class="difflineplus">+            _show('acknowledge_outgoing');</span>
<a href="#l4.565"></a><span id="l4.565" class="difflineplus">+            break;</span>
<a href="#l4.566"></a><span id="l4.566" class="difflineplus">+          case '':</span>
<a href="#l4.567"></a><span id="l4.567" class="difflineplus">+            _hide('outgoing_box');</span>
<a href="#l4.568"></a><span id="l4.568" class="difflineplus">+            _hide('acknowledge_outgoing');</span>
<a href="#l4.569"></a><span id="l4.569" class="difflineplus">+        }</span>
<a href="#l4.570"></a><span id="l4.570" class="difflineplus">+      }</span>
<a href="#l4.571"></a><span id="l4.571" class="difflineplus">+      else</span>
<a href="#l4.572"></a><span id="l4.572" class="difflineplus">+      {</span>
<a href="#l4.573"></a><span id="l4.573" class="difflineplus">+        // no certificate or cleartext issues</span>
<a href="#l4.574"></a><span id="l4.574" class="difflineplus">+        this.validateAndFinish();</span>
<a href="#l4.575"></a><span id="l4.575" class="difflineplus">+      }</span>
<a href="#l4.576"></a><span id="l4.576" class="difflineplus">+</span>
<a href="#l4.577"></a><span id="l4.577" class="difflineplus">+    } catch (ex) { alertPrompt(gStringsBundle.getString(&quot;error_creating_account&quot;), ex); }</span>
<a href="#l4.578"></a><span id="l4.578" class="difflineplus">+  },</span>
<a href="#l4.579"></a><span id="l4.579" class="difflineplus">+</span>
<a href="#l4.580"></a><span id="l4.580" class="difflineplus">+  getMeOutOfHere : function()</span>
<a href="#l4.581"></a><span id="l4.581" class="difflineplus">+  {</span>
<a href="#l4.582"></a><span id="l4.582" class="difflineplus">+    _hide('warningbox');</span>
<a href="#l4.583"></a><span id="l4.583" class="difflineplus">+    _show('mastervbox');</span>
<a href="#l4.584"></a><span id="l4.584" class="difflineplus">+    getElementById('acknowledge_incoming').checked = false;</span>
<a href="#l4.585"></a><span id="l4.585" class="difflineplus">+    getElementById('acknowledge_outgoing').checked = false;</span>
<a href="#l4.586"></a><span id="l4.586" class="difflineplus">+  },</span>
<a href="#l4.587"></a><span id="l4.587" class="difflineplus">+</span>
<a href="#l4.588"></a><span id="l4.588" class="difflineplus">+  validateAndFinish : function()</span>
<a href="#l4.589"></a><span id="l4.589" class="difflineplus">+  {</span>
<a href="#l4.590"></a><span id="l4.590" class="difflineplus">+    // if we're coming from the cert warning dialog</span>
<a href="#l4.591"></a><span id="l4.591" class="difflineplus">+    _show('mastervbox');</span>
<a href="#l4.592"></a><span id="l4.592" class="difflineplus">+    _hide('warningbox');</span>
<a href="#l4.593"></a><span id="l4.593" class="difflineplus">+</span>
<a href="#l4.594"></a><span id="l4.594" class="difflineplus">+    if (!this.checkIncomingAccountIsNew())</span>
<a href="#l4.595"></a><span id="l4.595" class="difflineplus">+    {</span>
<a href="#l4.596"></a><span id="l4.596" class="difflineplus">+      alertPrompt(gStringsBundle.getString(&quot;error_creating_account&quot;),</span>
<a href="#l4.597"></a><span id="l4.597" class="difflineplus">+                  gStringsBundle.getString(&quot;incoming_server_exists&quot;));</span>
<a href="#l4.598"></a><span id="l4.598" class="difflineplus">+      return;</span>
<a href="#l4.599"></a><span id="l4.599" class="difflineplus">+    }</span>
<a href="#l4.600"></a><span id="l4.600" class="difflineplus">+    if (!this.checkOutgoingAccountIsNew())</span>
<a href="#l4.601"></a><span id="l4.601" class="difflineplus">+    {</span>
<a href="#l4.602"></a><span id="l4.602" class="difflineplus">+      alertPrompt(gStringsBundle.getString(&quot;error_creating_account&quot;),</span>
<a href="#l4.603"></a><span id="l4.603" class="difflineplus">+                  gStringsBundle.getString(&quot;outgoing_server_exists&quot;));</span>
<a href="#l4.604"></a><span id="l4.604" class="difflineplus">+      return;</span>
<a href="#l4.605"></a><span id="l4.605" class="difflineplus">+    }</span>
<a href="#l4.606"></a><span id="l4.606" class="difflineplus">+</span>
<a href="#l4.607"></a><span id="l4.607" class="difflineplus">+    this.validatePassword();</span>
<a href="#l4.608"></a><span id="l4.608" class="difflineplus">+    if (!this._password)</span>
<a href="#l4.609"></a><span id="l4.609" class="difflineplus">+     return; // error already shown by validatePassword()</span>
<a href="#l4.610"></a><span id="l4.610" class="difflineplus">+</span>
<a href="#l4.611"></a><span id="l4.611" class="difflineplus">+    getElementById('create_button').disabled = true;</span>
<a href="#l4.612"></a><span id="l4.612" class="difflineplus">+    var me = this;</span>
<a href="#l4.613"></a><span id="l4.613" class="difflineplus">+    if (!this._verifiedConfig)</span>
<a href="#l4.614"></a><span id="l4.614" class="difflineplus">+      this.verifyConfig(function() // success</span>
<a href="#l4.615"></a><span id="l4.615" class="difflineplus">+                        {</span>
<a href="#l4.616"></a><span id="l4.616" class="difflineplus">+                          me.finish();</span>
<a href="#l4.617"></a><span id="l4.617" class="difflineplus">+                        },</span>
<a href="#l4.618"></a><span id="l4.618" class="difflineplus">+                        function(e) // failure</span>
<a href="#l4.619"></a><span id="l4.619" class="difflineplus">+                        {</span>
<a href="#l4.620"></a><span id="l4.620" class="difflineplus">+                          getElementById('create_button').disabled = false;</span>
<a href="#l4.621"></a><span id="l4.621" class="difflineplus">+                        });</span>
<a href="#l4.622"></a><span id="l4.622" class="difflineplus">+    else</span>
<a href="#l4.623"></a><span id="l4.623" class="difflineplus">+      this.finish();</span>
<a href="#l4.624"></a><span id="l4.624" class="difflineplus">+  },</span>
<a href="#l4.625"></a><span id="l4.625" class="difflineplus">+</span>
<a href="#l4.626"></a><span id="l4.626" class="difflineplus">+  verifyConfig : function(successCallback, errorCallback)</span>
<a href="#l4.627"></a><span id="l4.627" class="difflineplus">+  {</span>
<a href="#l4.628"></a><span id="l4.628" class="difflineplus">+    var me = this;</span>
<a href="#l4.629"></a><span id="l4.629" class="difflineplus">+    this.startSpinner(&quot;checking_password&quot;);</span>
<a href="#l4.630"></a><span id="l4.630" class="difflineplus">+    // logic function defined in verifyConfig.js</span>
<a href="#l4.631"></a><span id="l4.631" class="difflineplus">+    verifyConfig(</span>
<a href="#l4.632"></a><span id="l4.632" class="difflineplus">+      this._currentConfigFilledIn,</span>
<a href="#l4.633"></a><span id="l4.633" class="difflineplus">+      // guess login config?</span>
<a href="#l4.634"></a><span id="l4.634" class="difflineplus">+      this._currentConfigFilledIn.source != AccountConfig.kSourceXML,</span>
<a href="#l4.635"></a><span id="l4.635" class="difflineplus">+      this._parentMsgWindow,</span>
<a href="#l4.636"></a><span id="l4.636" class="difflineplus">+      function() // success</span>
<a href="#l4.637"></a><span id="l4.637" class="difflineplus">+      {</span>
<a href="#l4.638"></a><span id="l4.638" class="difflineplus">+        me._verifiedConfig = true;</span>
<a href="#l4.639"></a><span id="l4.639" class="difflineplus">+        me.stopSpinner(&quot;password_ok&quot;);</span>
<a href="#l4.640"></a><span id="l4.640" class="difflineplus">+        if (successCallback)</span>
<a href="#l4.641"></a><span id="l4.641" class="difflineplus">+          successCallback();</span>
<a href="#l4.642"></a><span id="l4.642" class="difflineplus">+      },</span>
<a href="#l4.643"></a><span id="l4.643" class="difflineplus">+      function(e) // failed</span>
<a href="#l4.644"></a><span id="l4.644" class="difflineplus">+      {</span>
<a href="#l4.645"></a><span id="l4.645" class="difflineplus">+        me.stopSpinner(&quot;config_not_verified&quot;);</span>
<a href="#l4.646"></a><span id="l4.646" class="difflineplus">+        me.setError('passworderror', 'user_pass_invalid');</span>
<a href="#l4.647"></a><span id="l4.647" class="difflineplus">+        alertPrompt(gStringsBundle.getString(&quot;error_creating_account&quot;),</span>
<a href="#l4.648"></a><span id="l4.648" class="difflineplus">+                    gStringsBundle.getString(&quot;config_not_verified&quot;));</span>
<a href="#l4.649"></a><span id="l4.649" class="difflineplus">+        if (errorCallback)</span>
<a href="#l4.650"></a><span id="l4.650" class="difflineplus">+          errorCallback(e);</span>
<a href="#l4.651"></a><span id="l4.651" class="difflineplus">+      });</span>
<a href="#l4.652"></a><span id="l4.652" class="difflineplus">+  },</span>
<a href="#l4.653"></a><span id="l4.653" class="difflineplus">+</span>
<a href="#l4.654"></a><span id="l4.654" class="difflineplus">+  finish : function()</span>
<a href="#l4.655"></a><span id="l4.655" class="difflineplus">+  {</span>
<a href="#l4.656"></a><span id="l4.656" class="difflineplus">+    gEmailWizardLogger.info(&quot;creating account in backend&quot;);</span>
<a href="#l4.657"></a><span id="l4.657" class="difflineplus">+    this._currentConfigFilledIn.rememberPassword =</span>
<a href="#l4.658"></a><span id="l4.658" class="difflineplus">+      getElementById(&quot;remember_password&quot;).checked;</span>
<a href="#l4.659"></a><span id="l4.659" class="difflineplus">+    createAccountInBackend(this._currentConfigFilledIn);</span>
<a href="#l4.660"></a><span id="l4.660" class="difflineplus">+    window.close();</span>
<a href="#l4.661"></a><span id="l4.661" class="difflineplus">+  },</span>
<a href="#l4.662"></a><span id="l4.662" class="difflineplus">+</span>
<a href="#l4.663"></a><span id="l4.663" class="difflineplus">+  advancedSettings : function()</span>
<a href="#l4.664"></a><span id="l4.664" class="difflineplus">+  {</span>
<a href="#l4.665"></a><span id="l4.665" class="difflineplus">+    gEmailWizardLogger.info(&quot;creating account in backend&quot;);</span>
<a href="#l4.666"></a><span id="l4.666" class="difflineplus">+    this._currentConfigFilledIn.rememberPassword =</span>
<a href="#l4.667"></a><span id="l4.667" class="difflineplus">+      getElementById(&quot;remember_password&quot;).checked;</span>
<a href="#l4.668"></a><span id="l4.668" class="difflineplus">+    var newAccount = createAccountInBackend(this._currentConfigFilledIn);</span>
<a href="#l4.669"></a><span id="l4.669" class="difflineplus">+    var windowManager =</span>
<a href="#l4.670"></a><span id="l4.670" class="difflineplus">+      Components.classes['@mozilla.org/appshell/window-mediator;1']</span>
<a href="#l4.671"></a><span id="l4.671" class="difflineplus">+                .getService(Components.interfaces.nsIWindowMediator);</span>
<a href="#l4.672"></a><span id="l4.672" class="difflineplus">+</span>
<a href="#l4.673"></a><span id="l4.673" class="difflineplus">+    var existingAccountManager =</span>
<a href="#l4.674"></a><span id="l4.674" class="difflineplus">+      windowManager.getMostRecentWindow(&quot;mailnews:accountmanager&quot;);</span>
<a href="#l4.675"></a><span id="l4.675" class="difflineplus">+</span>
<a href="#l4.676"></a><span id="l4.676" class="difflineplus">+    if (existingAccountManager)</span>
<a href="#l4.677"></a><span id="l4.677" class="difflineplus">+      existingAccountManager.focus();</span>
<a href="#l4.678"></a><span id="l4.678" class="difflineplus">+    else</span>
<a href="#l4.679"></a><span id="l4.679" class="difflineplus">+      window.openDialog(&quot;chrome://messenger/content/AccountManager.xul&quot;,</span>
<a href="#l4.680"></a><span id="l4.680" class="difflineplus">+                        &quot;AccountManager&quot;, &quot;chrome,centerscreen,modal,titlebar&quot;,</span>
<a href="#l4.681"></a><span id="l4.681" class="difflineplus">+                        { server: newAccount.incomingServer,</span>
<a href="#l4.682"></a><span id="l4.682" class="difflineplus">+                          selectPage: 'am-server.xul' });</span>
<a href="#l4.683"></a><span id="l4.683" class="difflineplus">+    window.close();</span>
<a href="#l4.684"></a><span id="l4.684" class="difflineplus">+  },</span>
<a href="#l4.685"></a><span id="l4.685" class="difflineplus">+  /**</span>
<a href="#l4.686"></a><span id="l4.686" class="difflineplus">+   * Gets the values that the user edited in the right of the dialog.</span>
<a href="#l4.687"></a><span id="l4.687" class="difflineplus">+   */</span>
<a href="#l4.688"></a><span id="l4.688" class="difflineplus">+  getUserConfig : function()</span>
<a href="#l4.689"></a><span id="l4.689" class="difflineplus">+  {</span>
<a href="#l4.690"></a><span id="l4.690" class="difflineplus">+    var config = this._currentConfig;</span>
<a href="#l4.691"></a><span id="l4.691" class="difflineplus">+    if (!config)</span>
<a href="#l4.692"></a><span id="l4.692" class="difflineplus">+      config = new AccountConfig();</span>
<a href="#l4.693"></a><span id="l4.693" class="difflineplus">+</span>
<a href="#l4.694"></a><span id="l4.694" class="difflineplus">+    config.source = AccountConfig.kSourceGuess;</span>
<a href="#l4.695"></a><span id="l4.695" class="difflineplus">+</span>
<a href="#l4.696"></a><span id="l4.696" class="difflineplus">+    // Did the user select one of the already configured SMTP servers from the</span>
<a href="#l4.697"></a><span id="l4.697" class="difflineplus">+    // drop-down list? If so, use it.</span>
<a href="#l4.698"></a><span id="l4.698" class="difflineplus">+    if (this._userPickedOutgoingServer)</span>
<a href="#l4.699"></a><span id="l4.699" class="difflineplus">+    {</span>
<a href="#l4.700"></a><span id="l4.700" class="difflineplus">+      config.outgoing.addThisServer = false;</span>
<a href="#l4.701"></a><span id="l4.701" class="difflineplus">+      config.outgoing.existingServerKey =</span>
<a href="#l4.702"></a><span id="l4.702" class="difflineplus">+        getElementById(&quot;outgoing_server&quot;).selectedItem.value;</span>
<a href="#l4.703"></a><span id="l4.703" class="difflineplus">+      config.outgoing.existingServerLabel =</span>
<a href="#l4.704"></a><span id="l4.704" class="difflineplus">+        getElementById(&quot;outgoing_server&quot;).selectedItem.label;</span>
<a href="#l4.705"></a><span id="l4.705" class="difflineplus">+    }</span>
<a href="#l4.706"></a><span id="l4.706" class="difflineplus">+    else</span>
<a href="#l4.707"></a><span id="l4.707" class="difflineplus">+    {</span>
<a href="#l4.708"></a><span id="l4.708" class="difflineplus">+      config.outgoing.username = getElementById(&quot;username&quot;).value;</span>
<a href="#l4.709"></a><span id="l4.709" class="difflineplus">+      config.outgoing.hostname = getElementById(&quot;outgoing_server&quot;).value;</span>
<a href="#l4.710"></a><span id="l4.710" class="difflineplus">+      dump(&quot;in getUserConfig setting outgoing hostname to &quot; + config.outgoing.hostname + &quot;\n&quot;);</span>
<a href="#l4.711"></a><span id="l4.711" class="difflineplus">+      config.outgoing.port =</span>
<a href="#l4.712"></a><span id="l4.712" class="difflineplus">+        sanitize.integerRange(getElementById(&quot;outgoing_port&quot;).value, 1,</span>
<a href="#l4.713"></a><span id="l4.713" class="difflineplus">+                              kHighestPort);</span>
<a href="#l4.714"></a><span id="l4.714" class="difflineplus">+    }</span>
<a href="#l4.715"></a><span id="l4.715" class="difflineplus">+    config.incoming.username = getElementById(&quot;username&quot;).value;</span>
<a href="#l4.716"></a><span id="l4.716" class="difflineplus">+    config.incoming.hostname = getElementById(&quot;incoming_server&quot;).value;</span>
<a href="#l4.717"></a><span id="l4.717" class="difflineplus">+    config.incoming.port =</span>
<a href="#l4.718"></a><span id="l4.718" class="difflineplus">+      sanitize.integerRange(getElementById(&quot;incoming_port&quot;).value, 1,</span>
<a href="#l4.719"></a><span id="l4.719" class="difflineplus">+                            kHighestPort);</span>
<a href="#l4.720"></a><span id="l4.720" class="difflineplus">+    config.incoming.type =</span>
<a href="#l4.721"></a><span id="l4.721" class="difflineplus">+      getElementById(&quot;incoming_protocol&quot;).value == 1 ? &quot;imap&quot; : &quot;pop3&quot;;</span>
<a href="#l4.722"></a><span id="l4.722" class="difflineplus">+</span>
<a href="#l4.723"></a><span id="l4.723" class="difflineplus">+    return config;</span>
<a href="#l4.724"></a><span id="l4.724" class="difflineplus">+  },</span>
<a href="#l4.725"></a><span id="l4.725" class="difflineplus">+</span>
<a href="#l4.726"></a><span id="l4.726" class="difflineplus">+  _setIncomingStatus : function (state, details)</span>
<a href="#l4.727"></a><span id="l4.727" class="difflineplus">+  {</span>
<a href="#l4.728"></a><span id="l4.728" class="difflineplus">+    if (!details)</span>
<a href="#l4.729"></a><span id="l4.729" class="difflineplus">+      details = &quot;&quot;;</span>
<a href="#l4.730"></a><span id="l4.730" class="difflineplus">+</span>
<a href="#l4.731"></a><span id="l4.731" class="difflineplus">+    switch (state)</span>
<a href="#l4.732"></a><span id="l4.732" class="difflineplus">+    {</span>
<a href="#l4.733"></a><span id="l4.733" class="difflineplus">+      case 'strong':</span>
<a href="#l4.734"></a><span id="l4.734" class="difflineplus">+        this._incomingState = 'done';</span>
<a href="#l4.735"></a><span id="l4.735" class="difflineplus">+        this._incomingWarning = '';</span>
<a href="#l4.736"></a><span id="l4.736" class="difflineplus">+        // fall through</span>
<a href="#l4.737"></a><span id="l4.737" class="difflineplus">+      case 'weak':</span>
<a href="#l4.738"></a><span id="l4.738" class="difflineplus">+        this._incomingWarning = details;</span>
<a href="#l4.739"></a><span id="l4.739" class="difflineplus">+        this._incomingWarningAcknowledged = false;</span>
<a href="#l4.740"></a><span id="l4.740" class="difflineplus">+        break;</span>
<a href="#l4.741"></a><span id="l4.741" class="difflineplus">+      default:</span>
<a href="#l4.742"></a><span id="l4.742" class="difflineplus">+        this._incomingState = state;</span>
<a href="#l4.743"></a><span id="l4.743" class="difflineplus">+    }</span>
<a href="#l4.744"></a><span id="l4.744" class="difflineplus">+    // since we look for SSL/TLS first, if we get 'weak', we're</span>
<a href="#l4.745"></a><span id="l4.745" class="difflineplus">+    // stuck with it, and might as well admit we're done.</span>
<a href="#l4.746"></a><span id="l4.746" class="difflineplus">+    if (state == 'weak')</span>
<a href="#l4.747"></a><span id="l4.747" class="difflineplus">+      this._incomingState = 'done';</span>
<a href="#l4.748"></a><span id="l4.748" class="difflineplus">+</span>
<a href="#l4.749"></a><span id="l4.749" class="difflineplus">+    this._setIconAndTooltip('incoming_status', state, details);</span>
<a href="#l4.750"></a><span id="l4.750" class="difflineplus">+  },</span>
<a href="#l4.751"></a><span id="l4.751" class="difflineplus">+</span>
<a href="#l4.752"></a><span id="l4.752" class="difflineplus">+  _setOutgoingStatus: function (state, details)</span>
<a href="#l4.753"></a><span id="l4.753" class="difflineplus">+  {</span>
<a href="#l4.754"></a><span id="l4.754" class="difflineplus">+    if (!details)</span>
<a href="#l4.755"></a><span id="l4.755" class="difflineplus">+      details = '';</span>
<a href="#l4.756"></a><span id="l4.756" class="difflineplus">+</span>
<a href="#l4.757"></a><span id="l4.757" class="difflineplus">+    if (this._userPickedOutgoingServer)</span>
<a href="#l4.758"></a><span id="l4.758" class="difflineplus">+      return;</span>
<a href="#l4.759"></a><span id="l4.759" class="difflineplus">+</span>
<a href="#l4.760"></a><span id="l4.760" class="difflineplus">+    switch (state)</span>
<a href="#l4.761"></a><span id="l4.761" class="difflineplus">+    {</span>
<a href="#l4.762"></a><span id="l4.762" class="difflineplus">+      case 'strong':</span>
<a href="#l4.763"></a><span id="l4.763" class="difflineplus">+        this._outgoingState = 'done';</span>
<a href="#l4.764"></a><span id="l4.764" class="difflineplus">+        this._outgoingWarning = '';</span>
<a href="#l4.765"></a><span id="l4.765" class="difflineplus">+        // fall through</span>
<a href="#l4.766"></a><span id="l4.766" class="difflineplus">+      case 'weak':</span>
<a href="#l4.767"></a><span id="l4.767" class="difflineplus">+        this._outgoingWarning = details;</span>
<a href="#l4.768"></a><span id="l4.768" class="difflineplus">+        this._outgoingWarningAcknowledged = false;</span>
<a href="#l4.769"></a><span id="l4.769" class="difflineplus">+        break</span>
<a href="#l4.770"></a><span id="l4.770" class="difflineplus">+      default:</span>
<a href="#l4.771"></a><span id="l4.771" class="difflineplus">+        this._outgoingState = state;</span>
<a href="#l4.772"></a><span id="l4.772" class="difflineplus">+    }</span>
<a href="#l4.773"></a><span id="l4.773" class="difflineplus">+    // since we look for SSL/TLS first, if we get 'weak', we're</span>
<a href="#l4.774"></a><span id="l4.774" class="difflineplus">+    // stuck with it, and might as well admit we're done.</span>
<a href="#l4.775"></a><span id="l4.775" class="difflineplus">+    if (state == 'weak')</span>
<a href="#l4.776"></a><span id="l4.776" class="difflineplus">+      this._outgoingState = 'done';</span>
<a href="#l4.777"></a><span id="l4.777" class="difflineplus">+</span>
<a href="#l4.778"></a><span id="l4.778" class="difflineplus">+    this._setIconAndTooltip('outgoing_status', state, details);</span>
<a href="#l4.779"></a><span id="l4.779" class="difflineplus">+  },</span>
<a href="#l4.780"></a><span id="l4.780" class="difflineplus">+</span>
<a href="#l4.781"></a><span id="l4.781" class="difflineplus">+  _setIconAndTooltip : function(id, state, details)</span>
<a href="#l4.782"></a><span id="l4.782" class="difflineplus">+  {</span>
<a href="#l4.783"></a><span id="l4.783" class="difflineplus">+    let icon = getElementById(id);</span>
<a href="#l4.784"></a><span id="l4.784" class="difflineplus">+    icon.setAttribute('state', state);</span>
<a href="#l4.785"></a><span id="l4.785" class="difflineplus">+    switch (state)</span>
<a href="#l4.786"></a><span id="l4.786" class="difflineplus">+    {</span>
<a href="#l4.787"></a><span id="l4.787" class="difflineplus">+      case 'weak':</span>
<a href="#l4.788"></a><span id="l4.788" class="difflineplus">+        icon.setAttribute('tooltip', 'insecureserver-'+details);</span>
<a href="#l4.789"></a><span id="l4.789" class="difflineplus">+        break;</span>
<a href="#l4.790"></a><span id="l4.790" class="difflineplus">+      case 'hidden':</span>
<a href="#l4.791"></a><span id="l4.791" class="difflineplus">+        icon.removeAttribute('tooltip');</span>
<a href="#l4.792"></a><span id="l4.792" class="difflineplus">+        break;</span>
<a href="#l4.793"></a><span id="l4.793" class="difflineplus">+      case 'strong':</span>
<a href="#l4.794"></a><span id="l4.794" class="difflineplus">+        icon.setAttribute('tooltip', 'secureservertooltip');</span>
<a href="#l4.795"></a><span id="l4.795" class="difflineplus">+        break;</span>
<a href="#l4.796"></a><span id="l4.796" class="difflineplus">+    }</span>
<a href="#l4.797"></a><span id="l4.797" class="difflineplus">+  },</span>
<a href="#l4.798"></a><span id="l4.798" class="difflineplus">+</span>
<a href="#l4.799"></a><span id="l4.799" class="difflineplus">+  showConfigDetails : function()</span>
<a href="#l4.800"></a><span id="l4.800" class="difflineplus">+  {</span>
<a href="#l4.801"></a><span id="l4.801" class="difflineplus">+    // show the config details area</span>
<a href="#l4.802"></a><span id="l4.802" class="difflineplus">+    _show(&quot;settingsbox&quot;);</span>
<a href="#l4.803"></a><span id="l4.803" class="difflineplus">+    // also show the create button because it's outside of the area</span>
<a href="#l4.804"></a><span id="l4.804" class="difflineplus">+    _show(&quot;create_button&quot;);</span>
<a href="#l4.805"></a><span id="l4.805" class="difflineplus">+  },</span>
<a href="#l4.806"></a><span id="l4.806" class="difflineplus">+</span>
<a href="#l4.807"></a><span id="l4.807" class="difflineplus">+  hideConfigDetails : function()</span>
<a href="#l4.808"></a><span id="l4.808" class="difflineplus">+  {</span>
<a href="#l4.809"></a><span id="l4.809" class="difflineplus">+    _hide(&quot;settingsbox&quot;);</span>
<a href="#l4.810"></a><span id="l4.810" class="difflineplus">+    _hide(&quot;create_button&quot;);</span>
<a href="#l4.811"></a><span id="l4.811" class="difflineplus">+  },</span>
<a href="#l4.812"></a><span id="l4.812" class="difflineplus">+</span>
<a href="#l4.813"></a><span id="l4.813" class="difflineplus">+  /* Clears out the config details information, this is really only meant to be</span>
<a href="#l4.814"></a><span id="l4.814" class="difflineplus">+   * called from the (Back) button.</span>
<a href="#l4.815"></a><span id="l4.815" class="difflineplus">+   * XXX This can destroy user input where it might not be necessary</span>
<a href="#l4.816"></a><span id="l4.816" class="difflineplus">+   */</span>
<a href="#l4.817"></a><span id="l4.817" class="difflineplus">+  clearConfigDetails : function()</span>
<a href="#l4.818"></a><span id="l4.818" class="difflineplus">+  {</span>
<a href="#l4.819"></a><span id="l4.819" class="difflineplus">+    for (let i = 0; i &lt; this._configDetailTextInputs.length; i++ )</span>
<a href="#l4.820"></a><span id="l4.820" class="difflineplus">+    {</span>
<a href="#l4.821"></a><span id="l4.821" class="difflineplus">+      getElementById(this._configDetailTextInputs[i]).value = &quot;&quot;;</span>
<a href="#l4.822"></a><span id="l4.822" class="difflineplus">+    }</span>
<a href="#l4.823"></a><span id="l4.823" class="difflineplus">+</span>
<a href="#l4.824"></a><span id="l4.824" class="difflineplus">+    this._setIncomingStatus('hidden');</span>
<a href="#l4.825"></a><span id="l4.825" class="difflineplus">+    this._setOutgoingStatus('hidden');</span>
<a href="#l4.826"></a><span id="l4.826" class="difflineplus">+  },</span>
<a href="#l4.827"></a><span id="l4.827" class="difflineplus">+</span>
<a href="#l4.828"></a><span id="l4.828" class="difflineplus">+  /* Setting the config details form so it can be edited.  We also disable</span>
<a href="#l4.829"></a><span id="l4.829" class="difflineplus">+   * (and hide) the create button during this time because we don't know what</span>
<a href="#l4.830"></a><span id="l4.830" class="difflineplus">+   * might have changed.  The function called from the button that restarts</span>
<a href="#l4.831"></a><span id="l4.831" class="difflineplus">+   * the config check should be enabling the config button as needed.</span>
<a href="#l4.832"></a><span id="l4.832" class="difflineplus">+   */</span>
<a href="#l4.833"></a><span id="l4.833" class="difflineplus">+  editConfigDetails : function() {</span>
<a href="#l4.834"></a><span id="l4.834" class="difflineplus">+    this._disableConfigDetails(false);</span>
<a href="#l4.835"></a><span id="l4.835" class="difflineplus">+    this._setIncomingStatus('hidden');</span>
<a href="#l4.836"></a><span id="l4.836" class="difflineplus">+    this._setOutgoingStatus('hidden');</span>
<a href="#l4.837"></a><span id="l4.837" class="difflineplus">+    getElementById('create_button').disabled = true;</span>
<a href="#l4.838"></a><span id="l4.838" class="difflineplus">+    _hide(&quot;create_button&quot;);</span>
<a href="#l4.839"></a><span id="l4.839" class="difflineplus">+  },</span>
<a href="#l4.840"></a><span id="l4.840" class="difflineplus">+</span>
<a href="#l4.841"></a><span id="l4.841" class="difflineplus">+  /* This _doesn't_ set create back to enabled, that needs to be done in a</span>
<a href="#l4.842"></a><span id="l4.842" class="difflineplus">+   * config check.  Only showing the button.</span>
<a href="#l4.843"></a><span id="l4.843" class="difflineplus">+   * XXX However it seems that a disabled button can still receive click</span>
<a href="#l4.844"></a><span id="l4.844" class="difflineplus">+   *     events so this needs to be looked into further.</span>
<a href="#l4.845"></a><span id="l4.845" class="difflineplus">+   */</span>
<a href="#l4.846"></a><span id="l4.846" class="difflineplus">+  goWithConfigDetails : function() {</span>
<a href="#l4.847"></a><span id="l4.847" class="difflineplus">+    this._disableConfigDetails(true);</span>
<a href="#l4.848"></a><span id="l4.848" class="difflineplus">+    _show(&quot;create_button&quot;);</span>
<a href="#l4.849"></a><span id="l4.849" class="difflineplus">+  },</span>
<a href="#l4.850"></a><span id="l4.850" class="difflineplus">+</span>
<a href="#l4.851"></a><span id="l4.851" class="difflineplus">+  // IDs of &lt;textbox&gt; inputs that can have a .value attr set</span>
<a href="#l4.852"></a><span id="l4.852" class="difflineplus">+  _configDetailTextInputs : [&quot;username&quot;, &quot;incoming_server&quot;,</span>
<a href="#l4.853"></a><span id="l4.853" class="difflineplus">+                             &quot;incoming_port&quot;, &quot;incoming_protocol&quot;,</span>
<a href="#l4.854"></a><span id="l4.854" class="difflineplus">+                             &quot;outgoing_port&quot;],</span>
<a href="#l4.855"></a><span id="l4.855" class="difflineplus">+</span>
<a href="#l4.856"></a><span id="l4.856" class="difflineplus">+  // IDs of the &lt;menulist&gt; elements that don't accept a .value attr but can</span>
<a href="#l4.857"></a><span id="l4.857" class="difflineplus">+  // be disabled</span>
<a href="#l4.858"></a><span id="l4.858" class="difflineplus">+  _configDetailMenulists : [&quot;incoming_security&quot;,</span>
<a href="#l4.859"></a><span id="l4.859" class="difflineplus">+                            &quot;outgoing_server&quot;, &quot;outgoing_security&quot;],</span>
<a href="#l4.860"></a><span id="l4.860" class="difflineplus">+</span>
<a href="#l4.861"></a><span id="l4.861" class="difflineplus">+  /* Helper function to loop through all config details form elements and</span>
<a href="#l4.862"></a><span id="l4.862" class="difflineplus">+   * enable or disable each</span>
<a href="#l4.863"></a><span id="l4.863" class="difflineplus">+   */</span>
<a href="#l4.864"></a><span id="l4.864" class="difflineplus">+  _disableConfigDetails : function(disabled)</span>
<a href="#l4.865"></a><span id="l4.865" class="difflineplus">+  {</span>
<a href="#l4.866"></a><span id="l4.866" class="difflineplus">+    let formElements =</span>
<a href="#l4.867"></a><span id="l4.867" class="difflineplus">+      this._configDetailTextInputs.concat(this._configDetailMenulists);</span>
<a href="#l4.868"></a><span id="l4.868" class="difflineplus">+    for (let i = 0; i &lt; formElements.length; i++)</span>
<a href="#l4.869"></a><span id="l4.869" class="difflineplus">+    {</span>
<a href="#l4.870"></a><span id="l4.870" class="difflineplus">+      getElementById(formElements[i]).disabled = disabled;</span>
<a href="#l4.871"></a><span id="l4.871" class="difflineplus">+    }</span>
<a href="#l4.872"></a><span id="l4.872" class="difflineplus">+  },</span>
<a href="#l4.873"></a><span id="l4.873" class="difflineplus">+</span>
<a href="#l4.874"></a><span id="l4.874" class="difflineplus">+  /**</span>
<a href="#l4.875"></a><span id="l4.875" class="difflineplus">+   * Updates a (probed) config to the user,</span>
<a href="#l4.876"></a><span id="l4.876" class="difflineplus">+   * in the config details area</span>
<a href="#l4.877"></a><span id="l4.877" class="difflineplus">+   *</span>
<a href="#l4.878"></a><span id="l4.878" class="difflineplus">+   * @param config {AccountConfig} The config to present to user</span>
<a href="#l4.879"></a><span id="l4.879" class="difflineplus">+   */</span>
<a href="#l4.880"></a><span id="l4.880" class="difflineplus">+  updateConfig : function(config)</span>
<a href="#l4.881"></a><span id="l4.881" class="difflineplus">+  {</span>
<a href="#l4.882"></a><span id="l4.882" class="difflineplus">+    // if we have a username, set it.</span>
<a href="#l4.883"></a><span id="l4.883" class="difflineplus">+    if (config.incoming.username)</span>
<a href="#l4.884"></a><span id="l4.884" class="difflineplus">+    {</span>
<a href="#l4.885"></a><span id="l4.885" class="difflineplus">+      dump(&quot;updating UI with username from found config&quot; + config.incoming.username + &quot;\n&quot;);</span>
<a href="#l4.886"></a><span id="l4.886" class="difflineplus">+      getElementById(&quot;username&quot;).value = config.incoming.username;</span>
<a href="#l4.887"></a><span id="l4.887" class="difflineplus">+    }</span>
<a href="#l4.888"></a><span id="l4.888" class="difflineplus">+    else</span>
<a href="#l4.889"></a><span id="l4.889" class="difflineplus">+    {</span>
<a href="#l4.890"></a><span id="l4.890" class="difflineplus">+      // XXX needs more thought</span>
<a href="#l4.891"></a><span id="l4.891" class="difflineplus">+      this.editConfigDetails();</span>
<a href="#l4.892"></a><span id="l4.892" class="difflineplus">+      getElementById(&quot;username&quot;).value = &quot;???&quot;;</span>
<a href="#l4.893"></a><span id="l4.893" class="difflineplus">+    }</span>
<a href="#l4.894"></a><span id="l4.894" class="difflineplus">+</span>
<a href="#l4.895"></a><span id="l4.895" class="difflineplus">+    // incoming server</span>
<a href="#l4.896"></a><span id="l4.896" class="difflineplus">+    if (config.incoming.hostname &amp;&amp; config.incoming.hostname != -1)</span>
<a href="#l4.897"></a><span id="l4.897" class="difflineplus">+    {</span>
<a href="#l4.898"></a><span id="l4.898" class="difflineplus">+      /* -1 failure needs to be handled in the context of the failure</span>
<a href="#l4.899"></a><span id="l4.899" class="difflineplus">+        * at this point all we know is there is no hostname, but not why</span>
<a href="#l4.900"></a><span id="l4.900" class="difflineplus">+        * the error handling behaviour needs to be done above</span>
<a href="#l4.901"></a><span id="l4.901" class="difflineplus">+        */</span>
<a href="#l4.902"></a><span id="l4.902" class="difflineplus">+      getElementById(&quot;incoming_server&quot;).value = config.incoming.hostname;</span>
<a href="#l4.903"></a><span id="l4.903" class="difflineplus">+      dump(&quot;config.incoming.type = &quot; + config.incoming.type + &quot;\n&quot;);</span>
<a href="#l4.904"></a><span id="l4.904" class="difflineplus">+      getElementById(&quot;incoming_port&quot;).value = config.incoming.port;</span>
<a href="#l4.905"></a><span id="l4.905" class="difflineplus">+      getElementById(&quot;incoming_security&quot;).value = config.incoming.socketType;</span>
<a href="#l4.906"></a><span id="l4.906" class="difflineplus">+      getElementById(&quot;incoming_protocol&quot;).value =</span>
<a href="#l4.907"></a><span id="l4.907" class="difflineplus">+        sanitize.translate(config.incoming.type, { &quot;imap&quot; : 1, &quot;pop3&quot; : 2});</span>
<a href="#l4.908"></a><span id="l4.908" class="difflineplus">+</span>
<a href="#l4.909"></a><span id="l4.909" class="difflineplus">+      if (config.incoming._inprogress)</span>
<a href="#l4.910"></a><span id="l4.910" class="difflineplus">+      {</span>
<a href="#l4.911"></a><span id="l4.911" class="difflineplus">+        this._setIncomingStatus('probing');</span>
<a href="#l4.912"></a><span id="l4.912" class="difflineplus">+      }</span>
<a href="#l4.913"></a><span id="l4.913" class="difflineplus">+      else</span>
<a href="#l4.914"></a><span id="l4.914" class="difflineplus">+      {</span>
<a href="#l4.915"></a><span id="l4.915" class="difflineplus">+        switch (config.incoming.socketType)</span>
<a href="#l4.916"></a><span id="l4.916" class="difflineplus">+        {</span>
<a href="#l4.917"></a><span id="l4.917" class="difflineplus">+          case 2: // SSL / TLS</span>
<a href="#l4.918"></a><span id="l4.918" class="difflineplus">+          case 3: // STARTTLS</span>
<a href="#l4.919"></a><span id="l4.919" class="difflineplus">+            if (config.incoming.badCert)</span>
<a href="#l4.920"></a><span id="l4.920" class="difflineplus">+            {</span>
<a href="#l4.921"></a><span id="l4.921" class="difflineplus">+              this._setIncomingStatus('weak', 'selfsigned');</span>
<a href="#l4.922"></a><span id="l4.922" class="difflineplus">+              var params = { exceptionAdded : false };</span>
<a href="#l4.923"></a><span id="l4.923" class="difflineplus">+              params.prefetchCert = true;</span>
<a href="#l4.924"></a><span id="l4.924" class="difflineplus">+              params.location = config.incoming.targetSite;</span>
<a href="#l4.925"></a><span id="l4.925" class="difflineplus">+              window.openDialog('chrome://pippki/content/exceptionDialog.xul',</span>
<a href="#l4.926"></a><span id="l4.926" class="difflineplus">+                                '','chrome,centerscreen,modal', params);</span>
<a href="#l4.927"></a><span id="l4.927" class="difflineplus">+              config.incoming.badCert = false;</span>
<a href="#l4.928"></a><span id="l4.928" class="difflineplus">+            }</span>
<a href="#l4.929"></a><span id="l4.929" class="difflineplus">+            else</span>
<a href="#l4.930"></a><span id="l4.930" class="difflineplus">+            {</span>
<a href="#l4.931"></a><span id="l4.931" class="difflineplus">+              this._setIncomingStatus('strong');</span>
<a href="#l4.932"></a><span id="l4.932" class="difflineplus">+            }</span>
<a href="#l4.933"></a><span id="l4.933" class="difflineplus">+            break;</span>
<a href="#l4.934"></a><span id="l4.934" class="difflineplus">+          case 1: // plain</span>
<a href="#l4.935"></a><span id="l4.935" class="difflineplus">+            this._setIncomingStatus('weak', 'cleartext');</span>
<a href="#l4.936"></a><span id="l4.936" class="difflineplus">+            break;</span>
<a href="#l4.937"></a><span id="l4.937" class="difflineplus">+          default:</span>
<a href="#l4.938"></a><span id="l4.938" class="difflineplus">+            throw new NotReached(&quot;sslType &quot; + config.incoming.socketType + &quot; unknown&quot;);</span>
<a href="#l4.939"></a><span id="l4.939" class="difflineplus">+        }</span>
<a href="#l4.940"></a><span id="l4.940" class="difflineplus">+      }</span>
<a href="#l4.941"></a><span id="l4.941" class="difflineplus">+    }</span>
<a href="#l4.942"></a><span id="l4.942" class="difflineplus">+</span>
<a href="#l4.943"></a><span id="l4.943" class="difflineplus">+    // outgoing server</span>
<a href="#l4.944"></a><span id="l4.944" class="difflineplus">+    if (config.outgoing.hostname &amp;&amp; config.outgoing.hostname != -1)</span>
<a href="#l4.945"></a><span id="l4.945" class="difflineplus">+    {</span>
<a href="#l4.946"></a><span id="l4.946" class="difflineplus">+      /* -1 failure needs to be handled in the context of the failure</span>
<a href="#l4.947"></a><span id="l4.947" class="difflineplus">+       * at this point all we know is there is no hostname, but not why.</span>
<a href="#l4.948"></a><span id="l4.948" class="difflineplus">+       * The error handling behaviour needs to be done elsewhere</span>
<a href="#l4.949"></a><span id="l4.949" class="difflineplus">+       */</span>
<a href="#l4.950"></a><span id="l4.950" class="difflineplus">+      if (!gEmailConfigWizard._userPickedOutgoingServer)</span>
<a href="#l4.951"></a><span id="l4.951" class="difflineplus">+      {</span>
<a href="#l4.952"></a><span id="l4.952" class="difflineplus">+        dump(&quot;setting menu to &quot; + config.outgoing.hostname + &quot;\n&quot;);</span>
<a href="#l4.953"></a><span id="l4.953" class="difflineplus">+        getElementById(&quot;outgoing_server&quot;).value = config.outgoing.hostname;</span>
<a href="#l4.954"></a><span id="l4.954" class="difflineplus">+        getElementById(&quot;outgoing_port&quot;).value = config.outgoing.port;</span>
<a href="#l4.955"></a><span id="l4.955" class="difflineplus">+        getElementById(&quot;outgoing_security&quot;).value = config.outgoing.socketType;</span>
<a href="#l4.956"></a><span id="l4.956" class="difflineplus">+        _show(&quot;outgoing_port&quot;);</span>
<a href="#l4.957"></a><span id="l4.957" class="difflineplus">+        _show(&quot;outgoing_security&quot;);</span>
<a href="#l4.958"></a><span id="l4.958" class="difflineplus">+        if (config.outgoing._inprogress) {</span>
<a href="#l4.959"></a><span id="l4.959" class="difflineplus">+          this._setOutgoingStatus('probing');</span>
<a href="#l4.960"></a><span id="l4.960" class="difflineplus">+        }</span>
<a href="#l4.961"></a><span id="l4.961" class="difflineplus">+        else</span>
<a href="#l4.962"></a><span id="l4.962" class="difflineplus">+        {</span>
<a href="#l4.963"></a><span id="l4.963" class="difflineplus">+          switch (config.outgoing.socketType)</span>
<a href="#l4.964"></a><span id="l4.964" class="difflineplus">+          {</span>
<a href="#l4.965"></a><span id="l4.965" class="difflineplus">+            case 2: // SSL / TLS</span>
<a href="#l4.966"></a><span id="l4.966" class="difflineplus">+            case 3: // STARTTLS</span>
<a href="#l4.967"></a><span id="l4.967" class="difflineplus">+              if (config.outgoing.badCert)</span>
<a href="#l4.968"></a><span id="l4.968" class="difflineplus">+                this._setOutgoingStatus('weak', 'selfsigned');</span>
<a href="#l4.969"></a><span id="l4.969" class="difflineplus">+              else</span>
<a href="#l4.970"></a><span id="l4.970" class="difflineplus">+                this._setOutgoingStatus('strong');</span>
<a href="#l4.971"></a><span id="l4.971" class="difflineplus">+              break;</span>
<a href="#l4.972"></a><span id="l4.972" class="difflineplus">+            case 1: // plain</span>
<a href="#l4.973"></a><span id="l4.973" class="difflineplus">+              ddump(&quot;setting outgoing security to weak\n&quot;);</span>
<a href="#l4.974"></a><span id="l4.974" class="difflineplus">+              this._setOutgoingStatus('weak');</span>
<a href="#l4.975"></a><span id="l4.975" class="difflineplus">+              break;</span>
<a href="#l4.976"></a><span id="l4.976" class="difflineplus">+            default:</span>
<a href="#l4.977"></a><span id="l4.977" class="difflineplus">+              throw new NotReached(&quot;sslType &quot; + config.incoming.socketType + &quot; unknown&quot;);</span>
<a href="#l4.978"></a><span id="l4.978" class="difflineplus">+          }</span>
<a href="#l4.979"></a><span id="l4.979" class="difflineplus">+        }</span>
<a href="#l4.980"></a><span id="l4.980" class="difflineplus">+      }</span>
<a href="#l4.981"></a><span id="l4.981" class="difflineplus">+      else</span>
<a href="#l4.982"></a><span id="l4.982" class="difflineplus">+      {</span>
<a href="#l4.983"></a><span id="l4.983" class="difflineplus">+        config.outgoing.addThisServer = false;</span>
<a href="#l4.984"></a><span id="l4.984" class="difflineplus">+        config.outgoing.useGlobalPreferredServer = true;</span>
<a href="#l4.985"></a><span id="l4.985" class="difflineplus">+      }</span>
<a href="#l4.986"></a><span id="l4.986" class="difflineplus">+    }</span>
<a href="#l4.987"></a><span id="l4.987" class="difflineplus">+  },</span>
<a href="#l4.988"></a><span id="l4.988" class="difflineplus">+</span>
<a href="#l4.989"></a><span id="l4.989" class="difflineplus">+  /* (Edit) button click handler.  This turns the config details area into an</span>
<a href="#l4.990"></a><span id="l4.990" class="difflineplus">+   * editable form and makes the (Go) button appear.  The edit button should</span>
<a href="#l4.991"></a><span id="l4.991" class="difflineplus">+   * only be available after the config probing is completely finished,</span>
<a href="#l4.992"></a><span id="l4.992" class="difflineplus">+   * replacing what was the (Stop) button.</span>
<a href="#l4.993"></a><span id="l4.993" class="difflineplus">+   */</span>
<a href="#l4.994"></a><span id="l4.994" class="difflineplus">+  onEdit : function()</span>
<a href="#l4.995"></a><span id="l4.995" class="difflineplus">+  {</span>
<a href="#l4.996"></a><span id="l4.996" class="difflineplus">+    this.editConfigDetails();</span>
<a href="#l4.997"></a><span id="l4.997" class="difflineplus">+    // swap out the buttons</span>
<a href="#l4.998"></a><span id="l4.998" class="difflineplus">+    _hide(&quot;edit_button&quot;);</span>
<a href="#l4.999"></a><span id="l4.999" class="difflineplus">+    _show(&quot;go_button&quot;);</span>
<a href="#l4.1000"></a><span id="l4.1000" class="difflineplus">+  },</span>
<a href="#l4.1001"></a><span id="l4.1001" class="difflineplus">+</span>
<a href="#l4.1002"></a><span id="l4.1002" class="difflineplus">+  // short hand so I didn't have to insert the swap functions in various places</span>
<a href="#l4.1003"></a><span id="l4.1003" class="difflineplus">+  showEditButton : function() { _show(&quot;edit_button&quot;); _hide(&quot;stop_button&quot;); },</span>
<a href="#l4.1004"></a><span id="l4.1004" class="difflineplus">+</span>
<a href="#l4.1005"></a><span id="l4.1005" class="difflineplus">+  /* (Stop) button click handler.  This should stop short any probing or config</span>
<a href="#l4.1006"></a><span id="l4.1006" class="difflineplus">+   * guessing progress and changing the config details area into manual edit</span>
<a href="#l4.1007"></a><span id="l4.1007" class="difflineplus">+   * mode.  This button should only be available during probing, after which it</span>
<a href="#l4.1008"></a><span id="l4.1008" class="difflineplus">+   * is replaced by the (Edit) button.</span>
<a href="#l4.1009"></a><span id="l4.1009" class="difflineplus">+   */</span>
<a href="#l4.1010"></a><span id="l4.1010" class="difflineplus">+  onStop : function()</span>
<a href="#l4.1011"></a><span id="l4.1011" class="difflineplus">+  {</span>
<a href="#l4.1012"></a><span id="l4.1012" class="difflineplus">+    if (!this._probeAbortable)</span>
<a href="#l4.1013"></a><span id="l4.1013" class="difflineplus">+    {</span>
<a href="#l4.1014"></a><span id="l4.1014" class="difflineplus">+      ddump(&quot;nothing to abort&quot;);</span>
<a href="#l4.1015"></a><span id="l4.1015" class="difflineplus">+    }</span>
<a href="#l4.1016"></a><span id="l4.1016" class="difflineplus">+    else</span>
<a href="#l4.1017"></a><span id="l4.1017" class="difflineplus">+    {</span>
<a href="#l4.1018"></a><span id="l4.1018" class="difflineplus">+      this._probeAbortable.cancel();</span>
<a href="#l4.1019"></a><span id="l4.1019" class="difflineplus">+      ddump(&quot;canceled probe&quot;);</span>
<a href="#l4.1020"></a><span id="l4.1020" class="difflineplus">+    }</span>
<a href="#l4.1021"></a><span id="l4.1021" class="difflineplus">+    this.stopSpinner('manually_edit_config');</span>
<a href="#l4.1022"></a><span id="l4.1022" class="difflineplus">+    this.editConfigDetails();</span>
<a href="#l4.1023"></a><span id="l4.1023" class="difflineplus">+    // swap the stop button for the config go (restart) button</span>
<a href="#l4.1024"></a><span id="l4.1024" class="difflineplus">+    _hide(&quot;stop_button&quot;);</span>
<a href="#l4.1025"></a><span id="l4.1025" class="difflineplus">+    _show(&quot;go_button&quot;);</span>
<a href="#l4.1026"></a><span id="l4.1026" class="difflineplus">+  },</span>
<a href="#l4.1027"></a><span id="l4.1027" class="difflineplus">+</span>
<a href="#l4.1028"></a><span id="l4.1028" class="difflineplus">+  /* (Go) button click handler.  Restarts the config guessing process after a</span>
<a href="#l4.1029"></a><span id="l4.1029" class="difflineplus">+   * person possibly editing the fields.  The go button replaces either the</span>
<a href="#l4.1030"></a><span id="l4.1030" class="difflineplus">+   * (Stop) or (Edit) button after they have been clicked.</span>
<a href="#l4.1031"></a><span id="l4.1031" class="difflineplus">+   */</span>
<a href="#l4.1032"></a><span id="l4.1032" class="difflineplus">+  onGo : function()</span>
<a href="#l4.1033"></a><span id="l4.1033" class="difflineplus">+  {</span>
<a href="#l4.1034"></a><span id="l4.1034" class="difflineplus">+    // swap out go for stop button</span>
<a href="#l4.1035"></a><span id="l4.1035" class="difflineplus">+    _hide(&quot;go_button&quot;);</span>
<a href="#l4.1036"></a><span id="l4.1036" class="difflineplus">+    // the stop is naturally not hidden so has no place in the code where it is</span>
<a href="#l4.1037"></a><span id="l4.1037" class="difflineplus">+    // told to be shown</span>
<a href="#l4.1038"></a><span id="l4.1038" class="difflineplus">+    _show(&quot;stop_button&quot;);</span>
<a href="#l4.1039"></a><span id="l4.1039" class="difflineplus">+    this.goWithConfigDetails();</span>
<a href="#l4.1040"></a><span id="l4.1040" class="difflineplus">+    var newConfig = this.getUserConfig();</span>
<a href="#l4.1041"></a><span id="l4.1041" class="difflineplus">+    // this prevents updateConfig from expecting the socketType to be set.</span>
<a href="#l4.1042"></a><span id="l4.1042" class="difflineplus">+    // Alternatively, maybe we shouldn't be calling updateConfig</span>
<a href="#l4.1043"></a><span id="l4.1043" class="difflineplus">+    newConfig.incoming._inprogress = true;</span>
<a href="#l4.1044"></a><span id="l4.1044" class="difflineplus">+    newConfig.outgoing._inprogress = true;</span>
<a href="#l4.1045"></a><span id="l4.1045" class="difflineplus">+    gEmailConfigWizard._startProbingIncoming(newConfig);</span>
<a href="#l4.1046"></a><span id="l4.1046" class="difflineplus">+    if (!this._userPickedOutgoingServer)</span>
<a href="#l4.1047"></a><span id="l4.1047" class="difflineplus">+      gEmailConfigWizard._startProbingOutgoing(newConfig);</span>
<a href="#l4.1048"></a><span id="l4.1048" class="difflineplus">+  },</span>
<a href="#l4.1049"></a><span id="l4.1049" class="difflineplus">+</span>
<a href="#l4.1050"></a><span id="l4.1050" class="difflineplus">+  onCancel : function()</span>
<a href="#l4.1051"></a><span id="l4.1051" class="difflineplus">+  {</span>
<a href="#l4.1052"></a><span id="l4.1052" class="difflineplus">+    this.onWizardShutdown();</span>
<a href="#l4.1053"></a><span id="l4.1053" class="difflineplus">+    window.close();</span>
<a href="#l4.1054"></a><span id="l4.1054" class="difflineplus">+  },</span>
<a href="#l4.1055"></a><span id="l4.1055" class="difflineplus">+</span>
<a href="#l4.1056"></a><span id="l4.1056" class="difflineplus">+  // UI helper functions</span>
<a href="#l4.1057"></a><span id="l4.1057" class="difflineplus">+</span>
<a href="#l4.1058"></a><span id="l4.1058" class="difflineplus">+  startSpinner: function(actionStrName)</span>
<a href="#l4.1059"></a><span id="l4.1059" class="difflineplus">+  {</span>
<a href="#l4.1060"></a><span id="l4.1060" class="difflineplus">+    this._showStatusTitle(false, actionStrName);</span>
<a href="#l4.1061"></a><span id="l4.1061" class="difflineplus">+    gEmailWizardLogger.warn(&quot;spinner start\n&quot;);</span>
<a href="#l4.1062"></a><span id="l4.1062" class="difflineplus">+  },</span>
<a href="#l4.1063"></a><span id="l4.1063" class="difflineplus">+</span>
<a href="#l4.1064"></a><span id="l4.1064" class="difflineplus">+  setSpinnerStatus : function(actionStrName)</span>
<a href="#l4.1065"></a><span id="l4.1065" class="difflineplus">+  {</span>
<a href="#l4.1066"></a><span id="l4.1066" class="difflineplus">+    this._showStatus(actionStrName);</span>
<a href="#l4.1067"></a><span id="l4.1067" class="difflineplus">+  },</span>
<a href="#l4.1068"></a><span id="l4.1068" class="difflineplus">+</span>
<a href="#l4.1069"></a><span id="l4.1069" class="difflineplus">+  stopSpinner: function(actionStrName)</span>
<a href="#l4.1070"></a><span id="l4.1070" class="difflineplus">+  {</span>
<a href="#l4.1071"></a><span id="l4.1071" class="difflineplus">+    this._showStatusTitle(true, actionStrName);</span>
<a href="#l4.1072"></a><span id="l4.1072" class="difflineplus">+    gEmailWizardLogger.warn(&quot;spinner stop\n&quot;);</span>
<a href="#l4.1073"></a><span id="l4.1073" class="difflineplus">+  },</span>
<a href="#l4.1074"></a><span id="l4.1074" class="difflineplus">+</span>
<a href="#l4.1075"></a><span id="l4.1075" class="difflineplus">+  // thought this would be needed other places, not likely though</span>
<a href="#l4.1076"></a><span id="l4.1076" class="difflineplus">+  _hideSpinner : function(hidden)</span>
<a href="#l4.1077"></a><span id="l4.1077" class="difflineplus">+  {</span>
<a href="#l4.1078"></a><span id="l4.1078" class="difflineplus">+    getElementById(&quot;config_spinner&quot;).hidden = hidden;</span>
<a href="#l4.1079"></a><span id="l4.1079" class="difflineplus">+  },</span>
<a href="#l4.1080"></a><span id="l4.1080" class="difflineplus">+</span>
<a href="#l4.1081"></a><span id="l4.1081" class="difflineplus">+  _showStatusTitle: function(success, msgName)</span>
<a href="#l4.1082"></a><span id="l4.1082" class="difflineplus">+  {</span>
<a href="#l4.1083"></a><span id="l4.1083" class="difflineplus">+    let msg;</span>
<a href="#l4.1084"></a><span id="l4.1084" class="difflineplus">+    try {</span>
<a href="#l4.1085"></a><span id="l4.1085" class="difflineplus">+      msg = msgName ? gStringsBundle.getString(msgName) : &quot;&quot;;</span>
<a href="#l4.1086"></a><span id="l4.1086" class="difflineplus">+    } catch(ex) {</span>
<a href="#l4.1087"></a><span id="l4.1087" class="difflineplus">+      ddump(&quot;missing string for &quot; + msgName);</span>
<a href="#l4.1088"></a><span id="l4.1088" class="difflineplus">+    }</span>
<a href="#l4.1089"></a><span id="l4.1089" class="difflineplus">+</span>
<a href="#l4.1090"></a><span id="l4.1090" class="difflineplus">+    this._hideSpinner(success);</span>
<a href="#l4.1091"></a><span id="l4.1091" class="difflineplus">+    let title = getElementById(&quot;config_status_title&quot;);</span>
<a href="#l4.1092"></a><span id="l4.1092" class="difflineplus">+    title.hidden = false;</span>
<a href="#l4.1093"></a><span id="l4.1093" class="difflineplus">+    title.textContent = msg;</span>
<a href="#l4.1094"></a><span id="l4.1094" class="difflineplus">+    gEmailWizardLogger.info(&quot;show status title &quot; + (success ? &quot;success&quot; : &quot;failure&quot;) +</span>
<a href="#l4.1095"></a><span id="l4.1095" class="difflineplus">+                            &quot;, msg: &quot; + msg);</span>
<a href="#l4.1096"></a><span id="l4.1096" class="difflineplus">+  },</span>
<a href="#l4.1097"></a><span id="l4.1097" class="difflineplus">+</span>
<a href="#l4.1098"></a><span id="l4.1098" class="difflineplus">+  _showStatus: function(msgName)</span>
<a href="#l4.1099"></a><span id="l4.1099" class="difflineplus">+  {</span>
<a href="#l4.1100"></a><span id="l4.1100" class="difflineplus">+    let msg;</span>
<a href="#l4.1101"></a><span id="l4.1101" class="difflineplus">+    try {</span>
<a href="#l4.1102"></a><span id="l4.1102" class="difflineplus">+      msg = msgName ? gStringsBundle.getString(msgName) : &quot;&quot;;</span>
<a href="#l4.1103"></a><span id="l4.1103" class="difflineplus">+    } catch(ex) {</span>
<a href="#l4.1104"></a><span id="l4.1104" class="difflineplus">+      ddump(&quot;missing string for &quot; + msgName);</span>
<a href="#l4.1105"></a><span id="l4.1105" class="difflineplus">+    }</span>
<a href="#l4.1106"></a><span id="l4.1106" class="difflineplus">+</span>
<a href="#l4.1107"></a><span id="l4.1107" class="difflineplus">+    let subtitle = getElementById(&quot;config_status_subtitle&quot;);</span>
<a href="#l4.1108"></a><span id="l4.1108" class="difflineplus">+    subtitle.hidden = false;</span>
<a href="#l4.1109"></a><span id="l4.1109" class="difflineplus">+    subtitle.textContent = msg;</span>
<a href="#l4.1110"></a><span id="l4.1110" class="difflineplus">+    gEmailWizardLogger.info(&quot;show status subtitle: &quot; + msg);</span>
<a href="#l4.1111"></a><span id="l4.1111" class="difflineplus">+  },</span>
<a href="#l4.1112"></a><span id="l4.1112" class="difflineplus">+</span>
<a href="#l4.1113"></a><span id="l4.1113" class="difflineplus">+  clickOnOutgoingServer: function()</span>
<a href="#l4.1114"></a><span id="l4.1114" class="difflineplus">+  {</span>
<a href="#l4.1115"></a><span id="l4.1115" class="difflineplus">+    _hide('outgoing_protocol');</span>
<a href="#l4.1116"></a><span id="l4.1116" class="difflineplus">+    _hide('outgoing_port');</span>
<a href="#l4.1117"></a><span id="l4.1117" class="difflineplus">+    _hide('outgoing_security');</span>
<a href="#l4.1118"></a><span id="l4.1118" class="difflineplus">+  },</span>
<a href="#l4.1119"></a><span id="l4.1119" class="difflineplus">+</span>
<a href="#l4.1120"></a><span id="l4.1120" class="difflineplus">+  setHost: function(eltId)</span>
<a href="#l4.1121"></a><span id="l4.1121" class="difflineplus">+  {</span>
<a href="#l4.1122"></a><span id="l4.1122" class="difflineplus">+    gEmailWizardLogger.info(&quot;doing setHost: &quot; + eltId);</span>
<a href="#l4.1123"></a><span id="l4.1123" class="difflineplus">+    let elt = getElementById(eltId);</span>
<a href="#l4.1124"></a><span id="l4.1124" class="difflineplus">+    if (!domainRE.test(elt.value))</span>
<a href="#l4.1125"></a><span id="l4.1125" class="difflineplus">+      return; // it's not a domain yet</span>
<a href="#l4.1126"></a><span id="l4.1126" class="difflineplus">+</span>
<a href="#l4.1127"></a><span id="l4.1127" class="difflineplus">+    // since we're having the user press &quot;Go&quot; to result config,</span>
<a href="#l4.1128"></a><span id="l4.1128" class="difflineplus">+    // we don't want to do it here at this point.</span>
<a href="#l4.1129"></a><span id="l4.1129" class="difflineplus">+    // XXX TODO FIXME</span>
<a href="#l4.1130"></a><span id="l4.1130" class="difflineplus">+    return;</span>
<a href="#l4.1131"></a><span id="l4.1131" class="difflineplus">+</span>
<a href="#l4.1132"></a><span id="l4.1132" class="difflineplus">+    var newConfig = this.getUserConfig();</span>
<a href="#l4.1133"></a><span id="l4.1133" class="difflineplus">+    switch (eltId)</span>
<a href="#l4.1134"></a><span id="l4.1134" class="difflineplus">+    {</span>
<a href="#l4.1135"></a><span id="l4.1135" class="difflineplus">+      case 'incoming_server':</span>
<a href="#l4.1136"></a><span id="l4.1136" class="difflineplus">+        // only probe if the current hostname is different.</span>
<a href="#l4.1137"></a><span id="l4.1137" class="difflineplus">+        if (this._currentConfigFilledIn &amp;&amp;</span>
<a href="#l4.1138"></a><span id="l4.1138" class="difflineplus">+            this._currentConfigFilledIn.incoming.hostname == newConfig.incoming.hostname)</span>
<a href="#l4.1139"></a><span id="l4.1139" class="difflineplus">+          return;</span>
<a href="#l4.1140"></a><span id="l4.1140" class="difflineplus">+        // this prevents updateConfig from expecting the socketType to be set.</span>
<a href="#l4.1141"></a><span id="l4.1141" class="difflineplus">+        // Alternatively, maybe we shouldn't be calling updateConfig</span>
<a href="#l4.1142"></a><span id="l4.1142" class="difflineplus">+        newConfig.incoming._inprogress = true;</span>
<a href="#l4.1143"></a><span id="l4.1143" class="difflineplus">+        newConfig.outgoing._inprogress = true;</span>
<a href="#l4.1144"></a><span id="l4.1144" class="difflineplus">+        this.foundConfig(newConfig);</span>
<a href="#l4.1145"></a><span id="l4.1145" class="difflineplus">+        gEmailConfigWizard._startProbingIncoming(newConfig);</span>
<a href="#l4.1146"></a><span id="l4.1146" class="difflineplus">+        break;</span>
<a href="#l4.1147"></a><span id="l4.1147" class="difflineplus">+      case 'outgoing_server':</span>
<a href="#l4.1148"></a><span id="l4.1148" class="difflineplus">+        if (this._currentConfigFilledIn &amp;&amp;</span>
<a href="#l4.1149"></a><span id="l4.1149" class="difflineplus">+            this._currentConfigFilledIn.outgoing.hostname == newConfig.outgoing.hostname)</span>
<a href="#l4.1150"></a><span id="l4.1150" class="difflineplus">+          return;</span>
<a href="#l4.1151"></a><span id="l4.1151" class="difflineplus">+</span>
<a href="#l4.1152"></a><span id="l4.1152" class="difflineplus">+        this.foundConfig(newConfig);</span>
<a href="#l4.1153"></a><span id="l4.1153" class="difflineplus">+        gEmailConfigWizard._startProbingOutgoing(newConfig);</span>
<a href="#l4.1154"></a><span id="l4.1154" class="difflineplus">+        break;</span>
<a href="#l4.1155"></a><span id="l4.1155" class="difflineplus">+    }</span>
<a href="#l4.1156"></a><span id="l4.1156" class="difflineplus">+  },</span>
<a href="#l4.1157"></a><span id="l4.1157" class="difflineplus">+</span>
<a href="#l4.1158"></a><span id="l4.1158" class="difflineplus">+  stopProbing: function(eltId)</span>
<a href="#l4.1159"></a><span id="l4.1159" class="difflineplus">+  {</span>
<a href="#l4.1160"></a><span id="l4.1160" class="difflineplus">+    gEmailWizardLogger.info(&quot;stopping probing: &quot; + eltId);</span>
<a href="#l4.1161"></a><span id="l4.1161" class="difflineplus">+    let elt = getElementById(eltId);</span>
<a href="#l4.1162"></a><span id="l4.1162" class="difflineplus">+    switch (eltId)</span>
<a href="#l4.1163"></a><span id="l4.1163" class="difflineplus">+    {</span>
<a href="#l4.1164"></a><span id="l4.1164" class="difflineplus">+    case 'incoming_server':</span>
<a href="#l4.1165"></a><span id="l4.1165" class="difflineplus">+      if (this._probeAbortable)</span>
<a href="#l4.1166"></a><span id="l4.1166" class="difflineplus">+        this._probeAbortable.cancel('incoming');</span>
<a href="#l4.1167"></a><span id="l4.1167" class="difflineplus">+      break;</span>
<a href="#l4.1168"></a><span id="l4.1168" class="difflineplus">+    case 'outgoing_server':</span>
<a href="#l4.1169"></a><span id="l4.1169" class="difflineplus">+      if (this._probeAbortable)</span>
<a href="#l4.1170"></a><span id="l4.1170" class="difflineplus">+        this._probeAbortable.cancel('outgoing');</span>
<a href="#l4.1171"></a><span id="l4.1171" class="difflineplus">+      break;</span>
<a href="#l4.1172"></a><span id="l4.1172" class="difflineplus">+    }</span>
<a href="#l4.1173"></a><span id="l4.1173" class="difflineplus">+  },</span>
<a href="#l4.1174"></a><span id="l4.1174" class="difflineplus">+</span>
<a href="#l4.1175"></a><span id="l4.1175" class="difflineplus">+  _prefillConfig: function(initialConfig)</span>
<a href="#l4.1176"></a><span id="l4.1176" class="difflineplus">+  {</span>
<a href="#l4.1177"></a><span id="l4.1177" class="difflineplus">+    var emailsplit = this._email.split(&quot;@&quot;);</span>
<a href="#l4.1178"></a><span id="l4.1178" class="difflineplus">+    if (emailsplit.length != 2)</span>
<a href="#l4.1179"></a><span id="l4.1179" class="difflineplus">+      throw new Exception(gStringsBundle.getString(&quot;email.error&quot;));</span>
<a href="#l4.1180"></a><span id="l4.1180" class="difflineplus">+</span>
<a href="#l4.1181"></a><span id="l4.1181" class="difflineplus">+    var emaillocal = sanitize.nonemptystring(emailsplit[0]);</span>
<a href="#l4.1182"></a><span id="l4.1182" class="difflineplus">+    initialConfig.incoming.username = emaillocal;</span>
<a href="#l4.1183"></a><span id="l4.1183" class="difflineplus">+    initialConfig.outgoing.username = emaillocal;</span>
<a href="#l4.1184"></a><span id="l4.1184" class="difflineplus">+    initialConfig.outgoing.protocol = 'smtp';</span>
<a href="#l4.1185"></a><span id="l4.1185" class="difflineplus">+    return initialConfig;</span>
<a href="#l4.1186"></a><span id="l4.1186" class="difflineplus">+  },</span>
<a href="#l4.1187"></a><span id="l4.1187" class="difflineplus">+</span>
<a href="#l4.1188"></a><span id="l4.1188" class="difflineplus">+  _startProbingIncoming : function(config)</span>
<a href="#l4.1189"></a><span id="l4.1189" class="difflineplus">+  {</span>
<a href="#l4.1190"></a><span id="l4.1190" class="difflineplus">+    gEmailWizardLogger.info(&quot;_startProbingIncoming: &quot; + config.incoming.hostname +</span>
<a href="#l4.1191"></a><span id="l4.1191" class="difflineplus">+                            &quot; probe = &quot; + this._probeAbortable);</span>
<a href="#l4.1192"></a><span id="l4.1192" class="difflineplus">+    this.startSpinner(&quot;searching_for_configs&quot;);</span>
<a href="#l4.1193"></a><span id="l4.1193" class="difflineplus">+    this.setSpinnerStatus(this._outgoingState == &quot;probing&quot; ?</span>
<a href="#l4.1194"></a><span id="l4.1194" class="difflineplus">+                          &quot;check_server_details&quot; : &quot;check_in_server_details&quot;);</span>
<a href="#l4.1195"></a><span id="l4.1195" class="difflineplus">+</span>
<a href="#l4.1196"></a><span id="l4.1196" class="difflineplus">+    config.incoming._inprogress = true;</span>
<a href="#l4.1197"></a><span id="l4.1197" class="difflineplus">+    // User entered hostname, we want to probe port and protocol and socketType</span>
<a href="#l4.1198"></a><span id="l4.1198" class="difflineplus">+    config.incoming.protocol = undefined;</span>
<a href="#l4.1199"></a><span id="l4.1199" class="difflineplus">+    config.incoming.port = undefined;</span>
<a href="#l4.1200"></a><span id="l4.1200" class="difflineplus">+    config.incoming.socketType = undefined;</span>
<a href="#l4.1201"></a><span id="l4.1201" class="difflineplus">+</span>
<a href="#l4.1202"></a><span id="l4.1202" class="difflineplus">+    if (this._probeAbortable)</span>
<a href="#l4.1203"></a><span id="l4.1203" class="difflineplus">+    {</span>
<a href="#l4.1204"></a><span id="l4.1204" class="difflineplus">+      gEmailWizardLogger.info(&quot;restarting probe: &quot; + config.incoming.hostname);</span>
<a href="#l4.1205"></a><span id="l4.1205" class="difflineplus">+      this._probeAbortable.restart(config.incoming.hostname, config,</span>
<a href="#l4.1206"></a><span id="l4.1206" class="difflineplus">+                                   &quot;incoming&quot;);</span>
<a href="#l4.1207"></a><span id="l4.1207" class="difflineplus">+    }</span>
<a href="#l4.1208"></a><span id="l4.1208" class="difflineplus">+    else</span>
<a href="#l4.1209"></a><span id="l4.1209" class="difflineplus">+    {</span>
<a href="#l4.1210"></a><span id="l4.1210" class="difflineplus">+      this._guessConfig(config.incoming.hostname, config, &quot;incoming&quot;);</span>
<a href="#l4.1211"></a><span id="l4.1211" class="difflineplus">+    }</span>
<a href="#l4.1212"></a><span id="l4.1212" class="difflineplus">+  },</span>
<a href="#l4.1213"></a><span id="l4.1213" class="difflineplus">+</span>
<a href="#l4.1214"></a><span id="l4.1214" class="difflineplus">+  _startProbingOutgoing : function(config)</span>
<a href="#l4.1215"></a><span id="l4.1215" class="difflineplus">+  {</span>
<a href="#l4.1216"></a><span id="l4.1216" class="difflineplus">+    gEmailWizardLogger.info(&quot;_startProbingOutgoing: &quot; + config.outgoing.hostname +</span>
<a href="#l4.1217"></a><span id="l4.1217" class="difflineplus">+                            &quot; probe = &quot; + this._probeAbortable);</span>
<a href="#l4.1218"></a><span id="l4.1218" class="difflineplus">+    this.startSpinner(&quot;searching_for_configs&quot;);</span>
<a href="#l4.1219"></a><span id="l4.1219" class="difflineplus">+    this.setSpinnerStatus(this._incomingState == &quot;probing&quot; ?</span>
<a href="#l4.1220"></a><span id="l4.1220" class="difflineplus">+                          &quot;check_server_details&quot; : &quot;check_out_server_details&quot;);</span>
<a href="#l4.1221"></a><span id="l4.1221" class="difflineplus">+</span>
<a href="#l4.1222"></a><span id="l4.1222" class="difflineplus">+    config.outgoing._inprogress = true;</span>
<a href="#l4.1223"></a><span id="l4.1223" class="difflineplus">+    // User entered hostname, we want to probe port and protocol and socketType</span>
<a href="#l4.1224"></a><span id="l4.1224" class="difflineplus">+    config.outgoing.port = undefined;</span>
<a href="#l4.1225"></a><span id="l4.1225" class="difflineplus">+    config.outgoing.socketType = undefined;</span>
<a href="#l4.1226"></a><span id="l4.1226" class="difflineplus">+</span>
<a href="#l4.1227"></a><span id="l4.1227" class="difflineplus">+    if (this._probeAbortable)</span>
<a href="#l4.1228"></a><span id="l4.1228" class="difflineplus">+    {</span>
<a href="#l4.1229"></a><span id="l4.1229" class="difflineplus">+      gEmailWizardLogger.info(&quot;restarting probe: &quot; + config.outgoing.hostname);</span>
<a href="#l4.1230"></a><span id="l4.1230" class="difflineplus">+      this._probeAbortable.restart(config.outgoing.hostname, config, &quot;outgoing&quot;);</span>
<a href="#l4.1231"></a><span id="l4.1231" class="difflineplus">+    }</span>
<a href="#l4.1232"></a><span id="l4.1232" class="difflineplus">+    else</span>
<a href="#l4.1233"></a><span id="l4.1233" class="difflineplus">+    {</span>
<a href="#l4.1234"></a><span id="l4.1234" class="difflineplus">+      this._guessConfig(config.outgoing.hostname, config, &quot;outgoing&quot;);</span>
<a href="#l4.1235"></a><span id="l4.1235" class="difflineplus">+    }</span>
<a href="#l4.1236"></a><span id="l4.1236" class="difflineplus">+  },</span>
<a href="#l4.1237"></a><span id="l4.1237" class="difflineplus">+</span>
<a href="#l4.1238"></a><span id="l4.1238" class="difflineplus">+  switchToTwin: function(elt, twin)</span>
<a href="#l4.1239"></a><span id="l4.1239" class="difflineplus">+  {</span>
<a href="#l4.1240"></a><span id="l4.1240" class="difflineplus">+    twin.hidden = false;</span>
<a href="#l4.1241"></a><span id="l4.1241" class="difflineplus">+    elt.hidden = true;</span>
<a href="#l4.1242"></a><span id="l4.1242" class="difflineplus">+    switch (twin.tagName)</span>
<a href="#l4.1243"></a><span id="l4.1243" class="difflineplus">+    {</span>
<a href="#l4.1244"></a><span id="l4.1244" class="difflineplus">+      case 'textbox':</span>
<a href="#l4.1245"></a><span id="l4.1245" class="difflineplus">+        twin.value = elt.value; // comes from label</span>
<a href="#l4.1246"></a><span id="l4.1246" class="difflineplus">+        twin.select();</span>
<a href="#l4.1247"></a><span id="l4.1247" class="difflineplus">+        break;</span>
<a href="#l4.1248"></a><span id="l4.1248" class="difflineplus">+      case 'menulist':</span>
<a href="#l4.1249"></a><span id="l4.1249" class="difflineplus">+        twin.selected = elt.value;</span>
<a href="#l4.1250"></a><span id="l4.1250" class="difflineplus">+        twin.focus();</span>
<a href="#l4.1251"></a><span id="l4.1251" class="difflineplus">+        break;</span>
<a href="#l4.1252"></a><span id="l4.1252" class="difflineplus">+      case 'label':</span>
<a href="#l4.1253"></a><span id="l4.1253" class="difflineplus">+        switch (elt.tagName)</span>
<a href="#l4.1254"></a><span id="l4.1254" class="difflineplus">+        {</span>
<a href="#l4.1255"></a><span id="l4.1255" class="difflineplus">+          case 'menulist':</span>
<a href="#l4.1256"></a><span id="l4.1256" class="difflineplus">+            twin.value = elt.selectedItem.label;</span>
<a href="#l4.1257"></a><span id="l4.1257" class="difflineplus">+            break;</span>
<a href="#l4.1258"></a><span id="l4.1258" class="difflineplus">+          case 'textbox':</span>
<a href="#l4.1259"></a><span id="l4.1259" class="difflineplus">+            twin.value = elt.value;</span>
<a href="#l4.1260"></a><span id="l4.1260" class="difflineplus">+        }</span>
<a href="#l4.1261"></a><span id="l4.1261" class="difflineplus">+    }</span>
<a href="#l4.1262"></a><span id="l4.1262" class="difflineplus">+  },</span>
<a href="#l4.1263"></a><span id="l4.1263" class="difflineplus">+</span>
<a href="#l4.1264"></a><span id="l4.1264" class="difflineplus">+  clearError: function(which) {</span>
<a href="#l4.1265"></a><span id="l4.1265" class="difflineplus">+    _hide(which);</span>
<a href="#l4.1266"></a><span id="l4.1266" class="difflineplus">+    getElementById(which).textContent = &quot;&quot;;</span>
<a href="#l4.1267"></a><span id="l4.1267" class="difflineplus">+  },</span>
<a href="#l4.1268"></a><span id="l4.1268" class="difflineplus">+</span>
<a href="#l4.1269"></a><span id="l4.1269" class="difflineplus">+  setError: function(which, msg_name) {</span>
<a href="#l4.1270"></a><span id="l4.1270" class="difflineplus">+    try {</span>
<a href="#l4.1271"></a><span id="l4.1271" class="difflineplus">+      _show(which);</span>
<a href="#l4.1272"></a><span id="l4.1272" class="difflineplus">+      getElementById(which).textContent = gStringsBundle.getString(msg_name);</span>
<a href="#l4.1273"></a><span id="l4.1273" class="difflineplus">+    }</span>
<a href="#l4.1274"></a><span id="l4.1274" class="difflineplus">+    catch(ex) {</span>
<a href="#l4.1275"></a><span id="l4.1275" class="difflineplus">+      alertPrompt(&quot;missing error string&quot;, msg_name);</span>
<a href="#l4.1276"></a><span id="l4.1276" class="difflineplus">+    }</span>
<a href="#l4.1277"></a><span id="l4.1277" class="difflineplus">+  },</span>
<a href="#l4.1278"></a><span id="l4.1278" class="difflineplus">+</span>
<a href="#l4.1279"></a><span id="l4.1279" class="difflineplus">+  onKeyDown : function (key)</span>
<a href="#l4.1280"></a><span id="l4.1280" class="difflineplus">+  {</span>
<a href="#l4.1281"></a><span id="l4.1281" class="difflineplus">+    if (key == 27)</span>
<a href="#l4.1282"></a><span id="l4.1282" class="difflineplus">+      this.onCancel();</span>
<a href="#l4.1283"></a><span id="l4.1283" class="difflineplus">+    else if (key == 13 &amp;&amp; !getElementById('create_button').disabled)</span>
<a href="#l4.1284"></a><span id="l4.1284" class="difflineplus">+      this.onOK();</span>
<a href="#l4.1285"></a><span id="l4.1285" class="difflineplus">+  },</span>
<a href="#l4.1286"></a><span id="l4.1286" class="difflineplus">+</span>
<a href="#l4.1287"></a><span id="l4.1287" class="difflineplus">+  onWizardShutdown: function EmailConfigWizard_onWizardshutdown() {</span>
<a href="#l4.1288"></a><span id="l4.1288" class="difflineplus">+    if (this._probeAbortale)</span>
<a href="#l4.1289"></a><span id="l4.1289" class="difflineplus">+      this._probeAbortable.cancel();</span>
<a href="#l4.1290"></a><span id="l4.1290" class="difflineplus">+</span>
<a href="#l4.1291"></a><span id="l4.1291" class="difflineplus">+    gEmailWizardLogger.info(&quot;Shutting down email config dialog&quot;);</span>
<a href="#l4.1292"></a><span id="l4.1292" class="difflineplus">+  }</span>
<a href="#l4.1293"></a><span id="l4.1293" class="difflineplus">+};</span>
<a href="#l4.1294"></a><span id="l4.1294" class="difflineplus">+</span>
<a href="#l4.1295"></a><span id="l4.1295" class="difflineplus">+var gEmailConfigWizard = new EmailConfigWizard();</span>
<a href="#l4.1296"></a><span id="l4.1296" class="difflineplus">+gEmailWizardLogger.info(&quot;email account setup dialog&quot;);</span>
<a href="#l4.1297"></a><span id="l4.1297" class="difflineplus">+</span>
<a href="#l4.1298"></a><span id="l4.1298" class="difflineplus">+function sslLabel(val)</span>
<a href="#l4.1299"></a><span id="l4.1299" class="difflineplus">+{</span>
<a href="#l4.1300"></a><span id="l4.1300" class="difflineplus">+  switch (val)</span>
<a href="#l4.1301"></a><span id="l4.1301" class="difflineplus">+  {</span>
<a href="#l4.1302"></a><span id="l4.1302" class="difflineplus">+    case 1:</span>
<a href="#l4.1303"></a><span id="l4.1303" class="difflineplus">+      return gStringsBundle.getString(&quot;no_encryption&quot;);</span>
<a href="#l4.1304"></a><span id="l4.1304" class="difflineplus">+    case 2:</span>
<a href="#l4.1305"></a><span id="l4.1305" class="difflineplus">+      return gStringsBundle.getString(&quot;ssltls&quot;);</span>
<a href="#l4.1306"></a><span id="l4.1306" class="difflineplus">+    case 3:</span>
<a href="#l4.1307"></a><span id="l4.1307" class="difflineplus">+      return gStringsBundle.getString(&quot;starttls&quot;);;</span>
<a href="#l4.1308"></a><span id="l4.1308" class="difflineplus">+    default:</span>
<a href="#l4.1309"></a><span id="l4.1309" class="difflineplus">+      throw new NotReached(&quot;Unknown SSL type&quot;);</span>
<a href="#l4.1310"></a><span id="l4.1310" class="difflineplus">+  }</span>
<a href="#l4.1311"></a><span id="l4.1311" class="difflineplus">+}</span>
<a href="#l4.1312"></a><span id="l4.1312" class="difflineplus">+</span>
<a href="#l4.1313"></a><span id="l4.1313" class="difflineplus">+</span>
<a href="#l4.1314"></a><span id="l4.1314" class="difflineplus">+function setText(id, value)</span>
<a href="#l4.1315"></a><span id="l4.1315" class="difflineplus">+{</span>
<a href="#l4.1316"></a><span id="l4.1316" class="difflineplus">+  var element = document.getElementById(id);</span>
<a href="#l4.1317"></a><span id="l4.1317" class="difflineplus">+  if (!element)</span>
<a href="#l4.1318"></a><span id="l4.1318" class="difflineplus">+    return;</span>
<a href="#l4.1319"></a><span id="l4.1319" class="difflineplus">+</span>
<a href="#l4.1320"></a><span id="l4.1320" class="difflineplus">+  if (element.localName == &quot;textbox&quot; || element.localName == &quot;label&quot;)</span>
<a href="#l4.1321"></a><span id="l4.1321" class="difflineplus">+    element.value = value;</span>
<a href="#l4.1322"></a><span id="l4.1322" class="difflineplus">+  else if (element.localName == &quot;description&quot;)</span>
<a href="#l4.1323"></a><span id="l4.1323" class="difflineplus">+    element.textContent = value;</span>
<a href="#l4.1324"></a><span id="l4.1324" class="difflineplus">+  else</span>
<a href="#l4.1325"></a><span id="l4.1325" class="difflineplus">+    throw new NotReached(&quot;XUL element type not supported&quot;);</span>
<a href="#l4.1326"></a><span id="l4.1326" class="difflineplus">+}</span>
<a href="#l4.1327"></a><span id="l4.1327" class="difflineplus">+</span>
<a href="#l4.1328"></a><span id="l4.1328" class="difflineplus">+</span>
<a href="#l4.1329"></a><span id="l4.1329" class="difflineplus">+/**</span>
<a href="#l4.1330"></a><span id="l4.1330" class="difflineplus">+* Called by dialog logic, if there are custom fields needed</span>
<a href="#l4.1331"></a><span id="l4.1331" class="difflineplus">+* The dialog just shows all these descriptions, and a textfield next to each,</span>
<a href="#l4.1332"></a><span id="l4.1332" class="difflineplus">+* and returns the values the user entered.</span>
<a href="#l4.1333"></a><span id="l4.1333" class="difflineplus">+*</span>
<a href="#l4.1334"></a><span id="l4.1334" class="difflineplus">+* @param inputFields {Array}   @see AccountConfig.inputFields</span>
<a href="#l4.1335"></a><span id="l4.1335" class="difflineplus">+* @param defaults {Object}</span>
<a href="#l4.1336"></a><span id="l4.1336" class="difflineplus">+* Associative array / map of</span>
<a href="#l4.1337"></a><span id="l4.1337" class="difflineplus">+* field ID (from config file) -&gt; default value in text field</span>
<a href="#l4.1338"></a><span id="l4.1338" class="difflineplus">+* The default values can come from a previous invokation of the dialog.</span>
<a href="#l4.1339"></a><span id="l4.1339" class="difflineplus">+* May be null.</span>
<a href="#l4.1340"></a><span id="l4.1340" class="difflineplus">+*/</span>
<a href="#l4.1341"></a><span id="l4.1341" class="difflineplus">+function CustomFieldsDialog(inputFields, defaults)</span>
<a href="#l4.1342"></a><span id="l4.1342" class="difflineplus">+{</span>
<a href="#l4.1343"></a><span id="l4.1343" class="difflineplus">+  if (!defaults)</span>
<a href="#l4.1344"></a><span id="l4.1344" class="difflineplus">+    defaults = {};</span>
<a href="#l4.1345"></a><span id="l4.1345" class="difflineplus">+</span>
<a href="#l4.1346"></a><span id="l4.1346" class="difflineplus">+  this._inputFields = inputFields;</span>
<a href="#l4.1347"></a><span id="l4.1347" class="difflineplus">+  this._defaults = defaults;</span>
<a href="#l4.1348"></a><span id="l4.1348" class="difflineplus">+}</span>
<a href="#l4.1349"></a><span id="l4.1349" class="difflineplus">+CustomFieldsDialog.prototype =</span>
<a href="#l4.1350"></a><span id="l4.1350" class="difflineplus">+{</span>
<a href="#l4.1351"></a><span id="l4.1351" class="difflineplus">+  /**</span>
<a href="#l4.1352"></a><span id="l4.1352" class="difflineplus">+   * Open dialog, unless the needed data is already in |defaults|.</span>
<a href="#l4.1353"></a><span id="l4.1353" class="difflineplus">+   * @param successCallback, cancelCallback @see open()</span>
<a href="#l4.1354"></a><span id="l4.1354" class="difflineplus">+   */</span>
<a href="#l4.1355"></a><span id="l4.1355" class="difflineplus">+  openIfNeeded : function(successCallback, cancelCallback)</span>
<a href="#l4.1356"></a><span id="l4.1356" class="difflineplus">+  {</span>
<a href="#l4.1357"></a><span id="l4.1357" class="difflineplus">+    var needInput = false;</span>
<a href="#l4.1358"></a><span id="l4.1358" class="difflineplus">+    for (var i = 0; i &lt; this._inputFields.length; i++)</span>
<a href="#l4.1359"></a><span id="l4.1359" class="difflineplus">+    {</span>
<a href="#l4.1360"></a><span id="l4.1360" class="difflineplus">+      let fieldid = this._inputFields[i].varname;</span>
<a href="#l4.1361"></a><span id="l4.1361" class="difflineplus">+      if (!this._defaults[fieldid])</span>
<a href="#l4.1362"></a><span id="l4.1362" class="difflineplus">+        needInput = true;</span>
<a href="#l4.1363"></a><span id="l4.1363" class="difflineplus">+    }</span>
<a href="#l4.1364"></a><span id="l4.1364" class="difflineplus">+    if (!needInput)</span>
<a href="#l4.1365"></a><span id="l4.1365" class="difflineplus">+    {</span>
<a href="#l4.1366"></a><span id="l4.1366" class="difflineplus">+      successCallback(this._defaults);</span>
<a href="#l4.1367"></a><span id="l4.1367" class="difflineplus">+      return;</span>
<a href="#l4.1368"></a><span id="l4.1368" class="difflineplus">+    }</span>
<a href="#l4.1369"></a><span id="l4.1369" class="difflineplus">+</span>
<a href="#l4.1370"></a><span id="l4.1370" class="difflineplus">+    this.open(successCallback, cancelCallback);</span>
<a href="#l4.1371"></a><span id="l4.1371" class="difflineplus">+  },</span>
<a href="#l4.1372"></a><span id="l4.1372" class="difflineplus">+</span>
<a href="#l4.1373"></a><span id="l4.1373" class="difflineplus">+  /**</span>
<a href="#l4.1374"></a><span id="l4.1374" class="difflineplus">+   * @param successCallback {Function({Object})}</span>
<a href="#l4.1375"></a><span id="l4.1375" class="difflineplus">+   * Will be called when the user entered all values and clicked OK.</span>
<a href="#l4.1376"></a><span id="l4.1376" class="difflineplus">+   * The first parameter contains the values that the user entered,</span>
<a href="#l4.1377"></a><span id="l4.1377" class="difflineplus">+   * in form Map of: field ID -&gt; user value</span>
<a href="#l4.1378"></a><span id="l4.1378" class="difflineplus">+   *</span>
<a href="#l4.1379"></a><span id="l4.1379" class="difflineplus">+   * @param cancelCallback {Function()}</span>
<a href="#l4.1380"></a><span id="l4.1380" class="difflineplus">+   * The user cancelled the dialog.</span>
<a href="#l4.1381"></a><span id="l4.1381" class="difflineplus">+   */</span>
<a href="#l4.1382"></a><span id="l4.1382" class="difflineplus">+  open : function(successCallback, cancelCallback)</span>
<a href="#l4.1383"></a><span id="l4.1383" class="difflineplus">+  {</span>
<a href="#l4.1384"></a><span id="l4.1384" class="difflineplus">+    this._successCallback = successCallback;</span>
<a href="#l4.1385"></a><span id="l4.1385" class="difflineplus">+    this._cancelCallback = cancelCallback;</span>
<a href="#l4.1386"></a><span id="l4.1386" class="difflineplus">+</span>
<a href="#l4.1387"></a><span id="l4.1387" class="difflineplus">+    var rows = getElementById(&quot;customfields-rows&quot;);</span>
<a href="#l4.1388"></a><span id="l4.1388" class="difflineplus">+</span>
<a href="#l4.1389"></a><span id="l4.1389" class="difflineplus">+    // first, clear dialog from any possible previous use</span>
<a href="#l4.1390"></a><span id="l4.1390" class="difflineplus">+    while (rows.hasChildNodes())</span>
<a href="#l4.1391"></a><span id="l4.1391" class="difflineplus">+      rows.removeChild(rows.firstChild);</span>
<a href="#l4.1392"></a><span id="l4.1392" class="difflineplus">+</span>
<a href="#l4.1393"></a><span id="l4.1393" class="difflineplus">+    for (var i = 0; i &lt; this._inputFields.length; i++)</span>
<a href="#l4.1394"></a><span id="l4.1394" class="difflineplus">+    {</span>
<a href="#l4.1395"></a><span id="l4.1395" class="difflineplus">+      let fieldid = this._inputFields[i].varname;</span>
<a href="#l4.1396"></a><span id="l4.1396" class="difflineplus">+      let displayName = this._inputFields[i].displayName;</span>
<a href="#l4.1397"></a><span id="l4.1397" class="difflineplus">+      let exampleValue = this._inputFields[i].exampleValue;</span>
<a href="#l4.1398"></a><span id="l4.1398" class="difflineplus">+</span>
<a href="#l4.1399"></a><span id="l4.1399" class="difflineplus">+      // only 5 fields allowed per spec, to cut down on dialog size and preserve sanity</span>
<a href="#l4.1400"></a><span id="l4.1400" class="difflineplus">+      if (i &gt;= 5)</span>
<a href="#l4.1401"></a><span id="l4.1401" class="difflineplus">+        throw new Exception(gStringsBundle.getString(&quot;customfields_tooMany.error&quot;));</span>
<a href="#l4.1402"></a><span id="l4.1402" class="difflineplus">+</span>
<a href="#l4.1403"></a><span id="l4.1403" class="difflineplus">+      // Create UI widgets</span>
<a href="#l4.1404"></a><span id="l4.1404" class="difflineplus">+      let row = document.createElement(&quot;row&quot;);</span>
<a href="#l4.1405"></a><span id="l4.1405" class="difflineplus">+      let descr = document.createElement(&quot;description&quot;);</span>
<a href="#l4.1406"></a><span id="l4.1406" class="difflineplus">+      let textfield = document.createElement(&quot;textbox&quot;);</span>
<a href="#l4.1407"></a><span id="l4.1407" class="difflineplus">+      let exHBox = document.createElement(&quot;hbox&quot;);</span>
<a href="#l4.1408"></a><span id="l4.1408" class="difflineplus">+      let exLabel = document.createElement(&quot;label&quot;);</span>
<a href="#l4.1409"></a><span id="l4.1409" class="difflineplus">+      let example = document.createElement(&quot;label&quot;);</span>
<a href="#l4.1410"></a><span id="l4.1410" class="difflineplus">+      exHBox.appendChild(exLabel);</span>
<a href="#l4.1411"></a><span id="l4.1411" class="difflineplus">+      exHBox.appendChild(example);</span>
<a href="#l4.1412"></a><span id="l4.1412" class="difflineplus">+      row.appendChild(descr);</span>
<a href="#l4.1413"></a><span id="l4.1413" class="difflineplus">+      row.appendChild(textfield);</span>
<a href="#l4.1414"></a><span id="l4.1414" class="difflineplus">+      row.appendChild(exHBox);</span>
<a href="#l4.1415"></a><span id="l4.1415" class="difflineplus">+      rows.appendChild(row);</span>
<a href="#l4.1416"></a><span id="l4.1416" class="difflineplus">+      descr.setAttribute(&quot;class&quot;, &quot;customfield-label&quot;);</span>
<a href="#l4.1417"></a><span id="l4.1417" class="difflineplus">+      textfield.setAttribute(&quot;class&quot;, &quot;customfield-value&quot;);</span>
<a href="#l4.1418"></a><span id="l4.1418" class="difflineplus">+      example.setAttribute(&quot;class&quot;, &quot;customfield-example&quot;);</span>
<a href="#l4.1419"></a><span id="l4.1419" class="difflineplus">+      // fieldid was already sanitized in readFrom XML.js as alphanumdash and uppercase</span>
<a href="#l4.1420"></a><span id="l4.1420" class="difflineplus">+      textfield.id = &quot;customfield-value-&quot; + fieldid;</span>
<a href="#l4.1421"></a><span id="l4.1421" class="difflineplus">+      exLabel.setAttribute(&quot;value&quot;, gStringsBundle.getString(&quot;customfields_example.label&quot;));</span>
<a href="#l4.1422"></a><span id="l4.1422" class="difflineplus">+</span>
<a href="#l4.1423"></a><span id="l4.1423" class="difflineplus">+      // Set labels and values</span>
<a href="#l4.1424"></a><span id="l4.1424" class="difflineplus">+      descr.textContent = displayName;</span>
<a href="#l4.1425"></a><span id="l4.1425" class="difflineplus">+      example.setAttribute(&quot;value&quot;, exampleValue);</span>
<a href="#l4.1426"></a><span id="l4.1426" class="difflineplus">+      if (this._defaults &amp;&amp; this._defaults[fieldid])</span>
<a href="#l4.1427"></a><span id="l4.1427" class="difflineplus">+        textfield.setAttribute(&quot;value&quot;, this._defaults[fieldid]);</span>
<a href="#l4.1428"></a><span id="l4.1428" class="difflineplus">+    }</span>
<a href="#l4.1429"></a><span id="l4.1429" class="difflineplus">+</span>
<a href="#l4.1430"></a><span id="l4.1430" class="difflineplus">+    _hide(&quot;mastervbox&quot;);</span>
<a href="#l4.1431"></a><span id="l4.1431" class="difflineplus">+    _show(&quot;customfields-box&quot;);</span>
<a href="#l4.1432"></a><span id="l4.1432" class="difflineplus">+  },</span>
<a href="#l4.1433"></a><span id="l4.1433" class="difflineplus">+</span>
<a href="#l4.1434"></a><span id="l4.1434" class="difflineplus">+  // UI button pressed</span>
<a href="#l4.1435"></a><span id="l4.1435" class="difflineplus">+  onCancel : function()</span>
<a href="#l4.1436"></a><span id="l4.1436" class="difflineplus">+  {</span>
<a href="#l4.1437"></a><span id="l4.1437" class="difflineplus">+    _show(&quot;mastervbox&quot;);</span>
<a href="#l4.1438"></a><span id="l4.1438" class="difflineplus">+    _hide(&quot;customfields-box&quot;);</span>
<a href="#l4.1439"></a><span id="l4.1439" class="difflineplus">+    gCustomFieldsDialog = null;</span>
<a href="#l4.1440"></a><span id="l4.1440" class="difflineplus">+    try {</span>
<a href="#l4.1441"></a><span id="l4.1441" class="difflineplus">+      this._cancelCallback();</span>
<a href="#l4.1442"></a><span id="l4.1442" class="difflineplus">+    } catch (e) {</span>
<a href="#l4.1443"></a><span id="l4.1443" class="difflineplus">+      // XXX TODO FIXME</span>
<a href="#l4.1444"></a><span id="l4.1444" class="difflineplus">+      alert(e.message); throw e;</span>
<a href="#l4.1445"></a><span id="l4.1445" class="difflineplus">+    }</span>
<a href="#l4.1446"></a><span id="l4.1446" class="difflineplus">+  },</span>
<a href="#l4.1447"></a><span id="l4.1447" class="difflineplus">+</span>
<a href="#l4.1448"></a><span id="l4.1448" class="difflineplus">+  // UI button pressed</span>
<a href="#l4.1449"></a><span id="l4.1449" class="difflineplus">+  onOK : function()</span>
<a href="#l4.1450"></a><span id="l4.1450" class="difflineplus">+  {</span>
<a href="#l4.1451"></a><span id="l4.1451" class="difflineplus">+    try {</span>
<a href="#l4.1452"></a><span id="l4.1452" class="difflineplus">+      var result = {};</span>
<a href="#l4.1453"></a><span id="l4.1453" class="difflineplus">+      for (var i = 0; i &lt; this._inputFields.length; i++)</span>
<a href="#l4.1454"></a><span id="l4.1454" class="difflineplus">+      {</span>
<a href="#l4.1455"></a><span id="l4.1455" class="difflineplus">+        let fieldid = this._inputFields[i].varname;</span>
<a href="#l4.1456"></a><span id="l4.1456" class="difflineplus">+        result[fieldid] = getElementById(&quot;customfield-value-&quot; + fieldid).value;</span>
<a href="#l4.1457"></a><span id="l4.1457" class="difflineplus">+</span>
<a href="#l4.1458"></a><span id="l4.1458" class="difflineplus">+        gEmailWizardLogger.info(&quot;User value for &quot; + fieldid + &quot; is &quot; + result[fieldid]);</span>
<a href="#l4.1459"></a><span id="l4.1459" class="difflineplus">+        if (!result[fieldid])</span>
<a href="#l4.1460"></a><span id="l4.1460" class="difflineplus">+        {</span>
<a href="#l4.1461"></a><span id="l4.1461" class="difflineplus">+          getElementById(&quot;customfields-error&quot;).textContent =</span>
<a href="#l4.1462"></a><span id="l4.1462" class="difflineplus">+            gStringsBundle.getString(&quot;customfields_empty.error&quot;);</span>
<a href="#l4.1463"></a><span id="l4.1463" class="difflineplus">+          return;</span>
<a href="#l4.1464"></a><span id="l4.1464" class="difflineplus">+        }</span>
<a href="#l4.1465"></a><span id="l4.1465" class="difflineplus">+      }</span>
<a href="#l4.1466"></a><span id="l4.1466" class="difflineplus">+</span>
<a href="#l4.1467"></a><span id="l4.1467" class="difflineplus">+      _show(&quot;mastervbox&quot;);</span>
<a href="#l4.1468"></a><span id="l4.1468" class="difflineplus">+      _hide(&quot;customfields-box&quot;);</span>
<a href="#l4.1469"></a><span id="l4.1469" class="difflineplus">+      gCustomFieldsDialog = null;</span>
<a href="#l4.1470"></a><span id="l4.1470" class="difflineplus">+</span>
<a href="#l4.1471"></a><span id="l4.1471" class="difflineplus">+      this._successCallback(result);</span>
<a href="#l4.1472"></a><span id="l4.1472" class="difflineplus">+</span>
<a href="#l4.1473"></a><span id="l4.1473" class="difflineplus">+    } catch (e) { alert(e.message); throw e; } // TODO alertPrompt()</span>
<a href="#l4.1474"></a><span id="l4.1474" class="difflineplus">+  }</span>
<a href="#l4.1475"></a><span id="l4.1475" class="difflineplus">+}</span>
<a href="#l4.1476"></a><span id="l4.1476" class="difflineplus">+</span>
<a href="#l4.1477"></a><span id="l4.1477" class="difflineplus">+var gCustomFieldsDialog = null;</span>
<a href="#l4.1478"></a><span id="l4.1478" class="difflineplus">+</span>
<a href="#l4.1479"></a><span id="l4.1479" class="difflineplus">+</span>
<a href="#l4.1480"></a><span id="l4.1480" class="difflineplus">+/**</span>
<a href="#l4.1481"></a><span id="l4.1481" class="difflineplus">+* Called by dialog logic, if the user needs to visit certain pages and do stuff</span>
<a href="#l4.1482"></a><span id="l4.1482" class="difflineplus">+* in order for his account to work with Thunderbird.</span>
<a href="#l4.1483"></a><span id="l4.1483" class="difflineplus">+* The dialog just shows all these descriptions, and clickable links,</span>
<a href="#l4.1484"></a><span id="l4.1484" class="difflineplus">+* and tracks the clicks, and returns whether the URLs were opened.</span>
<a href="#l4.1485"></a><span id="l4.1485" class="difflineplus">+*</span>
<a href="#l4.1486"></a><span id="l4.1486" class="difflineplus">+* @param enableURLs {Array}   @see AccountConfig.enableURLs</span>
<a href="#l4.1487"></a><span id="l4.1487" class="difflineplus">+* @param alreadyVisited {Object}  Map of: URL {String} -&gt; bool</span>
<a href="#l4.1488"></a><span id="l4.1488" class="difflineplus">+* URLs that the user has already visited in a previous run of the dialog.</span>
<a href="#l4.1489"></a><span id="l4.1489" class="difflineplus">+* May be null.</span>
<a href="#l4.1490"></a><span id="l4.1490" class="difflineplus">+*</span>
<a href="#l4.1491"></a><span id="l4.1491" class="difflineplus">+*/</span>
<a href="#l4.1492"></a><span id="l4.1492" class="difflineplus">+function EnableURLsDialog(enableURLs, alreadyVisited)</span>
<a href="#l4.1493"></a><span id="l4.1493" class="difflineplus">+{</span>
<a href="#l4.1494"></a><span id="l4.1494" class="difflineplus">+  if ( ! alreadyVisited)</span>
<a href="#l4.1495"></a><span id="l4.1495" class="difflineplus">+    alreadyVisited = {};</span>
<a href="#l4.1496"></a><span id="l4.1496" class="difflineplus">+</span>
<a href="#l4.1497"></a><span id="l4.1497" class="difflineplus">+  this._visitedURLs = alreadyVisited;</span>
<a href="#l4.1498"></a><span id="l4.1498" class="difflineplus">+}</span>
<a href="#l4.1499"></a><span id="l4.1499" class="difflineplus">+</span>
<a href="#l4.1500"></a><span id="l4.1500" class="difflineplus">+EnableURLsDialog.prototype =</span>
<a href="#l4.1501"></a><span id="l4.1501" class="difflineplus">+{</span>
<a href="#l4.1502"></a><span id="l4.1502" class="difflineplus">+  /**</span>
<a href="#l4.1503"></a><span id="l4.1503" class="difflineplus">+   * Open dialog, unless the needed data is already in |alreadyVisited|.</span>
<a href="#l4.1504"></a><span id="l4.1504" class="difflineplus">+   * @param successCallback, cancelCallback @see open()</span>
<a href="#l4.1505"></a><span id="l4.1505" class="difflineplus">+   */</span>
<a href="#l4.1506"></a><span id="l4.1506" class="difflineplus">+  openIfNeeded : function(successCallback, cancelCallback)</span>
<a href="#l4.1507"></a><span id="l4.1507" class="difflineplus">+  {</span>
<a href="#l4.1508"></a><span id="l4.1508" class="difflineplus">+    var needVisits = false;</span>
<a href="#l4.1509"></a><span id="l4.1509" class="difflineplus">+    for (var i = 0; i &lt; this._enableURLs.length; i++)</span>
<a href="#l4.1510"></a><span id="l4.1510" class="difflineplus">+    {</span>
<a href="#l4.1511"></a><span id="l4.1511" class="difflineplus">+      let url = this._enableURLs[i].url;</span>
<a href="#l4.1512"></a><span id="l4.1512" class="difflineplus">+      if ( ! this._visitedURLs[url])</span>
<a href="#l4.1513"></a><span id="l4.1513" class="difflineplus">+        needVisits = true;</span>
<a href="#l4.1514"></a><span id="l4.1514" class="difflineplus">+    }</span>
<a href="#l4.1515"></a><span id="l4.1515" class="difflineplus">+    if (!needVisits)</span>
<a href="#l4.1516"></a><span id="l4.1516" class="difflineplus">+    {</span>
<a href="#l4.1517"></a><span id="l4.1517" class="difflineplus">+      successCallback(this._visitedURLs);</span>
<a href="#l4.1518"></a><span id="l4.1518" class="difflineplus">+      return;</span>
<a href="#l4.1519"></a><span id="l4.1519" class="difflineplus">+    }</span>
<a href="#l4.1520"></a><span id="l4.1520" class="difflineplus">+</span>
<a href="#l4.1521"></a><span id="l4.1521" class="difflineplus">+    this.open(successCallback, cancelCallback);</span>
<a href="#l4.1522"></a><span id="l4.1522" class="difflineplus">+  },</span>
<a href="#l4.1523"></a><span id="l4.1523" class="difflineplus">+  /**</span>
<a href="#l4.1524"></a><span id="l4.1524" class="difflineplus">+   * @param successCallback {Function(this._visitedEnableURLs)}</span>
<a href="#l4.1525"></a><span id="l4.1525" class="difflineplus">+   * Will be called when the user visited all URLs and clicked OK.</span>
<a href="#l4.1526"></a><span id="l4.1526" class="difflineplus">+   * The first parameter contains the URLs (as map URL {String} -&gt; bool).</span>
<a href="#l4.1527"></a><span id="l4.1527" class="difflineplus">+   *</span>
<a href="#l4.1528"></a><span id="l4.1528" class="difflineplus">+   * @param cancelCallback {Function()}</span>
<a href="#l4.1529"></a><span id="l4.1529" class="difflineplus">+   * The user cancelled the dialog</span>
<a href="#l4.1530"></a><span id="l4.1530" class="difflineplus">+   */</span>
<a href="#l4.1531"></a><span id="l4.1531" class="difflineplus">+  open : function(successCallback, cancelCallback)</span>
<a href="#l4.1532"></a><span id="l4.1532" class="difflineplus">+  {</span>
<a href="#l4.1533"></a><span id="l4.1533" class="difflineplus">+    this._successCallback = successCallback;</span>
<a href="#l4.1534"></a><span id="l4.1534" class="difflineplus">+    this._cancelCallback = cancelCallback;</span>
<a href="#l4.1535"></a><span id="l4.1535" class="difflineplus">+</span>
<a href="#l4.1536"></a><span id="l4.1536" class="difflineplus">+    var rows = getElementById(&quot;enableURLs-rows&quot;);</span>
<a href="#l4.1537"></a><span id="l4.1537" class="difflineplus">+    var me = this;</span>
<a href="#l4.1538"></a><span id="l4.1538" class="difflineplus">+</span>
<a href="#l4.1539"></a><span id="l4.1539" class="difflineplus">+    // first, clear dialog from any possible previous use</span>
<a href="#l4.1540"></a><span id="l4.1540" class="difflineplus">+    while (rows.hasChildNodes())</span>
<a href="#l4.1541"></a><span id="l4.1541" class="difflineplus">+      rows.removeChild(rows.firstChild);</span>
<a href="#l4.1542"></a><span id="l4.1542" class="difflineplus">+</span>
<a href="#l4.1543"></a><span id="l4.1543" class="difflineplus">+    for (var i = 0; i &lt; this._enableURLs.length; i++)</span>
<a href="#l4.1544"></a><span id="l4.1544" class="difflineplus">+    {</span>
<a href="#l4.1545"></a><span id="l4.1545" class="difflineplus">+      let url = this._enableURLs[i].url;</span>
<a href="#l4.1546"></a><span id="l4.1546" class="difflineplus">+      let instr = this._enableURLs[i].instruction;</span>
<a href="#l4.1547"></a><span id="l4.1547" class="difflineplus">+</span>
<a href="#l4.1548"></a><span id="l4.1548" class="difflineplus">+      // only 5 URLs allowed per spec, to cut down on dialog size and preserve sanity</span>
<a href="#l4.1549"></a><span id="l4.1549" class="difflineplus">+      if (i &gt;= 5)</span>
<a href="#l4.1550"></a><span id="l4.1550" class="difflineplus">+        throw new Exception(gStringsBundle.getString(&quot;enableURLs_tooMany.error&quot;));</span>
<a href="#l4.1551"></a><span id="l4.1551" class="difflineplus">+</span>
<a href="#l4.1552"></a><span id="l4.1552" class="difflineplus">+      // Create UI widgets</span>
<a href="#l4.1553"></a><span id="l4.1553" class="difflineplus">+      let row = document.createElement(&quot;row&quot;);</span>
<a href="#l4.1554"></a><span id="l4.1554" class="difflineplus">+      let descr = document.createElement(&quot;description&quot;);</span>
<a href="#l4.1555"></a><span id="l4.1555" class="difflineplus">+      let link = document.createElement(&quot;label&quot;);</span>
<a href="#l4.1556"></a><span id="l4.1556" class="difflineplus">+      let checkbox = document.createElement(&quot;checkbox&quot;);</span>
<a href="#l4.1557"></a><span id="l4.1557" class="difflineplus">+      row.appendChild(descr);</span>
<a href="#l4.1558"></a><span id="l4.1558" class="difflineplus">+      row.appendChild(link);</span>
<a href="#l4.1559"></a><span id="l4.1559" class="difflineplus">+      row.appendChild(checkbox);</span>
<a href="#l4.1560"></a><span id="l4.1560" class="difflineplus">+      rows.appendChild(row);</span>
<a href="#l4.1561"></a><span id="l4.1561" class="difflineplus">+      descr.setAttribute(&quot;class&quot;, &quot;enableURLs-label&quot;);</span>
<a href="#l4.1562"></a><span id="l4.1562" class="difflineplus">+      link.setAttribute(&quot;class&quot;, &quot;enableURLs-link text-link&quot;); // class=text-link is the XUL magic which makes it a link</span>
<a href="#l4.1563"></a><span id="l4.1563" class="difflineplus">+      checkbox.setAttribute(&quot;class&quot;, &quot;enableURLs-checkbox&quot;);</span>
<a href="#l4.1564"></a><span id="l4.1564" class="difflineplus">+      checkbox.disabled = true;</span>
<a href="#l4.1565"></a><span id="l4.1565" class="difflineplus">+      link.setAttribute(&quot;value&quot;, gStringsBundle.getString(&quot;enableURLs_openlink.label&quot;));</span>
<a href="#l4.1566"></a><span id="l4.1566" class="difflineplus">+      link.addEventListener(&quot;click&quot;, function() { me.onLinkClick(link, checkbox); }, true );</span>
<a href="#l4.1567"></a><span id="l4.1567" class="difflineplus">+      // TODO accessibility Bug 475260: using onclick, because &lt;label class=&quot;text-link&quot;&gt; does not send oncommand.</span>
<a href="#l4.1568"></a><span id="l4.1568" class="difflineplus">+</span>
<a href="#l4.1569"></a><span id="l4.1569" class="difflineplus">+      // Set labels and values</span>
<a href="#l4.1570"></a><span id="l4.1570" class="difflineplus">+      // URL was already sanitized in readFrom XML.js as loadable</span>
<a href="#l4.1571"></a><span id="l4.1571" class="difflineplus">+      descr.textContent = instr;</span>
<a href="#l4.1572"></a><span id="l4.1572" class="difflineplus">+      link.setAttribute(&quot;href&quot;, url);</span>
<a href="#l4.1573"></a><span id="l4.1573" class="difflineplus">+      checkbox.checked = this._visitedURLs[url] ? true : false;</span>
<a href="#l4.1574"></a><span id="l4.1574" class="difflineplus">+    }</span>
<a href="#l4.1575"></a><span id="l4.1575" class="difflineplus">+</span>
<a href="#l4.1576"></a><span id="l4.1576" class="difflineplus">+    _hide(&quot;mastervbox&quot;);</span>
<a href="#l4.1577"></a><span id="l4.1577" class="difflineplus">+    _show(&quot;enableURLs-box&quot;);</span>
<a href="#l4.1578"></a><span id="l4.1578" class="difflineplus">+  },</span>
<a href="#l4.1579"></a><span id="l4.1579" class="difflineplus">+</span>
<a href="#l4.1580"></a><span id="l4.1580" class="difflineplus">+  onLinkClick : function(linkLabel, checkbox)</span>
<a href="#l4.1581"></a><span id="l4.1581" class="difflineplus">+  {</span>
<a href="#l4.1582"></a><span id="l4.1582" class="difflineplus">+    var url = linkLabel.getAttribute(&quot;href&quot;);</span>
<a href="#l4.1583"></a><span id="l4.1583" class="difflineplus">+    this._visitedURLs[url] = true;</span>
<a href="#l4.1584"></a><span id="l4.1584" class="difflineplus">+    checkbox.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l4.1585"></a><span id="l4.1585" class="difflineplus">+  },</span>
<a href="#l4.1586"></a><span id="l4.1586" class="difflineplus">+</span>
<a href="#l4.1587"></a><span id="l4.1587" class="difflineplus">+  // UI button pressed</span>
<a href="#l4.1588"></a><span id="l4.1588" class="difflineplus">+  onCancel : function()</span>
<a href="#l4.1589"></a><span id="l4.1589" class="difflineplus">+  {</span>
<a href="#l4.1590"></a><span id="l4.1590" class="difflineplus">+    _show(&quot;mastervbox&quot;);</span>
<a href="#l4.1591"></a><span id="l4.1591" class="difflineplus">+    _hide(&quot;enableURLs-box&quot;);</span>
<a href="#l4.1592"></a><span id="l4.1592" class="difflineplus">+    gCustomFieldsDialog = null;</span>
<a href="#l4.1593"></a><span id="l4.1593" class="difflineplus">+    try {</span>
<a href="#l4.1594"></a><span id="l4.1594" class="difflineplus">+      this._cancelCallback();</span>
<a href="#l4.1595"></a><span id="l4.1595" class="difflineplus">+    } catch (e) {</span>
<a href="#l4.1596"></a><span id="l4.1596" class="difflineplus">+      // XXX TODO FIXME</span>
<a href="#l4.1597"></a><span id="l4.1597" class="difflineplus">+      alert(e.message); throw e; }</span>
<a href="#l4.1598"></a><span id="l4.1598" class="difflineplus">+  },</span>
<a href="#l4.1599"></a><span id="l4.1599" class="difflineplus">+</span>
<a href="#l4.1600"></a><span id="l4.1600" class="difflineplus">+  // UI button pressed</span>
<a href="#l4.1601"></a><span id="l4.1601" class="difflineplus">+  onOK : function()</span>
<a href="#l4.1602"></a><span id="l4.1602" class="difflineplus">+  {</span>
<a href="#l4.1603"></a><span id="l4.1603" class="difflineplus">+    try {</span>
<a href="#l4.1604"></a><span id="l4.1604" class="difflineplus">+      for (var i = 0; i &lt; this._enableURLs.length; i++)</span>
<a href="#l4.1605"></a><span id="l4.1605" class="difflineplus">+      {</span>
<a href="#l4.1606"></a><span id="l4.1606" class="difflineplus">+        let url = this._enableURLs[i].url;</span>
<a href="#l4.1607"></a><span id="l4.1607" class="difflineplus">+        gEmailWizardLogger.info(url + &quot;  has been visited: &quot; + this._visitedURLs[url]);</span>
<a href="#l4.1608"></a><span id="l4.1608" class="difflineplus">+        if (!this._visitedURLs[url])</span>
<a href="#l4.1609"></a><span id="l4.1609" class="difflineplus">+        {</span>
<a href="#l4.1610"></a><span id="l4.1610" class="difflineplus">+          getElementById(&quot;enableURLs-error&quot;).textContent =</span>
<a href="#l4.1611"></a><span id="l4.1611" class="difflineplus">+            gStringsBundle.getString(&quot;enableURLs_notvisited.error&quot;);</span>
<a href="#l4.1612"></a><span id="l4.1612" class="difflineplus">+          return;</span>
<a href="#l4.1613"></a><span id="l4.1613" class="difflineplus">+        }</span>
<a href="#l4.1614"></a><span id="l4.1614" class="difflineplus">+      }</span>
<a href="#l4.1615"></a><span id="l4.1615" class="difflineplus">+</span>
<a href="#l4.1616"></a><span id="l4.1616" class="difflineplus">+      _show(&quot;mastervbox&quot;);</span>
<a href="#l4.1617"></a><span id="l4.1617" class="difflineplus">+      _hide(&quot;enableURLs-box&quot;);</span>
<a href="#l4.1618"></a><span id="l4.1618" class="difflineplus">+      gEnableURLsDialog = null;</span>
<a href="#l4.1619"></a><span id="l4.1619" class="difflineplus">+</span>
<a href="#l4.1620"></a><span id="l4.1620" class="difflineplus">+      this._successCallback(this._visitedURLs);</span>
<a href="#l4.1621"></a><span id="l4.1621" class="difflineplus">+</span>
<a href="#l4.1622"></a><span id="l4.1622" class="difflineplus">+    } catch (e) {</span>
<a href="#l4.1623"></a><span id="l4.1623" class="difflineplus">+      // XXX TODO FIXME</span>
<a href="#l4.1624"></a><span id="l4.1624" class="difflineplus">+      alert(e.message); throw e;</span>
<a href="#l4.1625"></a><span id="l4.1625" class="difflineplus">+    }</span>
<a href="#l4.1626"></a><span id="l4.1626" class="difflineplus">+  }</span>
<a href="#l4.1627"></a><span id="l4.1627" class="difflineplus">+}</span>
<a href="#l4.1628"></a><span id="l4.1628" class="difflineplus">+</span>
<a href="#l4.1629"></a><span id="l4.1629" class="difflineplus">+var gEnableURLsDialog = null;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/mailnews/base/prefs/resources/content/accountcreation/emailWizard.xul</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,414 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://global/skin/&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://messenger/skin/accountCreation.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+&lt;!DOCTYPE window [</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+  &lt;!ENTITY % brandDTD SYSTEM &quot;chrome://branding/locale/brand.dtd&quot;&gt;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+  %brandDTD;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  &lt;!ENTITY % acDTD SYSTEM &quot;chrome://messenger/locale/accountCreation.dtd&quot;&gt;</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+  %acDTD;</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+]&gt;</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+&lt;window xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+        id=&quot;autoconfigWizard&quot;</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+        title=&quot;&amp;welcome.description;&quot;</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+        style=&quot;&amp;autoconfigWizard.style;&quot;</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+        onload=&quot;gEmailConfigWizard.onLoad();&quot;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+        onkeydown=&quot;gEmailConfigWizard.onKeyDown()&quot;</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+        onclose=&quot;gEmailConfigWizard.onWizardShutdown();&quot;</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+        onunload=&quot;gEmailConfigWizard.onWizardShutdown();&quot;</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+        &gt;</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+  &lt;stringbundleset&gt;</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+    &lt;stringbundle id=&quot;strings&quot; src=&quot;chrome://messenger/locale/accountCreation.properties&quot;/&gt;</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+    &lt;stringbundle id=&quot;utilstrings&quot; src=&quot;chrome://messenger/locale/accountCreationUtil.properties&quot;/&gt;</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+  &lt;/stringbundleset&gt;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+          src=&quot;chrome://messenger/content/accountcreation/util.js&quot;/&gt;</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+          src=&quot;chrome://messenger/content/accountcreation/accountConfig.js&quot;/&gt;</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+          src=&quot;chrome://messenger/content/accountcreation/emailWizard.js&quot;/&gt;</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+          src=&quot;chrome://messenger/content/accountcreation/sanitizeDatatypes.js&quot;/&gt;</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+          src=&quot;chrome://messenger/content/accountcreation/fetchhttp.js&quot;/&gt;</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+          src=&quot;chrome://messenger/content/accountcreation/readFromXML.js&quot;/&gt;</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+          src=&quot;chrome://messenger/content/accountcreation/guessConfig.js&quot;/&gt;</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+          src=&quot;chrome://messenger/content/accountcreation/verifyConfig.js&quot;/&gt;</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+          src=&quot;chrome://messenger/content/accountcreation/fetchConfig.js&quot;/&gt;</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+          src=&quot;chrome://messenger/content/accountcreation/createInBackend.js&quot;/&gt;</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+          src=&quot;chrome://messenger/content/accountcreation/MyBadCertHandler.js&quot;/&gt;</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+  &lt;keyset id=&quot;mailKeys&quot;&gt;</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+    &lt;key keycode=&quot;VK_ESCAPE&quot; oncommand=&quot;window.close();&quot;/&gt;</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+  &lt;/keyset&gt;</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+  &lt;tooltip id=&quot;insecureserver-cleartext&quot;&gt;</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+    &lt;hbox align=&quot;bottom&quot;&gt;</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+      &lt;image class=&quot;insecureLarry&quot;/&gt;</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+      &lt;description&gt;&amp;insecureCleartext.description;&lt;/description&gt;</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+    &lt;/hbox&gt;</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+  &lt;/tooltip&gt;</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+  &lt;tooltip id=&quot;insecureserver-selfsigned&quot;&gt;</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+    &lt;hbox align=&quot;bottom&quot;&gt;</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+      &lt;image class=&quot;insecureLarry&quot;/&gt;</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+      &lt;description&gt;&amp;insecureSelfsigned.description;&lt;/description&gt;</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+    &lt;/hbox&gt;</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+  &lt;/tooltip&gt;</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+  &lt;tooltip id=&quot;secureservertooltip&quot;&gt;</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+    &lt;hbox align=&quot;bottom&quot;&gt;</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+      &lt;image class=&quot;secureLarry&quot;/&gt;</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+      &lt;description&gt;&amp;secureServer.description;&lt;/description&gt;</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+    &lt;/hbox&gt;</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+  &lt;/tooltip&gt;</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+  &lt;vbox class=&quot;mastervbox&quot;</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+        id=&quot;mastervbox&quot;</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+        flex=&quot;1&quot;&gt;</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+    &lt;grid&gt;</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+      &lt;columns&gt;</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+        &lt;column/&gt;</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+        &lt;column flex=&quot;1&quot;/&gt;</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+      &lt;/columns&gt;</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+      &lt;rows&gt;</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+        &lt;row class=&quot;heading&quot;&gt;</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+          &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+            &lt;label class=&quot;heading&quot;&gt;Account Information&lt;/label&gt;</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+          &lt;/hbox&gt;</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+          &lt;hbox&gt;&lt;spacer/&gt;&lt;/hbox&gt;</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+        &lt;/row&gt;</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+        &lt;row&gt;</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+          &lt;grid&gt;</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+            &lt;rows&gt;</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+              &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+                &lt;description id=&quot;nameerror&quot; class=&quot;errordescription&quot;</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+                             hidden=&quot;true&quot;/&gt;</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+              &lt;/row&gt;</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+              &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+                &lt;textbox id=&quot;realname&quot; class=&quot;padded&quot;</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+                         value=&quot;&quot; emptytext=&quot;&amp;name.description;&quot;</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+                         onblur=&quot;gEmailConfigWizard.validateRealname();&quot;/&gt;</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+              &lt;/row&gt;</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+              &lt;spacer/&gt;</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+              &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+                &lt;description id=&quot;emailerror&quot; class=&quot;errordescription&quot;</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+                             hidden=&quot;true&quot;/&gt;</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+              &lt;/row&gt;</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+              &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+                &lt;textbox emptytext=&quot;&amp;email.description;&quot; id=&quot;email&quot; class=&quot;padded&quot;</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+                         onblur=&quot;gEmailConfigWizard.validateEmail();&quot;/&gt;</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+              &lt;/row&gt;</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+              &lt;spacer/&gt;</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+              &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+                &lt;description id=&quot;passworderror&quot; class=&quot;errordescription&quot;</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+                             hidden=&quot;true&quot;/&gt;</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+              &lt;/row&gt;</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+              &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+                &lt;!-- this starts out as text so the emptytext shows, but then</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+                     changes to type=password for the life of the dialog --&gt;</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+                &lt;textbox emptytext=&quot;&amp;password.description;&quot; id=&quot;password&quot;</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+                         class=&quot;padded&quot; type=&quot;text&quot;</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+                         onfocus=&quot;this.type='password';&quot;</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+                         onblur=&quot;gEmailConfigWizard.validatePassword();&quot;/&gt;</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+              &lt;/row&gt;</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+              &lt;row align=&quot;center&quot;&gt;</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+                &lt;checkbox id=&quot;remember_password&quot; label=&quot;&amp;rememberpassword.label;&quot; checked=&quot;true&quot;/&gt;</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+              &lt;/row&gt;</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+              &lt;row&gt;</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+                &lt;hbox pack=&quot;end&quot;&gt;</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+                  &lt;button id=&quot;next_button&quot;</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+                          oncommand=&quot;gEmailConfigWizard.onNext();&quot;</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+                          label=&quot;Next &amp;#187;&quot; class=&quot;larger-button&quot;/&gt;</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+                  &lt;button id=&quot;back_button&quot; class=&quot;smaller-button&quot;</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+                          oncommand=&quot;gEmailConfigWizard.onBack();&quot;</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+                          label=&quot;&amp;#171; Back&quot; hidden=&quot;true&quot;/&gt;</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+                &lt;/hbox&gt;</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+              &lt;/row&gt;</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineplus">+            &lt;/rows&gt;</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+          &lt;/grid&gt;</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+          &lt;vbox&gt;</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+            &lt;groupbox id=&quot;settingsbox&quot; class=&quot;settings&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+              &lt;vbox&gt;</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+                &lt;vbox id=&quot;configarea&quot;&gt;</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+                  &lt;hbox&gt;</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+                    &lt;hbox flex=&quot;1&quot;&gt;</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+                      &lt;description id=&quot;config_status_title&quot;/&gt;</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+                    &lt;/hbox&gt;</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+                    &lt;hbox pack=&quot;end&quot;&gt;</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+                      &lt;button id=&quot;stop_button&quot;</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+                              oncommand=&quot;gEmailConfigWizard.onStop();&quot;</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+                              label=&quot;&amp;stop.label;&quot; class=&quot;smaller-button&quot;/&gt;</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineplus">+                      &lt;button id=&quot;edit_button&quot;</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineplus">+                              oncommand=&quot;gEmailConfigWizard.onEdit();&quot;</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineplus">+                              label=&quot;&amp;edit.label;&quot; class=&quot;smaller-button&quot;</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+                              hidden=&quot;true&quot;/&gt;</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineplus">+                      &lt;button id=&quot;go_button&quot;</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+                              oncommand=&quot;gEmailConfigWizard.onGo();&quot;</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+                              label=&quot;&amp;go_button.label;&quot; class=&quot;smaller-button&quot;</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineplus">+                              hidden=&quot;true&quot;/&gt;</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineplus">+                    &lt;/hbox&gt;</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineplus">+                  &lt;/hbox&gt;</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineplus">+                  &lt;hbox&gt;</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineplus">+                    &lt;hbox flex=&quot;1&quot;&gt;</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineplus">+                        &lt;description id=&quot;config_status_subtitle&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineplus">+                    &lt;/hbox&gt;</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineplus">+                    &lt;hbox pack=&quot;end&quot;&gt;</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineplus">+                      &lt;vbox class=&quot;statusimage&quot; width=&quot;16&quot;&gt;</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineplus">+                      &lt;image id=&quot;config_spinner&quot;</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineplus">+                             src=&quot;chrome://global/skin/icons/loading_16.png&quot;</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineplus">+                             hidden=&quot;true&quot;/&gt;</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineplus">+                      &lt;/vbox&gt;</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineplus">+                    &lt;/hbox&gt;</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineplus">+                  &lt;/hbox&gt;</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineplus">+                &lt;/vbox&gt;</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineplus">+                &lt;vbox id=&quot;usernamearea&quot;&gt;</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineplus">+                  &lt;label class=&quot;textbox-label&quot; value=&quot;&amp;username.label;&quot;</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineplus">+                          control=&quot;username&quot;/&gt;</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+                  &lt;hbox&gt;</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineplus">+                    &lt;vbox class=&quot;statusimage&quot; width=&quot;22&quot;/&gt;</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineplus">+                      &lt;textbox id=&quot;username&quot;</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineplus">+                               value=&quot;&quot;</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineplus">+                               disabled=&quot;true&quot;</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineplus">+                               class=&quot;username&quot;</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineplus">+                               oninput=&quot;gEmailConfigWizard.setUsername('username')&quot;</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineplus">+                               onblur=&quot;gEmailConfigWizard.setUsername('username');&quot;/&gt;</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineplus">+                  &lt;/hbox&gt;</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineplus">+                &lt;/vbox&gt;</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineplus">+                &lt;vbox id=&quot;incomingarea&quot;&gt;</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineplus">+                  &lt;label class=&quot;textbox-label&quot; value=&quot;&amp;receivingserver.label;&quot;</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineplus">+                          control=&quot;incoming_server&quot;/&gt;</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineplus">+                  &lt;hbox&gt;</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineplus">+                    &lt;vbox id=&quot;incoming_status&quot; class=&quot;icon&quot; width=&quot;22&quot;/&gt;</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineplus">+                    &lt;hbox&gt;</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineplus">+                      &lt;textbox id=&quot;incoming_server&quot;</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineplus">+                               value=&quot;&quot;</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineplus">+                               disabled=&quot;true&quot;</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineplus">+                               class=&quot;host&quot;</span>
<a href="#l5.200"></a><span id="l5.200" class="difflineplus">+                               onblur=&quot;gEmailConfigWizard.setHost('incoming_server')&quot;</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineplus">+                               oninput=&quot;gEmailConfigWizard.stopProbing('incoming_server')&quot;</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineplus">+                               onchange=&quot;gEmailConfigWizard.setHost('incoming_server')&quot;/&gt;</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineplus">+                    &lt;/hbox&gt;</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineplus">+                  &lt;/hbox&gt;</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineplus">+                  &lt;hbox&gt;</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineplus">+                    &lt;spacer height=&quot;30&quot; width=&quot;22&quot;/&gt;</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineplus">+                    &lt;hbox&gt;</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineplus">+                      &lt;menulist id=&quot;incoming_protocol&quot;</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineplus">+                                value=&quot;&quot;</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineplus">+                                disabled=&quot;true&quot;</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineplus">+                                class=&quot;protocol&quot;&gt;</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineplus">+                        &lt;menupopup onpopuphidden=&quot;gEmailConfigWizard.setProtocol('incoming_protocol')&quot;&gt;</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineplus">+                          &lt;menuitem label=&quot;&amp;imap.label;&quot; value=&quot;1&quot;/&gt;</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineplus">+                          &lt;menuitem label=&quot;&amp;pop.label;&quot; value=&quot;2&quot;/&gt;</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineplus">+                        &lt;/menupopup&gt;</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineplus">+                      &lt;/menulist&gt;</span>
<a href="#l5.217"></a><span id="l5.217" class="difflineplus">+                    &lt;/hbox&gt;</span>
<a href="#l5.218"></a><span id="l5.218" class="difflineplus">+                    &lt;hbox&gt;</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineplus">+                      &lt;textbox id=&quot;incoming_port&quot;</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineplus">+                               value=&quot;&quot;</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineplus">+                               disabled=&quot;true&quot;</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineplus">+                               class=&quot;port&quot;/&gt;</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineplus">+                    &lt;/hbox&gt;</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineplus">+                    &lt;hbox&gt;</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineplus">+                      &lt;menulist id=&quot;incoming_security&quot;</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineplus">+                                value=&quot;&quot;</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineplus">+                                disabled=&quot;true&quot;</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineplus">+                                class=&quot;security&quot;&gt;</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineplus">+                        &lt;menupopup onpopuphidden=&quot;gEmailConfigWizard.setSecurity('incoming_security')&quot;&gt;</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineplus">+                          &lt;menuitem label=&quot;&amp;noencryption.label;&quot; value=&quot;1&quot;/&gt;</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineplus">+                          &lt;menuitem label=&quot;&amp;starttls.label;&quot; value=&quot;3&quot;/&gt;</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineplus">+                          &lt;menuitem label=&quot;&amp;ssltls.label;&quot; value=&quot;2&quot;/&gt;</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineplus">+                        &lt;/menupopup&gt;</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineplus">+                      &lt;/menulist&gt;</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineplus">+                    &lt;/hbox&gt;</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineplus">+                  &lt;/hbox&gt;</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineplus">+                &lt;/vbox&gt;</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineplus">+                &lt;vbox id=&quot;outgoingarea&quot;&gt;</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineplus">+                  &lt;label class=&quot;textbox-label&quot; value=&quot;&amp;sendingserver.label;&quot;</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineplus">+                          control=&quot;outgoing_server&quot;/&gt;</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineplus">+                  &lt;hbox&gt;</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineplus">+                    &lt;vbox id=&quot;outgoing_status&quot; class=&quot;icon&quot; width=&quot;22&quot;/&gt;</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineplus">+                    &lt;hbox&gt;</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineplus">+                      &lt;menulist id=&quot;outgoing_server&quot;</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineplus">+                                class=&quot;hostname&quot;</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineplus">+                                disabled=&quot;false&quot;</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineplus">+                                editable=&quot;true&quot; &gt;</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineplus">+                              &lt;!-- oncommand, and onchange and onmousedown of menulist's inputfield, set in ctor --&gt;</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineplus">+                        &lt;menupopup id=&quot;smtp_menupopup&quot;/&gt;</span>
<a href="#l5.250"></a><span id="l5.250" class="difflineplus">+                      &lt;/menulist&gt;</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineplus">+                    &lt;/hbox&gt;</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineplus">+                  &lt;/hbox&gt;</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineplus">+                  &lt;hbox&gt;</span>
<a href="#l5.254"></a><span id="l5.254" class="difflineplus">+                    &lt;spacer height=&quot;30&quot; width=&quot;22&quot;/&gt;</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineplus">+                    &lt;hbox&gt;</span>
<a href="#l5.256"></a><span id="l5.256" class="difflineplus">+                      &lt;label id=&quot;outgoing_protocol&quot;</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineplus">+                             class=&quot;protocol&quot; value=&quot;&amp;smtp.label;&quot;/&gt;</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineplus">+                    &lt;/hbox&gt;</span>
<a href="#l5.259"></a><span id="l5.259" class="difflineplus">+                    &lt;hbox&gt;</span>
<a href="#l5.260"></a><span id="l5.260" class="difflineplus">+                      &lt;textbox id=&quot;outgoing_port&quot;</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineplus">+                               value=&quot;&quot;</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineplus">+                               disabled=&quot;true&quot;</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineplus">+                               class=&quot;port&quot;/&gt;</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineplus">+                    &lt;/hbox&gt;</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineplus">+                    &lt;hbox&gt;</span>
<a href="#l5.266"></a><span id="l5.266" class="difflineplus">+                      &lt;menulist id=&quot;outgoing_security&quot;</span>
<a href="#l5.267"></a><span id="l5.267" class="difflineplus">+                                value=&quot;&quot;</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineplus">+                                disabled=&quot;true&quot;</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineplus">+                                class=&quot;security&quot;&gt;</span>
<a href="#l5.270"></a><span id="l5.270" class="difflineplus">+                        &lt;menupopup onpopuphidden=&quot;gEmailConfigWizard.setSecurity('outgoing_security')&quot;&gt;</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineplus">+                          &lt;menuitem label=&quot;&amp;noencryption.label;&quot; value=&quot;1&quot;/&gt;</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineplus">+                          &lt;menuitem label=&quot;&amp;starttls.label;&quot; value=&quot;3&quot;/&gt;</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineplus">+                          &lt;menuitem label=&quot;&amp;ssltls.label;&quot; value=&quot;2&quot;/&gt;</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineplus">+                        &lt;/menupopup&gt;</span>
<a href="#l5.275"></a><span id="l5.275" class="difflineplus">+                      &lt;/menulist&gt;</span>
<a href="#l5.276"></a><span id="l5.276" class="difflineplus">+                    &lt;/hbox&gt;</span>
<a href="#l5.277"></a><span id="l5.277" class="difflineplus">+                  &lt;/hbox&gt;</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineplus">+                &lt;/vbox&gt;</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineplus">+              &lt;/vbox&gt;</span>
<a href="#l5.280"></a><span id="l5.280" class="difflineplus">+            &lt;/groupbox&gt;</span>
<a href="#l5.281"></a><span id="l5.281" class="difflineplus">+          &lt;/vbox&gt;</span>
<a href="#l5.282"></a><span id="l5.282" class="difflineplus">+        &lt;/row&gt;</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineplus">+      &lt;/rows&gt;</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineplus">+    &lt;/grid&gt;</span>
<a href="#l5.285"></a><span id="l5.285" class="difflineplus">+    &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l5.286"></a><span id="l5.286" class="difflineplus">+    &lt;hbox&gt;</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineplus">+      &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineplus">+        &lt;button id=&quot;cancel_button&quot; label=&quot;&amp;cancel.label;&quot;</span>
<a href="#l5.289"></a><span id="l5.289" class="difflineplus">+                onmousedown=&quot;gEmailConfigWizard.onCancel();&quot;/&gt;</span>
<a href="#l5.290"></a><span id="l5.290" class="difflineplus">+        &lt;label id=&quot;advanced_settings&quot; value=&quot;&amp;gotoadvanced.label;&quot;</span>
<a href="#l5.291"></a><span id="l5.291" class="difflineplus">+               onmousedown=&quot;gEmailConfigWizard.advancedSettings()&quot;</span>
<a href="#l5.292"></a><span id="l5.292" class="difflineplus">+               class=&quot;clickable_label&quot;/&gt;</span>
<a href="#l5.293"></a><span id="l5.293" class="difflineplus">+      &lt;/hbox&gt;</span>
<a href="#l5.294"></a><span id="l5.294" class="difflineplus">+      &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l5.295"></a><span id="l5.295" class="difflineplus">+      &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l5.296"></a><span id="l5.296" class="difflineplus">+        &lt;button id=&quot;create_button&quot; label=&quot;&amp;createaccount.label;&quot;</span>
<a href="#l5.297"></a><span id="l5.297" class="difflineplus">+                onmousedown=&quot;gEmailConfigWizard.onOK();&quot;</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineplus">+                hidden=&quot;true&quot; class=&quot;larger-button&quot;/&gt;</span>
<a href="#l5.299"></a><span id="l5.299" class="difflineplus">+      &lt;/hbox&gt;</span>
<a href="#l5.300"></a><span id="l5.300" class="difflineplus">+    &lt;/hbox&gt;</span>
<a href="#l5.301"></a><span id="l5.301" class="difflineplus">+  &lt;/vbox&gt;</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineplus">+</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineplus">+</span>
<a href="#l5.304"></a><span id="l5.304" class="difflineplus">+  &lt;vbox id=&quot;warningbox&quot; class=&quot;warningbox&quot; hidden=&quot;true&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l5.305"></a><span id="l5.305" class="difflineplus">+    &lt;hbox class=&quot;warning&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineplus">+      &lt;vbox class=&quot;larrybox&quot;&gt;</span>
<a href="#l5.307"></a><span id="l5.307" class="difflineplus">+        &lt;image id=&quot;insecure_larry&quot; class=&quot;insecureLarry&quot;/&gt;</span>
<a href="#l5.308"></a><span id="l5.308" class="difflineplus">+      &lt;/vbox&gt;</span>
<a href="#l5.309"></a><span id="l5.309" class="difflineplus">+      &lt;vbox flex=&quot;1&quot;&gt;</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineplus">+        &lt;vbox class=&quot;warning_text&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineplus">+          &lt;label class=&quot;warning-heading&quot;&gt;&amp;warning.label;&lt;/label&gt;</span>
<a href="#l5.312"></a><span id="l5.312" class="difflineplus">+          &lt;description id=&quot;warning_description&quot;/&gt;</span>
<a href="#l5.313"></a><span id="l5.313" class="difflineplus">+          &lt;vbox id=&quot;incoming_box&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l5.314"></a><span id="l5.314" class="difflineplus">+            &lt;description id=&quot;warning_incoming&quot;/&gt;</span>
<a href="#l5.315"></a><span id="l5.315" class="difflineplus">+            &lt;vbox class=&quot;settings&quot;&gt;</span>
<a href="#l5.316"></a><span id="l5.316" class="difflineplus">+              &lt;hbox&gt;</span>
<a href="#l5.317"></a><span id="l5.317" class="difflineplus">+                &lt;label value=&quot;&amp;incoming_settings.label;&quot;/&gt;&lt;label id=&quot;incoming_settings&quot;/&gt;</span>
<a href="#l5.318"></a><span id="l5.318" class="difflineplus">+              &lt;/hbox&gt;</span>
<a href="#l5.319"></a><span id="l5.319" class="difflineplus">+              &lt;checkbox id=&quot;acknowledge_incoming&quot;</span>
<a href="#l5.320"></a><span id="l5.320" class="difflineplus">+                        class=&quot;acknowledge_checkbox&quot;</span>
<a href="#l5.321"></a><span id="l5.321" class="difflineplus">+                        label=&quot;&amp;incoming_is_checked.label;&quot;</span>
<a href="#l5.322"></a><span id="l5.322" class="difflineplus">+                        oncommand=&quot;gEmailConfigWizard.toggleAcknowledgeIncoming()&quot;/&gt;</span>
<a href="#l5.323"></a><span id="l5.323" class="difflineplus">+            &lt;/vbox&gt;</span>
<a href="#l5.324"></a><span id="l5.324" class="difflineplus">+          &lt;/vbox&gt;</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineplus">+          &lt;vbox id=&quot;outgoing_box&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineplus">+            &lt;description id=&quot;warning_outgoing&quot;/&gt;</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineplus">+            &lt;vbox class=&quot;settings&quot;&gt;</span>
<a href="#l5.328"></a><span id="l5.328" class="difflineplus">+              &lt;hbox&gt;</span>
<a href="#l5.329"></a><span id="l5.329" class="difflineplus">+                &lt;label value=&quot;&amp;outgoing_settings.label;&quot;/&gt;&lt;label id=&quot;outgoing_settings&quot;/&gt;</span>
<a href="#l5.330"></a><span id="l5.330" class="difflineplus">+              &lt;/hbox&gt;</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineplus">+              &lt;checkbox id=&quot;acknowledge_outgoing&quot;</span>
<a href="#l5.332"></a><span id="l5.332" class="difflineplus">+                        class=&quot;acknowledge_checkbox&quot;</span>
<a href="#l5.333"></a><span id="l5.333" class="difflineplus">+                        label=&quot;&amp;outgoing_is_checked.label;&quot;</span>
<a href="#l5.334"></a><span id="l5.334" class="difflineplus">+                        oncommand=&quot;gEmailConfigWizard.toggleAcknowledgeOutgoing()&quot;/&gt;</span>
<a href="#l5.335"></a><span id="l5.335" class="difflineplus">+            &lt;/vbox&gt;</span>
<a href="#l5.336"></a><span id="l5.336" class="difflineplus">+          &lt;/vbox&gt;</span>
<a href="#l5.337"></a><span id="l5.337" class="difflineplus">+          &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l5.338"></a><span id="l5.338" class="difflineplus">+          &lt;description id=&quot;findoutmore&quot;&gt;&amp;lectureYourProvider.description;&lt;/description&gt;</span>
<a href="#l5.339"></a><span id="l5.339" class="difflineplus">+          &lt;hbox class=&quot;highlightedlinkbox&quot;&gt;</span>
<a href="#l5.340"></a><span id="l5.340" class="difflineplus">+            &lt;label class=&quot;text-link&quot; href=&quot;&amp;certinfo.url;&quot; value=&quot;&amp;getcertinfo.label;&quot;/&gt;</span>
<a href="#l5.341"></a><span id="l5.341" class="difflineplus">+          &lt;/hbox&gt;</span>
<a href="#l5.342"></a><span id="l5.342" class="difflineplus">+        &lt;/vbox&gt;</span>
<a href="#l5.343"></a><span id="l5.343" class="difflineplus">+        &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l5.344"></a><span id="l5.344" class="difflineplus">+        &lt;hbox&gt;</span>
<a href="#l5.345"></a><span id="l5.345" class="difflineplus">+          &lt;button id=&quot;getmeoutofhere&quot; label=&quot;&amp;getmeout.label;&quot; oncommand=&quot;gEmailConfigWizard.getMeOutOfHere()&quot;/&gt;</span>
<a href="#l5.346"></a><span id="l5.346" class="difflineplus">+          &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l5.347"></a><span id="l5.347" class="difflineplus">+          &lt;button id=&quot;iknow&quot; label=&quot;&amp;understood.label;&quot; disabled=&quot;true&quot; oncommand=&quot;gEmailConfigWizard.validateAndFinish()&quot;/&gt;</span>
<a href="#l5.348"></a><span id="l5.348" class="difflineplus">+        &lt;/hbox&gt;</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineplus">+      &lt;/vbox&gt;</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineplus">+    &lt;/hbox&gt;</span>
<a href="#l5.351"></a><span id="l5.351" class="difflineplus">+  &lt;/vbox&gt;</span>
<a href="#l5.352"></a><span id="l5.352" class="difflineplus">+</span>
<a href="#l5.353"></a><span id="l5.353" class="difflineplus">+</span>
<a href="#l5.354"></a><span id="l5.354" class="difflineplus">+  &lt;vbox id=&quot;customfields-box&quot; hidden=&quot;true&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l5.355"></a><span id="l5.355" class="difflineplus">+    &lt;description class=&quot;header&quot;&gt;&amp;customfields-header.label;&lt;/description&gt;</span>
<a href="#l5.356"></a><span id="l5.356" class="difflineplus">+    &lt;description class=&quot;intro&quot;&gt;&amp;customfields-intro1.descr;&lt;/description&gt;</span>
<a href="#l5.357"></a><span id="l5.357" class="difflineplus">+    &lt;description class=&quot;intro&quot;&gt;&amp;customfields-intro2.descr;&lt;/description&gt;</span>
<a href="#l5.358"></a><span id="l5.358" class="difflineplus">+    &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l5.359"></a><span id="l5.359" class="difflineplus">+    &lt;grid&gt;</span>
<a href="#l5.360"></a><span id="l5.360" class="difflineplus">+      &lt;columns&gt;</span>
<a href="#l5.361"></a><span id="l5.361" class="difflineplus">+        &lt;column/&gt;</span>
<a href="#l5.362"></a><span id="l5.362" class="difflineplus">+        &lt;column flex=&quot;1&quot;/&gt;</span>
<a href="#l5.363"></a><span id="l5.363" class="difflineplus">+        &lt;column/&gt;</span>
<a href="#l5.364"></a><span id="l5.364" class="difflineplus">+      &lt;/columns&gt;</span>
<a href="#l5.365"></a><span id="l5.365" class="difflineplus">+      &lt;rows id=&quot;customfields-rows&quot;&gt;</span>
<a href="#l5.366"></a><span id="l5.366" class="difflineplus">+        &lt;!-- Generated N times by JS via DOM:</span>
<a href="#l5.367"></a><span id="l5.367" class="difflineplus">+        &lt;row align=&quot;top&quot;&gt;</span>
<a href="#l5.368"></a><span id="l5.368" class="difflineplus">+          &lt;description class=&quot;customfield-label&quot;&gt;Text from config file&lt;/description&gt;</span>
<a href="#l5.369"></a><span id="l5.369" class="difflineplus">+          &lt;textfield id=&quot;customfields-value-FIELDID&quot; class=&quot;customfield-value&quot; value=&quot;Default from config file&quot;/&gt;</span>
<a href="#l5.370"></a><span id="l5.370" class="difflineplus">+          &lt;label class=&quot;customfield-example&quot; value=&quot;Example value from config file&quot;/&gt;</span>
<a href="#l5.371"></a><span id="l5.371" class="difflineplus">+        &lt;/row&gt;</span>
<a href="#l5.372"></a><span id="l5.372" class="difflineplus">+        --&gt;</span>
<a href="#l5.373"></a><span id="l5.373" class="difflineplus">+      &lt;/rows&gt;</span>
<a href="#l5.374"></a><span id="l5.374" class="difflineplus">+    &lt;/grid&gt;</span>
<a href="#l5.375"></a><span id="l5.375" class="difflineplus">+    &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l5.376"></a><span id="l5.376" class="difflineplus">+    &lt;description id=&quot;customfields-error&quot; class=&quot;errordescription&quot;/&gt;</span>
<a href="#l5.377"></a><span id="l5.377" class="difflineplus">+    &lt;spacer/&gt;</span>
<a href="#l5.378"></a><span id="l5.378" class="difflineplus">+    &lt;hbox&gt;</span>
<a href="#l5.379"></a><span id="l5.379" class="difflineplus">+        &lt;button label=&quot;&amp;customfields-cancel.label;&quot; oncommand=&quot;gCustomFieldsDialog.onCancel();&quot;/&gt;</span>
<a href="#l5.380"></a><span id="l5.380" class="difflineplus">+        &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l5.381"></a><span id="l5.381" class="difflineplus">+        &lt;button label=&quot;&amp;customfields-ok.label;&quot; oncommand=&quot;gCustomFieldsDialog.onOK();&quot;/&gt;</span>
<a href="#l5.382"></a><span id="l5.382" class="difflineplus">+    &lt;/hbox&gt;</span>
<a href="#l5.383"></a><span id="l5.383" class="difflineplus">+  &lt;/vbox&gt;</span>
<a href="#l5.384"></a><span id="l5.384" class="difflineplus">+</span>
<a href="#l5.385"></a><span id="l5.385" class="difflineplus">+</span>
<a href="#l5.386"></a><span id="l5.386" class="difflineplus">+  &lt;vbox id=&quot;enableURLs-box&quot; hidden=&quot;true&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l5.387"></a><span id="l5.387" class="difflineplus">+    &lt;description class=&quot;header&quot;&gt;&amp;enableURLs-header.label;&lt;/description&gt;</span>
<a href="#l5.388"></a><span id="l5.388" class="difflineplus">+    &lt;description class=&quot;intro&quot;&gt;&amp;enableURLs-intro1.descr;&lt;/description&gt;</span>
<a href="#l5.389"></a><span id="l5.389" class="difflineplus">+        &lt;description class=&quot;intro&quot;&gt;&amp;enableURLs-intro2.descr;&lt;/description&gt;</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineplus">+    &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineplus">+    &lt;grid&gt;</span>
<a href="#l5.392"></a><span id="l5.392" class="difflineplus">+      &lt;columns&gt;</span>
<a href="#l5.393"></a><span id="l5.393" class="difflineplus">+        &lt;column/&gt;</span>
<a href="#l5.394"></a><span id="l5.394" class="difflineplus">+        &lt;column flex=&quot;1&quot;/&gt;</span>
<a href="#l5.395"></a><span id="l5.395" class="difflineplus">+        &lt;column/&gt;</span>
<a href="#l5.396"></a><span id="l5.396" class="difflineplus">+      &lt;/columns&gt;</span>
<a href="#l5.397"></a><span id="l5.397" class="difflineplus">+      &lt;rows id=&quot;enableURLs-rows&quot;&gt;</span>
<a href="#l5.398"></a><span id="l5.398" class="difflineplus">+        &lt;!-- Generated N times by JS via DOM:</span>
<a href="#l5.399"></a><span id="l5.399" class="difflineplus">+        &lt;row align=&quot;top&quot;&gt;</span>
<a href="#l5.400"></a><span id="l5.400" class="difflineplus">+          &lt;description class=&quot;enableURLs-label&quot;&gt;Text from config file&lt;/description&gt;</span>
<a href="#l5.401"></a><span id="l5.401" class="difflineplus">+          &lt;label href=&quot;url&quot; class=&quot;enableURLs-link text-link&quot; value=&quot;Open&quot; onclick=&quot;me.onLinkClick(...);&quot;/&gt;</span>
<a href="#l5.402"></a><span id="l5.402" class="difflineplus">+          &lt;checkbox class=&quot;enableURLs-checkbox&quot; disabled=&quot;true&quot; checked=&quot;false&quot;/&gt;</span>
<a href="#l5.403"></a><span id="l5.403" class="difflineplus">+        &lt;/row&gt;</span>
<a href="#l5.404"></a><span id="l5.404" class="difflineplus">+        --&gt;</span>
<a href="#l5.405"></a><span id="l5.405" class="difflineplus">+      &lt;/rows&gt;</span>
<a href="#l5.406"></a><span id="l5.406" class="difflineplus">+    &lt;/grid&gt;</span>
<a href="#l5.407"></a><span id="l5.407" class="difflineplus">+    &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l5.408"></a><span id="l5.408" class="difflineplus">+    &lt;description id=&quot;enableURLs-error&quot; class=&quot;errordescription&quot;/&gt;</span>
<a href="#l5.409"></a><span id="l5.409" class="difflineplus">+    &lt;spacer/&gt;</span>
<a href="#l5.410"></a><span id="l5.410" class="difflineplus">+    &lt;hbox&gt;</span>
<a href="#l5.411"></a><span id="l5.411" class="difflineplus">+        &lt;button label=&quot;&amp;enableURLs-cancel.label;&quot; oncommand=&quot;gEnableURLsDialog.onCancel();&quot;/&gt;</span>
<a href="#l5.412"></a><span id="l5.412" class="difflineplus">+        &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l5.413"></a><span id="l5.413" class="difflineplus">+        &lt;button label=&quot;&amp;enableURLs-ok.label;&quot; oncommand=&quot;gEnableURLsDialog.onOK();&quot;/&gt;</span>
<a href="#l5.414"></a><span id="l5.414" class="difflineplus">+    &lt;/hbox&gt;</span>
<a href="#l5.415"></a><span id="l5.415" class="difflineplus">+  &lt;/vbox&gt;</span>
<a href="#l5.416"></a><span id="l5.416" class="difflineplus">+</span>
<a href="#l5.417"></a><span id="l5.417" class="difflineplus">+</span>
<a href="#l5.418"></a><span id="l5.418" class="difflineplus">+&lt;/window&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/mailnews/base/prefs/resources/content/accountcreation/fetchConfig.js</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,106 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+ *</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+ *</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+ * License.</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+ *</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+ *</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+ * Ben Bucksch &lt;mozilla bucksch.org&gt;</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008-2009</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+ *</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+ *</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+ * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+ * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+ *</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+/**</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+ * Tries to find a configuration for this ISP on the local harddisk, in the TB install folder.</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+ * Params @see fetchConfigFromISP()</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+ */</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+function fetchConfigFromDisk(domain, successCallback, errorCallback)</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+{</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+  return new TimeoutAbortable(runAsync(function()</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+  {</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+    try {</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+      // &lt;TB installdir&gt;/isp/example.com.xml</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+      var uri = &quot;resource://gre/isp/&quot; + sanitize.hostname(domain) + &quot;.xml&quot;;</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+      var contents = readURLasUTF8(makeNSIURI(uri));</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+       // Bug 336551 trips over &lt;?xml ... &gt;</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+      contents = contents.replace(/&lt;\?xml[^&gt;]*\?&gt;/, &quot;&quot;);</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+      successCallback(readFromXML(new XML(contents)));</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+    } catch (e) { errorCallback(e); }</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+  }));</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+}</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+/**</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+ * Tries to get a configuration from the ISP / mail provider directly.</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+ *</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+ * @param domain {String}   The domain part of the user's email address</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+ * @param emailAddress {String}   The user's email address</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+ * @param successCallback {Function(config {AccountConfig}})}   A callback that</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+ *         will be called when we could retrieve a configuration.</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+ *         The AccountConfig object will be passed in as first parameter.</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+ * @param errorCallback {Function(ex)}   A callback that</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+ *         will be called when we could not retrieve a configuration,</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+ *         for whatever reason. This is expected (e.g. when there's no config</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+ *         for this domain at this location), so do not unconditionally show this to the user.</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+ *         The first paramter will be an exception object or error string.</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+ */</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+function fetchConfigFromISP(domain, emailAddress, successCallback, errorCallback)</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+{</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+  let url = &quot;https://autoconfig.&quot; + sanitize.hostname(domain) + &quot;/mail/mozilla.xml&quot;;</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+  let fetch = new FetchHTTP(url, { emailaddress: emailAddress }, false,</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+                            function(result)</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+                            {</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+                              successCallback(readFromXML(result));</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+                            },</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+                            errorCallback);</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+  fetch.start();</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+  return fetch;</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+}</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+/**</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+ * Tries to get a configuration for this ISP from a central database at Mozilla servers.</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+ * Params @see fetchConfigFromISP()</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+ */</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+function fetchConfigFromDB(domain, successCallback, errorCallback)</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+{</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+  let pref = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+                               .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+  let url = pref.getCharPref(&quot;mailnews.auto_config_url&quot;) + sanitize.hostname(domain);</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+  if (!url.length)</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+    return errorCallback(&quot;no fetch url set&quot;);</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+  let fetch = new FetchHTTP(url, null, false,</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+                            function(result)</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+                            {</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+                              successCallback(readFromXML(result));</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+                            },</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+                            errorCallback);</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+  fetch.start();</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+  return fetch;</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/mailnews/base/prefs/resources/content/accountcreation/fetchhttp.js</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,282 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+ *</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+ *</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+ * License.</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+ *</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+ *</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+ * Ben Bucksch &lt;mozilla bucksch.org&gt;</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008-2009</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+ *</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+ *</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+ * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+ * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+ *</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+/**</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+ * This is a small wrapper around XMLHttpRequest, which solves various</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+ * inadequacies of the API, e.g. error handling. It is entirely generic and</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+ * can be used for purposes outside of even mail.</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+ *</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+ * It does not provide download progress, but assumes that the</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+ * fetched resource is so small (&lt;1 10 KB) that the roundtrip and</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+ * response generation is far more significant than the</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+ * download time of the response. In other words, it's fine for RPC,</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+ * but not for bigger file downloads.</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+ */</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+/**</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+ * Set up a fetch.</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+ *</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+ * @param url {String}   URL of the server function.</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+ *    ATTENTION: The caller needs to make sure that the URL is secure to call.</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+ * @param urlArgs {Object, associative array} Parameters to add</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+ *   to the end of the URL as query string. E.g.</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+ *   { foo: &quot;bla&quot;, bar: &quot;blub blub&quot; } will add &quot;?foo=bla&amp;bar=blub%20blub&quot;</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+ *   to the URL</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+ *   (unless the URL already has a &quot;?&quot;, then it adds &quot;&amp;foo...&quot;).</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+ *   The values will be urlComponentEncoded, so pass them unencoded.</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+ * @param post {Boolean}   HTTP GET or POST</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+ *   Only influences the HTTP request method,</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+ *   i.e. first line of the HTTP request, not the body or parameters.</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+ *   Use POST when you modify server state,</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+ *   GET when you only request information.</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+ *</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+ * @param successCallback {Function(result {String})}</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+ *   Called when the server call worked (no errors).</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+ *   |result| will contain the body of the HTTP reponse, as string.</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+ * @param errorCallback {Function(ex)}</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+ *   Called in case of error. ex contains the error</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+ *   with a user-displayable but not localized |.message| and maybe a</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+ *   |.code|, which can be either</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+ *  - an nsresult error code,</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+ *  - an HTTP result error code (0...1000) or</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+ *  - negative: 0...-100 :</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+ *     -2 = can't resolve server in DNS etc.</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+ *     -4 = response body (e.g. XML) malformed</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+ */</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+/* not yet supported:</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+ * @param headers {Object, associative array} Like urlArgs,</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+ *   just that the params will be added as HTTP headers.</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+ *   { foo: &quot;blub blub&quot; } will add &quot;Foo: Blub blub&quot;</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+ *   The values will be urlComponentEncoded, apart from space,</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+ *   so pass them unencoded.</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+ * @param headerArgs {Object, associative array} Like urlArgs,</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+ *   just that the params will be added as HTTP headers.</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+ *   { foo: &quot;blub blub&quot; } will add &quot;X-Moz-Arg-Foo: Blub blub&quot;</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+ *   The values will be urlComponentEncoded, apart from space,</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+ *   so pass them unencoded.</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+ * @param bodyArgs {Object, associative array} Like urlArgs,</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+ *   just that the params will be sent x-url-encoded in the body,</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+ *   like a HTML form post.</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+ *   The values will be urlComponentEncoded, so pass them unencoded.</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+ *   This cannot be used together with |uploadBody|.</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+ * @param uploadbody {Object}   Arbitrary object, which to use as</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+ *   body of the HTTP request. Will also set the mimetype accordingly.</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+ *   Only supported object types, currently only E4X is supported</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+ *   (sending XML).</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+ *   Usually, you have nothing to upload, so just pass |null|.</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+ */</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+function FetchHTTP(url, urlArgs, post,</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+                   successCallback, errorCallback)</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+{</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+  assert(typeof(successCallback) == &quot;function&quot;, &quot;BUG: successCallback&quot;);</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+  assert(typeof(errorCallback) == &quot;function&quot;, &quot;BUG: errorCallback&quot;);</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+  this._url = sanitize.string(url);</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+  if ( ! urlArgs)</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+    urlArgs = {};</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+  this._urlArgs = urlArgs;</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+  this._post = sanitize.boolean(post);</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+  this._successCallback = successCallback;</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+  this._errorCallback = errorCallback;</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+}</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+FetchHTTP.prototype =</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+{</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+  _url : null, // URL as passed to ctor, without arguments</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+  _urlArgs : null,</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+  _post : null,</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+  _successCallback : null,</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+  _errorCallback : null,</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+  _request : null, // the XMLHttpRequest object</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+  result : null,</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+  start : function()</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+  {</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+    var url = this._url;</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+    for (var name in this._urlArgs)</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+    {</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+      url += (url.indexOf(&quot;?&quot;) == -1) ? &quot;?&quot; : &quot;&amp;&quot; +</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+              name + &quot;=&quot; + encodeURIComponent(this._urlArgs[name]);</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+    }</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+    this._request = new XMLHttpRequest();</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+    let request = this._request;</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+    request.open(this._post ? &quot;POST&quot; : &quot;GET&quot;, url);</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+    request.channel.loadGroup = null;</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+    // needs bug 407190 patch v4 (or higher) - uncomment if that lands.</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+    // try {</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+    //    var channel = request.channel.QueryInterface(Ci.nsIHttpChannel2);</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+    //    channel.connectTimeout = 5;</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+    //    channel.requestTimeout = 5;</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+    //    } catch (e) { dump(e + &quot;\n&quot;); }</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+    var me = this;</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineplus">+    request.onload = function() { me._response(true); }</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineplus">+    request.onerror = function() { me._response(false); }</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+    request.send(null);</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+  },</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineplus">+  _response : function(success, exStored)</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineplus">+  {</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineplus">+    try {</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+    var errorCode = null;</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+    var errorStr = null;</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+    if (success &amp;&amp; this._request.status &gt;= 200 &amp;&amp;</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+        this._request.status &lt; 300) // HTTP level success</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+    {</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+      try</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+      {</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+        // response</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+        var mimetype = this._request.getResponseHeader(&quot;Content-Type&quot;);</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+        if ( ! mimetype)</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineplus">+          mimetype = &quot;&quot;;</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+        mimetype = mimetype.split(&quot;;&quot;)[0];</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+        if (mimetype == &quot;text/xml&quot; ||</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineplus">+            mimetype == &quot;application/xml&quot; ||</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+            mimetype == &quot;text/rdf&quot;)</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+        {</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineplus">+          // Bug 270553 prevents usage of .responseXML</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+          var text = this._request.responseText;</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineplus">+           // Bug 336551 trips over &lt;?xml ... &gt;</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineplus">+          text = text.replace(/&lt;\?xml[^&gt;]*\?&gt;/, &quot;&quot;);</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineplus">+          this.result = new XML(text);</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineplus">+        }</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineplus">+        else</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineplus">+        {</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineplus">+          //ddump(&quot;mimetype: &quot; + mimetype + &quot; only supported as text&quot;);</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineplus">+          this.result = this._request.responseText;</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineplus">+        }</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineplus">+        //ddump(&quot;result:\n&quot; + this.result);</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineplus">+      }</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineplus">+      catch (e)</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+      {</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineplus">+        success = false;</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineplus">+        var stringBundle = getStringBundle(&quot;chrome://messenger/locale/accountCreationUtil.properties&quot;);</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineplus">+        errorStr = stringBundle.GetStringFromName(&quot;bad_response_content.error&quot;);</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineplus">+        errorCode = -4;</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineplus">+      }</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineplus">+    }</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineplus">+    else</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineplus">+    {</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+      success = false;</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+      try {</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+        errorCode = this._request.status;</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+        errorStr = this._request.statusText;</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+      } catch (e) {</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+        // If we can't resolve the hostname in DNS etc., .statusText throws</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+        errorCode = -2;</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+/*        var stringBundle = document.getElementById(&quot;utilstrings&quot;);</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineplus">+        errorStr = stringBundle.getString(&quot;cannot_contact_server.error&quot;);</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineplus">+        ddump(errorStr);</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineplus">+        errorStr = getStringBundle(&quot;chrome://messenger/locale/accountCreationUtil.properties&quot;)</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+                        .GetStringFromName(&quot;DefaultSaveFileName&quot;);</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineplus">+        ddump(errorStr);*/</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineplus">+        errorStr = getStringBundle(&quot;chrome://messenger/locale/accountCreationUtil.properties&quot;)</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineplus">+                        .GetStringFromName(&quot;cannot_contact_server.error&quot;);</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineplus">+        ddump(errorStr);</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineplus">+      }</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineplus">+    }</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineplus">+</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineplus">+    // Callbacks</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineplus">+    if (success)</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineplus">+      this._successCallback(this.result);</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineplus">+    else if (exStored)</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineplus">+      this._errorCallback(exStored);</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineplus">+    else</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineplus">+      this._errorCallback(new ServerException(errorStr, errorCode, this._url));</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineplus">+</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineplus">+    if (this._finishedCallback)</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineplus">+      this._finishedCallback(this);</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineplus">+</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineplus">+    } catch (e) {</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineplus">+      // error in callback or our fetchhttp._response() code</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineplus">+      try {</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineplus">+        ddump(&quot;Error in errorCallback or _response(): &quot; + e);</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineplus">+        this._errorCallback(e);</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+      } catch (e) {</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineplus">+        //ddump(&quot;Error in errorCallback: &quot; + e);</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineplus">+        alert(e); // error in errorCallback, too!</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineplus">+        throw(e); // to error console</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineplus">+      }</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineplus">+    }</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineplus">+  },</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineplus">+  /**</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineplus">+   * Call this between start() and finishedCallback fired.</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineplus">+   */</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineplus">+  cancel : function(ex)</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineplus">+  {</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineplus">+    assert( ! this.result, &quot;Call already returned&quot;);</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineplus">+</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineplus">+    this._request.abort();</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineplus">+</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineplus">+    // Need to manually call error handler</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineplus">+    // &lt;https://bugzilla.mozilla.org/show_bug.cgi?id=218236#c11&gt;</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineplus">+    this._response(false, ex ? ex : new UserCancelledException());</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineplus">+  },</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineplus">+  /**</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineplus">+   * Allows caller or lib to be notified when the call is done.</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineplus">+   * This is useful to enable and disable a Cancel button in the UI,</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineplus">+   * which allows to cancel the network request.</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineplus">+   */</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineplus">+  setFinishedCallback : function (finishedCallback)</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineplus">+  {</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineplus">+    this._finishedCallback = finishedCallback;</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineplus">+  }</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineplus">+}</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineplus">+extend(FetchHTTP, Abortable);</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineplus">+</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineplus">+function UserCancelledException(msg)</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineplus">+{</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineplus">+  // The user knows they cancelled so I don't see a need</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineplus">+  // for a message to that effect.</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineplus">+  if ( ! msg)</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineplus">+    msg = &quot;&quot;;</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineplus">+  Exception.call(this, msg);</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineplus">+}</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineplus">+UserCancelledException.prototype =</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineplus">+{</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineplus">+}</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineplus">+extend(UserCancelledException, Exception);</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineplus">+</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineplus">+function ServerException(msg, code, uri)</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineplus">+{</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineplus">+  Exception.call(this, msg);</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineplus">+  this.code = code;</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineplus">+  this.uri = uri;</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineplus">+}</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineplus">+ServerException.prototype =</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineplus">+{</span>
<a href="#l7.285"></a><span id="l7.285" class="difflineplus">+}</span>
<a href="#l7.286"></a><span id="l7.286" class="difflineplus">+extend(ServerException, Exception);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/mailnews/base/prefs/resources/content/accountcreation/guessConfig.js</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,877 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+ *</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+ *</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+ * License.</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+ *</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+ * The Original Code is Incoming Mail Auto discovery.</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+ *</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+ * Brian Kirsch.</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008-2009</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+ *</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+ * David Ascher</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+ * Ben Bucksch &lt;mozilla bucksch.org&gt;</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+ *</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+ *</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+var gOverrideService = Components.classes[&quot;@mozilla.org/security/certoverride;1&quot;]</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+                            .getService(Components.interfaces.nsICertOverrideService);</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+Cu.import(&quot;resource://app/modules/gloda/log4moz.js&quot;);</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+// Protocol Types</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+const UNKNOWN = -1;</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+const IMAP = 0;</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+const POP = 1;</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+const SMTP = 2;</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+// Security Types</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+const NONE = 0; // no encryption</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+//1 would be &quot;TLS if available&quot;</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+const TLS = 2; // STARTTLS</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+const SSL = 3; // SSL / TLS</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+const TIMEOUT =  10; // in seconds</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+let IMAP4_CMDS = [&quot;1 CAPABILITY\n&quot;, &quot;2 LOGOUT\n&quot;];</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+let POP3_CMDS  = [&quot;CAPA\n&quot;, &quot;QUIT\n&quot;];</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+let SMTP_CMDS = [&quot;EHLO\n&quot;, &quot;QUIT\n&quot;];</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+// this is a bit ugly - we set outgoingDone to false</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+// when emailWizard.js cancels the outgoing probe because the user picked</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+// an outoing server. It does this by poking the probeAbortable object,</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+// so we need outgoingDone to have global scope.</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+var outgoingDone = false;</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+/**</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+ * Try to guess the config, by:</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+ * - guessing hostnames (pop3.&lt;domain&gt;, pop.&lt;domain&gt;, imap.&lt;domain&gt;,</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+ *                       mail.&lt;domain&gt; etc.)</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+ * - probing known ports (143 for IMAP, 110 for POP3, 573 for SMTP, more for SSL)</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+ * - opening a connection via the right protocol and checking the</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+ *    protocol-specific CAPABILITIES like that the server returns.</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+ *</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+ * Final verification is not done here, but in verifyConfig().</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+ *</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+ * This function is async.</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+ * @param domain {String} the domain part of the email address</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+ * @param progressCallback {function(type, hostname, port, ssl, done)}</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+ *   Called when we try a new hostname/port.</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+ *   type {String-enum} &quot;imap&quot;, &quot;pop3&quot;, &quot;smtp&quot;, like AccountConfig.incoming.type</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+ *   hostname {String}</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+ *   port {Integer}</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+ *   ssl {Integer} 1 = plain, 2 = SSL, 3 = TLS, like</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+ *       AccountConfig.incoming.socketType:</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+ *   done {Boolean}   false, if we start probing this host/port, true if we're</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+ *       done and the host is good.  (there is no notification when a host is</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+ *       bad, we'll just tell about the next host tried)</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+ * @param successCallback function(accountConfig)</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+ *   Called when we could guess the config.</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+ *   param accountConfig {AccountConfig} The guessed account config.</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+ *       username, password, realname, emailaddress etc. are not filled out,</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+ *       but placeholders to be filled out via replaceVariables().</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+ * @param errorCallback function(ex)</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+ *   Called when we could guess not the config, either</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+ *   because we have not found anything or</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+ *   because there was an error (e.g. no network connection).</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+ *   The ex.message will contain a user-presentable message.</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+ * @param incomingErrorCallback function(ex, config)</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+ *   Like errorCallback, just that we do have a config for the</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+ *   outgoing server, just not for the incoming server.</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+ *   This is not terribly useful, because we may have guessed</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+ *   the MX server (SMTP server for incoming mail from other SMTP servers),</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+ *   not the outbound SMTP for users.</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+ *   Showing MX will highly mislead users, so better to treat that as total error.</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+ * @param outgoingErrorCallback function(ex, config)</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+ *   Like errorCallback, just that we do have a config for the</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+ *   incoming server, just not for the outgoing server.</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+ * @param resultConfig: an AutoConfig object which is most likely partially</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+ *   filled in.</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+ * @param which: 'incoming', 'outgoing', or 'both'.</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+ * @result {Abortable}</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+ */</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+function guessConfig(domain, progressCallback, successCallback, errorCallback,</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+                     incomingErrorCallback, outgoingErrorCallback,</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+                     resultConfig, which)</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+{</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+  resultConfig.source = AccountConfig.kSourceGuess;</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+  var outgoingHostDetector = null;</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+  var incomingHostDetector = null;</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+  var incomingEx = null; // if incoming had error, store ex here</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+  var outgoingEx = null; // if incoming had error, store ex here</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+  var incomingDone = false;</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+  if (which == 'incoming')</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+    outgoingDone = true;</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+  if (which == 'outgoing')</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+    incomingDone = true;</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+  var progress = function(type, hostname, port, ssl)</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+  {</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+    progressCallback(protocolToString(type), hostname, port,</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+                     sslConvertToSocketType(ssl), false, resultConfig);</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+  };</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+  var updateConfig = function(config)</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+  {</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+    resultConfig = config;</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+  };</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+  var checkDone = function()</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+  {</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+    if (outgoingEx)</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+      outgoingErrorCallback(outgoingEx, resultConfig);</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+    if (incomingEx)</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+      incomingErrorCallback(incomingEx, resultConfig);</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+    if (incomingEx &amp;&amp; outgoingEx)</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+    {</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineplus">+      errorCallback(incomingEx, resultConfig);</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+      return;</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+    }</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+    if ((incomingDone || incomingEx) &amp;&amp; (outgoingDone || outgoingEx))</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+    {</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineplus">+      successCallback(resultConfig);</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineplus">+      return;</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+    }</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+  };</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+  var outgoingSuccess = function(type, hostname, port, ssl, badCert)</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineplus">+  {</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+    assert(type == SMTP, &quot;I only know SMTP for outgoing&quot;);</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+    resultConfig.outgoing.hostname = hostname;</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+    resultConfig.outgoing.port = port;</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+    // non-auth smtp servers must be rare at this point.</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+    resultConfig.outgoing.auth = 1;</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+    resultConfig.outgoing.socketType = sslConvertToSocketType(ssl);</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+    resultConfig.outgoing.badCert = badCert;</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+    progressCallback(protocolToString(type), hostname, port,</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+                     sslConvertToSocketType(ssl), true, resultConfig);</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+    outgoingDone = true;</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineplus">+    checkDone();</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineplus">+  };</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineplus">+</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineplus">+  var outgoingError = function(ex)</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineplus">+  {</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineplus">+    outgoingEx = ex;</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineplus">+    checkDone();</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineplus">+  };</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineplus">+</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineplus">+  var incomingSuccess = function(type, hostname, port, ssl, secureAuth, badCert,</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineplus">+                                 targetSite)</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineplus">+  {</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineplus">+    dump(&quot;incomingSuccess outgoingDone = &quot; + outgoingDone + &quot;\n&quot;);</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineplus">+    dump(&quot;incoming success username = &quot; + resultConfig.incoming.username + &quot;\n&quot;);</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineplus">+    resultConfig.incoming.hostname = hostname;</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineplus">+    resultConfig.incoming.port = port;</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineplus">+    resultConfig.incoming.type = protocolToString(type);</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineplus">+    resultConfig.incoming.socketType =  sslConvertToSocketType(ssl);</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineplus">+    resultConfig.incoming.badCert = badCert;</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineplus">+    resultConfig.incoming.targetSite = targetSite;</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineplus">+    resultConfig.incoming.auth = secureAuth ? 2 : 1;</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineplus">+</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineplus">+    progressCallback(protocolToString(type), hostname, port,</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineplus">+                     sslConvertToSocketType(ssl), true, resultConfig);</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineplus">+    incomingDone = true;</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineplus">+    checkDone();</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineplus">+  };</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineplus">+</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineplus">+  var incomingError = function(ex)</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineplus">+  {</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineplus">+    incomingEx = ex;</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineplus">+    checkDone();</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineplus">+  };</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineplus">+</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineplus">+  let incomingHostDetector = null;</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineplus">+  let outgoingHostDetector = null;</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineplus">+  incomingHostDetector = new IncomingHostDetector(</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineplus">+    progress, incomingSuccess, incomingError);</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineplus">+  outgoingHostDetector = new OutgoingHostDetector(</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineplus">+      progress, outgoingSuccess, outgoingError);</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineplus">+  if (which == 'incoming' || which == 'both')</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineplus">+  {</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineplus">+    incomingHostDetector.autoDetect(domain,</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineplus">+            resultConfig.incoming.hostname ? true : false,</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineplus">+            resultConfig.incoming.protocol ? resultConfig.incoming.protocol : undefined,</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineplus">+            resultConfig.incoming.port ? resultConfig.incoming.port : undefined);</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineplus">+  }</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineplus">+  if (which == 'outgoing' || which == 'both')</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineplus">+  {</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineplus">+    outgoingHostDetector.autoDetect(domain,</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineplus">+            resultConfig.outgoing.hostname ? true : false,</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineplus">+            resultConfig.outgoing.port ? resultConfig.outgoing.port : undefined);</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineplus">+  }</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineplus">+</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineplus">+  return new GuessAbortable(incomingHostDetector, outgoingHostDetector, updateConfig);</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineplus">+}</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineplus">+</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineplus">+function GuessAbortable(incomingHostDetector, outgoingHostDetector, updateConfig)</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineplus">+{</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineplus">+  this._init(incomingHostDetector, outgoingHostDetector, updateConfig);</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineplus">+}</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineplus">+</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineplus">+GuessAbortable.prototype =</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineplus">+{</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineplus">+  _init : function(incomingHostDetector, outgoingHostDetector, updateConfig)</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineplus">+  {</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineplus">+    this._incomingHostDetector = incomingHostDetector;</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineplus">+    this._outgoingHostDetector = outgoingHostDetector;</span>
<a href="#l8.247"></a><span id="l8.247" class="difflineplus">+    this._updateConfig = updateConfig;</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineplus">+  },</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineplus">+</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineplus">+  cancel : function(which)</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineplus">+  {</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineplus">+    switch (which)</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineplus">+    {</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineplus">+      case 'incoming':</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineplus">+      default:</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineplus">+        if (this._incomingHostDetector)</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineplus">+          this._incomingHostDetector.cancel();</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineplus">+      case 'outgoing':</span>
<a href="#l8.259"></a><span id="l8.259" class="difflineplus">+        if (which != 'incoming')</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineplus">+        {</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineplus">+          if (this._outgoingHostDetector)</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineplus">+            this._outgoingHostDetector.cancel();</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineplus">+          dump(&quot;setting outgoingDone to true\n&quot;);</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineplus">+          outgoingDone = true;</span>
<a href="#l8.265"></a><span id="l8.265" class="difflineplus">+        }</span>
<a href="#l8.266"></a><span id="l8.266" class="difflineplus">+    }</span>
<a href="#l8.267"></a><span id="l8.267" class="difflineplus">+  },</span>
<a href="#l8.268"></a><span id="l8.268" class="difflineplus">+</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineplus">+  restart : function(domain, config, which /* 'incoming' or 'outgoing', default to both */,</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineplus">+                     protocol, port)</span>
<a href="#l8.271"></a><span id="l8.271" class="difflineplus">+  {</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineplus">+    // calling code may have changed config (e.g., user may have changed username)</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineplus">+    //  so put new values in resultConfig.</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineplus">+    this._updateConfig(config);</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineplus">+    switch (which)</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineplus">+    {</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineplus">+      case 'incoming':</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineplus">+        if (this._incomingHostDetector)</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineplus">+        {</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineplus">+          this._incomingHostDetector.cancel();</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineplus">+          this._incomingHostDetector.autoDetect(domain, true,</span>
<a href="#l8.282"></a><span id="l8.282" class="difflineplus">+                                                protocol, port);</span>
<a href="#l8.283"></a><span id="l8.283" class="difflineplus">+        }</span>
<a href="#l8.284"></a><span id="l8.284" class="difflineplus">+        else</span>
<a href="#l8.285"></a><span id="l8.285" class="difflineplus">+        {</span>
<a href="#l8.286"></a><span id="l8.286" class="difflineplus">+          ddump(&quot;no incoming host detector!&quot;); // TODO use assert()</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineplus">+        }</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineplus">+        break;</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineplus">+      case 'outgoing':</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineplus">+          if (this._outgoingHostDetector)</span>
<a href="#l8.291"></a><span id="l8.291" class="difflineplus">+          {</span>
<a href="#l8.292"></a><span id="l8.292" class="difflineplus">+            this._outgoingHostDetector.cancel();</span>
<a href="#l8.293"></a><span id="l8.293" class="difflineplus">+            this._outgoingHostDetector.autoDetect(domain, true, port);</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineplus">+          } else {</span>
<a href="#l8.295"></a><span id="l8.295" class="difflineplus">+            ddump(&quot;no outgoing host detector!&quot;); // TODO use assert()</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineplus">+          }</span>
<a href="#l8.297"></a><span id="l8.297" class="difflineplus">+          break</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineplus">+      default: // both</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineplus">+        if (this._incomingHostDetector)</span>
<a href="#l8.300"></a><span id="l8.300" class="difflineplus">+        {</span>
<a href="#l8.301"></a><span id="l8.301" class="difflineplus">+          this._incomingHostDetector.cancel();</span>
<a href="#l8.302"></a><span id="l8.302" class="difflineplus">+          this._incomingHostDetector.autoDetect(domain, true,</span>
<a href="#l8.303"></a><span id="l8.303" class="difflineplus">+                                                protocol, port);</span>
<a href="#l8.304"></a><span id="l8.304" class="difflineplus">+        }</span>
<a href="#l8.305"></a><span id="l8.305" class="difflineplus">+        if (this._outgoingHostDetector)</span>
<a href="#l8.306"></a><span id="l8.306" class="difflineplus">+        {</span>
<a href="#l8.307"></a><span id="l8.307" class="difflineplus">+          this._outgoingHostDetector.cancel();</span>
<a href="#l8.308"></a><span id="l8.308" class="difflineplus">+          this._outgoingHostDetector.autoDetect(domain, true, port);</span>
<a href="#l8.309"></a><span id="l8.309" class="difflineplus">+        }</span>
<a href="#l8.310"></a><span id="l8.310" class="difflineplus">+    }</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineplus">+  }</span>
<a href="#l8.312"></a><span id="l8.312" class="difflineplus">+}</span>
<a href="#l8.313"></a><span id="l8.313" class="difflineplus">+</span>
<a href="#l8.314"></a><span id="l8.314" class="difflineplus">+extend(GuessAbortable, Abortable);</span>
<a href="#l8.315"></a><span id="l8.315" class="difflineplus">+</span>
<a href="#l8.316"></a><span id="l8.316" class="difflineplus">+function sslConvertToSocketType(ssl)</span>
<a href="#l8.317"></a><span id="l8.317" class="difflineplus">+{</span>
<a href="#l8.318"></a><span id="l8.318" class="difflineplus">+  if (ssl == NONE)</span>
<a href="#l8.319"></a><span id="l8.319" class="difflineplus">+    return 1;</span>
<a href="#l8.320"></a><span id="l8.320" class="difflineplus">+  if (ssl == SSL)</span>
<a href="#l8.321"></a><span id="l8.321" class="difflineplus">+    return 2;</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineplus">+  if (ssl == TLS)</span>
<a href="#l8.323"></a><span id="l8.323" class="difflineplus">+    return 3;</span>
<a href="#l8.324"></a><span id="l8.324" class="difflineplus">+  throw new NotReached(&quot;unexpected SSL type&quot;);</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineplus">+}</span>
<a href="#l8.326"></a><span id="l8.326" class="difflineplus">+</span>
<a href="#l8.327"></a><span id="l8.327" class="difflineplus">+function protocolToString(type)</span>
<a href="#l8.328"></a><span id="l8.328" class="difflineplus">+{</span>
<a href="#l8.329"></a><span id="l8.329" class="difflineplus">+  if (type == IMAP)</span>
<a href="#l8.330"></a><span id="l8.330" class="difflineplus">+    return &quot;imap&quot;;</span>
<a href="#l8.331"></a><span id="l8.331" class="difflineplus">+  if (type == POP)</span>
<a href="#l8.332"></a><span id="l8.332" class="difflineplus">+    return &quot;pop3&quot;;</span>
<a href="#l8.333"></a><span id="l8.333" class="difflineplus">+  if (type == SMTP)</span>
<a href="#l8.334"></a><span id="l8.334" class="difflineplus">+    return &quot;smtp&quot;;</span>
<a href="#l8.335"></a><span id="l8.335" class="difflineplus">+  throw new NotReached(&quot;unexpected protocol&quot;);</span>
<a href="#l8.336"></a><span id="l8.336" class="difflineplus">+}</span>
<a href="#l8.337"></a><span id="l8.337" class="difflineplus">+</span>
<a href="#l8.338"></a><span id="l8.338" class="difflineplus">+/**</span>
<a href="#l8.339"></a><span id="l8.339" class="difflineplus">+ * @param successCallback {function(type, hostname, port, ssl)} Called when the</span>
<a href="#l8.340"></a><span id="l8.340" class="difflineplus">+ * config is OK</span>
<a href="#l8.341"></a><span id="l8.341" class="difflineplus">+ *    type @see constants above</span>
<a href="#l8.342"></a><span id="l8.342" class="difflineplus">+ *    hostname {String}</span>
<a href="#l8.343"></a><span id="l8.343" class="difflineplus">+ *    port {Integer}</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineplus">+ *    ssl @see constants above</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineplus">+ * @param errorCallback {function(ex)} Called when we could not find a config</span>
<a href="#l8.346"></a><span id="l8.346" class="difflineplus">+ * @param progressCallback { function(hostname, port) } Called when we tried</span>
<a href="#l8.347"></a><span id="l8.347" class="difflineplus">+ *    (will try?) a new hostname and port</span>
<a href="#l8.348"></a><span id="l8.348" class="difflineplus">+ */</span>
<a href="#l8.349"></a><span id="l8.349" class="difflineplus">+function HostDetector(progressCallback, successCallback, errorCallback)</span>
<a href="#l8.350"></a><span id="l8.350" class="difflineplus">+{</span>
<a href="#l8.351"></a><span id="l8.351" class="difflineplus">+  this._init(progressCallback, successCallback, errorCallback);</span>
<a href="#l8.352"></a><span id="l8.352" class="difflineplus">+}</span>
<a href="#l8.353"></a><span id="l8.353" class="difflineplus">+HostDetector.prototype =</span>
<a href="#l8.354"></a><span id="l8.354" class="difflineplus">+{</span>
<a href="#l8.355"></a><span id="l8.355" class="difflineplus">+  _loggerName : &quot;hostdetector&quot;,</span>
<a href="#l8.356"></a><span id="l8.356" class="difflineplus">+</span>
<a href="#l8.357"></a><span id="l8.357" class="difflineplus">+  _init : function HostDetector_init(progressCallback, successCallback,</span>
<a href="#l8.358"></a><span id="l8.358" class="difflineplus">+                                     errorCallback)</span>
<a href="#l8.359"></a><span id="l8.359" class="difflineplus">+  {</span>
<a href="#l8.360"></a><span id="l8.360" class="difflineplus">+    this.mSuccessCallback = successCallback;</span>
<a href="#l8.361"></a><span id="l8.361" class="difflineplus">+    this.mProgressCallback = progressCallback;</span>
<a href="#l8.362"></a><span id="l8.362" class="difflineplus">+    this.mErrorCallback = errorCallback;</span>
<a href="#l8.363"></a><span id="l8.363" class="difflineplus">+    this._initLogging();</span>
<a href="#l8.364"></a><span id="l8.364" class="difflineplus">+    this._doneFlag = false;</span>
<a href="#l8.365"></a><span id="l8.365" class="difflineplus">+    this._cancel = false;</span>
<a href="#l8.366"></a><span id="l8.366" class="difflineplus">+    this._caller = null;</span>
<a href="#l8.367"></a><span id="l8.367" class="difflineplus">+    this._result = null;</span>
<a href="#l8.368"></a><span id="l8.368" class="difflineplus">+    this._tryIndex = 0;</span>
<a href="#l8.369"></a><span id="l8.369" class="difflineplus">+    this._hostsToTry = new Array;</span>
<a href="#l8.370"></a><span id="l8.370" class="difflineplus">+    this._gotCertError = false;</span>
<a href="#l8.371"></a><span id="l8.371" class="difflineplus">+  },</span>
<a href="#l8.372"></a><span id="l8.372" class="difflineplus">+</span>
<a href="#l8.373"></a><span id="l8.373" class="difflineplus">+  _initLogging: function ()</span>
<a href="#l8.374"></a><span id="l8.374" class="difflineplus">+  {</span>
<a href="#l8.375"></a><span id="l8.375" class="difflineplus">+    this._log = Log4Moz.getConfiguredLogger(this._loggerName);</span>
<a href="#l8.376"></a><span id="l8.376" class="difflineplus">+    this._log.info(&quot;Initializing &quot; + this._loggerName + ' logger');</span>
<a href="#l8.377"></a><span id="l8.377" class="difflineplus">+  },</span>
<a href="#l8.378"></a><span id="l8.378" class="difflineplus">+</span>
<a href="#l8.379"></a><span id="l8.379" class="difflineplus">+  // TODO we could make all host/port combinations run in parallel, store their</span>
<a href="#l8.380"></a><span id="l8.380" class="difflineplus">+  // results in an array, and as soon as one finishes successfully and all</span>
<a href="#l8.381"></a><span id="l8.381" class="difflineplus">+  // higher-priority ones have failed, abort all lower-priority ones.</span>
<a href="#l8.382"></a><span id="l8.382" class="difflineplus">+</span>
<a href="#l8.383"></a><span id="l8.383" class="difflineplus">+  _tryNextHost : function()</span>
<a href="#l8.384"></a><span id="l8.384" class="difflineplus">+  {</span>
<a href="#l8.385"></a><span id="l8.385" class="difflineplus">+    if (this._cancel)</span>
<a href="#l8.386"></a><span id="l8.386" class="difflineplus">+      return;</span>
<a href="#l8.387"></a><span id="l8.387" class="difflineplus">+</span>
<a href="#l8.388"></a><span id="l8.388" class="difflineplus">+    if (this._hostIndex &gt;= this._hostsToTry.length)</span>
<a href="#l8.389"></a><span id="l8.389" class="difflineplus">+    {</span>
<a href="#l8.390"></a><span id="l8.390" class="difflineplus">+      // ran out of options</span>
<a href="#l8.391"></a><span id="l8.391" class="difflineplus">+      this._log.info(&quot;ran out of hosts&quot;);</span>
<a href="#l8.392"></a><span id="l8.392" class="difflineplus">+      var stringBundle = getStringBundle(&quot;chrome://messenger/locale/accountCreationModel.properties&quot;);</span>
<a href="#l8.393"></a><span id="l8.393" class="difflineplus">+      var errorMsg = stringBundle.GetStringFromName(&quot;cannot_find_server.error&quot;);</span>
<a href="#l8.394"></a><span id="l8.394" class="difflineplus">+      this.mErrorCallback(new Exception(errorMsg));</span>
<a href="#l8.395"></a><span id="l8.395" class="difflineplus">+      return;</span>
<a href="#l8.396"></a><span id="l8.396" class="difflineplus">+    }</span>
<a href="#l8.397"></a><span id="l8.397" class="difflineplus">+    this._host = this._hostsToTry[this._hostIndex++];</span>
<a href="#l8.398"></a><span id="l8.398" class="difflineplus">+    this._log.info(&quot;hostname: &quot; + this._host);</span>
<a href="#l8.399"></a><span id="l8.399" class="difflineplus">+    this._tryHost();</span>
<a href="#l8.400"></a><span id="l8.400" class="difflineplus">+  },</span>
<a href="#l8.401"></a><span id="l8.401" class="difflineplus">+</span>
<a href="#l8.402"></a><span id="l8.402" class="difflineplus">+  keepTrying : function()</span>
<a href="#l8.403"></a><span id="l8.403" class="difflineplus">+  {</span>
<a href="#l8.404"></a><span id="l8.404" class="difflineplus">+    if (this._cancel)</span>
<a href="#l8.405"></a><span id="l8.405" class="difflineplus">+        return;</span>
<a href="#l8.406"></a><span id="l8.406" class="difflineplus">+    this._tryIndex++;</span>
<a href="#l8.407"></a><span id="l8.407" class="difflineplus">+    var curTry = this.tryOrder[this._tryIndex];</span>
<a href="#l8.408"></a><span id="l8.408" class="difflineplus">+</span>
<a href="#l8.409"></a><span id="l8.409" class="difflineplus">+    if (curTry === undefined) {</span>
<a href="#l8.410"></a><span id="l8.410" class="difflineplus">+      // ran out of options</span>
<a href="#l8.411"></a><span id="l8.411" class="difflineplus">+      this._log.info(&quot;ran out of tries&quot;);</span>
<a href="#l8.412"></a><span id="l8.412" class="difflineplus">+      this._tryNextHost();</span>
<a href="#l8.413"></a><span id="l8.413" class="difflineplus">+      return;</span>
<a href="#l8.414"></a><span id="l8.414" class="difflineplus">+    }</span>
<a href="#l8.415"></a><span id="l8.415" class="difflineplus">+</span>
<a href="#l8.416"></a><span id="l8.416" class="difflineplus">+    let curTry = this.tryOrder[this._tryIndex];</span>
<a href="#l8.417"></a><span id="l8.417" class="difflineplus">+    let type = curTry[0];</span>
<a href="#l8.418"></a><span id="l8.418" class="difflineplus">+    let port = curTry[2];</span>
<a href="#l8.419"></a><span id="l8.419" class="difflineplus">+    let ssl = curTry[1];</span>
<a href="#l8.420"></a><span id="l8.420" class="difflineplus">+    this.mProgressCallback(type, this._host, port, ssl);</span>
<a href="#l8.421"></a><span id="l8.421" class="difflineplus">+    this._log.info(&quot;poking at &quot; + this._host + &quot; on port &quot; +</span>
<a href="#l8.422"></a><span id="l8.422" class="difflineplus">+                   curTry[2].toString() + &quot; ssl: &quot;+ curTry[1]);</span>
<a href="#l8.423"></a><span id="l8.423" class="difflineplus">+</span>
<a href="#l8.424"></a><span id="l8.424" class="difflineplus">+    SocketUtil(this._host, curTry[2], curTry[1] == SSL, curTry[3], TIMEOUT,</span>
<a href="#l8.425"></a><span id="l8.425" class="difflineplus">+               this, this.onResult, this._gotCertError);</span>
<a href="#l8.426"></a><span id="l8.426" class="difflineplus">+  },</span>
<a href="#l8.427"></a><span id="l8.427" class="difflineplus">+</span>
<a href="#l8.428"></a><span id="l8.428" class="difflineplus">+  processCertError : function(socketInfo, status, targetSite)</span>
<a href="#l8.429"></a><span id="l8.429" class="difflineplus">+  {</span>
<a href="#l8.430"></a><span id="l8.430" class="difflineplus">+    this._log.warn(&quot;Got Cert error for &quot;+ targetSite);</span>
<a href="#l8.431"></a><span id="l8.431" class="difflineplus">+</span>
<a href="#l8.432"></a><span id="l8.432" class="difflineplus">+    if (!status)</span>
<a href="#l8.433"></a><span id="l8.433" class="difflineplus">+      return true;</span>
<a href="#l8.434"></a><span id="l8.434" class="difflineplus">+</span>
<a href="#l8.435"></a><span id="l8.435" class="difflineplus">+    let cert = status.QueryInterface(Components.interfaces.nsISSLStatus).serverCert;</span>
<a href="#l8.436"></a><span id="l8.436" class="difflineplus">+    let flags = 0;</span>
<a href="#l8.437"></a><span id="l8.437" class="difflineplus">+</span>
<a href="#l8.438"></a><span id="l8.438" class="difflineplus">+    if (status.isUntrusted)</span>
<a href="#l8.439"></a><span id="l8.439" class="difflineplus">+      flags |= gOverrideService.ERROR_UNTRUSTED;</span>
<a href="#l8.440"></a><span id="l8.440" class="difflineplus">+    if (status.isDomainMismatch)</span>
<a href="#l8.441"></a><span id="l8.441" class="difflineplus">+      flags |= gOverrideService.ERROR_MISMATCH;</span>
<a href="#l8.442"></a><span id="l8.442" class="difflineplus">+    if (status.isNotValidAtThisTime)</span>
<a href="#l8.443"></a><span id="l8.443" class="difflineplus">+      flags |= gOverrideService.ERROR_TIME;</span>
<a href="#l8.444"></a><span id="l8.444" class="difflineplus">+</span>
<a href="#l8.445"></a><span id="l8.445" class="difflineplus">+    let parts = targetSite.split(':');</span>
<a href="#l8.446"></a><span id="l8.446" class="difflineplus">+    let host = parts[0];</span>
<a href="#l8.447"></a><span id="l8.447" class="difflineplus">+    let port = parts[1];</span>
<a href="#l8.448"></a><span id="l8.448" class="difflineplus">+</span>
<a href="#l8.449"></a><span id="l8.449" class="difflineplus">+    // if domain mismatch, then we shouldn't accept, and instead try the domain</span>
<a href="#l8.450"></a><span id="l8.450" class="difflineplus">+    // in the cert to the list of tries.</span>
<a href="#l8.451"></a><span id="l8.451" class="difflineplus">+    // Not skipping mismatches for now because it's too common, and until we can</span>
<a href="#l8.452"></a><span id="l8.452" class="difflineplus">+    // poke around the cert and find out what domain to try, best to live</span>
<a href="#l8.453"></a><span id="l8.453" class="difflineplus">+    // w/ orange than red.</span>
<a href="#l8.454"></a><span id="l8.454" class="difflineplus">+</span>
<a href="#l8.455"></a><span id="l8.455" class="difflineplus">+    this._gotCertError = true;</span>
<a href="#l8.456"></a><span id="l8.456" class="difflineplus">+    this._targetSite = targetSite;</span>
<a href="#l8.457"></a><span id="l8.457" class="difflineplus">+    this._certOverrideProcessed = false;</span>
<a href="#l8.458"></a><span id="l8.458" class="difflineplus">+    gOverrideService.rememberValidityOverride(host, port, cert, flags,</span>
<a href="#l8.459"></a><span id="l8.459" class="difflineplus">+        false); // last bit is temporary -- should it be true? XXX</span>
<a href="#l8.460"></a><span id="l8.460" class="difflineplus">+    this._log.warn(&quot;!! Overrode bad cert temporarily &quot; + host + ' ' + port +</span>
<a href="#l8.461"></a><span id="l8.461" class="difflineplus">+                   'flags = ' + flags + '\n');</span>
<a href="#l8.462"></a><span id="l8.462" class="difflineplus">+    return true;</span>
<a href="#l8.463"></a><span id="l8.463" class="difflineplus">+  },</span>
<a href="#l8.464"></a><span id="l8.464" class="difflineplus">+</span>
<a href="#l8.465"></a><span id="l8.465" class="difflineplus">+  processSSLError : function(socketInfo, status, targetSite)</span>
<a href="#l8.466"></a><span id="l8.466" class="difflineplus">+  {</span>
<a href="#l8.467"></a><span id="l8.467" class="difflineplus">+    dump (&quot;got SSL error\n&quot;);</span>
<a href="#l8.468"></a><span id="l8.468" class="difflineplus">+    // XXX record that there was an SSL error, and tell the user</span>
<a href="#l8.469"></a><span id="l8.469" class="difflineplus">+    // about it somehow</span>
<a href="#l8.470"></a><span id="l8.470" class="difflineplus">+    // XXX test case?</span>
<a href="#l8.471"></a><span id="l8.471" class="difflineplus">+    // return true if you want to suppress the default PSM dialog</span>
<a href="#l8.472"></a><span id="l8.472" class="difflineplus">+    return false;</span>
<a href="#l8.473"></a><span id="l8.473" class="difflineplus">+  },</span>
<a href="#l8.474"></a><span id="l8.474" class="difflineplus">+</span>
<a href="#l8.475"></a><span id="l8.475" class="difflineplus">+  onResult : function(wiredata)</span>
<a href="#l8.476"></a><span id="l8.476" class="difflineplus">+  {</span>
<a href="#l8.477"></a><span id="l8.477" class="difflineplus">+    if (this._cancel) // it's been canceled</span>
<a href="#l8.478"></a><span id="l8.478" class="difflineplus">+      return; // just don't use response nor continue</span>
<a href="#l8.479"></a><span id="l8.479" class="difflineplus">+</span>
<a href="#l8.480"></a><span id="l8.480" class="difflineplus">+    if (this._gotCertError)</span>
<a href="#l8.481"></a><span id="l8.481" class="difflineplus">+    {</span>
<a href="#l8.482"></a><span id="l8.482" class="difflineplus">+      this._log.info(&quot;TRYING AGAIN, hopefully w/ exception recorded&quot;);</span>
<a href="#l8.483"></a><span id="l8.483" class="difflineplus">+      this._tryIndex--; // this will just try same host/port, again</span>
<a href="#l8.484"></a><span id="l8.484" class="difflineplus">+      this._selfSignedCert = true; // _next_ run through</span>
<a href="#l8.485"></a><span id="l8.485" class="difflineplus">+      this._gotCertError = false;</span>
<a href="#l8.486"></a><span id="l8.486" class="difflineplus">+    }</span>
<a href="#l8.487"></a><span id="l8.487" class="difflineplus">+</span>
<a href="#l8.488"></a><span id="l8.488" class="difflineplus">+    let curTry = this.tryOrder[this._tryIndex];</span>
<a href="#l8.489"></a><span id="l8.489" class="difflineplus">+    if (curTry === undefined)</span>
<a href="#l8.490"></a><span id="l8.490" class="difflineplus">+    {</span>
<a href="#l8.491"></a><span id="l8.491" class="difflineplus">+      this._log.error(&quot;curTry undefined, _tryIndex is &quot; + this._tryIndex);</span>
<a href="#l8.492"></a><span id="l8.492" class="difflineplus">+      return;</span>
<a href="#l8.493"></a><span id="l8.493" class="difflineplus">+    }</span>
<a href="#l8.494"></a><span id="l8.494" class="difflineplus">+</span>
<a href="#l8.495"></a><span id="l8.495" class="difflineplus">+    if (wiredata == null || wiredata === undefined)</span>
<a href="#l8.496"></a><span id="l8.496" class="difflineplus">+    {</span>
<a href="#l8.497"></a><span id="l8.497" class="difflineplus">+      this._log.info(&quot;no data&quot;);</span>
<a href="#l8.498"></a><span id="l8.498" class="difflineplus">+    }</span>
<a href="#l8.499"></a><span id="l8.499" class="difflineplus">+    else</span>
<a href="#l8.500"></a><span id="l8.500" class="difflineplus">+    {</span>
<a href="#l8.501"></a><span id="l8.501" class="difflineplus">+      if (curTry[1] != TLS || this._matchTLS(curTry, wiredata))</span>
<a href="#l8.502"></a><span id="l8.502" class="difflineplus">+      {</span>
<a href="#l8.503"></a><span id="l8.503" class="difflineplus">+        this._log.info(&quot;non-null data: &quot; + wiredata.toString());</span>
<a href="#l8.504"></a><span id="l8.504" class="difflineplus">+        let type = curTry[0];</span>
<a href="#l8.505"></a><span id="l8.505" class="difflineplus">+        let port = curTry[2];</span>
<a href="#l8.506"></a><span id="l8.506" class="difflineplus">+        let ssl = curTry[1];</span>
<a href="#l8.507"></a><span id="l8.507" class="difflineplus">+        let secureAuth = this._advertisesSecureAuth(type, wiredata);</span>
<a href="#l8.508"></a><span id="l8.508" class="difflineplus">+        if (this._selfSignedCert)</span>
<a href="#l8.509"></a><span id="l8.509" class="difflineplus">+        {</span>
<a href="#l8.510"></a><span id="l8.510" class="difflineplus">+          // the callback will put up the cert exception dialog, so</span>
<a href="#l8.511"></a><span id="l8.511" class="difflineplus">+          // clear the override here.</span>
<a href="#l8.512"></a><span id="l8.512" class="difflineplus">+          this._log.info(&quot;clearing validity override&quot;);</span>
<a href="#l8.513"></a><span id="l8.513" class="difflineplus">+          gOverrideService.clearValidityOverride(this._host, curTry[2]);</span>
<a href="#l8.514"></a><span id="l8.514" class="difflineplus">+        }</span>
<a href="#l8.515"></a><span id="l8.515" class="difflineplus">+        this._log.info(&quot;SUCCESS, _selfSignedCert = &quot; + this._selfSignedCert);</span>
<a href="#l8.516"></a><span id="l8.516" class="difflineplus">+        this.mSuccessCallback(type, this._host, port, ssl, secureAuth,</span>
<a href="#l8.517"></a><span id="l8.517" class="difflineplus">+                              this._selfSignedCert, this._targetSite);</span>
<a href="#l8.518"></a><span id="l8.518" class="difflineplus">+        return; // stop trying, you're done!</span>
<a href="#l8.519"></a><span id="l8.519" class="difflineplus">+      }</span>
<a href="#l8.520"></a><span id="l8.520" class="difflineplus">+    }</span>
<a href="#l8.521"></a><span id="l8.521" class="difflineplus">+</span>
<a href="#l8.522"></a><span id="l8.522" class="difflineplus">+    // report success if you found it.</span>
<a href="#l8.523"></a><span id="l8.523" class="difflineplus">+    this.keepTrying()</span>
<a href="#l8.524"></a><span id="l8.524" class="difflineplus">+  },</span>
<a href="#l8.525"></a><span id="l8.525" class="difflineplus">+</span>
<a href="#l8.526"></a><span id="l8.526" class="difflineplus">+  cancel : function()</span>
<a href="#l8.527"></a><span id="l8.527" class="difflineplus">+  {</span>
<a href="#l8.528"></a><span id="l8.528" class="difflineplus">+    this._cancel = true;</span>
<a href="#l8.529"></a><span id="l8.529" class="difflineplus">+    // XXX this is not enough -- we have to actively stop the network calls, as</span>
<a href="#l8.530"></a><span id="l8.530" class="difflineplus">+    // they may result in callbacks e.g. to the cert handler.  If the dialog is</span>
<a href="#l8.531"></a><span id="l8.531" class="difflineplus">+    // gone by the time this happens, the javascript stack is horked.</span>
<a href="#l8.532"></a><span id="l8.532" class="difflineplus">+  },</span>
<a href="#l8.533"></a><span id="l8.533" class="difflineplus">+</span>
<a href="#l8.534"></a><span id="l8.534" class="difflineplus">+  _advertisesSecureAuth : function(protocol, capaResponse)</span>
<a href="#l8.535"></a><span id="l8.535" class="difflineplus">+  {</span>
<a href="#l8.536"></a><span id="l8.536" class="difflineplus">+    // for imap to support secure auth,</span>
<a href="#l8.537"></a><span id="l8.537" class="difflineplus">+    // capabilities needs to return 1 or more of the following:</span>
<a href="#l8.538"></a><span id="l8.538" class="difflineplus">+    // &quot;AUTH=CRAM-MD5&quot;, &quot;AUTH=NTLM&quot;, &quot;AUTH=GSSAPI&quot;, &quot;AUTH=MSN&quot;</span>
<a href="#l8.539"></a><span id="l8.539" class="difflineplus">+    // for pop3, the auth mechanisms are returned in capa as the following:</span>
<a href="#l8.540"></a><span id="l8.540" class="difflineplus">+    // &quot;CRAM-MD5&quot;, &quot;NTLM&quot;, &quot;MSN&quot;, &quot;GSSAPI&quot;</span>
<a href="#l8.541"></a><span id="l8.541" class="difflineplus">+    // For smtp, EHLO will return AUTH and then a list of the</span>
<a href="#l8.542"></a><span id="l8.542" class="difflineplus">+    // mechanism(s) supported, e.g.,</span>
<a href="#l8.543"></a><span id="l8.543" class="difflineplus">+    // AUTH LOGIN NTLM MSN CRAM-MD5 GSSAPI</span>
<a href="#l8.544"></a><span id="l8.544" class="difflineplus">+    let line = capaResponse.join(&quot;\n&quot;)</span>
<a href="#l8.545"></a><span id="l8.545" class="difflineplus">+    if (protocol == POP)</span>
<a href="#l8.546"></a><span id="l8.546" class="difflineplus">+      return /CRAM-MD5|NTLM|MSN|GSSAPI/.test(line);</span>
<a href="#l8.547"></a><span id="l8.547" class="difflineplus">+    if (protocol == IMAP)</span>
<a href="#l8.548"></a><span id="l8.548" class="difflineplus">+      return /AUTH=(CRAM-MD5|NTLM|MSN|GSSAPI)/.test(line);</span>
<a href="#l8.549"></a><span id="l8.549" class="difflineplus">+    if (protocol == SMTP)</span>
<a href="#l8.550"></a><span id="l8.550" class="difflineplus">+      return /AUTH (CRAM-MD5|NTLM|MSN|GSSAPI)/.test(line);</span>
<a href="#l8.551"></a><span id="l8.551" class="difflineplus">+  },</span>
<a href="#l8.552"></a><span id="l8.552" class="difflineplus">+</span>
<a href="#l8.553"></a><span id="l8.553" class="difflineplus">+  _matchTLS : function(curTry, result)</span>
<a href="#l8.554"></a><span id="l8.554" class="difflineplus">+  {</span>
<a href="#l8.555"></a><span id="l8.555" class="difflineplus">+      return curTry != null &amp;&amp; curTry[1] == TLS &amp;&amp;</span>
<a href="#l8.556"></a><span id="l8.556" class="difflineplus">+               hasTLS(result.join(&quot;\n&quot;), curTry[0]);</span>
<a href="#l8.557"></a><span id="l8.557" class="difflineplus">+  }</span>
<a href="#l8.558"></a><span id="l8.558" class="difflineplus">+}</span>
<a href="#l8.559"></a><span id="l8.559" class="difflineplus">+</span>
<a href="#l8.560"></a><span id="l8.560" class="difflineplus">+function IncomingHostDetector(progressCallback, successCallback, errorCallback)</span>
<a href="#l8.561"></a><span id="l8.561" class="difflineplus">+{</span>
<a href="#l8.562"></a><span id="l8.562" class="difflineplus">+  this._init(progressCallback, successCallback, errorCallback);</span>
<a href="#l8.563"></a><span id="l8.563" class="difflineplus">+}</span>
<a href="#l8.564"></a><span id="l8.564" class="difflineplus">+</span>
<a href="#l8.565"></a><span id="l8.565" class="difflineplus">+IncomingHostDetector.prototype =</span>
<a href="#l8.566"></a><span id="l8.566" class="difflineplus">+{</span>
<a href="#l8.567"></a><span id="l8.567" class="difflineplus">+  __proto__: new HostDetector(),</span>
<a href="#l8.568"></a><span id="l8.568" class="difflineplus">+</span>
<a href="#l8.569"></a><span id="l8.569" class="difflineplus">+  type: 'incoming',</span>
<a href="#l8.570"></a><span id="l8.570" class="difflineplus">+</span>
<a href="#l8.571"></a><span id="l8.571" class="difflineplus">+  _loggerName : &quot;incominghostdetector&quot;,</span>
<a href="#l8.572"></a><span id="l8.572" class="difflineplus">+</span>
<a href="#l8.573"></a><span id="l8.573" class="difflineplus">+  autoDetect : function(host, /* required */</span>
<a href="#l8.574"></a><span id="l8.574" class="difflineplus">+                        hostIsPrecise /* false */,</span>
<a href="#l8.575"></a><span id="l8.575" class="difflineplus">+                        protocol /* UNKNOWN */,</span>
<a href="#l8.576"></a><span id="l8.576" class="difflineplus">+                        port /* UNKNOWN */) {</span>
<a href="#l8.577"></a><span id="l8.577" class="difflineplus">+    if (hostIsPrecise === undefined)</span>
<a href="#l8.578"></a><span id="l8.578" class="difflineplus">+      hostIsPrecise = false;</span>
<a href="#l8.579"></a><span id="l8.579" class="difflineplus">+    if (protocol === undefined)</span>
<a href="#l8.580"></a><span id="l8.580" class="difflineplus">+      protocol = UNKNOWN;</span>
<a href="#l8.581"></a><span id="l8.581" class="difflineplus">+    if (port === undefined)</span>
<a href="#l8.582"></a><span id="l8.582" class="difflineplus">+      port = UNKNOWN;</span>
<a href="#l8.583"></a><span id="l8.583" class="difflineplus">+    this._cancel = false;</span>
<a href="#l8.584"></a><span id="l8.584" class="difflineplus">+</span>
<a href="#l8.585"></a><span id="l8.585" class="difflineplus">+    this._log.info(&quot;doing autoDetectIncoming(&quot;+host+&quot;, &quot;+hostIsPrecise+</span>
<a href="#l8.586"></a><span id="l8.586" class="difflineplus">+                   &quot;, &quot;+protocol+&quot;, &quot;+port+&quot;)&quot;);</span>
<a href="#l8.587"></a><span id="l8.587" class="difflineplus">+    //Strip off any white space</span>
<a href="#l8.588"></a><span id="l8.588" class="difflineplus">+    this.host = host.replace(/\s*/g, &quot;&quot;);</span>
<a href="#l8.589"></a><span id="l8.589" class="difflineplus">+    this._hostsToTry = [];</span>
<a href="#l8.590"></a><span id="l8.590" class="difflineplus">+    this._specifiedProtocol = protocol;</span>
<a href="#l8.591"></a><span id="l8.591" class="difflineplus">+    this._specifiedPort = port;</span>
<a href="#l8.592"></a><span id="l8.592" class="difflineplus">+</span>
<a href="#l8.593"></a><span id="l8.593" class="difflineplus">+    // if hostIsPrecise is true, it's because that's what the user input</span>
<a href="#l8.594"></a><span id="l8.594" class="difflineplus">+    // explicitly, and we'll just try it, nothing else.</span>
<a href="#l8.595"></a><span id="l8.595" class="difflineplus">+</span>
<a href="#l8.596"></a><span id="l8.596" class="difflineplus">+    if (hostIsPrecise !== undefined &amp;&amp; hostIsPrecise == true)</span>
<a href="#l8.597"></a><span id="l8.597" class="difflineplus">+    {</span>
<a href="#l8.598"></a><span id="l8.598" class="difflineplus">+      this._hostsToTry.push(this.host);</span>
<a href="#l8.599"></a><span id="l8.599" class="difflineplus">+    }</span>
<a href="#l8.600"></a><span id="l8.600" class="difflineplus">+    else</span>
<a href="#l8.601"></a><span id="l8.601" class="difflineplus">+    {</span>
<a href="#l8.602"></a><span id="l8.602" class="difflineplus">+      if (this._specifiedProtocol != POP)</span>
<a href="#l8.603"></a><span id="l8.603" class="difflineplus">+        this._hostsToTry.push(&quot;imap.&quot; +  this.host);</span>
<a href="#l8.604"></a><span id="l8.604" class="difflineplus">+      if (this._specifiedProtocol != IMAP)</span>
<a href="#l8.605"></a><span id="l8.605" class="difflineplus">+      {</span>
<a href="#l8.606"></a><span id="l8.606" class="difflineplus">+        this._hostsToTry.push(&quot;pop3.&quot; +  this.host);</span>
<a href="#l8.607"></a><span id="l8.607" class="difflineplus">+        this._hostsToTry.push(&quot;pop.&quot; +  this.host);</span>
<a href="#l8.608"></a><span id="l8.608" class="difflineplus">+      }</span>
<a href="#l8.609"></a><span id="l8.609" class="difflineplus">+      this._hostsToTry.push(&quot;mail.&quot; + this.host);</span>
<a href="#l8.610"></a><span id="l8.610" class="difflineplus">+      this._hostsToTry.push(this.host);</span>
<a href="#l8.611"></a><span id="l8.611" class="difflineplus">+    }</span>
<a href="#l8.612"></a><span id="l8.612" class="difflineplus">+    this._hostIndex = 0;</span>
<a href="#l8.613"></a><span id="l8.613" class="difflineplus">+    this._tryNextHost();</span>
<a href="#l8.614"></a><span id="l8.614" class="difflineplus">+  },</span>
<a href="#l8.615"></a><span id="l8.615" class="difflineplus">+</span>
<a href="#l8.616"></a><span id="l8.616" class="difflineplus">+  _tryHost : function()</span>
<a href="#l8.617"></a><span id="l8.617" class="difflineplus">+  {</span>
<a href="#l8.618"></a><span id="l8.618" class="difflineplus">+    // if the protocol was specified, trust that.</span>
<a href="#l8.619"></a><span id="l8.619" class="difflineplus">+    // same for the port number.</span>
<a href="#l8.620"></a><span id="l8.620" class="difflineplus">+    // otherwise, if the hostname starts with pop try POP3 protocols first</span>
<a href="#l8.621"></a><span id="l8.621" class="difflineplus">+    // otherwise check IMAP4 protocols first.</span>
<a href="#l8.622"></a><span id="l8.622" class="difflineplus">+</span>
<a href="#l8.623"></a><span id="l8.623" class="difflineplus">+    var lowerCaseHost = this._host.toLowerCase();</span>
<a href="#l8.624"></a><span id="l8.624" class="difflineplus">+    if (this._specifiedProtocol == POP ||</span>
<a href="#l8.625"></a><span id="l8.625" class="difflineplus">+        !lowerCaseHost.indexOf(&quot;pop.&quot;) ||</span>
<a href="#l8.626"></a><span id="l8.626" class="difflineplus">+        !lowerCaseHost.indexOf(&quot;pop3.&quot;))</span>
<a href="#l8.627"></a><span id="l8.627" class="difflineplus">+    {</span>
<a href="#l8.628"></a><span id="l8.628" class="difflineplus">+      if (this._specifiedPort == UNKNOWN)</span>
<a href="#l8.629"></a><span id="l8.629" class="difflineplus">+      {</span>
<a href="#l8.630"></a><span id="l8.630" class="difflineplus">+        this.tryOrder = [</span>
<a href="#l8.631"></a><span id="l8.631" class="difflineplus">+              [POP, TLS, 110, POP3_CMDS],</span>
<a href="#l8.632"></a><span id="l8.632" class="difflineplus">+              [POP, SSL, 995, POP3_CMDS],</span>
<a href="#l8.633"></a><span id="l8.633" class="difflineplus">+              [POP, NONE, 110, POP3_CMDS]];</span>
<a href="#l8.634"></a><span id="l8.634" class="difflineplus">+      }</span>
<a href="#l8.635"></a><span id="l8.635" class="difflineplus">+      else</span>
<a href="#l8.636"></a><span id="l8.636" class="difflineplus">+      {</span>
<a href="#l8.637"></a><span id="l8.637" class="difflineplus">+        this.tryOrder = [</span>
<a href="#l8.638"></a><span id="l8.638" class="difflineplus">+              [POP, TLS, this._specifiedPort, POP3_CMDS],</span>
<a href="#l8.639"></a><span id="l8.639" class="difflineplus">+              [POP, SSL, this._specifiedPort, POP3_CMDS],</span>
<a href="#l8.640"></a><span id="l8.640" class="difflineplus">+              [POP, NONE, this._specifiedPort, POP3_CMDS]];</span>
<a href="#l8.641"></a><span id="l8.641" class="difflineplus">+      }</span>
<a href="#l8.642"></a><span id="l8.642" class="difflineplus">+    }</span>
<a href="#l8.643"></a><span id="l8.643" class="difflineplus">+    else if ((this._specifiedProtocol == IMAP) ||</span>
<a href="#l8.644"></a><span id="l8.644" class="difflineplus">+             !lowerCaseHost.indexOf(&quot;imap.&quot;))</span>
<a href="#l8.645"></a><span id="l8.645" class="difflineplus">+    {</span>
<a href="#l8.646"></a><span id="l8.646" class="difflineplus">+      if (this._specifiedPort == UNKNOWN)</span>
<a href="#l8.647"></a><span id="l8.647" class="difflineplus">+      {</span>
<a href="#l8.648"></a><span id="l8.648" class="difflineplus">+        this.tryOrder = [</span>
<a href="#l8.649"></a><span id="l8.649" class="difflineplus">+            [IMAP, TLS, 143, IMAP4_CMDS],</span>
<a href="#l8.650"></a><span id="l8.650" class="difflineplus">+            [IMAP, SSL, 993, IMAP4_CMDS],</span>
<a href="#l8.651"></a><span id="l8.651" class="difflineplus">+            [IMAP, NONE, 143, IMAP4_CMDS]];</span>
<a href="#l8.652"></a><span id="l8.652" class="difflineplus">+      }</span>
<a href="#l8.653"></a><span id="l8.653" class="difflineplus">+      else</span>
<a href="#l8.654"></a><span id="l8.654" class="difflineplus">+      {</span>
<a href="#l8.655"></a><span id="l8.655" class="difflineplus">+        this.tryOrder = [</span>
<a href="#l8.656"></a><span id="l8.656" class="difflineplus">+            [IMAP, TLS, this._specifiedPort, IMAP4_CMDS],</span>
<a href="#l8.657"></a><span id="l8.657" class="difflineplus">+            [IMAP, SSL, this._specifiedPort, IMAP4_CMDS],</span>
<a href="#l8.658"></a><span id="l8.658" class="difflineplus">+            [IMAP, NONE, this._specifiedPort, IMAP4_CMDS]];</span>
<a href="#l8.659"></a><span id="l8.659" class="difflineplus">+      }</span>
<a href="#l8.660"></a><span id="l8.660" class="difflineplus">+    }</span>
<a href="#l8.661"></a><span id="l8.661" class="difflineplus">+    else</span>
<a href="#l8.662"></a><span id="l8.662" class="difflineplus">+    {</span>
<a href="#l8.663"></a><span id="l8.663" class="difflineplus">+      if (this._specifiedPort == UNKNOWN)</span>
<a href="#l8.664"></a><span id="l8.664" class="difflineplus">+      {</span>
<a href="#l8.665"></a><span id="l8.665" class="difflineplus">+        this.tryOrder = [</span>
<a href="#l8.666"></a><span id="l8.666" class="difflineplus">+              [IMAP, TLS, 143, IMAP4_CMDS],</span>
<a href="#l8.667"></a><span id="l8.667" class="difflineplus">+              [IMAP, SSL, 993, IMAP4_CMDS],</span>
<a href="#l8.668"></a><span id="l8.668" class="difflineplus">+              [POP, TLS, 110, POP3_CMDS],</span>
<a href="#l8.669"></a><span id="l8.669" class="difflineplus">+              [POP, SSL, 995, POP3_CMDS],</span>
<a href="#l8.670"></a><span id="l8.670" class="difflineplus">+              [IMAP, NONE, 143, IMAP4_CMDS],</span>
<a href="#l8.671"></a><span id="l8.671" class="difflineplus">+              [POP, NONE, 110, POP3_CMDS]];</span>
<a href="#l8.672"></a><span id="l8.672" class="difflineplus">+      }</span>
<a href="#l8.673"></a><span id="l8.673" class="difflineplus">+      else</span>
<a href="#l8.674"></a><span id="l8.674" class="difflineplus">+      {</span>
<a href="#l8.675"></a><span id="l8.675" class="difflineplus">+        this.tryOrder = [</span>
<a href="#l8.676"></a><span id="l8.676" class="difflineplus">+              [IMAP, TLS, this._specifiedPort, IMAP4_CMDS],</span>
<a href="#l8.677"></a><span id="l8.677" class="difflineplus">+              [IMAP, SSL, this._specifiedPort, IMAP4_CMDS],</span>
<a href="#l8.678"></a><span id="l8.678" class="difflineplus">+              [POP, TLS, this._specifiedPort, POP3_CMDS],</span>
<a href="#l8.679"></a><span id="l8.679" class="difflineplus">+              [POP, SSL, this._specifiedPort, POP3_CMDS],</span>
<a href="#l8.680"></a><span id="l8.680" class="difflineplus">+              [IMAP, NONE, this._specifiedPort, IMAP4_CMDS],</span>
<a href="#l8.681"></a><span id="l8.681" class="difflineplus">+              [POP, NONE, this._specifiedPort, POP3_CMDS]];</span>
<a href="#l8.682"></a><span id="l8.682" class="difflineplus">+      }</span>
<a href="#l8.683"></a><span id="l8.683" class="difflineplus">+    }</span>
<a href="#l8.684"></a><span id="l8.684" class="difflineplus">+    this._tryIndex = -1;</span>
<a href="#l8.685"></a><span id="l8.685" class="difflineplus">+    this.keepTrying();</span>
<a href="#l8.686"></a><span id="l8.686" class="difflineplus">+  }</span>
<a href="#l8.687"></a><span id="l8.687" class="difflineplus">+}</span>
<a href="#l8.688"></a><span id="l8.688" class="difflineplus">+</span>
<a href="#l8.689"></a><span id="l8.689" class="difflineplus">+function OutgoingHostDetector(progressCallback, successCallback, errorCallback)</span>
<a href="#l8.690"></a><span id="l8.690" class="difflineplus">+{</span>
<a href="#l8.691"></a><span id="l8.691" class="difflineplus">+  this._init(progressCallback, successCallback, errorCallback);</span>
<a href="#l8.692"></a><span id="l8.692" class="difflineplus">+}</span>
<a href="#l8.693"></a><span id="l8.693" class="difflineplus">+OutgoingHostDetector.prototype =</span>
<a href="#l8.694"></a><span id="l8.694" class="difflineplus">+{</span>
<a href="#l8.695"></a><span id="l8.695" class="difflineplus">+  __proto__: new HostDetector(),</span>
<a href="#l8.696"></a><span id="l8.696" class="difflineplus">+  type: 'outgoing',</span>
<a href="#l8.697"></a><span id="l8.697" class="difflineplus">+  _loggerName : &quot;outgoinghostdetector&quot;,</span>
<a href="#l8.698"></a><span id="l8.698" class="difflineplus">+</span>
<a href="#l8.699"></a><span id="l8.699" class="difflineplus">+  autoDetect : function(host, /* required */</span>
<a href="#l8.700"></a><span id="l8.700" class="difflineplus">+                        hostIsPrecise /* false */,</span>
<a href="#l8.701"></a><span id="l8.701" class="difflineplus">+                        port /* UNKNOWN */)</span>
<a href="#l8.702"></a><span id="l8.702" class="difflineplus">+  {</span>
<a href="#l8.703"></a><span id="l8.703" class="difflineplus">+    if (hostIsPrecise === undefined)</span>
<a href="#l8.704"></a><span id="l8.704" class="difflineplus">+      hostIsPrecise = false;</span>
<a href="#l8.705"></a><span id="l8.705" class="difflineplus">+    if (port === undefined)</span>
<a href="#l8.706"></a><span id="l8.706" class="difflineplus">+      port = UNKNOWN;</span>
<a href="#l8.707"></a><span id="l8.707" class="difflineplus">+</span>
<a href="#l8.708"></a><span id="l8.708" class="difflineplus">+    this._log.info(&quot;doing autoDetectOutgoing(&quot; + host + &quot;, &quot; + hostIsPrecise +</span>
<a href="#l8.709"></a><span id="l8.709" class="difflineplus">+                   &quot;, &quot; + &quot;port = &quot; + port + &quot;)&quot;);</span>
<a href="#l8.710"></a><span id="l8.710" class="difflineplus">+    //Strip off any white space</span>
<a href="#l8.711"></a><span id="l8.711" class="difflineplus">+    this.host = host.replace(/\s*/g, &quot;&quot;);</span>
<a href="#l8.712"></a><span id="l8.712" class="difflineplus">+    this._hostsToTry = [];</span>
<a href="#l8.713"></a><span id="l8.713" class="difflineplus">+    this._cancel = false;</span>
<a href="#l8.714"></a><span id="l8.714" class="difflineplus">+    this._specifiedPort = port;</span>
<a href="#l8.715"></a><span id="l8.715" class="difflineplus">+    this._hostsToTry = [];</span>
<a href="#l8.716"></a><span id="l8.716" class="difflineplus">+    if (hostIsPrecise)</span>
<a href="#l8.717"></a><span id="l8.717" class="difflineplus">+    {</span>
<a href="#l8.718"></a><span id="l8.718" class="difflineplus">+      this._hostsToTry.push(this.host);</span>
<a href="#l8.719"></a><span id="l8.719" class="difflineplus">+    }</span>
<a href="#l8.720"></a><span id="l8.720" class="difflineplus">+    else</span>
<a href="#l8.721"></a><span id="l8.721" class="difflineplus">+    {</span>
<a href="#l8.722"></a><span id="l8.722" class="difflineplus">+      this._hostsToTry.push(&quot;smtp.&quot; + this.host);</span>
<a href="#l8.723"></a><span id="l8.723" class="difflineplus">+      this._hostsToTry.push(&quot;mail.&quot; +  this.host);</span>
<a href="#l8.724"></a><span id="l8.724" class="difflineplus">+      this._hostsToTry.push(this.host);</span>
<a href="#l8.725"></a><span id="l8.725" class="difflineplus">+    }</span>
<a href="#l8.726"></a><span id="l8.726" class="difflineplus">+    this._hostIndex = 0;</span>
<a href="#l8.727"></a><span id="l8.727" class="difflineplus">+    this._tryNextHost();</span>
<a href="#l8.728"></a><span id="l8.728" class="difflineplus">+  },</span>
<a href="#l8.729"></a><span id="l8.729" class="difflineplus">+</span>
<a href="#l8.730"></a><span id="l8.730" class="difflineplus">+  _tryHost : function()</span>
<a href="#l8.731"></a><span id="l8.731" class="difflineplus">+  {</span>
<a href="#l8.732"></a><span id="l8.732" class="difflineplus">+    if (this._specifiedPort == UNKNOWN)</span>
<a href="#l8.733"></a><span id="l8.733" class="difflineplus">+    {</span>
<a href="#l8.734"></a><span id="l8.734" class="difflineplus">+      this.tryOrder = [</span>
<a href="#l8.735"></a><span id="l8.735" class="difflineplus">+             [SMTP, TLS, 573, SMTP_CMDS],</span>
<a href="#l8.736"></a><span id="l8.736" class="difflineplus">+             [SMTP, SSL, 465, SMTP_CMDS],</span>
<a href="#l8.737"></a><span id="l8.737" class="difflineplus">+             [SMTP, TLS, 25, SMTP_CMDS],</span>
<a href="#l8.738"></a><span id="l8.738" class="difflineplus">+             [SMTP, NONE, 573, SMTP_CMDS],</span>
<a href="#l8.739"></a><span id="l8.739" class="difflineplus">+             [SMTP, NONE, 25, SMTP_CMDS]];</span>
<a href="#l8.740"></a><span id="l8.740" class="difflineplus">+    } else {</span>
<a href="#l8.741"></a><span id="l8.741" class="difflineplus">+      this.tryOrder = [</span>
<a href="#l8.742"></a><span id="l8.742" class="difflineplus">+             [SMTP, TLS, this._specifiedPort, SMTP_CMDS],</span>
<a href="#l8.743"></a><span id="l8.743" class="difflineplus">+             [SMTP, SSL, this._specifiedPort, SMTP_CMDS],</span>
<a href="#l8.744"></a><span id="l8.744" class="difflineplus">+             [SMTP, NONE, this._specifiedPort, SMTP_CMDS]];</span>
<a href="#l8.745"></a><span id="l8.745" class="difflineplus">+    }</span>
<a href="#l8.746"></a><span id="l8.746" class="difflineplus">+    this._tryIndex = -1;</span>
<a href="#l8.747"></a><span id="l8.747" class="difflineplus">+    this.keepTrying();</span>
<a href="#l8.748"></a><span id="l8.748" class="difflineplus">+  }</span>
<a href="#l8.749"></a><span id="l8.749" class="difflineplus">+}</span>
<a href="#l8.750"></a><span id="l8.750" class="difflineplus">+</span>
<a href="#l8.751"></a><span id="l8.751" class="difflineplus">+function hasTLS(line, type)</span>
<a href="#l8.752"></a><span id="l8.752" class="difflineplus">+{</span>
<a href="#l8.753"></a><span id="l8.753" class="difflineplus">+  return line.indexOf(type != POP ? &quot;STARTTLS&quot; : &quot;STLS&quot;) != -1;</span>
<a href="#l8.754"></a><span id="l8.754" class="difflineplus">+}</span>
<a href="#l8.755"></a><span id="l8.755" class="difflineplus">+</span>
<a href="#l8.756"></a><span id="l8.756" class="difflineplus">+function SocketUtil(host, port, useSSL, protocolData, timeout, listener, scope,</span>
<a href="#l8.757"></a><span id="l8.757" class="difflineplus">+                    clearoverride)</span>
<a href="#l8.758"></a><span id="l8.758" class="difflineplus">+{</span>
<a href="#l8.759"></a><span id="l8.759" class="difflineplus">+  //</span>
<a href="#l8.760"></a><span id="l8.760" class="difflineplus">+  // @host: The DNS hostname to connect to.</span>
<a href="#l8.761"></a><span id="l8.761" class="difflineplus">+  // @port: The numberic port to connect to on the host.</span>
<a href="#l8.762"></a><span id="l8.762" class="difflineplus">+  // @useSSL: Boolean flag indicating whether the connection should be</span>
<a href="#l8.763"></a><span id="l8.763" class="difflineplus">+  //          made with a Secure Socket Layer.</span>
<a href="#l8.764"></a><span id="l8.764" class="difflineplus">+  // @protocolData: An Array of protocol specific strings to send to the</span>
<a href="#l8.765"></a><span id="l8.765" class="difflineplus">+  //                server.</span>
<a href="#l8.766"></a><span id="l8.766" class="difflineplus">+  // @timeout: The timeout value in seconds between server responses.</span>
<a href="#l8.767"></a><span id="l8.767" class="difflineplus">+  // @callback: An object implementing an onResult function. This will</span>
<a href="#l8.768"></a><span id="l8.768" class="difflineplus">+  //            be called with the result string array from the server</span>
<a href="#l8.769"></a><span id="l8.769" class="difflineplus">+  //            or null if no communication occurred.</span>
<a href="#l8.770"></a><span id="l8.770" class="difflineplus">+  //            ie. var cb = {</span>
<a href="#l8.771"></a><span id="l8.771" class="difflineplus">+  //                     onResult: function(result) {</span>
<a href="#l8.772"></a><span id="l8.772" class="difflineplus">+  //                              doSomething();</span>
<a href="#l8.773"></a><span id="l8.773" class="difflineplus">+  //                         }</span>
<a href="#l8.774"></a><span id="l8.774" class="difflineplus">+  //                  };</span>
<a href="#l8.775"></a><span id="l8.775" class="difflineplus">+  //</span>
<a href="#l8.776"></a><span id="l8.776" class="difflineplus">+  var fired = false;</span>
<a href="#l8.777"></a><span id="l8.777" class="difflineplus">+</span>
<a href="#l8.778"></a><span id="l8.778" class="difflineplus">+  function callListener(result)</span>
<a href="#l8.779"></a><span id="l8.779" class="difflineplus">+  {</span>
<a href="#l8.780"></a><span id="l8.780" class="difflineplus">+    if (fired)</span>
<a href="#l8.781"></a><span id="l8.781" class="difflineplus">+      return;</span>
<a href="#l8.782"></a><span id="l8.782" class="difflineplus">+</span>
<a href="#l8.783"></a><span id="l8.783" class="difflineplus">+    scope.call(listener, result);</span>
<a href="#l8.784"></a><span id="l8.784" class="difflineplus">+    fired = true;</span>
<a href="#l8.785"></a><span id="l8.785" class="difflineplus">+  }</span>
<a href="#l8.786"></a><span id="l8.786" class="difflineplus">+</span>
<a href="#l8.787"></a><span id="l8.787" class="difflineplus">+  // Very basic error checking.</span>
<a href="#l8.788"></a><span id="l8.788" class="difflineplus">+  if (!protocolData || !protocolData.length)</span>
<a href="#l8.789"></a><span id="l8.789" class="difflineplus">+  {</span>
<a href="#l8.790"></a><span id="l8.790" class="difflineplus">+    callListener(null);</span>
<a href="#l8.791"></a><span id="l8.791" class="difflineplus">+    return;</span>
<a href="#l8.792"></a><span id="l8.792" class="difflineplus">+  }</span>
<a href="#l8.793"></a><span id="l8.793" class="difflineplus">+</span>
<a href="#l8.794"></a><span id="l8.794" class="difflineplus">+  try</span>
<a href="#l8.795"></a><span id="l8.795" class="difflineplus">+  {</span>
<a href="#l8.796"></a><span id="l8.796" class="difflineplus">+    // The current index in the protocolData Array</span>
<a href="#l8.797"></a><span id="l8.797" class="difflineplus">+    var index = 0;</span>
<a href="#l8.798"></a><span id="l8.798" class="difflineplus">+    var initialized = false;</span>
<a href="#l8.799"></a><span id="l8.799" class="difflineplus">+</span>
<a href="#l8.800"></a><span id="l8.800" class="difflineplus">+    function timeoutFunc()</span>
<a href="#l8.801"></a><span id="l8.801" class="difflineplus">+    {</span>
<a href="#l8.802"></a><span id="l8.802" class="difflineplus">+       if (!initialized)</span>
<a href="#l8.803"></a><span id="l8.803" class="difflineplus">+         callListener(null);</span>
<a href="#l8.804"></a><span id="l8.804" class="difflineplus">+    }</span>
<a href="#l8.805"></a><span id="l8.805" class="difflineplus">+</span>
<a href="#l8.806"></a><span id="l8.806" class="difflineplus">+    //In case DNS takes too long or does not resolve or another blocking</span>
<a href="#l8.807"></a><span id="l8.807" class="difflineplus">+    // issue occurs before the timeout can be set on the socket, this</span>
<a href="#l8.808"></a><span id="l8.808" class="difflineplus">+    // ensures that the listener callback will be fired in a timely manner.</span>
<a href="#l8.809"></a><span id="l8.809" class="difflineplus">+    // XXX There might to be some clean up needed after the timeout is fired</span>
<a href="#l8.810"></a><span id="l8.810" class="difflineplus">+    // for socket and io resources.</span>
<a href="#l8.811"></a><span id="l8.811" class="difflineplus">+</span>
<a href="#l8.812"></a><span id="l8.812" class="difflineplus">+     //The timeout value plus 2 seconds</span>
<a href="#l8.813"></a><span id="l8.813" class="difflineplus">+    setTimeout(timeoutFunc, (timeout * 1000) + 2000);</span>
<a href="#l8.814"></a><span id="l8.814" class="difflineplus">+</span>
<a href="#l8.815"></a><span id="l8.815" class="difflineplus">+    var transportService =</span>
<a href="#l8.816"></a><span id="l8.816" class="difflineplus">+         Components.classes[&quot;@mozilla.org/network/socket-transport-service;1&quot;]</span>
<a href="#l8.817"></a><span id="l8.817" class="difflineplus">+               .getService(Components.interfaces.nsISocketTransportService);</span>
<a href="#l8.818"></a><span id="l8.818" class="difflineplus">+</span>
<a href="#l8.819"></a><span id="l8.819" class="difflineplus">+    var transport = transportService.createTransport(useSSL ? ['ssl'] : null,</span>
<a href="#l8.820"></a><span id="l8.820" class="difflineplus">+                             useSSL ? 1 : 0, host, port, null);</span>
<a href="#l8.821"></a><span id="l8.821" class="difflineplus">+</span>
<a href="#l8.822"></a><span id="l8.822" class="difflineplus">+    transport.setTimeout(Ci.nsISocketTransport.TIMEOUT_CONNECT, timeout);</span>
<a href="#l8.823"></a><span id="l8.823" class="difflineplus">+    transport.setTimeout(Ci.nsISocketTransport.TIMEOUT_READ_WRITE, timeout);</span>
<a href="#l8.824"></a><span id="l8.824" class="difflineplus">+    try {</span>
<a href="#l8.825"></a><span id="l8.825" class="difflineplus">+      transport.securityCallbacks = new BadCertHandler(listener);</span>
<a href="#l8.826"></a><span id="l8.826" class="difflineplus">+    } catch (e) {</span>
<a href="#l8.827"></a><span id="l8.827" class="difflineplus">+      alert(e);</span>
<a href="#l8.828"></a><span id="l8.828" class="difflineplus">+    }</span>
<a href="#l8.829"></a><span id="l8.829" class="difflineplus">+    var outstream = transport.openOutputStream(0,0,0);</span>
<a href="#l8.830"></a><span id="l8.830" class="difflineplus">+    var stream = transport.openInputStream(0,0,0);</span>
<a href="#l8.831"></a><span id="l8.831" class="difflineplus">+    var instream = Components.classes[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l8.832"></a><span id="l8.832" class="difflineplus">+              .createInstance(Components.interfaces.nsIScriptableInputStream);</span>
<a href="#l8.833"></a><span id="l8.833" class="difflineplus">+    instream.init(stream);</span>
<a href="#l8.834"></a><span id="l8.834" class="difflineplus">+</span>
<a href="#l8.835"></a><span id="l8.835" class="difflineplus">+    var dataListener =</span>
<a href="#l8.836"></a><span id="l8.836" class="difflineplus">+    {</span>
<a href="#l8.837"></a><span id="l8.837" class="difflineplus">+      data : new Array(),</span>
<a href="#l8.838"></a><span id="l8.838" class="difflineplus">+      onStartRequest: function(request, context)</span>
<a href="#l8.839"></a><span id="l8.839" class="difflineplus">+      {</span>
<a href="#l8.840"></a><span id="l8.840" class="difflineplus">+        initialized = true;</span>
<a href="#l8.841"></a><span id="l8.841" class="difflineplus">+        if (!fired)</span>
<a href="#l8.842"></a><span id="l8.842" class="difflineplus">+        {</span>
<a href="#l8.843"></a><span id="l8.843" class="difflineplus">+          //Send the first request</span>
<a href="#l8.844"></a><span id="l8.844" class="difflineplus">+          let outputData = protocolData[index++];</span>
<a href="#l8.845"></a><span id="l8.845" class="difflineplus">+          outstream.write(outputData, outputData.length);</span>
<a href="#l8.846"></a><span id="l8.846" class="difflineplus">+        }</span>
<a href="#l8.847"></a><span id="l8.847" class="difflineplus">+      },</span>
<a href="#l8.848"></a><span id="l8.848" class="difflineplus">+      onStopRequest: function(request, context, status)</span>
<a href="#l8.849"></a><span id="l8.849" class="difflineplus">+      {</span>
<a href="#l8.850"></a><span id="l8.850" class="difflineplus">+        instream.close();</span>
<a href="#l8.851"></a><span id="l8.851" class="difflineplus">+        outstream.close();</span>
<a href="#l8.852"></a><span id="l8.852" class="difflineplus">+        callListener(this.data.length ? this.data : null);</span>
<a href="#l8.853"></a><span id="l8.853" class="difflineplus">+      },</span>
<a href="#l8.854"></a><span id="l8.854" class="difflineplus">+      onDataAvailable: function(request, context, inputStream, offset, count)</span>
<a href="#l8.855"></a><span id="l8.855" class="difflineplus">+      {</span>
<a href="#l8.856"></a><span id="l8.856" class="difflineplus">+        if (!fired)</span>
<a href="#l8.857"></a><span id="l8.857" class="difflineplus">+        {</span>
<a href="#l8.858"></a><span id="l8.858" class="difflineplus">+          let inputData = instream.read(count);</span>
<a href="#l8.859"></a><span id="l8.859" class="difflineplus">+          this.data.push(inputData);</span>
<a href="#l8.860"></a><span id="l8.860" class="difflineplus">+          if (index &lt; protocolData.length)</span>
<a href="#l8.861"></a><span id="l8.861" class="difflineplus">+          {</span>
<a href="#l8.862"></a><span id="l8.862" class="difflineplus">+            //Send the next request to the server.</span>
<a href="#l8.863"></a><span id="l8.863" class="difflineplus">+            let outputData = protocolData[index++];</span>
<a href="#l8.864"></a><span id="l8.864" class="difflineplus">+            outstream.write(outputData, outputData.length);</span>
<a href="#l8.865"></a><span id="l8.865" class="difflineplus">+          }</span>
<a href="#l8.866"></a><span id="l8.866" class="difflineplus">+        }</span>
<a href="#l8.867"></a><span id="l8.867" class="difflineplus">+      }</span>
<a href="#l8.868"></a><span id="l8.868" class="difflineplus">+    };</span>
<a href="#l8.869"></a><span id="l8.869" class="difflineplus">+    var pump = Components.classes[&quot;@mozilla.org/network/input-stream-pump;1&quot;]</span>
<a href="#l8.870"></a><span id="l8.870" class="difflineplus">+             .createInstance(Components.interfaces.nsIInputStreamPump);</span>
<a href="#l8.871"></a><span id="l8.871" class="difflineplus">+</span>
<a href="#l8.872"></a><span id="l8.872" class="difflineplus">+    pump.init(stream, -1, -1, 0, 0, false);</span>
<a href="#l8.873"></a><span id="l8.873" class="difflineplus">+    pump.asyncRead(dataListener, null);</span>
<a href="#l8.874"></a><span id="l8.874" class="difflineplus">+   }</span>
<a href="#l8.875"></a><span id="l8.875" class="difflineplus">+   catch (ex)</span>
<a href="#l8.876"></a><span id="l8.876" class="difflineplus">+   {</span>
<a href="#l8.877"></a><span id="l8.877" class="difflineplus">+    callListener(null);</span>
<a href="#l8.878"></a><span id="l8.878" class="difflineplus">+    dump(ex);</span>
<a href="#l8.879"></a><span id="l8.879" class="difflineplus">+   }</span>
<a href="#l8.880"></a><span id="l8.880" class="difflineplus">+   return null;</span>
<a href="#l8.881"></a><span id="l8.881" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/mailnews/base/prefs/resources/content/accountcreation/readFromXML.js</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,136 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+ *</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+ *</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+ * License.</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+ *</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+ *</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+ * Ben Bucksch &lt;ben.bucksch beonex.com&gt;</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008-2009</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+ *</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+ *</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+ * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+ * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+ *</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+/**</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+ * Takes an XML snipplet (as E4X) and reads the values into</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+ * a new AccountConfig object.</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+ * It does so securely (or tries to), by trying to avoid remote execution</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+ * and similar holes which can appear when reading too naively.</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+ * Of course it cannot tell whether the actual values are correct,</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+ * e.g. it can't tell whether the host name is a good server.</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+ *</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+ * The XML format is documented at</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+ * &lt;https://wiki.mozilla.org/Thunderbird:Autoconfiguration:ConfigFileFormat&gt;</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+ *</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+ * @param clientConfigXML {E4X}  The &lt;clientConfig&gt; node.</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+ * @return AccountConfig   object filled with the data from XML</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+ */</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+function readFromXML(clientConfigXML)</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+{</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+  if ( ! &quot;emailProvider&quot; in clientConfigXML)</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+  {</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+    var stringBundle = getStringBundle(&quot;chrome://messenger/locale/accountCreationModel.properties&quot;);</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+    throw stringBundle.GetStringFromName(&quot;no_emailProvider.error&quot;);</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+  }</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+  var xml = clientConfigXML.emailProvider;</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+  var d = new AccountConfig();</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+  d.source = AccountConfig.kSourceXML;</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+  d.id = sanitize.alphanumdash(xml.id);</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+  if (&quot;displayName&quot; in xml)</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+    d.displayName = sanitize.label(xml.displayName);</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+  if (&quot;displayShortName&quot; in xml)</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+    d.displayShortName = sanitize.label(xml.displayShortName);</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+  for each (var domain in xml.domain)</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineplus">+    d.domains.push(sanitize.hostname(domain));</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineplus">+</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineplus">+  // incoming server</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+  var iX = xml.incomingServer; // input (XML)</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+  var iO = d.incoming; // output (object)</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+  iO.type = sanitize.enum(iX.@type, [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]);</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+  iO.hostname = sanitize.hostname(iX.hostname);</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+  iO.port = sanitize.integerRange(iX.port, 1, 65535);</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+  iO.username = sanitize.string(iX.username); // may be a %VARIABLE%</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+  iO.auth = sanitize.translate(iX.authentication, { plain : 1, secure : 2 }); // TODO &quot;secure&quot;</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+  iO.socketType = sanitize.translate(iX.socketType, { plain : 1, SSL: 2, STARTTLS: 3 });</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+  if (iO.type == &quot;pop3&quot; &amp;&amp; &quot;pop3&quot; in iX)</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+  {</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+    if (&quot;leaveMessagesOnServer&quot; in iX.pop3)</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineplus">+      iO.leaveMessagesOnServer = sanitize.boolean(iX.pop3.leaveMessagesOnServer);</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineplus">+    if (&quot;daysToLeaveMessagesOnServer&quot; in iX.pop3)</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+      iO.daysToLeaveMessagesOnServer = iX.pop3.daysToLeaveMessagesOnServer;</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+  }</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineplus">+</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineplus">+  // outgoing server</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineplus">+  var oX = xml.outgoingServer; // input (XML)</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineplus">+  var oO = d.outgoing; // output (object)</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+  if ( ! oX.@type == &quot;smtp&quot;)</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+  {</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+    var stringBundle = getStringBundle(&quot;chrome://messenger/locale/accountCreationModel.properties&quot;);</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineplus">+    throw stringBundle.GetStringFromName(&quot;outgoing_not_smtp.error&quot;);</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineplus">+  }</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineplus">+  oO.hostname = sanitize.hostname(oX.hostname);</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineplus">+  oO.port = sanitize.integerRange(oX.port, 1, 65535);</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineplus">+  if (&quot;username&quot; in oX)</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineplus">+    oO.username = sanitize.string(oX.username);</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineplus">+  oO.socketType = sanitize.translate(oX.socketType, { plain : 1, SSL: 2, STARTTLS: 3 });</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineplus">+  oO.auth = sanitize.translate(oX.authentication,</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineplus">+          { none : 0 /* e.g. IP-address-based */, plain : 1, secure : 2,  // TODO &quot;secure&quot;</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineplus">+            &quot;smtp-after-pop&quot; : 0 /* hope for the best */});</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineplus">+  if (&quot;addThisServer&quot; in oX)</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineplus">+    oO.addThisServer = sanitize.boolean(oX.addThisServer);</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineplus">+  if (&quot;useGlobalPreferredServer&quot; in oX)</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineplus">+    oO.useGlobalPreferredServer = sanitize.boolean(oX.useGlobalPreferredServer);</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineplus">+</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineplus">+  for each (var inputField in xml.inputField)</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineplus">+  {</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineplus">+    if ( ! d.inputFields)</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+      d.inputFields = new Array();</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineplus">+    var fieldset =</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineplus">+    {</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineplus">+      varname : sanitize.alphanumdash(inputField.@key).toUpperCase(),</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineplus">+      displayName : sanitize.label(inputField.@label),</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineplus">+      exampleValue : sanitize.label(inputField.text())</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineplus">+    };</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+    d.inputFields.push(fieldset);</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineplus">+  }</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineplus">+</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineplus">+  for each (var enableURL in xml.enableURL)</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineplus">+  {</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineplus">+    if ( ! d.enableURLs)</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineplus">+      d.enableURLs = new Array();</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineplus">+    var fieldset =</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineplus">+    {</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineplus">+      url : sanitize.url(sanitize.nonemptystring(enableURL.@url)),</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineplus">+      instruction : sanitize.label(sanitize.nonemptystring(enableURL.@instruction))</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineplus">+    };</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineplus">+    d.enableURLs.push(fieldset);</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineplus">+  }</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineplus">+</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineplus">+  return d;</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- /dev/null</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ b/mailnews/base/prefs/resources/content/accountcreation/sanitizeDatatypes.js</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -0,0 +1,185 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+ *</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+ *</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+ * License.</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+ *</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+ *</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+ * Ben Bucksch &lt;ben.bucksch beonex.com&gt;</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008-2009</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+ *</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+ *</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+ * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+ * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+ *</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+/**</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+ * This is a generic input validation lib. Use it when you process</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+ * data from the network.</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+ *</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+ * Just a few functions which verify, for security purposes, that the</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+ * input variables (strings, if nothing else is noted) are of the expected</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+ * type and syntax.</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+ *</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+ * The functions take a string (unless noted otherwise) and return</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+ * the expected datatype in JS types. If the value is not as expected,</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+ * they throw exceptions.</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+ */</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+var sanitize =</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+{</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+integer : function (unchecked)</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+{</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+  if (typeof(unchecked) == &quot;number&quot;)</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+    return unchecked;</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+  var r = parseInt(unchecked);</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+  if (r == NaN)</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+    throw new MalformedException(&quot;no_number.error&quot;, unchecked);</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+  return r;</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+},</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+integerRange : function (unchecked, min, max)</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+{</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+  var int = this.integer(unchecked);</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+  if (int &lt; min)</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+    throw new MalformedException(&quot;number_too_small.error&quot;, unchecked);</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+  if (int &gt; max)</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+    throw new MalformedException(&quot;number_too_large.error&quot;, unchecked);</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+  return int;</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+},</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+boolean : function (unchecked)</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+{</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+  if (typeof(unchecked) == &quot;boolean&quot;)</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+    return unchecked;</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+  if (unchecked == &quot;true&quot;)</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+    return true;</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+  if (unchecked == &quot;false&quot;)</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+    return false;</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+  throw new MalformedException(&quot;boolean.error&quot;, unchecked);</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+},</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+string : function (unchecked)</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+{</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+  return String(unchecked);</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+},</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+nonemptystring : function (unchecked)</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+{</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+  if ( ! unchecked)</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+    throw new MalformedException(&quot;string_empty.error&quot;, unchecked);</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+  return this.string(unchecked);</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+},</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineplus">+/**</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineplus">+ * Allow only letters, numbers, &quot;-&quot; and &quot;_&quot;.</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineplus">+ *</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineplus">+ * Empty strings not allowed (good idea?).</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineplus">+ */</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+alphanumdash : function (unchecked)</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+{</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+  var str = this.nonemptystring(unchecked);</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+  if ( ! /^[a-zA-Z0-9\-\_]*$/.test(str))</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+    throw new MalformedException(&quot;alphanumdash.error&quot;, unchecked);</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+  return str;</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineplus">+},</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineplus">+/**</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+ * DNS hostnames like foo.bar.example.com</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineplus">+ * Allow only letters, numbers, &quot;-&quot; and &quot;.&quot;</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineplus">+ * Empty strings not allowed.</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+ * Currently does not support IDN (international domain names).</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineplus">+ * HACK: &quot;%&quot; is allowed, because we allow placeholders in hostnames in the config file.</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+ */</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+hostname : function (unchecked)</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineplus">+{</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineplus">+  var str = this.nonemptystring(unchecked);</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineplus">+  if ( ! /^[a-zA-Z0-9\-\.%]*$/.test(unchecked))</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineplus">+    throw new MalformedException(&quot;hostname_syntax.error&quot;, unchecked);</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineplus">+  return str;</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineplus">+},</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineplus">+/**</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineplus">+ * A non-chrome URL that's safe to request.</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineplus">+ */</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineplus">+url : function (unchecked)</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineplus">+{</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineplus">+  var str =  this.string(unchecked);</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineplus">+  if (str.substr(0, 4) != &quot;http&quot; &amp;&amp; str.substr(0, 5) != &quot;https&quot;)</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineplus">+    throw new MalformedException(&quot;url_scheme.error&quot;, unchecked);</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineplus">+</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineplus">+  var uri;</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineplus">+  try {</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineplus">+    uri = ioService().newURI(str, null, null);</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineplus">+    uri = uri.QueryInterface(Ci.nsIURL);</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineplus">+  } catch (e) {</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+    throw new MalformedException(&quot;url_parsing.error&quot;, unchecked);</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+  }</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineplus">+  //this.enum(uri.scheme, [&quot;http&quot;, &quot;https&quot;]);</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineplus">+  if (uri.scheme != &quot;http&quot; &amp;&amp; uri.scheme != &quot;https&quot;)</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineplus">+    throw new MalformedException(&quot;url_scheme.error&quot;, unchecked);</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+  return uri.spec;</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+},</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineplus">+</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineplus">+/**</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineplus">+ * A value which should be shown to the user in the UI as label</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineplus">+ */</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineplus">+label : function (unchecked)</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineplus">+{</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineplus">+  return this.string(unchecked);</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineplus">+},</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineplus">+enum : function(unchecked, allowedValues)</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineplus">+{</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineplus">+  for each (var allowedValue in allowedValues)</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineplus">+  {</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineplus">+    if (allowedValue == unchecked)</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineplus">+      return allowedValue;</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineplus">+  }</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineplus">+  throw new MalformedException(&quot;enum_value.error&quot;, unchecked);</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineplus">+},</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineplus">+/**</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineplus">+ * Like enum, allows only certain (string) values as input.</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineplus">+ * But allows the caller to specify another value to return instead of the</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineplus">+ * input value. E.g.,</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineplus">+ * if unchecked == &quot;foo&quot;, return 1, if unchecked == &quot;bar&quot;, return 2,</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineplus">+ *  otherwise throw. This allows to translate string enums into integer enums.</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineplus">+ *</span>
<a href="#l10.166"></a><span id="l10.166" class="difflineplus">+ * @param unchecked {Object} Associative array. property name is the input value,</span>
<a href="#l10.167"></a><span id="l10.167" class="difflineplus">+ *       property value is the output value. E.g. the example above would be:</span>
<a href="#l10.168"></a><span id="l10.168" class="difflineplus">+ *       { foo: 1, bar : 2 } .</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineplus">+ * Use quotes when you need freaky characters: &quot;baz-&quot; : 3.</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineplus">+ */</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineplus">+translate : function(unchecked, mapping)</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineplus">+{</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineplus">+  for (var inputValue in mapping)</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineplus">+  {</span>
<a href="#l10.175"></a><span id="l10.175" class="difflineplus">+    if (inputValue == unchecked)</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineplus">+      return mapping[inputValue];</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineplus">+  }</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineplus">+  throw new MalformedException(&quot;enum_value.error&quot;, unchecked);</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineplus">+}</span>
<a href="#l10.180"></a><span id="l10.180" class="difflineplus">+};</span>
<a href="#l10.181"></a><span id="l10.181" class="difflineplus">+</span>
<a href="#l10.182"></a><span id="l10.182" class="difflineplus">+function MalformedException(msgID, uncheckedBadValue)</span>
<a href="#l10.183"></a><span id="l10.183" class="difflineplus">+{</span>
<a href="#l10.184"></a><span id="l10.184" class="difflineplus">+  var stringBundle = getStringBundle(&quot;chrome://messenger/locale/accountCreationUtil.properties&quot;);</span>
<a href="#l10.185"></a><span id="l10.185" class="difflineplus">+  this._message = stringBundle.GetStringFromName(msgID);</span>
<a href="#l10.186"></a><span id="l10.186" class="difflineplus">+  if (kDebug)</span>
<a href="#l10.187"></a><span id="l10.187" class="difflineplus">+    this._message += &quot; (bad value: &quot; + new String(uncheckedBadValue) + &quot;)&quot;;</span>
<a href="#l10.188"></a><span id="l10.188" class="difflineplus">+}</span>
<a href="#l10.189"></a><span id="l10.189" class="difflineplus">+extend(MalformedException, Exception);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- /dev/null</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ b/mailnews/base/prefs/resources/content/accountcreation/util.js</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -0,0 +1,315 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+ *</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+ *</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+ * License.</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+ *</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+ *</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+ * Ben Bucksch &lt;ben.bucksch  beonex.com&gt;</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008-2009</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+ *</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+ *  David Ascher &lt;dascher@mozillamessaging.com&gt;</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+ *</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+ * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+ * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+ *</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+/**</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+ * Some common, generic functions</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+ */</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+const Cu = Components.utils;</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+/**</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+ * Create a subtype</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+ */</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+function extend(child, supertype)</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+{</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+  child.prototype.__proto__ = supertype.prototype;</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+}</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+function assert(test, errorMsg)</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+{</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+  if ( ! test)</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+    throw new Exception(errorMsg);</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+}</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+/**</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+ * Runs the given function sometime later</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+ *</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+ * Currently implemented using setTimeout(), but</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+ * can later be replaced with an nsITimer impl,</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+ * when code wants to use it in a module.</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+ */</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+function runAsync(func)</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+{</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+  setTimeout(func, 0);</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+}</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+/**</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+ * @param uriStr {String}</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+ * @result {nsIURI}</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+ */</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+function makeNSIURI(uriStr)</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+{</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+  return ioService().newURI(uriStr, null, null);</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+}</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineplus">+</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+/**</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+ * Reads UTF8 data from a URL.</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+ *</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+ * @param uri {nsIURI}   what you want to read</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+ * @return {Array of String}   the contents of the file, one string per line</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+ */</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+function readURLasUTF8(uri)</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+{</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+  assert(uri instanceof Ci.nsIURI, &quot;uri must be an nsIURI&quot;);</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+  try {</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+    var chan = ioService().newChannelFromURI(uri);</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineplus">+    var is = Cc[&quot;@mozilla.org/intl/converter-input-stream;1&quot;]</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineplus">+      .createInstance(Ci.nsIConverterInputStream);</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+    is.init(chan.open(), &quot;UTF-8&quot;, 1024,</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineplus">+            Ci.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER);</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineplus">+</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+    var content = &quot;&quot;;</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+    var strOut = new Object();</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineplus">+    try {</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+      while (is.readString(1024, strOut) != 0)</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineplus">+        content += strOut.value;</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineplus">+    // catch in outer try/catch</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+    } finally {</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineplus">+      is.close();</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineplus">+    }</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+    return content;</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineplus">+  } catch (e) {</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineplus">+  // TODO this has a numeric error message. We need to ship translations</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineplus">+  // into human language.</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineplus">+    throw e;</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineplus">+  }</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineplus">+}</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineplus">+</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineplus">+/**</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineplus">+ * Takes a string (which is typically the content of a file,</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineplus">+ * e.g. the result returned from readURLUTF8() ), and splits</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineplus">+ * it into lines, and returns an array with one string per line</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+ *</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineplus">+ * Linebreaks are not contained in the result,,</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineplus">+ * and all of \r\n, (Windows) \r (Mac) and \n (Unix) counts as linebreak.</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineplus">+ *</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineplus">+ * @param content {String} one long string with the whole file</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineplus">+ * @return {Array of String} one string per line (no linebreaks)</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineplus">+ */</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineplus">+function splitLines(content)</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineplus">+{</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineplus">+  content = content.replace(&quot;\r\n&quot;, &quot;\n&quot;);</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineplus">+  content = content.replace(&quot;\r&quot;, &quot;\n&quot;);</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineplus">+  return content.split(&quot;\n&quot;);</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineplus">+}</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineplus">+</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineplus">+/**</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineplus">+ * @return nsIIOService</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineplus">+ * @throws all errors to caller</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineplus">+ */</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineplus">+function ioService()</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineplus">+{</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineplus">+  if (_gIOServiceCached)</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineplus">+    return _gIOServiceCached;</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineplus">+</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineplus">+  _gIOServiceCached = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineplus">+               .getService(Ci.nsIIOService);</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineplus">+  return _gIOServiceCached;</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineplus">+}</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineplus">+var _gIOServiceCached;</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineplus">+</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineplus">+/**</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineplus">+ * @param bundleURI {String}   chrome URL to properties file</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineplus">+ * @return nsIStringBundle</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineplus">+ */</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineplus">+function getStringBundle(bundleURI)</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineplus">+{</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineplus">+  try {</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineplus">+    return Cc[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineplus">+                   .getService(Ci.nsIStringBundleService)</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineplus">+                   .createBundle(bundleURI);</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineplus">+  } catch (e) {</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineplus">+    throw new Exception(&quot;Failed to get stringbundle URI &lt;&quot; + bundleURI + &quot;&gt;. Error: &quot; + e);</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineplus">+  }</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineplus">+}</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineplus">+</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineplus">+</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineplus">+function Exception(msg)</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineplus">+{</span>
<a href="#l11.173"></a><span id="l11.173" class="difflineplus">+  this._message = msg;</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineplus">+}</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineplus">+Exception.prototype =</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineplus">+{</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineplus">+  get message()</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineplus">+  {</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineplus">+    return this._message;</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineplus">+  },</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineplus">+  toString : function()</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineplus">+  {</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineplus">+    return this._message;</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineplus">+  }</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineplus">+}</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineplus">+</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineplus">+function NotReached(msg)</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineplus">+{</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineplus">+}</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineplus">+extend(NotReached, Exception);</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineplus">+</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineplus">+</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineplus">+/**</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineplus">+ * A handle for an async function which you can cancel.</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineplus">+ * The async function will return an object of this type (a subtype)</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineplus">+ * and you can call cancel() when you feel like killing the function.</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineplus">+ */</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineplus">+function Abortable()</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineplus">+{</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineplus">+}</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineplus">+Abortable.prototype =</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineplus">+{</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineplus">+  cancel : function()</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineplus">+  {</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineplus">+  }</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineplus">+}</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineplus">+</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineplus">+/**</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineplus">+ * Utility implementation, for allowing to abort a setTimeout.</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineplus">+ * Use like: return new TimeoutAbortable(setTimeout(function(){ ... }, 0));</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineplus">+ * @param setTimeoutID {Integer}  Return value of setTimeout()</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineplus">+ */</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineplus">+function TimeoutAbortable(setTimeoutID)</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineplus">+{</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineplus">+  this._id = setTimeoutID;</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineplus">+}</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineplus">+TimeoutAbortable.prototype =</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineplus">+{</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineplus">+  cancel : function()</span>
<a href="#l11.220"></a><span id="l11.220" class="difflineplus">+  {</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineplus">+    clearTimeout(this._id);</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineplus">+  }</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineplus">+}</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineplus">+extend(TimeoutAbortable, Abortable);</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineplus">+</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineplus">+/**</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineplus">+ * Utility implementation, for allowing to abort a setTimeout.</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineplus">+ * Use like: return new TimeoutAbortable(setTimeout(function(){ ... }, 0));</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineplus">+ * @param setIntervalID {Integer}  Return value of setInterval()</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineplus">+ */</span>
<a href="#l11.231"></a><span id="l11.231" class="difflineplus">+function IntervalAbortable(setIntervalID)</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineplus">+{</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineplus">+  this._id = setIntervalID;</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineplus">+}</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineplus">+IntervalAbortable.prototype =</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineplus">+{</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineplus">+  cancel : function()</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineplus">+  {</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineplus">+    clearInterval(this._id);</span>
<a href="#l11.240"></a><span id="l11.240" class="difflineplus">+  }</span>
<a href="#l11.241"></a><span id="l11.241" class="difflineplus">+}</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineplus">+extend(IntervalAbortable, Abortable);</span>
<a href="#l11.243"></a><span id="l11.243" class="difflineplus">+</span>
<a href="#l11.244"></a><span id="l11.244" class="difflineplus">+function deepCopy(org)</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineplus">+{</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineplus">+  if (typeof(org) == &quot;undefined&quot;)</span>
<a href="#l11.247"></a><span id="l11.247" class="difflineplus">+    return undefined;</span>
<a href="#l11.248"></a><span id="l11.248" class="difflineplus">+  if (org == null)</span>
<a href="#l11.249"></a><span id="l11.249" class="difflineplus">+    return null;</span>
<a href="#l11.250"></a><span id="l11.250" class="difflineplus">+  if (typeof(org) == &quot;string&quot;)</span>
<a href="#l11.251"></a><span id="l11.251" class="difflineplus">+    return org;</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineplus">+  if (typeof(org) == &quot;number&quot;)</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineplus">+    return org;</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineplus">+  if (typeof(org) == &quot;boolean&quot;)</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineplus">+    return org == true;</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineplus">+  if (typeof(org) == &quot;function&quot;)</span>
<a href="#l11.257"></a><span id="l11.257" class="difflineplus">+    return org;</span>
<a href="#l11.258"></a><span id="l11.258" class="difflineplus">+  if (typeof(org) != &quot;object&quot;)</span>
<a href="#l11.259"></a><span id="l11.259" class="difflineplus">+    throw &quot;can't copy objects of type &quot; + typeof(org) + &quot; yet&quot;;</span>
<a href="#l11.260"></a><span id="l11.260" class="difflineplus">+</span>
<a href="#l11.261"></a><span id="l11.261" class="difflineplus">+  //TODO still instanceof org != instanceof copy</span>
<a href="#l11.262"></a><span id="l11.262" class="difflineplus">+  //var result = new org.constructor();</span>
<a href="#l11.263"></a><span id="l11.263" class="difflineplus">+  var result = new Object();</span>
<a href="#l11.264"></a><span id="l11.264" class="difflineplus">+  if (typeof(org.length) != &quot;undefined&quot;)</span>
<a href="#l11.265"></a><span id="l11.265" class="difflineplus">+    var result = new Array();</span>
<a href="#l11.266"></a><span id="l11.266" class="difflineplus">+  for (var prop in org)</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineplus">+    result[prop] = deepCopy(org[prop]);</span>
<a href="#l11.268"></a><span id="l11.268" class="difflineplus">+  return result;</span>
<a href="#l11.269"></a><span id="l11.269" class="difflineplus">+}</span>
<a href="#l11.270"></a><span id="l11.270" class="difflineplus">+</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineplus">+</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineplus">+</span>
<a href="#l11.273"></a><span id="l11.273" class="difflineplus">+let kDebug = true;</span>
<a href="#l11.274"></a><span id="l11.274" class="difflineplus">+</span>
<a href="#l11.275"></a><span id="l11.275" class="difflineplus">+</span>
<a href="#l11.276"></a><span id="l11.276" class="difflineplus">+function ddump(text)</span>
<a href="#l11.277"></a><span id="l11.277" class="difflineplus">+{</span>
<a href="#l11.278"></a><span id="l11.278" class="difflineplus">+  if (kDebug)</span>
<a href="#l11.279"></a><span id="l11.279" class="difflineplus">+    dump(text + &quot;\n&quot;);</span>
<a href="#l11.280"></a><span id="l11.280" class="difflineplus">+}</span>
<a href="#l11.281"></a><span id="l11.281" class="difflineplus">+function ddumpObject(obj, name, maxDepth, curDepth)</span>
<a href="#l11.282"></a><span id="l11.282" class="difflineplus">+{</span>
<a href="#l11.283"></a><span id="l11.283" class="difflineplus">+  if (curDepth == undefined)</span>
<a href="#l11.284"></a><span id="l11.284" class="difflineplus">+    curDepth = 0;</span>
<a href="#l11.285"></a><span id="l11.285" class="difflineplus">+  if (maxDepth != undefined &amp;&amp; curDepth &gt; maxDepth)</span>
<a href="#l11.286"></a><span id="l11.286" class="difflineplus">+    return;</span>
<a href="#l11.287"></a><span id="l11.287" class="difflineplus">+</span>
<a href="#l11.288"></a><span id="l11.288" class="difflineplus">+  var i = 0;</span>
<a href="#l11.289"></a><span id="l11.289" class="difflineplus">+  for (prop in obj)</span>
<a href="#l11.290"></a><span id="l11.290" class="difflineplus">+  {</span>
<a href="#l11.291"></a><span id="l11.291" class="difflineplus">+    i++;</span>
<a href="#l11.292"></a><span id="l11.292" class="difflineplus">+    try {</span>
<a href="#l11.293"></a><span id="l11.293" class="difflineplus">+      if (typeof(obj[prop]) == &quot;object&quot;)</span>
<a href="#l11.294"></a><span id="l11.294" class="difflineplus">+      {</span>
<a href="#l11.295"></a><span id="l11.295" class="difflineplus">+        if (obj[prop] &amp;&amp; obj[prop].length != undefined)</span>
<a href="#l11.296"></a><span id="l11.296" class="difflineplus">+          ddump(name + &quot;.&quot; + prop + &quot;=[probably array, length &quot; +</span>
<a href="#l11.297"></a><span id="l11.297" class="difflineplus">+                obj[prop].length + &quot;]&quot;);</span>
<a href="#l11.298"></a><span id="l11.298" class="difflineplus">+        else</span>
<a href="#l11.299"></a><span id="l11.299" class="difflineplus">+          ddump(name + &quot;.&quot; + prop + &quot;=[&quot; + typeof(obj[prop]) + &quot;]&quot;);</span>
<a href="#l11.300"></a><span id="l11.300" class="difflineplus">+        ddumpObject(obj[prop], name + &quot;.&quot; + prop, maxDepth, curDepth+1);</span>
<a href="#l11.301"></a><span id="l11.301" class="difflineplus">+      }</span>
<a href="#l11.302"></a><span id="l11.302" class="difflineplus">+      else if (typeof(obj[prop]) == &quot;function&quot;)</span>
<a href="#l11.303"></a><span id="l11.303" class="difflineplus">+        ddump(name + &quot;.&quot; + prop + &quot;=[function]&quot;);</span>
<a href="#l11.304"></a><span id="l11.304" class="difflineplus">+      else</span>
<a href="#l11.305"></a><span id="l11.305" class="difflineplus">+        ddump(name + &quot;.&quot; + prop + &quot;=&quot; + obj[prop]);</span>
<a href="#l11.306"></a><span id="l11.306" class="difflineplus">+    } catch (e) {</span>
<a href="#l11.307"></a><span id="l11.307" class="difflineplus">+      ddump(name + &quot;.&quot; + prop + &quot;-&gt; Exception(&quot; + e + &quot;)&quot;);</span>
<a href="#l11.308"></a><span id="l11.308" class="difflineplus">+    }</span>
<a href="#l11.309"></a><span id="l11.309" class="difflineplus">+  }</span>
<a href="#l11.310"></a><span id="l11.310" class="difflineplus">+  if ( ! i)</span>
<a href="#l11.311"></a><span id="l11.311" class="difflineplus">+    ddump(name + &quot; is empty&quot;);</span>
<a href="#l11.312"></a><span id="l11.312" class="difflineplus">+}</span>
<a href="#l11.313"></a><span id="l11.313" class="difflineplus">+</span>
<a href="#l11.314"></a><span id="l11.314" class="difflineplus">+function alertPrompt(alertTitle, alertMsg)</span>
<a href="#l11.315"></a><span id="l11.315" class="difflineplus">+{</span>
<a href="#l11.316"></a><span id="l11.316" class="difflineplus">+  Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l11.317"></a><span id="l11.317" class="difflineplus">+                    .getService(Components.interfaces.nsIPromptService)</span>
<a href="#l11.318"></a><span id="l11.318" class="difflineplus">+                    .alert(window, alertTitle, alertMsg);</span>
<a href="#l11.319"></a><span id="l11.319" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/mailnews/base/prefs/resources/content/accountcreation/verifyConfig.js</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,262 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+ *</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+ *</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+ * License.</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+ *</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+ * The Original Code is Incoming Mail Auto discovery.</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+ *</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+ * Brian Kirsch.</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+ *</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+ * David Ascher</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+ * Ben Bucksch &lt;mozilla bucksch.org&gt;</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+ *</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+ *</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+/**</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+ * This checks a given config, by trying a real connection and login,</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+ * with username and password.</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+ *</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+ * @param accountConfig {AccountConfig} The guessed account config.</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+ *    username, password, realname, emailaddress etc. are not filled out,</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+ *    but placeholders to be filled out via replaceVariables().</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+ * @param alter {boolean}</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+ *    Try other usernames and login schemes, until login works.</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+ *    Warning: Modifies |accountConfig|.</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+ *</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+ * This function is async.</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+ * @param successCallback function(accountConfig)</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+ *   Called when we could guess the config.</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+ *   For accountConfig, see below.</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+ * @param errorCallback function(ex)</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+ *   Called when we could guess not the config, either</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+ *   because we have not found anything or</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+ *   because there was an error (e.g. no network connection).</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+ *   The ex.message will contain a user-presentable message.</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+ */</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+function verifyConfig(config, alter, msgWindow, successCallback, errorCallback)</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+{</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+  ddumpObject(config, &quot;config&quot;, 3);</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+  assert(config instanceof AccountConfig, &quot;BUG: Arg 'config' needs to be an AccountConfig object&quot;);</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+  assert(typeof(alter) == &quot;boolean&quot;, &quot;BUG: Bad arg 'alter'&quot;);</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineplus">+  assert(typeof(successCallback) == &quot;function&quot;, &quot;BUG: 'successCallback' is not a function&quot;);</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineplus">+  assert(typeof(errorCallback) == &quot;function&quot;, &quot;BUG: 'errorCallback' is not a function&quot;);</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+  var accountManager =</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+          Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+          .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+  if (accountManager.findRealServer(config.incoming.username,</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+                                    config.incoming.hostname,</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+                                    sanitize.enum(config.incoming.type,</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+                                                  [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]),</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+                                    config.incoming.port))</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+    return errorCallback('Incoming server exists');</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+  // incoming server</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+  var inServer = accountManager.createIncomingServer(</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+      config.incoming.username,</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+      config.incoming.hostname,</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+      sanitize.enum(config.incoming.type, [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]));</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+  inServer.port = config.incoming.port;</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+  inServer.password = config.incoming.password;</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+  if (config.incoming.socketType == 1) // plain</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+      inServer.socketType = Ci.nsIMsgIncomingServer.defaultSocket;</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+  else if (config.incoming.socketType == 2) // SSL</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+      inServer.socketType = Ci.nsIMsgIncomingServer.useSSL;</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+  else if (config.incoming.socketType == 3) // TLS</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+      inServer.socketType = Ci.nsIMsgIncomingServer.alwaysUseTLS;</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+  // auth</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+  if (config.incoming.auth == 2) // &quot;secure&quot; auth</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineplus">+      inServer.useSecAuth = true;</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineplus">+  //&lt;/copied&gt;</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineplus">+  try {</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineplus">+    inServer.password = config.incoming.password;</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineplus">+    verifyLogon(config, inServer, alter, msgWindow, successCallback, errorCallback);</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineplus">+  } catch (e) {</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+    ddump(&quot;ERROR: verify logon shouldn't have failed&quot;);</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineplus">+    errorCallback(e);</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+    throw(e);</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+  }</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+};</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineplus">+</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineplus">+function verifyLogon(config, inServer, alter, msgWindow, successCallback,</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineplus">+                     errorCallback)</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+{</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineplus">+  // hack - save away the old callbacks.</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineplus">+  let saveCallbacks =   msgWindow.notificationCallbacks;</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineplus">+  // set our own callbacks - this works because verifyLogon will</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineplus">+  // synchronously create the transport and use the notification callbacks.</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineplus">+  let listener = new urlListener(config, inServer, alter, msgWindow,</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+                                       successCallback, errorCallback);</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineplus">+  // our listener listens both for the url and cert errors.</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineplus">+  msgWindow.notificationCallbacks = listener;</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineplus">+  // try to work around bug where backend is clearing password.</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineplus">+  inServer.password = config.incoming.password;</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineplus">+  let uri = inServer.verifyLogon(listener, msgWindow);</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineplus">+  // clear msgWindow so url won't prompt for passwords.</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineplus">+  uri.QueryInterface(Ci.nsIMsgMailNewsUrl).msgWindow = null;</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineplus">+  // restore them</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineplus">+  msgWindow.notificationCallbacks = saveCallbacks;</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineplus">+}</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineplus">+</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineplus">+/**</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineplus">+ * The url listener also implements nsIBadCertListener2.  Its job is to prevent &quot;bad cert&quot;</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineplus">+ * security dialogs from being shown to the user.  Currently it puts up the</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineplus">+ * cert override dialog, though we'd like to give the user more detailed</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineplus">+ * information in the future.</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineplus">+ */</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineplus">+</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineplus">+function urlListener(config, server, alter, msgWindow, successCallback, errorCallback)</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineplus">+{</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineplus">+  this.mConfig = config;</span>
<a href="#l12.140"></a><span id="l12.140" class="difflineplus">+  this.mServer = server;</span>
<a href="#l12.141"></a><span id="l12.141" class="difflineplus">+  this.mAlter = alter;</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineplus">+  this.mSuccessCallback = successCallback;</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineplus">+  this.mErrorCallback = errorCallback;</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineplus">+  this.mUsernameSaved = null;</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineplus">+  this.mMsgWindow = msgWindow;</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineplus">+  this.mCertError = false;</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineplus">+}</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineplus">+urlListener.prototype =</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineplus">+{</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineplus">+  OnStartRunningUrl: function(aUrl)</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineplus">+  {</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineplus">+  },</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineplus">+  OnStopRunningUrl: function(aUrl, aExitCode)</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineplus">+  {</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineplus">+    if (! (aExitCode &amp; 0x80000000)) // logon succeeded</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineplus">+    {</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineplus">+      this._cleanup();</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineplus">+      this.mSuccessCallback();</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineplus">+    }</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineplus">+    // logon failed</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineplus">+    else if ( !this.mAlter) // we were asked to not try other variations</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineplus">+    {</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineplus">+      this._cleanup();</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineplus">+      var stringBundle = getStringBundle(&quot;chrome://messenger/locale/accountCreationModel.properties&quot;);</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineplus">+      var errorMsg = stringBundle.GetStringFromName(&quot;cannot_login.error&quot;);</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineplus">+      this.mErrorCallback(new Exception(errorMsg));</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineplus">+    }</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineplus">+    // try other variations, unless there's a cert error, in which</span>
<a href="#l12.170"></a><span id="l12.170" class="difflineplus">+    // case we'll see what the user chooses.</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineplus">+    else if (!this.mCertError)</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineplus">+    {</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineplus">+      dump(&quot;trying next logon\n&quot;);</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineplus">+      this.tryNextLogon()</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineplus">+    }</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineplus">+  },</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineplus">+</span>
<a href="#l12.178"></a><span id="l12.178" class="difflineplus">+  tryNextLogon: function()</span>
<a href="#l12.179"></a><span id="l12.179" class="difflineplus">+  {</span>
<a href="#l12.180"></a><span id="l12.180" class="difflineplus">+    // check if we tried full email address as username</span>
<a href="#l12.181"></a><span id="l12.181" class="difflineplus">+    if (this.mConfig.incoming.username != this.mConfig.identity.emailAddress)</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineplus">+    {</span>
<a href="#l12.183"></a><span id="l12.183" class="difflineplus">+      this.mUsernameSaved = this.mConfig.incoming.username;</span>
<a href="#l12.184"></a><span id="l12.184" class="difflineplus">+      this.mConfig.incoming.username = this.mConfig.identity.emailAddress;</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineplus">+      this.mServer.username = this.mConfig.incoming.username;</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineplus">+      this.mServer.password = this.mConfig.incoming.password;</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineplus">+      verifyLogon(this.mConfig, this.mServer, this.mAlter, this.mMsgWindow,</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineplus">+                  this.mSuccessCallback, this.mErrorCallback);</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineplus">+    }</span>
<a href="#l12.190"></a><span id="l12.190" class="difflineplus">+    // sec auth seems to have failed, and we've tried both</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineplus">+    // varieties of user name, sadly.</span>
<a href="#l12.192"></a><span id="l12.192" class="difflineplus">+    // So fall back to non-secure auth, and</span>
<a href="#l12.193"></a><span id="l12.193" class="difflineplus">+    // again try the user name and email address as username</span>
<a href="#l12.194"></a><span id="l12.194" class="difflineplus">+    else if (this.mServer.useSecAuth)</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineplus">+    {</span>
<a href="#l12.196"></a><span id="l12.196" class="difflineplus">+      this.mServer.useSecAuth = false;</span>
<a href="#l12.197"></a><span id="l12.197" class="difflineplus">+      this.mServer.username = this.mUsernameSaved;</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineplus">+      this.mServer.password = this.mConfig.incoming.password;</span>
<a href="#l12.199"></a><span id="l12.199" class="difflineplus">+      verifyLogon(this.mConfig, this.mServer, this.mAlter, this.mMsgWindow,</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineplus">+                  this.mSuccessCallback, this.mErrorCallback);</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineplus">+    }</span>
<a href="#l12.202"></a><span id="l12.202" class="difflineplus">+    else</span>
<a href="#l12.203"></a><span id="l12.203" class="difflineplus">+    {</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineplus">+      // Tried all variations we can. Give up.</span>
<a href="#l12.205"></a><span id="l12.205" class="difflineplus">+      this._cleanup();</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineplus">+      let stringBundle = getStringBundle(&quot;chrome://messenger/locale/accountCreationModel.properties&quot;);</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineplus">+      let errorMsg = stringBundle.GetStringFromName(&quot;cannot_login.error&quot;);</span>
<a href="#l12.208"></a><span id="l12.208" class="difflineplus">+      this.mErrorCallback(new Exception(errorMsg));</span>
<a href="#l12.209"></a><span id="l12.209" class="difflineplus">+    }</span>
<a href="#l12.210"></a><span id="l12.210" class="difflineplus">+  },</span>
<a href="#l12.211"></a><span id="l12.211" class="difflineplus">+</span>
<a href="#l12.212"></a><span id="l12.212" class="difflineplus">+  _cleanup : function()</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineplus">+  {</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineplus">+      // avoid pref pollution, clear out server prefs.</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineplus">+      Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineplus">+            .getService(Ci.nsIMsgAccountManager).</span>
<a href="#l12.217"></a><span id="l12.217" class="difflineplus">+                removeIncomingServer(this.mServer, true);</span>
<a href="#l12.218"></a><span id="l12.218" class="difflineplus">+      this.mServer = null;</span>
<a href="#l12.219"></a><span id="l12.219" class="difflineplus">+  },</span>
<a href="#l12.220"></a><span id="l12.220" class="difflineplus">+</span>
<a href="#l12.221"></a><span id="l12.221" class="difflineplus">+  // Suppress any certificate errors</span>
<a href="#l12.222"></a><span id="l12.222" class="difflineplus">+  notifyCertProblem: function(socketInfo, status, targetSite) {</span>
<a href="#l12.223"></a><span id="l12.223" class="difflineplus">+    if (!status)</span>
<a href="#l12.224"></a><span id="l12.224" class="difflineplus">+      return true;</span>
<a href="#l12.225"></a><span id="l12.225" class="difflineplus">+</span>
<a href="#l12.226"></a><span id="l12.226" class="difflineplus">+    this.mCertError = true;</span>
<a href="#l12.227"></a><span id="l12.227" class="difflineplus">+    dump(&quot;got cert error\n&quot;);</span>
<a href="#l12.228"></a><span id="l12.228" class="difflineplus">+    setTimeout(this.informUserOfCertError, 0, socketInfo, targetSite, this);</span>
<a href="#l12.229"></a><span id="l12.229" class="difflineplus">+    return true;</span>
<a href="#l12.230"></a><span id="l12.230" class="difflineplus">+  },</span>
<a href="#l12.231"></a><span id="l12.231" class="difflineplus">+</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineplus">+  informUserOfCertError : function(socketInfo, targetSite, self) {</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineplus">+    let params = { exceptionAdded : false };</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineplus">+    params.prefetchCert = true;</span>
<a href="#l12.235"></a><span id="l12.235" class="difflineplus">+    params.location = targetSite;</span>
<a href="#l12.236"></a><span id="l12.236" class="difflineplus">+    window.openDialog('chrome://pippki/content/exceptionDialog.xul',</span>
<a href="#l12.237"></a><span id="l12.237" class="difflineplus">+                    '','chrome,centerscreen,modal', params);</span>
<a href="#l12.238"></a><span id="l12.238" class="difflineplus">+    dump(&quot;after exception dialog\n&quot;);</span>
<a href="#l12.239"></a><span id="l12.239" class="difflineplus">+    dump(&quot;exceptionAdded = &quot; + params.exceptionAdded + &quot;\n&quot;);</span>
<a href="#l12.240"></a><span id="l12.240" class="difflineplus">+    if (!params.exceptionAdded) {</span>
<a href="#l12.241"></a><span id="l12.241" class="difflineplus">+      self._cleanup();</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineplus">+      let stringBundle = getStringBundle(&quot;chrome://messenger/locale/accountCreationModel.properties&quot;);</span>
<a href="#l12.243"></a><span id="l12.243" class="difflineplus">+      let errorMsg = stringBundle.GetStringFromName(&quot;cannot_login.error&quot;);</span>
<a href="#l12.244"></a><span id="l12.244" class="difflineplus">+      self.mErrorCallback(new Exception(errorMsg));</span>
<a href="#l12.245"></a><span id="l12.245" class="difflineplus">+    }</span>
<a href="#l12.246"></a><span id="l12.246" class="difflineplus">+    else { // retry the logon now that we've added the cert exception.</span>
<a href="#l12.247"></a><span id="l12.247" class="difflineplus">+      verifyLogon(self.mConfig, self.mServer, self.mAlter, self.mMsgWindow,</span>
<a href="#l12.248"></a><span id="l12.248" class="difflineplus">+            self.mSuccessCallback, self.mErrorCallback);</span>
<a href="#l12.249"></a><span id="l12.249" class="difflineplus">+    }</span>
<a href="#l12.250"></a><span id="l12.250" class="difflineplus">+  },</span>
<a href="#l12.251"></a><span id="l12.251" class="difflineplus">+</span>
<a href="#l12.252"></a><span id="l12.252" class="difflineplus">+  // nsIInterfaceRequestor</span>
<a href="#l12.253"></a><span id="l12.253" class="difflineplus">+  getInterface: function(iid) {</span>
<a href="#l12.254"></a><span id="l12.254" class="difflineplus">+    return this.QueryInterface(iid);</span>
<a href="#l12.255"></a><span id="l12.255" class="difflineplus">+  },</span>
<a href="#l12.256"></a><span id="l12.256" class="difflineplus">+</span>
<a href="#l12.257"></a><span id="l12.257" class="difflineplus">+  // nsISupports</span>
<a href="#l12.258"></a><span id="l12.258" class="difflineplus">+  QueryInterface: function(iid) {</span>
<a href="#l12.259"></a><span id="l12.259" class="difflineplus">+    if (!iid.equals(Components.interfaces.nsIBadCertListener2) &amp;&amp;</span>
<a href="#l12.260"></a><span id="l12.260" class="difflineplus">+      !iid.equals(Components.interfaces.nsIInterfaceRequestor) &amp;&amp;</span>
<a href="#l12.261"></a><span id="l12.261" class="difflineplus">+      !iid.equals(Components.interfaces.nsIUrlListener) &amp;&amp;</span>
<a href="#l12.262"></a><span id="l12.262" class="difflineplus">+      !iid.equals(Components.interfaces.nsISupports))</span>
<a href="#l12.263"></a><span id="l12.263" class="difflineplus">+      throw Components.results.NS_ERROR_NO_INTERFACE;</span>
<a href="#l12.264"></a><span id="l12.264" class="difflineplus">+    return this;</span>
<a href="#l12.265"></a><span id="l12.265" class="difflineplus">+  }</span>
<a href="#l12.266"></a><span id="l12.266" class="difflineplus">+}</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

