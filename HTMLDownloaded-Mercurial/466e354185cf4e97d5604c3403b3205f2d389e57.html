<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 14741:466e354185cf4e97d5604c3403b3205f2d389e57</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 466e354185cf4e97d5604c3403b3205f2d389e57" />
<meta property="og:url" content="/comm-central/rev/466e354185cf4e97d5604c3403b3205f2d389e57" />
<meta property="og:description" content="Bug 954193 - reorganize purplexpcom, part 2: rewrite the core service, account list, status handling and protocol plugin loading in JS components that don't depend on libpurple." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 466e354185cf4e97d5604c3403b3205f2d389e57 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/466e354185cf4e97d5604c3403b3205f2d389e57">shortlog</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/466e354185cf4e97d5604c3403b3205f2d389e57">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57">files</a> |
changeset |
<a href="/comm-central/raw-rev/466e354185cf4e97d5604c3403b3205f2d389e57">raw</a>  | <a href="/comm-central/archive/466e354185cf4e97d5604c3403b3205f2d389e57.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=954193">Bug 954193</a> - reorganize purplexpcom, part 2: rewrite the core service, account list, status handling and protocol plugin loading in JS components that don't depend on libpurple.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#70;&#108;&#111;&#114;&#105;&#97;&#110;&#32;&#81;&#117;&#232;&#122;&#101;&#32;&#60;&#102;&#108;&#111;&#114;&#105;&#97;&#110;&#64;&#105;&#110;&#115;&#116;&#97;&#110;&#116;&#98;&#105;&#114;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 09 Nov 2011 01:16:17 +0100</td></tr>

<tr>
 <td>changeset 14741</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/466e354185cf4e97d5604c3403b3205f2d389e57">466e354185cf4e97d5604c3403b3205f2d389e57</a></td>
</tr>



<tr>
<td>parent 14740</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9d0c3d6cdf63063b630180d701e0e3a9ea227059">9d0c3d6cdf63063b630180d701e0e3a9ea227059</a>
</td>
</tr>

<tr>
<td>child 14742</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b8402474dd532ae716c165f45af73153282d2ab8">b8402474dd532ae716c165f45af73153282d2ab8</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=466e354185cf4e97d5604c3403b3205f2d389e57">9778</a></td></tr>
<tr><td>push user</td><td>florian@queze.net</td></tr>
<tr><td>push date</td><td class="date age">Sun, 12 Jan 2014 18:25:45 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@f81a23bfefcd [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=954193">954193</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=954193">Bug 954193</a> - reorganize purplexpcom, part 2: rewrite the core service, account list, status handling and protocol plugin loading in JS components that don't depend on libpurple.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/Makefile.in">chat/components/public/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/Makefile.in">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/Makefile.in">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/Makefile.in">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/Makefile.in">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/ibILogger.idl">chat/components/public/ibILogger.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/ibILogger.idl">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/ibILogger.idl">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/ibILogger.idl">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/ibILogger.idl">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/ibILogger.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imIAccount.idl">chat/components/public/imIAccount.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imIAccount.idl">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imIAccount.idl">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imIAccount.idl">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imIAccount.idl">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imIAccount.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imIAccountsService.idl">chat/components/public/imIAccountsService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imIAccountsService.idl">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imIAccountsService.idl">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imIAccountsService.idl">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imIAccountsService.idl">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imIAccountsService.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imIContactsService.idl">chat/components/public/imIContactsService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imIContactsService.idl">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imIContactsService.idl">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imIContactsService.idl">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imIContactsService.idl">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imIContactsService.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imIConversationsService.idl">chat/components/public/imIConversationsService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imIConversationsService.idl">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imIConversationsService.idl">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imIConversationsService.idl">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imIConversationsService.idl">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imIConversationsService.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imICoreService.idl">chat/components/public/imICoreService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imICoreService.idl">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imICoreService.idl">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imICoreService.idl">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imICoreService.idl">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imICoreService.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imIUserStatusInfo.idl">chat/components/public/imIUserStatusInfo.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imIUserStatusInfo.idl">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imIUserStatusInfo.idl">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imIUserStatusInfo.idl">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imIUserStatusInfo.idl">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/imIUserStatusInfo.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/prplIProtocol.idl">chat/components/public/prplIProtocol.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/prplIProtocol.idl">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/prplIProtocol.idl">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/prplIProtocol.idl">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/prplIProtocol.idl">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/prplIProtocol.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/purpleIConversation.idl">chat/components/public/purpleIConversation.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/purpleIConversation.idl">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/purpleIConversation.idl">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/purpleIConversation.idl">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/purpleIConversation.idl">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/public/purpleIConversation.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/Makefile.in">chat/components/src/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/Makefile.in">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/Makefile.in">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/Makefile.in">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/Makefile.in">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imAccounts.js">chat/components/src/imAccounts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imAccounts.js">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imAccounts.js">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imAccounts.js">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imAccounts.js">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imAccounts.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imAccounts.manifest">chat/components/src/imAccounts.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imAccounts.manifest">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imAccounts.manifest">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imAccounts.manifest">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imAccounts.manifest">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imAccounts.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imCommands.js">chat/components/src/imCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imCommands.js">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imCommands.js">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imCommands.js">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imCommands.js">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imCommands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imContacts.js">chat/components/src/imContacts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imContacts.js">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imContacts.js">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imContacts.js">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imContacts.js">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imContacts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imConversations.js">chat/components/src/imConversations.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imConversations.js">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imConversations.js">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imConversations.js">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imConversations.js">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imConversations.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imCore.js">chat/components/src/imCore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imCore.js">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imCore.js">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imCore.js">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imCore.js">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imCore.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imCore.manifest">chat/components/src/imCore.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imCore.manifest">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imCore.manifest">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imCore.manifest">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imCore.manifest">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/chat/components/src/imCore.manifest">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/modules/imServices.jsm">chat/modules/imServices.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/chat/modules/imServices.jsm">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/chat/modules/imServices.jsm">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/modules/imServices.jsm">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/chat/modules/imServices.jsm">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/chat/modules/imServices.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/modules/imThemes.jsm">chat/modules/imThemes.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/chat/modules/imThemes.jsm">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/chat/modules/imThemes.jsm">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/modules/imThemes.jsm">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/chat/modules/imThemes.jsm">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/chat/modules/imThemes.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/modules/imXPCOMUtils.jsm">chat/modules/imXPCOMUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/chat/modules/imXPCOMUtils.jsm">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/chat/modules/imXPCOMUtils.jsm">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/modules/imXPCOMUtils.jsm">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/chat/modules/imXPCOMUtils.jsm">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/chat/modules/imXPCOMUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/modules/jsProtoHelper.jsm">chat/modules/jsProtoHelper.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/chat/modules/jsProtoHelper.jsm">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/chat/modules/jsProtoHelper.jsm">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/modules/jsProtoHelper.jsm">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/chat/modules/jsProtoHelper.jsm">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/chat/modules/jsProtoHelper.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/jsTest/jsTestProtocol.js">chat/protocols/jsTest/jsTestProtocol.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/jsTest/jsTestProtocol.js">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/jsTest/jsTestProtocol.js">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/jsTest/jsTestProtocol.js">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/jsTest/jsTestProtocol.js">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/jsTest/jsTestProtocol.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/jsTest/jsTestProtocol.manifest">chat/protocols/jsTest/jsTestProtocol.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/jsTest/jsTestProtocol.manifest">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/jsTest/jsTestProtocol.manifest">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/jsTest/jsTestProtocol.manifest">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/jsTest/jsTestProtocol.manifest">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/jsTest/jsTestProtocol.manifest">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/overrides/facebookOverrideProtocol.js">chat/protocols/overrides/facebookOverrideProtocol.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/overrides/facebookOverrideProtocol.js">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/overrides/facebookOverrideProtocol.js">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/overrides/facebookOverrideProtocol.js">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/overrides/facebookOverrideProtocol.js">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/overrides/facebookOverrideProtocol.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/overrides/gtalkOverrideProtocol.js">chat/protocols/overrides/gtalkOverrideProtocol.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/overrides/gtalkOverrideProtocol.js">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/overrides/gtalkOverrideProtocol.js">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/overrides/gtalkOverrideProtocol.js">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/overrides/gtalkOverrideProtocol.js">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/overrides/gtalkOverrideProtocol.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/overrides/overrideProtocols.manifest">chat/protocols/overrides/overrideProtocols.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/overrides/overrideProtocols.manifest">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/overrides/overrideProtocols.manifest">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/overrides/overrideProtocols.manifest">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/overrides/overrideProtocols.manifest">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/overrides/overrideProtocols.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/twitter/twitter.js">chat/protocols/twitter/twitter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/twitter/twitter.js">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/twitter/twitter.js">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/twitter/twitter.js">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/twitter/twitter.js">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/twitter/twitter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/twitter/twitter.manifest">chat/protocols/twitter/twitter.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/twitter/twitter.manifest">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/twitter/twitter.manifest">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/twitter/twitter.manifest">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/twitter/twitter.manifest">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/chat/protocols/twitter/twitter.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/components/ibCommandLineHandler.js">im/components/ibCommandLineHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/im/components/ibCommandLineHandler.js">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/im/components/ibCommandLineHandler.js">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/components/ibCommandLineHandler.js">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/im/components/ibCommandLineHandler.js">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/im/components/ibCommandLineHandler.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/components/ibStatusCommandLineHandler.js">im/components/ibStatusCommandLineHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/im/components/ibStatusCommandLineHandler.js">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/im/components/ibStatusCommandLineHandler.js">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/components/ibStatusCommandLineHandler.js">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/im/components/ibStatusCommandLineHandler.js">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/im/components/ibStatusCommandLineHandler.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/components/mintrayr/content/mintrayr.js">im/components/mintrayr/content/mintrayr.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/im/components/mintrayr/content/mintrayr.js">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/im/components/mintrayr/content/mintrayr.js">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/components/mintrayr/content/mintrayr.js">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/im/components/mintrayr/content/mintrayr.js">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/im/components/mintrayr/content/mintrayr.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/aboutDialog.xul">im/content/aboutDialog.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/aboutDialog.xul">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/aboutDialog.xul">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/aboutDialog.xul">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/aboutDialog.xul">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/aboutDialog.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/account.js">im/content/account.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/account.js">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/account.js">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/account.js">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/account.js">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/account.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/account.xml">im/content/account.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/account.xml">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/account.xml">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/account.xml">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/account.xml">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/account.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/accountWizard.js">im/content/accountWizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/accountWizard.js">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/accountWizard.js">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/accountWizard.js">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/accountWizard.js">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/accountWizard.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/accounts.js">im/content/accounts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/accounts.js">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/accounts.js">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/accounts.js">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/accounts.js">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/accounts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/addbuddy.js">im/content/addbuddy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/addbuddy.js">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/addbuddy.js">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/addbuddy.js">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/addbuddy.js">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/addbuddy.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/blist.js">im/content/blist.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/blist.js">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/blist.js">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/blist.js">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/blist.js">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/blist.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/debug/debug.js">im/content/debug/debug.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/debug/debug.js">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/debug/debug.js">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/debug/debug.js">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/debug/debug.js">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/debug/debug.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/debug/fake/fake.js">im/content/debug/fake/fake.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/debug/fake/fake.js">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/debug/fake/fake.js">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/debug/fake/fake.js">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/debug/fake/fake.js">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/debug/fake/fake.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/joinchat.js">im/content/joinchat.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/joinchat.js">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/joinchat.js">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/joinchat.js">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/joinchat.js">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/joinchat.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/menus.js">im/content/menus.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/menus.js">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/menus.js">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/menus.js">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/menus.js">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/menus.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/proxies.js">im/content/proxies.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/proxies.js">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/proxies.js">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/proxies.js">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/proxies.js">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/im/content/proxies.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/locales/en-US/chrome/instantbird/core.properties">im/locales/en-US/chrome/instantbird/core.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/im/locales/en-US/chrome/instantbird/core.properties">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/im/locales/en-US/chrome/instantbird/core.properties">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/locales/en-US/chrome/instantbird/core.properties">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/im/locales/en-US/chrome/instantbird/core.properties">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/im/locales/en-US/chrome/instantbird/core.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/modules/ibCore.jsm">im/modules/ibCore.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/im/modules/ibCore.jsm">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/im/modules/ibCore.jsm">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/im/modules/ibCore.jsm">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/im/modules/ibCore.jsm">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/im/modules/ibCore.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/purple/purplexpcom/public/purpleIProtocol.idl">purple/purplexpcom/public/purpleIProtocol.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/purple/purplexpcom/public/purpleIProtocol.idl">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/purple/purplexpcom/public/purpleIProtocol.idl">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/purple/purplexpcom/public/purpleIProtocol.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/purple/purplexpcom/public/purpleIRequest.idl">purple/purplexpcom/public/purpleIRequest.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/466e354185cf4e97d5604c3403b3205f2d389e57/purple/purplexpcom/public/purpleIRequest.idl">file</a> |
<a href="/comm-central/annotate/466e354185cf4e97d5604c3403b3205f2d389e57/purple/purplexpcom/public/purpleIRequest.idl">annotate</a> |
<a href="/comm-central/diff/466e354185cf4e97d5604c3403b3205f2d389e57/purple/purplexpcom/public/purpleIRequest.idl">diff</a> |
<a href="/comm-central/comparison/466e354185cf4e97d5604c3403b3205f2d389e57/purple/purplexpcom/public/purpleIRequest.idl">comparison</a> |
<a href="/comm-central/log/466e354185cf4e97d5604c3403b3205f2d389e57/purple/purplexpcom/public/purpleIRequest.idl">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/chat/components/public/Makefile.in</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/chat/components/public/Makefile.in</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -40,15 +40,20 @@ srcdir		= @srcdir@</span>
<a href="#l1.4"></a><span id="l1.4"> VPATH		= @srcdir@</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> MODULE		= chat</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> XPIDLSRCS	= \</span>
<a href="#l1.11"></a><span id="l1.11"> 		ibILogger.idl \</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+		imIAccount.idl \</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+		imIAccountsService.idl \</span>
<a href="#l1.14"></a><span id="l1.14"> 		imICommandsService.idl \</span>
<a href="#l1.15"></a><span id="l1.15"> 		imIContactsService.idl \</span>
<a href="#l1.16"></a><span id="l1.16"> 		imIConversationsService.idl \</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+		imICoreService.idl \</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+		imIUserStatusInfo.idl \</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+		prplIProtocol.idl \</span>
<a href="#l1.20"></a><span id="l1.20"> 		purpleIConversation.idl \</span>
<a href="#l1.21"></a><span id="l1.21"> 		$(NULL)</span>
<a href="#l1.22"></a><span id="l1.22"> </span>
<a href="#l1.23"></a><span id="l1.23"> include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/chat/components/public/ibILogger.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/chat/components/public/ibILogger.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -33,17 +33,17 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l2.5"></a><span id="l2.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l2.6"></a><span id="l2.6">  *</span>
<a href="#l2.7"></a><span id="l2.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l2.10"></a><span id="l2.10"> #include &quot;nsISimpleEnumerator.idl&quot;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-interface purpleIAccount;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+interface imIAccount;</span>
<a href="#l2.14"></a><span id="l2.14"> interface imIAccountBuddy;</span>
<a href="#l2.15"></a><span id="l2.15"> interface imIBuddy;</span>
<a href="#l2.16"></a><span id="l2.16"> interface imIContact;</span>
<a href="#l2.17"></a><span id="l2.17"> interface purpleIConversation;</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19"> [scriptable, uuid(164ff6c3-ca64-4880-b8f3-67eb1817955f)]</span>
<a href="#l2.20"></a><span id="l2.20"> interface ibILog: nsISupports {</span>
<a href="#l2.21"></a><span id="l2.21">   readonly attribute AUTF8String path;</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -51,10 +51,10 @@ interface ibILog: nsISupports {</span>
<a href="#l2.23"></a><span id="l2.23"> };</span>
<a href="#l2.24"></a><span id="l2.24"> </span>
<a href="#l2.25"></a><span id="l2.25"> [scriptable, uuid(ab38c01c-2245-4279-9437-1d6bcc69d556)]</span>
<a href="#l2.26"></a><span id="l2.26"> interface ibILogger: nsISupports {</span>
<a href="#l2.27"></a><span id="l2.27">   nsISimpleEnumerator getLogsForAccountBuddy(in imIAccountBuddy aAccountBuddy);</span>
<a href="#l2.28"></a><span id="l2.28">   nsISimpleEnumerator getLogsForBuddy(in imIBuddy aBuddy);</span>
<a href="#l2.29"></a><span id="l2.29">   nsISimpleEnumerator getLogsForContact(in imIContact aContact);</span>
<a href="#l2.30"></a><span id="l2.30">   nsISimpleEnumerator getLogsForConversation(in purpleIConversation aConversation);</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-  nsISimpleEnumerator getSystemLogsForAccount(in purpleIAccount aAccount);</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+  nsISimpleEnumerator getSystemLogsForAccount(in imIAccount aAccount);</span>
<a href="#l2.33"></a><span id="l2.33"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/chat/components/public/imIAccount.idl</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,296 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+ *</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+ *</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+ * License.</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+ *</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+ * The Original Code is the Instantbird messenging client, released</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+ * 2007.</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+ *</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+ * Florian QUEZE &lt;florian@instantbird.org&gt;.</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+ *</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+ *</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+ *</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+#include &quot;purpleIConversation.idl&quot;</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+#include &quot;purpleIProxy.idl&quot;</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+#include &quot;imIUserStatusInfo.idl&quot;</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+interface imITag;</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+interface imIBuddy;</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+interface imIAccountBuddy;</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+interface imIAccount;</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+interface prplIProtocol;</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+/*</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+ * Used to join chat rooms.</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+ */</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+[ptr] native GHashTablePtr(GHashTable);</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+[scriptable, uuid(ea7ab156-d25e-46cc-93ef-29f77b3c0795)]</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+interface purpleIChatRoomFieldValues: nsISupports {</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+  AUTF8String getValue(in AUTF8String aIdentifier);</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+  void setValue(in AUTF8String aIdentifier, in AUTF8String aValue);</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+  [noscript] readonly attribute GHashTablePtr hashTable;</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+};</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+[scriptable, uuid(19dff981-b125-4a70-bc1a-efc783d07137)]</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+interface purpleIChatRoomField: nsISupports {</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+  readonly attribute AUTF8String label;</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+  readonly attribute AUTF8String identifier;</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+  readonly attribute boolean required;</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+  const short TYPE_TEXT = 0;</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+  const short TYPE_PASSWORD = 1;</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+  const short TYPE_INT = 2;</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+  readonly attribute short type;</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+  readonly attribute long min;</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+  readonly attribute long max;</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+};</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+/*</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+ * This interface should be implemented by the protocol plugin.</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+ */</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+[scriptable, uuid(fb1b29cb-63ba-4335-9f44-63aea3f616a3)]</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+interface prplIAccount: nsISupports {</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+  readonly attribute imIAccount imAccount;</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+  // observe should only be called by the imIAccount</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+  // implementation to report user status changes that affect this account.</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+  void observe(in nsISupports aObj, in string aEvent,</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+               [optional] in wstring aData);</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+  /* Uninitialize the prplIAccount instance. This is typically done</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+     automatically at shutdown (by the core service) or as part of</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+     the 'remove' method. */</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+  void unInit();</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+  void connect();</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+  void disconnect();</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+  purpleIConversation createConversation(in AUTF8String aName);</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+  // Used when the user wants to add a buddy to the buddy list</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+  void addBuddy(in imITag aTag, in AUTF8String aName);</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+  // Used while loading the buddy list at startup.</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+  imIAccountBuddy loadBuddy(in imIBuddy aBuddy, in imITag aTag);</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+  /* Request more info on a buddy (typically a chat buddy).</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+   * The result (if any) will be provided by a user-info-received</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+   * notification dispatched through the observer service:</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+   *  - aSubject will be an nsISimpleEnumerator of purpleITooltipInfo,</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+   *  Do NOT store aSubject. Use it right away. The memory it points to</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+   *  will be freed right after the notification is dispatched.</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+   *  - aData will be aBuddyName.</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+   */</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+  void requestBuddyInfo(in AUTF8String aBuddyName);</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+  readonly attribute boolean canJoinChat;</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+  nsISimpleEnumerator getChatRoomFields();</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+  purpleIChatRoomFieldValues getChatRoomDefaultFieldValues([optional] in AUTF8String aDefaultChatName);</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+  /*</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+   * Create a new chat conversation if it doesn't already exist.</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineplus">+   */</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineplus">+  void joinChat(in purpleIChatRoomFieldValues aComponents);</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+  readonly attribute AUTF8String normalizedName;</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+  attribute purpleIProxyInfo proxyInfo;</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+  // protocol specific options: those functions set the protocol</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+  // specific options for the PurpleAccount</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+  void setBool(in string aName, in boolean aVal);</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+  void setInt(in string aName, in long aVal);</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+  void setString(in string aName, in string aVal);</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+  /* When a connection error occurred, this value indicates the type of error */</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+  readonly attribute short connectionErrorReason;</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+  /* Possible connection error reasons:</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+     ERROR_NETWORK_ERROR and ERROR_ENCRYPTION_ERROR are not fatal and</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+     should enable the automatic reconnection feature. */</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+  const short NO_ERROR = -1;</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+  const short ERROR_NETWORK_ERROR = 0;</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+  const short ERROR_INVALID_USERNAME = 1;</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineplus">+  const short ERROR_AUTHENTICATION_FAILED = 2;</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineplus">+  const short ERROR_AUTHENTICATION_IMPOSSIBLE = 3;</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+  const short ERROR_NO_SSL_SUPPORT = 4;</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+  const short ERROR_ENCRYPTION_ERROR = 5;</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+  const short ERROR_NAME_IN_USE = 6;</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+  const short ERROR_INVALID_SETTINGS = 7;</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineplus">+  const short ERROR_CERT_NOT_PROVIDED = 8;</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+  const short ERROR_CERT_UNTRUSTED = 9;</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+  const short ERROR_CERT_EXPIRED = 10;</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineplus">+  const short ERROR_CERT_NOT_ACTIVATED = 11;</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineplus">+  const short ERROR_CERT_HOSTNAME_MISMATCH = 12;</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineplus">+  const short ERROR_CERT_FINGERPRINT_MISMATCH = 13;</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineplus">+  const short ERROR_CERT_SELF_SIGNED = 14;</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineplus">+  const short ERROR_CERT_OTHER_ERROR = 15;</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineplus">+  const short ERROR_OTHER_ERROR = 16;</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+  /* From PurpleConnectionFlags */</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+  //   PURPLE_CONNECTION_HTML</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+  //    Connection sends/receives in 'HTML'.</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+  readonly attribute boolean HTMLEnabled;</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineplus">+  //   PURPLE_CONNECTION_NO_BGCOLOR</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineplus">+  //    Connection does not send/receive background colors.</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+  readonly attribute boolean noBackgroundColors;</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineplus">+</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineplus">+  //   PURPLE_CONNECTION_AUTO_RESP</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineplus">+  //    Send auto responses when away.</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+  readonly attribute boolean autoResponses;</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+  //   PURPLE_CONNECTION_FORMATTING_WBFO</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineplus">+  //    The text buffer must be formatted as a whole.</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineplus">+  readonly attribute boolean singleFormatting;</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+  //   PURPLE_CONNECTION_NO_NEWLINES</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineplus">+  //    No new lines are allowed in outgoing messages.</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineplus">+  readonly attribute boolean noNewlines;</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineplus">+</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+  //   PURPLE_CONNECTION_NO_FONTSIZE</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineplus">+  //    Connection does not send/receive font sizes.</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineplus">+  readonly attribute boolean noFontSizes;</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+  //   PURPLE_CONNECTION_NO_URLDESC</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+  //    Connection does not support descriptions with links.</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineplus">+  readonly attribute boolean noUrlDesc;</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineplus">+</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineplus">+  //   PURPLE_CONNECTION_NO_IMAGES</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineplus">+  //    Connection does not support sending of images.</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineplus">+  readonly attribute boolean noImages;</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineplus">+</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineplus">+  // This is currently used only by Twitter.</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineplus">+  readonly attribute PRInt32 maxMessageLength;</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineplus">+};</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineplus">+</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineplus">+/* This interface should be implemented by the im core. It inherits</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+from prplIAccount and in most cases will forward the calls for the</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineplus">+inherited members to a prplIAccount account instance implemented by</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineplus">+the protocol plugin. */</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineplus">+[scriptable, uuid(20a85b44-e220-4f23-85bf-f8523d1a2b08)]</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineplus">+interface imIAccount: prplIAccount {</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineplus">+  /* Check if autologin is enabled for this account, connect it now. */</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineplus">+  void checkAutoLogin();</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineplus">+</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineplus">+  /* Delete the account (from the preferences, mozStorage, and call unInit). */</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineplus">+  void remove();</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineplus">+</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineplus">+  /* Cancel the timer that automatically reconnects the account that were</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+     disconnected with a non fatal error */</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+  void cancelReconnection();</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineplus">+</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineplus">+  readonly attribute AUTF8String name;</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineplus">+  readonly attribute AUTF8String id;</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineplus">+  readonly attribute PRUint32 numericId;</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineplus">+  readonly attribute prplIProtocol protocol;</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineplus">+  readonly attribute prplIAccount prplAccount;</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineplus">+</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineplus">+  // Save account specific preferences to disk.</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineplus">+  void save();</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineplus">+</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineplus">+  attribute boolean autoLogin;</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineplus">+</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineplus">+  /* This is the value when the preference firstConnectionState is not set.</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineplus">+     It indicates that the account has already been successfully connected at</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineplus">+     least once with the current parameters. */</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineplus">+  const short FIRST_CONNECTION_OK = 0;</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineplus">+  /* Set when the account has never had a successful connection</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineplus">+     with the current parameters */</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineplus">+  const short FIRST_CONNECTION_UNKNOWN = 1;</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineplus">+  /* Set when the account is trying to connect for the first time</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineplus">+     with the current parameters (removed after a successsful connection) */</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineplus">+  const short FIRST_CONNECTION_PENDING = 2;</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineplus">+  /* Set at startup when the previous state was pending */</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineplus">+  const short FIRST_CONNECTION_CRASHED = 4;</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineplus">+</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineplus">+  attribute short firstConnectionState;</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineplus">+</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineplus">+  // FIXME password should be in password manager</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineplus">+  attribute AUTF8String password;</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineplus">+</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineplus">+  attribute AUTF8String alias;</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineplus">+</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineplus">+  /* While an account is connecting, this attribute contains a message</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineplus">+     indicating the current step of the connection */</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineplus">+  readonly attribute AUTF8String connectionStateMsg;</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineplus">+</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineplus">+  /* Number of the reconnection attempt</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineplus">+   *  0 means that no automatic reconnection currently pending</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineplus">+   *  n means the nth reconnection attempt is pending</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineplus">+   */</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineplus">+  readonly attribute PRUint16 reconnectAttempt;</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineplus">+</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineplus">+  /* Time stamp of the next reconnection attempt */</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineplus">+  readonly attribute PRInt64 timeOfNextReconnect;</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineplus">+</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineplus">+  /* Time stamp of the last connection (value not reliable if not connected) */</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineplus">+  readonly attribute PRInt64 timeOfLastConnect;</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineplus">+</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineplus">+  /* Additional possible connection error reasons:</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineplus">+   * (Use a big enough number that it can't conflict with error</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineplus">+   *  codes used in prplIAccount).</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineplus">+   */</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineplus">+  const short ERROR_UNKNOWN_PRPL = 42;</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineplus">+  const short ERROR_CRASHED = 43;</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineplus">+  const short ERROR_MISSING_PASSWORD = 44;</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineplus">+</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineplus">+  /* A message describing the connection error */</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineplus">+  readonly attribute AUTF8String connectionErrorMessage;</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineplus">+</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineplus">+  /* Info about the connection state and flags */</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineplus">+  const short STATE_DISCONNECTED = 0;</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineplus">+  const short STATE_CONNECTED = 1;</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineplus">+  const short STATE_CONNECTING = 2;</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineplus">+  const short STATE_DISCONNECTING = 3;</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineplus">+</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineplus">+  readonly attribute short connectionState;</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineplus">+</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineplus">+  /* The following 4 properties use the above connectionState value. */</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineplus">+  readonly attribute boolean disconnected;</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineplus">+  readonly attribute boolean connected;</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineplus">+  readonly attribute boolean connecting;</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineplus">+  readonly attribute boolean disconnecting;</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineplus">+</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineplus">+  /* The imIUserStatusInfo instance this account should observe for</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineplus">+     status changes. When this is null (the default value), the</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineplus">+     account will observe the global status. */</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineplus">+  attribute imIUserStatusInfo observedStatusInfo;</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineplus">+  // Same as above, but never null (it fallbacks to the global status info).</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineplus">+  attribute imIUserStatusInfo statusInfo;</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineplus">+</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineplus">+  // imIAccount also implements an observe method but this</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineplus">+  // observe should only be called by the prplIAccount</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineplus">+  // implementations to report connection status changes.</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/chat/components/public/imIAccountsService.idl</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,97 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+ *</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+ *</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+ * License.</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+ *</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+ * The Original Code is the Instantbird messenging client, released</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+ * 2007.</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+ *</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+ * Florian QUEZE &lt;florian@instantbird.org&gt;.</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+ *</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+ *</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+ *</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+#include &quot;nsISimpleEnumerator.idl&quot;</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+#include &quot;imIAccount.idl&quot;</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+[scriptable, uuid(b3b6459a-5c26-47b8-8e9c-ba838b6f632a)]</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+interface imIAccountsService: nsISupports {</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+  void initAccounts();</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+  void unInitAccounts();</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+  /* This attribute is set to AUTOLOGIN_ENABLED by default. It can be set to</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+     any other value before the initialization of this service to prevent</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+     accounts with autoLogin enabled from being connected when libpurple is</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+     initialized.</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+     Any value other than the ones listed below will disable autoLogin and</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+     display a generic message in the Account Manager. */</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+  attribute short autoLoginStatus;</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+  const short AUTOLOGIN_ENABLED = 0;</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+  const short AUTOLOGIN_USER_DISABLED = 1;</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+  const short AUTOLOGIN_SAFE_MODE = 2;</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+  const short AUTOLOGIN_CRASH = 3;</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+  const short AUTOLOGIN_START_OFFLINE = 4;</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+  /* The method should be used to connect all accounts with autoLogin enabled.</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+     Some use cases:</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+       - if the autologin was disabled at startup</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+       - after a loss of internet connectivity that disconnected all accounts.</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+  */</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+  void processAutoLogin();</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+  imIAccount getAccountById(in AUTF8String aAccountId);</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+  /* will throw NS_ERROR_FAILURE if not found */</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+  imIAccount getAccountByNumericId(in PRUint32 aAccountId);</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+  nsISimpleEnumerator getAccounts();</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+  /* will fire the event account-added */</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+  imIAccount createAccount(in AUTF8String aName, in AUTF8String aPrpl);</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+  /* will fire the event account-removed */</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+  void deleteAccount(in AUTF8String aAccountId);</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+};</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+/*</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+ account related notifications sent to nsIObserverService:</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+   - account-added: a new account has been created</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+   - account-removed: the account has been deleted</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+   - account-connecting: the account is being connected</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+   - account-connected: the account is now connected</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+   - account-connect-error: the account is disconnect with an error.</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+     (before account-disconnecting)</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+   - account-disconnecting: the account is being disconnected</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+   - account-disconnected: the account is now disconnected</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+   - account-updated: when some settings have changed</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+   - account-list-updated: when the list of account is reordered.</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+   These events can be watched using an nsIObserver.</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+   The associated imIAccount will be given as a parameter</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+   (except for account-list-updated).</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+*/</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/chat/components/public/imIContactsService.idl</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/chat/components/public/imIContactsService.idl</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -39,35 +39,52 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #include &quot;nsIObserver.idl&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;nsISimpleEnumerator.idl&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;purpleIConversation.idl&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> interface imITag;</span>
<a href="#l5.9"></a><span id="l5.9"> interface imIContact;</span>
<a href="#l5.10"></a><span id="l5.10"> interface imIBuddy;</span>
<a href="#l5.11"></a><span id="l5.11"> interface imIAccountBuddy;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-interface purpleIProtocol;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+interface imIAccount;</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+interface prplIProtocol;</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16"> [scriptable, uuid(f1619b49-310b-47aa-ab1c-238aba084c62)]</span>
<a href="#l5.17"></a><span id="l5.17"> interface imIContactsService: nsISupports {</span>
<a href="#l5.18"></a><span id="l5.18">   void initContacts();</span>
<a href="#l5.19"></a><span id="l5.19">   void unInitContacts();</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21">   imIContact getContactById(in long aId);</span>
<a href="#l5.22"></a><span id="l5.22">   imIBuddy getBuddyById(in long aId);</span>
<a href="#l5.23"></a><span id="l5.23">   imIBuddy getBuddyByNameAndProtocol(in AUTF8String aNormalizedName,</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-                                     in purpleIProtocol aPrpl);</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+                                     in prplIProtocol aPrpl);</span>
<a href="#l5.26"></a><span id="l5.26"> </span>
<a href="#l5.27"></a><span id="l5.27">   // These 3 functions are called by the protocol plugins when</span>
<a href="#l5.28"></a><span id="l5.28">   // synchronizing the buddy list with the server stored list,</span>
<a href="#l5.29"></a><span id="l5.29">   // or after user operations have been performed.</span>
<a href="#l5.30"></a><span id="l5.30">   void accountBuddyAdded(in imIAccountBuddy aAccountBuddy);</span>
<a href="#l5.31"></a><span id="l5.31">   void accountBuddyRemoved(in imIAccountBuddy aAccountBuddy);</span>
<a href="#l5.32"></a><span id="l5.32">   void accountBuddyMoved(in imIAccountBuddy aAccountBuddy,</span>
<a href="#l5.33"></a><span id="l5.33">                          in imITag aOldTag, in imITag aNewTag);</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+  // These methods are called by the imIAccountsService implementation</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+  // to keep the accounts table in sync with accounts stored in the</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+  // preferences.</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+  // Called when an account is created or loaded to store the new</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+  // account or ensure it doesn't conflict with an existing account</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+  // (to detect database corruption).</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+  // Will throw if a stored account has the id aId but a different</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+  // username or prplId.</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+  void storeAccount(in PRUint32 aId, in AUTF8String aUserName,</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+                    in AUTF8String aPrplId);</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+  // Check if an account id already exists in the database.</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+  boolean accountIdExists(in PRUint32 aId);</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+  // Called when deleting an account to remove it from blist.sqlite.</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+  void forgetAccount(in PRUint32 aId);</span>
<a href="#l5.50"></a><span id="l5.50"> };</span>
<a href="#l5.51"></a><span id="l5.51"> </span>
<a href="#l5.52"></a><span id="l5.52"> [scriptable, uuid(f799a9c2-23f2-4fd1-96fb-515bad238f8c)]</span>
<a href="#l5.53"></a><span id="l5.53"> interface imITagsService: nsISupports {</span>
<a href="#l5.54"></a><span id="l5.54">   // Create a new tags or return the existing one if it already exists</span>
<a href="#l5.55"></a><span id="l5.55">   imITag createTag(in AUTF8String aName);</span>
<a href="#l5.56"></a><span id="l5.56">   // Get an existing tag by (numeric) id. Returns null if not found.</span>
<a href="#l5.57"></a><span id="l5.57">   imITag getTagById(in long aId);</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineat">@@ -250,17 +267,17 @@ interface imIContact: imIStatusInfo {</span>
<a href="#l5.59"></a><span id="l5.59">   void notifyObservers(in nsISupports aObj, in string aEvent,</span>
<a href="#l5.60"></a><span id="l5.60">                        [optional] in wstring aData);</span>
<a href="#l5.61"></a><span id="l5.61"> };</span>
<a href="#l5.62"></a><span id="l5.62"> </span>
<a href="#l5.63"></a><span id="l5.63"> </span>
<a href="#l5.64"></a><span id="l5.64"> [scriptable, uuid(fea582a0-3839-4d80-bcab-0ff82ae8f97f)]</span>
<a href="#l5.65"></a><span id="l5.65"> interface imIBuddy: imIStatusInfo {</span>
<a href="#l5.66"></a><span id="l5.66">   readonly attribute long id;</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineminus">-  readonly attribute purpleIProtocol protocol;</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+  readonly attribute prplIProtocol protocol;</span>
<a href="#l5.69"></a><span id="l5.69">   readonly attribute AUTF8String userName; // may be formatted</span>
<a href="#l5.70"></a><span id="l5.70">   readonly attribute AUTF8String normalizedName; // normalized userName</span>
<a href="#l5.71"></a><span id="l5.71">   // The optional server alias is in displayName (inherited from imIStatusInfo)</span>
<a href="#l5.72"></a><span id="l5.72">   // displayName = serverAlias || userName.</span>
<a href="#l5.73"></a><span id="l5.73"> </span>
<a href="#l5.74"></a><span id="l5.74">   readonly attribute imIContact contact;</span>
<a href="#l5.75"></a><span id="l5.75">   readonly attribute imIAccountBuddy preferredAccountBuddy;</span>
<a href="#l5.76"></a><span id="l5.76">   void getAccountBuddies([optional] out unsigned long accountBuddyCount,</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineat">@@ -325,17 +342,17 @@ interface imIBuddy: imIStatusInfo {</span>
<a href="#l5.78"></a><span id="l5.78">  * its tags and nsObserverService.</span>
<a href="#l5.79"></a><span id="l5.79">  */</span>
<a href="#l5.80"></a><span id="l5.80"> [scriptable, uuid(114d24ff-56a1-4fd6-9822-4992efb6e036)]</span>
<a href="#l5.81"></a><span id="l5.81"> interface imIAccountBuddy: imIStatusInfo {</span>
<a href="#l5.82"></a><span id="l5.82">   // The setter is for internal use only. buddy will be set by the</span>
<a href="#l5.83"></a><span id="l5.83">   // Contacts service when accountBuddyAdded is called on this</span>
<a href="#l5.84"></a><span id="l5.84">   // instance of imIAccountBuddy.</span>
<a href="#l5.85"></a><span id="l5.85">            attribute imIBuddy buddy;</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineminus">-  readonly attribute purpleIAccount account;</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+  readonly attribute imIAccount account;</span>
<a href="#l5.88"></a><span id="l5.88">   // Setting the tag will move the buddy to a different group on the</span>
<a href="#l5.89"></a><span id="l5.89">   // server-stored buddy list.</span>
<a href="#l5.90"></a><span id="l5.90">            attribute imITag tag;</span>
<a href="#l5.91"></a><span id="l5.91">   readonly attribute AUTF8String userName;</span>
<a href="#l5.92"></a><span id="l5.92">   readonly attribute AUTF8String normalizedName;</span>
<a href="#l5.93"></a><span id="l5.93">            attribute AUTF8String serverAlias;</span>
<a href="#l5.94"></a><span id="l5.94"> </span>
<a href="#l5.95"></a><span id="l5.95">   // remove the buddy from the buddy list of this account.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/chat/components/public/imIConversationsService.idl</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/chat/components/public/imIConversationsService.idl</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -88,11 +88,11 @@ interface imIConversationsService: nsISu</span>
<a href="#l6.4"></a><span id="l6.4">   void getUIConversations([optional] out unsigned long conversationCount,</span>
<a href="#l6.5"></a><span id="l6.5">                           [retval, array, size_is(conversationCount)] out imIConversation conversations);</span>
<a href="#l6.6"></a><span id="l6.6">   imIConversation getUIConversation(in purpleIConversation aConversation);</span>
<a href="#l6.7"></a><span id="l6.7">   imIConversation getUIConversationByContactId(in long aId);</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9">   nsISimpleEnumerator getConversations();</span>
<a href="#l6.10"></a><span id="l6.10">   purpleIConversation getConversationById(in unsigned long aId);</span>
<a href="#l6.11"></a><span id="l6.11">   purpleIConversation getConversationByNameAndAccount(in AUTF8String aName,</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-                                                      in purpleIAccount aAccount,</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+                                                      in imIAccount aAccount,</span>
<a href="#l6.14"></a><span id="l6.14">                                                       in boolean aIsChat);</span>
<a href="#l6.15"></a><span id="l6.15"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/chat/components/public/imICoreService.idl</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,54 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+ *</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+ *</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+ * License.</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+ *</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+ * The Original Code is the Instantbird messenging client, released</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+ * 2007.</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+ *</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+ * Florian QUEZE &lt;florian@instantbird.org&gt;.</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2007</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+ *</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+ *</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+ *</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+#include &quot;imIUserStatusInfo.idl&quot;</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+#include &quot;nsISimpleEnumerator.idl&quot;</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+#include &quot;prplIProtocol.idl&quot;</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+[scriptable, uuid(205d4b2b-1ccf-4879-9ef1-f08942566151)]</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+interface imICoreService: nsISupports {</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+  void init();</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+  void quit(); // will emit a prpl-quit notification.</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+  // returns an enumerator on a pplIProtocol array</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+  nsISimpleEnumerator getProtocols();</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+  prplIProtocol getProtocolById(in AUTF8String aProtocolId);</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+  readonly attribute imIUserStatusInfo globalUserStatus;</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/chat/components/public/imIUserStatusInfo.idl</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,76 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+ *</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+ *</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+ * License.</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+ *</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+ * The Original Code is the Instantbird messenging client, released</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+ * 2010.</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+ *</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+ * Florian QUEZE &lt;florian@instantbird.org&gt;.</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2010</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+ *</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+ *</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+ *</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+#include &quot;nsIObserver.idl&quot;</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+//forward declarations</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+interface nsILocalFile;</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+interface nsIFileURL;</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+[scriptable, uuid(817918fa-1f4b-4254-9cdb-f906da91c45d)]</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+interface imIUserStatusInfo: nsISupports {</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+  readonly attribute AUTF8String statusText;</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+  // See imIStatusInfo in imIContactsService.idl for the values.</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+  readonly attribute short statusType;</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+  // Only works with STATUS_OFFLINE, STATUS_UNAVAILABLE, STATUS_AWAY,</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+  // STATUS_AVAILABLE and STATUS_INVISIBLE.</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+  // - When called with the status type STATUS_UNSET, only the status</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+  //   message will be changed.</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+  // - When called with STATUS_OFFLINE, the aMessage parameter is ignored.</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+  void setStatus(in short aStatus, in AUTF8String aMessage);</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+  /* Will fire an user-icon-changed notificaton. */</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+  void setUserIcon(in nsILocalFile aIconFile);</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+  nsIFileURL getUserIcon();</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+  /* The setter will fire an user-display-name-changed notificaton. */</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+  attribute AUTF8String displayName;</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+  void addObserver(in nsIObserver aObserver);</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+  void removeObserver(in nsIObserver aObserver);</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+  /* Observers will receive the following notifications:</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+   *   status-changed (when either the status type or text has changed)</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+   *   user-icon-changed</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+   *   user-display-name-changed</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+   *   idle-time-changed</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+   */</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">rename from purple/purplexpcom/public/purpleIProtocol.idl</span>
<a href="#l9.2"></a><span id="l9.2">rename to chat/components/public/prplIProtocol.idl</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineminus">--- a/purple/purplexpcom/public/purpleIProtocol.idl</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineplus">+++ b/chat/components/public/prplIProtocol.idl</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineat">@@ -32,32 +32,25 @@</span>
<a href="#l9.6"></a><span id="l9.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l9.7"></a><span id="l9.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l9.8"></a><span id="l9.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l9.9"></a><span id="l9.9">  *</span>
<a href="#l9.10"></a><span id="l9.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l9.13"></a><span id="l9.13"> #include &quot;nsISimpleEnumerator.idl&quot;</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-/*</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">- * This is the libpurple protocol</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">- */</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+#include &quot;imIAccount.idl&quot;</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-%{C++</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-#pragma GCC visibility push(default)</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-#include &lt;libpurple/prpl.h&gt;</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-#pragma GCC visibility pop</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-%}</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+[scriptable, uuid(7d302db0-3813-4c51-8372-c7eb5fc9f3d3)]</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+interface prplIProtocol: nsISupports {</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+  // aId is the prpl id, this method is used so that classes</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+  // implementing several protocol plugins can know which protocol is</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+  // desired for this instance.</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+  void init(in AUTF8String aId);</span>
<a href="#l9.31"></a><span id="l9.31"> </span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-[ptr] native PurpleNativePluginProtocolInfo(PurplePluginProtocolInfo);</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-interface purpleIAccount;</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-[scriptable, uuid(0a51b511-4ce7-4f4c-a109-43023b72fc5a)]</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-interface purpleIProtocol: nsISupports {</span>
<a href="#l9.37"></a><span id="l9.37">   readonly attribute AUTF8String name;</span>
<a href="#l9.38"></a><span id="l9.38">   readonly attribute AUTF8String id;</span>
<a href="#l9.39"></a><span id="l9.39">   readonly attribute AUTF8String normalizedName;</span>
<a href="#l9.40"></a><span id="l9.40"> </span>
<a href="#l9.41"></a><span id="l9.41">   // returns a chrome URI pointing to a folder that contains the files:</span>
<a href="#l9.42"></a><span id="l9.42">   // icon.png icon32.png and icon48.png</span>
<a href="#l9.43"></a><span id="l9.43">   readonly attribute AUTF8String iconBaseURI;</span>
<a href="#l9.44"></a><span id="l9.44"> </span>
<a href="#l9.45"></a><span id="l9.45" class="difflineat">@@ -118,27 +111,23 @@ interface purpleIProtocol: nsISupports {</span>
<a href="#l9.46"></a><span id="l9.46">   // are native to this protocol.</span>
<a href="#l9.47"></a><span id="l9.47">   // Used as a hint that unknown commands should not be sent as messages.</span>
<a href="#l9.48"></a><span id="l9.48">   readonly attribute boolean slashCommandsNative;</span>
<a href="#l9.49"></a><span id="l9.49"> </span>
<a href="#l9.50"></a><span id="l9.50">   // Indicates if the protocol plugin can use a purpleIProxy for the</span>
<a href="#l9.51"></a><span id="l9.51">   // account, or uses the Mozilla proxy settings for all accounts.</span>
<a href="#l9.52"></a><span id="l9.52">   readonly attribute boolean usePurpleProxy;</span>
<a href="#l9.53"></a><span id="l9.53"> </span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-  // The key is the unique identifier needed to get account data</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-  // stored in the preferences.</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-  purpleIAccount getAccount(in AUTF8String aKey, in AUTF8String aName);</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+  // Get the protocol specific part of an already initialized</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+  // imIAccount instance.</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+  prplIAccount getAccount(in imIAccount aImAccount);</span>
<a href="#l9.60"></a><span id="l9.60"> };</span>
<a href="#l9.61"></a><span id="l9.61"> </span>
<a href="#l9.62"></a><span id="l9.62"> [scriptable, uuid(20c4971a-f7c2-4781-8e85-69fee7b83a3d)]</span>
<a href="#l9.63"></a><span id="l9.63"> interface purpleIUsernameSplit: nsISupports {</span>
<a href="#l9.64"></a><span id="l9.64">   readonly attribute AUTF8String label;</span>
<a href="#l9.65"></a><span id="l9.65">   readonly attribute AUTF8String defaultValue;</span>
<a href="#l9.66"></a><span id="l9.66">   readonly attribute char separator;</span>
<a href="#l9.67"></a><span id="l9.67"> </span>
<a href="#l9.68"></a><span id="l9.68">   /* reverse is PR_TRUE if the separator should be found starting at</span>
<a href="#l9.69"></a><span id="l9.69">      the end of the string, PR_FALSE otherwise. */</span>
<a href="#l9.70"></a><span id="l9.70">   readonly attribute PRBool reverse;</span>
<a href="#l9.71"></a><span id="l9.71"> };</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineminus">-</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-%{C++</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-#define JS_PROTOCOL_PLUGIN_CATEGORY &quot;js-protocol-plugin&quot;</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-%}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/chat/components/public/purpleIConversation.idl</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/chat/components/public/purpleIConversation.idl</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -36,32 +36,32 @@</span>
<a href="#l10.4"></a><span id="l10.4">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6"> </span>
<a href="#l10.7"></a><span id="l10.7"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l10.8"></a><span id="l10.8"> #include &quot;nsISimpleEnumerator.idl&quot;</span>
<a href="#l10.9"></a><span id="l10.9"> #include &quot;nsIObserver.idl&quot;</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11"> interface imIAccountBuddy;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-interface purpleIAccount;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+interface imIAccount;</span>
<a href="#l10.14"></a><span id="l10.14"> interface nsIURI;</span>
<a href="#l10.15"></a><span id="l10.15"> interface nsIDOMDocument;</span>
<a href="#l10.16"></a><span id="l10.16"> </span>
<a href="#l10.17"></a><span id="l10.17"> /*</span>
<a href="#l10.18"></a><span id="l10.18">  * This is the XPCOM purple conversation component, a proxy for PurpleConversation.</span>
<a href="#l10.19"></a><span id="l10.19">  */</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21"> [scriptable, uuid(74fca337-b8e7-4e5d-81cd-8aba3dba9208)]</span>
<a href="#l10.22"></a><span id="l10.22"> interface purpleIConversation: nsISupports {</span>
<a href="#l10.23"></a><span id="l10.23"> </span>
<a href="#l10.24"></a><span id="l10.24">   /* Indicate if this conversation implements purpleIConvIM or purpleIConvChat */</span>
<a href="#l10.25"></a><span id="l10.25">   readonly attribute boolean isChat;</span>
<a href="#l10.26"></a><span id="l10.26"> </span>
<a href="#l10.27"></a><span id="l10.27">   /* The account used for this conversation */</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-  readonly attribute purpleIAccount account;</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+  readonly attribute imIAccount account;</span>
<a href="#l10.30"></a><span id="l10.30"> </span>
<a href="#l10.31"></a><span id="l10.31">   /* The name of the conversation, typically in English */</span>
<a href="#l10.32"></a><span id="l10.32">   readonly attribute AUTF8String name;</span>
<a href="#l10.33"></a><span id="l10.33"> </span>
<a href="#l10.34"></a><span id="l10.34">   /* The normalized name of the conversation (suitable for a log file name) */</span>
<a href="#l10.35"></a><span id="l10.35">   readonly attribute AUTF8String normalizedName;</span>
<a href="#l10.36"></a><span id="l10.36"> </span>
<a href="#l10.37"></a><span id="l10.37">   /* The title of the conversation, typically localized */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/chat/components/src/Makefile.in</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/chat/components/src/Makefile.in</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -37,20 +37,23 @@</span>
<a href="#l11.4"></a><span id="l11.4"> DEPTH		= ../../..</span>
<a href="#l11.5"></a><span id="l11.5"> topsrcdir	= @top_srcdir@</span>
<a href="#l11.6"></a><span id="l11.6"> srcdir		= @srcdir@</span>
<a href="#l11.7"></a><span id="l11.7"> VPATH		= @srcdir@</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11"> EXTRA_COMPONENTS = \</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+		imAccounts.manifest \</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+		imCommands.js imCommands.manifest \</span>
<a href="#l11.14"></a><span id="l11.14"> 		imContacts.js imContacts.manifest \</span>
<a href="#l11.15"></a><span id="l11.15"> 		imConversations.js imConversations.manifest \</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-		imCommands.js imCommands.manifest \</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+		imCore.js imCore.manifest \</span>
<a href="#l11.18"></a><span id="l11.18"> 		logger.manifest \</span>
<a href="#l11.19"></a><span id="l11.19"> 		smileProtocolHandler.js smileProtocolHandler.manifest \</span>
<a href="#l11.20"></a><span id="l11.20"> 		$(NULL)</span>
<a href="#l11.21"></a><span id="l11.21"> </span>
<a href="#l11.22"></a><span id="l11.22"> EXTRA_PP_COMPONENTS = \</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+		imAccounts.js \</span>
<a href="#l11.24"></a><span id="l11.24"> 		logger.js \</span>
<a href="#l11.25"></a><span id="l11.25"> 		$(NULL)</span>
<a href="#l11.26"></a><span id="l11.26"> </span>
<a href="#l11.27"></a><span id="l11.27"> include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/chat/components/src/imAccounts.js</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,741 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+ *</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+ *</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+ * License.</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+ *</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+ * The Original Code is the Instantbird messenging client, released</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+ * 2011.</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+ *</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+ * Florian QUEZE &lt;florian@instantbird.org&gt;.</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+ *</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+ *   Romain Bezut &lt;romain@bezut.info&gt;</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+ *</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+ *</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+const {classes: Cc, interfaces: Ci, utils: Cu, results: Cr} = Components;</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+Cu.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+const kPrefAutologinPending = &quot;messenger.accounts.autoLoginPending&quot;;</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+const kPrefMessengerAccounts = &quot;messenger.accounts&quot;;</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+const kPrefAccountPrefix = &quot;messenger.account.&quot;;</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+const kAccountKeyPrefix = &quot;account&quot;;</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+const kAccountOptionPrefPrefix = &quot;options.&quot;;</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+const kPrefAccountName = &quot;name&quot;;</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+const kPrefAccountPrpl = &quot;prpl&quot;;</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+const kPrefAccountPassword = &quot;password&quot;;</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+const kPrefAccountAutoLogin = &quot;autoLogin&quot;;</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+const kPrefAccountAlias = &quot;alias&quot;;</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+const kPrefAccountFirstConnectionState = &quot;firstConnectionState&quot;;</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+var SavePrefTimer = {</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+  saveNow: function() {</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+    if (this._timer) {</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+      clearTimeout(this._timer);</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+      this._timer = null;</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+    }</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+    Services.prefs.savePrefFile(null);</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+  },</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+  _timer: null,</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+  unInitTimer: function() {</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+    if (this._timer)</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineplus">+      this.saveNow();</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineplus">+  },</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+  initTimer: function() {</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+    if (!this._timer)</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+      this._timer = setTimeout(this.saveNow.bind(this), 5000);</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+  }</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+};</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+var AutoLoginCounter = {</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+  _count: 0,</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+  startAutoLogin: function() {</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+    ++this._count;</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+    if (this._count != 1)</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+      return;</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+    Services.prefs.setIntPref(kPrefAutologinPending, Date.now() / 1000);</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+    SavePrefTimer.saveNow();</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+  },</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+  finishedAutoLogin: function() {</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+    --this._count;</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+    if (this._count != 0)</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+      return;</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+    Services.prefs.deleteBranch(kPrefAutologinPending);</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+    SavePrefTimer.initTimer();</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+  }</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+};</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+function UnknownProtocol(aPrplId)</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+{</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineplus">+  this.id = aPrplId;</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineplus">+}</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineplus">+UnknownProtocol.prototype = {</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineplus">+  __proto__: ClassInfo(&quot;prplIProtocol&quot;, &quot;Unknown protocol&quot;),</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineplus">+  get name() &quot;&quot;,</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineplus">+  get normalizedName() this.name,</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+  get iconBaseURI() &quot;chrome://instantbird/skin/prpl-unknown/&quot;,</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineplus">+  getOptions: function() EmptyEnumerator,</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+  getUsernameSplit: function() EmptyEnumerator,</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+  get usernameEmptyText() &quot;&quot;,</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineplus">+  getAccount: function(aKey, aName) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineplus">+  accountExists: function() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineplus">+</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+  // false seems an acceptable default for all options</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineplus">+  // (they should never be called anyway).</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineplus">+  get uniqueChatName() false,</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineplus">+  get chatHasTopic() false,</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineplus">+  get noPassword() false,</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineplus">+  get newMailNotification() false,</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+  get imagesInIM() false,</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineplus">+  get passwordOptional() true,</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineplus">+  get usePointSize() true,</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineplus">+  get registerNoScreenName() false,</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineplus">+  get slashCommandsNative() false,</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineplus">+  get usePurpleProxy() false</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineplus">+};</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineplus">+</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineplus">+// aName and aPrplId are provided as parameter only if this is a new</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineplus">+// account that doesn't exist in the preferences. In this case, these</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineplus">+// 2 values should be stored.</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineplus">+function imAccount(aKey, aName, aPrplId)</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineplus">+{</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineplus">+  if (aKey.indexOf(kAccountKeyPrefix) != 0)</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineplus">+    throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineplus">+</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineplus">+  this.id = aKey;</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineplus">+  this.numericId = parseInt(aKey.substr(kAccountKeyPrefix.length));</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineplus">+  this.prefBranch = Services.prefs.getBranch(kPrefAccountPrefix + aKey + &quot;.&quot;);</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineplus">+</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineplus">+  if (aName) {</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineplus">+    this.name = aName;</span>
<a href="#l12.140"></a><span id="l12.140" class="difflineplus">+    this.prefBranch.setCharPref(kPrefAccountName, aName);</span>
<a href="#l12.141"></a><span id="l12.141" class="difflineplus">+    this.firstConnectionState = Ci.imIAccount.FIRST_CONNECTION_UNKNOWN;</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineplus">+  }</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineplus">+  else</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineplus">+    this.name = this.prefBranch.getCharPref(kPrefAccountName);</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineplus">+</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineplus">+  let prplId = aPrplId;</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineplus">+  if (prplId)</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineplus">+    this.prefBranch.setCharPref(kPrefAccountPrpl, prplId);</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineplus">+  else</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineplus">+    prplId = this.prefBranch.getCharPref(kPrefAccountPrpl);</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineplus">+</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineplus">+  // Get the protocol plugin, or fallback to an UnknownProtocol instance.</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+  this.protocol = Services.core.getProtocolById(prplId);</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineplus">+  if (!this.protocol) {</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineplus">+    this.protocol = new UnknownProtocol(prplId);</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineplus">+    this._connectionErrorReason = Ci.imIAccount.ERROR_UNKNOWN_PRPL;</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineplus">+    return;</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineplus">+  }</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineplus">+</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineplus">+  // Ensure the account is correctly stored in blist.sqlite.</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineplus">+  Services.contacts.storeAccount(this.numericId, this.name, prplId);</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineplus">+</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineplus">+  // Get the prplIAccount from the protocol plugin.</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineplus">+  this.prplAccount = this.protocol.getAccount(this);</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineplus">+</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineplus">+  // Send status change notifications to the account.</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineplus">+  this.observedStatusInfo = null; // (To execute the setter).</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineplus">+</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineplus">+  // If we have never finished the first connection attempt for this account,</span>
<a href="#l12.170"></a><span id="l12.170" class="difflineplus">+  // mark the account as having caused a crash.</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineplus">+  if (this.firstConnectionState == Ci.imIAccount.FIRST_CONNECTION_PENDING)</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineplus">+    this.firstConnectionState = Ci.imIAccount.FIRST_CONNECTION_CRASHED;</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineplus">+</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineplus">+  // Check for errors that should prevent connection attempts.</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineplus">+  if (this._passwordRequired &amp;&amp; !this.password)</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineplus">+    this._connectionErrorReason = Ci.imIAccount.ERROR_MISSING_PASSWORD;</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineplus">+  else if (this.firstConnectionState == Ci.imIAccount.FIRST_CONNECTION_CRASHED)</span>
<a href="#l12.178"></a><span id="l12.178" class="difflineplus">+    this._connectionErrorReason = Ci.imIAccount.ERROR_CRASHED;</span>
<a href="#l12.179"></a><span id="l12.179" class="difflineplus">+}</span>
<a href="#l12.180"></a><span id="l12.180" class="difflineplus">+</span>
<a href="#l12.181"></a><span id="l12.181" class="difflineplus">+imAccount.prototype = {</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineplus">+  __proto__: ClassInfo([&quot;imIAccount&quot;, &quot;prplIAccount&quot;], &quot;im account object&quot;),</span>
<a href="#l12.183"></a><span id="l12.183" class="difflineplus">+</span>
<a href="#l12.184"></a><span id="l12.184" class="difflineplus">+  name: &quot;&quot;,</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineplus">+  id: &quot;&quot;,</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineplus">+  numericId: 0,</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineplus">+  protocol: null,</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineplus">+  prplAccount: null,</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineplus">+  connectionState: Ci.imIAccount.STATE_DISCONNECTED,</span>
<a href="#l12.190"></a><span id="l12.190" class="difflineplus">+  connectionStateMsg: &quot;&quot;,</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineplus">+  connectionErrorMessage: &quot;&quot;,</span>
<a href="#l12.192"></a><span id="l12.192" class="difflineplus">+  _connectionErrorReason: Ci.prplIAccount.NO_ERROR,</span>
<a href="#l12.193"></a><span id="l12.193" class="difflineplus">+  get connectionErrorReason() {</span>
<a href="#l12.194"></a><span id="l12.194" class="difflineplus">+    if (this._connectionErrorReason != Ci.prplIAccount.NO_ERROR)</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineplus">+      return this._connectionErrorReason;</span>
<a href="#l12.196"></a><span id="l12.196" class="difflineplus">+    else</span>
<a href="#l12.197"></a><span id="l12.197" class="difflineplus">+      return this.prplAccount.connectionErrorReason;</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineplus">+  },</span>
<a href="#l12.199"></a><span id="l12.199" class="difflineplus">+</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineplus">+  observe: function(aSubject, aTopic, aData) {</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineplus">+    if (aTopic == &quot;account-connect-progress&quot;)</span>
<a href="#l12.202"></a><span id="l12.202" class="difflineplus">+      this.connectionStateMsg = aData;</span>
<a href="#l12.203"></a><span id="l12.203" class="difflineplus">+    else if (aTopic == &quot;account-connecting&quot;) {</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineplus">+      if (this.prplAccount.connectionErrorReason != Ci.prplIAccount.NO_ERROR) {</span>
<a href="#l12.205"></a><span id="l12.205" class="difflineplus">+        delete this.connectionErrorMessage;</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineplus">+        if (this.timeOfNextReconnect - Date.now() &gt; 1000) {</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineplus">+          // This is a manual reconnection, reset the auto-reconnect stuff</span>
<a href="#l12.208"></a><span id="l12.208" class="difflineplus">+          this.timeOfLastConnect = 0;</span>
<a href="#l12.209"></a><span id="l12.209" class="difflineplus">+          this.cancelReconnection();</span>
<a href="#l12.210"></a><span id="l12.210" class="difflineplus">+        }</span>
<a href="#l12.211"></a><span id="l12.211" class="difflineplus">+      }</span>
<a href="#l12.212"></a><span id="l12.212" class="difflineplus">+      if (this.firstConnectionState != Ci.imIAccount.FIRST_CONNECTION_OK)</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineplus">+        this.firstConnectionState = Ci.imIAccount.FIRST_CONNECTION_PENDING;</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineplus">+      this.connectionState = Ci.imIAccount.STATE_CONNECTING;</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineplus">+    }</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineplus">+    else if (aTopic == &quot;account-connected&quot;) {</span>
<a href="#l12.217"></a><span id="l12.217" class="difflineplus">+      this.connectionState = Ci.imIAccount.STATE_CONNECTED;</span>
<a href="#l12.218"></a><span id="l12.218" class="difflineplus">+      this._finishedAutoLogin();</span>
<a href="#l12.219"></a><span id="l12.219" class="difflineplus">+      this.timeOfLastConnect = Date.now();</span>
<a href="#l12.220"></a><span id="l12.220" class="difflineplus">+      if (this.firstConnectionState != Ci.imIAccount.FIRST_CONNECTION_OK)</span>
<a href="#l12.221"></a><span id="l12.221" class="difflineplus">+        this.firstConnectionState = Ci.imIAccount.FIRST_CONNECTION_OK;</span>
<a href="#l12.222"></a><span id="l12.222" class="difflineplus">+      delete this.connectionStateMsg;</span>
<a href="#l12.223"></a><span id="l12.223" class="difflineplus">+    }</span>
<a href="#l12.224"></a><span id="l12.224" class="difflineplus">+    else if (aTopic == &quot;account-disconnecting&quot;) {</span>
<a href="#l12.225"></a><span id="l12.225" class="difflineplus">+      this.connectionState = Ci.imIAccount.STATE_DISCONNECTING;</span>
<a href="#l12.226"></a><span id="l12.226" class="difflineplus">+      this.connectionErrorMessage = aData;</span>
<a href="#l12.227"></a><span id="l12.227" class="difflineplus">+      delete this.connectionStateMsg;</span>
<a href="#l12.228"></a><span id="l12.228" class="difflineplus">+      this._finishedAutoLogin();</span>
<a href="#l12.229"></a><span id="l12.229" class="difflineplus">+</span>
<a href="#l12.230"></a><span id="l12.230" class="difflineplus">+      let firstConnectionState = this.firstConnectionState;</span>
<a href="#l12.231"></a><span id="l12.231" class="difflineplus">+      if (firstConnectionState != Ci.imIAccount.FIRST_CONNECTION_OK &amp;&amp;</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineplus">+          firstConnectionState != Ci.imIAccount.FIRST_CONNECTION_CRASHED)</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineplus">+        this.firstConnectionState = Ci.imIAccount.FIRST_CONNECTION_UNKNOWN;</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineplus">+</span>
<a href="#l12.235"></a><span id="l12.235" class="difflineplus">+      let connectionErrorReason = this.prplAccount.connectionErrorReason;</span>
<a href="#l12.236"></a><span id="l12.236" class="difflineplus">+      if (connectionErrorReason != Ci.prplIAccount.NO_ERROR) {</span>
<a href="#l12.237"></a><span id="l12.237" class="difflineplus">+        if (connectionErrorReason == Ci.prplIAccount.ERROR_NETWORK_ERROR ||</span>
<a href="#l12.238"></a><span id="l12.238" class="difflineplus">+            connectionErrorReason == Ci.prplIAccount.ERROR_ENCRYPTION_ERROR)</span>
<a href="#l12.239"></a><span id="l12.239" class="difflineplus">+          this._startReconnectTimer();</span>
<a href="#l12.240"></a><span id="l12.240" class="difflineplus">+        this._sendNotification(&quot;account-connect-error&quot;);</span>
<a href="#l12.241"></a><span id="l12.241" class="difflineplus">+      }</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineplus">+    }</span>
<a href="#l12.243"></a><span id="l12.243" class="difflineplus">+    else if (aTopic == &quot;account-disconnected&quot;)</span>
<a href="#l12.244"></a><span id="l12.244" class="difflineplus">+      this.connectionState = Ci.imIAccount.STATE_DISCONNECTED;</span>
<a href="#l12.245"></a><span id="l12.245" class="difflineplus">+    else</span>
<a href="#l12.246"></a><span id="l12.246" class="difflineplus">+      throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l12.247"></a><span id="l12.247" class="difflineplus">+    this._sendNotification(aTopic, aData);</span>
<a href="#l12.248"></a><span id="l12.248" class="difflineplus">+  },</span>
<a href="#l12.249"></a><span id="l12.249" class="difflineplus">+</span>
<a href="#l12.250"></a><span id="l12.250" class="difflineplus">+  _observedStatusInfo: null,</span>
<a href="#l12.251"></a><span id="l12.251" class="difflineplus">+  get observedStatusInfo() this._observedStatusInfo,</span>
<a href="#l12.252"></a><span id="l12.252" class="difflineplus">+  _statusObserver: null,</span>
<a href="#l12.253"></a><span id="l12.253" class="difflineplus">+  set observedStatusInfo(aUserStatusInfo) {</span>
<a href="#l12.254"></a><span id="l12.254" class="difflineplus">+    if (!this.prplAccount)</span>
<a href="#l12.255"></a><span id="l12.255" class="difflineplus">+      return;</span>
<a href="#l12.256"></a><span id="l12.256" class="difflineplus">+    if (this._statusObserver)</span>
<a href="#l12.257"></a><span id="l12.257" class="difflineplus">+      this.statusInfo.removeObserver(this._statusObserver);</span>
<a href="#l12.258"></a><span id="l12.258" class="difflineplus">+    this._observedStatusInfo = aUserStatusInfo;</span>
<a href="#l12.259"></a><span id="l12.259" class="difflineplus">+    if (!this._statusObserver) {</span>
<a href="#l12.260"></a><span id="l12.260" class="difflineplus">+      let prplAccount = this.prplAccount;</span>
<a href="#l12.261"></a><span id="l12.261" class="difflineplus">+      this._statusObserver = {</span>
<a href="#l12.262"></a><span id="l12.262" class="difflineplus">+        observe: function(aSubject, aTopic, aData) {</span>
<a href="#l12.263"></a><span id="l12.263" class="difflineplus">+          prplAccount.observe(aSubject, aTopic, aData);</span>
<a href="#l12.264"></a><span id="l12.264" class="difflineplus">+        }</span>
<a href="#l12.265"></a><span id="l12.265" class="difflineplus">+      };</span>
<a href="#l12.266"></a><span id="l12.266" class="difflineplus">+    }</span>
<a href="#l12.267"></a><span id="l12.267" class="difflineplus">+    this.statusInfo.addObserver(this._statusObserver);</span>
<a href="#l12.268"></a><span id="l12.268" class="difflineplus">+  },</span>
<a href="#l12.269"></a><span id="l12.269" class="difflineplus">+  get statusInfo() this._observedStatusInfo || Services.core.globalUserStatus,</span>
<a href="#l12.270"></a><span id="l12.270" class="difflineplus">+</span>
<a href="#l12.271"></a><span id="l12.271" class="difflineplus">+  reconnectAttempt: 0,</span>
<a href="#l12.272"></a><span id="l12.272" class="difflineplus">+  timeOfLastConnect: 0,</span>
<a href="#l12.273"></a><span id="l12.273" class="difflineplus">+  timeOfNextReconnect: 0,</span>
<a href="#l12.274"></a><span id="l12.274" class="difflineplus">+  _reconnectTimer: null,</span>
<a href="#l12.275"></a><span id="l12.275" class="difflineplus">+  _startReconnectTimer: function() {</span>
<a href="#l12.276"></a><span id="l12.276" class="difflineplus">+    /* If the last successful connection is older than 10 seconds, reset the</span>
<a href="#l12.277"></a><span id="l12.277" class="difflineplus">+     number of reconnection attemps. */</span>
<a href="#l12.278"></a><span id="l12.278" class="difflineplus">+    const kTimeBeforeSuccessfulConnection = 10;</span>
<a href="#l12.279"></a><span id="l12.279" class="difflineplus">+    if (this.timeOfLastConnect &amp;&amp;</span>
<a href="#l12.280"></a><span id="l12.280" class="difflineplus">+        this.timeOfLastConnect + kTimeBeforeSuccessfulConnection * 1000 &lt; Date.now()) {</span>
<a href="#l12.281"></a><span id="l12.281" class="difflineplus">+      delete this.reconnectAttempt;</span>
<a href="#l12.282"></a><span id="l12.282" class="difflineplus">+      delete this.timeOfLastConnect;</span>
<a href="#l12.283"></a><span id="l12.283" class="difflineplus">+    }</span>
<a href="#l12.284"></a><span id="l12.284" class="difflineplus">+</span>
<a href="#l12.285"></a><span id="l12.285" class="difflineplus">+    let timers =</span>
<a href="#l12.286"></a><span id="l12.286" class="difflineplus">+      Services.prefs.getCharPref(&quot;messenger.accounts.reconnectTimer&quot;).split(&quot;,&quot;);</span>
<a href="#l12.287"></a><span id="l12.287" class="difflineplus">+    let delay = timers[Math.max(this.reconnectAttempt, timers.length - 1)];</span>
<a href="#l12.288"></a><span id="l12.288" class="difflineplus">+    let msDelay = parseInt(delay) * 1000;</span>
<a href="#l12.289"></a><span id="l12.289" class="difflineplus">+    ++this.reconnectAttempt;</span>
<a href="#l12.290"></a><span id="l12.290" class="difflineplus">+    this.timeOfNextReconnect = Date.now() + msDelay;</span>
<a href="#l12.291"></a><span id="l12.291" class="difflineplus">+    this._reconnectTimer = setTimeout(this.connect.bind(this), msDelay);</span>
<a href="#l12.292"></a><span id="l12.292" class="difflineplus">+  },</span>
<a href="#l12.293"></a><span id="l12.293" class="difflineplus">+</span>
<a href="#l12.294"></a><span id="l12.294" class="difflineplus">+  _sendNotification: function(aTopic, aData) {</span>
<a href="#l12.295"></a><span id="l12.295" class="difflineplus">+    Services.obs.notifyObservers(this, aTopic, aData);</span>
<a href="#l12.296"></a><span id="l12.296" class="difflineplus">+  },</span>
<a href="#l12.297"></a><span id="l12.297" class="difflineplus">+</span>
<a href="#l12.298"></a><span id="l12.298" class="difflineplus">+  get firstConnectionState() {</span>
<a href="#l12.299"></a><span id="l12.299" class="difflineplus">+    try {</span>
<a href="#l12.300"></a><span id="l12.300" class="difflineplus">+      return this.prefBranch.getIntPref(kPrefAccountFirstConnectionState);</span>
<a href="#l12.301"></a><span id="l12.301" class="difflineplus">+    } catch (e) {</span>
<a href="#l12.302"></a><span id="l12.302" class="difflineplus">+      return Ci.imIAccount.FIRST_CONNECTION_OK;</span>
<a href="#l12.303"></a><span id="l12.303" class="difflineplus">+    }</span>
<a href="#l12.304"></a><span id="l12.304" class="difflineplus">+  },</span>
<a href="#l12.305"></a><span id="l12.305" class="difflineplus">+  set firstConnectionState(aState) {</span>
<a href="#l12.306"></a><span id="l12.306" class="difflineplus">+    if (aState == Ci.imIAccount.FIRST_CONNECTION_OK)</span>
<a href="#l12.307"></a><span id="l12.307" class="difflineplus">+      this.prefBranch.deleteBranch(kPrefAccountFirstConnectionState);</span>
<a href="#l12.308"></a><span id="l12.308" class="difflineplus">+    else {</span>
<a href="#l12.309"></a><span id="l12.309" class="difflineplus">+      this.prefBranch.setIntPref(kPrefAccountFirstConnectionState, aState);</span>
<a href="#l12.310"></a><span id="l12.310" class="difflineplus">+      // We want to save this pref immediately when trying to connect.</span>
<a href="#l12.311"></a><span id="l12.311" class="difflineplus">+      if (aState == Ci.imIAccount.FIRST_CONNECTION_PENDING)</span>
<a href="#l12.312"></a><span id="l12.312" class="difflineplus">+        SavePrefTimer.saveNow();</span>
<a href="#l12.313"></a><span id="l12.313" class="difflineplus">+      else</span>
<a href="#l12.314"></a><span id="l12.314" class="difflineplus">+        SavePrefTimer.initTimer();</span>
<a href="#l12.315"></a><span id="l12.315" class="difflineplus">+    }</span>
<a href="#l12.316"></a><span id="l12.316" class="difflineplus">+  },</span>
<a href="#l12.317"></a><span id="l12.317" class="difflineplus">+</span>
<a href="#l12.318"></a><span id="l12.318" class="difflineplus">+  get normalizedName() this._ensurePrplAccount.normalizedName,</span>
<a href="#l12.319"></a><span id="l12.319" class="difflineplus">+</span>
<a href="#l12.320"></a><span id="l12.320" class="difflineplus">+  _sendUpdateNotification: function() {</span>
<a href="#l12.321"></a><span id="l12.321" class="difflineplus">+    this._sendNotification(&quot;account-updated&quot;);</span>
<a href="#l12.322"></a><span id="l12.322" class="difflineplus">+  },</span>
<a href="#l12.323"></a><span id="l12.323" class="difflineplus">+</span>
<a href="#l12.324"></a><span id="l12.324" class="difflineplus">+  set alias(val) {</span>
<a href="#l12.325"></a><span id="l12.325" class="difflineplus">+    if (val)</span>
<a href="#l12.326"></a><span id="l12.326" class="difflineplus">+      this.prefBranch.setCharPref(kPrefAccountAlias, val);</span>
<a href="#l12.327"></a><span id="l12.327" class="difflineplus">+    else</span>
<a href="#l12.328"></a><span id="l12.328" class="difflineplus">+      this.prefBranch.deleteBranch(kPrefAccountAlias);</span>
<a href="#l12.329"></a><span id="l12.329" class="difflineplus">+    this._sendUpdateNotification();</span>
<a href="#l12.330"></a><span id="l12.330" class="difflineplus">+  },</span>
<a href="#l12.331"></a><span id="l12.331" class="difflineplus">+  get alias() {</span>
<a href="#l12.332"></a><span id="l12.332" class="difflineplus">+    try {</span>
<a href="#l12.333"></a><span id="l12.333" class="difflineplus">+      return this.prefBranch.getCharPref(kPrefAccountAlias);</span>
<a href="#l12.334"></a><span id="l12.334" class="difflineplus">+    } catch (e) {</span>
<a href="#l12.335"></a><span id="l12.335" class="difflineplus">+      return &quot;&quot;;</span>
<a href="#l12.336"></a><span id="l12.336" class="difflineplus">+    }</span>
<a href="#l12.337"></a><span id="l12.337" class="difflineplus">+  },</span>
<a href="#l12.338"></a><span id="l12.338" class="difflineplus">+</span>
<a href="#l12.339"></a><span id="l12.339" class="difflineplus">+  get password() {</span>
<a href="#l12.340"></a><span id="l12.340" class="difflineplus">+    try {</span>
<a href="#l12.341"></a><span id="l12.341" class="difflineplus">+      return this.prefBranch.getCharPref(kPrefAccountPassword);</span>
<a href="#l12.342"></a><span id="l12.342" class="difflineplus">+    } catch (e) {</span>
<a href="#l12.343"></a><span id="l12.343" class="difflineplus">+      return &quot;&quot;;</span>
<a href="#l12.344"></a><span id="l12.344" class="difflineplus">+    }</span>
<a href="#l12.345"></a><span id="l12.345" class="difflineplus">+  },</span>
<a href="#l12.346"></a><span id="l12.346" class="difflineplus">+  get _passwordRequired()</span>
<a href="#l12.347"></a><span id="l12.347" class="difflineplus">+    !this.protocol.noPassword &amp;&amp; !this.protocol.passwordOptional,</span>
<a href="#l12.348"></a><span id="l12.348" class="difflineplus">+  set password(aPassword) {</span>
<a href="#l12.349"></a><span id="l12.349" class="difflineplus">+    this.prefBranch.setCharPref(kPrefAccountPassword, aPassword);</span>
<a href="#l12.350"></a><span id="l12.350" class="difflineplus">+    if (aPassword &amp;&amp;</span>
<a href="#l12.351"></a><span id="l12.351" class="difflineplus">+        this._connectionErrorReason == Ci.imIAccount.ERROR_MISSING_PASSWORD) {</span>
<a href="#l12.352"></a><span id="l12.352" class="difflineplus">+      if (this.firstConnectionState == Ci.imIAccount.FIRST_CONNECTION_CRASHED)</span>
<a href="#l12.353"></a><span id="l12.353" class="difflineplus">+        this._connectionErrorReason = Ci.imIAccount.ERROR_CRASHED;</span>
<a href="#l12.354"></a><span id="l12.354" class="difflineplus">+      else</span>
<a href="#l12.355"></a><span id="l12.355" class="difflineplus">+        this._connectionErrorReason = Ci.imIAccount.NO_ERROR;</span>
<a href="#l12.356"></a><span id="l12.356" class="difflineplus">+    }</span>
<a href="#l12.357"></a><span id="l12.357" class="difflineplus">+    else if (!aPassword &amp;&amp; this._passwordRequired)</span>
<a href="#l12.358"></a><span id="l12.358" class="difflineplus">+      this._connectionErrorReason = Ci.imIAccount.ERROR_MISSING_PASSWORD;</span>
<a href="#l12.359"></a><span id="l12.359" class="difflineplus">+    this._sendUpdateNotification();</span>
<a href="#l12.360"></a><span id="l12.360" class="difflineplus">+  },</span>
<a href="#l12.361"></a><span id="l12.361" class="difflineplus">+</span>
<a href="#l12.362"></a><span id="l12.362" class="difflineplus">+  get autoLogin() {</span>
<a href="#l12.363"></a><span id="l12.363" class="difflineplus">+    let autoLogin = true;</span>
<a href="#l12.364"></a><span id="l12.364" class="difflineplus">+    try {</span>
<a href="#l12.365"></a><span id="l12.365" class="difflineplus">+      autoLogin = this.prefBranch.getBoolPref(kPrefAccountAutoLogin);</span>
<a href="#l12.366"></a><span id="l12.366" class="difflineplus">+    } catch (e) { }</span>
<a href="#l12.367"></a><span id="l12.367" class="difflineplus">+    return autoLogin;</span>
<a href="#l12.368"></a><span id="l12.368" class="difflineplus">+  },</span>
<a href="#l12.369"></a><span id="l12.369" class="difflineplus">+  set autoLogin(val) {</span>
<a href="#l12.370"></a><span id="l12.370" class="difflineplus">+    this.prefBranch.setBoolPref(kPrefAccountAutoLogin, val);</span>
<a href="#l12.371"></a><span id="l12.371" class="difflineplus">+    SavePrefTimer.initTimer();</span>
<a href="#l12.372"></a><span id="l12.372" class="difflineplus">+    this._sendUpdateNotification();</span>
<a href="#l12.373"></a><span id="l12.373" class="difflineplus">+  },</span>
<a href="#l12.374"></a><span id="l12.374" class="difflineplus">+  _autoLoginPending: false,</span>
<a href="#l12.375"></a><span id="l12.375" class="difflineplus">+  checkAutoLogin: function() {</span>
<a href="#l12.376"></a><span id="l12.376" class="difflineplus">+    // No auto-login if: the account has an error at the imIAccount level</span>
<a href="#l12.377"></a><span id="l12.377" class="difflineplus">+    // (unknown protocol, missing password, first connection crashed),</span>
<a href="#l12.378"></a><span id="l12.378" class="difflineplus">+    // the account is already connected or connecting, or autoLogin is off.</span>
<a href="#l12.379"></a><span id="l12.379" class="difflineplus">+    if (this._connectionErrorReason != Ci.prplIAccount.NO_ERROR ||</span>
<a href="#l12.380"></a><span id="l12.380" class="difflineplus">+        this.connecting || this.connected || !this.autoLogin)</span>
<a href="#l12.381"></a><span id="l12.381" class="difflineplus">+      return;</span>
<a href="#l12.382"></a><span id="l12.382" class="difflineplus">+</span>
<a href="#l12.383"></a><span id="l12.383" class="difflineplus">+    this._autoLoginPending = true;</span>
<a href="#l12.384"></a><span id="l12.384" class="difflineplus">+    AutoLoginCounter.startAutoLogin();</span>
<a href="#l12.385"></a><span id="l12.385" class="difflineplus">+    try {</span>
<a href="#l12.386"></a><span id="l12.386" class="difflineplus">+      this.connect();</span>
<a href="#l12.387"></a><span id="l12.387" class="difflineplus">+    } catch (e) {</span>
<a href="#l12.388"></a><span id="l12.388" class="difflineplus">+      Cu.reportError(e);</span>
<a href="#l12.389"></a><span id="l12.389" class="difflineplus">+      this._finishedAutoLogin();</span>
<a href="#l12.390"></a><span id="l12.390" class="difflineplus">+    }</span>
<a href="#l12.391"></a><span id="l12.391" class="difflineplus">+  },</span>
<a href="#l12.392"></a><span id="l12.392" class="difflineplus">+  _finishedAutoLogin: function() {</span>
<a href="#l12.393"></a><span id="l12.393" class="difflineplus">+    if (!this.hasOwnProperty(&quot;_autoLoginPending&quot;))</span>
<a href="#l12.394"></a><span id="l12.394" class="difflineplus">+      return;</span>
<a href="#l12.395"></a><span id="l12.395" class="difflineplus">+    delete this._autoLoginPending;</span>
<a href="#l12.396"></a><span id="l12.396" class="difflineplus">+    AutoLoginCounter.finishedAutoLogin();</span>
<a href="#l12.397"></a><span id="l12.397" class="difflineplus">+  },</span>
<a href="#l12.398"></a><span id="l12.398" class="difflineplus">+</span>
<a href="#l12.399"></a><span id="l12.399" class="difflineplus">+  remove: function() {</span>
<a href="#l12.400"></a><span id="l12.400" class="difflineplus">+    this.unInit();</span>
<a href="#l12.401"></a><span id="l12.401" class="difflineplus">+    Services.contacts.forgetAccount(this.numericId);</span>
<a href="#l12.402"></a><span id="l12.402" class="difflineplus">+    this.prefBranch.deleteBranch(&quot;&quot;);</span>
<a href="#l12.403"></a><span id="l12.403" class="difflineplus">+  },</span>
<a href="#l12.404"></a><span id="l12.404" class="difflineplus">+  unInit: function() {</span>
<a href="#l12.405"></a><span id="l12.405" class="difflineplus">+    // remove any pending reconnection timer.</span>
<a href="#l12.406"></a><span id="l12.406" class="difflineplus">+    this.cancelReconnection();</span>
<a href="#l12.407"></a><span id="l12.407" class="difflineplus">+</span>
<a href="#l12.408"></a><span id="l12.408" class="difflineplus">+    // remove any pending autologin preference used for crash detection.</span>
<a href="#l12.409"></a><span id="l12.409" class="difflineplus">+    this._finishedAutoLogin();</span>
<a href="#l12.410"></a><span id="l12.410" class="difflineplus">+</span>
<a href="#l12.411"></a><span id="l12.411" class="difflineplus">+    // If the first connection was pending on quit, we set it back to unknown.</span>
<a href="#l12.412"></a><span id="l12.412" class="difflineplus">+    if (this.firstConnectionState == Ci.imIAccount.FIRST_CONNECTION_PENDING)</span>
<a href="#l12.413"></a><span id="l12.413" class="difflineplus">+      this.firstConnectionState = Ci.imIAccount.FIRST_CONNECTION_UNKNOWN;</span>
<a href="#l12.414"></a><span id="l12.414" class="difflineplus">+</span>
<a href="#l12.415"></a><span id="l12.415" class="difflineplus">+    // and make sure we cleanup the save pref timer.</span>
<a href="#l12.416"></a><span id="l12.416" class="difflineplus">+    SavePrefTimer.unInitTimer();</span>
<a href="#l12.417"></a><span id="l12.417" class="difflineplus">+</span>
<a href="#l12.418"></a><span id="l12.418" class="difflineplus">+    if (this.prplAccount)</span>
<a href="#l12.419"></a><span id="l12.419" class="difflineplus">+      this.prplAccount.unInit();</span>
<a href="#l12.420"></a><span id="l12.420" class="difflineplus">+</span>
<a href="#l12.421"></a><span id="l12.421" class="difflineplus">+    delete this.protocol;</span>
<a href="#l12.422"></a><span id="l12.422" class="difflineplus">+    delete this.prplAccount;</span>
<a href="#l12.423"></a><span id="l12.423" class="difflineplus">+  },</span>
<a href="#l12.424"></a><span id="l12.424" class="difflineplus">+</span>
<a href="#l12.425"></a><span id="l12.425" class="difflineplus">+  get _ensurePrplAccount() {</span>
<a href="#l12.426"></a><span id="l12.426" class="difflineplus">+    if (this.prplAccount)</span>
<a href="#l12.427"></a><span id="l12.427" class="difflineplus">+      return this.prplAccount;</span>
<a href="#l12.428"></a><span id="l12.428" class="difflineplus">+    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.429"></a><span id="l12.429" class="difflineplus">+  },</span>
<a href="#l12.430"></a><span id="l12.430" class="difflineplus">+  connect: function() { this._ensurePrplAccount.connect(); },</span>
<a href="#l12.431"></a><span id="l12.431" class="difflineplus">+  disconnect: function() { this._ensurePrplAccount.disconnect(); },</span>
<a href="#l12.432"></a><span id="l12.432" class="difflineplus">+</span>
<a href="#l12.433"></a><span id="l12.433" class="difflineplus">+  get disconnected() this.connectionState == Ci.imIAccount.STATE_DISCONNECTED,</span>
<a href="#l12.434"></a><span id="l12.434" class="difflineplus">+  get connected() this.connectionState == Ci.imIAccount.STATE_CONNECTED,</span>
<a href="#l12.435"></a><span id="l12.435" class="difflineplus">+  get connecting() this.connectionState == Ci.imIAccount.STATE_CONNECTING,</span>
<a href="#l12.436"></a><span id="l12.436" class="difflineplus">+  get disconnecting() this.connectionState == Ci.imIAccount.STATE_DISCONNECTING,</span>
<a href="#l12.437"></a><span id="l12.437" class="difflineplus">+</span>
<a href="#l12.438"></a><span id="l12.438" class="difflineplus">+  cancelReconnection: function() {</span>
<a href="#l12.439"></a><span id="l12.439" class="difflineplus">+    if (this._reconnectTimer) {</span>
<a href="#l12.440"></a><span id="l12.440" class="difflineplus">+      clearTimeout(this._reconnectTimer);</span>
<a href="#l12.441"></a><span id="l12.441" class="difflineplus">+      delete this._reconnectTimer;</span>
<a href="#l12.442"></a><span id="l12.442" class="difflineplus">+    }</span>
<a href="#l12.443"></a><span id="l12.443" class="difflineplus">+    delete this.reconnectAttempt;</span>
<a href="#l12.444"></a><span id="l12.444" class="difflineplus">+    delete this.timeOfNextReconnect;</span>
<a href="#l12.445"></a><span id="l12.445" class="difflineplus">+  },</span>
<a href="#l12.446"></a><span id="l12.446" class="difflineplus">+  createConversation: function(aName)</span>
<a href="#l12.447"></a><span id="l12.447" class="difflineplus">+    this._ensurePrplAccount.createConversation(aName),</span>
<a href="#l12.448"></a><span id="l12.448" class="difflineplus">+  addBuddy: function(aTag, aName) {</span>
<a href="#l12.449"></a><span id="l12.449" class="difflineplus">+    this._ensurePrplAccount.addBuddy(aTag, aName);</span>
<a href="#l12.450"></a><span id="l12.450" class="difflineplus">+  },</span>
<a href="#l12.451"></a><span id="l12.451" class="difflineplus">+  loadBuddy: function(aBuddy, aTag)</span>
<a href="#l12.452"></a><span id="l12.452" class="difflineplus">+    this._ensurePrplAccount.loadBuddy(aBuddy, aTag), // FIXME for unknown proto</span>
<a href="#l12.453"></a><span id="l12.453" class="difflineplus">+  requestBuddyInfo: function(aBuddyName) {</span>
<a href="#l12.454"></a><span id="l12.454" class="difflineplus">+    this._ensurePrplAccount.requestBuddyInfo(aBuddyName);</span>
<a href="#l12.455"></a><span id="l12.455" class="difflineplus">+  },</span>
<a href="#l12.456"></a><span id="l12.456" class="difflineplus">+  getChatRoomFields: function() this._ensurePrplAccount.getChatRoomFields(),</span>
<a href="#l12.457"></a><span id="l12.457" class="difflineplus">+  getChatRoomDefaultFieldValues: function(aDefaultChatName)</span>
<a href="#l12.458"></a><span id="l12.458" class="difflineplus">+    this._ensurePrplAccount.getChatRoomDefaultFieldValues(aDefaultChatName),</span>
<a href="#l12.459"></a><span id="l12.459" class="difflineplus">+  get canJoinChat() this.prplAccount ? this.prplAccount.canJoinChat : false,</span>
<a href="#l12.460"></a><span id="l12.460" class="difflineplus">+  joinChat: function(aComponents) {</span>
<a href="#l12.461"></a><span id="l12.461" class="difflineplus">+    this._ensurePrplAccount.joinChat(aComponents);</span>
<a href="#l12.462"></a><span id="l12.462" class="difflineplus">+  },</span>
<a href="#l12.463"></a><span id="l12.463" class="difflineplus">+  setBool: function(aName, aVal) {</span>
<a href="#l12.464"></a><span id="l12.464" class="difflineplus">+    this.prefBranch.setBoolPref(kAccountOptionPrefPrefix + aName, aVal);</span>
<a href="#l12.465"></a><span id="l12.465" class="difflineplus">+    if (this.prplAccount)</span>
<a href="#l12.466"></a><span id="l12.466" class="difflineplus">+      this.prplAccount.setBool(aName, aVal);</span>
<a href="#l12.467"></a><span id="l12.467" class="difflineplus">+    SavePrefTimer.initTimer();</span>
<a href="#l12.468"></a><span id="l12.468" class="difflineplus">+  },</span>
<a href="#l12.469"></a><span id="l12.469" class="difflineplus">+  setInt: function(aName, aVal) {</span>
<a href="#l12.470"></a><span id="l12.470" class="difflineplus">+    this.prefBranch.setIntPref(kAccountOptionPrefPrefix + aName, aVal);</span>
<a href="#l12.471"></a><span id="l12.471" class="difflineplus">+    if (this.prplAccount)</span>
<a href="#l12.472"></a><span id="l12.472" class="difflineplus">+      this.prplAccount.setInt(aName, aVal);</span>
<a href="#l12.473"></a><span id="l12.473" class="difflineplus">+    SavePrefTimer.initTimer();</span>
<a href="#l12.474"></a><span id="l12.474" class="difflineplus">+  },</span>
<a href="#l12.475"></a><span id="l12.475" class="difflineplus">+  setString: function(aName, aVal) {</span>
<a href="#l12.476"></a><span id="l12.476" class="difflineplus">+    this.prefBranch.setCharPref(kAccountOptionPrefPrefix + aName, aVal);</span>
<a href="#l12.477"></a><span id="l12.477" class="difflineplus">+    if (this.prplAccount)</span>
<a href="#l12.478"></a><span id="l12.478" class="difflineplus">+      this.prplAccount.setString(aName, aVal);</span>
<a href="#l12.479"></a><span id="l12.479" class="difflineplus">+    SavePrefTimer.initTimer();</span>
<a href="#l12.480"></a><span id="l12.480" class="difflineplus">+  },</span>
<a href="#l12.481"></a><span id="l12.481" class="difflineplus">+  save: function() { SavePrefTimer.saveNow(); },</span>
<a href="#l12.482"></a><span id="l12.482" class="difflineplus">+</span>
<a href="#l12.483"></a><span id="l12.483" class="difflineplus">+  get HTMLEnabled() this._ensurePrplAccount.HTMLEnabled,</span>
<a href="#l12.484"></a><span id="l12.484" class="difflineplus">+  get noBackgroundColors() this._ensurePrplAccount.noBackgroundColors,</span>
<a href="#l12.485"></a><span id="l12.485" class="difflineplus">+  get autoResponses() this._ensurePrplAccount.autoResponses,</span>
<a href="#l12.486"></a><span id="l12.486" class="difflineplus">+  get singleFormatting() this._ensurePrplAccount.singleFormatting,</span>
<a href="#l12.487"></a><span id="l12.487" class="difflineplus">+  get noNewlines() this._ensurePrplAccount.noNewlines,</span>
<a href="#l12.488"></a><span id="l12.488" class="difflineplus">+  get noFontSizes() this._ensurePrplAccount.noFontSizes,</span>
<a href="#l12.489"></a><span id="l12.489" class="difflineplus">+  get noUrlDesc() this._ensurePrplAccount.noUrlDesc,</span>
<a href="#l12.490"></a><span id="l12.490" class="difflineplus">+  get noImages() this._ensurePrplAccount.noImages,</span>
<a href="#l12.491"></a><span id="l12.491" class="difflineplus">+  get maxMessageLength() this._ensurePrplAccount.maxMessageLength,</span>
<a href="#l12.492"></a><span id="l12.492" class="difflineplus">+</span>
<a href="#l12.493"></a><span id="l12.493" class="difflineplus">+  get proxyInfo() this._ensurePrplAccount.proxyInfo,</span>
<a href="#l12.494"></a><span id="l12.494" class="difflineplus">+  set proxyInfo(val) { this._ensurePrplAccount.proxyInfo = val; }</span>
<a href="#l12.495"></a><span id="l12.495" class="difflineplus">+};</span>
<a href="#l12.496"></a><span id="l12.496" class="difflineplus">+</span>
<a href="#l12.497"></a><span id="l12.497" class="difflineplus">+function AccountsService() { }</span>
<a href="#l12.498"></a><span id="l12.498" class="difflineplus">+AccountsService.prototype = {</span>
<a href="#l12.499"></a><span id="l12.499" class="difflineplus">+  initAccounts: function() {</span>
<a href="#l12.500"></a><span id="l12.500" class="difflineplus">+    this._initAutoLoginStatus();</span>
<a href="#l12.501"></a><span id="l12.501" class="difflineplus">+    this._accounts = [];</span>
<a href="#l12.502"></a><span id="l12.502" class="difflineplus">+    this._accountsById = {};</span>
<a href="#l12.503"></a><span id="l12.503" class="difflineplus">+    for each (let account in this._accountList.split(&quot;,&quot;)) {</span>
<a href="#l12.504"></a><span id="l12.504" class="difflineplus">+      try {</span>
<a href="#l12.505"></a><span id="l12.505" class="difflineplus">+        account.trim();</span>
<a href="#l12.506"></a><span id="l12.506" class="difflineplus">+        if (!account)</span>
<a href="#l12.507"></a><span id="l12.507" class="difflineplus">+          throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l12.508"></a><span id="l12.508" class="difflineplus">+        let newAccount = new imAccount(account);</span>
<a href="#l12.509"></a><span id="l12.509" class="difflineplus">+        this._accounts.push(newAccount);</span>
<a href="#l12.510"></a><span id="l12.510" class="difflineplus">+        this._accountsById[newAccount.numericId] = newAccount;</span>
<a href="#l12.511"></a><span id="l12.511" class="difflineplus">+      } catch (e) {</span>
<a href="#l12.512"></a><span id="l12.512" class="difflineplus">+        Cu.reportError(e);</span>
<a href="#l12.513"></a><span id="l12.513" class="difflineplus">+        dump(e + &quot; &quot; + e.toSource() + &quot;\n&quot;);</span>
<a href="#l12.514"></a><span id="l12.514" class="difflineplus">+      }</span>
<a href="#l12.515"></a><span id="l12.515" class="difflineplus">+    }</span>
<a href="#l12.516"></a><span id="l12.516" class="difflineplus">+</span>
<a href="#l12.517"></a><span id="l12.517" class="difflineplus">+    this._prefObserver = this.observe.bind(this);</span>
<a href="#l12.518"></a><span id="l12.518" class="difflineplus">+    Services.prefs.addObserver(kPrefMessengerAccounts, this._prefObserver, false);</span>
<a href="#l12.519"></a><span id="l12.519" class="difflineplus">+  },</span>
<a href="#l12.520"></a><span id="l12.520" class="difflineplus">+</span>
<a href="#l12.521"></a><span id="l12.521" class="difflineplus">+  _observingAccountListChange: true,</span>
<a href="#l12.522"></a><span id="l12.522" class="difflineplus">+  _prefObserver: null,</span>
<a href="#l12.523"></a><span id="l12.523" class="difflineplus">+  observe: function(aSubject, aTopic, aData) {</span>
<a href="#l12.524"></a><span id="l12.524" class="difflineplus">+    if (aTopic != &quot;nsPref:changed&quot; || aData != kPrefMessengerAccounts ||</span>
<a href="#l12.525"></a><span id="l12.525" class="difflineplus">+       !this._observingAccountListChange)</span>
<a href="#l12.526"></a><span id="l12.526" class="difflineplus">+      return;</span>
<a href="#l12.527"></a><span id="l12.527" class="difflineplus">+</span>
<a href="#l12.528"></a><span id="l12.528" class="difflineplus">+    this._accounts =</span>
<a href="#l12.529"></a><span id="l12.529" class="difflineplus">+      this._accountList.split(&quot;,&quot;).map(String.trim)</span>
<a href="#l12.530"></a><span id="l12.530" class="difflineplus">+          .filter(function (k) k.indexOf(kAccountKeyPrefix) == 0)</span>
<a href="#l12.531"></a><span id="l12.531" class="difflineplus">+          .map(function (k) parseInt(k.substr(kAccountKeyPrefix.length)))</span>
<a href="#l12.532"></a><span id="l12.532" class="difflineplus">+          .map(this.getAccountByNumericId, this)</span>
<a href="#l12.533"></a><span id="l12.533" class="difflineplus">+          .filter(function (a) a);</span>
<a href="#l12.534"></a><span id="l12.534" class="difflineplus">+</span>
<a href="#l12.535"></a><span id="l12.535" class="difflineplus">+    Services.obs.notifyObservers(this, &quot;account-list-updated&quot;, null);</span>
<a href="#l12.536"></a><span id="l12.536" class="difflineplus">+  },</span>
<a href="#l12.537"></a><span id="l12.537" class="difflineplus">+</span>
<a href="#l12.538"></a><span id="l12.538" class="difflineplus">+  get _accountList() Services.prefs.getCharPref(kPrefMessengerAccounts),</span>
<a href="#l12.539"></a><span id="l12.539" class="difflineplus">+  set _accountList(aNewList) {</span>
<a href="#l12.540"></a><span id="l12.540" class="difflineplus">+    this._observingAccountListChange = false;</span>
<a href="#l12.541"></a><span id="l12.541" class="difflineplus">+    Services.prefs.setCharPref(kPrefMessengerAccounts, aNewList);</span>
<a href="#l12.542"></a><span id="l12.542" class="difflineplus">+    delete this._observingAccountListChange;</span>
<a href="#l12.543"></a><span id="l12.543" class="difflineplus">+  },</span>
<a href="#l12.544"></a><span id="l12.544" class="difflineplus">+</span>
<a href="#l12.545"></a><span id="l12.545" class="difflineplus">+  unInitAccounts: function() {</span>
<a href="#l12.546"></a><span id="l12.546" class="difflineplus">+    for each (let account in this._accounts)</span>
<a href="#l12.547"></a><span id="l12.547" class="difflineplus">+      account.unInit();</span>
<a href="#l12.548"></a><span id="l12.548" class="difflineplus">+    delete this._accounts;</span>
<a href="#l12.549"></a><span id="l12.549" class="difflineplus">+    delete this._accountsById;</span>
<a href="#l12.550"></a><span id="l12.550" class="difflineplus">+    Services.prefs.removeObserver(kPrefMessengerAccounts, this._prefObserver);</span>
<a href="#l12.551"></a><span id="l12.551" class="difflineplus">+    delete this._prefObserver;</span>
<a href="#l12.552"></a><span id="l12.552" class="difflineplus">+  },</span>
<a href="#l12.553"></a><span id="l12.553" class="difflineplus">+</span>
<a href="#l12.554"></a><span id="l12.554" class="difflineplus">+  autoLoginStatus: Ci.imIAccountsService.AUTOLOGIN_ENABLED,</span>
<a href="#l12.555"></a><span id="l12.555" class="difflineplus">+  _initAutoLoginStatus: function() {</span>
<a href="#l12.556"></a><span id="l12.556" class="difflineplus">+    /* If auto-login is already disabled, do nothing */</span>
<a href="#l12.557"></a><span id="l12.557" class="difflineplus">+    if (this.autoLoginStatus != Ci.imIAccountsService.AUTOLOGIN_ENABLED)</span>
<a href="#l12.558"></a><span id="l12.558" class="difflineplus">+      return;</span>
<a href="#l12.559"></a><span id="l12.559" class="difflineplus">+</span>
<a href="#l12.560"></a><span id="l12.560" class="difflineplus">+    let prefs = Services.prefs;</span>
<a href="#l12.561"></a><span id="l12.561" class="difflineplus">+    if (!prefs.getIntPref(&quot;messenger.startup.action&quot;)) {</span>
<a href="#l12.562"></a><span id="l12.562" class="difflineplus">+      // the value 0 means that we start without connecting the accounts</span>
<a href="#l12.563"></a><span id="l12.563" class="difflineplus">+      this.autoLoginStatus = Ci.imIAccountsService.AUTOLOGIN_USER_DISABLED;</span>
<a href="#l12.564"></a><span id="l12.564" class="difflineplus">+      return;</span>
<a href="#l12.565"></a><span id="l12.565" class="difflineplus">+    }</span>
<a href="#l12.566"></a><span id="l12.566" class="difflineplus">+</span>
<a href="#l12.567"></a><span id="l12.567" class="difflineplus">+    /* Disable auto-login if we are running in safe mode */</span>
<a href="#l12.568"></a><span id="l12.568" class="difflineplus">+    if (Services.appinfo.inSafeMode) {</span>
<a href="#l12.569"></a><span id="l12.569" class="difflineplus">+      this.autoLoginStatus = Ci.imIAccountsService.AUTOLOGIN_SAFE_MODE;</span>
<a href="#l12.570"></a><span id="l12.570" class="difflineplus">+      return;</span>
<a href="#l12.571"></a><span id="l12.571" class="difflineplus">+    }</span>
<a href="#l12.572"></a><span id="l12.572" class="difflineplus">+</span>
<a href="#l12.573"></a><span id="l12.573" class="difflineplus">+    /* If the application was started offline, disable auto-login */</span>
<a href="#l12.574"></a><span id="l12.574" class="difflineplus">+    if (!Services.io.manageOfflineStatus &amp;&amp; Services.io.offline) {</span>
<a href="#l12.575"></a><span id="l12.575" class="difflineplus">+      this.autoLoginStatus = Ci.imIAccountsService.AUTOLOGIN_START_OFFLINE;</span>
<a href="#l12.576"></a><span id="l12.576" class="difflineplus">+      return;</span>
<a href="#l12.577"></a><span id="l12.577" class="difflineplus">+    }</span>
<a href="#l12.578"></a><span id="l12.578" class="difflineplus">+</span>
<a href="#l12.579"></a><span id="l12.579" class="difflineplus">+    /* Check if we crashed at the last startup during autologin */</span>
<a href="#l12.580"></a><span id="l12.580" class="difflineplus">+    let autoLoginPending;</span>
<a href="#l12.581"></a><span id="l12.581" class="difflineplus">+    if (prefs.getPrefType(kPrefAutologinPending) == prefs.PREF_INVALID ||</span>
<a href="#l12.582"></a><span id="l12.582" class="difflineplus">+        !(autoLoginPending = prefs.getIntPref(kPrefAutologinPending))) {</span>
<a href="#l12.583"></a><span id="l12.583" class="difflineplus">+      // if the pref isn't set, then we haven't crashed: keep autologin enabled</span>
<a href="#l12.584"></a><span id="l12.584" class="difflineplus">+      return;</span>
<a href="#l12.585"></a><span id="l12.585" class="difflineplus">+    }</span>
<a href="#l12.586"></a><span id="l12.586" class="difflineplus">+</span>
<a href="#l12.587"></a><span id="l12.587" class="difflineplus">+    // Last autologin hasn't finished properly.</span>
<a href="#l12.588"></a><span id="l12.588" class="difflineplus">+    // For now, assume it's because of a crash.</span>
<a href="#l12.589"></a><span id="l12.589" class="difflineplus">+    this.autoLoginStatus = Ci.imIAccountsService.AUTOLOGIN_CRASH;</span>
<a href="#l12.590"></a><span id="l12.590" class="difflineplus">+    prefs.deleteBranch(kPrefAutologinPending);</span>
<a href="#l12.591"></a><span id="l12.591" class="difflineplus">+</span>
<a href="#l12.592"></a><span id="l12.592" class="difflineplus">+#ifdef MOZ_CRASHREPORTER</span>
<a href="#l12.593"></a><span id="l12.593" class="difflineplus">+    try {</span>
<a href="#l12.594"></a><span id="l12.594" class="difflineplus">+      // Try to get more info with breakpad</span>
<a href="#l12.595"></a><span id="l12.595" class="difflineplus">+      let lastCrashTime = 0;</span>
<a href="#l12.596"></a><span id="l12.596" class="difflineplus">+</span>
<a href="#l12.597"></a><span id="l12.597" class="difflineplus">+      /* Locate the LastCrash file */</span>
<a href="#l12.598"></a><span id="l12.598" class="difflineplus">+      let lastCrash =</span>
<a href="#l12.599"></a><span id="l12.599" class="difflineplus">+        Cc[&quot;@mozilla.org/file/directory_service;1&quot;].getService(Ci.nsIProperties)</span>
<a href="#l12.600"></a><span id="l12.600" class="difflineplus">+        .get(&quot;UAppData&quot;, Ci.nsILocalFile);</span>
<a href="#l12.601"></a><span id="l12.601" class="difflineplus">+      lastCrash.append(&quot;Crash Reports&quot;);</span>
<a href="#l12.602"></a><span id="l12.602" class="difflineplus">+      lastCrash.append(&quot;LastCrash&quot;);</span>
<a href="#l12.603"></a><span id="l12.603" class="difflineplus">+      if (lastCrash.exists()) {</span>
<a href="#l12.604"></a><span id="l12.604" class="difflineplus">+        /* Ok, the file exists, now let's try to read it */</span>
<a href="#l12.605"></a><span id="l12.605" class="difflineplus">+        let is = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l12.606"></a><span id="l12.606" class="difflineplus">+                 .createInstance(Ci.nsIFileInputStream);</span>
<a href="#l12.607"></a><span id="l12.607" class="difflineplus">+        let sis = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l12.608"></a><span id="l12.608" class="difflineplus">+                  .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l12.609"></a><span id="l12.609" class="difflineplus">+        is.init(lastCrash, -1, 0, 0);</span>
<a href="#l12.610"></a><span id="l12.610" class="difflineplus">+        sstream.init(sis);</span>
<a href="#l12.611"></a><span id="l12.611" class="difflineplus">+</span>
<a href="#l12.612"></a><span id="l12.612" class="difflineplus">+        lastCrashTime = parseInt(sstream.read(lastCrash.fileSize));</span>
<a href="#l12.613"></a><span id="l12.613" class="difflineplus">+</span>
<a href="#l12.614"></a><span id="l12.614" class="difflineplus">+        sstream.close();</span>
<a href="#l12.615"></a><span id="l12.615" class="difflineplus">+        fstream.close();</span>
<a href="#l12.616"></a><span id="l12.616" class="difflineplus">+      }</span>
<a href="#l12.617"></a><span id="l12.617" class="difflineplus">+      // The file not existing is totally acceptable, it just means that</span>
<a href="#l12.618"></a><span id="l12.618" class="difflineplus">+      // either we never crashed or breakpad is not enabled.</span>
<a href="#l12.619"></a><span id="l12.619" class="difflineplus">+      // In this case, lastCrashTime will keep its 0 initialization value.</span>
<a href="#l12.620"></a><span id="l12.620" class="difflineplus">+</span>
<a href="#l12.621"></a><span id="l12.621" class="difflineplus">+      /*dump(&quot;autoLoginPending = &quot; + autoLoginPending +</span>
<a href="#l12.622"></a><span id="l12.622" class="difflineplus">+             &quot;, lastCrash = &quot; + lastCrashTime +</span>
<a href="#l12.623"></a><span id="l12.623" class="difflineplus">+             &quot;, difference = &quot; + lastCrashTime - autoLoginPending + &quot;\n&quot;);*/</span>
<a href="#l12.624"></a><span id="l12.624" class="difflineplus">+</span>
<a href="#l12.625"></a><span id="l12.625" class="difflineplus">+      if (lastCrashTime &lt; autoLoginPending) {</span>
<a href="#l12.626"></a><span id="l12.626" class="difflineplus">+        // the last crash caught by breakpad is older than our last autologin</span>
<a href="#l12.627"></a><span id="l12.627" class="difflineplus">+        // attempt.</span>
<a href="#l12.628"></a><span id="l12.628" class="difflineplus">+        // If breakpad is currently enabled, we can be confident that</span>
<a href="#l12.629"></a><span id="l12.629" class="difflineplus">+        // autologin was interrupted for an exterior reason</span>
<a href="#l12.630"></a><span id="l12.630" class="difflineplus">+        // (application killed by the user, power outage, ...)</span>
<a href="#l12.631"></a><span id="l12.631" class="difflineplus">+        try {</span>
<a href="#l12.632"></a><span id="l12.632" class="difflineplus">+          Services.appinfo.QueryInterface(Ci.nsICrashReporter)</span>
<a href="#l12.633"></a><span id="l12.633" class="difflineplus">+                  .annotateCrashReport(&quot;=&quot;, &quot;&quot;);</span>
<a href="#l12.634"></a><span id="l12.634" class="difflineplus">+        } catch (e) {</span>
<a href="#l12.635"></a><span id="l12.635" class="difflineplus">+          // This should fail with NS_ERROR_INVALID_ARG if breakpad is enabled,</span>
<a href="#l12.636"></a><span id="l12.636" class="difflineplus">+          // and NS_ERROR_NOT_INITIALIZED if it is not.</span>
<a href="#l12.637"></a><span id="l12.637" class="difflineplus">+          if (e != Cr.NS_ERROR_NOT_INITIALIZED)</span>
<a href="#l12.638"></a><span id="l12.638" class="difflineplus">+            this.autoLoginStatus = Ci.imIAccountsService.AUTOLOGIN_ENABLED;</span>
<a href="#l12.639"></a><span id="l12.639" class="difflineplus">+        }</span>
<a href="#l12.640"></a><span id="l12.640" class="difflineplus">+      }</span>
<a href="#l12.641"></a><span id="l12.641" class="difflineplus">+    } catch (e) {</span>
<a href="#l12.642"></a><span id="l12.642" class="difflineplus">+      // if we failed to get the last crash time, then keep the</span>
<a href="#l12.643"></a><span id="l12.643" class="difflineplus">+      // AUTOLOGIN_CRASH value in mAutoLoginStatus and return.</span>
<a href="#l12.644"></a><span id="l12.644" class="difflineplus">+      return;</span>
<a href="#l12.645"></a><span id="l12.645" class="difflineplus">+    }</span>
<a href="#l12.646"></a><span id="l12.646" class="difflineplus">+#endif</span>
<a href="#l12.647"></a><span id="l12.647" class="difflineplus">+  },</span>
<a href="#l12.648"></a><span id="l12.648" class="difflineplus">+</span>
<a href="#l12.649"></a><span id="l12.649" class="difflineplus">+  processAutoLogin: function() {</span>
<a href="#l12.650"></a><span id="l12.650" class="difflineplus">+    if (Services.io.offline)</span>
<a href="#l12.651"></a><span id="l12.651" class="difflineplus">+      throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l12.652"></a><span id="l12.652" class="difflineplus">+</span>
<a href="#l12.653"></a><span id="l12.653" class="difflineplus">+    for each (let account in this._accounts)</span>
<a href="#l12.654"></a><span id="l12.654" class="difflineplus">+      account.checkAutoLogin();</span>
<a href="#l12.655"></a><span id="l12.655" class="difflineplus">+</span>
<a href="#l12.656"></a><span id="l12.656" class="difflineplus">+    // Make sure autologin is now enabled, so that we don't display a</span>
<a href="#l12.657"></a><span id="l12.657" class="difflineplus">+    // message stating that it is disabled and asking the user if it</span>
<a href="#l12.658"></a><span id="l12.658" class="difflineplus">+    // should be processed now.</span>
<a href="#l12.659"></a><span id="l12.659" class="difflineplus">+    this.autoLoginStatus = Ci.imIAccountsService.AUTOLOGIN_ENABLED;</span>
<a href="#l12.660"></a><span id="l12.660" class="difflineplus">+</span>
<a href="#l12.661"></a><span id="l12.661" class="difflineplus">+    // Notify observers so that any message stating that autologin is</span>
<a href="#l12.662"></a><span id="l12.662" class="difflineplus">+    // disabled can be removed</span>
<a href="#l12.663"></a><span id="l12.663" class="difflineplus">+    Services.observers(this, &quot;autologin-processed&quot;, null);</span>
<a href="#l12.664"></a><span id="l12.664" class="difflineplus">+  },</span>
<a href="#l12.665"></a><span id="l12.665" class="difflineplus">+</span>
<a href="#l12.666"></a><span id="l12.666" class="difflineplus">+  getAccountById: function(aAccountId) {</span>
<a href="#l12.667"></a><span id="l12.667" class="difflineplus">+    if (aAccountId.indexOf(kAccountKeyPrefix) != 0)</span>
<a href="#l12.668"></a><span id="l12.668" class="difflineplus">+      throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l12.669"></a><span id="l12.669" class="difflineplus">+</span>
<a href="#l12.670"></a><span id="l12.670" class="difflineplus">+    let id = parseInt(aAccountId.substr(kAccountKeyPrefix.length));</span>
<a href="#l12.671"></a><span id="l12.671" class="difflineplus">+    return this.getAccountByNumericId(id);</span>
<a href="#l12.672"></a><span id="l12.672" class="difflineplus">+  },</span>
<a href="#l12.673"></a><span id="l12.673" class="difflineplus">+</span>
<a href="#l12.674"></a><span id="l12.674" class="difflineplus">+  getAccountByNumericId: function(aAccountId) this._accountsById[aAccountId],</span>
<a href="#l12.675"></a><span id="l12.675" class="difflineplus">+  getAccounts: function() new nsSimpleEnumerator(this._accounts),</span>
<a href="#l12.676"></a><span id="l12.676" class="difflineplus">+</span>
<a href="#l12.677"></a><span id="l12.677" class="difflineplus">+  createAccount: function(aName, aPrpl) {</span>
<a href="#l12.678"></a><span id="l12.678" class="difflineplus">+    // Ensure an account with the same name and protocol doesn't already exist.</span>
<a href="#l12.679"></a><span id="l12.679" class="difflineplus">+    let prpl = Services.core.getProtocolById(aPrpl);</span>
<a href="#l12.680"></a><span id="l12.680" class="difflineplus">+    if (!prpl)</span>
<a href="#l12.681"></a><span id="l12.681" class="difflineplus">+      throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l12.682"></a><span id="l12.682" class="difflineplus">+    if (prpl.accountExists(aName)) {</span>
<a href="#l12.683"></a><span id="l12.683" class="difflineplus">+      Cu.reportError(&quot;Attempted to create a duplicate account!&quot;);</span>
<a href="#l12.684"></a><span id="l12.684" class="difflineplus">+      throw Cr.NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l12.685"></a><span id="l12.685" class="difflineplus">+    }</span>
<a href="#l12.686"></a><span id="l12.686" class="difflineplus">+</span>
<a href="#l12.687"></a><span id="l12.687" class="difflineplus">+    /* First get a unique id for the new account. */</span>
<a href="#l12.688"></a><span id="l12.688" class="difflineplus">+    let id;</span>
<a href="#l12.689"></a><span id="l12.689" class="difflineplus">+    let found = true;</span>
<a href="#l12.690"></a><span id="l12.690" class="difflineplus">+    for (id = 1; found; ++id) {</span>
<a href="#l12.691"></a><span id="l12.691" class="difflineplus">+      if (this._accountsById.hasOwnProperty(id))</span>
<a href="#l12.692"></a><span id="l12.692" class="difflineplus">+        continue;</span>
<a href="#l12.693"></a><span id="l12.693" class="difflineplus">+</span>
<a href="#l12.694"></a><span id="l12.694" class="difflineplus">+      /* id isn't used by a known account, double check it isn't</span>
<a href="#l12.695"></a><span id="l12.695" class="difflineplus">+       already used in the sqlite database. This should never</span>
<a href="#l12.696"></a><span id="l12.696" class="difflineplus">+       happen, except if we have a corrupted profile. */</span>
<a href="#l12.697"></a><span id="l12.697" class="difflineplus">+      found = Services.contacts.accountIdExists(id);</span>
<a href="#l12.698"></a><span id="l12.698" class="difflineplus">+      if (found)</span>
<a href="#l12.699"></a><span id="l12.699" class="difflineplus">+        Services.console.logStringMessage(&quot;No account &quot; + id + &quot; but there is some data in the buddy list for an account with this number. Your profile may be corrupted.&quot;);</span>
<a href="#l12.700"></a><span id="l12.700" class="difflineplus">+    }</span>
<a href="#l12.701"></a><span id="l12.701" class="difflineplus">+</span>
<a href="#l12.702"></a><span id="l12.702" class="difflineplus">+    /* Actually create the new account. */</span>
<a href="#l12.703"></a><span id="l12.703" class="difflineplus">+    let key = kAccountKeyPrefix + id;</span>
<a href="#l12.704"></a><span id="l12.704" class="difflineplus">+    let account = new imAccount(key, aName, aPrpl);</span>
<a href="#l12.705"></a><span id="l12.705" class="difflineplus">+</span>
<a href="#l12.706"></a><span id="l12.706" class="difflineplus">+    /* Keep it in the local account lists. */</span>
<a href="#l12.707"></a><span id="l12.707" class="difflineplus">+    this._accounts.push(account);</span>
<a href="#l12.708"></a><span id="l12.708" class="difflineplus">+    this._accountsById[id] = account;</span>
<a href="#l12.709"></a><span id="l12.709" class="difflineplus">+</span>
<a href="#l12.710"></a><span id="l12.710" class="difflineplus">+    /* Save the account list pref. */</span>
<a href="#l12.711"></a><span id="l12.711" class="difflineplus">+    let list = this._accountList;</span>
<a href="#l12.712"></a><span id="l12.712" class="difflineplus">+    this._accountList = list ? list + &quot;,&quot; + key : key;</span>
<a href="#l12.713"></a><span id="l12.713" class="difflineplus">+</span>
<a href="#l12.714"></a><span id="l12.714" class="difflineplus">+    Services.obs.notifyObservers(account, &quot;account-added&quot;, null);</span>
<a href="#l12.715"></a><span id="l12.715" class="difflineplus">+    return account;</span>
<a href="#l12.716"></a><span id="l12.716" class="difflineplus">+  },</span>
<a href="#l12.717"></a><span id="l12.717" class="difflineplus">+</span>
<a href="#l12.718"></a><span id="l12.718" class="difflineplus">+  deleteAccount: function(aAccountId) {</span>
<a href="#l12.719"></a><span id="l12.719" class="difflineplus">+    let account = this.getAccountById(aAccountId);</span>
<a href="#l12.720"></a><span id="l12.720" class="difflineplus">+    if (!account)</span>
<a href="#l12.721"></a><span id="l12.721" class="difflineplus">+      throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l12.722"></a><span id="l12.722" class="difflineplus">+</span>
<a href="#l12.723"></a><span id="l12.723" class="difflineplus">+    let index = this._accounts.indexOf(account);</span>
<a href="#l12.724"></a><span id="l12.724" class="difflineplus">+    if (index == -1)</span>
<a href="#l12.725"></a><span id="l12.725" class="difflineplus">+      throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l12.726"></a><span id="l12.726" class="difflineplus">+</span>
<a href="#l12.727"></a><span id="l12.727" class="difflineplus">+    let id = account.numericId;</span>
<a href="#l12.728"></a><span id="l12.728" class="difflineplus">+    Services.obs.notifyObservers(account, &quot;account-removed&quot;, null);</span>
<a href="#l12.729"></a><span id="l12.729" class="difflineplus">+    account.remove();</span>
<a href="#l12.730"></a><span id="l12.730" class="difflineplus">+    this._accounts.splice(index, 1);</span>
<a href="#l12.731"></a><span id="l12.731" class="difflineplus">+    delete this._accountsById[id];</span>
<a href="#l12.732"></a><span id="l12.732" class="difflineplus">+</span>
<a href="#l12.733"></a><span id="l12.733" class="difflineplus">+    /* Update the account list pref. */</span>
<a href="#l12.734"></a><span id="l12.734" class="difflineplus">+    let list = this._accountList;</span>
<a href="#l12.735"></a><span id="l12.735" class="difflineplus">+    this._accountList =</span>
<a href="#l12.736"></a><span id="l12.736" class="difflineplus">+      list.split(&quot;,&quot;).filter(function (k) k.trim() != aAccountId).join(&quot;,&quot;);</span>
<a href="#l12.737"></a><span id="l12.737" class="difflineplus">+  },</span>
<a href="#l12.738"></a><span id="l12.738" class="difflineplus">+</span>
<a href="#l12.739"></a><span id="l12.739" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI([Ci.imIAccountsService]),</span>
<a href="#l12.740"></a><span id="l12.740" class="difflineplus">+  classDescription: &quot;Accounts&quot;,</span>
<a href="#l12.741"></a><span id="l12.741" class="difflineplus">+  classID: Components.ID(&quot;{a94b5427-cd8d-40cf-b47e-b67671953e70}&quot;),</span>
<a href="#l12.742"></a><span id="l12.742" class="difflineplus">+  contractID: &quot;@instantbird.org/purple/accounts-service;1&quot;</span>
<a href="#l12.743"></a><span id="l12.743" class="difflineplus">+};</span>
<a href="#l12.744"></a><span id="l12.744" class="difflineplus">+</span>
<a href="#l12.745"></a><span id="l12.745" class="difflineplus">+const NSGetFactory = XPCOMUtils.generateNSGetFactory([AccountsService]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- /dev/null</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ b/chat/components/src/imAccounts.manifest</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -0,0 +1,2 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+component {a94b5427-cd8d-40cf-b47e-b67671953e70} imAccounts.js</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+contract @instantbird.org/purple/accounts-service;1 {a94b5427-cd8d-40cf-b47e-b67671953e70}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/chat/components/src/imCommands.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/chat/components/src/imCommands.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -146,17 +146,17 @@ CommandsService.prototype = {</span>
<a href="#l14.4"></a><span id="l14.4">         get helpString()</span>
<a href="#l14.5"></a><span id="l14.5">           bundle.formatStringFromName(&quot;statusCommand&quot;,</span>
<a href="#l14.6"></a><span id="l14.6">                                       [this.name,</span>
<a href="#l14.7"></a><span id="l14.7">                                        bundle.GetStringFromName(this.name)],</span>
<a href="#l14.8"></a><span id="l14.8">                                       2),</span>
<a href="#l14.9"></a><span id="l14.9">         usageContext: Ci.imICommand.CONTEXT_ALL,</span>
<a href="#l14.10"></a><span id="l14.10">         priority: Ci.imICommand.PRIORITY_HIGH,</span>
<a href="#l14.11"></a><span id="l14.11">         run: function(aMsg) {</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-          Services.core.setStatus(statusValue, aMsg);</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+          Services.core.globalUserStatus.setStatus(statusValue, aMsg);</span>
<a href="#l14.14"></a><span id="l14.14">           return true;</span>
<a href="#l14.15"></a><span id="l14.15">         }</span>
<a href="#l14.16"></a><span id="l14.16">       });</span>
<a href="#l14.17"></a><span id="l14.17">     }</span>
<a href="#l14.18"></a><span id="l14.18">   },</span>
<a href="#l14.19"></a><span id="l14.19">   unInitCommands: function() {</span>
<a href="#l14.20"></a><span id="l14.20">     delete this._commands;</span>
<a href="#l14.21"></a><span id="l14.21">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/chat/components/src/imContacts.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/chat/components/src/imContacts.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -34,48 +34,105 @@</span>
<a href="#l15.4"></a><span id="l15.4">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l15.5"></a><span id="l15.5">  *</span>
<a href="#l15.6"></a><span id="l15.6">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l15.7"></a><span id="l15.7"> </span>
<a href="#l15.8"></a><span id="l15.8"> const {classes: Cc, interfaces: Ci, utils: Cu} = Components;</span>
<a href="#l15.9"></a><span id="l15.9"> Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l15.10"></a><span id="l15.10"> Cu.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+var gDBConnection = null;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+function getDBConnection()</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+{</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+  const NS_APP_USER_PROFILE_50_DIR = &quot;ProfD&quot;;</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+  let dbFile =</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+    Cc[&quot;@mozilla.org/file/directory_service;1&quot;].getService(Ci.nsIProperties)</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+    .get(NS_APP_USER_PROFILE_50_DIR, Ci.nsIFile);</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+  dbFile.append(&quot;blist.sqlite&quot;);</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+  let conn =</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+    Cc[&quot;@mozilla.org/storage/service;1&quot;].getService(Ci.mozIStorageService)</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+                                        .openDatabase(dbFile);</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+  if (!conn.connectionReady)</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+    throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+  // Grow blist db in 512KB increments.</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+  conn.setGrowthIncrement(512 * 1024, &quot;&quot;);</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+  // Create tables and indexes.</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+  [</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+    &quot;CREATE TABLE IF NOT EXISTS accounts (&quot; +</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+      &quot;id INTEGER PRIMARY KEY, &quot; +</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+      &quot;name VARCHAR, &quot; +</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+      &quot;prpl VARCHAR)&quot;,</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+    &quot;CREATE TABLE IF NOT EXISTS contacts (&quot; +</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+      &quot;id INTEGER PRIMARY KEY, &quot; +</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+      &quot;firstname VARCHAR, &quot; +</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+      &quot;lastname VARCHAR, &quot; +</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+      &quot;alias VARCHAR)&quot;,</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+    &quot;CREATE TABLE IF NOT EXISTS buddies (&quot; +</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+      &quot;id INTEGER PRIMARY KEY, &quot; +</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+      &quot;key VARCHAR NOT NULL, &quot; +</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+      &quot;name VARCHAR NOT NULL, &quot; +</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+      &quot;srv_alias VARCHAR, &quot; +</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+      &quot;position INTEGER, &quot; +</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+      &quot;icon BLOB, &quot; +</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+      &quot;contact_id INTEGER)&quot;,</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+    &quot;CREATE INDEX IF NOT EXISTS buddies_contactindex &quot; +</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+      &quot;ON buddies (contact_id)&quot;,</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+    &quot;CREATE TABLE IF NOT EXISTS tags (&quot; +</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+      &quot;id INTEGER PRIMARY KEY, &quot; +</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+      &quot;name VARCHAR UNIQUE NOT NULL, &quot; +</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+      &quot;position INTEGER)&quot;,</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineplus">+    &quot;CREATE TABLE IF NOT EXISTS contact_tag (&quot; +</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineplus">+      &quot;contact_id INTEGER NOT NULL, &quot; +</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+      &quot;tag_id INTEGER NOT NULL)&quot;,</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineplus">+    &quot;CREATE INDEX IF NOT EXISTS contact_tag_contactindex &quot; +</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+      &quot;ON contact_tag (contact_id)&quot;,</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineplus">+    &quot;CREATE INDEX IF NOT EXISTS contact_tag_tagindex &quot; +</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+      &quot;ON contact_tag (tag_id)&quot;,</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineplus">+</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineplus">+    &quot;CREATE TABLE IF NOT EXISTS account_buddy (&quot; +</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+      &quot;account_id INTEGER NOT NULL, &quot; +</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+      &quot;buddy_id INTEGER NOT NULL, &quot; +</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineplus">+      &quot;status VARCHAR, &quot; +</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineplus">+      &quot;tag_id INTEGER)&quot;,</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineplus">+    &quot;CREATE INDEX IF NOT EXISTS account_buddy_accountindex &quot; +</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineplus">+      &quot;ON account_buddy (account_id)&quot;,</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+    &quot;CREATE INDEX IF NOT EXISTS account_buddy_buddyindex &quot; +</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+      &quot;ON account_buddy (buddy_id)&quot;</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineplus">+  ].forEach(conn.executeSimpleSQL);</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineplus">+  return conn;</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineplus">+}</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineplus">+</span>
<a href="#l15.82"></a><span id="l15.82"> // Wrap all the usage of DBConn inside a transaction that will be</span>
<a href="#l15.83"></a><span id="l15.83"> // commited automatically at the end of the event loop spin so that</span>
<a href="#l15.84"></a><span id="l15.84"> // we flush buddy list data to disk only once per event loop spin.</span>
<a href="#l15.85"></a><span id="l15.85"> var gDBConnWithPendingTransaction = null;</span>
<a href="#l15.86"></a><span id="l15.86"> this.__defineGetter__(&quot;DBConn&quot;, function() {</span>
<a href="#l15.87"></a><span id="l15.87">   if (gDBConnWithPendingTransaction)</span>
<a href="#l15.88"></a><span id="l15.88">     return gDBConnWithPendingTransaction;</span>
<a href="#l15.89"></a><span id="l15.89"> </span>
<a href="#l15.90"></a><span id="l15.90" class="difflineminus">-  let conn = Services.core.storageConnection;</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineminus">-  gDBConnWithPendingTransaction = conn;</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineminus">-  conn.beginTransaction();</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineplus">+  if (!gDBConnection)</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineplus">+    gDBConnection = getDBConnection();</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineplus">+  gDBConnWithPendingTransaction = gDBConnection;</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineplus">+  gDBConnection.beginTransaction();</span>
<a href="#l15.97"></a><span id="l15.97">   executeSoon(function() {</span>
<a href="#l15.98"></a><span id="l15.98">     gDBConnWithPendingTransaction.commitTransaction();</span>
<a href="#l15.99"></a><span id="l15.99">     gDBConnWithPendingTransaction = null;</span>
<a href="#l15.100"></a><span id="l15.100">   });</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineminus">-  return conn;</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineplus">+  return gDBConnection;</span>
<a href="#l15.103"></a><span id="l15.103"> });</span>
<a href="#l15.104"></a><span id="l15.104"> </span>
<a href="#l15.105"></a><span id="l15.105" class="difflineminus">-var AccountsById = { };</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineminus">-function getAccountById(aId) {</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineminus">-  if (AccountsById.hasOwnProperty(aId))</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineminus">-    return AccountsById[aId];</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineminus">-</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineminus">-  let account = null;</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineminus">-  try {</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineminus">-    account = Services.core.getAccountByNumericId(aId);</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineminus">-  } catch (x) { /* Not found */ }</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineminus">-</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineminus">-  AccountsById[aId] = account;</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineminus">-  return account;</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineminus">-}</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineminus">-</span>
<a href="#l15.119"></a><span id="l15.119"> function TagsService() { }</span>
<a href="#l15.120"></a><span id="l15.120"> TagsService.prototype = {</span>
<a href="#l15.121"></a><span id="l15.121">   get wrappedJSObject() this,</span>
<a href="#l15.122"></a><span id="l15.122">   createTag: function(aName) {</span>
<a href="#l15.123"></a><span id="l15.123">     // If the tag already exists, we don't want to create a duplicate.</span>
<a href="#l15.124"></a><span id="l15.124">     let tag = this.getTagByName(aName);</span>
<a href="#l15.125"></a><span id="l15.125">     if (tag)</span>
<a href="#l15.126"></a><span id="l15.126">       return tag;</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineat">@@ -1149,35 +1206,35 @@ ContactsService.prototype = {</span>
<a href="#l15.128"></a><span id="l15.128">     while (statement.executeStep())</span>
<a href="#l15.129"></a><span id="l15.129">       new Buddy(statement.getInt32(0), statement.getUTF8String(1),</span>
<a href="#l15.130"></a><span id="l15.130">                 statement.getUTF8String(2), statement.getUTF8String(3),</span>
<a href="#l15.131"></a><span id="l15.131">                 statement.getInt32(4));</span>
<a href="#l15.132"></a><span id="l15.132">     // FIXME is there a way to enforce that all AccountBuddies of a Buddy have the same protocol?</span>
<a href="#l15.133"></a><span id="l15.133"> </span>
<a href="#l15.134"></a><span id="l15.134">     statement = DBConn.createStatement(&quot;SELECT account_id, buddy_id, tag_id FROM account_buddy&quot;);</span>
<a href="#l15.135"></a><span id="l15.135">     while (statement.executeStep()) {</span>
<a href="#l15.136"></a><span id="l15.136" class="difflineminus">-      let account = getAccountById(statement.getInt32(0));</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineplus">+      let account =</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineplus">+        Services.accounts.getAccountByNumericId(statement.getInt32(0));</span>
<a href="#l15.139"></a><span id="l15.139">       let buddy = BuddiesById[statement.getInt32(1)];</span>
<a href="#l15.140"></a><span id="l15.140">       let tag = TagsById[statement.getInt32(2)];</span>
<a href="#l15.141"></a><span id="l15.141">       try {</span>
<a href="#l15.142"></a><span id="l15.142">         let ab = account.loadBuddy(buddy, tag);</span>
<a href="#l15.143"></a><span id="l15.143">         if (ab)</span>
<a href="#l15.144"></a><span id="l15.144">           buddy._addAccount(ab, tag);</span>
<a href="#l15.145"></a><span id="l15.145">       } catch (e) {</span>
<a href="#l15.146"></a><span id="l15.146">         // FIXME ab shouldn't be NULL (once purpleAccount is finished)</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineminus">-        // It currently doesn't work write with unknown protocols.</span>
<a href="#l15.148"></a><span id="l15.148" class="difflineplus">+        // It currently doesn't work right with unknown protocols.</span>
<a href="#l15.149"></a><span id="l15.149">         Components.utils.reportError(e);</span>
<a href="#l15.150"></a><span id="l15.150">         dump(e + &quot;\n&quot;);</span>
<a href="#l15.151"></a><span id="l15.151">       }</span>
<a href="#l15.152"></a><span id="l15.152">     }</span>
<a href="#l15.153"></a><span id="l15.153"> </span>
<a href="#l15.154"></a><span id="l15.154">     otherContactsTag._initHiddenTags();</span>
<a href="#l15.155"></a><span id="l15.155">   },</span>
<a href="#l15.156"></a><span id="l15.156">   unInitContacts: function() {</span>
<a href="#l15.157"></a><span id="l15.157" class="difflineminus">-    AccountsById = { };</span>
<a href="#l15.158"></a><span id="l15.158">     Tags = [];</span>
<a href="#l15.159"></a><span id="l15.159">     TagsById = { };</span>
<a href="#l15.160"></a><span id="l15.160">     // Avoid shutdown leaks caused by references to native components</span>
<a href="#l15.161"></a><span id="l15.161">     // implementing imIAccountBuddy.</span>
<a href="#l15.162"></a><span id="l15.162">     for each (let buddy in BuddiesById)</span>
<a href="#l15.163"></a><span id="l15.163">       buddy.destroy();</span>
<a href="#l15.164"></a><span id="l15.164">     BuddiesById = { };</span>
<a href="#l15.165"></a><span id="l15.165">     ContactsById = { };</span>
<a href="#l15.166"></a><span id="l15.166" class="difflineat">@@ -1261,16 +1318,55 @@ ContactsService.prototype = {</span>
<a href="#l15.167"></a><span id="l15.167">     statement.params.oldTagId = aOldTag.id;</span>
<a href="#l15.168"></a><span id="l15.168">     statement.params.newTagId = aNewTag.id;</span>
<a href="#l15.169"></a><span id="l15.169">     statement.execute();</span>
<a href="#l15.170"></a><span id="l15.170"> </span>
<a href="#l15.171"></a><span id="l15.171">     buddy.observe(aAccountBuddy, &quot;account-buddy-moved&quot;);</span>
<a href="#l15.172"></a><span id="l15.172">     ContactsById[buddy.contact.id]._moved(aOldTag, aNewTag);</span>
<a href="#l15.173"></a><span id="l15.173">   },</span>
<a href="#l15.174"></a><span id="l15.174"> </span>
<a href="#l15.175"></a><span id="l15.175" class="difflineplus">+  storeAccount: function(aId, aUserName, aPrplId) {</span>
<a href="#l15.176"></a><span id="l15.176" class="difflineplus">+    let statement =</span>
<a href="#l15.177"></a><span id="l15.177" class="difflineplus">+      DBConn.createStatement(&quot;SELECT name, prpl FROM accounts WHERE id = :id&quot;);</span>
<a href="#l15.178"></a><span id="l15.178" class="difflineplus">+    statement.params.id = aId;</span>
<a href="#l15.179"></a><span id="l15.179" class="difflineplus">+    if (statement.executeStep()) {</span>
<a href="#l15.180"></a><span id="l15.180" class="difflineplus">+      if (statement.getUTF8String(0) == aUserName &amp;&amp;</span>
<a href="#l15.181"></a><span id="l15.181" class="difflineplus">+          statement.getUTF8String(1) == aPrplId)</span>
<a href="#l15.182"></a><span id="l15.182" class="difflineplus">+        return; // The account is already stored correctly.</span>
<a href="#l15.183"></a><span id="l15.183" class="difflineplus">+      throw Cr.NS_ERROR_UNEXPECTED; // Corrupted database?!?</span>
<a href="#l15.184"></a><span id="l15.184" class="difflineplus">+    }</span>
<a href="#l15.185"></a><span id="l15.185" class="difflineplus">+</span>
<a href="#l15.186"></a><span id="l15.186" class="difflineplus">+    // Actually store the account.</span>
<a href="#l15.187"></a><span id="l15.187" class="difflineplus">+    statement = DBConn.createStatement(&quot;INSERT INTO accounts (id, name, prpl) &quot; +</span>
<a href="#l15.188"></a><span id="l15.188" class="difflineplus">+                                       &quot;VALUES(:id, :userName, :prplId)&quot;);</span>
<a href="#l15.189"></a><span id="l15.189" class="difflineplus">+    statement.params.id = aId;</span>
<a href="#l15.190"></a><span id="l15.190" class="difflineplus">+    statement.params.userName = aUserName;</span>
<a href="#l15.191"></a><span id="l15.191" class="difflineplus">+    statement.params.prplId = aPrplId;</span>
<a href="#l15.192"></a><span id="l15.192" class="difflineplus">+    statement.execute();</span>
<a href="#l15.193"></a><span id="l15.193" class="difflineplus">+  },</span>
<a href="#l15.194"></a><span id="l15.194" class="difflineplus">+  accountIdExists: function(aId) {</span>
<a href="#l15.195"></a><span id="l15.195" class="difflineplus">+    let statement =</span>
<a href="#l15.196"></a><span id="l15.196" class="difflineplus">+      DBConn.createStatement(&quot;SELECT id FROM accounts WHERE id = :id&quot;);</span>
<a href="#l15.197"></a><span id="l15.197" class="difflineplus">+    statement.params.id = aId;</span>
<a href="#l15.198"></a><span id="l15.198" class="difflineplus">+    return statement.executeStep();</span>
<a href="#l15.199"></a><span id="l15.199" class="difflineplus">+  },</span>
<a href="#l15.200"></a><span id="l15.200" class="difflineplus">+  forgetAccount: function(aId) {</span>
<a href="#l15.201"></a><span id="l15.201" class="difflineplus">+    let statement =</span>
<a href="#l15.202"></a><span id="l15.202" class="difflineplus">+      DBConn.createStatement(&quot;DELETE FROM accounts WHERE id = :accountId&quot;);</span>
<a href="#l15.203"></a><span id="l15.203" class="difflineplus">+    statement.params.accountId = aId;</span>
<a href="#l15.204"></a><span id="l15.204" class="difflineplus">+    statement.execute();</span>
<a href="#l15.205"></a><span id="l15.205" class="difflineplus">+</span>
<a href="#l15.206"></a><span id="l15.206" class="difflineplus">+    // removing the account from the accounts table is not enought,</span>
<a href="#l15.207"></a><span id="l15.207" class="difflineplus">+    // we need to remove all the associated account_buddy entries too</span>
<a href="#l15.208"></a><span id="l15.208" class="difflineplus">+    statement = DBConn.createStatement(&quot;DELETE FROM account_buddy &quot; +</span>
<a href="#l15.209"></a><span id="l15.209" class="difflineplus">+                                       &quot;WHERE account_id = :accountId&quot;);</span>
<a href="#l15.210"></a><span id="l15.210" class="difflineplus">+    statement.params.accountId = aId;</span>
<a href="#l15.211"></a><span id="l15.211" class="difflineplus">+    statement.execute();</span>
<a href="#l15.212"></a><span id="l15.212" class="difflineplus">+  },</span>
<a href="#l15.213"></a><span id="l15.213" class="difflineplus">+</span>
<a href="#l15.214"></a><span id="l15.214">   QueryInterface: XPCOMUtils.generateQI([Ci.imIContactsService]),</span>
<a href="#l15.215"></a><span id="l15.215">   classDescription: &quot;Contacts&quot;,</span>
<a href="#l15.216"></a><span id="l15.216">   classID: Components.ID(&quot;{8c3725dd-ee26-489d-8135-736015af8c7f}&quot;),</span>
<a href="#l15.217"></a><span id="l15.217">   contractID: &quot;@instantbird.org/purple/contacts-service;1&quot;</span>
<a href="#l15.218"></a><span id="l15.218"> };</span>
<a href="#l15.219"></a><span id="l15.219"> </span>
<a href="#l15.220"></a><span id="l15.220"> const NSGetFactory = XPCOMUtils.generateNSGetFactory([ContactsService,</span>
<a href="#l15.221"></a><span id="l15.221">                                                       TagsService]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/chat/components/src/imConversations.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/chat/components/src/imConversations.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -127,16 +127,17 @@ UIConversation.prototype = {</span>
<a href="#l16.4"></a><span id="l16.4">     if (this._observedContact) {</span>
<a href="#l16.5"></a><span id="l16.5">       this._observedContact.removeObserver(this);</span>
<a href="#l16.6"></a><span id="l16.6">       aContactId.value = this._observedContact.id;</span>
<a href="#l16.7"></a><span id="l16.7">       delete this._observedContact;</span>
<a href="#l16.8"></a><span id="l16.8">     }</span>
<a href="#l16.9"></a><span id="l16.9">     else</span>
<a href="#l16.10"></a><span id="l16.10">       aContactId.value = 0;</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+    delete this._currentTargetId;</span>
<a href="#l16.13"></a><span id="l16.13">     this.notifyObservers(this, &quot;ui-conversation-closed&quot;);</span>
<a href="#l16.14"></a><span id="l16.14">     Services.obs.notifyObservers(this, &quot;ui-conversation-closed&quot;, null);</span>
<a href="#l16.15"></a><span id="l16.15">     return true;</span>
<a href="#l16.16"></a><span id="l16.16">   },</span>
<a href="#l16.17"></a><span id="l16.17"> </span>
<a href="#l16.18"></a><span id="l16.18">   _unreadMessageCount: 0,</span>
<a href="#l16.19"></a><span id="l16.19">   get unreadMessageCount() this._unreadMessageCount,</span>
<a href="#l16.20"></a><span id="l16.20">   _unreadTargetedMessageCount: 0,</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineat">@@ -160,16 +161,19 @@ UIConversation.prototype = {</span>
<a href="#l16.22"></a><span id="l16.22">     this._lastNotifiedUnreadCount = this._unreadIncomingMessageCount;</span>
<a href="#l16.23"></a><span id="l16.23">   },</span>
<a href="#l16.24"></a><span id="l16.24">   getMessages: function(aMessageCount) {</span>
<a href="#l16.25"></a><span id="l16.25">     if (aMessageCount)</span>
<a href="#l16.26"></a><span id="l16.26">       aMessageCount.value = this._messages.length;</span>
<a href="#l16.27"></a><span id="l16.27">     return this._messages;</span>
<a href="#l16.28"></a><span id="l16.28">   },</span>
<a href="#l16.29"></a><span id="l16.29">   checkClose: function() {</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+    if (!this._currentTargetId)</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+      return true; // already closed.</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+</span>
<a href="#l16.33"></a><span id="l16.33">     if (!Services.prefs.getBoolPref(&quot;messenger.conversations.alwaysClose&quot;) &amp;&amp;</span>
<a href="#l16.34"></a><span id="l16.34">         (this.isChat &amp;&amp; !this.left ||</span>
<a href="#l16.35"></a><span id="l16.35">          !this.isChat &amp;&amp; this.unreadIncomingMessageCount != 0))</span>
<a href="#l16.36"></a><span id="l16.36">       return false;</span>
<a href="#l16.37"></a><span id="l16.37"> </span>
<a href="#l16.38"></a><span id="l16.38">     this.close();</span>
<a href="#l16.39"></a><span id="l16.39">     return true;</span>
<a href="#l16.40"></a><span id="l16.40">   },</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineat">@@ -282,16 +286,17 @@ UIConversation.prototype = {</span>
<a href="#l16.42"></a><span id="l16.42">   unInit: function() {</span>
<a href="#l16.43"></a><span id="l16.43">     for each (let conv in this._purpleConv)</span>
<a href="#l16.44"></a><span id="l16.44">       conv.unInit();</span>
<a href="#l16.45"></a><span id="l16.45">     this._purpleConv = {}; // Prevent .close from failing.</span>
<a href="#l16.46"></a><span id="l16.46">   },</span>
<a href="#l16.47"></a><span id="l16.47">   close: function() {</span>
<a href="#l16.48"></a><span id="l16.48">     for each (let conv in this._purpleConv)</span>
<a href="#l16.49"></a><span id="l16.49">       conv.close();</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+    delete this._currentTargetId;</span>
<a href="#l16.51"></a><span id="l16.51">     this.notifyObservers(this, &quot;ui-conversation-closed&quot;);</span>
<a href="#l16.52"></a><span id="l16.52">     Services.obs.notifyObservers(this, &quot;ui-conversation-closed&quot;, null);</span>
<a href="#l16.53"></a><span id="l16.53">   },</span>
<a href="#l16.54"></a><span id="l16.54">   addObserver: function(aObserver) {</span>
<a href="#l16.55"></a><span id="l16.55">     if (this._observers.indexOf(aObserver) == -1)</span>
<a href="#l16.56"></a><span id="l16.56">       this._observers.push(aObserver);</span>
<a href="#l16.57"></a><span id="l16.57">   },</span>
<a href="#l16.58"></a><span id="l16.58">   removeObserver: function(aObserver) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">new file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- /dev/null</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ b/chat/components/src/imCore.js</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -0,0 +1,368 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineplus">+ *</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+ *</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+ * License.</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+ *</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+ * The Original Code is the Instantbird messenging client, released</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+ * 2011.</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+ *</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+ * Florian QUEZE &lt;florian@instantbird.org&gt;.</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+ *</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+ *</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+ *</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+const {classes: Cc, interfaces: Ci, utils: Cu, results: Cr} = Components;</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+Cu.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(this, &quot;categoryManager&quot;,</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+                                   &quot;@mozilla.org/categorymanager;1&quot;,</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+                                   &quot;nsICategoryManager&quot;);</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineplus">+</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+const kQuitApplicationGranted = &quot;quit-application-granted&quot;;</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineplus">+const kProtocolPluginCategory = &quot;im-protocol-plugin&quot;;</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineplus">+</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineplus">+const kPrefReportIdle =        &quot;messenger.status.reportIdle&quot;;</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineplus">+const kPrefUserIconFilename =  &quot;messenger.status.userIconFileName&quot;;</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineplus">+const kPrefUserDisplayname =   &quot;messenger.status.userDisplayName&quot;;</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineplus">+const kPrefTimeBeforeIdle =    &quot;messenger.status.timeBeforeIdle&quot;;</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineplus">+const kPrefAwayWhenIdle =      &quot;messenger.status.awayWhenIdle&quot;;</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineplus">+const kPrefDefaultMessage =    &quot;messenger.status.defaultIdleAwayMessage&quot;;</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineplus">+</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineplus">+const NS_IOSERVICE_GOING_OFFLINE_TOPIC = &quot;network:offline-about-to-go-offline&quot;;</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineplus">+const NS_IOSERVICE_OFFLINE_STATUS_TOPIC = &quot;network:offline-status-changed&quot;;</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineplus">+</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineplus">+function UserStatus()</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineplus">+{</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineplus">+  this._observers = [];</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineplus">+</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineplus">+  if (Services.prefs.getBoolPref(kPrefReportIdle))</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineplus">+    this._addIdleObserver();</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineplus">+  Services.prefs.addObserver(kPrefReportIdle, this, false);</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineplus">+</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineplus">+  if (Services.io.offline)</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineplus">+    this._offline = true;</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+  Services.obs.addObserver(this, NS_IOSERVICE_GOING_OFFLINE_TOPIC, false);</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+  Services.obs.addObserver(this, NS_IOSERVICE_OFFLINE_STATUS_TOPIC, false);</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineplus">+}</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineplus">+UserStatus.prototype = {</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineplus">+  __proto__: ClassInfo(&quot;imIUserStatusInfo&quot;, &quot;User status info&quot;),</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineplus">+</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineplus">+  unInit: function() {</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineplus">+    this._observers = [];</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineplus">+    Services.prefs.removeObserver(kPrefReportIdle, this);</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineplus">+    if (this._observingIdleness)</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineplus">+      this._removeIdleObserver();</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineplus">+    Services.obs.removeObserver(this, NS_IOSERVICE_GOING_OFFLINE_TOPIC);</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineplus">+    Services.obs.removeObserver(this, NS_IOSERVICE_OFFLINE_STATUS_TOPIC);</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineplus">+  },</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineplus">+  _observingIdleness: false,</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineplus">+  _addIdleObserver: function() {</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineplus">+    this._observingIdleness = true;</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineplus">+    this._idleService =</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineplus">+      Cc[&quot;@mozilla.org/widget/idleservice;1&quot;].getService(Ci.nsIIdleService);</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineplus">+    Services.obs.addObserver(this, &quot;im-sent&quot;, false);</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineplus">+</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineplus">+    this._timeBeforeIdle = Services.prefs.getIntPref(kPrefTimeBeforeIdle);</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineplus">+    if (this._timeBeforeIdle &lt; 0)</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineplus">+      this._timeBeforeIdle = 0;</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineplus">+    Services.prefs.addObserver(kPrefTimeBeforeIdle, this, false);</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineplus">+    if (this._timeBeforeIdle)</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineplus">+      this._idleService.addIdleObserver(this, this._timeBeforeIdle);</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineplus">+  },</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineplus">+  _removeIdleObserver: function() {</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineplus">+    if (this._timeBeforeIdle)</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineplus">+      this._idleService.removeIdleObserver(this, this._timeBeforeIdle);</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineplus">+</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineplus">+    Services.prefs.removeObserver(kPrefTimeBeforeIdle, this);</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineplus">+    delete this._timeBeforeIdle;</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineplus">+</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineplus">+    Services.obs.removeObserver(this, &quot;im-sent&quot;);</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineplus">+    delete this._idleService;</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineplus">+    delete this._observingIdleness;</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineplus">+  },</span>
<a href="#l17.112"></a><span id="l17.112" class="difflineplus">+</span>
<a href="#l17.113"></a><span id="l17.113" class="difflineplus">+  observe: function(aSubject, aTopic, aData) {</span>
<a href="#l17.114"></a><span id="l17.114" class="difflineplus">+    if (aTopic == &quot;nsPref:changed&quot;) {</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineplus">+      if (aData == kPrefReportIdle) {</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineplus">+        let reportIdle = Services.prefs.getBoolPref(kPrefReportIdle);</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineplus">+        if (reportIdle &amp;&amp; !this._observingIdleness)</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineplus">+          this._addIdleObserver();</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineplus">+        else if (!reportIdle &amp;&amp; this._observingIdleness)</span>
<a href="#l17.120"></a><span id="l17.120" class="difflineplus">+        this._removeIdleObserver();</span>
<a href="#l17.121"></a><span id="l17.121" class="difflineplus">+      }</span>
<a href="#l17.122"></a><span id="l17.122" class="difflineplus">+      else if (aData == kPrefTimeBeforeIdle) {</span>
<a href="#l17.123"></a><span id="l17.123" class="difflineplus">+        let timeBeforeIdle = Services.prefs.getIntPref(kPrefTimeBeforeIdle);</span>
<a href="#l17.124"></a><span id="l17.124" class="difflineplus">+        if (timeBeforeIdle != this._timeBeforeIdle) {</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineplus">+          if (this._timeBeforeIdle)</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineplus">+            this._idleService.removeIdleObserver(this, this._timeBeforeIdle);</span>
<a href="#l17.127"></a><span id="l17.127" class="difflineplus">+          this._timeBeforeIdle = timeBeforeIdle;</span>
<a href="#l17.128"></a><span id="l17.128" class="difflineplus">+          if (this._timeBeforeIdle)</span>
<a href="#l17.129"></a><span id="l17.129" class="difflineplus">+            this._idleService.addIdleObserver(this, this._timeBeforeIdle);</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineplus">+        }</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineplus">+      }</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineplus">+      else</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineplus">+        throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l17.134"></a><span id="l17.134" class="difflineplus">+    }</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineplus">+    else if (aTopic == NS_IOSERVICE_GOING_OFFLINE_TOPIC)</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineplus">+      this._offline = true;</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineplus">+    else if (aTopic == NS_IOSERVICE_OFFLINE_STATUS_TOPIC &amp;&amp; aData == &quot;online&quot;)</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineplus">+      this._offline = false;</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineplus">+    else</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineplus">+      this._checkIdle();</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineplus">+  },</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineplus">+</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineplus">+  _offlineStatusType: Ci.imIStatusInfo.STATUS_AVAILABLE,</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineplus">+  set offline(aOffline) {</span>
<a href="#l17.145"></a><span id="l17.145" class="difflineplus">+    let statusType = this.statusType;</span>
<a href="#l17.146"></a><span id="l17.146" class="difflineplus">+    let statusText = this.statusText;</span>
<a href="#l17.147"></a><span id="l17.147" class="difflineplus">+    if (aOffline)</span>
<a href="#l17.148"></a><span id="l17.148" class="difflineplus">+      this._offlineStatusType = Ci.imIStatusInfo.STATUS_OFFLINE;</span>
<a href="#l17.149"></a><span id="l17.149" class="difflineplus">+    else</span>
<a href="#l17.150"></a><span id="l17.150" class="difflineplus">+      delete this._offlineStatusType;</span>
<a href="#l17.151"></a><span id="l17.151" class="difflineplus">+    if (this.statusType != statusType || this.statusText != statusText)</span>
<a href="#l17.152"></a><span id="l17.152" class="difflineplus">+      this._notifyObservers(&quot;status-changed&quot;, this.statusText);</span>
<a href="#l17.153"></a><span id="l17.153" class="difflineplus">+  },</span>
<a href="#l17.154"></a><span id="l17.154" class="difflineplus">+</span>
<a href="#l17.155"></a><span id="l17.155" class="difflineplus">+  _idleTime: 0,</span>
<a href="#l17.156"></a><span id="l17.156" class="difflineplus">+  get idleTime() this._idleTime,</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineplus">+  set idleTime(aIdleTime) {</span>
<a href="#l17.158"></a><span id="l17.158" class="difflineplus">+    this._idleTime = aIdleTime;</span>
<a href="#l17.159"></a><span id="l17.159" class="difflineplus">+    this._notifyObservers(&quot;idle-time-changed&quot;, aIdleTime);</span>
<a href="#l17.160"></a><span id="l17.160" class="difflineplus">+  },</span>
<a href="#l17.161"></a><span id="l17.161" class="difflineplus">+  _idle: false,</span>
<a href="#l17.162"></a><span id="l17.162" class="difflineplus">+  _idleStatusText: &quot;&quot;,</span>
<a href="#l17.163"></a><span id="l17.163" class="difflineplus">+  _idleStatusType: Ci.imIStatusInfo.STATUS_AVAILABLE,</span>
<a href="#l17.164"></a><span id="l17.164" class="difflineplus">+  _checkIdle: function() {</span>
<a href="#l17.165"></a><span id="l17.165" class="difflineplus">+    let idleTime = this._idleService.idleTime / 1000;</span>
<a href="#l17.166"></a><span id="l17.166" class="difflineplus">+    let idle = this._timeBeforeIdle &amp;&amp; idleTime &gt;= this._timeBeforeIdle;</span>
<a href="#l17.167"></a><span id="l17.167" class="difflineplus">+    if (idle == this._idle)</span>
<a href="#l17.168"></a><span id="l17.168" class="difflineplus">+      return;</span>
<a href="#l17.169"></a><span id="l17.169" class="difflineplus">+</span>
<a href="#l17.170"></a><span id="l17.170" class="difflineplus">+    let statusType = this.statusType;</span>
<a href="#l17.171"></a><span id="l17.171" class="difflineplus">+    let statusText = this.statusText;</span>
<a href="#l17.172"></a><span id="l17.172" class="difflineplus">+    this._idle = idle;</span>
<a href="#l17.173"></a><span id="l17.173" class="difflineplus">+    if (idle) {</span>
<a href="#l17.174"></a><span id="l17.174" class="difflineplus">+      this.idleTime = idleTime;</span>
<a href="#l17.175"></a><span id="l17.175" class="difflineplus">+      if (Services.prefs.getBoolPref(kPrefAwayWhenIdle)) {</span>
<a href="#l17.176"></a><span id="l17.176" class="difflineplus">+        this._idleStatusType = Ci.imIStatusInfo.STATUS_AWAY;</span>
<a href="#l17.177"></a><span id="l17.177" class="difflineplus">+        this._idleStatusText =</span>
<a href="#l17.178"></a><span id="l17.178" class="difflineplus">+          Services.prefs.getComplexValue(kPrefDefaultMessage,</span>
<a href="#l17.179"></a><span id="l17.179" class="difflineplus">+                                         Ci.nsIPrefLocalizedString).data;</span>
<a href="#l17.180"></a><span id="l17.180" class="difflineplus">+      }</span>
<a href="#l17.181"></a><span id="l17.181" class="difflineplus">+    }</span>
<a href="#l17.182"></a><span id="l17.182" class="difflineplus">+    else {</span>
<a href="#l17.183"></a><span id="l17.183" class="difflineplus">+      this.idleTime = 0;</span>
<a href="#l17.184"></a><span id="l17.184" class="difflineplus">+      delete this._idleStatusType;</span>
<a href="#l17.185"></a><span id="l17.185" class="difflineplus">+      delete this._idleStatusText;</span>
<a href="#l17.186"></a><span id="l17.186" class="difflineplus">+    }</span>
<a href="#l17.187"></a><span id="l17.187" class="difflineplus">+    if (this.statusType != statusType || this.statusText != statusText)</span>
<a href="#l17.188"></a><span id="l17.188" class="difflineplus">+      this._notifyObservers(&quot;status-changed&quot;, this.statusText);</span>
<a href="#l17.189"></a><span id="l17.189" class="difflineplus">+  },</span>
<a href="#l17.190"></a><span id="l17.190" class="difflineplus">+</span>
<a href="#l17.191"></a><span id="l17.191" class="difflineplus">+  _statusText: &quot;&quot;,</span>
<a href="#l17.192"></a><span id="l17.192" class="difflineplus">+  get statusText() this._statusText || this._idleStatusText,</span>
<a href="#l17.193"></a><span id="l17.193" class="difflineplus">+  _statusType: Ci.imIStatusInfo.STATUS_AVAILABLE,</span>
<a href="#l17.194"></a><span id="l17.194" class="difflineplus">+  get statusType() Math.min(this._statusType, this._idleStatusType, this._offlineStatusType),</span>
<a href="#l17.195"></a><span id="l17.195" class="difflineplus">+  setStatus: function(aStatus, aMessage) {</span>
<a href="#l17.196"></a><span id="l17.196" class="difflineplus">+    if (aStatus != Ci.imIStatusInfo.STATUS_UNKNOWN)</span>
<a href="#l17.197"></a><span id="l17.197" class="difflineplus">+      this._statusType = aStatus;</span>
<a href="#l17.198"></a><span id="l17.198" class="difflineplus">+    if (aStatus != Ci.imIStatusInfo.STATUS_OFFLINE)</span>
<a href="#l17.199"></a><span id="l17.199" class="difflineplus">+      this._statusText = aMessage;</span>
<a href="#l17.200"></a><span id="l17.200" class="difflineplus">+    this._notifyObservers(&quot;status-changed&quot;, aMessage);</span>
<a href="#l17.201"></a><span id="l17.201" class="difflineplus">+  },</span>
<a href="#l17.202"></a><span id="l17.202" class="difflineplus">+</span>
<a href="#l17.203"></a><span id="l17.203" class="difflineplus">+  _getProfileDir: function()</span>
<a href="#l17.204"></a><span id="l17.204" class="difflineplus">+    Cc[&quot;@mozilla.org/file/directory_service;1&quot;].getService(Ci.nsIProperties)</span>
<a href="#l17.205"></a><span id="l17.205" class="difflineplus">+      .get(&quot;ProfD&quot; /*NS_APP_USER_PROFILE_50_DIR*/, Ci.nsIFile),</span>
<a href="#l17.206"></a><span id="l17.206" class="difflineplus">+  setUserIcon: function(aIconFile) {</span>
<a href="#l17.207"></a><span id="l17.207" class="difflineplus">+    let folder = this._getProfileDir();</span>
<a href="#l17.208"></a><span id="l17.208" class="difflineplus">+</span>
<a href="#l17.209"></a><span id="l17.209" class="difflineplus">+    let newName = &quot;&quot;;</span>
<a href="#l17.210"></a><span id="l17.210" class="difflineplus">+    if (aIconFile) {</span>
<a href="#l17.211"></a><span id="l17.211" class="difflineplus">+      // Get the extension (remove trailing dots - invalid Windows extension).</span>
<a href="#l17.212"></a><span id="l17.212" class="difflineplus">+      let ext = aIconFile.leafName.replace(/.*(\.[a-z0-9]+)\.*/i, &quot;$1&quot;);</span>
<a href="#l17.213"></a><span id="l17.213" class="difflineplus">+      // newName = userIcon-&lt;timestamp(now)&gt;.&lt;aIconFile.extension&gt;</span>
<a href="#l17.214"></a><span id="l17.214" class="difflineplus">+      newName = &quot;userIcon-&quot; + (Date.now() / 1000) + ext;</span>
<a href="#l17.215"></a><span id="l17.215" class="difflineplus">+</span>
<a href="#l17.216"></a><span id="l17.216" class="difflineplus">+      // Copy the new icon file to newName in the profile folder.</span>
<a href="#l17.217"></a><span id="l17.217" class="difflineplus">+      aIconFile.copyTo(folder, newName);</span>
<a href="#l17.218"></a><span id="l17.218" class="difflineplus">+    }</span>
<a href="#l17.219"></a><span id="l17.219" class="difflineplus">+</span>
<a href="#l17.220"></a><span id="l17.220" class="difflineplus">+    // Get the previous file name before saving the new file name.</span>
<a href="#l17.221"></a><span id="l17.221" class="difflineplus">+    let oldFileName = Services.prefs.getCharPref(kPrefUserIconFilename);</span>
<a href="#l17.222"></a><span id="l17.222" class="difflineplus">+    Services.prefs.setCharPref(kPrefUserIconFilename, newName);</span>
<a href="#l17.223"></a><span id="l17.223" class="difflineplus">+</span>
<a href="#l17.224"></a><span id="l17.224" class="difflineplus">+    // Now that the new icon has been copied to the profile directory</span>
<a href="#l17.225"></a><span id="l17.225" class="difflineplus">+    // and the pref value changed, we can remove the old icon. Ignore</span>
<a href="#l17.226"></a><span id="l17.226" class="difflineplus">+    // failures so that we always fire the user-icon-changed notification.</span>
<a href="#l17.227"></a><span id="l17.227" class="difflineplus">+    try {</span>
<a href="#l17.228"></a><span id="l17.228" class="difflineplus">+      if (oldFileName) {</span>
<a href="#l17.229"></a><span id="l17.229" class="difflineplus">+        folder.append(oldFileName);</span>
<a href="#l17.230"></a><span id="l17.230" class="difflineplus">+        if (folder.exists())</span>
<a href="#l17.231"></a><span id="l17.231" class="difflineplus">+          folder.remove(false);</span>
<a href="#l17.232"></a><span id="l17.232" class="difflineplus">+      }</span>
<a href="#l17.233"></a><span id="l17.233" class="difflineplus">+    } catch (e) {</span>
<a href="#l17.234"></a><span id="l17.234" class="difflineplus">+      Cu.reportError(e);</span>
<a href="#l17.235"></a><span id="l17.235" class="difflineplus">+    }</span>
<a href="#l17.236"></a><span id="l17.236" class="difflineplus">+</span>
<a href="#l17.237"></a><span id="l17.237" class="difflineplus">+    this._notifyObservers(&quot;user-icon-changed&quot;, newName);</span>
<a href="#l17.238"></a><span id="l17.238" class="difflineplus">+  },</span>
<a href="#l17.239"></a><span id="l17.239" class="difflineplus">+  getUserIcon: function() {</span>
<a href="#l17.240"></a><span id="l17.240" class="difflineplus">+    let filename = Services.prefs.getCharPref(kPrefUserIconFilename);</span>
<a href="#l17.241"></a><span id="l17.241" class="difflineplus">+    if (!filename)</span>
<a href="#l17.242"></a><span id="l17.242" class="difflineplus">+      return null; // No icon has been set.</span>
<a href="#l17.243"></a><span id="l17.243" class="difflineplus">+</span>
<a href="#l17.244"></a><span id="l17.244" class="difflineplus">+    let file = this._getProfileDir();</span>
<a href="#l17.245"></a><span id="l17.245" class="difflineplus">+    file.append(filename);</span>
<a href="#l17.246"></a><span id="l17.246" class="difflineplus">+</span>
<a href="#l17.247"></a><span id="l17.247" class="difflineplus">+    if (!file.exists()) {</span>
<a href="#l17.248"></a><span id="l17.248" class="difflineplus">+      Services.console.logStringMessage(&quot;Invalid userIconFileName preference&quot;);</span>
<a href="#l17.249"></a><span id="l17.249" class="difflineplus">+      return null;</span>
<a href="#l17.250"></a><span id="l17.250" class="difflineplus">+    }</span>
<a href="#l17.251"></a><span id="l17.251" class="difflineplus">+</span>
<a href="#l17.252"></a><span id="l17.252" class="difflineplus">+    return Services.io.newFileURI(file);</span>
<a href="#l17.253"></a><span id="l17.253" class="difflineplus">+  },</span>
<a href="#l17.254"></a><span id="l17.254" class="difflineplus">+</span>
<a href="#l17.255"></a><span id="l17.255" class="difflineplus">+  get displayName() Services.prefs.getCharPref(kPrefUserDisplayname),</span>
<a href="#l17.256"></a><span id="l17.256" class="difflineplus">+  set displayName(aDisplayName) {</span>
<a href="#l17.257"></a><span id="l17.257" class="difflineplus">+    Services.prefs.setCharPref(kPrefUserDisplayname, aDisplayName);</span>
<a href="#l17.258"></a><span id="l17.258" class="difflineplus">+    this._notifyObservers(&quot;user-display-name-changed&quot;, aDisplayName);</span>
<a href="#l17.259"></a><span id="l17.259" class="difflineplus">+  },</span>
<a href="#l17.260"></a><span id="l17.260" class="difflineplus">+</span>
<a href="#l17.261"></a><span id="l17.261" class="difflineplus">+  addObserver: function(aObserver) {</span>
<a href="#l17.262"></a><span id="l17.262" class="difflineplus">+    if (this._observers.indexOf(aObserver) == -1)</span>
<a href="#l17.263"></a><span id="l17.263" class="difflineplus">+      this._observers.push(aObserver);</span>
<a href="#l17.264"></a><span id="l17.264" class="difflineplus">+  },</span>
<a href="#l17.265"></a><span id="l17.265" class="difflineplus">+  removeObserver: function(aObserver) {</span>
<a href="#l17.266"></a><span id="l17.266" class="difflineplus">+    this._observers = this._observers.filter(function(o) o !== aObserver);</span>
<a href="#l17.267"></a><span id="l17.267" class="difflineplus">+  },</span>
<a href="#l17.268"></a><span id="l17.268" class="difflineplus">+  _notifyObservers: function(aTopic, aData) {</span>
<a href="#l17.269"></a><span id="l17.269" class="difflineplus">+    for each (let observer in this._observers)</span>
<a href="#l17.270"></a><span id="l17.270" class="difflineplus">+      observer.observe(this, aTopic, aData);</span>
<a href="#l17.271"></a><span id="l17.271" class="difflineplus">+  }</span>
<a href="#l17.272"></a><span id="l17.272" class="difflineplus">+};</span>
<a href="#l17.273"></a><span id="l17.273" class="difflineplus">+</span>
<a href="#l17.274"></a><span id="l17.274" class="difflineplus">+var gCoreService;</span>
<a href="#l17.275"></a><span id="l17.275" class="difflineplus">+function CoreService() { gCoreService = this; }</span>
<a href="#l17.276"></a><span id="l17.276" class="difflineplus">+CoreService.prototype = {</span>
<a href="#l17.277"></a><span id="l17.277" class="difflineplus">+  _initialized: false,</span>
<a href="#l17.278"></a><span id="l17.278" class="difflineplus">+  globalUserStatus: null,</span>
<a href="#l17.279"></a><span id="l17.279" class="difflineplus">+  init: function() {</span>
<a href="#l17.280"></a><span id="l17.280" class="difflineplus">+    if (this._initialized)</span>
<a href="#l17.281"></a><span id="l17.281" class="difflineplus">+      throw Cr.NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l17.282"></a><span id="l17.282" class="difflineplus">+</span>
<a href="#l17.283"></a><span id="l17.283" class="difflineplus">+    Services.obs.addObserver(this, kQuitApplicationGranted, false);</span>
<a href="#l17.284"></a><span id="l17.284" class="difflineplus">+    this._initialized = true;</span>
<a href="#l17.285"></a><span id="l17.285" class="difflineplus">+</span>
<a href="#l17.286"></a><span id="l17.286" class="difflineplus">+    Services.cmd.initCommands();</span>
<a href="#l17.287"></a><span id="l17.287" class="difflineplus">+    this._protos = {};</span>
<a href="#l17.288"></a><span id="l17.288" class="difflineplus">+</span>
<a href="#l17.289"></a><span id="l17.289" class="difflineplus">+    this.globalUserStatus = new UserStatus();</span>
<a href="#l17.290"></a><span id="l17.290" class="difflineplus">+    this.globalUserStatus.addObserver({</span>
<a href="#l17.291"></a><span id="l17.291" class="difflineplus">+      observe: function(aSubject, aTopic, aData) {</span>
<a href="#l17.292"></a><span id="l17.292" class="difflineplus">+        Services.obs.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l17.293"></a><span id="l17.293" class="difflineplus">+      }</span>
<a href="#l17.294"></a><span id="l17.294" class="difflineplus">+    });</span>
<a href="#l17.295"></a><span id="l17.295" class="difflineplus">+</span>
<a href="#l17.296"></a><span id="l17.296" class="difflineplus">+    Services.accounts.initAccounts();</span>
<a href="#l17.297"></a><span id="l17.297" class="difflineplus">+    Services.contacts.initContacts();</span>
<a href="#l17.298"></a><span id="l17.298" class="difflineplus">+    Services.conversations.initConversations();</span>
<a href="#l17.299"></a><span id="l17.299" class="difflineplus">+  },</span>
<a href="#l17.300"></a><span id="l17.300" class="difflineplus">+  observe: function(aObject, aTopic, aData) {</span>
<a href="#l17.301"></a><span id="l17.301" class="difflineplus">+    if (aTopic == kQuitApplicationGranted)</span>
<a href="#l17.302"></a><span id="l17.302" class="difflineplus">+      this.quit();</span>
<a href="#l17.303"></a><span id="l17.303" class="difflineplus">+  },</span>
<a href="#l17.304"></a><span id="l17.304" class="difflineplus">+  quit: function() {</span>
<a href="#l17.305"></a><span id="l17.305" class="difflineplus">+    if (!this._initialized)</span>
<a href="#l17.306"></a><span id="l17.306" class="difflineplus">+      throw Cr.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l17.307"></a><span id="l17.307" class="difflineplus">+</span>
<a href="#l17.308"></a><span id="l17.308" class="difflineplus">+    Services.obs.removeObserver(this, kQuitApplicationGranted);</span>
<a href="#l17.309"></a><span id="l17.309" class="difflineplus">+    Services.obs.notifyObservers(this, &quot;prpl-quit&quot;, null);</span>
<a href="#l17.310"></a><span id="l17.310" class="difflineplus">+</span>
<a href="#l17.311"></a><span id="l17.311" class="difflineplus">+    Services.conversations.unInitConversations();</span>
<a href="#l17.312"></a><span id="l17.312" class="difflineplus">+    Services.accounts.unInitAccounts();</span>
<a href="#l17.313"></a><span id="l17.313" class="difflineplus">+    Services.contacts.unInitContacts();</span>
<a href="#l17.314"></a><span id="l17.314" class="difflineplus">+    Services.cmd.unInitCommands();</span>
<a href="#l17.315"></a><span id="l17.315" class="difflineplus">+</span>
<a href="#l17.316"></a><span id="l17.316" class="difflineplus">+    this.globalUserStatus.unInit();</span>
<a href="#l17.317"></a><span id="l17.317" class="difflineplus">+    delete this.globalUserStatus;</span>
<a href="#l17.318"></a><span id="l17.318" class="difflineplus">+    delete this._protos;</span>
<a href="#l17.319"></a><span id="l17.319" class="difflineplus">+    delete this._initialized;</span>
<a href="#l17.320"></a><span id="l17.320" class="difflineplus">+  },</span>
<a href="#l17.321"></a><span id="l17.321" class="difflineplus">+</span>
<a href="#l17.322"></a><span id="l17.322" class="difflineplus">+  getProtocols: function() {</span>
<a href="#l17.323"></a><span id="l17.323" class="difflineplus">+    if (!this._initialized)</span>
<a href="#l17.324"></a><span id="l17.324" class="difflineplus">+      throw Cr.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l17.325"></a><span id="l17.325" class="difflineplus">+</span>
<a href="#l17.326"></a><span id="l17.326" class="difflineplus">+    let protocols = [];</span>
<a href="#l17.327"></a><span id="l17.327" class="difflineplus">+    let entries = categoryManager.enumerateCategory(kProtocolPluginCategory);</span>
<a href="#l17.328"></a><span id="l17.328" class="difflineplus">+    while (entries.hasMoreElements()) {</span>
<a href="#l17.329"></a><span id="l17.329" class="difflineplus">+      let id = entries.getNext().QueryInterface(Ci.nsISupportsCString).data;</span>
<a href="#l17.330"></a><span id="l17.330" class="difflineplus">+      let proto = this.getProtocolById(id);</span>
<a href="#l17.331"></a><span id="l17.331" class="difflineplus">+      if (proto)</span>
<a href="#l17.332"></a><span id="l17.332" class="difflineplus">+        protocols.push(proto);</span>
<a href="#l17.333"></a><span id="l17.333" class="difflineplus">+    }</span>
<a href="#l17.334"></a><span id="l17.334" class="difflineplus">+    return new nsSimpleEnumerator(protocols);</span>
<a href="#l17.335"></a><span id="l17.335" class="difflineplus">+  },</span>
<a href="#l17.336"></a><span id="l17.336" class="difflineplus">+</span>
<a href="#l17.337"></a><span id="l17.337" class="difflineplus">+  getProtocolById: function(aPrplId) {</span>
<a href="#l17.338"></a><span id="l17.338" class="difflineplus">+    if (!this._initialized)</span>
<a href="#l17.339"></a><span id="l17.339" class="difflineplus">+      throw Cr.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l17.340"></a><span id="l17.340" class="difflineplus">+</span>
<a href="#l17.341"></a><span id="l17.341" class="difflineplus">+    if (this._protos.hasOwnProperty(aPrplId))</span>
<a href="#l17.342"></a><span id="l17.342" class="difflineplus">+      return this._protos[aPrplId];</span>
<a href="#l17.343"></a><span id="l17.343" class="difflineplus">+</span>
<a href="#l17.344"></a><span id="l17.344" class="difflineplus">+    let cid;</span>
<a href="#l17.345"></a><span id="l17.345" class="difflineplus">+    try {</span>
<a href="#l17.346"></a><span id="l17.346" class="difflineplus">+      cid = categoryManager.getCategoryEntry(kProtocolPluginCategory, aPrplId);</span>
<a href="#l17.347"></a><span id="l17.347" class="difflineplus">+    } catch (e) {</span>
<a href="#l17.348"></a><span id="l17.348" class="difflineplus">+      return null; // no protocol registered for this id.</span>
<a href="#l17.349"></a><span id="l17.349" class="difflineplus">+    }</span>
<a href="#l17.350"></a><span id="l17.350" class="difflineplus">+</span>
<a href="#l17.351"></a><span id="l17.351" class="difflineplus">+    let proto = null;</span>
<a href="#l17.352"></a><span id="l17.352" class="difflineplus">+    try {</span>
<a href="#l17.353"></a><span id="l17.353" class="difflineplus">+      proto = Cc[cid].createInstance(Ci.prplIProtocol);</span>
<a href="#l17.354"></a><span id="l17.354" class="difflineplus">+    } catch (e) {</span>
<a href="#l17.355"></a><span id="l17.355" class="difflineplus">+      // This is a real error, the protocol is registered and failed to init.</span>
<a href="#l17.356"></a><span id="l17.356" class="difflineplus">+      Cu.reportError(e);</span>
<a href="#l17.357"></a><span id="l17.357" class="difflineplus">+    }</span>
<a href="#l17.358"></a><span id="l17.358" class="difflineplus">+    if (!proto)</span>
<a href="#l17.359"></a><span id="l17.359" class="difflineplus">+      return null;</span>
<a href="#l17.360"></a><span id="l17.360" class="difflineplus">+</span>
<a href="#l17.361"></a><span id="l17.361" class="difflineplus">+    proto.init(aPrplId);</span>
<a href="#l17.362"></a><span id="l17.362" class="difflineplus">+    this._protos[aPrplId] = proto;</span>
<a href="#l17.363"></a><span id="l17.363" class="difflineplus">+    return proto;</span>
<a href="#l17.364"></a><span id="l17.364" class="difflineplus">+  },</span>
<a href="#l17.365"></a><span id="l17.365" class="difflineplus">+</span>
<a href="#l17.366"></a><span id="l17.366" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI([Ci.imICoreService]),</span>
<a href="#l17.367"></a><span id="l17.367" class="difflineplus">+  classDescription: &quot;Core&quot;,</span>
<a href="#l17.368"></a><span id="l17.368" class="difflineplus">+  classID: Components.ID(&quot;{073f5953-853c-4a38-bd81-255510c31c2e}&quot;),</span>
<a href="#l17.369"></a><span id="l17.369" class="difflineplus">+  contractID: &quot;@instantbird.org/purple/core-service;1&quot;</span>
<a href="#l17.370"></a><span id="l17.370" class="difflineplus">+};</span>
<a href="#l17.371"></a><span id="l17.371" class="difflineplus">+</span>
<a href="#l17.372"></a><span id="l17.372" class="difflineplus">+const NSGetFactory = XPCOMUtils.generateNSGetFactory([CoreService]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">new file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineminus">--- /dev/null</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineplus">+++ b/chat/components/src/imCore.manifest</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineat">@@ -0,0 +1,2 @@</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineplus">+component {073f5953-853c-4a38-bd81-255510c31c2e} imCore.js</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineplus">+contract @instantbird.org/purple/core-service;1 {073f5953-853c-4a38-bd81-255510c31c2e}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/chat/modules/imServices.jsm</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/chat/modules/imServices.jsm</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -35,19 +35,22 @@</span>
<a href="#l19.4"></a><span id="l19.4">  *</span>
<a href="#l19.5"></a><span id="l19.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l19.6"></a><span id="l19.6"> </span>
<a href="#l19.7"></a><span id="l19.7"> let EXPORTED_SYMBOLS = [&quot;Services&quot;];</span>
<a href="#l19.8"></a><span id="l19.8"> </span>
<a href="#l19.9"></a><span id="l19.9"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l19.10"></a><span id="l19.10"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(Services, &quot;accounts&quot;,</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+                                   &quot;@instantbird.org/purple/accounts-service;1&quot;,</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+                                   &quot;imIAccountsService&quot;);</span>
<a href="#l19.15"></a><span id="l19.15"> XPCOMUtils.defineLazyServiceGetter(Services, &quot;core&quot;,</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineminus">-                                   &quot;@instantbird.org/purple/core;1&quot;,</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineminus">-                                   &quot;purpleICoreService&quot;);</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+                                   &quot;@instantbird.org/purple/core-service;1&quot;,</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+                                   &quot;imICoreService&quot;);</span>
<a href="#l19.20"></a><span id="l19.20"> XPCOMUtils.defineLazyServiceGetter(Services, &quot;cmd&quot;,</span>
<a href="#l19.21"></a><span id="l19.21">                                    &quot;@instantbird.org/purple/commands-service;1&quot;,</span>
<a href="#l19.22"></a><span id="l19.22">                                    &quot;imICommandsService&quot;);</span>
<a href="#l19.23"></a><span id="l19.23"> XPCOMUtils.defineLazyServiceGetter(Services, &quot;contacts&quot;,</span>
<a href="#l19.24"></a><span id="l19.24">                                    &quot;@instantbird.org/purple/contacts-service;1&quot;,</span>
<a href="#l19.25"></a><span id="l19.25">                                    &quot;imIContactsService&quot;);</span>
<a href="#l19.26"></a><span id="l19.26"> XPCOMUtils.defineLazyServiceGetter(Services, &quot;conversations&quot;,</span>
<a href="#l19.27"></a><span id="l19.27">                                    &quot;@instantbird.org/purple/conversations-service;1&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/chat/modules/imThemes.jsm</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/chat/modules/imThemes.jsm</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -426,17 +426,17 @@ const messageReplacements = {</span>
<a href="#l20.4"></a><span id="l20.4">   userIconPath: function (aMsg) {</span>
<a href="#l20.5"></a><span id="l20.5">     // If the protocol plugin provides an icon for the message, use it.</span>
<a href="#l20.6"></a><span id="l20.6">     let iconURL = aMsg.iconURL;</span>
<a href="#l20.7"></a><span id="l20.7">     if (iconURL)</span>
<a href="#l20.8"></a><span id="l20.8">       return iconURL;</span>
<a href="#l20.9"></a><span id="l20.9"> </span>
<a href="#l20.10"></a><span id="l20.10">     // For outgoing messages, use the current user icon.</span>
<a href="#l20.11"></a><span id="l20.11">     if (aMsg.outgoing) {</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-      iconURL = Services.core.getUserIcon();</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+      iconURL = aMsg.conversation.account.statusInfo.getUserIcon();</span>
<a href="#l20.14"></a><span id="l20.14">       if (iconURL)</span>
<a href="#l20.15"></a><span id="l20.15">         return iconURL.spec;</span>
<a href="#l20.16"></a><span id="l20.16">     }</span>
<a href="#l20.17"></a><span id="l20.17"> </span>
<a href="#l20.18"></a><span id="l20.18">     // Fallback to the theme's default icons.</span>
<a href="#l20.19"></a><span id="l20.19">     return (aMsg.incoming ? &quot;Incoming&quot; : &quot;Outgoing&quot;) + &quot;/buddy_icon.png&quot;;</span>
<a href="#l20.20"></a><span id="l20.20">   },</span>
<a href="#l20.21"></a><span id="l20.21">   senderScreenName: function(aMsg) aMsg.who,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/chat/modules/imXPCOMUtils.jsm</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/chat/modules/imXPCOMUtils.jsm</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -122,16 +122,21 @@ function executeSoon(aFunction)</span>
<a href="#l21.4"></a><span id="l21.4">  * shared by all generic objects implemented in this file. */</span>
<a href="#l21.5"></a><span id="l21.5"> function ClassInfo(aInterfaces, aDescription)</span>
<a href="#l21.6"></a><span id="l21.6"> {</span>
<a href="#l21.7"></a><span id="l21.7">   if (!(this instanceof ClassInfo))</span>
<a href="#l21.8"></a><span id="l21.8">     return new ClassInfo(aInterfaces, aDescription);</span>
<a href="#l21.9"></a><span id="l21.9"> </span>
<a href="#l21.10"></a><span id="l21.10">   if (!Array.isArray(aInterfaces))</span>
<a href="#l21.11"></a><span id="l21.11">     aInterfaces = [aInterfaces];</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+  for each (let i in aInterfaces)</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+    if (typeof i == &quot;string&quot; &amp;&amp; !(i in Ci))</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+      Services.console.logStringMessage(&quot;ClassInfo: unknown interface &quot; + i);</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+</span>
<a href="#l21.17"></a><span id="l21.17">   this._interfaces =</span>
<a href="#l21.18"></a><span id="l21.18">     aInterfaces.map(function (i) typeof i == &quot;string&quot; ? Ci[i] : i);</span>
<a href="#l21.19"></a><span id="l21.19"> </span>
<a href="#l21.20"></a><span id="l21.20">   this.classDescription = aDescription || &quot;JS Proto Object&quot;;</span>
<a href="#l21.21"></a><span id="l21.21"> }</span>
<a href="#l21.22"></a><span id="l21.22"> ClassInfo.prototype = {</span>
<a href="#l21.23"></a><span id="l21.23">   QueryInterface: function ClassInfo_QueryInterface(iid) {</span>
<a href="#l21.24"></a><span id="l21.24">     if (iid.equals(Ci.nsISupports) || iid.equals(Ci.nsIClassInfo) ||</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/chat/modules/jsProtoHelper.jsm</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/chat/modules/jsProtoHelper.jsm</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -53,113 +53,112 @@ const {classes: Cc, interfaces: Ci, resu</span>
<a href="#l22.4"></a><span id="l22.4"> </span>
<a href="#l22.5"></a><span id="l22.5"> Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l22.6"></a><span id="l22.6"> Cu.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l22.7"></a><span id="l22.7"> </span>
<a href="#l22.8"></a><span id="l22.8"> initLogModule(&quot;jsProtoHelper&quot;);</span>
<a href="#l22.9"></a><span id="l22.9"> </span>
<a href="#l22.10"></a><span id="l22.10"> function normalize(aString) aString.replace(/[^a-z0-9]/gi, &quot;&quot;).toLowerCase()</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;AccountBase&quot;, function()</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-  Components.Constructor(&quot;@instantbird.org/purple/account;1&quot;,</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">-                         &quot;purpleIAccountBase&quot;)</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineminus">-);</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineminus">-</span>
<a href="#l22.17"></a><span id="l22.17"> const ForwardAccountPrototype = {</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineminus">-  __proto__: ClassInfo(&quot;purpleIAccount&quot;, &quot;generic account object&quot;),</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineminus">-  _init: function _init(aProtoInstance, aBase) {</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineplus">+  __proto__: ClassInfo(&quot;prplIAccount&quot;, &quot;generic account object&quot;),</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineplus">+  _init: function _init(aBase) {</span>
<a href="#l22.22"></a><span id="l22.22">     this._base = aBase;</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineminus">-    this._base.concreteAccount = this;</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineminus">-    this._protocol = aProtoInstance;</span>
<a href="#l22.25"></a><span id="l22.25">   },</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineminus">-  get base() this._base.purpleIAccountBase,</span>
<a href="#l22.27"></a><span id="l22.27"> </span>
<a href="#l22.28"></a><span id="l22.28" class="difflineminus">-  checkAutoLogin: function() this._base.checkAutoLogin(),</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineminus">-  remove: function() this._base.remove(),</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineminus">-  UnInit: function() this._base.UnInit(),</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineplus">+  observe: function(aSubject, aTopic, aData) {</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+    this._base.observe(aSubject, aTopic, aData);</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineplus">+  },</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+  unInit: function() this._base.unInit(),</span>
<a href="#l22.35"></a><span id="l22.35">   connect: function() this._base.connect(),</span>
<a href="#l22.36"></a><span id="l22.36">   disconnect: function() this._base.disconnect(),</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineminus">-  cancelReconnection: function() this._base.cancelReconnection(),</span>
<a href="#l22.38"></a><span id="l22.38">   createConversation: function(aName) this._base.createConversation(aName),</span>
<a href="#l22.39"></a><span id="l22.39">   addBuddy: function(aTag, aName) this._base.addBuddy(aTag, aName),</span>
<a href="#l22.40"></a><span id="l22.40">   loadBuddy: function(aBuddy, aTag) this._base.loadBuddy(aBuddy, aTag),</span>
<a href="#l22.41"></a><span id="l22.41">   requestBuddyInfo: function(aBuddyName) this._base.requestBuddyInfo(aBuddyName),</span>
<a href="#l22.42"></a><span id="l22.42">   getChatRoomFields: function() this._base.getChatRoomFields(),</span>
<a href="#l22.43"></a><span id="l22.43">   getChatRoomDefaultFieldValues: function(aDefaultChatName)</span>
<a href="#l22.44"></a><span id="l22.44">     this._base.getChatRoomDefaultFieldValues(aDefaultChatName),</span>
<a href="#l22.45"></a><span id="l22.45">   joinChat: function(aComponents) this._base.joinChat(aComponents),</span>
<a href="#l22.46"></a><span id="l22.46">   setBool: function(aName, aVal) this._base.setBool(aName, aVal),</span>
<a href="#l22.47"></a><span id="l22.47">   setInt: function(aName, aVal) this._base.setInt(aName, aVal),</span>
<a href="#l22.48"></a><span id="l22.48">   setString: function(aName, aVal) this._base.setString(aName, aVal),</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineminus">-  save: function() this._base.save(),</span>
<a href="#l22.50"></a><span id="l22.50"> </span>
<a href="#l22.51"></a><span id="l22.51" class="difflineminus">-  // grep attribute purpleIAccount.idl |sed 's/.* //;s/;//;s/\(.*\)/  get \1() this._base.\1,/'</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineminus">-  // Exception: the protocol getter is handled locally.</span>
<a href="#l22.53"></a><span id="l22.53">   get canJoinChat() this._base.canJoinChat,</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineminus">-  get name() this._base.name,</span>
<a href="#l22.55"></a><span id="l22.55">   get normalizedName() this._base.normalizedName,</span>
<a href="#l22.56"></a><span id="l22.56" class="difflineminus">-  get id() this._base.id,</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineminus">-  get numericId() this._base.numericId,</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineminus">-  get protocol() this._protocol,</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineminus">-  get autoLogin() this._base.autoLogin,</span>
<a href="#l22.60"></a><span id="l22.60" class="difflineminus">-  get firstConnectionState() this._base.firstConnectionState,</span>
<a href="#l22.61"></a><span id="l22.61" class="difflineminus">-  get password() this._base.password,</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineminus">-  get rememberPassword() this._base.rememberPassword,</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineminus">-  get alias() this._base.alias,</span>
<a href="#l22.64"></a><span id="l22.64">   get proxyInfo() this._base.proxyInfo,</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineminus">-  get connectionStateMsg() this._base.connectionStateMsg,</span>
<a href="#l22.66"></a><span id="l22.66">   get connectionErrorReason() this._base.connectionErrorReason,</span>
<a href="#l22.67"></a><span id="l22.67" class="difflineminus">-  get reconnectAttempt() this._base.reconnectAttempt,</span>
<a href="#l22.68"></a><span id="l22.68" class="difflineminus">-  get timeOfNextReconnect() this._base.timeOfNextReconnect,</span>
<a href="#l22.69"></a><span id="l22.69" class="difflineminus">-  get timeOfLastConnect() this._base.timeOfLastConnect,</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineminus">-  get connectionErrorMessage() this._base.connectionErrorMessage,</span>
<a href="#l22.71"></a><span id="l22.71" class="difflineminus">-  get connectionState() this._base.connectionState,</span>
<a href="#l22.72"></a><span id="l22.72" class="difflineminus">-  get disconnected() this._base.disconnected,</span>
<a href="#l22.73"></a><span id="l22.73" class="difflineminus">-  get connected() this._base.connected,</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineminus">-  get connecting() this._base.connecting,</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineminus">-  get disconnecting() this._base.disconnecting,</span>
<a href="#l22.76"></a><span id="l22.76">   get HTMLEnabled() this._base.HTMLEnabled,</span>
<a href="#l22.77"></a><span id="l22.77">   get noBackgroundColors() this._base.noBackgroundColors,</span>
<a href="#l22.78"></a><span id="l22.78">   get autoResponses() this._base.autoResponses,</span>
<a href="#l22.79"></a><span id="l22.79">   get singleFormatting() this._base.singleFormatting,</span>
<a href="#l22.80"></a><span id="l22.80">   get noNewlines() this._base.noNewlines,</span>
<a href="#l22.81"></a><span id="l22.81">   get noFontSizes() this._base.noFontSizes,</span>
<a href="#l22.82"></a><span id="l22.82">   get noUrlDesc() this._base.noUrlDesc,</span>
<a href="#l22.83"></a><span id="l22.83">   get noImages() this._base.noImages,</span>
<a href="#l22.84"></a><span id="l22.84">   get maxMessageLength() this._base.maxMessageLength,</span>
<a href="#l22.85"></a><span id="l22.85"> </span>
<a href="#l22.86"></a><span id="l22.86" class="difflineminus">-  // grep attribute purpleIAccount.idl |grep -v readonly |sed 's/.* //;s/;//;s/\(.*\)/  set \1(val) { this._base.\1 = val; },/'</span>
<a href="#l22.87"></a><span id="l22.87" class="difflineminus">-  set autoLogin(val) { this._base.autoLogin = val; },</span>
<a href="#l22.88"></a><span id="l22.88" class="difflineminus">-  set firstConnectionState(val) { this._base.firstConnectionState = val; },</span>
<a href="#l22.89"></a><span id="l22.89" class="difflineminus">-  set password(val) { this._base.password = val; },</span>
<a href="#l22.90"></a><span id="l22.90" class="difflineminus">-  set rememberPassword(val) { this._base.rememberPassword = val; },</span>
<a href="#l22.91"></a><span id="l22.91" class="difflineminus">-  set alias(val) { this._base.alias = val; },</span>
<a href="#l22.92"></a><span id="l22.92">   set proxyInfo(val) { this._base.proxyInfo = val; }</span>
<a href="#l22.93"></a><span id="l22.93"> };</span>
<a href="#l22.94"></a><span id="l22.94"> </span>
<a href="#l22.95"></a><span id="l22.95"> const GenericAccountPrototype = {</span>
<a href="#l22.96"></a><span id="l22.96" class="difflineminus">-  __proto__: ForwardAccountPrototype,</span>
<a href="#l22.97"></a><span id="l22.97" class="difflineminus">-  _init: function _init(aProtoInstance, aKey, aName) {</span>
<a href="#l22.98"></a><span id="l22.98" class="difflineminus">-    ForwardAccountPrototype._init.call(this, aProtoInstance, new AccountBase());</span>
<a href="#l22.99"></a><span id="l22.99" class="difflineminus">-    this._base.init(aKey, aName, aProtoInstance);</span>
<a href="#l22.100"></a><span id="l22.100" class="difflineplus">+  __proto__: ClassInfo(&quot;prplIAccount&quot;, &quot;generic account object&quot;),</span>
<a href="#l22.101"></a><span id="l22.101" class="difflineplus">+  _init: function _init(aProtocol, aImAccount) {</span>
<a href="#l22.102"></a><span id="l22.102" class="difflineplus">+    this.protocol = aProtocol;</span>
<a href="#l22.103"></a><span id="l22.103" class="difflineplus">+    this.imAccount = aImAccount;</span>
<a href="#l22.104"></a><span id="l22.104" class="difflineplus">+  },</span>
<a href="#l22.105"></a><span id="l22.105" class="difflineplus">+  observe: function(aSubject, aTopic, aData) {},</span>
<a href="#l22.106"></a><span id="l22.106" class="difflineplus">+  unInit: function() {},</span>
<a href="#l22.107"></a><span id="l22.107" class="difflineplus">+  connect: function() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l22.108"></a><span id="l22.108" class="difflineplus">+  disconnect: function() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l22.109"></a><span id="l22.109" class="difflineplus">+  createConversation: function(aName) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l22.110"></a><span id="l22.110" class="difflineplus">+  joinChat: function(aComponents) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l22.111"></a><span id="l22.111" class="difflineplus">+  setBool: function(aName, aVal) {},</span>
<a href="#l22.112"></a><span id="l22.112" class="difflineplus">+  setInt: function(aName, aVal) {},</span>
<a href="#l22.113"></a><span id="l22.113" class="difflineplus">+  setString: function(aName, aVal) {},</span>
<a href="#l22.114"></a><span id="l22.114" class="difflineplus">+</span>
<a href="#l22.115"></a><span id="l22.115" class="difflineplus">+  get name() this.imAccount.name,</span>
<a href="#l22.116"></a><span id="l22.116" class="difflineplus">+  get connected() this.imAccount.connected,</span>
<a href="#l22.117"></a><span id="l22.117" class="difflineplus">+  get connecting() this.imAccount.connecting,</span>
<a href="#l22.118"></a><span id="l22.118" class="difflineplus">+  get disconnected() this.imAccount.disconnected,</span>
<a href="#l22.119"></a><span id="l22.119" class="difflineplus">+  get disconnecting() this.imAccount.disconnecting,</span>
<a href="#l22.120"></a><span id="l22.120" class="difflineplus">+  _connectionErrorReason: Ci.prplIAccount.NO_ERROR,</span>
<a href="#l22.121"></a><span id="l22.121" class="difflineplus">+  get connectionErrorReason() this._connectionErrorReason,</span>
<a href="#l22.122"></a><span id="l22.122" class="difflineplus">+</span>
<a href="#l22.123"></a><span id="l22.123" class="difflineplus">+  reportConnected: function() {</span>
<a href="#l22.124"></a><span id="l22.124" class="difflineplus">+    this.imAccount.observe(this, &quot;account-connected&quot;, null);</span>
<a href="#l22.125"></a><span id="l22.125" class="difflineplus">+  },</span>
<a href="#l22.126"></a><span id="l22.126" class="difflineplus">+  reportConnecting: function(aConnectionStateMsg) {</span>
<a href="#l22.127"></a><span id="l22.127" class="difflineplus">+    if (!this.connecting)</span>
<a href="#l22.128"></a><span id="l22.128" class="difflineplus">+      this.imAccount.observe(this, &quot;account-connecting&quot;, null);</span>
<a href="#l22.129"></a><span id="l22.129" class="difflineplus">+    if (aConnectionStateMsg)</span>
<a href="#l22.130"></a><span id="l22.130" class="difflineplus">+      this.imAccount.observe(this, &quot;account-connect-progress&quot;, aConnectionStateMsg);</span>
<a href="#l22.131"></a><span id="l22.131" class="difflineplus">+  },</span>
<a href="#l22.132"></a><span id="l22.132" class="difflineplus">+  reportDisconnected: function() {</span>
<a href="#l22.133"></a><span id="l22.133" class="difflineplus">+    this.imAccount.observe(this, &quot;account-disconnected&quot;, null);</span>
<a href="#l22.134"></a><span id="l22.134" class="difflineplus">+  },</span>
<a href="#l22.135"></a><span id="l22.135" class="difflineplus">+  reportDisconnecting: function(aConnectionErrorReason, aConnectionErrorMessage) {</span>
<a href="#l22.136"></a><span id="l22.136" class="difflineplus">+    this._connectionErrorReason = aConnectionErrorReason;</span>
<a href="#l22.137"></a><span id="l22.137" class="difflineplus">+    this.imAccount.observe(this, &quot;account-disconnecting&quot;, aConnectionErrorMessage);</span>
<a href="#l22.138"></a><span id="l22.138">   },</span>
<a href="#l22.139"></a><span id="l22.139"> </span>
<a href="#l22.140"></a><span id="l22.140">   addBuddy: function(aTag, aName) {</span>
<a href="#l22.141"></a><span id="l22.141">     Services.contacts</span>
<a href="#l22.142"></a><span id="l22.142">             .accountBuddyAdded(new AccountBuddy(this, null, aTag, aName));</span>
<a href="#l22.143"></a><span id="l22.143">   },</span>
<a href="#l22.144"></a><span id="l22.144">   loadBuddy: function(aBuddy, aTag) {</span>
<a href="#l22.145"></a><span id="l22.145">    try {</span>
<a href="#l22.146"></a><span id="l22.146" class="difflineminus">-     return new AccountBuddy(this, aBuddy, aTag) ;</span>
<a href="#l22.147"></a><span id="l22.147" class="difflineplus">+     return new AccountBuddy(this, aBuddy, aTag);</span>
<a href="#l22.148"></a><span id="l22.148">    } catch (x) {</span>
<a href="#l22.149"></a><span id="l22.149">      dump(x + &quot;\n&quot;);</span>
<a href="#l22.150"></a><span id="l22.150">      return null;</span>
<a href="#l22.151"></a><span id="l22.151">    }</span>
<a href="#l22.152"></a><span id="l22.152">   },</span>
<a href="#l22.153"></a><span id="l22.153">   requestBuddyInfo: function(aBuddyName) {},</span>
<a href="#l22.154"></a><span id="l22.154" class="difflineplus">+  get canJoinChat() false,</span>
<a href="#l22.155"></a><span id="l22.155">   getChatRoomFields: function() {</span>
<a href="#l22.156"></a><span id="l22.156">     if (!this.chatRoomFields)</span>
<a href="#l22.157"></a><span id="l22.157">       return EmptyEnumerator;</span>
<a href="#l22.158"></a><span id="l22.158"> </span>
<a href="#l22.159"></a><span id="l22.159">     let fields = [];</span>
<a href="#l22.160"></a><span id="l22.160">     for (let fieldName in this.chatRoomFields)</span>
<a href="#l22.161"></a><span id="l22.161">       fields.push(new ChatRoomField(fieldName, this.chatRoomFields[fieldName]));</span>
<a href="#l22.162"></a><span id="l22.162">     return new nsSimpleEnumerator(fields);</span>
<a href="#l22.163"></a><span id="l22.163" class="difflineat">@@ -185,33 +184,43 @@ const GenericAccountPrototype = {</span>
<a href="#l22.164"></a><span id="l22.164">     this.prefs.prefHasUserValue(aName) ?</span>
<a href="#l22.165"></a><span id="l22.165">       this.prefs[&quot;get&quot; + aType + &quot;Pref&quot;](aName) :</span>
<a href="#l22.166"></a><span id="l22.166">       this.protocol._getOptionDefault(aName),</span>
<a href="#l22.167"></a><span id="l22.167">   getInt: function(aName) this.getPref(aName, &quot;Int&quot;),</span>
<a href="#l22.168"></a><span id="l22.168">   getString: function(aName) this.getPref(aName, &quot;Char&quot;),</span>
<a href="#l22.169"></a><span id="l22.169">   getBool: function(aName) this.getPref(aName, &quot;Bool&quot;),</span>
<a href="#l22.170"></a><span id="l22.170"> </span>
<a href="#l22.171"></a><span id="l22.171">   get prefs() this._prefs ||</span>
<a href="#l22.172"></a><span id="l22.172" class="difflineminus">-    (this._prefs = Services.prefs.getBranch(&quot;messenger.account.&quot; + this.id +</span>
<a href="#l22.173"></a><span id="l22.173" class="difflineminus">-                                            &quot;.options.&quot;)),</span>
<a href="#l22.174"></a><span id="l22.174" class="difflineplus">+    (this._prefs = Services.prefs.getBranch(&quot;messenger.account.&quot; +</span>
<a href="#l22.175"></a><span id="l22.175" class="difflineplus">+                                            this.imAccount.id + &quot;.options.&quot;)),</span>
<a href="#l22.176"></a><span id="l22.176"> </span>
<a href="#l22.177"></a><span id="l22.177">   get normalizedName() normalize(this.name),</span>
<a href="#l22.178"></a><span id="l22.178">   get proxyInfo() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l22.179"></a><span id="l22.179" class="difflineminus">-  set proxyInfo(val) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l22.180"></a><span id="l22.180" class="difflineplus">+  set proxyInfo(val) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l22.181"></a><span id="l22.181" class="difflineplus">+</span>
<a href="#l22.182"></a><span id="l22.182" class="difflineplus">+  get HTMLEnabled() true,</span>
<a href="#l22.183"></a><span id="l22.183" class="difflineplus">+  get noBackgroundColors() true,</span>
<a href="#l22.184"></a><span id="l22.184" class="difflineplus">+  get autoResponses() false,</span>
<a href="#l22.185"></a><span id="l22.185" class="difflineplus">+  get singleFormatting() false,</span>
<a href="#l22.186"></a><span id="l22.186" class="difflineplus">+  get noNewlines() false,</span>
<a href="#l22.187"></a><span id="l22.187" class="difflineplus">+  get noFontSizes() false,</span>
<a href="#l22.188"></a><span id="l22.188" class="difflineplus">+  get noUrlDesc() false,</span>
<a href="#l22.189"></a><span id="l22.189" class="difflineplus">+  get noImages() true,</span>
<a href="#l22.190"></a><span id="l22.190" class="difflineplus">+  get maxMessageLength() 0</span>
<a href="#l22.191"></a><span id="l22.191"> };</span>
<a href="#l22.192"></a><span id="l22.192"> </span>
<a href="#l22.193"></a><span id="l22.193"> </span>
<a href="#l22.194"></a><span id="l22.194"> const GenericAccountBuddyPrototype = {</span>
<a href="#l22.195"></a><span id="l22.195">   __proto__: ClassInfo(&quot;imIAccountBuddy&quot;, &quot;generic account buddy object&quot;),</span>
<a href="#l22.196"></a><span id="l22.196">   _init: function(aAccount, aBuddy, aTag, aUserName) {</span>
<a href="#l22.197"></a><span id="l22.197">     if (!aBuddy &amp;&amp; !aUserName)</span>
<a href="#l22.198"></a><span id="l22.198">       throw &quot;aUserName is required when aBuddy is null&quot;;</span>
<a href="#l22.199"></a><span id="l22.199"> </span>
<a href="#l22.200"></a><span id="l22.200">     this._tag = aTag;</span>
<a href="#l22.201"></a><span id="l22.201" class="difflineminus">-    this._account = aAccount;</span>
<a href="#l22.202"></a><span id="l22.202" class="difflineplus">+    this._account = aAccount.imAccount;</span>
<a href="#l22.203"></a><span id="l22.203">     this._buddy = aBuddy;</span>
<a href="#l22.204"></a><span id="l22.204">     this._userName = aUserName;</span>
<a href="#l22.205"></a><span id="l22.205">   },</span>
<a href="#l22.206"></a><span id="l22.206"> </span>
<a href="#l22.207"></a><span id="l22.207">   get account() this._account,</span>
<a href="#l22.208"></a><span id="l22.208">   set buddy(aBuddy) {</span>
<a href="#l22.209"></a><span id="l22.209">     if (this._buddy)</span>
<a href="#l22.210"></a><span id="l22.210">       throw Cr.NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l22.211"></a><span id="l22.211" class="difflineat">@@ -366,17 +375,17 @@ function Message(aWho, aMessage, aObject</span>
<a href="#l22.212"></a><span id="l22.212"> Message.prototype = GenericMessagePrototype;</span>
<a href="#l22.213"></a><span id="l22.213"> </span>
<a href="#l22.214"></a><span id="l22.214"> </span>
<a href="#l22.215"></a><span id="l22.215"> const GenericConversationPrototype = {</span>
<a href="#l22.216"></a><span id="l22.216">   __proto__: ClassInfo(&quot;purpleIConversation&quot;, &quot;generic conversation object&quot;),</span>
<a href="#l22.217"></a><span id="l22.217">   flags: Ci.nsIClassInfo.DOM_OBJECT,</span>
<a href="#l22.218"></a><span id="l22.218"> </span>
<a href="#l22.219"></a><span id="l22.219">   _init: function(aAccount, aName) {</span>
<a href="#l22.220"></a><span id="l22.220" class="difflineminus">-    this.account = aAccount;</span>
<a href="#l22.221"></a><span id="l22.221" class="difflineplus">+    this.account = aAccount.imAccount;</span>
<a href="#l22.222"></a><span id="l22.222">     this._name = aName;</span>
<a href="#l22.223"></a><span id="l22.223">     this._observers = [];</span>
<a href="#l22.224"></a><span id="l22.224">     Services.conversations.addConversation(this);</span>
<a href="#l22.225"></a><span id="l22.225">   },</span>
<a href="#l22.226"></a><span id="l22.226"> </span>
<a href="#l22.227"></a><span id="l22.227">   _id: 0,</span>
<a href="#l22.228"></a><span id="l22.228">   get id() this._id,</span>
<a href="#l22.229"></a><span id="l22.229">   set id(aId) {</span>
<a href="#l22.230"></a><span id="l22.230" class="difflineat">@@ -592,18 +601,22 @@ ChatRoomFieldValues.prototype = {</span>
<a href="#l22.231"></a><span id="l22.231">     this.values.hasOwnProperty(aIdentifier) ? this.values[aIdentifier] : null,</span>
<a href="#l22.232"></a><span id="l22.232">   setValue: function(aIdentifier, aValue) {</span>
<a href="#l22.233"></a><span id="l22.233">     this.values[aIdentifier] = aValue;</span>
<a href="#l22.234"></a><span id="l22.234">   }</span>
<a href="#l22.235"></a><span id="l22.235"> };</span>
<a href="#l22.236"></a><span id="l22.236"> </span>
<a href="#l22.237"></a><span id="l22.237"> // the name getter needs to be implemented</span>
<a href="#l22.238"></a><span id="l22.238"> const GenericProtocolPrototype = {</span>
<a href="#l22.239"></a><span id="l22.239" class="difflineminus">-  __proto__: ClassInfo(&quot;purpleIProtocol&quot;, &quot;Generic protocol object&quot;),</span>
<a href="#l22.240"></a><span id="l22.240" class="difflineplus">+  __proto__: ClassInfo(&quot;prplIProtocol&quot;, &quot;Generic protocol object&quot;),</span>
<a href="#l22.241"></a><span id="l22.241"> </span>
<a href="#l22.242"></a><span id="l22.242" class="difflineplus">+  init: function(aId) {</span>
<a href="#l22.243"></a><span id="l22.243" class="difflineplus">+    if (aId != this.id)</span>
<a href="#l22.244"></a><span id="l22.244" class="difflineplus">+      throw NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l22.245"></a><span id="l22.245" class="difflineplus">+  },</span>
<a href="#l22.246"></a><span id="l22.246">   get id() &quot;prpl-&quot; + this.normalizedName,</span>
<a href="#l22.247"></a><span id="l22.247">   get normalizedName() normalize(this.name),</span>
<a href="#l22.248"></a><span id="l22.248">   get iconBaseURI() &quot;chrome://instantbird/skin/prpl-generic/&quot;,</span>
<a href="#l22.249"></a><span id="l22.249"> </span>
<a href="#l22.250"></a><span id="l22.250">   getAccount: function(aKey, aName) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l22.251"></a><span id="l22.251"> </span>
<a href="#l22.252"></a><span id="l22.252">   _getOptionDefault: function(aName) {</span>
<a href="#l22.253"></a><span id="l22.253">     if (this.options &amp;&amp; this.options.hasOwnProperty(aName))</span>
<a href="#l22.254"></a><span id="l22.254" class="difflineat">@@ -666,34 +679,34 @@ const GenericProtocolPrototype = {</span>
<a href="#l22.255"></a><span id="l22.255">   get registerNoScreenName() false,</span>
<a href="#l22.256"></a><span id="l22.256">   get slashCommandsNative() false,</span>
<a href="#l22.257"></a><span id="l22.257">   get usePurpleProxy() false,</span>
<a href="#l22.258"></a><span id="l22.258"> </span>
<a href="#l22.259"></a><span id="l22.259">   get classDescription() this.name + &quot; Protocol&quot;,</span>
<a href="#l22.260"></a><span id="l22.260">   get contractID() &quot;@instantbird.org/purple/&quot; + this.normalizedName + &quot;;1&quot;</span>
<a href="#l22.261"></a><span id="l22.261"> };</span>
<a href="#l22.262"></a><span id="l22.262"> </span>
<a href="#l22.263"></a><span id="l22.263" class="difflineminus">-function ForwardAccount(aProtocol, aBaseAccount)</span>
<a href="#l22.264"></a><span id="l22.264" class="difflineplus">+function ForwardAccount(aBaseAccount)</span>
<a href="#l22.265"></a><span id="l22.265"> {</span>
<a href="#l22.266"></a><span id="l22.266" class="difflineminus">-  this._init(aProtocol, aBaseAccount);</span>
<a href="#l22.267"></a><span id="l22.267" class="difflineplus">+  this._init(aBaseAccount);</span>
<a href="#l22.268"></a><span id="l22.268"> }</span>
<a href="#l22.269"></a><span id="l22.269"> ForwardAccount.prototype = ForwardAccountPrototype;</span>
<a href="#l22.270"></a><span id="l22.270"> </span>
<a href="#l22.271"></a><span id="l22.271"> // the baseId property should be set to the prpl id of the base protocol plugin</span>
<a href="#l22.272"></a><span id="l22.272"> // and the name getter is required.</span>
<a href="#l22.273"></a><span id="l22.273"> const ForwardProtocolPrototype = {</span>
<a href="#l22.274"></a><span id="l22.274">   __proto__: GenericProtocolPrototype,</span>
<a href="#l22.275"></a><span id="l22.275"> </span>
<a href="#l22.276"></a><span id="l22.276">   get base() {</span>
<a href="#l22.277"></a><span id="l22.277">     if (!this.hasOwnProperty(&quot;_base&quot;))</span>
<a href="#l22.278"></a><span id="l22.278">       this._base = Services.core.getProtocolById(this.baseId);</span>
<a href="#l22.279"></a><span id="l22.279">     return this._base;</span>
<a href="#l22.280"></a><span id="l22.280">   },</span>
<a href="#l22.281"></a><span id="l22.281" class="difflineminus">-  getAccount: function(aKey, aName)</span>
<a href="#l22.282"></a><span id="l22.282" class="difflineminus">-    new ForwardAccount(this, this.base.getAccount(aKey, aName)),</span>
<a href="#l22.283"></a><span id="l22.283" class="difflineplus">+  getAccount: function(aImAccount)</span>
<a href="#l22.284"></a><span id="l22.284" class="difflineplus">+    new ForwardAccount(this.base.getAccount(aImAccount)),</span>
<a href="#l22.285"></a><span id="l22.285"> </span>
<a href="#l22.286"></a><span id="l22.286">   get iconBaseURI() this.base.iconBaseURI,</span>
<a href="#l22.287"></a><span id="l22.287">   getOptions: function() this.base.getOptions(),</span>
<a href="#l22.288"></a><span id="l22.288">   getUsernameSplit: function() this.base.getUsernameSplit(),</span>
<a href="#l22.289"></a><span id="l22.289">   accountExists: function(aName) this.base.accountExists(aName),</span>
<a href="#l22.290"></a><span id="l22.290">   get uniqueChatName() this.base.uniqueChatName,</span>
<a href="#l22.291"></a><span id="l22.291">   get chatHasTopic() this.base.chatHasTopic,</span>
<a href="#l22.292"></a><span id="l22.292">   get noPassword() this.base.noPassword,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/chat/protocols/jsTest/jsTestProtocol.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/chat/protocols/jsTest/jsTestProtocol.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -61,19 +61,19 @@ Conversation.prototype = {</span>
<a href="#l23.4"></a><span id="l23.4">     this.writeMessage(&quot;/dev/null&quot;, &quot;Thanks! I appreciate your attention.&quot;,</span>
<a href="#l23.5"></a><span id="l23.5">                       {incoming: true, autoResponse: true});</span>
<a href="#l23.6"></a><span id="l23.6">   },</span>
<a href="#l23.7"></a><span id="l23.7"> </span>
<a href="#l23.8"></a><span id="l23.8">   get name() &quot;/dev/null&quot;,</span>
<a href="#l23.9"></a><span id="l23.9"> };</span>
<a href="#l23.10"></a><span id="l23.10"> Conversation.prototype.__proto__ = GenericConvIMPrototype;</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-function Account(aProtoInstance, aKey, aName)</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+function Account(aProtoInstance, aImAccount)</span>
<a href="#l23.14"></a><span id="l23.14"> {</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineminus">-  this._init(aProtoInstance, aKey, aName);</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineplus">+  this._init(aProtoInstance, aImAccount);</span>
<a href="#l23.17"></a><span id="l23.17"> }</span>
<a href="#l23.18"></a><span id="l23.18"> Account.prototype = {</span>
<a href="#l23.19"></a><span id="l23.19">   connect: function() {</span>
<a href="#l23.20"></a><span id="l23.20">     this.base.connecting();</span>
<a href="#l23.21"></a><span id="l23.21">     // do something here</span>
<a href="#l23.22"></a><span id="l23.22">     this.base.connected();</span>
<a href="#l23.23"></a><span id="l23.23">     setTimeout((function() {</span>
<a href="#l23.24"></a><span id="l23.24">       this._conv = new Conversation(this);</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineat">@@ -113,17 +113,17 @@ jsTestProtocol.prototype = {</span>
<a href="#l23.26"></a><span id="l23.26">     &quot;int&quot; : {label: &quot;Integer option&quot;, default: 42},</span>
<a href="#l23.27"></a><span id="l23.27">     &quot;list&quot;: {label: &quot;Select option&quot;,  default: {&quot;option1&quot;: &quot;Default option&quot;,</span>
<a href="#l23.28"></a><span id="l23.28">                                                 &quot;option2&quot;: &quot;Other option&quot;}}</span>
<a href="#l23.29"></a><span id="l23.29">   },</span>
<a href="#l23.30"></a><span id="l23.30">   usernameSplits: [</span>
<a href="#l23.31"></a><span id="l23.31">     {label: &quot;Server&quot;, separator: &quot;@&quot;, defaultValue: &quot;default.server&quot;,</span>
<a href="#l23.32"></a><span id="l23.32">      reverse: true}</span>
<a href="#l23.33"></a><span id="l23.33">   ],</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineminus">-  getAccount: function(aKey, aName) new Account(this, aKey, aName),</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineplus">+  getAccount: function(aImAccount) new Account(this, aImAccount),</span>
<a href="#l23.36"></a><span id="l23.36">   classID: Components.ID(&quot;{a0774c5a-4aea-458b-9fbc-8d3cbf1a4630}&quot;),</span>
<a href="#l23.37"></a><span id="l23.37"> };</span>
<a href="#l23.38"></a><span id="l23.38"> jsTestProtocol.prototype.__proto__ = GenericProtocolPrototype;</span>
<a href="#l23.39"></a><span id="l23.39"> </span>
<a href="#l23.40"></a><span id="l23.40"> function overrideTestProtocol() { }</span>
<a href="#l23.41"></a><span id="l23.41"> overrideTestProtocol.prototype = {</span>
<a href="#l23.42"></a><span id="l23.42">   get normalizedName() &quot;override&quot;,</span>
<a href="#l23.43"></a><span id="l23.43">   get name() &quot;Override Test&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/chat/protocols/jsTest/jsTestProtocol.manifest</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/chat/protocols/jsTest/jsTestProtocol.manifest</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -1,6 +1,6 @@</span>
<a href="#l24.4"></a><span id="l24.4"> component {a0774c5a-4aea-458b-9fbc-8d3cbf1a4630} jsTestProtocol.js</span>
<a href="#l24.5"></a><span id="l24.5"> contract @instantbird.org/purple/jstest;1 {a0774c5a-4aea-458b-9fbc-8d3cbf1a4630}</span>
<a href="#l24.6"></a><span id="l24.6" class="difflineminus">-category js-protocol-plugin @instantbird.org/purple/jstest;1 @instantbird.org/purple/jstest;1</span>
<a href="#l24.7"></a><span id="l24.7" class="difflineplus">+category im-protocol-plugin prpl-jstest @instantbird.org/purple/jstest;1</span>
<a href="#l24.8"></a><span id="l24.8"> component {88795348-8a4b-4018-890d-5314cb08ec4d} jsTestProtocol.js</span>
<a href="#l24.9"></a><span id="l24.9"> contract @instantbird.org/purple/override;1 {88795348-8a4b-4018-890d-5314cb08ec4d}</span>
<a href="#l24.10"></a><span id="l24.10" class="difflineminus">-category js-protocol-plugin @instantbird.org/purple/override;1 @instantbird.org/purple/override;1</span>
<a href="#l24.11"></a><span id="l24.11" class="difflineplus">+category im-protocol-plugin prpl-override @instantbird.org/purple/override;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/chat/protocols/overrides/facebookOverrideProtocol.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/chat/protocols/overrides/facebookOverrideProtocol.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -56,20 +56,20 @@ UsernameSplit.prototype = {</span>
<a href="#l25.4"></a><span id="l25.4"> function facebookProtocol() { }</span>
<a href="#l25.5"></a><span id="l25.5"> facebookProtocol.prototype = {</span>
<a href="#l25.6"></a><span id="l25.6">   __proto__: ForwardProtocolPrototype,</span>
<a href="#l25.7"></a><span id="l25.7">   get normalizedName() &quot;facebook&quot;,</span>
<a href="#l25.8"></a><span id="l25.8">   get name() &quot;Facebook Chat&quot;,</span>
<a href="#l25.9"></a><span id="l25.9">   get iconBaseURI() &quot;chrome://prpl-facebook/skin/&quot;,</span>
<a href="#l25.10"></a><span id="l25.10">   get baseId() &quot;prpl-jabber&quot;,</span>
<a href="#l25.11"></a><span id="l25.11"> </span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-  getAccount: function(aKey, aName) {</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-    let account = ForwardProtocolPrototype.getAccount.call(this, aKey, aName);</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+  getAccount: function(aImAccount) {</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+    let account = ForwardProtocolPrototype.getAccount.call(this, aImAccount);</span>
<a href="#l25.16"></a><span id="l25.16">     account.__defineGetter__(&quot;canJoinChat&quot;, function() false);</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineminus">-    account.setString(&quot;connection_security&quot;, &quot;opportunistic_tls&quot;);</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineplus">+    aImAccount.setString(&quot;connection_security&quot;, &quot;opportunistic_tls&quot;);</span>
<a href="#l25.19"></a><span id="l25.19">     return account;</span>
<a href="#l25.20"></a><span id="l25.20">   },</span>
<a href="#l25.21"></a><span id="l25.21">   getOptions: function() EmptyEnumerator,</span>
<a href="#l25.22"></a><span id="l25.22">   getUsernameSplit: function() {</span>
<a href="#l25.23"></a><span id="l25.23">     var splits = this.base.getUsernameSplit();</span>
<a href="#l25.24"></a><span id="l25.24">     let newSplits = [];</span>
<a href="#l25.25"></a><span id="l25.25">     while (splits.hasMoreElements()) {</span>
<a href="#l25.26"></a><span id="l25.26">       let split = splits.getNext();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/chat/protocols/overrides/gtalkOverrideProtocol.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/chat/protocols/overrides/gtalkOverrideProtocol.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -45,21 +45,21 @@ function gtalkProtocol() {</span>
<a href="#l26.4"></a><span id="l26.4"> }</span>
<a href="#l26.5"></a><span id="l26.5"> gtalkProtocol.prototype = {</span>
<a href="#l26.6"></a><span id="l26.6">   __proto__: ForwardProtocolPrototype,</span>
<a href="#l26.7"></a><span id="l26.7">   get normalizedName() &quot;gtalk&quot;,</span>
<a href="#l26.8"></a><span id="l26.8">   get name() &quot;Google Talk&quot;,</span>
<a href="#l26.9"></a><span id="l26.9">   get iconBaseURI() &quot;chrome://prpl-gtalk/skin/&quot;,</span>
<a href="#l26.10"></a><span id="l26.10">   get baseId() &quot;prpl-jabber&quot;,</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-  getAccount: function(aKey, aName) {</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-    let account = ForwardProtocolPrototype.getAccount.call(this, aKey, aName);</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+  getAccount: function(aImAccount) {</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+    let account = ForwardProtocolPrototype.getAccount.call(this, aImAccount);</span>
<a href="#l26.16"></a><span id="l26.16">     let connectServer =</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineminus">-      /@g(oogle)?mail.com(\/|$)/.test(aName) ? &quot;&quot; : &quot;talk.google.com&quot;;</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineminus">-    account.setString(&quot;connect_server&quot;, connectServer);</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineplus">+      /@g(oogle)?mail.com(\/|$)/.test(aImAccount.name) ? &quot;&quot; : &quot;talk.google.com&quot;;</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineplus">+    aImAccount.setString(&quot;connect_server&quot;, connectServer);</span>
<a href="#l26.21"></a><span id="l26.21">     return account;</span>
<a href="#l26.22"></a><span id="l26.22">   },</span>
<a href="#l26.23"></a><span id="l26.23">   getOptions: function() EmptyEnumerator,</span>
<a href="#l26.24"></a><span id="l26.24"> </span>
<a href="#l26.25"></a><span id="l26.25">   classID: Components.ID(&quot;{ad8a6454-2f5a-40c2-86ca-30062408125e}&quot;)</span>
<a href="#l26.26"></a><span id="l26.26"> };</span>
<a href="#l26.27"></a><span id="l26.27"> </span>
<a href="#l26.28"></a><span id="l26.28"> const NSGetFactory = XPCOMUtils.generateNSGetFactory([gtalkProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/chat/protocols/overrides/overrideProtocols.manifest</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/chat/protocols/overrides/overrideProtocols.manifest</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -1,6 +1,6 @@</span>
<a href="#l27.4"></a><span id="l27.4"> component {ad8a6454-2f5a-40c2-86ca-30062408125e} gtalkOverrideProtocol.js</span>
<a href="#l27.5"></a><span id="l27.5"> contract @instantbird.org/purple/gtalk;1 {ad8a6454-2f5a-40c2-86ca-30062408125e}</span>
<a href="#l27.6"></a><span id="l27.6" class="difflineminus">-category js-protocol-plugin @instantbird.org/purple/gtalk;1 @instantbird.org/purple/gtalk;1</span>
<a href="#l27.7"></a><span id="l27.7" class="difflineplus">+category im-protocol-plugin prpl-gtalk @instantbird.org/purple/gtalk;1</span>
<a href="#l27.8"></a><span id="l27.8"> component {61bc3528-df53-4481-a61a-74c3a2e8c9fd} facebookOverrideProtocol.js</span>
<a href="#l27.9"></a><span id="l27.9"> contract @instantbird.org/purple/facebook;1 {61bc3528-df53-4481-a61a-74c3a2e8c9fd}</span>
<a href="#l27.10"></a><span id="l27.10" class="difflineminus">-category js-protocol-plugin @instantbird.org/purple/facebook;1 @instantbird.org/purple/facebook;1</span>
<a href="#l27.11"></a><span id="l27.11" class="difflineplus">+category im-protocol-plugin prpl-facebook @instantbird.org/purple/facebook;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/chat/protocols/twitter/twitter.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/chat/protocols/twitter/twitter.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -313,23 +313,21 @@ Conversation.prototype = {</span>
<a href="#l28.4"></a><span id="l28.4">     this.notifyObservers(new nsSimpleEnumerator([chatBuddy]),</span>
<a href="#l28.5"></a><span id="l28.5">                          &quot;chat-buddy-add&quot;);</span>
<a href="#l28.6"></a><span id="l28.6">   },</span>
<a href="#l28.7"></a><span id="l28.7">   get name() this.nick + &quot; timeline&quot;,</span>
<a href="#l28.8"></a><span id="l28.8">   get title() _(&quot;timeline&quot;, this.nick),</span>
<a href="#l28.9"></a><span id="l28.9">   get nick() &quot;@&quot; + this.account.name</span>
<a href="#l28.10"></a><span id="l28.10"> };</span>
<a href="#l28.11"></a><span id="l28.11"> </span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-function Account(aProtoInstance, aKey, aName)</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+function Account(aProtocol, aImAccount)</span>
<a href="#l28.14"></a><span id="l28.14"> {</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineminus">-  this._init(aProtoInstance, aKey, aName);</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineplus">+  this._init(aProtocol, aImAccount);</span>
<a href="#l28.17"></a><span id="l28.17">   this._knownMessageIds = {};</span>
<a href="#l28.18"></a><span id="l28.18">   this._userInfo = {};</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineminus">-</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineminus">-  Services.obs.addObserver(this, &quot;status-changed&quot;, false);</span>
<a href="#l28.21"></a><span id="l28.21"> }</span>
<a href="#l28.22"></a><span id="l28.22"> Account.prototype = {</span>
<a href="#l28.23"></a><span id="l28.23">   __proto__: GenericAccountPrototype,</span>
<a href="#l28.24"></a><span id="l28.24"> </span>
<a href="#l28.25"></a><span id="l28.25">   get HTMLEnabled() false,</span>
<a href="#l28.26"></a><span id="l28.26">   get maxMessageLength() 140,</span>
<a href="#l28.27"></a><span id="l28.27"> </span>
<a href="#l28.28"></a><span id="l28.28">   consumerKey: &quot;TSuyS1ieRAkB3qWv8yyEw&quot;,</span>
<a href="#l28.29"></a><span id="l28.29" class="difflineat">@@ -347,17 +345,17 @@ Account.prototype = {</span>
<a href="#l28.30"></a><span id="l28.30">   _enabled: false,</span>
<a href="#l28.31"></a><span id="l28.31"> </span>
<a href="#l28.32"></a><span id="l28.32">   token: &quot;&quot;,</span>
<a href="#l28.33"></a><span id="l28.33">   tokenSecret: &quot;&quot;,</span>
<a href="#l28.34"></a><span id="l28.34">   connect: function() {</span>
<a href="#l28.35"></a><span id="l28.35">     if (this.connected || this.connecting)</span>
<a href="#l28.36"></a><span id="l28.36">       return;</span>
<a href="#l28.37"></a><span id="l28.37"> </span>
<a href="#l28.38"></a><span id="l28.38" class="difflineminus">-    this.base.connecting();</span>
<a href="#l28.39"></a><span id="l28.39" class="difflineplus">+    this.reportConnecting();</span>
<a href="#l28.40"></a><span id="l28.40">     this._enabled = true;</span>
<a href="#l28.41"></a><span id="l28.41"> </span>
<a href="#l28.42"></a><span id="l28.42">     // Read the OAuth token from the prefs</span>
<a href="#l28.43"></a><span id="l28.43">     let prefValue = {};</span>
<a href="#l28.44"></a><span id="l28.44">     try {</span>
<a href="#l28.45"></a><span id="l28.45">       prefValue = JSON.parse(this.prefs.getCharPref(&quot;oauth&quot;));</span>
<a href="#l28.46"></a><span id="l28.46">     } catch(e) { }</span>
<a href="#l28.47"></a><span id="l28.47">     if (prefValue.hasOwnProperty(this.consumerKey)) {</span>
<a href="#l28.48"></a><span id="l28.48" class="difflineat">@@ -375,22 +373,25 @@ Account.prototype = {</span>
<a href="#l28.49"></a><span id="l28.49">       this.requestToken();</span>
<a href="#l28.50"></a><span id="l28.50">       return;</span>
<a href="#l28.51"></a><span id="l28.51">     }</span>
<a href="#l28.52"></a><span id="l28.52"> </span>
<a href="#l28.53"></a><span id="l28.53">     LOG(&quot;Connecting using existing token&quot;);</span>
<a href="#l28.54"></a><span id="l28.54">     this.getTimelines();</span>
<a href="#l28.55"></a><span id="l28.55">   },</span>
<a href="#l28.56"></a><span id="l28.56"> </span>
<a href="#l28.57"></a><span id="l28.57" class="difflineminus">-  // Currently only used for &quot;status-changed&quot; notification.</span>
<a href="#l28.58"></a><span id="l28.58">   observe: function(aSubject, aTopic, aMsg) {</span>
<a href="#l28.59"></a><span id="l28.59" class="difflineplus">+    // Currently only used for &quot;status-changed&quot; notification.</span>
<a href="#l28.60"></a><span id="l28.60" class="difflineplus">+    if (aTopic != &quot;status-changed&quot;)</span>
<a href="#l28.61"></a><span id="l28.61" class="difflineplus">+      return;</span>
<a href="#l28.62"></a><span id="l28.62" class="difflineplus">+</span>
<a href="#l28.63"></a><span id="l28.63">     if (!this._enabled)</span>
<a href="#l28.64"></a><span id="l28.64">       return;</span>
<a href="#l28.65"></a><span id="l28.65"> </span>
<a href="#l28.66"></a><span id="l28.66" class="difflineminus">-    let statusType = aSubject.currentStatusType;</span>
<a href="#l28.67"></a><span id="l28.67" class="difflineplus">+    let statusType = aSubject.statusType;</span>
<a href="#l28.68"></a><span id="l28.68">     if (statusType == Ci.imIStatusInfo.STATUS_OFFLINE) {</span>
<a href="#l28.69"></a><span id="l28.69">       // This will remove the _enabled value...</span>
<a href="#l28.70"></a><span id="l28.70">       this.disconnect();</span>
<a href="#l28.71"></a><span id="l28.71">       // ...set it again:</span>
<a href="#l28.72"></a><span id="l28.72">       this._enabled = true;</span>
<a href="#l28.73"></a><span id="l28.73">     }</span>
<a href="#l28.74"></a><span id="l28.74">     else if (statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE)</span>
<a href="#l28.75"></a><span id="l28.75">       this.connect();</span>
<a href="#l28.76"></a><span id="l28.76" class="difflineat">@@ -511,18 +512,17 @@ Account.prototype = {</span>
<a href="#l28.77"></a><span id="l28.77">                                   new Date(date) / 1000);</span>
<a href="#l28.78"></a><span id="l28.78">     }, null, this);</span>
<a href="#l28.79"></a><span id="l28.79">   },</span>
<a href="#l28.80"></a><span id="l28.80">   addBuddy: function(aTag, aName) {</span>
<a href="#l28.81"></a><span id="l28.81">     this.follow(aName);</span>
<a href="#l28.82"></a><span id="l28.82">   },</span>
<a href="#l28.83"></a><span id="l28.83"> </span>
<a href="#l28.84"></a><span id="l28.84">   getTimelines: function() {</span>
<a href="#l28.85"></a><span id="l28.85" class="difflineminus">-    this.base</span>
<a href="#l28.86"></a><span id="l28.86" class="difflineminus">-        .connecting(_(&quot;connection.requestTimelines&quot;));</span>
<a href="#l28.87"></a><span id="l28.87" class="difflineplus">+    this.reportConnecting(_(&quot;connection.requestTimelines&quot;));</span>
<a href="#l28.88"></a><span id="l28.88"> </span>
<a href="#l28.89"></a><span id="l28.89">     // If we have a last known message ID, append it as a get parameter.</span>
<a href="#l28.90"></a><span id="l28.90">     let lastMsgParam = this.prefs.prefHasUserValue(&quot;lastMessageId&quot;) ?</span>
<a href="#l28.91"></a><span id="l28.91">       &quot;&amp;since_id=&quot; + this.prefs.getCharPref(&quot;lastMessageId&quot;) : &quot;&quot;;</span>
<a href="#l28.92"></a><span id="l28.92">     let getParams = &quot;?include_entities=1&amp;count=200&quot; + lastMsgParam;</span>
<a href="#l28.93"></a><span id="l28.93">     this._pendingRequests = [</span>
<a href="#l28.94"></a><span id="l28.94">       this.signAndSend(&quot;1/statuses/home_timeline.json&quot; + getParams, null, null,</span>
<a href="#l28.95"></a><span id="l28.95">                        this.onTimelineReceived, this.onTimelineError, this),</span>
<a href="#l28.96"></a><span id="l28.96" class="difflineat">@@ -639,17 +639,17 @@ Account.prototype = {</span>
<a href="#l28.97"></a><span id="l28.97">       return;</span>
<a href="#l28.98"></a><span id="l28.98">     }</span>
<a href="#l28.99"></a><span id="l28.99"> </span>
<a href="#l28.100"></a><span id="l28.100">     // Less than 2 auth errors is probably just some flakiness of the</span>
<a href="#l28.101"></a><span id="l28.101">     // twitter servers, ignore and reset this._timelineAuthError.</span>
<a href="#l28.102"></a><span id="l28.102">     if (this._timelineAuthError)</span>
<a href="#l28.103"></a><span id="l28.103">       delete this._timelineAuthError;</span>
<a href="#l28.104"></a><span id="l28.104"> </span>
<a href="#l28.105"></a><span id="l28.105" class="difflineminus">-    this.base.connected();</span>
<a href="#l28.106"></a><span id="l28.106" class="difflineplus">+    this.reportConnected();</span>
<a href="#l28.107"></a><span id="l28.107"> </span>
<a href="#l28.108"></a><span id="l28.108">     // If the conversation already exists, notify it we are back online.</span>
<a href="#l28.109"></a><span id="l28.109">     if (this._timeline)</span>
<a href="#l28.110"></a><span id="l28.110">       this._timeline.notifyObservers(this._timeline, &quot;update-buddy-status&quot;);</span>
<a href="#l28.111"></a><span id="l28.111"> </span>
<a href="#l28.112"></a><span id="l28.112">     this._timelineBuffer.sort(this.sortByDate);</span>
<a href="#l28.113"></a><span id="l28.113">     this.displayMessages(this._timelineBuffer);</span>
<a href="#l28.114"></a><span id="l28.114"> </span>
<a href="#l28.115"></a><span id="l28.115" class="difflineat">@@ -681,17 +681,17 @@ Account.prototype = {</span>
<a href="#l28.116"></a><span id="l28.116">     this._streamingRequest =</span>
<a href="#l28.117"></a><span id="l28.117">       this.signAndSend(&quot;https://userstream.twitter.com/2/user.json&quot;,</span>
<a href="#l28.118"></a><span id="l28.118">                        null, track ? [[&quot;track&quot;, track]] : [],</span>
<a href="#l28.119"></a><span id="l28.119">                        this.openStream, this.onStreamError, this);</span>
<a href="#l28.120"></a><span id="l28.120">     this._streamingRequest.onprogress = this.onDataAvailable.bind(this);</span>
<a href="#l28.121"></a><span id="l28.121">   },</span>
<a href="#l28.122"></a><span id="l28.122">   onStreamError: function(aError) {</span>
<a href="#l28.123"></a><span id="l28.123">     delete this._streamingRequest;</span>
<a href="#l28.124"></a><span id="l28.124" class="difflineminus">-    this.gotDisconnected(this._base.ERROR_NETWORK_ERROR, aError);</span>
<a href="#l28.125"></a><span id="l28.125" class="difflineplus">+    this.gotDisconnected(Ci.prplIAccount.ERROR_NETWORK_ERROR, aError);</span>
<a href="#l28.126"></a><span id="l28.126">   },</span>
<a href="#l28.127"></a><span id="l28.127">   onDataAvailable: function(aRequest) {</span>
<a href="#l28.128"></a><span id="l28.128">     let text = aRequest.target.responseText;</span>
<a href="#l28.129"></a><span id="l28.129">     let newText = this._pendingData + text.slice(this._receivedLength);</span>
<a href="#l28.130"></a><span id="l28.130">     DEBUG(&quot;Received data: &quot; + newText);</span>
<a href="#l28.131"></a><span id="l28.131">     let messages = newText.split(/\r\n?/);</span>
<a href="#l28.132"></a><span id="l28.132">     this._pendingData = messages.pop();</span>
<a href="#l28.133"></a><span id="l28.133">     this._receivedLength = text.length;</span>
<a href="#l28.134"></a><span id="l28.134" class="difflineat">@@ -729,51 +729,51 @@ Account.prototype = {</span>
<a href="#l28.135"></a><span id="l28.135">           this.timeline.systemMessage(_(&quot;event.&quot; + event, user.screen_name),</span>
<a href="#l28.136"></a><span id="l28.136">                                       false, new Date(msg.created_at) / 1000);</span>
<a href="#l28.137"></a><span id="l28.137">         }</span>
<a href="#l28.138"></a><span id="l28.138">       }</span>
<a href="#l28.139"></a><span id="l28.139">     }</span>
<a href="#l28.140"></a><span id="l28.140">   },</span>
<a href="#l28.141"></a><span id="l28.141"> </span>
<a href="#l28.142"></a><span id="l28.142">   requestToken: function() {</span>
<a href="#l28.143"></a><span id="l28.143" class="difflineminus">-    this.base.connecting(_(&quot;connection.initAuth&quot;));</span>
<a href="#l28.144"></a><span id="l28.144" class="difflineplus">+    this.reportConnecting(_(&quot;connection.initAuth&quot;));</span>
<a href="#l28.145"></a><span id="l28.145">     let oauthParams =</span>
<a href="#l28.146"></a><span id="l28.146">       [[&quot;oauth_callback&quot;, encodeURIComponent(this.completionURI)]];</span>
<a href="#l28.147"></a><span id="l28.147">     this.signAndSend(&quot;oauth/request_token&quot;, null, [],</span>
<a href="#l28.148"></a><span id="l28.148">                      this.onRequestTokenReceived, this.onError, this,</span>
<a href="#l28.149"></a><span id="l28.149">                      oauthParams);</span>
<a href="#l28.150"></a><span id="l28.150">   },</span>
<a href="#l28.151"></a><span id="l28.151">   onRequestTokenReceived: function(aData) {</span>
<a href="#l28.152"></a><span id="l28.152">     LOG(&quot;Received request token.&quot;);</span>
<a href="#l28.153"></a><span id="l28.153">     let data = this._parseURLData(aData);</span>
<a href="#l28.154"></a><span id="l28.154">     if (!data.oauth_callback_confirmed ||</span>
<a href="#l28.155"></a><span id="l28.155">         !data.oauth_token || !data.oauth_token_secret) {</span>
<a href="#l28.156"></a><span id="l28.156" class="difflineminus">-      this.gotDisconnected(this._base.ERROR_OTHER_ERROR,</span>
<a href="#l28.157"></a><span id="l28.157" class="difflineplus">+      this.gotDisconnected(Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l28.158"></a><span id="l28.158">                            _(&quot;connection.failedToken&quot;));</span>
<a href="#l28.159"></a><span id="l28.159">       return;</span>
<a href="#l28.160"></a><span id="l28.160">     }</span>
<a href="#l28.161"></a><span id="l28.161">     this.token = data.oauth_token;</span>
<a href="#l28.162"></a><span id="l28.162">     this.tokenSecret = data.oauth_token_secret;</span>
<a href="#l28.163"></a><span id="l28.163"> </span>
<a href="#l28.164"></a><span id="l28.164">     this.requestAuthorization();</span>
<a href="#l28.165"></a><span id="l28.165">   },</span>
<a href="#l28.166"></a><span id="l28.166">   requestAuthorization: function() {</span>
<a href="#l28.167"></a><span id="l28.167" class="difflineminus">-    this.base.connecting(_(&quot;connection.requestAuth&quot;));</span>
<a href="#l28.168"></a><span id="l28.168" class="difflineplus">+    this.reportConnecting(_(&quot;connection.requestAuth&quot;));</span>
<a href="#l28.169"></a><span id="l28.169">     const url = this.baseURI + &quot;oauth/authorize?oauth_token=&quot;;</span>
<a href="#l28.170"></a><span id="l28.170">     this._browserRequest = {</span>
<a href="#l28.171"></a><span id="l28.171">       get promptText() _(&quot;authPrompt&quot;),</span>
<a href="#l28.172"></a><span id="l28.172">       account: this,</span>
<a href="#l28.173"></a><span id="l28.173">       url: url + this.token,</span>
<a href="#l28.174"></a><span id="l28.174">       _active: true,</span>
<a href="#l28.175"></a><span id="l28.175">       cancelled: function() {</span>
<a href="#l28.176"></a><span id="l28.176">         if (!this._active)</span>
<a href="#l28.177"></a><span id="l28.177">           return;</span>
<a href="#l28.178"></a><span id="l28.178"> </span>
<a href="#l28.179"></a><span id="l28.179">         this.account</span>
<a href="#l28.180"></a><span id="l28.180" class="difflineminus">-            .gotDisconnected(this.account._base.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l28.181"></a><span id="l28.181" class="difflineplus">+            .gotDisconnected(Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l28.182"></a><span id="l28.182">                              _(&quot;connection.error.authCancelled&quot;));</span>
<a href="#l28.183"></a><span id="l28.183">       },</span>
<a href="#l28.184"></a><span id="l28.184">       loaded: function(aWindow, aWebProgress) {</span>
<a href="#l28.185"></a><span id="l28.185">         if (!this._active)</span>
<a href="#l28.186"></a><span id="l28.186">           return;</span>
<a href="#l28.187"></a><span id="l28.187"> </span>
<a href="#l28.188"></a><span id="l28.188">         this._listener = {</span>
<a href="#l28.189"></a><span id="l28.189">           QueryInterface: XPCOMUtils.generateQI([Ci.nsIWebProgressListener,</span>
<a href="#l28.190"></a><span id="l28.190" class="difflineat">@@ -820,24 +820,24 @@ Account.prototype = {</span>
<a href="#l28.191"></a><span id="l28.191">     this._browserRequest._active = false;</span>
<a href="#l28.192"></a><span id="l28.192">     if (&quot;_listener&quot; in this._browserRequest)</span>
<a href="#l28.193"></a><span id="l28.193">       this._browserRequest._listener._cleanUp();</span>
<a href="#l28.194"></a><span id="l28.194">     delete this._browserRequest;</span>
<a href="#l28.195"></a><span id="l28.195">   },</span>
<a href="#l28.196"></a><span id="l28.196">   onAuthorizationReceived: function(aData) {</span>
<a href="#l28.197"></a><span id="l28.197">     let data = this._parseURLData(aData.split(&quot;?&quot;)[1]);</span>
<a href="#l28.198"></a><span id="l28.198">     if (data.oauth_token != this.token || !data.oauth_verifier) {</span>
<a href="#l28.199"></a><span id="l28.199" class="difflineminus">-      this.gotDisconnected(this._base.ERROR_OTHER_ERROR,</span>
<a href="#l28.200"></a><span id="l28.200" class="difflineplus">+      this.gotDisconnected(Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l28.201"></a><span id="l28.201">                            _(&quot;connection.error.authFailed&quot;));</span>
<a href="#l28.202"></a><span id="l28.202">       return;</span>
<a href="#l28.203"></a><span id="l28.203">     }</span>
<a href="#l28.204"></a><span id="l28.204">     this.requestAccessToken(data.oauth_verifier);</span>
<a href="#l28.205"></a><span id="l28.205">   },</span>
<a href="#l28.206"></a><span id="l28.206">   requestAccessToken: function(aTokenVerifier) {</span>
<a href="#l28.207"></a><span id="l28.207" class="difflineminus">-    this.base.connecting(_(&quot;connection.requestAccess&quot;));</span>
<a href="#l28.208"></a><span id="l28.208" class="difflineplus">+    this.reportConnecting(_(&quot;connection.requestAccess&quot;));</span>
<a href="#l28.209"></a><span id="l28.209">     this.signAndSend(&quot;oauth/access_token&quot;, null, [],</span>
<a href="#l28.210"></a><span id="l28.210">                      this.onAccessTokenReceived, this.onError, this,</span>
<a href="#l28.211"></a><span id="l28.211">                      [[&quot;oauth_verifier&quot;, aTokenVerifier]]);</span>
<a href="#l28.212"></a><span id="l28.212">   },</span>
<a href="#l28.213"></a><span id="l28.213">   onAccessTokenReceived: function(aData) {</span>
<a href="#l28.214"></a><span id="l28.214">     LOG(&quot;Received access token.&quot;);</span>
<a href="#l28.215"></a><span id="l28.215">     let result = this._parseURLData(aData);</span>
<a href="#l28.216"></a><span id="l28.216">     if (result.screen_name &amp;&amp; result.screen_name != this.name) {</span>
<a href="#l28.217"></a><span id="l28.217" class="difflineat">@@ -873,52 +873,50 @@ Account.prototype = {</span>
<a href="#l28.218"></a><span id="l28.218">     delete this.token;</span>
<a href="#l28.219"></a><span id="l28.219">     delete this.tokenSecret;</span>
<a href="#l28.220"></a><span id="l28.220">   },</span>
<a href="#l28.221"></a><span id="l28.221">   gotDisconnected: function(aError, aErrorMessage) {</span>
<a href="#l28.222"></a><span id="l28.222">     if (this.disconnected || this.disconnecting)</span>
<a href="#l28.223"></a><span id="l28.223">       return;</span>
<a href="#l28.224"></a><span id="l28.224"> </span>
<a href="#l28.225"></a><span id="l28.225">     if (aError === undefined)</span>
<a href="#l28.226"></a><span id="l28.226" class="difflineminus">-      aError = this._base.NO_ERROR;</span>
<a href="#l28.227"></a><span id="l28.227" class="difflineplus">+      aError = Ci.prplIAccount.NO_ERROR;</span>
<a href="#l28.228"></a><span id="l28.228">     let connected = this.connected;</span>
<a href="#l28.229"></a><span id="l28.229" class="difflineminus">-    this.base.disconnecting(aError, aErrorMessage);</span>
<a href="#l28.230"></a><span id="l28.230" class="difflineplus">+    this.reportDisconnecting(aError, aErrorMessage);</span>
<a href="#l28.231"></a><span id="l28.231">     this.cleanUp();</span>
<a href="#l28.232"></a><span id="l28.232">     if (this._timeline &amp;&amp; connected)</span>
<a href="#l28.233"></a><span id="l28.233">       this._timeline.notifyObservers(this._timeline, &quot;update-conv-chatleft&quot;);</span>
<a href="#l28.234"></a><span id="l28.234">     delete this._enabled;</span>
<a href="#l28.235"></a><span id="l28.235" class="difflineminus">-    this.base.disconnected();</span>
<a href="#l28.236"></a><span id="l28.236" class="difflineplus">+    this.reportDisconnected();</span>
<a href="#l28.237"></a><span id="l28.237">   },</span>
<a href="#l28.238"></a><span id="l28.238" class="difflineminus">-  UnInit: function() {</span>
<a href="#l28.239"></a><span id="l28.239" class="difflineplus">+  unInit: function() {</span>
<a href="#l28.240"></a><span id="l28.240">     this.cleanUp();</span>
<a href="#l28.241"></a><span id="l28.241">     // If we've received any messages, update the last known message.</span>
<a href="#l28.242"></a><span id="l28.242">     let newestMessageId = &quot;&quot;;</span>
<a href="#l28.243"></a><span id="l28.243">     for (let id in this._knownMessageIds) {</span>
<a href="#l28.244"></a><span id="l28.244">       // Compare the length of the ids first, and then the text.</span>
<a href="#l28.245"></a><span id="l28.245">       // This avoids converting tweet ids into rounded numbers.</span>
<a href="#l28.246"></a><span id="l28.246">       if (id.length &gt; newestMessageId.length ||</span>
<a href="#l28.247"></a><span id="l28.247">           (id.length == newestMessageId.length &amp;&amp; id &gt; newestMessageId))</span>
<a href="#l28.248"></a><span id="l28.248">         newestMessageId = id;</span>
<a href="#l28.249"></a><span id="l28.249">     }</span>
<a href="#l28.250"></a><span id="l28.250">     if (newestMessageId)</span>
<a href="#l28.251"></a><span id="l28.251">       this.prefs.setCharPref(&quot;lastMessageId&quot;, newestMessageId);</span>
<a href="#l28.252"></a><span id="l28.252" class="difflineminus">-    Services.obs.removeObserver(this, &quot;status-changed&quot;);</span>
<a href="#l28.253"></a><span id="l28.253" class="difflineminus">-    this._base.UnInit();</span>
<a href="#l28.254"></a><span id="l28.254">   },</span>
<a href="#l28.255"></a><span id="l28.255">   disconnect: function() {</span>
<a href="#l28.256"></a><span id="l28.256">     this.gotDisconnected();</span>
<a href="#l28.257"></a><span id="l28.257">   },</span>
<a href="#l28.258"></a><span id="l28.258"> </span>
<a href="#l28.259"></a><span id="l28.259">   onError: function(aException) {</span>
<a href="#l28.260"></a><span id="l28.260">     if (aException == &quot;offline&quot;) {</span>
<a href="#l28.261"></a><span id="l28.261" class="difflineminus">-      this.gotDisconnected(this._base.ERROR_NETWORK_ERROR,</span>
<a href="#l28.262"></a><span id="l28.262" class="difflineplus">+      this.gotDisconnected(Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l28.263"></a><span id="l28.263">                            _(&quot;connection.error.noNetwork&quot;));</span>
<a href="#l28.264"></a><span id="l28.264">     }</span>
<a href="#l28.265"></a><span id="l28.265">     else</span>
<a href="#l28.266"></a><span id="l28.266" class="difflineminus">-      this.gotDisconnected(this._base.ERROR_OTHER_ERROR, aException.toString());</span>
<a href="#l28.267"></a><span id="l28.267" class="difflineplus">+      this.gotDisconnected(Ci.prplIAccount.ERROR_OTHER_ERROR, aException.toString());</span>
<a href="#l28.268"></a><span id="l28.268">   },</span>
<a href="#l28.269"></a><span id="l28.269"> </span>
<a href="#l28.270"></a><span id="l28.270">   onRequestedInfoReceived: function(aData) {</span>
<a href="#l28.271"></a><span id="l28.271">     let user = JSON.parse(aData);</span>
<a href="#l28.272"></a><span id="l28.272">     this._userInfo[user.screen_name] = user;</span>
<a href="#l28.273"></a><span id="l28.273">     this.requestBuddyInfo(user.screen_name);</span>
<a href="#l28.274"></a><span id="l28.274">   },</span>
<a href="#l28.275"></a><span id="l28.275">   requestBuddyInfo: function(aBuddyName) {</span>
<a href="#l28.276"></a><span id="l28.276" class="difflineat">@@ -982,13 +980,13 @@ function TwitterProtocol() { }</span>
<a href="#l28.277"></a><span id="l28.277"> TwitterProtocol.prototype = {</span>
<a href="#l28.278"></a><span id="l28.278">   __proto__: GenericProtocolPrototype,</span>
<a href="#l28.279"></a><span id="l28.279">   get name() &quot;Twitter&quot;,</span>
<a href="#l28.280"></a><span id="l28.280">   get iconBaseURI() &quot;chrome://prpl-twitter/skin/&quot;,</span>
<a href="#l28.281"></a><span id="l28.281">   get noPassword() true,</span>
<a href="#l28.282"></a><span id="l28.282">   options: {</span>
<a href="#l28.283"></a><span id="l28.283">     &quot;track&quot;: {get label() _(&quot;options.track&quot;), default: &quot;&quot;}</span>
<a href="#l28.284"></a><span id="l28.284">   },</span>
<a href="#l28.285"></a><span id="l28.285" class="difflineminus">-  getAccount: function(aKey, aName) new Account(this, aKey, aName),</span>
<a href="#l28.286"></a><span id="l28.286" class="difflineplus">+  getAccount: function(aImAccount) new Account(this, aImAccount),</span>
<a href="#l28.287"></a><span id="l28.287">   classID: Components.ID(&quot;{31082ff6-1de8-422b-ab60-ca0ac0b2af13}&quot;)</span>
<a href="#l28.288"></a><span id="l28.288"> };</span>
<a href="#l28.289"></a><span id="l28.289"> </span>
<a href="#l28.290"></a><span id="l28.290"> const NSGetFactory = XPCOMUtils.generateNSGetFactory([TwitterProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/chat/protocols/twitter/twitter.manifest</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/chat/protocols/twitter/twitter.manifest</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -1,3 +1,3 @@</span>
<a href="#l29.4"></a><span id="l29.4"> component {31082ff6-1de8-422b-ab60-ca0ac0b2af13} twitter.js</span>
<a href="#l29.5"></a><span id="l29.5"> contract @instantbird.org/purple/twitter;1 {31082ff6-1de8-422b-ab60-ca0ac0b2af13}</span>
<a href="#l29.6"></a><span id="l29.6" class="difflineminus">-category js-protocol-plugin @instantbird.org/purple/twitter;1 @instantbird.org/purple/twitter;1</span>
<a href="#l29.7"></a><span id="l29.7" class="difflineplus">+category im-protocol-plugin prpl-twitter @instantbird.org/purple/twitter;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/im/components/ibCommandLineHandler.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/im/components/ibCommandLineHandler.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -32,33 +32,33 @@</span>
<a href="#l30.4"></a><span id="l30.4">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l30.5"></a><span id="l30.5">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l30.6"></a><span id="l30.6">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l30.7"></a><span id="l30.7">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l30.8"></a><span id="l30.8">  *</span>
<a href="#l30.9"></a><span id="l30.9">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l30.10"></a><span id="l30.10"> </span>
<a href="#l30.11"></a><span id="l30.11"> const {classes: Cc, interfaces: Ci, utils: Cu} = Components;</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineplus">+Cu.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l30.13"></a><span id="l30.13"> Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l30.14"></a><span id="l30.14"> Cu.import(&quot;resource:///modules/ibCore.jsm&quot;);</span>
<a href="#l30.15"></a><span id="l30.15"> </span>
<a href="#l30.16"></a><span id="l30.16"> function ibCommandLineHandler() { }</span>
<a href="#l30.17"></a><span id="l30.17"> </span>
<a href="#l30.18"></a><span id="l30.18"> ibCommandLineHandler.prototype = {</span>
<a href="#l30.19"></a><span id="l30.19">   handle: function clh_handle(cmdLine) {</span>
<a href="#l30.20"></a><span id="l30.20">     if (cmdLine.handleFlag(&quot;preferences&quot;, false)) {</span>
<a href="#l30.21"></a><span id="l30.21">       Core.showPreferences();</span>
<a href="#l30.22"></a><span id="l30.22">       cmdLine.preventDefault = true;</span>
<a href="#l30.23"></a><span id="l30.23">       return;</span>
<a href="#l30.24"></a><span id="l30.24">     }</span>
<a href="#l30.25"></a><span id="l30.25"> </span>
<a href="#l30.26"></a><span id="l30.26">     if (cmdLine.handleFlag(&quot;n&quot;, false)) {</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineminus">-      Components.classes[&quot;@instantbird.org/purple/core;1&quot;]</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineminus">-                .getService(Ci.purpleICoreService)</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineminus">-                .autoLoginStatus = Ci.purpleICoreService.AUTOLOGIN_USER_DISABLED;</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineplus">+      Services.accounts.autoLoginStatus =</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineplus">+        Ci.imIAccountsService.AUTOLOGIN_USER_DISABLED;</span>
<a href="#l30.32"></a><span id="l30.32">     }</span>
<a href="#l30.33"></a><span id="l30.33"> </span>
<a href="#l30.34"></a><span id="l30.34">     // Initialize the core only at the first real startup,</span>
<a href="#l30.35"></a><span id="l30.35">     // not when clicking the dock.</span>
<a href="#l30.36"></a><span id="l30.36">     if (cmdLine.state == cmdLine.STATE_INITIAL_LAUNCH) {</span>
<a href="#l30.37"></a><span id="l30.37">       // If the core failed to init, don't show the buddy list</span>
<a href="#l30.38"></a><span id="l30.38">       if (!Core.init())</span>
<a href="#l30.39"></a><span id="l30.39">         cmdLine.preventDefault = true;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/im/components/ibStatusCommandLineHandler.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/im/components/ibStatusCommandLineHandler.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -55,18 +55,18 @@ StatusCLH.prototype = {</span>
<a href="#l31.4"></a><span id="l31.4">       return;</span>
<a href="#l31.5"></a><span id="l31.5"> </span>
<a href="#l31.6"></a><span id="l31.6">     let statusParam = cmdLine.getArgument(statusIndex + 1).toLowerCase();</span>
<a href="#l31.7"></a><span id="l31.7"> </span>
<a href="#l31.8"></a><span id="l31.8">     // Remove the arguments since they've been handled.</span>
<a href="#l31.9"></a><span id="l31.9">     cmdLine.removeArguments(statusIndex, statusIndex + 1);</span>
<a href="#l31.10"></a><span id="l31.10"> </span>
<a href="#l31.11"></a><span id="l31.11">     // We're keeping the old status message here.</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-    Services.core.setStatus(Status.toFlag(statusParam),</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineminus">-                            Services.core.currentStatusMessage);</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineplus">+    let us = Services.core.globalUserStatus;</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineplus">+    us.setStatus(Status.toFlag(statusParam), us.statusText);</span>
<a href="#l31.16"></a><span id="l31.16"> </span>
<a href="#l31.17"></a><span id="l31.17">     // Only perform the default action (i.e. loading the buddy list) if</span>
<a href="#l31.18"></a><span id="l31.18">     // Instantbird is launched with a status flag.</span>
<a href="#l31.19"></a><span id="l31.19">     if (cmdLine.state != Ci.nsICommandLine.STATE_INITIAL_LAUNCH)</span>
<a href="#l31.20"></a><span id="l31.20">       cmdLine.preventDefault = true;</span>
<a href="#l31.21"></a><span id="l31.21">   },</span>
<a href="#l31.22"></a><span id="l31.22"> </span>
<a href="#l31.23"></a><span id="l31.23">   // Follow the guidelines in nsICommandLineHandler.idl for the help info</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/im/components/mintrayr/content/mintrayr.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/im/components/mintrayr/content/mintrayr.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -123,14 +123,14 @@ var gMinTrayR = {</span>
<a href="#l32.4"></a><span id="l32.4"> </span>
<a href="#l32.5"></a><span id="l32.5">     if (this._icon.isMinimized)</span>
<a href="#l32.6"></a><span id="l32.6">       this._icon.restore();</span>
<a href="#l32.7"></a><span id="l32.7">     else</span>
<a href="#l32.8"></a><span id="l32.8">       this._icon.minimize();</span>
<a href="#l32.9"></a><span id="l32.9">   },</span>
<a href="#l32.10"></a><span id="l32.10"> </span>
<a href="#l32.11"></a><span id="l32.11">   setStatus: function MinTrayR_setStatus(aStatusParam) {</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-    Services.core.setStatus(Status.toFlag(aStatusParam),</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">-                            Services.core.currentStatusMessage);</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineplus">+    let us = Services.core.globalUserStatus;</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineplus">+    us.setStatus(Status.toFlag(aStatusParam), us.statusText);</span>
<a href="#l32.16"></a><span id="l32.16">   }</span>
<a href="#l32.17"></a><span id="l32.17"> };</span>
<a href="#l32.18"></a><span id="l32.18"> </span>
<a href="#l32.19"></a><span id="l32.19"> window.addEventListener(&quot;load&quot;, gMinTrayR.load, true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/im/content/aboutDialog.xul</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/im/content/aboutDialog.xul</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -77,17 +77,17 @@</span>
<a href="#l33.4"></a><span id="l33.4">           var versionField = document.getElementById(&quot;versionField&quot;);</span>
<a href="#l33.5"></a><span id="l33.5">           versionField.value = versionField.value + xai.version</span>
<a href="#l33.6"></a><span id="l33.6">                              + ' (' + xai.appBuildID + ')';</span>
<a href="#l33.7"></a><span id="l33.7"> </span>
<a href="#l33.8"></a><span id="l33.8">           versionField = document.getElementById(&quot;geckoVersionField&quot;);</span>
<a href="#l33.9"></a><span id="l33.9">           versionField.value = versionField.value + xai.platformVersion</span>
<a href="#l33.10"></a><span id="l33.10">                              + ' (' + xai.platformBuildID + ')';</span>
<a href="#l33.11"></a><span id="l33.11"> </span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-          var pcs = Components.classes[&quot;@instantbird.org/purple/core;1&quot;]</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+          var pcs = Components.classes[&quot;@instantbird.org/libpurple/core;1&quot;]</span>
<a href="#l33.14"></a><span id="l33.14">                               .getService(Components.interfaces.purpleICoreService)</span>
<a href="#l33.15"></a><span id="l33.15">           versionField = document.getElementById(&quot;libpurpleVersionField&quot;);</span>
<a href="#l33.16"></a><span id="l33.16">           versionField.value = versionField.value + pcs.version;</span>
<a href="#l33.17"></a><span id="l33.17"> </span>
<a href="#l33.18"></a><span id="l33.18">           versionField = document.getElementById(&quot;userAgentField&quot;);</span>
<a href="#l33.19"></a><span id="l33.19">           versionField.value = navigator.userAgent;</span>
<a href="#l33.20"></a><span id="l33.20"> </span>
<a href="#l33.21"></a><span id="l33.21">           var button = document.documentElement.getButton(&quot;extra2&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/im/content/account.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/im/content/account.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -33,17 +33,17 @@</span>
<a href="#l34.4"></a><span id="l34.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l34.5"></a><span id="l34.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l34.6"></a><span id="l34.6">  *</span>
<a href="#l34.7"></a><span id="l34.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l34.8"></a><span id="l34.8"> </span>
<a href="#l34.9"></a><span id="l34.9"> const autoJoinPref = &quot;autoJoin&quot;;</span>
<a href="#l34.10"></a><span id="l34.10"> </span>
<a href="#l34.11"></a><span id="l34.11"> const events = [</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-  &quot;purple-quit&quot;</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+  &quot;prpl-quit&quot;</span>
<a href="#l34.14"></a><span id="l34.14"> ];</span>
<a href="#l34.15"></a><span id="l34.15"> </span>
<a href="#l34.16"></a><span id="l34.16"> var account = {</span>
<a href="#l34.17"></a><span id="l34.17">   onload: function account_onload() {</span>
<a href="#l34.18"></a><span id="l34.18">     this.account = window.arguments[0];</span>
<a href="#l34.19"></a><span id="l34.19">     this.proto = this.account.protocol;</span>
<a href="#l34.20"></a><span id="l34.20">     document.getElementById(&quot;accountName&quot;).value = this.account.name;</span>
<a href="#l34.21"></a><span id="l34.21">     document.getElementById(&quot;protocolName&quot;).value = this.proto.name || this.proto.id;</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineat">@@ -89,29 +89,30 @@ var account = {</span>
<a href="#l34.23"></a><span id="l34.23"> </span>
<a href="#l34.24"></a><span id="l34.24">     addObservers(this, events);</span>
<a href="#l34.25"></a><span id="l34.25">     window.addEventListener(&quot;unload&quot;, this.unload);</span>
<a href="#l34.26"></a><span id="l34.26">   },</span>
<a href="#l34.27"></a><span id="l34.27">   unload: function account_unload() {</span>
<a href="#l34.28"></a><span id="l34.28">     removeObservers(account, events);</span>
<a href="#l34.29"></a><span id="l34.29">   },</span>
<a href="#l34.30"></a><span id="l34.30">   observe: function account_observe(aObject, aTopic, aData) {</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineminus">-    if (aTopic == &quot;purple-quit&quot;) {</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineplus">+    if (aTopic == &quot;prpl-quit&quot;) {</span>
<a href="#l34.33"></a><span id="l34.33">       // libpurple is being uninitialized. Close this dialog.</span>
<a href="#l34.34"></a><span id="l34.34">       window.close();</span>
<a href="#l34.35"></a><span id="l34.35">     }</span>
<a href="#l34.36"></a><span id="l34.36">   },</span>
<a href="#l34.37"></a><span id="l34.37"> </span>
<a href="#l34.38"></a><span id="l34.38">   displayProxyDescription: function account_displayProxyDescription() {</span>
<a href="#l34.39"></a><span id="l34.39">     var type = this.proxy.type;</span>
<a href="#l34.40"></a><span id="l34.40">     var bundle = document.getElementById(&quot;proxiesBundle&quot;);</span>
<a href="#l34.41"></a><span id="l34.41">     var proxy;</span>
<a href="#l34.42"></a><span id="l34.42">     var result;</span>
<a href="#l34.43"></a><span id="l34.43">     if (type == Ci.purpleIProxyInfo.useGlobal) {</span>
<a href="#l34.44"></a><span id="l34.44" class="difflineminus">-      proxy = Services.core.globalProxy;</span>
<a href="#l34.45"></a><span id="l34.45" class="difflineplus">+      proxy = Cc[&quot;@instantbird.org/libpurple/core;1&quot;]</span>
<a href="#l34.46"></a><span id="l34.46" class="difflineplus">+              .getService(Ci.purpleICoreService).globalProxy;</span>
<a href="#l34.47"></a><span id="l34.47">       type = proxy.type;</span>
<a href="#l34.48"></a><span id="l34.48">     }</span>
<a href="#l34.49"></a><span id="l34.49">     else</span>
<a href="#l34.50"></a><span id="l34.50">       proxy = this.proxy;</span>
<a href="#l34.51"></a><span id="l34.51"> </span>
<a href="#l34.52"></a><span id="l34.52">     if (type == Ci.purpleIProxyInfo.noProxy)</span>
<a href="#l34.53"></a><span id="l34.53">       result = bundle.getString(&quot;proxies.directConnection&quot;);</span>
<a href="#l34.54"></a><span id="l34.54"> </span>
<a href="#l34.55"></a><span id="l34.55" class="difflineat">@@ -317,29 +318,29 @@ var account = {</span>
<a href="#l34.56"></a><span id="l34.56">         break;</span>
<a href="#l34.57"></a><span id="l34.57">       default:</span>
<a href="#l34.58"></a><span id="l34.58">         throw &quot;unknown preference type &quot; + opt.type;</span>
<a href="#l34.59"></a><span id="l34.59">       }</span>
<a href="#l34.60"></a><span id="l34.60">     }</span>
<a href="#l34.61"></a><span id="l34.61"> </span>
<a href="#l34.62"></a><span id="l34.62">     if (connectionInfoHasChanged) {</span>
<a href="#l34.63"></a><span id="l34.63">       /* This is the first time we try to connect with these parameters */</span>
<a href="#l34.64"></a><span id="l34.64" class="difflineminus">-      this.account.firstConnectionState = this.account.FIRST_CONNECTION_SET;</span>
<a href="#l34.65"></a><span id="l34.65" class="difflineplus">+      this.account.firstConnectionState = this.account.FIRST_CONNECTION_UNKNOWN;</span>
<a href="#l34.66"></a><span id="l34.66"> </span>
<a href="#l34.67"></a><span id="l34.67">       if (this.account.connecting) {</span>
<a href="#l34.68"></a><span id="l34.68">         this.account.disconnect();</span>
<a href="#l34.69"></a><span id="l34.69">         this.account.connect();</span>
<a href="#l34.70"></a><span id="l34.70">         return;</span>
<a href="#l34.71"></a><span id="l34.71">       }</span>
<a href="#l34.72"></a><span id="l34.72">       let errorReason = this.account.connectionErrorReason;</span>
<a href="#l34.73"></a><span id="l34.73">       if (this.account.disconnected &amp;&amp;</span>
<a href="#l34.74"></a><span id="l34.74" class="difflineminus">-          errorReason != Ci.purpleIAccount.NO_ERROR &amp;&amp;</span>
<a href="#l34.75"></a><span id="l34.75" class="difflineminus">-          errorReason != Ci.purpleIAccount.ERROR_MISSING_PASSWORD &amp;&amp;</span>
<a href="#l34.76"></a><span id="l34.76" class="difflineminus">-          errorReason != Ci.purpleIAccount.ERROR_CRASHED &amp;&amp;</span>
<a href="#l34.77"></a><span id="l34.77" class="difflineminus">-          errorReason != Ci.purpleIAccount.ERROR_UNKNOWN_PRPL) {</span>
<a href="#l34.78"></a><span id="l34.78" class="difflineplus">+          errorReason != Ci.prplIAccount.NO_ERROR &amp;&amp;</span>
<a href="#l34.79"></a><span id="l34.79" class="difflineplus">+          errorReason != Ci.imIAccount.ERROR_MISSING_PASSWORD &amp;&amp;</span>
<a href="#l34.80"></a><span id="l34.80" class="difflineplus">+          errorReason != Ci.imIAccount.ERROR_CRASHED &amp;&amp;</span>
<a href="#l34.81"></a><span id="l34.81" class="difflineplus">+          errorReason != Ci.imIAccount.ERROR_UNKNOWN_PRPL) {</span>
<a href="#l34.82"></a><span id="l34.82">         this.account.connect();</span>
<a href="#l34.83"></a><span id="l34.83">       }</span>
<a href="#l34.84"></a><span id="l34.84">     }</span>
<a href="#l34.85"></a><span id="l34.85">   },</span>
<a href="#l34.86"></a><span id="l34.86"> </span>
<a href="#l34.87"></a><span id="l34.87">   getProtoOptions: function account_getProtoOptions() {</span>
<a href="#l34.88"></a><span id="l34.88">     return getIter(this.proto.getOptions());</span>
<a href="#l34.89"></a><span id="l34.89">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/im/content/account.xml</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/im/content/account.xml</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -90,17 +90,17 @@</span>
<a href="#l35.4"></a><span id="l35.4">         this.setAttribute(&quot;protocol&quot;, proto.name);</span>
<a href="#l35.5"></a><span id="l35.5">         this.setAttribute(&quot;prplicon&quot;, proto.iconBaseURI + &quot;icon32.png&quot;);</span>
<a href="#l35.6"></a><span id="l35.6">         var state = &quot;Unknown&quot;;</span>
<a href="#l35.7"></a><span id="l35.7">         if (this._account.connected) {</span>
<a href="#l35.8"></a><span id="l35.8">           state = &quot;connected&quot;;</span>
<a href="#l35.9"></a><span id="l35.9">           this.refreshConnectedLabel();</span>
<a href="#l35.10"></a><span id="l35.10">         } else if (this._account.disconnected) {</span>
<a href="#l35.11"></a><span id="l35.11">           state = &quot;disconnected&quot;;</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-          if (this._account.connectionErrorReason != Ci.purpleIAccount.NO_ERROR)</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+          if (this._account.connectionErrorReason != Ci.prplIAccount.NO_ERROR)</span>
<a href="#l35.14"></a><span id="l35.14">             this.updateConnectionError();</span>
<a href="#l35.15"></a><span id="l35.15">           else</span>
<a href="#l35.16"></a><span id="l35.16">             this.removeAttribute(&quot;error&quot;);</span>
<a href="#l35.17"></a><span id="l35.17">         } else if (this._account.connecting) {</span>
<a href="#l35.18"></a><span id="l35.18">           state = &quot;connecting&quot;;</span>
<a href="#l35.19"></a><span id="l35.19">           this.updateConnectionState();</span>
<a href="#l35.20"></a><span id="l35.20">         } else if (this._account.disconnecting) {</span>
<a href="#l35.21"></a><span id="l35.21">           state = &quot;connected&quot;;</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineat">@@ -131,22 +131,22 @@</span>
<a href="#l35.23"></a><span id="l35.23">      &lt;method name=&quot;updateConnectionError&quot;&gt;</span>
<a href="#l35.24"></a><span id="l35.24">       &lt;body&gt;</span>
<a href="#l35.25"></a><span id="l35.25">       &lt;![CDATA[</span>
<a href="#l35.26"></a><span id="l35.26">         var bundle = document.getElementById(&quot;accountsBundle&quot;);</span>
<a href="#l35.27"></a><span id="l35.27">         const key = &quot;account.connection.error&quot;;</span>
<a href="#l35.28"></a><span id="l35.28">         var account = this._account;</span>
<a href="#l35.29"></a><span id="l35.29">         var text;</span>
<a href="#l35.30"></a><span id="l35.30">         let errorReason = account.connectionErrorReason;</span>
<a href="#l35.31"></a><span id="l35.31" class="difflineminus">-        if (errorReason == Ci.purpleIAccount.ERROR_UNKNOWN_PRPL)</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineplus">+        if (errorReason == Ci.imIAccount.ERROR_UNKNOWN_PRPL)</span>
<a href="#l35.33"></a><span id="l35.33">           text = bundle.getFormattedString(key + &quot;UnknownPrpl&quot;,</span>
<a href="#l35.34"></a><span id="l35.34">                                            [account.protocol.id]);</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineminus">-        else if (errorReason == Ci.purpleIAccount.ERROR_MISSING_PASSWORD)</span>
<a href="#l35.36"></a><span id="l35.36" class="difflineplus">+        else if (errorReason == Ci.imIAccount.ERROR_MISSING_PASSWORD)</span>
<a href="#l35.37"></a><span id="l35.37">           text = bundle.getString(key + &quot;MissingPassword&quot;);</span>
<a href="#l35.38"></a><span id="l35.38" class="difflineminus">-        else if (errorReason == Ci.purpleIAccount.ERROR_CRASHED)</span>
<a href="#l35.39"></a><span id="l35.39" class="difflineplus">+        else if (errorReason == Ci.imIAccount.ERROR_CRASHED)</span>
<a href="#l35.40"></a><span id="l35.40">           text = bundle.getString(key + &quot;CrashedAccount&quot;);</span>
<a href="#l35.41"></a><span id="l35.41">         else</span>
<a href="#l35.42"></a><span id="l35.42">           text = account.connectionErrorMessage;</span>
<a href="#l35.43"></a><span id="l35.43">         text = bundle.getFormattedString(key, [text]);</span>
<a href="#l35.44"></a><span id="l35.44"> </span>
<a href="#l35.45"></a><span id="l35.45">         this.setAttribute(&quot;error&quot;, &quot;true&quot;);</span>
<a href="#l35.46"></a><span id="l35.46">         var error = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;,</span>
<a href="#l35.47"></a><span id="l35.47">                                                             &quot;error&quot;);</span>
<a href="#l35.48"></a><span id="l35.48" class="difflineat">@@ -225,17 +225,17 @@</span>
<a href="#l35.49"></a><span id="l35.49">      &lt;method name=&quot;restoreItems&quot;&gt;</span>
<a href="#l35.50"></a><span id="l35.50">        &lt;body&gt;</span>
<a href="#l35.51"></a><span id="l35.51">        &lt;![CDATA[</span>
<a href="#l35.52"></a><span id="l35.52">          // Called after a removal and reinsertion of the binding</span>
<a href="#l35.53"></a><span id="l35.53">          this._buttons = null;</span>
<a href="#l35.54"></a><span id="l35.54">          this._connectedLabel = null;</span>
<a href="#l35.55"></a><span id="l35.55">          if (this._account.connected)</span>
<a href="#l35.56"></a><span id="l35.56">            this.refreshConnectedLabel();</span>
<a href="#l35.57"></a><span id="l35.57" class="difflineminus">-         if (this._account.connectionErrorReason == Ci.purpleIAccount.NO_ERROR)</span>
<a href="#l35.58"></a><span id="l35.58" class="difflineplus">+         if (this._account.connectionErrorReason == Ci.prplIAccount.NO_ERROR)</span>
<a href="#l35.59"></a><span id="l35.59">            this.updateConnectionState();</span>
<a href="#l35.60"></a><span id="l35.60">          else</span>
<a href="#l35.61"></a><span id="l35.61">            this.updateConnectionError();</span>
<a href="#l35.62"></a><span id="l35.62">        ]]&gt;</span>
<a href="#l35.63"></a><span id="l35.63">        &lt;/body&gt;</span>
<a href="#l35.64"></a><span id="l35.64">      &lt;/method&gt;</span>
<a href="#l35.65"></a><span id="l35.65"> </span>
<a href="#l35.66"></a><span id="l35.66">      &lt;method name=&quot;destroy&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/im/content/accountWizard.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/im/content/accountWizard.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -34,17 +34,17 @@</span>
<a href="#l36.4"></a><span id="l36.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l36.5"></a><span id="l36.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l36.6"></a><span id="l36.6">  *</span>
<a href="#l36.7"></a><span id="l36.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l36.8"></a><span id="l36.8"> </span>
<a href="#l36.9"></a><span id="l36.9"> const PREF_EXTENSIONS_GETMOREPROTOCOLSURL = &quot;extensions.getMoreProtocolsURL&quot;;</span>
<a href="#l36.10"></a><span id="l36.10"> </span>
<a href="#l36.11"></a><span id="l36.11"> const events = [</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-  &quot;purple-quit&quot;</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+  &quot;prpl-quit&quot;</span>
<a href="#l36.14"></a><span id="l36.14"> ];</span>
<a href="#l36.15"></a><span id="l36.15"> </span>
<a href="#l36.16"></a><span id="l36.16"> var accountWizard = {</span>
<a href="#l36.17"></a><span id="l36.17">   onload: function aw_onload() {</span>
<a href="#l36.18"></a><span id="l36.18">     accountWizard.setGetMoreProtocols();</span>
<a href="#l36.19"></a><span id="l36.19"> </span>
<a href="#l36.20"></a><span id="l36.20">     var protoList = document.getElementById(&quot;protolist&quot;);</span>
<a href="#l36.21"></a><span id="l36.21">     var protos = [];</span>
<a href="#l36.22"></a><span id="l36.22" class="difflineat">@@ -65,17 +65,17 @@ var accountWizard = {</span>
<a href="#l36.23"></a><span id="l36.23"> </span>
<a href="#l36.24"></a><span id="l36.24">     addObservers(this, events);</span>
<a href="#l36.25"></a><span id="l36.25">     window.addEventListener(&quot;unload&quot;, this.unload);</span>
<a href="#l36.26"></a><span id="l36.26">   },</span>
<a href="#l36.27"></a><span id="l36.27">   unload: function aw_unload() {</span>
<a href="#l36.28"></a><span id="l36.28">     removeObservers(accountWizard, events);</span>
<a href="#l36.29"></a><span id="l36.29">   },</span>
<a href="#l36.30"></a><span id="l36.30">   observe: function am_observe(aObject, aTopic, aData) {</span>
<a href="#l36.31"></a><span id="l36.31" class="difflineminus">-    if (aTopic == &quot;purple-quit&quot;) {</span>
<a href="#l36.32"></a><span id="l36.32" class="difflineplus">+    if (aTopic == &quot;prpl-quit&quot;) {</span>
<a href="#l36.33"></a><span id="l36.33">       // libpurple is being uninitialized. We can't create any new</span>
<a href="#l36.34"></a><span id="l36.34">       // account so keeping this wizard open would be pointless, close it.</span>
<a href="#l36.35"></a><span id="l36.35">       window.close();</span>
<a href="#l36.36"></a><span id="l36.36">     }</span>
<a href="#l36.37"></a><span id="l36.37">   },</span>
<a href="#l36.38"></a><span id="l36.38"> </span>
<a href="#l36.39"></a><span id="l36.39">   getUsername: function aw_getUsername() {</span>
<a href="#l36.40"></a><span id="l36.40">     // If the first username textbox is empty, make sure we return an empty</span>
<a href="#l36.41"></a><span id="l36.41" class="difflineat">@@ -217,17 +217,18 @@ var accountWizard = {</span>
<a href="#l36.42"></a><span id="l36.42">   },</span>
<a href="#l36.43"></a><span id="l36.43"> </span>
<a href="#l36.44"></a><span id="l36.44">   displayProxyDescription: function aw_displayProxyDescription() {</span>
<a href="#l36.45"></a><span id="l36.45">     var type = this.proxy.type;</span>
<a href="#l36.46"></a><span id="l36.46">     var bundle = document.getElementById(&quot;proxiesBundle&quot;);</span>
<a href="#l36.47"></a><span id="l36.47">     var proxy;</span>
<a href="#l36.48"></a><span id="l36.48">     var result;</span>
<a href="#l36.49"></a><span id="l36.49">     if (type == Ci.purpleIProxyInfo.useGlobal) {</span>
<a href="#l36.50"></a><span id="l36.50" class="difflineminus">-      proxy = Services.core.globalProxy;</span>
<a href="#l36.51"></a><span id="l36.51" class="difflineplus">+      proxy = Cc[&quot;@instantbird.org/libpurple/core;1&quot;]</span>
<a href="#l36.52"></a><span id="l36.52" class="difflineplus">+              .getService(Ci.purpleICoreService).globalProxy;</span>
<a href="#l36.53"></a><span id="l36.53">       type = proxy.type;</span>
<a href="#l36.54"></a><span id="l36.54">     }</span>
<a href="#l36.55"></a><span id="l36.55">     else</span>
<a href="#l36.56"></a><span id="l36.56">       proxy = this.proxy;</span>
<a href="#l36.57"></a><span id="l36.57"> </span>
<a href="#l36.58"></a><span id="l36.58">     if (type == Ci.purpleIProxyInfo.noProxy)</span>
<a href="#l36.59"></a><span id="l36.59">       result = bundle.getString(&quot;proxies.directConnection&quot;);</span>
<a href="#l36.60"></a><span id="l36.60"> </span>
<a href="#l36.61"></a><span id="l36.61" class="difflineat">@@ -433,21 +434,19 @@ var accountWizard = {</span>
<a href="#l36.62"></a><span id="l36.62">     for (let i = 0; i &lt; this.prefs.length; ++i) {</span>
<a href="#l36.63"></a><span id="l36.63">       let opt = this.prefs[i];</span>
<a href="#l36.64"></a><span id="l36.64">       let label = bundle.getFormattedString(&quot;accountColon&quot;, [opt.opt.label]);</span>
<a href="#l36.65"></a><span id="l36.65">       rows.appendChild(this.createSummaryRow(label, opt.value));</span>
<a href="#l36.66"></a><span id="l36.66">     }</span>
<a href="#l36.67"></a><span id="l36.67">   },</span>
<a href="#l36.68"></a><span id="l36.68"> </span>
<a href="#l36.69"></a><span id="l36.69">   createAccount: function aw_createAccount() {</span>
<a href="#l36.70"></a><span id="l36.70" class="difflineminus">-    var acc = Services.core.createAccount(this.username, this.proto.id);</span>
<a href="#l36.71"></a><span id="l36.71" class="difflineminus">-    if (!this.proto.noPassword) {</span>
<a href="#l36.72"></a><span id="l36.72" class="difflineplus">+    var acc = Services.accounts.createAccount(this.username, this.proto.id);</span>
<a href="#l36.73"></a><span id="l36.73" class="difflineplus">+    if (!this.proto.noPassword)</span>
<a href="#l36.74"></a><span id="l36.74">       acc.password = this.password;</span>
<a href="#l36.75"></a><span id="l36.75" class="difflineminus">-      acc.rememberPassword = true;</span>
<a href="#l36.76"></a><span id="l36.76" class="difflineminus">-    }</span>
<a href="#l36.77"></a><span id="l36.77">     if (this.alias)</span>
<a href="#l36.78"></a><span id="l36.78">       acc.alias = this.alias;</span>
<a href="#l36.79"></a><span id="l36.79">     //FIXME: newMailNotification</span>
<a href="#l36.80"></a><span id="l36.80"> </span>
<a href="#l36.81"></a><span id="l36.81">     for (let i = 0; i &lt; this.prefs.length; ++i) {</span>
<a href="#l36.82"></a><span id="l36.82">       let option = this.prefs[i];</span>
<a href="#l36.83"></a><span id="l36.83">       let opt = option.opt;</span>
<a href="#l36.84"></a><span id="l36.84">       switch(opt.type) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/im/content/accounts.js</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/im/content/accounts.js</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -35,17 +35,17 @@</span>
<a href="#l37.4"></a><span id="l37.4">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l37.5"></a><span id="l37.5">  *</span>
<a href="#l37.6"></a><span id="l37.6">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l37.7"></a><span id="l37.7"> </span>
<a href="#l37.8"></a><span id="l37.8"> Components.utils.import(&quot;resource://gre/modules/DownloadUtils.jsm&quot;);</span>
<a href="#l37.9"></a><span id="l37.9"> </span>
<a href="#l37.10"></a><span id="l37.10"> // This is the list of notifications that the account manager window observes</span>
<a href="#l37.11"></a><span id="l37.11"> const events = [</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-  &quot;purple-quit&quot;,</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+  &quot;prpl-quit&quot;,</span>
<a href="#l37.14"></a><span id="l37.14">   &quot;account-list-updated&quot;,</span>
<a href="#l37.15"></a><span id="l37.15">   &quot;account-added&quot;,</span>
<a href="#l37.16"></a><span id="l37.16">   &quot;account-updated&quot;,</span>
<a href="#l37.17"></a><span id="l37.17">   &quot;account-removed&quot;,</span>
<a href="#l37.18"></a><span id="l37.18">   &quot;account-connected&quot;,</span>
<a href="#l37.19"></a><span id="l37.19">   &quot;account-connecting&quot;,</span>
<a href="#l37.20"></a><span id="l37.20">   &quot;account-disconnected&quot;,</span>
<a href="#l37.21"></a><span id="l37.21">   &quot;account-disconnecting&quot;,</span>
<a href="#l37.22"></a><span id="l37.22" class="difflineat">@@ -121,17 +121,17 @@ var gAccountManager = {</span>
<a href="#l37.23"></a><span id="l37.23">     // The selected item is still selected</span>
<a href="#l37.24"></a><span id="l37.24">     accountList.selectedItem.buttons.setFocus();</span>
<a href="#l37.25"></a><span id="l37.25">     accountList.ensureSelectedElementIsVisible();</span>
<a href="#l37.26"></a><span id="l37.26"> </span>
<a href="#l37.27"></a><span id="l37.27">     // We need to refresh the disabled menu items</span>
<a href="#l37.28"></a><span id="l37.28">     this.disableCommandItems();</span>
<a href="#l37.29"></a><span id="l37.29">   },</span>
<a href="#l37.30"></a><span id="l37.30">   observe: function am_observe(aObject, aTopic, aData) {</span>
<a href="#l37.31"></a><span id="l37.31" class="difflineminus">-    if (aTopic == &quot;purple-quit&quot;) {</span>
<a href="#l37.32"></a><span id="l37.32" class="difflineplus">+    if (aTopic == &quot;prpl-quit&quot;) {</span>
<a href="#l37.33"></a><span id="l37.33">       // libpurple is being uninitialized. We don't need the account</span>
<a href="#l37.34"></a><span id="l37.34">       // manager window anymore, close it.</span>
<a href="#l37.35"></a><span id="l37.35">       this.close();</span>
<a href="#l37.36"></a><span id="l37.36">       return;</span>
<a href="#l37.37"></a><span id="l37.37">     }</span>
<a href="#l37.38"></a><span id="l37.38">     else if (aTopic == &quot;autologin-processed&quot;) {</span>
<a href="#l37.39"></a><span id="l37.39">       var notification = document.getElementById(&quot;accountsNotificationBox&quot;)</span>
<a href="#l37.40"></a><span id="l37.40">                                  .getNotificationWithValue(&quot;autoLoginStatus&quot;);</span>
<a href="#l37.41"></a><span id="l37.41" class="difflineat">@@ -139,26 +139,26 @@ var gAccountManager = {</span>
<a href="#l37.42"></a><span id="l37.42">         notification.close();</span>
<a href="#l37.43"></a><span id="l37.43">       return;</span>
<a href="#l37.44"></a><span id="l37.44">     }</span>
<a href="#l37.45"></a><span id="l37.45">     else if (aTopic == &quot;network:offline-status-changed&quot;) {</span>
<a href="#l37.46"></a><span id="l37.46">       this.setOffline(aData == &quot;offline&quot;);</span>
<a href="#l37.47"></a><span id="l37.47">       return;</span>
<a href="#l37.48"></a><span id="l37.48">     }</span>
<a href="#l37.49"></a><span id="l37.49">     else if (aTopic == &quot;status-changed&quot;) {</span>
<a href="#l37.50"></a><span id="l37.50" class="difflineminus">-      this.setOffline(aObject.currentStatusType == Ci.imIStatusInfo.STATUS_OFFLINE);</span>
<a href="#l37.51"></a><span id="l37.51" class="difflineplus">+      this.setOffline(aObject.statusType == Ci.imIStatusInfo.STATUS_OFFLINE);</span>
<a href="#l37.52"></a><span id="l37.52">       return;</span>
<a href="#l37.53"></a><span id="l37.53">     }</span>
<a href="#l37.54"></a><span id="l37.54">     else if (aTopic == &quot;account-list-updated&quot;) {</span>
<a href="#l37.55"></a><span id="l37.55">       this._updateAccountList();</span>
<a href="#l37.56"></a><span id="l37.56">       return;</span>
<a href="#l37.57"></a><span id="l37.57">     }</span>
<a href="#l37.58"></a><span id="l37.58"> </span>
<a href="#l37.59"></a><span id="l37.59" class="difflineminus">-    if (!(aObject instanceof Ci.purpleIAccount))</span>
<a href="#l37.60"></a><span id="l37.60" class="difflineminus">-      throw &quot;Bad notification.&quot;;</span>
<a href="#l37.61"></a><span id="l37.61" class="difflineplus">+    // The following notification handlers need an account.</span>
<a href="#l37.62"></a><span id="l37.62" class="difflineplus">+    aObject.QueryInterface(Ci.imIAccount);</span>
<a href="#l37.63"></a><span id="l37.63"> </span>
<a href="#l37.64"></a><span id="l37.64">     if (aTopic == &quot;account-added&quot;) {</span>
<a href="#l37.65"></a><span id="l37.65">       document.getElementById(&quot;accountsDesk&quot;).selectedIndex = 1;</span>
<a href="#l37.66"></a><span id="l37.66">       var elt = document.createElement(&quot;richlistitem&quot;);</span>
<a href="#l37.67"></a><span id="l37.67">       this.accountList.appendChild(elt);</span>
<a href="#l37.68"></a><span id="l37.68">       elt.build(aObject);</span>
<a href="#l37.69"></a><span id="l37.69">       if (this.accountList.getRowCount() == 1)</span>
<a href="#l37.70"></a><span id="l37.70">         this.accountList.selectedIndex = 0;</span>
<a href="#l37.71"></a><span id="l37.71" class="difflineat">@@ -198,16 +198,19 @@ var gAccountManager = {</span>
<a href="#l37.72"></a><span id="l37.72">       const stateEvents = {</span>
<a href="#l37.73"></a><span id="l37.73">         &quot;account-connected&quot;: &quot;connected&quot;,</span>
<a href="#l37.74"></a><span id="l37.74">         &quot;account-connecting&quot;: &quot;connecting&quot;,</span>
<a href="#l37.75"></a><span id="l37.75">         &quot;account-disconnected&quot;: &quot;disconnected&quot;,</span>
<a href="#l37.76"></a><span id="l37.76">         &quot;account-disconnecting&quot;: &quot;disconnecting&quot;</span>
<a href="#l37.77"></a><span id="l37.77">       };</span>
<a href="#l37.78"></a><span id="l37.78">       if (aTopic in stateEvents) {</span>
<a href="#l37.79"></a><span id="l37.79">         let elt = document.getElementById(aObject.id);</span>
<a href="#l37.80"></a><span id="l37.80" class="difflineplus">+        if (!elt)</span>
<a href="#l37.81"></a><span id="l37.81" class="difflineplus">+          return; // probably disconnecting a removed account.</span>
<a href="#l37.82"></a><span id="l37.82" class="difflineplus">+</span>
<a href="#l37.83"></a><span id="l37.83">         if (aTopic == &quot;account-connecting&quot;) {</span>
<a href="#l37.84"></a><span id="l37.84">           elt.removeAttribute(&quot;error&quot;);</span>
<a href="#l37.85"></a><span id="l37.85">           elt.updateConnectionState();</span>
<a href="#l37.86"></a><span id="l37.86">         }</span>
<a href="#l37.87"></a><span id="l37.87">         else {</span>
<a href="#l37.88"></a><span id="l37.88">           if (aTopic == &quot;account-connected&quot;)</span>
<a href="#l37.89"></a><span id="l37.89">             elt.refreshConnectedLabel();</span>
<a href="#l37.90"></a><span id="l37.90">         }</span>
<a href="#l37.91"></a><span id="l37.91" class="difflineat">@@ -278,17 +281,17 @@ var gAccountManager = {</span>
<a href="#l37.92"></a><span id="l37.92">       if (prompts.confirmEx(window, promptTitle, promptMessage, flags,</span>
<a href="#l37.93"></a><span id="l37.93">                             deleteButton, null, null, promptCheckbox, checkbox))</span>
<a href="#l37.94"></a><span id="l37.94">         return;</span>
<a href="#l37.95"></a><span id="l37.95"> </span>
<a href="#l37.96"></a><span id="l37.96">       if (checkbox.value)</span>
<a href="#l37.97"></a><span id="l37.97">         Services.prefs.setBoolPref(&quot;messenger.accounts.promptOnDelete&quot;, false);</span>
<a href="#l37.98"></a><span id="l37.98">     }</span>
<a href="#l37.99"></a><span id="l37.99"> </span>
<a href="#l37.100"></a><span id="l37.100" class="difflineminus">-    Services.core.deleteAccount(selectedItem.id);</span>
<a href="#l37.101"></a><span id="l37.101" class="difflineplus">+    Services.accounts.deleteAccount(selectedItem.id);</span>
<a href="#l37.102"></a><span id="l37.102">   },</span>
<a href="#l37.103"></a><span id="l37.103">   new: function am_new() {</span>
<a href="#l37.104"></a><span id="l37.104">     this.openDialog(&quot;chrome://instantbird/content/accountWizard.xul&quot;);</span>
<a href="#l37.105"></a><span id="l37.105">   },</span>
<a href="#l37.106"></a><span id="l37.106">   edit: function am_edit() {</span>
<a href="#l37.107"></a><span id="l37.107">     this.openDialog(&quot;chrome://instantbird/content/account.xul&quot;,</span>
<a href="#l37.108"></a><span id="l37.108">                     this.accountList.selectedItem.account);</span>
<a href="#l37.109"></a><span id="l37.109">   },</span>
<a href="#l37.110"></a><span id="l37.110" class="difflineat">@@ -321,18 +324,18 @@ var gAccountManager = {</span>
<a href="#l37.111"></a><span id="l37.111">       return;</span>
<a href="#l37.112"></a><span id="l37.112"> </span>
<a href="#l37.113"></a><span id="l37.113">     let account = selectedItem.account;</span>
<a href="#l37.114"></a><span id="l37.114">     let activeCommandName = account.disconnected ? &quot;connect&quot; : &quot;disconnect&quot;;</span>
<a href="#l37.115"></a><span id="l37.115">     let activeCommandElt = document.getElementById(&quot;cmd_&quot; + activeCommandName);</span>
<a href="#l37.116"></a><span id="l37.116">     let isCommandDisabled =</span>
<a href="#l37.117"></a><span id="l37.117">       (this.isOffline ||</span>
<a href="#l37.118"></a><span id="l37.118">        (account.disconnected &amp;&amp;</span>
<a href="#l37.119"></a><span id="l37.119" class="difflineminus">-        (account.connectionErrorReason == Ci.purpleIAccount.ERROR_UNKNOWN_PRPL ||</span>
<a href="#l37.120"></a><span id="l37.120" class="difflineminus">-         account.connectionErrorReason == Ci.purpleIAccount.ERROR_MISSING_PASSWORD)));</span>
<a href="#l37.121"></a><span id="l37.121" class="difflineplus">+        (account.connectionErrorReason == Ci.imIAccount.ERROR_UNKNOWN_PRPL ||</span>
<a href="#l37.122"></a><span id="l37.122" class="difflineplus">+         account.connectionErrorReason == Ci.imIAccount.ERROR_MISSING_PASSWORD)));</span>
<a href="#l37.123"></a><span id="l37.123"> </span>
<a href="#l37.124"></a><span id="l37.124">     [[activeCommandElt, isCommandDisabled],</span>
<a href="#l37.125"></a><span id="l37.125">      [document.getElementById(&quot;cmd_moveup&quot;), accountList.selectedIndex == 0],</span>
<a href="#l37.126"></a><span id="l37.126">      [document.getElementById(&quot;cmd_movedown&quot;),</span>
<a href="#l37.127"></a><span id="l37.127">       accountList.selectedIndex == accountList.itemCount - 1]</span>
<a href="#l37.128"></a><span id="l37.128">     ].forEach(function (aEltArray) {</span>
<a href="#l37.129"></a><span id="l37.129">       let [elt, state] = aEltArray;</span>
<a href="#l37.130"></a><span id="l37.130">       if (state)</span>
<a href="#l37.131"></a><span id="l37.131" class="difflineat">@@ -441,94 +444,94 @@ var gAccountManager = {</span>
<a href="#l37.132"></a><span id="l37.132">       newIndex = 0;</span>
<a href="#l37.133"></a><span id="l37.133">     else if (newIndex &gt;= accountList.itemCount)</span>
<a href="#l37.134"></a><span id="l37.134">       newIndex = accountList.itemCount - 1;</span>
<a href="#l37.135"></a><span id="l37.135">     array.splice(newIndex, 0, selectedID);</span>
<a href="#l37.136"></a><span id="l37.136"> </span>
<a href="#l37.137"></a><span id="l37.137">     Services.prefs.setCharPref(&quot;messenger.accounts&quot;, array.join(&quot;,&quot;));</span>
<a href="#l37.138"></a><span id="l37.138">   },</span>
<a href="#l37.139"></a><span id="l37.139"> </span>
<a href="#l37.140"></a><span id="l37.140" class="difflineminus">-  getAccounts: function am_getAccounts() getIter(Services.core.getAccounts()),</span>
<a href="#l37.141"></a><span id="l37.141" class="difflineplus">+  getAccounts: function am_getAccounts() getIter(Services.accounts.getAccounts()),</span>
<a href="#l37.142"></a><span id="l37.142"> </span>
<a href="#l37.143"></a><span id="l37.143">   openDialog: function am_openDialog(aUrl, aArgs) {</span>
<a href="#l37.144"></a><span id="l37.144">     this.modalDialog = true;</span>
<a href="#l37.145"></a><span id="l37.145">     window.openDialog(aUrl, &quot;&quot;, &quot;chrome,modal,titlebar,centerscreen&quot;, aArgs);</span>
<a href="#l37.146"></a><span id="l37.146">     this.modalDialog = false;</span>
<a href="#l37.147"></a><span id="l37.147">   },</span>
<a href="#l37.148"></a><span id="l37.148">   setAutoLoginNotification: function am_setAutoLoginNotification() {</span>
<a href="#l37.149"></a><span id="l37.149" class="difflineminus">-    var pcs = Services.core;</span>
<a href="#l37.150"></a><span id="l37.150" class="difflineminus">-    var autoLoginStatus = pcs.autoLoginStatus;</span>
<a href="#l37.151"></a><span id="l37.151" class="difflineplus">+    var as = Services.accounts;</span>
<a href="#l37.152"></a><span id="l37.152" class="difflineplus">+    var autoLoginStatus = as.autoLoginStatus;</span>
<a href="#l37.153"></a><span id="l37.153">     let isOffline = false;</span>
<a href="#l37.154"></a><span id="l37.154">     let crashCount = 0;</span>
<a href="#l37.155"></a><span id="l37.155">     for (let acc in this.getAccounts())</span>
<a href="#l37.156"></a><span id="l37.156">       if (acc.autoLogin &amp;&amp; acc.firstConnectionState == acc.FIRST_CONNECTION_CRASHED)</span>
<a href="#l37.157"></a><span id="l37.157">         ++crashCount;</span>
<a href="#l37.158"></a><span id="l37.158"> </span>
<a href="#l37.159"></a><span id="l37.159" class="difflineminus">-    if (autoLoginStatus == pcs.AUTOLOGIN_ENABLED &amp;&amp; crashCount == 0) {</span>
<a href="#l37.160"></a><span id="l37.160" class="difflineminus">-      this.setOffline(isOffline ||</span>
<a href="#l37.161"></a><span id="l37.161" class="difflineminus">-                      pcs.currentStatusType == Ci.imIStatusInfo.STATUS_OFFLINE);</span>
<a href="#l37.162"></a><span id="l37.162" class="difflineplus">+    if (autoLoginStatus == as.AUTOLOGIN_ENABLED &amp;&amp; crashCount == 0) {</span>
<a href="#l37.163"></a><span id="l37.163" class="difflineplus">+      let status = Services.core.globalUserStatus.statusType;</span>
<a href="#l37.164"></a><span id="l37.164" class="difflineplus">+      this.setOffline(isOffline || status == Ci.imIStatusInfo.STATUS_OFFLINE);</span>
<a href="#l37.165"></a><span id="l37.165">       return;</span>
<a href="#l37.166"></a><span id="l37.166">     }</span>
<a href="#l37.167"></a><span id="l37.167"> </span>
<a href="#l37.168"></a><span id="l37.168">     var bundle = document.getElementById(&quot;accountsBundle&quot;);</span>
<a href="#l37.169"></a><span id="l37.169">     var box = document.getElementById(&quot;accountsNotificationBox&quot;);</span>
<a href="#l37.170"></a><span id="l37.170">     var priority = box.PRIORITY_INFO_HIGH;</span>
<a href="#l37.171"></a><span id="l37.171">     var connectNowButton = {</span>
<a href="#l37.172"></a><span id="l37.172">       accessKey: bundle.getString(&quot;accountsManager.notification.button.accessKey&quot;),</span>
<a href="#l37.173"></a><span id="l37.173">       callback: this.processAutoLogin,</span>
<a href="#l37.174"></a><span id="l37.174">       label: bundle.getString(&quot;accountsManager.notification.button.label&quot;)</span>
<a href="#l37.175"></a><span id="l37.175">     };</span>
<a href="#l37.176"></a><span id="l37.176">     var label;</span>
<a href="#l37.177"></a><span id="l37.177"> </span>
<a href="#l37.178"></a><span id="l37.178">     switch (autoLoginStatus) {</span>
<a href="#l37.179"></a><span id="l37.179" class="difflineminus">-      case pcs.AUTOLOGIN_USER_DISABLED:</span>
<a href="#l37.180"></a><span id="l37.180" class="difflineplus">+      case as.AUTOLOGIN_USER_DISABLED:</span>
<a href="#l37.181"></a><span id="l37.181">         label = bundle.getString(&quot;accountsManager.notification.userDisabled.label&quot;);</span>
<a href="#l37.182"></a><span id="l37.182">         break;</span>
<a href="#l37.183"></a><span id="l37.183"> </span>
<a href="#l37.184"></a><span id="l37.184" class="difflineminus">-      case pcs.AUTOLOGIN_SAFE_MODE:</span>
<a href="#l37.185"></a><span id="l37.185" class="difflineplus">+      case as.AUTOLOGIN_SAFE_MODE:</span>
<a href="#l37.186"></a><span id="l37.186">         label = bundle.getString(&quot;accountsManager.notification.safeMode.label&quot;);</span>
<a href="#l37.187"></a><span id="l37.187">         break;</span>
<a href="#l37.188"></a><span id="l37.188"> </span>
<a href="#l37.189"></a><span id="l37.189" class="difflineminus">-      case pcs.AUTOLOGIN_START_OFFLINE:</span>
<a href="#l37.190"></a><span id="l37.190" class="difflineplus">+      case as.AUTOLOGIN_START_OFFLINE:</span>
<a href="#l37.191"></a><span id="l37.191">         label = bundle.getString(&quot;accountsManager.notification.startOffline.label&quot;);</span>
<a href="#l37.192"></a><span id="l37.192">         isOffline = true;</span>
<a href="#l37.193"></a><span id="l37.193">         break;</span>
<a href="#l37.194"></a><span id="l37.194"> </span>
<a href="#l37.195"></a><span id="l37.195" class="difflineminus">-      case pcs.AUTOLOGIN_CRASH:</span>
<a href="#l37.196"></a><span id="l37.196" class="difflineplus">+      case as.AUTOLOGIN_CRASH:</span>
<a href="#l37.197"></a><span id="l37.197">         label = bundle.getString(&quot;accountsManager.notification.crash.label&quot;);</span>
<a href="#l37.198"></a><span id="l37.198">         priority = box.PRIORITY_WARNING_MEDIUM;</span>
<a href="#l37.199"></a><span id="l37.199">         break;</span>
<a href="#l37.200"></a><span id="l37.200"> </span>
<a href="#l37.201"></a><span id="l37.201">       /* One or more accounts made the application crash during their connection.</span>
<a href="#l37.202"></a><span id="l37.202">          If none, this function has already returned */</span>
<a href="#l37.203"></a><span id="l37.203" class="difflineminus">-      case pcs.AUTOLOGIN_ENABLED:</span>
<a href="#l37.204"></a><span id="l37.204" class="difflineplus">+      case as.AUTOLOGIN_ENABLED:</span>
<a href="#l37.205"></a><span id="l37.205">         if (!(&quot;PluralForm&quot; in window))</span>
<a href="#l37.206"></a><span id="l37.206">           Components.utils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l37.207"></a><span id="l37.207">         label = bundle.getString(&quot;accountsManager.notification.singleCrash.label&quot;);</span>
<a href="#l37.208"></a><span id="l37.208">         label = PluralForm.get(crashCount, label).replace(&quot;#1&quot;, crashCount);</span>
<a href="#l37.209"></a><span id="l37.209">         priority = box.PRIORITY_WARNING_MEDIUM;</span>
<a href="#l37.210"></a><span id="l37.210">         connectNowButton.callback = this.processCrashedAccountsLogin;</span>
<a href="#l37.211"></a><span id="l37.211">         break;</span>
<a href="#l37.212"></a><span id="l37.212"> </span>
<a href="#l37.213"></a><span id="l37.213">       default:</span>
<a href="#l37.214"></a><span id="l37.214">         label = bundle.getString(&quot;accountsManager.notification.other.label&quot;);</span>
<a href="#l37.215"></a><span id="l37.215">     }</span>
<a href="#l37.216"></a><span id="l37.216" class="difflineminus">-    this.setOffline(isOffline ||</span>
<a href="#l37.217"></a><span id="l37.217" class="difflineminus">-                    pcs.currentStatusType == Ci.imIStatusInfo.STATUS_OFFLINE);</span>
<a href="#l37.218"></a><span id="l37.218" class="difflineplus">+    let status = Services.core.globalUserStatus.statusType;</span>
<a href="#l37.219"></a><span id="l37.219" class="difflineplus">+    this.setOffline(isOffline || status == Ci.imIStatusInfo.STATUS_OFFLINE);</span>
<a href="#l37.220"></a><span id="l37.220"> </span>
<a href="#l37.221"></a><span id="l37.221">     box.appendNotification(label, &quot;autologinStatus&quot;, null, priority, [connectNowButton]);</span>
<a href="#l37.222"></a><span id="l37.222">   },</span>
<a href="#l37.223"></a><span id="l37.223">   processAutoLogin: function am_processAutoLogin() {</span>
<a href="#l37.224"></a><span id="l37.224">     var ioService = Services.io;</span>
<a href="#l37.225"></a><span id="l37.225">     if (ioService.offline) {</span>
<a href="#l37.226"></a><span id="l37.226">       ioService.manageOfflineStatus = false;</span>
<a href="#l37.227"></a><span id="l37.227">       ioService.offline = false;</span>
<a href="#l37.228"></a><span id="l37.228">     }</span>
<a href="#l37.229"></a><span id="l37.229"> </span>
<a href="#l37.230"></a><span id="l37.230" class="difflineminus">-    Services.core.processAutoLogin();</span>
<a href="#l37.231"></a><span id="l37.231" class="difflineplus">+    Services.accounts.processAutoLogin();</span>
<a href="#l37.232"></a><span id="l37.232"> </span>
<a href="#l37.233"></a><span id="l37.233">     gAccountManager.accountList.selectedItem.buttons.setFocus();</span>
<a href="#l37.234"></a><span id="l37.234">   },</span>
<a href="#l37.235"></a><span id="l37.235">   processCrashedAccountsLogin: function am_processCrashedAccountsLogin() {</span>
<a href="#l37.236"></a><span id="l37.236">     for (let acc in gAccountManager.getAccounts())</span>
<a href="#l37.237"></a><span id="l37.237">       if (acc.disconnected &amp;&amp; acc.autoLogin &amp;&amp;</span>
<a href="#l37.238"></a><span id="l37.238">           acc.firstConnectionState == acc.FIRST_CONNECTION_CRASHED)</span>
<a href="#l37.239"></a><span id="l37.239">         acc.connect();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/im/content/addbuddy.js</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/im/content/addbuddy.js</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -39,17 +39,17 @@</span>
<a href="#l38.4"></a><span id="l38.4"> var addBuddy = {</span>
<a href="#l38.5"></a><span id="l38.5">   onload: function ab_onload() {</span>
<a href="#l38.6"></a><span id="l38.6">     this.buildAccountList();</span>
<a href="#l38.7"></a><span id="l38.7">     this.buildTagList();</span>
<a href="#l38.8"></a><span id="l38.8">   },</span>
<a href="#l38.9"></a><span id="l38.9"> </span>
<a href="#l38.10"></a><span id="l38.10">   buildAccountList: function ab_buildAccountList() {</span>
<a href="#l38.11"></a><span id="l38.11">     var accountList = document.getElementById(&quot;accountlist&quot;);</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-    for (let acc in getIter(Services.core.getAccounts())) {</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+    for (let acc in getIter(Services.accounts.getAccounts())) {</span>
<a href="#l38.14"></a><span id="l38.14">       if (!acc.connected)</span>
<a href="#l38.15"></a><span id="l38.15">         continue;</span>
<a href="#l38.16"></a><span id="l38.16">       var proto = acc.protocol;</span>
<a href="#l38.17"></a><span id="l38.17">       var item = accountList.appendItem(acc.name, acc.id, proto.name);</span>
<a href="#l38.18"></a><span id="l38.18">       item.setAttribute(&quot;image&quot;, proto.iconBaseURI + &quot;icon.png&quot;);</span>
<a href="#l38.19"></a><span id="l38.19">       item.setAttribute(&quot;class&quot;, &quot;menuitem-iconic&quot;);</span>
<a href="#l38.20"></a><span id="l38.20">     }</span>
<a href="#l38.21"></a><span id="l38.21">     if (!accountList.itemCount) {</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineat">@@ -71,17 +71,17 @@ var addBuddy = {</span>
<a href="#l38.23"></a><span id="l38.23">       tagList.appendItem(tag.name, tag.id);</span>
<a href="#l38.24"></a><span id="l38.24">     });</span>
<a href="#l38.25"></a><span id="l38.25">     tagList.selectedIndex = 0;</span>
<a href="#l38.26"></a><span id="l38.26">   },</span>
<a href="#l38.27"></a><span id="l38.27"> </span>
<a href="#l38.28"></a><span id="l38.28">   getValue: function ab_getValue(aId) document.getElementById(aId).value,</span>
<a href="#l38.29"></a><span id="l38.29"> </span>
<a href="#l38.30"></a><span id="l38.30">   create: function ab_create() {</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineminus">-    var account = Services.core.getAccountById(this.getValue(&quot;accountlist&quot;));</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineplus">+    var account = Services.accounts.getAccountById(this.getValue(&quot;accountlist&quot;));</span>
<a href="#l38.33"></a><span id="l38.33">     var name = this.getValue(&quot;name&quot;);</span>
<a href="#l38.34"></a><span id="l38.34"> </span>
<a href="#l38.35"></a><span id="l38.35">     var tag;</span>
<a href="#l38.36"></a><span id="l38.36">     var taglist = document.getElementById(&quot;taglist&quot;);</span>
<a href="#l38.37"></a><span id="l38.37">     var items = taglist.getElementsByAttribute(&quot;label&quot;, taglist.label);</span>
<a href="#l38.38"></a><span id="l38.38">     if (items.length)</span>
<a href="#l38.39"></a><span id="l38.39">       tag = Services.tags.getTagById(items[0].value);</span>
<a href="#l38.40"></a><span id="l38.40">     else</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/im/content/blist.js</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/im/content/blist.js</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -43,17 +43,17 @@ const events = [&quot;contact-availability-ch</span>
<a href="#l39.4"></a><span id="l39.4">                 &quot;contact-tag-removed&quot;,</span>
<a href="#l39.5"></a><span id="l39.5">                 &quot;showing-ui-conversation&quot;,</span>
<a href="#l39.6"></a><span id="l39.6">                 &quot;status-changed&quot;,</span>
<a href="#l39.7"></a><span id="l39.7">                 &quot;tag-hidden&quot;,</span>
<a href="#l39.8"></a><span id="l39.8">                 &quot;tag-shown&quot;,</span>
<a href="#l39.9"></a><span id="l39.9">                 &quot;ui-conversation-hidden&quot;,</span>
<a href="#l39.10"></a><span id="l39.10">                 &quot;user-display-name-changed&quot;,</span>
<a href="#l39.11"></a><span id="l39.11">                 &quot;user-icon-changed&quot;,</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-                &quot;purple-quit&quot;];</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineplus">+                &quot;prpl-quit&quot;];</span>
<a href="#l39.14"></a><span id="l39.14"> </span>
<a href="#l39.15"></a><span id="l39.15"> const showOfflineBuddiesPref = &quot;messenger.buddies.showOffline&quot;;</span>
<a href="#l39.16"></a><span id="l39.16"> </span>
<a href="#l39.17"></a><span id="l39.17"> var gBuddyListContextMenu = null;</span>
<a href="#l39.18"></a><span id="l39.18"> </span>
<a href="#l39.19"></a><span id="l39.19"> function buddyListContextMenu(aXulMenu) {</span>
<a href="#l39.20"></a><span id="l39.20">   this.target  = document.popupNode;</span>
<a href="#l39.21"></a><span id="l39.21">   this.menu    = aXulMenu;</span>
<a href="#l39.22"></a><span id="l39.22" class="difflineat">@@ -308,17 +308,17 @@ buddyListContextMenu.prototype = {</span>
<a href="#l39.23"></a><span id="l39.23">       !!document.getElementById(&quot;context-show-offline-buddies&quot;)</span>
<a href="#l39.24"></a><span id="l39.24">                 .getAttribute(&quot;checked&quot;);</span>
<a href="#l39.25"></a><span id="l39.25">     Services.prefs.setBoolPref(showOfflineBuddiesPref, newValue);</span>
<a href="#l39.26"></a><span id="l39.26">   }</span>
<a href="#l39.27"></a><span id="l39.27"> };</span>
<a href="#l39.28"></a><span id="l39.28"> </span>
<a href="#l39.29"></a><span id="l39.29"> var buddyList = {</span>
<a href="#l39.30"></a><span id="l39.30">   observe: function bl_observe(aSubject, aTopic, aMsg) {</span>
<a href="#l39.31"></a><span id="l39.31" class="difflineminus">-    if (aTopic == &quot;purple-quit&quot;) {</span>
<a href="#l39.32"></a><span id="l39.32" class="difflineplus">+    if (aTopic == &quot;prpl-quit&quot;) {</span>
<a href="#l39.33"></a><span id="l39.33">       window.close();</span>
<a href="#l39.34"></a><span id="l39.34">       return;</span>
<a href="#l39.35"></a><span id="l39.35">     }</span>
<a href="#l39.36"></a><span id="l39.36"> </span>
<a href="#l39.37"></a><span id="l39.37">     if (aTopic == &quot;nsPref:changed&quot; &amp;&amp; aMsg == showOfflineBuddiesPref) {</span>
<a href="#l39.38"></a><span id="l39.38">       let showOffline = Services.prefs.getBoolPref(showOfflineBuddiesPref);</span>
<a href="#l39.39"></a><span id="l39.39">       this._showOffline = showOffline;</span>
<a href="#l39.40"></a><span id="l39.40">       let item = document.getElementById(&quot;context-show-offline-buddies&quot;);</span>
<a href="#l39.41"></a><span id="l39.41" class="difflineat">@@ -395,22 +395,22 @@ var buddyList = {</span>
<a href="#l39.42"></a><span id="l39.42">           this.showOtherContacts();</span>
<a href="#l39.43"></a><span id="l39.43">         else if (!document.getElementById(&quot;group&quot; + aTag.id))</span>
<a href="#l39.44"></a><span id="l39.44">           this.displayGroup(aTag);</span>
<a href="#l39.45"></a><span id="l39.45">       }, this);</span>
<a href="#l39.46"></a><span id="l39.46">     }</span>
<a href="#l39.47"></a><span id="l39.47">   },</span>
<a href="#l39.48"></a><span id="l39.48"> </span>
<a href="#l39.49"></a><span id="l39.49">   displayUserIcon: function bl_displayUserIcon() {</span>
<a href="#l39.50"></a><span id="l39.50" class="difflineminus">-    let icon = Services.core.getUserIcon();</span>
<a href="#l39.51"></a><span id="l39.51" class="difflineplus">+    let icon = Services.core.globalUserStatus.getUserIcon();</span>
<a href="#l39.52"></a><span id="l39.52">     document.getElementById(&quot;userIcon&quot;).src = icon ? icon.spec : &quot;&quot;;</span>
<a href="#l39.53"></a><span id="l39.53">   },</span>
<a href="#l39.54"></a><span id="l39.54"> </span>
<a href="#l39.55"></a><span id="l39.55">   displayUserDisplayName: function bl_displayUserDisplayName() {</span>
<a href="#l39.56"></a><span id="l39.56" class="difflineminus">-    let displayName = Services.core.userDisplayName;</span>
<a href="#l39.57"></a><span id="l39.57" class="difflineplus">+    let displayName = Services.core.globalUserStatus.displayName;</span>
<a href="#l39.58"></a><span id="l39.58">     let elt = document.getElementById(&quot;displayName&quot;);</span>
<a href="#l39.59"></a><span id="l39.59">     if (displayName)</span>
<a href="#l39.60"></a><span id="l39.60">       elt.removeAttribute(&quot;usingDefault&quot;);</span>
<a href="#l39.61"></a><span id="l39.61">     else {</span>
<a href="#l39.62"></a><span id="l39.62">       let bundle = document.getElementById(&quot;instantbirdBundle&quot;);</span>
<a href="#l39.63"></a><span id="l39.63">       displayName = bundle.getString(&quot;displayNameEmptyText&quot;);</span>
<a href="#l39.64"></a><span id="l39.64">       elt.setAttribute(&quot;usingDefault&quot;, displayName);</span>
<a href="#l39.65"></a><span id="l39.65">     }</span>
<a href="#l39.66"></a><span id="l39.66" class="difflineat">@@ -423,35 +423,35 @@ var buddyList = {</span>
<a href="#l39.67"></a><span id="l39.67">     let statusString = Status.toLabel(aStatusType);</span>
<a href="#l39.68"></a><span id="l39.68">     let statusTypeIcon = document.getElementById(&quot;statusTypeIcon&quot;);</span>
<a href="#l39.69"></a><span id="l39.69">     statusTypeIcon.setAttribute(&quot;status&quot;, aStatusType);</span>
<a href="#l39.70"></a><span id="l39.70">     statusTypeIcon.setAttribute(&quot;tooltiptext&quot;, statusString);</span>
<a href="#l39.71"></a><span id="l39.71">     return statusString;</span>
<a href="#l39.72"></a><span id="l39.72">   },</span>
<a href="#l39.73"></a><span id="l39.73"> </span>
<a href="#l39.74"></a><span id="l39.74">   displayCurrentStatus: function bl_displayCurrentStatus() {</span>
<a href="#l39.75"></a><span id="l39.75" class="difflineminus">-    let pcs = Services.core;</span>
<a href="#l39.76"></a><span id="l39.76" class="difflineminus">-    let status = Status.toAttribute(pcs.currentStatusType);</span>
<a href="#l39.77"></a><span id="l39.77" class="difflineminus">-    let message = status == &quot;offline&quot; ? &quot;&quot; : pcs.currentStatusMessage;</span>
<a href="#l39.78"></a><span id="l39.78" class="difflineplus">+    let us = Services.core.globalUserStatus;</span>
<a href="#l39.79"></a><span id="l39.79" class="difflineplus">+    let status = Status.toAttribute(us.statusType);</span>
<a href="#l39.80"></a><span id="l39.80" class="difflineplus">+    let message = status == &quot;offline&quot; ? &quot;&quot; : us.statusText;</span>
<a href="#l39.81"></a><span id="l39.81">     let statusString = this.displayStatusType(status);</span>
<a href="#l39.82"></a><span id="l39.82">     let statusMessage = document.getElementById(&quot;statusMessage&quot;);</span>
<a href="#l39.83"></a><span id="l39.83">     if (message)</span>
<a href="#l39.84"></a><span id="l39.84">       statusMessage.removeAttribute(&quot;usingDefault&quot;);</span>
<a href="#l39.85"></a><span id="l39.85">     else {</span>
<a href="#l39.86"></a><span id="l39.86">       statusMessage.setAttribute(&quot;usingDefault&quot;, statusString);</span>
<a href="#l39.87"></a><span id="l39.87">       message = statusString;</span>
<a href="#l39.88"></a><span id="l39.88">     }</span>
<a href="#l39.89"></a><span id="l39.89">     statusMessage.setAttribute(&quot;value&quot;, message);</span>
<a href="#l39.90"></a><span id="l39.90">     statusMessage.setAttribute(&quot;tooltiptext&quot;, message);</span>
<a href="#l39.91"></a><span id="l39.91">   },</span>
<a href="#l39.92"></a><span id="l39.92"> </span>
<a href="#l39.93"></a><span id="l39.93">   editStatus: function bl_editStatus(aEvent) {</span>
<a href="#l39.94"></a><span id="l39.94">     let status = aEvent.originalTarget.getAttribute(&quot;status&quot;);</span>
<a href="#l39.95"></a><span id="l39.95">     if (status == &quot;offline&quot;)</span>
<a href="#l39.96"></a><span id="l39.96" class="difflineminus">-      Services.core.setStatus(Ci.imIStatusInfo.STATUS_OFFLINE, &quot;&quot;);</span>
<a href="#l39.97"></a><span id="l39.97" class="difflineplus">+      Services.core.globalUserStatus.setStatus(Ci.imIStatusInfo.STATUS_OFFLINE, &quot;&quot;);</span>
<a href="#l39.98"></a><span id="l39.98">     else if (status)</span>
<a href="#l39.99"></a><span id="l39.99">       this.startEditStatus(status);</span>
<a href="#l39.100"></a><span id="l39.100">   },</span>
<a href="#l39.101"></a><span id="l39.101"> </span>
<a href="#l39.102"></a><span id="l39.102">   startEditStatus: function bl_startEditStatus(aStatusType) {</span>
<a href="#l39.103"></a><span id="l39.103">     let currentStatusType =</span>
<a href="#l39.104"></a><span id="l39.104">       document.getElementById(&quot;statusTypeIcon&quot;).getAttribute(&quot;status&quot;);</span>
<a href="#l39.105"></a><span id="l39.105">     if (aStatusType != currentStatusType) {</span>
<a href="#l39.106"></a><span id="l39.106" class="difflineat">@@ -471,17 +471,17 @@ var buddyList = {</span>
<a href="#l39.107"></a><span id="l39.107">     let elt = document.getElementById(&quot;statusMessage&quot;);</span>
<a href="#l39.108"></a><span id="l39.108">     if (!elt.hasAttribute(&quot;editing&quot;)) {</span>
<a href="#l39.109"></a><span id="l39.109">       elt.setAttribute(&quot;editing&quot;, &quot;true&quot;);</span>
<a href="#l39.110"></a><span id="l39.110">       elt.addEventListener(&quot;keypress&quot;, this.statusMessageKeyPress);</span>
<a href="#l39.111"></a><span id="l39.111">       elt.addEventListener(&quot;blur&quot;, this.statusMessageBlur);</span>
<a href="#l39.112"></a><span id="l39.112">       if (elt.hasAttribute(&quot;usingDefault&quot;)) {</span>
<a href="#l39.113"></a><span id="l39.113">         if (&quot;_statusTypeBeforeEditing&quot; in this &amp;&amp;</span>
<a href="#l39.114"></a><span id="l39.114">             this._statusTypeBeforeEditing == &quot;offline&quot;)</span>
<a href="#l39.115"></a><span id="l39.115" class="difflineminus">-          elt.setAttribute(&quot;value&quot;, Services.core.currentStatusMessage);</span>
<a href="#l39.116"></a><span id="l39.116" class="difflineplus">+          elt.setAttribute(&quot;value&quot;, Services.core.globalUserStatus.statusMessage);</span>
<a href="#l39.117"></a><span id="l39.117">         else</span>
<a href="#l39.118"></a><span id="l39.118">           elt.removeAttribute(&quot;value&quot;);</span>
<a href="#l39.119"></a><span id="l39.119">       }</span>
<a href="#l39.120"></a><span id="l39.120">       if (!(&quot;TextboxSpellChecker&quot; in window))</span>
<a href="#l39.121"></a><span id="l39.121">         Components.utils.import(&quot;resource:///modules/imTextboxUtils.jsm&quot;);</span>
<a href="#l39.122"></a><span id="l39.122">       TextboxSpellChecker.registerTextbox(elt);</span>
<a href="#l39.123"></a><span id="l39.123">       // force binding attachmant by forcing layout</span>
<a href="#l39.124"></a><span id="l39.124">       elt.getBoundingClientRect();</span>
<a href="#l39.125"></a><span id="l39.125" class="difflineat">@@ -535,17 +535,17 @@ var buddyList = {</span>
<a href="#l39.126"></a><span id="l39.126">         else if (statusType == &quot;offline&quot;)</span>
<a href="#l39.127"></a><span id="l39.127">           newStatus = Ci.imIStatusInfo.STATUS_OFFLINE;</span>
<a href="#l39.128"></a><span id="l39.128">         delete this._statusTypeBeforeEditing;</span>
<a href="#l39.129"></a><span id="l39.129">         delete this._statusTypeEditing;</span>
<a href="#l39.130"></a><span id="l39.130">       }</span>
<a href="#l39.131"></a><span id="l39.131">       // apply the new status only if it is different from the current one</span>
<a href="#l39.132"></a><span id="l39.132">       if (newStatus != Ci.imIStatusInfo.STATUS_UNKNOWN ||</span>
<a href="#l39.133"></a><span id="l39.133">           elt.value != elt.getAttribute(&quot;value&quot;))</span>
<a href="#l39.134"></a><span id="l39.134" class="difflineminus">-        Services.core.setStatus(newStatus, elt.value);</span>
<a href="#l39.135"></a><span id="l39.135" class="difflineplus">+        Services.core.globalUserStatus.setStatus(newStatus, elt.value);</span>
<a href="#l39.136"></a><span id="l39.136">     }</span>
<a href="#l39.137"></a><span id="l39.137">     else if (&quot;_statusTypeBeforeEditing&quot; in this) {</span>
<a href="#l39.138"></a><span id="l39.138">       this.displayStatusType(this._statusTypeBeforeEditing);</span>
<a href="#l39.139"></a><span id="l39.139">       delete this._statusTypeBeforeEditing;</span>
<a href="#l39.140"></a><span id="l39.140">       delete this._statusTypeEditing;</span>
<a href="#l39.141"></a><span id="l39.141">     }</span>
<a href="#l39.142"></a><span id="l39.142"> </span>
<a href="#l39.143"></a><span id="l39.143">     if (elt.hasAttribute(&quot;usingDefault&quot;))</span>
<a href="#l39.144"></a><span id="l39.144" class="difflineat">@@ -560,17 +560,17 @@ var buddyList = {</span>
<a href="#l39.145"></a><span id="l39.145">     const nsIFilePicker = Components.interfaces.nsIFilePicker;</span>
<a href="#l39.146"></a><span id="l39.146">     let fp = Components.classes[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l39.147"></a><span id="l39.147">                        .createInstance(nsIFilePicker);</span>
<a href="#l39.148"></a><span id="l39.148">     let bundle = document.getElementById(&quot;instantbirdBundle&quot;);</span>
<a href="#l39.149"></a><span id="l39.149">     fp.init(window, bundle.getString(&quot;userIconFilePickerTitle&quot;),</span>
<a href="#l39.150"></a><span id="l39.150">             nsIFilePicker.modeOpen);</span>
<a href="#l39.151"></a><span id="l39.151">     fp.appendFilters(nsIFilePicker.filterImages);</span>
<a href="#l39.152"></a><span id="l39.152">     if (fp.show() == nsIFilePicker.returnOK)</span>
<a href="#l39.153"></a><span id="l39.153" class="difflineminus">-      Services.core.setUserIcon(fp.file);</span>
<a href="#l39.154"></a><span id="l39.154" class="difflineplus">+      Services.core.globalUserStatus.setUserIcon(fp.file);</span>
<a href="#l39.155"></a><span id="l39.155">   },</span>
<a href="#l39.156"></a><span id="l39.156"> </span>
<a href="#l39.157"></a><span id="l39.157">   displayNameClick: function bl_displayNameClick() {</span>
<a href="#l39.158"></a><span id="l39.158">     let elt = document.getElementById(&quot;displayName&quot;);</span>
<a href="#l39.159"></a><span id="l39.159">     if (!elt.hasAttribute(&quot;editing&quot;)) {</span>
<a href="#l39.160"></a><span id="l39.160">       elt.setAttribute(&quot;editing&quot;, &quot;true&quot;);</span>
<a href="#l39.161"></a><span id="l39.161">       if (elt.hasAttribute(&quot;usingDefault&quot;))</span>
<a href="#l39.162"></a><span id="l39.162">         elt.removeAttribute(&quot;value&quot;);</span>
<a href="#l39.163"></a><span id="l39.163" class="difflineat">@@ -612,17 +612,17 @@ var buddyList = {</span>
<a href="#l39.164"></a><span id="l39.164">     }</span>
<a href="#l39.165"></a><span id="l39.165">   },</span>
<a href="#l39.166"></a><span id="l39.166"> </span>
<a href="#l39.167"></a><span id="l39.167">   finishEditDisplayName: function bl_finishEditDisplayName(aSave) {</span>
<a href="#l39.168"></a><span id="l39.168">     clearTimeout(this._stopEditDisplayNameTimeout);</span>
<a href="#l39.169"></a><span id="l39.169">     let elt = document.getElementById(&quot;displayName&quot;);</span>
<a href="#l39.170"></a><span id="l39.170">     // Apply the new display name only if it is different from the current one.</span>
<a href="#l39.171"></a><span id="l39.171">     if (aSave &amp;&amp; elt.value != elt.getAttribute(&quot;value&quot;))</span>
<a href="#l39.172"></a><span id="l39.172" class="difflineminus">-      Services.core.userDisplayName = elt.value;</span>
<a href="#l39.173"></a><span id="l39.173" class="difflineplus">+      Services.core.globalUserStatus.displayName = elt.value;</span>
<a href="#l39.174"></a><span id="l39.174">     else if (elt.hasAttribute(&quot;usingDefault&quot;))</span>
<a href="#l39.175"></a><span id="l39.175">       elt.setAttribute(&quot;value&quot;, elt.getAttribute(&quot;usingDefault&quot;));</span>
<a href="#l39.176"></a><span id="l39.176"> </span>
<a href="#l39.177"></a><span id="l39.177">     elt.removeAttribute(&quot;editing&quot;);</span>
<a href="#l39.178"></a><span id="l39.178">     elt.removeEventListener(&quot;keypress&quot;, this.displayNameKeyPress, false);</span>
<a href="#l39.179"></a><span id="l39.179">     elt.removeEventListener(&quot;blur&quot;, this.displayNameBlur, false);</span>
<a href="#l39.180"></a><span id="l39.180">   },</span>
<a href="#l39.181"></a><span id="l39.181"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/im/content/debug/debug.js</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/im/content/debug/debug.js</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -61,33 +61,32 @@ function debug_enumerateProtocols()</span>
<a href="#l40.4"></a><span id="l40.4">            opt.name + (opt.masked ? &quot;(masked)&quot; : &quot;&quot;) + &quot;\t&quot; +</span>
<a href="#l40.5"></a><span id="l40.5">            type[opt.type][1]() + &quot;\n&quot;);</span>
<a href="#l40.6"></a><span id="l40.6">     }</span>
<a href="#l40.7"></a><span id="l40.7">   }</span>
<a href="#l40.8"></a><span id="l40.8"> }</span>
<a href="#l40.9"></a><span id="l40.9"> </span>
<a href="#l40.10"></a><span id="l40.10"> function debug_connectAccount(aProto, aName, aPassword)</span>
<a href="#l40.11"></a><span id="l40.11"> {</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-  var pcs = Services.core;</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineminus">-  var proto = pcs.getProtocolById(aProto);</span>
<a href="#l40.14"></a><span id="l40.14" class="difflineplus">+  var proto = Services.core.getProtocolById(aProto);</span>
<a href="#l40.15"></a><span id="l40.15">   if (!proto)</span>
<a href="#l40.16"></a><span id="l40.16">     throw &quot;Couldn't get protocol &quot; + aProto;</span>
<a href="#l40.17"></a><span id="l40.17"> </span>
<a href="#l40.18"></a><span id="l40.18" class="difflineminus">-  var acc = pcs.createAccount(aName, proto);</span>
<a href="#l40.19"></a><span id="l40.19" class="difflineplus">+  var acc = Services.accounts.createAccount(aName, proto);</span>
<a href="#l40.20"></a><span id="l40.20">   acc.password = aPassword;</span>
<a href="#l40.21"></a><span id="l40.21">   dump(&quot;trying to connect to &quot; + proto.name +</span>
<a href="#l40.22"></a><span id="l40.22">        &quot; (&quot; + proto.id + &quot;) with &quot; + aName + &quot;\n&quot;);</span>
<a href="#l40.23"></a><span id="l40.23">   acc.connect();</span>
<a href="#l40.24"></a><span id="l40.24"> }</span>
<a href="#l40.25"></a><span id="l40.25"> </span>
<a href="#l40.26"></a><span id="l40.26"> function debug_dumpBuddyList()</span>
<a href="#l40.27"></a><span id="l40.27"> {</span>
<a href="#l40.28"></a><span id="l40.28">   let formatBuddy = (function(buddy) &quot;  &quot; + buddy.name + &quot;\n   &quot; + buddy.getAccounts().map(function(a) a.name).join(&quot; &quot;));</span>
<a href="#l40.29"></a><span id="l40.29">   let formatGroup = (function(aGroup) &quot; Group &quot; + aGroup.id + &quot;: &quot; + aGroup.name + &quot;\n&quot; + aGroup.getBuddies().map(formatBuddy).join(&quot;\n&quot;));</span>
<a href="#l40.30"></a><span id="l40.30" class="difflineminus">-  dump(&quot;Buddy list:\n\n&quot; + Services.core.getTags().map(formatGroup).join(&quot;\n\n&quot;) + &quot;\n\n&quot;);</span>
<a href="#l40.31"></a><span id="l40.31" class="difflineplus">+  dump(&quot;Buddy list:\n\n&quot; + Services.tags.getTags().map(formatGroup).join(&quot;\n\n&quot;) + &quot;\n\n&quot;);</span>
<a href="#l40.32"></a><span id="l40.32"> }</span>
<a href="#l40.33"></a><span id="l40.33"> </span>
<a href="#l40.34"></a><span id="l40.34"> function dumpStack(offset, max_depth)</span>
<a href="#l40.35"></a><span id="l40.35"> {</span>
<a href="#l40.36"></a><span id="l40.36">   if (!offset || offset&lt;0) offset = 0;</span>
<a href="#l40.37"></a><span id="l40.37">   if (!max_depth) max_depth = 10;</span>
<a href="#l40.38"></a><span id="l40.38">   var frame = Components.stack;</span>
<a href="#l40.39"></a><span id="l40.39">   while(--max_depth &amp;&amp; (frame=frame.caller)) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/im/content/debug/fake/fake.js</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/im/content/debug/fake/fake.js</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -298,48 +298,48 @@ var fake = {</span>
<a href="#l41.4"></a><span id="l41.4">                 {time: makeDate(&quot;10:43:32&quot;), outgoing: true, conversation: chat});</span>
<a href="#l41.5"></a><span id="l41.5">     new Message(&quot;Andrew&quot;, &quot;Instantbird is great!&quot;,</span>
<a href="#l41.6"></a><span id="l41.6">                 {time: makeDate(&quot;10:43:52&quot;), incoming: true, conversation: chat});</span>
<a href="#l41.7"></a><span id="l41.7">     new Message(&quot;Daniel&quot;, &quot;Sure! I love it! &lt;3&quot;,</span>
<a href="#l41.8"></a><span id="l41.8">                 {time: makeDate(&quot;10:44:01&quot;), incoming: true, conversation: chat});</span>
<a href="#l41.9"></a><span id="l41.9">     new Message(&quot;Florian&quot;, &quot;Thanks :)&quot;,</span>
<a href="#l41.10"></a><span id="l41.10">                 {time: makeDate(&quot;10:44:12&quot;), incoming: true, conversation: chat});</span>
<a href="#l41.11"></a><span id="l41.11"> </span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-    Services.core.userDisplayName = &quot;Tom Smith&quot;;</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+    Services.core.globalUserStatus.displayName = &quot;Tom Smith&quot;;</span>
<a href="#l41.14"></a><span id="l41.14">     // Ugly :-(</span>
<a href="#l41.15"></a><span id="l41.15">     document.getElementById(&quot;userIcon&quot;).src = ib_icon_url;</span>
<a href="#l41.16"></a><span id="l41.16">   },</span>
<a href="#l41.17"></a><span id="l41.17">   deleteAccounts: function f_deleteAccounts() {</span>
<a href="#l41.18"></a><span id="l41.18" class="difflineminus">-    if (!Services.core.getAccounts().hasMoreElements())</span>
<a href="#l41.19"></a><span id="l41.19" class="difflineplus">+    if (!Services.accounts.getAccounts().hasMoreElements())</span>
<a href="#l41.20"></a><span id="l41.20">       return;</span>
<a href="#l41.21"></a><span id="l41.21"> </span>
<a href="#l41.22"></a><span id="l41.22">     var prompts = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l41.23"></a><span id="l41.23">                             .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l41.24"></a><span id="l41.24">     if (!prompts.confirm(window, &quot;Are you sure you want to delete all accounts?&quot;,</span>
<a href="#l41.25"></a><span id="l41.25">                          &quot;You are about to delete &quot; + nbaccounts + &quot; accounts. Are you sure?&quot;))</span>
<a href="#l41.26"></a><span id="l41.26">       throw &quot;user aborted the operation&quot;;</span>
<a href="#l41.27"></a><span id="l41.27"> </span>
<a href="#l41.28"></a><span id="l41.28" class="difflineminus">-    for (let acc in getIter(Services.core.getAccounts()))</span>
<a href="#l41.29"></a><span id="l41.29" class="difflineminus">-      Services.core.deleteAccount(acc.id);</span>
<a href="#l41.30"></a><span id="l41.30" class="difflineplus">+    for (let acc in getIter(Services.accounts.getAccounts()))</span>
<a href="#l41.31"></a><span id="l41.31" class="difflineplus">+      Services.accounts.deleteAccount(acc.id);</span>
<a href="#l41.32"></a><span id="l41.32">   }</span>
<a href="#l41.33"></a><span id="l41.33"> };</span>
<a href="#l41.34"></a><span id="l41.34"> </span>
<a href="#l41.35"></a><span id="l41.35"> this.addEventListener(&quot;load&quot;, fake.load);</span>
<a href="#l41.36"></a><span id="l41.36"> </span>
<a href="#l41.37"></a><span id="l41.37"> var gLastAccountId = 0;</span>
<a href="#l41.38"></a><span id="l41.38"> function Account(aName, aProto)</span>
<a href="#l41.39"></a><span id="l41.39"> {</span>
<a href="#l41.40"></a><span id="l41.40">   this.name = aName;</span>
<a href="#l41.41"></a><span id="l41.41">   this.protocol = Services.core.getProtocolById(aProto);</span>
<a href="#l41.42"></a><span id="l41.42">   this.id = &quot;account&quot; + (++gLastAccountId);</span>
<a href="#l41.43"></a><span id="l41.43"> </span>
<a href="#l41.44"></a><span id="l41.44">   dump(&quot;account &quot; + aName + &quot; created\n&quot;);</span>
<a href="#l41.45"></a><span id="l41.45"> }</span>
<a href="#l41.46"></a><span id="l41.46"> Account.prototype = {</span>
<a href="#l41.47"></a><span id="l41.47" class="difflineminus">-  __proto__: ClassInfo(&quot;purpleIAccount&quot;, &quot;generic account object&quot;),</span>
<a href="#l41.48"></a><span id="l41.48" class="difflineplus">+  __proto__: ClassInfo(&quot;imIAccount&quot;, &quot;generic account object&quot;),</span>
<a href="#l41.49"></a><span id="l41.49">   protocol: null,</span>
<a href="#l41.50"></a><span id="l41.50">   password: &quot;&quot;,</span>
<a href="#l41.51"></a><span id="l41.51">   autoLogin: true,</span>
<a href="#l41.52"></a><span id="l41.52">   rememberPassword: true,</span>
<a href="#l41.53"></a><span id="l41.53">   alias: &quot;&quot;,</span>
<a href="#l41.54"></a><span id="l41.54">   proxyInfo: null,</span>
<a href="#l41.55"></a><span id="l41.55">   connectionStageMsg: &quot;&quot;,</span>
<a href="#l41.56"></a><span id="l41.56">   connectionErrorReason: -1,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/im/content/joinchat.js</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/im/content/joinchat.js</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -169,10 +169,10 @@ var joinChat = {</span>
<a href="#l42.4"></a><span id="l42.4">         autojoin.push(name);</span>
<a href="#l42.5"></a><span id="l42.5">         prefBranch.setCharPref(autoJoinPref, autojoin.join(&quot;,&quot;));</span>
<a href="#l42.6"></a><span id="l42.6">       }</span>
<a href="#l42.7"></a><span id="l42.7">     }</span>
<a href="#l42.8"></a><span id="l42.8"> </span>
<a href="#l42.9"></a><span id="l42.9">     return true;</span>
<a href="#l42.10"></a><span id="l42.10">   },</span>
<a href="#l42.11"></a><span id="l42.11"> </span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-  getAccounts: function jc_getAccounts() getIter(Services.core.getAccounts())</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+  getAccounts: function jc_getAccounts() getIter(Services.accounts.getAccounts())</span>
<a href="#l42.14"></a><span id="l42.14"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/im/content/menus.js</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/im/content/menus.js</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -45,17 +45,17 @@ if (!(&quot;Services&quot; in window))</span>
<a href="#l43.4"></a><span id="l43.4">   Components.utils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l43.5"></a><span id="l43.5"> if (!(&quot;Core&quot; in window))</span>
<a href="#l43.6"></a><span id="l43.6">   Components.utils.import(&quot;resource:///modules/ibCore.jsm&quot;);</span>
<a href="#l43.7"></a><span id="l43.7"> </span>
<a href="#l43.8"></a><span id="l43.8"> var menus = {</span>
<a href="#l43.9"></a><span id="l43.9">   supportsCommand: function(aCmd)</span>
<a href="#l43.10"></a><span id="l43.10">     aCmd == &quot;cmd_addbuddy&quot; || aCmd == &quot;cmd_joinchat&quot;,</span>
<a href="#l43.11"></a><span id="l43.11">   isCommandEnabled: function(aCmd) {</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-    let enumerator = Services.core.getAccounts();</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+    let enumerator = Services.accounts.getAccounts();</span>
<a href="#l43.14"></a><span id="l43.14">     while (enumerator.hasMoreElements()) {</span>
<a href="#l43.15"></a><span id="l43.15">       let acc = enumerator.getNext();</span>
<a href="#l43.16"></a><span id="l43.16">       if (acc.connected &amp;&amp; (aCmd == &quot;cmd_addbuddy&quot; || acc.canJoinChat))</span>
<a href="#l43.17"></a><span id="l43.17">         return true;</span>
<a href="#l43.18"></a><span id="l43.18">     }</span>
<a href="#l43.19"></a><span id="l43.19">     return false;</span>
<a href="#l43.20"></a><span id="l43.20">   },</span>
<a href="#l43.21"></a><span id="l43.21">   doCommand: function(aCmd) {</span>
<a href="#l43.22"></a><span id="l43.22" class="difflineat">@@ -171,17 +171,17 @@ var menus = {</span>
<a href="#l43.23"></a><span id="l43.23"> </span>
<a href="#l43.24"></a><span id="l43.24">   joinChat: function menu_joinChat() {</span>
<a href="#l43.25"></a><span id="l43.25">     this.openDialog(&quot;Messenger:JoinChat&quot;, joinChatWindow);</span>
<a href="#l43.26"></a><span id="l43.26">   },</span>
<a href="#l43.27"></a><span id="l43.27"> </span>
<a href="#l43.28"></a><span id="l43.28">   checkCurrentStatusType: function menu_checkCurrentStatusType(aItems) {</span>
<a href="#l43.29"></a><span id="l43.29">     if (!(&quot;Status&quot; in window))</span>
<a href="#l43.30"></a><span id="l43.30">       Components.utils.import(&quot;resource:///modules/imStatusUtils.jsm&quot;);</span>
<a href="#l43.31"></a><span id="l43.31" class="difflineminus">-    let status = Status.toAttribute(Services.core.currentStatusType);</span>
<a href="#l43.32"></a><span id="l43.32" class="difflineplus">+    let status = Status.toAttribute(Services.core.globalUserStatus.statusType);</span>
<a href="#l43.33"></a><span id="l43.33">     if (status == &quot;away&quot;)</span>
<a href="#l43.34"></a><span id="l43.34">       status = &quot;unavailable&quot;;</span>
<a href="#l43.35"></a><span id="l43.35"> </span>
<a href="#l43.36"></a><span id="l43.36">     aItems.forEach(function (aId) {</span>
<a href="#l43.37"></a><span id="l43.37">       let elt = document.getElementById(aId);</span>
<a href="#l43.38"></a><span id="l43.38">       if (elt.getAttribute(&quot;status&quot;) == status)</span>
<a href="#l43.39"></a><span id="l43.39">         elt.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l43.40"></a><span id="l43.40">       else</span>
<a href="#l43.41"></a><span id="l43.41" class="difflineat">@@ -201,15 +201,15 @@ var menus = {</span>
<a href="#l43.42"></a><span id="l43.42">       return; // is this really possible?</span>
<a href="#l43.43"></a><span id="l43.43"> </span>
<a href="#l43.44"></a><span id="l43.44">     let blist = Services.wm.getMostRecentWindow(&quot;Messenger:blist&quot;);</span>
<a href="#l43.45"></a><span id="l43.45">     if (blist) {</span>
<a href="#l43.46"></a><span id="l43.46">       blist.focus();</span>
<a href="#l43.47"></a><span id="l43.47">       blist.buddyList.startEditStatus(status);</span>
<a href="#l43.48"></a><span id="l43.48">     }</span>
<a href="#l43.49"></a><span id="l43.49">     else {</span>
<a href="#l43.50"></a><span id="l43.50" class="difflineminus">-      Services.core.setStatus(Status.toFlag(status),</span>
<a href="#l43.51"></a><span id="l43.51" class="difflineminus">-                              Services.core.currentStatusMessage);</span>
<a href="#l43.52"></a><span id="l43.52" class="difflineplus">+      let us = Services.core.globalUserStatus;</span>
<a href="#l43.53"></a><span id="l43.53" class="difflineplus">+      us.setStatus(Status.toFlag(status), us.statusText);</span>
<a href="#l43.54"></a><span id="l43.54">     }</span>
<a href="#l43.55"></a><span id="l43.55">   }</span>
<a href="#l43.56"></a><span id="l43.56"> };</span>
<a href="#l43.57"></a><span id="l43.57"> </span>
<a href="#l43.58"></a><span id="l43.58"> window.addEventListener(&quot;load&quot;, function() { this.controllers.insertControllerAt(0, menus); });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/im/content/proxies.js</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/im/content/proxies.js</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -37,17 +37,18 @@</span>
<a href="#l44.4"></a><span id="l44.4"> </span>
<a href="#l44.5"></a><span id="l44.5"> var gProxies = {</span>
<a href="#l44.6"></a><span id="l44.6">   load: function proxy_load() {</span>
<a href="#l44.7"></a><span id="l44.7"> </span>
<a href="#l44.8"></a><span id="l44.8">   // check the environment</span>
<a href="#l44.9"></a><span id="l44.9">   // see what the global settings are</span>
<a href="#l44.10"></a><span id="l44.10">   // build a list of existing proxies</span>
<a href="#l44.11"></a><span id="l44.11"> </span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-    var pcs = Services.core;</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+    var pcs = Cc[&quot;@instantbird.org/libpurple/core;1&quot;]</span>
<a href="#l44.14"></a><span id="l44.14" class="difflineplus">+              .getService(Ci.purpleICoreService);</span>
<a href="#l44.15"></a><span id="l44.15"> </span>
<a href="#l44.16"></a><span id="l44.16">     var proxyInfoCtr = Components.Constructor(&quot;@instantbird.org/purple/proxyinfo;1&quot;,</span>
<a href="#l44.17"></a><span id="l44.17">                                               &quot;purpleIProxyInfo&quot;);</span>
<a href="#l44.18"></a><span id="l44.18">     var proxyInfo;</span>
<a href="#l44.19"></a><span id="l44.19">     var account = window.arguments[0];</span>
<a href="#l44.20"></a><span id="l44.20">     if (account) {</span>
<a href="#l44.21"></a><span id="l44.21">       proxyInfo = new proxyInfoCtr();</span>
<a href="#l44.22"></a><span id="l44.22">       proxyInfo.type = Ci.purpleIProxyInfo.useGlobal;</span>
<a href="#l44.23"></a><span id="l44.23" class="difflineat">@@ -147,17 +148,18 @@ var gProxies = {</span>
<a href="#l44.24"></a><span id="l44.24">     }</span>
<a href="#l44.25"></a><span id="l44.25">   },</span>
<a href="#l44.26"></a><span id="l44.26"> </span>
<a href="#l44.27"></a><span id="l44.27">   getValue: function proxy_getValue(aId) {</span>
<a href="#l44.28"></a><span id="l44.28">     return document.getElementById(aId).value;</span>
<a href="#l44.29"></a><span id="l44.29">   },</span>
<a href="#l44.30"></a><span id="l44.30"> </span>
<a href="#l44.31"></a><span id="l44.31">   accept: function proxy_accept() {</span>
<a href="#l44.32"></a><span id="l44.32" class="difflineminus">-    var pcs = Services.core;</span>
<a href="#l44.33"></a><span id="l44.33" class="difflineplus">+    var pcs = Cc[&quot;@instantbird.org/libpurple/core;1&quot;]</span>
<a href="#l44.34"></a><span id="l44.34" class="difflineplus">+              .getService(Ci.purpleICoreService);</span>
<a href="#l44.35"></a><span id="l44.35">     var promptService = Services.prompt;</span>
<a href="#l44.36"></a><span id="l44.36">     var item = document.getElementById(&quot;proxylist&quot;).selectedItem;</span>
<a href="#l44.37"></a><span id="l44.37">     if (item.id == &quot;newProxy&quot;) {</span>
<a href="#l44.38"></a><span id="l44.38">       var type = this.getValue(&quot;proxyType&quot;);</span>
<a href="#l44.39"></a><span id="l44.39">       var host = this.getValue(&quot;hostname&quot;);</span>
<a href="#l44.40"></a><span id="l44.40">       var port = this.getValue(&quot;port&quot;);</span>
<a href="#l44.41"></a><span id="l44.41">       if (!host || !port) {</span>
<a href="#l44.42"></a><span id="l44.42">         promptService.alert(window, bundle.getString(&quot;proxies.alert.invalidInput.title&quot;),</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/im/locales/en-US/chrome/instantbird/core.properties</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/im/locales/en-US/chrome/instantbird/core.properties</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -1,12 +1,10 @@</span>
<a href="#l45.4"></a><span id="l45.4"> startupFailure.title=Instantbird - Start up failure</span>
<a href="#l45.5"></a><span id="l45.5"> startupFailure.apologize=Instantbird encountered a serious error and cannot start, we apologize for the inconvenience.</span>
<a href="#l45.6"></a><span id="l45.6"> startupFailure.update=An updated version will probably be available shortly to fix the problem.</span>
<a href="#l45.7"></a><span id="l45.7"> </span>
<a href="#l45.8"></a><span id="l45.8" class="difflineminus">-startupFailure.purplexpcomFileError=Description: The file &quot;purplexpcom.xpt&quot; is missing or corrupted.</span>
<a href="#l45.9"></a><span id="l45.9" class="difflineminus">-startupFailure.xpcomRegistrationError=Description: XPCOM registration of the purplexpcom component failed.</span>
<a href="#l45.10"></a><span id="l45.10" class="difflineminus">-startupFailure.purplexpcomInitError=An exception occurred while initializing purplexpcom: %S</span>
<a href="#l45.11"></a><span id="l45.11" class="difflineminus">-startupFailure.libpurpleError=An error occurred while checking whether libpurple is usable.</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-startupFailure.noProtocolLoaded=Description: No protocol plugin could be loaded.</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineplus">+startupFailure.purplexpcomFileError=Description: The file &quot;instantbird.xpt&quot; is missing or corrupted.</span>
<a href="#l45.14"></a><span id="l45.14" class="difflineplus">+startupFailure.xpcomRegistrationError=Description: XPCOM registration of the core component failed.</span>
<a href="#l45.15"></a><span id="l45.15" class="difflineplus">+startupFailure.purplexpcomInitError=An exception occurred while initializing the core component: %S</span>
<a href="#l45.16"></a><span id="l45.16"> </span>
<a href="#l45.17"></a><span id="l45.17"> startupFailure.buttonUpdate=Check for Updates</span>
<a href="#l45.18"></a><span id="l45.18"> startupFailure.buttonClose=Close Instantbird</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/im/modules/ibCore.jsm</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/im/modules/ibCore.jsm</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -65,42 +65,29 @@ var Core = {</span>
<a href="#l46.4"></a><span id="l46.4">       // don't worry too much about this exception.</span>
<a href="#l46.5"></a><span id="l46.5">     }</span>
<a href="#l46.6"></a><span id="l46.6"> </span>
<a href="#l46.7"></a><span id="l46.7">     if (!Ci.purpleICoreService) {</span>
<a href="#l46.8"></a><span id="l46.8">       this._promptError(&quot;startupFailure.purplexpcomFileError&quot;);</span>
<a href="#l46.9"></a><span id="l46.9">       return false;</span>
<a href="#l46.10"></a><span id="l46.10">     }</span>
<a href="#l46.11"></a><span id="l46.11"> </span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-    if (!Components.classes[&quot;@instantbird.org/purple/core;1&quot;]) {</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineplus">+    if (!Components.classes[&quot;@instantbird.org/purple/core-service;1&quot;]) {</span>
<a href="#l46.14"></a><span id="l46.14">       this._promptError(&quot;startupFailure.xpcomRegistrationError&quot;);</span>
<a href="#l46.15"></a><span id="l46.15">       return false;</span>
<a href="#l46.16"></a><span id="l46.16">     }</span>
<a href="#l46.17"></a><span id="l46.17"> </span>
<a href="#l46.18"></a><span id="l46.18">     try {</span>
<a href="#l46.19"></a><span id="l46.19" class="difflineminus">-      var pcs = Services.core;</span>
<a href="#l46.20"></a><span id="l46.20" class="difflineminus">-      pcs.init();</span>
<a href="#l46.21"></a><span id="l46.21" class="difflineplus">+      Services.core.init();</span>
<a href="#l46.22"></a><span id="l46.22">     }</span>
<a href="#l46.23"></a><span id="l46.23">     catch (e) {</span>
<a href="#l46.24"></a><span id="l46.24">       this._promptError(&quot;startupFailure.purplexpcomInitError&quot;, e);</span>
<a href="#l46.25"></a><span id="l46.25">       return false;</span>
<a href="#l46.26"></a><span id="l46.26">     }</span>
<a href="#l46.27"></a><span id="l46.27"> </span>
<a href="#l46.28"></a><span id="l46.28" class="difflineminus">-    if (!pcs.version) {</span>
<a href="#l46.29"></a><span id="l46.29" class="difflineminus">-      this._promptError(&quot;startupFailure.libpurpleError&quot;);</span>
<a href="#l46.30"></a><span id="l46.30" class="difflineminus">-      return false;</span>
<a href="#l46.31"></a><span id="l46.31" class="difflineminus">-    }</span>
<a href="#l46.32"></a><span id="l46.32" class="difflineminus">-</span>
<a href="#l46.33"></a><span id="l46.33" class="difflineminus">-    if (!pcs.getProtocols().hasMoreElements()) {</span>
<a href="#l46.34"></a><span id="l46.34" class="difflineminus">-      this._promptError(&quot;startupFailure.noProtocolLoaded&quot;);</span>
<a href="#l46.35"></a><span id="l46.35" class="difflineminus">-      this.uninitPurpleCore();</span>
<a href="#l46.36"></a><span id="l46.36" class="difflineminus">-      return false;</span>
<a href="#l46.37"></a><span id="l46.37" class="difflineminus">-    }</span>
<a href="#l46.38"></a><span id="l46.38" class="difflineminus">-</span>
<a href="#l46.39"></a><span id="l46.39" class="difflineminus">-    Services.conversations.initConversations();</span>
<a href="#l46.40"></a><span id="l46.40">     Conversations.init();</span>
<a href="#l46.41"></a><span id="l46.41">     Notifications.init();</span>
<a href="#l46.42"></a><span id="l46.42">     Sounds.init();</span>
<a href="#l46.43"></a><span id="l46.43"> #ifdef XP_WIN</span>
<a href="#l46.44"></a><span id="l46.44">     // For windows seven, initialize the jump list module.</span>
<a href="#l46.45"></a><span id="l46.45">     const WINTASKBAR_CONTRACTID = &quot;@mozilla.org/windows-taskbar;1&quot;;</span>
<a href="#l46.46"></a><span id="l46.46">     if (WINTASKBAR_CONTRACTID in Cc &amp;&amp;</span>
<a href="#l46.47"></a><span id="l46.47">         Cc[WINTASKBAR_CONTRACTID].getService(Ci.nsIWinTaskbar).available) {</span>
<a href="#l46.48"></a><span id="l46.48" class="difflineat">@@ -165,27 +152,27 @@ var Core = {</span>
<a href="#l46.49"></a><span id="l46.49">     else</span>
<a href="#l46.50"></a><span id="l46.50">       prompter.checkForUpdates();</span>
<a href="#l46.51"></a><span id="l46.51">   },</span>
<a href="#l46.52"></a><span id="l46.52"> </span>
<a href="#l46.53"></a><span id="l46.53">   getIter: function(aEnumerator) {</span>
<a href="#l46.54"></a><span id="l46.54">     while (aEnumerator.hasMoreElements())</span>
<a href="#l46.55"></a><span id="l46.55">       yield aEnumerator.getNext();</span>
<a href="#l46.56"></a><span id="l46.56">   },</span>
<a href="#l46.57"></a><span id="l46.57" class="difflineminus">-  getAccounts: function() this.getIter(Services.core.getAccounts()),</span>
<a href="#l46.58"></a><span id="l46.58" class="difflineplus">+  getAccounts: function() this.getIter(Services.accounts.getAccounts()),</span>
<a href="#l46.59"></a><span id="l46.59"> </span>
<a href="#l46.60"></a><span id="l46.60">   /* This function pops up the account manager if no account is</span>
<a href="#l46.61"></a><span id="l46.61">    * connected or connecting.</span>
<a href="#l46.62"></a><span id="l46.62">    * When called during startup (aIsStarting == true), it will also</span>
<a href="#l46.63"></a><span id="l46.63">    * look for crashed accounts.</span>
<a href="#l46.64"></a><span id="l46.64">    */</span>
<a href="#l46.65"></a><span id="l46.65">   _showAccountManagerIfNeeded: function (aIsStarting) {</span>
<a href="#l46.66"></a><span id="l46.66">     // If the current status is offline, we don't need the account manager</span>
<a href="#l46.67"></a><span id="l46.67">     let isOffline =</span>
<a href="#l46.68"></a><span id="l46.68" class="difflineminus">-      Services.core.currentStatusType == Ci.imIStatusInfo.STATUS_OFFLINE;</span>
<a href="#l46.69"></a><span id="l46.69" class="difflineplus">+      Services.core.globalUserStatus.statusType == Ci.imIStatusInfo.STATUS_OFFLINE;</span>
<a href="#l46.70"></a><span id="l46.70">     if (isOffline &amp;&amp; !aIsStarting)</span>
<a href="#l46.71"></a><span id="l46.71">       return;</span>
<a href="#l46.72"></a><span id="l46.72"> </span>
<a href="#l46.73"></a><span id="l46.73">     let hasActiveAccount = false;</span>
<a href="#l46.74"></a><span id="l46.74">     let hasCrashedAccount = false;</span>
<a href="#l46.75"></a><span id="l46.75">     for (let acc in this.getAccounts()) {</span>
<a href="#l46.76"></a><span id="l46.76">       if (acc.connected || acc.connecting)</span>
<a href="#l46.77"></a><span id="l46.77">         hasActiveAccount = true;</span>
<a href="#l46.78"></a><span id="l46.78" class="difflineat">@@ -201,17 +188,17 @@ var Core = {</span>
<a href="#l46.79"></a><span id="l46.79">        In case of connection failure after an automatic reconnection attempt,</span>
<a href="#l46.80"></a><span id="l46.80">        we don't want to popup the account manager */</span>
<a href="#l46.81"></a><span id="l46.81">     if ((!hasActiveAccount &amp;&amp; !isOffline) || (aIsStarting &amp;&amp; hasCrashedAccount))</span>
<a href="#l46.82"></a><span id="l46.82">       this.showAccounts();</span>
<a href="#l46.83"></a><span id="l46.83">   },</span>
<a href="#l46.84"></a><span id="l46.84"> </span>
<a href="#l46.85"></a><span id="l46.85">   observe: function(aSubject, aTopic, aMsg) {</span>
<a href="#l46.86"></a><span id="l46.86">     if (aTopic == &quot;account-connected&quot;) {</span>
<a href="#l46.87"></a><span id="l46.87" class="difflineminus">-      let account = aSubject.QueryInterface(Components.interfaces.purpleIAccount);</span>
<a href="#l46.88"></a><span id="l46.88" class="difflineplus">+      let account = aSubject.QueryInterface(Ci.imIAccount);</span>
<a href="#l46.89"></a><span id="l46.89">       if (!account.canJoinChat)</span>
<a href="#l46.90"></a><span id="l46.90">         return;</span>
<a href="#l46.91"></a><span id="l46.91"> </span>
<a href="#l46.92"></a><span id="l46.92">       let pref = &quot;messenger.account.&quot; + account.id + &quot;.autoJoin&quot;;</span>
<a href="#l46.93"></a><span id="l46.93">       if (Services.prefs.prefHasUserValue(pref)) {</span>
<a href="#l46.94"></a><span id="l46.94">         let autojoin = Services.prefs.getCharPref(pref);</span>
<a href="#l46.95"></a><span id="l46.95">         if (autojoin) {</span>
<a href="#l46.96"></a><span id="l46.96">           autojoin = autojoin.split(&quot;,&quot;);</span>
<a href="#l46.97"></a><span id="l46.97" class="difflineat">@@ -220,17 +207,17 @@ var Core = {</span>
<a href="#l46.98"></a><span id="l46.98">             account.joinChat(values);</span>
<a href="#l46.99"></a><span id="l46.99">           }</span>
<a href="#l46.100"></a><span id="l46.100">         }</span>
<a href="#l46.101"></a><span id="l46.101">       }</span>
<a href="#l46.102"></a><span id="l46.102">       return;</span>
<a href="#l46.103"></a><span id="l46.103">     }</span>
<a href="#l46.104"></a><span id="l46.104"> </span>
<a href="#l46.105"></a><span id="l46.105">     if (aTopic == &quot;account-disconnected&quot;) {</span>
<a href="#l46.106"></a><span id="l46.106" class="difflineminus">-      let account = aSubject.QueryInterface(Ci.purpleIAccount);</span>
<a href="#l46.107"></a><span id="l46.107" class="difflineplus">+      let account = aSubject.QueryInterface(Ci.imIAccount);</span>
<a href="#l46.108"></a><span id="l46.108">       if (account.reconnectAttempt &lt;= 1)</span>
<a href="#l46.109"></a><span id="l46.109">         this._showAccountManagerIfNeeded(false);</span>
<a href="#l46.110"></a><span id="l46.110">       return;</span>
<a href="#l46.111"></a><span id="l46.111">     }</span>
<a href="#l46.112"></a><span id="l46.112"> </span>
<a href="#l46.113"></a><span id="l46.113">     if (aTopic == &quot;browser-request&quot;) {</span>
<a href="#l46.114"></a><span id="l46.114">       Services.ww.openWindow(null,</span>
<a href="#l46.115"></a><span id="l46.115">                              &quot;chrome://instantbird/content/browserRequest.xul&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/purple/purplexpcom/public/purpleIRequest.idl</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/purple/purplexpcom/public/purpleIRequest.idl</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -32,21 +32,21 @@</span>
<a href="#l47.4"></a><span id="l47.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l47.5"></a><span id="l47.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l47.6"></a><span id="l47.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l47.7"></a><span id="l47.7">  *</span>
<a href="#l47.8"></a><span id="l47.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l47.9"></a><span id="l47.9"> </span>
<a href="#l47.10"></a><span id="l47.10"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l47.11"></a><span id="l47.11"> </span>
<a href="#l47.12"></a><span id="l47.12" class="difflineminus">-interface purpleIAccount;</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineplus">+interface imIAccount;</span>
<a href="#l47.14"></a><span id="l47.14"> interface nsIDOMWindowInternal;</span>
<a href="#l47.15"></a><span id="l47.15"> interface nsIWebProgress;</span>
<a href="#l47.16"></a><span id="l47.16"> </span>
<a href="#l47.17"></a><span id="l47.17"> [scriptable, uuid(b89dbb38-0de4-11e0-b3d0-0002e304243c)]</span>
<a href="#l47.18"></a><span id="l47.18"> interface purpleIRequestBrowser: nsISupports {</span>
<a href="#l47.19"></a><span id="l47.19">   readonly attribute AUTF8String promptText;</span>
<a href="#l47.20"></a><span id="l47.20" class="difflineminus">-  readonly attribute purpleIAccount account;</span>
<a href="#l47.21"></a><span id="l47.21" class="difflineplus">+  readonly attribute imIAccount account;</span>
<a href="#l47.22"></a><span id="l47.22">   readonly attribute AUTF8String url;</span>
<a href="#l47.23"></a><span id="l47.23">   void cancelled();</span>
<a href="#l47.24"></a><span id="l47.24">   void loaded(in nsIDOMWindowInternal aWindow,</span>
<a href="#l47.25"></a><span id="l47.25">               in nsIWebProgress aWebProgress);</span>
<a href="#l47.26"></a><span id="l47.26"> };</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

