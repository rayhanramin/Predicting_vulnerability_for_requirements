<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 5504:1e333d47863da0324273d7bc97e8f62ad7bf1455</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 1e333d47863da0324273d7bc97e8f62ad7bf1455" />
<meta property="og:url" content="/comm-central/rev/1e333d47863da0324273d7bc97e8f62ad7bf1455" />
<meta property="og:description" content="Bug 545955 - The quick filter bar. This replaces the previous quick search widget.  r+sr=bienvenu, ui-review=clarkbw" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 1e333d47863da0324273d7bc97e8f62ad7bf1455 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/1e333d47863da0324273d7bc97e8f62ad7bf1455">shortlog</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/1e333d47863da0324273d7bc97e8f62ad7bf1455">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455">files</a> |
changeset |
<a href="/comm-central/raw-rev/1e333d47863da0324273d7bc97e8f62ad7bf1455">raw</a>  | <a href="/comm-central/archive/1e333d47863da0324273d7bc97e8f62ad7bf1455.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=545955">Bug 545955</a> - The quick filter bar. This replaces the previous quick search widget.  r+sr=bienvenu, ui-review=clarkbw
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 21 Apr 2010 21:52:20 -0700</td></tr>

<tr>
 <td>changeset 5504</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/1e333d47863da0324273d7bc97e8f62ad7bf1455">1e333d47863da0324273d7bc97e8f62ad7bf1455</a></td>
</tr>



<tr>
<td>parent 5503</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7d1528f6c1715c4a4ccabb4254d1de3f659032e9">7d1528f6c1715c4a4ccabb4254d1de3f659032e9</a>
</td>
</tr>

<tr>
<td>child 5505</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/c341ceea13c51506fb62bbefa749073b82d524d7">c341ceea13c51506fb62bbefa749073b82d524d7</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=1e333d47863da0324273d7bc97e8f62ad7bf1455">4257</a></td></tr>
<tr><td>push user</td><td>bugmail@asutherland.org</td></tr>
<tr><td>push date</td><td class="date age">Thu, 22 Apr 2010 04:52:41 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@1e333d47863d [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1e333d47863da0324273d7bc97e8f62ad7bf1455">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1e333d47863da0324273d7bc97e8f62ad7bf1455&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1e333d47863da0324273d7bc97e8f62ad7bf1455&newProject=comm-central&newRevision=1e333d47863da0324273d7bc97e8f62ad7bf1455&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1e333d47863da0324273d7bc97e8f62ad7bf1455&newProject=comm-central&newRevision=1e333d47863da0324273d7bc97e8f62ad7bf1455&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1e333d47863da0324273d7bc97e8f62ad7bf1455&newProject=comm-central&newRevision=1e333d47863da0324273d7bc97e8f62ad7bf1455&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=545955">545955</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=545955">Bug 545955</a> - The quick filter bar. This replaces the previous quick search widget.  r+sr=bienvenu, ui-review=clarkbw</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/extraCustomizeItems.xul">mail/base/content/extraCustomizeItems.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/extraCustomizeItems.xul">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/extraCustomizeItems.xul">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/extraCustomizeItems.xul">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/extraCustomizeItems.xul">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/extraCustomizeItems.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/folderDisplay.js">mail/base/content/folderDisplay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/folderDisplay.js">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/folderDisplay.js">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/folderDisplay.js">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/folderDisplay.js">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/folderDisplay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/mailTabs.js">mail/base/content/mailTabs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/mailTabs.js">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/mailTabs.js">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/mailTabs.js">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/mailTabs.js">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/mailTabs.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/mailWindowOverlay.xul">mail/base/content/mailWindowOverlay.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/mailWindowOverlay.xul">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/mailWindowOverlay.xul">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/mailWindowOverlay.xul">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/mailWindowOverlay.xul">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/mailWindowOverlay.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/messenger.xul">mail/base/content/messenger.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/messenger.xul">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/messenger.xul">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/messenger.xul">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/messenger.xul">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/messenger.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/msgMail3PaneWindow.js">mail/base/content/msgMail3PaneWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/msgMail3PaneWindow.js">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/msgMail3PaneWindow.js">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/msgMail3PaneWindow.js">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/msgMail3PaneWindow.js">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/msgMail3PaneWindow.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/quickFilterBar.css">mail/base/content/quickFilterBar.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/quickFilterBar.css">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/quickFilterBar.css">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/quickFilterBar.css">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/quickFilterBar.css">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/quickFilterBar.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/quickFilterBar.js">mail/base/content/quickFilterBar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/quickFilterBar.js">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/quickFilterBar.js">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/quickFilterBar.js">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/quickFilterBar.js">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/quickFilterBar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/quickFilterBar.xul">mail/base/content/quickFilterBar.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/quickFilterBar.xul">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/quickFilterBar.xul">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/quickFilterBar.xul">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/quickFilterBar.xul">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/quickFilterBar.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/search.xml">mail/base/content/search.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/search.xml">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/search.xml">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/search.xml">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/search.xml">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/search.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/searchBar.js">mail/base/content/searchBar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/searchBar.js">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/searchBar.js">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/searchBar.js">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/searchBar.js">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/searchBar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/tabmail.xml">mail/base/content/tabmail.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/tabmail.xml">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/tabmail.xml">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/tabmail.xml">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/tabmail.xml">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/content/tabmail.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/jar.mn">mail/base/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/jar.mn">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/jar.mn">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/jar.mn">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/jar.mn">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/modules/Makefile.in">mail/base/modules/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/modules/Makefile.in">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/modules/Makefile.in">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/modules/Makefile.in">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/modules/Makefile.in">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/modules/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/modules/dbViewWrapper.js">mail/base/modules/dbViewWrapper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/modules/dbViewWrapper.js">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/modules/dbViewWrapper.js">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/modules/dbViewWrapper.js">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/modules/dbViewWrapper.js">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/modules/dbViewWrapper.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/modules/quickFilterManager.js">mail/base/modules/quickFilterManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/modules/quickFilterManager.js">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/modules/quickFilterManager.js">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/modules/quickFilterManager.js">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/modules/quickFilterManager.js">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/modules/quickFilterManager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/modules/quickSearchManager.js">mail/base/modules/quickSearchManager.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/modules/quickSearchManager.js">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/modules/quickSearchManager.js">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/modules/quickSearchManager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/modules/searchSpec.js">mail/base/modules/searchSpec.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/modules/searchSpec.js">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/modules/searchSpec.js">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/modules/searchSpec.js">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/modules/searchSpec.js">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/modules/searchSpec.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/test/unit/resources/viewWrapperTestUtils.js">mail/base/test/unit/resources/viewWrapperTestUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/test/unit/resources/viewWrapperTestUtils.js">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/test/unit/resources/viewWrapperTestUtils.js">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/test/unit/resources/viewWrapperTestUtils.js">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/test/unit/resources/viewWrapperTestUtils.js">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/test/unit/resources/viewWrapperTestUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/test/unit/test_viewWrapper_realFolder.js">mail/base/test/unit/test_viewWrapper_realFolder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/test/unit/test_viewWrapper_realFolder.js">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/test/unit/test_viewWrapper_realFolder.js">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/test/unit/test_viewWrapper_realFolder.js">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/test/unit/test_viewWrapper_realFolder.js">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/test/unit/test_viewWrapper_realFolder.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/test/unit/test_viewWrapper_virtualFolder.js">mail/base/test/unit/test_viewWrapper_virtualFolder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/test/unit/test_viewWrapper_virtualFolder.js">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/test/unit/test_viewWrapper_virtualFolder.js">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/test/unit/test_viewWrapper_virtualFolder.js">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/test/unit/test_viewWrapper_virtualFolder.js">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/base/test/unit/test_viewWrapper_virtualFolder.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/installer/removed-files.in">mail/installer/removed-files.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/installer/removed-files.in">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/installer/removed-files.in">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/installer/removed-files.in">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/installer/removed-files.in">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/installer/removed-files.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/locales/en-US/chrome/messenger/messenger.dtd">mail/locales/en-US/chrome/messenger/messenger.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/locales/en-US/chrome/messenger/messenger.dtd">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/locales/en-US/chrome/messenger/messenger.dtd">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/locales/en-US/chrome/messenger/messenger.dtd">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/locales/en-US/chrome/messenger/messenger.dtd">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/locales/en-US/chrome/messenger/messenger.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/locales/en-US/chrome/messenger/quickFilterBar.dtd">mail/locales/en-US/chrome/messenger/quickFilterBar.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/locales/en-US/chrome/messenger/quickFilterBar.dtd">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/locales/en-US/chrome/messenger/quickFilterBar.dtd">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/locales/en-US/chrome/messenger/quickFilterBar.dtd">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/locales/en-US/chrome/messenger/quickFilterBar.dtd">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/locales/en-US/chrome/messenger/quickFilterBar.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/locales/en-US/chrome/messenger/quickSearch.properties">mail/locales/en-US/chrome/messenger/quickSearch.properties</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/locales/en-US/chrome/messenger/quickSearch.properties">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/locales/en-US/chrome/messenger/quickSearch.properties">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/locales/en-US/chrome/messenger/quickSearch.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/locales/jar.mn">mail/locales/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/locales/jar.mn">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/locales/jar.mn">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/locales/jar.mn">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/locales/jar.mn">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/locales/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/folder-display/test-quick-search.js">mail/test/mozmill/folder-display/test-quick-search.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/folder-display/test-quick-search.js">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/folder-display/test-quick-search.js">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/folder-display/test-quick-search.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/mozmilltests.list">mail/test/mozmill/mozmilltests.list</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/mozmilltests.list">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/mozmilltests.list">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/mozmilltests.list">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/mozmilltests.list">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/mozmilltests.list">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/quick-filter-bar/test-display-issues.js">mail/test/mozmill/quick-filter-bar/test-display-issues.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/quick-filter-bar/test-display-issues.js">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/quick-filter-bar/test-display-issues.js">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/quick-filter-bar/test-display-issues.js">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/quick-filter-bar/test-display-issues.js">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/quick-filter-bar/test-display-issues.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/quick-filter-bar/test-filter-logic.js">mail/test/mozmill/quick-filter-bar/test-filter-logic.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/quick-filter-bar/test-filter-logic.js">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/quick-filter-bar/test-filter-logic.js">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/quick-filter-bar/test-filter-logic.js">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/quick-filter-bar/test-filter-logic.js">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/quick-filter-bar/test-filter-logic.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/quick-filter-bar/test-keyboard-interface.js">mail/test/mozmill/quick-filter-bar/test-keyboard-interface.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/quick-filter-bar/test-keyboard-interface.js">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/quick-filter-bar/test-keyboard-interface.js">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/quick-filter-bar/test-keyboard-interface.js">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/quick-filter-bar/test-keyboard-interface.js">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/quick-filter-bar/test-keyboard-interface.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/quick-filter-bar/test-sticky-filter-logic.js">mail/test/mozmill/quick-filter-bar/test-sticky-filter-logic.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/quick-filter-bar/test-sticky-filter-logic.js">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/quick-filter-bar/test-sticky-filter-logic.js">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/quick-filter-bar/test-sticky-filter-logic.js">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/quick-filter-bar/test-sticky-filter-logic.js">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/quick-filter-bar/test-sticky-filter-logic.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/quick-filter-bar/test-toggle-bar.js">mail/test/mozmill/quick-filter-bar/test-toggle-bar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/quick-filter-bar/test-toggle-bar.js">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/quick-filter-bar/test-toggle-bar.js">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/quick-filter-bar/test-toggle-bar.js">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/quick-filter-bar/test-toggle-bar.js">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/quick-filter-bar/test-toggle-bar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">mail/test/mozmill/shared-modules/test-folder-display-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/shared-modules/test-quick-filter-bar-helper.js">mail/test/mozmill/shared-modules/test-quick-filter-bar-helper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/shared-modules/test-quick-filter-bar-helper.js">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/shared-modules/test-quick-filter-bar-helper.js">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/shared-modules/test-quick-filter-bar-helper.js">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/shared-modules/test-quick-filter-bar-helper.js">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/shared-modules/test-quick-filter-bar-helper.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/shared-modules/test-window-helpers.js">mail/test/mozmill/shared-modules/test-window-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/shared-modules/test-window-helpers.js">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/shared-modules/test-window-helpers.js">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/shared-modules/test-window-helpers.js">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/shared-modules/test-window-helpers.js">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/test/mozmill/shared-modules/test-window-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/jar.mn">mail/themes/gnomestripe/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/jar.mn">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/jar.mn">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/jar.mn">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/jar.mn">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/icons/black_pin.png">mail/themes/gnomestripe/mail/icons/black_pin.png</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/icons/black_pin.png">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/icons/black_pin.png">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/icons/black_pin.png">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/icons/black_pin.png">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/icons/black_pin.png">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/icons/filter.png">mail/themes/gnomestripe/mail/icons/filter.png</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/icons/filter.png">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/icons/filter.png">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/icons/filter.png">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/icons/filter.png">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/icons/filter.png">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/icons/filterbar.png">mail/themes/gnomestripe/mail/icons/filterbar.png</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/icons/filterbar.png">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/icons/filterbar.png">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/icons/filterbar.png">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/icons/filterbar.png">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/icons/filterbar.png">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/icons/red_pin.png">mail/themes/gnomestripe/mail/icons/red_pin.png</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/icons/red_pin.png">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/icons/red_pin.png">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/icons/red_pin.png">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/icons/red_pin.png">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/icons/red_pin.png">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/quickFilterBar.css">mail/themes/gnomestripe/mail/quickFilterBar.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/quickFilterBar.css">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/quickFilterBar.css">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/quickFilterBar.css">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/quickFilterBar.css">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/quickFilterBar.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/searchBox.css">mail/themes/gnomestripe/mail/searchBox.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/searchBox.css">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/searchBox.css">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/searchBox.css">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/searchBox.css">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/gnomestripe/mail/searchBox.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/jar.mn">mail/themes/pinstripe/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/jar.mn">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/jar.mn">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/jar.mn">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/jar.mn">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/mail/icons/black_pin.png">mail/themes/pinstripe/mail/icons/black_pin.png</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/mail/icons/black_pin.png">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/mail/icons/black_pin.png">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/mail/icons/black_pin.png">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/mail/icons/black_pin.png">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/mail/icons/black_pin.png">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/mail/icons/filter.png">mail/themes/pinstripe/mail/icons/filter.png</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/mail/icons/filter.png">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/mail/icons/filter.png">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/mail/icons/filter.png">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/mail/icons/filter.png">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/mail/icons/filter.png">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/mail/icons/red_pin.png">mail/themes/pinstripe/mail/icons/red_pin.png</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/mail/icons/red_pin.png">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/mail/icons/red_pin.png">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/mail/icons/red_pin.png">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/mail/icons/red_pin.png">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/mail/icons/red_pin.png">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/mail/icons/tag1616.png">mail/themes/pinstripe/mail/icons/tag1616.png</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/mail/icons/tag1616.png">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/mail/icons/tag1616.png">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/mail/icons/tag1616.png">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/mail/icons/tag1616.png">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/mail/icons/tag1616.png">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/mail/quickFilterBar.css">mail/themes/pinstripe/mail/quickFilterBar.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/mail/quickFilterBar.css">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/mail/quickFilterBar.css">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/mail/quickFilterBar.css">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/mail/quickFilterBar.css">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/pinstripe/mail/quickFilterBar.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/qute/jar.mn">mail/themes/qute/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/qute/jar.mn">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/qute/jar.mn">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/qute/jar.mn">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/qute/jar.mn">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/qute/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/qute/mail/icons/filter.png">mail/themes/qute/mail/icons/filter.png</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/qute/mail/icons/filter.png">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/qute/mail/icons/filter.png">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/qute/mail/icons/filter.png">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/qute/mail/icons/filter.png">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/qute/mail/icons/filter.png">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/qute/mail/icons/xp-pin-grey.png">mail/themes/qute/mail/icons/xp-pin-grey.png</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/qute/mail/icons/xp-pin-grey.png">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/qute/mail/icons/xp-pin-grey.png">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/qute/mail/icons/xp-pin-grey.png">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/qute/mail/icons/xp-pin-grey.png">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/qute/mail/icons/xp-pin-grey.png">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/qute/mail/icons/xp-pin-red.png">mail/themes/qute/mail/icons/xp-pin-red.png</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/qute/mail/icons/xp-pin-red.png">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/qute/mail/icons/xp-pin-red.png">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/qute/mail/icons/xp-pin-red.png">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/qute/mail/icons/xp-pin-red.png">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/qute/mail/icons/xp-pin-red.png">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/qute/mail/quickFilterBar.css">mail/themes/qute/mail/quickFilterBar.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/qute/mail/quickFilterBar.css">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/qute/mail/quickFilterBar.css">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/qute/mail/quickFilterBar.css">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/qute/mail/quickFilterBar.css">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mail/themes/qute/mail/quickFilterBar.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/public/nsIMsgDBView.idl">mailnews/base/public/nsIMsgDBView.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/public/nsIMsgDBView.idl">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/public/nsIMsgDBView.idl">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/public/nsIMsgDBView.idl">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/public/nsIMsgDBView.idl">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/public/nsIMsgDBView.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/search/public/nsIMsgSearchSession.idl">mailnews/base/search/public/nsIMsgSearchSession.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/search/public/nsIMsgSearchSession.idl">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/search/public/nsIMsgSearchSession.idl">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/search/public/nsIMsgSearchSession.idl">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/search/public/nsIMsgSearchSession.idl">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/search/public/nsIMsgSearchSession.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/search/src/nsMsgFilterService.cpp">mailnews/base/search/src/nsMsgFilterService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/search/src/nsMsgFilterService.cpp">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/search/src/nsMsgFilterService.cpp">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/search/src/nsMsgFilterService.cpp">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/search/src/nsMsgFilterService.cpp">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/search/src/nsMsgFilterService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/search/src/nsMsgSearchSession.cpp">mailnews/base/search/src/nsMsgSearchSession.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/search/src/nsMsgSearchSession.cpp">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/search/src/nsMsgSearchSession.cpp">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/search/src/nsMsgSearchSession.cpp">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/search/src/nsMsgSearchSession.cpp">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/search/src/nsMsgSearchSession.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/search/src/nsMsgSearchSession.h">mailnews/base/search/src/nsMsgSearchSession.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/search/src/nsMsgSearchSession.h">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/search/src/nsMsgSearchSession.h">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/search/src/nsMsgSearchSession.h">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/search/src/nsMsgSearchSession.h">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/search/src/nsMsgSearchSession.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgDBView.cpp">mailnews/base/src/nsMsgDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgDBView.cpp">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgDBView.cpp">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgDBView.cpp">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgDBView.cpp">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgPurgeService.cpp">mailnews/base/src/nsMsgPurgeService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgPurgeService.cpp">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgPurgeService.cpp">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgPurgeService.cpp">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgPurgeService.cpp">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgPurgeService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgQuickSearchDBView.cpp">mailnews/base/src/nsMsgQuickSearchDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgQuickSearchDBView.cpp">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgQuickSearchDBView.cpp">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgQuickSearchDBView.cpp">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgQuickSearchDBView.cpp">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgQuickSearchDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgQuickSearchDBView.h">mailnews/base/src/nsMsgQuickSearchDBView.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgQuickSearchDBView.h">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgQuickSearchDBView.h">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgQuickSearchDBView.h">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgQuickSearchDBView.h">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgQuickSearchDBView.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgSearchDBView.cpp">mailnews/base/src/nsMsgSearchDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgSearchDBView.cpp">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgSearchDBView.cpp">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgSearchDBView.cpp">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgSearchDBView.cpp">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgSearchDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgSearchDBView.h">mailnews/base/src/nsMsgSearchDBView.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgSearchDBView.h">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgSearchDBView.h">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgSearchDBView.h">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgSearchDBView.h">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgSearchDBView.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgSpecialViews.cpp">mailnews/base/src/nsMsgSpecialViews.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgSpecialViews.cpp">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgSpecialViews.cpp">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgSpecialViews.cpp">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgSpecialViews.cpp">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgSpecialViews.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgSpecialViews.h">mailnews/base/src/nsMsgSpecialViews.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgSpecialViews.h">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgSpecialViews.h">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgSpecialViews.h">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgSpecialViews.h">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/src/nsMsgSpecialViews.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/util/errUtils.js">mailnews/base/util/errUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/util/errUtils.js">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/util/errUtils.js">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/util/errUtils.js">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/util/errUtils.js">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/base/util/errUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/db/gloda/components/glautocomp.js">mailnews/db/gloda/components/glautocomp.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/db/gloda/components/glautocomp.js">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/db/gloda/components/glautocomp.js">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/db/gloda/components/glautocomp.js">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/db/gloda/components/glautocomp.js">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/db/gloda/components/glautocomp.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/news/src/nsNewsDownloader.cpp">mailnews/news/src/nsNewsDownloader.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/news/src/nsNewsDownloader.cpp">file</a> |
<a href="/comm-central/annotate/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/news/src/nsNewsDownloader.cpp">annotate</a> |
<a href="/comm-central/diff/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/news/src/nsNewsDownloader.cpp">diff</a> |
<a href="/comm-central/comparison/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/news/src/nsNewsDownloader.cpp">comparison</a> |
<a href="/comm-central/log/1e333d47863da0324273d7bc97e8f62ad7bf1455/mailnews/news/src/nsNewsDownloader.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/extraCustomizeItems.xul</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/extraCustomizeItems.xul</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -34,16 +34,18 @@</span>
<a href="#l1.4"></a><span id="l1.4">  - use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l1.5"></a><span id="l1.5">  - and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l1.6"></a><span id="l1.6">  - the provisions above, a recipient may use your version of this file under</span>
<a href="#l1.7"></a><span id="l1.7">  - the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l1.8"></a><span id="l1.8">  -</span>
<a href="#l1.9"></a><span id="l1.9">  - ***** END LICENSE BLOCK *****</span>
<a href="#l1.10"></a><span id="l1.10">  --&gt;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://global/skin/textbox.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+</span>
<a href="#l1.14"></a><span id="l1.14"> &lt;!DOCTYPE overlay [</span>
<a href="#l1.15"></a><span id="l1.15">   &lt;!ENTITY % messengerDTD SYSTEM &quot;chrome://messenger/locale/messenger.dtd&quot;&gt;</span>
<a href="#l1.16"></a><span id="l1.16">   %messengerDTD;</span>
<a href="#l1.17"></a><span id="l1.17">   &lt;!ENTITY % msgViewPickerDTD SYSTEM &quot;chrome://messenger/locale/msgViewPickerOverlay.dtd&quot; &gt;</span>
<a href="#l1.18"></a><span id="l1.18">   %msgViewPickerDTD;</span>
<a href="#l1.19"></a><span id="l1.19">   &lt;!ENTITY % msgFolderPickerDTD SYSTEM &quot;chrome://messenger/locale/msgFolderPickerOverlay.dtd&quot; &gt;</span>
<a href="#l1.20"></a><span id="l1.20">   %msgFolderPickerDTD;</span>
<a href="#l1.21"></a><span id="l1.21">   &lt;!ENTITY % brandDTD SYSTEM &quot;chrome://branding/locale/brand.dtd&quot;&gt;</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -61,22 +63,39 @@</span>
<a href="#l1.23"></a><span id="l1.23">     &lt;!-- gloda search widget; provides global (message) searching.  --&gt;</span>
<a href="#l1.24"></a><span id="l1.24">     &lt;toolbaritem id=&quot;gloda-search&quot; insertafter=&quot;button-stop&quot;</span>
<a href="#l1.25"></a><span id="l1.25">                  title=&quot;&amp;glodaSearch.title;&quot;</span>
<a href="#l1.26"></a><span id="l1.26">                  align=&quot;center&quot;</span>
<a href="#l1.27"></a><span id="l1.27">                  flex=&quot;1&quot;</span>
<a href="#l1.28"></a><span id="l1.28">                  class=&quot;chromeclass-toolbar-additional&quot;&gt;</span>
<a href="#l1.29"></a><span id="l1.29">         &lt;textbox id=&quot;searchInput&quot; </span>
<a href="#l1.30"></a><span id="l1.30">                  flex=&quot;1&quot;</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-                 searchCriteria=&quot;true&quot;</span>
<a href="#l1.32"></a><span id="l1.32">                  type=&quot;glodacomplete&quot;</span>
<a href="#l1.33"></a><span id="l1.33">                  searchbutton=&quot;true&quot;</span>
<a href="#l1.34"></a><span id="l1.34">                  autocompletesearch=&quot;gloda&quot;</span>
<a href="#l1.35"></a><span id="l1.35">                  autocompletepopup=&quot;PopupGlodaAutocomplete&quot;</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+                 autocompletesearchparam=&quot;global&quot;</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+                 enablehistory=&quot;false&quot;</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+                 timeout=&quot;200&quot;</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+                 emptytext=&quot;&quot;</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+                 emptytextbase=&quot;&amp;searchAllMessages.label.base;&quot;</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+                 keyLabelNonMac=&quot;&amp;searchAllMessages.keyLabel.nonmac;&quot;</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+                 keyLabelMac=&quot;&amp;searchAllMessages.keyLabel.mac;&quot;</span>
<a href="#l1.43"></a><span id="l1.43">                  &gt;</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+          &lt;!-- Mimic the search/clear buttons of the standard search textbox,</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+               but adjust for the reality that clear doesn't make much sense</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+               since gloda results only show in a tab and the idiom for closing</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+               tabs is closing the tab.  Our binding does process escape to</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+               clear the box, if people want to clear it that way...</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+               --&gt;</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+          &lt;hbox&gt;</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+            &lt;image class=&quot;textbox-search-icon&quot;</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+                   onclick=&quot;document.getElementById('searchInput').doSearch();&quot;</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+                   /&gt;</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+          &lt;/hbox&gt;</span>
<a href="#l1.55"></a><span id="l1.55">         &lt;/textbox&gt;</span>
<a href="#l1.56"></a><span id="l1.56">     &lt;/toolbaritem&gt;</span>
<a href="#l1.57"></a><span id="l1.57"> </span>
<a href="#l1.58"></a><span id="l1.58">     &lt;toolbarbutton id=&quot;button-compact&quot; class=&quot;toolbarbutton-1&quot;</span>
<a href="#l1.59"></a><span id="l1.59">                    insertafter=&quot;button-mark&quot;</span>
<a href="#l1.60"></a><span id="l1.60">                    label=&quot;&amp;compactButton.label;&quot;</span>
<a href="#l1.61"></a><span id="l1.61">                    tooltiptext=&quot;&amp;compactButton.tooltip;&quot;</span>
<a href="#l1.62"></a><span id="l1.62">                    oncommand=&quot;goDoCommand('button_compact');&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/folderDisplay.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/folderDisplay.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -41,16 +41,79 @@ Components.utils.import(&quot;resource:///mod</span>
<a href="#l2.4"></a><span id="l2.4"> Components.utils.import(&quot;resource:///modules/jsTreeSelection.js&quot;);</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6"> var gFolderDisplay = null;</span>
<a href="#l2.7"></a><span id="l2.7"> var gMessageDisplay = null;</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> var nsMsgFolderFlags = Components.interfaces.nsMsgFolderFlags;</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11"> /**</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+ * Maintains a list of listeners for all FolderDisplayWidget instances in this</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+ *  window.  The assumption is that because of our multiplexed tab</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+ *  implementation all consumers are effectively going to care about all such</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+ *  tabs.</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+ *</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+ * We are not just a global list so that we can add brains about efficiently</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+ *  building lists, provide try-wrapper convenience, etc.</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+ */</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+let FolderDisplayListenerManager = {</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+  _listeners: [],</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+  /**</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+   * Register a listener that implements one or more of the methods defined on</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+   *  |IDBViewWrapperListener|.  Note that a change from those interface</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+   *  signatures is that the first argument is always a reference to the</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+   *  FolderDisplayWidget generating the notification.</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+   *</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+   * We additionally support the following notifications:</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+   * - onMakeActive.  Invoked when makeActive is called on the</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+   *   FolderDisplayWidget.  The second argument (after the folder display) is</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+   *   aWasInactive.</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+   *</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+   * - onActiveCreatedView.  onCreatedView deferred to when the tab is actually</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+   *   made active.</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+   *</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+   * - onActiveAllMessagesLoaded.  onAllMessagesLoaded deferred to when the</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+   *   tab is actually made active.  Use this if the actions you need to take</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+   *   are based on the folder display actually being visible, such as updating</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+   *   some UI widget, etc.</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+   *</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+   */</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+  registerListener: function FDLM_registerListener(aListener) {</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+    this._listeners.push(aListener);</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+  },</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+  /**</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+   * Unregister a previously registered event listener.</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+   */</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+  unregisterListener: function FDLM_unregisterListener(aListener) {</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+    let idx = this._listeners.indexOf(idx);</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+    if (idx &gt;= 0) {</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+      this._listeners.splice(idx, 1);</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+    }</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+  },</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+  /**</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+   * For use by FolderDisplayWidget to trigger listener invocation.</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+   */</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+  _fireListeners: function FDBLM__fireListeners(aEventName, aArgs) {</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+    for each (let [, listener] in Iterator(this._listeners)) {</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+      if (aEventName in listener) {</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+        try {</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+          listener[aEventName].apply(listener, aArgs);</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+        }</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+        catch(ex) {</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+          Components.utils.reportError(ex);</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+        }</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+      }</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+    }</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+  },</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+};</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+/**</span>
<a href="#l2.75"></a><span id="l2.75">  * Abstraction for a widget that (roughly speaking) displays the contents of</span>
<a href="#l2.76"></a><span id="l2.76">  *  folders.  The widget belongs to a tab and has a lifetime as long as the tab</span>
<a href="#l2.77"></a><span id="l2.77">  *  that contains it.  This class is strictly concerned with the UI aspects of</span>
<a href="#l2.78"></a><span id="l2.78">  *  this; the DBViewWrapper class handles the view details (and is exposed on</span>
<a href="#l2.79"></a><span id="l2.79">  *  the 'view' attribute.)</span>
<a href="#l2.80"></a><span id="l2.80">  *</span>
<a href="#l2.81"></a><span id="l2.81">  * The search window subclasses this into the SearchFolderDisplayWidget rather</span>
<a href="#l2.82"></a><span id="l2.82">  *  than us attempting to generalize everything excessively.  This is because</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineat">@@ -774,58 +837,71 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l2.84"></a><span id="l2.84">    *  nice to the future. Loading a folder is a blocking operation that is going</span>
<a href="#l2.85"></a><span id="l2.85">    *  to make us unresponsive and accordingly make it very hard for the user to</span>
<a href="#l2.86"></a><span id="l2.86">    *  change tabs.</span>
<a href="#l2.87"></a><span id="l2.87">    */</span>
<a href="#l2.88"></a><span id="l2.88">   onFolderLoading: function(aFolderLoading) {</span>
<a href="#l2.89"></a><span id="l2.89">     if (this._tabInfo)</span>
<a href="#l2.90"></a><span id="l2.90">       document.getElementById(&quot;tabmail&quot;).setTabBusy(this._tabInfo,</span>
<a href="#l2.91"></a><span id="l2.91">                                                     aFolderLoading);</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+    FolderDisplayListenerManager._fireListeners(&quot;onFolderLoading&quot;,</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+                                                [this, aFolderLoading]);</span>
<a href="#l2.95"></a><span id="l2.95">   },</span>
<a href="#l2.96"></a><span id="l2.96"> </span>
<a href="#l2.97"></a><span id="l2.97">   /**</span>
<a href="#l2.98"></a><span id="l2.98">    * The view wrapper tells us when a search is active, and we mark the tab as</span>
<a href="#l2.99"></a><span id="l2.99">    *  thinking so the user knows something is happening.  'Searching' in this</span>
<a href="#l2.100"></a><span id="l2.100">    *  case is more than just a user-initiated search.  Virtual folders / saved</span>
<a href="#l2.101"></a><span id="l2.101">    *  searches, mail views, plus the more obvious quick search are all based off</span>
<a href="#l2.102"></a><span id="l2.102">    *  of searches and we will receive a notification for them.</span>
<a href="#l2.103"></a><span id="l2.103">    */</span>
<a href="#l2.104"></a><span id="l2.104">   onSearching: function(aIsSearching) {</span>
<a href="#l2.105"></a><span id="l2.105">     if (this._tabInfo) {</span>
<a href="#l2.106"></a><span id="l2.106">       let searchBundle = document.getElementById(&quot;bundle_search&quot;);</span>
<a href="#l2.107"></a><span id="l2.107">       document.getElementById(&quot;tabmail&quot;).setTabThinking(</span>
<a href="#l2.108"></a><span id="l2.108">         this._tabInfo,</span>
<a href="#l2.109"></a><span id="l2.109">         aIsSearching &amp;&amp; searchBundle.getString(&quot;searchingMessage&quot;));</span>
<a href="#l2.110"></a><span id="l2.110">     }</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+    FolderDisplayListenerManager._fireListeners(&quot;onSearching&quot;,</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+                                                [this, aIsSearching]);</span>
<a href="#l2.114"></a><span id="l2.114">   },</span>
<a href="#l2.115"></a><span id="l2.115"> </span>
<a href="#l2.116"></a><span id="l2.116">   /**</span>
<a href="#l2.117"></a><span id="l2.117">    * Things we do on creating a view:</span>
<a href="#l2.118"></a><span id="l2.118">    * - notify the observer service so that custom column handler providers can</span>
<a href="#l2.119"></a><span id="l2.119">    *   add their custom columns to our view.</span>
<a href="#l2.120"></a><span id="l2.120">    */</span>
<a href="#l2.121"></a><span id="l2.121">   onCreatedView: function FolderDisplayWidget_onCreatedView() {</span>
<a href="#l2.122"></a><span id="l2.122">     // All of our messages are not displayed if the view was just created.  We</span>
<a href="#l2.123"></a><span id="l2.123">     //  will get an onAllMessagesLoaded nearly immediately if this is a local</span>
<a href="#l2.124"></a><span id="l2.124">     //  folder where view creation is synonymous with having all messages.</span>
<a href="#l2.125"></a><span id="l2.125">     this._allMessagesLoaded = false;</span>
<a href="#l2.126"></a><span id="l2.126">     this.messageDisplay.onCreatedView();</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+    FolderDisplayListenerManager._fireListeners(&quot;onCreatedView&quot;,</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+                                                [this]);</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+</span>
<a href="#l2.131"></a><span id="l2.131">     this._notifyWhenActive(this._activeCreatedView);</span>
<a href="#l2.132"></a><span id="l2.132">   },</span>
<a href="#l2.133"></a><span id="l2.133">   _activeCreatedView: function() {</span>
<a href="#l2.134"></a><span id="l2.134">     gDBView = this.view.dbView;</span>
<a href="#l2.135"></a><span id="l2.135"> </span>
<a href="#l2.136"></a><span id="l2.136">     // A change in view may result in changes to sorts, the view menu, etc.</span>
<a href="#l2.137"></a><span id="l2.137">     // Do this before we 'reroot' the dbview.</span>
<a href="#l2.138"></a><span id="l2.138">     this._updateThreadDisplay();</span>
<a href="#l2.139"></a><span id="l2.139"> </span>
<a href="#l2.140"></a><span id="l2.140">     // this creates a new selection object for the view.</span>
<a href="#l2.141"></a><span id="l2.141">     if (this.treeBox)</span>
<a href="#l2.142"></a><span id="l2.142">       this.treeBox.view = this.view.dbView;</span>
<a href="#l2.143"></a><span id="l2.143"> </span>
<a href="#l2.144"></a><span id="l2.144" class="difflineplus">+    FolderDisplayListenerManager._fireListeners(&quot;onActiveCreatedView&quot;,</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineplus">+                                                [this]);</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineplus">+</span>
<a href="#l2.147"></a><span id="l2.147">     let ObserverService =</span>
<a href="#l2.148"></a><span id="l2.148">       Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l2.149"></a><span id="l2.149">                 .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l2.150"></a><span id="l2.150">     // The data payload used to be viewType + &quot;:&quot; + viewFlags.  We no longer</span>
<a href="#l2.151"></a><span id="l2.151">     //  do this because we already have the implied contract that gDBView is</span>
<a href="#l2.152"></a><span id="l2.152">     //  valid at the time we generate the notification.  In such a case, you</span>
<a href="#l2.153"></a><span id="l2.153">     //  can easily get that information from the gDBView.  (The documentation</span>
<a href="#l2.154"></a><span id="l2.154">     //  on creating a custom column assumes gDBView.)</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineat">@@ -845,16 +921,19 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l2.156"></a><span id="l2.156">       // any selections</span>
<a href="#l2.157"></a><span id="l2.157">       if (aFolderIsComingBack &amp;&amp; !this._aboutToSelectMessage)</span>
<a href="#l2.158"></a><span id="l2.158">         this._saveSelection();</span>
<a href="#l2.159"></a><span id="l2.159">       else</span>
<a href="#l2.160"></a><span id="l2.160">         this._clearSavedSelection();</span>
<a href="#l2.161"></a><span id="l2.161">       gDBView = null;</span>
<a href="#l2.162"></a><span id="l2.162">     }</span>
<a href="#l2.163"></a><span id="l2.163"> </span>
<a href="#l2.164"></a><span id="l2.164" class="difflineplus">+    FolderDisplayListenerManager._fireListeners(&quot;onDestroyingView&quot;,</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+                                                [this, aFolderIsComingBack]);</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineplus">+</span>
<a href="#l2.167"></a><span id="l2.167">     // if we have no view, no messages could be loaded.</span>
<a href="#l2.168"></a><span id="l2.168">     this._allMessagesLoaded = false;</span>
<a href="#l2.169"></a><span id="l2.169"> </span>
<a href="#l2.170"></a><span id="l2.170">     // but the actual tree view selection (based on view indicies) is a goner no</span>
<a href="#l2.171"></a><span id="l2.171">     //  matter what, make everyone forget.</span>
<a href="#l2.172"></a><span id="l2.172">     this.view.dbView.selection = null;</span>
<a href="#l2.173"></a><span id="l2.173">     this._savedFirstVisibleRow = null;</span>
<a href="#l2.174"></a><span id="l2.174">     this._nextViewIndexAfterDelete = null;</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineat">@@ -874,16 +953,19 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l2.176"></a><span id="l2.176">    * Restore persisted information about what columns to display for the folder.</span>
<a href="#l2.177"></a><span id="l2.177">    *  If we have no persisted information, we leave/set _savedColumnStates null.</span>
<a href="#l2.178"></a><span id="l2.178">    *  The column states will be set to default values in onDisplayingFolder in</span>
<a href="#l2.179"></a><span id="l2.179">    *  that case.</span>
<a href="#l2.180"></a><span id="l2.180">    */</span>
<a href="#l2.181"></a><span id="l2.181">   onLoadingFolder: function FolderDisplayWidget_onLoadingFolder(aDbFolderInfo) {</span>
<a href="#l2.182"></a><span id="l2.182">     this._savedColumnStates =</span>
<a href="#l2.183"></a><span id="l2.183">       this._depersistColumnStatesFromDbFolderInfo(aDbFolderInfo);</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineplus">+</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineplus">+    FolderDisplayListenerManager._fireListeners(&quot;onLoadingFolder&quot;,</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineplus">+                                                [this, aDbFolderInfo]);</span>
<a href="#l2.187"></a><span id="l2.187">   },</span>
<a href="#l2.188"></a><span id="l2.188"> </span>
<a href="#l2.189"></a><span id="l2.189">   /**</span>
<a href="#l2.190"></a><span id="l2.190">    * We are entering the folder for display:</span>
<a href="#l2.191"></a><span id="l2.191">    * - set the header cache size.</span>
<a href="#l2.192"></a><span id="l2.192">    * - Setup the columns if we did not already depersist in |onLoadingFolder|.</span>
<a href="#l2.193"></a><span id="l2.193">    */</span>
<a href="#l2.194"></a><span id="l2.194">   onDisplayingFolder: function FolderDisplayWidget_onDisplayingFolder() {</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineat">@@ -895,31 +977,32 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l2.196"></a><span id="l2.196">     // makeActive will restore the folder state</span>
<a href="#l2.197"></a><span id="l2.197">     if (!this._savedColumnStates) {</span>
<a href="#l2.198"></a><span id="l2.198">       // get the default for this folder</span>
<a href="#l2.199"></a><span id="l2.199">       this._savedColumnStates = this._getDefaultColumnsForCurrentFolder();</span>
<a href="#l2.200"></a><span id="l2.200">       // and save it so it doesn't wiggle if the inbox/prototype changes</span>
<a href="#l2.201"></a><span id="l2.201">       this._persistColumnStates(this._savedColumnStates);</span>
<a href="#l2.202"></a><span id="l2.202">     }</span>
<a href="#l2.203"></a><span id="l2.203"> </span>
<a href="#l2.204"></a><span id="l2.204" class="difflineminus">-    // update the quick-search relative to whether it's incoming/outgoing</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineminus">-    let searchInput = document.getElementById(&quot;searchInput&quot;);</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineminus">-    if (searchInput)</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineminus">-      searchInput.folderChanged(this.view.isOutgoingFolder)</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineplus">+    FolderDisplayListenerManager._fireListeners(&quot;onDisplayingFolder&quot;,</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineplus">+                                                [this]);</span>
<a href="#l2.210"></a><span id="l2.210"> </span>
<a href="#l2.211"></a><span id="l2.211">     if (this.active)</span>
<a href="#l2.212"></a><span id="l2.212">       this.makeActive();</span>
<a href="#l2.213"></a><span id="l2.213">   },</span>
<a href="#l2.214"></a><span id="l2.214"> </span>
<a href="#l2.215"></a><span id="l2.215">   /**</span>
<a href="#l2.216"></a><span id="l2.216">    * Notification from DBViewWrapper that it is closing the folder.  This can</span>
<a href="#l2.217"></a><span id="l2.217">    *  happen for reasons other than our own 'close' method closing the view.</span>
<a href="#l2.218"></a><span id="l2.218">    *  For example, user deletion of the folder or underlying folder closes it.</span>
<a href="#l2.219"></a><span id="l2.219">    */</span>
<a href="#l2.220"></a><span id="l2.220">   onLeavingFolder: function FolderDisplayWidget_onLeavingFolder() {</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineplus">+    FolderDisplayListenerManager._fireListeners(&quot;onLeavingFolder&quot;,</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineplus">+                                                [this]);</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineplus">+</span>
<a href="#l2.224"></a><span id="l2.224">     // Keep the msgWindow's openFolder up-to-date; it powers nsMessenger's</span>
<a href="#l2.225"></a><span id="l2.225">     //  concept of history so that it can bring you back to the actual folder</span>
<a href="#l2.226"></a><span id="l2.226">     //  you were looking at, rather than just the underlying folder.</span>
<a href="#l2.227"></a><span id="l2.227">     if (this._active)</span>
<a href="#l2.228"></a><span id="l2.228">       msgWindow.openFolder = null;</span>
<a href="#l2.229"></a><span id="l2.229">   },</span>
<a href="#l2.230"></a><span id="l2.230"> </span>
<a href="#l2.231"></a><span id="l2.231">   /**</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineat">@@ -937,20 +1020,27 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l2.233"></a><span id="l2.233">    *  shown up.  For a real folder, this happens when the folder is entered.</span>
<a href="#l2.234"></a><span id="l2.234">    *  For a virtual folder, this happens when the search completes.</span>
<a href="#l2.235"></a><span id="l2.235">    *</span>
<a href="#l2.236"></a><span id="l2.236">    * What we do:</span>
<a href="#l2.237"></a><span id="l2.237">    * - Any scrolling required!</span>
<a href="#l2.238"></a><span id="l2.238">    */</span>
<a href="#l2.239"></a><span id="l2.239">   onAllMessagesLoaded: function FolderDisplayWidget_onAllMessagesLoaded() {</span>
<a href="#l2.240"></a><span id="l2.240">     this._allMessagesLoaded = true;</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineplus">+</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+    FolderDisplayListenerManager._fireListeners(&quot;onAllMessagesLoaded&quot;,</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineplus">+                                                [this]);</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineplus">+</span>
<a href="#l2.245"></a><span id="l2.245">     this._notifyWhenActive(this._activeAllMessagesLoaded);</span>
<a href="#l2.246"></a><span id="l2.246">   },</span>
<a href="#l2.247"></a><span id="l2.247">   _activeAllMessagesLoaded:</span>
<a href="#l2.248"></a><span id="l2.248">       function FolderDisplayWidget__activeAllMessagesLoaded() {</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineplus">+    FolderDisplayListenerManager._fireListeners(&quot;onActiveAllMessagesLoaded&quot;,</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineplus">+                                                [this]);</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineplus">+</span>
<a href="#l2.252"></a><span id="l2.252">     // - if a selectMessage's coming up, get out of here</span>
<a href="#l2.253"></a><span id="l2.253">     if (this._aboutToSelectMessage)</span>
<a href="#l2.254"></a><span id="l2.254">       return;</span>
<a href="#l2.255"></a><span id="l2.255"> </span>
<a href="#l2.256"></a><span id="l2.256">     // - restore selection</span>
<a href="#l2.257"></a><span id="l2.257">     // Attempt to restore the selection (if we saved it because the view was</span>
<a href="#l2.258"></a><span id="l2.258">     //  being destroyed or otherwise manipulated in a fashion that the normal</span>
<a href="#l2.259"></a><span id="l2.259">     //  nsTreeSelection would be unable to handle.)</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineat">@@ -1033,25 +1123,31 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l2.261"></a><span id="l2.261">   /**</span>
<a href="#l2.262"></a><span id="l2.262">    * Just the sort or threading was changed, without changing other things.  We</span>
<a href="#l2.263"></a><span id="l2.263">    *  will not get this notification if the view was re-created, for example.</span>
<a href="#l2.264"></a><span id="l2.264">    */</span>
<a href="#l2.265"></a><span id="l2.265">   onSortChanged: function FolderDisplayWidget_onSortChanged() {</span>
<a href="#l2.266"></a><span id="l2.266">     if (this.active)</span>
<a href="#l2.267"></a><span id="l2.267">       UpdateSortIndicators(this.view.primarySortType,</span>
<a href="#l2.268"></a><span id="l2.268">                            this.view.primarySortOrder);</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineplus">+</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineplus">+    FolderDisplayListenerManager._fireListeners(&quot;onSortChanged&quot;,</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineplus">+                                                [this]);</span>
<a href="#l2.272"></a><span id="l2.272">   },</span>
<a href="#l2.273"></a><span id="l2.273"> </span>
<a href="#l2.274"></a><span id="l2.274">   /**</span>
<a href="#l2.275"></a><span id="l2.275">    * Messages (that may have been displayed) have been removed; this may impact</span>
<a href="#l2.276"></a><span id="l2.276">    * our message selection. We might know it's coming; if we do then</span>
<a href="#l2.277"></a><span id="l2.277">    * this._nextViewIndexAfterDelete should know what view index to select next.</span>
<a href="#l2.278"></a><span id="l2.278">    * For the imap mark-as-deleted we won't know beforehand.</span>
<a href="#l2.279"></a><span id="l2.279">    */</span>
<a href="#l2.280"></a><span id="l2.280">   onMessagesRemoved: function FolderDisplayWidget_onMessagesRemoved() {</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineplus">+    FolderDisplayListenerManager._fireListeners(&quot;onMessagesRemoved&quot;,</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineplus">+                                                [this]);</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineplus">+</span>
<a href="#l2.284"></a><span id="l2.284">     // - we saw this coming</span>
<a href="#l2.285"></a><span id="l2.285">     let rowCount = this.view.dbView.rowCount;</span>
<a href="#l2.286"></a><span id="l2.286">     if (!this._massMoveActive &amp;&amp; (this._nextViewIndexAfterDelete != null)) {</span>
<a href="#l2.287"></a><span id="l2.287">       // adjust the index if it is after the last row...</span>
<a href="#l2.288"></a><span id="l2.288">       // (this can happen if the &quot;mail.delete_matches_sort_order&quot; pref is not</span>
<a href="#l2.289"></a><span id="l2.289">       //  set and the message is the last message in the view.)</span>
<a href="#l2.290"></a><span id="l2.290">       if (this._nextViewIndexAfterDelete &gt;= rowCount)</span>
<a href="#l2.291"></a><span id="l2.291">         this._nextViewIndexAfterDelete = rowCount - 1;</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineat">@@ -1103,24 +1199,28 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l2.293"></a><span id="l2.293">   /**</span>
<a href="#l2.294"></a><span id="l2.294">    * Messages were not actually removed, but we were expecting that they would</span>
<a href="#l2.295"></a><span id="l2.295">    *  be.  Clean-up what onMessagesRemoved would have cleaned up, namely the</span>
<a href="#l2.296"></a><span id="l2.296">    *  next view index to select.</span>
<a href="#l2.297"></a><span id="l2.297">    */</span>
<a href="#l2.298"></a><span id="l2.298">   onMessageRemovalFailed:</span>
<a href="#l2.299"></a><span id="l2.299">       function FolderDisplayWidget_onMessageRemovalFailed() {</span>
<a href="#l2.300"></a><span id="l2.300">     this._nextViewIndexAfterDelete = null;</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineplus">+    FolderDisplayListenerManager._fireListeners(&quot;onMessagesRemovalFailed&quot;,</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineplus">+                                                [this]);</span>
<a href="#l2.303"></a><span id="l2.303">   },</span>
<a href="#l2.304"></a><span id="l2.304"> </span>
<a href="#l2.305"></a><span id="l2.305">   /**</span>
<a href="#l2.306"></a><span id="l2.306">    * Update the status bar to reflect our exciting message counts.</span>
<a href="#l2.307"></a><span id="l2.307">    */</span>
<a href="#l2.308"></a><span id="l2.308">   onMessageCountsChanged: function FolderDisplayWidget_onMessageCountsChaned() {</span>
<a href="#l2.309"></a><span id="l2.309">     if (this.active)</span>
<a href="#l2.310"></a><span id="l2.310">       UpdateStatusMessageCounts(this.displayedFolder);</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineplus">+    FolderDisplayListenerManager._fireListeners(&quot;onMessageCountsChanged&quot;,</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineplus">+                                                [this]);</span>
<a href="#l2.313"></a><span id="l2.313">   },</span>
<a href="#l2.314"></a><span id="l2.314">   //@}</span>
<a href="#l2.315"></a><span id="l2.315">   /* ===== End IDBViewWrapperListener ===== */</span>
<a href="#l2.316"></a><span id="l2.316"> </span>
<a href="#l2.317"></a><span id="l2.317">   /*   ==================================   */</span>
<a href="#l2.318"></a><span id="l2.318">   /* ===== nsIMsgDBViewCommandUpdater ===== */</span>
<a href="#l2.319"></a><span id="l2.319">   /*   ==================================   */</span>
<a href="#l2.320"></a><span id="l2.320"> </span>
<a href="#l2.321"></a><span id="l2.321" class="difflineat">@@ -1450,16 +1550,19 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l2.322"></a><span id="l2.322">     this._active = true;</span>
<a href="#l2.323"></a><span id="l2.323">     this._runNotificationsPendingActivation();</span>
<a href="#l2.324"></a><span id="l2.324"> </span>
<a href="#l2.325"></a><span id="l2.325">     // Make sure we get rid of this._fakeTreeSelection, whether we use it below</span>
<a href="#l2.326"></a><span id="l2.326">     // or not.</span>
<a href="#l2.327"></a><span id="l2.327">     let fakeTreeSelection = this._fakeTreeSelection;</span>
<a href="#l2.328"></a><span id="l2.328">     this._fakeTreeSelection = null;</span>
<a href="#l2.329"></a><span id="l2.329"> </span>
<a href="#l2.330"></a><span id="l2.330" class="difflineplus">+    FolderDisplayListenerManager._fireListeners(&quot;onMakeActive&quot;,</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineplus">+                                                [this, aWasInactive]);</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineplus">+</span>
<a href="#l2.333"></a><span id="l2.333">     // -- UI</span>
<a href="#l2.334"></a><span id="l2.334"> </span>
<a href="#l2.335"></a><span id="l2.335">     // We're going to set this to true if we've already caused a</span>
<a href="#l2.336"></a><span id="l2.336">     // selectionChanged event, so that the message display doesn't cause</span>
<a href="#l2.337"></a><span id="l2.337">     // another, or if a select message is coming up shortly.</span>
<a href="#l2.338"></a><span id="l2.338">     let dontReloadMessage = this._aboutToSelectMessage;</span>
<a href="#l2.339"></a><span id="l2.339">     // thread pane if we have a db view</span>
<a href="#l2.340"></a><span id="l2.340">     if (this.view.dbView) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/mailTabs.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/mailTabs.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -115,59 +115,40 @@ let mailTabType = {</span>
<a href="#l3.4"></a><span id="l3.4">         let windowToInheritFrom = null;</span>
<a href="#l3.5"></a><span id="l3.5">         if (window.opener &amp;&amp;</span>
<a href="#l3.6"></a><span id="l3.6">             (window.opener.document.documentElement.getAttribute(&quot;windowtype&quot;) ==</span>
<a href="#l3.7"></a><span id="l3.7">              &quot;mail:3pane&quot;))</span>
<a href="#l3.8"></a><span id="l3.8">           windowToInheritFrom = window.opener;</span>
<a href="#l3.9"></a><span id="l3.9">         else</span>
<a href="#l3.10"></a><span id="l3.10">           windowToInheritFrom = FindOther3PaneWindow();</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-        if (windowToInheritFrom) {</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-          let searchInputToInheritFrom =</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-            windowToInheritFrom.document.getElementById(&quot;searchInput&quot;);</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-          if (searchInputToInheritFrom) {</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-            let searchInput = document.getElementById(&quot;searchInput&quot;);</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-            if (searchInput)</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-              // This should set the aTab.searchMode as well</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-              searchInput.searchMode = searchInputToInheritFrom.searchMode;</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-          }</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-        }</span>
<a href="#l3.22"></a><span id="l3.22">         aTab.folderDisplay.makeActive();</span>
<a href="#l3.23"></a><span id="l3.23">       },</span>
<a href="#l3.24"></a><span id="l3.24">       /**</span>
<a href="#l3.25"></a><span id="l3.25">        * @param aArgs.folder The nsIMsgFolder to display.</span>
<a href="#l3.26"></a><span id="l3.26">        * @param [aArgs.msgHdr] Optional message header to display.</span>
<a href="#l3.27"></a><span id="l3.27">        * @param [aArgs.folderPaneVisible] Whether the folder pane should be</span>
<a href="#l3.28"></a><span id="l3.28">        *            visible. If this isn't specified, the current or first tab's</span>
<a href="#l3.29"></a><span id="l3.29">        *            current state is used.</span>
<a href="#l3.30"></a><span id="l3.30">        * @param [aArgs.messagePaneVisible] Whether the message pane should be</span>
<a href="#l3.31"></a><span id="l3.31">        *            visible. If this isn't specified, the current or first tab's</span>
<a href="#l3.32"></a><span id="l3.32">        *            current state is used.</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-       * @param [aArgs.searchMode] The search mode for this tab. If this isn't</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-       *            specified, the current or first tab's current mode is used.</span>
<a href="#l3.35"></a><span id="l3.35">        * @param [aArgs.forceSelectMessage] Whether we should consider dropping</span>
<a href="#l3.36"></a><span id="l3.36">        *            filters to select the message. This has no effect if</span>
<a href="#l3.37"></a><span id="l3.37">        *            aArgs.msgHdr isn't specified. Defaults to false.</span>
<a href="#l3.38"></a><span id="l3.38">        */</span>
<a href="#l3.39"></a><span id="l3.39">       openTab: function(aTab, aArgs) {</span>
<a href="#l3.40"></a><span id="l3.40">         // persistence and restoreTab wants to know if we are the magic first tab</span>
<a href="#l3.41"></a><span id="l3.41">         aTab.firstTab = false;</span>
<a href="#l3.42"></a><span id="l3.42"> </span>
<a href="#l3.43"></a><span id="l3.43">         // Get a tab that we can initialize our user preferences from.</span>
<a href="#l3.44"></a><span id="l3.44">         // (We don't want to assume that our immediate predecessor was a</span>
<a href="#l3.45"></a><span id="l3.45">         //  &quot;folder&quot; tab.)</span>
<a href="#l3.46"></a><span id="l3.46">         let modelTab = document.getElementById(&quot;tabmail&quot;)</span>
<a href="#l3.47"></a><span id="l3.47">                          .getTabInfoForCurrentOrFirstModeInstance(aTab.mode);</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-        let searchInput = document.getElementById(&quot;searchInput&quot;);</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-        if (&quot;searchMode&quot; in aArgs)</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-          aTab.searchMode = aArgs.searchMode;</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-        else if (searchInput)</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-          aTab.searchMode = searchInput.searchMode;</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-        aTab.searchInputValue = &quot;&quot;;</span>
<a href="#l3.55"></a><span id="l3.55"> </span>
<a href="#l3.56"></a><span id="l3.56">         // - figure out whether to show the folder pane</span>
<a href="#l3.57"></a><span id="l3.57">         let folderPaneShouldBeVisible;</span>
<a href="#l3.58"></a><span id="l3.58">         // explicitly told to us?</span>
<a href="#l3.59"></a><span id="l3.59">         if (&quot;folderPaneVisible&quot; in aArgs)</span>
<a href="#l3.60"></a><span id="l3.60">           folderPaneShouldBeVisible = aArgs.folderPaneVisible;</span>
<a href="#l3.61"></a><span id="l3.61">         // inherit from the previous tab (if we've got one)</span>
<a href="#l3.62"></a><span id="l3.62">         else if (modelTab)</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineat">@@ -233,18 +214,16 @@ let mailTabType = {</span>
<a href="#l3.64"></a><span id="l3.64">           let retval = {</span>
<a href="#l3.65"></a><span id="l3.65">             folderURI: aTab.folderDisplay.displayedFolder.URI,</span>
<a href="#l3.66"></a><span id="l3.66">             // if the folder pane is active, then we need to look at</span>
<a href="#l3.67"></a><span id="l3.67">             // whether the box is collapsed</span>
<a href="#l3.68"></a><span id="l3.68">             folderPaneVisible: aTab.folderDisplay.folderPaneVisible,</span>
<a href="#l3.69"></a><span id="l3.69">             messagePaneVisible: aTab.messageDisplay.visible,</span>
<a href="#l3.70"></a><span id="l3.70">             firstTab: aTab.firstTab</span>
<a href="#l3.71"></a><span id="l3.71">           };</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-          if (&quot;searchMode&quot; in aTab)</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-            retval.searchMode = aTab.searchMode;</span>
<a href="#l3.74"></a><span id="l3.74">           return retval;</span>
<a href="#l3.75"></a><span id="l3.75">         } catch (e) {</span>
<a href="#l3.76"></a><span id="l3.76">           logException(e);</span>
<a href="#l3.77"></a><span id="l3.77">           return null;</span>
<a href="#l3.78"></a><span id="l3.78">         }</span>
<a href="#l3.79"></a><span id="l3.79">       },</span>
<a href="#l3.80"></a><span id="l3.80">       restoreTab: function(aTabmail, aPersistedState) {</span>
<a href="#l3.81"></a><span id="l3.81">       try {</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineat">@@ -277,33 +256,40 @@ let mailTabType = {</span>
<a href="#l3.83"></a><span id="l3.83">               if (!gMessageDisplay._active)</span>
<a href="#l3.84"></a><span id="l3.84">                 gMessageDisplay._visible = aPersistedState.messagePaneVisible;</span>
<a href="#l3.85"></a><span id="l3.85">             }</span>
<a href="#l3.86"></a><span id="l3.86"> </span>
<a href="#l3.87"></a><span id="l3.87">             if (!(&quot;dontRestoreFirstTab&quot; in aPersistedState &amp;&amp;</span>
<a href="#l3.88"></a><span id="l3.88">                   aPersistedState.dontRestoreFirstTab))</span>
<a href="#l3.89"></a><span id="l3.89">               gFolderTreeView.selectFolder(folder);</span>
<a href="#l3.90"></a><span id="l3.90"> </span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-            // This should be after selectFolder, so that onDisplayingFolder</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-            // there doesn't clobber this.</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineminus">-            if (&quot;searchMode&quot; in aPersistedState) {</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineminus">-              let searchInput = document.getElementById(&quot;searchInput&quot;);</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-              if (searchInput)</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-                searchInput.searchMode = aPersistedState.searchMode;</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+            // We need to manually trigger the tab monitor restore trigger</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+            // for this tab.  In theory this should be in tabmail, but the</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+            // special nature of the first tab will last exactly long as this</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+            // implementation right here so it does not particularly matter</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+            // and is a bit more honest, if ugly, to do it here.</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+            let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+            let restoreState = tabmail._restoringTabState;</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+            let tab = tabmail.tabInfo[0];</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+            for each (let [, tabMonitor] in Iterator(tabmail.tabMonitors)) {</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+              if ((&quot;onTabRestored&quot; in tabMonitor) &amp;&amp;</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+                  (tabMonitor.monitorName in restoreState.ext)) {</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+                tabMonitor.onTabRestored(tab,</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+                                         restoreState.ext[tabMonitor.monitorName],</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+                                         true);</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+              }</span>
<a href="#l3.112"></a><span id="l3.112">             }</span>
<a href="#l3.113"></a><span id="l3.113">           }</span>
<a href="#l3.114"></a><span id="l3.114">           else {</span>
<a href="#l3.115"></a><span id="l3.115">             let tabArgs = {</span>
<a href="#l3.116"></a><span id="l3.116">               folder: folder,</span>
<a href="#l3.117"></a><span id="l3.117">               folderPaneVisible: folderPaneVisible,</span>
<a href="#l3.118"></a><span id="l3.118">               messagePaneVisible: aPersistedState.messagePaneVisible,</span>
<a href="#l3.119"></a><span id="l3.119">               background: true</span>
<a href="#l3.120"></a><span id="l3.120">             };</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-            if (&quot;searchMode&quot; in aPersistedState)</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineminus">-              tabArgs.searchMode = aPersistedState.searchMode;</span>
<a href="#l3.123"></a><span id="l3.123">             aTabmail.openTab(&quot;folder&quot;, tabArgs);</span>
<a href="#l3.124"></a><span id="l3.124">           }</span>
<a href="#l3.125"></a><span id="l3.125">         }</span>
<a href="#l3.126"></a><span id="l3.126">       } catch (e) {</span>
<a href="#l3.127"></a><span id="l3.127">         logException(e);</span>
<a href="#l3.128"></a><span id="l3.128">       }</span>
<a href="#l3.129"></a><span id="l3.129">       },</span>
<a href="#l3.130"></a><span id="l3.130">       onTitleChanged: function(aTab, aTabNode) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.xul</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.xul</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1047,17 +1047,17 @@</span>
<a href="#l4.4"></a><span id="l4.4">                       label=&quot;&amp;selectFlaggedCmd.label;&quot;</span>
<a href="#l4.5"></a><span id="l4.5">                       accesskey=&quot;&amp;selectFlaggedCmd.accesskey;&quot;</span>
<a href="#l4.6"></a><span id="l4.6">                       command=&quot;cmd_selectFlagged&quot;/&gt;</span>
<a href="#l4.7"></a><span id="l4.7">           &lt;/menupopup&gt;</span>
<a href="#l4.8"></a><span id="l4.8">         &lt;/menu&gt;</span>
<a href="#l4.9"></a><span id="l4.9">         &lt;menuseparator id=&quot;editMenuAfterSelectSeparator&quot;/&gt;</span>
<a href="#l4.10"></a><span id="l4.10">         &lt;menu id=&quot;menu_find&quot; label=&quot;&amp;findMenu.label;&quot; accesskey=&quot;&amp;findMenu.accesskey;&quot;&gt;</span>
<a href="#l4.11"></a><span id="l4.11">           &lt;menupopup id=&quot;menu_FindPopup&quot;&gt;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-            &lt;menuitem id=&quot;menu_findCmd&quot; label=&quot;&amp;findCmd.label;&quot; key=&quot;key_find&quot; accesskey=&quot;&amp;findCmd.accesskey;&quot; command=&quot;cmd_find&quot;/&gt;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+            &lt;menuitem id=&quot;menu_findCmd&quot; label=&quot;&amp;findCmd.label;&quot; key=&quot;key_findAgain&quot; accesskey=&quot;&amp;findCmd.accesskey;&quot; command=&quot;cmd_find&quot;/&gt;</span>
<a href="#l4.14"></a><span id="l4.14">             &lt;menuitem id=&quot;menu_findAgainCmd&quot; label=&quot;&amp;findAgainCmd.label;&quot; key=&quot;key_findAgain&quot; accesskey=&quot;&amp;findAgainCmd.accesskey;&quot; command=&quot;cmd_findAgain&quot;/&gt;</span>
<a href="#l4.15"></a><span id="l4.15">             &lt;menuseparator id=&quot;editMenuAfterFindSeparator&quot;/&gt;</span>
<a href="#l4.16"></a><span id="l4.16">             &lt;menuitem id=&quot;searchMailCmd&quot; label=&quot;&amp;searchMailCmd.label;&quot;</span>
<a href="#l4.17"></a><span id="l4.17">                       key=&quot;key_searchMail&quot;</span>
<a href="#l4.18"></a><span id="l4.18">                       accesskey=&quot;&amp;searchMailCmd.accesskey;&quot;</span>
<a href="#l4.19"></a><span id="l4.19">                       command=&quot;cmd_search&quot;/&gt;</span>
<a href="#l4.20"></a><span id="l4.20">             &lt;menuitem id=&quot;searchAddressesCmd&quot; label=&quot;&amp;searchAddressesCmd.label;&quot;</span>
<a href="#l4.21"></a><span id="l4.21">                       accesskey=&quot;&amp;searchAddressesCmd.accesskey;&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/base/content/messenger.xul</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/base/content/messenger.xul</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -45,16 +45,17 @@</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5"> &lt;?xul-overlay href=&quot;chrome://communicator/content/utilityOverlay.xul&quot;?&gt;</span>
<a href="#l5.6"></a><span id="l5.6"> &lt;?xul-overlay href=&quot;chrome://messenger/content/msgHdrViewOverlay.xul&quot;?&gt;</span>
<a href="#l5.7"></a><span id="l5.7"> &lt;?xul-overlay href=&quot;chrome://messenger/content/mailWindowOverlay.xul&quot;?&gt;</span>
<a href="#l5.8"></a><span id="l5.8"> &lt;?xul-overlay href=&quot;chrome://messenger/content/extraCustomizeItems.xul&quot;?&gt;</span>
<a href="#l5.9"></a><span id="l5.9"> &lt;?xul-overlay href=&quot;chrome://messenger/content/mailOverlay.xul&quot;?&gt;</span>
<a href="#l5.10"></a><span id="l5.10"> &lt;?xul-overlay href=&quot;chrome://messenger/content/editContactOverlay.xul&quot;?&gt;</span>
<a href="#l5.11"></a><span id="l5.11"> &lt;?xul-overlay href=&quot;chrome://messenger/content/specialTabs.xul&quot;?&gt;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+&lt;?xul-overlay href=&quot;chrome://messenger/content/quickFilterBar.xul&quot;?&gt;</span>
<a href="#l5.13"></a><span id="l5.13"> </span>
<a href="#l5.14"></a><span id="l5.14"> &lt;!DOCTYPE window [</span>
<a href="#l5.15"></a><span id="l5.15"> &lt;!ENTITY % brandDTD SYSTEM &quot;chrome://branding/locale/brand.dtd&quot; &gt;</span>
<a href="#l5.16"></a><span id="l5.16"> %brandDTD;</span>
<a href="#l5.17"></a><span id="l5.17"> &lt;!ENTITY % messengerDTD SYSTEM &quot;chrome://messenger/locale/messenger.dtd&quot; &gt;</span>
<a href="#l5.18"></a><span id="l5.18"> %messengerDTD;</span>
<a href="#l5.19"></a><span id="l5.19"> &lt;!ENTITY % customizeToolbarDTD SYSTEM &quot;chrome://global/locale/customizeToolbar.dtd&quot;&gt;</span>
<a href="#l5.20"></a><span id="l5.20"> %customizeToolbarDTD;</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineat">@@ -236,17 +237,22 @@</span>
<a href="#l5.22"></a><span id="l5.22"> </span>
<a href="#l5.23"></a><span id="l5.23">   &lt;toolbox id=&quot;mail-toolbox&quot; class=&quot;toolbox-top&quot;&gt;</span>
<a href="#l5.24"></a><span id="l5.24">   &lt;/toolbox&gt;</span>
<a href="#l5.25"></a><span id="l5.25">   &lt;!-- XXX This extension point (tabmail-container) is only temporary!</span>
<a href="#l5.26"></a><span id="l5.26">        Horizontal space shouldn't be wasted if it isn't absolutely critical.</span>
<a href="#l5.27"></a><span id="l5.27">        A mechanism for adding sidebar panes will be added in bug 476154. --&gt;</span>
<a href="#l5.28"></a><span id="l5.28">   &lt;hbox id=&quot;tabmail-container&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l5.29"></a><span id="l5.29">     &lt;tabmail id=&quot;tabmail&quot; flex=&quot;1&quot; panelcontainer=&quot;tabpanelcontainer&quot;&gt;</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-      &lt;hbox id=&quot;tabmail-buttons&quot;/&gt;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+      &lt;hbox&gt;</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+        &lt;!-- extensions can put stuff in here --&gt;</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+        &lt;hbox id=&quot;tabmail-buttons&quot;/&gt;</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+        &lt;!-- extensions must not put stuff in here --&gt;</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+        &lt;hbox id=&quot;thunderbird-private-tabmail-buttons&quot;/&gt;</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+      &lt;/hbox&gt;</span>
<a href="#l5.37"></a><span id="l5.37">       &lt;tabpanels id=&quot;tabpanelcontainer&quot; flex=&quot;1&quot; class=&quot;plain&quot; selectedIndex=&quot;0&quot;&gt;</span>
<a href="#l5.38"></a><span id="l5.38">         &lt;!-- mailContent is the container used for the &quot;wide&quot; layout. Normally,</span>
<a href="#l5.39"></a><span id="l5.39">              all it contains is the &quot;messengerBox&quot; box.  However, in &quot;wide&quot; mode</span>
<a href="#l5.40"></a><span id="l5.40">              the message pane and its splitter transplant themselves into the box</span>
<a href="#l5.41"></a><span id="l5.41">              (respectively, messagepanebox and threadpane-splitter).  This gives us</span>
<a href="#l5.42"></a><span id="l5.42">              the folder pane next to the thread view, with the message pane/reader</span>
<a href="#l5.43"></a><span id="l5.43">              beneath both of them. --&gt;</span>
<a href="#l5.44"></a><span id="l5.44">         &lt;box id=&quot;mailContent&quot; orient=&quot;vertical&quot; flex=&quot;1&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -38,22 +38,22 @@</span>
<a href="#l6.4"></a><span id="l6.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l6.5"></a><span id="l6.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l6.6"></a><span id="l6.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l6.7"></a><span id="l6.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l6.8"></a><span id="l6.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l6.9"></a><span id="l6.9">  *</span>
<a href="#l6.10"></a><span id="l6.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/folderUtils.jsm&quot;);</span>
<a href="#l6.13"></a><span id="l6.13"> Components.utils.import(&quot;resource:///modules/activity/activityModules.js&quot;);</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-Components.utils.import(&quot;resource:///modules/errUtils.js&quot;);</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-Components.utils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-Components.utils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l6.17"></a><span id="l6.17"> Components.utils.import(&quot;resource:///modules/jsTreeSelection.js&quot;);</span>
<a href="#l6.18"></a><span id="l6.18"> Components.utils.import(&quot;resource:///modules/MailConsts.js&quot;);</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+Components.utils.import(&quot;resource:///modules/errUtils.js&quot;);</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+Components.utils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l6.21"></a><span id="l6.21"> Components.utils.import(&quot;resource:///modules/mailnewsMigrator.js&quot;);</span>
<a href="#l6.22"></a><span id="l6.22"> Components.utils.import(&quot;resource:///modules/sessionStoreManager.js&quot;);</span>
<a href="#l6.23"></a><span id="l6.23"> </span>
<a href="#l6.24"></a><span id="l6.24"> /* This is where functions related to the 3 pane window are kept */</span>
<a href="#l6.25"></a><span id="l6.25"> </span>
<a href="#l6.26"></a><span id="l6.26"> // from MailNewsTypes.h</span>
<a href="#l6.27"></a><span id="l6.27"> const nsMsgKey_None = 0xFFFFFFFF;</span>
<a href="#l6.28"></a><span id="l6.28"> const nsMsgViewIndex_None = 0xFFFFFFFF;</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineat">@@ -314,17 +314,17 @@ function OnLoadMessenger()</span>
<a href="#l6.30"></a><span id="l6.30">   //  specialTabs.openSpecialTabsOnStartup below.</span>
<a href="#l6.31"></a><span id="l6.31">   let tabmail = document.getElementById('tabmail');</span>
<a href="#l6.32"></a><span id="l6.32">   if (tabmail)</span>
<a href="#l6.33"></a><span id="l6.33">   {</span>
<a href="#l6.34"></a><span id="l6.34">     // mailTabType is defined in mailWindowOverlay.js</span>
<a href="#l6.35"></a><span id="l6.35">     tabmail.registerTabType(mailTabType);</span>
<a href="#l6.36"></a><span id="l6.36">     // glodaFacetTab* in glodaFacetTab.js</span>
<a href="#l6.37"></a><span id="l6.37">     tabmail.registerTabType(glodaFacetTabType);</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-    tabmail.registerTabMonitor(QuickSearchTabMonitor);</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+    tabmail.registerTabMonitor(GlodaSearchBoxTabMonitor);</span>
<a href="#l6.40"></a><span id="l6.40">     tabmail.registerTabMonitor(statusMessageCountsMonitor);</span>
<a href="#l6.41"></a><span id="l6.41">     tabmail.openFirstTab();</span>
<a href="#l6.42"></a><span id="l6.42">   }</span>
<a href="#l6.43"></a><span id="l6.43"> </span>
<a href="#l6.44"></a><span id="l6.44">   // verifyAccounts returns true if the callback won't be called</span>
<a href="#l6.45"></a><span id="l6.45">   // We also don't want the account wizard to open if any sort of account exists</span>
<a href="#l6.46"></a><span id="l6.46">   if (verifyAccounts(LoadPostAccountWizard, false, AutoConfigWizard))</span>
<a href="#l6.47"></a><span id="l6.47">     LoadPostAccountWizard();</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineat">@@ -876,17 +876,21 @@ function ClearMessagePane()</span>
<a href="#l6.49"></a><span id="l6.49"> {</span>
<a href="#l6.50"></a><span id="l6.50">   // hide the message header view AND the message pane...</span>
<a href="#l6.51"></a><span id="l6.51">   HideMessageHeaderPane();</span>
<a href="#l6.52"></a><span id="l6.52">   gMessageNotificationBar.clearMsgNotifications();</span>
<a href="#l6.53"></a><span id="l6.53">   ClearPendingReadTimer();</span>
<a href="#l6.54"></a><span id="l6.54">   try {</span>
<a href="#l6.55"></a><span id="l6.55">     // This can fail because cloning imap URI's can fail if the username</span>
<a href="#l6.56"></a><span id="l6.56">     // has been cleared by docshell/base/nsDefaultURIFixup.cpp.</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-    GetMessagePaneFrame().location.href = &quot;about:blank&quot;;</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+    let messagePane = GetMessagePaneFrame();</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+    // If we don't do this check, no one else does and we do a non-trivial</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+    // amount of work.  So do the check.</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+    if (messagePane.location.href != &quot;about:blank&quot;)</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+      messagePane.location.href = &quot;about:blank&quot;;</span>
<a href="#l6.63"></a><span id="l6.63">   } catch(ex) {</span>
<a href="#l6.64"></a><span id="l6.64">       logException(ex, false, &quot;error clearing message pane&quot;);</span>
<a href="#l6.65"></a><span id="l6.65">   }</span>
<a href="#l6.66"></a><span id="l6.66"> }</span>
<a href="#l6.67"></a><span id="l6.67"> </span>
<a href="#l6.68"></a><span id="l6.68"> /**</span>
<a href="#l6.69"></a><span id="l6.69">  * When right-clicks happen, we do not want to corrupt the underlying</span>
<a href="#l6.70"></a><span id="l6.70">  * selection.  The right-click is a transient selection.  So, unless the</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/mail/base/content/quickFilterBar.css</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,20 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+#qfb-results-label {</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+  text-align: end;</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+  visibility: hidden;</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+}</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+#qfb-filter-bar-spacer {</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+  min-width: 4px !important;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+}</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+.qfb-tag-button[inverted] {</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+  text-decoration: line-through;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+}</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+#quick-filter-bar-main-bar {</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+  overflow: hidden;</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+}</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+#quick-filter-bar-collapsible-buttons[shrink=&quot;true&quot;] toolbarbutton label.toolbarbutton-text {</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+  display: none;</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/mail/base/content/quickFilterBar.js</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,626 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+ *</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+ *</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+ * License.</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+ *</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+ *</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+ * The Initial Developer of the Original Code is the Mozilla Foundation.</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2010</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+ *</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+ * Contributor(s):</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+ *</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+ *</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+Components.utils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+Components.utils.import(&quot;resource:///modules/errUtils.js&quot;);</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+Components.utils.import(&quot;resource:///modules/searchSpec.js&quot;);</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+Components.utils.import(&quot;resource:///modules/quickFilterManager.js&quot;);</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+//// Proper Code</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+/**</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+ * There is only one message filter bar widget; the muxer deals with tab</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+ *  changes and directing modifications to and reflecting the state of the</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+ *  actual filterer objects.</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+ */</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+let QuickFilterBarMuxer = {</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+  _init: function QFBM__init() {</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+    // -- folder display hookup</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+    FolderDisplayListenerManager.registerListener(this);</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+    // -- tab monitor hookup</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+    this.tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+    this.tabmail.registerTabMonitor(this);</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+    // We may be registering after the first tab was opened, in which case</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+    //  we should generate a synthetic notification to ourselves.</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+    if (this.tabmail.currentTabInfo)</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+      this.onTabOpened(this.tabmail.currentTabInfo, true, null);</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+    // -- window hookups</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+    let dis = this;</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+    window.addEventListener(&quot;resize&quot;, function() {</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+                              dis.onWindowResize();</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+                            }, false);</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+    this._bindUI();</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+  },</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+  // FolderDisplayListener</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+  /**</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+   * Decide whether to display the filter bar toggle button whenever a folder</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+   *  display is made active.  makeActive is what triggers the display of</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+   *  account central so this is the perfect spot to do so.</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+   */</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+  onMakeActive: function QFBM_onMakeActive(aFolderDisplay) {</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+    let tab = aFolderDisplay._tabInfo;</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+    let appropriate = (&quot;quickFilter&quot; in tab._ext) &amp;&amp;</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+                        aFolderDisplay.displayedFolder &amp;&amp;</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+                        !aFolderDisplay.displayedFolder.isServer;</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+    document.getElementById(&quot;qfb-show-filter-bar&quot;).style.visibility =</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+      (appropriate ? &quot;visible&quot; : &quot;hidden&quot;);</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+  },</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+  /**</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+   * Clear out our state when notified the user has changed folders and re-apply</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+   *  search constraints if we are in sticky mode.  It is important that we</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+   *  re-apply search constraints here in onLoadingFolder as this is the only</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+   *  notification we receive where we have a chance to avoid creating a view</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+   *  just to nuke it and re-create it with our new search constraints shortly</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+   *  afterwards.</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+   */</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+  onLoadingFolder: function QFBM_onFolderChanged(aFolderDisplay,</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+                                                 aIsOutbound) {</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+    let tab = aFolderDisplay._tabInfo;</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+    let filterer = (&quot;quickFilter&quot; in tab._ext) ? tab._ext.quickFilter : null;</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+    if (!filterer)</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+      return;</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+    // check if there actually was a change (notification might not be for us)</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+    if (tab.folderDisplay.displayedFolder != filterer.displayedFolder) {</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+      // perform state propagation to a new filter state</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+      tab._ext.quickFilter = filterer = new QuickFilterState(filterer);</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+      this.updateSearch();</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+      this.reflectFiltererState(filterer, tab.folderDisplay);</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+    }</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+  },</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+  /**</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+   * Once the view is fully populated:</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+   * - Invoke postFilterProcess on all filter definitions that expose such a</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+   *   method.  If they return a value, cram it in their state and (assuming</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+   *   this is the current tab), call their reflectInDOM method so they can</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+   *   update their state.</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+   * - Update UI to reflect some/no matches.</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+   */</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+  onActiveAllMessagesLoaded:</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+      function QFBM_onFolderDisplayAllMessagesLoaded(aFolderDisplay) {</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+    let filterer = this.maybeActiveFilterer;</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+    if (!filterer)</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+      return;</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+    let filtering = aFolderDisplay.view.search.userTerms != null;</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+    // - postFilterProcess everyone who cares</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+    // This may need to be converted into an asynchronous process at some point.</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+    for each (let [, filterDef] in Iterator(QuickFilterManager.filterDefs)) {</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+      if (&quot;postFilterProcess&quot; in filterDef) {</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+        let preState = (filterDef.name in filterer.filterValues) ?</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+          filterer.filterValues[filterDef.name] : null;</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+        let [newState, update, treatAsUserAction] =</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+          filterDef.postFilterProcess(preState, aFolderDisplay.view, filtering);</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+        filterer.setFilterValue(filterDef.name, newState, !treatAsUserAction);</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+        if (update) {</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+          if (aFolderDisplay._tabInfo == this.tabmail.currentTabInfo &amp;&amp;</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+              (&quot;reflectInDOM&quot; in filterDef)) {</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+            let domNode = document.getElementById(filterDef.domId);</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+            // We are passing update as a super-secret data propagation channel</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+            //  exclusively for one-off cases like the text filter gloda upsell.</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+            filterDef.reflectInDOM(domNode, newState, document, this, update);</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+          }</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+        }</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+      }</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+    }</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineplus">+</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+    // - Update match status.</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+    this.reflectFiltererResults(filterer, aFolderDisplay);</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+  },</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineplus">+  /**</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineplus">+   * If we're searching, update the filter results.  (If we stop searching,</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+   *  we're going to end up in the onFolderDisplayAllMessagesLoaded</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+   *  notification.  Mayhaps we should lose that vector and just use this one.)</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+   */</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+  onSearching: function QFBM_onSearching(</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineplus">+      aFolderDisplay, aIsSearching) {</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+    // we only care if we just started searching and we are active</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+    if (!aIsSearching || !aFolderDisplay.active)</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+      return;</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+    // - Update match status.</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+    this.reflectFiltererResults(this.activeFilterer, aFolderDisplay);</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+  },</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+  // UI State Manipulation</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineplus">+</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineplus">+  /**</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineplus">+   * Add appropriate event handlers to the DOM elements.  We do this rather</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineplus">+   *  than requiring lots of boilerplate &quot;oncommand&quot; junk on the nodes.</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineplus">+   *</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineplus">+   * We hook up the following:</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineplus">+   * - &quot;command&quot; event listener.</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineplus">+   * - reflect filter state</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineplus">+   */</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineplus">+  _bindUI: function QFBM__bindUI() {</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineplus">+    for each (let [, filterDef] in Iterator(QuickFilterManager.filterDefs)) {</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineplus">+      let domNode = document.getElementById(filterDef.domId);</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineplus">+      // the loop let binding does not latch, at least in 1.9.2</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineplus">+      let latchedFilterDef = filterDef;</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineplus">+</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineplus">+      let handler;</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineplus">+      if (!(&quot;onCommand&quot; in filterDef)) {</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineplus">+        handler = function(aEvent) {</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineplus">+          try {</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineplus">+            let postValue = domNode.checked ? true : null;</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineplus">+            QuickFilterBarMuxer.activeFilterer.setFilterValue(</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineplus">+              latchedFilterDef.name, postValue);</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineplus">+            QuickFilterBarMuxer.deferredUpdateSearch();</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineplus">+          }</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineplus">+          catch (ex) {</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineplus">+            logException(ex);</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineplus">+          }</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineplus">+        };</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineplus">+      }</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineplus">+      else {</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineplus">+        handler = function(aEvent) {</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineplus">+          let filterValues = QuickFilterBarMuxer.activeFilterer.filterValues;</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineplus">+          let preValue = (latchedFilterDef.name in filterValues) ?</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineplus">+                           filterValues[latchedFilterDef.name] : null;</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineplus">+          let [postValue, update] =</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineplus">+            latchedFilterDef.onCommand(preValue, domNode, aEvent, document);</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineplus">+          QuickFilterBarMuxer.activeFilterer.setFilterValue(</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineplus">+            latchedFilterDef.name, postValue, !update);</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineplus">+          if (update)</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineplus">+            QuickFilterBarMuxer.deferredUpdateSearch();</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineplus">+        };</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineplus">+      }</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineplus">+      domNode.addEventListener(&quot;command&quot;, handler, false);</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineplus">+</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineplus">+      if (&quot;domBindExtra&quot; in filterDef)</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineplus">+        filterDef.domBindExtra(document, this, domNode);</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineplus">+    }</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineplus">+  },</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineplus">+</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineplus">+  /**</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineplus">+   * Update the UI to reflect the state of the filterer constraints.</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineplus">+   *</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineplus">+   * @param aFilterer The active filterer.</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineplus">+   * @param aFolderDisplay The active FolderDisplayWidget.</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineplus">+   * @param [aFilterName] If only a single filter needs to be updated, name it.</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineplus">+   */</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineplus">+  reflectFiltererState: function QFBM_reflectFiltererState(aFilterer,</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineplus">+                                                           aFolderDisplay,</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineplus">+                                                           aFilterName) {</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineplus">+    // If we aren't visible then there is no need to update the widgets.</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineplus">+    if (aFilterer.visible) {</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineplus">+      let filterValues = aFilterer.filterValues;</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineplus">+      for each (let [, filterDef] in</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineplus">+                Iterator(QuickFilterManager.filterDefs)) {</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineplus">+        // If we only need to update one state, check and skip as appropriate.</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineplus">+        if (aFilterName &amp;&amp; filterDef.name != aFilterName)</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineplus">+          continue;</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineplus">+</span>
<a href="#l8.247"></a><span id="l8.247" class="difflineplus">+        let domNode = document.getElementById(filterDef.domId);</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineplus">+        let value = (filterDef.name in filterValues) ?</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineplus">+          filterValues[filterDef.name] : null;</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineplus">+        if (!(&quot;reflectInDOM&quot; in filterDef))</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineplus">+          domNode.checked = Boolean(value);</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineplus">+        else</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineplus">+          filterDef.reflectInDOM(domNode, value, document, this);</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineplus">+      }</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineplus">+    }</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineplus">+</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineplus">+    this.reflectFiltererResults(aFilterer, aFolderDisplay);</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineplus">+</span>
<a href="#l8.259"></a><span id="l8.259" class="difflineplus">+    document.getElementById(&quot;quick-filter-bar&quot;).collapsed =</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineplus">+      !aFilterer.visible;</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineplus">+    document.getElementById(&quot;qfb-show-filter-bar&quot;).checked = aFilterer.visible;</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineplus">+  },</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineplus">+</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineplus">+  /**</span>
<a href="#l8.265"></a><span id="l8.265" class="difflineplus">+   * Update the UI to reflect the state of the folderDisplay in terms of</span>
<a href="#l8.266"></a><span id="l8.266" class="difflineplus">+   *  filtering.  This is expected to be called by |reflectFiltererState| and</span>
<a href="#l8.267"></a><span id="l8.267" class="difflineplus">+   *  when something happens event-wise in terms of search.</span>
<a href="#l8.268"></a><span id="l8.268" class="difflineplus">+   *</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineplus">+   * We can have one of four states:</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineplus">+   * - No filter is active; no attributes exposed for CSS to do anything.</span>
<a href="#l8.271"></a><span id="l8.271" class="difflineplus">+   * - A filter is active and we are still searching; filterActive=searching.</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineplus">+   * - A filter is active, completed searching, and we have results;</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineplus">+   *   filterActive=matches.</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineplus">+   * - A filter is active, completed searching, and we have no results;</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineplus">+   *   filterActive=nomatches.</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineplus">+   */</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineplus">+  reflectFiltererResults: function QFBM_reflectFiltererResults(aFilterer,</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineplus">+                                                               aFolderDisplay) {</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineplus">+    let view = aFolderDisplay.view;</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineplus">+    let threadPane = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineplus">+    let qfb = document.getElementById(&quot;quick-filter-bar&quot;);</span>
<a href="#l8.282"></a><span id="l8.282" class="difflineplus">+</span>
<a href="#l8.283"></a><span id="l8.283" class="difflineplus">+    // bail early if the view is in the process of being created</span>
<a href="#l8.284"></a><span id="l8.284" class="difflineplus">+    if (!view.dbView)</span>
<a href="#l8.285"></a><span id="l8.285" class="difflineplus">+      return;</span>
<a href="#l8.286"></a><span id="l8.286" class="difflineplus">+</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineplus">+    // no filter active</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineplus">+    if (!view.search || !view.search.userTerms) {</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineplus">+      threadPane.removeAttribute(&quot;filterActive&quot;);</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineplus">+      qfb.removeAttribute(&quot;filterActive&quot;);</span>
<a href="#l8.291"></a><span id="l8.291" class="difflineplus">+    }</span>
<a href="#l8.292"></a><span id="l8.292" class="difflineplus">+    // filter active, still searching</span>
<a href="#l8.293"></a><span id="l8.293" class="difflineplus">+    else if (view.searching) {</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineplus">+      // Do not set this immediately; wait a bit and then only set this if we</span>
<a href="#l8.295"></a><span id="l8.295" class="difflineplus">+      //  still are in this same state (and we are still the active tab...)</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineplus">+      setTimeout(function() {</span>
<a href="#l8.297"></a><span id="l8.297" class="difflineplus">+        if (!view.searching ||</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineplus">+            (QuickFilterBarMuxer.maybeActiveFilterer != aFilterer))</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineplus">+          return;</span>
<a href="#l8.300"></a><span id="l8.300" class="difflineplus">+        threadPane.setAttribute(&quot;filterActive&quot;, &quot;searching&quot;);</span>
<a href="#l8.301"></a><span id="l8.301" class="difflineplus">+        qfb.setAttribute(&quot;filterActive&quot;, &quot;searching&quot;);</span>
<a href="#l8.302"></a><span id="l8.302" class="difflineplus">+      }, 500);</span>
<a href="#l8.303"></a><span id="l8.303" class="difflineplus">+    }</span>
<a href="#l8.304"></a><span id="l8.304" class="difflineplus">+    // filter completed, results</span>
<a href="#l8.305"></a><span id="l8.305" class="difflineplus">+    else if (view.dbView.numMsgsInView) {</span>
<a href="#l8.306"></a><span id="l8.306" class="difflineplus">+      // some matches</span>
<a href="#l8.307"></a><span id="l8.307" class="difflineplus">+      threadPane.setAttribute(&quot;filterActive&quot;, &quot;matches&quot;);</span>
<a href="#l8.308"></a><span id="l8.308" class="difflineplus">+      qfb.setAttribute(&quot;filterActive&quot;, &quot;matches&quot;);</span>
<a href="#l8.309"></a><span id="l8.309" class="difflineplus">+    }</span>
<a href="#l8.310"></a><span id="l8.310" class="difflineplus">+    // filter completed, no results</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineplus">+    else {</span>
<a href="#l8.312"></a><span id="l8.312" class="difflineplus">+      // no matches! :(</span>
<a href="#l8.313"></a><span id="l8.313" class="difflineplus">+      threadPane.setAttribute(&quot;filterActive&quot;, &quot;nomatches&quot;);</span>
<a href="#l8.314"></a><span id="l8.314" class="difflineplus">+      qfb.setAttribute(&quot;filterActive&quot;, &quot;nomatches&quot;);</span>
<a href="#l8.315"></a><span id="l8.315" class="difflineplus">+    }</span>
<a href="#l8.316"></a><span id="l8.316" class="difflineplus">+  },</span>
<a href="#l8.317"></a><span id="l8.317" class="difflineplus">+</span>
<a href="#l8.318"></a><span id="l8.318" class="difflineplus">+  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.319"></a><span id="l8.319" class="difflineplus">+  // Resizing regimen</span>
<a href="#l8.320"></a><span id="l8.320" class="difflineplus">+</span>
<a href="#l8.321"></a><span id="l8.321" class="difflineplus">+  /**</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineplus">+   * Are the button labels currently collapsed?</span>
<a href="#l8.323"></a><span id="l8.323" class="difflineplus">+   */</span>
<a href="#l8.324"></a><span id="l8.324" class="difflineplus">+  _buttonLabelsCollapsed: false,</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineplus">+</span>
<a href="#l8.326"></a><span id="l8.326" class="difflineplus">+  /**</span>
<a href="#l8.327"></a><span id="l8.327" class="difflineplus">+   * The minimum width the bar must be before we can un-collapse the button</span>
<a href="#l8.328"></a><span id="l8.328" class="difflineplus">+   *  labels.</span>
<a href="#l8.329"></a><span id="l8.329" class="difflineplus">+   */</span>
<a href="#l8.330"></a><span id="l8.330" class="difflineplus">+  _minExpandedBarWidth: null,</span>
<a href="#l8.331"></a><span id="l8.331" class="difflineplus">+</span>
<a href="#l8.332"></a><span id="l8.332" class="difflineplus">+  /**</span>
<a href="#l8.333"></a><span id="l8.333" class="difflineplus">+   * Our general strategy is this:</span>
<a href="#l8.334"></a><span id="l8.334" class="difflineplus">+   * - All collapsible buttons are set to not flex and live in the</span>
<a href="#l8.335"></a><span id="l8.335" class="difflineplus">+   *   &quot;quick-filter-bar-collapsible-buttons&quot; hbox.  This provides us with a</span>
<a href="#l8.336"></a><span id="l8.336" class="difflineplus">+   *   nice minimum size.</span>
<a href="#l8.337"></a><span id="l8.337" class="difflineplus">+   * - All flexy widgets have some minimum size configured.</span>
<a href="#l8.338"></a><span id="l8.338" class="difflineplus">+   * - When the bar starts to overflow we save off the (minimum) size of the bar</span>
<a href="#l8.339"></a><span id="l8.339" class="difflineplus">+   *   so that once it gets large enough again we can restore the buttons.</span>
<a href="#l8.340"></a><span id="l8.340" class="difflineplus">+   *</span>
<a href="#l8.341"></a><span id="l8.341" class="difflineplus">+   * This method handles the overflow case where we transition to collapsed</span>
<a href="#l8.342"></a><span id="l8.342" class="difflineplus">+   * buttons.  Our onWindowResize logic handles detecting when it is time to</span>
<a href="#l8.343"></a><span id="l8.343" class="difflineplus">+   * un-collapse.</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineplus">+   */</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineplus">+  onOverflow: function QFBM_onOverflow() {</span>
<a href="#l8.346"></a><span id="l8.346" class="difflineplus">+    // if we are already collapsed, there is nothing more to do.</span>
<a href="#l8.347"></a><span id="l8.347" class="difflineplus">+    if (this._buttonLabelsCollapsed)</span>
<a href="#l8.348"></a><span id="l8.348" class="difflineplus">+      return;</span>
<a href="#l8.349"></a><span id="l8.349" class="difflineplus">+</span>
<a href="#l8.350"></a><span id="l8.350" class="difflineplus">+    let quickFilterBarBox =</span>
<a href="#l8.351"></a><span id="l8.351" class="difflineplus">+      document.getElementById(&quot;quick-filter-bar-main-bar&quot;);</span>
<a href="#l8.352"></a><span id="l8.352" class="difflineplus">+    let collapsibleButtonBox =</span>
<a href="#l8.353"></a><span id="l8.353" class="difflineplus">+      document.getElementById(&quot;quick-filter-bar-collapsible-buttons&quot;);</span>
<a href="#l8.354"></a><span id="l8.354" class="difflineplus">+    // the scroll width is the actual size it wants to be...</span>
<a href="#l8.355"></a><span id="l8.355" class="difflineplus">+    this._minExpandedBarWidth = quickFilterBarBox.scrollWidth;</span>
<a href="#l8.356"></a><span id="l8.356" class="difflineplus">+    this._buttonLabelsCollapsed = true;</span>
<a href="#l8.357"></a><span id="l8.357" class="difflineplus">+</span>
<a href="#l8.358"></a><span id="l8.358" class="difflineplus">+    collapsibleButtonBox.setAttribute(&quot;shrink&quot;, &quot;true&quot;);</span>
<a href="#l8.359"></a><span id="l8.359" class="difflineplus">+  },</span>
<a href="#l8.360"></a><span id="l8.360" class="difflineplus">+</span>
<a href="#l8.361"></a><span id="l8.361" class="difflineplus">+  /**</span>
<a href="#l8.362"></a><span id="l8.362" class="difflineplus">+   * Counterpart to |onOverflow| un-collapses the buttons once the quick filter</span>
<a href="#l8.363"></a><span id="l8.363" class="difflineplus">+   *  bar gets wide enough to support the desired minimum widget of the bar when</span>
<a href="#l8.364"></a><span id="l8.364" class="difflineplus">+   *  the buttons are not collapsed.</span>
<a href="#l8.365"></a><span id="l8.365" class="difflineplus">+   */</span>
<a href="#l8.366"></a><span id="l8.366" class="difflineplus">+  onWindowResize: function QFB_onWindowResize() {</span>
<a href="#l8.367"></a><span id="l8.367" class="difflineplus">+    // nothing to do here if the buttons are not collapsed</span>
<a href="#l8.368"></a><span id="l8.368" class="difflineplus">+    if (!this._buttonLabelsCollapsed)</span>
<a href="#l8.369"></a><span id="l8.369" class="difflineplus">+      return;</span>
<a href="#l8.370"></a><span id="l8.370" class="difflineplus">+</span>
<a href="#l8.371"></a><span id="l8.371" class="difflineplus">+    let quickFilterBarBox =</span>
<a href="#l8.372"></a><span id="l8.372" class="difflineplus">+      document.getElementById(&quot;quick-filter-bar-main-bar&quot;);</span>
<a href="#l8.373"></a><span id="l8.373" class="difflineplus">+    // the client width is how big it actually is (thanks to overflow:hidden)</span>
<a href="#l8.374"></a><span id="l8.374" class="difflineplus">+    if (quickFilterBarBox.clientWidth &lt; this._minExpandedBarWidth)</span>
<a href="#l8.375"></a><span id="l8.375" class="difflineplus">+      return;</span>
<a href="#l8.376"></a><span id="l8.376" class="difflineplus">+</span>
<a href="#l8.377"></a><span id="l8.377" class="difflineplus">+    this._buttonLabelsCollapsed = false;</span>
<a href="#l8.378"></a><span id="l8.378" class="difflineplus">+    this._minExpandedBarWidth = null;</span>
<a href="#l8.379"></a><span id="l8.379" class="difflineplus">+</span>
<a href="#l8.380"></a><span id="l8.380" class="difflineplus">+    let collapsibleButtonBox =</span>
<a href="#l8.381"></a><span id="l8.381" class="difflineplus">+      document.getElementById(&quot;quick-filter-bar-collapsible-buttons&quot;);</span>
<a href="#l8.382"></a><span id="l8.382" class="difflineplus">+    collapsibleButtonBox.removeAttribute(&quot;shrink&quot;);</span>
<a href="#l8.383"></a><span id="l8.383" class="difflineplus">+  },</span>
<a href="#l8.384"></a><span id="l8.384" class="difflineplus">+</span>
<a href="#l8.385"></a><span id="l8.385" class="difflineplus">+  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.386"></a><span id="l8.386" class="difflineplus">+  // Tab Monitor Interaction</span>
<a href="#l8.387"></a><span id="l8.387" class="difflineplus">+</span>
<a href="#l8.388"></a><span id="l8.388" class="difflineplus">+  monitorName: &quot;quickFilter&quot;,</span>
<a href="#l8.389"></a><span id="l8.389" class="difflineplus">+</span>
<a href="#l8.390"></a><span id="l8.390" class="difflineplus">+  onTabTitleChanged: function QFBM_onTabTitleChanged(aTab) {</span>
<a href="#l8.391"></a><span id="l8.391" class="difflineplus">+    // nop</span>
<a href="#l8.392"></a><span id="l8.392" class="difflineplus">+  },</span>
<a href="#l8.393"></a><span id="l8.393" class="difflineplus">+</span>
<a href="#l8.394"></a><span id="l8.394" class="difflineplus">+  /**</span>
<a href="#l8.395"></a><span id="l8.395" class="difflineplus">+   * Whenever an appropriate new tab is opened, initialize its quick filter</span>
<a href="#l8.396"></a><span id="l8.396" class="difflineplus">+   *  state.</span>
<a href="#l8.397"></a><span id="l8.397" class="difflineplus">+   */</span>
<a href="#l8.398"></a><span id="l8.398" class="difflineplus">+  onTabOpened: function QFBM_onTabOpened(aTab, aFirstTab, aOldTab) {</span>
<a href="#l8.399"></a><span id="l8.399" class="difflineplus">+    if (aTab.mode.name == &quot;folder&quot; ||</span>
<a href="#l8.400"></a><span id="l8.400" class="difflineplus">+        aTab.mode.name == &quot;glodaList&quot;) {</span>
<a href="#l8.401"></a><span id="l8.401" class="difflineplus">+      let modelTab =</span>
<a href="#l8.402"></a><span id="l8.402" class="difflineplus">+        this.tabmail.getTabInfoForCurrentOrFirstModeInstance(aTab.mode);</span>
<a href="#l8.403"></a><span id="l8.403" class="difflineplus">+      let oldFilterer = (modelTab &amp;&amp; (&quot;quickFilter&quot; in modelTab._ext)) ?</span>
<a href="#l8.404"></a><span id="l8.404" class="difflineplus">+                          modelTab._ext.quickFilter : undefined;</span>
<a href="#l8.405"></a><span id="l8.405" class="difflineplus">+      aTab._ext.quickFilter = new QuickFilterState(oldFilterer);</span>
<a href="#l8.406"></a><span id="l8.406" class="difflineplus">+      this.updateSearch(aTab);</span>
<a href="#l8.407"></a><span id="l8.407" class="difflineplus">+    }</span>
<a href="#l8.408"></a><span id="l8.408" class="difflineplus">+  },</span>
<a href="#l8.409"></a><span id="l8.409" class="difflineplus">+</span>
<a href="#l8.410"></a><span id="l8.410" class="difflineplus">+  onTabRestored: function QFBM_onTabRestored(aTab, aState, aFirstTab) {</span>
<a href="#l8.411"></a><span id="l8.411" class="difflineplus">+    let filterer = aTab._ext.quickFilter = new QuickFilterState(null, aState);</span>
<a href="#l8.412"></a><span id="l8.412" class="difflineplus">+    this.updateSearch(aTab);</span>
<a href="#l8.413"></a><span id="l8.413" class="difflineplus">+    if (aTab == this.tabmail.currentTabInfo)</span>
<a href="#l8.414"></a><span id="l8.414" class="difflineplus">+      this.reflectFiltererState(filterer, aTab.folderDisplay);</span>
<a href="#l8.415"></a><span id="l8.415" class="difflineplus">+  },</span>
<a href="#l8.416"></a><span id="l8.416" class="difflineplus">+</span>
<a href="#l8.417"></a><span id="l8.417" class="difflineplus">+  onTabPersist: function QFBM_onTabPersist(aTab) {</span>
<a href="#l8.418"></a><span id="l8.418" class="difflineplus">+    let filterer = (&quot;quickFilter&quot; in aTab._ext) ? aTab._ext.quickFilter : null;</span>
<a href="#l8.419"></a><span id="l8.419" class="difflineplus">+    if (filterer)</span>
<a href="#l8.420"></a><span id="l8.420" class="difflineplus">+      return filterer.persistToObj();</span>
<a href="#l8.421"></a><span id="l8.421" class="difflineplus">+    return null;</span>
<a href="#l8.422"></a><span id="l8.422" class="difflineplus">+  },</span>
<a href="#l8.423"></a><span id="l8.423" class="difflineplus">+</span>
<a href="#l8.424"></a><span id="l8.424" class="difflineplus">+  /**</span>
<a href="#l8.425"></a><span id="l8.425" class="difflineplus">+   * On tab switch we need to:</span>
<a href="#l8.426"></a><span id="l8.426" class="difflineplus">+   * - Restore state for already existing state</span>
<a href="#l8.427"></a><span id="l8.427" class="difflineplus">+   * - Create state if it's a new (to us) tab</span>
<a href="#l8.428"></a><span id="l8.428" class="difflineplus">+   */</span>
<a href="#l8.429"></a><span id="l8.429" class="difflineplus">+  onTabSwitched: function QFBM_onTabSwitched(aTab, aOldTab) {</span>
<a href="#l8.430"></a><span id="l8.430" class="difflineplus">+    // (Note: we used to explicitly handle the possibility that the user had</span>
<a href="#l8.431"></a><span id="l8.431" class="difflineplus">+    // typed something but an ontimeout had not yet fired in the textbox.</span>
<a href="#l8.432"></a><span id="l8.432" class="difflineplus">+    // We are bailing on that because it adds complexity without much functional</span>
<a href="#l8.433"></a><span id="l8.433" class="difflineplus">+    // gain.  Our UI will be consistent when we switch back to the tab, which</span>
<a href="#l8.434"></a><span id="l8.434" class="difflineplus">+    // is good enough.)</span>
<a href="#l8.435"></a><span id="l8.435" class="difflineplus">+</span>
<a href="#l8.436"></a><span id="l8.436" class="difflineplus">+    let filterer = this.maybeActiveFilterer;</span>
<a href="#l8.437"></a><span id="l8.437" class="difflineplus">+    if (filterer)</span>
<a href="#l8.438"></a><span id="l8.438" class="difflineplus">+      this.reflectFiltererState(filterer, aTab.folderDisplay);</span>
<a href="#l8.439"></a><span id="l8.439" class="difflineplus">+    else // this only happens for tabs we are not legal on</span>
<a href="#l8.440"></a><span id="l8.440" class="difflineplus">+      document.getElementById(&quot;qfb-show-filter-bar&quot;).style.visibility = &quot;hidden&quot;;</span>
<a href="#l8.441"></a><span id="l8.441" class="difflineplus">+  },</span>
<a href="#l8.442"></a><span id="l8.442" class="difflineplus">+</span>
<a href="#l8.443"></a><span id="l8.443" class="difflineplus">+  supportsCommand: function QFBM_supportsCommand(aCommand, aTab) {</span>
<a href="#l8.444"></a><span id="l8.444" class="difflineplus">+    // we are not active on tab types we do not support (message tabs)</span>
<a href="#l8.445"></a><span id="l8.445" class="difflineplus">+    if (!(&quot;quickFilter&quot; in aTab._ext))</span>
<a href="#l8.446"></a><span id="l8.446" class="difflineplus">+      return null;</span>
<a href="#l8.447"></a><span id="l8.447" class="difflineplus">+</span>
<a href="#l8.448"></a><span id="l8.448" class="difflineplus">+    if (aCommand == &quot;cmd_stop&quot; || aCommand == &quot;cmd_find&quot; ||</span>
<a href="#l8.449"></a><span id="l8.449" class="difflineplus">+        aCommand == &quot;cmd_toggleQuickFilterBar&quot;)</span>
<a href="#l8.450"></a><span id="l8.450" class="difflineplus">+      return true;</span>
<a href="#l8.451"></a><span id="l8.451" class="difflineplus">+    else</span>
<a href="#l8.452"></a><span id="l8.452" class="difflineplus">+      return null;</span>
<a href="#l8.453"></a><span id="l8.453" class="difflineplus">+  },</span>
<a href="#l8.454"></a><span id="l8.454" class="difflineplus">+  isCommandEnabled: function QFBM_isCommandEnabled(aCommand, aTab) {</span>
<a href="#l8.455"></a><span id="l8.455" class="difflineplus">+    // we are not active on tab types we do not support (message tabs)</span>
<a href="#l8.456"></a><span id="l8.456" class="difflineplus">+    if (!(&quot;quickFilter&quot; in aTab._ext))</span>
<a href="#l8.457"></a><span id="l8.457" class="difflineplus">+      return null;</span>
<a href="#l8.458"></a><span id="l8.458" class="difflineplus">+</span>
<a href="#l8.459"></a><span id="l8.459" class="difflineplus">+    if (aCommand == &quot;cmd_stop&quot; || aCommand == &quot;cmd_find&quot; ||</span>
<a href="#l8.460"></a><span id="l8.460" class="difflineplus">+        aCommand == &quot;cmd_toggleQuickFilterBar&quot;)</span>
<a href="#l8.461"></a><span id="l8.461" class="difflineplus">+      return true;</span>
<a href="#l8.462"></a><span id="l8.462" class="difflineplus">+    else</span>
<a href="#l8.463"></a><span id="l8.463" class="difflineplus">+      return null;</span>
<a href="#l8.464"></a><span id="l8.464" class="difflineplus">+  },</span>
<a href="#l8.465"></a><span id="l8.465" class="difflineplus">+  doCommand: function QFBM_doCommand(aCommand, aTab) {</span>
<a href="#l8.466"></a><span id="l8.466" class="difflineplus">+    // we are not active on tab types we do not support (message tabs)</span>
<a href="#l8.467"></a><span id="l8.467" class="difflineplus">+    if (!(&quot;quickFilter&quot; in aTab._ext))</span>
<a href="#l8.468"></a><span id="l8.468" class="difflineplus">+      return null;</span>
<a href="#l8.469"></a><span id="l8.469" class="difflineplus">+</span>
<a href="#l8.470"></a><span id="l8.470" class="difflineplus">+    if (aCommand == &quot;cmd_stop&quot;) {</span>
<a href="#l8.471"></a><span id="l8.471" class="difflineplus">+      QuickFilterBarMuxer.cmdEscapeFilterStack();</span>
<a href="#l8.472"></a><span id="l8.472" class="difflineplus">+      return true;</span>
<a href="#l8.473"></a><span id="l8.473" class="difflineplus">+    }</span>
<a href="#l8.474"></a><span id="l8.474" class="difflineplus">+    else if (aCommand == &quot;cmd_find&quot;) {</span>
<a href="#l8.475"></a><span id="l8.475" class="difflineplus">+      let textWidget = document.getElementById(</span>
<a href="#l8.476"></a><span id="l8.476" class="difflineplus">+                         QuickFilterManager.textBoxDomId);</span>
<a href="#l8.477"></a><span id="l8.477" class="difflineplus">+      // if it's not already focused, then focus/select it</span>
<a href="#l8.478"></a><span id="l8.478" class="difflineplus">+      if (document.commandDispatcher.focusedElement != textWidget.inputField) {</span>
<a href="#l8.479"></a><span id="l8.479" class="difflineplus">+        QuickFilterBarMuxer._showFilterBar(true);</span>
<a href="#l8.480"></a><span id="l8.480" class="difflineplus">+        textWidget.select();</span>
<a href="#l8.481"></a><span id="l8.481" class="difflineplus">+        return true;</span>
<a href="#l8.482"></a><span id="l8.482" class="difflineplus">+      }</span>
<a href="#l8.483"></a><span id="l8.483" class="difflineplus">+    }</span>
<a href="#l8.484"></a><span id="l8.484" class="difflineplus">+    else if (aCommand == &quot;cmd_toggleQuickFilterBar&quot;) {</span>
<a href="#l8.485"></a><span id="l8.485" class="difflineplus">+      this._showFilterBar(!this.activeFilterer.visible);</span>
<a href="#l8.486"></a><span id="l8.486" class="difflineplus">+      return true;</span>
<a href="#l8.487"></a><span id="l8.487" class="difflineplus">+    }</span>
<a href="#l8.488"></a><span id="l8.488" class="difflineplus">+    return null;</span>
<a href="#l8.489"></a><span id="l8.489" class="difflineplus">+  },</span>
<a href="#l8.490"></a><span id="l8.490" class="difflineplus">+</span>
<a href="#l8.491"></a><span id="l8.491" class="difflineplus">+  get maybeActiveFilterer() {</span>
<a href="#l8.492"></a><span id="l8.492" class="difflineplus">+    if (&quot;quickFilter&quot; in this.tabmail.currentTabInfo._ext)</span>
<a href="#l8.493"></a><span id="l8.493" class="difflineplus">+      return this.tabmail.currentTabInfo._ext.quickFilter;</span>
<a href="#l8.494"></a><span id="l8.494" class="difflineplus">+    return null;</span>
<a href="#l8.495"></a><span id="l8.495" class="difflineplus">+  },</span>
<a href="#l8.496"></a><span id="l8.496" class="difflineplus">+</span>
<a href="#l8.497"></a><span id="l8.497" class="difflineplus">+  get activeFilterer() {</span>
<a href="#l8.498"></a><span id="l8.498" class="difflineplus">+    if (&quot;quickFilter&quot; in this.tabmail.currentTabInfo._ext)</span>
<a href="#l8.499"></a><span id="l8.499" class="difflineplus">+      return this.tabmail.currentTabInfo._ext.quickFilter;</span>
<a href="#l8.500"></a><span id="l8.500" class="difflineplus">+    throw errorWithDebug(&quot;There is no active filterer but we want one.&quot;);</span>
<a href="#l8.501"></a><span id="l8.501" class="difflineplus">+  },</span>
<a href="#l8.502"></a><span id="l8.502" class="difflineplus">+</span>
<a href="#l8.503"></a><span id="l8.503" class="difflineplus">+  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.504"></a><span id="l8.504" class="difflineplus">+  // Event Handling Support</span>
<a href="#l8.505"></a><span id="l8.505" class="difflineplus">+</span>
<a href="#l8.506"></a><span id="l8.506" class="difflineplus">+  /**</span>
<a href="#l8.507"></a><span id="l8.507" class="difflineplus">+   * Retrieve the current filter state value (presumably an object) for mutation</span>
<a href="#l8.508"></a><span id="l8.508" class="difflineplus">+   *  purposes.  This causes the filter to be the last touched filter for escape</span>
<a href="#l8.509"></a><span id="l8.509" class="difflineplus">+   *  undo-ish purposes.</span>
<a href="#l8.510"></a><span id="l8.510" class="difflineplus">+   */</span>
<a href="#l8.511"></a><span id="l8.511" class="difflineplus">+  getFilterValueForMutation: function QFBM_getFilterValueForMutation(aName) {</span>
<a href="#l8.512"></a><span id="l8.512" class="difflineplus">+    return this.activeFilterer.getFilterValue(aName);</span>
<a href="#l8.513"></a><span id="l8.513" class="difflineplus">+  },</span>
<a href="#l8.514"></a><span id="l8.514" class="difflineplus">+</span>
<a href="#l8.515"></a><span id="l8.515" class="difflineplus">+  /**</span>
<a href="#l8.516"></a><span id="l8.516" class="difflineplus">+   * Set the filter state for the given named filter to the given value.  This</span>
<a href="#l8.517"></a><span id="l8.517" class="difflineplus">+   *  causes the filter to be the last touched filter for escape undo-ish</span>
<a href="#l8.518"></a><span id="l8.518" class="difflineplus">+   *  purposes.</span>
<a href="#l8.519"></a><span id="l8.519" class="difflineplus">+   *</span>
<a href="#l8.520"></a><span id="l8.520" class="difflineplus">+   * @param aName Filter name.</span>
<a href="#l8.521"></a><span id="l8.521" class="difflineplus">+   * @param aValue The new filter state.</span>
<a href="#l8.522"></a><span id="l8.522" class="difflineplus">+   */</span>
<a href="#l8.523"></a><span id="l8.523" class="difflineplus">+  setFilterValue: function QFBM_setFilterValue(aName, aValue) {</span>
<a href="#l8.524"></a><span id="l8.524" class="difflineplus">+    this.activeFilterer.setFilterValue(aName, aValue);</span>
<a href="#l8.525"></a><span id="l8.525" class="difflineplus">+  },</span>
<a href="#l8.526"></a><span id="l8.526" class="difflineplus">+</span>
<a href="#l8.527"></a><span id="l8.527" class="difflineplus">+  /**</span>
<a href="#l8.528"></a><span id="l8.528" class="difflineplus">+   * For UI responsiveness purposes, defer the actual initiation of the search</span>
<a href="#l8.529"></a><span id="l8.529" class="difflineplus">+   *  until after the button click handling has completed and had the ability</span>
<a href="#l8.530"></a><span id="l8.530" class="difflineplus">+   *  to paint such.</span>
<a href="#l8.531"></a><span id="l8.531" class="difflineplus">+   */</span>
<a href="#l8.532"></a><span id="l8.532" class="difflineplus">+  deferredUpdateSearch: function QFBM_deferredUpdateSearch() {</span>
<a href="#l8.533"></a><span id="l8.533" class="difflineplus">+    setTimeout(this._deferredInvocUpdateSearch, 10);</span>
<a href="#l8.534"></a><span id="l8.534" class="difflineplus">+  },</span>
<a href="#l8.535"></a><span id="l8.535" class="difflineplus">+</span>
<a href="#l8.536"></a><span id="l8.536" class="difflineplus">+  /**</span>
<a href="#l8.537"></a><span id="l8.537" class="difflineplus">+   * The actual helper function to call updateSearch for deferredUpdateSearch</span>
<a href="#l8.538"></a><span id="l8.538" class="difflineplus">+   *  that makes 'this' relevant.</span>
<a href="#l8.539"></a><span id="l8.539" class="difflineplus">+   */</span>
<a href="#l8.540"></a><span id="l8.540" class="difflineplus">+  _deferredInvocUpdateSearch: function QFBM__deferredInvocUpdateSearch() {</span>
<a href="#l8.541"></a><span id="l8.541" class="difflineplus">+    QuickFilterBarMuxer.updateSearch();</span>
<a href="#l8.542"></a><span id="l8.542" class="difflineplus">+  },</span>
<a href="#l8.543"></a><span id="l8.543" class="difflineplus">+</span>
<a href="#l8.544"></a><span id="l8.544" class="difflineplus">+  /**</span>
<a href="#l8.545"></a><span id="l8.545" class="difflineplus">+   * Update the user terms part of the search definition to reflect the active</span>
<a href="#l8.546"></a><span id="l8.546" class="difflineplus">+   *  filterer's current state.</span>
<a href="#l8.547"></a><span id="l8.547" class="difflineplus">+   */</span>
<a href="#l8.548"></a><span id="l8.548" class="difflineplus">+  updateSearch: function QFBM_updateSearch(aTab) {</span>
<a href="#l8.549"></a><span id="l8.549" class="difflineplus">+    let tab = aTab || this.tabmail.currentTabInfo;</span>
<a href="#l8.550"></a><span id="l8.550" class="difflineplus">+    // bail if things don't really exist yet</span>
<a href="#l8.551"></a><span id="l8.551" class="difflineplus">+    if (!tab.folderDisplay.view.search)</span>
<a href="#l8.552"></a><span id="l8.552" class="difflineplus">+      return;</span>
<a href="#l8.553"></a><span id="l8.553" class="difflineplus">+</span>
<a href="#l8.554"></a><span id="l8.554" class="difflineplus">+    let filterer = tab._ext.quickFilter;</span>
<a href="#l8.555"></a><span id="l8.555" class="difflineplus">+    filterer.displayedFolder = tab.folderDisplay.displayedFolder;</span>
<a href="#l8.556"></a><span id="l8.556" class="difflineplus">+</span>
<a href="#l8.557"></a><span id="l8.557" class="difflineplus">+    let [terms, listeners] =</span>
<a href="#l8.558"></a><span id="l8.558" class="difflineplus">+      filterer.createSearchTerms(tab.folderDisplay.view.search.session);</span>
<a href="#l8.559"></a><span id="l8.559" class="difflineplus">+</span>
<a href="#l8.560"></a><span id="l8.560" class="difflineplus">+    for each (let [, [listener, filterDef]] in Iterator(listeners)) {</span>
<a href="#l8.561"></a><span id="l8.561" class="difflineplus">+      // it registers itself with the search session.</span>
<a href="#l8.562"></a><span id="l8.562" class="difflineplus">+      new QuickFilterSearchListener(</span>
<a href="#l8.563"></a><span id="l8.563" class="difflineplus">+        tab.folderDisplay, filterer, filterDef,</span>
<a href="#l8.564"></a><span id="l8.564" class="difflineplus">+        listener, QuickFilterBarMuxer);</span>
<a href="#l8.565"></a><span id="l8.565" class="difflineplus">+    }</span>
<a href="#l8.566"></a><span id="l8.566" class="difflineplus">+    tab.folderDisplay.view.search.userTerms = terms;</span>
<a href="#l8.567"></a><span id="l8.567" class="difflineplus">+    // Uncomment to know what the search state is when we (try and) update it.</span>
<a href="#l8.568"></a><span id="l8.568" class="difflineplus">+    //dump(tab.folderDisplay.view.search.prettyString());</span>
<a href="#l8.569"></a><span id="l8.569" class="difflineplus">+  },</span>
<a href="#l8.570"></a><span id="l8.570" class="difflineplus">+</span>
<a href="#l8.571"></a><span id="l8.571" class="difflineplus">+  _showFilterBar: function QFBM__showFilterBar(aShow) {</span>
<a href="#l8.572"></a><span id="l8.572" class="difflineplus">+    this.activeFilterer.visible = aShow;</span>
<a href="#l8.573"></a><span id="l8.573" class="difflineplus">+    if (!aShow) {</span>
<a href="#l8.574"></a><span id="l8.574" class="difflineplus">+      this.activeFilterer.clear();</span>
<a href="#l8.575"></a><span id="l8.575" class="difflineplus">+      this.updateSearch();</span>
<a href="#l8.576"></a><span id="l8.576" class="difflineplus">+    }</span>
<a href="#l8.577"></a><span id="l8.577" class="difflineplus">+    this.reflectFiltererState(this.activeFilterer,</span>
<a href="#l8.578"></a><span id="l8.578" class="difflineplus">+                              this.tabmail.currentTabInfo.folderDisplay);</span>
<a href="#l8.579"></a><span id="l8.579" class="difflineplus">+  },</span>
<a href="#l8.580"></a><span id="l8.580" class="difflineplus">+</span>
<a href="#l8.581"></a><span id="l8.581" class="difflineplus">+  /**</span>
<a href="#l8.582"></a><span id="l8.582" class="difflineplus">+   * Invoked when the user chooses the popup from the gloda search box.</span>
<a href="#l8.583"></a><span id="l8.583" class="difflineplus">+   */</span>
<a href="#l8.584"></a><span id="l8.584" class="difflineplus">+  cmdGlodaSearchDownSell: function QFBM_cmdGlodaSearchDownSell(aEvent) {</span>
<a href="#l8.585"></a><span id="l8.585" class="difflineplus">+    aEvent.stopPropagation();</span>
<a href="#l8.586"></a><span id="l8.586" class="difflineplus">+    this._showFilterBar(true);</span>
<a href="#l8.587"></a><span id="l8.587" class="difflineplus">+    let textWidget = document.getElementById(</span>
<a href="#l8.588"></a><span id="l8.588" class="difflineplus">+                       QuickFilterManager.textBoxDomId);</span>
<a href="#l8.589"></a><span id="l8.589" class="difflineplus">+    textWidget.select();</span>
<a href="#l8.590"></a><span id="l8.590" class="difflineplus">+  },</span>
<a href="#l8.591"></a><span id="l8.591" class="difflineplus">+</span>
<a href="#l8.592"></a><span id="l8.592" class="difflineplus">+  /**</span>
<a href="#l8.593"></a><span id="l8.593" class="difflineplus">+   * User explicitly closed the filter bar.</span>
<a href="#l8.594"></a><span id="l8.594" class="difflineplus">+   */</span>
<a href="#l8.595"></a><span id="l8.595" class="difflineplus">+  cmdClose: function QFBM_cmdClose(aEvent) {</span>
<a href="#l8.596"></a><span id="l8.596" class="difflineplus">+    this._showFilterBar(false);</span>
<a href="#l8.597"></a><span id="l8.597" class="difflineplus">+  },</span>
<a href="#l8.598"></a><span id="l8.598" class="difflineplus">+</span>
<a href="#l8.599"></a><span id="l8.599" class="difflineplus">+  /**</span>
<a href="#l8.600"></a><span id="l8.600" class="difflineplus">+   * User hit the escape key; do our undo-ish thing keeping in mind that this</span>
<a href="#l8.601"></a><span id="l8.601" class="difflineplus">+   *  may be invoked in situations where the filter bar is not legal / enabled.</span>
<a href="#l8.602"></a><span id="l8.602" class="difflineplus">+   */</span>
<a href="#l8.603"></a><span id="l8.603" class="difflineplus">+  cmdEscapeFilterStack: function QFBM_cmdEscapeFilterStack() {</span>
<a href="#l8.604"></a><span id="l8.604" class="difflineplus">+    let filterer = this.maybeActiveFilterer;</span>
<a href="#l8.605"></a><span id="l8.605" class="difflineplus">+    if (!filterer || !filterer.visible)</span>
<a href="#l8.606"></a><span id="l8.606" class="difflineplus">+      return;</span>
<a href="#l8.607"></a><span id="l8.607" class="difflineplus">+</span>
<a href="#l8.608"></a><span id="l8.608" class="difflineplus">+    // update the search if we were relaxing something</span>
<a href="#l8.609"></a><span id="l8.609" class="difflineplus">+    if (filterer.userHitEscape()) {</span>
<a href="#l8.610"></a><span id="l8.610" class="difflineplus">+      this.updateSearch();</span>
<a href="#l8.611"></a><span id="l8.611" class="difflineplus">+      this.reflectFiltererState(filterer,</span>
<a href="#l8.612"></a><span id="l8.612" class="difflineplus">+                                this.tabmail.currentTabInfo.folderDisplay);</span>
<a href="#l8.613"></a><span id="l8.613" class="difflineplus">+    }</span>
<a href="#l8.614"></a><span id="l8.614" class="difflineplus">+    // close the filter since there was nothing left to relax</span>
<a href="#l8.615"></a><span id="l8.615" class="difflineplus">+    else {</span>
<a href="#l8.616"></a><span id="l8.616" class="difflineplus">+      this.cmdClose();</span>
<a href="#l8.617"></a><span id="l8.617" class="difflineplus">+    }</span>
<a href="#l8.618"></a><span id="l8.618" class="difflineplus">+  },</span>
<a href="#l8.619"></a><span id="l8.619" class="difflineplus">+</span>
<a href="#l8.620"></a><span id="l8.620" class="difflineplus">+  _testHelperResetFilterState: function QFBM_resetFilterState() {</span>
<a href="#l8.621"></a><span id="l8.621" class="difflineplus">+    let filterer = this.maybeActiveFilterer;</span>
<a href="#l8.622"></a><span id="l8.622" class="difflineplus">+    if (!filterer)</span>
<a href="#l8.623"></a><span id="l8.623" class="difflineplus">+      return;</span>
<a href="#l8.624"></a><span id="l8.624" class="difflineplus">+    let tab = this.tabmail.currentTabInfo;</span>
<a href="#l8.625"></a><span id="l8.625" class="difflineplus">+    tab._ext.quickFilter = filterer = new QuickFilterState();</span>
<a href="#l8.626"></a><span id="l8.626" class="difflineplus">+    this.updateSearch();</span>
<a href="#l8.627"></a><span id="l8.627" class="difflineplus">+    this.reflectFiltererState(filterer, tab.folderDisplay);</span>
<a href="#l8.628"></a><span id="l8.628" class="difflineplus">+  },</span>
<a href="#l8.629"></a><span id="l8.629" class="difflineplus">+};</span>
<a href="#l8.630"></a><span id="l8.630" class="difflineplus">+addEventListener(&quot;load&quot;, function() QuickFilterBarMuxer._init(), false);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/mail/base/content/quickFilterBar.xul</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,184 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+&lt;!-- ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+  -   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+  -</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+  - The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+  - 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+  - the License. You may obtain a copy of the License at</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+  - http://www.mozilla.org/MPL/</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  - </span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+  - Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+  - WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+  - for the specific language governing rights and limitations under the</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+  - License.</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+  -</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+  - The Original Code is Thunderbird Mail Client.</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+  -</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+  - The Initial Developer of the Original Code is the Mozilla Foundation.</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+  - Portions created by the Initial Developer are Copyright (C) 2010</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+  - the Initial Developer. All Rights Reserved.</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+  -</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+  - Contributor(s):</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+  -   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+  -</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+  - Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+  - either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+  - the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+  - in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+  - of those above. If you wish to allow use of your version of this file only</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+  - under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+  - use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+  - decision by deleting the provisions above and replace them with the notice</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+  - and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+  - the provisions above, a recipient may use your version of this file under</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+  - the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+  - </span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+  - ***** END LICENSE BLOCK ***** --&gt;</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://messenger/skin/quickFilterBar.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+&lt;!DOCTYPE quickFilterBar SYSTEM &quot;chrome://messenger/locale/quickFilterBar.dtd&quot;&gt;</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+&lt;overlay id=&quot;quickFilterBar-overlay&quot;</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+  &lt;script src=&quot;quickFilterBar.js&quot; type=&quot;application/javascript&quot; /&gt;</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+  &lt;commandset id=&quot;mailViewMenuItems&quot;&gt;</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+    &lt;command id=&quot;cmd_toggleQuickFilterBar&quot;</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+             oncommand=&quot;goDoCommand('cmd_toggleQuickFilterBar');&quot;</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+             /&gt;</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+  &lt;/commandset&gt;</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+  &lt;menupopup id=&quot;view_toolbars_popup&quot;&gt;</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+    &lt;!-- gets disabled but stays visible when not legal --&gt;</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+    &lt;menuitem id=&quot;view_toolbars_popup_quickFilterBar&quot;</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+              insertbefore=&quot;viewMenuBeforeCustomizeMailToolbarsSeparator&quot;</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+              label=&quot;&amp;quickFilterBar.toggleBarVisibility.menu.label;&quot;</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+              accesskey=&quot;&amp;quickFilterBar.toggleBarVisibility.menu.accesskey;&quot;</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+              command=&quot;cmd_toggleQuickFilterBar&quot;</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+              observes=&quot;qfb-show-filter-bar&quot;</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+              key=&quot;key_find&quot;</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+              /&gt;</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+  &lt;/menupopup&gt;</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+  &lt;hbox id=&quot;thunderbird-private-tabmail-buttons&quot;&gt;</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+    &lt;!-- gets hidden but keeps space allocation when not legal--&gt;</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+    &lt;toolbarbutton id=&quot;qfb-show-filter-bar&quot; type=&quot;checkbox&quot;</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+                   command=&quot;cmd_toggleQuickFilterBar&quot;</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+                   tooltiptext=&quot;&amp;quickFilterBar.toggleBarVisibility.button.tooltip;&quot;</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+                   /&gt;</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+  &lt;/hbox&gt;</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineplus">+  &lt;popupset id=&quot;mainPopupSet&quot;&gt;</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineplus">+    &lt;!-- Using an actual panel resulted in serious focus problems on linux,</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineplus">+         even with noautofocus=true.  It would appear the window manager does</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+         not buy into what we are selling in that case, whereas I presume the</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+         specialization that precludes tooltips from ever having focus prevents</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+         that problem from happening. --&gt;</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+    &lt;tooltip id=&quot;qfb-text-search-upsell&quot;</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+             level=&quot;parent&quot;</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+             style=&quot;background-color: #ffeeee;&quot;</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+           &gt;</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+      &lt;vbox&gt;</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+        &lt;label id=&quot;qfb-upsell-line-one&quot;</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+               class=&quot;header&quot;</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+               fmt=&quot;&amp;quickFilterBar.glodaUpsell.continueSearch;&quot;</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineplus">+               value=&quot;&quot;</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineplus">+               /&gt;</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+        &lt;label id=&quot;qfb-upsell-line-two&quot;</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+               fmt=&quot;&amp;quickFilterBar.glodaUpsell.pressEnterAndCurrent;&quot;</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineplus">+               value=&quot;&quot;</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineplus">+               /&gt;</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineplus">+      &lt;/vbox&gt;</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineplus">+    &lt;/tooltip&gt;</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+  &lt;/popupset&gt;</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineplus">+  &lt;vbox id=&quot;threadContentArea&quot;&gt;</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineplus">+    &lt;!--</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineplus">+      - The message filter bar is not a XBL binding at this time in order to</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineplus">+      - make it easier for people to overlay given that we are likely leaving</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineplus">+      - a lot of visible space on the table.</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineplus">+      -</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineplus">+      - This may need to change for drag-and-drop or other reasons.</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineplus">+      --&gt;</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineplus">+    &lt;vbox id=&quot;quick-filter-bar&quot; insertbefore=&quot;threadTree&quot;&gt;</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineplus">+      &lt;hbox id=&quot;quick-filter-bar-main-bar&quot; align=&quot;center&quot;</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineplus">+            onoverflow=&quot;QuickFilterBarMuxer.onOverflow();&quot;</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineplus">+            &gt;</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineplus">+        &lt;toolbarbutton id=&quot;qfb-sticky&quot; type=&quot;checkbox&quot;</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineplus">+                       crop=&quot;none&quot; minwidth=&quot;16&quot;</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineplus">+                       tooltiptext=&quot;&amp;quickFilterBar.sticky.tooltip;&quot;</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineplus">+                       /&gt;</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineplus">+        &lt;label id=&quot;qfb-filter-label&quot;</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineplus">+               value=&quot;&amp;quickFilterBar.barLabel.label;&quot;/&gt;</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+        &lt;!-- Extensions, put your labeled buttons in the following box. --&gt;</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineplus">+        &lt;hbox id=&quot;quick-filter-bar-collapsible-buttons&quot;&gt;</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineplus">+          &lt;toolbarbutton id=&quot;qfb-unread&quot; type=&quot;checkbox&quot;</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineplus">+                         crop=&quot;none&quot; minwidth=&quot;16&quot;</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineplus">+                         label=&quot;&amp;quickFilterBar.unread.label;&quot;</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineplus">+                         tooltiptext=&quot;&amp;quickFilterBar.unread.tooltip;&quot;</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineplus">+                         /&gt;</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+          &lt;toolbarbutton id=&quot;qfb-starred&quot; type=&quot;checkbox&quot;</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineplus">+                         crop=&quot;none&quot; minwidth=&quot;16&quot;</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineplus">+                         label=&quot;&amp;quickFilterBar.starred.label;&quot;</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineplus">+                         tooltiptext=&quot;&amp;quickFilterBar.starred.tooltip;&quot;</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineplus">+                         /&gt;</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineplus">+          &lt;toolbarbutton id=&quot;qfb-inaddrbook&quot; type=&quot;checkbox&quot;</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineplus">+                         crop=&quot;none&quot; minwidth=&quot;16&quot;</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineplus">+                         label=&quot;&amp;quickFilterBar.inaddrbook.label;&quot;</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineplus">+                         tooltiptext=&quot;&amp;quickFilterBar.inaddrbook.tooltip;&quot;</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineplus">+                         /&gt;</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineplus">+          &lt;toolbarbutton id=&quot;qfb-tags&quot; type=&quot;checkbox&quot;</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineplus">+                         crop=&quot;none&quot; minwidth=&quot;16&quot;</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineplus">+                         label=&quot;&amp;quickFilterBar.tags.label;&quot;</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineplus">+                         tooltiptext=&quot;&amp;quickFilterBar.tags.tooltip;&quot;</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineplus">+                         /&gt;</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineplus">+          &lt;toolbarbutton id=&quot;qfb-attachment&quot; type=&quot;checkbox&quot;</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineplus">+                         crop=&quot;none&quot; minwidth=&quot;16&quot;</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineplus">+                         label=&quot;&amp;quickFilterBar.attachment.label;&quot;</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineplus">+                         tooltiptext=&quot;&amp;quickFilterBar.attachment.tooltip;&quot;/&gt;</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineplus">+        &lt;/hbox&gt;</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineplus">+        &lt;toolbarspacer id=&quot;qfb-filter-bar-spacer&quot; flex=&quot;200&quot; align=&quot;end&quot;/&gt;</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineplus">+        &lt;!-- I added a minwidth and end text-align because otherwise the change</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineplus">+             in dimensions causes ugly flex rearrangement of the textbox. --&gt;</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineplus">+        &lt;label id=&quot;qfb-results-label&quot;</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineplus">+               minwidth=&quot;&amp;quickFilterBar.resultsLabel.minWidth;&quot;</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineplus">+               value=&quot;&quot;</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineplus">+               somefmtstring=&quot;&amp;quickFilterBar.resultsLabel.some.formatString;&quot;</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineplus">+               noresultsstring=&quot;&amp;quickFilterBar.resultsLabel.none;&quot;</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineplus">+               /&gt;</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineplus">+        &lt;textbox id=&quot;qfb-qs-textbox&quot; flex=&quot;1&quot;</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineplus">+                 type=&quot;search&quot;</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineplus">+                 emptytext=&quot;&quot;</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineplus">+                 emptytextbase=&quot;&amp;quickFilterBar.textbox.emptyText.base;&quot;</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineplus">+                 keyLabelNonMac=&quot;&amp;quickFilterBar.textbox.emptyText.keyLabel.nonmac;&quot;</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineplus">+                 keyLabelMac=&quot;&amp;quickFilterBar.textbox.emptyText.keyLabel.mac;&quot;</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineplus">+                 timeout=&quot;500&quot;</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineplus">+                 width=&quot;320&quot;</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineplus">+                 minwidth=&quot;280&quot;&gt;</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineplus">+        &lt;/textbox&gt;</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineplus">+      &lt;/hbox&gt;</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineplus">+      &lt;hbox id=&quot;quick-filter-bar-expando&quot;&gt;</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineplus">+        &lt;arrowscrollbox id=&quot;quick-filter-bar-tab-bar&quot;</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineplus">+                        orient=&quot;horizontal&quot;</span>
<a href="#l9.167"></a><span id="l9.167" class="difflineplus">+                        collapsed=&quot;true&quot;</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineplus">+                        flex=&quot;2&quot;&gt;</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineplus">+        &lt;/arrowscrollbox&gt;</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineplus">+        &lt;hbox id=&quot;quick-filter-bar-filter-text-bar&quot;</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineplus">+              collapsed=&quot;true&quot;</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineplus">+              pack=&quot;end&quot;</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineplus">+              align=&quot;center&quot;</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineplus">+              flex=&quot;1&quot;&gt;</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineplus">+          &lt;label id=&quot;qfb-qs-label&quot; value=&quot;Filter message by:&quot;/&gt;</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineplus">+          &lt;toolbarbutton id=&quot;qfb-qs-sender&quot; type=&quot;checkbox&quot;</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineplus">+                         label=&quot;&amp;quickFilterBar.textFilter.sender.label;&quot; /&gt;</span>
<a href="#l9.178"></a><span id="l9.178" class="difflineplus">+          &lt;toolbarbutton id=&quot;qfb-qs-recipients&quot; type=&quot;checkbox&quot;</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineplus">+                         label=&quot;&amp;quickFilterBar.textFilter.recipients.label;&quot; /&gt;</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineplus">+          &lt;toolbarbutton id=&quot;qfb-qs-subject&quot; type=&quot;checkbox&quot;</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineplus">+                         label=&quot;&amp;quickFilterBar.textFilter.subject.label;&quot; /&gt;</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineplus">+          &lt;toolbarbutton id=&quot;qfb-qs-body&quot; type=&quot;checkbox&quot;</span>
<a href="#l9.183"></a><span id="l9.183" class="difflineplus">+                         label=&quot;&amp;quickFilterBar.textFilter.body.label;&quot; /&gt;</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineplus">+        &lt;/hbox&gt;</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineplus">+      &lt;/hbox&gt;</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineplus">+    &lt;/vbox&gt;</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineplus">+  &lt;/vbox&gt;</span>
<a href="#l9.188"></a><span id="l9.188" class="difflineplus">+&lt;/overlay&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/base/content/search.xml</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/base/content/search.xml</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -53,159 +53,59 @@</span>
<a href="#l10.4"></a><span id="l10.4"> </span>
<a href="#l10.5"></a><span id="l10.5">   &lt;!--</span>
<a href="#l10.6"></a><span id="l10.6">     - The glodaSearch binding implements a gloda-backed search mechanism.  The</span>
<a href="#l10.7"></a><span id="l10.7">     -  actual search logic comes from the glodaFacet tab mode in the</span>
<a href="#l10.8"></a><span id="l10.8">     -  glodaFacetTabType definition.  This binding serves as a means to display</span>
<a href="#l10.9"></a><span id="l10.9">     -  and alter the current search query if a &quot;glodaFacet&quot; tab is displayed,</span>
<a href="#l10.10"></a><span id="l10.10">     -  or enter a search query and spawn a new &quot;glodaFacet&quot; tab if one is</span>
<a href="#l10.11"></a><span id="l10.11">     -  currently not displayed.</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+    -</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+    - This widget used to have many weird implementation nuances.  Now we are</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+    -  just a little bit of extra stuff on top of the toolkit autocomplete</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+    -  implementation.  Our deviations are:</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+    -  - We collapse ourselves when gloda is disabled; we track the state.</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+    -  -</span>
<a href="#l10.18"></a><span id="l10.18">     --&gt;</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-  &lt;binding id=&quot;glodaSearch&quot; extends=&quot;chrome://global/content/bindings/autocomplete.xml#autocomplete&quot;&gt;</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+  &lt;binding id=&quot;glodaSearch&quot;</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+           extends=&quot;chrome://global/content/bindings/autocomplete.xml#autocomplete&quot;&gt;</span>
<a href="#l10.22"></a><span id="l10.22">     &lt;resources&gt;</span>
<a href="#l10.23"></a><span id="l10.23">       &lt;stylesheet src=&quot;chrome://messenger/skin/searchBox.css&quot;/&gt;</span>
<a href="#l10.24"></a><span id="l10.24">     &lt;/resources&gt;</span>
<a href="#l10.25"></a><span id="l10.25"> </span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-    &lt;content&gt;</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-      &lt;xul:button anonid=&quot;quick-search-button&quot; class=&quot;quick-search-button&quot; type=&quot;menu&quot;&gt;</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-        &lt;xul:menupopup anonid=&quot;quick-search-menupopup&quot;</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-                   class=&quot;quick-search-menupopup&quot;</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-                   persist=&quot;value&quot;</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-                   onpopupshowing=&quot;this.parentNode.parentNode.updatePopup();&quot;</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-                   popupalign=&quot;topleft&quot;</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-                   popupanchor=&quot;bottomleft&quot;&gt;</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-          &lt;xul:menuitem anonid=&quot;searchGlobalMenu&quot;</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-                    class=&quot;quick-search-menu&quot;</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-                    value=&quot;global&quot;</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-                    glodaOnly=&quot;true&quot;</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-                    label=&quot;&amp;searchAllMessages.label;&quot;</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-                    type=&quot;radio&quot;</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-                    oncommand=&quot;this.parentNode.parentNode.parentNode.changeMode(this)&quot;/&gt;</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-          &lt;xul:menuseparator quicksearchOnly=&quot;true&quot;</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-                             glodaOnly=&quot;true&quot;/&gt;</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-        &lt;/xul:menupopup&gt;</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-      &lt;/xul:button&gt;</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-      &lt;xul:hbox class=&quot;quick-search-textbox textbox-input-box&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-        &lt;html:input class=&quot;textbox-input&quot; flex=&quot;1&quot; anonid=&quot;input&quot; allowevents=&quot;true&quot;</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-                    xbl:inherits=&quot;onfocus,onblur,oninput,value,type,maxlength,disabled,size,readonly,tabindex,accesskey&quot;/&gt;</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-      &lt;/xul:hbox&gt;</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-      &lt;xul:toolbarbutton anonid=&quot;quick-search-clearbutton&quot; xbl:inherits=&quot;&quot;</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-                         disabled=&quot;true&quot; class=&quot;quick-search-clearbutton&quot;</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-                         onclick=&quot;this.parentNode.value = ''; this.parentNode.doSearch(); this.parentNode.select(); return false;&quot;/&gt;</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-                         &lt;!--XXX update search if not global--&gt;</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-    &lt;/content&gt;</span>
<a href="#l10.55"></a><span id="l10.55">     &lt;handlers&gt;</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-      &lt;handler event=&quot;input&quot;&gt;</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-        &lt;![CDATA[</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-        try {</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineminus">-          if (this.searchMode != &quot;global&quot;) { // it's a quick search</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-            let dis = this;</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-            clearTimeout(this.timeoutHandler);</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineminus">-            this.timeoutHandler = setTimeout(this.onTimeout, this.timeout, dis);</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineminus">-          }</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineminus">-        } catch (e) {</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineminus">-          logException(e);</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineminus">-        }</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineminus">-        ]]&gt;</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineminus">-      &lt;/handler&gt;</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-      &lt;!-- For the next two, we need to get in on the bubbling phase, as</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineminus">-           otherwise we'll be doing searches when autocomplete results are</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-           being selected. --&gt;</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineminus">-      &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_ENTER&quot;</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineminus">-        phase=&quot;bubbling&quot; action=&quot;return this.doSearch();&quot;/&gt;</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineminus">-      &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_RETURN&quot;</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineminus">-        phase=&quot;bubbling&quot;&gt;</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineminus">-        &lt;![CDATA[</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineminus">-          try {</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineminus">-            this.doSearch();</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineminus">-          } catch (e) {</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineminus">-            logException(e);</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineminus">-          }</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineminus">-          return true;</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineminus">-        ]]&gt;</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineminus">-      &lt;/handler&gt;</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineminus">-      &lt;handler event=&quot;input&quot;&gt;</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineminus">-        &lt;![CDATA[</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineminus">-          if (!this.value)</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineminus">-            this.clearButtonHidden = true;</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineminus">-          else</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineminus">-            this.clearButtonHidden = false;</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineminus">-        ]]&gt;&lt;/handler&gt;</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineminus">-      &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_DOWN&quot; modifiers=&quot;alt&quot;</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineminus">-               phase=&quot;capturing&quot; action=&quot;return this.openmenupopup();&quot;/&gt;</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineminus">-      &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_UP&quot;   modifiers=&quot;alt&quot;</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineminus">-               phase=&quot;capturing&quot; action=&quot;return this.openmenupopup();&quot;/&gt;</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineminus">-      &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_F4&quot; phase=&quot;capturing&quot;&gt;&lt;![CDATA[</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineminus">-        if (window.navigator.oscpu.substring(0, 3).toLowerCase() != &quot;mac&quot;)</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineminus">-          return this.openmenupopup();</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineplus">+      &lt;handler event=&quot;drop&quot; phase=&quot;capturing&quot;&gt;&lt;![CDATA[</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+        nsDragAndDrop.drop(event, this.searchInputDNDObserver);</span>
<a href="#l10.101"></a><span id="l10.101">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l10.102"></a><span id="l10.102"> </span>
<a href="#l10.103"></a><span id="l10.103" class="difflineminus">-      &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_UP&quot; modifiers=&quot;control&quot;</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineminus">-               phase=&quot;capturing&quot;&gt;</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineminus">-        &lt;![CDATA[</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineminus">-        try {</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineminus">-          var menuPopupValue = this.menupopup.getAttribute('value');</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineminus">-          var menuItem =</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineminus">-            this.menupopup.getElementsByAttribute('value', this.searchMode)[0];</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineminus">-          if (menuItem != this.menupopup.firstChild) {</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineminus">-            let previousMenuItem = menuItem.previousSibling;</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineminus">-            while (! previousMenuItem.hasAttribute(&quot;value&quot;) &amp;&amp;</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineminus">-                   previousMenuItem != this.menupopup.firstChild)</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineminus">-              previousMenuItem = previousMenuItem.previousSibling;</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineminus">-</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineminus">-            previousMenuItem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineminus">-            menuItem.removeAttribute(&quot;checked&quot;);</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineminus">-            this.searchMode = previousMenuItem.getAttribute('value');</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineminus">-            this.menupopup.setAttribute('value', this.searchMode);</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineminus">-          }</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineminus">-          return false;</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineminus">-        } catch (e) {</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineminus">-          logException(e);</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineminus">-        }</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineminus">-        ]]&gt;&lt;/handler&gt;</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineminus">-</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineminus">-      &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_DOWN&quot; modifiers=&quot;control&quot;</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineminus">-               phase=&quot;capturing&quot;&gt;</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineminus">-        &lt;![CDATA[</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineminus">-        try {</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineminus">-          var menuPopupValue = this.menupopup.getAttribute('value');</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineminus">-          var menuItem =</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineminus">-            this.menupopup.getElementsByAttribute('value', this.searchMode)[0];</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineminus">-          if (menuItem != this.menupopup.lastChild) {</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineminus">-            let nextMenuItem = menuItem.nextSibling;</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineminus">-            while (! nextMenuItem.hasAttribute(&quot;value&quot;) &amp;&amp;</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineminus">-                   nextMenuItem != this.menupopup.lastChild)</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineminus">-              nextMenuItem = nextMenuItem.nextSibling;</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineminus">-            nextMenuItem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineminus">-            menuItem.removeAttribute(&quot;checked&quot;);</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineminus">-            this.searchMode = nextMenuItem.getAttribute('value');</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineminus">-            this.menupopup.setAttribute('value', this.searchMode);</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineminus">-          }</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineminus">-          return false;</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineminus">-        } catch (e) {</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineminus">-          logException(e);</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineminus">-        }</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineminus">-        ]]&gt;&lt;/handler&gt;</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineminus">-</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineminus">-</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineminus">-      &lt;handler event=&quot;drop&quot; phase=&quot;capturing&quot;&gt;</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineminus">-        nsDragAndDrop.drop(event, this.searchInputDNDObserver);</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineminus">-      &lt;/handler&gt;</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineplus">+      &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_RETURN&quot;&gt;&lt;![CDATA[</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineplus">+        this.doSearch();</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineplus">+        event.preventDefault();</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineplus">+        event.stopPropagation();</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineplus">+      ]]&gt;&lt;/handler&gt;</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineplus">+      &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_ESCAPE&quot;&gt;&lt;![CDATA[</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineplus">+        this.clearSearch();</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineplus">+        event.preventDefault();</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineplus">+        event.stopPropagation();</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineplus">+      ]]&gt;&lt;/handler&gt;</span>
<a href="#l10.164"></a><span id="l10.164">     &lt;/handlers&gt;</span>
<a href="#l10.165"></a><span id="l10.165"> </span>
<a href="#l10.166"></a><span id="l10.166">     &lt;implementation implements=&quot;nsIObserver&quot;&gt;</span>
<a href="#l10.167"></a><span id="l10.167">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l10.168"></a><span id="l10.168">         const Cc = Components.classes;</span>
<a href="#l10.169"></a><span id="l10.169">         const Ci = Components.interfaces;</span>
<a href="#l10.170"></a><span id="l10.170">         const Cu = Components.utils;</span>
<a href="#l10.171"></a><span id="l10.171">         Cu.import(&quot;resource:///modules/errUtils.js&quot;);</span>
<a href="#l10.172"></a><span id="l10.172">         try {</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineminus">-          Cu.import(&quot;resource:///modules/StringBundle.js&quot;);</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineminus">-          Cu.import(&quot;resource:///modules/quickSearchManager.js&quot;);</span>
<a href="#l10.175"></a><span id="l10.175" class="difflineplus">+          this.setAttribute(</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineplus">+            &quot;emptytext&quot;,</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineplus">+            this.getAttribute(&quot;emptytextbase&quot;)</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineplus">+                 .replace(&quot;#1&quot;, this.getAttribute(</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineplus">+                                  Application.platformIsMac ?</span>
<a href="#l10.180"></a><span id="l10.180" class="difflineplus">+                                  &quot;keyLabelMac&quot; : &quot;keyLabelNonMac&quot;)));</span>
<a href="#l10.181"></a><span id="l10.181"> </span>
<a href="#l10.182"></a><span id="l10.182">           var prefBranch =</span>
<a href="#l10.183"></a><span id="l10.183">               Components.classes['@mozilla.org/preferences-service;1'].</span>
<a href="#l10.184"></a><span id="l10.184">               getService(Components.interfaces.nsIPrefBranch2);</span>
<a href="#l10.185"></a><span id="l10.185">           this.glodaCompleter =</span>
<a href="#l10.186"></a><span id="l10.186">             Components.classes[&quot;@mozilla.org/autocomplete/search;1?name=gloda&quot;]</span>
<a href="#l10.187"></a><span id="l10.187">                       .getService()</span>
<a href="#l10.188"></a><span id="l10.188">                       .wrappedJSObject;</span>
<a href="#l10.189"></a><span id="l10.189" class="difflineat">@@ -227,58 +127,19 @@</span>
<a href="#l10.190"></a><span id="l10.190">             // care, since we don't want to register observers in that scope.</span>
<a href="#l10.191"></a><span id="l10.191"> </span>
<a href="#l10.192"></a><span id="l10.192">             prefBranch.addObserver(&quot;mailnews.database.global.indexer.enabled&quot;,</span>
<a href="#l10.193"></a><span id="l10.193">                                    this._prefObserver, false);</span>
<a href="#l10.194"></a><span id="l10.194">             observerSvc.addObserver(this, &quot;autocomplete-did-enter-text&quot;, false);</span>
<a href="#l10.195"></a><span id="l10.195">             gSearchInputObserversRegistered = true;</span>
<a href="#l10.196"></a><span id="l10.196">           }</span>
<a href="#l10.197"></a><span id="l10.197"> </span>
<a href="#l10.198"></a><span id="l10.198" class="difflineminus">-          this.quickSearchStrings =</span>
<a href="#l10.199"></a><span id="l10.199" class="difflineminus">-            new StringBundle(</span>
<a href="#l10.200"></a><span id="l10.200" class="difflineminus">-              &quot;chrome://messenger/locale/quickSearch.properties&quot;);</span>
<a href="#l10.201"></a><span id="l10.201" class="difflineminus">-</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineminus">-          let quickSearchModes = QuickSearchManager.getSearchModes();</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineminus">-          for (let i = 0; i &lt; quickSearchModes.length; i++) {</span>
<a href="#l10.204"></a><span id="l10.204" class="difflineminus">-            let searchMode = quickSearchModes[i];</span>
<a href="#l10.205"></a><span id="l10.205" class="difflineminus">-            let value = searchMode[&quot;value&quot;];</span>
<a href="#l10.206"></a><span id="l10.206" class="difflineminus">-            let label = searchMode[&quot;label&quot;];</span>
<a href="#l10.207"></a><span id="l10.207" class="difflineminus">-            let menuitem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l10.208"></a><span id="l10.208" class="difflineminus">-            menuitem.setAttribute(&quot;value&quot;, value.toString());</span>
<a href="#l10.209"></a><span id="l10.209" class="difflineminus">-            menuitem.setAttribute(&quot;label&quot;, label);</span>
<a href="#l10.210"></a><span id="l10.210" class="difflineminus">-            menuitem.setAttribute(&quot;type&quot;, &quot;radio&quot;);</span>
<a href="#l10.211"></a><span id="l10.211" class="difflineminus">-            menuitem.setAttribute(&quot;quicksearchOnly&quot;, &quot;true&quot;);</span>
<a href="#l10.212"></a><span id="l10.212" class="difflineminus">-            menuitem.setAttribute(&quot;oncommand&quot;,</span>
<a href="#l10.213"></a><span id="l10.213" class="difflineminus">-              &quot;this.parentNode.parentNode.parentNode.changeMode(this)&quot;);</span>
<a href="#l10.214"></a><span id="l10.214" class="difflineminus">-            this.menupopup.appendChild(menuitem);</span>
<a href="#l10.215"></a><span id="l10.215" class="difflineminus">-          }</span>
<a href="#l10.216"></a><span id="l10.216" class="difflineminus">-</span>
<a href="#l10.217"></a><span id="l10.217" class="difflineminus">-          let separator = document.createElement(&quot;menuseparator&quot;);</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineminus">-          separator.setAttribute(&quot;quicksearchOnly&quot;, &quot;true&quot;);</span>
<a href="#l10.219"></a><span id="l10.219" class="difflineminus">-          this.menupopup.appendChild(separator);</span>
<a href="#l10.220"></a><span id="l10.220" class="difflineminus">-</span>
<a href="#l10.221"></a><span id="l10.221" class="difflineminus">-          let saveAsVF = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l10.222"></a><span id="l10.222" class="difflineminus">-          saveAsVF.setAttribute(&quot;anonid&quot;,</span>
<a href="#l10.223"></a><span id="l10.223" class="difflineminus">-                                &quot;quick-search-save-as-virtual-folder&quot;);</span>
<a href="#l10.224"></a><span id="l10.224" class="difflineminus">-          saveAsVF.setAttribute(&quot;label&quot;,</span>
<a href="#l10.225"></a><span id="l10.225" class="difflineminus">-            this.quickSearchStrings.get(&quot;saveAsVirtualFolder.label&quot;));</span>
<a href="#l10.226"></a><span id="l10.226" class="difflineminus">-          saveAsVF.setAttribute(&quot;quicksearchOnly&quot;, &quot;true&quot;);</span>
<a href="#l10.227"></a><span id="l10.227" class="difflineminus">-          saveAsVF.setAttribute(&quot;oncommand&quot;,</span>
<a href="#l10.228"></a><span id="l10.228" class="difflineminus">-            &quot;gFolderTreeController.newVirtualFolder(\</span>
<a href="#l10.229"></a><span id="l10.229" class="difflineminus">-              this.parentNode.parentNode.parentNode.value,\</span>
<a href="#l10.230"></a><span id="l10.230" class="difflineminus">-              gFolderDisplay.view.search.session.searchTerms);&quot;);</span>
<a href="#l10.231"></a><span id="l10.231" class="difflineminus">-          this.menupopup.appendChild(saveAsVF);</span>
<a href="#l10.232"></a><span id="l10.232" class="difflineminus">-</span>
<a href="#l10.233"></a><span id="l10.233" class="difflineminus">-          this.updateSaveItem();</span>
<a href="#l10.234"></a><span id="l10.234" class="difflineminus">-          this.input = &quot;&quot;;</span>
<a href="#l10.235"></a><span id="l10.235">           this.glodaEnabled =</span>
<a href="#l10.236"></a><span id="l10.236">             prefBranch.getBoolPref(&quot;mailnews.database.global.indexer.enabled&quot;);</span>
<a href="#l10.237"></a><span id="l10.237" class="difflineminus">-          this.searchMode = this.glodaEnabled ? &quot;global&quot; :</span>
<a href="#l10.238"></a><span id="l10.238" class="difflineminus">-            quickSearchModes[QuickSearchConstants.kQuickSearchFromOrSubject]</span>
<a href="#l10.239"></a><span id="l10.239" class="difflineminus">-              .value.toString();</span>
<a href="#l10.240"></a><span id="l10.240" class="difflineplus">+          this.collapsed = !this.glodaEnabled;</span>
<a href="#l10.241"></a><span id="l10.241">         } catch (e) {</span>
<a href="#l10.242"></a><span id="l10.242">           logException(e, true);</span>
<a href="#l10.243"></a><span id="l10.243">         }</span>
<a href="#l10.244"></a><span id="l10.244">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l10.245"></a><span id="l10.245"> </span>
<a href="#l10.246"></a><span id="l10.246">       &lt;destructor&gt;</span>
<a href="#l10.247"></a><span id="l10.247">         &lt;![CDATA[</span>
<a href="#l10.248"></a><span id="l10.248">           var prefBranch =</span>
<a href="#l10.249"></a><span id="l10.249" class="difflineat">@@ -298,122 +159,46 @@</span>
<a href="#l10.250"></a><span id="l10.250">         {</span>
<a href="#l10.251"></a><span id="l10.251">           if (topic == &quot;nsPref:changed&quot;) {</span>
<a href="#l10.252"></a><span id="l10.252">             subject.QueryInterface(Components.interfaces.nsIPrefBranch);</span>
<a href="#l10.253"></a><span id="l10.253">             switch (data) {</span>
<a href="#l10.254"></a><span id="l10.254">             case &quot;mailnews.database.global.indexer.enabled&quot;:</span>
<a href="#l10.255"></a><span id="l10.255">               this.inputSearch.glodaEnabled =</span>
<a href="#l10.256"></a><span id="l10.256">                 gPrefBranch.getBoolPref(</span>
<a href="#l10.257"></a><span id="l10.257">                   &quot;mailnews.database.global.indexer.enabled&quot;);</span>
<a href="#l10.258"></a><span id="l10.258" class="difflineminus">-              let quickSearchModes = QuickSearchManager.getSearchModes();</span>
<a href="#l10.259"></a><span id="l10.259" class="difflineminus">-              this.inputSearch.searchMode = this.inputSearch.glodaEnabled ?</span>
<a href="#l10.260"></a><span id="l10.260" class="difflineminus">-                &quot;global&quot; :</span>
<a href="#l10.261"></a><span id="l10.261" class="difflineminus">-                quickSearchModes[QuickSearchConstants.kQuickSearchFromOrSubject]</span>
<a href="#l10.262"></a><span id="l10.262" class="difflineminus">-                  .value.toString();</span>
<a href="#l10.263"></a><span id="l10.263" class="difflineplus">+              this.inputSearch.collapsed = !this.inputSearch.glodaEnabled;</span>
<a href="#l10.264"></a><span id="l10.264">               break;</span>
<a href="#l10.265"></a><span id="l10.265">             }</span>
<a href="#l10.266"></a><span id="l10.266">           }</span>
<a href="#l10.267"></a><span id="l10.267">         },</span>
<a href="#l10.268"></a><span id="l10.268"> </span>
<a href="#l10.269"></a><span id="l10.269">         QueryInterface: function(aIID)</span>
<a href="#l10.270"></a><span id="l10.270">         {</span>
<a href="#l10.271"></a><span id="l10.271">           if (aIID.equals(Components.interfaces.nsIObserver) ||</span>
<a href="#l10.272"></a><span id="l10.272">               aIID.equals(Components.interfaces.nsISupports))</span>
<a href="#l10.273"></a><span id="l10.273">             return this;</span>
<a href="#l10.274"></a><span id="l10.274">           throw Components.results.NS_NOINTERFACE;</span>
<a href="#l10.275"></a><span id="l10.275">         }</span>
<a href="#l10.276"></a><span id="l10.276">         });</span>
<a href="#l10.277"></a><span id="l10.277">       &lt;/field&gt;</span>
<a href="#l10.278"></a><span id="l10.278" class="difflineminus">-      &lt;field name=&quot;timeout&quot;&gt;200&lt;/field&gt;</span>
<a href="#l10.279"></a><span id="l10.279">       &lt;field name=&quot;glodaCompleter&quot;&gt;null&lt;/field&gt;</span>
<a href="#l10.280"></a><span id="l10.280" class="difflineminus">-      &lt;field name=&quot;ignoreClick&quot;&gt;false&lt;/field&gt;</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineminus">-      &lt;field name=&quot;quickSearchStrings&quot;&gt;null&lt;/field&gt;</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineminus">-      &lt;field name=&quot;mQuickSearchMode&quot;&gt;null&lt;/field&gt;</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineminus">-      &lt;field name=&quot;timeoutHandler&quot;&gt;null&lt;/field&gt;</span>
<a href="#l10.284"></a><span id="l10.284" class="difflineminus">-      &lt;property name=&quot;searchMode&quot;&gt;</span>
<a href="#l10.285"></a><span id="l10.285" class="difflineminus">-        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l10.286"></a><span id="l10.286" class="difflineminus">-          return this.mQuickSearchMode;</span>
<a href="#l10.287"></a><span id="l10.287" class="difflineminus">-        ]]&gt;&lt;/getter&gt;</span>
<a href="#l10.288"></a><span id="l10.288" class="difflineminus">-        &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l10.289"></a><span id="l10.289" class="difflineminus">-          this.mQuickSearchMode = val;</span>
<a href="#l10.290"></a><span id="l10.290" class="difflineminus">-          this.menupopup.setAttribute('value', val);</span>
<a href="#l10.291"></a><span id="l10.291" class="difflineminus">-          let tabmail = document.getElementById('tabmail');</span>
<a href="#l10.292"></a><span id="l10.292" class="difflineminus">-          if (tabmail) { /* if not in the customize toolbar */</span>
<a href="#l10.293"></a><span id="l10.293" class="difflineminus">-            let currentTabInfo = tabmail.currentTabInfo;</span>
<a href="#l10.294"></a><span id="l10.294" class="difflineminus">-            this.menupopup.getElementsByAttribute('value', this.searchMode)[0]</span>
<a href="#l10.295"></a><span id="l10.295" class="difflineminus">-                          .setAttribute('checked', 'true');</span>
<a href="#l10.296"></a><span id="l10.296" class="difflineminus">-            if (currentTabInfo)</span>
<a href="#l10.297"></a><span id="l10.297" class="difflineminus">-             currentTabInfo.searchMode = this.searchMode;</span>
<a href="#l10.298"></a><span id="l10.298" class="difflineminus">-            this.updateEmptyText();</span>
<a href="#l10.299"></a><span id="l10.299" class="difflineminus">-          }</span>
<a href="#l10.300"></a><span id="l10.300" class="difflineminus">-          this.setAttribute(&quot;autocompletesearchparam&quot;, val)</span>
<a href="#l10.301"></a><span id="l10.301" class="difflineminus">-        ]]&gt;&lt;/setter&gt;</span>
<a href="#l10.302"></a><span id="l10.302" class="difflineminus">-      &lt;/property&gt;</span>
<a href="#l10.303"></a><span id="l10.303" class="difflineminus">-      &lt;field name=&quot;_glodaEnabled&quot;/&gt;</span>
<a href="#l10.304"></a><span id="l10.304" class="difflineminus">-      &lt;property name=&quot;glodaEnabled&quot;&gt;</span>
<a href="#l10.305"></a><span id="l10.305" class="difflineminus">-        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l10.306"></a><span id="l10.306" class="difflineminus">-          return this._glodaEnabled</span>
<a href="#l10.307"></a><span id="l10.307" class="difflineminus">-        ]]&gt;&lt;/getter&gt;</span>
<a href="#l10.308"></a><span id="l10.308" class="difflineminus">-        &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l10.309"></a><span id="l10.309" class="difflineminus">-          try {</span>
<a href="#l10.310"></a><span id="l10.310" class="difflineminus">-            this.showGlodaItems(val); this._glodaEnabled = val;</span>
<a href="#l10.311"></a><span id="l10.311" class="difflineminus">-          } catch(e) {</span>
<a href="#l10.312"></a><span id="l10.312" class="difflineminus">-            logException(e);</span>
<a href="#l10.313"></a><span id="l10.313" class="difflineminus">-          }</span>
<a href="#l10.314"></a><span id="l10.314" class="difflineminus">-        ]]&gt;&lt;/setter&gt;</span>
<a href="#l10.315"></a><span id="l10.315" class="difflineminus">-      &lt;/property&gt;</span>
<a href="#l10.316"></a><span id="l10.316" class="difflineminus">-      &lt;property name=&quot;autocompletePopup&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l10.317"></a><span id="l10.317" class="difflineminus">-        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l10.318"></a><span id="l10.318" class="difflineminus">-          return document.getElementById(</span>
<a href="#l10.319"></a><span id="l10.319" class="difflineminus">-                   this.getAttribute('autocompletepopup'));</span>
<a href="#l10.320"></a><span id="l10.320" class="difflineminus">-        ]]&gt;&lt;/getter&gt;</span>
<a href="#l10.321"></a><span id="l10.321" class="difflineminus">-      &lt;/property&gt;</span>
<a href="#l10.322"></a><span id="l10.322" class="difflineminus">-      &lt;property name=&quot;showingSearchCriteria&quot;&gt;</span>
<a href="#l10.323"></a><span id="l10.323" class="difflineminus">-        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l10.324"></a><span id="l10.324" class="difflineminus">-          return this.getAttribute('searchCriteria') == 'true';</span>
<a href="#l10.325"></a><span id="l10.325" class="difflineminus">-        ]]&gt;&lt;/getter&gt;</span>
<a href="#l10.326"></a><span id="l10.326" class="difflineminus">-        &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l10.327"></a><span id="l10.327" class="difflineminus">-          this.setAttribute('searchCriteria', val); return val;</span>
<a href="#l10.328"></a><span id="l10.328" class="difflineminus">-        ]]&gt;&lt;/setter&gt;</span>
<a href="#l10.329"></a><span id="l10.329" class="difflineminus">-      &lt;/property&gt;</span>
<a href="#l10.330"></a><span id="l10.330">       &lt;property name=&quot;menupopup&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l10.331"></a><span id="l10.331">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l10.332"></a><span id="l10.332">           return document.getAnonymousElementByAttribute(</span>
<a href="#l10.333"></a><span id="l10.333">                    this, 'anonid', 'quick-search-menupopup');</span>
<a href="#l10.334"></a><span id="l10.334">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l10.335"></a><span id="l10.335">       &lt;/property&gt;</span>
<a href="#l10.336"></a><span id="l10.336" class="difflineminus">-      &lt;property name=&quot;saveAsVirtualFolder&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l10.337"></a><span id="l10.337" class="difflineminus">-        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l10.338"></a><span id="l10.338" class="difflineminus">-          return document.getAnonymousElementByAttribute(</span>
<a href="#l10.339"></a><span id="l10.339" class="difflineminus">-                   this, 'anonid', 'quick-search-save-as-virtual-folder');</span>
<a href="#l10.340"></a><span id="l10.340" class="difflineminus">-        ]]&gt;&lt;/getter&gt;</span>
<a href="#l10.341"></a><span id="l10.341" class="difflineminus">-      &lt;/property&gt;</span>
<a href="#l10.342"></a><span id="l10.342" class="difflineminus">-      &lt;property name=&quot;clearButtonHidden&quot;&gt;</span>
<a href="#l10.343"></a><span id="l10.343" class="difflineminus">-        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l10.344"></a><span id="l10.344" class="difflineminus">-          return document.getAnonymousElementByAttribute(</span>
<a href="#l10.345"></a><span id="l10.345" class="difflineminus">-                            this, 'anonid', 'quick-search-clearbutton')</span>
<a href="#l10.346"></a><span id="l10.346" class="difflineminus">-                         .getAttribute('clearButtonHidden') == 'true';</span>
<a href="#l10.347"></a><span id="l10.347" class="difflineminus">-        ]]&gt;&lt;/getter&gt;</span>
<a href="#l10.348"></a><span id="l10.348" class="difflineminus">-        &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l10.349"></a><span id="l10.349" class="difflineminus">-          document.getAnonymousElementByAttribute(</span>
<a href="#l10.350"></a><span id="l10.350" class="difflineminus">-                     this, 'anonid', 'quick-search-clearbutton')</span>
<a href="#l10.351"></a><span id="l10.351" class="difflineminus">-                  .setAttribute('clearButtonHidden', val);</span>
<a href="#l10.352"></a><span id="l10.352" class="difflineminus">-          return val;</span>
<a href="#l10.353"></a><span id="l10.353" class="difflineminus">-        ]]&gt;&lt;/setter&gt;</span>
<a href="#l10.354"></a><span id="l10.354" class="difflineminus">-      &lt;/property&gt;</span>
<a href="#l10.355"></a><span id="l10.355"> </span>
<a href="#l10.356"></a><span id="l10.356">       &lt;property name=&quot;state&quot;&gt;</span>
<a href="#l10.357"></a><span id="l10.357">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l10.358"></a><span id="l10.358">           return {</span>
<a href="#l10.359"></a><span id="l10.359" class="difflineminus">-            'mode': this.searchMode,</span>
<a href="#l10.360"></a><span id="l10.360">             'string': this.value</span>
<a href="#l10.361"></a><span id="l10.361">           };</span>
<a href="#l10.362"></a><span id="l10.362">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l10.363"></a><span id="l10.363">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l10.364"></a><span id="l10.364" class="difflineminus">-          this.searchMode = val['mode'];</span>
<a href="#l10.365"></a><span id="l10.365">           this.value = val['string'];</span>
<a href="#l10.366"></a><span id="l10.366">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l10.367"></a><span id="l10.367">       &lt;/property&gt;</span>
<a href="#l10.368"></a><span id="l10.368"> </span>
<a href="#l10.369"></a><span id="l10.369">       // DND Observer</span>
<a href="#l10.370"></a><span id="l10.370">       &lt;field name=&quot;searchInputDNDObserver&quot; readonly=&quot;true&quot;&gt;&lt;![CDATA[</span>
<a href="#l10.371"></a><span id="l10.371">       ({</span>
<a href="#l10.372"></a><span id="l10.372">         inputSearch: this,</span>
<a href="#l10.373"></a><span id="l10.373" class="difflineat">@@ -435,64 +220,24 @@</span>
<a href="#l10.374"></a><span id="l10.374">         getSupportedFlavours: function () {</span>
<a href="#l10.375"></a><span id="l10.375">           var flavourSet = new FlavourSet();</span>
<a href="#l10.376"></a><span id="l10.376">           flavourSet.appendFlavour(&quot;text/unicode&quot;);</span>
<a href="#l10.377"></a><span id="l10.377">           return flavourSet;</span>
<a href="#l10.378"></a><span id="l10.378">         }</span>
<a href="#l10.379"></a><span id="l10.379">       })</span>
<a href="#l10.380"></a><span id="l10.380">       ]]&gt;&lt;/field&gt;</span>
<a href="#l10.381"></a><span id="l10.381"> </span>
<a href="#l10.382"></a><span id="l10.382" class="difflineminus">-      &lt;method name=&quot;onTimeout&quot;&gt;</span>
<a href="#l10.383"></a><span id="l10.383" class="difflineminus">-        &lt;parameter name=&quot;dis&quot;/&gt;</span>
<a href="#l10.384"></a><span id="l10.384" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l10.385"></a><span id="l10.385" class="difflineminus">-        try {</span>
<a href="#l10.386"></a><span id="l10.386" class="difflineminus">-          dis.doSearch();</span>
<a href="#l10.387"></a><span id="l10.387" class="difflineminus">-        } catch (e) {</span>
<a href="#l10.388"></a><span id="l10.388" class="difflineminus">-          logException(e);</span>
<a href="#l10.389"></a><span id="l10.389" class="difflineminus">-        }</span>
<a href="#l10.390"></a><span id="l10.390" class="difflineminus">-        ]]&gt;</span>
<a href="#l10.391"></a><span id="l10.391" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l10.392"></a><span id="l10.392" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l10.393"></a><span id="l10.393" class="difflineminus">-      &lt;method name=&quot;updatePopup&quot;&gt;</span>
<a href="#l10.394"></a><span id="l10.394" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l10.395"></a><span id="l10.395" class="difflineminus">-        try {</span>
<a href="#l10.396"></a><span id="l10.396" class="difflineminus">-          // disable the create virtual folder menu item if the current radio</span>
<a href="#l10.397"></a><span id="l10.397" class="difflineminus">-          // value is set to Find in message since you can't really  create a VF from find</span>
<a href="#l10.398"></a><span id="l10.398" class="difflineminus">-          // in message</span>
<a href="#l10.399"></a><span id="l10.399" class="difflineminus">-          if (this.searchMode == &quot;global&quot; || this.value == &quot;&quot;)</span>
<a href="#l10.400"></a><span id="l10.400" class="difflineminus">-            this.saveAsVirtualFolder.setAttribute('disabled', 'true');</span>
<a href="#l10.401"></a><span id="l10.401" class="difflineminus">-          else</span>
<a href="#l10.402"></a><span id="l10.402" class="difflineminus">-            this.saveAsVirtualFolder.removeAttribute('disabled');</span>
<a href="#l10.403"></a><span id="l10.403" class="difflineminus">-</span>
<a href="#l10.404"></a><span id="l10.404" class="difflineminus">-          //let hideQuickSearchModes = this.searchMode == &quot;global&quot; ? &quot;true&quot; : &quot;false&quot;;</span>
<a href="#l10.405"></a><span id="l10.405" class="difflineminus">-          //for each (let child in this.menupopup.childNodes) {</span>
<a href="#l10.406"></a><span id="l10.406" class="difflineminus">-          //  if (child.hasAttribute(&quot;quicksearch&quot;)) {</span>
<a href="#l10.407"></a><span id="l10.407" class="difflineminus">-          //    child.setAttribute(&quot;collapsed&quot;, hideQuickSearchModes)</span>
<a href="#l10.408"></a><span id="l10.408" class="difflineminus">-          //  }</span>
<a href="#l10.409"></a><span id="l10.409" class="difflineminus">-          //}</span>
<a href="#l10.410"></a><span id="l10.410" class="difflineminus">-        } catch (e) {</span>
<a href="#l10.411"></a><span id="l10.411" class="difflineminus">-          logException(e);</span>
<a href="#l10.412"></a><span id="l10.412" class="difflineminus">-        }</span>
<a href="#l10.413"></a><span id="l10.413" class="difflineminus">-        ]]&gt;</span>
<a href="#l10.414"></a><span id="l10.414" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l10.415"></a><span id="l10.415" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l10.416"></a><span id="l10.416" class="difflineminus">-      &lt;method name=&quot;build&quot;&gt;</span>
<a href="#l10.417"></a><span id="l10.417" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l10.418"></a><span id="l10.418" class="difflineminus">-</span>
<a href="#l10.419"></a><span id="l10.419" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l10.420"></a><span id="l10.420" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l10.421"></a><span id="l10.421" class="difflineminus">-</span>
<a href="#l10.422"></a><span id="l10.422">       &lt;method name=&quot;observe&quot;&gt;</span>
<a href="#l10.423"></a><span id="l10.423" class="difflineminus">-      &lt;parameter name=&quot;aSubject&quot;/&gt;</span>
<a href="#l10.424"></a><span id="l10.424" class="difflineminus">-      &lt;parameter name=&quot;aTopic&quot;/&gt;</span>
<a href="#l10.425"></a><span id="l10.425" class="difflineminus">-      &lt;parameter name=&quot;aData&quot;/&gt;</span>
<a href="#l10.426"></a><span id="l10.426" class="difflineplus">+        &lt;parameter name=&quot;aSubject&quot;/&gt;</span>
<a href="#l10.427"></a><span id="l10.427" class="difflineplus">+        &lt;parameter name=&quot;aTopic&quot;/&gt;</span>
<a href="#l10.428"></a><span id="l10.428" class="difflineplus">+        &lt;parameter name=&quot;aData&quot;/&gt;</span>
<a href="#l10.429"></a><span id="l10.429">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l10.430"></a><span id="l10.430">         try {</span>
<a href="#l10.431"></a><span id="l10.431">           if (aTopic == &quot;autocomplete-did-enter-text&quot;) {</span>
<a href="#l10.432"></a><span id="l10.432" class="difflineminus">-            let selectedIndex = this.autocompletePopup.selectedIndex;</span>
<a href="#l10.433"></a><span id="l10.433" class="difflineplus">+            let selectedIndex = this.popup.selectedIndex;</span>
<a href="#l10.434"></a><span id="l10.434">             let curResult = this.glodaCompleter.curResult;</span>
<a href="#l10.435"></a><span id="l10.435">             if (! curResult)</span>
<a href="#l10.436"></a><span id="l10.436">               return; // autocomplete didn't even finish.</span>
<a href="#l10.437"></a><span id="l10.437">             let row = curResult.getObjectAt(selectedIndex);</span>
<a href="#l10.438"></a><span id="l10.438">             if (row == null)</span>
<a href="#l10.439"></a><span id="l10.439">               return;</span>
<a href="#l10.440"></a><span id="l10.440">             let theQuery = Gloda.newQuery(Gloda.NOUN_MESSAGE);</span>
<a href="#l10.441"></a><span id="l10.441">             let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l10.442"></a><span id="l10.442" class="difflineat">@@ -513,172 +258,50 @@</span>
<a href="#l10.443"></a><span id="l10.443">             }</span>
<a href="#l10.444"></a><span id="l10.444">           }</span>
<a href="#l10.445"></a><span id="l10.445">         } catch (e) {</span>
<a href="#l10.446"></a><span id="l10.446">           logException(e);</span>
<a href="#l10.447"></a><span id="l10.447">         }</span>
<a href="#l10.448"></a><span id="l10.448">         ]]&gt;&lt;/body&gt;</span>
<a href="#l10.449"></a><span id="l10.449">       &lt;/method&gt;</span>
<a href="#l10.450"></a><span id="l10.450"> </span>
<a href="#l10.451"></a><span id="l10.451" class="difflineminus">-      &lt;method name=&quot;updateEmptyText&quot;&gt;</span>
<a href="#l10.452"></a><span id="l10.452" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l10.453"></a><span id="l10.453" class="difflineminus">-        try {</span>
<a href="#l10.454"></a><span id="l10.454" class="difflineminus">-          // extract the label value from the menu item</span>
<a href="#l10.455"></a><span id="l10.455" class="difflineminus">-          let menuItem = this.menupopup.getElementsByAttribute('value',</span>
<a href="#l10.456"></a><span id="l10.456" class="difflineminus">-                          this.searchMode)[0];</span>
<a href="#l10.457"></a><span id="l10.457" class="difflineminus">-          this.emptyText = menuItem.getAttribute('label');</span>
<a href="#l10.458"></a><span id="l10.458" class="difflineminus">-        } catch (e) {</span>
<a href="#l10.459"></a><span id="l10.459" class="difflineminus">-          logException(e);</span>
<a href="#l10.460"></a><span id="l10.460" class="difflineminus">-        }</span>
<a href="#l10.461"></a><span id="l10.461" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l10.462"></a><span id="l10.462" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l10.463"></a><span id="l10.463" class="difflineminus">-</span>
<a href="#l10.464"></a><span id="l10.464" class="difflineminus">-      &lt;method name=&quot;updateSaveItem&quot;&gt;</span>
<a href="#l10.465"></a><span id="l10.465" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l10.466"></a><span id="l10.466" class="difflineminus">-          let disabled = true;</span>
<a href="#l10.467"></a><span id="l10.467" class="difflineminus">-          this.saveAsVirtualFolder.setAttribute(&quot;disabled&quot;, disabled)</span>
<a href="#l10.468"></a><span id="l10.468" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l10.469"></a><span id="l10.469" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l10.470"></a><span id="l10.470" class="difflineminus">-</span>
<a href="#l10.471"></a><span id="l10.471" class="difflineminus">-</span>
<a href="#l10.472"></a><span id="l10.472">       &lt;method name=&quot;doSearch&quot;&gt;</span>
<a href="#l10.473"></a><span id="l10.473">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l10.474"></a><span id="l10.474">           try {</span>
<a href="#l10.475"></a><span id="l10.475" class="difflineminus">-            if (this.searchMode == 'global') // faceted search</span>
<a href="#l10.476"></a><span id="l10.476" class="difflineminus">-            {</span>
<a href="#l10.477"></a><span id="l10.477" class="difflineminus">-              if (this.value) {</span>
<a href="#l10.478"></a><span id="l10.478" class="difflineminus">-                let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l10.479"></a><span id="l10.479" class="difflineminus">-                // If the current tab is a gloda search tab, reset the value</span>
<a href="#l10.480"></a><span id="l10.480" class="difflineminus">-                //  to the initial search value.  Otherwise, clear it.  This</span>
<a href="#l10.481"></a><span id="l10.481" class="difflineminus">-                //  is the value that 3is going to be saved with the current</span>
<a href="#l10.482"></a><span id="l10.482" class="difflineminus">-                //  tab when we switch back to it next.</span>
<a href="#l10.483"></a><span id="l10.483" class="difflineminus">-                let searchString = this.value;</span>
<a href="#l10.484"></a><span id="l10.484" class="difflineplus">+            if (this.value) {</span>
<a href="#l10.485"></a><span id="l10.485" class="difflineplus">+              let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l10.486"></a><span id="l10.486" class="difflineplus">+              // If the current tab is a gloda search tab, reset the value</span>
<a href="#l10.487"></a><span id="l10.487" class="difflineplus">+              //  to the initial search value.  Otherwise, clear it.  This</span>
<a href="#l10.488"></a><span id="l10.488" class="difflineplus">+              //  is the value that 3is going to be saved with the current</span>
<a href="#l10.489"></a><span id="l10.489" class="difflineplus">+              //  tab when we switch back to it next.</span>
<a href="#l10.490"></a><span id="l10.490" class="difflineplus">+              let searchString = this.value;</span>
<a href="#l10.491"></a><span id="l10.491"> </span>
<a href="#l10.492"></a><span id="l10.492" class="difflineminus">-                if (tabmail.currentTabInfo.mode.name == &quot;glodaFacet&quot;) {</span>
<a href="#l10.493"></a><span id="l10.493" class="difflineminus">-                  // we'd rather reuse the existing tab (and somehow do something</span>
<a href="#l10.494"></a><span id="l10.494" class="difflineminus">-                  // smart with any preexisting facet choices, but that's a</span>
<a href="#l10.495"></a><span id="l10.495" class="difflineminus">-                  // bit hard right now, so doing the cheap thing and closing</span>
<a href="#l10.496"></a><span id="l10.496" class="difflineminus">-                  // this tab and starting over</span>
<a href="#l10.497"></a><span id="l10.497" class="difflineminus">-                  tabmail.closeTab();</span>
<a href="#l10.498"></a><span id="l10.498" class="difflineminus">-                }</span>
<a href="#l10.499"></a><span id="l10.499" class="difflineminus">-                this.value = ''; // clear our value, to avoid persistence</span>
<a href="#l10.500"></a><span id="l10.500" class="difflineminus">-                if (gFolderDisplay.view) {</span>
<a href="#l10.501"></a><span id="l10.501" class="difflineminus">-                  // if we started out from a gFolderDisplay.view,</span>
<a href="#l10.502"></a><span id="l10.502" class="difflineminus">-                  // remove existing (non-global) filter from view, to avoid persistence</span>
<a href="#l10.503"></a><span id="l10.503" class="difflineminus">-                  gFolderDisplay.view.search.userTerms = null;</span>
<a href="#l10.504"></a><span id="l10.504" class="difflineminus">-                }</span>
<a href="#l10.505"></a><span id="l10.505" class="difflineminus">-                tabmail.openTab(&quot;glodaFacet&quot;, {</span>
<a href="#l10.506"></a><span id="l10.506" class="difflineminus">-                  searcher: new GlodaMsgSearcher(null, searchString)</span>
<a href="#l10.507"></a><span id="l10.507" class="difflineminus">-                });</span>
<a href="#l10.508"></a><span id="l10.508" class="difflineplus">+              if (tabmail.currentTabInfo.mode.name == &quot;glodaFacet&quot;) {</span>
<a href="#l10.509"></a><span id="l10.509" class="difflineplus">+                // we'd rather reuse the existing tab (and somehow do something</span>
<a href="#l10.510"></a><span id="l10.510" class="difflineplus">+                // smart with any preexisting facet choices, but that's a</span>
<a href="#l10.511"></a><span id="l10.511" class="difflineplus">+                // bit hard right now, so doing the cheap thing and closing</span>
<a href="#l10.512"></a><span id="l10.512" class="difflineplus">+                // this tab and starting over</span>
<a href="#l10.513"></a><span id="l10.513" class="difflineplus">+                tabmail.closeTab();</span>
<a href="#l10.514"></a><span id="l10.514">               }</span>
<a href="#l10.515"></a><span id="l10.515" class="difflineminus">-            } else { // quick search</span>
<a href="#l10.516"></a><span id="l10.516" class="difflineminus">-              if (!gFolderDisplay.view)</span>
<a href="#l10.517"></a><span id="l10.517" class="difflineminus">-                return;</span>
<a href="#l10.518"></a><span id="l10.518" class="difflineminus">-              if (! this.value)</span>
<a href="#l10.519"></a><span id="l10.519" class="difflineminus">-                gFolderDisplay.view.search.userTerms = null</span>
<a href="#l10.520"></a><span id="l10.520" class="difflineminus">-              else</span>
<a href="#l10.521"></a><span id="l10.521" class="difflineminus">-                gFolderDisplay.view.search.quickSearch(Number(this.searchMode), this.value);</span>
<a href="#l10.522"></a><span id="l10.522" class="difflineplus">+              this.value = ''; // clear our value, to avoid persistence</span>
<a href="#l10.523"></a><span id="l10.523" class="difflineplus">+              tabmail.openTab(&quot;glodaFacet&quot;, {</span>
<a href="#l10.524"></a><span id="l10.524" class="difflineplus">+                searcher: new GlodaMsgSearcher(null, searchString)</span>
<a href="#l10.525"></a><span id="l10.525" class="difflineplus">+              });</span>
<a href="#l10.526"></a><span id="l10.526">             }</span>
<a href="#l10.527"></a><span id="l10.527">           } catch (e) {</span>
<a href="#l10.528"></a><span id="l10.528">             logException(e);</span>
<a href="#l10.529"></a><span id="l10.529">           }</span>
<a href="#l10.530"></a><span id="l10.530">         ]]&gt;</span>
<a href="#l10.531"></a><span id="l10.531">         &lt;/body&gt;</span>
<a href="#l10.532"></a><span id="l10.532">       &lt;/method&gt;</span>
<a href="#l10.533"></a><span id="l10.533" class="difflineminus">-</span>
<a href="#l10.534"></a><span id="l10.534" class="difflineminus">-      &lt;method name=&quot;changeMode&quot;&gt;</span>
<a href="#l10.535"></a><span id="l10.535" class="difflineminus">-      &lt;parameter name=&quot;aMenuItem&quot; /&gt;</span>
<a href="#l10.536"></a><span id="l10.536" class="difflineplus">+      &lt;method name=&quot;clearSearch&quot;&gt;</span>
<a href="#l10.537"></a><span id="l10.537">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l10.538"></a><span id="l10.538" class="difflineminus">-          var oldSearchMode = this.searchMode;</span>
<a href="#l10.539"></a><span id="l10.539" class="difflineminus">-          this.searchMode = aMenuItem.value;</span>
<a href="#l10.540"></a><span id="l10.540" class="difflineminus">-          if (oldSearchMode != this.searchMode) // the search mode just changed so we need to redo the quick search</span>
<a href="#l10.541"></a><span id="l10.541" class="difflineminus">-            this.doSearch();</span>
<a href="#l10.542"></a><span id="l10.542" class="difflineplus">+          this.value = &quot;&quot;;</span>
<a href="#l10.543"></a><span id="l10.543">         ]]&gt;&lt;/body&gt;</span>
<a href="#l10.544"></a><span id="l10.544">       &lt;/method&gt;</span>
<a href="#l10.545"></a><span id="l10.545" class="difflineminus">-</span>
<a href="#l10.546"></a><span id="l10.546" class="difflineminus">-      &lt;method name=&quot;openmenupopup&quot;&gt;</span>
<a href="#l10.547"></a><span id="l10.547" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l10.548"></a><span id="l10.548" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l10.549"></a><span id="l10.549" class="difflineminus">-          try {</span>
<a href="#l10.550"></a><span id="l10.550" class="difflineminus">-            this.menupopup.click();</span>
<a href="#l10.551"></a><span id="l10.551" class="difflineminus">-          } catch (e) {</span>
<a href="#l10.552"></a><span id="l10.552" class="difflineminus">-            logException(e);</span>
<a href="#l10.553"></a><span id="l10.553" class="difflineminus">-          }</span>
<a href="#l10.554"></a><span id="l10.554" class="difflineminus">-          return false;</span>
<a href="#l10.555"></a><span id="l10.555" class="difflineminus">-          ]]&gt;</span>
<a href="#l10.556"></a><span id="l10.556" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l10.557"></a><span id="l10.557" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l10.558"></a><span id="l10.558" class="difflineminus">-</span>
<a href="#l10.559"></a><span id="l10.559" class="difflineminus">-</span>
<a href="#l10.560"></a><span id="l10.560" class="difflineminus">-      &lt;!--If switching from an &quot;incoming&quot; (Inbox, etc.) type of mail folder,--&gt;</span>
<a href="#l10.561"></a><span id="l10.561" class="difflineminus">-      &lt;!--to an &quot;outbound&quot; (Sent, Drafts etc.)  type, and the current search--&gt;</span>
<a href="#l10.562"></a><span id="l10.562" class="difflineminus">-      &lt;!--type contains 'Sender', then switch it to the equivalent--&gt;</span>
<a href="#l10.563"></a><span id="l10.563" class="difflineminus">-      &lt;!--'Recipient' search type by default. Vice versa when switching from--&gt;</span>
<a href="#l10.564"></a><span id="l10.564" class="difflineminus">-      &lt;!--outbound to incoming folder type.--&gt;</span>
<a href="#l10.565"></a><span id="l10.565" class="difflineminus">-      &lt;!--@param isOutboundFolder  Bool--&gt;</span>
<a href="#l10.566"></a><span id="l10.566" class="difflineminus">-      &lt;!--       true:  switch from an incoming to an outgoing folder--&gt;</span>
<a href="#l10.567"></a><span id="l10.567" class="difflineminus">-      &lt;!--       false: switch from an outgoing to an incoming folder--&gt;</span>
<a href="#l10.568"></a><span id="l10.568" class="difflineminus">-      &lt;method name=&quot;folderChanged&quot;&gt;</span>
<a href="#l10.569"></a><span id="l10.569" class="difflineminus">-        &lt;parameter name=&quot;isOutboundFolder&quot; /&gt;</span>
<a href="#l10.570"></a><span id="l10.570" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l10.571"></a><span id="l10.571" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l10.572"></a><span id="l10.572" class="difflineminus">-            let newSearchMode = null;</span>
<a href="#l10.573"></a><span id="l10.573" class="difflineminus">-            if (isOutboundFolder) {</span>
<a href="#l10.574"></a><span id="l10.574" class="difflineminus">-              if (this.searchMode == QuickSearchConstants.kQuickSearchFromOrSubject)</span>
<a href="#l10.575"></a><span id="l10.575" class="difflineminus">-                this.searchMode = QuickSearchConstants.kQuickSearchRecipientOrSubject;</span>
<a href="#l10.576"></a><span id="l10.576" class="difflineminus">-              else if (this.searchMode == QuickSearchConstants.kQuickSearchFrom)</span>
<a href="#l10.577"></a><span id="l10.577" class="difflineminus">-                this.searchMode = QuickSearchConstants.kQuickSearchRecipient;</span>
<a href="#l10.578"></a><span id="l10.578" class="difflineminus">-            } else {</span>
<a href="#l10.579"></a><span id="l10.579" class="difflineminus">-              if (this.searchMode == QuickSearchConstants.kQuickSearchRecipientOrSubject)</span>
<a href="#l10.580"></a><span id="l10.580" class="difflineminus">-                this.searchMode = QuickSearchConstants.kQuickSearchFromOrSubject;</span>
<a href="#l10.581"></a><span id="l10.581" class="difflineminus">-              else if (this.searchMode == QuickSearchConstants.kQuickSearchRecipient)</span>
<a href="#l10.582"></a><span id="l10.582" class="difflineminus">-                this.searchMode = QuickSearchConstants.kQuickSearchFrom;</span>
<a href="#l10.583"></a><span id="l10.583" class="difflineminus">-            }</span>
<a href="#l10.584"></a><span id="l10.584" class="difflineminus">-          ]]&gt;</span>
<a href="#l10.585"></a><span id="l10.585" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l10.586"></a><span id="l10.586" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l10.587"></a><span id="l10.587" class="difflineminus">-      &lt;!--</span>
<a href="#l10.588"></a><span id="l10.588" class="difflineminus">-        Called by the TabMonitor to make the quick search menu only show options that are relevant for a particular tab.</span>
<a href="#l10.589"></a><span id="l10.589" class="difflineminus">-        In particular, in faceted search results, no real mode choices are available.</span>
<a href="#l10.590"></a><span id="l10.590" class="difflineminus">-</span>
<a href="#l10.591"></a><span id="l10.591" class="difflineminus">-         @param showQSItems  Bool</span>
<a href="#l10.592"></a><span id="l10.592" class="difflineminus">-            true:  show quick search-relevant menu items</span>
<a href="#l10.593"></a><span id="l10.593" class="difflineminus">-            false: don't show quick search-relevant menu items</span>
<a href="#l10.594"></a><span id="l10.594" class="difflineminus">-      --&gt;</span>
<a href="#l10.595"></a><span id="l10.595" class="difflineminus">-      &lt;method name=&quot;showQuickSearchItems&quot;&gt;</span>
<a href="#l10.596"></a><span id="l10.596" class="difflineminus">-        &lt;parameter name=&quot;showQSItems&quot; /&gt;</span>
<a href="#l10.597"></a><span id="l10.597" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l10.598"></a><span id="l10.598" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l10.599"></a><span id="l10.599" class="difflineminus">-            for (let i = 0; i &lt; this.menupopup.childNodes.length; i++) {</span>
<a href="#l10.600"></a><span id="l10.600" class="difflineminus">-              let menuitem = this.menupopup.childNodes[i];</span>
<a href="#l10.601"></a><span id="l10.601" class="difflineminus">-              if (menuitem.getAttribute('quicksearchOnly') == 'true')</span>
<a href="#l10.602"></a><span id="l10.602" class="difflineminus">-                menuitem.collapsed = ! showQSItems;</span>
<a href="#l10.603"></a><span id="l10.603" class="difflineminus">-            }</span>
<a href="#l10.604"></a><span id="l10.604" class="difflineminus">-          ]]&gt;</span>
<a href="#l10.605"></a><span id="l10.605" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l10.606"></a><span id="l10.606" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l10.607"></a><span id="l10.607" class="difflineminus">-</span>
<a href="#l10.608"></a><span id="l10.608" class="difflineminus">-      &lt;method name=&quot;showGlodaItems&quot;&gt;</span>
<a href="#l10.609"></a><span id="l10.609" class="difflineminus">-        &lt;parameter name=&quot;aEnable&quot;/&gt;</span>
<a href="#l10.610"></a><span id="l10.610" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l10.611"></a><span id="l10.611" class="difflineminus">-        try {</span>
<a href="#l10.612"></a><span id="l10.612" class="difflineminus">-          for (let i = 0; i &lt; this.menupopup.childNodes.length; i++) {</span>
<a href="#l10.613"></a><span id="l10.613" class="difflineminus">-            let menuitem = this.menupopup.childNodes[i];</span>
<a href="#l10.614"></a><span id="l10.614" class="difflineminus">-            if (menuitem.getAttribute('glodaOnly') == 'true') {</span>
<a href="#l10.615"></a><span id="l10.615" class="difflineminus">-              menuitem.collapsed = ! aEnable;</span>
<a href="#l10.616"></a><span id="l10.616" class="difflineminus">-              menuitem.hidden = ! aEnable;</span>
<a href="#l10.617"></a><span id="l10.617" class="difflineminus">-            }</span>
<a href="#l10.618"></a><span id="l10.618" class="difflineminus">-          }</span>
<a href="#l10.619"></a><span id="l10.619" class="difflineminus">-        } catch (e) {</span>
<a href="#l10.620"></a><span id="l10.620" class="difflineminus">-          logException(e);</span>
<a href="#l10.621"></a><span id="l10.621" class="difflineminus">-        }</span>
<a href="#l10.622"></a><span id="l10.622" class="difflineminus">-        ]]&gt;</span>
<a href="#l10.623"></a><span id="l10.623" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l10.624"></a><span id="l10.624" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l10.625"></a><span id="l10.625" class="difflineminus">-</span>
<a href="#l10.626"></a><span id="l10.626">     &lt;/implementation&gt;</span>
<a href="#l10.627"></a><span id="l10.627">   &lt;/binding&gt;</span>
<a href="#l10.628"></a><span id="l10.628"> </span>
<a href="#l10.629"></a><span id="l10.629">   &lt;binding id=&quot;searchBarDropMarker&quot;&gt;</span>
<a href="#l10.630"></a><span id="l10.630">     &lt;resources&gt;</span>
<a href="#l10.631"></a><span id="l10.631">       &lt;stylesheet src=&quot;chrome://messenger/skin/searchBox.css&quot;/&gt;</span>
<a href="#l10.632"></a><span id="l10.632">     &lt;/resources&gt;</span>
<a href="#l10.633"></a><span id="l10.633">     &lt;content popup=&quot;_child&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/base/content/searchBar.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/base/content/searchBar.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -35,63 +35,64 @@</span>
<a href="#l11.4"></a><span id="l11.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l11.5"></a><span id="l11.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l11.6"></a><span id="l11.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l11.7"></a><span id="l11.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l11.8"></a><span id="l11.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l11.9"></a><span id="l11.9">  *</span>
<a href="#l11.10"></a><span id="l11.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-Components.utils.import(&quot;resource:///modules/quickSearchManager.js&quot;);</span>
<a href="#l11.13"></a><span id="l11.13"> Components.utils.import(&quot;resource:///modules/StringBundle.js&quot;);</span>
<a href="#l11.14"></a><span id="l11.14"> </span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-</span>
<a href="#l11.16"></a><span id="l11.16"> var gSearchBundle;</span>
<a href="#l11.17"></a><span id="l11.17"> </span>
<a href="#l11.18"></a><span id="l11.18"> var gStatusBar = document.getElementById('statusbar-icon');</span>
<a href="#l11.19"></a><span id="l11.19"> </span>
<a href="#l11.20"></a><span id="l11.20"> var gGlodaCompleteStrings = new StringBundle(&quot;chrome://messenger/locale/glodaComplete.properties&quot;);</span>
<a href="#l11.21"></a><span id="l11.21"> </span>
<a href="#l11.22"></a><span id="l11.22"> /* see the constructor of searchbar in search.xml's constructor for details */</span>
<a href="#l11.23"></a><span id="l11.23"> var gSearchInputObserversRegistered = false;</span>
<a href="#l11.24"></a><span id="l11.24"> </span>
<a href="#l11.25"></a><span id="l11.25"> /**</span>
<a href="#l11.26"></a><span id="l11.26">  * The quicksearch widget is a UI widget (the #searchInput textbox) which is</span>
<a href="#l11.27"></a><span id="l11.27">  * outside of the mailTabType's display panel, but acts as though it were within</span>
<a href="#l11.28"></a><span id="l11.28">  * it..  This means we need to use a tab monitor so that we can appropriately</span>
<a href="#l11.29"></a><span id="l11.29">  * update the contents of the textbox.</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">- * </span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+ *</span>
<a href="#l11.32"></a><span id="l11.32">  * Every time a tab is changed, we save the state of the text box and restore</span>
<a href="#l11.33"></a><span id="l11.33">  *  its previous value for the tab we are switching to, as well as whether this</span>
<a href="#l11.34"></a><span id="l11.34">  *  value is a change to the currently-used value (if it is a faceted search) tab.</span>
<a href="#l11.35"></a><span id="l11.35">  *  The behaviour rationale for this is that the searchInput is like the</span>
<a href="#l11.36"></a><span id="l11.36">  *  URL bar.  When you are on a glodaSearch tab, we need to show you your</span>
<a href="#l11.37"></a><span id="l11.37">  *  current value, including any &quot;uncommitted&quot; (you haven't hit enter yet)</span>
<a href="#l11.38"></a><span id="l11.38">  *  changes.</span>
<a href="#l11.39"></a><span id="l11.39">  *</span>
<a href="#l11.40"></a><span id="l11.40">  *  In addition, we want to disable the quick-search modes when a tab is</span>
<a href="#l11.41"></a><span id="l11.41">  *  being displayed that lacks quick search abilities (but we'll leave the</span>
<a href="#l11.42"></a><span id="l11.42">  *  faceted search as it's always available).</span>
<a href="#l11.43"></a><span id="l11.43">  */</span>
<a href="#l11.44"></a><span id="l11.44"> </span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-var QuickSearchTabMonitor = {</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+var GlodaSearchBoxTabMonitor = {</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+  monitorName: &quot;glodaSearchBox&quot;,</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+</span>
<a href="#l11.49"></a><span id="l11.49">   onTabTitleChanged: function() {</span>
<a href="#l11.50"></a><span id="l11.50">   },</span>
<a href="#l11.51"></a><span id="l11.51"> </span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+  onTabOpened: function GSBTM_onTabOpened(aTab, aFirstTab, aOldTab) {</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+    aTab._ext.glodaSearchBox = {</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+      value: &quot;&quot;,</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+    };</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+  },</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+</span>
<a href="#l11.58"></a><span id="l11.58">   onTabSwitched: function (aTab, aOldTab) {</span>
<a href="#l11.59"></a><span id="l11.59">     let searchInput = document.getElementById(&quot;searchInput&quot;);</span>
<a href="#l11.60"></a><span id="l11.60">     if (!searchInput) // customized out of the way</span>
<a href="#l11.61"></a><span id="l11.61">       return;</span>
<a href="#l11.62"></a><span id="l11.62"> </span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-    searchInput.showQuickSearchItems(aTab.mode.tabType != glodaFacetTabType)</span>
<a href="#l11.64"></a><span id="l11.64">     // save the current search field value</span>
<a href="#l11.65"></a><span id="l11.65">     if (aOldTab) {</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-      aOldTab.searchInputValue = searchInput.value;</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineminus">-      // XXX search.xml also updates this, so this shouldn't be necessary</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-      aOldTab.searchMode = searchInput.searchMode;</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+      aOldTab._ext.glodaSearchBox.value = searchInput.value;</span>
<a href="#l11.70"></a><span id="l11.70">     }</span>
<a href="#l11.71"></a><span id="l11.71">     // load (or clear if there is none) the persisted search field value</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineminus">-    searchInput.value = aTab.searchInputValue || &quot;&quot;;</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineminus">-    if (aTab.searchMode)</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-      searchInput.searchMode = aTab.searchMode;</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+    searchInput.value = aTab._ext.glodaSearchBox.value || &quot;&quot;;</span>
<a href="#l11.76"></a><span id="l11.76">   }</span>
<a href="#l11.77"></a><span id="l11.77"> };</span>
<a href="#l11.78"></a><span id="l11.78"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/base/content/tabmail.xml</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/base/content/tabmail.xml</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -216,26 +216,57 @@</span>
<a href="#l12.4"></a><span id="l12.4">     -     the window.</span>
<a href="#l12.5"></a><span id="l12.5">     - * getBrowser(aTab): This function should return the browser element for</span>
<a href="#l12.6"></a><span id="l12.6">     -     your tab if there is one (return null or don't define this function</span>
<a href="#l12.7"></a><span id="l12.7">     -     otherwise). It is used for some toolkit functions that require a</span>
<a href="#l12.8"></a><span id="l12.8">     -     global &quot;getBrowser&quot; function, e.g. ZoomManager.</span>
<a href="#l12.9"></a><span id="l12.9">     -</span>
<a href="#l12.10"></a><span id="l12.10">     - Tab monitoring code is expected to be used for widgets on the screen</span>
<a href="#l12.11"></a><span id="l12.11">     -  outside of the tab box that need to update themselves as the active tab</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-    -  changes.  This is primarily intended to be used for the ThunderBar; if</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-    -  you are not the ThunderBar and this sounds appealing to you, please</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-    -  solicit discussion on your needs on the mozilla.dev.apps.thunderbird</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-    -  newsgroup.</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+    -  changes.</span>
<a href="#l12.17"></a><span id="l12.17">     - Tab monitoring code (un)registers itself via (un)registerTabMonitor.</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+    -  The following attributes should be provided on the monitor object:</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+    - * monitorName: A string value naming the tab monitor/extension.  This is</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+    -     the canonical name for the tab monitor for all persistence purposes.</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+    -     If the tab monitor wants to store data in the tab info object and its</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+    -     name is FOO it should store it in 'tabInfo._ext.FOO'.  This is the</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+    -     only place the tab monitor should store information on the tab info</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+    -     object.  The FOO attribute will not be automatically created; it is</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+    -     up to the code.  The _ext attribute will be there, reliably, however.</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+    -     The name is also used when persisting state, but the tab monitor</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+    -     does not need to do anything in that case; the name is automatically</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+    -     used in the course of wrapping the object.</span>
<a href="#l12.29"></a><span id="l12.29">     -  The following functions should be provided on the monitor object:</span>
<a href="#l12.30"></a><span id="l12.30">     - * onTabTitleChanged(aTab): Called when the tab's title changes.</span>
<a href="#l12.31"></a><span id="l12.31">     - * onTabSwitched(aTab, aOldTab): Called when a new tab is made active.  If</span>
<a href="#l12.32"></a><span id="l12.32">     -     this is the first tab ever, aOldTab will be null, otherwise aOldTab</span>
<a href="#l12.33"></a><span id="l12.33">     -     will be the previously active tab.</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+    - * onTabOpened(aTab, aIsFirstTab, aWasCurrentTab): Called when a new tab is</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+    -     opened.  This method is invoked after the tab mode's openTab method</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+    -     is invoked.  This method is invoked before the tab monitor</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+    -     onTabSwitched method in the case where it will be invoked.  (It is</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+    -     not invoked if the tab is opened in the background.)</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+    - * onTabClosing(aTab): Called when a tab is being closed.  This method is</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+    -     is invoked before the call to the tab mode's closeTab function.</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+    - * onTabPersist(aTab): Return a JSON-representable object to persist for</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+    -     the tab.  Return null if you do not have anything to persist.</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+    - * onTabRestored(aTab, aState, aIsFirstTab): Called when a tab is being</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+    -     restored and there is data previously persisted by the tab monitor.</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+    -     This method is called instead of invoking onTabOpened.  This is done</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+    -     because the restoreTab method (potentially) uses the tabmail openTab</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+    -     API to effect restoration.  (Note: the first opened tab is special;</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+    -     it will produce an onTabOpened notification potentially followed by</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+    -     an onTabRestored notification.)</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+    - Tab monitor code is also allowed to hook into the command processing</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+    -  logic.  We support the standard supportsCommand/isCommandEnabled/</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+    -  doCommand functions but with a twist to indicate when other tab monitors</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+    -  and the actual tab itself should get a chance to process: supportsCommand</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+    -  and isCommandEnabled should return null when they are not handling the</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+    -  case.  doCommand should return true if it handled the case, null</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+    -  otherwise.</span>
<a href="#l12.57"></a><span id="l12.57">     --&gt;</span>
<a href="#l12.58"></a><span id="l12.58">   &lt;binding id=&quot;tabmail&quot;&gt;</span>
<a href="#l12.59"></a><span id="l12.59">     &lt;resources&gt;</span>
<a href="#l12.60"></a><span id="l12.60">       &lt;stylesheet src=&quot;chrome://messenger/content/tabmail.css&quot;/&gt;</span>
<a href="#l12.61"></a><span id="l12.61">       &lt;stylesheet src=&quot;chrome://messenger/skin/tabmail.css&quot;/&gt;</span>
<a href="#l12.62"></a><span id="l12.62">     &lt;/resources&gt;</span>
<a href="#l12.63"></a><span id="l12.63">     &lt;content&gt;</span>
<a href="#l12.64"></a><span id="l12.64">       &lt;xul:tabbox anonid=&quot;tabbox&quot; flex=&quot;1&quot; eventnode=&quot;document&quot; xbl:inherits=&quot;handleCtrlPageUpDown&quot;</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineat">@@ -277,16 +308,17 @@</span>
<a href="#l12.66"></a><span id="l12.66">         &lt;!-- Remember, user of this binding, you need to provide tabpanels!  --&gt;</span>
<a href="#l12.67"></a><span id="l12.67">         &lt;children includes=&quot;tabpanels&quot;/&gt;</span>
<a href="#l12.68"></a><span id="l12.68">       &lt;/xul:tabbox&gt;</span>
<a href="#l12.69"></a><span id="l12.69">     &lt;/content&gt;</span>
<a href="#l12.70"></a><span id="l12.70"> </span>
<a href="#l12.71"></a><span id="l12.71">     &lt;implementation implements=&quot;nsIController&quot;&gt;</span>
<a href="#l12.72"></a><span id="l12.72">       &lt;constructor&gt;</span>
<a href="#l12.73"></a><span id="l12.73">         window.controllers.insertControllerAt(0, this);</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+        this._restoringTabState = null;</span>
<a href="#l12.75"></a><span id="l12.75">       &lt;/constructor&gt;</span>
<a href="#l12.76"></a><span id="l12.76">       &lt;destructor&gt;</span>
<a href="#l12.77"></a><span id="l12.77">         window.controllers.removeController(this);</span>
<a href="#l12.78"></a><span id="l12.78">       &lt;/destructor&gt;</span>
<a href="#l12.79"></a><span id="l12.79">       &lt;field name=&quot;currentTabInfo&quot;&gt;</span>
<a href="#l12.80"></a><span id="l12.80">         null</span>
<a href="#l12.81"></a><span id="l12.81">       &lt;/field&gt;</span>
<a href="#l12.82"></a><span id="l12.82">       &lt;!-- Temporary field that only has a non-null value during a call to</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineat">@@ -395,29 +427,30 @@</span>
<a href="#l12.84"></a><span id="l12.84">           // From the moment of creation, our XBL binding already has a visible</span>
<a href="#l12.85"></a><span id="l12.85">           //  tab.  We need to create a tab information structure for this tab.</span>
<a href="#l12.86"></a><span id="l12.86">           //  In the process we also generate a synthetic tab title changed</span>
<a href="#l12.87"></a><span id="l12.87">           //  event to ensure we have an accurate title.  We assume the tab</span>
<a href="#l12.88"></a><span id="l12.88">           //  contents will set themselves up correctly.</span>
<a href="#l12.89"></a><span id="l12.89">           if (this.tabInfo.length == 0) {</span>
<a href="#l12.90"></a><span id="l12.90">             let firstTab = {mode: this.defaultTabMode, busy: false,</span>
<a href="#l12.91"></a><span id="l12.91">                             canClose: false,</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineminus">-                            searchMode: 'global'};</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+                            _ext: {}};</span>
<a href="#l12.94"></a><span id="l12.94">             firstTab.mode.tabs.push(firstTab);</span>
<a href="#l12.95"></a><span id="l12.95"> </span>
<a href="#l12.96"></a><span id="l12.96">             this.tabInfo[0] = this.currentTabInfo = firstTab;</span>
<a href="#l12.97"></a><span id="l12.97"> </span>
<a href="#l12.98"></a><span id="l12.98">             let tabOpenFirstFunc = firstTab.mode.openFirstTab ||</span>
<a href="#l12.99"></a><span id="l12.99">                                    firstTab.mode.tabType.openFirstTab;</span>
<a href="#l12.100"></a><span id="l12.100">             tabOpenFirstFunc.call(firstTab.mode.tabType, firstTab);</span>
<a href="#l12.101"></a><span id="l12.101">             this.setTabTitle(null);</span>
<a href="#l12.102"></a><span id="l12.102"> </span>
<a href="#l12.103"></a><span id="l12.103" class="difflineminus">-            if (this.tabMonitors.length) {</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineminus">-              for each (let [i, tabMonitor] in Iterator(this.tabMonitors))</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineminus">-                tabMonitor.onTabSwitched(firstTab, null);</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+            for each (let [i, tabMonitor] in Iterator(this.tabMonitors)) {</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+              if (&quot;onTabOpened&quot; in tabMonitor)</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+                tabMonitor.onTabOpened(firstTab, true);</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineplus">+              tabMonitor.onTabSwitched(firstTab, null);</span>
<a href="#l12.110"></a><span id="l12.110">             }</span>
<a href="#l12.111"></a><span id="l12.111">           }</span>
<a href="#l12.112"></a><span id="l12.112">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.113"></a><span id="l12.113">       &lt;/method&gt;</span>
<a href="#l12.114"></a><span id="l12.114">       &lt;method name=&quot;openTab&quot;&gt;</span>
<a href="#l12.115"></a><span id="l12.115">         &lt;parameter name=&quot;aTabModeName&quot;/&gt;</span>
<a href="#l12.116"></a><span id="l12.116">         &lt;parameter name=&quot;aArgs&quot;/&gt;</span>
<a href="#l12.117"></a><span id="l12.117">         &lt;body&gt;</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineat">@@ -450,17 +483,17 @@</span>
<a href="#l12.119"></a><span id="l12.119">               return;</span>
<a href="#l12.120"></a><span id="l12.120">             }</span>
<a href="#l12.121"></a><span id="l12.121">           }</span>
<a href="#l12.122"></a><span id="l12.122"> </span>
<a href="#l12.123"></a><span id="l12.123">           if (!background)</span>
<a href="#l12.124"></a><span id="l12.124">             // we need to save the state before it gets corrupted</span>
<a href="#l12.125"></a><span id="l12.125">             this.saveCurrentTabState();</span>
<a href="#l12.126"></a><span id="l12.126"> </span>
<a href="#l12.127"></a><span id="l12.127" class="difflineminus">-          let tab = {mode: tabMode, busy: false, canClose: true};</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineplus">+          let tab = {mode: tabMode, busy: false, canClose: true, _ext: {}};</span>
<a href="#l12.129"></a><span id="l12.129">           tabMode.tabs.push(tab);</span>
<a href="#l12.130"></a><span id="l12.130"> </span>
<a href="#l12.131"></a><span id="l12.131">           var t = document.createElementNS(</span>
<a href="#l12.132"></a><span id="l12.132">             &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;,</span>
<a href="#l12.133"></a><span id="l12.133">             &quot;tab&quot;);</span>
<a href="#l12.134"></a><span id="l12.134">           tab.tabNode = t;</span>
<a href="#l12.135"></a><span id="l12.135">           t.setAttribute(&quot;crop&quot;, &quot;end&quot;);</span>
<a href="#l12.136"></a><span id="l12.136">           t.maxWidth = this.tabContainer.mTabMaxWidth;</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineat">@@ -503,18 +536,26 @@</span>
<a href="#l12.138"></a><span id="l12.138">               this.panelContainer.selectedPanel = tab.panel;</span>
<a href="#l12.139"></a><span id="l12.139">           }</span>
<a href="#l12.140"></a><span id="l12.140">           else if (!background)</span>
<a href="#l12.141"></a><span id="l12.141">             this.panelContainer.selectedPanel = tab.mode.tabType.panel;</span>
<a href="#l12.142"></a><span id="l12.142"> </span>
<a href="#l12.143"></a><span id="l12.143">           let tabOpenFunc = tab.mode.openTab || tab.mode.tabType.openTab;</span>
<a href="#l12.144"></a><span id="l12.144">           tabOpenFunc.apply(tab.mode.tabType, [tab, aArgs]);</span>
<a href="#l12.145"></a><span id="l12.145"> </span>
<a href="#l12.146"></a><span id="l12.146" class="difflineminus">-          if (!background &amp;&amp; this.tabMonitors.length) {</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineminus">-            for each (let [i, tabMonitor] in Iterator(this.tabMonitors))</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineplus">+          let restoreState = this._restoringTabState;</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineplus">+          for each (let [i, tabMonitor] in Iterator(this.tabMonitors)) {</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineplus">+            if ((&quot;onTabRestored&quot; in tabMonitor) &amp;&amp; restoreState &amp;&amp;</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineplus">+                (tabMonitor.monitorName in restoreState.ext))</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineplus">+              tabMonitor.onTabRestored(tab,</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+                                       restoreState.ext[tabMonitor.monitorName],</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineplus">+                                       false);</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineplus">+            else if (&quot;onTabOpened&quot; in tabMonitor)</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineplus">+              tabMonitor.onTabOpened(tab, false, oldTab);</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineplus">+            if (!background)</span>
<a href="#l12.158"></a><span id="l12.158">               tabMonitor.onTabSwitched(tab, oldTab);</span>
<a href="#l12.159"></a><span id="l12.159">           }</span>
<a href="#l12.160"></a><span id="l12.160">           </span>
<a href="#l12.161"></a><span id="l12.161">           // clear _mostRecentTabInfo; we only needed it during the call to</span>
<a href="#l12.162"></a><span id="l12.162">           //  openTab.</span>
<a href="#l12.163"></a><span id="l12.163">           this._mostRecentTabInfo = null;</span>
<a href="#l12.164"></a><span id="l12.164">           </span>
<a href="#l12.165"></a><span id="l12.165">           t.setAttribute(&quot;label&quot;, tab.title);</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineat">@@ -599,16 +640,21 @@</span>
<a href="#l12.167"></a><span id="l12.167">         &lt;parameter name=&quot;aOptTabIndexNodeOrInfo&quot;/&gt;</span>
<a href="#l12.168"></a><span id="l12.168">         &lt;body&gt;</span>
<a href="#l12.169"></a><span id="l12.169">           &lt;![CDATA[</span>
<a href="#l12.170"></a><span id="l12.170">             let [iTab, tab, tabNode] =</span>
<a href="#l12.171"></a><span id="l12.171">               this._getTabContextForTabbyThing(aOptTabIndexNodeOrInfo, true);</span>
<a href="#l12.172"></a><span id="l12.172"> </span>
<a href="#l12.173"></a><span id="l12.173">             if (!tab.canClose)</span>
<a href="#l12.174"></a><span id="l12.174">               return;</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineplus">+</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineplus">+            for each (let [i, tabMonitor] in Iterator(this.tabMonitors)) {</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineplus">+              if (&quot;onTabClosing&quot; in tabMonitor)</span>
<a href="#l12.178"></a><span id="l12.178" class="difflineplus">+                tabMonitor.onTabClosing(tab);</span>
<a href="#l12.179"></a><span id="l12.179" class="difflineplus">+            }</span>
<a href="#l12.180"></a><span id="l12.180">             </span>
<a href="#l12.181"></a><span id="l12.181">             let closeFunc = tab.mode.closeTab || tab.mode.tabType.closeTab;</span>
<a href="#l12.182"></a><span id="l12.182">             closeFunc.call(tab.mode.tabType, tab);</span>
<a href="#l12.183"></a><span id="l12.183">              </span>
<a href="#l12.184"></a><span id="l12.184">             this.tabInfo.splice(iTab, 1);</span>
<a href="#l12.185"></a><span id="l12.185">             tab.mode.tabs.splice(tab.mode.tabs.indexOf(tab), 1);</span>
<a href="#l12.186"></a><span id="l12.186">             this.tabContainer.removeChild(tabNode);</span>
<a href="#l12.187"></a><span id="l12.187">             if (this.tabContainer.selectedIndex == -1)</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineat">@@ -700,19 +746,30 @@</span>
<a href="#l12.189"></a><span id="l12.189">               continue;</span>
<a href="#l12.190"></a><span id="l12.190">             let tabState = persistFunc.call(tab.mode.tabType, tab);</span>
<a href="#l12.191"></a><span id="l12.191">             // If there is a non-null tab-state, then persisting succeeded and</span>
<a href="#l12.192"></a><span id="l12.192">             //  we should store it.  We store the tab's persisted state in its</span>
<a href="#l12.193"></a><span id="l12.193">             //  own distinct object rather than mixing things up in a dictionary</span>
<a href="#l12.194"></a><span id="l12.194">             //  to avoid bugs and because we may eventually let extensions store</span>
<a href="#l12.195"></a><span id="l12.195">             //  per-tab information in the persisted state.</span>
<a href="#l12.196"></a><span id="l12.196">             if (tabState != null) {</span>
<a href="#l12.197"></a><span id="l12.197" class="difflineplus">+              let ext = {};</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineplus">+</span>
<a href="#l12.199"></a><span id="l12.199" class="difflineplus">+              for each (let [i, tabMonitor] in Iterator(this.tabMonitors)) {</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineplus">+                if (&quot;onTabPersist&quot; in tabMonitor) {</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineplus">+                  let monState = tabMonitor.onTabPersist(tab);</span>
<a href="#l12.202"></a><span id="l12.202" class="difflineplus">+                  if (monState !== null)</span>
<a href="#l12.203"></a><span id="l12.203" class="difflineplus">+                    ext[tabMonitor.monitorName] = monState;</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineplus">+                }</span>
<a href="#l12.205"></a><span id="l12.205" class="difflineplus">+              }</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineplus">+</span>
<a href="#l12.207"></a><span id="l12.207">               tabs.push({</span>
<a href="#l12.208"></a><span id="l12.208">                 mode: tab.mode.name,</span>
<a href="#l12.209"></a><span id="l12.209">                 state: tabState,</span>
<a href="#l12.210"></a><span id="l12.210" class="difflineplus">+                ext: ext,</span>
<a href="#l12.211"></a><span id="l12.211">               });</span>
<a href="#l12.212"></a><span id="l12.212">               // Mark this persisted tab as selected</span>
<a href="#l12.213"></a><span id="l12.213">               if (iTab == this.tabContainer.selectedIndex)</span>
<a href="#l12.214"></a><span id="l12.214">                 state.selectedIndex = tabs.length - 1;</span>
<a href="#l12.215"></a><span id="l12.215">             }</span>
<a href="#l12.216"></a><span id="l12.216">           }</span>
<a href="#l12.217"></a><span id="l12.217"> </span>
<a href="#l12.218"></a><span id="l12.218">           return state;</span>
<a href="#l12.219"></a><span id="l12.219" class="difflineat">@@ -741,17 +798,22 @@</span>
<a href="#l12.220"></a><span id="l12.220">               continue;</span>
<a href="#l12.221"></a><span id="l12.221"> </span>
<a href="#l12.222"></a><span id="l12.222">             // The first tab is a folder tab (we know that from our</span>
<a href="#l12.223"></a><span id="l12.223">             // implementation). Tell the folder tab to back off if necessary.</span>
<a href="#l12.224"></a><span id="l12.224">             // XXX find a better way to do this.</span>
<a href="#l12.225"></a><span id="l12.225">             if (tabState.state.firstTab &amp;&amp; aDontRestoreFirstTab)</span>
<a href="#l12.226"></a><span id="l12.226">               tabState.state.dontRestoreFirstTab = aDontRestoreFirstTab;</span>
<a href="#l12.227"></a><span id="l12.227"> </span>
<a href="#l12.228"></a><span id="l12.228" class="difflineplus">+            // normalize the state to have an ext attribute if it does not.</span>
<a href="#l12.229"></a><span id="l12.229" class="difflineplus">+            if (!(&quot;ext&quot; in tabState))</span>
<a href="#l12.230"></a><span id="l12.230" class="difflineplus">+              tabState.ext = {};</span>
<a href="#l12.231"></a><span id="l12.231" class="difflineplus">+            this._restoringTabState = tabState;</span>
<a href="#l12.232"></a><span id="l12.232">             restoreFunc.call(mode.tabType, this, tabState.state);</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineplus">+            this._restoringTabState = null;</span>
<a href="#l12.234"></a><span id="l12.234"> </span>
<a href="#l12.235"></a><span id="l12.235">             // If this persisted tab was the selected one, then mark the newest</span>
<a href="#l12.236"></a><span id="l12.236">             //  tab as the guy to select.</span>
<a href="#l12.237"></a><span id="l12.237">             if (iTab == aPersistedState.selectedIndex)</span>
<a href="#l12.238"></a><span id="l12.238">               indexToSelect = this.tabInfo.length - 1;</span>
<a href="#l12.239"></a><span id="l12.239">           }</span>
<a href="#l12.240"></a><span id="l12.240">           if (indexToSelect != null &amp;&amp; !aDontRestoreFirstTab)</span>
<a href="#l12.241"></a><span id="l12.241">             this.tabContainer.selectedIndex = indexToSelect;</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineat">@@ -816,20 +878,18 @@</span>
<a href="#l12.243"></a><span id="l12.243">                 this.tabInfo[this.tabContainer.selectedIndex];</span>
<a href="#l12.244"></a><span id="l12.244"> </span>
<a href="#l12.245"></a><span id="l12.245">               this.panelContainer.selectedPanel = tab.panel ||</span>
<a href="#l12.246"></a><span id="l12.246">                                                   tab.mode.tabType.panel;</span>
<a href="#l12.247"></a><span id="l12.247"> </span>
<a href="#l12.248"></a><span id="l12.248">               let showTabFunc = tab.mode.showTab || tab.mode.tabType.showTab;</span>
<a href="#l12.249"></a><span id="l12.249">               showTabFunc.call(tab.mode.tabType, tab);</span>
<a href="#l12.250"></a><span id="l12.250"> </span>
<a href="#l12.251"></a><span id="l12.251" class="difflineminus">-              if (this.tabMonitors.length) {</span>
<a href="#l12.252"></a><span id="l12.252" class="difflineminus">-                for each (let [i, tabMonitor] in Iterator(this.tabMonitors))</span>
<a href="#l12.253"></a><span id="l12.253" class="difflineminus">-                  tabMonitor.onTabSwitched(tab, oldTab);</span>
<a href="#l12.254"></a><span id="l12.254" class="difflineminus">-              }</span>
<a href="#l12.255"></a><span id="l12.255" class="difflineplus">+              for each (let [i, tabMonitor] in Iterator(this.tabMonitors))</span>
<a href="#l12.256"></a><span id="l12.256" class="difflineplus">+                tabMonitor.onTabSwitched(tab, oldTab);</span>
<a href="#l12.257"></a><span id="l12.257"> </span>
<a href="#l12.258"></a><span id="l12.258">               // always update the cursor status when we switch tabs</span>
<a href="#l12.259"></a><span id="l12.259">               SetBusyCursor(window, tab.busy);</span>
<a href="#l12.260"></a><span id="l12.260">               // active tabs should not have the wasBusy attribute</span>
<a href="#l12.261"></a><span id="l12.261">               this.tabContainer.selectedItem.removeAttribute(&quot;wasBusy&quot;);</span>
<a href="#l12.262"></a><span id="l12.262"> </span>
<a href="#l12.263"></a><span id="l12.263">               // update the thinking status when we switch tabs</span>
<a href="#l12.264"></a><span id="l12.264">               this._setActiveThinkingState(tab.thinking);</span>
<a href="#l12.265"></a><span id="l12.265" class="difflineat">@@ -883,20 +943,18 @@</span>
<a href="#l12.266"></a><span id="l12.266">               let tabNode =</span>
<a href="#l12.267"></a><span id="l12.267">                 this.tabContainer.childNodes[iTab];</span>
<a href="#l12.268"></a><span id="l12.268"> </span>
<a href="#l12.269"></a><span id="l12.269">               let titleChangeFunc = tab.mode.onTitleChanged ||</span>
<a href="#l12.270"></a><span id="l12.270">                                     tab.mode.tabType.onTitleChanged;</span>
<a href="#l12.271"></a><span id="l12.271">               if (titleChangeFunc)</span>
<a href="#l12.272"></a><span id="l12.272">                 titleChangeFunc.call(tab.mode.tabType, tab, tabNode);</span>
<a href="#l12.273"></a><span id="l12.273"> </span>
<a href="#l12.274"></a><span id="l12.274" class="difflineminus">-              if (this.tabMonitors.length) {</span>
<a href="#l12.275"></a><span id="l12.275" class="difflineminus">-                for each (let [, tabMonitor] in Iterator(this.tabMonitors))</span>
<a href="#l12.276"></a><span id="l12.276" class="difflineminus">-                  tabMonitor.onTabTitleChanged(tab);</span>
<a href="#l12.277"></a><span id="l12.277" class="difflineminus">-              }</span>
<a href="#l12.278"></a><span id="l12.278" class="difflineplus">+              for each (let [, tabMonitor] in Iterator(this.tabMonitors))</span>
<a href="#l12.279"></a><span id="l12.279" class="difflineplus">+                tabMonitor.onTabTitleChanged(tab);</span>
<a href="#l12.280"></a><span id="l12.280"> </span>
<a href="#l12.281"></a><span id="l12.281">               tabNode.setAttribute(&quot;label&quot;, tab.title);</span>
<a href="#l12.282"></a><span id="l12.282"> </span>
<a href="#l12.283"></a><span id="l12.283">               // Update the window title if we're the displayed tab.</span>
<a href="#l12.284"></a><span id="l12.284">               if (iTab == this.tabContainer.selectedIndex)</span>
<a href="#l12.285"></a><span id="l12.285">                 this.setDocumentTitle(tab);</span>
<a href="#l12.286"></a><span id="l12.286">             }</span>
<a href="#l12.287"></a><span id="l12.287">           ]]&gt;</span>
<a href="#l12.288"></a><span id="l12.288" class="difflineat">@@ -1007,69 +1065,93 @@</span>
<a href="#l12.289"></a><span id="l12.289">             closeTabItem.setAttribute(&quot;disabled&quot;, tab.canClose ? &quot;false&quot; : &quot;true&quot;);</span>
<a href="#l12.290"></a><span id="l12.290">             return true;</span>
<a href="#l12.291"></a><span id="l12.291">           ]]&gt;</span>
<a href="#l12.292"></a><span id="l12.292">         &lt;/body&gt;</span>
<a href="#l12.293"></a><span id="l12.293">       &lt;/method&gt;</span>
<a href="#l12.294"></a><span id="l12.294">       &lt;method name=&quot;supportsCommand&quot;&gt;</span>
<a href="#l12.295"></a><span id="l12.295">         &lt;parameter name=&quot;aCommand&quot;/&gt;</span>
<a href="#l12.296"></a><span id="l12.296">         &lt;body&gt;</span>
<a href="#l12.297"></a><span id="l12.297" class="difflineminus">-           &lt;![CDATA[</span>
<a href="#l12.298"></a><span id="l12.298" class="difflineminus">-             let tab = this.currentTabInfo;</span>
<a href="#l12.299"></a><span id="l12.299" class="difflineplus">+          &lt;![CDATA[</span>
<a href="#l12.300"></a><span id="l12.300" class="difflineplus">+            let tab = this.currentTabInfo;</span>
<a href="#l12.301"></a><span id="l12.301"> </span>
<a href="#l12.302"></a><span id="l12.302" class="difflineminus">-             // This can happen if we're starting up and haven't got a tab</span>
<a href="#l12.303"></a><span id="l12.303" class="difflineminus">-             // loaded yet.</span>
<a href="#l12.304"></a><span id="l12.304" class="difflineminus">-             if (!tab)</span>
<a href="#l12.305"></a><span id="l12.305" class="difflineminus">-               return false;</span>
<a href="#l12.306"></a><span id="l12.306" class="difflineplus">+            // This can happen if we're starting up and haven't got a tab</span>
<a href="#l12.307"></a><span id="l12.307" class="difflineplus">+            // loaded yet.</span>
<a href="#l12.308"></a><span id="l12.308" class="difflineplus">+            if (!tab)</span>
<a href="#l12.309"></a><span id="l12.309" class="difflineplus">+              return false;</span>
<a href="#l12.310"></a><span id="l12.310"> </span>
<a href="#l12.311"></a><span id="l12.311" class="difflineminus">-             let supportsCommandFunc = tab.mode.supportsCommand ||</span>
<a href="#l12.312"></a><span id="l12.312" class="difflineminus">-                                       tab.mode.tabType.supportsCommand;</span>
<a href="#l12.313"></a><span id="l12.313" class="difflineminus">-             if (supportsCommandFunc)</span>
<a href="#l12.314"></a><span id="l12.314" class="difflineminus">-               return supportsCommandFunc.call(tab.mode.tabType, aCommand, tab);</span>
<a href="#l12.315"></a><span id="l12.315" class="difflineplus">+            for each (let [, tabMonitor] in Iterator(this.tabMonitors)) {</span>
<a href="#l12.316"></a><span id="l12.316" class="difflineplus">+              if (&quot;supportsCommand&quot; in tabMonitor) {</span>
<a href="#l12.317"></a><span id="l12.317" class="difflineplus">+                let result = tabMonitor.supportsCommand(aCommand, tab);</span>
<a href="#l12.318"></a><span id="l12.318" class="difflineplus">+                if (result !== null)</span>
<a href="#l12.319"></a><span id="l12.319" class="difflineplus">+                  return result;</span>
<a href="#l12.320"></a><span id="l12.320" class="difflineplus">+              }</span>
<a href="#l12.321"></a><span id="l12.321" class="difflineplus">+            }</span>
<a href="#l12.322"></a><span id="l12.322"> </span>
<a href="#l12.323"></a><span id="l12.323" class="difflineminus">-             return false;</span>
<a href="#l12.324"></a><span id="l12.324" class="difflineminus">-           ]]&gt;</span>
<a href="#l12.325"></a><span id="l12.325" class="difflineplus">+            let supportsCommandFunc = tab.mode.supportsCommand ||</span>
<a href="#l12.326"></a><span id="l12.326" class="difflineplus">+                                      tab.mode.tabType.supportsCommand;</span>
<a href="#l12.327"></a><span id="l12.327" class="difflineplus">+            if (supportsCommandFunc)</span>
<a href="#l12.328"></a><span id="l12.328" class="difflineplus">+              return supportsCommandFunc.call(tab.mode.tabType, aCommand, tab);</span>
<a href="#l12.329"></a><span id="l12.329" class="difflineplus">+</span>
<a href="#l12.330"></a><span id="l12.330" class="difflineplus">+            return false;</span>
<a href="#l12.331"></a><span id="l12.331" class="difflineplus">+          ]]&gt;</span>
<a href="#l12.332"></a><span id="l12.332">         &lt;/body&gt;</span>
<a href="#l12.333"></a><span id="l12.333">       &lt;/method&gt;</span>
<a href="#l12.334"></a><span id="l12.334">       &lt;method name=&quot;isCommandEnabled&quot;&gt;</span>
<a href="#l12.335"></a><span id="l12.335">         &lt;parameter name=&quot;aCommand&quot;/&gt;</span>
<a href="#l12.336"></a><span id="l12.336">         &lt;body&gt;</span>
<a href="#l12.337"></a><span id="l12.337" class="difflineminus">-           &lt;![CDATA[</span>
<a href="#l12.338"></a><span id="l12.338" class="difflineminus">-             let tab = this.currentTabInfo;</span>
<a href="#l12.339"></a><span id="l12.339" class="difflineplus">+          &lt;![CDATA[</span>
<a href="#l12.340"></a><span id="l12.340" class="difflineplus">+            let tab = this.currentTabInfo;</span>
<a href="#l12.341"></a><span id="l12.341"> </span>
<a href="#l12.342"></a><span id="l12.342" class="difflineminus">-             // This can happen if we're starting up and haven't got a tab</span>
<a href="#l12.343"></a><span id="l12.343" class="difflineminus">-             // loaded yet.</span>
<a href="#l12.344"></a><span id="l12.344" class="difflineminus">-             if (!tab)</span>
<a href="#l12.345"></a><span id="l12.345" class="difflineminus">-               return false;</span>
<a href="#l12.346"></a><span id="l12.346" class="difflineplus">+            // This can happen if we're starting up and haven't got a tab</span>
<a href="#l12.347"></a><span id="l12.347" class="difflineplus">+            // loaded yet.</span>
<a href="#l12.348"></a><span id="l12.348" class="difflineplus">+            if (!tab)</span>
<a href="#l12.349"></a><span id="l12.349" class="difflineplus">+              return false;</span>
<a href="#l12.350"></a><span id="l12.350"> </span>
<a href="#l12.351"></a><span id="l12.351" class="difflineminus">-             let isCommandEnabledFunc = tab.mode.isCommandEnabled ||</span>
<a href="#l12.352"></a><span id="l12.352" class="difflineminus">-                                        tab.mode.tabType.isCommandEnabled;</span>
<a href="#l12.353"></a><span id="l12.353" class="difflineminus">-             if (isCommandEnabledFunc)</span>
<a href="#l12.354"></a><span id="l12.354" class="difflineminus">-               return isCommandEnabledFunc.call(tab.mode.tabType, aCommand, tab);</span>
<a href="#l12.355"></a><span id="l12.355" class="difflineplus">+            for each (let [, tabMonitor] in Iterator(this.tabMonitors)) {</span>
<a href="#l12.356"></a><span id="l12.356" class="difflineplus">+              if (&quot;isCommandEnabled&quot; in tabMonitor) {</span>
<a href="#l12.357"></a><span id="l12.357" class="difflineplus">+                let result = tabMonitor.isCommandEnabled(aCommand, tab);</span>
<a href="#l12.358"></a><span id="l12.358" class="difflineplus">+                if (result !== null)</span>
<a href="#l12.359"></a><span id="l12.359" class="difflineplus">+                  return result;</span>
<a href="#l12.360"></a><span id="l12.360" class="difflineplus">+              }</span>
<a href="#l12.361"></a><span id="l12.361" class="difflineplus">+            }</span>
<a href="#l12.362"></a><span id="l12.362"> </span>
<a href="#l12.363"></a><span id="l12.363" class="difflineminus">-             return false;</span>
<a href="#l12.364"></a><span id="l12.364" class="difflineminus">-           ]]&gt;</span>
<a href="#l12.365"></a><span id="l12.365" class="difflineplus">+            let isCommandEnabledFunc = tab.mode.isCommandEnabled ||</span>
<a href="#l12.366"></a><span id="l12.366" class="difflineplus">+                                       tab.mode.tabType.isCommandEnabled;</span>
<a href="#l12.367"></a><span id="l12.367" class="difflineplus">+            if (isCommandEnabledFunc)</span>
<a href="#l12.368"></a><span id="l12.368" class="difflineplus">+              return isCommandEnabledFunc.call(tab.mode.tabType, aCommand, tab);</span>
<a href="#l12.369"></a><span id="l12.369" class="difflineplus">+</span>
<a href="#l12.370"></a><span id="l12.370" class="difflineplus">+            return false;</span>
<a href="#l12.371"></a><span id="l12.371" class="difflineplus">+          ]]&gt;</span>
<a href="#l12.372"></a><span id="l12.372">         &lt;/body&gt;</span>
<a href="#l12.373"></a><span id="l12.373">       &lt;/method&gt;</span>
<a href="#l12.374"></a><span id="l12.374">       &lt;method name=&quot;doCommand&quot;&gt;</span>
<a href="#l12.375"></a><span id="l12.375">         &lt;parameter name=&quot;aCommand&quot;/&gt;</span>
<a href="#l12.376"></a><span id="l12.376">         &lt;body&gt;</span>
<a href="#l12.377"></a><span id="l12.377" class="difflineminus">-           &lt;![CDATA[</span>
<a href="#l12.378"></a><span id="l12.378" class="difflineminus">-             let tab = this.currentTabInfo;</span>
<a href="#l12.379"></a><span id="l12.379" class="difflineplus">+          &lt;![CDATA[</span>
<a href="#l12.380"></a><span id="l12.380" class="difflineplus">+            let tab = this.currentTabInfo;</span>
<a href="#l12.381"></a><span id="l12.381" class="difflineplus">+</span>
<a href="#l12.382"></a><span id="l12.382" class="difflineplus">+            // This can happen if we're starting up and haven't got a tab</span>
<a href="#l12.383"></a><span id="l12.383" class="difflineplus">+            // loaded yet.</span>
<a href="#l12.384"></a><span id="l12.384" class="difflineplus">+            if (!tab)</span>
<a href="#l12.385"></a><span id="l12.385" class="difflineplus">+              return;</span>
<a href="#l12.386"></a><span id="l12.386"> </span>
<a href="#l12.387"></a><span id="l12.387" class="difflineminus">-             // This can happen if we're starting up and haven't got a tab</span>
<a href="#l12.388"></a><span id="l12.388" class="difflineminus">-             // loaded yet.</span>
<a href="#l12.389"></a><span id="l12.389" class="difflineminus">-             if (!tab)</span>
<a href="#l12.390"></a><span id="l12.390" class="difflineminus">-               return;</span>
<a href="#l12.391"></a><span id="l12.391" class="difflineplus">+            for each (let [, tabMonitor] in Iterator(this.tabMonitors)) {</span>
<a href="#l12.392"></a><span id="l12.392" class="difflineplus">+              if (&quot;doCommand&quot; in tabMonitor) {</span>
<a href="#l12.393"></a><span id="l12.393" class="difflineplus">+                let result = tabMonitor.doCommand(aCommand, tab);</span>
<a href="#l12.394"></a><span id="l12.394" class="difflineplus">+                if (result === true)</span>
<a href="#l12.395"></a><span id="l12.395" class="difflineplus">+                  return;</span>
<a href="#l12.396"></a><span id="l12.396" class="difflineplus">+              }</span>
<a href="#l12.397"></a><span id="l12.397" class="difflineplus">+            }</span>
<a href="#l12.398"></a><span id="l12.398"> </span>
<a href="#l12.399"></a><span id="l12.399" class="difflineminus">-             let doCommandFunc = tab.mode.doCommand ||</span>
<a href="#l12.400"></a><span id="l12.400" class="difflineminus">-                                 tab.mode.tabType.doCommand;</span>
<a href="#l12.401"></a><span id="l12.401" class="difflineminus">-             if (doCommandFunc)</span>
<a href="#l12.402"></a><span id="l12.402" class="difflineminus">-               doCommandFunc.call(tab.mode.tabType, aCommand, tab);</span>
<a href="#l12.403"></a><span id="l12.403" class="difflineminus">-           ]]&gt;</span>
<a href="#l12.404"></a><span id="l12.404" class="difflineplus">+            let doCommandFunc = tab.mode.doCommand ||</span>
<a href="#l12.405"></a><span id="l12.405" class="difflineplus">+                                tab.mode.tabType.doCommand;</span>
<a href="#l12.406"></a><span id="l12.406" class="difflineplus">+            if (doCommandFunc)</span>
<a href="#l12.407"></a><span id="l12.407" class="difflineplus">+              doCommandFunc.call(tab.mode.tabType, aCommand, tab);</span>
<a href="#l12.408"></a><span id="l12.408" class="difflineplus">+          ]]&gt;</span>
<a href="#l12.409"></a><span id="l12.409">         &lt;/body&gt;</span>
<a href="#l12.410"></a><span id="l12.410">       &lt;/method&gt;</span>
<a href="#l12.411"></a><span id="l12.411">       &lt;method name=&quot;onEvent&quot;&gt;</span>
<a href="#l12.412"></a><span id="l12.412">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l12.413"></a><span id="l12.413">         &lt;body&gt;</span>
<a href="#l12.414"></a><span id="l12.414">            &lt;![CDATA[</span>
<a href="#l12.415"></a><span id="l12.415">              let tab = this.currentTabInfo;</span>
<a href="#l12.416"></a><span id="l12.416"> </span>
<a href="#l12.417"></a><span id="l12.417" class="difflineat">@@ -1114,18 +1196,17 @@</span>
<a href="#l12.418"></a><span id="l12.418">   &lt;/binding&gt;</span>
<a href="#l12.419"></a><span id="l12.419"> </span>
<a href="#l12.420"></a><span id="l12.420">   &lt;binding id=&quot;tabmail-tab&quot; display=&quot;xul:box&quot;</span>
<a href="#l12.421"></a><span id="l12.421">            extends=&quot;chrome://global/content/bindings/tabbox.xml#tab&quot;&gt;</span>
<a href="#l12.422"></a><span id="l12.422">     &lt;content closetabtext=&quot;&amp;closeTab.label;&quot;&gt;</span>
<a href="#l12.423"></a><span id="l12.423">       &lt;xul:hbox class=&quot;tab-image-left&quot; xbl:inherits=&quot;selected&quot;/&gt;</span>
<a href="#l12.424"></a><span id="l12.424">       &lt;xul:hbox class=&quot;tab-image-middle box-inherit&quot; align=&quot;center&quot;</span>
<a href="#l12.425"></a><span id="l12.425">                 xbl:inherits=&quot;dir,pack,orient,selected&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l12.426"></a><span id="l12.426" class="difflineminus">-        &lt;xul:image class=&quot;tab-icon-image&quot;</span>
<a href="#l12.427"></a><span id="l12.427" class="difflineminus">-                   xbl:inherits=&quot;validate,src=image,src&quot;/&gt;</span>
<a href="#l12.428"></a><span id="l12.428" class="difflineplus">+        &lt;xul:image class=&quot;tab-icon-image&quot; xbl:inherits=&quot;validate,src=image&quot;/&gt;</span>
<a href="#l12.429"></a><span id="l12.429">         &lt;xul:label class=&quot;tab-text&quot;</span>
<a href="#l12.430"></a><span id="l12.430">                   xbl:inherits=&quot;value=label,accesskey,crop,disabled&quot;</span>
<a href="#l12.431"></a><span id="l12.431">                   crop=&quot;right&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l12.432"></a><span id="l12.432">       &lt;/xul:hbox&gt;</span>
<a href="#l12.433"></a><span id="l12.433">       &lt;xul:toolbarbutton anonid=&quot;close-button&quot; class=&quot;tab-close-button&quot; tabindex=&quot;-1&quot;/&gt;</span>
<a href="#l12.434"></a><span id="l12.434">       &lt;xul:hbox class=&quot;tab-image-right&quot; xbl:inherits=&quot;selected&quot;/&gt;</span>
<a href="#l12.435"></a><span id="l12.435">     &lt;/content&gt;</span>
<a href="#l12.436"></a><span id="l12.436"> </span>
<a href="#l12.437"></a><span id="l12.437" class="difflineat">@@ -1625,28 +1706,23 @@</span>
<a href="#l12.438"></a><span id="l12.438">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.439"></a><span id="l12.439">           var menuItem = aEvent.target.mCorrespondingMenuitem;</span>
<a href="#l12.440"></a><span id="l12.440">           if (menuItem) {</span>
<a href="#l12.441"></a><span id="l12.441">             var attrName = aEvent.attrName;</span>
<a href="#l12.442"></a><span id="l12.442">             switch (attrName) {</span>
<a href="#l12.443"></a><span id="l12.443">               case &quot;label&quot;:</span>
<a href="#l12.444"></a><span id="l12.444">               case &quot;crop&quot;:</span>
<a href="#l12.445"></a><span id="l12.445">               case &quot;busy&quot;:</span>
<a href="#l12.446"></a><span id="l12.446" class="difflineplus">+              case &quot;image&quot;:</span>
<a href="#l12.447"></a><span id="l12.447">               case &quot;selected&quot;:</span>
<a href="#l12.448"></a><span id="l12.448">                 if (aEvent.attrChange == aEvent.REMOVAL)</span>
<a href="#l12.449"></a><span id="l12.449">                   menuItem.removeAttribute(attrName);</span>
<a href="#l12.450"></a><span id="l12.450">                 else</span>
<a href="#l12.451"></a><span id="l12.451">                   menuItem.setAttribute(attrName, aEvent.newValue);</span>
<a href="#l12.452"></a><span id="l12.452">             }</span>
<a href="#l12.453"></a><span id="l12.453" class="difflineminus">-            if (attrName == &quot;busy&quot;) {</span>
<a href="#l12.454"></a><span id="l12.454" class="difflineminus">-              // With busy status changes the tab icon</span>
<a href="#l12.455"></a><span id="l12.455" class="difflineminus">-              let style = window.getComputedStyle(aEvent.target, null);</span>
<a href="#l12.456"></a><span id="l12.456" class="difflineminus">-              menuItem.style.listStyleImage = style.listStyleImage;</span>
<a href="#l12.457"></a><span id="l12.457" class="difflineminus">-              menuItem.style.MozImageRegion = style.MozImageRegion;</span>
<a href="#l12.458"></a><span id="l12.458" class="difflineminus">-            }</span>
<a href="#l12.459"></a><span id="l12.459">           }</span>
<a href="#l12.460"></a><span id="l12.460">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.461"></a><span id="l12.461">       &lt;/method&gt;</span>
<a href="#l12.462"></a><span id="l12.462"> </span>
<a href="#l12.463"></a><span id="l12.463">       &lt;method name=&quot;_tabOnTabClose&quot;&gt;</span>
<a href="#l12.464"></a><span id="l12.464">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l12.465"></a><span id="l12.465">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.466"></a><span id="l12.466">           var menuItem = aEvent.target.mCorrespondingMenuitem;</span>
<a href="#l12.467"></a><span id="l12.467" class="difflineat">@@ -1706,21 +1782,17 @@</span>
<a href="#l12.468"></a><span id="l12.468">           var menuItem = document.createElementNS(</span>
<a href="#l12.469"></a><span id="l12.469">             &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;, </span>
<a href="#l12.470"></a><span id="l12.470">             &quot;menuitem&quot;);</span>
<a href="#l12.471"></a><span id="l12.471"> </span>
<a href="#l12.472"></a><span id="l12.472">           menuItem.setAttribute(&quot;class&quot;, &quot;menuitem-iconic alltabs-item&quot;);</span>
<a href="#l12.473"></a><span id="l12.473"> </span>
<a href="#l12.474"></a><span id="l12.474">           menuItem.setAttribute(&quot;label&quot;, aTab.label);</span>
<a href="#l12.475"></a><span id="l12.475">           menuItem.setAttribute(&quot;crop&quot;, aTab.getAttribute(&quot;crop&quot;));</span>
<a href="#l12.476"></a><span id="l12.476" class="difflineminus">-</span>
<a href="#l12.477"></a><span id="l12.477" class="difflineminus">-          // Get the tabicon and set it here</span>
<a href="#l12.478"></a><span id="l12.478" class="difflineminus">-          let style = window.getComputedStyle(aTab, null);</span>
<a href="#l12.479"></a><span id="l12.479" class="difflineminus">-          menuItem.style.listStyleImage = style.listStyleImage;</span>
<a href="#l12.480"></a><span id="l12.480" class="difflineminus">-          menuItem.style.MozImageRegion = style.MozImageRegion;</span>
<a href="#l12.481"></a><span id="l12.481" class="difflineplus">+          menuItem.setAttribute(&quot;image&quot;, aTab.getAttribute(&quot;image&quot;));</span>
<a href="#l12.482"></a><span id="l12.482"> </span>
<a href="#l12.483"></a><span id="l12.483">           if (aTab.hasAttribute(&quot;busy&quot;))</span>
<a href="#l12.484"></a><span id="l12.484">             menuItem.setAttribute(&quot;busy&quot;, aTab.getAttribute(&quot;busy&quot;));</span>
<a href="#l12.485"></a><span id="l12.485">           if (aTab.selected)</span>
<a href="#l12.486"></a><span id="l12.486">             menuItem.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l12.487"></a><span id="l12.487"> </span>
<a href="#l12.488"></a><span id="l12.488">           // Keep some attributes of the menuitem in sync with its</span>
<a href="#l12.489"></a><span id="l12.489">           // corresponding tab (e.g. the tab label)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/base/jar.mn</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/base/jar.mn</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -101,16 +101,19 @@ messenger.jar:</span>
<a href="#l13.4"></a><span id="l13.4">     content/messenger/glodaFacetTab.js              (content/glodaFacetTab.js)</span>
<a href="#l13.5"></a><span id="l13.5">     content/messenger/glodaFacetViewWrapper.xul     (content/glodaFacetViewWrapper.xul)</span>
<a href="#l13.6"></a><span id="l13.6">     content/messenger/glodaFacetView.xhtml          (content/glodaFacetView.xhtml)</span>
<a href="#l13.7"></a><span id="l13.7">     content/messenger/glodaFacetView.js             (content/glodaFacetView.js)</span>
<a href="#l13.8"></a><span id="l13.8">     content/messenger/glodaFacetView.css            (content/glodaFacetView.css)</span>
<a href="#l13.9"></a><span id="l13.9">     content/messenger/glodaFacetBindings.css        (content/glodaFacetBindings.css)</span>
<a href="#l13.10"></a><span id="l13.10">     content/messenger/glodaFacetBindings.xml        (content/glodaFacetBindings.xml)</span>
<a href="#l13.11"></a><span id="l13.11">     content/messenger/glodaFacetVis.js              (content/glodaFacetVis.js)</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+    content/messenger/quickFilterBar.xul            (content/quickFilterBar.xul)</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+    content/messenger/quickFilterBar.js             (content/quickFilterBar.js)</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+    content/messenger/quickFilterBar.css            (content/quickFilterBar.css)</span>
<a href="#l13.15"></a><span id="l13.15">     content/messenger/downloadsOverlay.xul          (content/downloadsOverlay.xul)</span>
<a href="#l13.16"></a><span id="l13.16"> # the following files are mail-specific overrides</span>
<a href="#l13.17"></a><span id="l13.17"> *+  content/messenger/license.html                  (/mozilla/toolkit/content/license.html)</span>
<a href="#l13.18"></a><span id="l13.18"> % override chrome://global/content/license.html chrome://messenger/content/license.html</span>
<a href="#l13.19"></a><span id="l13.19"> </span>
<a href="#l13.20"></a><span id="l13.20"> comm.jar:</span>
<a href="#l13.21"></a><span id="l13.21"> % content communicator %content/communicator/ xpcnativewrappers=yes</span>
<a href="#l13.22"></a><span id="l13.22"> *  content/communicator/contentAreaClick.js         (content/contentAreaClick.js)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/base/modules/Makefile.in</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/base/modules/Makefile.in</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -44,16 +44,16 @@ VPATH   = @srcdir@</span>
<a href="#l14.4"></a><span id="l14.4"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l14.5"></a><span id="l14.5"> </span>
<a href="#l14.6"></a><span id="l14.6"> EXTRA_JS_MODULES = \</span>
<a href="#l14.7"></a><span id="l14.7">   MailConsts.js \</span>
<a href="#l14.8"></a><span id="l14.8">   MailUtils.js \</span>
<a href="#l14.9"></a><span id="l14.9">   attachmentChecker.js \</span>
<a href="#l14.10"></a><span id="l14.10">   dbViewWrapper.js \</span>
<a href="#l14.11"></a><span id="l14.11">   mailViewManager.js \</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-  quickSearchManager.js \</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+  quickFilterManager.js \</span>
<a href="#l14.14"></a><span id="l14.14">   searchSpec.js \</span>
<a href="#l14.15"></a><span id="l14.15">   MsgHdrSyntheticView.js \</span>
<a href="#l14.16"></a><span id="l14.16">   sessionStoreManager.js \</span>
<a href="#l14.17"></a><span id="l14.17">   mailMigrator.js \</span>
<a href="#l14.18"></a><span id="l14.18">   $(NULL)</span>
<a href="#l14.19"></a><span id="l14.19"> </span>
<a href="#l14.20"></a><span id="l14.20"> include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/base/modules/dbViewWrapper.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/base/modules/dbViewWrapper.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1083,21 +1083,26 @@ DBViewWrapper.prototype = {</span>
<a href="#l15.4"></a><span id="l15.4">     let [sortType, sortOrder, sortCustomCol] =</span>
<a href="#l15.5"></a><span id="l15.5">       this._getSortDetails(this._sort.length-1);</span>
<a href="#l15.6"></a><span id="l15.6">     let outCount = {};</span>
<a href="#l15.7"></a><span id="l15.7">     // when the underlying folder is a single real folder (virtual or no), we</span>
<a href="#l15.8"></a><span id="l15.8">     //  tell the view about the underlying folder.</span>
<a href="#l15.9"></a><span id="l15.9">     if (this.isSingleFolder) {</span>
<a href="#l15.10"></a><span id="l15.10">       dbView.open(this._underlyingFolders[0], sortType, sortOrder, viewFlags,</span>
<a href="#l15.11"></a><span id="l15.11">                   outCount);</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-      // but if it's a virtual folder, we need to tell the db view about the</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-      //  the display (virtual) folder so it can store all the view-specific</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+      // If there are any search terms, we need to tell the db view about the</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+      //  the display (/virtual) folder so it can store all the view-specific</span>
<a href="#l15.16"></a><span id="l15.16">       //  data there (things like the active mail view and such that go in</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-      //  dbFolderInfo.)</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-      if (this.isVirtual)</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+      //  dbFolderInfo.)  This also goes for cases where the quick search is</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+      //  active; the C++ code explicitly nulls out the view folder for no</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+      //  good/documented reason, so we need to set it again if we want changes</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+      //  made with the quick filter applied.  (We don't just change the C++</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+      //  code because there could be SeaMonkey fallout.)  See bug 502767 for</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+      //  info about the quick-search part of the problem.</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+      if (this.search.hasSearchTerms)</span>
<a href="#l15.26"></a><span id="l15.26">         dbView.viewFolder = this.displayedFolder;</span>
<a href="#l15.27"></a><span id="l15.27">     }</span>
<a href="#l15.28"></a><span id="l15.28">     // when we're dealing with a multi-folder virtual folder, we just tell the</span>
<a href="#l15.29"></a><span id="l15.29">     //  db view about the display folder.  (It gets its own XFVF view, so it</span>
<a href="#l15.30"></a><span id="l15.30">     //  knows what to do.)</span>
<a href="#l15.31"></a><span id="l15.31">     // and for a synthetic folder, displayedFolder is null anyways</span>
<a href="#l15.32"></a><span id="l15.32">     else {</span>
<a href="#l15.33"></a><span id="l15.33">       dbView.open(this.displayedFolder, sortType, sortOrder, viewFlags,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">new file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- /dev/null</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ b/mail/base/modules/quickFilterManager.js</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -0,0 +1,1344 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineplus">+ *</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+ *</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+ * License.</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+ *</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+ * The Original Code is Thunderbird Email Client.</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+ *</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+ * The Initial Developer of the Original Code is the Mozilla Foundation.</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2010</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+ *</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineplus">+ * Contributor(s):</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineplus">+ *</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+ *</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+const EXPORTED_SYMBOLS = [&quot;QuickFilterState&quot;, &quot;QuickFilterManager&quot;,</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+                          &quot;MessageTextFilter&quot;, &quot;QuickFilterSearchListener&quot;];</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineplus">+const Cr = Components.results;</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+const Cu = Components.utils;</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineplus">+</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+Cu.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+Cu.import(&quot;resource:///modules/searchSpec.js&quot;);</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+Cu.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+Cu.import(&quot;resource:///modules/errUtils.js&quot;);</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineplus">+</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+const Application = Cc[&quot;@mozilla.org/steel/application;1&quot;]</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineplus">+                      .getService(Ci.steelIApplication);</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+const FocusManager = Cc[&quot;@mozilla.org/focus-manager;1&quot;]</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineplus">+                       .getService(Ci.nsIFocusManager);</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+const nsMsgSearchAttrib = Components.interfaces.nsMsgSearchAttrib;</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+const nsMsgMessageFlags = Components.interfaces.nsMsgMessageFlags;</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+const nsMsgSearchOp = Components.interfaces.nsMsgSearchOp;</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineplus">+</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+// XXX we need to know whether the gloda indexer is enabled for upsell reasons,</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineplus">+// but this should really just be exposed on the main Gloda public interface.</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+Cu.import(&quot;resource://app/modules/gloda/indexer.js&quot;);</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineplus">+// we need to be able to create gloda message searcher instances for upsells:</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineplus">+Cu.import(&quot;resource://app/modules/gloda/msg_search.js&quot;);</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineplus">+/**</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+ * Shallow object copy.</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineplus">+ */</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineplus">+function shallowObjCopy(obj) {</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+  let newObj = {};</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineplus">+  for each (let [key, value] in Iterator(obj)) {</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+    newObj[key] = value;</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+  }</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+  return newObj;</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineplus">+}</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineplus">+</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineplus">+/**</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineplus">+ * Should the filter be visible when there's no previous state to propagate it</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineplus">+ *  from?  The idea is that when session persistence is working this should only</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineplus">+ *  ever affect the first time Thunderbird is started up.  Although opening</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineplus">+ *  additional 3-panes will likely trigger this unless we go out of our way to</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineplus">+ *  implement propagation across those boundaries (and we're not).</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineplus">+ */</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineplus">+const FILTER_VISIBILITY_DEFAULT = true;</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineplus">+</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineplus">+/**</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineplus">+ * Represents the state of a quick filter bar.  This mainly decorates the</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineplus">+ *  manipulation of the filter states with support of tracking the filter most</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineplus">+ *  recently manipulated so we can maintain a very limited undo stack of sorts.</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineplus">+ */</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineplus">+function QuickFilterState(aTemplateState, aJsonedState) {</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineplus">+  if (aJsonedState) {</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineplus">+    this.filterValues = aJsonedState.filterValues;</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineplus">+    this.visible = aJsonedState.visible;</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineplus">+  }</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineplus">+  else if (aTemplateState) {</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineplus">+    this.filterValues = QuickFilterManager.propagateValues(</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineplus">+                          aTemplateState.filterValues);</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineplus">+    this.visible = aTemplateState.visible;</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineplus">+  }</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineplus">+  else {</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineplus">+    this.filterValues = QuickFilterManager.getDefaultValues();</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineplus">+    this.visible = FILTER_VISIBILITY_DEFAULT;</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineplus">+  }</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineplus">+  this._lastFilterAttr = null;</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineplus">+}</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineplus">+QuickFilterState.prototype = {</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineplus">+  /**</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineplus">+   * Maps filter names to their current states.  We rely on QuickFilterManager</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineplus">+   *  to do most of the interesting manipulation of this value.</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineplus">+   */</span>
<a href="#l16.117"></a><span id="l16.117" class="difflineplus">+  filterValues: null,</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineplus">+  /**</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineplus">+   * Is the filter bar visible?  Always inherited from the template regardless</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineplus">+   *  of stickyness.</span>
<a href="#l16.121"></a><span id="l16.121" class="difflineplus">+   */</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineplus">+  visible: null,</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineplus">+</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineplus">+  /**</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineplus">+   * Get a filter state and update lastFilterAttr appropriately.  This is</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineplus">+   *  intended for use when the filter state is a rich object whose state</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineplus">+   *  cannot be updated just by clobbering as provided by |setFilterValue|.</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineplus">+   *</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineplus">+   * @param aName The name of the filter we are retrieving.</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineplus">+   * @param [aNoChange=false] Is this actually a change for the purposes of</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineplus">+   *     lastFilterAttr purposes?</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineplus">+   */</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineplus">+  getFilterValue: function MFS_getFilterValue(aName, aNoChange) {</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineplus">+    if (!aNoChange)</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineplus">+      this._lastFilterAttr = aName;</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineplus">+    return this.filterValues[aName];</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineplus">+  },</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineplus">+</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineplus">+  /**</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineplus">+   * Set a filter state and update lastFilterAttr appropriately.</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineplus">+   *</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineplus">+   * @param aName The name of the filter we are setting.</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineplus">+   * @param aValue The value to set; null/undefined implies deletion.</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineplus">+   * @param [aNoChange=false] Is this actually a change for the purposes of</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineplus">+   *     lastFilterAttr purposes?</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineplus">+   */</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineplus">+  setFilterValue: function MFS_setFilterValue(aName, aValue, aNoChange) {</span>
<a href="#l16.148"></a><span id="l16.148" class="difflineplus">+    if (aValue == null) {</span>
<a href="#l16.149"></a><span id="l16.149" class="difflineplus">+      delete this.filterValues[aName];</span>
<a href="#l16.150"></a><span id="l16.150" class="difflineplus">+      return;</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineplus">+    }</span>
<a href="#l16.152"></a><span id="l16.152" class="difflineplus">+</span>
<a href="#l16.153"></a><span id="l16.153" class="difflineplus">+    this.filterValues[aName] = aValue;</span>
<a href="#l16.154"></a><span id="l16.154" class="difflineplus">+    if (!aNoChange)</span>
<a href="#l16.155"></a><span id="l16.155" class="difflineplus">+      this._lastFilterAttr = aName;</span>
<a href="#l16.156"></a><span id="l16.156" class="difflineplus">+  },</span>
<a href="#l16.157"></a><span id="l16.157" class="difflineplus">+</span>
<a href="#l16.158"></a><span id="l16.158" class="difflineplus">+  /**</span>
<a href="#l16.159"></a><span id="l16.159" class="difflineplus">+   * Track the last filter that was affirmatively applied.  If you hit escape</span>
<a href="#l16.160"></a><span id="l16.160" class="difflineplus">+   *  and this value is non-null, we clear the referenced filter constraint.</span>
<a href="#l16.161"></a><span id="l16.161" class="difflineplus">+   *  If you hit escape and the value is null, we clear all filters.</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineplus">+   */</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineplus">+  _lastFilterAttr: null,</span>
<a href="#l16.164"></a><span id="l16.164" class="difflineplus">+</span>
<a href="#l16.165"></a><span id="l16.165" class="difflineplus">+  /**</span>
<a href="#l16.166"></a><span id="l16.166" class="difflineplus">+   * The user hit escape; based on _lastFilterAttr and whether there are any</span>
<a href="#l16.167"></a><span id="l16.167" class="difflineplus">+   *  applied filters, change our constraints.  First press clears the last</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineplus">+   *  added constraint (if any), second press (or if no last constraint) clears</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineplus">+   *  the state entirely.</span>
<a href="#l16.170"></a><span id="l16.170" class="difflineplus">+   *</span>
<a href="#l16.171"></a><span id="l16.171" class="difflineplus">+   * @return true if we relaxed the state, false if there was nothing to relax.</span>
<a href="#l16.172"></a><span id="l16.172" class="difflineplus">+   */</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineplus">+  userHitEscape: function MFS_userHitEscape() {</span>
<a href="#l16.174"></a><span id="l16.174" class="difflineplus">+    if (this._lastFilterAttr) {</span>
<a href="#l16.175"></a><span id="l16.175" class="difflineplus">+      QuickFilterManager.clearFilterValue(this._lastFilterAttr,</span>
<a href="#l16.176"></a><span id="l16.176" class="difflineplus">+                                            this.filterValues);</span>
<a href="#l16.177"></a><span id="l16.177" class="difflineplus">+      this._lastFilterAttr = null;</span>
<a href="#l16.178"></a><span id="l16.178" class="difflineplus">+      return true;</span>
<a href="#l16.179"></a><span id="l16.179" class="difflineplus">+    }</span>
<a href="#l16.180"></a><span id="l16.180" class="difflineplus">+</span>
<a href="#l16.181"></a><span id="l16.181" class="difflineplus">+    return QuickFilterManager.clearAllFilterValues(this.filterValues);</span>
<a href="#l16.182"></a><span id="l16.182" class="difflineplus">+  },</span>
<a href="#l16.183"></a><span id="l16.183" class="difflineplus">+</span>
<a href="#l16.184"></a><span id="l16.184" class="difflineplus">+  /**</span>
<a href="#l16.185"></a><span id="l16.185" class="difflineplus">+   * Clear the state without going through any undo-ish steps like</span>
<a href="#l16.186"></a><span id="l16.186" class="difflineplus">+   *  |userHitEscape| tries to do.</span>
<a href="#l16.187"></a><span id="l16.187" class="difflineplus">+   */</span>
<a href="#l16.188"></a><span id="l16.188" class="difflineplus">+  clear: function MFS_clear() {</span>
<a href="#l16.189"></a><span id="l16.189" class="difflineplus">+    QuickFilterManager.clearAllFilterValues(this.filterValues);</span>
<a href="#l16.190"></a><span id="l16.190" class="difflineplus">+  },</span>
<a href="#l16.191"></a><span id="l16.191" class="difflineplus">+</span>
<a href="#l16.192"></a><span id="l16.192" class="difflineplus">+  /**</span>
<a href="#l16.193"></a><span id="l16.193" class="difflineplus">+   * Create the search terms appropriate to the current filter states.</span>
<a href="#l16.194"></a><span id="l16.194" class="difflineplus">+   */</span>
<a href="#l16.195"></a><span id="l16.195" class="difflineplus">+  createSearchTerms: function MFS_createSearchTerms(aTermCreator) {</span>
<a href="#l16.196"></a><span id="l16.196" class="difflineplus">+    return QuickFilterManager.createSearchTerms(this.filterValues,</span>
<a href="#l16.197"></a><span id="l16.197" class="difflineplus">+                                                aTermCreator);</span>
<a href="#l16.198"></a><span id="l16.198" class="difflineplus">+  },</span>
<a href="#l16.199"></a><span id="l16.199" class="difflineplus">+</span>
<a href="#l16.200"></a><span id="l16.200" class="difflineplus">+  persistToObj: function MFS_persistToObj() {</span>
<a href="#l16.201"></a><span id="l16.201" class="difflineplus">+    return {</span>
<a href="#l16.202"></a><span id="l16.202" class="difflineplus">+      filterValues: this.filterValues,</span>
<a href="#l16.203"></a><span id="l16.203" class="difflineplus">+      visible: this.visible,</span>
<a href="#l16.204"></a><span id="l16.204" class="difflineplus">+    };</span>
<a href="#l16.205"></a><span id="l16.205" class="difflineplus">+  },</span>
<a href="#l16.206"></a><span id="l16.206" class="difflineplus">+};</span>
<a href="#l16.207"></a><span id="l16.207" class="difflineplus">+</span>
<a href="#l16.208"></a><span id="l16.208" class="difflineplus">+/**</span>
<a href="#l16.209"></a><span id="l16.209" class="difflineplus">+ * An nsIMsgSearchNotify listener wrapper to facilitate faceting of messages</span>
<a href="#l16.210"></a><span id="l16.210" class="difflineplus">+ *  being returned by a search.  We have to use a listener because the</span>
<a href="#l16.211"></a><span id="l16.211" class="difflineplus">+ *  nsMsgDBView includes presentation logic and unless we force all of its</span>
<a href="#l16.212"></a><span id="l16.212" class="difflineplus">+ *  results to be fully expanded (and dummy headers ignored), we can't get</span>
<a href="#l16.213"></a><span id="l16.213" class="difflineplus">+ *  at all the messages reliably.</span>
<a href="#l16.214"></a><span id="l16.214" class="difflineplus">+ *</span>
<a href="#l16.215"></a><span id="l16.215" class="difflineplus">+ * We need to provide a wrapper so that:</span>
<a href="#l16.216"></a><span id="l16.216" class="difflineplus">+ * - We can provide better error handling support.</span>
<a href="#l16.217"></a><span id="l16.217" class="difflineplus">+ * - We can provide better GC support.</span>
<a href="#l16.218"></a><span id="l16.218" class="difflineplus">+ * - We can ensure the right life-cycle stuff happens (unregister ourselves as</span>
<a href="#l16.219"></a><span id="l16.219" class="difflineplus">+ *   a listener, namely.)</span>
<a href="#l16.220"></a><span id="l16.220" class="difflineplus">+ *</span>
<a href="#l16.221"></a><span id="l16.221" class="difflineplus">+ * It is nice that we have a wrapper so that:</span>
<a href="#l16.222"></a><span id="l16.222" class="difflineplus">+ * - We can provide context to the thing we are calling that it does not need</span>
<a href="#l16.223"></a><span id="l16.223" class="difflineplus">+ *  to maintain.</span>
<a href="#l16.224"></a><span id="l16.224" class="difflineplus">+ *</span>
<a href="#l16.225"></a><span id="l16.225" class="difflineplus">+ * The listener should implement the following methods:</span>
<a href="#l16.226"></a><span id="l16.226" class="difflineplus">+ *</span>
<a href="#l16.227"></a><span id="l16.227" class="difflineplus">+ * - function onSearchStart(aCurState) returning aScratch.</span>
<a href="#l16.228"></a><span id="l16.228" class="difflineplus">+ *   This function should initialize the scratch object that will be passed to</span>
<a href="#l16.229"></a><span id="l16.229" class="difflineplus">+ *    onSearchMessage and onSearchDone.  This is an attempt to provide a</span>
<a href="#l16.230"></a><span id="l16.230" class="difflineplus">+ *    friendly API that provides debugging support by dumping the state of</span>
<a href="#l16.231"></a><span id="l16.231" class="difflineplus">+ *    said object when things go wrong.</span>
<a href="#l16.232"></a><span id="l16.232" class="difflineplus">+ *</span>
<a href="#l16.233"></a><span id="l16.233" class="difflineplus">+ * - function onSearchMessage(aScratch, aMsgHdr, aFolder)</span>
<a href="#l16.234"></a><span id="l16.234" class="difflineplus">+ *   Processes messages reported as search hits.  Its only context is the</span>
<a href="#l16.235"></a><span id="l16.235" class="difflineplus">+ *    object you returned from onSearchStart.  Take the hint and try and keep</span>
<a href="#l16.236"></a><span id="l16.236" class="difflineplus">+ *    this method efficient!  We will catch all exceptions for you and report</span>
<a href="#l16.237"></a><span id="l16.237" class="difflineplus">+ *    errors.  We will also handle forcing GCs as appropriate.</span>
<a href="#l16.238"></a><span id="l16.238" class="difflineplus">+ *</span>
<a href="#l16.239"></a><span id="l16.239" class="difflineplus">+ * - function onSearchDone(aCurState, aScratch, aSuccess) returning</span>
<a href="#l16.240"></a><span id="l16.240" class="difflineplus">+ *    [new state for your filter, should call reflectInDOM, should treat the</span>
<a href="#l16.241"></a><span id="l16.241" class="difflineplus">+ *     state as if it is a result of user action].</span>
<a href="#l16.242"></a><span id="l16.242" class="difflineplus">+ *   This ends up looking exactly the same as the postFilterProcess handler</span>
<a href="#l16.243"></a><span id="l16.243" class="difflineplus">+ *</span>
<a href="#l16.244"></a><span id="l16.244" class="difflineplus">+ * @param aFolderDisplay The folder display we are working in service of.</span>
<a href="#l16.245"></a><span id="l16.245" class="difflineplus">+ * @param aFilterer The QuickFilterState instance.</span>
<a href="#l16.246"></a><span id="l16.246" class="difflineplus">+ * @param aListener The thing on which we invoke methods.</span>
<a href="#l16.247"></a><span id="l16.247" class="difflineplus">+ */</span>
<a href="#l16.248"></a><span id="l16.248" class="difflineplus">+function QuickFilterSearchListener(aFolderDisplay, aFilterer, aFilterDef,</span>
<a href="#l16.249"></a><span id="l16.249" class="difflineplus">+                                   aListener, aMuxer) {</span>
<a href="#l16.250"></a><span id="l16.250" class="difflineplus">+  this.folderDisplay = aFolderDisplay;</span>
<a href="#l16.251"></a><span id="l16.251" class="difflineplus">+  this.filterer = aFilterer;</span>
<a href="#l16.252"></a><span id="l16.252" class="difflineplus">+  this.filterDef = aFilterDef;</span>
<a href="#l16.253"></a><span id="l16.253" class="difflineplus">+  this.listener = aListener;</span>
<a href="#l16.254"></a><span id="l16.254" class="difflineplus">+  this.muxer = aMuxer;</span>
<a href="#l16.255"></a><span id="l16.255" class="difflineplus">+  this.folderDisplay = aFolderDisplay;</span>
<a href="#l16.256"></a><span id="l16.256" class="difflineplus">+</span>
<a href="#l16.257"></a><span id="l16.257" class="difflineplus">+  this.session = aFolderDisplay.view.search.session;</span>
<a href="#l16.258"></a><span id="l16.258" class="difflineplus">+</span>
<a href="#l16.259"></a><span id="l16.259" class="difflineplus">+  this.scratch = null;</span>
<a href="#l16.260"></a><span id="l16.260" class="difflineplus">+  this.count = 0;</span>
<a href="#l16.261"></a><span id="l16.261" class="difflineplus">+  this.started = false;</span>
<a href="#l16.262"></a><span id="l16.262" class="difflineplus">+</span>
<a href="#l16.263"></a><span id="l16.263" class="difflineplus">+  this.session.registerListener(this,</span>
<a href="#l16.264"></a><span id="l16.264" class="difflineplus">+                                Ci.nsIMsgSearchSession.allNotifications);</span>
<a href="#l16.265"></a><span id="l16.265" class="difflineplus">+}</span>
<a href="#l16.266"></a><span id="l16.266" class="difflineplus">+QuickFilterSearchListener.prototype = {</span>
<a href="#l16.267"></a><span id="l16.267" class="difflineplus">+  onNewSearch: function QuickFilterSearchListener_onNewSearch() {</span>
<a href="#l16.268"></a><span id="l16.268" class="difflineplus">+    this.started = true;</span>
<a href="#l16.269"></a><span id="l16.269" class="difflineplus">+    let curState = (this.filterDef.name in this.filterer.filterValues) ?</span>
<a href="#l16.270"></a><span id="l16.270" class="difflineplus">+                     this.filterer.filterValues[this.filterDef.name] : null;</span>
<a href="#l16.271"></a><span id="l16.271" class="difflineplus">+    this.scratch = this.listener.onSearchStart(curState);</span>
<a href="#l16.272"></a><span id="l16.272" class="difflineplus">+  },</span>
<a href="#l16.273"></a><span id="l16.273" class="difflineplus">+</span>
<a href="#l16.274"></a><span id="l16.274" class="difflineplus">+  onSearchHit: function QuickFilterSearchListener_onSearchHit(aMsgHdr,</span>
<a href="#l16.275"></a><span id="l16.275" class="difflineplus">+                                                              aFolder) {</span>
<a href="#l16.276"></a><span id="l16.276" class="difflineplus">+    // GC sanity demands that we trigger a GC if we have seen a large number</span>
<a href="#l16.277"></a><span id="l16.277" class="difflineplus">+    //  of headers.  Because we are driven by the search mechanism which likes</span>
<a href="#l16.278"></a><span id="l16.278" class="difflineplus">+    //  to time-slice when it has a lot of messages on its plate, it is</span>
<a href="#l16.279"></a><span id="l16.279" class="difflineplus">+    //  conceivable something else may trigger a GC for us.  Unfortunately,</span>
<a href="#l16.280"></a><span id="l16.280" class="difflineplus">+    //  we can't guarantee it, as XPConnect does not inform memory pressure,</span>
<a href="#l16.281"></a><span id="l16.281" class="difflineplus">+    //  so it's us to stop-gap it.</span>
<a href="#l16.282"></a><span id="l16.282" class="difflineplus">+    this.count++;</span>
<a href="#l16.283"></a><span id="l16.283" class="difflineplus">+    if (!(this.count % 4096))</span>
<a href="#l16.284"></a><span id="l16.284" class="difflineplus">+      Cu.forceGC();</span>
<a href="#l16.285"></a><span id="l16.285" class="difflineplus">+</span>
<a href="#l16.286"></a><span id="l16.286" class="difflineplus">+    try {</span>
<a href="#l16.287"></a><span id="l16.287" class="difflineplus">+      this.listener.onSearchMessage(this.scratch, aMsgHdr, aFolder);</span>
<a href="#l16.288"></a><span id="l16.288" class="difflineplus">+    }</span>
<a href="#l16.289"></a><span id="l16.289" class="difflineplus">+    catch (ex) {</span>
<a href="#l16.290"></a><span id="l16.290" class="difflineplus">+      logException(ex);</span>
<a href="#l16.291"></a><span id="l16.291" class="difflineplus">+      logObject(this.scratch, &quot;scratch object&quot;);</span>
<a href="#l16.292"></a><span id="l16.292" class="difflineplus">+    }</span>
<a href="#l16.293"></a><span id="l16.293" class="difflineplus">+  },</span>
<a href="#l16.294"></a><span id="l16.294" class="difflineplus">+</span>
<a href="#l16.295"></a><span id="l16.295" class="difflineplus">+  onSearchDone: function QuickFilterSearchListener_onSearchDone(aStatus) {</span>
<a href="#l16.296"></a><span id="l16.296" class="difflineplus">+    // it's possible we will see the tail end of an existing search. ignore.</span>
<a href="#l16.297"></a><span id="l16.297" class="difflineplus">+    if (!this.started)</span>
<a href="#l16.298"></a><span id="l16.298" class="difflineplus">+      return;</span>
<a href="#l16.299"></a><span id="l16.299" class="difflineplus">+</span>
<a href="#l16.300"></a><span id="l16.300" class="difflineplus">+    this.session.unregisterListener(this);</span>
<a href="#l16.301"></a><span id="l16.301" class="difflineplus">+</span>
<a href="#l16.302"></a><span id="l16.302" class="difflineplus">+    let curState = (this.filterDef.name in this.filterer.filterValues) ?</span>
<a href="#l16.303"></a><span id="l16.303" class="difflineplus">+                     this.filterer.filterValues[this.filterDef.name] : null;</span>
<a href="#l16.304"></a><span id="l16.304" class="difflineplus">+    let [newState, update, treatAsUserAction] =</span>
<a href="#l16.305"></a><span id="l16.305" class="difflineplus">+      this.listener.onSearchDone(curState, this.scratch, aStatus);</span>
<a href="#l16.306"></a><span id="l16.306" class="difflineplus">+</span>
<a href="#l16.307"></a><span id="l16.307" class="difflineplus">+    this.filterer.setFilterValue(this.filterDef.name, newState,</span>
<a href="#l16.308"></a><span id="l16.308" class="difflineplus">+                                 !treatAsUserAction);</span>
<a href="#l16.309"></a><span id="l16.309" class="difflineplus">+    if (update &amp;&amp; this.folderDisplay.active) {</span>
<a href="#l16.310"></a><span id="l16.310" class="difflineplus">+     this.muxer.reflectFiltererState(this.filterer, this.folderDisplay,</span>
<a href="#l16.311"></a><span id="l16.311" class="difflineplus">+                                     this.filterDef.name);</span>
<a href="#l16.312"></a><span id="l16.312" class="difflineplus">+    }</span>
<a href="#l16.313"></a><span id="l16.313" class="difflineplus">+  },</span>
<a href="#l16.314"></a><span id="l16.314" class="difflineplus">+};</span>
<a href="#l16.315"></a><span id="l16.315" class="difflineplus">+</span>
<a href="#l16.316"></a><span id="l16.316" class="difflineplus">+/**</span>
<a href="#l16.317"></a><span id="l16.317" class="difflineplus">+ * Extensible mechanism for defining filters for the quick filter bar.  This</span>
<a href="#l16.318"></a><span id="l16.318" class="difflineplus">+ * is the spiritual successor to the mailViewManager and quickSearchManager.</span>
<a href="#l16.319"></a><span id="l16.319" class="difflineplus">+ *</span>
<a href="#l16.320"></a><span id="l16.320" class="difflineplus">+ * The manager includes and requires UI-relevant metadata for use by its</span>
<a href="#l16.321"></a><span id="l16.321" class="difflineplus">+ * counterparts in quickFilterBar.js.  New filters are expected to contribute</span>
<a href="#l16.322"></a><span id="l16.322" class="difflineplus">+ * DOM nodes to the overlay and tell us about them using their id during</span>
<a href="#l16.323"></a><span id="l16.323" class="difflineplus">+ * registration.</span>
<a href="#l16.324"></a><span id="l16.324" class="difflineplus">+ *</span>
<a href="#l16.325"></a><span id="l16.325" class="difflineplus">+ * We support two types of filtery things.</span>
<a href="#l16.326"></a><span id="l16.326" class="difflineplus">+ * - Filters via defineFilter.</span>
<a href="#l16.327"></a><span id="l16.327" class="difflineplus">+ * - Text filters via defineTextFilter.  These always take the filter text as</span>
<a href="#l16.328"></a><span id="l16.328" class="difflineplus">+ *   a parameter.</span>
<a href="#l16.329"></a><span id="l16.329" class="difflineplus">+ *</span>
<a href="#l16.330"></a><span id="l16.330" class="difflineplus">+ * If you are an adventurous extension developer and want to add a magic</span>
<a href="#l16.331"></a><span id="l16.331" class="difflineplus">+ * text filter that does the whole &quot;from:bob to:jim subject:shoes&quot; what you</span>
<a href="#l16.332"></a><span id="l16.332" class="difflineplus">+ * will want to do is register a normal filter and collapse the normal text</span>
<a href="#l16.333"></a><span id="l16.333" class="difflineplus">+ * filter text-box.  You add your own text box, etc.</span>
<a href="#l16.334"></a><span id="l16.334" class="difflineplus">+ */</span>
<a href="#l16.335"></a><span id="l16.335" class="difflineplus">+let QuickFilterManager = {</span>
<a href="#l16.336"></a><span id="l16.336" class="difflineplus">+  /**</span>
<a href="#l16.337"></a><span id="l16.337" class="difflineplus">+   * List of filter definitions, potentially prioritized.</span>
<a href="#l16.338"></a><span id="l16.338" class="difflineplus">+   */</span>
<a href="#l16.339"></a><span id="l16.339" class="difflineplus">+  filterDefs: [],</span>
<a href="#l16.340"></a><span id="l16.340" class="difflineplus">+  /**</span>
<a href="#l16.341"></a><span id="l16.341" class="difflineplus">+   * Keys are filter definition names, values are the filter defs.</span>
<a href="#l16.342"></a><span id="l16.342" class="difflineplus">+   */</span>
<a href="#l16.343"></a><span id="l16.343" class="difflineplus">+  filterDefsByName: {},</span>
<a href="#l16.344"></a><span id="l16.344" class="difflineplus">+  /**</span>
<a href="#l16.345"></a><span id="l16.345" class="difflineplus">+   * The DOM id of the text widget that should get focused when the user hits</span>
<a href="#l16.346"></a><span id="l16.346" class="difflineplus">+   *  control-f or the equivalent.  This is here so it can get clobbered.</span>
<a href="#l16.347"></a><span id="l16.347" class="difflineplus">+   */</span>
<a href="#l16.348"></a><span id="l16.348" class="difflineplus">+  textBoxDomId: null,</span>
<a href="#l16.349"></a><span id="l16.349" class="difflineplus">+</span>
<a href="#l16.350"></a><span id="l16.350" class="difflineplus">+  /**</span>
<a href="#l16.351"></a><span id="l16.351" class="difflineplus">+   * Define a new filter.</span>
<a href="#l16.352"></a><span id="l16.352" class="difflineplus">+   *</span>
<a href="#l16.353"></a><span id="l16.353" class="difflineplus">+   * Filter states must always be JSON serializable.  A state of undefined means</span>
<a href="#l16.354"></a><span id="l16.354" class="difflineplus">+   * that we are not persisting any state for your filter.</span>
<a href="#l16.355"></a><span id="l16.355" class="difflineplus">+   *</span>
<a href="#l16.356"></a><span id="l16.356" class="difflineplus">+   * @param {String} aFilterDef.name The name of your filter.  This is the name</span>
<a href="#l16.357"></a><span id="l16.357" class="difflineplus">+   *     of the attribute we cram your state into the state dictionary as, so</span>
<a href="#l16.358"></a><span id="l16.358" class="difflineplus">+   *     the key thing is that it doesn't conflict with other id's.</span>
<a href="#l16.359"></a><span id="l16.359" class="difflineplus">+   * @param {String} aFilterDef.domId The id of the DOM node that you have</span>
<a href="#l16.360"></a><span id="l16.360" class="difflineplus">+   *     overlayed into the quick filter bar.</span>
<a href="#l16.361"></a><span id="l16.361" class="difflineplus">+   * @param {function(aTermCreator, aTerms, aState)} aFilterDef.appendTerms</span>
<a href="#l16.362"></a><span id="l16.362" class="difflineplus">+   *     The function to invoke to contribute your terms to the list of</span>
<a href="#l16.363"></a><span id="l16.363" class="difflineplus">+   *     search terms in aTerms.  Your function will not be invoked if you do</span>
<a href="#l16.364"></a><span id="l16.364" class="difflineplus">+   *     not have any currently persisted state (as is the case if null or</span>
<a href="#l16.365"></a><span id="l16.365" class="difflineplus">+   *     undefined was set).  If you have nothing to add, then don't do</span>
<a href="#l16.366"></a><span id="l16.366" class="difflineplus">+   *     anything.  If you do add terms, the first term you add needs to have</span>
<a href="#l16.367"></a><span id="l16.367" class="difflineplus">+   *     the booleanAnd flag set to true.  You may optionally return a listener</span>
<a href="#l16.368"></a><span id="l16.368" class="difflineplus">+   *     that complies with the documentation on QuickFilterSearchListener if</span>
<a href="#l16.369"></a><span id="l16.369" class="difflineplus">+   *     you want to process all of the messages returned by the filter; doing</span>
<a href="#l16.370"></a><span id="l16.370" class="difflineplus">+   *     so is not cheap, so don't do that lightly.  (Tag faceting uses this.)</span>
<a href="#l16.371"></a><span id="l16.371" class="difflineplus">+   * @param {function()} [aFilterDef.getDefaults] Function that returns the</span>
<a href="#l16.372"></a><span id="l16.372" class="difflineplus">+   *     default state for the filter.  If the function is not defined or the</span>
<a href="#l16.373"></a><span id="l16.373" class="difflineplus">+   *     returned value is === undefined, no state is set.</span>
<a href="#l16.374"></a><span id="l16.374" class="difflineplus">+   * @param {function(aTemplState, aSticky)} [aFilterDef.propagateState] A</span>
<a href="#l16.375"></a><span id="l16.375" class="difflineplus">+   *     function that takes the state from another QuickFilterState instance</span>
<a href="#l16.376"></a><span id="l16.376" class="difflineplus">+   *     for this definition and propagates it to a new state which it returns.</span>
<a href="#l16.377"></a><span id="l16.377" class="difflineplus">+   *     You would use this to keep the 'sticky' bits of state that you want to</span>
<a href="#l16.378"></a><span id="l16.378" class="difflineplus">+   *     persist between folder changes and when new tabs are opened.  The</span>
<a href="#l16.379"></a><span id="l16.379" class="difflineplus">+   *     aSticky argument tells you if the user wants all the filters still</span>
<a href="#l16.380"></a><span id="l16.380" class="difflineplus">+   *     applied or not.  When false, the idea is you might keep things like</span>
<a href="#l16.381"></a><span id="l16.381" class="difflineplus">+   *     which text fields to filter on, but not the text to filter.  When true,</span>
<a href="#l16.382"></a><span id="l16.382" class="difflineplus">+   *     you would keep the text to filter on too.  Return undefined if you do</span>
<a href="#l16.383"></a><span id="l16.383" class="difflineplus">+   *     not want any state stored in the new filter state.  If you do not</span>
<a href="#l16.384"></a><span id="l16.384" class="difflineplus">+   *     define this function and aSticky would be true, we will propagate your</span>
<a href="#l16.385"></a><span id="l16.385" class="difflineplus">+   *     state verbatim; accordingly functions using rich object state must</span>
<a href="#l16.386"></a><span id="l16.386" class="difflineplus">+   *     implement this method.</span>
<a href="#l16.387"></a><span id="l16.387" class="difflineplus">+   * @param {function(aState)} [aFilterDef.clearState] Function to reset the</span>
<a href="#l16.388"></a><span id="l16.388" class="difflineplus">+   *     the filter's value for the given state, returning a tuple of the new</span>
<a href="#l16.389"></a><span id="l16.389" class="difflineplus">+   *     state and a boolean flag indicating whether there was actually state to</span>
<a href="#l16.390"></a><span id="l16.390" class="difflineplus">+   *     clear.  This is used when the user decides to reset the state of the</span>
<a href="#l16.391"></a><span id="l16.391" class="difflineplus">+   *     filter bar or (just one specific filter).  If omitted, we just delete</span>
<a href="#l16.392"></a><span id="l16.392" class="difflineplus">+   *     the filter state entirely, so you only need to define this if you have</span>
<a href="#l16.393"></a><span id="l16.393" class="difflineplus">+   *     some sticky meta-state you want to maintain.  Return undefined for the</span>
<a href="#l16.394"></a><span id="l16.394" class="difflineplus">+   *     state value if you do not need any state kept around.</span>
<a href="#l16.395"></a><span id="l16.395" class="difflineplus">+   * @param {function(aDocument, aMuxer, aNode)} [aFilterDef.domBindExtra]</span>
<a href="#l16.396"></a><span id="l16.396" class="difflineplus">+   *     Function invoked at initial UI binding of the quick filter bar after</span>
<a href="#l16.397"></a><span id="l16.397" class="difflineplus">+   *     we add a command listener to whatever is identified by domId.  If you</span>
<a href="#l16.398"></a><span id="l16.398" class="difflineplus">+   *     have additional widgets to hook up, this is where you do it.  aDocument</span>
<a href="#l16.399"></a><span id="l16.399" class="difflineplus">+   *     and aMuxer are provided to assist in this endeavor.  Use aMuxer's</span>
<a href="#l16.400"></a><span id="l16.400" class="difflineplus">+   *     getFilterValueForMutation/setFilterValue/updateSearch methods from any</span>
<a href="#l16.401"></a><span id="l16.401" class="difflineplus">+   *     event handlers you register.</span>
<a href="#l16.402"></a><span id="l16.402" class="difflineplus">+   * @param {function(aState, aNode, aEvent, aDocument)} [aFilterDef.onCommand]</span>
<a href="#l16.403"></a><span id="l16.403" class="difflineplus">+   *     If omitted, the default handler assumes your widget has a &quot;checked&quot;</span>
<a href="#l16.404"></a><span id="l16.404" class="difflineplus">+   *     state that should set your state value to true when checked and delete</span>
<a href="#l16.405"></a><span id="l16.405" class="difflineplus">+   *     the state when unchecked.  Implement this function if that is not what</span>
<a href="#l16.406"></a><span id="l16.406" class="difflineplus">+   *     you need.  The function should return a tuple of [new state, should</span>
<a href="#l16.407"></a><span id="l16.407" class="difflineplus">+   *     update the search] as its result.</span>
<a href="#l16.408"></a><span id="l16.408" class="difflineplus">+   * @param {function(aDomNode, aFilterValue, aDoc, aMuxer)}</span>
<a href="#l16.409"></a><span id="l16.409" class="difflineplus">+   *     [aFilterDef.reflectInDOM]</span>
<a href="#l16.410"></a><span id="l16.410" class="difflineplus">+   *     If omitted, we assume the widget referenced by domId has a checked</span>
<a href="#l16.411"></a><span id="l16.411" class="difflineplus">+   *     attribute and assign the filter value coerced to a boolean to the</span>
<a href="#l16.412"></a><span id="l16.412" class="difflineplus">+   *     checked attribute.  Otherwise we call your function and it's up to you</span>
<a href="#l16.413"></a><span id="l16.413" class="difflineplus">+   *     to reflect your state.  aDomNode is the node referred to by domId.</span>
<a href="#l16.414"></a><span id="l16.414" class="difflineplus">+   *     This function will be called when the tab changes, folder changes, or</span>
<a href="#l16.415"></a><span id="l16.415" class="difflineplus">+   *     if we called postFilterProcess and you returned a value !== undefined.</span>
<a href="#l16.416"></a><span id="l16.416" class="difflineplus">+   * @param {function(aState, aViewWrapper, aFiltering)}</span>
<a href="#l16.417"></a><span id="l16.417" class="difflineplus">+   *     [aFilterDef.postFilterProcess]</span>
<a href="#l16.418"></a><span id="l16.418" class="difflineplus">+   *     Invoked after all of the message headers for the view have been</span>
<a href="#l16.419"></a><span id="l16.419" class="difflineplus">+   *     displayed, allowing your code to perform some kind of faceting or other</span>
<a href="#l16.420"></a><span id="l16.420" class="difflineplus">+   *     clever logic.  Return a tuple of [new state, should call reflectInDOM,</span>
<a href="#l16.421"></a><span id="l16.421" class="difflineplus">+   *     should treat as if the user modified the state].  We call this _even</span>
<a href="#l16.422"></a><span id="l16.422" class="difflineplus">+   *     when there is no filter_ applied.  We tell you what's happening via</span>
<a href="#l16.423"></a><span id="l16.423" class="difflineplus">+   *     aFiltering; true means we have applied some terms, false means not.</span>
<a href="#l16.424"></a><span id="l16.424" class="difflineplus">+   *     It's vitally important that you do not just facet things willy nilly</span>
<a href="#l16.425"></a><span id="l16.425" class="difflineplus">+   *     unless there is expected user payoff and they opted in.  Our tagging UI</span>
<a href="#l16.426"></a><span id="l16.426" class="difflineplus">+   *     only facets when the user clicked the tag facet.  If you write an</span>
<a href="#l16.427"></a><span id="l16.427" class="difflineplus">+   *     extension that provides really sweet visualizations or something like</span>
<a href="#l16.428"></a><span id="l16.428" class="difflineplus">+   *     that and the user installs you knowing what's what, that is also cool,</span>
<a href="#l16.429"></a><span id="l16.429" class="difflineplus">+   *     we just can't do it in core for now.</span>
<a href="#l16.430"></a><span id="l16.430" class="difflineplus">+   */</span>
<a href="#l16.431"></a><span id="l16.431" class="difflineplus">+  defineFilter: function MFM_defineFilter(aFilterDef) {</span>
<a href="#l16.432"></a><span id="l16.432" class="difflineplus">+    this.filterDefs.push(aFilterDef);</span>
<a href="#l16.433"></a><span id="l16.433" class="difflineplus">+    this.filterDefsByName[aFilterDef.name] = aFilterDef;</span>
<a href="#l16.434"></a><span id="l16.434" class="difflineplus">+  },</span>
<a href="#l16.435"></a><span id="l16.435" class="difflineplus">+</span>
<a href="#l16.436"></a><span id="l16.436" class="difflineplus">+  /**</span>
<a href="#l16.437"></a><span id="l16.437" class="difflineplus">+   * Remove a filter from existence by name.  This is for extensions to disable</span>
<a href="#l16.438"></a><span id="l16.438" class="difflineplus">+   *  existing filters and not a dynamic jetpack-like lifecycle.  It falls to</span>
<a href="#l16.439"></a><span id="l16.439" class="difflineplus">+   *  the code calling killFilter to deal with the DOM nodes themselves for now.</span>
<a href="#l16.440"></a><span id="l16.440" class="difflineplus">+   *</span>
<a href="#l16.441"></a><span id="l16.441" class="difflineplus">+   * @param aName The name of the filter to kill.</span>
<a href="#l16.442"></a><span id="l16.442" class="difflineplus">+   */</span>
<a href="#l16.443"></a><span id="l16.443" class="difflineplus">+  killFilter: function MFM_killFilter(aName) {</span>
<a href="#l16.444"></a><span id="l16.444" class="difflineplus">+    let filterDef = this.filterDefsByName[aName];</span>
<a href="#l16.445"></a><span id="l16.445" class="difflineplus">+    this.filterDefs.splice(this.filterDefs.indexOf(aName), 1);</span>
<a href="#l16.446"></a><span id="l16.446" class="difflineplus">+    delete this.filterDefsByName[aName];</span>
<a href="#l16.447"></a><span id="l16.447" class="difflineplus">+  },</span>
<a href="#l16.448"></a><span id="l16.448" class="difflineplus">+</span>
<a href="#l16.449"></a><span id="l16.449" class="difflineplus">+  /**</span>
<a href="#l16.450"></a><span id="l16.450" class="difflineplus">+   * Propagate values from an existing state into a new state based on</span>
<a href="#l16.451"></a><span id="l16.451" class="difflineplus">+   *  propagation rules.  For use by QuickFilterState.</span>
<a href="#l16.452"></a><span id="l16.452" class="difflineplus">+   *</span>
<a href="#l16.453"></a><span id="l16.453" class="difflineplus">+   * @param aTemplValues A set of existing filterValues.</span>
<a href="#l16.454"></a><span id="l16.454" class="difflineplus">+   * @return The new filterValues state.</span>
<a href="#l16.455"></a><span id="l16.455" class="difflineplus">+   */</span>
<a href="#l16.456"></a><span id="l16.456" class="difflineplus">+  propagateValues: function MFM_propagateValues(aTemplValues) {</span>
<a href="#l16.457"></a><span id="l16.457" class="difflineplus">+    let values = {};</span>
<a href="#l16.458"></a><span id="l16.458" class="difflineplus">+    let sticky = (&quot;sticky&quot; in aTemplValues) ? aTemplValues.sticky : false;</span>
<a href="#l16.459"></a><span id="l16.459" class="difflineplus">+</span>
<a href="#l16.460"></a><span id="l16.460" class="difflineplus">+    for each (let [, filterDef] in Iterator(this.filterDefs)) {</span>
<a href="#l16.461"></a><span id="l16.461" class="difflineplus">+      if (&quot;propagateState&quot; in filterDef) {</span>
<a href="#l16.462"></a><span id="l16.462" class="difflineplus">+        let curValue = (filterDef.name in aTemplValues) ?</span>
<a href="#l16.463"></a><span id="l16.463" class="difflineplus">+                         aTemplValues[filterDef.name] : undefined;</span>
<a href="#l16.464"></a><span id="l16.464" class="difflineplus">+        let newValue = filterDef.propagateState(curValue, sticky);</span>
<a href="#l16.465"></a><span id="l16.465" class="difflineplus">+        if (newValue !== undefined)</span>
<a href="#l16.466"></a><span id="l16.466" class="difflineplus">+          values[filterDef.name] = newValue;</span>
<a href="#l16.467"></a><span id="l16.467" class="difflineplus">+      }</span>
<a href="#l16.468"></a><span id="l16.468" class="difflineplus">+      // always propagate the value if sticky and there was no handler</span>
<a href="#l16.469"></a><span id="l16.469" class="difflineplus">+      else if (sticky) {</span>
<a href="#l16.470"></a><span id="l16.470" class="difflineplus">+        if (filterDef.name in aTemplValues)</span>
<a href="#l16.471"></a><span id="l16.471" class="difflineplus">+          values[filterDef.name] = aTemplValues[filterDef.name];</span>
<a href="#l16.472"></a><span id="l16.472" class="difflineplus">+      }</span>
<a href="#l16.473"></a><span id="l16.473" class="difflineplus">+    }</span>
<a href="#l16.474"></a><span id="l16.474" class="difflineplus">+</span>
<a href="#l16.475"></a><span id="l16.475" class="difflineplus">+    return values;</span>
<a href="#l16.476"></a><span id="l16.476" class="difflineplus">+  },</span>
<a href="#l16.477"></a><span id="l16.477" class="difflineplus">+  /**</span>
<a href="#l16.478"></a><span id="l16.478" class="difflineplus">+   * Get the set of default filterValues for the current set of defined filters.</span>
<a href="#l16.479"></a><span id="l16.479" class="difflineplus">+   *</span>
<a href="#l16.480"></a><span id="l16.480" class="difflineplus">+   * @return Thew new filterValues state.</span>
<a href="#l16.481"></a><span id="l16.481" class="difflineplus">+   */</span>
<a href="#l16.482"></a><span id="l16.482" class="difflineplus">+  getDefaultValues: function MFM_getDefaultValues() {</span>
<a href="#l16.483"></a><span id="l16.483" class="difflineplus">+    let values = {};</span>
<a href="#l16.484"></a><span id="l16.484" class="difflineplus">+    for each (let [, filterDef] in Iterator(this.filterDefs)) {</span>
<a href="#l16.485"></a><span id="l16.485" class="difflineplus">+      if (&quot;getDefaults&quot; in filterDef) {</span>
<a href="#l16.486"></a><span id="l16.486" class="difflineplus">+        let newValue = filterDef.getDefaults();</span>
<a href="#l16.487"></a><span id="l16.487" class="difflineplus">+        if (newValue !== undefined)</span>
<a href="#l16.488"></a><span id="l16.488" class="difflineplus">+          values[filterDef.name] = newValue;</span>
<a href="#l16.489"></a><span id="l16.489" class="difflineplus">+      }</span>
<a href="#l16.490"></a><span id="l16.490" class="difflineplus">+    }</span>
<a href="#l16.491"></a><span id="l16.491" class="difflineplus">+    return values;</span>
<a href="#l16.492"></a><span id="l16.492" class="difflineplus">+  },</span>
<a href="#l16.493"></a><span id="l16.493" class="difflineplus">+</span>
<a href="#l16.494"></a><span id="l16.494" class="difflineplus">+  /**</span>
<a href="#l16.495"></a><span id="l16.495" class="difflineplus">+   * Reset the state of a single filter given the provided values.</span>
<a href="#l16.496"></a><span id="l16.496" class="difflineplus">+   *</span>
<a href="#l16.497"></a><span id="l16.497" class="difflineplus">+   * @return true if we actually cleared some state, false if there was nothing</span>
<a href="#l16.498"></a><span id="l16.498" class="difflineplus">+   *     to clear.</span>
<a href="#l16.499"></a><span id="l16.499" class="difflineplus">+   */</span>
<a href="#l16.500"></a><span id="l16.500" class="difflineplus">+  clearFilterValue: function MFM_clearFilterValue(aFilterName, aValues) {</span>
<a href="#l16.501"></a><span id="l16.501" class="difflineplus">+    let filterDef = this.filterDefsByName[aFilterName];</span>
<a href="#l16.502"></a><span id="l16.502" class="difflineplus">+    if (!(&quot;clearState&quot; in filterDef)) {</span>
<a href="#l16.503"></a><span id="l16.503" class="difflineplus">+      if (aFilterName in aValues) {</span>
<a href="#l16.504"></a><span id="l16.504" class="difflineplus">+        delete aValues[aFilterName];</span>
<a href="#l16.505"></a><span id="l16.505" class="difflineplus">+        return true;</span>
<a href="#l16.506"></a><span id="l16.506" class="difflineplus">+      }</span>
<a href="#l16.507"></a><span id="l16.507" class="difflineplus">+      return false;</span>
<a href="#l16.508"></a><span id="l16.508" class="difflineplus">+    }</span>
<a href="#l16.509"></a><span id="l16.509" class="difflineplus">+</span>
<a href="#l16.510"></a><span id="l16.510" class="difflineplus">+    let curValue = (aFilterName in aValues) ?</span>
<a href="#l16.511"></a><span id="l16.511" class="difflineplus">+                     aValues[aFilterName] : undefined;</span>
<a href="#l16.512"></a><span id="l16.512" class="difflineplus">+    // Yes, we want to call it to clear its state even if it has no state.</span>
<a href="#l16.513"></a><span id="l16.513" class="difflineplus">+    let [newValue, didClear] = filterDef.clearState(curValue);</span>
<a href="#l16.514"></a><span id="l16.514" class="difflineplus">+    if (newValue !== undefined)</span>
<a href="#l16.515"></a><span id="l16.515" class="difflineplus">+      aValues[aFilterName] = newValue;</span>
<a href="#l16.516"></a><span id="l16.516" class="difflineplus">+    else</span>
<a href="#l16.517"></a><span id="l16.517" class="difflineplus">+      delete aValues[aFilterName];</span>
<a href="#l16.518"></a><span id="l16.518" class="difflineplus">+    return didClear;</span>
<a href="#l16.519"></a><span id="l16.519" class="difflineplus">+  },</span>
<a href="#l16.520"></a><span id="l16.520" class="difflineplus">+</span>
<a href="#l16.521"></a><span id="l16.521" class="difflineplus">+  /**</span>
<a href="#l16.522"></a><span id="l16.522" class="difflineplus">+   * Reset the state of all filters given the provided values.</span>
<a href="#l16.523"></a><span id="l16.523" class="difflineplus">+   *</span>
<a href="#l16.524"></a><span id="l16.524" class="difflineplus">+   * @return true if we actually cleared something, false if there was nothing</span>
<a href="#l16.525"></a><span id="l16.525" class="difflineplus">+   *     to clear.</span>
<a href="#l16.526"></a><span id="l16.526" class="difflineplus">+   */</span>
<a href="#l16.527"></a><span id="l16.527" class="difflineplus">+  clearAllFilterValues: function MFM_clearFilterValues(aFilterValues) {</span>
<a href="#l16.528"></a><span id="l16.528" class="difflineplus">+    let didClearSomething = false;</span>
<a href="#l16.529"></a><span id="l16.529" class="difflineplus">+    for each (let [, filterDef] in Iterator(this.filterDefs)) {</span>
<a href="#l16.530"></a><span id="l16.530" class="difflineplus">+      if (this.clearFilterValue(filterDef.name, aFilterValues))</span>
<a href="#l16.531"></a><span id="l16.531" class="difflineplus">+        didClearSomething = true;</span>
<a href="#l16.532"></a><span id="l16.532" class="difflineplus">+    }</span>
<a href="#l16.533"></a><span id="l16.533" class="difflineplus">+    return didClearSomething;</span>
<a href="#l16.534"></a><span id="l16.534" class="difflineplus">+  },</span>
<a href="#l16.535"></a><span id="l16.535" class="difflineplus">+</span>
<a href="#l16.536"></a><span id="l16.536" class="difflineplus">+  /**</span>
<a href="#l16.537"></a><span id="l16.537" class="difflineplus">+   * Populate and return a list of search terms given the provided state.</span>
<a href="#l16.538"></a><span id="l16.538" class="difflineplus">+   *</span>
<a href="#l16.539"></a><span id="l16.539" class="difflineplus">+   * We only invoke appendTerms on filters that have state in aFilterValues,</span>
<a href="#l16.540"></a><span id="l16.540" class="difflineplus">+   * as per the contract.</span>
<a href="#l16.541"></a><span id="l16.541" class="difflineplus">+   */</span>
<a href="#l16.542"></a><span id="l16.542" class="difflineplus">+  createSearchTerms: function MFM_createSearchTerms(aFilterValues,</span>
<a href="#l16.543"></a><span id="l16.543" class="difflineplus">+                                                    aTermCreator) {</span>
<a href="#l16.544"></a><span id="l16.544" class="difflineplus">+    let searchTerms = [], listeners = [];</span>
<a href="#l16.545"></a><span id="l16.545" class="difflineplus">+    for each (let [filterName, filterValue] in Iterator(aFilterValues)) {</span>
<a href="#l16.546"></a><span id="l16.546" class="difflineplus">+      let filterDef = this.filterDefsByName[filterName];</span>
<a href="#l16.547"></a><span id="l16.547" class="difflineplus">+      try {</span>
<a href="#l16.548"></a><span id="l16.548" class="difflineplus">+        let listener =</span>
<a href="#l16.549"></a><span id="l16.549" class="difflineplus">+          filterDef.appendTerms(aTermCreator, searchTerms, filterValue);</span>
<a href="#l16.550"></a><span id="l16.550" class="difflineplus">+        if (listener)</span>
<a href="#l16.551"></a><span id="l16.551" class="difflineplus">+          listeners.push([listener, filterDef]);</span>
<a href="#l16.552"></a><span id="l16.552" class="difflineplus">+      }</span>
<a href="#l16.553"></a><span id="l16.553" class="difflineplus">+      catch(ex) {</span>
<a href="#l16.554"></a><span id="l16.554" class="difflineplus">+        logException(ex);</span>
<a href="#l16.555"></a><span id="l16.555" class="difflineplus">+      }</span>
<a href="#l16.556"></a><span id="l16.556" class="difflineplus">+    }</span>
<a href="#l16.557"></a><span id="l16.557" class="difflineplus">+    return searchTerms.length ? [searchTerms, listeners] : [null, listeners];</span>
<a href="#l16.558"></a><span id="l16.558" class="difflineplus">+  }</span>
<a href="#l16.559"></a><span id="l16.559" class="difflineplus">+};</span>
<a href="#l16.560"></a><span id="l16.560" class="difflineplus">+</span>
<a href="#l16.561"></a><span id="l16.561" class="difflineplus">+/**</span>
<a href="#l16.562"></a><span id="l16.562" class="difflineplus">+ * Meta-filter, just handles whether or not things are sticky.</span>
<a href="#l16.563"></a><span id="l16.563" class="difflineplus">+ */</span>
<a href="#l16.564"></a><span id="l16.564" class="difflineplus">+QuickFilterManager.defineFilter({</span>
<a href="#l16.565"></a><span id="l16.565" class="difflineplus">+  name: &quot;sticky&quot;,</span>
<a href="#l16.566"></a><span id="l16.566" class="difflineplus">+  domId: &quot;qfb-sticky&quot;,</span>
<a href="#l16.567"></a><span id="l16.567" class="difflineplus">+  appendTerms: function(aTermCreator, aTerms, aFilterValue) {</span>
<a href="#l16.568"></a><span id="l16.568" class="difflineplus">+  },</span>
<a href="#l16.569"></a><span id="l16.569" class="difflineplus">+  /**</span>
<a href="#l16.570"></a><span id="l16.570" class="difflineplus">+   * This should not cause an update, otherwise default logic.</span>
<a href="#l16.571"></a><span id="l16.571" class="difflineplus">+   */</span>
<a href="#l16.572"></a><span id="l16.572" class="difflineplus">+  onCommand: function(aState, aNode, aEvent, aDocument) {</span>
<a href="#l16.573"></a><span id="l16.573" class="difflineplus">+    let checked = aNode.checked ? true : null;</span>
<a href="#l16.574"></a><span id="l16.574" class="difflineplus">+    return [checked, false];</span>
<a href="#l16.575"></a><span id="l16.575" class="difflineplus">+  },</span>
<a href="#l16.576"></a><span id="l16.576" class="difflineplus">+});</span>
<a href="#l16.577"></a><span id="l16.577" class="difflineplus">+</span>
<a href="#l16.578"></a><span id="l16.578" class="difflineplus">+/**</span>
<a href="#l16.579"></a><span id="l16.579" class="difflineplus">+ * true: must be unread, false: must be read.</span>
<a href="#l16.580"></a><span id="l16.580" class="difflineplus">+ */</span>
<a href="#l16.581"></a><span id="l16.581" class="difflineplus">+QuickFilterManager.defineFilter({</span>
<a href="#l16.582"></a><span id="l16.582" class="difflineplus">+  name: &quot;unread&quot;,</span>
<a href="#l16.583"></a><span id="l16.583" class="difflineplus">+  domId: &quot;qfb-unread&quot;,</span>
<a href="#l16.584"></a><span id="l16.584" class="difflineplus">+  appendTerms: function(aTermCreator, aTerms, aFilterValue) {</span>
<a href="#l16.585"></a><span id="l16.585" class="difflineplus">+    let term, value;</span>
<a href="#l16.586"></a><span id="l16.586" class="difflineplus">+    term = aTermCreator.createTerm();</span>
<a href="#l16.587"></a><span id="l16.587" class="difflineplus">+    term.attrib = nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l16.588"></a><span id="l16.588" class="difflineplus">+    value = term.value;</span>
<a href="#l16.589"></a><span id="l16.589" class="difflineplus">+    value.attrib = term.attrib;</span>
<a href="#l16.590"></a><span id="l16.590" class="difflineplus">+    value.status = nsMsgMessageFlags.Read;</span>
<a href="#l16.591"></a><span id="l16.591" class="difflineplus">+    term.value = value;</span>
<a href="#l16.592"></a><span id="l16.592" class="difflineplus">+    term.op = aFilterValue ? nsMsgSearchOp.Isnt : nsMsgSearchOp.Is;</span>
<a href="#l16.593"></a><span id="l16.593" class="difflineplus">+    term.booleanAnd = true;</span>
<a href="#l16.594"></a><span id="l16.594" class="difflineplus">+    aTerms.push(term);</span>
<a href="#l16.595"></a><span id="l16.595" class="difflineplus">+  }</span>
<a href="#l16.596"></a><span id="l16.596" class="difflineplus">+});</span>
<a href="#l16.597"></a><span id="l16.597" class="difflineplus">+</span>
<a href="#l16.598"></a><span id="l16.598" class="difflineplus">+/**</span>
<a href="#l16.599"></a><span id="l16.599" class="difflineplus">+ * true: must be starred, false: must not be starred.</span>
<a href="#l16.600"></a><span id="l16.600" class="difflineplus">+ */</span>
<a href="#l16.601"></a><span id="l16.601" class="difflineplus">+QuickFilterManager.defineFilter({</span>
<a href="#l16.602"></a><span id="l16.602" class="difflineplus">+  name: &quot;starred&quot;,</span>
<a href="#l16.603"></a><span id="l16.603" class="difflineplus">+  domId: &quot;qfb-starred&quot;,</span>
<a href="#l16.604"></a><span id="l16.604" class="difflineplus">+  appendTerms: function(aTermCreator, aTerms, aFilterValue) {</span>
<a href="#l16.605"></a><span id="l16.605" class="difflineplus">+    let term, value;</span>
<a href="#l16.606"></a><span id="l16.606" class="difflineplus">+    term = aTermCreator.createTerm();</span>
<a href="#l16.607"></a><span id="l16.607" class="difflineplus">+    term.attrib = nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l16.608"></a><span id="l16.608" class="difflineplus">+    value = term.value;</span>
<a href="#l16.609"></a><span id="l16.609" class="difflineplus">+    value.attrib = term.attrib;</span>
<a href="#l16.610"></a><span id="l16.610" class="difflineplus">+    value.status = nsMsgMessageFlags.Marked;</span>
<a href="#l16.611"></a><span id="l16.611" class="difflineplus">+    term.value = value;</span>
<a href="#l16.612"></a><span id="l16.612" class="difflineplus">+    term.op = aFilterValue ? nsMsgSearchOp.Is : nsMsgSearchOp.Isnt;</span>
<a href="#l16.613"></a><span id="l16.613" class="difflineplus">+    term.booleanAnd = true;</span>
<a href="#l16.614"></a><span id="l16.614" class="difflineplus">+    aTerms.push(term);</span>
<a href="#l16.615"></a><span id="l16.615" class="difflineplus">+  }</span>
<a href="#l16.616"></a><span id="l16.616" class="difflineplus">+});</span>
<a href="#l16.617"></a><span id="l16.617" class="difflineplus">+</span>
<a href="#l16.618"></a><span id="l16.618" class="difflineplus">+/**</span>
<a href="#l16.619"></a><span id="l16.619" class="difflineplus">+ * true: sender must be in a local address book, false: sender must not be.</span>
<a href="#l16.620"></a><span id="l16.620" class="difflineplus">+ */</span>
<a href="#l16.621"></a><span id="l16.621" class="difflineplus">+QuickFilterManager.defineFilter({</span>
<a href="#l16.622"></a><span id="l16.622" class="difflineplus">+  name: &quot;addrBook&quot;,</span>
<a href="#l16.623"></a><span id="l16.623" class="difflineplus">+  domId: &quot;qfb-inaddrbook&quot;,</span>
<a href="#l16.624"></a><span id="l16.624" class="difflineplus">+  appendTerms: function(aTermCreator, aTerms, aFilterValue) {</span>
<a href="#l16.625"></a><span id="l16.625" class="difflineplus">+    let term, value;</span>
<a href="#l16.626"></a><span id="l16.626" class="difflineplus">+    let enumerator = Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l16.627"></a><span id="l16.627" class="difflineplus">+                               .getService(Components.interfaces.nsIAbManager)</span>
<a href="#l16.628"></a><span id="l16.628" class="difflineplus">+                               .directories;</span>
<a href="#l16.629"></a><span id="l16.629" class="difflineplus">+    let firstBook = true;</span>
<a href="#l16.630"></a><span id="l16.630" class="difflineplus">+    term = null;</span>
<a href="#l16.631"></a><span id="l16.631" class="difflineplus">+    while (enumerator.hasMoreElements()) {</span>
<a href="#l16.632"></a><span id="l16.632" class="difflineplus">+      let addrbook = enumerator.getNext();</span>
<a href="#l16.633"></a><span id="l16.633" class="difflineplus">+      if (addrbook instanceof Components.interfaces.nsIAbDirectory &amp;&amp;</span>
<a href="#l16.634"></a><span id="l16.634" class="difflineplus">+          !addrbook.isRemote) {</span>
<a href="#l16.635"></a><span id="l16.635" class="difflineplus">+        term = aTermCreator.createTerm();</span>
<a href="#l16.636"></a><span id="l16.636" class="difflineplus">+        term.attrib = Components.interfaces.nsMsgSearchAttrib.Sender;</span>
<a href="#l16.637"></a><span id="l16.637" class="difflineplus">+        value = term.value;</span>
<a href="#l16.638"></a><span id="l16.638" class="difflineplus">+        value.attrib = term.attrib;</span>
<a href="#l16.639"></a><span id="l16.639" class="difflineplus">+        value.str = addrbook.URI;</span>
<a href="#l16.640"></a><span id="l16.640" class="difflineplus">+        term.value = value;</span>
<a href="#l16.641"></a><span id="l16.641" class="difflineplus">+        term.op = aFilterValue ? nsMsgSearchOp.IsInAB : nsMsgSearchOp.IsntInAB;</span>
<a href="#l16.642"></a><span id="l16.642" class="difflineplus">+        // It's an AND if we're the first book (so the boolean affects the</span>
<a href="#l16.643"></a><span id="l16.643" class="difflineplus">+        //  group as a whole.)</span>
<a href="#l16.644"></a><span id="l16.644" class="difflineplus">+        // It's the negation of whether we're filtering otherwise; demorgans.</span>
<a href="#l16.645"></a><span id="l16.645" class="difflineplus">+        term.booleanAnd = firstBook || !aFilterValue;</span>
<a href="#l16.646"></a><span id="l16.646" class="difflineplus">+        term.beginsGrouping = firstBook;</span>
<a href="#l16.647"></a><span id="l16.647" class="difflineplus">+        aTerms.push(term);</span>
<a href="#l16.648"></a><span id="l16.648" class="difflineplus">+        firstBook = false;</span>
<a href="#l16.649"></a><span id="l16.649" class="difflineplus">+      }</span>
<a href="#l16.650"></a><span id="l16.650" class="difflineplus">+    }</span>
<a href="#l16.651"></a><span id="l16.651" class="difflineplus">+    if (term)</span>
<a href="#l16.652"></a><span id="l16.652" class="difflineplus">+      term.endsGrouping = true;</span>
<a href="#l16.653"></a><span id="l16.653" class="difflineplus">+  }</span>
<a href="#l16.654"></a><span id="l16.654" class="difflineplus">+});</span>
<a href="#l16.655"></a><span id="l16.655" class="difflineplus">+</span>
<a href="#l16.656"></a><span id="l16.656" class="difflineplus">+/**</span>
<a href="#l16.657"></a><span id="l16.657" class="difflineplus">+ * It's a tag filter that sorta facets! Stealing gloda's thunder! Woo!</span>
<a href="#l16.658"></a><span id="l16.658" class="difflineplus">+ *</span>
<a href="#l16.659"></a><span id="l16.659" class="difflineplus">+ * Filter on message tags?  Meanings:</span>
<a href="#l16.660"></a><span id="l16.660" class="difflineplus">+ * - true: Yes, must have at least one tag on it.</span>
<a href="#l16.661"></a><span id="l16.661" class="difflineplus">+ * - false: No, no tags on it!</span>
<a href="#l16.662"></a><span id="l16.662" class="difflineplus">+ * - dictionary where keys are tag keys and values are tri-state with null</span>
<a href="#l16.663"></a><span id="l16.663" class="difflineplus">+ *    meaning don't constraint, true meaning yes should be present, false</span>
<a href="#l16.664"></a><span id="l16.664" class="difflineplus">+ *    meaning no, don't be present</span>
<a href="#l16.665"></a><span id="l16.665" class="difflineplus">+ */</span>
<a href="#l16.666"></a><span id="l16.666" class="difflineplus">+let TagFacetingFilter = {</span>
<a href="#l16.667"></a><span id="l16.667" class="difflineplus">+  name: &quot;tags&quot;,</span>
<a href="#l16.668"></a><span id="l16.668" class="difflineplus">+  domId: &quot;qfb-tags&quot;,</span>
<a href="#l16.669"></a><span id="l16.669" class="difflineplus">+</span>
<a href="#l16.670"></a><span id="l16.670" class="difflineplus">+  /**</span>
<a href="#l16.671"></a><span id="l16.671" class="difflineplus">+   * @return true if the constaint is only on has tags/does not have tags,</span>
<a href="#l16.672"></a><span id="l16.672" class="difflineplus">+   *     false if there are specific tag constraints in play.</span>
<a href="#l16.673"></a><span id="l16.673" class="difflineplus">+   */</span>
<a href="#l16.674"></a><span id="l16.674" class="difflineplus">+  isSimple: function(aFilterValue) {</span>
<a href="#l16.675"></a><span id="l16.675" class="difflineplus">+    // it's the simple case if the value is just a boolean</span>
<a href="#l16.676"></a><span id="l16.676" class="difflineplus">+    if (typeof(aFilterValue) != &quot;object&quot;)</span>
<a href="#l16.677"></a><span id="l16.677" class="difflineplus">+      return true;</span>
<a href="#l16.678"></a><span id="l16.678" class="difflineplus">+    // but also if the object contains no true values</span>
<a href="#l16.679"></a><span id="l16.679" class="difflineplus">+    let simpleCase = true;</span>
<a href="#l16.680"></a><span id="l16.680" class="difflineplus">+    for each (let [key, value] in Iterator(aFilterValue)) {</span>
<a href="#l16.681"></a><span id="l16.681" class="difflineplus">+      if (value !== null) {</span>
<a href="#l16.682"></a><span id="l16.682" class="difflineplus">+        simpleCase = false;</span>
<a href="#l16.683"></a><span id="l16.683" class="difflineplus">+        break;</span>
<a href="#l16.684"></a><span id="l16.684" class="difflineplus">+      }</span>
<a href="#l16.685"></a><span id="l16.685" class="difflineplus">+    }</span>
<a href="#l16.686"></a><span id="l16.686" class="difflineplus">+    return simpleCase;</span>
<a href="#l16.687"></a><span id="l16.687" class="difflineplus">+  },</span>
<a href="#l16.688"></a><span id="l16.688" class="difflineplus">+</span>
<a href="#l16.689"></a><span id="l16.689" class="difflineplus">+  /**</span>
<a href="#l16.690"></a><span id="l16.690" class="difflineplus">+   * Because we support both inclusion and exclusion we can produce up to two</span>
<a href="#l16.691"></a><span id="l16.691" class="difflineplus">+   *  groups.  One group for inclusion, one group for exclusion.  To get listed</span>
<a href="#l16.692"></a><span id="l16.692" class="difflineplus">+   *  you only need to include one of the tags marked for inclusion, but you</span>
<a href="#l16.693"></a><span id="l16.693" class="difflineplus">+   *  must not have any of the tags marked for exclusion.</span>
<a href="#l16.694"></a><span id="l16.694" class="difflineplus">+   */</span>
<a href="#l16.695"></a><span id="l16.695" class="difflineplus">+  appendTerms: function TFF_appendTerms(aTermCreator, aTerms, aFilterValue) {</span>
<a href="#l16.696"></a><span id="l16.696" class="difflineplus">+    let term, value;</span>
<a href="#l16.697"></a><span id="l16.697" class="difflineplus">+</span>
<a href="#l16.698"></a><span id="l16.698" class="difflineplus">+    if (aFilterValue == null)</span>
<a href="#l16.699"></a><span id="l16.699" class="difflineplus">+      return null;</span>
<a href="#l16.700"></a><span id="l16.700" class="difflineplus">+</span>
<a href="#l16.701"></a><span id="l16.701" class="difflineplus">+    // just the true/false case</span>
<a href="#l16.702"></a><span id="l16.702" class="difflineplus">+    if (this.isSimple(aFilterValue)) {</span>
<a href="#l16.703"></a><span id="l16.703" class="difflineplus">+      term = aTermCreator.createTerm();</span>
<a href="#l16.704"></a><span id="l16.704" class="difflineplus">+      term.attrib = Components.interfaces.nsMsgSearchAttrib.Keywords;</span>
<a href="#l16.705"></a><span id="l16.705" class="difflineplus">+      value = term.value;</span>
<a href="#l16.706"></a><span id="l16.706" class="difflineplus">+      value.str = &quot;&quot;;</span>
<a href="#l16.707"></a><span id="l16.707" class="difflineplus">+      term.value = value;</span>
<a href="#l16.708"></a><span id="l16.708" class="difflineplus">+      term.op = aFilterValue ?</span>
<a href="#l16.709"></a><span id="l16.709" class="difflineplus">+                  Components.interfaces.nsMsgSearchOp.IsntEmpty :</span>
<a href="#l16.710"></a><span id="l16.710" class="difflineplus">+                  Components.interfaces.nsMsgSearchOp.IsEmpty;</span>
<a href="#l16.711"></a><span id="l16.711" class="difflineplus">+      term.booleanAnd = true;</span>
<a href="#l16.712"></a><span id="l16.712" class="difflineplus">+      aTerms.push(term);</span>
<a href="#l16.713"></a><span id="l16.713" class="difflineplus">+</span>
<a href="#l16.714"></a><span id="l16.714" class="difflineplus">+      // we need to perform faceting if the value is literally true.</span>
<a href="#l16.715"></a><span id="l16.715" class="difflineplus">+      if (aFilterValue === true)</span>
<a href="#l16.716"></a><span id="l16.716" class="difflineplus">+        return this;</span>
<a href="#l16.717"></a><span id="l16.717" class="difflineplus">+    }</span>
<a href="#l16.718"></a><span id="l16.718" class="difflineplus">+    else {</span>
<a href="#l16.719"></a><span id="l16.719" class="difflineplus">+      let firstIncludeClause = true, firstExcludeClause = true;</span>
<a href="#l16.720"></a><span id="l16.720" class="difflineplus">+      let lastIncludeTerm = null;</span>
<a href="#l16.721"></a><span id="l16.721" class="difflineplus">+      term = null;</span>
<a href="#l16.722"></a><span id="l16.722" class="difflineplus">+</span>
<a href="#l16.723"></a><span id="l16.723" class="difflineplus">+      let excludeTerms = [];</span>
<a href="#l16.724"></a><span id="l16.724" class="difflineplus">+</span>
<a href="#l16.725"></a><span id="l16.725" class="difflineplus">+      for each (let [key, shouldFilter] in Iterator(aFilterValue)) {</span>
<a href="#l16.726"></a><span id="l16.726" class="difflineplus">+        if (shouldFilter !== null) {</span>
<a href="#l16.727"></a><span id="l16.727" class="difflineplus">+          term = aTermCreator.createTerm();</span>
<a href="#l16.728"></a><span id="l16.728" class="difflineplus">+          term.attrib = Components.interfaces.nsMsgSearchAttrib.Keywords;</span>
<a href="#l16.729"></a><span id="l16.729" class="difflineplus">+          value = term.value;</span>
<a href="#l16.730"></a><span id="l16.730" class="difflineplus">+          value.attrib = term.attrib;</span>
<a href="#l16.731"></a><span id="l16.731" class="difflineplus">+          value.str = key;</span>
<a href="#l16.732"></a><span id="l16.732" class="difflineplus">+          term.value = value;</span>
<a href="#l16.733"></a><span id="l16.733" class="difflineplus">+          if (shouldFilter) {</span>
<a href="#l16.734"></a><span id="l16.734" class="difflineplus">+            term.op = nsMsgSearchOp.Contains;</span>
<a href="#l16.735"></a><span id="l16.735" class="difflineplus">+            // AND for the group, but OR inside the group</span>
<a href="#l16.736"></a><span id="l16.736" class="difflineplus">+            term.booleanAnd = firstIncludeClause;</span>
<a href="#l16.737"></a><span id="l16.737" class="difflineplus">+            term.beginsGrouping = firstIncludeClause;</span>
<a href="#l16.738"></a><span id="l16.738" class="difflineplus">+            aTerms.push(term);</span>
<a href="#l16.739"></a><span id="l16.739" class="difflineplus">+            firstIncludeClause = false;</span>
<a href="#l16.740"></a><span id="l16.740" class="difflineplus">+            lastIncludeTerm = term;</span>
<a href="#l16.741"></a><span id="l16.741" class="difflineplus">+          }</span>
<a href="#l16.742"></a><span id="l16.742" class="difflineplus">+          else {</span>
<a href="#l16.743"></a><span id="l16.743" class="difflineplus">+            term.op = nsMsgSearchOp.DoesntContain;</span>
<a href="#l16.744"></a><span id="l16.744" class="difflineplus">+            // you need to not include all of the tags marked excluded.</span>
<a href="#l16.745"></a><span id="l16.745" class="difflineplus">+            term.booleanAnd = true;</span>
<a href="#l16.746"></a><span id="l16.746" class="difflineplus">+            term.beginsGrouping = firstExcludeClause;</span>
<a href="#l16.747"></a><span id="l16.747" class="difflineplus">+            excludeTerms.push(term);</span>
<a href="#l16.748"></a><span id="l16.748" class="difflineplus">+            firstExcludeClause = false;</span>
<a href="#l16.749"></a><span id="l16.749" class="difflineplus">+          }</span>
<a href="#l16.750"></a><span id="l16.750" class="difflineplus">+        }</span>
<a href="#l16.751"></a><span id="l16.751" class="difflineplus">+      }</span>
<a href="#l16.752"></a><span id="l16.752" class="difflineplus">+      if (lastIncludeTerm)</span>
<a href="#l16.753"></a><span id="l16.753" class="difflineplus">+        lastIncludeTerm.endsGrouping = true;</span>
<a href="#l16.754"></a><span id="l16.754" class="difflineplus">+</span>
<a href="#l16.755"></a><span id="l16.755" class="difflineplus">+      // if we have any exclude terms:</span>
<a href="#l16.756"></a><span id="l16.756" class="difflineplus">+      // - we might need to add a &quot;has a tag&quot; clause if there were no explicit</span>
<a href="#l16.757"></a><span id="l16.757" class="difflineplus">+      //   inclusions.</span>
<a href="#l16.758"></a><span id="l16.758" class="difflineplus">+      // - extend the exclusions list in.</span>
<a href="#l16.759"></a><span id="l16.759" class="difflineplus">+      if (excludeTerms.length) {</span>
<a href="#l16.760"></a><span id="l16.760" class="difflineplus">+        // (we need to add has a tag)</span>
<a href="#l16.761"></a><span id="l16.761" class="difflineplus">+        if (!lastIncludeTerm) {</span>
<a href="#l16.762"></a><span id="l16.762" class="difflineplus">+          term = aTermCreator.createTerm();</span>
<a href="#l16.763"></a><span id="l16.763" class="difflineplus">+          term.attrib = Components.interfaces.nsMsgSearchAttrib.Keywords;</span>
<a href="#l16.764"></a><span id="l16.764" class="difflineplus">+          value = term.value;</span>
<a href="#l16.765"></a><span id="l16.765" class="difflineplus">+          value.str = &quot;&quot;;</span>
<a href="#l16.766"></a><span id="l16.766" class="difflineplus">+          term.value = value;</span>
<a href="#l16.767"></a><span id="l16.767" class="difflineplus">+          term.op = Components.interfaces.nsMsgSearchOp.IsntEmpty;</span>
<a href="#l16.768"></a><span id="l16.768" class="difflineplus">+          term.booleanAnd = true;</span>
<a href="#l16.769"></a><span id="l16.769" class="difflineplus">+          aTerms.push(term);</span>
<a href="#l16.770"></a><span id="l16.770" class="difflineplus">+        }</span>
<a href="#l16.771"></a><span id="l16.771" class="difflineplus">+</span>
<a href="#l16.772"></a><span id="l16.772" class="difflineplus">+        // (extend in the exclusions)</span>
<a href="#l16.773"></a><span id="l16.773" class="difflineplus">+        excludeTerms[excludeTerms.length-1].endsGrouping = true;</span>
<a href="#l16.774"></a><span id="l16.774" class="difflineplus">+        aTerms.push.apply(aTerms, excludeTerms);</span>
<a href="#l16.775"></a><span id="l16.775" class="difflineplus">+      }</span>
<a href="#l16.776"></a><span id="l16.776" class="difflineplus">+    }</span>
<a href="#l16.777"></a><span id="l16.777" class="difflineplus">+</span>
<a href="#l16.778"></a><span id="l16.778" class="difflineplus">+    return null;</span>
<a href="#l16.779"></a><span id="l16.779" class="difflineplus">+  },</span>
<a href="#l16.780"></a><span id="l16.780" class="difflineplus">+</span>
<a href="#l16.781"></a><span id="l16.781" class="difflineplus">+  onSearchStart: function(aCurState) {</span>
<a href="#l16.782"></a><span id="l16.782" class="difflineplus">+    // this becomes aKeywordMap; we want to start with an empty one</span>
<a href="#l16.783"></a><span id="l16.783" class="difflineplus">+    return {};</span>
<a href="#l16.784"></a><span id="l16.784" class="difflineplus">+  },</span>
<a href="#l16.785"></a><span id="l16.785" class="difflineplus">+  onSearchMessage: function(aKeywordMap, aMsgHdr, aFolder) {</span>
<a href="#l16.786"></a><span id="l16.786" class="difflineplus">+    let keywords = aMsgHdr.getStringProperty(&quot;keywords&quot;);</span>
<a href="#l16.787"></a><span id="l16.787" class="difflineplus">+    let keywordList = keywords.split(' ');</span>
<a href="#l16.788"></a><span id="l16.788" class="difflineplus">+    for (let iKeyword = 0; iKeyword &lt; keywordList.length; iKeyword++) {</span>
<a href="#l16.789"></a><span id="l16.789" class="difflineplus">+      let keyword = keywordList[iKeyword];</span>
<a href="#l16.790"></a><span id="l16.790" class="difflineplus">+      aKeywordMap[keyword] = null;</span>
<a href="#l16.791"></a><span id="l16.791" class="difflineplus">+    }</span>
<a href="#l16.792"></a><span id="l16.792" class="difflineplus">+  },</span>
<a href="#l16.793"></a><span id="l16.793" class="difflineplus">+  onSearchDone: function(aCurState, aKeywordMap, aStatus) {</span>
<a href="#l16.794"></a><span id="l16.794" class="difflineplus">+    // we are an async operation; if the user turned off the tag facet already,</span>
<a href="#l16.795"></a><span id="l16.795" class="difflineplus">+    //  then leave that state intact...</span>
<a href="#l16.796"></a><span id="l16.796" class="difflineplus">+    if (aCurState == null)</span>
<a href="#l16.797"></a><span id="l16.797" class="difflineplus">+      return [null, false, false];</span>
<a href="#l16.798"></a><span id="l16.798" class="difflineplus">+</span>
<a href="#l16.799"></a><span id="l16.799" class="difflineplus">+    // only propagate things that are actually tags though!</span>
<a href="#l16.800"></a><span id="l16.800" class="difflineplus">+    let outKeyMap = {};</span>
<a href="#l16.801"></a><span id="l16.801" class="difflineplus">+    let tagService = Cc[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l16.802"></a><span id="l16.802" class="difflineplus">+                       .getService(Ci.nsIMsgTagService);</span>
<a href="#l16.803"></a><span id="l16.803" class="difflineplus">+    let tags = tagService.getAllTags({});</span>
<a href="#l16.804"></a><span id="l16.804" class="difflineplus">+    let tagCount = tags.length;</span>
<a href="#l16.805"></a><span id="l16.805" class="difflineplus">+    for (let iTag=0; iTag &lt; tagCount; iTag++) {</span>
<a href="#l16.806"></a><span id="l16.806" class="difflineplus">+      let tag = tags[iTag];</span>
<a href="#l16.807"></a><span id="l16.807" class="difflineplus">+</span>
<a href="#l16.808"></a><span id="l16.808" class="difflineplus">+      if (tag.key in aKeywordMap)</span>
<a href="#l16.809"></a><span id="l16.809" class="difflineplus">+        outKeyMap[tag.key] = aKeywordMap[tag.key];</span>
<a href="#l16.810"></a><span id="l16.810" class="difflineplus">+    }</span>
<a href="#l16.811"></a><span id="l16.811" class="difflineplus">+</span>
<a href="#l16.812"></a><span id="l16.812" class="difflineplus">+    return [outKeyMap, true, false];</span>
<a href="#l16.813"></a><span id="l16.813" class="difflineplus">+  },</span>
<a href="#l16.814"></a><span id="l16.814" class="difflineplus">+</span>
<a href="#l16.815"></a><span id="l16.815" class="difflineplus">+  /**</span>
<a href="#l16.816"></a><span id="l16.816" class="difflineplus">+   * We need to clone our state if it's an object to avoid bad sharing.</span>
<a href="#l16.817"></a><span id="l16.817" class="difflineplus">+   */</span>
<a href="#l16.818"></a><span id="l16.818" class="difflineplus">+  propagateState: function(aOld, aSticky) {</span>
<a href="#l16.819"></a><span id="l16.819" class="difflineplus">+    // stay disabled when disabled</span>
<a href="#l16.820"></a><span id="l16.820" class="difflineplus">+    if (aOld == null)</span>
<a href="#l16.821"></a><span id="l16.821" class="difflineplus">+      return null;</span>
<a href="#l16.822"></a><span id="l16.822" class="difflineplus">+    if (this.isSimple(aOld))</span>
<a href="#l16.823"></a><span id="l16.823" class="difflineplus">+      return aOld ? true : false; // could be an object, need to convert.</span>
<a href="#l16.824"></a><span id="l16.824" class="difflineplus">+    return shallowObjCopy(aOld);</span>
<a href="#l16.825"></a><span id="l16.825" class="difflineplus">+  },</span>
<a href="#l16.826"></a><span id="l16.826" class="difflineplus">+</span>
<a href="#l16.827"></a><span id="l16.827" class="difflineplus">+  /**</span>
<a href="#l16.828"></a><span id="l16.828" class="difflineplus">+   * Default behaviour but:</span>
<a href="#l16.829"></a><span id="l16.829" class="difflineplus">+   * - We collapse our expando if we get unchecked.</span>
<a href="#l16.830"></a><span id="l16.830" class="difflineplus">+   * - We want to initiate a faceting pass if we just got checked.</span>
<a href="#l16.831"></a><span id="l16.831" class="difflineplus">+   */</span>
<a href="#l16.832"></a><span id="l16.832" class="difflineplus">+  onCommand: function(aState, aNode, aEvent, aDocument) {</span>
<a href="#l16.833"></a><span id="l16.833" class="difflineplus">+    let checked = aNode.checked ? true : null;</span>
<a href="#l16.834"></a><span id="l16.834" class="difflineplus">+    if (!checked)</span>
<a href="#l16.835"></a><span id="l16.835" class="difflineplus">+      aDocument.getElementById(&quot;quick-filter-bar-tab-bar&quot;).collapsed = true;</span>
<a href="#l16.836"></a><span id="l16.836" class="difflineplus">+</span>
<a href="#l16.837"></a><span id="l16.837" class="difflineplus">+    // return ourselves if we just got checked to have</span>
<a href="#l16.838"></a><span id="l16.838" class="difflineplus">+    //  onSearchStart/onSearchMessage/onSearchDone get to do their thing.</span>
<a href="#l16.839"></a><span id="l16.839" class="difflineplus">+    return [checked, true];</span>
<a href="#l16.840"></a><span id="l16.840" class="difflineplus">+  },</span>
<a href="#l16.841"></a><span id="l16.841" class="difflineplus">+</span>
<a href="#l16.842"></a><span id="l16.842" class="difflineplus">+  reflectInDOM: function TFF_reflectInDOM(aNode, aFilterValue,</span>
<a href="#l16.843"></a><span id="l16.843" class="difflineplus">+                                          aDocument, aMuxer) {</span>
<a href="#l16.844"></a><span id="l16.844" class="difflineplus">+    aNode.checked = aFilterValue ? true : false;</span>
<a href="#l16.845"></a><span id="l16.845" class="difflineplus">+</span>
<a href="#l16.846"></a><span id="l16.846" class="difflineplus">+    if ((aFilterValue != null) &amp;&amp;</span>
<a href="#l16.847"></a><span id="l16.847" class="difflineplus">+        (typeof(aFilterValue) == &quot;object&quot;))</span>
<a href="#l16.848"></a><span id="l16.848" class="difflineplus">+      this._populateTagBar(aFilterValue, aDocument, aMuxer);</span>
<a href="#l16.849"></a><span id="l16.849" class="difflineplus">+    else</span>
<a href="#l16.850"></a><span id="l16.850" class="difflineplus">+      aDocument.getElementById(&quot;quick-filter-bar-tab-bar&quot;).collapsed = true;</span>
<a href="#l16.851"></a><span id="l16.851" class="difflineplus">+  },</span>
<a href="#l16.852"></a><span id="l16.852" class="difflineplus">+</span>
<a href="#l16.853"></a><span id="l16.853" class="difflineplus">+  _populateTagBar: function TFF__populateTagMenu(aState, aDocument, aMuxer) {</span>
<a href="#l16.854"></a><span id="l16.854" class="difflineplus">+    let tagbar = aDocument.getElementById(&quot;quick-filter-bar-tab-bar&quot;);</span>
<a href="#l16.855"></a><span id="l16.855" class="difflineplus">+    let keywordMap = aState;</span>
<a href="#l16.856"></a><span id="l16.856" class="difflineplus">+</span>
<a href="#l16.857"></a><span id="l16.857" class="difflineplus">+    function commandHandler(aEvent) {</span>
<a href="#l16.858"></a><span id="l16.858" class="difflineplus">+      let tagKey = aEvent.target.getAttribute(&quot;value&quot;);</span>
<a href="#l16.859"></a><span id="l16.859" class="difflineplus">+      let state = aMuxer.getFilterValueForMutation(TagFacetingFilter.name);</span>
<a href="#l16.860"></a><span id="l16.860" class="difflineplus">+      state[tagKey] = aEvent.target.checked ? true : null;</span>
<a href="#l16.861"></a><span id="l16.861" class="difflineplus">+      aEvent.target.removeAttribute(&quot;inverted&quot;);</span>
<a href="#l16.862"></a><span id="l16.862" class="difflineplus">+      aMuxer.updateSearch();</span>
<a href="#l16.863"></a><span id="l16.863" class="difflineplus">+    };</span>
<a href="#l16.864"></a><span id="l16.864" class="difflineplus">+</span>
<a href="#l16.865"></a><span id="l16.865" class="difflineplus">+    function rightClickHandler(aEvent) {</span>
<a href="#l16.866"></a><span id="l16.866" class="difflineplus">+      // Only do something if this is a right-click, otherwise commandHandler</span>
<a href="#l16.867"></a><span id="l16.867" class="difflineplus">+      //  will pick up on it.</span>
<a href="#l16.868"></a><span id="l16.868" class="difflineplus">+      if (aEvent.button == 2) {</span>
<a href="#l16.869"></a><span id="l16.869" class="difflineplus">+        // we need to toggle the checked state ourselves</span>
<a href="#l16.870"></a><span id="l16.870" class="difflineplus">+        aEvent.target.checked = !aEvent.target.checked;</span>
<a href="#l16.871"></a><span id="l16.871" class="difflineplus">+</span>
<a href="#l16.872"></a><span id="l16.872" class="difflineplus">+        let tagKey = aEvent.target.getAttribute(&quot;value&quot;);</span>
<a href="#l16.873"></a><span id="l16.873" class="difflineplus">+        let state = aMuxer.getFilterValueForMutation(TagFacetingFilter.name);</span>
<a href="#l16.874"></a><span id="l16.874" class="difflineplus">+        state[tagKey] = aEvent.target.checked ? false : null;</span>
<a href="#l16.875"></a><span id="l16.875" class="difflineplus">+        if (aEvent.target.checked)</span>
<a href="#l16.876"></a><span id="l16.876" class="difflineplus">+          aEvent.target.setAttribute(&quot;inverted&quot;, &quot;true&quot;);</span>
<a href="#l16.877"></a><span id="l16.877" class="difflineplus">+        else</span>
<a href="#l16.878"></a><span id="l16.878" class="difflineplus">+          aEvent.target.removeAttribute(&quot;inverted&quot;);</span>
<a href="#l16.879"></a><span id="l16.879" class="difflineplus">+        aMuxer.updateSearch();</span>
<a href="#l16.880"></a><span id="l16.880" class="difflineplus">+        aEvent.stopPropagation();</span>
<a href="#l16.881"></a><span id="l16.881" class="difflineplus">+        aEvent.preventDefault();</span>
<a href="#l16.882"></a><span id="l16.882" class="difflineplus">+      }</span>
<a href="#l16.883"></a><span id="l16.883" class="difflineplus">+    }</span>
<a href="#l16.884"></a><span id="l16.884" class="difflineplus">+</span>
<a href="#l16.885"></a><span id="l16.885" class="difflineplus">+    // -- nuke existing exposed tags</span>
<a href="#l16.886"></a><span id="l16.886" class="difflineplus">+    while (tagbar.lastChild)</span>
<a href="#l16.887"></a><span id="l16.887" class="difflineplus">+      tagbar.removeChild(tagbar.lastChild);</span>
<a href="#l16.888"></a><span id="l16.888" class="difflineplus">+</span>
<a href="#l16.889"></a><span id="l16.889" class="difflineplus">+    let addCount = 0;</span>
<a href="#l16.890"></a><span id="l16.890" class="difflineplus">+</span>
<a href="#l16.891"></a><span id="l16.891" class="difflineplus">+    // -- create an element for each tag</span>
<a href="#l16.892"></a><span id="l16.892" class="difflineplus">+    let tagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l16.893"></a><span id="l16.893" class="difflineplus">+                           .getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l16.894"></a><span id="l16.894" class="difflineplus">+    let tags = tagService.getAllTags({});</span>
<a href="#l16.895"></a><span id="l16.895" class="difflineplus">+    let tagCount = tags.length;</span>
<a href="#l16.896"></a><span id="l16.896" class="difflineplus">+    for (let iTag=0; iTag &lt; tagCount; iTag++) {</span>
<a href="#l16.897"></a><span id="l16.897" class="difflineplus">+      let tag = tags[iTag];</span>
<a href="#l16.898"></a><span id="l16.898" class="difflineplus">+</span>
<a href="#l16.899"></a><span id="l16.899" class="difflineplus">+      if (tag.key in keywordMap) {</span>
<a href="#l16.900"></a><span id="l16.900" class="difflineplus">+        addCount++;</span>
<a href="#l16.901"></a><span id="l16.901" class="difflineplus">+</span>
<a href="#l16.902"></a><span id="l16.902" class="difflineplus">+        // Keep in mind that the XBL does not get built for dynamically created</span>
<a href="#l16.903"></a><span id="l16.903" class="difflineplus">+        //  elements such as these until they get displayed, which definitely</span>
<a href="#l16.904"></a><span id="l16.904" class="difflineplus">+        //  means not before we append it into the tree.</span>
<a href="#l16.905"></a><span id="l16.905" class="difflineplus">+        let button = aDocument.createElement(&quot;toolbarbutton&quot;);</span>
<a href="#l16.906"></a><span id="l16.906" class="difflineplus">+</span>
<a href="#l16.907"></a><span id="l16.907" class="difflineplus">+        button.setAttribute(&quot;id&quot;, &quot;qfb-tag-&quot; + tag.key);</span>
<a href="#l16.908"></a><span id="l16.908" class="difflineplus">+        button.addEventListener(&quot;command&quot;, commandHandler, false);</span>
<a href="#l16.909"></a><span id="l16.909" class="difflineplus">+        button.addEventListener(&quot;click&quot;, rightClickHandler, false);</span>
<a href="#l16.910"></a><span id="l16.910" class="difflineplus">+        button.setAttribute(&quot;type&quot;, &quot;checkbox&quot;);</span>
<a href="#l16.911"></a><span id="l16.911" class="difflineplus">+        if (keywordMap[tag.key] !== null) {</span>
<a href="#l16.912"></a><span id="l16.912" class="difflineplus">+          button.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l16.913"></a><span id="l16.913" class="difflineplus">+          if (!keywordMap[tag.key])</span>
<a href="#l16.914"></a><span id="l16.914" class="difflineplus">+            button.setAttribute(&quot;inverted&quot;, &quot;true&quot;);</span>
<a href="#l16.915"></a><span id="l16.915" class="difflineplus">+        }</span>
<a href="#l16.916"></a><span id="l16.916" class="difflineplus">+        button.setAttribute(&quot;label&quot;, tag.tag);</span>
<a href="#l16.917"></a><span id="l16.917" class="difflineplus">+        button.setAttribute(&quot;value&quot;, tag.key);</span>
<a href="#l16.918"></a><span id="l16.918" class="difflineplus">+        let color = tag.color;</span>
<a href="#l16.919"></a><span id="l16.919" class="difflineplus">+        // everybody always gets to be an qfb-tag-button.</span>
<a href="#l16.920"></a><span id="l16.920" class="difflineplus">+        if (color)</span>
<a href="#l16.921"></a><span id="l16.921" class="difflineplus">+          button.setAttribute(&quot;class&quot;, &quot;qfb-tag-button lc-&quot; + color.substr(1));</span>
<a href="#l16.922"></a><span id="l16.922" class="difflineplus">+        else</span>
<a href="#l16.923"></a><span id="l16.923" class="difflineplus">+          button.setAttribute(&quot;class&quot;, &quot;qfb-tag-button&quot;);</span>
<a href="#l16.924"></a><span id="l16.924" class="difflineplus">+        tagbar.appendChild(button);</span>
<a href="#l16.925"></a><span id="l16.925" class="difflineplus">+      }</span>
<a href="#l16.926"></a><span id="l16.926" class="difflineplus">+    }</span>
<a href="#l16.927"></a><span id="l16.927" class="difflineplus">+</span>
<a href="#l16.928"></a><span id="l16.928" class="difflineplus">+    tagbar.collapsed = !addCount;</span>
<a href="#l16.929"></a><span id="l16.929" class="difflineplus">+  },</span>
<a href="#l16.930"></a><span id="l16.930" class="difflineplus">+};</span>
<a href="#l16.931"></a><span id="l16.931" class="difflineplus">+QuickFilterManager.defineFilter(TagFacetingFilter);</span>
<a href="#l16.932"></a><span id="l16.932" class="difflineplus">+</span>
<a href="#l16.933"></a><span id="l16.933" class="difflineplus">+/**</span>
<a href="#l16.934"></a><span id="l16.934" class="difflineplus">+ * true: must have attachment, false: must not have attachment.</span>
<a href="#l16.935"></a><span id="l16.935" class="difflineplus">+ */</span>
<a href="#l16.936"></a><span id="l16.936" class="difflineplus">+QuickFilterManager.defineFilter({</span>
<a href="#l16.937"></a><span id="l16.937" class="difflineplus">+  name: &quot;attachment&quot;,</span>
<a href="#l16.938"></a><span id="l16.938" class="difflineplus">+  domId: &quot;qfb-attachment&quot;,</span>
<a href="#l16.939"></a><span id="l16.939" class="difflineplus">+  appendTerms: function(aTermCreator, aTerms, aFilterValue) {</span>
<a href="#l16.940"></a><span id="l16.940" class="difflineplus">+    let term, value;</span>
<a href="#l16.941"></a><span id="l16.941" class="difflineplus">+    term = aTermCreator.createTerm();</span>
<a href="#l16.942"></a><span id="l16.942" class="difflineplus">+    term.attrib = Components.interfaces.nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l16.943"></a><span id="l16.943" class="difflineplus">+    value = term.value;</span>
<a href="#l16.944"></a><span id="l16.944" class="difflineplus">+    value.attrib = term.attrib;</span>
<a href="#l16.945"></a><span id="l16.945" class="difflineplus">+    value.status = Components.interfaces.nsMsgMessageFlags.Attachment;</span>
<a href="#l16.946"></a><span id="l16.946" class="difflineplus">+    term.value = value;</span>
<a href="#l16.947"></a><span id="l16.947" class="difflineplus">+    term.op = aFilterValue ? nsMsgSearchOp.Is : nsMsgSearchOp.Isnt;</span>
<a href="#l16.948"></a><span id="l16.948" class="difflineplus">+    term.booleanAnd = true;</span>
<a href="#l16.949"></a><span id="l16.949" class="difflineplus">+    aTerms.push(term);</span>
<a href="#l16.950"></a><span id="l16.950" class="difflineplus">+  }</span>
<a href="#l16.951"></a><span id="l16.951" class="difflineplus">+});</span>
<a href="#l16.952"></a><span id="l16.952" class="difflineplus">+</span>
<a href="#l16.953"></a><span id="l16.953" class="difflineplus">+/**</span>
<a href="#l16.954"></a><span id="l16.954" class="difflineplus">+ * The traditional quick-search text filter now with added gloda upsell!  We</span>
<a href="#l16.955"></a><span id="l16.955" class="difflineplus">+ * are mildly extensible in case someone wants to add more specific text filter</span>
<a href="#l16.956"></a><span id="l16.956" class="difflineplus">+ * criteria to toggle, but otherwise are intended to be taken out of the</span>
<a href="#l16.957"></a><span id="l16.957" class="difflineplus">+ * picture entirely by extensions implementing more featureful text searches.</span>
<a href="#l16.958"></a><span id="l16.958" class="difflineplus">+ *</span>
<a href="#l16.959"></a><span id="l16.959" class="difflineplus">+ * Our state looks like {text: &quot;&quot;, states: {a: true, b: false}} where a and b</span>
<a href="#l16.960"></a><span id="l16.960" class="difflineplus">+ * are text filters.</span>
<a href="#l16.961"></a><span id="l16.961" class="difflineplus">+ */</span>
<a href="#l16.962"></a><span id="l16.962" class="difflineplus">+let MessageTextFilter = {</span>
<a href="#l16.963"></a><span id="l16.963" class="difflineplus">+  name: &quot;text&quot;,</span>
<a href="#l16.964"></a><span id="l16.964" class="difflineplus">+  domId: &quot;qfb-qs-textbox&quot;,</span>
<a href="#l16.965"></a><span id="l16.965" class="difflineplus">+  /**</span>
<a href="#l16.966"></a><span id="l16.966" class="difflineplus">+   * Parse the string into terms/phrases by finding matching double-quotes.  If</span>
<a href="#l16.967"></a><span id="l16.967" class="difflineplus">+   * we find a quote that doesn't have a friend, we assume the user was going</span>
<a href="#l16.968"></a><span id="l16.968" class="difflineplus">+   * to put a quote at the end of the string.  (This is important because we</span>
<a href="#l16.969"></a><span id="l16.969" class="difflineplus">+   * update using a timer and this results in stable behavior.)</span>
<a href="#l16.970"></a><span id="l16.970" class="difflineplus">+   *</span>
<a href="#l16.971"></a><span id="l16.971" class="difflineplus">+   * This code is cloned from gloda's msg_search.js and known good (enough :).</span>
<a href="#l16.972"></a><span id="l16.972" class="difflineplus">+   * I did change the friendless quote situation, though.</span>
<a href="#l16.973"></a><span id="l16.973" class="difflineplus">+   *</span>
<a href="#l16.974"></a><span id="l16.974" class="difflineplus">+   * @param aSearchString The phrase to parse up.</span>
<a href="#l16.975"></a><span id="l16.975" class="difflineplus">+   * @return A list of terms.</span>
<a href="#l16.976"></a><span id="l16.976" class="difflineplus">+   */</span>
<a href="#l16.977"></a><span id="l16.977" class="difflineplus">+  _parseSearchString: function MTF__parseSearchString(aSearchString) {</span>
<a href="#l16.978"></a><span id="l16.978" class="difflineplus">+    aSearchString = aSearchString.trim();</span>
<a href="#l16.979"></a><span id="l16.979" class="difflineplus">+    let terms = [];</span>
<a href="#l16.980"></a><span id="l16.980" class="difflineplus">+</span>
<a href="#l16.981"></a><span id="l16.981" class="difflineplus">+    /*</span>
<a href="#l16.982"></a><span id="l16.982" class="difflineplus">+     * Add the term as long as the trim on the way in didn't obliterate it.</span>
<a href="#l16.983"></a><span id="l16.983" class="difflineplus">+     *</span>
<a href="#l16.984"></a><span id="l16.984" class="difflineplus">+     * In the future this might have other helper logic; it did once before.</span>
<a href="#l16.985"></a><span id="l16.985" class="difflineplus">+     */</span>
<a href="#l16.986"></a><span id="l16.986" class="difflineplus">+    function addTerm(aTerm) {</span>
<a href="#l16.987"></a><span id="l16.987" class="difflineplus">+      if (aTerm)</span>
<a href="#l16.988"></a><span id="l16.988" class="difflineplus">+        terms.push(aTerm);</span>
<a href="#l16.989"></a><span id="l16.989" class="difflineplus">+    }</span>
<a href="#l16.990"></a><span id="l16.990" class="difflineplus">+</span>
<a href="#l16.991"></a><span id="l16.991" class="difflineplus">+    while (aSearchString) {</span>
<a href="#l16.992"></a><span id="l16.992" class="difflineplus">+      if (aSearchString[0] == '&quot;') {</span>
<a href="#l16.993"></a><span id="l16.993" class="difflineplus">+        let endIndex = aSearchString.indexOf(aSearchString[0], 1);</span>
<a href="#l16.994"></a><span id="l16.994" class="difflineplus">+        // treat a quote without a friend as making a phrase containing the</span>
<a href="#l16.995"></a><span id="l16.995" class="difflineplus">+        // rest of the string...</span>
<a href="#l16.996"></a><span id="l16.996" class="difflineplus">+        if (endIndex == -1) {</span>
<a href="#l16.997"></a><span id="l16.997" class="difflineplus">+          endIndex = aSearchString.length;</span>
<a href="#l16.998"></a><span id="l16.998" class="difflineplus">+        }</span>
<a href="#l16.999"></a><span id="l16.999" class="difflineplus">+</span>
<a href="#l16.1000"></a><span id="l16.1000" class="difflineplus">+        addTerm(aSearchString.substring(1, endIndex).trim());</span>
<a href="#l16.1001"></a><span id="l16.1001" class="difflineplus">+        aSearchString = aSearchString.substring(endIndex + 1);</span>
<a href="#l16.1002"></a><span id="l16.1002" class="difflineplus">+        continue;</span>
<a href="#l16.1003"></a><span id="l16.1003" class="difflineplus">+      }</span>
<a href="#l16.1004"></a><span id="l16.1004" class="difflineplus">+</span>
<a href="#l16.1005"></a><span id="l16.1005" class="difflineplus">+      let spaceIndex = aSearchString.indexOf(&quot; &quot;);</span>
<a href="#l16.1006"></a><span id="l16.1006" class="difflineplus">+      if (spaceIndex == -1) {</span>
<a href="#l16.1007"></a><span id="l16.1007" class="difflineplus">+        addTerm(aSearchString);</span>
<a href="#l16.1008"></a><span id="l16.1008" class="difflineplus">+        break;</span>
<a href="#l16.1009"></a><span id="l16.1009" class="difflineplus">+      }</span>
<a href="#l16.1010"></a><span id="l16.1010" class="difflineplus">+</span>
<a href="#l16.1011"></a><span id="l16.1011" class="difflineplus">+      addTerm(aSearchString.substring(0, spaceIndex));</span>
<a href="#l16.1012"></a><span id="l16.1012" class="difflineplus">+      aSearchString = aSearchString.substring(spaceIndex+1);</span>
<a href="#l16.1013"></a><span id="l16.1013" class="difflineplus">+    }</span>
<a href="#l16.1014"></a><span id="l16.1014" class="difflineplus">+</span>
<a href="#l16.1015"></a><span id="l16.1015" class="difflineplus">+    return terms;</span>
<a href="#l16.1016"></a><span id="l16.1016" class="difflineplus">+  },</span>
<a href="#l16.1017"></a><span id="l16.1017" class="difflineplus">+</span>
<a href="#l16.1018"></a><span id="l16.1018" class="difflineplus">+  /**</span>
<a href="#l16.1019"></a><span id="l16.1019" class="difflineplus">+   * For each search phrase, build a group that contains all our active text</span>
<a href="#l16.1020"></a><span id="l16.1020" class="difflineplus">+   *  filters OR'ed together.  So if the user queries for 'foo bar' with</span>
<a href="#l16.1021"></a><span id="l16.1021" class="difflineplus">+   *  sender and recipient enabled, we build:</span>
<a href="#l16.1022"></a><span id="l16.1022" class="difflineplus">+   * (&quot;foo&quot; sender OR &quot;foo&quot; recipient) AND (&quot;bar&quot; sender OR &quot;bar&quot; recipient)</span>
<a href="#l16.1023"></a><span id="l16.1023" class="difflineplus">+   */</span>
<a href="#l16.1024"></a><span id="l16.1024" class="difflineplus">+  appendTerms: function(aTermCreator, aTerms, aFilterValue) {</span>
<a href="#l16.1025"></a><span id="l16.1025" class="difflineplus">+    let term, value;</span>
<a href="#l16.1026"></a><span id="l16.1026" class="difflineplus">+</span>
<a href="#l16.1027"></a><span id="l16.1027" class="difflineplus">+    if (aFilterValue.text) {</span>
<a href="#l16.1028"></a><span id="l16.1028" class="difflineplus">+      let phrases = this._parseSearchString(aFilterValue.text);</span>
<a href="#l16.1029"></a><span id="l16.1029" class="difflineplus">+      for each (let [, phrase] in Iterator(phrases)) {</span>
<a href="#l16.1030"></a><span id="l16.1030" class="difflineplus">+        let firstClause = true;</span>
<a href="#l16.1031"></a><span id="l16.1031" class="difflineplus">+        term = null;</span>
<a href="#l16.1032"></a><span id="l16.1032" class="difflineplus">+        for each (let [tfName, tfValue] in Iterator(aFilterValue.states)) {</span>
<a href="#l16.1033"></a><span id="l16.1033" class="difflineplus">+          if (!tfValue)</span>
<a href="#l16.1034"></a><span id="l16.1034" class="difflineplus">+            continue;</span>
<a href="#l16.1035"></a><span id="l16.1035" class="difflineplus">+          let tfDef = this.textFilterDefs[tfName];</span>
<a href="#l16.1036"></a><span id="l16.1036" class="difflineplus">+</span>
<a href="#l16.1037"></a><span id="l16.1037" class="difflineplus">+          term = aTermCreator.createTerm();</span>
<a href="#l16.1038"></a><span id="l16.1038" class="difflineplus">+          term.attrib = tfDef.attrib;</span>
<a href="#l16.1039"></a><span id="l16.1039" class="difflineplus">+          value = term.value;</span>
<a href="#l16.1040"></a><span id="l16.1040" class="difflineplus">+          value.attrib = tfDef.attrib;</span>
<a href="#l16.1041"></a><span id="l16.1041" class="difflineplus">+          value.str = phrase;</span>
<a href="#l16.1042"></a><span id="l16.1042" class="difflineplus">+          term.value = value;</span>
<a href="#l16.1043"></a><span id="l16.1043" class="difflineplus">+          term.op = nsMsgSearchOp.Contains;</span>
<a href="#l16.1044"></a><span id="l16.1044" class="difflineplus">+          // AND for the group, but OR inside the group</span>
<a href="#l16.1045"></a><span id="l16.1045" class="difflineplus">+          term.booleanAnd = firstClause;</span>
<a href="#l16.1046"></a><span id="l16.1046" class="difflineplus">+          term.beginsGrouping = firstClause;</span>
<a href="#l16.1047"></a><span id="l16.1047" class="difflineplus">+          aTerms.push(term);</span>
<a href="#l16.1048"></a><span id="l16.1048" class="difflineplus">+          firstClause = false;</span>
<a href="#l16.1049"></a><span id="l16.1049" class="difflineplus">+        }</span>
<a href="#l16.1050"></a><span id="l16.1050" class="difflineplus">+        if (term)</span>
<a href="#l16.1051"></a><span id="l16.1051" class="difflineplus">+          term.endsGrouping = true;</span>
<a href="#l16.1052"></a><span id="l16.1052" class="difflineplus">+      }</span>
<a href="#l16.1053"></a><span id="l16.1053" class="difflineplus">+    }</span>
<a href="#l16.1054"></a><span id="l16.1054" class="difflineplus">+  },</span>
<a href="#l16.1055"></a><span id="l16.1055" class="difflineplus">+  getDefaults: function() {</span>
<a href="#l16.1056"></a><span id="l16.1056" class="difflineplus">+    let states = {};</span>
<a href="#l16.1057"></a><span id="l16.1057" class="difflineplus">+    for each (let [name, value] in Iterator(this._defaultStates)) {</span>
<a href="#l16.1058"></a><span id="l16.1058" class="difflineplus">+      states[name] = value;</span>
<a href="#l16.1059"></a><span id="l16.1059" class="difflineplus">+    }</span>
<a href="#l16.1060"></a><span id="l16.1060" class="difflineplus">+    return {</span>
<a href="#l16.1061"></a><span id="l16.1061" class="difflineplus">+      text: null,</span>
<a href="#l16.1062"></a><span id="l16.1062" class="difflineplus">+      states: states,</span>
<a href="#l16.1063"></a><span id="l16.1063" class="difflineplus">+    };</span>
<a href="#l16.1064"></a><span id="l16.1064" class="difflineplus">+  },</span>
<a href="#l16.1065"></a><span id="l16.1065" class="difflineplus">+  propagateState: function(aOld, aSticky) {</span>
<a href="#l16.1066"></a><span id="l16.1066" class="difflineplus">+    return {</span>
<a href="#l16.1067"></a><span id="l16.1067" class="difflineplus">+      text: aSticky ? aOld.text : null,</span>
<a href="#l16.1068"></a><span id="l16.1068" class="difflineplus">+      states: shallowObjCopy(aOld.states),</span>
<a href="#l16.1069"></a><span id="l16.1069" class="difflineplus">+    };</span>
<a href="#l16.1070"></a><span id="l16.1070" class="difflineplus">+  },</span>
<a href="#l16.1071"></a><span id="l16.1071" class="difflineplus">+  clearState: function(aState) {</span>
<a href="#l16.1072"></a><span id="l16.1072" class="difflineplus">+    let hadState = (aState.text &amp;&amp; aState.text != &quot;&quot;);</span>
<a href="#l16.1073"></a><span id="l16.1073" class="difflineplus">+    aState.text = null;</span>
<a href="#l16.1074"></a><span id="l16.1074" class="difflineplus">+    return [aState, hadState];</span>
<a href="#l16.1075"></a><span id="l16.1075" class="difflineplus">+  },</span>
<a href="#l16.1076"></a><span id="l16.1076" class="difflineplus">+</span>
<a href="#l16.1077"></a><span id="l16.1077" class="difflineplus">+  /**</span>
<a href="#l16.1078"></a><span id="l16.1078" class="difflineplus">+   * We need to create and bind our expando-bar toggle buttons.  We also need to</span>
<a href="#l16.1079"></a><span id="l16.1079" class="difflineplus">+   *  add a special down keypress handler that escapes the textbox into the</span>
<a href="#l16.1080"></a><span id="l16.1080" class="difflineplus">+   *  thread pane.</span>
<a href="#l16.1081"></a><span id="l16.1081" class="difflineplus">+   */</span>
<a href="#l16.1082"></a><span id="l16.1082" class="difflineplus">+  domBindExtra: function MessageTextFilter_domBind(aDocument, aMuxer, aNode) {</span>
<a href="#l16.1083"></a><span id="l16.1083" class="difflineplus">+    // -- platform-dependent emptytext setup</span>
<a href="#l16.1084"></a><span id="l16.1084" class="difflineplus">+    aNode.setAttribute(</span>
<a href="#l16.1085"></a><span id="l16.1085" class="difflineplus">+      &quot;emptytext&quot;,</span>
<a href="#l16.1086"></a><span id="l16.1086" class="difflineplus">+      aNode.getAttribute(&quot;emptytextbase&quot;)</span>
<a href="#l16.1087"></a><span id="l16.1087" class="difflineplus">+           .replace(&quot;#1&quot;, aNode.getAttribute(Application.platformIsMac ?</span>
<a href="#l16.1088"></a><span id="l16.1088" class="difflineplus">+                                             &quot;keyLabelMac&quot; : &quot;keyLabelNonMac&quot;)));</span>
<a href="#l16.1089"></a><span id="l16.1089" class="difflineplus">+</span>
<a href="#l16.1090"></a><span id="l16.1090" class="difflineplus">+    // -- Keypresses for focus transferral and upsell</span>
<a href="#l16.1091"></a><span id="l16.1091" class="difflineplus">+    aNode.addEventListener(&quot;keypress&quot;, function(aEvent) {</span>
<a href="#l16.1092"></a><span id="l16.1092" class="difflineplus">+      // - Down key into the thread pane</span>
<a href="#l16.1093"></a><span id="l16.1093" class="difflineplus">+      if (aEvent.keyCode == aEvent.DOM_VK_DOWN) {</span>
<a href="#l16.1094"></a><span id="l16.1094" class="difflineplus">+        let threadPane = aDocument.getElementById(&quot;threadTree&quot;);</span>
<a href="#l16.1095"></a><span id="l16.1095" class="difflineplus">+        // focusing does not actually select the row...</span>
<a href="#l16.1096"></a><span id="l16.1096" class="difflineplus">+        threadPane.focus();</span>
<a href="#l16.1097"></a><span id="l16.1097" class="difflineplus">+        // ...so explicitly select the current index.</span>
<a href="#l16.1098"></a><span id="l16.1098" class="difflineplus">+        threadPane.view.selection.select(threadPane.currentIndex);</span>
<a href="#l16.1099"></a><span id="l16.1099" class="difflineplus">+        return false;</span>
<a href="#l16.1100"></a><span id="l16.1100" class="difflineplus">+      }</span>
<a href="#l16.1101"></a><span id="l16.1101" class="difflineplus">+      // - Enter when upsell is actively proposed...</span>
<a href="#l16.1102"></a><span id="l16.1102" class="difflineplus">+      else if (aEvent.keyCode == aEvent.DOM_VK_ENTER) {</span>
<a href="#l16.1103"></a><span id="l16.1103" class="difflineplus">+      }</span>
<a href="#l16.1104"></a><span id="l16.1104" class="difflineplus">+      return true;</span>
<a href="#l16.1105"></a><span id="l16.1105" class="difflineplus">+    }, false);</span>
<a href="#l16.1106"></a><span id="l16.1106" class="difflineplus">+</span>
<a href="#l16.1107"></a><span id="l16.1107" class="difflineplus">+    // -- Blurring kills upsell.</span>
<a href="#l16.1108"></a><span id="l16.1108" class="difflineplus">+    aNode.addEventListener(&quot;blur&quot;, function(aEvent) {</span>
<a href="#l16.1109"></a><span id="l16.1109" class="difflineplus">+      let panel = aDocument.getElementById(&quot;qfb-text-search-upsell&quot;);</span>
<a href="#l16.1110"></a><span id="l16.1110" class="difflineplus">+      if ((FocusManager.activeWindow != aDocument.defaultView ||</span>
<a href="#l16.1111"></a><span id="l16.1111" class="difflineplus">+           aDocument.commandDispatcher.focusedElement != aNode.inputField) &amp;&amp;</span>
<a href="#l16.1112"></a><span id="l16.1112" class="difflineplus">+          panel.state == &quot;open&quot;) {</span>
<a href="#l16.1113"></a><span id="l16.1113" class="difflineplus">+        panel.hidePopup();</span>
<a href="#l16.1114"></a><span id="l16.1114" class="difflineplus">+      }</span>
<a href="#l16.1115"></a><span id="l16.1115" class="difflineplus">+    }, true);</span>
<a href="#l16.1116"></a><span id="l16.1116" class="difflineplus">+</span>
<a href="#l16.1117"></a><span id="l16.1117" class="difflineplus">+    // -- Expando Buttons!</span>
<a href="#l16.1118"></a><span id="l16.1118" class="difflineplus">+    function commandHandler(aEvent) {</span>
<a href="#l16.1119"></a><span id="l16.1119" class="difflineplus">+      let state = aMuxer.getFilterValueForMutation(MessageTextFilter.name);</span>
<a href="#l16.1120"></a><span id="l16.1120" class="difflineplus">+      let filterDef = MessageTextFilter.textFilterDefsByDomId[aEvent.target.id];</span>
<a href="#l16.1121"></a><span id="l16.1121" class="difflineplus">+      state.states[filterDef.name] = aEvent.target.checked;</span>
<a href="#l16.1122"></a><span id="l16.1122" class="difflineplus">+      aMuxer.updateSearch();</span>
<a href="#l16.1123"></a><span id="l16.1123" class="difflineplus">+    }</span>
<a href="#l16.1124"></a><span id="l16.1124" class="difflineplus">+</span>
<a href="#l16.1125"></a><span id="l16.1125" class="difflineplus">+    for each (let [, textFilter] in Iterator(this.textFilterDefs)) {</span>
<a href="#l16.1126"></a><span id="l16.1126" class="difflineplus">+      aDocument.getElementById(textFilter.domId).addEventListener(</span>
<a href="#l16.1127"></a><span id="l16.1127" class="difflineplus">+        &quot;command&quot;, commandHandler, false);</span>
<a href="#l16.1128"></a><span id="l16.1128" class="difflineplus">+    }</span>
<a href="#l16.1129"></a><span id="l16.1129" class="difflineplus">+  },</span>
<a href="#l16.1130"></a><span id="l16.1130" class="difflineplus">+</span>
<a href="#l16.1131"></a><span id="l16.1131" class="difflineplus">+  onCommand: function(aState, aNode, aEvent, aDocument) {</span>
<a href="#l16.1132"></a><span id="l16.1132" class="difflineplus">+    let text = aNode.value.length ? aNode.value : null;</span>
<a href="#l16.1133"></a><span id="l16.1133" class="difflineplus">+    if (text == aState.text) {</span>
<a href="#l16.1134"></a><span id="l16.1134" class="difflineplus">+      let upsell = aDocument.getElementById(&quot;qfb-text-search-upsell&quot;);</span>
<a href="#l16.1135"></a><span id="l16.1135" class="difflineplus">+      if (upsell.state == &quot;open&quot;) {</span>
<a href="#l16.1136"></a><span id="l16.1136" class="difflineplus">+        upsell.hidePopup();</span>
<a href="#l16.1137"></a><span id="l16.1137" class="difflineplus">+        let tabmail = aDocument.getElementById(&quot;tabmail&quot;);</span>
<a href="#l16.1138"></a><span id="l16.1138" class="difflineplus">+        tabmail.openTab(&quot;glodaFacet&quot;, {</span>
<a href="#l16.1139"></a><span id="l16.1139" class="difflineplus">+                          searcher: new GlodaMsgSearcher(null, aState.text)</span>
<a href="#l16.1140"></a><span id="l16.1140" class="difflineplus">+                        });</span>
<a href="#l16.1141"></a><span id="l16.1141" class="difflineplus">+      }</span>
<a href="#l16.1142"></a><span id="l16.1142" class="difflineplus">+      return [aState, false];</span>
<a href="#l16.1143"></a><span id="l16.1143" class="difflineplus">+    }</span>
<a href="#l16.1144"></a><span id="l16.1144" class="difflineplus">+</span>
<a href="#l16.1145"></a><span id="l16.1145" class="difflineplus">+    aState.text = text;</span>
<a href="#l16.1146"></a><span id="l16.1146" class="difflineplus">+    aDocument.getElementById(&quot;quick-filter-bar-filter-text-bar&quot;).collapsed =</span>
<a href="#l16.1147"></a><span id="l16.1147" class="difflineplus">+      (text == null);</span>
<a href="#l16.1148"></a><span id="l16.1148" class="difflineplus">+    return [aState, true];</span>
<a href="#l16.1149"></a><span id="l16.1149" class="difflineplus">+  },</span>
<a href="#l16.1150"></a><span id="l16.1150" class="difflineplus">+</span>
<a href="#l16.1151"></a><span id="l16.1151" class="difflineplus">+  reflectInDOM: function MessageTextFilter_reflectInDOM(aNode, aFilterValue,</span>
<a href="#l16.1152"></a><span id="l16.1152" class="difflineplus">+                                                        aDocument, aMuxer,</span>
<a href="#l16.1153"></a><span id="l16.1153" class="difflineplus">+                                                        aFromPFP) {</span>
<a href="#l16.1154"></a><span id="l16.1154" class="difflineplus">+    if (aFromPFP == &quot;nosale&quot;) {</span>
<a href="#l16.1155"></a><span id="l16.1155" class="difflineplus">+      let panel = aDocument.getElementById(&quot;qfb-text-search-upsell&quot;);</span>
<a href="#l16.1156"></a><span id="l16.1156" class="difflineplus">+      if (panel.state != &quot;closed&quot;)</span>
<a href="#l16.1157"></a><span id="l16.1157" class="difflineplus">+        panel.hidePopup();</span>
<a href="#l16.1158"></a><span id="l16.1158" class="difflineplus">+      return;</span>
<a href="#l16.1159"></a><span id="l16.1159" class="difflineplus">+    }</span>
<a href="#l16.1160"></a><span id="l16.1160" class="difflineplus">+    if (aFromPFP == &quot;upsell&quot;) {</span>
<a href="#l16.1161"></a><span id="l16.1161" class="difflineplus">+      let panel = aDocument.getElementById(&quot;qfb-text-search-upsell&quot;);</span>
<a href="#l16.1162"></a><span id="l16.1162" class="difflineplus">+      let line1 = aDocument.getElementById(&quot;qfb-upsell-line-one&quot;);</span>
<a href="#l16.1163"></a><span id="l16.1163" class="difflineplus">+      let line2 = aDocument.getElementById(&quot;qfb-upsell-line-two&quot;);</span>
<a href="#l16.1164"></a><span id="l16.1164" class="difflineplus">+      line1.value = line1.getAttribute(&quot;fmt&quot;).replace(&quot;#1&quot;, aFilterValue.text);</span>
<a href="#l16.1165"></a><span id="l16.1165" class="difflineplus">+      line2.value = line2.getAttribute(&quot;fmt&quot;).replace(&quot;#1&quot;, aFilterValue.text);</span>
<a href="#l16.1166"></a><span id="l16.1166" class="difflineplus">+</span>
<a href="#l16.1167"></a><span id="l16.1167" class="difflineplus">+      if (panel.state == &quot;closed&quot; &amp;&amp;</span>
<a href="#l16.1168"></a><span id="l16.1168" class="difflineplus">+          aDocument.commandDispatcher.focusedElement == aNode.inputField) {</span>
<a href="#l16.1169"></a><span id="l16.1169" class="difflineplus">+        let filterBar = aDocument.getElementById(&quot;quick-filter-bar&quot;);</span>
<a href="#l16.1170"></a><span id="l16.1170" class="difflineplus">+        //panel.sizeTo(filterBar.clientWidth - 20, filterBar.clientHeight - 20);</span>
<a href="#l16.1171"></a><span id="l16.1171" class="difflineplus">+        panel.openPopup(filterBar, &quot;after_end&quot;, -7, 7, false, true);</span>
<a href="#l16.1172"></a><span id="l16.1172" class="difflineplus">+      }</span>
<a href="#l16.1173"></a><span id="l16.1173" class="difflineplus">+      return;</span>
<a href="#l16.1174"></a><span id="l16.1174" class="difflineplus">+    }</span>
<a href="#l16.1175"></a><span id="l16.1175" class="difflineplus">+</span>
<a href="#l16.1176"></a><span id="l16.1176" class="difflineplus">+    // Make sure we have no visible upsell on state change while our textbox</span>
<a href="#l16.1177"></a><span id="l16.1177" class="difflineplus">+    //  retains focus.</span>
<a href="#l16.1178"></a><span id="l16.1178" class="difflineplus">+    let panel = aDocument.getElementById(&quot;qfb-text-search-upsell&quot;);</span>
<a href="#l16.1179"></a><span id="l16.1179" class="difflineplus">+    if (panel.state != &quot;closed&quot;)</span>
<a href="#l16.1180"></a><span id="l16.1180" class="difflineplus">+      panel.hidePopup();</span>
<a href="#l16.1181"></a><span id="l16.1181" class="difflineplus">+</span>
<a href="#l16.1182"></a><span id="l16.1182" class="difflineplus">+    // Update the text</span>
<a href="#l16.1183"></a><span id="l16.1183" class="difflineplus">+    aNode.value = aFilterValue.text;</span>
<a href="#l16.1184"></a><span id="l16.1184" class="difflineplus">+</span>
<a href="#l16.1185"></a><span id="l16.1185" class="difflineplus">+    // Update our expando buttons</span>
<a href="#l16.1186"></a><span id="l16.1186" class="difflineplus">+    let states = aFilterValue.states;</span>
<a href="#l16.1187"></a><span id="l16.1187" class="difflineplus">+    for each (let [, textFilter] in Iterator(this.textFilterDefs)) {</span>
<a href="#l16.1188"></a><span id="l16.1188" class="difflineplus">+      aDocument.getElementById(textFilter.domId).checked =</span>
<a href="#l16.1189"></a><span id="l16.1189" class="difflineplus">+        states[textFilter.name];</span>
<a href="#l16.1190"></a><span id="l16.1190" class="difflineplus">+    }</span>
<a href="#l16.1191"></a><span id="l16.1191" class="difflineplus">+</span>
<a href="#l16.1192"></a><span id="l16.1192" class="difflineplus">+    // Show the expando?</span>
<a href="#l16.1193"></a><span id="l16.1193" class="difflineplus">+    aDocument.getElementById(&quot;quick-filter-bar-filter-text-bar&quot;).collapsed =</span>
<a href="#l16.1194"></a><span id="l16.1194" class="difflineplus">+      (aFilterValue.text == null);</span>
<a href="#l16.1195"></a><span id="l16.1195" class="difflineplus">+  },</span>
<a href="#l16.1196"></a><span id="l16.1196" class="difflineplus">+</span>
<a href="#l16.1197"></a><span id="l16.1197" class="difflineplus">+  /**</span>
<a href="#l16.1198"></a><span id="l16.1198" class="difflineplus">+   * In order to do our upsell we need to know when we are not getting any</span>
<a href="#l16.1199"></a><span id="l16.1199" class="difflineplus">+   *  results.</span>
<a href="#l16.1200"></a><span id="l16.1200" class="difflineplus">+   */</span>
<a href="#l16.1201"></a><span id="l16.1201" class="difflineplus">+  postFilterProcess: function MessageTextFilter_postFilterProcess(aState,</span>
<a href="#l16.1202"></a><span id="l16.1202" class="difflineplus">+                                                                  aViewWrapper,</span>
<a href="#l16.1203"></a><span id="l16.1203" class="difflineplus">+                                                                  aFiltering) {</span>
<a href="#l16.1204"></a><span id="l16.1204" class="difflineplus">+    // If we're not filtering, not filtering on text, there are results, or</span>
<a href="#l16.1205"></a><span id="l16.1205" class="difflineplus">+    //  gloda is not enabled so upselling makes no sense, then bail.</span>
<a href="#l16.1206"></a><span id="l16.1206" class="difflineplus">+    // (Currently we always return &quot;nosale&quot; to make sure our panel is closed;</span>
<a href="#l16.1207"></a><span id="l16.1207" class="difflineplus">+    //  this might be overkill but unless it becomes a performance problem, it</span>
<a href="#l16.1208"></a><span id="l16.1208" class="difflineplus">+    //  keeps us safe from weird stuff.)</span>
<a href="#l16.1209"></a><span id="l16.1209" class="difflineplus">+    if (!aFiltering || !aState.text || aViewWrapper.dbView.numMsgsInView ||</span>
<a href="#l16.1210"></a><span id="l16.1210" class="difflineplus">+        !GlodaIndexer.enabled)</span>
<a href="#l16.1211"></a><span id="l16.1211" class="difflineplus">+      return [aState, &quot;nosale&quot;, false];</span>
<a href="#l16.1212"></a><span id="l16.1212" class="difflineplus">+</span>
<a href="#l16.1213"></a><span id="l16.1213" class="difflineplus">+    // since we're filtering, filtering on text, and there are no results, tell</span>
<a href="#l16.1214"></a><span id="l16.1214" class="difflineplus">+    //  the upsell code to get bizzay</span>
<a href="#l16.1215"></a><span id="l16.1215" class="difflineplus">+    return [aState, &quot;upsell&quot;, false];</span>
<a href="#l16.1216"></a><span id="l16.1216" class="difflineplus">+  },</span>
<a href="#l16.1217"></a><span id="l16.1217" class="difflineplus">+</span>
<a href="#l16.1218"></a><span id="l16.1218" class="difflineplus">+  /** maps text filter names to whether they are enabled by default (bool)  */</span>
<a href="#l16.1219"></a><span id="l16.1219" class="difflineplus">+  _defaultStates: {},</span>
<a href="#l16.1220"></a><span id="l16.1220" class="difflineplus">+  /** maps text filter name to text filter def */</span>
<a href="#l16.1221"></a><span id="l16.1221" class="difflineplus">+  textFilterDefs: {},</span>
<a href="#l16.1222"></a><span id="l16.1222" class="difflineplus">+  /** maps dom id to text filter def */</span>
<a href="#l16.1223"></a><span id="l16.1223" class="difflineplus">+  textFilterDefsByDomId: {},</span>
<a href="#l16.1224"></a><span id="l16.1224" class="difflineplus">+  defineTextFilter: function MessageTextFilter_defineTextFilter(aTextDef) {</span>
<a href="#l16.1225"></a><span id="l16.1225" class="difflineplus">+    this.textFilterDefs[aTextDef.name] = aTextDef;</span>
<a href="#l16.1226"></a><span id="l16.1226" class="difflineplus">+    this.textFilterDefsByDomId[aTextDef.domId] = aTextDef;</span>
<a href="#l16.1227"></a><span id="l16.1227" class="difflineplus">+    if (aTextDef.defaultState)</span>
<a href="#l16.1228"></a><span id="l16.1228" class="difflineplus">+      this._defaultStates[aTextDef.name] = true;</span>
<a href="#l16.1229"></a><span id="l16.1229" class="difflineplus">+  },</span>
<a href="#l16.1230"></a><span id="l16.1230" class="difflineplus">+};</span>
<a href="#l16.1231"></a><span id="l16.1231" class="difflineplus">+// Note that we definitely want this filter defined AFTER the cheap message</span>
<a href="#l16.1232"></a><span id="l16.1232" class="difflineplus">+// status filters, so don't reorder this invocation willy nilly.</span>
<a href="#l16.1233"></a><span id="l16.1233" class="difflineplus">+QuickFilterManager.defineFilter(MessageTextFilter);</span>
<a href="#l16.1234"></a><span id="l16.1234" class="difflineplus">+QuickFilterManager.textBoxDomId = &quot;qfb-qs-textbox&quot;;</span>
<a href="#l16.1235"></a><span id="l16.1235" class="difflineplus">+</span>
<a href="#l16.1236"></a><span id="l16.1236" class="difflineplus">+MessageTextFilter.defineTextFilter({</span>
<a href="#l16.1237"></a><span id="l16.1237" class="difflineplus">+  name: &quot;sender&quot;,</span>
<a href="#l16.1238"></a><span id="l16.1238" class="difflineplus">+  domId: &quot;qfb-qs-sender&quot;,</span>
<a href="#l16.1239"></a><span id="l16.1239" class="difflineplus">+  attrib: nsMsgSearchAttrib.Sender,</span>
<a href="#l16.1240"></a><span id="l16.1240" class="difflineplus">+  defaultState: true,</span>
<a href="#l16.1241"></a><span id="l16.1241" class="difflineplus">+});</span>
<a href="#l16.1242"></a><span id="l16.1242" class="difflineplus">+MessageTextFilter.defineTextFilter({</span>
<a href="#l16.1243"></a><span id="l16.1243" class="difflineplus">+  name: &quot;recipients&quot;,</span>
<a href="#l16.1244"></a><span id="l16.1244" class="difflineplus">+  domId: &quot;qfb-qs-recipients&quot;,</span>
<a href="#l16.1245"></a><span id="l16.1245" class="difflineplus">+  attrib: nsMsgSearchAttrib.ToOrCC,</span>
<a href="#l16.1246"></a><span id="l16.1246" class="difflineplus">+  defaultState: true,</span>
<a href="#l16.1247"></a><span id="l16.1247" class="difflineplus">+});</span>
<a href="#l16.1248"></a><span id="l16.1248" class="difflineplus">+MessageTextFilter.defineTextFilter({</span>
<a href="#l16.1249"></a><span id="l16.1249" class="difflineplus">+  name: &quot;subject&quot;,</span>
<a href="#l16.1250"></a><span id="l16.1250" class="difflineplus">+  domId: &quot;qfb-qs-subject&quot;,</span>
<a href="#l16.1251"></a><span id="l16.1251" class="difflineplus">+  attrib: nsMsgSearchAttrib.Subject,</span>
<a href="#l16.1252"></a><span id="l16.1252" class="difflineplus">+  defaultState: true,</span>
<a href="#l16.1253"></a><span id="l16.1253" class="difflineplus">+});</span>
<a href="#l16.1254"></a><span id="l16.1254" class="difflineplus">+MessageTextFilter.defineTextFilter({</span>
<a href="#l16.1255"></a><span id="l16.1255" class="difflineplus">+  name: &quot;body&quot;,</span>
<a href="#l16.1256"></a><span id="l16.1256" class="difflineplus">+  domId: &quot;qfb-qs-body&quot;,</span>
<a href="#l16.1257"></a><span id="l16.1257" class="difflineplus">+  attrib: nsMsgSearchAttrib.Body,</span>
<a href="#l16.1258"></a><span id="l16.1258" class="difflineplus">+  defaultState: false,</span>
<a href="#l16.1259"></a><span id="l16.1259" class="difflineplus">+});</span>
<a href="#l16.1260"></a><span id="l16.1260" class="difflineplus">+</span>
<a href="#l16.1261"></a><span id="l16.1261" class="difflineplus">+/**</span>
<a href="#l16.1262"></a><span id="l16.1262" class="difflineplus">+ * We need to be parameterized by folder/muxer to provide update notifications</span>
<a href="#l16.1263"></a><span id="l16.1263" class="difflineplus">+ * and this is the cleanest way given the current FolderDisplayWidget assumption</span>
<a href="#l16.1264"></a><span id="l16.1264" class="difflineplus">+ * that everyone knows the window they are in already.</span>
<a href="#l16.1265"></a><span id="l16.1265" class="difflineplus">+ */</span>
<a href="#l16.1266"></a><span id="l16.1266" class="difflineplus">+function ResultsLabelFolderDisplayListener(aMuxer) {</span>
<a href="#l16.1267"></a><span id="l16.1267" class="difflineplus">+  this.muxer = aMuxer;</span>
<a href="#l16.1268"></a><span id="l16.1268" class="difflineplus">+}</span>
<a href="#l16.1269"></a><span id="l16.1269" class="difflineplus">+ResultsLabelFolderDisplayListener.prototype = {</span>
<a href="#l16.1270"></a><span id="l16.1270" class="difflineplus">+  _update: function ResultsLabelFolderDisplayListener__update(aFolderDisplay) {</span>
<a href="#l16.1271"></a><span id="l16.1271" class="difflineplus">+    let filterer = aFolderDisplay._tabInfo._ext.quickFilter;</span>
<a href="#l16.1272"></a><span id="l16.1272" class="difflineplus">+    if (!filterer)</span>
<a href="#l16.1273"></a><span id="l16.1273" class="difflineplus">+      return;</span>
<a href="#l16.1274"></a><span id="l16.1274" class="difflineplus">+    let oldCount = (&quot;results&quot; in filterer.filterValues) ?</span>
<a href="#l16.1275"></a><span id="l16.1275" class="difflineplus">+                     filterer.filterValues.results : null;</span>
<a href="#l16.1276"></a><span id="l16.1276" class="difflineplus">+    // (we only display the tally when the filter is active; don't change that)</span>
<a href="#l16.1277"></a><span id="l16.1277" class="difflineplus">+    if (oldCount == null)</span>
<a href="#l16.1278"></a><span id="l16.1278" class="difflineplus">+      return;</span>
<a href="#l16.1279"></a><span id="l16.1279" class="difflineplus">+    let newCount = aFolderDisplay.view.dbView.numMsgsInView;</span>
<a href="#l16.1280"></a><span id="l16.1280" class="difflineplus">+    if (oldCount == newCount)</span>
<a href="#l16.1281"></a><span id="l16.1281" class="difflineplus">+      return;</span>
<a href="#l16.1282"></a><span id="l16.1282" class="difflineplus">+    filterer.setFilterValue(&quot;results&quot;, newCount, true);</span>
<a href="#l16.1283"></a><span id="l16.1283" class="difflineplus">+    if (aFolderDisplay.active)</span>
<a href="#l16.1284"></a><span id="l16.1284" class="difflineplus">+      this.muxer.reflectFiltererState(filterer, aFolderDisplay, &quot;results&quot;);</span>
<a href="#l16.1285"></a><span id="l16.1285" class="difflineplus">+  },</span>
<a href="#l16.1286"></a><span id="l16.1286" class="difflineplus">+</span>
<a href="#l16.1287"></a><span id="l16.1287" class="difflineplus">+  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.1288"></a><span id="l16.1288" class="difflineplus">+  //// FolderDisplayListener</span>
<a href="#l16.1289"></a><span id="l16.1289" class="difflineplus">+</span>
<a href="#l16.1290"></a><span id="l16.1290" class="difflineplus">+  // We want to make sure that anything that would change the count of displayed</span>
<a href="#l16.1291"></a><span id="l16.1291" class="difflineplus">+  //  messages causes us to update our dislayed value.</span>
<a href="#l16.1292"></a><span id="l16.1292" class="difflineplus">+</span>
<a href="#l16.1293"></a><span id="l16.1293" class="difflineplus">+  onMessageCountsChanged: function(aFolderDisplay) {</span>
<a href="#l16.1294"></a><span id="l16.1294" class="difflineplus">+    this._update(aFolderDisplay);</span>
<a href="#l16.1295"></a><span id="l16.1295" class="difflineplus">+  },</span>
<a href="#l16.1296"></a><span id="l16.1296" class="difflineplus">+</span>
<a href="#l16.1297"></a><span id="l16.1297" class="difflineplus">+  onMessagesRemoved: function(aFolderDisplay) {</span>
<a href="#l16.1298"></a><span id="l16.1298" class="difflineplus">+    this._update(aFolderDisplay);</span>
<a href="#l16.1299"></a><span id="l16.1299" class="difflineplus">+  },</span>
<a href="#l16.1300"></a><span id="l16.1300" class="difflineplus">+};</span>
<a href="#l16.1301"></a><span id="l16.1301" class="difflineplus">+</span>
<a href="#l16.1302"></a><span id="l16.1302" class="difflineplus">+/**</span>
<a href="#l16.1303"></a><span id="l16.1303" class="difflineplus">+ * The results label says whether there were any matches and, if so, how many.</span>
<a href="#l16.1304"></a><span id="l16.1304" class="difflineplus">+ */</span>
<a href="#l16.1305"></a><span id="l16.1305" class="difflineplus">+QuickFilterManager.defineFilter({</span>
<a href="#l16.1306"></a><span id="l16.1306" class="difflineplus">+  name: &quot;results&quot;,</span>
<a href="#l16.1307"></a><span id="l16.1307" class="difflineplus">+  domId: &quot;qfb-results-label&quot;,</span>
<a href="#l16.1308"></a><span id="l16.1308" class="difflineplus">+  appendTerms: function(aTermCreator, aTerms, aFilterValue) {</span>
<a href="#l16.1309"></a><span id="l16.1309" class="difflineplus">+  },</span>
<a href="#l16.1310"></a><span id="l16.1310" class="difflineplus">+  /**</span>
<a href="#l16.1311"></a><span id="l16.1311" class="difflineplus">+   * Hook us up as a folder display listener so we can get information on when</span>
<a href="#l16.1312"></a><span id="l16.1312" class="difflineplus">+   * the counts change.</span>
<a href="#l16.1313"></a><span id="l16.1313" class="difflineplus">+   */</span>
<a href="#l16.1314"></a><span id="l16.1314" class="difflineplus">+  domBindExtra: function MessageTextFilter_domBind(aDocument, aMuxer, aNode) {</span>
<a href="#l16.1315"></a><span id="l16.1315" class="difflineplus">+    aDocument.defaultView.FolderDisplayListenerManager.registerListener(</span>
<a href="#l16.1316"></a><span id="l16.1316" class="difflineplus">+      new ResultsLabelFolderDisplayListener(aMuxer));</span>
<a href="#l16.1317"></a><span id="l16.1317" class="difflineplus">+  },</span>
<a href="#l16.1318"></a><span id="l16.1318" class="difflineplus">+  reflectInDOM: function MessageTextFilter_reflectInDOM(aNode, aFilterValue,</span>
<a href="#l16.1319"></a><span id="l16.1319" class="difflineplus">+                                                        aDocument) {</span>
<a href="#l16.1320"></a><span id="l16.1320" class="difflineplus">+    if (aFilterValue == null) {</span>
<a href="#l16.1321"></a><span id="l16.1321" class="difflineplus">+      aNode.value = &quot;&quot;;</span>
<a href="#l16.1322"></a><span id="l16.1322" class="difflineplus">+      aNode.style.visibility = &quot;hidden&quot;;</span>
<a href="#l16.1323"></a><span id="l16.1323" class="difflineplus">+    }</span>
<a href="#l16.1324"></a><span id="l16.1324" class="difflineplus">+    else if (aFilterValue == 0) {</span>
<a href="#l16.1325"></a><span id="l16.1325" class="difflineplus">+      aNode.value = aNode.getAttribute(&quot;noresultsstring&quot;);</span>
<a href="#l16.1326"></a><span id="l16.1326" class="difflineplus">+      aNode.style.visibility = &quot;visible&quot;;</span>
<a href="#l16.1327"></a><span id="l16.1327" class="difflineplus">+    }</span>
<a href="#l16.1328"></a><span id="l16.1328" class="difflineplus">+    else {</span>
<a href="#l16.1329"></a><span id="l16.1329" class="difflineplus">+      let fmtstring = aNode.getAttribute(&quot;somefmtstring&quot;);</span>
<a href="#l16.1330"></a><span id="l16.1330" class="difflineplus">+</span>
<a href="#l16.1331"></a><span id="l16.1331" class="difflineplus">+      aNode.value = PluralForm.get(aFilterValue, fmtstring)</span>
<a href="#l16.1332"></a><span id="l16.1332" class="difflineplus">+                              .replace(&quot;#1&quot;, aFilterValue.toString());</span>
<a href="#l16.1333"></a><span id="l16.1333" class="difflineplus">+      aNode.style.visibility = &quot;visible&quot;;</span>
<a href="#l16.1334"></a><span id="l16.1334" class="difflineplus">+    }</span>
<a href="#l16.1335"></a><span id="l16.1335" class="difflineplus">+  },</span>
<a href="#l16.1336"></a><span id="l16.1336" class="difflineplus">+  /**</span>
<a href="#l16.1337"></a><span id="l16.1337" class="difflineplus">+   * We slightly abuse the filtering hook to figure out how many messages there</span>
<a href="#l16.1338"></a><span id="l16.1338" class="difflineplus">+   *  are and whether a filter is active.  What makes this reasonable is that</span>
<a href="#l16.1339"></a><span id="l16.1339" class="difflineplus">+   *  a more complicated widget that visualized the results as a timeline would</span>
<a href="#l16.1340"></a><span id="l16.1340" class="difflineplus">+   *  definitely want to be hooked up like this.  (Although they would want</span>
<a href="#l16.1341"></a><span id="l16.1341" class="difflineplus">+   *  to implement propagateState since the state they store would be pretty</span>
<a href="#l16.1342"></a><span id="l16.1342" class="difflineplus">+   *  expensive.)</span>
<a href="#l16.1343"></a><span id="l16.1343" class="difflineplus">+   */</span>
<a href="#l16.1344"></a><span id="l16.1344" class="difflineplus">+  postFilterProcess: function TFF_postFilterProcess(aState, aViewWrapper,</span>
<a href="#l16.1345"></a><span id="l16.1345" class="difflineplus">+                                                    aFiltering) {</span>
<a href="#l16.1346"></a><span id="l16.1346" class="difflineplus">+    return [aFiltering ? aViewWrapper.dbView.numMsgsInView : null, true, false];</span>
<a href="#l16.1347"></a><span id="l16.1347" class="difflineplus">+  },</span>
<a href="#l16.1348"></a><span id="l16.1348" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">deleted file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- a/mail/base/modules/quickSearchManager.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ /dev/null</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -1,262 +0,0 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineminus">- *</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">- *</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">- * License.</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">- *</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineminus">- * The Original Code is Mozilla Communicator client code, released</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">- * March 31, 1998.</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">- *</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">- * Netscape Communications Corporation.</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineminus">- *</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineminus">- * Contributor(s):</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineminus">- *   Seth Spitzer &lt;sspitzer@netscape.com&gt;</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineminus">- *   Scott MacGregor &lt;mscott@mozilla.org&gt;</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineminus">- *   David Bienvenu &lt;bienvenu@nventure.com&gt;</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineminus">- *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">- *   Thomas Dllmann &lt;bugzilla2009@duellmann24.net&gt;</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">- *</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineminus">- * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineminus">- * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineminus">- *</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineminus">-</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineminus">-/*</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineminus">- * This file mimics mailViewManager.js.  It shares the same idiom of creating</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineminus">- *  lists of search terms, and so is really quite similar.  Except the term</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineminus">- *  Manager is all wrong; however, we keep it for parallel construction and</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineminus">- *  ease of searching.</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineminus">- */</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineminus">-</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineminus">-const EXPORTED_SYMBOLS = ['QuickSearchManager', 'QuickSearchConstants'];</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineminus">-</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineminus">-const Cc = Components.classes;</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineminus">-const Ci = Components.interfaces;</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineminus">-const Cr = Components.results;</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineminus">-const Cu = Components.utils;</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineminus">-</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineminus">-Cu.import(&quot;resource:///modules/errUtils.js&quot;);</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineminus">-</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineminus">-try {</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineminus">-  Cu.import(&quot;resource:///modules/StringBundle.js&quot;);</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineminus">-} catch (e) {</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineminus">-  logException(e);</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineminus">-}</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineminus">-</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineminus">-const nsMsgSearchScope = Ci.nsMsgSearchScope;</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineminus">-const nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineminus">-const nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineminus">-</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineminus">-/**</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineminus">- * Constants originally found in searchBar.js bundled together into a single</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineminus">- *  name-space contribution.</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineminus">- *</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineminus">- * These constants are used by quick-search-menupopup.  The state of</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineminus">- *  quick-search-menupopup is persisted to localstore.rdf, so new values need</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineminus">- *  new constants.</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineminus">- */</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineminus">-var QuickSearchConstants = {</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineminus">-  kQuickSearchSubjectFromOrRecipient: 0,</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineminus">-  kQuickSearchFromOrSubject: 1,</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineminus">-  kQuickSearchRecipientOrSubject: 2,</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineminus">-  kQuickSearchSubject: 3,</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineminus">-  kQuickSearchFrom: 4,</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineminus">-  kQuickSearchRecipient: 5,</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineminus">-  kQuickSearchBody: 6,</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineminus">-  kQuickSearchEntireMessage: 7</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineminus">-};</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineminus">-const kQuickSearchCount = 8;</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineminus">-</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineminus">-var QuickSearchLabels = null; // populated dynamically from properties files</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineminus">-</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineminus">-/**</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineminus">- * All quick search logic that takes us from a search string (and search mode)</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineminus">- *  to a set of search terms goes in here.  Check out FolderDisplayWidget for</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineminus">- *  display concerns involving views, or DBViewWrapper and SearchSpec for the</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineminus">- *  actual nsIMsgDBView-related logic.</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineminus">- */</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineminus">-var QuickSearchManager = {</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineminus">-</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineminus">-  _modeLabels: {},</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineminus">-</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineminus">-  /**</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineminus">-   * Populate an associative array containing the labels from a properties file</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineminus">-   */</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineminus">-  loadLabels: function QuickSearchManager_loadLabels() {</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineminus">-    const quickSearchStrings =</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineminus">-      new StringBundle(&quot;chrome://messenger/locale/quickSearch.properties&quot;);</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineminus">-    this._modeLabels[QuickSearchConstants.kQuickSearchSubject] =</span>
<a href="#l17.112"></a><span id="l17.112" class="difflineminus">-      quickSearchStrings.get(&quot;searchSubject.label&quot;);</span>
<a href="#l17.113"></a><span id="l17.113" class="difflineminus">-    this._modeLabels[QuickSearchConstants.kQuickSearchFrom] =</span>
<a href="#l17.114"></a><span id="l17.114" class="difflineminus">-      quickSearchStrings.get(&quot;searchFrom.label&quot;);</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineminus">-    this._modeLabels[QuickSearchConstants.kQuickSearchFromOrSubject] =</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineminus">-      quickSearchStrings.get(&quot;searchFromOrSubject.label&quot;);</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineminus">-    this._modeLabels[QuickSearchConstants.kQuickSearchRecipient] =</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineminus">-      quickSearchStrings.get(&quot;searchRecipient.label&quot;);</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineminus">-    this._modeLabels[QuickSearchConstants.kQuickSearchRecipientOrSubject] =</span>
<a href="#l17.120"></a><span id="l17.120" class="difflineminus">-      quickSearchStrings.get(&quot;searchRecipientOrSubject.label&quot;);</span>
<a href="#l17.121"></a><span id="l17.121" class="difflineminus">-    this._modeLabels[QuickSearchConstants.kQuickSearchBody] =</span>
<a href="#l17.122"></a><span id="l17.122" class="difflineminus">-      quickSearchStrings.get(&quot;searchMsgBody.label&quot;);</span>
<a href="#l17.123"></a><span id="l17.123" class="difflineminus">-    this._modeLabels[QuickSearchConstants.kQuickSearchSubjectFromOrRecipient] =</span>
<a href="#l17.124"></a><span id="l17.124" class="difflineminus">-      quickSearchStrings.get(&quot;searchSubjectFromOrRecipient.label&quot;);</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineminus">-    this._modeLabels[QuickSearchConstants.kQuickSearchEntireMessage] =</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineminus">-      quickSearchStrings.get(&quot;searchEntireMessage.label&quot;);</span>
<a href="#l17.127"></a><span id="l17.127" class="difflineminus">-</span>
<a href="#l17.128"></a><span id="l17.128" class="difflineminus">-  },</span>
<a href="#l17.129"></a><span id="l17.129" class="difflineminus">-</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineminus">-  /**</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineminus">-   * Create the structure that the UI needs to fully describe a quick search</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineminus">-   * mode.</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineminus">-   *</span>
<a href="#l17.134"></a><span id="l17.134" class="difflineminus">-   * @return a list of array objects mapping 'value' to the constant specified</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineminus">-   * in QuickSearchConstants, and 'label' to a localized string.</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineminus">-   */</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineminus">-  getSearchModes: function QuickSearchManager_getSearchModes() {</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineminus">-    let modes = [];</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineminus">-    for (let i = 0; i &lt; kQuickSearchCount; i++)</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineminus">-      modes.push({'value': i, 'label': this._modeLabels[i]});</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineminus">-    return modes;</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineminus">-  },</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineminus">-</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineminus">-  /**</span>
<a href="#l17.145"></a><span id="l17.145" class="difflineminus">-   * Create the search terms for the given quick-search configuration.  This is</span>
<a href="#l17.146"></a><span id="l17.146" class="difflineminus">-   *  intended to basically be directly used in the service of the UI without</span>
<a href="#l17.147"></a><span id="l17.147" class="difflineminus">-   *  pre-processing.  If you want to add extra logic, probably add it in here</span>
<a href="#l17.148"></a><span id="l17.148" class="difflineminus">-   *  (with appropriate refactoring.)</span>
<a href="#l17.149"></a><span id="l17.149" class="difflineminus">-   * Callers should strongly consider using DBViewWrapper's search attribute</span>
<a href="#l17.150"></a><span id="l17.150" class="difflineminus">-   *  (which is a SearchSpec)'s quickSearch method which in turn calls us.  The</span>
<a href="#l17.151"></a><span id="l17.151" class="difflineminus">-   *  DBViewWrapper may in turn be embedded in a FolderDisplayWidget.  So an</span>
<a href="#l17.152"></a><span id="l17.152" class="difflineminus">-   *  example usage might be:</span>
<a href="#l17.153"></a><span id="l17.153" class="difflineminus">-   *</span>
<a href="#l17.154"></a><span id="l17.154" class="difflineminus">-   * gFolderDisplay.view.search.quickSearch(</span>
<a href="#l17.155"></a><span id="l17.155" class="difflineminus">-   *   QuickSearchConstants.kQuickSearchSubject, &quot;foo|bar&quot;);</span>
<a href="#l17.156"></a><span id="l17.156" class="difflineminus">-   *</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineminus">-   * @param aTermCreator A nsIMsgSearchSession or other interface with a</span>
<a href="#l17.158"></a><span id="l17.158" class="difflineminus">-   *     createTerm method.</span>
<a href="#l17.159"></a><span id="l17.159" class="difflineminus">-   * @param aSearchMode One of the QuickSearchConstants.kQuickSearch* search</span>
<a href="#l17.160"></a><span id="l17.160" class="difflineminus">-   *     mode constants specifying what parts of the message to search on.</span>
<a href="#l17.161"></a><span id="l17.161" class="difflineminus">-   * @param aSearchString The search string, consisting of sub-strings delimited</span>
<a href="#l17.162"></a><span id="l17.162" class="difflineminus">-   *     by '|' to be OR-ed together.  Given the string &quot;foo&quot; we search for</span>
<a href="#l17.163"></a><span id="l17.163" class="difflineminus">-   *     messages containing &quot;foo&quot;.  Given the string &quot;foo|bar&quot;, we search for</span>
<a href="#l17.164"></a><span id="l17.164" class="difflineminus">-   *     messages containing &quot;foo&quot; or &quot;bar&quot;.</span>
<a href="#l17.165"></a><span id="l17.165" class="difflineminus">-   * @return a list of nsIMsgSearch term instances representing the search as</span>
<a href="#l17.166"></a><span id="l17.166" class="difflineminus">-   *     defined by the arguments.</span>
<a href="#l17.167"></a><span id="l17.167" class="difflineminus">-   */</span>
<a href="#l17.168"></a><span id="l17.168" class="difflineminus">-  createSearchTerms: function QuickSearchManager_createSearchTerms(</span>
<a href="#l17.169"></a><span id="l17.169" class="difflineminus">-      aTermCreator, aSearchMode, aSearchString) {</span>
<a href="#l17.170"></a><span id="l17.170" class="difflineminus">-    let searchTerms = [];</span>
<a href="#l17.171"></a><span id="l17.171" class="difflineminus">-    let termList = aSearchString.split(&quot;|&quot;);</span>
<a href="#l17.172"></a><span id="l17.172" class="difflineminus">-    for (var i = 0; i &lt; termList.length; i ++)</span>
<a href="#l17.173"></a><span id="l17.173" class="difflineminus">-    {</span>
<a href="#l17.174"></a><span id="l17.174" class="difflineminus">-      // if the term is empty, skip it</span>
<a href="#l17.175"></a><span id="l17.175" class="difflineminus">-      if (termList[i] == &quot;&quot;)</span>
<a href="#l17.176"></a><span id="l17.176" class="difflineminus">-        continue;</span>
<a href="#l17.177"></a><span id="l17.177" class="difflineminus">-</span>
<a href="#l17.178"></a><span id="l17.178" class="difflineminus">-      // create, fill, and append the terms for subject etc.</span>
<a href="#l17.179"></a><span id="l17.179" class="difflineminus">-      let term;</span>
<a href="#l17.180"></a><span id="l17.180" class="difflineminus">-      let value;</span>
<a href="#l17.181"></a><span id="l17.181" class="difflineminus">-</span>
<a href="#l17.182"></a><span id="l17.182" class="difflineminus">-      // if our search criteria is subject or subject|from etc. then add a term for</span>
<a href="#l17.183"></a><span id="l17.183" class="difflineminus">-      // the subject</span>
<a href="#l17.184"></a><span id="l17.184" class="difflineminus">-      if (aSearchMode == QuickSearchConstants.kQuickSearchSubject ||</span>
<a href="#l17.185"></a><span id="l17.185" class="difflineminus">-          aSearchMode == QuickSearchConstants.kQuickSearchFromOrSubject ||</span>
<a href="#l17.186"></a><span id="l17.186" class="difflineminus">-          aSearchMode == QuickSearchConstants.kQuickSearchRecipientOrSubject ||</span>
<a href="#l17.187"></a><span id="l17.187" class="difflineminus">-          aSearchMode == QuickSearchConstants.kQuickSearchSubjectFromOrRecipient ||</span>
<a href="#l17.188"></a><span id="l17.188" class="difflineminus">-          aSearchMode == QuickSearchConstants.kQuickSearchEntireMessage)</span>
<a href="#l17.189"></a><span id="l17.189" class="difflineminus">-      {</span>
<a href="#l17.190"></a><span id="l17.190" class="difflineminus">-        term = aTermCreator.createTerm();</span>
<a href="#l17.191"></a><span id="l17.191" class="difflineminus">-        value = term.value;</span>
<a href="#l17.192"></a><span id="l17.192" class="difflineminus">-        value.str = termList[i];</span>
<a href="#l17.193"></a><span id="l17.193" class="difflineminus">-        term.value = value;</span>
<a href="#l17.194"></a><span id="l17.194" class="difflineminus">-        term.attrib = nsMsgSearchAttrib.Subject;</span>
<a href="#l17.195"></a><span id="l17.195" class="difflineminus">-        term.op = nsMsgSearchOp.Contains;</span>
<a href="#l17.196"></a><span id="l17.196" class="difflineminus">-        term.booleanAnd = false;</span>
<a href="#l17.197"></a><span id="l17.197" class="difflineminus">-        searchTerms.push(term);</span>
<a href="#l17.198"></a><span id="l17.198" class="difflineminus">-      }</span>
<a href="#l17.199"></a><span id="l17.199" class="difflineminus">-</span>
<a href="#l17.200"></a><span id="l17.200" class="difflineminus">-      // create, fill, and append a term for the body</span>
<a href="#l17.201"></a><span id="l17.201" class="difflineminus">-      if (aSearchMode == QuickSearchConstants.kQuickSearchBody ||</span>
<a href="#l17.202"></a><span id="l17.202" class="difflineminus">-          aSearchMode == QuickSearchConstants.kQuickSearchEntireMessage)</span>
<a href="#l17.203"></a><span id="l17.203" class="difflineminus">-      {</span>
<a href="#l17.204"></a><span id="l17.204" class="difflineminus">-        // what do we do for news and imap users that aren't configured for offline use?</span>
<a href="#l17.205"></a><span id="l17.205" class="difflineminus">-        // in these cases the body search will never return any matches. Should we try to</span>
<a href="#l17.206"></a><span id="l17.206" class="difflineminus">-        // see if body is a valid search scope in this particular case before doing the search?</span>
<a href="#l17.207"></a><span id="l17.207" class="difflineminus">-        // should we switch back to a subject/from search behind the scenes?</span>
<a href="#l17.208"></a><span id="l17.208" class="difflineminus">-        term = aTermCreator.createTerm();</span>
<a href="#l17.209"></a><span id="l17.209" class="difflineminus">-        value = term.value;</span>
<a href="#l17.210"></a><span id="l17.210" class="difflineminus">-        value.str = termList[i];</span>
<a href="#l17.211"></a><span id="l17.211" class="difflineminus">-        term.value = value;</span>
<a href="#l17.212"></a><span id="l17.212" class="difflineminus">-        term.attrib = nsMsgSearchAttrib.Body;</span>
<a href="#l17.213"></a><span id="l17.213" class="difflineminus">-        term.op = nsMsgSearchOp.Contains;</span>
<a href="#l17.214"></a><span id="l17.214" class="difflineminus">-        term.booleanAnd = false;</span>
<a href="#l17.215"></a><span id="l17.215" class="difflineminus">-        searchTerms.push(term);</span>
<a href="#l17.216"></a><span id="l17.216" class="difflineminus">-      }</span>
<a href="#l17.217"></a><span id="l17.217" class="difflineminus">-</span>
<a href="#l17.218"></a><span id="l17.218" class="difflineminus">-      // create, fill, and append a term for from</span>
<a href="#l17.219"></a><span id="l17.219" class="difflineminus">-      if (aSearchMode == QuickSearchConstants.kQuickSearchFrom ||</span>
<a href="#l17.220"></a><span id="l17.220" class="difflineminus">-          aSearchMode == QuickSearchConstants.kQuickSearchFromOrSubject)</span>
<a href="#l17.221"></a><span id="l17.221" class="difflineminus">-      {</span>
<a href="#l17.222"></a><span id="l17.222" class="difflineminus">-        term = aTermCreator.createTerm();</span>
<a href="#l17.223"></a><span id="l17.223" class="difflineminus">-        value = term.value;</span>
<a href="#l17.224"></a><span id="l17.224" class="difflineminus">-        value.str = termList[i];</span>
<a href="#l17.225"></a><span id="l17.225" class="difflineminus">-        term.value = value;</span>
<a href="#l17.226"></a><span id="l17.226" class="difflineminus">-        term.attrib = nsMsgSearchAttrib.Sender;</span>
<a href="#l17.227"></a><span id="l17.227" class="difflineminus">-        term.op = nsMsgSearchOp.Contains;</span>
<a href="#l17.228"></a><span id="l17.228" class="difflineminus">-        term.booleanAnd = false;</span>
<a href="#l17.229"></a><span id="l17.229" class="difflineminus">-        searchTerms.push(term);</span>
<a href="#l17.230"></a><span id="l17.230" class="difflineminus">-      }</span>
<a href="#l17.231"></a><span id="l17.231" class="difflineminus">-</span>
<a href="#l17.232"></a><span id="l17.232" class="difflineminus">-      // create, fill, and append a term for the recipient</span>
<a href="#l17.233"></a><span id="l17.233" class="difflineminus">-      // XXX: need to include bcc here</span>
<a href="#l17.234"></a><span id="l17.234" class="difflineminus">-      if (aSearchMode == QuickSearchConstants.kQuickSearchRecipient ||</span>
<a href="#l17.235"></a><span id="l17.235" class="difflineminus">-          aSearchMode == QuickSearchConstants.kQuickSearchRecipientOrSubject)</span>
<a href="#l17.236"></a><span id="l17.236" class="difflineminus">-      {</span>
<a href="#l17.237"></a><span id="l17.237" class="difflineminus">-        term = aTermCreator.createTerm();</span>
<a href="#l17.238"></a><span id="l17.238" class="difflineminus">-        value = term.value;</span>
<a href="#l17.239"></a><span id="l17.239" class="difflineminus">-        value.str = termList[i];</span>
<a href="#l17.240"></a><span id="l17.240" class="difflineminus">-        term.value = value;</span>
<a href="#l17.241"></a><span id="l17.241" class="difflineminus">-        term.attrib = nsMsgSearchAttrib.ToOrCC;</span>
<a href="#l17.242"></a><span id="l17.242" class="difflineminus">-        term.op = nsMsgSearchOp.Contains;</span>
<a href="#l17.243"></a><span id="l17.243" class="difflineminus">-        term.booleanAnd = false;</span>
<a href="#l17.244"></a><span id="l17.244" class="difflineminus">-        searchTerms.push(term);</span>
<a href="#l17.245"></a><span id="l17.245" class="difflineminus">-      }</span>
<a href="#l17.246"></a><span id="l17.246" class="difflineminus">-</span>
<a href="#l17.247"></a><span id="l17.247" class="difflineminus">-      // create, fill, and append the AllAddresses term</span>
<a href="#l17.248"></a><span id="l17.248" class="difflineminus">-      if (aSearchMode == QuickSearchConstants.kQuickSearchSubjectFromOrRecipient ||</span>
<a href="#l17.249"></a><span id="l17.249" class="difflineminus">-          aSearchMode == QuickSearchConstants.kQuickSearchEntireMessage)</span>
<a href="#l17.250"></a><span id="l17.250" class="difflineminus">-      {</span>
<a href="#l17.251"></a><span id="l17.251" class="difflineminus">-        term = aTermCreator.createTerm();</span>
<a href="#l17.252"></a><span id="l17.252" class="difflineminus">-        value = term.value;</span>
<a href="#l17.253"></a><span id="l17.253" class="difflineminus">-        value.str = termList[i];</span>
<a href="#l17.254"></a><span id="l17.254" class="difflineminus">-        term.value = value;</span>
<a href="#l17.255"></a><span id="l17.255" class="difflineminus">-        term.attrib = nsMsgSearchAttrib.AllAddresses;</span>
<a href="#l17.256"></a><span id="l17.256" class="difflineminus">-        term.op = nsMsgSearchOp.Contains;</span>
<a href="#l17.257"></a><span id="l17.257" class="difflineminus">-        term.booleanAnd = false;</span>
<a href="#l17.258"></a><span id="l17.258" class="difflineminus">-        searchTerms.push(term);</span>
<a href="#l17.259"></a><span id="l17.259" class="difflineminus">-      }</span>
<a href="#l17.260"></a><span id="l17.260" class="difflineminus">-    }</span>
<a href="#l17.261"></a><span id="l17.261" class="difflineminus">-</span>
<a href="#l17.262"></a><span id="l17.262" class="difflineminus">-    return searchTerms.length ? searchTerms : null;</span>
<a href="#l17.263"></a><span id="l17.263" class="difflineminus">-  }</span>
<a href="#l17.264"></a><span id="l17.264" class="difflineminus">-};</span>
<a href="#l17.265"></a><span id="l17.265" class="difflineminus">-</span>
<a href="#l17.266"></a><span id="l17.266" class="difflineminus">-QuickSearchManager.loadLabels();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mail/base/modules/searchSpec.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mail/base/modules/searchSpec.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -38,17 +38,16 @@</span>
<a href="#l18.4"></a><span id="l18.4"> const EXPORTED_SYMBOLS = ['SearchSpec'];</span>
<a href="#l18.5"></a><span id="l18.5"> </span>
<a href="#l18.6"></a><span id="l18.6"> const Cc = Components.classes;</span>
<a href="#l18.7"></a><span id="l18.7"> const Ci = Components.interfaces;</span>
<a href="#l18.8"></a><span id="l18.8"> const Cr = Components.results;</span>
<a href="#l18.9"></a><span id="l18.9"> const Cu = Components.utils;</span>
<a href="#l18.10"></a><span id="l18.10"> </span>
<a href="#l18.11"></a><span id="l18.11"> Cu.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-Cu.import(&quot;resource:///modules/quickSearchManager.js&quot;);</span>
<a href="#l18.13"></a><span id="l18.13"> </span>
<a href="#l18.14"></a><span id="l18.14"> const nsMsgSearchScope = Ci.nsMsgSearchScope;</span>
<a href="#l18.15"></a><span id="l18.15"> const nsIMsgSearchTerm = Ci.nsIMsgSearchTerm;</span>
<a href="#l18.16"></a><span id="l18.16"> const nsIMsgLocalMailFolder = Ci.nsIMsgLocalMailFolder;</span>
<a href="#l18.17"></a><span id="l18.17"> const nsMsgFolderFlags = Ci.nsMsgFolderFlags;</span>
<a href="#l18.18"></a><span id="l18.18"> const nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l18.19"></a><span id="l18.19"> </span>
<a href="#l18.20"></a><span id="l18.20"> const NS_MSG_SEARCH_INTERRUPTED = 0x00550002;</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineat">@@ -131,19 +130,22 @@ SearchSpec.prototype = {</span>
<a href="#l18.22"></a><span id="l18.22"> </span>
<a href="#l18.23"></a><span id="l18.23">       if (this.owner.isSynthetic) {</span>
<a href="#l18.24"></a><span id="l18.24">         this.owner._syntheticView.search(new FilteringSyntheticListener(this));</span>
<a href="#l18.25"></a><span id="l18.25">       }</span>
<a href="#l18.26"></a><span id="l18.26">       else {</span>
<a href="#l18.27"></a><span id="l18.27">         if (!this._sessionListener)</span>
<a href="#l18.28"></a><span id="l18.28">           this._sessionListener = new SearchSpecListener(this);</span>
<a href="#l18.29"></a><span id="l18.29"> </span>
<a href="#l18.30"></a><span id="l18.30" class="difflineminus">-        this.session.registerListener(aDBView);</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+        this.session.registerListener(aDBView,</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+                                      Ci.nsIMsgSearchSession.allNotifications);</span>
<a href="#l18.33"></a><span id="l18.33">         aDBView.searchSession = this._session;</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineminus">-        this._session.registerListener(this._sessionListener);</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+        this._session.registerListener(this._sessionListener,</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+                                       Ci.nsIMsgSearchSession.onNewSearch |</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+                                       Ci.nsIMsgSearchSession.onSearchDone);</span>
<a href="#l18.38"></a><span id="l18.38">         this._listenersRegistered = true;</span>
<a href="#l18.39"></a><span id="l18.39"> </span>
<a href="#l18.40"></a><span id="l18.40">         this.owner.searching = true;</span>
<a href="#l18.41"></a><span id="l18.41">         this.session.search(this.owner.listener.msgWindow);</span>
<a href="#l18.42"></a><span id="l18.42">       }</span>
<a href="#l18.43"></a><span id="l18.43">     }</span>
<a href="#l18.44"></a><span id="l18.44">     // if it's synthetic but we have no search terms, hook the output of the</span>
<a href="#l18.45"></a><span id="l18.45">     //  synthetic view directly up to the search nsIMsgDBView</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineat">@@ -180,17 +182,18 @@ SearchSpec.prototype = {</span>
<a href="#l18.47"></a><span id="l18.47"> </span>
<a href="#l18.48"></a><span id="l18.48">   /**</span>
<a href="#l18.49"></a><span id="l18.49">    * Given a list of terms, mutate them so that they form a single boolean</span>
<a href="#l18.50"></a><span id="l18.50">    *  group.</span>
<a href="#l18.51"></a><span id="l18.51">    *</span>
<a href="#l18.52"></a><span id="l18.52">    * @param aTerms The search terms</span>
<a href="#l18.53"></a><span id="l18.53">    * @param aCloneTerms Do we need to clone the terms?</span>
<a href="#l18.54"></a><span id="l18.54">    */</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineminus">-  _groupifyTerms: function SearchSpec__groupifyTerms(aTerms, aCloneTerms) {</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineplus">+  _flattenGroupifyTerms: function SearchSpec__flattenGroupifyTerms(aTerms,</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineplus">+                                                                   aCloneTerms){</span>
<a href="#l18.58"></a><span id="l18.58">     let iTerm = 0, term;</span>
<a href="#l18.59"></a><span id="l18.59">     let outTerms = aCloneTerms ? [] : aTerms;</span>
<a href="#l18.60"></a><span id="l18.60">     for (term in fixIterator(aTerms, Ci.nsIMsgSearchTerm)) {</span>
<a href="#l18.61"></a><span id="l18.61">       if (aCloneTerms) {</span>
<a href="#l18.62"></a><span id="l18.62">         let cloneTerm = this.session.createTerm();</span>
<a href="#l18.63"></a><span id="l18.63">         cloneTerm.value = term.value;</span>
<a href="#l18.64"></a><span id="l18.64">         cloneTerm.attrib = term.attrib;</span>
<a href="#l18.65"></a><span id="l18.65">         cloneTerm.arbitraryHeader = term.arbitraryHeader;</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineat">@@ -199,36 +202,100 @@ SearchSpec.prototype = {</span>
<a href="#l18.67"></a><span id="l18.67">         cloneTerm.op = term.op;</span>
<a href="#l18.68"></a><span id="l18.68">         cloneTerm.booleanAnd = term.booleanAnd;</span>
<a href="#l18.69"></a><span id="l18.69">         cloneTerm.matchAll = term.matchAll;</span>
<a href="#l18.70"></a><span id="l18.70">         term = cloneTerm;</span>
<a href="#l18.71"></a><span id="l18.71">         outTerms.push(term);</span>
<a href="#l18.72"></a><span id="l18.72">       }</span>
<a href="#l18.73"></a><span id="l18.73">       if (iTerm == 0) {</span>
<a href="#l18.74"></a><span id="l18.74">         term.beginsGrouping = true;</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineplus">+        term.endsGrouping = false;</span>
<a href="#l18.76"></a><span id="l18.76">         term.booleanAnd = true;</span>
<a href="#l18.77"></a><span id="l18.77">       }</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineplus">+      else {</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineplus">+        term.beginsGrouping = false;</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineplus">+        term.endsGrouping = false;</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineplus">+      }</span>
<a href="#l18.82"></a><span id="l18.82">       iTerm++;</span>
<a href="#l18.83"></a><span id="l18.83">     }</span>
<a href="#l18.84"></a><span id="l18.84">     if (term)</span>
<a href="#l18.85"></a><span id="l18.85">       term.endsGrouping = true;</span>
<a href="#l18.86"></a><span id="l18.86"> </span>
<a href="#l18.87"></a><span id="l18.87">     return outTerms;</span>
<a href="#l18.88"></a><span id="l18.88">   },</span>
<a href="#l18.89"></a><span id="l18.89"> </span>
<a href="#l18.90"></a><span id="l18.90">   /**</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineplus">+   * Normalize the provided list of terms so that all of the 'groups' in it are</span>
<a href="#l18.92"></a><span id="l18.92" class="difflineplus">+   *  ANDed together.  If any OR clauses are detected outside of a group, we</span>
<a href="#l18.93"></a><span id="l18.93" class="difflineplus">+   *  defer to |_flattenGroupifyTerms| to force the terms to be bundled up into</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineplus">+   *  a single group, maintaining the booleanAnd state of terms.</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineplus">+   *</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineplus">+   * This particular logic is desired because it allows the quick filter bar to</span>
<a href="#l18.97"></a><span id="l18.97" class="difflineplus">+   *  produce interesting and useful filters.</span>
<a href="#l18.98"></a><span id="l18.98" class="difflineplus">+   *</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineplus">+   * @param aTerms The search terms</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineplus">+   * @param aCloneTerms Do we need to clone the terms?</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineplus">+   */</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineplus">+  _groupifyTerms: function SearchSpec__groupifyTerms(aTerms, aCloneTerms) {</span>
<a href="#l18.103"></a><span id="l18.103" class="difflineplus">+    let term;</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineplus">+    let outTerms = aCloneTerms ? [] : aTerms;</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineplus">+    let inGroup = false;</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineplus">+    for (term in fixIterator(aTerms, Components.interfaces.nsIMsgSearchTerm)) {</span>
<a href="#l18.107"></a><span id="l18.107" class="difflineplus">+      // If we're in a group, all that is forbidden is the creation of new</span>
<a href="#l18.108"></a><span id="l18.108" class="difflineplus">+      // groups.</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineplus">+      if (inGroup) {</span>
<a href="#l18.110"></a><span id="l18.110" class="difflineplus">+        if (term.beginsGrouping) // forbidden!</span>
<a href="#l18.111"></a><span id="l18.111" class="difflineplus">+          return this._flattenGroupifyTerms(aTerms, aCloneTerms);</span>
<a href="#l18.112"></a><span id="l18.112" class="difflineplus">+        else if (term.endsGrouping)</span>
<a href="#l18.113"></a><span id="l18.113" class="difflineplus">+          inGroup = false;</span>
<a href="#l18.114"></a><span id="l18.114" class="difflineplus">+      }</span>
<a href="#l18.115"></a><span id="l18.115" class="difflineplus">+      // If we're not in a group, the boolean must be AND.  It's okay for a group</span>
<a href="#l18.116"></a><span id="l18.116" class="difflineplus">+      // to start.</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineplus">+      else {</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineplus">+        // If it's not an AND then it needs to be in a group and we use the other</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineplus">+        //  function to take care of it.  (This function can't back up...)</span>
<a href="#l18.120"></a><span id="l18.120" class="difflineplus">+        if (!term.booleanAnd)</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineplus">+          return this._flattenGroupifyTerms(aTerms, aCloneTerms);</span>
<a href="#l18.122"></a><span id="l18.122" class="difflineplus">+</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineplus">+        inGroup = term.beginsGrouping;</span>
<a href="#l18.124"></a><span id="l18.124" class="difflineplus">+      }</span>
<a href="#l18.125"></a><span id="l18.125" class="difflineplus">+</span>
<a href="#l18.126"></a><span id="l18.126" class="difflineplus">+      if (aCloneTerms) {</span>
<a href="#l18.127"></a><span id="l18.127" class="difflineplus">+        let cloneTerm = this.session.createTerm();</span>
<a href="#l18.128"></a><span id="l18.128" class="difflineplus">+        cloneTerm.attrib = term.attrib;</span>
<a href="#l18.129"></a><span id="l18.129" class="difflineplus">+        cloneTerm.value = term.value;</span>
<a href="#l18.130"></a><span id="l18.130" class="difflineplus">+        cloneTerm.arbitraryHeader = term.arbitraryHeader;</span>
<a href="#l18.131"></a><span id="l18.131" class="difflineplus">+        cloneTerm.hdrProperty = term.hdrProperty;</span>
<a href="#l18.132"></a><span id="l18.132" class="difflineplus">+        cloneTerm.customId = term.customId;</span>
<a href="#l18.133"></a><span id="l18.133" class="difflineplus">+        cloneTerm.op = term.op;</span>
<a href="#l18.134"></a><span id="l18.134" class="difflineplus">+        cloneTerm.booleanAnd = term.booleanAnd;</span>
<a href="#l18.135"></a><span id="l18.135" class="difflineplus">+        cloneTerm.matchAll = term.matchAll;</span>
<a href="#l18.136"></a><span id="l18.136" class="difflineplus">+        cloneTerm.beginsGrouping = term.beginsGrouping;</span>
<a href="#l18.137"></a><span id="l18.137" class="difflineplus">+        cloneTerm.endsGrouping = term.endsGrouping;</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineplus">+        term = cloneTerm;</span>
<a href="#l18.139"></a><span id="l18.139" class="difflineplus">+        outTerms.push(term);</span>
<a href="#l18.140"></a><span id="l18.140" class="difflineplus">+      }</span>
<a href="#l18.141"></a><span id="l18.141" class="difflineplus">+    }</span>
<a href="#l18.142"></a><span id="l18.142" class="difflineplus">+</span>
<a href="#l18.143"></a><span id="l18.143" class="difflineplus">+    return outTerms;</span>
<a href="#l18.144"></a><span id="l18.144" class="difflineplus">+  },</span>
<a href="#l18.145"></a><span id="l18.145" class="difflineplus">+</span>
<a href="#l18.146"></a><span id="l18.146" class="difflineplus">+  /**</span>
<a href="#l18.147"></a><span id="l18.147">    * Set search terms that are defined by the 'view', which translates to that</span>
<a href="#l18.148"></a><span id="l18.148">    *  weird combo-box that lets you view your unread messages, messages by tag,</span>
<a href="#l18.149"></a><span id="l18.149">    *  messages that aren't deleted, etc.</span>
<a href="#l18.150"></a><span id="l18.150">    *</span>
<a href="#l18.151"></a><span id="l18.151">    * @param aViewTerms The list of terms.  We take ownership and mutate it.</span>
<a href="#l18.152"></a><span id="l18.152">    */</span>
<a href="#l18.153"></a><span id="l18.153">   set viewTerms(aViewTerms) {</span>
<a href="#l18.154"></a><span id="l18.154">     if (aViewTerms)</span>
<a href="#l18.155"></a><span id="l18.155">       this._viewTerms = this._groupifyTerms(aViewTerms);</span>
<a href="#l18.156"></a><span id="l18.156" class="difflineplus">+    // if they are nulling out already null values, do not apply view changes!</span>
<a href="#l18.157"></a><span id="l18.157" class="difflineplus">+    else if (this._viewTerms === null)</span>
<a href="#l18.158"></a><span id="l18.158" class="difflineplus">+      return;</span>
<a href="#l18.159"></a><span id="l18.159">     else</span>
<a href="#l18.160"></a><span id="l18.160">       this._viewTerms = null;</span>
<a href="#l18.161"></a><span id="l18.161">     this.owner._applyViewChanges();</span>
<a href="#l18.162"></a><span id="l18.162">   },</span>
<a href="#l18.163"></a><span id="l18.163">   /**</span>
<a href="#l18.164"></a><span id="l18.164">    * @return the view terms currently in effect.  Do not mutate this.</span>
<a href="#l18.165"></a><span id="l18.165">    */</span>
<a href="#l18.166"></a><span id="l18.166">   get viewTerms() {</span>
<a href="#l18.167"></a><span id="l18.167" class="difflineat">@@ -242,16 +309,19 @@ SearchSpec.prototype = {</span>
<a href="#l18.168"></a><span id="l18.168">    *     do not mutate yours.</span>
<a href="#l18.169"></a><span id="l18.169">    */</span>
<a href="#l18.170"></a><span id="l18.170">   set virtualFolderTerms(aVirtualFolderTerms) {</span>
<a href="#l18.171"></a><span id="l18.171">     if (aVirtualFolderTerms)</span>
<a href="#l18.172"></a><span id="l18.172">       // we need to clone virtual folder terms because they are pulled from a</span>
<a href="#l18.173"></a><span id="l18.173">       //  persistent location rather than created on demand</span>
<a href="#l18.174"></a><span id="l18.174">       this._virtualFolderTerms = this._groupifyTerms(aVirtualFolderTerms,</span>
<a href="#l18.175"></a><span id="l18.175">                                                      true);</span>
<a href="#l18.176"></a><span id="l18.176" class="difflineplus">+    // if they are nulling out already null values, do not apply view changes!</span>
<a href="#l18.177"></a><span id="l18.177" class="difflineplus">+    else if (this._virtualFolderTerms === null)</span>
<a href="#l18.178"></a><span id="l18.178" class="difflineplus">+      return;</span>
<a href="#l18.179"></a><span id="l18.179">     else</span>
<a href="#l18.180"></a><span id="l18.180">       this._virtualFolderTerms = null;</span>
<a href="#l18.181"></a><span id="l18.181">     this.owner._applyViewChanges();</span>
<a href="#l18.182"></a><span id="l18.182">   },</span>
<a href="#l18.183"></a><span id="l18.183">   /**</span>
<a href="#l18.184"></a><span id="l18.184">    * @return the Virtual folder terms currently in effect.  Do not mutate this.</span>
<a href="#l18.185"></a><span id="l18.185">    */</span>
<a href="#l18.186"></a><span id="l18.186">   get virtualFolderTerms() {</span>
<a href="#l18.187"></a><span id="l18.187" class="difflineat">@@ -263,44 +333,30 @@ SearchSpec.prototype = {</span>
<a href="#l18.188"></a><span id="l18.188">    *  augmented with the 'context' search terms potentially provided by</span>
<a href="#l18.189"></a><span id="l18.189">    *  viewTerms and virtualFolderTerms.</span>
<a href="#l18.190"></a><span id="l18.190">    *</span>
<a href="#l18.191"></a><span id="l18.191">    * @param aUserTerms The list of terms.  We take ownership and mutate it.</span>
<a href="#l18.192"></a><span id="l18.192">    */</span>
<a href="#l18.193"></a><span id="l18.193">   set userTerms(aUserTerms) {</span>
<a href="#l18.194"></a><span id="l18.194">     if (aUserTerms)</span>
<a href="#l18.195"></a><span id="l18.195">       this._userTerms = this._groupifyTerms(aUserTerms);</span>
<a href="#l18.196"></a><span id="l18.196" class="difflineplus">+    // if they are nulling out already null values, do not apply view changes!</span>
<a href="#l18.197"></a><span id="l18.197" class="difflineplus">+    else if (this._userTerms === null)</span>
<a href="#l18.198"></a><span id="l18.198" class="difflineplus">+      return;</span>
<a href="#l18.199"></a><span id="l18.199">     else</span>
<a href="#l18.200"></a><span id="l18.200">       this._userTerms = null;</span>
<a href="#l18.201"></a><span id="l18.201">     this.owner._applyViewChanges();</span>
<a href="#l18.202"></a><span id="l18.202">   },</span>
<a href="#l18.203"></a><span id="l18.203">   /**</span>
<a href="#l18.204"></a><span id="l18.204">    * @return the user terms currently in effect as set via the |userTerms|</span>
<a href="#l18.205"></a><span id="l18.205">    *     attribute or via the |quickSearch| method.  Do not mutate this.</span>
<a href="#l18.206"></a><span id="l18.206">    */</span>
<a href="#l18.207"></a><span id="l18.207">   get userTerms() {</span>
<a href="#l18.208"></a><span id="l18.208">     return this._userTerms;</span>
<a href="#l18.209"></a><span id="l18.209">   },</span>
<a href="#l18.210"></a><span id="l18.210" class="difflineminus">-  /**</span>
<a href="#l18.211"></a><span id="l18.211" class="difflineminus">-   * Apply a quick-search for the given search mode using the given search</span>
<a href="#l18.212"></a><span id="l18.212" class="difflineminus">-   *  string.  All of the hard work is done by</span>
<a href="#l18.213"></a><span id="l18.213" class="difflineminus">-   *  QuickSearchManager.createSearchTerms; we mainly just assign the result to</span>
<a href="#l18.214"></a><span id="l18.214" class="difflineminus">-   *  our userTerms property.</span>
<a href="#l18.215"></a><span id="l18.215" class="difflineminus">-   *</span>
<a href="#l18.216"></a><span id="l18.216" class="difflineminus">-   * @param aSearchMode One of the QuickSearchConstants.kQuickSearch* search</span>
<a href="#l18.217"></a><span id="l18.217" class="difflineminus">-   *     mode constants specifying what parts of the message to search on.</span>
<a href="#l18.218"></a><span id="l18.218" class="difflineminus">-   * @param aSearchString The search string, consisting of sub-strings delimited</span>
<a href="#l18.219"></a><span id="l18.219" class="difflineminus">-   *     by '|' to be OR-ed together.  Given the string &quot;foo&quot; we search for</span>
<a href="#l18.220"></a><span id="l18.220" class="difflineminus">-   *     messages containing &quot;foo&quot;.  Given the string &quot;foo|bar&quot;, we search for</span>
<a href="#l18.221"></a><span id="l18.221" class="difflineminus">-   *     messages containing &quot;foo&quot; or &quot;bar&quot;.</span>
<a href="#l18.222"></a><span id="l18.222" class="difflineminus">-   */</span>
<a href="#l18.223"></a><span id="l18.223" class="difflineminus">-  quickSearch: function SearchSpec_quickSearch(aSearchMode, aSearchString) {</span>
<a href="#l18.224"></a><span id="l18.224" class="difflineminus">-    this.userTerms = QuickSearchManager.createSearchTerms(</span>
<a href="#l18.225"></a><span id="l18.225" class="difflineminus">-      this.session, aSearchMode, aSearchString);</span>
<a href="#l18.226"></a><span id="l18.226" class="difflineminus">-  },</span>
<a href="#l18.227"></a><span id="l18.227"> </span>
<a href="#l18.228"></a><span id="l18.228">   clear: function SearchSpec_clear() {</span>
<a href="#l18.229"></a><span id="l18.229">     if (this.hasSearchTerms) {</span>
<a href="#l18.230"></a><span id="l18.230">       this._viewTerms = null;</span>
<a href="#l18.231"></a><span id="l18.231">       this._virtualFolderTerms = null;</span>
<a href="#l18.232"></a><span id="l18.232">       this._userTerms = null;</span>
<a href="#l18.233"></a><span id="l18.233">       this.owner._applyViewChanges();</span>
<a href="#l18.234"></a><span id="l18.234">     }</span>
<a href="#l18.235"></a><span id="l18.235" class="difflineat">@@ -473,75 +529,38 @@ SearchSpec.prototype = {</span>
<a href="#l18.236"></a><span id="l18.236">     for each (let [, folder] in Iterator(this.owner._underlyingFolders)) {</span>
<a href="#l18.237"></a><span id="l18.237">       s += '      ' + folder.prettyName + '\n';</span>
<a href="#l18.238"></a><span id="l18.238">     }</span>
<a href="#l18.239"></a><span id="l18.239">     return s;</span>
<a href="#l18.240"></a><span id="l18.240">   },</span>
<a href="#l18.241"></a><span id="l18.241"> };</span>
<a href="#l18.242"></a><span id="l18.242"> </span>
<a href="#l18.243"></a><span id="l18.243"> /**</span>
<a href="#l18.244"></a><span id="l18.244" class="difflineminus">- * An nsIMsgSearchNotify listener for searches, primarily to keep the UI</span>
<a href="#l18.245"></a><span id="l18.245" class="difflineminus">- *  up-to-date.  The db view itself always gets added as a listener and does</span>
<a href="#l18.246"></a><span id="l18.246" class="difflineminus">- *  the heavy lifting.</span>
<a href="#l18.247"></a><span id="l18.247" class="difflineminus">- *</span>
<a href="#l18.248"></a><span id="l18.248" class="difflineminus">- * The one notable thing we do is help single-folder virtual folders out by</span>
<a href="#l18.249"></a><span id="l18.249" class="difflineminus">- *  tracking and updating their total and unread message counts.  Our logic</span>
<a href="#l18.250"></a><span id="l18.250" class="difflineminus">- *  is simple and is not clever enough to deal with the user reading messages</span>
<a href="#l18.251"></a><span id="l18.251" class="difflineminus">- *  as they are displayed.  However, this is not a major issue for single-folder</span>
<a href="#l18.252"></a><span id="l18.252" class="difflineminus">- *  searches because they should complete very quickly.  (Note: I am documenting</span>
<a href="#l18.253"></a><span id="l18.253" class="difflineminus">- *  reality here, not implementing and rationalizing.)</span>
<a href="#l18.254"></a><span id="l18.254" class="difflineplus">+ * A simple nsIMsgSearchNotify listener that only listens for search start/stop</span>
<a href="#l18.255"></a><span id="l18.255" class="difflineplus">+ *  so that it can tell the DBViewWrapper when the search has completed.</span>
<a href="#l18.256"></a><span id="l18.256">  */</span>
<a href="#l18.257"></a><span id="l18.257"> function SearchSpecListener(aSearchSpec) {</span>
<a href="#l18.258"></a><span id="l18.258">   this.searchSpec = aSearchSpec;</span>
<a href="#l18.259"></a><span id="l18.259"> }</span>
<a href="#l18.260"></a><span id="l18.260"> SearchSpecListener.prototype = {</span>
<a href="#l18.261"></a><span id="l18.261">   onNewSearch: function SearchSpecListener_onNewSearch() {</span>
<a href="#l18.262"></a><span id="l18.262">     // searching should already be true by the time this happens.  if it's not,</span>
<a href="#l18.263"></a><span id="l18.263">     //  it means some code is poking at the search session.  bad!</span>
<a href="#l18.264"></a><span id="l18.264">     if (!this.searchSpec.owner.searching) {</span>
<a href="#l18.265"></a><span id="l18.265" class="difflineminus">-      dump(&quot;Search originated from unknown initiator! Confusion!\n&quot;);</span>
<a href="#l18.266"></a><span id="l18.266" class="difflineplus">+      Cu.reportErrror(&quot;Search originated from unknown initiator! Confusion!&quot;);</span>
<a href="#l18.267"></a><span id="l18.267">       this.searchSpec.owner.searching = true;</span>
<a href="#l18.268"></a><span id="l18.268">     }</span>
<a href="#l18.269"></a><span id="l18.269" class="difflineminus">-</span>
<a href="#l18.270"></a><span id="l18.270" class="difflineminus">-    // we track total/unread messages to help out single-folder virtual folders</span>
<a href="#l18.271"></a><span id="l18.271" class="difflineminus">-    this.totalMessages = 0;</span>
<a href="#l18.272"></a><span id="l18.272" class="difflineminus">-    this.unreadMessages = 0;</span>
<a href="#l18.273"></a><span id="l18.273">   },</span>
<a href="#l18.274"></a><span id="l18.274"> </span>
<a href="#l18.275"></a><span id="l18.275">   onSearchHit: function SearchSpecListener_onSearchHit(aMsgHdr, aFolder) {</span>
<a href="#l18.276"></a><span id="l18.276" class="difflineminus">-    this.totalMessages++;</span>
<a href="#l18.277"></a><span id="l18.277" class="difflineminus">-    if (!aMsgHdr.isRead)</span>
<a href="#l18.278"></a><span id="l18.278" class="difflineminus">-      this.unreadMessages++;</span>
<a href="#l18.279"></a><span id="l18.279" class="difflineplus">+    // this method is never invoked!</span>
<a href="#l18.280"></a><span id="l18.280">   },</span>
<a href="#l18.281"></a><span id="l18.281"> </span>
<a href="#l18.282"></a><span id="l18.282">   onSearchDone: function SearchSpecListener_onSearchDone(aStatus) {</span>
<a href="#l18.283"></a><span id="l18.283" class="difflineminus">-    let viewWrapper = this.searchSpec.owner;</span>
<a href="#l18.284"></a><span id="l18.284" class="difflineminus">-    let folder = viewWrapper.displayedFolder;</span>
<a href="#l18.285"></a><span id="l18.285" class="difflineminus">-</span>
<a href="#l18.286"></a><span id="l18.286" class="difflineminus">-    // Save message counts if it's a virtual folder and there are no additional</span>
<a href="#l18.287"></a><span id="l18.287" class="difflineminus">-    //  constraints contaminating the virtual folder results.</span>
<a href="#l18.288"></a><span id="l18.288" class="difflineminus">-    // The old code did this every time, for both cross-folder (multi-folder)</span>
<a href="#l18.289"></a><span id="l18.289" class="difflineminus">-    //  virtual folders and single-folder backed virtual folders.  However,</span>
<a href="#l18.290"></a><span id="l18.290" class="difflineminus">-    //  nsMsgXFVirtualFolderDBView already does this (and does a better job of</span>
<a href="#l18.291"></a><span id="l18.291" class="difflineminus">-    //  it), so we only do this for single virtual folders.</span>
<a href="#l18.292"></a><span id="l18.292" class="difflineminus">-    if (viewWrapper.isVirtual &amp;&amp; viewWrapper.isSingleFolder) {</span>
<a href="#l18.293"></a><span id="l18.293" class="difflineminus">-      let msgDatabase = folder.msgDatabase;</span>
<a href="#l18.294"></a><span id="l18.294" class="difflineminus">-      if (msgDatabase) {</span>
<a href="#l18.295"></a><span id="l18.295" class="difflineminus">-        let dbFolderInfo = msgDatabase.dBFolderInfo;</span>
<a href="#l18.296"></a><span id="l18.296" class="difflineminus">-        dbFolderInfo.numUnreadMessages = this.unreadMessages;</span>
<a href="#l18.297"></a><span id="l18.297" class="difflineminus">-        dbFolderInfo.numMessages = this.totalMessages;</span>
<a href="#l18.298"></a><span id="l18.298" class="difflineminus">-        // passing true compels it to use the new message counts we just set.</span>
<a href="#l18.299"></a><span id="l18.299" class="difflineminus">-        // this call also flushes to the folder cache.</span>
<a href="#l18.300"></a><span id="l18.300" class="difflineminus">-        folder.updateSummaryTotals(true);</span>
<a href="#l18.301"></a><span id="l18.301" class="difflineminus">-        const MSG_DB_LARGE_COMMIT = 1;</span>
<a href="#l18.302"></a><span id="l18.302" class="difflineminus">-        msgDatabase.Commit(MSG_DB_LARGE_COMMIT);</span>
<a href="#l18.303"></a><span id="l18.303" class="difflineminus">-      }</span>
<a href="#l18.304"></a><span id="l18.304" class="difflineminus">-    }</span>
<a href="#l18.305"></a><span id="l18.305" class="difflineminus">-</span>
<a href="#l18.306"></a><span id="l18.306" class="difflineminus">-    viewWrapper.searching = false;</span>
<a href="#l18.307"></a><span id="l18.307" class="difflineplus">+    this.searchSpec.owner.searching = false;</span>
<a href="#l18.308"></a><span id="l18.308">   },</span>
<a href="#l18.309"></a><span id="l18.309"> };</span>
<a href="#l18.310"></a><span id="l18.310"> </span>
<a href="#l18.311"></a><span id="l18.311"> /**</span>
<a href="#l18.312"></a><span id="l18.312">  * Pretend to implement the nsIMsgSearchNotify interface, checking all matches</span>
<a href="#l18.313"></a><span id="l18.313">  *  we are given against the search session on the search spec.  If they pass,</span>
<a href="#l18.314"></a><span id="l18.314">  *  relay them to the underlying db view, otherwise quietly eat them.</span>
<a href="#l18.315"></a><span id="l18.315">  * This is what allows us to use mail-views and quick searches against</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mail/base/test/unit/resources/viewWrapperTestUtils.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mail/base/test/unit/resources/viewWrapperTestUtils.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -32,17 +32,16 @@</span>
<a href="#l19.4"></a><span id="l19.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l19.5"></a><span id="l19.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l19.6"></a><span id="l19.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l19.7"></a><span id="l19.7">  *</span>
<a href="#l19.8"></a><span id="l19.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l19.9"></a><span id="l19.9"> </span>
<a href="#l19.10"></a><span id="l19.10"> Components.utils.import(&quot;resource:///modules/dbViewWrapper.js&quot;);</span>
<a href="#l19.11"></a><span id="l19.11"> Components.utils.import(&quot;resource:///modules/mailViewManager.js&quot;);</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-Components.utils.import(&quot;resource:///modules/quickSearchManager.js&quot;);</span>
<a href="#l19.13"></a><span id="l19.13"> Components.utils.import(&quot;resource:///modules/virtualFolderWrapper.js&quot;);</span>
<a href="#l19.14"></a><span id="l19.14"> </span>
<a href="#l19.15"></a><span id="l19.15"> /**</span>
<a href="#l19.16"></a><span id="l19.16">  * Do initialization for xpcshell-tests; not used by</span>
<a href="#l19.17"></a><span id="l19.17">  *  test-folder-display-helpers.js, our friendly mozmill test helper.</span>
<a href="#l19.18"></a><span id="l19.18">  */</span>
<a href="#l19.19"></a><span id="l19.19"> function initViewWrapperTestUtils(aInjectionConfig) {</span>
<a href="#l19.20"></a><span id="l19.20">   gMessageGenerator = new MessageGenerator();</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineat">@@ -238,22 +237,16 @@ function async_view_open(aViewWrapper, a</span>
<a href="#l19.22"></a><span id="l19.22"> }</span>
<a href="#l19.23"></a><span id="l19.23"> </span>
<a href="#l19.24"></a><span id="l19.24"> function async_view_set_mail_view(aViewWrapper, aMailViewIndex, aData) {</span>
<a href="#l19.25"></a><span id="l19.25">   aViewWrapper.listener.pendingLoad = true;</span>
<a href="#l19.26"></a><span id="l19.26">   aViewWrapper.setMailView(aMailViewIndex, aData);</span>
<a href="#l19.27"></a><span id="l19.27">   return false;</span>
<a href="#l19.28"></a><span id="l19.28"> }</span>
<a href="#l19.29"></a><span id="l19.29"> </span>
<a href="#l19.30"></a><span id="l19.30" class="difflineminus">-function async_view_quick_search(aViewWrapper, aSearchMode, aSearchString) {</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-  aViewWrapper.listener.pendingLoad = true;</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-  aViewWrapper.search.quickSearch(aSearchMode, aSearchString);</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineminus">-  return false;</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineminus">-}</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineminus">-</span>
<a href="#l19.36"></a><span id="l19.36"> function async_view_refresh(aViewWrapper) {</span>
<a href="#l19.37"></a><span id="l19.37">   aViewWrapper.listener.pendingLoad = true;</span>
<a href="#l19.38"></a><span id="l19.38">   aViewWrapper.refresh();</span>
<a href="#l19.39"></a><span id="l19.39">   return false;</span>
<a href="#l19.40"></a><span id="l19.40"> }</span>
<a href="#l19.41"></a><span id="l19.41"> </span>
<a href="#l19.42"></a><span id="l19.42"> function async_view_group_by_sort(aViewWrapper, aGroupBySort) {</span>
<a href="#l19.43"></a><span id="l19.43">   aViewWrapper.listener.pendingLoad = true;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mail/base/test/unit/test_viewWrapper_realFolder.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mail/base/test/unit/test_viewWrapper_realFolder.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -470,179 +470,16 @@ function test_real_folder_mail_views_cus</span>
<a href="#l20.4"></a><span id="l20.4">   yield async_view_set_mail_view(viewWrapper, &quot;Has Attachments&quot;);</span>
<a href="#l20.5"></a><span id="l20.5">   verify_messages_in_view(setAttach, viewWrapper);</span>
<a href="#l20.6"></a><span id="l20.6"> </span>
<a href="#l20.7"></a><span id="l20.7">   let [setMoreAttach, setMoreNoAttach] =</span>
<a href="#l20.8"></a><span id="l20.8">     make_new_sets_in_folder(folder, [attachSetDef, noAttachSetDef]);</span>
<a href="#l20.9"></a><span id="l20.9">   verify_messages_in_view([setAttach, setMoreAttach], viewWrapper);</span>
<a href="#l20.10"></a><span id="l20.10"> }</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-/* ===== Real Folder, Quick Search ===== */</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-/*</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">- * Quick-search testing is aligned according to the UI exposure, even though</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineminus">- *  this is arguably some redundancy from a coverage perspective.</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">- *</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">- * The message generator does not generate strings containing &quot;foo&quot;, &quot;bar&quot;, or</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">- *  &quot;baz&quot; on its own, so it is okay to use these as test things ourselves.</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineminus">- */</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineminus">-</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineminus">-function test_real_folder_quick_search_subject () {</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineminus">-  let viewWrapper = make_view_wrapper();</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineminus">-</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineminus">-  // add a &quot;foo&quot; set and a &quot;bar&quot; set</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineminus">-  let [folder, setFoo, setBar] = make_folder_with_sets([</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineminus">-    {subject: &quot;foo is a word&quot;}, {subject: &quot;bar is also a word&quot;}]);</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineminus">-  yield async_view_open(viewWrapper, folder);</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineminus">-</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-  // quick-search on 'foo'</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-  yield async_view_quick_search(viewWrapper, QuickSearchConstants.kQuickSearchSubject,</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineminus">-                                 &quot;foo&quot;);</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-  verify_messages_in_view(setFoo, viewWrapper);</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineminus">-</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineminus">-  // quick-search on 'foo' or 'bar'</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-  yield async_view_quick_search(viewWrapper, QuickSearchConstants.kQuickSearchSubject,</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineminus">-                                 &quot;foo|bar&quot;);</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineminus">-  verify_messages_in_view([setFoo, setBar], viewWrapper);</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineminus">-</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineminus">-  // add a &quot;bar foo&quot; set (matches) and a &quot;nopers&quot; set (should not match)</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineminus">-  let [setFooBar, setNopers] = make_new_sets_in_folder(folder, [</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineminus">-    {subject: &quot;bar foo&quot;}, {subject: &quot;nopers&quot;}]);</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineminus">-  verify_messages_in_view([setFoo, setBar, setFooBar], viewWrapper);</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineminus">-}</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineminus">-</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineminus">-function test_real_folder_quick_search_subject_or_from () {</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineminus">-  let viewWrapper = make_view_wrapper();</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineminus">-</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineminus">-  let whoFoo = make_person_with_word_in_name(&quot;foo&quot;);</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineminus">-  let whoBar = make_person_with_word_in_address(&quot;bar&quot;);</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineminus">-  let [folder, subjFoo, fromFoo, subjBar, fromBar, setNopers] =</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineminus">-    make_folder_with_sets([{subject: &quot;foo&quot;}, {from: whoFoo},</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineminus">-                           {subject: &quot;bar&quot;}, {from: whoBar},</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineminus">-                           {}]);</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineminus">-  yield async_view_open(viewWrapper, folder);</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineminus">-</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineminus">-  // search on &quot;foo&quot;</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineminus">-  yield async_view_quick_search(viewWrapper, QuickSearchConstants.kQuickSearchFromOrSubject,</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineminus">-                                 &quot;foo&quot;);</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineminus">-  verify_messages_in_view([subjFoo, fromFoo], viewWrapper);</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineminus">-</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineminus">-  // search on &quot;foo&quot; or &quot;bar&quot;</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineminus">-  yield async_view_quick_search(viewWrapper, QuickSearchConstants.kQuickSearchFromOrSubject,</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineminus">-                                 &quot;foo|bar&quot;);</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineminus">-  verify_messages_in_view([subjFoo, fromFoo, subjBar, fromBar], viewWrapper);</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineminus">-}</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineminus">-</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineminus">-function test_real_folder_quick_search_to_or_cc () {</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineminus">-  let viewWrapper = make_view_wrapper();</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineminus">-</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineminus">-  let whoFoo = make_person_with_word_in_name(&quot;foo&quot;);</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineminus">-  let whoBar = make_person_with_word_in_address(&quot;bar&quot;);</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineminus">-  let [folder, toFoo, ccFoo, toBar, ccBar, setNopers] =</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineminus">-    make_folder_with_sets([{to: [whoFoo]}, {cc: [whoFoo]},</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineminus">-                           {to: [whoBar]}, {cc: [whoBar]},</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineminus">-                           {}]);</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineminus">-  yield async_view_open(viewWrapper, folder);</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineminus">-</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineminus">-  // search on &quot;foo&quot;</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineminus">-  yield async_view_quick_search(viewWrapper, QuickSearchConstants.kQuickSearchRecipient,</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineminus">-                                 &quot;foo&quot;);</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineminus">-  verify_messages_in_view([toFoo, ccFoo], viewWrapper);</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineminus">-</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineminus">-  // search on &quot;foo&quot; or &quot;bar&quot;</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineminus">-  yield async_view_quick_search(viewWrapper, QuickSearchConstants.kQuickSearchRecipient,</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineminus">-                                 &quot;foo|bar&quot;);</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineminus">-  verify_messages_in_view([toFoo, ccFoo, toBar, ccBar], viewWrapper);</span>
<a href="#l20.88"></a><span id="l20.88" class="difflineminus">-}</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineminus">-</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineminus">-function test_real_folder_quick_search_subject_to_or_cc () {</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineminus">-  let viewWrapper = make_view_wrapper();</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineminus">-</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineminus">-  let whoFoo = make_person_with_word_in_name(&quot;foo&quot;);</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineminus">-  let whoBar = make_person_with_word_in_address(&quot;bar&quot;);</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineminus">-  let [folder, subjFoo, toFoo, ccFoo, subjBar, toBar, ccBar, setNopers] =</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineminus">-    make_folder_with_sets([{subject: &quot;foo&quot;}, {to: [whoFoo]}, {cc: [whoFoo]},</span>
<a href="#l20.97"></a><span id="l20.97" class="difflineminus">-                           {subject: &quot;bar&quot;}, {to: [whoBar]}, {cc: [whoBar]},</span>
<a href="#l20.98"></a><span id="l20.98" class="difflineminus">-                           {}]);</span>
<a href="#l20.99"></a><span id="l20.99" class="difflineminus">-  yield async_view_open(viewWrapper, folder);</span>
<a href="#l20.100"></a><span id="l20.100" class="difflineminus">-</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineminus">-  // search on &quot;foo&quot;</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineminus">-  yield async_view_quick_search(viewWrapper,</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineminus">-    QuickSearchConstants.kQuickSearchRecipientOrSubject, &quot;foo&quot;);</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineminus">-  verify_messages_in_view([subjFoo, toFoo, ccFoo], viewWrapper);</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineminus">-</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineminus">-  // search on &quot;foo&quot; or &quot;bar&quot;</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineminus">-  yield async_view_quick_search(viewWrapper,</span>
<a href="#l20.108"></a><span id="l20.108" class="difflineminus">-    QuickSearchConstants.kQuickSearchRecipientOrSubject, &quot;foo|bar&quot;);</span>
<a href="#l20.109"></a><span id="l20.109" class="difflineminus">-  verify_messages_in_view([subjFoo, toFoo, ccFoo, subjBar, toBar, ccBar],</span>
<a href="#l20.110"></a><span id="l20.110" class="difflineminus">-                          viewWrapper);</span>
<a href="#l20.111"></a><span id="l20.111" class="difflineminus">-}</span>
<a href="#l20.112"></a><span id="l20.112" class="difflineminus">-</span>
<a href="#l20.113"></a><span id="l20.113" class="difflineminus">-/**</span>
<a href="#l20.114"></a><span id="l20.114" class="difflineminus">- * The UI says &quot;entire message&quot;, but we search the body.</span>
<a href="#l20.115"></a><span id="l20.115" class="difflineminus">- */</span>
<a href="#l20.116"></a><span id="l20.116" class="difflineminus">-function test_real_folder_quick_search_body () {</span>
<a href="#l20.117"></a><span id="l20.117" class="difflineminus">-  let viewWrapper = make_view_wrapper();</span>
<a href="#l20.118"></a><span id="l20.118" class="difflineminus">-</span>
<a href="#l20.119"></a><span id="l20.119" class="difflineminus">-  let [folder, bodyFoo, bodyBar] =</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineminus">-    make_folder_with_sets([{body: {body: &quot;foo&quot;}},</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineminus">-                           {body: {body: &quot;bar&quot;}},</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineminus">-                           {}]);</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineminus">-  yield async_view_open(viewWrapper, folder);</span>
<a href="#l20.124"></a><span id="l20.124" class="difflineminus">-</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineminus">-  // search on &quot;foo&quot;</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineminus">-  yield async_view_quick_search(viewWrapper, QuickSearchConstants.kQuickSearchBody,</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineminus">-                                 &quot;foo&quot;);</span>
<a href="#l20.128"></a><span id="l20.128" class="difflineminus">-  verify_messages_in_view(bodyFoo, viewWrapper);</span>
<a href="#l20.129"></a><span id="l20.129" class="difflineminus">-</span>
<a href="#l20.130"></a><span id="l20.130" class="difflineminus">-  // search on &quot;bar&quot;</span>
<a href="#l20.131"></a><span id="l20.131" class="difflineminus">-  yield async_view_quick_search(viewWrapper, QuickSearchConstants.kQuickSearchBody,</span>
<a href="#l20.132"></a><span id="l20.132" class="difflineminus">-                                 &quot;foo|bar&quot;);</span>
<a href="#l20.133"></a><span id="l20.133" class="difflineminus">-  verify_messages_in_view([bodyFoo, bodyBar], viewWrapper);</span>
<a href="#l20.134"></a><span id="l20.134" class="difflineminus">-}</span>
<a href="#l20.135"></a><span id="l20.135" class="difflineminus">-</span>
<a href="#l20.136"></a><span id="l20.136" class="difflineminus">-/* ===== Real Folder, Mail View and Quick Search Together */</span>
<a href="#l20.137"></a><span id="l20.137" class="difflineminus">-</span>
<a href="#l20.138"></a><span id="l20.138" class="difflineminus">-/*</span>
<a href="#l20.139"></a><span id="l20.139" class="difflineminus">- * No need to be exhaustive here, just prove the machinery works with a mail</span>
<a href="#l20.140"></a><span id="l20.140" class="difflineminus">- *  view and a quick search at the same time.</span>
<a href="#l20.141"></a><span id="l20.141" class="difflineminus">- */</span>
<a href="#l20.142"></a><span id="l20.142" class="difflineminus">-</span>
<a href="#l20.143"></a><span id="l20.143" class="difflineminus">-/**</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineminus">- * We'll use the unread mail view with a subject quick search.</span>
<a href="#l20.145"></a><span id="l20.145" class="difflineminus">- */</span>
<a href="#l20.146"></a><span id="l20.146" class="difflineminus">-function test_real_folder_mail_view_and_quick_search() {</span>
<a href="#l20.147"></a><span id="l20.147" class="difflineminus">-  let viewWrapper = make_view_wrapper();</span>
<a href="#l20.148"></a><span id="l20.148" class="difflineminus">-</span>
<a href="#l20.149"></a><span id="l20.149" class="difflineminus">-  let [folder, fooOne, fooTwo, noneOne] = make_folder_with_sets([</span>
<a href="#l20.150"></a><span id="l20.150" class="difflineminus">-    {subject: &quot;foo 1&quot;}, {subject: &quot;foo 2&quot;}, {}]);</span>
<a href="#l20.151"></a><span id="l20.151" class="difflineminus">-</span>
<a href="#l20.152"></a><span id="l20.152" class="difflineminus">-  // everything is unread to start with</span>
<a href="#l20.153"></a><span id="l20.153" class="difflineminus">-  yield async_view_open(viewWrapper, folder);</span>
<a href="#l20.154"></a><span id="l20.154" class="difflineminus">-  yield async_view_set_mail_view(viewWrapper, MailViewConstants.kViewItemUnread);</span>
<a href="#l20.155"></a><span id="l20.155" class="difflineminus">-  yield async_view_quick_search(viewWrapper, QuickSearchConstants.kQuickSearchSubject,</span>
<a href="#l20.156"></a><span id="l20.156" class="difflineminus">-                          &quot;foo&quot;);</span>
<a href="#l20.157"></a><span id="l20.157" class="difflineminus">-  verify_messages_in_view([fooOne, fooTwo], viewWrapper);</span>
<a href="#l20.158"></a><span id="l20.158" class="difflineminus">-</span>
<a href="#l20.159"></a><span id="l20.159" class="difflineminus">-  // add some more things (unread!), make sure they appear. #2</span>
<a href="#l20.160"></a><span id="l20.160" class="difflineminus">-  let [fooThree, noneTwo] = make_new_sets_in_folder(folder, [</span>
<a href="#l20.161"></a><span id="l20.161" class="difflineminus">-    {subject: &quot;foo 3&quot;}, {}]);</span>
<a href="#l20.162"></a><span id="l20.162" class="difflineminus">-  verify_messages_in_view([fooOne, fooTwo, fooThree], viewWrapper);</span>
<a href="#l20.163"></a><span id="l20.163" class="difflineminus">-</span>
<a href="#l20.164"></a><span id="l20.164" class="difflineminus">-  // make some things read, make sure they disappear. #3 (after refresh)</span>
<a href="#l20.165"></a><span id="l20.165" class="difflineminus">-  fooTwo.setRead(true);</span>
<a href="#l20.166"></a><span id="l20.166" class="difflineminus">-  yield async_view_refresh(viewWrapper); // refresh to get the messages to disappear</span>
<a href="#l20.167"></a><span id="l20.167" class="difflineminus">-  verify_messages_in_view([fooOne, fooThree], viewWrapper);</span>
<a href="#l20.168"></a><span id="l20.168" class="difflineminus">-</span>
<a href="#l20.169"></a><span id="l20.169" class="difflineminus">-  // make those things un-read again. #2</span>
<a href="#l20.170"></a><span id="l20.170" class="difflineminus">-  fooTwo.setRead(false);</span>
<a href="#l20.171"></a><span id="l20.171" class="difflineminus">-  yield async_view_refresh(viewWrapper); // QUICKSEARCH-VIEW-LIMITATION-REMOVE</span>
<a href="#l20.172"></a><span id="l20.172" class="difflineminus">-  verify_messages_in_view([fooOne, fooTwo, fooThree], viewWrapper);</span>
<a href="#l20.173"></a><span id="l20.173" class="difflineminus">-}</span>
<a href="#l20.174"></a><span id="l20.174" class="difflineminus">-</span>
<a href="#l20.175"></a><span id="l20.175"> /* ===== Real Folder, Special Views ===== */</span>
<a href="#l20.176"></a><span id="l20.176"> </span>
<a href="#l20.177"></a><span id="l20.177"> function test_real_folder_special_views_threads_with_unread() {</span>
<a href="#l20.178"></a><span id="l20.178">   let viewWrapper = make_view_wrapper();</span>
<a href="#l20.179"></a><span id="l20.179">   let folder = make_empty_folder();</span>
<a href="#l20.180"></a><span id="l20.180"> </span>
<a href="#l20.181"></a><span id="l20.181">   // create two maximally nested threads and add them to the folder.</span>
<a href="#l20.182"></a><span id="l20.182">   const count = 10;</span>
<a href="#l20.183"></a><span id="l20.183" class="difflineat">@@ -743,24 +580,16 @@ var tests = [</span>
<a href="#l20.184"></a><span id="l20.184">   test_real_folder_mail_views_tags,</span>
<a href="#l20.185"></a><span id="l20.185">   test_real_folder_mail_views_not_deleted,</span>
<a href="#l20.186"></a><span id="l20.186">   // - mail views: test the custom views</span>
<a href="#l20.187"></a><span id="l20.187">   test_real_folder_mail_views_custom_people_i_know,</span>
<a href="#l20.188"></a><span id="l20.188">   test_real_folder_mail_views_custom_recent_mail,</span>
<a href="#l20.189"></a><span id="l20.189">   test_real_folder_mail_views_custom_last_5_days,</span>
<a href="#l20.190"></a><span id="l20.190">   test_real_folder_mail_views_custom_not_junk,</span>
<a href="#l20.191"></a><span id="l20.191">   test_real_folder_mail_views_custom_has_attachments,</span>
<a href="#l20.192"></a><span id="l20.192" class="difflineminus">-  // - quick search</span>
<a href="#l20.193"></a><span id="l20.193" class="difflineminus">-  test_real_folder_quick_search_subject,</span>
<a href="#l20.194"></a><span id="l20.194" class="difflineminus">-  test_real_folder_quick_search_subject_or_from,</span>
<a href="#l20.195"></a><span id="l20.195" class="difflineminus">-  test_real_folder_quick_search_to_or_cc,</span>
<a href="#l20.196"></a><span id="l20.196" class="difflineminus">-  test_real_folder_quick_search_subject_to_or_cc,</span>
<a href="#l20.197"></a><span id="l20.197" class="difflineminus">-  test_real_folder_quick_search_body,</span>
<a href="#l20.198"></a><span id="l20.198" class="difflineminus">-  // - mail views with quick search</span>
<a href="#l20.199"></a><span id="l20.199" class="difflineminus">-  test_real_folder_mail_view_and_quick_search,</span>
<a href="#l20.200"></a><span id="l20.200">   // - special views</span>
<a href="#l20.201"></a><span id="l20.201">   test_real_folder_special_views_threads_with_unread,</span>
<a href="#l20.202"></a><span id="l20.202">   test_real_folder_special_views_persist,</span>
<a href="#l20.203"></a><span id="l20.203">   // (we cannot test the watched threads with unread case in local folders)</span>
<a href="#l20.204"></a><span id="l20.204">   test_real_folder_mark_read_on_exit,</span>
<a href="#l20.205"></a><span id="l20.205"> ];</span>
<a href="#l20.206"></a><span id="l20.206"> </span>
<a href="#l20.207"></a><span id="l20.207"> function run_test() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mail/base/test/unit/test_viewWrapper_virtualFolder.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mail/base/test/unit/test_viewWrapper_virtualFolder.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -352,127 +352,16 @@ function test_virtual_folder_mail_views_</span>
<a href="#l21.4"></a><span id="l21.4">   // make those things un-read again.</span>
<a href="#l21.5"></a><span id="l21.5">   fooTwo.setRead(false);</span>
<a href="#l21.6"></a><span id="l21.6">   // I thought this was a quick search limitation, but XFVF needs it to, at</span>
<a href="#l21.7"></a><span id="l21.7">   //  least for the unread case.</span>
<a href="#l21.8"></a><span id="l21.8">   yield async_view_refresh(viewWrapper);</span>
<a href="#l21.9"></a><span id="l21.9">   verify_messages_in_view([fooOne, fooTwo, fooThree], viewWrapper);</span>
<a href="#l21.10"></a><span id="l21.10"> }</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-/* ===== Virtual Folder, Quick Search  ===== */</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-/*</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">- * We do not need to test all of the quick search permutations, realFolder</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineminus">- *  already did that.  We just need to make sure that quick search works</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineminus">- *  with single-folder and multi-folder virtual folders.  Additionally, we</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineminus">- *  need to make sure that it works for simple and complex virtual folders.</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineminus">- * We handle the single and multi folder cases with the same test code, just</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineminus">- *  parameterized over the number of folders.  We use 4 folders for the multi</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineminus">- *  folder case to encourage the time slicing logic to split itself up.</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineminus">- */</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineminus">-</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineminus">-function test_virtual_folder_param_quick_search_simple(aNumFolders) {</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineminus">-  let viewWrapper = make_view_wrapper();</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineminus">-</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineminus">-  // venn it up.  virtual folder search on &quot;foo&quot;, actual search will be on &quot;bar&quot;</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineminus">-  let [folders, subjFooBar, subjFoo, subjBar, nopers] =</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineminus">-    make_folders_with_sets(aNumFolders,</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-      [{subject: &quot;foo bar&quot;}, {subject: &quot;foo&quot;}, {subject: &quot;bar&quot;}, {}]);</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-  let virt = make_virtual_folder(folders, {subject: &quot;foo&quot;});</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineminus">-  yield async_view_open(viewWrapper, virt);</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineminus">-  verify_messages_in_view([subjFooBar, subjFoo], viewWrapper);</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineminus">-</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineminus">-  yield async_view_quick_search(viewWrapper,</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineminus">-                                QuickSearchConstants.kQuickSearchSubject,</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineminus">-                                &quot;bar&quot;);</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineminus">-  verify_messages_in_view([subjFooBar], viewWrapper);</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineminus">-}</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineminus">-</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineminus">-function test_virtual_folder_param_quick_search_complex(aNumFolders) {</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineminus">-  let viewWrapper = make_view_wrapper();</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineminus">-</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineminus">-  let whoBaz = make_person_with_word_in_address(&quot;baz&quot;);</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineminus">-</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineminus">-  // virtual folder is on &quot;foo&quot; and &quot;baz&quot;</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineminus">-  // quick search is on &quot;bar&quot;</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineminus">-  let [folders, fooBarBaz, fooBar, fooBaz, foo, barBaz, bar, baz, nopers] =</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineminus">-    make_folders_with_sets(aNumFolders,</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineminus">-      [{subject: &quot;foo bar&quot;, from: whoBaz}, {subject: &quot;foo bar&quot;},</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineminus">-       {subject: &quot;foo&quot;, from: whoBaz}, {subject: &quot;foo&quot;},</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineminus">-       {subject: &quot;bar&quot;, from: whoBaz}, {subject: &quot;bar&quot;},</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineminus">-       {from: whoBaz}, {}]);</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineminus">-  let virt = make_virtual_folder(folders, {subject: &quot;foo&quot;, from: &quot;baz&quot;}, true);</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineminus">-  yield async_view_open(viewWrapper, virt);</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineminus">-  verify_messages_in_view([fooBarBaz, fooBaz], viewWrapper);</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineminus">-</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineminus">-  yield async_view_quick_search(viewWrapper,</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineminus">-                                QuickSearchConstants.kQuickSearchSubject,</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineminus">-                                &quot;bar&quot;);</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineminus">-  verify_messages_in_view([fooBarBaz], viewWrapper);</span>
<a href="#l21.63"></a><span id="l21.63" class="difflineminus">-}</span>
<a href="#l21.64"></a><span id="l21.64" class="difflineminus">-</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineminus">-/* ===== Virtual Folder, Mail View and Quick Search ===== */</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineminus">-</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineminus">-/**</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineminus">- * Test the complex intersection of all three search clauses for result</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineminus">- *  retrieval and that deletion correctly removes rows.  Check that clones</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineminus">- *  end up operating the same too.</span>
<a href="#l21.71"></a><span id="l21.71" class="difflineminus">- */</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineminus">-function test_virtual_folder_param_mail_view_and_quick_search(aNumFolders) {</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineminus">-  let viewWrapper = make_view_wrapper();</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineminus">-</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineminus">-  // virtual folder search on &quot;foo&quot;</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineminus">-  // quick search on &quot;bar&quot;</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineminus">-  let [folders, fooBarOne, fooBarTwo, foo, bar, nopers] =</span>
<a href="#l21.78"></a><span id="l21.78" class="difflineminus">-    make_folders_with_sets(aNumFolders,</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineminus">-      [{subject: &quot;foo bar 1&quot;}, {subject: &quot;foo bar 2&quot;}, {subject: &quot;foo&quot;},</span>
<a href="#l21.80"></a><span id="l21.80" class="difflineminus">-       {subject: &quot;bar&quot;}, {}]);</span>
<a href="#l21.81"></a><span id="l21.81" class="difflineminus">-  let virt = make_virtual_folder(folders, {subject: &quot;foo&quot;});</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineminus">-  yield async_view_open(viewWrapper, virt);</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineminus">-  // mailview on unread</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineminus">-  yield async_view_set_mail_view(viewWrapper, MailViewConstants.kViewItemUnread);</span>
<a href="#l21.85"></a><span id="l21.85" class="difflineminus">-  yield async_view_quick_search(viewWrapper,</span>
<a href="#l21.86"></a><span id="l21.86" class="difflineminus">-                                QuickSearchConstants.kQuickSearchSubject,</span>
<a href="#l21.87"></a><span id="l21.87" class="difflineminus">-                                &quot;bar&quot;);</span>
<a href="#l21.88"></a><span id="l21.88" class="difflineminus">-  verify_messages_in_view([fooBarOne, fooBarTwo], viewWrapper);</span>
<a href="#l21.89"></a><span id="l21.89" class="difflineminus">-</span>
<a href="#l21.90"></a><span id="l21.90" class="difflineminus">-  // clone and make sure the clone has the same results before/after refresh</span>
<a href="#l21.91"></a><span id="l21.91" class="difflineminus">-  let clonedWrapper = clone_view_wrapper(viewWrapper);</span>
<a href="#l21.92"></a><span id="l21.92" class="difflineminus">-  verify_messages_in_view([fooBarOne, fooBarTwo], clonedWrapper);</span>
<a href="#l21.93"></a><span id="l21.93" class="difflineminus">-  yield async_view_refresh(clonedWrapper);</span>
<a href="#l21.94"></a><span id="l21.94" class="difflineminus">-  verify_messages_in_view([fooBarOne, fooBarTwo], clonedWrapper);</span>
<a href="#l21.95"></a><span id="l21.95" class="difflineminus">-</span>
<a href="#l21.96"></a><span id="l21.96" class="difflineminus">-  // - Mark a set read so only one set remains.</span>
<a href="#l21.97"></a><span id="l21.97" class="difflineminus">-  fooBarTwo.setRead(true);</span>
<a href="#l21.98"></a><span id="l21.98" class="difflineminus">-  // We need to refresh to actually see the change (views do not make things</span>
<a href="#l21.99"></a><span id="l21.99" class="difflineminus">-  //  disappear out from under the user for attribute changes.)</span>
<a href="#l21.100"></a><span id="l21.100" class="difflineminus">-  yield async_view_refresh(viewWrapper);</span>
<a href="#l21.101"></a><span id="l21.101" class="difflineminus">-  verify_messages_in_view(fooBarOne, viewWrapper);</span>
<a href="#l21.102"></a><span id="l21.102" class="difflineminus">-  // (and make sure the clone sees this change too)</span>
<a href="#l21.103"></a><span id="l21.103" class="difflineminus">-  yield async_view_refresh(clonedWrapper);</span>
<a href="#l21.104"></a><span id="l21.104" class="difflineminus">-  verify_messages_in_view(fooBarOne, clonedWrapper);</span>
<a href="#l21.105"></a><span id="l21.105" class="difflineminus">-</span>
<a href="#l21.106"></a><span id="l21.106" class="difflineminus">-  // Make another clone to make sure the deleted notification shows up even</span>
<a href="#l21.107"></a><span id="l21.107" class="difflineminus">-  //  without a refresh triggering the creation of a new search session.</span>
<a href="#l21.108"></a><span id="l21.108" class="difflineminus">-  let doubleClone = clone_view_wrapper(clonedWrapper);</span>
<a href="#l21.109"></a><span id="l21.109" class="difflineminus">-</span>
<a href="#l21.110"></a><span id="l21.110" class="difflineminus">-  // - Delete some messages</span>
<a href="#l21.111"></a><span id="l21.111" class="difflineminus">-  // This should result in both views getting a messages removed notification.</span>
<a href="#l21.112"></a><span id="l21.112" class="difflineminus">-  gMockViewWrapperListener.messagesRemovedEventCount = 0;</span>
<a href="#l21.113"></a><span id="l21.113" class="difflineminus">-  yield async_delete_messages(fooBarOne);</span>
<a href="#l21.114"></a><span id="l21.114" class="difflineminus">-  // (thrice for each folder because we have three views listening)</span>
<a href="#l21.115"></a><span id="l21.115" class="difflineminus">-  do_check_eq(gMockViewWrapperListener.messagesRemovedEventCount,</span>
<a href="#l21.116"></a><span id="l21.116" class="difflineminus">-              aNumFolders * 3);</span>
<a href="#l21.117"></a><span id="l21.117" class="difflineminus">-</span>
<a href="#l21.118"></a><span id="l21.118" class="difflineminus">-  verify_messages_in_view([], viewWrapper);</span>
<a href="#l21.119"></a><span id="l21.119" class="difflineminus">-  verify_messages_in_view([], clonedWrapper);</span>
<a href="#l21.120"></a><span id="l21.120" class="difflineminus">-  verify_messages_in_view([], doubleClone);</span>
<a href="#l21.121"></a><span id="l21.121" class="difflineminus">-}</span>
<a href="#l21.122"></a><span id="l21.122" class="difflineminus">-</span>
<a href="#l21.123"></a><span id="l21.123"> var tests = [</span>
<a href="#l21.124"></a><span id="l21.124">   // -- single-folder backed virtual folder</span>
<a href="#l21.125"></a><span id="l21.125">   test_virtual_folder_single_load_no_pred,</span>
<a href="#l21.126"></a><span id="l21.126">   test_virtual_folder_single_load_simple_pred,</span>
<a href="#l21.127"></a><span id="l21.127">   test_virtual_folder_single_load_complex_pred,</span>
<a href="#l21.128"></a><span id="l21.128">   test_virtual_folder_single_load_after_load,</span>
<a href="#l21.129"></a><span id="l21.129">   // -- multi-folder backed virtual folder</span>
<a href="#l21.130"></a><span id="l21.130">   test_virtual_folder_multi_load_no_pred,</span>
<a href="#l21.131"></a><span id="l21.131" class="difflineat">@@ -485,18 +374,13 @@ var tests = [</span>
<a href="#l21.132"></a><span id="l21.132">   // -- mixture of single-backed and multi-backed</span>
<a href="#l21.133"></a><span id="l21.133">   test_virtual_folder_combo_load_after_load,</span>
<a href="#l21.134"></a><span id="l21.134">   // -- ignore things we should ignore</span>
<a href="#l21.135"></a><span id="l21.135">   test_virtual_folder_filters_out_servers,</span>
<a href="#l21.136"></a><span id="l21.136">   // -- rare/edge cases!</span>
<a href="#l21.137"></a><span id="l21.137">   test_virtual_folder_underlying_folder_deleted,</span>
<a href="#l21.138"></a><span id="l21.138">   // -- mail views (parameterized)</span>
<a href="#l21.139"></a><span id="l21.139">   parameterizeTest(test_virtual_folder_mail_views_unread, [1, 4]),</span>
<a href="#l21.140"></a><span id="l21.140" class="difflineminus">-  // -- quick search (parameterized for single and multi folder cases)</span>
<a href="#l21.141"></a><span id="l21.141" class="difflineminus">-  parameterizeTest(test_virtual_folder_param_quick_search_simple, [1, 4]),</span>
<a href="#l21.142"></a><span id="l21.142" class="difflineminus">-  parameterizeTest(test_virtual_folder_param_quick_search_complex, [1, 4]),</span>
<a href="#l21.143"></a><span id="l21.143" class="difflineminus">-  // -- mail view with quick search</span>
<a href="#l21.144"></a><span id="l21.144" class="difflineminus">-  parameterizeTest(test_virtual_folder_param_mail_view_and_quick_search,[1, 4]),</span>
<a href="#l21.145"></a><span id="l21.145"> ];</span>
<a href="#l21.146"></a><span id="l21.146"> </span>
<a href="#l21.147"></a><span id="l21.147"> function run_test() {</span>
<a href="#l21.148"></a><span id="l21.148">   async_run_tests(tests);</span>
<a href="#l21.149"></a><span id="l21.149"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mail/installer/removed-files.in</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mail/installer/removed-files.in</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -213,16 +213,17 @@ isp/sl/gmail.rdf</span>
<a href="#l22.4"></a><span id="l22.4"> isp/sv-SE/gmail.rdf</span>
<a href="#l22.5"></a><span id="l22.5"> isp/tr/gmail.rdf</span>
<a href="#l22.6"></a><span id="l22.6"> isp/uk/gmail.rdf</span>
<a href="#l22.7"></a><span id="l22.7"> isp/zh-CN/gmail.rdf</span>
<a href="#l22.8"></a><span id="l22.8"> isp/zh-TW/gmail.rdf</span>
<a href="#l22.9"></a><span id="l22.9"> license.html</span>
<a href="#l22.10"></a><span id="l22.10"> LICENSE.txt</span>
<a href="#l22.11"></a><span id="l22.11"> modules/JSON.jsm</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+modules/quickSearchManager.js</span>
<a href="#l22.13"></a><span id="l22.13"> #ifndef MOZ_IPC</span>
<a href="#l22.14"></a><span id="l22.14"> mozilla-runtime@BIN_SUFFIX@</span>
<a href="#l22.15"></a><span id="l22.15"> #endif</span>
<a href="#l22.16"></a><span id="l22.16"> #ifdef XP_MACOSX</span>
<a href="#l22.17"></a><span id="l22.17"> ../Plug-Ins/PrintPDE.plugin/Contents/Info.plist</span>
<a href="#l22.18"></a><span id="l22.18"> ../Plug-Ins/PrintPDE.plugin/Contents/MacOS/PrintPDE</span>
<a href="#l22.19"></a><span id="l22.19"> ../Plug-Ins/PrintPDE.plugin/Contents/Resources/English.lproj/Localizable.strings</span>
<a href="#l22.20"></a><span id="l22.20"> ../Plug-Ins/PrintPDE.plugin/Contents/Resources/English.lproj/PrintPDE.nib/classes.nib</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/messenger.dtd</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/messenger.dtd</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -692,18 +692,45 @@ you can use these alternative items. Oth</span>
<a href="#l23.4"></a><span id="l23.4"> &lt;!ENTITY reportPhishingError1.label &quot;This message doesn't appear to be a scam.&quot;&gt;</span>
<a href="#l23.5"></a><span id="l23.5"> </span>
<a href="#l23.6"></a><span id="l23.6"> &lt;!-- MDN Bar --&gt;</span>
<a href="#l23.7"></a><span id="l23.7"> &lt;!ENTITY mdnBarMessage.label &quot;The sender of this message has asked to be notified when you read this message. Do you wish to notify the sender?&quot;&gt;</span>
<a href="#l23.8"></a><span id="l23.8"> &lt;!ENTITY mdnBarIgnoreButton.label &quot;Ignore Request&quot;&gt;</span>
<a href="#l23.9"></a><span id="l23.9"> &lt;!ENTITY mdnBarSendButton.label &quot;Send Receipt&quot;&gt;</span>
<a href="#l23.10"></a><span id="l23.10"> </span>
<a href="#l23.11"></a><span id="l23.11"> &lt;!-- Quick Search Bar --&gt;</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (quickSearchCmd.key):</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+     This is actually the key used for the global message search box; we have</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+     not changed </span>
<a href="#l23.15"></a><span id="l23.15" class="difflineplus">+     --&gt;</span>
<a href="#l23.16"></a><span id="l23.16"> &lt;!ENTITY quickSearchCmd.key &quot;k&quot;&gt;</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineminus">-&lt;!ENTITY searchAllMessages.label &quot;Search all messages&quot;&gt;</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (searchAllMessages.label.base):</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineplus">+     This is the base of the empty text for the global search box.  We replace</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineplus">+     #1 with the contents of the appropriate</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineplus">+     searchAllMessages.keyLabel.* value for the platform.</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineplus">+     The goal is to convey to the user that typing in the box will allow them</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineplus">+     to search for messages globally and that there is a hotkey they can press</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineplus">+     to get to the box faster.  If the global indexer is disabled, the search</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineplus">+     box will be collapsed and the user will never see this message.</span>
<a href="#l23.26"></a><span id="l23.26" class="difflineplus">+     --&gt;</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineplus">+&lt;!ENTITY searchAllMessages.label.base &quot;Search all messages #1&quot;&gt;</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (searchAllMessages.keyLabel.nonmac):</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineplus">+     The description of the key-binding to get into the box on windows and</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineplus">+     linux (which use the control key).  We use the keybinding for cmd_find</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineplus">+     used by the find-in-message mechanism, so that's the letter to indicate</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineplus">+     if you don't use 'f' for your localization.</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineplus">+     --&gt;</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineplus">+&lt;!ENTITY searchAllMessages.keyLabel.nonmac &quot;&amp;lt;Ctrl+K&amp;gt;&quot;&gt;</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (searchAllMessages.keyLabel.mac):</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineplus">+     The description of the key-binding to get into the box on mac systems.</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineplus">+     We use the keybinding for cmd_find used by the find-in-message mechanism,</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineplus">+     so that's the letter to indicate  if you don't use 'f' for your</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineplus">+     localization.</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineplus">+     --&gt;</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineplus">+&lt;!ENTITY searchAllMessages.keyLabel.mac &quot;&amp;lt;&amp;#2318;+F&amp;gt;&quot;&gt;</span>
<a href="#l23.42"></a><span id="l23.42"> </span>
<a href="#l23.43"></a><span id="l23.43"> &lt;!-- Message Header Context Menu --&gt;</span>
<a href="#l23.44"></a><span id="l23.44"> &lt;!ENTITY AddToAddressBook.label &quot;Add to Address Book&quot;&gt;</span>
<a href="#l23.45"></a><span id="l23.45"> &lt;!ENTITY AddToAddressBook.accesskey &quot;B&quot;&gt;</span>
<a href="#l23.46"></a><span id="l23.46"> &lt;!ENTITY AddDirectlyToAddressBook.label &quot;Add to Address Book&quot;&gt;</span>
<a href="#l23.47"></a><span id="l23.47"> &lt;!ENTITY AddDirectlyToAddressBook.accesskey &quot;B&quot;&gt;</span>
<a href="#l23.48"></a><span id="l23.48"> &lt;!ENTITY EditContact.label &quot;Edit Contact&quot;&gt;</span>
<a href="#l23.49"></a><span id="l23.49"> &lt;!ENTITY EditContact.accesskey &quot;E&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1">new file mode 100644</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineminus">--- /dev/null</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/quickFilterBar.dtd</span>
<a href="#l24.4"></a><span id="l24.4" class="difflineat">@@ -0,0 +1,227 @@</span>
<a href="#l24.5"></a><span id="l24.5" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (quickFilterBar.toggleBarVisibility.menu.label):</span>
<a href="#l24.6"></a><span id="l24.6" class="difflineplus">+     The label to display for the &quot;View... Toolbars...&quot; menu item that controls</span>
<a href="#l24.7"></a><span id="l24.7" class="difflineplus">+     whether the quick filter bar is visible.</span>
<a href="#l24.8"></a><span id="l24.8" class="difflineplus">+     --&gt;</span>
<a href="#l24.9"></a><span id="l24.9" class="difflineplus">+&lt;!ENTITY quickFilterBar.toggleBarVisibility.menu.label</span>
<a href="#l24.10"></a><span id="l24.10" class="difflineplus">+         &quot;Quick Filter Bar&quot;&gt;</span>
<a href="#l24.11"></a><span id="l24.11" class="difflineplus">+</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (quickFilterBar.toggleBarVisibility.menu.accesskey):</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+     The access key for the &quot;View... Toolbars...&quot; menu item label that controls</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+     whether the quick filter bar is visible.</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineplus">+     --&gt;</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineplus">+&lt;!ENTITY quickFilterBar.toggleBarVisibility.menu.accesskey</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineplus">+         &quot;Q&quot;&gt;</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineplus">+</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (quickFilterBar.toggleBarVisibility.button.tooltip):</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineplus">+     The tooltip to display when hovering over the button on the tab bar that</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineplus">+     toggles the visibility of the quick filter bar.</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineplus">+     --&gt;</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineplus">+&lt;!ENTITY quickFilterBar.toggleBarVisibility.button.tooltip</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineplus">+         &quot;Toggle the quick filter bar.&quot;&gt;</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineplus">+</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (quickFilterBar.sticky.tooltip):</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineplus">+     The tooltip to display when the user hovers over the sticky button</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineplus">+     (currently displayed as a push-pin).  When active, the sticky button</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineplus">+     causes the current filter settings to be retained when the user changes</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineplus">+     folders or opens new tabs.  (When inactive, only the state of the text</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineplus">+     filters are propagated between folder changes and when opening new tabs.)</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineplus">+     --&gt;</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineplus">+&lt;!ENTITY quickFilterBar.sticky.tooltip</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineplus">+         &quot;Keep filters applied when switching folders?&quot;&gt;</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineplus">+</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (quickFilterBar.barLabel.label):</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineplus">+     The text to display on the quick filter bar, labeling it.  This should</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineplus">+     ideally be as short as possible.</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineplus">+     --&gt;</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineplus">+&lt;!ENTITY quickFilterBar.barLabel.label</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineplus">+         &quot;Quick Filter:&quot;&gt;</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineplus">+</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (quickFilterBar.unread.label):</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineplus">+     The label for the filter button that causes us to filter results to only</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineplus">+     include unread messages.</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineplus">+     --&gt;</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineplus">+&lt;!ENTITY quickFilterBar.unread.label</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineplus">+         &quot;Unread&quot;&gt;</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineplus">+</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (quickFilterBar.unread.tooltip):</span>
<a href="#l24.51"></a><span id="l24.51" class="difflineplus">+     The tooltip for the filter button that causes us to filter results to only</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineplus">+     include unread messages.</span>
<a href="#l24.53"></a><span id="l24.53" class="difflineplus">+     --&gt;</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineplus">+&lt;!ENTITY quickFilterBar.unread.tooltip</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineplus">+         &quot;Show only unread messages.&quot;&gt;</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineplus">+</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (quickFilterBar.starred.label):</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineplus">+     The label for the filter button that causes us to filter results to only</span>
<a href="#l24.59"></a><span id="l24.59" class="difflineplus">+     include messages that have been starred/flagged.</span>
<a href="#l24.60"></a><span id="l24.60" class="difflineplus">+     --&gt;</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineplus">+&lt;!ENTITY quickFilterBar.starred.label</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineplus">+         &quot;Starred&quot;&gt;</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineplus">+</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (quickFilterBar.starred.tooltip):</span>
<a href="#l24.65"></a><span id="l24.65" class="difflineplus">+     The tooltip for the filter button that causes us to filter results to only</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineplus">+     include messages that have been starred/flagged.</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineplus">+     --&gt;</span>
<a href="#l24.68"></a><span id="l24.68" class="difflineplus">+&lt;!ENTITY quickFilterBar.starred.tooltip</span>
<a href="#l24.69"></a><span id="l24.69" class="difflineplus">+         &quot;Show only starred messages.&quot;&gt;</span>
<a href="#l24.70"></a><span id="l24.70" class="difflineplus">+</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (quickFilterBar.inaddrbook.label):</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineplus">+     The label for the filter button that causes us to filter results to only</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineplus">+     include messages from contacts in one of the user's non-remote address</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineplus">+     books.</span>
<a href="#l24.75"></a><span id="l24.75" class="difflineplus">+     --&gt;</span>
<a href="#l24.76"></a><span id="l24.76" class="difflineplus">+&lt;!ENTITY quickFilterBar.inaddrbook.label</span>
<a href="#l24.77"></a><span id="l24.77" class="difflineplus">+         &quot;Contact&quot;&gt;</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineplus">+</span>
<a href="#l24.79"></a><span id="l24.79" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (quickFilterBar.inaddrbook.tooltip):</span>
<a href="#l24.80"></a><span id="l24.80" class="difflineplus">+     The tooltip for the filter button that causes us to filter results to only</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineplus">+     include messages from contacts in one of the user's non-remote address</span>
<a href="#l24.82"></a><span id="l24.82" class="difflineplus">+     books.</span>
<a href="#l24.83"></a><span id="l24.83" class="difflineplus">+     --&gt;</span>
<a href="#l24.84"></a><span id="l24.84" class="difflineplus">+&lt;!ENTITY quickFilterBar.inaddrbook.tooltip</span>
<a href="#l24.85"></a><span id="l24.85" class="difflineplus">+         &quot;Show only messages from people in your address book.&quot;&gt;</span>
<a href="#l24.86"></a><span id="l24.86" class="difflineplus">+</span>
<a href="#l24.87"></a><span id="l24.87" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (quickFilterBar.tags.label):</span>
<a href="#l24.88"></a><span id="l24.88" class="difflineplus">+     The label for the filter button that causes us to filter results to only</span>
<a href="#l24.89"></a><span id="l24.89" class="difflineplus">+     include messages with at least one tag on them.</span>
<a href="#l24.90"></a><span id="l24.90" class="difflineplus">+     --&gt;</span>
<a href="#l24.91"></a><span id="l24.91" class="difflineplus">+&lt;!ENTITY quickFilterBar.tags.label</span>
<a href="#l24.92"></a><span id="l24.92" class="difflineplus">+         &quot;Tags&quot;&gt;</span>
<a href="#l24.93"></a><span id="l24.93" class="difflineplus">+</span>
<a href="#l24.94"></a><span id="l24.94" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (quickFilterBar.tags.tooltip):</span>
<a href="#l24.95"></a><span id="l24.95" class="difflineplus">+     The tooltip for the filter button that causes us to filter results to only</span>
<a href="#l24.96"></a><span id="l24.96" class="difflineplus">+     include messages with at least one tag on them.</span>
<a href="#l24.97"></a><span id="l24.97" class="difflineplus">+     --&gt;</span>
<a href="#l24.98"></a><span id="l24.98" class="difflineplus">+&lt;!ENTITY quickFilterBar.tags.tooltip</span>
<a href="#l24.99"></a><span id="l24.99" class="difflineplus">+         &quot;Show only messages with tags on them.&quot;&gt;</span>
<a href="#l24.100"></a><span id="l24.100" class="difflineplus">+</span>
<a href="#l24.101"></a><span id="l24.101" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (quickFilterBar.attachment.label):</span>
<a href="#l24.102"></a><span id="l24.102" class="difflineplus">+     The label for the filter button that causes us to filter results to only</span>
<a href="#l24.103"></a><span id="l24.103" class="difflineplus">+     include messages with attachments.</span>
<a href="#l24.104"></a><span id="l24.104" class="difflineplus">+     --&gt;</span>
<a href="#l24.105"></a><span id="l24.105" class="difflineplus">+&lt;!ENTITY quickFilterBar.attachment.label</span>
<a href="#l24.106"></a><span id="l24.106" class="difflineplus">+         &quot;Attachment&quot;&gt;</span>
<a href="#l24.107"></a><span id="l24.107" class="difflineplus">+</span>
<a href="#l24.108"></a><span id="l24.108" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (quickFilterBar.attachment.tooltip):</span>
<a href="#l24.109"></a><span id="l24.109" class="difflineplus">+     The tooltip for the filter button that causes us to filter results to only</span>
<a href="#l24.110"></a><span id="l24.110" class="difflineplus">+     include messages with attachments.</span>
<a href="#l24.111"></a><span id="l24.111" class="difflineplus">+     --&gt;</span>
<a href="#l24.112"></a><span id="l24.112" class="difflineplus">+&lt;!ENTITY quickFilterBar.attachment.tooltip</span>
<a href="#l24.113"></a><span id="l24.113" class="difflineplus">+         &quot;Show only messages with attachments.&quot;&gt;</span>
<a href="#l24.114"></a><span id="l24.114" class="difflineplus">+</span>
<a href="#l24.115"></a><span id="l24.115" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (quickFilterBar.resultsLabel.some.formatString):</span>
<a href="#l24.116"></a><span id="l24.116" class="difflineplus">+     This is used to populate the results box; it either displays the</span>
<a href="#l24.117"></a><span id="l24.117" class="difflineplus">+     number of messages found using this string, that there are no messages</span>
<a href="#l24.118"></a><span id="l24.118" class="difflineplus">+     (using quickFilterBar.resultsLabel.none), or the box is hidden.</span>
<a href="#l24.119"></a><span id="l24.119" class="difflineplus">+     This is a pluralizable string used to express the number of messages in</span>
<a href="#l24.120"></a><span id="l24.120" class="difflineplus">+     the results.  We replace the '#1' with the number of messages, otherwise</span>
<a href="#l24.121"></a><span id="l24.121" class="difflineplus">+     see the following URL For more information:</span>
<a href="#l24.122"></a><span id="l24.122" class="difflineplus">+     https://developer.mozilla.org/En/Localization_and_Plurals</span>
<a href="#l24.123"></a><span id="l24.123" class="difflineplus">+     --&gt;</span>
<a href="#l24.124"></a><span id="l24.124" class="difflineplus">+&lt;!ENTITY quickFilterBar.resultsLabel.some.formatString</span>
<a href="#l24.125"></a><span id="l24.125" class="difflineplus">+         &quot;#1 message;#1 messages&quot;&gt;</span>
<a href="#l24.126"></a><span id="l24.126" class="difflineplus">+</span>
<a href="#l24.127"></a><span id="l24.127" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (quickFilterBar.resultsLabel.none):</span>
<a href="#l24.128"></a><span id="l24.128" class="difflineplus">+     The contents of the results box when there is a filter active but there</span>
<a href="#l24.129"></a><span id="l24.129" class="difflineplus">+     are no messages matching the filter.</span>
<a href="#l24.130"></a><span id="l24.130" class="difflineplus">+     --&gt;</span>
<a href="#l24.131"></a><span id="l24.131" class="difflineplus">+&lt;!ENTITY quickFilterBar.resultsLabel.none</span>
<a href="#l24.132"></a><span id="l24.132" class="difflineplus">+         &quot;No results&quot;&gt;</span>
<a href="#l24.133"></a><span id="l24.133" class="difflineplus">+</span>
<a href="#l24.134"></a><span id="l24.134" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (quickFilterBar.resultsLabel.minWidth):</span>
<a href="#l24.135"></a><span id="l24.135" class="difflineplus">+     The minimum width, in pixels, of the results label.  Please size this</span>
<a href="#l24.136"></a><span id="l24.136" class="difflineplus">+     so that a 3 or 4 digit number of messages in the results can be displayed</span>
<a href="#l24.137"></a><span id="l24.137" class="difflineplus">+     without growing the size of the box.  You can tell this has been</span>
<a href="#l24.138"></a><span id="l24.138" class="difflineplus">+     accomplished if adding a filter constraint that changes the displayed</span>
<a href="#l24.139"></a><span id="l24.139" class="difflineplus">+     string to your &quot;no results&quot; string does not result in any changes to the</span>
<a href="#l24.140"></a><span id="l24.140" class="difflineplus">+     size of the text box to the label's right.  (If your string for</span>
<a href="#l24.141"></a><span id="l24.141" class="difflineplus">+     &quot;no results&quot; is longer than the &quot;#### messages&quot; case, then size for that.</span>
<a href="#l24.142"></a><span id="l24.142" class="difflineplus">+     --&gt;</span>
<a href="#l24.143"></a><span id="l24.143" class="difflineplus">+&lt;!ENTITY quickFilterBar.resultsLabel.minWidth</span>
<a href="#l24.144"></a><span id="l24.144" class="difflineplus">+         &quot;100&quot;&gt;</span>
<a href="#l24.145"></a><span id="l24.145" class="difflineplus">+</span>
<a href="#l24.146"></a><span id="l24.146" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (quickFilterBar.textbox.emptyText.base):</span>
<a href="#l24.147"></a><span id="l24.147" class="difflineplus">+     This is the base of the empty text for the text search box.  We replace</span>
<a href="#l24.148"></a><span id="l24.148" class="difflineplus">+     #1 with the contents of the appropriate</span>
<a href="#l24.149"></a><span id="l24.149" class="difflineplus">+     quickFilterBar.textbox.emptyText.keyLabel.* value for the platform.</span>
<a href="#l24.150"></a><span id="l24.150" class="difflineplus">+     The goal is to convey to the user that typing in the box will filter</span>
<a href="#l24.151"></a><span id="l24.151" class="difflineplus">+     the messages and that there is a hotkey they can press to get to the</span>
<a href="#l24.152"></a><span id="l24.152" class="difflineplus">+     box faster.</span>
<a href="#l24.153"></a><span id="l24.153" class="difflineplus">+     --&gt;</span>
<a href="#l24.154"></a><span id="l24.154" class="difflineplus">+&lt;!ENTITY quickFilterBar.textbox.emptyText.base</span>
<a href="#l24.155"></a><span id="l24.155" class="difflineplus">+         &quot;Filter these messages... #1&quot;&gt;</span>
<a href="#l24.156"></a><span id="l24.156" class="difflineplus">+</span>
<a href="#l24.157"></a><span id="l24.157" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (quickFilterBar.textbox.emptyText.keyLabel.nonmac):</span>
<a href="#l24.158"></a><span id="l24.158" class="difflineplus">+     The description of the key-binding to get into the box on windows and</span>
<a href="#l24.159"></a><span id="l24.159" class="difflineplus">+     linux (which use the control key).  We use the keybinding for cmd_find</span>
<a href="#l24.160"></a><span id="l24.160" class="difflineplus">+     used by the find-in-message mechanism, so that's the letter to indicate</span>
<a href="#l24.161"></a><span id="l24.161" class="difflineplus">+     if you don't use 'f' for your localization.</span>
<a href="#l24.162"></a><span id="l24.162" class="difflineplus">+     --&gt;</span>
<a href="#l24.163"></a><span id="l24.163" class="difflineplus">+&lt;!ENTITY quickFilterBar.textbox.emptyText.keyLabel.nonmac</span>
<a href="#l24.164"></a><span id="l24.164" class="difflineplus">+         &quot;&amp;lt;Ctrl+F&amp;gt;&quot;&gt;</span>
<a href="#l24.165"></a><span id="l24.165" class="difflineplus">+</span>
<a href="#l24.166"></a><span id="l24.166" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (quickFilterBar.textbox.emptyText.keyLabel.mac):</span>
<a href="#l24.167"></a><span id="l24.167" class="difflineplus">+     The description of the key-binding to get into the box on mac systems.</span>
<a href="#l24.168"></a><span id="l24.168" class="difflineplus">+     We use the keybinding for cmd_find used by the find-in-message mechanism,</span>
<a href="#l24.169"></a><span id="l24.169" class="difflineplus">+     so that's the letter to indicate  if you don't use 'f' for your</span>
<a href="#l24.170"></a><span id="l24.170" class="difflineplus">+     localization.</span>
<a href="#l24.171"></a><span id="l24.171" class="difflineplus">+     --&gt;</span>
<a href="#l24.172"></a><span id="l24.172" class="difflineplus">+&lt;!ENTITY quickFilterBar.textbox.emptyText.keyLabel.mac</span>
<a href="#l24.173"></a><span id="l24.173" class="difflineplus">+         &quot;&amp;lt;&amp;#2318;+F&amp;gt;&quot;&gt;</span>
<a href="#l24.174"></a><span id="l24.174" class="difflineplus">+</span>
<a href="#l24.175"></a><span id="l24.175" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (quickFilterBar.textbox.idealWidth):</span>
<a href="#l24.176"></a><span id="l24.176" class="difflineplus">+     The number of pixels for the ideal width of the quick filter box textbox.</span>
<a href="#l24.177"></a><span id="l24.177" class="difflineplus">+     Choose this value so that the emptyText fits nicely with a little bit of</span>
<a href="#l24.178"></a><span id="l24.178" class="difflineplus">+     extra whitespace.</span>
<a href="#l24.179"></a><span id="l24.179" class="difflineplus">+     --&gt;</span>
<a href="#l24.180"></a><span id="l24.180" class="difflineplus">+&lt;!ENTITY quickFilterBar.textbox.idealWidth</span>
<a href="#l24.181"></a><span id="l24.181" class="difflineplus">+         &quot;320&quot;&gt;</span>
<a href="#l24.182"></a><span id="l24.182" class="difflineplus">+</span>
<a href="#l24.183"></a><span id="l24.183" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (quickFilterBar.textbox.minWidth):</span>
<a href="#l24.184"></a><span id="l24.184" class="difflineplus">+     The minimum width of the quick filter textbox in pixels.  This is the size</span>
<a href="#l24.185"></a><span id="l24.185" class="difflineplus">+     which we should refuse to flex below.  When we hit this size, the buttons</span>
<a href="#l24.186"></a><span id="l24.186" class="difflineplus">+     with labels will have their labels collapsed.</span>
<a href="#l24.187"></a><span id="l24.187" class="difflineplus">+     --&gt;</span>
<a href="#l24.188"></a><span id="l24.188" class="difflineplus">+&lt;!ENTITY quickFilterBar.textbox.minWidth</span>
<a href="#l24.189"></a><span id="l24.189" class="difflineplus">+         &quot;280&quot;&gt;</span>
<a href="#l24.190"></a><span id="l24.190" class="difflineplus">+</span>
<a href="#l24.191"></a><span id="l24.191" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (quickFilterBar.textFilter.sender.label):</span>
<a href="#l24.192"></a><span id="l24.192" class="difflineplus">+     The button label that toggles whether the text filter searches the message</span>
<a href="#l24.193"></a><span id="l24.193" class="difflineplus">+     sender for the string.</span>
<a href="#l24.194"></a><span id="l24.194" class="difflineplus">+     --&gt;</span>
<a href="#l24.195"></a><span id="l24.195" class="difflineplus">+&lt;!ENTITY quickFilterBar.textFilter.sender.label</span>
<a href="#l24.196"></a><span id="l24.196" class="difflineplus">+         &quot;Sender&quot;&gt;</span>
<a href="#l24.197"></a><span id="l24.197" class="difflineplus">+</span>
<a href="#l24.198"></a><span id="l24.198" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (quickFilterBar.textFilter.recipients.label):</span>
<a href="#l24.199"></a><span id="l24.199" class="difflineplus">+     The button label that toggles whether the text filter searches the message</span>
<a href="#l24.200"></a><span id="l24.200" class="difflineplus">+     recipients (to, cc) for the string.</span>
<a href="#l24.201"></a><span id="l24.201" class="difflineplus">+     --&gt;</span>
<a href="#l24.202"></a><span id="l24.202" class="difflineplus">+&lt;!ENTITY quickFilterBar.textFilter.recipients.label</span>
<a href="#l24.203"></a><span id="l24.203" class="difflineplus">+         &quot;Recipients&quot;&gt;</span>
<a href="#l24.204"></a><span id="l24.204" class="difflineplus">+</span>
<a href="#l24.205"></a><span id="l24.205" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (quickFilterBar.textFilter.subject.label):</span>
<a href="#l24.206"></a><span id="l24.206" class="difflineplus">+     The button label that toggles whether the text filter searches the message</span>
<a href="#l24.207"></a><span id="l24.207" class="difflineplus">+     subject for the string.</span>
<a href="#l24.208"></a><span id="l24.208" class="difflineplus">+     --&gt;</span>
<a href="#l24.209"></a><span id="l24.209" class="difflineplus">+&lt;!ENTITY quickFilterBar.textFilter.subject.label</span>
<a href="#l24.210"></a><span id="l24.210" class="difflineplus">+         &quot;Subject&quot;&gt;</span>
<a href="#l24.211"></a><span id="l24.211" class="difflineplus">+</span>
<a href="#l24.212"></a><span id="l24.212" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (quickFilterBar.textFilter.body.label):</span>
<a href="#l24.213"></a><span id="l24.213" class="difflineplus">+     The button label that toggles whether the text filter searches the message</span>
<a href="#l24.214"></a><span id="l24.214" class="difflineplus">+     body for the string.</span>
<a href="#l24.215"></a><span id="l24.215" class="difflineplus">+     --&gt;</span>
<a href="#l24.216"></a><span id="l24.216" class="difflineplus">+&lt;!ENTITY quickFilterBar.textFilter.body.label</span>
<a href="#l24.217"></a><span id="l24.217" class="difflineplus">+         &quot;Body&quot;&gt;</span>
<a href="#l24.218"></a><span id="l24.218" class="difflineplus">+</span>
<a href="#l24.219"></a><span id="l24.219" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (quickFilterBar.glodaUpsell.continueSearch):</span>
<a href="#l24.220"></a><span id="l24.220" class="difflineplus">+     The first line of the panel popup that tells the user we found no matches</span>
<a href="#l24.221"></a><span id="l24.221" class="difflineplus">+     but we can convert to a global search for them.</span>
<a href="#l24.222"></a><span id="l24.222" class="difflineplus">+     --&gt;</span>
<a href="#l24.223"></a><span id="l24.223" class="difflineplus">+&lt;!ENTITY quickFilterBar.glodaUpsell.continueSearch</span>
<a href="#l24.224"></a><span id="l24.224" class="difflineplus">+         &quot;Continue this search across all folders&quot;&gt;</span>
<a href="#l24.225"></a><span id="l24.225" class="difflineplus">+</span>
<a href="#l24.226"></a><span id="l24.226" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (quickFilterBar.glodaUpsell.pressEnterAndCurrent):</span>
<a href="#l24.227"></a><span id="l24.227" class="difflineplus">+     The second line of the panel popup that tells the user we found no matches.</span>
<a href="#l24.228"></a><span id="l24.228" class="difflineplus">+     This line will have #1 replaced with what the user has typed so far.</span>
<a href="#l24.229"></a><span id="l24.229" class="difflineplus">+     --&gt;</span>
<a href="#l24.230"></a><span id="l24.230" class="difflineplus">+&lt;!ENTITY quickFilterBar.glodaUpsell.pressEnterAndCurrent</span>
<a href="#l24.231"></a><span id="l24.231" class="difflineplus">+         &quot;Press 'Enter' again to continue your search for: #1&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1">deleted file mode 100644</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/quickSearch.properties</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineplus">+++ /dev/null</span>
<a href="#l25.4"></a><span id="l25.4" class="difflineat">@@ -1,9 +0,0 @@</span>
<a href="#l25.5"></a><span id="l25.5" class="difflineminus">-searchSubject.label=Subject filter</span>
<a href="#l25.6"></a><span id="l25.6" class="difflineminus">-searchFrom.label=From filter</span>
<a href="#l25.7"></a><span id="l25.7" class="difflineminus">-searchFromOrSubject.label=Subject or From filter</span>
<a href="#l25.8"></a><span id="l25.8" class="difflineminus">-searchRecipient.label=To or Cc filter</span>
<a href="#l25.9"></a><span id="l25.9" class="difflineminus">-searchRecipientOrSubject.label=Subject, To, or Cc filter</span>
<a href="#l25.10"></a><span id="l25.10" class="difflineminus">-searchMsgBody.label=Message body filter</span>
<a href="#l25.11"></a><span id="l25.11" class="difflineminus">-saveAsVirtualFolder.label=Save search as virtual folder</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-searchSubjectFromOrRecipient.label=Subject, From, or Recipient filter</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-searchEntireMessage.label=Entire message filter</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mail/locales/jar.mn</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mail/locales/jar.mn</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -90,24 +90,24 @@</span>
<a href="#l26.4"></a><span id="l26.4">   locale/@AB_CD@/messenger/fieldMapImport.dtd                           (%chrome/messenger/fieldMapImport.dtd)</span>
<a href="#l26.5"></a><span id="l26.5">   locale/@AB_CD@/messenger/textImportMsgs.properties                    (%chrome/messenger/textImportMsgs.properties)</span>
<a href="#l26.6"></a><span id="l26.6">   locale/@AB_CD@/messenger/appleMailImportMsgs.properties               (%chrome/messenger/appleMailImportMsgs.properties)</span>
<a href="#l26.7"></a><span id="l26.7">   locale/@AB_CD@/messenger/comm4xMailImportMsgs.properties              (%chrome/messenger/comm4xMailImportMsgs.properties)</span>
<a href="#l26.8"></a><span id="l26.8">   locale/@AB_CD@/messenger/eudoraImportMsgs.properties                  (%chrome/messenger/eudoraImportMsgs.properties)</span>
<a href="#l26.9"></a><span id="l26.9">   locale/@AB_CD@/messenger/oeImportMsgs.properties                      (%chrome/messenger/oeImportMsgs.properties)</span>
<a href="#l26.10"></a><span id="l26.10">   locale/@AB_CD@/messenger/outlookImportMsgs.properties                 (%chrome/messenger/outlookImportMsgs.properties)</span>
<a href="#l26.11"></a><span id="l26.11">   locale/@AB_CD@/messenger/shutdownWindow.properties                    (%chrome/messenger/shutdownWindow.properties)</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-  locale/@AB_CD@/messenger/quickSearch.properties                       (%chrome/messenger/quickSearch.properties)</span>
<a href="#l26.13"></a><span id="l26.13">   locale/@AB_CD@/messenger/featureConfigurator.dtd                      (%chrome/messenger/featureConfigurator.dtd)</span>
<a href="#l26.14"></a><span id="l26.14">   locale/@AB_CD@/messenger/configEditorOverlay.dtd                      (%chrome/messenger/configEditorOverlay.dtd)</span>
<a href="#l26.15"></a><span id="l26.15">   locale/@AB_CD@/messenger/gloda.properties                             (%chrome/messenger/gloda.properties)</span>
<a href="#l26.16"></a><span id="l26.16">   locale/@AB_CD@/messenger/glodaComplete.properties                     (%chrome/messenger/glodaComplete.properties)</span>
<a href="#l26.17"></a><span id="l26.17">   locale/@AB_CD@/messenger/templateUtils.properties                     (%chrome/messenger/templateUtils.properties)</span>
<a href="#l26.18"></a><span id="l26.18">   locale/@AB_CD@/messenger/glodaFacetView.properties                    (%chrome/messenger/glodaFacetView.properties)</span>
<a href="#l26.19"></a><span id="l26.19">   locale/@AB_CD@/messenger/glodaFacetView.dtd                           (%chrome/messenger/glodaFacetView.dtd)</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineplus">+  locale/@AB_CD@/messenger/quickFilterBar.dtd                           (%chrome/messenger/quickFilterBar.dtd)</span>
<a href="#l26.21"></a><span id="l26.21">   locale/@AB_CD@/messenger/addressbook/abMainWindow.dtd                 (%chrome/messenger/addressbook/abMainWindow.dtd)</span>
<a href="#l26.22"></a><span id="l26.22">   locale/@AB_CD@/messenger/addressbook/abNewCardDialog.dtd              (%chrome/messenger/addressbook/abNewCardDialog.dtd)</span>
<a href="#l26.23"></a><span id="l26.23">   locale/@AB_CD@/messenger/addressbook/abContactsPanel.dtd              (%chrome/messenger/addressbook/abContactsPanel.dtd)</span>
<a href="#l26.24"></a><span id="l26.24">   locale/@AB_CD@/messenger/addressbook/abAddressBookNameDialog.dtd      (%chrome/messenger/addressbook/abAddressBookNameDialog.dtd)</span>
<a href="#l26.25"></a><span id="l26.25">   locale/@AB_CD@/messenger/addressbook/abCardOverlay.dtd                (%chrome/messenger/addressbook/abCardOverlay.dtd)</span>
<a href="#l26.26"></a><span id="l26.26">   locale/@AB_CD@/messenger/addressbook/abCardViewOverlay.dtd            (%chrome/messenger/addressbook/abCardViewOverlay.dtd)</span>
<a href="#l26.27"></a><span id="l26.27">   locale/@AB_CD@/messenger/addressbook/abDirTreeOverlay.dtd             (%chrome/messenger/addressbook/abDirTreeOverlay.dtd)</span>
<a href="#l26.28"></a><span id="l26.28">   locale/@AB_CD@/messenger/addressbook/abResultsPaneOverlay.dtd         (%chrome/messenger/addressbook/abResultsPaneOverlay.dtd)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1">deleted file mode 100644</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-quick-search.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineplus">+++ /dev/null</span>
<a href="#l27.4"></a><span id="l27.4" class="difflineat">@@ -1,277 +0,0 @@</span>
<a href="#l27.5"></a><span id="l27.5" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l27.6"></a><span id="l27.6" class="difflineminus">- *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l27.7"></a><span id="l27.7" class="difflineminus">- *</span>
<a href="#l27.8"></a><span id="l27.8" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l27.9"></a><span id="l27.9" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l27.10"></a><span id="l27.10" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l27.11"></a><span id="l27.11" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">- *</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineminus">- * License.</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineminus">- *</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineminus">- * The Original Code is Thunderbird Mail Client.</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineminus">- *</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineminus">- * Mozilla Messaging, Inc.</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l27.24"></a><span id="l27.24" class="difflineminus">- *</span>
<a href="#l27.25"></a><span id="l27.25" class="difflineminus">- * Contributor(s):</span>
<a href="#l27.26"></a><span id="l27.26" class="difflineminus">- *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l27.27"></a><span id="l27.27" class="difflineminus">- *   Siddharth Agarwal &lt;sid.bugzilla@gmail.com&gt;</span>
<a href="#l27.28"></a><span id="l27.28" class="difflineminus">- *</span>
<a href="#l27.29"></a><span id="l27.29" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineminus">- * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineminus">- * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l27.33"></a><span id="l27.33" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l27.34"></a><span id="l27.34" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l27.35"></a><span id="l27.35" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l27.36"></a><span id="l27.36" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l27.37"></a><span id="l27.37" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l27.38"></a><span id="l27.38" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l27.39"></a><span id="l27.39" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l27.40"></a><span id="l27.40" class="difflineminus">- *</span>
<a href="#l27.41"></a><span id="l27.41" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l27.42"></a><span id="l27.42" class="difflineminus">-</span>
<a href="#l27.43"></a><span id="l27.43" class="difflineminus">-var MODULE_NAME = 'test-quick-search';</span>
<a href="#l27.44"></a><span id="l27.44" class="difflineminus">-</span>
<a href="#l27.45"></a><span id="l27.45" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l27.46"></a><span id="l27.46" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers',</span>
<a href="#l27.47"></a><span id="l27.47" class="difflineminus">-                       'search-window-helpers'];</span>
<a href="#l27.48"></a><span id="l27.48" class="difflineminus">-</span>
<a href="#l27.49"></a><span id="l27.49" class="difflineminus">-Cu.import(&quot;resource:///modules/quickSearchManager.js&quot;);</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineminus">-Cu.import(&quot;resource:///modules/sessionStoreManager.js&quot;);</span>
<a href="#l27.51"></a><span id="l27.51" class="difflineminus">-</span>
<a href="#l27.52"></a><span id="l27.52" class="difflineminus">-var folder;</span>
<a href="#l27.53"></a><span id="l27.53" class="difflineminus">-var setFoo, setBar;</span>
<a href="#l27.54"></a><span id="l27.54" class="difflineminus">-</span>
<a href="#l27.55"></a><span id="l27.55" class="difflineminus">-function setupModule(module) {</span>
<a href="#l27.56"></a><span id="l27.56" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l27.57"></a><span id="l27.57" class="difflineminus">-  fdh.installInto(module);</span>
<a href="#l27.58"></a><span id="l27.58" class="difflineminus">-  let wh = collector.getModule('window-helpers');</span>
<a href="#l27.59"></a><span id="l27.59" class="difflineminus">-  wh.installInto(module);</span>
<a href="#l27.60"></a><span id="l27.60" class="difflineminus">-  let sh = collector.getModule('search-window-helpers');</span>
<a href="#l27.61"></a><span id="l27.61" class="difflineminus">-  sh.installInto(module);</span>
<a href="#l27.62"></a><span id="l27.62" class="difflineminus">-</span>
<a href="#l27.63"></a><span id="l27.63" class="difflineminus">-  folder = create_folder(&quot;QuickSearch&quot;);</span>
<a href="#l27.64"></a><span id="l27.64" class="difflineminus">-  [setFoo, setBar] =</span>
<a href="#l27.65"></a><span id="l27.65" class="difflineminus">-    make_new_sets_in_folder(folder, [{subject: &quot;foo&quot;, count: 1},</span>
<a href="#l27.66"></a><span id="l27.66" class="difflineminus">-                                     {subject: &quot;bar&quot;, count: 1}]);</span>
<a href="#l27.67"></a><span id="l27.67" class="difflineminus">-}</span>
<a href="#l27.68"></a><span id="l27.68" class="difflineminus">-</span>
<a href="#l27.69"></a><span id="l27.69" class="difflineminus">-function _assert_quick_search_mode(aController, aMode)</span>
<a href="#l27.70"></a><span id="l27.70" class="difflineminus">-{</span>
<a href="#l27.71"></a><span id="l27.71" class="difflineminus">-  let searchInput = aController.e(&quot;searchInput&quot;);</span>
<a href="#l27.72"></a><span id="l27.72" class="difflineminus">-  let actualMode = searchInput.searchMode;</span>
<a href="#l27.73"></a><span id="l27.73" class="difflineminus">-  if (actualMode != aMode)</span>
<a href="#l27.74"></a><span id="l27.74" class="difflineminus">-    throw new Error(&quot;The search mode is supposed to be &quot; + aMode +</span>
<a href="#l27.75"></a><span id="l27.75" class="difflineminus">-                    &quot;, but is actually &quot; + actualMode);</span>
<a href="#l27.76"></a><span id="l27.76" class="difflineminus">-</span>
<a href="#l27.77"></a><span id="l27.77" class="difflineminus">-  // Check whether the menupopup has the correct value selected</span>
<a href="#l27.78"></a><span id="l27.78" class="difflineminus">-  let menupopupMode = searchInput.menupopup.getAttribute(&quot;value&quot;);</span>
<a href="#l27.79"></a><span id="l27.79" class="difflineminus">-  if (menupopupMode != aMode)</span>
<a href="#l27.80"></a><span id="l27.80" class="difflineminus">-    throw new Error(&quot;The search menupopup's mode is supposed to be &quot; + aMode +</span>
<a href="#l27.81"></a><span id="l27.81" class="difflineminus">-                    &quot;, but is actually &quot; + menupopupMode);</span>
<a href="#l27.82"></a><span id="l27.82" class="difflineminus">-</span>
<a href="#l27.83"></a><span id="l27.83" class="difflineminus">-  // Also check the empty text</span>
<a href="#l27.84"></a><span id="l27.84" class="difflineminus">-  let expectedEmptyText = searchInput.menupopup.getElementsByAttribute(&quot;value&quot;,</span>
<a href="#l27.85"></a><span id="l27.85" class="difflineminus">-                              aMode)[0].getAttribute(&quot;label&quot;);</span>
<a href="#l27.86"></a><span id="l27.86" class="difflineminus">-  if (expectedEmptyText != searchInput.emptyText)</span>
<a href="#l27.87"></a><span id="l27.87" class="difflineminus">-    throw new Error(&quot;The search empty text is supposed to be &quot; +</span>
<a href="#l27.88"></a><span id="l27.88" class="difflineminus">-                    expectedEmptyText + &quot;, but is actually &quot; +</span>
<a href="#l27.89"></a><span id="l27.89" class="difflineminus">-                    searchInput.emptyText);</span>
<a href="#l27.90"></a><span id="l27.90" class="difflineminus">-}</span>
<a href="#l27.91"></a><span id="l27.91" class="difflineminus">-</span>
<a href="#l27.92"></a><span id="l27.92" class="difflineminus">-function _open_3pane_window()</span>
<a href="#l27.93"></a><span id="l27.93" class="difflineminus">-{</span>
<a href="#l27.94"></a><span id="l27.94" class="difflineminus">-  let windowWatcher = Cc[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l27.95"></a><span id="l27.95" class="difflineminus">-                        .getService(Ci.nsIWindowWatcher);</span>
<a href="#l27.96"></a><span id="l27.96" class="difflineminus">-  windowWatcher.openWindow(null,</span>
<a href="#l27.97"></a><span id="l27.97" class="difflineminus">-      &quot;chrome://messenger/content/&quot;, &quot;&quot;,</span>
<a href="#l27.98"></a><span id="l27.98" class="difflineminus">-      &quot;all,chrome,dialog=no,status,toolbar&quot;, null);</span>
<a href="#l27.99"></a><span id="l27.99" class="difflineminus">-}</span>
<a href="#l27.100"></a><span id="l27.100" class="difflineminus">-</span>
<a href="#l27.101"></a><span id="l27.101" class="difflineminus">-/**</span>
<a href="#l27.102"></a><span id="l27.102" class="difflineminus">- *</span>
<a href="#l27.103"></a><span id="l27.103" class="difflineminus">- */</span>
<a href="#l27.104"></a><span id="l27.104" class="difflineminus">-function test_save_quick_search() {</span>
<a href="#l27.105"></a><span id="l27.105" class="difflineminus">-  be_in_folder(folder);</span>
<a href="#l27.106"></a><span id="l27.106" class="difflineminus">-</span>
<a href="#l27.107"></a><span id="l27.107" class="difflineminus">-  // - We want to do a from or subject search</span>
<a href="#l27.108"></a><span id="l27.108" class="difflineminus">-  mc.e(&quot;searchInput&quot;).searchMode =</span>
<a href="#l27.109"></a><span id="l27.109" class="difflineminus">-    QuickSearchConstants.kQuickSearchFromOrSubject.toString();</span>
<a href="#l27.110"></a><span id="l27.110" class="difflineminus">-</span>
<a href="#l27.111"></a><span id="l27.111" class="difflineminus">-  // - Type something in the quick search box.</span>
<a href="#l27.112"></a><span id="l27.112" class="difflineminus">-  mc.type(mc.eid(&quot;searchInput&quot;), &quot;foo&quot;);</span>
<a href="#l27.113"></a><span id="l27.113" class="difflineminus">-</span>
<a href="#l27.114"></a><span id="l27.114" class="difflineminus">-  mc.keypress(mc.eid(&quot;searchInput&quot;), &quot;VK_RETURN&quot;, {});</span>
<a href="#l27.115"></a><span id="l27.115" class="difflineminus">-  wait_for_all_messages_to_load();</span>
<a href="#l27.116"></a><span id="l27.116" class="difflineminus">-</span>
<a href="#l27.117"></a><span id="l27.117" class="difflineminus">-  // - Click the &quot;Save Search as a Folder&quot; button</span>
<a href="#l27.118"></a><span id="l27.118" class="difflineminus">-  // This will create a virtual folder properties dialog...</span>
<a href="#l27.119"></a><span id="l27.119" class="difflineminus">-  // (label: &quot;New Saved Search Folder&quot;, source: virtualFolderProperties.xul</span>
<a href="#l27.120"></a><span id="l27.120" class="difflineminus">-  //  no windowtype, id: &quot;virtualFolderPropertiesDialog&quot;)</span>
<a href="#l27.121"></a><span id="l27.121" class="difflineminus">-  plan_for_modal_dialog(&quot;mailnews:virtualFolderProperties&quot;,</span>
<a href="#l27.122"></a><span id="l27.122" class="difflineminus">-                        subtest_save_search);</span>
<a href="#l27.123"></a><span id="l27.123" class="difflineminus">-  mc.e(&quot;searchInput&quot;).saveAsVirtualFolder.doCommand();</span>
<a href="#l27.124"></a><span id="l27.124" class="difflineminus">-  wait_for_modal_dialog(&quot;mailnews:virtualFolderProperties&quot;);</span>
<a href="#l27.125"></a><span id="l27.125" class="difflineminus">-}</span>
<a href="#l27.126"></a><span id="l27.126" class="difflineminus">-</span>
<a href="#l27.127"></a><span id="l27.127" class="difflineminus">-/**</span>
<a href="#l27.128"></a><span id="l27.128" class="difflineminus">- * Save the search, making sure that the &quot;subject OR from&quot; constraints are</span>
<a href="#l27.129"></a><span id="l27.129" class="difflineminus">- *  there.</span>
<a href="#l27.130"></a><span id="l27.130" class="difflineminus">- */</span>
<a href="#l27.131"></a><span id="l27.131" class="difflineminus">-function subtest_save_search(savc) {</span>
<a href="#l27.132"></a><span id="l27.132" class="difflineminus">-  // - make sure our constraint propagated</span>
<a href="#l27.133"></a><span id="l27.133" class="difflineminus">-  // this should be an &quot;OR&quot; constraint</span>
<a href="#l27.134"></a><span id="l27.134" class="difflineminus">-  savc.assertValue(savc.eid(&quot;booleanAndGroup&quot;), &quot;or&quot;);</span>
<a href="#l27.135"></a><span id="l27.135" class="difflineminus">-</span>
<a href="#l27.136"></a><span id="l27.136" class="difflineminus">-  // first constraint is on &quot;Subject&quot;=0 and should be &quot;foo&quot;</span>
<a href="#l27.137"></a><span id="l27.137" class="difflineminus">-  let searchAttr0 = savc.eid(&quot;searchAttr0&quot;);</span>
<a href="#l27.138"></a><span id="l27.138" class="difflineminus">-  savc.assertNode(searchAttr0);</span>
<a href="#l27.139"></a><span id="l27.139" class="difflineminus">-  savc.assertValue(searchAttr0, &quot;0&quot;);</span>
<a href="#l27.140"></a><span id="l27.140" class="difflineminus">-</span>
<a href="#l27.141"></a><span id="l27.141" class="difflineminus">-  let searchVal0 = savc.aid(&quot;searchVal0&quot;, {crazyDeck: 0});</span>
<a href="#l27.142"></a><span id="l27.142" class="difflineminus">-  savc.assertNode(searchVal0);</span>
<a href="#l27.143"></a><span id="l27.143" class="difflineminus">-  savc.assertValue(searchVal0, &quot;foo&quot;);</span>
<a href="#l27.144"></a><span id="l27.144" class="difflineminus">-</span>
<a href="#l27.145"></a><span id="l27.145" class="difflineminus">-  // second constraint is on &quot;From&quot;=1 and should be &quot;foo&quot; as well</span>
<a href="#l27.146"></a><span id="l27.146" class="difflineminus">-  let searchAttr1 = savc.eid(&quot;searchAttr1&quot;);</span>
<a href="#l27.147"></a><span id="l27.147" class="difflineminus">-  savc.assertNode(searchAttr1);</span>
<a href="#l27.148"></a><span id="l27.148" class="difflineminus">-  savc.assertValue(searchAttr1, &quot;1&quot;);</span>
<a href="#l27.149"></a><span id="l27.149" class="difflineminus">-</span>
<a href="#l27.150"></a><span id="l27.150" class="difflineminus">-  let searchVal1 = savc.aid(&quot;searchVal1&quot;, {crazyDeck: 0});</span>
<a href="#l27.151"></a><span id="l27.151" class="difflineminus">-  savc.assertNode(searchVal1);</span>
<a href="#l27.152"></a><span id="l27.152" class="difflineminus">-  savc.assertValue(searchVal1, &quot;foo&quot;);</span>
<a href="#l27.153"></a><span id="l27.153" class="difflineminus">-</span>
<a href="#l27.154"></a><span id="l27.154" class="difflineminus">-  // - Make sure the name mangling is as expected</span>
<a href="#l27.155"></a><span id="l27.155" class="difflineminus">-  savc.assertValue(savc.eid(&quot;name&quot;), &quot;QuickSearch-foo&quot;);</span>
<a href="#l27.156"></a><span id="l27.156" class="difflineminus">-</span>
<a href="#l27.157"></a><span id="l27.157" class="difflineminus">-  // - save it!</span>
<a href="#l27.158"></a><span id="l27.158" class="difflineminus">-  // this will close the dialog, which wait_for_modal_dialog is making sure</span>
<a href="#l27.159"></a><span id="l27.159" class="difflineminus">-  //  happens.</span>
<a href="#l27.160"></a><span id="l27.160" class="difflineminus">-  savc.window.onOK();</span>
<a href="#l27.161"></a><span id="l27.161" class="difflineminus">-}</span>
<a href="#l27.162"></a><span id="l27.162" class="difflineminus">-</span>
<a href="#l27.163"></a><span id="l27.163" class="difflineminus">-/**</span>
<a href="#l27.164"></a><span id="l27.164" class="difflineminus">- * Make sure the folder showed up with the right name, and that displaying it</span>
<a href="#l27.165"></a><span id="l27.165" class="difflineminus">- *  has the right contents.</span>
<a href="#l27.166"></a><span id="l27.166" class="difflineminus">- */</span>
<a href="#l27.167"></a><span id="l27.167" class="difflineminus">-function test_verify_saved_search() {</span>
<a href="#l27.168"></a><span id="l27.168" class="difflineminus">-  let savedFolder = folder.findSubFolder(&quot;QuickSearch-foo&quot;);</span>
<a href="#l27.169"></a><span id="l27.169" class="difflineminus">-  if (savedFolder == null)</span>
<a href="#l27.170"></a><span id="l27.170" class="difflineminus">-    throw new Error(&quot;Saved folder did not show up.&quot;);</span>
<a href="#l27.171"></a><span id="l27.171" class="difflineminus">-</span>
<a href="#l27.172"></a><span id="l27.172" class="difflineminus">-  be_in_folder(savedFolder);</span>
<a href="#l27.173"></a><span id="l27.173" class="difflineminus">-  assert_messages_in_view(setFoo);</span>
<a href="#l27.174"></a><span id="l27.174" class="difflineminus">-}</span>
<a href="#l27.175"></a><span id="l27.175" class="difflineminus">-</span>
<a href="#l27.176"></a><span id="l27.176" class="difflineminus">-/**</span>
<a href="#l27.177"></a><span id="l27.177" class="difflineminus">- * Test that when a new 3-pane window is opened from the original 3-pane, the</span>
<a href="#l27.178"></a><span id="l27.178" class="difflineminus">- * search mode is persisted.</span>
<a href="#l27.179"></a><span id="l27.179" class="difflineminus">- */</span>
<a href="#l27.180"></a><span id="l27.180" class="difflineminus">-function test_search_mode_persistence_new_3pane_from_original_3pane()</span>
<a href="#l27.181"></a><span id="l27.181" class="difflineminus">-{</span>
<a href="#l27.182"></a><span id="l27.182" class="difflineminus">-  plan_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l27.183"></a><span id="l27.183" class="difflineminus">-  mc.window.MsgOpenNewWindowForFolder(null, -1);</span>
<a href="#l27.184"></a><span id="l27.184" class="difflineminus">-  let mc2 = wait_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l27.185"></a><span id="l27.185" class="difflineminus">-</span>
<a href="#l27.186"></a><span id="l27.186" class="difflineminus">-  _assert_quick_search_mode(mc2,</span>
<a href="#l27.187"></a><span id="l27.187" class="difflineminus">-      QuickSearchConstants.kQuickSearchFromOrSubject.toString());</span>
<a href="#l27.188"></a><span id="l27.188" class="difflineminus">-</span>
<a href="#l27.189"></a><span id="l27.189" class="difflineminus">-  mc2.window.close();</span>
<a href="#l27.190"></a><span id="l27.190" class="difflineminus">-}</span>
<a href="#l27.191"></a><span id="l27.191" class="difflineminus">-</span>
<a href="#l27.192"></a><span id="l27.192" class="difflineminus">-/**</span>
<a href="#l27.193"></a><span id="l27.193" class="difflineminus">- * Test that the window.close() above doesn't cause session persistence to come</span>
<a href="#l27.194"></a><span id="l27.194" class="difflineminus">- * into play -- i.e. if we now change the search mode and open a window again,</span>
<a href="#l27.195"></a><span id="l27.195" class="difflineminus">- * the new window has the new search mode and not the old one.</span>
<a href="#l27.196"></a><span id="l27.196" class="difflineminus">- */</span>
<a href="#l27.197"></a><span id="l27.197" class="difflineminus">-function test_search_mode_persistence_new_3pane_from_original_3pane_again()</span>
<a href="#l27.198"></a><span id="l27.198" class="difflineminus">-{</span>
<a href="#l27.199"></a><span id="l27.199" class="difflineminus">-  mc.e(&quot;searchInput&quot;).searchMode =</span>
<a href="#l27.200"></a><span id="l27.200" class="difflineminus">-    QuickSearchConstants.kQuickSearchBody.toString();</span>
<a href="#l27.201"></a><span id="l27.201" class="difflineminus">-  plan_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l27.202"></a><span id="l27.202" class="difflineminus">-  mc.window.MsgOpenNewWindowForFolder(null, -1);</span>
<a href="#l27.203"></a><span id="l27.203" class="difflineminus">-  let mc2 = wait_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l27.204"></a><span id="l27.204" class="difflineminus">-</span>
<a href="#l27.205"></a><span id="l27.205" class="difflineminus">-  _assert_quick_search_mode(mc2,</span>
<a href="#l27.206"></a><span id="l27.206" class="difflineminus">-      QuickSearchConstants.kQuickSearchBody.toString());</span>
<a href="#l27.207"></a><span id="l27.207" class="difflineminus">-</span>
<a href="#l27.208"></a><span id="l27.208" class="difflineminus">-  mc2.window.close();</span>
<a href="#l27.209"></a><span id="l27.209" class="difflineminus">-}</span>
<a href="#l27.210"></a><span id="l27.210" class="difflineminus">-</span>
<a href="#l27.211"></a><span id="l27.211" class="difflineminus">-/**</span>
<a href="#l27.212"></a><span id="l27.212" class="difflineminus">- * Test that when a new 3-pane window is opened independently of the original</span>
<a href="#l27.213"></a><span id="l27.213" class="difflineminus">- * 3-pane, the search mode is persisted from the original 3-pane.</span>
<a href="#l27.214"></a><span id="l27.214" class="difflineminus">- */</span>
<a href="#l27.215"></a><span id="l27.215" class="difflineminus">-function test_search_mode_persistence_new_3pane_independently()</span>
<a href="#l27.216"></a><span id="l27.216" class="difflineminus">-{</span>
<a href="#l27.217"></a><span id="l27.217" class="difflineminus">-  mc.e(&quot;searchInput&quot;).searchMode =</span>
<a href="#l27.218"></a><span id="l27.218" class="difflineminus">-    QuickSearchConstants.kQuickSearchFromOrSubject.toString();</span>
<a href="#l27.219"></a><span id="l27.219" class="difflineminus">-  plan_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l27.220"></a><span id="l27.220" class="difflineminus">-  _open_3pane_window();</span>
<a href="#l27.221"></a><span id="l27.221" class="difflineminus">-  let mc2 = wait_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l27.222"></a><span id="l27.222" class="difflineminus">-</span>
<a href="#l27.223"></a><span id="l27.223" class="difflineminus">-  _assert_quick_search_mode(mc2,</span>
<a href="#l27.224"></a><span id="l27.224" class="difflineminus">-      QuickSearchConstants.kQuickSearchFromOrSubject.toString());</span>
<a href="#l27.225"></a><span id="l27.225" class="difflineminus">-</span>
<a href="#l27.226"></a><span id="l27.226" class="difflineminus">-  mc2.window.close();</span>
<a href="#l27.227"></a><span id="l27.227" class="difflineminus">-}</span>
<a href="#l27.228"></a><span id="l27.228" class="difflineminus">-</span>
<a href="#l27.229"></a><span id="l27.229" class="difflineminus">-/**</span>
<a href="#l27.230"></a><span id="l27.230" class="difflineminus">- * Test that the window.close() above doesn't cause session persistence to come</span>
<a href="#l27.231"></a><span id="l27.231" class="difflineminus">- * into play -- i.e. if we now change the search mode and open a window again,</span>
<a href="#l27.232"></a><span id="l27.232" class="difflineminus">- * the new window has the new search mode and not the old one.</span>
<a href="#l27.233"></a><span id="l27.233" class="difflineminus">- */</span>
<a href="#l27.234"></a><span id="l27.234" class="difflineminus">-function test_search_mode_persistence_new_3pane_independently_again()</span>
<a href="#l27.235"></a><span id="l27.235" class="difflineminus">-{</span>
<a href="#l27.236"></a><span id="l27.236" class="difflineminus">-  mc.e(&quot;searchInput&quot;).searchMode =</span>
<a href="#l27.237"></a><span id="l27.237" class="difflineminus">-    QuickSearchConstants.kQuickSearchBody.toString();</span>
<a href="#l27.238"></a><span id="l27.238" class="difflineminus">-  plan_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l27.239"></a><span id="l27.239" class="difflineminus">-  _open_3pane_window();</span>
<a href="#l27.240"></a><span id="l27.240" class="difflineminus">-  let mc2 = wait_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l27.241"></a><span id="l27.241" class="difflineminus">-</span>
<a href="#l27.242"></a><span id="l27.242" class="difflineminus">-  _assert_quick_search_mode(mc2,</span>
<a href="#l27.243"></a><span id="l27.243" class="difflineminus">-      QuickSearchConstants.kQuickSearchBody.toString());</span>
<a href="#l27.244"></a><span id="l27.244" class="difflineminus">-</span>
<a href="#l27.245"></a><span id="l27.245" class="difflineminus">-  mc2.window.close();</span>
<a href="#l27.246"></a><span id="l27.246" class="difflineminus">-}</span>
<a href="#l27.247"></a><span id="l27.247" class="difflineminus">-</span>
<a href="#l27.248"></a><span id="l27.248" class="difflineminus">-/**</span>
<a href="#l27.249"></a><span id="l27.249" class="difflineminus">- * Test that persistence works properly if the &quot;Subject, To or Cc&quot; filter is</span>
<a href="#l27.250"></a><span id="l27.250" class="difflineminus">- * selected.</span>
<a href="#l27.251"></a><span id="l27.251" class="difflineminus">- */</span>
<a href="#l27.252"></a><span id="l27.252" class="difflineminus">-function test_search_mode_persistence_subject_to_cc_filter()</span>
<a href="#l27.253"></a><span id="l27.253" class="difflineminus">-{</span>
<a href="#l27.254"></a><span id="l27.254" class="difflineminus">-  mc.e(&quot;searchInput&quot;).searchMode =</span>
<a href="#l27.255"></a><span id="l27.255" class="difflineminus">-    QuickSearchConstants.kQuickSearchRecipientOrSubject.toString();</span>
<a href="#l27.256"></a><span id="l27.256" class="difflineminus">-</span>
<a href="#l27.257"></a><span id="l27.257" class="difflineminus">-  // Make sure we have a different window open, so that we don't start shutting</span>
<a href="#l27.258"></a><span id="l27.258" class="difflineminus">-  // down just because the last window was closed.</span>
<a href="#l27.259"></a><span id="l27.259" class="difflineminus">-  let swc = open_search_window();</span>
<a href="#l27.260"></a><span id="l27.260" class="difflineminus">-</span>
<a href="#l27.261"></a><span id="l27.261" class="difflineminus">-  plan_for_window_close(mc);</span>
<a href="#l27.262"></a><span id="l27.262" class="difflineminus">-  mc.window.close();</span>
<a href="#l27.263"></a><span id="l27.263" class="difflineminus">-  wait_for_window_close();</span>
<a href="#l27.264"></a><span id="l27.264" class="difflineminus">-</span>
<a href="#l27.265"></a><span id="l27.265" class="difflineminus">-  // XXX we force the session store manager to think it's not initialized</span>
<a href="#l27.266"></a><span id="l27.266" class="difflineminus">-  // so that it'll load the session file and restore the state of the last</span>
<a href="#l27.267"></a><span id="l27.267" class="difflineminus">-  // open window 3pane window.</span>
<a href="#l27.268"></a><span id="l27.268" class="difflineminus">-  sessionStoreManager._initialized = false;</span>
<a href="#l27.269"></a><span id="l27.269" class="difflineminus">-</span>
<a href="#l27.270"></a><span id="l27.270" class="difflineminus">-  plan_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l27.271"></a><span id="l27.271" class="difflineminus">-  _open_3pane_window();</span>
<a href="#l27.272"></a><span id="l27.272" class="difflineminus">-  mc = wait_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l27.273"></a><span id="l27.273" class="difflineminus">-</span>
<a href="#l27.274"></a><span id="l27.274" class="difflineminus">-  // We don't need the search window any more</span>
<a href="#l27.275"></a><span id="l27.275" class="difflineminus">-  plan_for_window_close(swc);</span>
<a href="#l27.276"></a><span id="l27.276" class="difflineminus">-  swc.window.close();</span>
<a href="#l27.277"></a><span id="l27.277" class="difflineminus">-  wait_for_window_close();</span>
<a href="#l27.278"></a><span id="l27.278" class="difflineminus">-</span>
<a href="#l27.279"></a><span id="l27.279" class="difflineminus">-  _assert_quick_search_mode(mc,</span>
<a href="#l27.280"></a><span id="l27.280" class="difflineminus">-      QuickSearchConstants.kQuickSearchRecipientOrSubject.toString());</span>
<a href="#l27.281"></a><span id="l27.281" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mail/test/mozmill/mozmilltests.list</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mail/test/mozmill/mozmilltests.list</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -4,9 +4,10 @@ search-window</span>
<a href="#l28.4"></a><span id="l28.4"> cookies</span>
<a href="#l28.5"></a><span id="l28.5"> content-policy</span>
<a href="#l28.6"></a><span id="l28.6"> content-tabs</span>
<a href="#l28.7"></a><span id="l28.7"> message-header</span>
<a href="#l28.8"></a><span id="l28.8"> folder-pane</span>
<a href="#l28.9"></a><span id="l28.9"> session-store</span>
<a href="#l28.10"></a><span id="l28.10"> pref-window</span>
<a href="#l28.11"></a><span id="l28.11"> folder-tree-modes</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineplus">+quick-filter-bar</span>
<a href="#l28.13"></a><span id="l28.13"> migration</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1">new file mode 100644</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineminus">--- /dev/null</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineplus">+++ b/mail/test/mozmill/quick-filter-bar/test-display-issues.js</span>
<a href="#l29.4"></a><span id="l29.4" class="difflineat">@@ -0,0 +1,118 @@</span>
<a href="#l29.5"></a><span id="l29.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l29.6"></a><span id="l29.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l29.7"></a><span id="l29.7" class="difflineplus">+ *</span>
<a href="#l29.8"></a><span id="l29.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l29.9"></a><span id="l29.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l29.10"></a><span id="l29.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l29.11"></a><span id="l29.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineplus">+ *</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineplus">+ * License.</span>
<a href="#l29.17"></a><span id="l29.17" class="difflineplus">+ *</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l29.19"></a><span id="l29.19" class="difflineplus">+ *</span>
<a href="#l29.20"></a><span id="l29.20" class="difflineplus">+ * The Initial Developer of the Original Code is the Mozilla Foundation.</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2010</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineplus">+ *</span>
<a href="#l29.24"></a><span id="l29.24" class="difflineplus">+ * Contributor(s):</span>
<a href="#l29.25"></a><span id="l29.25" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l29.26"></a><span id="l29.26" class="difflineplus">+ *</span>
<a href="#l29.27"></a><span id="l29.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l29.28"></a><span id="l29.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l29.29"></a><span id="l29.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l29.30"></a><span id="l29.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l29.31"></a><span id="l29.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l29.35"></a><span id="l29.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l29.36"></a><span id="l29.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l29.37"></a><span id="l29.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l29.38"></a><span id="l29.38" class="difflineplus">+ *</span>
<a href="#l29.39"></a><span id="l29.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l29.40"></a><span id="l29.40" class="difflineplus">+</span>
<a href="#l29.41"></a><span id="l29.41" class="difflineplus">+/*</span>
<a href="#l29.42"></a><span id="l29.42" class="difflineplus">+ * Test things of a visual nature.</span>
<a href="#l29.43"></a><span id="l29.43" class="difflineplus">+ */</span>
<a href="#l29.44"></a><span id="l29.44" class="difflineplus">+</span>
<a href="#l29.45"></a><span id="l29.45" class="difflineplus">+var MODULE_NAME = 'test-keyboard-interface';</span>
<a href="#l29.46"></a><span id="l29.46" class="difflineplus">+</span>
<a href="#l29.47"></a><span id="l29.47" class="difflineplus">+const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l29.48"></a><span id="l29.48" class="difflineplus">+</span>
<a href="#l29.49"></a><span id="l29.49" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers',</span>
<a href="#l29.50"></a><span id="l29.50" class="difflineplus">+                       'quick-filter-bar-helper'];</span>
<a href="#l29.51"></a><span id="l29.51" class="difflineplus">+</span>
<a href="#l29.52"></a><span id="l29.52" class="difflineplus">+var folder;</span>
<a href="#l29.53"></a><span id="l29.53" class="difflineplus">+var setUnstarred, setStarred;</span>
<a href="#l29.54"></a><span id="l29.54" class="difflineplus">+</span>
<a href="#l29.55"></a><span id="l29.55" class="difflineplus">+function setupModule(module) {</span>
<a href="#l29.56"></a><span id="l29.56" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l29.57"></a><span id="l29.57" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l29.58"></a><span id="l29.58" class="difflineplus">+  let wh = collector.getModule('window-helpers');</span>
<a href="#l29.59"></a><span id="l29.59" class="difflineplus">+  wh.installInto(module);</span>
<a href="#l29.60"></a><span id="l29.60" class="difflineplus">+  let qfb = collector.getModule('quick-filter-bar-helper');</span>
<a href="#l29.61"></a><span id="l29.61" class="difflineplus">+  qfb.installInto(module);</span>
<a href="#l29.62"></a><span id="l29.62" class="difflineplus">+</span>
<a href="#l29.63"></a><span id="l29.63" class="difflineplus">+  folder = create_folder(&quot;QuickFilterBarDisplayIssues&quot;);</span>
<a href="#l29.64"></a><span id="l29.64" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l29.65"></a><span id="l29.65" class="difflineplus">+}</span>
<a href="#l29.66"></a><span id="l29.66" class="difflineplus">+</span>
<a href="#l29.67"></a><span id="l29.67" class="difflineplus">+/**</span>
<a href="#l29.68"></a><span id="l29.68" class="difflineplus">+ * When the window gets too narrow the collapsible button labels need to get</span>
<a href="#l29.69"></a><span id="l29.69" class="difflineplus">+ *  gone.  Then they need to come back when we get large enough again.</span>
<a href="#l29.70"></a><span id="l29.70" class="difflineplus">+ *</span>
<a href="#l29.71"></a><span id="l29.71" class="difflineplus">+ * Because the mozmill window sizing is weird and confusing, we force our size</span>
<a href="#l29.72"></a><span id="l29.72" class="difflineplus">+ *  in both cases but do save/restore around our test.</span>
<a href="#l29.73"></a><span id="l29.73" class="difflineplus">+ */</span>
<a href="#l29.74"></a><span id="l29.74" class="difflineplus">+function test_buttons_collapse_and_expand() {</span>
<a href="#l29.75"></a><span id="l29.75" class="difflineplus">+  assert_quick_filter_bar_visible(true); // precondition</span>
<a href="#l29.76"></a><span id="l29.76" class="difflineplus">+</span>
<a href="#l29.77"></a><span id="l29.77" class="difflineplus">+  try {</span>
<a href="#l29.78"></a><span id="l29.78" class="difflineplus">+    let qfbCollapsy = mc.e(&quot;quick-filter-bar-collapsible-buttons&quot;);</span>
<a href="#l29.79"></a><span id="l29.79" class="difflineplus">+    let qfbExemplarButton = mc.e(&quot;qfb-unread&quot;); // (arbitrary labeled button)</span>
<a href="#l29.80"></a><span id="l29.80" class="difflineplus">+    let qfbExemplarLabel = mc.window</span>
<a href="#l29.81"></a><span id="l29.81" class="difflineplus">+                             .document.getAnonymousNodes(qfbExemplarButton)[1];</span>
<a href="#l29.82"></a><span id="l29.82" class="difflineplus">+</span>
<a href="#l29.83"></a><span id="l29.83" class="difflineplus">+    function assertCollapsed() {</span>
<a href="#l29.84"></a><span id="l29.84" class="difflineplus">+      // The bar should be shrunken and the button should be the same size as its</span>
<a href="#l29.85"></a><span id="l29.85" class="difflineplus">+      // image!</span>
<a href="#l29.86"></a><span id="l29.86" class="difflineplus">+      if (qfbCollapsy.getAttribute(&quot;shrink&quot;) != &quot;true&quot;)</span>
<a href="#l29.87"></a><span id="l29.87" class="difflineplus">+        throw new Error(&quot;The collapsy bar should be shrunk!&quot;);</span>
<a href="#l29.88"></a><span id="l29.88" class="difflineplus">+      if (qfbExemplarLabel.clientWidth != 0)</span>
<a href="#l29.89"></a><span id="l29.89" class="difflineplus">+        throw new Error(&quot;The exemplar label should be collapsed!&quot;);</span>
<a href="#l29.90"></a><span id="l29.90" class="difflineplus">+    }</span>
<a href="#l29.91"></a><span id="l29.91" class="difflineplus">+    function assertExpanded() {</span>
<a href="#l29.92"></a><span id="l29.92" class="difflineplus">+      // The bar should not be shrunken and the button should be smaller than its</span>
<a href="#l29.93"></a><span id="l29.93" class="difflineplus">+      // label!</span>
<a href="#l29.94"></a><span id="l29.94" class="difflineplus">+      if (qfbCollapsy.hasAttribute(&quot;shrink&quot;))</span>
<a href="#l29.95"></a><span id="l29.95" class="difflineplus">+        throw new Error(&quot;The collapsy bar should not be shrunk!&quot;);</span>
<a href="#l29.96"></a><span id="l29.96" class="difflineplus">+      if (qfbExemplarLabel.clientWidth == 0)</span>
<a href="#l29.97"></a><span id="l29.97" class="difflineplus">+        throw new Error(&quot;The exemplar label should not be collapsed!&quot;);</span>
<a href="#l29.98"></a><span id="l29.98" class="difflineplus">+    }</span>
<a href="#l29.99"></a><span id="l29.99" class="difflineplus">+</span>
<a href="#l29.100"></a><span id="l29.100" class="difflineplus">+    // -- GIANT!</span>
<a href="#l29.101"></a><span id="l29.101" class="difflineplus">+    mc.window.resizeTo(1200, 600);</span>
<a href="#l29.102"></a><span id="l29.102" class="difflineplus">+    // spin the event loop once</span>
<a href="#l29.103"></a><span id="l29.103" class="difflineplus">+    mc.sleep(0);</span>
<a href="#l29.104"></a><span id="l29.104" class="difflineplus">+    assertExpanded();</span>
<a href="#l29.105"></a><span id="l29.105" class="difflineplus">+</span>
<a href="#l29.106"></a><span id="l29.106" class="difflineplus">+    // -- tiny.</span>
<a href="#l29.107"></a><span id="l29.107" class="difflineplus">+    mc.window.resizeTo(600, 600);</span>
<a href="#l29.108"></a><span id="l29.108" class="difflineplus">+    // spin the event loop once</span>
<a href="#l29.109"></a><span id="l29.109" class="difflineplus">+    mc.sleep(0);</span>
<a href="#l29.110"></a><span id="l29.110" class="difflineplus">+    assertCollapsed();</span>
<a href="#l29.111"></a><span id="l29.111" class="difflineplus">+</span>
<a href="#l29.112"></a><span id="l29.112" class="difflineplus">+    // -- GIANT again!</span>
<a href="#l29.113"></a><span id="l29.113" class="difflineplus">+    mc.window.resizeTo(1200, 600);</span>
<a href="#l29.114"></a><span id="l29.114" class="difflineplus">+    // spin the event loop once</span>
<a href="#l29.115"></a><span id="l29.115" class="difflineplus">+    mc.sleep(0);</span>
<a href="#l29.116"></a><span id="l29.116" class="difflineplus">+    assertExpanded();</span>
<a href="#l29.117"></a><span id="l29.117" class="difflineplus">+  }</span>
<a href="#l29.118"></a><span id="l29.118" class="difflineplus">+  finally {</span>
<a href="#l29.119"></a><span id="l29.119" class="difflineplus">+    // restore window to nominal dimensions; saving was not working out</span>
<a href="#l29.120"></a><span id="l29.120" class="difflineplus">+    mc.window.resizeTo(1024, 768);</span>
<a href="#l29.121"></a><span id="l29.121" class="difflineplus">+  }</span>
<a href="#l29.122"></a><span id="l29.122" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1">new file mode 100644</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineminus">--- /dev/null</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineplus">+++ b/mail/test/mozmill/quick-filter-bar/test-filter-logic.js</span>
<a href="#l30.4"></a><span id="l30.4" class="difflineat">@@ -0,0 +1,344 @@</span>
<a href="#l30.5"></a><span id="l30.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l30.6"></a><span id="l30.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l30.7"></a><span id="l30.7" class="difflineplus">+ *</span>
<a href="#l30.8"></a><span id="l30.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l30.9"></a><span id="l30.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l30.10"></a><span id="l30.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l30.11"></a><span id="l30.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineplus">+ *</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineplus">+ * License.</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineplus">+ *</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineplus">+ *</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineplus">+ * The Initial Developer of the Original Code is the Mozilla Foundation.</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2010</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineplus">+ *</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineplus">+ * Contributor(s):</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineplus">+ *</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l30.36"></a><span id="l30.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l30.37"></a><span id="l30.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l30.38"></a><span id="l30.38" class="difflineplus">+ *</span>
<a href="#l30.39"></a><span id="l30.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l30.40"></a><span id="l30.40" class="difflineplus">+</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineplus">+/*</span>
<a href="#l30.42"></a><span id="l30.42" class="difflineplus">+ * Verify that we are constructing the filters that we expect and that they</span>
<a href="#l30.43"></a><span id="l30.43" class="difflineplus">+ * are hooked up to the right buttons.</span>
<a href="#l30.44"></a><span id="l30.44" class="difflineplus">+ */</span>
<a href="#l30.45"></a><span id="l30.45" class="difflineplus">+</span>
<a href="#l30.46"></a><span id="l30.46" class="difflineplus">+var MODULE_NAME = 'test-filter-logic';</span>
<a href="#l30.47"></a><span id="l30.47" class="difflineplus">+</span>
<a href="#l30.48"></a><span id="l30.48" class="difflineplus">+const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineplus">+</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers',</span>
<a href="#l30.51"></a><span id="l30.51" class="difflineplus">+                       'quick-filter-bar-helper'];</span>
<a href="#l30.52"></a><span id="l30.52" class="difflineplus">+</span>
<a href="#l30.53"></a><span id="l30.53" class="difflineplus">+function setupModule(module) {</span>
<a href="#l30.54"></a><span id="l30.54" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l30.55"></a><span id="l30.55" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l30.56"></a><span id="l30.56" class="difflineplus">+  let wh = collector.getModule('window-helpers');</span>
<a href="#l30.57"></a><span id="l30.57" class="difflineplus">+  wh.installInto(module);</span>
<a href="#l30.58"></a><span id="l30.58" class="difflineplus">+  let qfb = collector.getModule('quick-filter-bar-helper');</span>
<a href="#l30.59"></a><span id="l30.59" class="difflineplus">+  qfb.installInto(module);</span>
<a href="#l30.60"></a><span id="l30.60" class="difflineplus">+}</span>
<a href="#l30.61"></a><span id="l30.61" class="difflineplus">+</span>
<a href="#l30.62"></a><span id="l30.62" class="difflineplus">+function test_filter_unread() {</span>
<a href="#l30.63"></a><span id="l30.63" class="difflineplus">+  let folder = create_folder(&quot;QuickFilterBarFilterUnread&quot;);</span>
<a href="#l30.64"></a><span id="l30.64" class="difflineplus">+  let [unread, read] = make_new_sets_in_folder(folder,</span>
<a href="#l30.65"></a><span id="l30.65" class="difflineplus">+    [{count: 1}, {count: 1}]);</span>
<a href="#l30.66"></a><span id="l30.66" class="difflineplus">+  read.setRead(true);</span>
<a href="#l30.67"></a><span id="l30.67" class="difflineplus">+</span>
<a href="#l30.68"></a><span id="l30.68" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l30.69"></a><span id="l30.69" class="difflineplus">+  toggle_boolean_constraints(&quot;unread&quot;);</span>
<a href="#l30.70"></a><span id="l30.70" class="difflineplus">+  assert_messages_in_view(unread);</span>
<a href="#l30.71"></a><span id="l30.71" class="difflineplus">+}</span>
<a href="#l30.72"></a><span id="l30.72" class="difflineplus">+</span>
<a href="#l30.73"></a><span id="l30.73" class="difflineplus">+function test_filter_starred() {</span>
<a href="#l30.74"></a><span id="l30.74" class="difflineplus">+  let folder = create_folder(&quot;QuickFilterBarFilterStarred&quot;);</span>
<a href="#l30.75"></a><span id="l30.75" class="difflineplus">+  let [unstarred, starred] = make_new_sets_in_folder(folder,</span>
<a href="#l30.76"></a><span id="l30.76" class="difflineplus">+    [{count: 1}, {count: 1}]);</span>
<a href="#l30.77"></a><span id="l30.77" class="difflineplus">+  starred.setStarred(true);</span>
<a href="#l30.78"></a><span id="l30.78" class="difflineplus">+</span>
<a href="#l30.79"></a><span id="l30.79" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l30.80"></a><span id="l30.80" class="difflineplus">+  toggle_boolean_constraints(&quot;starred&quot;);</span>
<a href="#l30.81"></a><span id="l30.81" class="difflineplus">+  assert_messages_in_view(starred);</span>
<a href="#l30.82"></a><span id="l30.82" class="difflineplus">+}</span>
<a href="#l30.83"></a><span id="l30.83" class="difflineplus">+</span>
<a href="#l30.84"></a><span id="l30.84" class="difflineplus">+function test_filter_simple_intersection_unread_and_starred() {</span>
<a href="#l30.85"></a><span id="l30.85" class="difflineplus">+  let folder = create_folder(&quot;QuickFilterBarFilterUnreadAndStarred&quot;);</span>
<a href="#l30.86"></a><span id="l30.86" class="difflineplus">+  let [unreadUnstarred, readUnstarred, unreadStarred, readStarred] =</span>
<a href="#l30.87"></a><span id="l30.87" class="difflineplus">+    make_new_sets_in_folder(folder,</span>
<a href="#l30.88"></a><span id="l30.88" class="difflineplus">+      [{count: 1}, {count: 1}, {count: 1}, {count: 1}]);</span>
<a href="#l30.89"></a><span id="l30.89" class="difflineplus">+  readUnstarred.setRead(true);</span>
<a href="#l30.90"></a><span id="l30.90" class="difflineplus">+  unreadStarred.setStarred(true);</span>
<a href="#l30.91"></a><span id="l30.91" class="difflineplus">+  readStarred.setRead(true);</span>
<a href="#l30.92"></a><span id="l30.92" class="difflineplus">+  readStarred.setStarred(true);</span>
<a href="#l30.93"></a><span id="l30.93" class="difflineplus">+</span>
<a href="#l30.94"></a><span id="l30.94" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l30.95"></a><span id="l30.95" class="difflineplus">+  toggle_boolean_constraints(&quot;unread&quot;, &quot;starred&quot;);</span>
<a href="#l30.96"></a><span id="l30.96" class="difflineplus">+</span>
<a href="#l30.97"></a><span id="l30.97" class="difflineplus">+  assert_messages_in_view(unreadStarred);</span>
<a href="#l30.98"></a><span id="l30.98" class="difflineplus">+}</span>
<a href="#l30.99"></a><span id="l30.99" class="difflineplus">+</span>
<a href="#l30.100"></a><span id="l30.100" class="difflineplus">+function test_filter_attachments() {</span>
<a href="#l30.101"></a><span id="l30.101" class="difflineplus">+  let attachSetDef = {</span>
<a href="#l30.102"></a><span id="l30.102" class="difflineplus">+    count: 1,</span>
<a href="#l30.103"></a><span id="l30.103" class="difflineplus">+    attachments: [{filename: 'foo.png',</span>
<a href="#l30.104"></a><span id="l30.104" class="difflineplus">+                   contentType: 'image/png',</span>
<a href="#l30.105"></a><span id="l30.105" class="difflineplus">+                   encoding: 'base64', charset: null,</span>
<a href="#l30.106"></a><span id="l30.106" class="difflineplus">+                   body: 'YWJj\n', format: null}],</span>
<a href="#l30.107"></a><span id="l30.107" class="difflineplus">+  };</span>
<a href="#l30.108"></a><span id="l30.108" class="difflineplus">+  let noAttachSetDef = {</span>
<a href="#l30.109"></a><span id="l30.109" class="difflineplus">+    count: 1,</span>
<a href="#l30.110"></a><span id="l30.110" class="difflineplus">+  };</span>
<a href="#l30.111"></a><span id="l30.111" class="difflineplus">+</span>
<a href="#l30.112"></a><span id="l30.112" class="difflineplus">+</span>
<a href="#l30.113"></a><span id="l30.113" class="difflineplus">+  let folder = create_folder(&quot;QuickFilterBarFilterAttachments&quot;);</span>
<a href="#l30.114"></a><span id="l30.114" class="difflineplus">+  let [setNoAttach, setAttach] = make_new_sets_in_folder(folder,</span>
<a href="#l30.115"></a><span id="l30.115" class="difflineplus">+    [noAttachSetDef, attachSetDef]);</span>
<a href="#l30.116"></a><span id="l30.116" class="difflineplus">+</span>
<a href="#l30.117"></a><span id="l30.117" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l30.118"></a><span id="l30.118" class="difflineplus">+  toggle_boolean_constraints(&quot;attachments&quot;);</span>
<a href="#l30.119"></a><span id="l30.119" class="difflineplus">+</span>
<a href="#l30.120"></a><span id="l30.120" class="difflineplus">+  assert_messages_in_view(setAttach);</span>
<a href="#l30.121"></a><span id="l30.121" class="difflineplus">+}</span>
<a href="#l30.122"></a><span id="l30.122" class="difflineplus">+</span>
<a href="#l30.123"></a><span id="l30.123" class="difflineplus">+/**</span>
<a href="#l30.124"></a><span id="l30.124" class="difflineplus">+ * Create a card for the given e-mail address, adding it to the first address</span>
<a href="#l30.125"></a><span id="l30.125" class="difflineplus">+ * book we can find.</span>
<a href="#l30.126"></a><span id="l30.126" class="difflineplus">+ */</span>
<a href="#l30.127"></a><span id="l30.127" class="difflineplus">+function add_email_to_address_book(aEmailAddr) {</span>
<a href="#l30.128"></a><span id="l30.128" class="difflineplus">+  let card = Cc[&quot;@mozilla.org/addressbook/cardproperty;1&quot;]</span>
<a href="#l30.129"></a><span id="l30.129" class="difflineplus">+               .createInstance(Ci.nsIAbCard);</span>
<a href="#l30.130"></a><span id="l30.130" class="difflineplus">+  card.primaryEmail = aEmailAddr;</span>
<a href="#l30.131"></a><span id="l30.131" class="difflineplus">+</span>
<a href="#l30.132"></a><span id="l30.132" class="difflineplus">+  let enumerator = Cc[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l30.133"></a><span id="l30.133" class="difflineplus">+                     .getService(Ci.nsIAbManager)</span>
<a href="#l30.134"></a><span id="l30.134" class="difflineplus">+                     .directories;</span>
<a href="#l30.135"></a><span id="l30.135" class="difflineplus">+  while (enumerator.hasMoreElements()) {</span>
<a href="#l30.136"></a><span id="l30.136" class="difflineplus">+    let addrbook = enumerator.getNext();</span>
<a href="#l30.137"></a><span id="l30.137" class="difflineplus">+    if (addrbook instanceof Components.interfaces.nsIAbMDBDirectory &amp;&amp;</span>
<a href="#l30.138"></a><span id="l30.138" class="difflineplus">+        addrbook instanceof Components.interfaces.nsIAbDirectory) {</span>
<a href="#l30.139"></a><span id="l30.139" class="difflineplus">+      addrbook.addCard(card);</span>
<a href="#l30.140"></a><span id="l30.140" class="difflineplus">+      return;</span>
<a href="#l30.141"></a><span id="l30.141" class="difflineplus">+    }</span>
<a href="#l30.142"></a><span id="l30.142" class="difflineplus">+  }</span>
<a href="#l30.143"></a><span id="l30.143" class="difflineplus">+</span>
<a href="#l30.144"></a><span id="l30.144" class="difflineplus">+  throw new Error(&quot;Unable to find any suitable address book.&quot;);</span>
<a href="#l30.145"></a><span id="l30.145" class="difflineplus">+}</span>
<a href="#l30.146"></a><span id="l30.146" class="difflineplus">+</span>
<a href="#l30.147"></a><span id="l30.147" class="difflineplus">+function test_filter_in_address_book() {</span>
<a href="#l30.148"></a><span id="l30.148" class="difflineplus">+  let bookSetDef = {</span>
<a href="#l30.149"></a><span id="l30.149" class="difflineplus">+    from: [&quot;Qbert Q Qbington&quot;, &quot;q@q.q&quot;],</span>
<a href="#l30.150"></a><span id="l30.150" class="difflineplus">+    count: 1</span>
<a href="#l30.151"></a><span id="l30.151" class="difflineplus">+  };</span>
<a href="#l30.152"></a><span id="l30.152" class="difflineplus">+  add_email_to_address_book(bookSetDef.from[1]);</span>
<a href="#l30.153"></a><span id="l30.153" class="difflineplus">+  let folder = create_folder(&quot;MesssageFilterBarInAddressBook&quot;);</span>
<a href="#l30.154"></a><span id="l30.154" class="difflineplus">+  let [setBook, setNoBook] = make_new_sets_in_folder(folder,</span>
<a href="#l30.155"></a><span id="l30.155" class="difflineplus">+                               [bookSetDef, {count: 1}]);</span>
<a href="#l30.156"></a><span id="l30.156" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l30.157"></a><span id="l30.157" class="difflineplus">+  toggle_boolean_constraints(&quot;addrbook&quot;);</span>
<a href="#l30.158"></a><span id="l30.158" class="difflineplus">+  assert_messages_in_view(setBook);</span>
<a href="#l30.159"></a><span id="l30.159" class="difflineplus">+}</span>
<a href="#l30.160"></a><span id="l30.160" class="difflineplus">+</span>
<a href="#l30.161"></a><span id="l30.161" class="difflineplus">+function test_filter_tags() {</span>
<a href="#l30.162"></a><span id="l30.162" class="difflineplus">+  let folder = create_folder(&quot;QuickFilterBarTags&quot;);</span>
<a href="#l30.163"></a><span id="l30.163" class="difflineplus">+  const tagA = &quot;$label1&quot;, tagB = &quot;$label2&quot;, tagC = &quot;$label3&quot;;</span>
<a href="#l30.164"></a><span id="l30.164" class="difflineplus">+  let [setNoTag, setTagA, setTagB, setTagAB, setTagC] = make_new_sets_in_folder(</span>
<a href="#l30.165"></a><span id="l30.165" class="difflineplus">+    folder,</span>
<a href="#l30.166"></a><span id="l30.166" class="difflineplus">+    [{count: 1}, {count: 1}, {count: 1}, {count: 1}, {count: 1}]);</span>
<a href="#l30.167"></a><span id="l30.167" class="difflineplus">+  setTagA.addTag(tagA);</span>
<a href="#l30.168"></a><span id="l30.168" class="difflineplus">+  setTagB.addTag(tagB);</span>
<a href="#l30.169"></a><span id="l30.169" class="difflineplus">+  setTagAB.addTag(tagA);</span>
<a href="#l30.170"></a><span id="l30.170" class="difflineplus">+  setTagAB.addTag(tagB);</span>
<a href="#l30.171"></a><span id="l30.171" class="difflineplus">+  setTagC.addTag(tagC);</span>
<a href="#l30.172"></a><span id="l30.172" class="difflineplus">+</span>
<a href="#l30.173"></a><span id="l30.173" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l30.174"></a><span id="l30.174" class="difflineplus">+  toggle_boolean_constraints(&quot;tags&quot;); // must have a tag</span>
<a href="#l30.175"></a><span id="l30.175" class="difflineplus">+  assert_messages_in_view([setTagA, setTagB, setTagAB, setTagC]);</span>
<a href="#l30.176"></a><span id="l30.176" class="difflineplus">+</span>
<a href="#l30.177"></a><span id="l30.177" class="difflineplus">+  toggle_tag_constraints(tagA); // must have tag A</span>
<a href="#l30.178"></a><span id="l30.178" class="difflineplus">+  assert_messages_in_view([setTagA, setTagAB]);</span>
<a href="#l30.179"></a><span id="l30.179" class="difflineplus">+</span>
<a href="#l30.180"></a><span id="l30.180" class="difflineplus">+  toggle_tag_constraints(tagB); // must have tag A OR tag B</span>
<a href="#l30.181"></a><span id="l30.181" class="difflineplus">+  assert_messages_in_view([setTagA, setTagB, setTagAB]);</span>
<a href="#l30.182"></a><span id="l30.182" class="difflineplus">+</span>
<a href="#l30.183"></a><span id="l30.183" class="difflineplus">+  toggle_tag_constraints(tagA); // must have tag B</span>
<a href="#l30.184"></a><span id="l30.184" class="difflineplus">+  assert_messages_in_view([setTagB, setTagAB]);</span>
<a href="#l30.185"></a><span id="l30.185" class="difflineplus">+</span>
<a href="#l30.186"></a><span id="l30.186" class="difflineplus">+  toggle_tag_constraints(tagB); // have have a tag</span>
<a href="#l30.187"></a><span id="l30.187" class="difflineplus">+  assert_messages_in_view([setTagA, setTagB, setTagAB, setTagC]);</span>
<a href="#l30.188"></a><span id="l30.188" class="difflineplus">+</span>
<a href="#l30.189"></a><span id="l30.189" class="difflineplus">+  toggle_boolean_constraints(&quot;tags&quot;); // no constraints</span>
<a href="#l30.190"></a><span id="l30.190" class="difflineplus">+  assert_messages_in_view([setNoTag, setTagA, setTagB, setTagAB, setTagC]);</span>
<a href="#l30.191"></a><span id="l30.191" class="difflineplus">+</span>
<a href="#l30.192"></a><span id="l30.192" class="difflineplus">+  // If we have filtered to a specific tag and we disable the tag filter</span>
<a href="#l30.193"></a><span id="l30.193" class="difflineplus">+  // entirely, make sure that when we turn it back on we are just back to &quot;any</span>
<a href="#l30.194"></a><span id="l30.194" class="difflineplus">+  // tag&quot;.</span>
<a href="#l30.195"></a><span id="l30.195" class="difflineplus">+  toggle_boolean_constraints(&quot;tags&quot;);</span>
<a href="#l30.196"></a><span id="l30.196" class="difflineplus">+  toggle_tag_constraints(tagC);</span>
<a href="#l30.197"></a><span id="l30.197" class="difflineplus">+  assert_messages_in_view(setTagC);</span>
<a href="#l30.198"></a><span id="l30.198" class="difflineplus">+</span>
<a href="#l30.199"></a><span id="l30.199" class="difflineplus">+  toggle_boolean_constraints(&quot;tags&quot;); // no constraints</span>
<a href="#l30.200"></a><span id="l30.200" class="difflineplus">+  toggle_boolean_constraints(&quot;tags&quot;); // should be any tag (not tagC!)</span>
<a href="#l30.201"></a><span id="l30.201" class="difflineplus">+  assert_messages_in_view([setTagA, setTagB, setTagAB, setTagC]);</span>
<a href="#l30.202"></a><span id="l30.202" class="difflineplus">+}</span>
<a href="#l30.203"></a><span id="l30.203" class="difflineplus">+</span>
<a href="#l30.204"></a><span id="l30.204" class="difflineplus">+function test_filter_text_single_word_and_predicates() {</span>
<a href="#l30.205"></a><span id="l30.205" class="difflineplus">+  let folder = create_folder(&quot;QuickFilterBarTextSingleWord&quot;);</span>
<a href="#l30.206"></a><span id="l30.206" class="difflineplus">+  let whoFoo = [&quot;zabba&quot;, &quot;foo@madeup.nul&quot;];</span>
<a href="#l30.207"></a><span id="l30.207" class="difflineplus">+  let [setInert, setSenderFoo, setRecipientsFoo, setSubjectFoo, setBodyFoo] =</span>
<a href="#l30.208"></a><span id="l30.208" class="difflineplus">+    make_new_sets_in_folder(folder, [</span>
<a href="#l30.209"></a><span id="l30.209" class="difflineplus">+      {count: 1}, {count:1, from: whoFoo}, {count: 1, to: [whoFoo]},</span>
<a href="#l30.210"></a><span id="l30.210" class="difflineplus">+      {count: 1, subject: &quot;foo&quot;}, {count: 1, body: {body: &quot;foo&quot;}}]);</span>
<a href="#l30.211"></a><span id="l30.211" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l30.212"></a><span id="l30.212" class="difflineplus">+</span>
<a href="#l30.213"></a><span id="l30.213" class="difflineplus">+  // by default, sender/recipients/subject are selected</span>
<a href="#l30.214"></a><span id="l30.214" class="difflineplus">+  assert_text_constraints_checked(&quot;sender&quot;, &quot;recipients&quot;, &quot;subject&quot;);</span>
<a href="#l30.215"></a><span id="l30.215" class="difflineplus">+</span>
<a href="#l30.216"></a><span id="l30.216" class="difflineplus">+  // con defaults, por favor</span>
<a href="#l30.217"></a><span id="l30.217" class="difflineplus">+  set_filter_text(&quot;foo&quot;);</span>
<a href="#l30.218"></a><span id="l30.218" class="difflineplus">+  assert_messages_in_view([setSenderFoo, setRecipientsFoo, setSubjectFoo]);</span>
<a href="#l30.219"></a><span id="l30.219" class="difflineplus">+  // note: we sequence the changes in the list so there is always at least one</span>
<a href="#l30.220"></a><span id="l30.220" class="difflineplus">+  //  dude selected.  selecting down to nothing has potential UI implications</span>
<a href="#l30.221"></a><span id="l30.221" class="difflineplus">+  //  we don't want this test to get affected by.</span>
<a href="#l30.222"></a><span id="l30.222" class="difflineplus">+  // sender only</span>
<a href="#l30.223"></a><span id="l30.223" class="difflineplus">+  toggle_text_constraints(&quot;recipients&quot;, &quot;subject&quot;);</span>
<a href="#l30.224"></a><span id="l30.224" class="difflineplus">+  assert_messages_in_view(setSenderFoo);</span>
<a href="#l30.225"></a><span id="l30.225" class="difflineplus">+  // recipients only</span>
<a href="#l30.226"></a><span id="l30.226" class="difflineplus">+  toggle_text_constraints(&quot;recipients&quot;, &quot;sender&quot;);</span>
<a href="#l30.227"></a><span id="l30.227" class="difflineplus">+  assert_messages_in_view(setRecipientsFoo);</span>
<a href="#l30.228"></a><span id="l30.228" class="difflineplus">+  // subject only</span>
<a href="#l30.229"></a><span id="l30.229" class="difflineplus">+  toggle_text_constraints(&quot;subject&quot;, &quot;recipients&quot;);</span>
<a href="#l30.230"></a><span id="l30.230" class="difflineplus">+  assert_messages_in_view(setSubjectFoo);</span>
<a href="#l30.231"></a><span id="l30.231" class="difflineplus">+  // body only</span>
<a href="#l30.232"></a><span id="l30.232" class="difflineplus">+  toggle_text_constraints(&quot;body&quot;, &quot;subject&quot;);</span>
<a href="#l30.233"></a><span id="l30.233" class="difflineplus">+  assert_messages_in_view(setBodyFoo);</span>
<a href="#l30.234"></a><span id="l30.234" class="difflineplus">+  // everybody</span>
<a href="#l30.235"></a><span id="l30.235" class="difflineplus">+  toggle_text_constraints(&quot;sender&quot;, &quot;recipients&quot;, &quot;subject&quot;);</span>
<a href="#l30.236"></a><span id="l30.236" class="difflineplus">+  assert_messages_in_view([setSenderFoo, setRecipientsFoo, setSubjectFoo,</span>
<a href="#l30.237"></a><span id="l30.237" class="difflineplus">+                          setBodyFoo]);</span>
<a href="#l30.238"></a><span id="l30.238" class="difflineplus">+</span>
<a href="#l30.239"></a><span id="l30.239" class="difflineplus">+  // sanity check non-matching</span>
<a href="#l30.240"></a><span id="l30.240" class="difflineplus">+  set_filter_text(&quot;notgonnamatchevercauseisayso&quot;);</span>
<a href="#l30.241"></a><span id="l30.241" class="difflineplus">+  assert_messages_in_view([]);</span>
<a href="#l30.242"></a><span id="l30.242" class="difflineplus">+  // disable body, still should get nothing</span>
<a href="#l30.243"></a><span id="l30.243" class="difflineplus">+  toggle_text_constraints(&quot;body&quot;);</span>
<a href="#l30.244"></a><span id="l30.244" class="difflineplus">+  assert_messages_in_view([]);</span>
<a href="#l30.245"></a><span id="l30.245" class="difflineplus">+</span>
<a href="#l30.246"></a><span id="l30.246" class="difflineplus">+  // (we are leaving with the defaults once again active)</span>
<a href="#l30.247"></a><span id="l30.247" class="difflineplus">+  assert_text_constraints_checked(&quot;sender&quot;, &quot;recipients&quot;, &quot;subject&quot;);</span>
<a href="#l30.248"></a><span id="l30.248" class="difflineplus">+}</span>
<a href="#l30.249"></a><span id="l30.249" class="difflineplus">+</span>
<a href="#l30.250"></a><span id="l30.250" class="difflineplus">+/**</span>
<a href="#l30.251"></a><span id="l30.251" class="difflineplus">+ * Verify that the multi-word logic is actually splitting the words into</span>
<a href="#l30.252"></a><span id="l30.252" class="difflineplus">+ *  different terms and that the terms can match in different predicates.</span>
<a href="#l30.253"></a><span id="l30.253" class="difflineplus">+ *  This means that given &quot;foo bar&quot; we should be able to match &quot;bar foo&quot; in</span>
<a href="#l30.254"></a><span id="l30.254" class="difflineplus">+ *  a subject and &quot;foo&quot; in the sender and &quot;bar&quot; in the recipient.  And that</span>
<a href="#l30.255"></a><span id="l30.255" class="difflineplus">+ *  constitutes sufficient positive coverage, although we also want to make</span>
<a href="#l30.256"></a><span id="l30.256" class="difflineplus">+ *  sure that just a single term match is insufficient.</span>
<a href="#l30.257"></a><span id="l30.257" class="difflineplus">+ */</span>
<a href="#l30.258"></a><span id="l30.258" class="difflineplus">+function test_filter_text_multi_word() {</span>
<a href="#l30.259"></a><span id="l30.259" class="difflineplus">+  let folder = create_folder(&quot;QuickFilterBarTextMultiWord&quot;);</span>
<a href="#l30.260"></a><span id="l30.260" class="difflineplus">+</span>
<a href="#l30.261"></a><span id="l30.261" class="difflineplus">+  let whoFoo = [&quot;foo&quot;, &quot;zabba@madeup.nul&quot;];</span>
<a href="#l30.262"></a><span id="l30.262" class="difflineplus">+  let whoBar = [&quot;zabba&quot;, &quot;bar@madeup.nul&quot;];</span>
<a href="#l30.263"></a><span id="l30.263" class="difflineplus">+  let [setInert, setPeepMatch, setSubjReverse, setSubjectJustFoo] =</span>
<a href="#l30.264"></a><span id="l30.264" class="difflineplus">+    make_new_sets_in_folder(folder, [</span>
<a href="#l30.265"></a><span id="l30.265" class="difflineplus">+      {count: 1}, {count:1, from: whoFoo, to: [whoBar]},</span>
<a href="#l30.266"></a><span id="l30.266" class="difflineplus">+      {count: 1, subject: &quot;bar foo&quot;}, {count: 1, from: whoFoo}]);</span>
<a href="#l30.267"></a><span id="l30.267" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l30.268"></a><span id="l30.268" class="difflineplus">+</span>
<a href="#l30.269"></a><span id="l30.269" class="difflineplus">+  // (precondition)</span>
<a href="#l30.270"></a><span id="l30.270" class="difflineplus">+  assert_text_constraints_checked(&quot;sender&quot;, &quot;recipients&quot;, &quot;subject&quot;);</span>
<a href="#l30.271"></a><span id="l30.271" class="difflineplus">+</span>
<a href="#l30.272"></a><span id="l30.272" class="difflineplus">+  set_filter_text(&quot;foo bar&quot;);</span>
<a href="#l30.273"></a><span id="l30.273" class="difflineplus">+  assert_messages_in_view([setPeepMatch, setSubjReverse]);</span>
<a href="#l30.274"></a><span id="l30.274" class="difflineplus">+}</span>
<a href="#l30.275"></a><span id="l30.275" class="difflineplus">+</span>
<a href="#l30.276"></a><span id="l30.276" class="difflineplus">+/**</span>
<a href="#l30.277"></a><span id="l30.277" class="difflineplus">+ * Make sure that when dropping all constraints on toggle off or changing</span>
<a href="#l30.278"></a><span id="l30.278" class="difflineplus">+ *  folders that we persist/propagate the state of the</span>
<a href="#l30.279"></a><span id="l30.279" class="difflineplus">+ *  sender/recipients/subject/body toggle buttons.</span>
<a href="#l30.280"></a><span id="l30.280" class="difflineplus">+ */</span>
<a href="#l30.281"></a><span id="l30.281" class="difflineplus">+function test_filter_text_constraints_propagate() {</span>
<a href="#l30.282"></a><span id="l30.282" class="difflineplus">+  let whoFoo = [&quot;foo&quot;, &quot;zabba@madeup.nul&quot;];</span>
<a href="#l30.283"></a><span id="l30.283" class="difflineplus">+  let whoBar = [&quot;zabba&quot;, &quot;bar@madeup.nul&quot;];</span>
<a href="#l30.284"></a><span id="l30.284" class="difflineplus">+</span>
<a href="#l30.285"></a><span id="l30.285" class="difflineplus">+  let folderOne = create_folder(&quot;QuickFilterBarTextPropagate1&quot;);</span>
<a href="#l30.286"></a><span id="l30.286" class="difflineplus">+  let [setSubjFoo, setWhoFoo] = make_new_sets_in_folder(folderOne,</span>
<a href="#l30.287"></a><span id="l30.287" class="difflineplus">+    [{count: 1, subject: &quot;foo&quot;}, {count: 1, from: whoFoo}]);</span>
<a href="#l30.288"></a><span id="l30.288" class="difflineplus">+  let folderTwo = create_folder(&quot;QuickFilterBarTextPropagate2&quot;);</span>
<a href="#l30.289"></a><span id="l30.289" class="difflineplus">+  let [setSubjBar, setWhoBar] = make_new_sets_in_folder(folderTwo,</span>
<a href="#l30.290"></a><span id="l30.290" class="difflineplus">+    [{count: 1, subject: &quot;bar&quot;}, {count: 1, from: whoBar}]);</span>
<a href="#l30.291"></a><span id="l30.291" class="difflineplus">+</span>
<a href="#l30.292"></a><span id="l30.292" class="difflineplus">+  be_in_folder(folderOne);</span>
<a href="#l30.293"></a><span id="l30.293" class="difflineplus">+  set_filter_text(&quot;foo&quot;);</span>
<a href="#l30.294"></a><span id="l30.294" class="difflineplus">+  // (precondition)</span>
<a href="#l30.295"></a><span id="l30.295" class="difflineplus">+  assert_text_constraints_checked(&quot;sender&quot;, &quot;recipients&quot;, &quot;subject&quot;);</span>
<a href="#l30.296"></a><span id="l30.296" class="difflineplus">+  assert_messages_in_view([setSubjFoo, setWhoFoo]);</span>
<a href="#l30.297"></a><span id="l30.297" class="difflineplus">+</span>
<a href="#l30.298"></a><span id="l30.298" class="difflineplus">+  // -- drop subject, close bar to reset, make sure it sticks</span>
<a href="#l30.299"></a><span id="l30.299" class="difflineplus">+  toggle_text_constraints(&quot;subject&quot;);</span>
<a href="#l30.300"></a><span id="l30.300" class="difflineplus">+  assert_messages_in_view([setWhoFoo]);</span>
<a href="#l30.301"></a><span id="l30.301" class="difflineplus">+</span>
<a href="#l30.302"></a><span id="l30.302" class="difflineplus">+  toggle_quick_filter_bar();</span>
<a href="#l30.303"></a><span id="l30.303" class="difflineplus">+  toggle_quick_filter_bar();</span>
<a href="#l30.304"></a><span id="l30.304" class="difflineplus">+</span>
<a href="#l30.305"></a><span id="l30.305" class="difflineplus">+  set_filter_text(&quot;foo&quot;);</span>
<a href="#l30.306"></a><span id="l30.306" class="difflineplus">+  assert_messages_in_view([setWhoFoo]);</span>
<a href="#l30.307"></a><span id="l30.307" class="difflineplus">+  assert_text_constraints_checked(&quot;sender&quot;, &quot;recipients&quot;);</span>
<a href="#l30.308"></a><span id="l30.308" class="difflineplus">+</span>
<a href="#l30.309"></a><span id="l30.309" class="difflineplus">+  // -- now change folders and make sure the settings stick</span>
<a href="#l30.310"></a><span id="l30.310" class="difflineplus">+  be_in_folder(folderTwo);</span>
<a href="#l30.311"></a><span id="l30.311" class="difflineplus">+  set_filter_text(&quot;bar&quot;);</span>
<a href="#l30.312"></a><span id="l30.312" class="difflineplus">+  assert_messages_in_view([setWhoBar]);</span>
<a href="#l30.313"></a><span id="l30.313" class="difflineplus">+  assert_text_constraints_checked(&quot;sender&quot;, &quot;recipients&quot;);</span>
<a href="#l30.314"></a><span id="l30.314" class="difflineplus">+}</span>
<a href="#l30.315"></a><span id="l30.315" class="difflineplus">+</span>
<a href="#l30.316"></a><span id="l30.316" class="difflineplus">+/**</span>
<a href="#l30.317"></a><span id="l30.317" class="difflineplus">+ * Here is what the results label does:</span>
<a href="#l30.318"></a><span id="l30.318" class="difflineplus">+ * - No filter active: results label is not visible.</span>
<a href="#l30.319"></a><span id="l30.319" class="difflineplus">+ * - Filter active, messages: it says the number of messages.</span>
<a href="#l30.320"></a><span id="l30.320" class="difflineplus">+ * - Filter active, no messages: it says there are no messages.</span>
<a href="#l30.321"></a><span id="l30.321" class="difflineplus">+ *</span>
<a href="#l30.322"></a><span id="l30.322" class="difflineplus">+ * Additional nuances:</span>
<a href="#l30.323"></a><span id="l30.323" class="difflineplus">+ * - The count needs to update as the user deletes messages or what not.</span>
<a href="#l30.324"></a><span id="l30.324" class="difflineplus">+ */</span>
<a href="#l30.325"></a><span id="l30.325" class="difflineplus">+function test_results_label() {</span>
<a href="#l30.326"></a><span id="l30.326" class="difflineplus">+  let folder = create_folder(&quot;QuickFilterBarResultsLabel&quot;);</span>
<a href="#l30.327"></a><span id="l30.327" class="difflineplus">+  let [setImmortal, setMortal, setGoldfish] = make_new_sets_in_folder(folder,</span>
<a href="#l30.328"></a><span id="l30.328" class="difflineplus">+    [{count: 1}, {count: 1}, {count: 1}]);</span>
<a href="#l30.329"></a><span id="l30.329" class="difflineplus">+</span>
<a href="#l30.330"></a><span id="l30.330" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l30.331"></a><span id="l30.331" class="difflineplus">+</span>
<a href="#l30.332"></a><span id="l30.332" class="difflineplus">+  // no filter, the label should not be visible</span>
<a href="#l30.333"></a><span id="l30.333" class="difflineplus">+  if (mc.e(&quot;qfb-results-label&quot;).visible)</span>
<a href="#l30.334"></a><span id="l30.334" class="difflineplus">+    throw new Error(&quot;results label should not be visible, yo! mad impropah!&quot;);</span>
<a href="#l30.335"></a><span id="l30.335" class="difflineplus">+</span>
<a href="#l30.336"></a><span id="l30.336" class="difflineplus">+  toggle_boolean_constraints(&quot;unread&quot;);</span>
<a href="#l30.337"></a><span id="l30.337" class="difflineplus">+  assert_messages_in_view([setImmortal, setMortal, setGoldfish]);</span>
<a href="#l30.338"></a><span id="l30.338" class="difflineplus">+  assert_results_label_count(3);</span>
<a href="#l30.339"></a><span id="l30.339" class="difflineplus">+</span>
<a href="#l30.340"></a><span id="l30.340" class="difflineplus">+  delete_message_set(setGoldfish);</span>
<a href="#l30.341"></a><span id="l30.341" class="difflineplus">+  assert_results_label_count(2);</span>
<a href="#l30.342"></a><span id="l30.342" class="difflineplus">+</span>
<a href="#l30.343"></a><span id="l30.343" class="difflineplus">+  delete_message_set(setMortal);</span>
<a href="#l30.344"></a><span id="l30.344" class="difflineplus">+  assert_results_label_count(1);</span>
<a href="#l30.345"></a><span id="l30.345" class="difflineplus">+</span>
<a href="#l30.346"></a><span id="l30.346" class="difflineplus">+  delete_message_set(setImmortal);</span>
<a href="#l30.347"></a><span id="l30.347" class="difflineplus">+  assert_results_label_count(0);</span>
<a href="#l30.348"></a><span id="l30.348" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1">new file mode 100644</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineminus">--- /dev/null</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineplus">+++ b/mail/test/mozmill/quick-filter-bar/test-keyboard-interface.js</span>
<a href="#l31.4"></a><span id="l31.4" class="difflineat">@@ -0,0 +1,169 @@</span>
<a href="#l31.5"></a><span id="l31.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l31.6"></a><span id="l31.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l31.7"></a><span id="l31.7" class="difflineplus">+ *</span>
<a href="#l31.8"></a><span id="l31.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l31.9"></a><span id="l31.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l31.10"></a><span id="l31.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l31.11"></a><span id="l31.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineplus">+ *</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l31.16"></a><span id="l31.16" class="difflineplus">+ * License.</span>
<a href="#l31.17"></a><span id="l31.17" class="difflineplus">+ *</span>
<a href="#l31.18"></a><span id="l31.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l31.19"></a><span id="l31.19" class="difflineplus">+ *</span>
<a href="#l31.20"></a><span id="l31.20" class="difflineplus">+ * The Initial Developer of the Original Code is the Mozilla Foundation.</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2010</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l31.23"></a><span id="l31.23" class="difflineplus">+ *</span>
<a href="#l31.24"></a><span id="l31.24" class="difflineplus">+ * Contributor(s):</span>
<a href="#l31.25"></a><span id="l31.25" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l31.26"></a><span id="l31.26" class="difflineplus">+ *</span>
<a href="#l31.27"></a><span id="l31.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l31.28"></a><span id="l31.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l31.29"></a><span id="l31.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l31.30"></a><span id="l31.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l31.33"></a><span id="l31.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l31.34"></a><span id="l31.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l31.35"></a><span id="l31.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l31.36"></a><span id="l31.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l31.37"></a><span id="l31.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l31.38"></a><span id="l31.38" class="difflineplus">+ *</span>
<a href="#l31.39"></a><span id="l31.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l31.40"></a><span id="l31.40" class="difflineplus">+</span>
<a href="#l31.41"></a><span id="l31.41" class="difflineplus">+/*</span>
<a href="#l31.42"></a><span id="l31.42" class="difflineplus">+ * Tests keyboard stuff that doesn't fall under some other test's heading.</span>
<a href="#l31.43"></a><span id="l31.43" class="difflineplus">+ * Namely, control-f toggling the bar into existence happens in</span>
<a href="#l31.44"></a><span id="l31.44" class="difflineplus">+ * test-toggle-bar.js, but we test that repeatedly hitting control-f toggles</span>
<a href="#l31.45"></a><span id="l31.45" class="difflineplus">+ * between our search text box and the find-in-message text box.</span>
<a href="#l31.46"></a><span id="l31.46" class="difflineplus">+ */</span>
<a href="#l31.47"></a><span id="l31.47" class="difflineplus">+</span>
<a href="#l31.48"></a><span id="l31.48" class="difflineplus">+var MODULE_NAME = 'test-keyboard-interface';</span>
<a href="#l31.49"></a><span id="l31.49" class="difflineplus">+</span>
<a href="#l31.50"></a><span id="l31.50" class="difflineplus">+const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l31.51"></a><span id="l31.51" class="difflineplus">+</span>
<a href="#l31.52"></a><span id="l31.52" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers',</span>
<a href="#l31.53"></a><span id="l31.53" class="difflineplus">+                       'quick-filter-bar-helper'];</span>
<a href="#l31.54"></a><span id="l31.54" class="difflineplus">+</span>
<a href="#l31.55"></a><span id="l31.55" class="difflineplus">+var folder;</span>
<a href="#l31.56"></a><span id="l31.56" class="difflineplus">+var setUnstarred, setStarred;</span>
<a href="#l31.57"></a><span id="l31.57" class="difflineplus">+</span>
<a href="#l31.58"></a><span id="l31.58" class="difflineplus">+function setupModule(module) {</span>
<a href="#l31.59"></a><span id="l31.59" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l31.60"></a><span id="l31.60" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l31.61"></a><span id="l31.61" class="difflineplus">+  let wh = collector.getModule('window-helpers');</span>
<a href="#l31.62"></a><span id="l31.62" class="difflineplus">+  wh.installInto(module);</span>
<a href="#l31.63"></a><span id="l31.63" class="difflineplus">+  let qfb = collector.getModule('quick-filter-bar-helper');</span>
<a href="#l31.64"></a><span id="l31.64" class="difflineplus">+  qfb.installInto(module);</span>
<a href="#l31.65"></a><span id="l31.65" class="difflineplus">+</span>
<a href="#l31.66"></a><span id="l31.66" class="difflineplus">+  folder = create_folder(&quot;QuickFilterBarKeyboardInterface&quot;);</span>
<a href="#l31.67"></a><span id="l31.67" class="difflineplus">+  // we need a message so we can select it so we can find in message</span>
<a href="#l31.68"></a><span id="l31.68" class="difflineplus">+  make_new_sets_in_folder(folder, [{count: 1}]);</span>
<a href="#l31.69"></a><span id="l31.69" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l31.70"></a><span id="l31.70" class="difflineplus">+}</span>
<a href="#l31.71"></a><span id="l31.71" class="difflineplus">+</span>
<a href="#l31.72"></a><span id="l31.72" class="difflineplus">+/**</span>
<a href="#l31.73"></a><span id="l31.73" class="difflineplus">+ * The rules for pressing escape:</span>
<a href="#l31.74"></a><span id="l31.74" class="difflineplus">+ * - If there are any applied constraints:</span>
<a href="#l31.75"></a><span id="l31.75" class="difflineplus">+ *   - If there is a 'most recent' constraint, it is relaxed and the 'most</span>
<a href="#l31.76"></a><span id="l31.76" class="difflineplus">+ *     recent' field gets cleared, so that if escape gets hit again...</span>
<a href="#l31.77"></a><span id="l31.77" class="difflineplus">+ *   - If there is no 'most recent' constraint, all constraints are cleared.</span>
<a href="#l31.78"></a><span id="l31.78" class="difflineplus">+ * - If there are no applied constraints, we close the filter bar.</span>
<a href="#l31.79"></a><span id="l31.79" class="difflineplus">+ *</span>
<a href="#l31.80"></a><span id="l31.80" class="difflineplus">+ * We test these rules two ways:</span>
<a href="#l31.81"></a><span id="l31.81" class="difflineplus">+ * 1) With the focus in the thread pane.</span>
<a href="#l31.82"></a><span id="l31.82" class="difflineplus">+ * 2) With our focus in our text-box.</span>
<a href="#l31.83"></a><span id="l31.83" class="difflineplus">+ */</span>
<a href="#l31.84"></a><span id="l31.84" class="difflineplus">+function test_escape_rules() {</span>
<a href="#l31.85"></a><span id="l31.85" class="difflineplus">+  assert_quick_filter_bar_visible(true); // (precondition)</span>
<a href="#l31.86"></a><span id="l31.86" class="difflineplus">+</span>
<a href="#l31.87"></a><span id="l31.87" class="difflineplus">+  // the common logic for each bit...</span>
<a href="#l31.88"></a><span id="l31.88" class="difflineplus">+  function legwork() {</span>
<a href="#l31.89"></a><span id="l31.89" class="difflineplus">+    // apply two...</span>
<a href="#l31.90"></a><span id="l31.90" class="difflineplus">+    toggle_boolean_constraints(&quot;unread&quot;, &quot;starred&quot;, &quot;addrbook&quot;);</span>
<a href="#l31.91"></a><span id="l31.91" class="difflineplus">+    assert_constraints_expressed({unread: true, starred: true, addrbook: true});</span>
<a href="#l31.92"></a><span id="l31.92" class="difflineplus">+    assert_quick_filter_bar_visible(true);</span>
<a href="#l31.93"></a><span id="l31.93" class="difflineplus">+</span>
<a href="#l31.94"></a><span id="l31.94" class="difflineplus">+    // hit escape, should clear addrbook</span>
<a href="#l31.95"></a><span id="l31.95" class="difflineplus">+    mc.keypress(null, &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l31.96"></a><span id="l31.96" class="difflineplus">+    assert_quick_filter_bar_visible(true);</span>
<a href="#l31.97"></a><span id="l31.97" class="difflineplus">+    assert_constraints_expressed({unread: true, starred: true});</span>
<a href="#l31.98"></a><span id="l31.98" class="difflineplus">+</span>
<a href="#l31.99"></a><span id="l31.99" class="difflineplus">+    // hit escape, should clear both remaining ones</span>
<a href="#l31.100"></a><span id="l31.100" class="difflineplus">+    mc.keypress(null, &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l31.101"></a><span id="l31.101" class="difflineplus">+    assert_quick_filter_bar_visible(true);</span>
<a href="#l31.102"></a><span id="l31.102" class="difflineplus">+    assert_constraints_expressed({});</span>
<a href="#l31.103"></a><span id="l31.103" class="difflineplus">+</span>
<a href="#l31.104"></a><span id="l31.104" class="difflineplus">+    // hit escape, bar should disappear</span>
<a href="#l31.105"></a><span id="l31.105" class="difflineplus">+    mc.keypress(null, &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l31.106"></a><span id="l31.106" class="difflineplus">+    assert_quick_filter_bar_visible(false);</span>
<a href="#l31.107"></a><span id="l31.107" class="difflineplus">+</span>
<a href="#l31.108"></a><span id="l31.108" class="difflineplus">+    // bring the bar back for the next dude</span>
<a href="#l31.109"></a><span id="l31.109" class="difflineplus">+    toggle_quick_filter_bar();</span>
<a href="#l31.110"></a><span id="l31.110" class="difflineplus">+  }</span>
<a href="#l31.111"></a><span id="l31.111" class="difflineplus">+</span>
<a href="#l31.112"></a><span id="l31.112" class="difflineplus">+  // 1) focus in the thread pane</span>
<a href="#l31.113"></a><span id="l31.113" class="difflineplus">+  mc.e(&quot;threadTree&quot;).focus();</span>
<a href="#l31.114"></a><span id="l31.114" class="difflineplus">+  legwork();</span>
<a href="#l31.115"></a><span id="l31.115" class="difflineplus">+</span>
<a href="#l31.116"></a><span id="l31.116" class="difflineplus">+  // 2) focus in the text box</span>
<a href="#l31.117"></a><span id="l31.117" class="difflineplus">+  mc.e(&quot;qfb-qs-textbox&quot;).focus();</span>
<a href="#l31.118"></a><span id="l31.118" class="difflineplus">+  legwork();</span>
<a href="#l31.119"></a><span id="l31.119" class="difflineplus">+}</span>
<a href="#l31.120"></a><span id="l31.120" class="difflineplus">+</span>
<a href="#l31.121"></a><span id="l31.121" class="difflineplus">+/**</span>
<a href="#l31.122"></a><span id="l31.122" class="difflineplus">+ * It's fairly important that the gloda search widget eats escape when people</span>
<a href="#l31.123"></a><span id="l31.123" class="difflineplus">+ * press escape in there.  Because gloda is disabled by default, we need to</span>
<a href="#l31.124"></a><span id="l31.124" class="difflineplus">+ * viciously uncollapse it ourselves and then cleanup afterwards...</span>
<a href="#l31.125"></a><span id="l31.125" class="difflineplus">+ */</span>
<a href="#l31.126"></a><span id="l31.126" class="difflineplus">+function test_escape_does_not_reach_us_from_gloda_search() {</span>
<a href="#l31.127"></a><span id="l31.127" class="difflineplus">+  let glodaSearchWidget = mc.e(&quot;searchInput&quot;);</span>
<a href="#l31.128"></a><span id="l31.128" class="difflineplus">+  try {</span>
<a href="#l31.129"></a><span id="l31.129" class="difflineplus">+    // uncollapse and focus the gloda search widget</span>
<a href="#l31.130"></a><span id="l31.130" class="difflineplus">+    glodaSearchWidget.collapsed = false;</span>
<a href="#l31.131"></a><span id="l31.131" class="difflineplus">+    glodaSearchWidget.focus();</span>
<a href="#l31.132"></a><span id="l31.132" class="difflineplus">+</span>
<a href="#l31.133"></a><span id="l31.133" class="difflineplus">+    mc.keypress(null, &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l31.134"></a><span id="l31.134" class="difflineplus">+</span>
<a href="#l31.135"></a><span id="l31.135" class="difflineplus">+    assert_quick_filter_bar_visible(true);</span>
<a href="#l31.136"></a><span id="l31.136" class="difflineplus">+  }</span>
<a href="#l31.137"></a><span id="l31.137" class="difflineplus">+  finally {</span>
<a href="#l31.138"></a><span id="l31.138" class="difflineplus">+    glodaSearchWidget.collapsed = true;</span>
<a href="#l31.139"></a><span id="l31.139" class="difflineplus">+  }</span>
<a href="#l31.140"></a><span id="l31.140" class="difflineplus">+</span>
<a href="#l31.141"></a><span id="l31.141" class="difflineplus">+}</span>
<a href="#l31.142"></a><span id="l31.142" class="difflineplus">+</span>
<a href="#l31.143"></a><span id="l31.143" class="difflineplus">+/**</span>
<a href="#l31.144"></a><span id="l31.144" class="difflineplus">+ * Control-f jumps to the quickfilter text box when not in it.  when in it, it</span>
<a href="#l31.145"></a><span id="l31.145" class="difflineplus">+ * allows the normal find-in-message command to execute, which should jump it</span>
<a href="#l31.146"></a><span id="l31.146" class="difflineplus">+ * to the find-in-message textbox thing.</span>
<a href="#l31.147"></a><span id="l31.147" class="difflineplus">+ */</span>
<a href="#l31.148"></a><span id="l31.148" class="difflineplus">+function test_control_f_toggles_between_textboxes() {</span>
<a href="#l31.149"></a><span id="l31.149" class="difflineplus">+  let dispatcha = mc.window.document.commandDispatcher;</span>
<a href="#l31.150"></a><span id="l31.150" class="difflineplus">+</span>
<a href="#l31.151"></a><span id="l31.151" class="difflineplus">+  // focus explicitly on the thread pane so we know where the focus is.</span>
<a href="#l31.152"></a><span id="l31.152" class="difflineplus">+  mc.e(&quot;threadTree&quot;).focus();</span>
<a href="#l31.153"></a><span id="l31.153" class="difflineplus">+  // select a message so we can find in message</span>
<a href="#l31.154"></a><span id="l31.154" class="difflineplus">+  select_click_row(0);</span>
<a href="#l31.155"></a><span id="l31.155" class="difflineplus">+</span>
<a href="#l31.156"></a><span id="l31.156" class="difflineplus">+  // hit control-f to get in the quick filter box</span>
<a href="#l31.157"></a><span id="l31.157" class="difflineplus">+  mc.keypress(null, &quot;f&quot;, {accelKey: true});</span>
<a href="#l31.158"></a><span id="l31.158" class="difflineplus">+  if (dispatcha.focusedElement != mc.e(&quot;qfb-qs-textbox&quot;).inputField)</span>
<a href="#l31.159"></a><span id="l31.159" class="difflineplus">+    throw new Error(&quot;control-f did not focus quick filter textbox&quot;);</span>
<a href="#l31.160"></a><span id="l31.160" class="difflineplus">+</span>
<a href="#l31.161"></a><span id="l31.161" class="difflineplus">+  // hit control-f to get in the find-in-message box</span>
<a href="#l31.162"></a><span id="l31.162" class="difflineplus">+  mc.keypress(null, &quot;f&quot;, {accelKey: true});</span>
<a href="#l31.163"></a><span id="l31.163" class="difflineplus">+  if (dispatcha.focusedElement != mc.e(&quot;FindToolbar&quot;)._findField.inputField)</span>
<a href="#l31.164"></a><span id="l31.164" class="difflineplus">+    throw new Error(&quot;control-f did not focus toolbar textbox. focused elem: &quot; +</span>
<a href="#l31.165"></a><span id="l31.165" class="difflineplus">+                    dispatcha.focusedElement + &quot; expected elem: &quot; +</span>
<a href="#l31.166"></a><span id="l31.166" class="difflineplus">+                    mc.e(&quot;FindToolbar&quot;)._findField.inputField + &quot; last dude: &quot; +</span>
<a href="#l31.167"></a><span id="l31.167" class="difflineplus">+                    mc.e(&quot;qfb-qs-textbox&quot;).inputField);</span>
<a href="#l31.168"></a><span id="l31.168" class="difflineplus">+</span>
<a href="#l31.169"></a><span id="l31.169" class="difflineplus">+  // secret bonus test!  hit escape and make sure it only closes the</span>
<a href="#l31.170"></a><span id="l31.170" class="difflineplus">+  //  find-in-message bar.</span>
<a href="#l31.171"></a><span id="l31.171" class="difflineplus">+  mc.keypress(null, &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l31.172"></a><span id="l31.172" class="difflineplus">+  assert_quick_filter_bar_visible(true);</span>
<a href="#l31.173"></a><span id="l31.173" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1">new file mode 100644</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineminus">--- /dev/null</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineplus">+++ b/mail/test/mozmill/quick-filter-bar/test-sticky-filter-logic.js</span>
<a href="#l32.4"></a><span id="l32.4" class="difflineat">@@ -0,0 +1,147 @@</span>
<a href="#l32.5"></a><span id="l32.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l32.6"></a><span id="l32.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l32.7"></a><span id="l32.7" class="difflineplus">+ *</span>
<a href="#l32.8"></a><span id="l32.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l32.9"></a><span id="l32.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l32.10"></a><span id="l32.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l32.11"></a><span id="l32.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineplus">+ *</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineplus">+ * License.</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineplus">+ *</span>
<a href="#l32.18"></a><span id="l32.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l32.19"></a><span id="l32.19" class="difflineplus">+ *</span>
<a href="#l32.20"></a><span id="l32.20" class="difflineplus">+ * The Initial Developer of the Original Code is the Mozilla Foundation.</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2010</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l32.23"></a><span id="l32.23" class="difflineplus">+ *</span>
<a href="#l32.24"></a><span id="l32.24" class="difflineplus">+ * Contributor(s):</span>
<a href="#l32.25"></a><span id="l32.25" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l32.26"></a><span id="l32.26" class="difflineplus">+ *</span>
<a href="#l32.27"></a><span id="l32.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l32.28"></a><span id="l32.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l32.29"></a><span id="l32.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l32.30"></a><span id="l32.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l32.33"></a><span id="l32.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l32.34"></a><span id="l32.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l32.35"></a><span id="l32.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l32.36"></a><span id="l32.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l32.37"></a><span id="l32.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l32.38"></a><span id="l32.38" class="difflineplus">+ *</span>
<a href="#l32.39"></a><span id="l32.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l32.40"></a><span id="l32.40" class="difflineplus">+</span>
<a href="#l32.41"></a><span id="l32.41" class="difflineplus">+/*</span>
<a href="#l32.42"></a><span id="l32.42" class="difflineplus">+ * Sticky logic only needs to test the general sticky logic plus any filters</span>
<a href="#l32.43"></a><span id="l32.43" class="difflineplus">+ *  with custom propagateState implementations (currently: tags, text filter.)</span>
<a href="#l32.44"></a><span id="l32.44" class="difflineplus">+ */</span>
<a href="#l32.45"></a><span id="l32.45" class="difflineplus">+</span>
<a href="#l32.46"></a><span id="l32.46" class="difflineplus">+var MODULE_NAME = 'test-filter-logic';</span>
<a href="#l32.47"></a><span id="l32.47" class="difflineplus">+</span>
<a href="#l32.48"></a><span id="l32.48" class="difflineplus">+const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l32.49"></a><span id="l32.49" class="difflineplus">+</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers',</span>
<a href="#l32.51"></a><span id="l32.51" class="difflineplus">+                       'quick-filter-bar-helper'];</span>
<a href="#l32.52"></a><span id="l32.52" class="difflineplus">+</span>
<a href="#l32.53"></a><span id="l32.53" class="difflineplus">+function setupModule(module) {</span>
<a href="#l32.54"></a><span id="l32.54" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l32.55"></a><span id="l32.55" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l32.56"></a><span id="l32.56" class="difflineplus">+  let wh = collector.getModule('window-helpers');</span>
<a href="#l32.57"></a><span id="l32.57" class="difflineplus">+  wh.installInto(module);</span>
<a href="#l32.58"></a><span id="l32.58" class="difflineplus">+  let qfb = collector.getModule('quick-filter-bar-helper');</span>
<a href="#l32.59"></a><span id="l32.59" class="difflineplus">+  qfb.installInto(module);</span>
<a href="#l32.60"></a><span id="l32.60" class="difflineplus">+}</span>
<a href="#l32.61"></a><span id="l32.61" class="difflineplus">+</span>
<a href="#l32.62"></a><span id="l32.62" class="difflineplus">+/**</span>
<a href="#l32.63"></a><span id="l32.63" class="difflineplus">+ * Persist the current settings through folder change and inherit into a new tab.</span>
<a href="#l32.64"></a><span id="l32.64" class="difflineplus">+ */</span>
<a href="#l32.65"></a><span id="l32.65" class="difflineplus">+function test_sticky_basics() {</span>
<a href="#l32.66"></a><span id="l32.66" class="difflineplus">+  let folderOne = create_folder(&quot;QuickFilterBarStickyBasics1&quot;);</span>
<a href="#l32.67"></a><span id="l32.67" class="difflineplus">+  let [unreadOne, readOne] = make_new_sets_in_folder(folderOne,</span>
<a href="#l32.68"></a><span id="l32.68" class="difflineplus">+    [{count: 1}, {count: 1}]);</span>
<a href="#l32.69"></a><span id="l32.69" class="difflineplus">+  readOne.setRead(true);</span>
<a href="#l32.70"></a><span id="l32.70" class="difflineplus">+</span>
<a href="#l32.71"></a><span id="l32.71" class="difflineplus">+  let folderTwo = create_folder(&quot;QuickFilterBarStickyBasics2&quot;);</span>
<a href="#l32.72"></a><span id="l32.72" class="difflineplus">+  let [unreadTwo, readTwo] = make_new_sets_in_folder(folderTwo,</span>
<a href="#l32.73"></a><span id="l32.73" class="difflineplus">+    [{count: 1}, {count: 1}]);</span>
<a href="#l32.74"></a><span id="l32.74" class="difflineplus">+  readTwo.setRead(true);</span>
<a href="#l32.75"></a><span id="l32.75" class="difflineplus">+</span>
<a href="#l32.76"></a><span id="l32.76" class="difflineplus">+  // -- setup</span>
<a href="#l32.77"></a><span id="l32.77" class="difflineplus">+  let tabA = be_in_folder(folderOne);</span>
<a href="#l32.78"></a><span id="l32.78" class="difflineplus">+  toggle_boolean_constraints(&quot;sticky&quot;, &quot;unread&quot;);</span>
<a href="#l32.79"></a><span id="l32.79" class="difflineplus">+  assert_messages_in_view(unreadOne);</span>
<a href="#l32.80"></a><span id="l32.80" class="difflineplus">+</span>
<a href="#l32.81"></a><span id="l32.81" class="difflineplus">+  // -- change folders</span>
<a href="#l32.82"></a><span id="l32.82" class="difflineplus">+  be_in_folder(folderTwo);</span>
<a href="#l32.83"></a><span id="l32.83" class="difflineplus">+  assert_constraints_expressed({sticky: true, unread: true});</span>
<a href="#l32.84"></a><span id="l32.84" class="difflineplus">+  assert_messages_in_view(unreadTwo);</span>
<a href="#l32.85"></a><span id="l32.85" class="difflineplus">+</span>
<a href="#l32.86"></a><span id="l32.86" class="difflineplus">+  // -- inherit into a new folder</span>
<a href="#l32.87"></a><span id="l32.87" class="difflineplus">+  let tabB = open_folder_in_new_tab(folderOne);</span>
<a href="#l32.88"></a><span id="l32.88" class="difflineplus">+  assert_constraints_expressed({sticky: true, unread: true});</span>
<a href="#l32.89"></a><span id="l32.89" class="difflineplus">+  assert_messages_in_view(unreadOne);</span>
<a href="#l32.90"></a><span id="l32.90" class="difflineplus">+</span>
<a href="#l32.91"></a><span id="l32.91" class="difflineplus">+  close_tab(tabB);</span>
<a href="#l32.92"></a><span id="l32.92" class="difflineplus">+}</span>
<a href="#l32.93"></a><span id="l32.93" class="difflineplus">+</span>
<a href="#l32.94"></a><span id="l32.94" class="difflineplus">+/**</span>
<a href="#l32.95"></a><span id="l32.95" class="difflineplus">+ * The semantics of sticky tags are not obvious; there were decisions involved:</span>
<a href="#l32.96"></a><span id="l32.96" class="difflineplus">+ * - If the user has the tag facet enabled but not explicitly filtered on</span>
<a href="#l32.97"></a><span id="l32.97" class="difflineplus">+ *   specific tags then we propagate just &quot;true&quot; to cause the faceting to</span>
<a href="#l32.98"></a><span id="l32.98" class="difflineplus">+ *   run in the new folder.  In other words, the list of displayed tags should</span>
<a href="#l32.99"></a><span id="l32.99" class="difflineplus">+ *   change.</span>
<a href="#l32.100"></a><span id="l32.100" class="difflineplus">+ * - If the user has filtered on specific tags, then we do and must propagate</span>
<a href="#l32.101"></a><span id="l32.101" class="difflineplus">+ *   the list of tags.</span>
<a href="#l32.102"></a><span id="l32.102" class="difflineplus">+ *</span>
<a href="#l32.103"></a><span id="l32.103" class="difflineplus">+ * We only need to do folder changes from here on out since the logic is</span>
<a href="#l32.104"></a><span id="l32.104" class="difflineplus">+ *  identical (and tested to be identical in |test_sticky_basics|).</span>
<a href="#l32.105"></a><span id="l32.105" class="difflineplus">+ */</span>
<a href="#l32.106"></a><span id="l32.106" class="difflineplus">+function test_sticky_tags() {</span>
<a href="#l32.107"></a><span id="l32.107" class="difflineplus">+  let folderOne = create_folder(&quot;QuickFilterBarStickyTags1&quot;);</span>
<a href="#l32.108"></a><span id="l32.108" class="difflineplus">+  let folderTwo = create_folder(&quot;QuickFilterBarStickyTags2&quot;);</span>
<a href="#l32.109"></a><span id="l32.109" class="difflineplus">+  const tagA = &quot;$label1&quot;, tagB = &quot;$label2&quot;, tagC = &quot;$label3&quot;;</span>
<a href="#l32.110"></a><span id="l32.110" class="difflineplus">+  let [setNoTag1, setTagA1, setTagB1] = make_new_sets_in_folder(</span>
<a href="#l32.111"></a><span id="l32.111" class="difflineplus">+    folderOne, [{count: 1}, {count: 1}, {count: 1}]);</span>
<a href="#l32.112"></a><span id="l32.112" class="difflineplus">+  let [setNoTag2, setTagA2, setTagC2] = make_new_sets_in_folder(</span>
<a href="#l32.113"></a><span id="l32.113" class="difflineplus">+    folderTwo, [{count: 1}, {count: 1}, {count: 1}]);</span>
<a href="#l32.114"></a><span id="l32.114" class="difflineplus">+  setTagA1.addTag(tagA);</span>
<a href="#l32.115"></a><span id="l32.115" class="difflineplus">+  setTagB1.addTag(tagB);</span>
<a href="#l32.116"></a><span id="l32.116" class="difflineplus">+  setTagA2.addTag(tagA);</span>
<a href="#l32.117"></a><span id="l32.117" class="difflineplus">+  setTagC2.addTag(tagC);</span>
<a href="#l32.118"></a><span id="l32.118" class="difflineplus">+</span>
<a href="#l32.119"></a><span id="l32.119" class="difflineplus">+  be_in_folder(folderOne);</span>
<a href="#l32.120"></a><span id="l32.120" class="difflineplus">+  toggle_boolean_constraints(&quot;sticky&quot;, &quot;tags&quot;);</span>
<a href="#l32.121"></a><span id="l32.121" class="difflineplus">+  assert_tag_constraints_visible(tagA, tagB);</span>
<a href="#l32.122"></a><span id="l32.122" class="difflineplus">+  assert_messages_in_view([setTagA1, setTagB1]);</span>
<a href="#l32.123"></a><span id="l32.123" class="difflineplus">+</span>
<a href="#l32.124"></a><span id="l32.124" class="difflineplus">+  // -- re-facet when we change folders since constraint was just true</span>
<a href="#l32.125"></a><span id="l32.125" class="difflineplus">+  be_in_folder(folderTwo);</span>
<a href="#l32.126"></a><span id="l32.126" class="difflineplus">+  assert_tag_constraints_visible(tagA, tagC);</span>
<a href="#l32.127"></a><span id="l32.127" class="difflineplus">+  assert_messages_in_view([setTagA2, setTagC2]);</span>
<a href="#l32.128"></a><span id="l32.128" class="difflineplus">+</span>
<a href="#l32.129"></a><span id="l32.129" class="difflineplus">+  // -- do not re-facet since tag A was selected</span>
<a href="#l32.130"></a><span id="l32.130" class="difflineplus">+  toggle_tag_constraints(tagA);</span>
<a href="#l32.131"></a><span id="l32.131" class="difflineplus">+  be_in_folder(folderOne);</span>
<a href="#l32.132"></a><span id="l32.132" class="difflineplus">+  assert_tag_constraints_visible(tagA, tagC);</span>
<a href="#l32.133"></a><span id="l32.133" class="difflineplus">+  assert_messages_in_view([setTagA1]);</span>
<a href="#l32.134"></a><span id="l32.134" class="difflineplus">+}</span>
<a href="#l32.135"></a><span id="l32.135" class="difflineplus">+</span>
<a href="#l32.136"></a><span id="l32.136" class="difflineplus">+/**</span>
<a href="#l32.137"></a><span id="l32.137" class="difflineplus">+ * All we are testing propagating is the text value; the text states are always</span>
<a href="#l32.138"></a><span id="l32.138" class="difflineplus">+ *  propagated and that is tested in test-filter-logic.js by</span>
<a href="#l32.139"></a><span id="l32.139" class="difflineplus">+ *  |test_filter_text_constraints_propagate|.</span>
<a href="#l32.140"></a><span id="l32.140" class="difflineplus">+ */</span>
<a href="#l32.141"></a><span id="l32.141" class="difflineplus">+function test_sticky_text() {</span>
<a href="#l32.142"></a><span id="l32.142" class="difflineplus">+  let folderOne = create_folder(&quot;QuickFilterBarStickyText1&quot;);</span>
<a href="#l32.143"></a><span id="l32.143" class="difflineplus">+  let folderTwo = create_folder(&quot;QuickFilterBarStickyText2&quot;);</span>
<a href="#l32.144"></a><span id="l32.144" class="difflineplus">+</span>
<a href="#l32.145"></a><span id="l32.145" class="difflineplus">+  be_in_folder(folderOne);</span>
<a href="#l32.146"></a><span id="l32.146" class="difflineplus">+  toggle_boolean_constraints(&quot;sticky&quot;);</span>
<a href="#l32.147"></a><span id="l32.147" class="difflineplus">+  set_filter_text(&quot;foo&quot;);</span>
<a href="#l32.148"></a><span id="l32.148" class="difflineplus">+</span>
<a href="#l32.149"></a><span id="l32.149" class="difflineplus">+  be_in_folder(folderTwo);</span>
<a href="#l32.150"></a><span id="l32.150" class="difflineplus">+  assert_filter_text(&quot;foo&quot;);</span>
<a href="#l32.151"></a><span id="l32.151" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1">new file mode 100644</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineminus">--- /dev/null</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineplus">+++ b/mail/test/mozmill/quick-filter-bar/test-toggle-bar.js</span>
<a href="#l33.4"></a><span id="l33.4" class="difflineat">@@ -0,0 +1,116 @@</span>
<a href="#l33.5"></a><span id="l33.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l33.6"></a><span id="l33.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l33.7"></a><span id="l33.7" class="difflineplus">+ *</span>
<a href="#l33.8"></a><span id="l33.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l33.9"></a><span id="l33.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l33.10"></a><span id="l33.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l33.11"></a><span id="l33.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineplus">+ *</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineplus">+ * License.</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineplus">+ *</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineplus">+ *</span>
<a href="#l33.20"></a><span id="l33.20" class="difflineplus">+ * The Initial Developer of the Original Code is the Mozilla Foundation.</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2010</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l33.23"></a><span id="l33.23" class="difflineplus">+ *</span>
<a href="#l33.24"></a><span id="l33.24" class="difflineplus">+ * Contributor(s):</span>
<a href="#l33.25"></a><span id="l33.25" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l33.26"></a><span id="l33.26" class="difflineplus">+ *</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l33.28"></a><span id="l33.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l33.29"></a><span id="l33.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l33.30"></a><span id="l33.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l33.33"></a><span id="l33.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l33.34"></a><span id="l33.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l33.35"></a><span id="l33.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l33.36"></a><span id="l33.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l33.37"></a><span id="l33.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l33.38"></a><span id="l33.38" class="difflineplus">+ *</span>
<a href="#l33.39"></a><span id="l33.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l33.40"></a><span id="l33.40" class="difflineplus">+</span>
<a href="#l33.41"></a><span id="l33.41" class="difflineplus">+/*</span>
<a href="#l33.42"></a><span id="l33.42" class="difflineplus">+ * Test that the message filter bar toggles into and out of existence and</span>
<a href="#l33.43"></a><span id="l33.43" class="difflineplus">+ * states are updated as appropriate.</span>
<a href="#l33.44"></a><span id="l33.44" class="difflineplus">+ */</span>
<a href="#l33.45"></a><span id="l33.45" class="difflineplus">+</span>
<a href="#l33.46"></a><span id="l33.46" class="difflineplus">+var MODULE_NAME = 'test-toggle-bar';</span>
<a href="#l33.47"></a><span id="l33.47" class="difflineplus">+</span>
<a href="#l33.48"></a><span id="l33.48" class="difflineplus">+const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l33.49"></a><span id="l33.49" class="difflineplus">+</span>
<a href="#l33.50"></a><span id="l33.50" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers',</span>
<a href="#l33.51"></a><span id="l33.51" class="difflineplus">+                       'quick-filter-bar-helper'];</span>
<a href="#l33.52"></a><span id="l33.52" class="difflineplus">+</span>
<a href="#l33.53"></a><span id="l33.53" class="difflineplus">+var folder;</span>
<a href="#l33.54"></a><span id="l33.54" class="difflineplus">+var setUnstarred, setStarred;</span>
<a href="#l33.55"></a><span id="l33.55" class="difflineplus">+</span>
<a href="#l33.56"></a><span id="l33.56" class="difflineplus">+function setupModule(module) {</span>
<a href="#l33.57"></a><span id="l33.57" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l33.58"></a><span id="l33.58" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l33.59"></a><span id="l33.59" class="difflineplus">+  let wh = collector.getModule('window-helpers');</span>
<a href="#l33.60"></a><span id="l33.60" class="difflineplus">+  wh.installInto(module);</span>
<a href="#l33.61"></a><span id="l33.61" class="difflineplus">+  let qfb = collector.getModule('quick-filter-bar-helper');</span>
<a href="#l33.62"></a><span id="l33.62" class="difflineplus">+  qfb.installInto(module);</span>
<a href="#l33.63"></a><span id="l33.63" class="difflineplus">+</span>
<a href="#l33.64"></a><span id="l33.64" class="difflineplus">+  folder = create_folder(&quot;QuickFilterBarToggleBar&quot;);</span>
<a href="#l33.65"></a><span id="l33.65" class="difflineplus">+  [setUnstarred, setStarred] = make_new_sets_in_folder(folder, [</span>
<a href="#l33.66"></a><span id="l33.66" class="difflineplus">+                                 {count: 1}, {count: 1}]);</span>
<a href="#l33.67"></a><span id="l33.67" class="difflineplus">+  setStarred.setStarred(true);</span>
<a href="#l33.68"></a><span id="l33.68" class="difflineplus">+}</span>
<a href="#l33.69"></a><span id="l33.69" class="difflineplus">+</span>
<a href="#l33.70"></a><span id="l33.70" class="difflineplus">+function test_filter_button_hidden_on_account_central() {</span>
<a href="#l33.71"></a><span id="l33.71" class="difflineplus">+  be_in_folder(folder.rootFolder);</span>
<a href="#l33.72"></a><span id="l33.72" class="difflineplus">+  assert_quick_filter_button_visible(false);</span>
<a href="#l33.73"></a><span id="l33.73" class="difflineplus">+}</span>
<a href="#l33.74"></a><span id="l33.74" class="difflineplus">+</span>
<a href="#l33.75"></a><span id="l33.75" class="difflineplus">+function test_visible_by_default() {</span>
<a href="#l33.76"></a><span id="l33.76" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l33.77"></a><span id="l33.77" class="difflineplus">+  assert_quick_filter_button_visible(true);</span>
<a href="#l33.78"></a><span id="l33.78" class="difflineplus">+  assert_quick_filter_bar_visible(true);</span>
<a href="#l33.79"></a><span id="l33.79" class="difflineplus">+}</span>
<a href="#l33.80"></a><span id="l33.80" class="difflineplus">+</span>
<a href="#l33.81"></a><span id="l33.81" class="difflineplus">+function test_direct_toggle() {</span>
<a href="#l33.82"></a><span id="l33.82" class="difflineplus">+  assert_quick_filter_bar_visible(true);</span>
<a href="#l33.83"></a><span id="l33.83" class="difflineplus">+  toggle_quick_filter_bar();</span>
<a href="#l33.84"></a><span id="l33.84" class="difflineplus">+  assert_quick_filter_bar_visible(false);</span>
<a href="#l33.85"></a><span id="l33.85" class="difflineplus">+  toggle_quick_filter_bar();</span>
<a href="#l33.86"></a><span id="l33.86" class="difflineplus">+  assert_quick_filter_bar_visible(true);</span>
<a href="#l33.87"></a><span id="l33.87" class="difflineplus">+}</span>
<a href="#l33.88"></a><span id="l33.88" class="difflineplus">+</span>
<a href="#l33.89"></a><span id="l33.89" class="difflineplus">+function test_control_f_triggers_display() {</span>
<a href="#l33.90"></a><span id="l33.90" class="difflineplus">+  // hide it</span>
<a href="#l33.91"></a><span id="l33.91" class="difflineplus">+  toggle_quick_filter_bar();</span>
<a href="#l33.92"></a><span id="l33.92" class="difflineplus">+  assert_quick_filter_bar_visible(false);</span>
<a href="#l33.93"></a><span id="l33.93" class="difflineplus">+</span>
<a href="#l33.94"></a><span id="l33.94" class="difflineplus">+  // focus explicitly on the thread pane so we know where the focus is.</span>
<a href="#l33.95"></a><span id="l33.95" class="difflineplus">+  mc.e(&quot;threadTree&quot;).focus();</span>
<a href="#l33.96"></a><span id="l33.96" class="difflineplus">+</span>
<a href="#l33.97"></a><span id="l33.97" class="difflineplus">+  // hit control-f</span>
<a href="#l33.98"></a><span id="l33.98" class="difflineplus">+  mc.keypress(null, &quot;f&quot;, {accelKey: true});</span>
<a href="#l33.99"></a><span id="l33.99" class="difflineplus">+</span>
<a href="#l33.100"></a><span id="l33.100" class="difflineplus">+  // now we should be visible again!</span>
<a href="#l33.101"></a><span id="l33.101" class="difflineplus">+  assert_quick_filter_bar_visible(true);</span>
<a href="#l33.102"></a><span id="l33.102" class="difflineplus">+}</span>
<a href="#l33.103"></a><span id="l33.103" class="difflineplus">+</span>
<a href="#l33.104"></a><span id="l33.104" class="difflineplus">+function test_constraints_disappear_when_collapsed() {</span>
<a href="#l33.105"></a><span id="l33.105" class="difflineplus">+  // set some constraints</span>
<a href="#l33.106"></a><span id="l33.106" class="difflineplus">+  toggle_boolean_constraints(&quot;starred&quot;);</span>
<a href="#l33.107"></a><span id="l33.107" class="difflineplus">+  assert_constraints_expressed({starred: true});</span>
<a href="#l33.108"></a><span id="l33.108" class="difflineplus">+  assert_messages_in_view(setStarred);</span>
<a href="#l33.109"></a><span id="l33.109" class="difflineplus">+</span>
<a href="#l33.110"></a><span id="l33.110" class="difflineplus">+  // collapse, now we should see them all again!</span>
<a href="#l33.111"></a><span id="l33.111" class="difflineplus">+  toggle_quick_filter_bar();</span>
<a href="#l33.112"></a><span id="l33.112" class="difflineplus">+  assert_messages_in_view([setUnstarred, setStarred]);</span>
<a href="#l33.113"></a><span id="l33.113" class="difflineplus">+</span>
<a href="#l33.114"></a><span id="l33.114" class="difflineplus">+  // uncollapse, we should still see them all!</span>
<a href="#l33.115"></a><span id="l33.115" class="difflineplus">+  toggle_quick_filter_bar();</span>
<a href="#l33.116"></a><span id="l33.116" class="difflineplus">+  assert_messages_in_view([setUnstarred, setStarred]);</span>
<a href="#l33.117"></a><span id="l33.117" class="difflineplus">+</span>
<a href="#l33.118"></a><span id="l33.118" class="difflineplus">+  // there better be no constraints left!</span>
<a href="#l33.119"></a><span id="l33.119" class="difflineplus">+  assert_constraints_expressed({});</span>
<a href="#l33.120"></a><span id="l33.120" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -63,34 +63,34 @@ Cu.import('resource:///modules/MailConst</span>
<a href="#l34.4"></a><span id="l34.4"> Cu.import('resource:///modules/mailViewManager.js');</span>
<a href="#l34.5"></a><span id="l34.5"> </span>
<a href="#l34.6"></a><span id="l34.6"> /**</span>
<a href="#l34.7"></a><span id="l34.7">  * List of keys not to export via installInto; values do not matter, we just</span>
<a href="#l34.8"></a><span id="l34.8">  *  use true.</span>
<a href="#l34.9"></a><span id="l34.9">  */</span>
<a href="#l34.10"></a><span id="l34.10"> const DO_NOT_EXPORT = {</span>
<a href="#l34.11"></a><span id="l34.11">   // magic globals</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-  MODULE_NAME: true, DO_NOT_EXPORT: true,</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+  MODULE_NAME: true, DO_NOT_EXPORT: true, installInto: true,</span>
<a href="#l34.14"></a><span id="l34.14">   // imported modules</span>
<a href="#l34.15"></a><span id="l34.15">   elib: true, mozmill: true, controller: true, frame: true, os: true,</span>
<a href="#l34.16"></a><span id="l34.16">   // convenience constants</span>
<a href="#l34.17"></a><span id="l34.17">   Ci: true, Cc: true, Cu: true, Cr: true,</span>
<a href="#l34.18"></a><span id="l34.18">   // useful constants (we do export MailViewConstants)</span>
<a href="#l34.19"></a><span id="l34.19">   nsMsgViewIndex_None: true, MailConsts: true,</span>
<a href="#l34.20"></a><span id="l34.20">   // utility functions</span>
<a href="#l34.21"></a><span id="l34.21">   MailUtils: true, MailViewManager: true,</span>
<a href="#l34.22"></a><span id="l34.22">   // internal setup functions</span>
<a href="#l34.23"></a><span id="l34.23">   setupModule: true, setupAccountStuff: true,</span>
<a href="#l34.24"></a><span id="l34.24">   // we export this separately</span>
<a href="#l34.25"></a><span id="l34.25">   teardownImporter: true,</span>
<a href="#l34.26"></a><span id="l34.26">   // internal setup flags</span>
<a href="#l34.27"></a><span id="l34.27">   initialized: false,</span>
<a href="#l34.28"></a><span id="l34.28">   // other libraries we use</span>
<a href="#l34.29"></a><span id="l34.29">   testHelperModule: true,</span>
<a href="#l34.30"></a><span id="l34.30" class="difflineminus">-  windowHelper: true</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineplus">+  windowHelper: true,</span>
<a href="#l34.32"></a><span id="l34.32"> };</span>
<a href="#l34.33"></a><span id="l34.33"> </span>
<a href="#l34.34"></a><span id="l34.34"> const EXPORT_VIA_GETTER_SETTER = {</span>
<a href="#l34.35"></a><span id="l34.35">   // These should be getters and setters instead of direct property accesses so</span>
<a href="#l34.36"></a><span id="l34.36">   // that setting them reflects across scopes.</span>
<a href="#l34.37"></a><span id="l34.37">   mc: true,</span>
<a href="#l34.38"></a><span id="l34.38"> };</span>
<a href="#l34.39"></a><span id="l34.39"> </span>
<a href="#l34.40"></a><span id="l34.40" class="difflineat">@@ -180,31 +180,36 @@ function setupModule() {</span>
<a href="#l34.41"></a><span id="l34.41">   testHelperModule.gMessageGenerator = msgGen;</span>
<a href="#l34.42"></a><span id="l34.42">   testHelperModule.gMessageScenarioFactory =</span>
<a href="#l34.43"></a><span id="l34.43">     new testHelperModule.MessageScenarioFactory(msgGen);</span>
<a href="#l34.44"></a><span id="l34.44"> </span>
<a href="#l34.45"></a><span id="l34.45">   make_new_sets_in_folders = make_new_sets_in_folder =</span>
<a href="#l34.46"></a><span id="l34.46">     testHelperModule.make_new_sets_in_folders;</span>
<a href="#l34.47"></a><span id="l34.47">   add_sets_to_folders = testHelperModule.add_sets_to_folders;</span>
<a href="#l34.48"></a><span id="l34.48"> </span>
<a href="#l34.49"></a><span id="l34.49" class="difflineplus">+  delete_message_set = testHelperModule.async_delete_messages;</span>
<a href="#l34.50"></a><span id="l34.50" class="difflineplus">+</span>
<a href="#l34.51"></a><span id="l34.51">   // use window-helper's augment_controller method to get our extra good stuff</span>
<a href="#l34.52"></a><span id="l34.52">   //  we need.</span>
<a href="#l34.53"></a><span id="l34.53">   windowHelper = collector.getModule('window-helpers');</span>
<a href="#l34.54"></a><span id="l34.54">   mc = windowHelper.wait_for_existing_window(&quot;mail:3pane&quot;);</span>
<a href="#l34.55"></a><span id="l34.55">   windowHelper.augment_controller(mc);</span>
<a href="#l34.56"></a><span id="l34.56"> </span>
<a href="#l34.57"></a><span id="l34.57">   setupAccountStuff();</span>
<a href="#l34.58"></a><span id="l34.58"> }</span>
<a href="#l34.59"></a><span id="l34.59"> </span>
<a href="#l34.60"></a><span id="l34.60"> /**</span>
<a href="#l34.61"></a><span id="l34.61">  * Install this module into the provided module.</span>
<a href="#l34.62"></a><span id="l34.62">  */</span>
<a href="#l34.63"></a><span id="l34.63"> function installInto(module) {</span>
<a href="#l34.64"></a><span id="l34.64">   setupModule();</span>
<a href="#l34.65"></a><span id="l34.65"> </span>
<a href="#l34.66"></a><span id="l34.66" class="difflineplus">+  // force the window to be a nice size we all can love.</span>
<a href="#l34.67"></a><span id="l34.67" class="difflineplus">+  mc.window.resizeTo(1024, 768);</span>
<a href="#l34.68"></a><span id="l34.68" class="difflineplus">+</span>
<a href="#l34.69"></a><span id="l34.69">   // now copy everything into the module they provided to us...</span>
<a href="#l34.70"></a><span id="l34.70">   let us = collector.getModule('folder-display-helpers');</span>
<a href="#l34.71"></a><span id="l34.71">   let self = this;</span>
<a href="#l34.72"></a><span id="l34.72">   for each (let [key, value] in Iterator(us)) {</span>
<a href="#l34.73"></a><span id="l34.73">     if (key in EXPORT_VIA_GETTER_SETTER) {</span>
<a href="#l34.74"></a><span id="l34.74">       // The value of |key| changes between iterations, so it's important to</span>
<a href="#l34.75"></a><span id="l34.75">       // capture the right key in a local variable.</span>
<a href="#l34.76"></a><span id="l34.76">       let thisKey = key;</span>
<a href="#l34.77"></a><span id="l34.77" class="difflineat">@@ -2445,16 +2450,17 @@ function throw_and_dump_view_state(aMess</span>
<a href="#l34.78"></a><span id="l34.78">   testHelperModule.dump_view_state(aController.folderDisplay.view);</span>
<a href="#l34.79"></a><span id="l34.79">   throw new Error(aMessage);</span>
<a href="#l34.80"></a><span id="l34.80"> }</span>
<a href="#l34.81"></a><span id="l34.81"> </span>
<a href="#l34.82"></a><span id="l34.82"> /** exported from messageInjection */</span>
<a href="#l34.83"></a><span id="l34.83"> var make_new_sets_in_folders;</span>
<a href="#l34.84"></a><span id="l34.84"> var make_new_sets_in_folder;</span>
<a href="#l34.85"></a><span id="l34.85"> var add_sets_to_folders;</span>
<a href="#l34.86"></a><span id="l34.86" class="difflineplus">+var delete_message_set;</span>
<a href="#l34.87"></a><span id="l34.87"> </span>
<a href="#l34.88"></a><span id="l34.88"> /**</span>
<a href="#l34.89"></a><span id="l34.89">  * Load a file in its own 'module'.</span>
<a href="#l34.90"></a><span id="l34.90">  *</span>
<a href="#l34.91"></a><span id="l34.91">  * @param aPath A path relative to the comm-central source path.</span>
<a href="#l34.92"></a><span id="l34.92">  *</span>
<a href="#l34.93"></a><span id="l34.93">  * @return An object that serves as the global scope for the loaded file.</span>
<a href="#l34.94"></a><span id="l34.94">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1">new file mode 100644</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineminus">--- /dev/null</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-quick-filter-bar-helper.js</span>
<a href="#l35.4"></a><span id="l35.4" class="difflineat">@@ -0,0 +1,292 @@</span>
<a href="#l35.5"></a><span id="l35.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l35.6"></a><span id="l35.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l35.7"></a><span id="l35.7" class="difflineplus">+ *</span>
<a href="#l35.8"></a><span id="l35.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l35.9"></a><span id="l35.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l35.10"></a><span id="l35.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l35.11"></a><span id="l35.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineplus">+ *</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineplus">+ * License.</span>
<a href="#l35.17"></a><span id="l35.17" class="difflineplus">+ *</span>
<a href="#l35.18"></a><span id="l35.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l35.19"></a><span id="l35.19" class="difflineplus">+ *</span>
<a href="#l35.20"></a><span id="l35.20" class="difflineplus">+ * The Initial Developer of the Original Code is the Mozilla Foundation.</span>
<a href="#l35.21"></a><span id="l35.21" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2010</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l35.23"></a><span id="l35.23" class="difflineplus">+ *</span>
<a href="#l35.24"></a><span id="l35.24" class="difflineplus">+ * Contributor(s):</span>
<a href="#l35.25"></a><span id="l35.25" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l35.26"></a><span id="l35.26" class="difflineplus">+ *</span>
<a href="#l35.27"></a><span id="l35.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l35.28"></a><span id="l35.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l35.29"></a><span id="l35.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l35.30"></a><span id="l35.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l35.31"></a><span id="l35.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l35.33"></a><span id="l35.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l35.36"></a><span id="l35.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l35.37"></a><span id="l35.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l35.38"></a><span id="l35.38" class="difflineplus">+ *</span>
<a href="#l35.39"></a><span id="l35.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l35.40"></a><span id="l35.40" class="difflineplus">+</span>
<a href="#l35.41"></a><span id="l35.41" class="difflineplus">+var MODULE_NAME = 'quick-filter-bar-helper';</span>
<a href="#l35.42"></a><span id="l35.42" class="difflineplus">+</span>
<a href="#l35.43"></a><span id="l35.43" class="difflineplus">+const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l35.44"></a><span id="l35.44" class="difflineplus">+</span>
<a href="#l35.45"></a><span id="l35.45" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers'];</span>
<a href="#l35.46"></a><span id="l35.46" class="difflineplus">+</span>
<a href="#l35.47"></a><span id="l35.47" class="difflineplus">+var initialized = false;</span>
<a href="#l35.48"></a><span id="l35.48" class="difflineplus">+function setupModule(module) {</span>
<a href="#l35.49"></a><span id="l35.49" class="difflineplus">+  if (initialized)</span>
<a href="#l35.50"></a><span id="l35.50" class="difflineplus">+    return;</span>
<a href="#l35.51"></a><span id="l35.51" class="difflineplus">+</span>
<a href="#l35.52"></a><span id="l35.52" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l35.53"></a><span id="l35.53" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l35.54"></a><span id="l35.54" class="difflineplus">+</span>
<a href="#l35.55"></a><span id="l35.55" class="difflineplus">+  initialized = true;</span>
<a href="#l35.56"></a><span id="l35.56" class="difflineplus">+}</span>
<a href="#l35.57"></a><span id="l35.57" class="difflineplus">+</span>
<a href="#l35.58"></a><span id="l35.58" class="difflineplus">+var EXPORT = [</span>
<a href="#l35.59"></a><span id="l35.59" class="difflineplus">+  'assert_quick_filter_button_visible',</span>
<a href="#l35.60"></a><span id="l35.60" class="difflineplus">+  'assert_quick_filter_bar_visible',</span>
<a href="#l35.61"></a><span id="l35.61" class="difflineplus">+  'toggle_quick_filter_bar',</span>
<a href="#l35.62"></a><span id="l35.62" class="difflineplus">+  'assert_constraints_expressed',</span>
<a href="#l35.63"></a><span id="l35.63" class="difflineplus">+  'toggle_boolean_constraints',</span>
<a href="#l35.64"></a><span id="l35.64" class="difflineplus">+  'toggle_tag_constraints',</span>
<a href="#l35.65"></a><span id="l35.65" class="difflineplus">+  'assert_tag_constraints_visible',</span>
<a href="#l35.66"></a><span id="l35.66" class="difflineplus">+  'assert_tag_constraints_checked',</span>
<a href="#l35.67"></a><span id="l35.67" class="difflineplus">+  'toggle_text_constraints',</span>
<a href="#l35.68"></a><span id="l35.68" class="difflineplus">+  'assert_text_constraints_checked',</span>
<a href="#l35.69"></a><span id="l35.69" class="difflineplus">+  'set_filter_text',</span>
<a href="#l35.70"></a><span id="l35.70" class="difflineplus">+  'assert_filter_text',</span>
<a href="#l35.71"></a><span id="l35.71" class="difflineplus">+  'assert_results_label_count',</span>
<a href="#l35.72"></a><span id="l35.72" class="difflineplus">+  'clear_constraints',</span>
<a href="#l35.73"></a><span id="l35.73" class="difflineplus">+];</span>
<a href="#l35.74"></a><span id="l35.74" class="difflineplus">+</span>
<a href="#l35.75"></a><span id="l35.75" class="difflineplus">+var backstage = this;</span>
<a href="#l35.76"></a><span id="l35.76" class="difflineplus">+</span>
<a href="#l35.77"></a><span id="l35.77" class="difflineplus">+function installInto(module) {</span>
<a href="#l35.78"></a><span id="l35.78" class="difflineplus">+  setupModule(backstage);</span>
<a href="#l35.79"></a><span id="l35.79" class="difflineplus">+  for each (let [, name] in Iterator(EXPORT)) {</span>
<a href="#l35.80"></a><span id="l35.80" class="difflineplus">+    module[name] = backstage[name];</span>
<a href="#l35.81"></a><span id="l35.81" class="difflineplus">+  }</span>
<a href="#l35.82"></a><span id="l35.82" class="difflineplus">+  // disable the deferred search processing!</span>
<a href="#l35.83"></a><span id="l35.83" class="difflineplus">+  mc.window.QuickFilterBarMuxer.deferredUpdateSearch =</span>
<a href="#l35.84"></a><span id="l35.84" class="difflineplus">+    mc.window.QuickFilterBarMuxer.updateSearch;</span>
<a href="#l35.85"></a><span id="l35.85" class="difflineplus">+</span>
<a href="#l35.86"></a><span id="l35.86" class="difflineplus">+  module.__teardownTest__ = _afterEveryTest;</span>
<a href="#l35.87"></a><span id="l35.87" class="difflineplus">+  _afterEveryTest.__name__ = &quot;teardownTest&quot;;</span>
<a href="#l35.88"></a><span id="l35.88" class="difflineplus">+}</span>
<a href="#l35.89"></a><span id="l35.89" class="difflineplus">+</span>
<a href="#l35.90"></a><span id="l35.90" class="difflineplus">+function _afterEveryTest() {</span>
<a href="#l35.91"></a><span id="l35.91" class="difflineplus">+  clear_constraints();</span>
<a href="#l35.92"></a><span id="l35.92" class="difflineplus">+  // make it visible if it's not</span>
<a href="#l35.93"></a><span id="l35.93" class="difflineplus">+  if (mc.e(&quot;quick-filter-bar&quot;).collapsed) {</span>
<a href="#l35.94"></a><span id="l35.94" class="difflineplus">+    toggle_quick_filter_bar();</span>
<a href="#l35.95"></a><span id="l35.95" class="difflineplus">+  }</span>
<a href="#l35.96"></a><span id="l35.96" class="difflineplus">+}</span>
<a href="#l35.97"></a><span id="l35.97" class="difflineplus">+</span>
<a href="#l35.98"></a><span id="l35.98" class="difflineplus">+/**</span>
<a href="#l35.99"></a><span id="l35.99" class="difflineplus">+ * Maps names to bar DOM ids to simplify checking.</span>
<a href="#l35.100"></a><span id="l35.100" class="difflineplus">+ */</span>
<a href="#l35.101"></a><span id="l35.101" class="difflineplus">+const nameToBarDomId = {</span>
<a href="#l35.102"></a><span id="l35.102" class="difflineplus">+  sticky: &quot;qfb-sticky&quot;,</span>
<a href="#l35.103"></a><span id="l35.103" class="difflineplus">+  unread: &quot;qfb-unread&quot;,</span>
<a href="#l35.104"></a><span id="l35.104" class="difflineplus">+  starred: &quot;qfb-starred&quot;,</span>
<a href="#l35.105"></a><span id="l35.105" class="difflineplus">+  addrbook: &quot;qfb-inaddrbook&quot;,</span>
<a href="#l35.106"></a><span id="l35.106" class="difflineplus">+  tags: &quot;qfb-tags&quot;,</span>
<a href="#l35.107"></a><span id="l35.107" class="difflineplus">+  attachments: &quot;qfb-attachment&quot;,</span>
<a href="#l35.108"></a><span id="l35.108" class="difflineplus">+};</span>
<a href="#l35.109"></a><span id="l35.109" class="difflineplus">+</span>
<a href="#l35.110"></a><span id="l35.110" class="difflineplus">+function assert_quick_filter_button_visible(aVisible) {</span>
<a href="#l35.111"></a><span id="l35.111" class="difflineplus">+  if (mc.e(&quot;qfb-show-filter-bar&quot;).style.visibility !=</span>
<a href="#l35.112"></a><span id="l35.112" class="difflineplus">+      (aVisible ? &quot;visible&quot; : &quot;hidden&quot;)) {</span>
<a href="#l35.113"></a><span id="l35.113" class="difflineplus">+    throw new Error(&quot;Quick filter bar button should be &quot; +</span>
<a href="#l35.114"></a><span id="l35.114" class="difflineplus">+                    (aVisible ? &quot;visible&quot; : &quot;collapsed&quot;));</span>
<a href="#l35.115"></a><span id="l35.115" class="difflineplus">+  }</span>
<a href="#l35.116"></a><span id="l35.116" class="difflineplus">+}</span>
<a href="#l35.117"></a><span id="l35.117" class="difflineplus">+</span>
<a href="#l35.118"></a><span id="l35.118" class="difflineplus">+function assert_quick_filter_bar_visible(aVisible) {</span>
<a href="#l35.119"></a><span id="l35.119" class="difflineplus">+  if (mc.e(&quot;quick-filter-bar&quot;).collapsed != !aVisible) {</span>
<a href="#l35.120"></a><span id="l35.120" class="difflineplus">+    throw new Error(&quot;Quick filter bar should be &quot; +</span>
<a href="#l35.121"></a><span id="l35.121" class="difflineplus">+                    (aVisible ? &quot;visible&quot; : &quot;collapsed&quot;));</span>
<a href="#l35.122"></a><span id="l35.122" class="difflineplus">+  }</span>
<a href="#l35.123"></a><span id="l35.123" class="difflineplus">+}</span>
<a href="#l35.124"></a><span id="l35.124" class="difflineplus">+</span>
<a href="#l35.125"></a><span id="l35.125" class="difflineplus">+/**</span>
<a href="#l35.126"></a><span id="l35.126" class="difflineplus">+ * Toggle the state of the message filter bar as if by a mouse click.</span>
<a href="#l35.127"></a><span id="l35.127" class="difflineplus">+ */</span>
<a href="#l35.128"></a><span id="l35.128" class="difflineplus">+function toggle_quick_filter_bar() {</span>
<a href="#l35.129"></a><span id="l35.129" class="difflineplus">+  mc.click(mc.eid(&quot;qfb-show-filter-bar&quot;));</span>
<a href="#l35.130"></a><span id="l35.130" class="difflineplus">+  wait_for_all_messages_to_load();</span>
<a href="#l35.131"></a><span id="l35.131" class="difflineplus">+}</span>
<a href="#l35.132"></a><span id="l35.132" class="difflineplus">+</span>
<a href="#l35.133"></a><span id="l35.133" class="difflineplus">+/**</span>
<a href="#l35.134"></a><span id="l35.134" class="difflineplus">+ * Assert that the state of the constraints visually expressed by the bar is</span>
<a href="#l35.135"></a><span id="l35.135" class="difflineplus">+ * consistent with the passed-in constraints.  This method does not verify</span>
<a href="#l35.136"></a><span id="l35.136" class="difflineplus">+ * that the search constraints are in effect.  Check that elsewhere.</span>
<a href="#l35.137"></a><span id="l35.137" class="difflineplus">+ */</span>
<a href="#l35.138"></a><span id="l35.138" class="difflineplus">+function assert_constraints_expressed(aConstraints) {</span>
<a href="#l35.139"></a><span id="l35.139" class="difflineplus">+  for each (let [name, domId] in Iterator(nameToBarDomId)) {</span>
<a href="#l35.140"></a><span id="l35.140" class="difflineplus">+    let expectedValue = (name in aConstraints) ? aConstraints[name] : false;</span>
<a href="#l35.141"></a><span id="l35.141" class="difflineplus">+    let domNode = mc.e(domId);</span>
<a href="#l35.142"></a><span id="l35.142" class="difflineplus">+    if (domNode.checked !== expectedValue) {</span>
<a href="#l35.143"></a><span id="l35.143" class="difflineplus">+      throw new Error(name + &quot;'s checked state should be &quot; + expectedValue);</span>
<a href="#l35.144"></a><span id="l35.144" class="difflineplus">+    }</span>
<a href="#l35.145"></a><span id="l35.145" class="difflineplus">+  }</span>
<a href="#l35.146"></a><span id="l35.146" class="difflineplus">+}</span>
<a href="#l35.147"></a><span id="l35.147" class="difflineplus">+</span>
<a href="#l35.148"></a><span id="l35.148" class="difflineplus">+/**</span>
<a href="#l35.149"></a><span id="l35.149" class="difflineplus">+ * Toggle the given filter buttons by name (from nameToBarDomId); variable</span>
<a href="#l35.150"></a><span id="l35.150" class="difflineplus">+ * argument magic enabled.</span>
<a href="#l35.151"></a><span id="l35.151" class="difflineplus">+ */</span>
<a href="#l35.152"></a><span id="l35.152" class="difflineplus">+function toggle_boolean_constraints() {</span>
<a href="#l35.153"></a><span id="l35.153" class="difflineplus">+  for (let iArg = 0; iArg &lt; arguments.length; iArg++) {</span>
<a href="#l35.154"></a><span id="l35.154" class="difflineplus">+    mc.click(mc.eid(nameToBarDomId[arguments[iArg]]));</span>
<a href="#l35.155"></a><span id="l35.155" class="difflineplus">+  }</span>
<a href="#l35.156"></a><span id="l35.156" class="difflineplus">+  wait_for_all_messages_to_load(mc);</span>
<a href="#l35.157"></a><span id="l35.157" class="difflineplus">+}</span>
<a href="#l35.158"></a><span id="l35.158" class="difflineplus">+</span>
<a href="#l35.159"></a><span id="l35.159" class="difflineplus">+/**</span>
<a href="#l35.160"></a><span id="l35.160" class="difflineplus">+ * Toggle the tag faceting buttons by tag key.  Wait for messages after.</span>
<a href="#l35.161"></a><span id="l35.161" class="difflineplus">+ */</span>
<a href="#l35.162"></a><span id="l35.162" class="difflineplus">+function toggle_tag_constraints() {</span>
<a href="#l35.163"></a><span id="l35.163" class="difflineplus">+  for (let iArg = 0; iArg &lt; arguments.length; iArg++) {</span>
<a href="#l35.164"></a><span id="l35.164" class="difflineplus">+    mc.click(mc.eid(&quot;qfb-tag-&quot; + arguments[iArg]));</span>
<a href="#l35.165"></a><span id="l35.165" class="difflineplus">+  }</span>
<a href="#l35.166"></a><span id="l35.166" class="difflineplus">+  wait_for_all_messages_to_load(mc);</span>
<a href="#l35.167"></a><span id="l35.167" class="difflineplus">+}</span>
<a href="#l35.168"></a><span id="l35.168" class="difflineplus">+</span>
<a href="#l35.169"></a><span id="l35.169" class="difflineplus">+/**</span>
<a href="#l35.170"></a><span id="l35.170" class="difflineplus">+ * Verify that tag buttons exist for exactly the given set of tag keys in the</span>
<a href="#l35.171"></a><span id="l35.171" class="difflineplus">+ *  provided variable argument list.  Ordering is significant.</span>
<a href="#l35.172"></a><span id="l35.172" class="difflineplus">+ */</span>
<a href="#l35.173"></a><span id="l35.173" class="difflineplus">+function assert_tag_constraints_visible() {</span>
<a href="#l35.174"></a><span id="l35.174" class="difflineplus">+  // the stupid bar should be visible if any arguments are specified</span>
<a href="#l35.175"></a><span id="l35.175" class="difflineplus">+  if (arguments.length &amp;&amp; mc.e(&quot;quick-filter-bar-tab-bar&quot;).collapsed)</span>
<a href="#l35.176"></a><span id="l35.176" class="difflineplus">+    throw new Error(&quot;The tag bar should not be collapsed!&quot;);</span>
<a href="#l35.177"></a><span id="l35.177" class="difflineplus">+</span>
<a href="#l35.178"></a><span id="l35.178" class="difflineplus">+  let kids = mc.e(&quot;quick-filter-bar-tab-bar&quot;).childNodes;</span>
<a href="#l35.179"></a><span id="l35.179" class="difflineplus">+  // this is bad error reporting in here for now.</span>
<a href="#l35.180"></a><span id="l35.180" class="difflineplus">+  if (kids.length != arguments.length)</span>
<a href="#l35.181"></a><span id="l35.181" class="difflineplus">+    throw new Error(&quot;Mismatch in expected tag count and actual. &quot; +</span>
<a href="#l35.182"></a><span id="l35.182" class="difflineplus">+                    &quot;Expected &quot; + arguments.length +</span>
<a href="#l35.183"></a><span id="l35.183" class="difflineplus">+                    &quot; actual &quot; + kids.length);</span>
<a href="#l35.184"></a><span id="l35.184" class="difflineplus">+  for (let iArg = 0; iArg &lt; arguments.length; iArg++) {</span>
<a href="#l35.185"></a><span id="l35.185" class="difflineplus">+    let nodeId = &quot;qfb-tag-&quot; + arguments[iArg];</span>
<a href="#l35.186"></a><span id="l35.186" class="difflineplus">+    if (nodeId != kids[iArg].id)</span>
<a href="#l35.187"></a><span id="l35.187" class="difflineplus">+      throw new Error(&quot;Mismatch at tag &quot; + iArg + &quot; expected &quot; + nodeId +</span>
<a href="#l35.188"></a><span id="l35.188" class="difflineplus">+                      &quot; but got &quot; + kids[iArg].id);</span>
<a href="#l35.189"></a><span id="l35.189" class="difflineplus">+  }</span>
<a href="#l35.190"></a><span id="l35.190" class="difflineplus">+}</span>
<a href="#l35.191"></a><span id="l35.191" class="difflineplus">+</span>
<a href="#l35.192"></a><span id="l35.192" class="difflineplus">+/**</span>
<a href="#l35.193"></a><span id="l35.193" class="difflineplus">+ * Verify that only the buttons corresponding to the provided tag keys are</span>
<a href="#l35.194"></a><span id="l35.194" class="difflineplus">+ * checked.</span>
<a href="#l35.195"></a><span id="l35.195" class="difflineplus">+ */</span>
<a href="#l35.196"></a><span id="l35.196" class="difflineplus">+function assert_tag_constraints_checked() {</span>
<a href="#l35.197"></a><span id="l35.197" class="difflineplus">+  let expected = {};</span>
<a href="#l35.198"></a><span id="l35.198" class="difflineplus">+  for (let iArg = 0; iArg &lt; arguments.length; iArg++) {</span>
<a href="#l35.199"></a><span id="l35.199" class="difflineplus">+    let nodeId = &quot;qfb-tag-&quot; + arguments[iArg];</span>
<a href="#l35.200"></a><span id="l35.200" class="difflineplus">+    expected[nodeId] = true;</span>
<a href="#l35.201"></a><span id="l35.201" class="difflineplus">+  }</span>
<a href="#l35.202"></a><span id="l35.202" class="difflineplus">+</span>
<a href="#l35.203"></a><span id="l35.203" class="difflineplus">+  let kids = mc.e(&quot;quick-filter-bar-tab-bar&quot;).childNodes;</span>
<a href="#l35.204"></a><span id="l35.204" class="difflineplus">+  for (let iNode = 0; iNode &lt; kids.length; iNode++) {</span>
<a href="#l35.205"></a><span id="l35.205" class="difflineplus">+    let node = kids[iNode];</span>
<a href="#l35.206"></a><span id="l35.206" class="difflineplus">+    if (node.checked != (node.id in expected))</span>
<a href="#l35.207"></a><span id="l35.207" class="difflineplus">+      throw new Error(&quot;node &quot; + node.id + &quot; should &quot; +</span>
<a href="#l35.208"></a><span id="l35.208" class="difflineplus">+                      ((node.id in expected) ? &quot;be &quot; : &quot;not be &quot;) + &quot;checked.&quot;);</span>
<a href="#l35.209"></a><span id="l35.209" class="difflineplus">+  }</span>
<a href="#l35.210"></a><span id="l35.210" class="difflineplus">+}</span>
<a href="#l35.211"></a><span id="l35.211" class="difflineplus">+</span>
<a href="#l35.212"></a><span id="l35.212" class="difflineplus">+const nameToTextDomId = {</span>
<a href="#l35.213"></a><span id="l35.213" class="difflineplus">+  sender: &quot;qfb-qs-sender&quot;,</span>
<a href="#l35.214"></a><span id="l35.214" class="difflineplus">+  recipients: &quot;qfb-qs-recipients&quot;,</span>
<a href="#l35.215"></a><span id="l35.215" class="difflineplus">+  subject: &quot;qfb-qs-subject&quot;,</span>
<a href="#l35.216"></a><span id="l35.216" class="difflineplus">+  body: &quot;qfb-qs-body&quot;,</span>
<a href="#l35.217"></a><span id="l35.217" class="difflineplus">+};</span>
<a href="#l35.218"></a><span id="l35.218" class="difflineplus">+</span>
<a href="#l35.219"></a><span id="l35.219" class="difflineplus">+function toggle_text_constraints() {</span>
<a href="#l35.220"></a><span id="l35.220" class="difflineplus">+  for (let iArg = 0; iArg &lt; arguments.length; iArg++) {</span>
<a href="#l35.221"></a><span id="l35.221" class="difflineplus">+    mc.click(mc.eid(nameToTextDomId[arguments[iArg]]));</span>
<a href="#l35.222"></a><span id="l35.222" class="difflineplus">+  }</span>
<a href="#l35.223"></a><span id="l35.223" class="difflineplus">+  wait_for_all_messages_to_load(mc);</span>
<a href="#l35.224"></a><span id="l35.224" class="difflineplus">+}</span>
<a href="#l35.225"></a><span id="l35.225" class="difflineplus">+</span>
<a href="#l35.226"></a><span id="l35.226" class="difflineplus">+/**</span>
<a href="#l35.227"></a><span id="l35.227" class="difflineplus">+ * Assert that the text constraint buttons are checked.  Variable-argument</span>
<a href="#l35.228"></a><span id="l35.228" class="difflineplus">+ *  support where the arguments are one of sender/recipients/subject/body.</span>
<a href="#l35.229"></a><span id="l35.229" class="difflineplus">+ */</span>
<a href="#l35.230"></a><span id="l35.230" class="difflineplus">+function assert_text_constraints_checked() {</span>
<a href="#l35.231"></a><span id="l35.231" class="difflineplus">+  let expected = {};</span>
<a href="#l35.232"></a><span id="l35.232" class="difflineplus">+  for (let iArg = 0; iArg &lt; arguments.length; iArg++) {</span>
<a href="#l35.233"></a><span id="l35.233" class="difflineplus">+    let nodeId = nameToTextDomId[arguments[iArg]];</span>
<a href="#l35.234"></a><span id="l35.234" class="difflineplus">+    expected[nodeId] = true;</span>
<a href="#l35.235"></a><span id="l35.235" class="difflineplus">+  }</span>
<a href="#l35.236"></a><span id="l35.236" class="difflineplus">+</span>
<a href="#l35.237"></a><span id="l35.237" class="difflineplus">+  let kids = mc.e(&quot;quick-filter-bar-filter-text-bar&quot;).childNodes;</span>
<a href="#l35.238"></a><span id="l35.238" class="difflineplus">+  for (let iNode = 0; iNode &lt; kids.length; iNode++) {</span>
<a href="#l35.239"></a><span id="l35.239" class="difflineplus">+    let node = kids[iNode];</span>
<a href="#l35.240"></a><span id="l35.240" class="difflineplus">+    if (node.tagName == &quot;label&quot;)</span>
<a href="#l35.241"></a><span id="l35.241" class="difflineplus">+      continue;</span>
<a href="#l35.242"></a><span id="l35.242" class="difflineplus">+    if (node.checked != (node.id in expected))</span>
<a href="#l35.243"></a><span id="l35.243" class="difflineplus">+      throw new Error(&quot;node &quot; + node.id + &quot; should &quot; +</span>
<a href="#l35.244"></a><span id="l35.244" class="difflineplus">+                      ((node.id in expected) ? &quot;be &quot; : &quot;not be &quot;) + &quot;checked.&quot;);</span>
<a href="#l35.245"></a><span id="l35.245" class="difflineplus">+  }</span>
<a href="#l35.246"></a><span id="l35.246" class="difflineplus">+}</span>
<a href="#l35.247"></a><span id="l35.247" class="difflineplus">+</span>
<a href="#l35.248"></a><span id="l35.248" class="difflineplus">+/**</span>
<a href="#l35.249"></a><span id="l35.249" class="difflineplus">+ * Set the text in the text filter box, trigger it like enter was pressed, then</span>
<a href="#l35.250"></a><span id="l35.250" class="difflineplus">+ *  wait for all messages to load.</span>
<a href="#l35.251"></a><span id="l35.251" class="difflineplus">+ */</span>
<a href="#l35.252"></a><span id="l35.252" class="difflineplus">+function set_filter_text(aText) {</span>
<a href="#l35.253"></a><span id="l35.253" class="difflineplus">+  // We're not testing the reliability of the textbox widget; just poke our text</span>
<a href="#l35.254"></a><span id="l35.254" class="difflineplus">+  // in and trigger the command logic.</span>
<a href="#l35.255"></a><span id="l35.255" class="difflineplus">+  let textbox = mc.e(&quot;qfb-qs-textbox&quot;);</span>
<a href="#l35.256"></a><span id="l35.256" class="difflineplus">+  textbox.value = aText;</span>
<a href="#l35.257"></a><span id="l35.257" class="difflineplus">+  textbox.doCommand();</span>
<a href="#l35.258"></a><span id="l35.258" class="difflineplus">+  wait_for_all_messages_to_load(mc);</span>
<a href="#l35.259"></a><span id="l35.259" class="difflineplus">+}</span>
<a href="#l35.260"></a><span id="l35.260" class="difflineplus">+</span>
<a href="#l35.261"></a><span id="l35.261" class="difflineplus">+function assert_filter_text(aText) {</span>
<a href="#l35.262"></a><span id="l35.262" class="difflineplus">+  let textbox = mc.e(&quot;qfb-qs-textbox&quot;);</span>
<a href="#l35.263"></a><span id="l35.263" class="difflineplus">+  if (textbox.value != aText)</span>
<a href="#l35.264"></a><span id="l35.264" class="difflineplus">+    throw new Error(&quot;Expected text filter value of '&quot; + aText + &quot;' but got '&quot; +</span>
<a href="#l35.265"></a><span id="l35.265" class="difflineplus">+                    textbox.value);</span>
<a href="#l35.266"></a><span id="l35.266" class="difflineplus">+}</span>
<a href="#l35.267"></a><span id="l35.267" class="difflineplus">+</span>
<a href="#l35.268"></a><span id="l35.268" class="difflineplus">+/**</span>
<a href="#l35.269"></a><span id="l35.269" class="difflineplus">+ * Assert that the results label is telling us there are aCount messages</span>
<a href="#l35.270"></a><span id="l35.270" class="difflineplus">+ *  using the appropriate string.</span>
<a href="#l35.271"></a><span id="l35.271" class="difflineplus">+ */</span>
<a href="#l35.272"></a><span id="l35.272" class="difflineplus">+function assert_results_label_count(aCount) {</span>
<a href="#l35.273"></a><span id="l35.273" class="difflineplus">+  let resultsLabel = mc.e(&quot;qfb-results-label&quot;);</span>
<a href="#l35.274"></a><span id="l35.274" class="difflineplus">+  if (aCount == 0) {</span>
<a href="#l35.275"></a><span id="l35.275" class="difflineplus">+    if (resultsLabel.value != resultsLabel.getAttribute(&quot;noresultsstring&quot;))</span>
<a href="#l35.276"></a><span id="l35.276" class="difflineplus">+      throw new Error(&quot;results label should be displaying the no messages case&quot;);</span>
<a href="#l35.277"></a><span id="l35.277" class="difflineplus">+  }</span>
<a href="#l35.278"></a><span id="l35.278" class="difflineplus">+  else {</span>
<a href="#l35.279"></a><span id="l35.279" class="difflineplus">+    let s = resultsLabel.value;</span>
<a href="#l35.280"></a><span id="l35.280" class="difflineplus">+    s = s.substring(0, s.indexOf(&quot; &quot;));</span>
<a href="#l35.281"></a><span id="l35.281" class="difflineplus">+    if (parseInt(s) !== aCount)</span>
<a href="#l35.282"></a><span id="l35.282" class="difflineplus">+     throw new Error(&quot;Result count is displaying &quot; + s + &quot; but should show &quot; +</span>
<a href="#l35.283"></a><span id="l35.283" class="difflineplus">+                     aCount);</span>
<a href="#l35.284"></a><span id="l35.284" class="difflineplus">+  }</span>
<a href="#l35.285"></a><span id="l35.285" class="difflineplus">+}</span>
<a href="#l35.286"></a><span id="l35.286" class="difflineplus">+</span>
<a href="#l35.287"></a><span id="l35.287" class="difflineplus">+/**</span>
<a href="#l35.288"></a><span id="l35.288" class="difflineplus">+ * Clear active constraints via any means necessary; state cleanup for testing,</span>
<a href="#l35.289"></a><span id="l35.289" class="difflineplus">+ *  not to be used as part of a test.  Unlike normal clearing, this will kill</span>
<a href="#l35.290"></a><span id="l35.290" class="difflineplus">+ *  the sticky bit.</span>
<a href="#l35.291"></a><span id="l35.291" class="difflineplus">+ *</span>
<a href="#l35.292"></a><span id="l35.292" class="difflineplus">+ * This is automatically called by the test teardown helper.</span>
<a href="#l35.293"></a><span id="l35.293" class="difflineplus">+ */</span>
<a href="#l35.294"></a><span id="l35.294" class="difflineplus">+function clear_constraints() {</span>
<a href="#l35.295"></a><span id="l35.295" class="difflineplus">+  mc.window.QuickFilterBarMuxer._testHelperResetFilterState();</span>
<a href="#l35.296"></a><span id="l35.296" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-window-helpers.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-window-helpers.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -596,16 +596,25 @@ var AugmentEverybodyWith = {</span>
<a href="#l36.4"></a><span id="l36.4">      * @return an elementlib.Elem for the element with the given id on the</span>
<a href="#l36.5"></a><span id="l36.5">      *  window's document.</span>
<a href="#l36.6"></a><span id="l36.6">      */</span>
<a href="#l36.7"></a><span id="l36.7">     eid: function _get_elementid_by_id_helper(aId, aQuery) {</span>
<a href="#l36.8"></a><span id="l36.8">       return new elib.Elem(this.e(aId, aQuery));</span>
<a href="#l36.9"></a><span id="l36.9">     },</span>
<a href="#l36.10"></a><span id="l36.10"> </span>
<a href="#l36.11"></a><span id="l36.11">     /**</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineplus">+     * Wait for an element with the given id to show up.</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+     *</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineplus">+     * @param aId The DOM id of the element you want to wait to show up.</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineplus">+     */</span>
<a href="#l36.16"></a><span id="l36.16" class="difflineplus">+    ewait: function _wait_for_element_by_id_helper(aId) {</span>
<a href="#l36.17"></a><span id="l36.17" class="difflineplus">+      this.waitForElement(new elib.ID(this.window.document, aId));</span>
<a href="#l36.18"></a><span id="l36.18" class="difflineplus">+    },</span>
<a href="#l36.19"></a><span id="l36.19" class="difflineplus">+</span>
<a href="#l36.20"></a><span id="l36.20" class="difflineplus">+    /**</span>
<a href="#l36.21"></a><span id="l36.21">      * Find an element in the anonymous subtree of an element in the document</span>
<a href="#l36.22"></a><span id="l36.22">      *  identified by its id.  You would use this to dig into XBL bindings that</span>
<a href="#l36.23"></a><span id="l36.23">      *  are not doing what you want.  For example, jerks that don't focus right.</span>
<a href="#l36.24"></a><span id="l36.24">      *</span>
<a href="#l36.25"></a><span id="l36.25">      * Examples:</span>
<a href="#l36.26"></a><span id="l36.26">      *  // by class of the node</span>
<a href="#l36.27"></a><span id="l36.27">      *  a(&quot;searchVal0&quot;, {class: &quot;search-value-textbox&quot;});</span>
<a href="#l36.28"></a><span id="l36.28">      *  // when the thing is vaguely deck-like</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mail/themes/gnomestripe/jar.mn</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mail/themes/gnomestripe/jar.mn</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -35,16 +35,17 @@ classic.jar:</span>
<a href="#l37.4"></a><span id="l37.4">   skin/classic/messenger/icons/exclude.png                    (mail/icons/exclude.png)</span>
<a href="#l37.5"></a><span id="l37.5">   skin/classic/messenger/icons/exclude-selected.png           (mail/icons/exclude-selected.png)</span>
<a href="#l37.6"></a><span id="l37.6">   skin/classic/messenger/icons/zoomout.png                    (mail/icons/zoomout.png)</span>
<a href="#l37.7"></a><span id="l37.7">   skin/classic/messenger/icons/zoomout-hover.png              (mail/icons/zoomout-hover.png)</span>
<a href="#l37.8"></a><span id="l37.8">   skin/classic/messenger/dialogs.css                          (mail/dialogs.css)</span>
<a href="#l37.9"></a><span id="l37.9">   skin/classic/messenger/newmailalert.css                     (mail/newmailalert.css)</span>
<a href="#l37.10"></a><span id="l37.10">   skin/classic/messenger/tabmail.css                          (mail/tabmail.css)</span>
<a href="#l37.11"></a><span id="l37.11">   skin/classic/messenger/editContactOverlay.css               (mail/editContactOverlay.css)</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineplus">+  skin/classic/messenger/quickFilterBar.css                   (mail/quickFilterBar.css)</span>
<a href="#l37.13"></a><span id="l37.13">   skin/classic/messenger/starred48.png                        (mail/starred48.png)</span>
<a href="#l37.14"></a><span id="l37.14">   skin/classic/messenger/contactStarred.png                   (mail/contactStarred.png)</span>
<a href="#l37.15"></a><span id="l37.15">   skin/classic/messenger/starContact.png                      (mail/starContact.png)</span>
<a href="#l37.16"></a><span id="l37.16">   skin/classic/messenger/activity/activity.css                (mail/activity/activity.css)</span>
<a href="#l37.17"></a><span id="l37.17">   skin/classic/messenger/activity/buttons.png                 (mail/activity/buttons.png)</span>
<a href="#l37.18"></a><span id="l37.18">   skin/classic/messenger/activity/defaultProcessIcon.png      (mail/activity/defaultProcessIcon.png)</span>
<a href="#l37.19"></a><span id="l37.19">   skin/classic/messenger/activity/defaultEventIcon.png        (mail/activity/defaultEventIcon.png)</span>
<a href="#l37.20"></a><span id="l37.20">   skin/classic/messenger/activity/defaultWarningIcon.png      (mail/activity/defaultWarningIcon.png)</span>
<a href="#l37.21"></a><span id="l37.21" class="difflineat">@@ -144,16 +145,20 @@ classic.jar:</span>
<a href="#l37.22"></a><span id="l37.22">   skin/classic/messenger/icons/remote-blocked.png             (mail/icons/remote-blocked.png)</span>
<a href="#l37.23"></a><span id="l37.23">   skin/classic/messenger/icons/phishing.png                   (mail/icons/phishing.png)</span>
<a href="#l37.24"></a><span id="l37.24">   skin/classic/messenger/icons/junk.png                       (mail/icons/junk.png)</span>
<a href="#l37.25"></a><span id="l37.25">   skin/classic/messenger/icons/check.gif                      (mail/icons/check.gif)</span>
<a href="#l37.26"></a><span id="l37.26">   skin/classic/messenger/icons/notchecked.gif                 (mail/icons/notchecked.gif)</span>
<a href="#l37.27"></a><span id="l37.27">   skin/classic/messenger/icons/online.png                     (mail/icons/online.png)</span>
<a href="#l37.28"></a><span id="l37.28">   skin/classic/messenger/icons/offline.png                    (mail/icons/offline.png)</span>
<a href="#l37.29"></a><span id="l37.29">   skin/classic/messenger/icons/row.png                        (mail/icons/row.png)</span>
<a href="#l37.30"></a><span id="l37.30" class="difflineplus">+  skin/classic/messenger/icons/black_pin.png                  (mail/icons/black_pin.png)</span>
<a href="#l37.31"></a><span id="l37.31" class="difflineplus">+  skin/classic/messenger/icons/filter.png                     (mail/icons/filter.png)</span>
<a href="#l37.32"></a><span id="l37.32" class="difflineplus">+  skin/classic/messenger/icons/filterbar.png                  (mail/icons/filterbar.png)</span>
<a href="#l37.33"></a><span id="l37.33" class="difflineplus">+  skin/classic/messenger/icons/red_pin.png                    (mail/icons/red_pin.png)</span>
<a href="#l37.34"></a><span id="l37.34"> % skin communicator classic/1.0 %skin/classic/communicator/</span>
<a href="#l37.35"></a><span id="l37.35">   skin/classic/communicator/communicator.css                      (mail/communicator.css)</span>
<a href="#l37.36"></a><span id="l37.36">   skin/classic/communicator/icons/smileys/smiley-smile.png        (mail/icons/smiley-smile.png)</span>
<a href="#l37.37"></a><span id="l37.37">   skin/classic/communicator/icons/smileys/smiley-frown.png        (mail/icons/smiley-frown.png)</span>
<a href="#l37.38"></a><span id="l37.38">   skin/classic/communicator/icons/smileys/smiley-wink.png         (mail/icons/smiley-wink.png)</span>
<a href="#l37.39"></a><span id="l37.39">   skin/classic/communicator/icons/smileys/smiley-tongue-out.png  (mail/icons/smiley-tongue-out.png)</span>
<a href="#l37.40"></a><span id="l37.40">   skin/classic/communicator/icons/smileys/smiley-laughing.png (mail/icons/smiley-laughing.png)</span>
<a href="#l37.41"></a><span id="l37.41">   skin/classic/communicator/icons/smileys/smiley-embarassed.png  (mail/icons/smiley-embarassed.png)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1">new file mode 100644</span>
<a href="#l38.2"></a><span id="l38.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..e7051bc25668dc31ffc475549c5c31ff6455be77</span>
<a href="#l38.3"></a><span id="l38.3">GIT binary patch
literal 602
zc$@)R0;T&lt;lP)&lt;h;3K|Lk000e1NJLTq000mG000mO1^@s6AM^iV00001b5ch_0Itp)
z=&gt;Px#32;bRa{vGh*8l(w*8xH(n|J^K00(qQO+^RV10D|vGMZjuVE_OD&gt;`6pHR5;6(
zlfR4FU&gt;L{0d3{ZLDyS%LMOx_)`~lM8l!_pSbTQYZ|A1qc(lr5x4jm7&amp;b?9Hvu3fsk
z;LvPWQ~Cou+$~uIa};f2Oq!(2U6CW#J3sJ_-wzM(_j!aUif|QKmP-JBan4=b0Er6|
zLQVl3;}(#sVM?h{EEX%2(ieLPF2n71yWH&gt;hNfbp#vMe9oN^mi@QLR?XjIo4in&amp;|a&lt;
zcPOQwZjuOt!GH;Za7rnCC`l4=90%oc8I48*^Z6XQu5ScE_z{Mo5r*M60A~QsIOiS!
zBqT|40DJ)uESJj~rIhA!IpVr5*6TIu^?H&amp;q_8^nVbS%qy2A~1p{ct$^0|3Hqjj}A?
zCxjS&lt;LV=~z=|nc0MYGuir4+iZZ%xzu9t6P?&amp;iN*`1&lt;tt{hT&amp;t&amp;vR0nwA(cwO_k9?K
zf%EfoFQ3mp-3`a?0q5KV@L{{%LJ$N@CKEW0gKoD=E0xMeRaNi)R{#KE80xld+q2nh
zvsf&amp;CGREvqr*lv$l@621&lt;ak#?u4(79&gt;$&gt;UHYW3B1-J0+FC*$$hZnatmjIlPQ^!2|Q
z&lt;8I;NL*D^-et8e0(dd;ZilbVsmYz&lt;hzk?vSr)ipVtso9nRgXncJn=m55rCJProBZJ
oMSDL*QH~Tvc@squ_L?A$ze*_iFu_aY*Z=?k07*qoM6N&lt;$f`tMG{r~^~</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1">new file mode 100644</span>
<a href="#l39.2"></a><span id="l39.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..7ed2d204bd64aecb67948c374d66f0ee035bdc48</span>
<a href="#l39.3"></a><span id="l39.3">GIT binary patch
literal 426
zc$@*M0agBqP)&lt;h;3K|Lk000e1NJLTq000sI000aK1^@s6ZxZdi0000PbVXQnQ*UN;
zcVTj606}DLVr3vnZDD6+Qe|Oed2z{QJOBUzOi4sRRCwBqlCes}KoEv^_YMRJ&lt;N&lt;_$
zK7dKULQoK*SXjo!Lh%WF0E+{!I7LwrJ3+xte2HM8mL`oHC|(*-u1sN}NY*bJBpkU*
z7JmMjoy?#4Cy`of;kxc5d@QA$7eai42Kgm&lt;I}F1QQR7J4wx{5G@I+$^fmdRO_&gt;{N{
zuORkSCDa5R@CcS@(E0rfQ)c21U&lt;({o2`S#_fld@fx&gt;!K;9l8Lkb*w4yiG_ZtZz-Rl
zamR6FrBJqP8tk$nwK=FiIPEZNSMWYNnJ5;&gt;m!UPpPU=`|@?Z&lt;GY2q#x&amp;WL;5&amp;62N!
z9{Fvp&amp;!7KC4dP9(0Zj15{Q@Ee+{W5YvB~#+9mlayN{KX0g=JZPLS+Z&gt;ZD=?D7&gt;kJA
z73-eo=_E;nX__Jk0;xt!dw{?VJO&amp;O2i&amp;?W_7{B~)ZP;OFGtfEMW1{O(JNgk|0PtLo
UX_aH9bpQYW07*qoM6N&lt;$f-20h&lt;NyEw</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1">new file mode 100644</span>
<a href="#l40.2"></a><span id="l40.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..b67b78340e5ca561f8f118b97d25df8bb3297f3c</span>
<a href="#l40.3"></a><span id="l40.3">GIT binary patch
literal 2741
zc$@*X3QF~fP)&lt;h;3K|Lk000e1NJLTq002+`000mO1^@s6fl2tm00004b3#c}2nYxW
zd&lt;bNS00009a7bBm000fw000fw0YWI7cmMzZ8FWQhbW?9;ba!ELWdL_~cP?peYja~^
zaAhuUa%Y?FJQ@H13NlGVK~z|U)tGru6lWU7pRap*1{gq&amp;;Zh&lt;ox}4$&gt;B(4q$9uO%F
z9*M;4W&lt;_&gt;$SewMSMnu*m)?|}48;&gt;&lt;v-PJ@*;S~Zz4LLMgC6EY-D3`c`cRWCJ80PHh
znZCaLLm?jMnyOf}`&amp;La=SM~Sw`+UE8`~BV?LMg?Aikf1=8uO^~z!Llq1bI*ZYl_K0
zhGnY=VHy-!dd8SXrTf*cTJ`oIhSmO4rPK&amp;eLI`tMq{&lt;(Q78RX(AZG6oCX&gt;lW=dVlB
zQ17M1i&lt;e)!{r&amp;?3`2BXxhQX;zpSN`$@tS|!KhKy)OYcXwYSr6=Sk9+;_LI5({rg7~
zLVzosS7&gt;QjiA#{hQFnvb($&lt;(xK=xBgwThy^&gt;lGnMQkNu3yF9%0_3Z4~=AYx=WHK&gt;2
zU+yiIA+L-cJtpwX+0%;IY_5RH&lt;`)(g+I!Y9Kj)$M8#TqmSECJ?8y&gt;rydH7M2uZH6m
z-LIBmwI5|=X6d7%1`vRPQi_Q1NHTfiB!4YoKfbGwl5ZlyqO&gt;v5gYZbq5G2GVB6e_`
zAvh&gt;FUsTu=B_&amp;%&amp;-meFf$;9~RHJcI=&lt;Co&gt;k$O(LOWC~_ZpUDnOPM%2^b&gt;q!zH9Z&amp;m
z5AMw-z(N3V0M39y27wWPhJqd;APj(L0&lt;&lt;VpUGw;)sg?KeFehf@5|&amp;EGq17istABWS
zO)(j4%%f-ji+3U`iZLQQlCfB&gt;L9Y)4App-i5fTzg&gt;&lt;)WsZf-7HT3XsiU!_`|RtKlc
zp&lt;cXnK@dd|563*&gt;_sF2ZoUgB+q3+1x&gt;JL9$pYg&amp;AFE!i`yrhJr{NW=;pzd%T&gt;JA@;
z*XzaOnVD#9Yn!!V#fs3Pq9RK#zyp&gt;0aw5Va_r%8~5uH{GuPDZt&amp;7JVk`G61tQ5468
z8p5IFI0zn3Ow+OY&gt;|GV5nX__oD*&gt;QpD&gt;GBWafJ-)8?Mnsg@(q=^ba5MDg(j+stxh!
z#o7}GpK1MJ2WKaQu&gt;iC~mZX=BdGy3B^a#PyKQDpR)(ub&lt;Jn!ns4@nYX?Y7-@&lt;EpAs
zN-4Q`&gt;4M;P3Nt;DC+I}$zc(Alqy&lt;DpMqyM+YCvVx!K#%jS7sCx6!ZzP2j0-c&lt;ouMB
z6ns~E2!dNcTx&gt;j!A3p|{;6lHCfn104S|k7q(EAG0f`qsvqEH6y76I*65&amp;eQf(cIFA
zy80gw9v%rvA-HT2&amp;}o-2WJo;AJNZQbP*Y480+gi8Iz2iy*EVS6^wz-mj9u5^0RR&amp;O
z-@rsBWkw4(dd^kDs3(udJ(QS}!D_gV?x-P3sf%~kHZ(LSUauE+yA3v5H{5O~nwpzc
zm&amp;&lt;je@9G0Q9xnv|Ns_2X@&amp;tLkLO)rSq2B261NslZ__Xu@mB^KEzFBm~&gt;-&lt;yYCFYMx
zO+`&amp;@Ep%EfCQO)!#-;`s!VF*-7B-um7X+cRN5=qwA}h%tz{z$eE_b_e!R&amp;@Cd(maF
zoU_?%osuHsREHDo-ELek3t$M~&lt;Xy=CV9cW`!?OF^kDElQ+Ck-upz@EP(n(Nn4OIRU
zsE)NzEYE&gt;@_5!LM*Df}?sj8OTzKOE3GB&amp;th(Dz?{^%YZh&lt;Op0YCwR9T4UNtCX8!&gt;a
z)jz7btgMXf3!o%PR&lt;Gzq%)mi&lt;hG8~yoNi50;?Mv~w;2}8_48xkz=6n`oE1oceG3*W
z2)rF$d|Z6~u;C+6T~!IIts6s!CZnpV3I&gt;A#zaBFdhray|zJ7js6&gt;@Vy!CZYWK$p|i
z(rvY&amp;+bQ7ORUU4S0E^WM7w@XI+Z{)3b{o1JZk)TyL-2ZVt*Z+zr&gt;mvMfFjE?ue5Fb
z&gt;{Rs(fhrbI=SHa3La6qYp!}zxVk3xO4iqI6jbCO9Zrl0AV}2+9&lt;8}yV&amp;Ys+ymNstj
zU*BFq%w`Kd+_VK7HhzT8&amp;TB9&amp;e~XMy8^7rEnYQhH0u-gMJ388x;Gke)9FrE1Hg;S9
z!w`f7g~H?Y^g&lt;jwcrapP;{rg`&lt;vm)R54$QPI3zzIF$tAbm1t@{hH&gt;M@;fv2JV6}GR
zvBy%ed-pC7mc``Blc3k@qq@4-0N_RsbU2+W&gt;+262W8)LZuM8Tv+yWXKj!A-(f8Q+%
z0pC_vW{*r6#m0qcV0XH3=-V2FcevK{7%=8h8NhG8-_E^vy0++**fGm|Ks`V0j`)Ex
z323Ou@W`U`X=5J!;&amp;uQ_mlfnD4;}V&amp;M*2h@&amp;%2O6Zyp$i1t9&gt;X6k4qg6DLg4oj-qW
z#*(G4&amp;3*6P)mv}Ydw9pP3l95?z`%ZihEM|t!@%qHqRV1NWJG^-UhROzVn%3a7={fS
z?ps$^HwD0Jg@uIy8ZCKg%G4&gt;S_&lt;RpKI&lt;Ax}it?1x&lt;-)WlrhymS*s^&amp;Gq92MzMtVBR
z%RfU)OUvrglJd@8fWOaszGCgV)l*NNY+I;OB~Ddny#jev(c(9b0&gt;HB6%QBmq8W&amp;Mj
zO_r$ILRG9;{kPS3oWiOiR}hAq58~?sE(su7fT{o}7*-EekqCf&amp;eN~XhBfOeEF5RcC
ztp$`)aGVwz&amp;GjKcmSsqi2#(Vtb8?o?y7eEt4B!@k+1ax$my~RuUQ&gt;JME900nKZC)5
zh=?d$y?W(Vh}JIn`};$bq%Z)W)TQTnMyt_iaQ5tZ^S{&lt;_oc)LA=N(x0!Me$cqCim;
zj87krtjx#pN$DqOINGqbw4{7VPu|`!X5q`P?FF#6ug$$&lt;dZ!Y=y~dUsL5%&amp;PCi#E~
z1o6#)sxTl72LcB`{16Z}O0;(#8VR88cBReg7&lt;uW^d3ZeTUU&amp;?1{ftvpwHKmB!@*{E
zB=?nl&amp;YWkfHf-AP#J&amp;UjDl#W#&gt;LVf|?tmyOGFnfxLc_8r0f6V-@Ja;NuXz;!wrncS
znmv1V0vL7u#EFwKrazH`Z9BK2;Yh&gt;UPfN=FbaT#Mbdc8Qg0lP#X&amp;liEg!RfXTEF`-
zq5116g5VNC*a!p&lt;n5qRZwlA&amp;VcAMMUPQc-?!)~|2X6uI4di`g!b;EAA!r`#v^qEs|
zyWN(%d6@s){DW?XD`(H1-F!z!I~YO`5fOEx6{uht7Q1%s&lt;{do08UWmG9z4$j0HUL#
zBl4fi^W^0}EBNZQjd5|Y8B?cC#rB=sQD0Yo2Rz`W3j8I4Qgx8qdIIN&lt;7V^BMp;;Df
zzm&gt;d}m}7g&gt;cSgp|4*{iGhV_l_OKW#Hw&gt;3347o&lt;EoLaWiRH~JsB@mva3RUpd&gt;T3U{a
zPN#F{y?iWQy!7B3rZ=YT*s){x@ZrP#l9GmM{rvpU+S-Ql@^Y8QBb0CZc-tNT;CTpO
z6xn&gt;uta&lt;bG&lt;&gt;&lt;KDuCv&gt;1pa4XV2k*cCcU-z~xlee&amp;FZ?ZByG{2D%lW?|i?$8Mxk_)3
zswpNuj7I+#hS8?VqIID$k2c+|oiJf+JSAL{s;ats&lt;sb|Zp^#D4)zvNcS_c3N7Ay#3
z7_vf=#Yv(l1#3C(l+(?&gt;yY=I(yKY{WJLjp@02TxXhiI(U?wfBpD5Y!4KK;yeS3eK(
v@2vl)c=5#-IZ+gEnK5~um+m&amp;W_r!ky;64ABYKoaw00000NkvXXu0mjfs!c8s</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1">new file mode 100644</span>
<a href="#l41.2"></a><span id="l41.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..8f06471545ca860cf8da01cf0d2226740ee48f93</span>
<a href="#l41.3"></a><span id="l41.3">GIT binary patch
literal 633
zc$@)w0*3vGP)&lt;h;3K|Lk000e1NJLTq000mG000mO1^@s6AM^iV00004b3#c}2nYxW
zd&lt;bNS00009a7bBm000fw000fw0YWI7cmMzZ8FWQhbW?9;ba!ELWdL_~cP?peYja~^
zaAhuUa%Y?FJQ@H10rp8mK~y-6mD5ja6G0dT@Mm^*x7$Q(17+O}i&amp;UsYFN)og)Jtg#
zg6+W%;K7p@@wBCBi+J$ZQpkb_KY?d2-V9bzOlAFxDHTdkDuS4lkc7rv$826NMnbc-
z?E`Zf-XF~SFpP+&gt;H!foafSN-T^jz+V6g4aZ&gt;i}jB8twsH#temX&amp;m0&amp;y)d$=&gt;65ujs
z$eeo@GnwSn&lt;fIfbHsLZhdMLnU%;1c9XGcbo*5DxjTrOiOlj&amp;0=&gt;FGfT%K^FstZTsV
z1=Eyvg8)g&gt;gq2R?d#QxSg@P})+aG=dUI@GcumNDhArc*c0l370&gt;jYdIR+QK|%i`M5
z5Pk@OL_7{&amp;E~DCL(924Ni0DNdxYB8eb=T-JW^uqft*ZL5Sd1S}Byh&amp;Ip-K{-udV$m
z?d-f4z_df;N4DS)eG7r~7a&lt;y&lt;@8g7`z$e0!%}sn#WKm6z&amp;2|s&gt;038It!)B`mp=l_*
zd5sE}AY~odzdZdYyEv!)7XW||cvcO==Etoqf4g4)x_x!FX^)Th8-_8eC`!H?i39+=
zssZsz5WGdLo(fv6&lt;$ONhv~9az*Yz=3mhb+nG3qb;UFZV&lt;H#*y1x}CkFs_IfIm5LXO
z#oaIrPp+=ye(noICA&amp;B`qpIq%5aK+5TdOO%`yiqtpZNu6Vt&amp;E7M@0KS;jsAwqLc9!
Ts!6F{00000NkvXXu0mjfqMZ^m</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1">new file mode 100644</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineminus">--- /dev/null</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineplus">+++ b/mail/themes/gnomestripe/mail/quickFilterBar.css</span>
<a href="#l42.4"></a><span id="l42.4" class="difflineat">@@ -0,0 +1,117 @@</span>
<a href="#l42.5"></a><span id="l42.5" class="difflineplus">+@import url(&quot;chrome://messenger/content/quickFilterBar.css&quot;);</span>
<a href="#l42.6"></a><span id="l42.6" class="difflineplus">+</span>
<a href="#l42.7"></a><span id="l42.7" class="difflineplus">+/* :::: Filter Tab Bar Button :::: */</span>
<a href="#l42.8"></a><span id="l42.8" class="difflineplus">+</span>
<a href="#l42.9"></a><span id="l42.9" class="difflineplus">+#qfb-show-filter-bar {</span>
<a href="#l42.10"></a><span id="l42.10" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/filter.png&quot;);</span>
<a href="#l42.11"></a><span id="l42.11" class="difflineplus">+  -moz-border-start: 2px solid;</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineplus">+  -moz-border-end: none;</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+  -moz-border-left-colors: rgba(0,0,0,0.25) rgba(255,255,255,0.15);</span>
<a href="#l42.14"></a><span id="l42.14" class="difflineplus">+  -moz-border-right-colors: rgba(0,0,0,0.25) rgba(255,255,255,0.15);</span>
<a href="#l42.15"></a><span id="l42.15" class="difflineplus">+  margin: 0;</span>
<a href="#l42.16"></a><span id="l42.16" class="difflineplus">+  padding: 0 4px;</span>
<a href="#l42.17"></a><span id="l42.17" class="difflineplus">+}</span>
<a href="#l42.18"></a><span id="l42.18" class="difflineplus">+</span>
<a href="#l42.19"></a><span id="l42.19" class="difflineplus">+#qfb-show-filter-bar:hover {</span>
<a href="#l42.20"></a><span id="l42.20" class="difflineplus">+  background-color: rgba(0,0,0,0.10);</span>
<a href="#l42.21"></a><span id="l42.21" class="difflineplus">+}</span>
<a href="#l42.22"></a><span id="l42.22" class="difflineplus">+</span>
<a href="#l42.23"></a><span id="l42.23" class="difflineplus">+#qfb-show-filter-bar:hover:active,</span>
<a href="#l42.24"></a><span id="l42.24" class="difflineplus">+#qfb-show-filter-bar[checked] {</span>
<a href="#l42.25"></a><span id="l42.25" class="difflineplus">+  background-color: rgba(0,0,0,0.20);</span>
<a href="#l42.26"></a><span id="l42.26" class="difflineplus">+}</span>
<a href="#l42.27"></a><span id="l42.27" class="difflineplus">+</span>
<a href="#l42.28"></a><span id="l42.28" class="difflineplus">+#qfb-show-filter-bar &gt; .toolbarbutton-icon {</span>
<a href="#l42.29"></a><span id="l42.29" class="difflineplus">+  padding: 0 3px;</span>
<a href="#l42.30"></a><span id="l42.30" class="difflineplus">+}</span>
<a href="#l42.31"></a><span id="l42.31" class="difflineplus">+</span>
<a href="#l42.32"></a><span id="l42.32" class="difflineplus">+#qfb-show-filter-bar &gt; .toolbarbutton-text {</span>
<a href="#l42.33"></a><span id="l42.33" class="difflineplus">+  display: none;</span>
<a href="#l42.34"></a><span id="l42.34" class="difflineplus">+}</span>
<a href="#l42.35"></a><span id="l42.35" class="difflineplus">+</span>
<a href="#l42.36"></a><span id="l42.36" class="difflineplus">+/* :::: Filter Bar :::: */</span>
<a href="#l42.37"></a><span id="l42.37" class="difflineplus">+</span>
<a href="#l42.38"></a><span id="l42.38" class="difflineplus">+#threadTree[filterActive=&quot;matches&quot;] {</span>
<a href="#l42.39"></a><span id="l42.39" class="difflineplus">+  outline: 1px solid #4e9a06;</span>
<a href="#l42.40"></a><span id="l42.40" class="difflineplus">+}</span>
<a href="#l42.41"></a><span id="l42.41" class="difflineplus">+</span>
<a href="#l42.42"></a><span id="l42.42" class="difflineplus">+#threadTree[filterActive=&quot;nomatches&quot;] {</span>
<a href="#l42.43"></a><span id="l42.43" class="difflineplus">+  outline: 1px solid #cc0000;</span>
<a href="#l42.44"></a><span id="l42.44" class="difflineplus">+}</span>
<a href="#l42.45"></a><span id="l42.45" class="difflineplus">+</span>
<a href="#l42.46"></a><span id="l42.46" class="difflineplus">+/* :::: Filter Buttons :::: */</span>
<a href="#l42.47"></a><span id="l42.47" class="difflineplus">+</span>
<a href="#l42.48"></a><span id="l42.48" class="difflineplus">+#quick-filter-bar #qfb-sticky,</span>
<a href="#l42.49"></a><span id="l42.49" class="difflineplus">+#quick-filter-bar #qfb-sticky[checked] {</span>
<a href="#l42.50"></a><span id="l42.50" class="difflineplus">+  background: none;</span>
<a href="#l42.51"></a><span id="l42.51" class="difflineplus">+  border-width: 0;</span>
<a href="#l42.52"></a><span id="l42.52" class="difflineplus">+  -moz-border-image: none;</span>
<a href="#l42.53"></a><span id="l42.53" class="difflineplus">+}</span>
<a href="#l42.54"></a><span id="l42.54" class="difflineplus">+</span>
<a href="#l42.55"></a><span id="l42.55" class="difflineplus">+#qfb-sticky {</span>
<a href="#l42.56"></a><span id="l42.56" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/black_pin.png&quot;);</span>
<a href="#l42.57"></a><span id="l42.57" class="difflineplus">+}</span>
<a href="#l42.58"></a><span id="l42.58" class="difflineplus">+</span>
<a href="#l42.59"></a><span id="l42.59" class="difflineplus">+#qfb-sticky[checked] {</span>
<a href="#l42.60"></a><span id="l42.60" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/red_pin.png&quot;);</span>
<a href="#l42.61"></a><span id="l42.61" class="difflineplus">+}</span>
<a href="#l42.62"></a><span id="l42.62" class="difflineplus">+</span>
<a href="#l42.63"></a><span id="l42.63" class="difflineplus">+/* we use both IDs so we are more precise than the other # toolbarbutton rules */</span>
<a href="#l42.64"></a><span id="l42.64" class="difflineplus">+#quick-filter-bar #qfb-sticky:hover {</span>
<a href="#l42.65"></a><span id="l42.65" class="difflineplus">+  text-shadow: none;</span>
<a href="#l42.66"></a><span id="l42.66" class="difflineplus">+  background: none;</span>
<a href="#l42.67"></a><span id="l42.67" class="difflineplus">+  border: 1px solid transparent;</span>
<a href="#l42.68"></a><span id="l42.68" class="difflineplus">+  -moz-border-radius: 0;</span>
<a href="#l42.69"></a><span id="l42.69" class="difflineplus">+  border-width: 0;</span>
<a href="#l42.70"></a><span id="l42.70" class="difflineplus">+}</span>
<a href="#l42.71"></a><span id="l42.71" class="difflineplus">+</span>
<a href="#l42.72"></a><span id="l42.72" class="difflineplus">+</span>
<a href="#l42.73"></a><span id="l42.73" class="difflineplus">+#qfb-closebutton {</span>
<a href="#l42.74"></a><span id="l42.74" class="difflineplus">+  list-style-image: url(&quot;chrome://global/skin/icons/closeSidebar.png&quot;);</span>
<a href="#l42.75"></a><span id="l42.75" class="difflineplus">+  -moz-image-region: rect(0px, 14px, 14px, 0px);</span>
<a href="#l42.76"></a><span id="l42.76" class="difflineplus">+}</span>
<a href="#l42.77"></a><span id="l42.77" class="difflineplus">+</span>
<a href="#l42.78"></a><span id="l42.78" class="difflineplus">+#qfb-unread {</span>
<a href="#l42.79"></a><span id="l42.79" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/filterbar.png&quot;);</span>
<a href="#l42.80"></a><span id="l42.80" class="difflineplus">+  -moz-image-region: rect(0px, 16px, 16px, 0px);</span>
<a href="#l42.81"></a><span id="l42.81" class="difflineplus">+}</span>
<a href="#l42.82"></a><span id="l42.82" class="difflineplus">+</span>
<a href="#l42.83"></a><span id="l42.83" class="difflineplus">+#qfb-starred {</span>
<a href="#l42.84"></a><span id="l42.84" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/filterbar.png&quot;);</span>
<a href="#l42.85"></a><span id="l42.85" class="difflineplus">+  -moz-image-region: rect(0px, 32px, 16px, 16px);</span>
<a href="#l42.86"></a><span id="l42.86" class="difflineplus">+}</span>
<a href="#l42.87"></a><span id="l42.87" class="difflineplus">+</span>
<a href="#l42.88"></a><span id="l42.88" class="difflineplus">+.qfb-starred-nostar {</span>
<a href="#l42.89"></a><span id="l42.89" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/starContact.png&quot;);</span>
<a href="#l42.90"></a><span id="l42.90" class="difflineplus">+  -moz-image-region:rect(0px 32px 16px 16px);</span>
<a href="#l42.91"></a><span id="l42.91" class="difflineplus">+}</span>
<a href="#l42.92"></a><span id="l42.92" class="difflineplus">+</span>
<a href="#l42.93"></a><span id="l42.93" class="difflineplus">+#qfb-inaddrbook {</span>
<a href="#l42.94"></a><span id="l42.94" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/filterbar.png&quot;);</span>
<a href="#l42.95"></a><span id="l42.95" class="difflineplus">+  -moz-image-region: rect(0px, 48px, 16px, 32px);</span>
<a href="#l42.96"></a><span id="l42.96" class="difflineplus">+}</span>
<a href="#l42.97"></a><span id="l42.97" class="difflineplus">+</span>
<a href="#l42.98"></a><span id="l42.98" class="difflineplus">+#qfb-tags {</span>
<a href="#l42.99"></a><span id="l42.99" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/filterbar.png&quot;);</span>
<a href="#l42.100"></a><span id="l42.100" class="difflineplus">+  -moz-image-region: rect(0px, 64px, 16px, 48px);</span>
<a href="#l42.101"></a><span id="l42.101" class="difflineplus">+}</span>
<a href="#l42.102"></a><span id="l42.102" class="difflineplus">+</span>
<a href="#l42.103"></a><span id="l42.103" class="difflineplus">+#qfb-attachment {</span>
<a href="#l42.104"></a><span id="l42.104" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/filterbar.png&quot;);</span>
<a href="#l42.105"></a><span id="l42.105" class="difflineplus">+  -moz-image-region: rect(0px, 80px, 16px, 64px);</span>
<a href="#l42.106"></a><span id="l42.106" class="difflineplus">+}</span>
<a href="#l42.107"></a><span id="l42.107" class="difflineplus">+</span>
<a href="#l42.108"></a><span id="l42.108" class="difflineplus">+#qfb-results-label {</span>
<a href="#l42.109"></a><span id="l42.109" class="difflineplus">+  color: GrayText;</span>
<a href="#l42.110"></a><span id="l42.110" class="difflineplus">+}</span>
<a href="#l42.111"></a><span id="l42.111" class="difflineplus">+</span>
<a href="#l42.112"></a><span id="l42.112" class="difflineplus">+#quick-filter-bar[filterActive=&quot;matches&quot;] #qfb-results-label {</span>
<a href="#l42.113"></a><span id="l42.113" class="difflineplus">+  color: #4e9a06;</span>
<a href="#l42.114"></a><span id="l42.114" class="difflineplus">+}</span>
<a href="#l42.115"></a><span id="l42.115" class="difflineplus">+</span>
<a href="#l42.116"></a><span id="l42.116" class="difflineplus">+#quick-filter-bar[filterActive=&quot;nomatches&quot;] #qfb-results-label {</span>
<a href="#l42.117"></a><span id="l42.117" class="difflineplus">+  color: #cc0000;</span>
<a href="#l42.118"></a><span id="l42.118" class="difflineplus">+}</span>
<a href="#l42.119"></a><span id="l42.119" class="difflineplus">+</span>
<a href="#l42.120"></a><span id="l42.120" class="difflineplus">+#qfb-qs-textbox {</span>
<a href="#l42.121"></a><span id="l42.121" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/mail/themes/gnomestripe/mail/searchBox.css</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/mail/themes/gnomestripe/mail/searchBox.css</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -69,8 +69,21 @@</span>
<a href="#l43.4"></a><span id="l43.4">   -moz-appearance: none;</span>
<a href="#l43.5"></a><span id="l43.5">   padding: 0px !important;</span>
<a href="#l43.6"></a><span id="l43.6">   border: none !important;</span>
<a href="#l43.7"></a><span id="l43.7"> }</span>
<a href="#l43.8"></a><span id="l43.8"> </span>
<a href="#l43.9"></a><span id="l43.9"> .quick-search-clearbutton &gt; .toolbarbutton-icon {</span>
<a href="#l43.10"></a><span id="l43.10">   -moz-margin-end: 0px; /* override toolkit's default value */</span>
<a href="#l43.11"></a><span id="l43.11"> }</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineplus">+</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+/* things from xul.css that only exist if Thunderbird did not define </span>
<a href="#l43.14"></a><span id="l43.14" class="difflineplus">+ * AUTOCOMPLETE_OLD_STYLE </span>
<a href="#l43.15"></a><span id="l43.15" class="difflineplus">+ */</span>
<a href="#l43.16"></a><span id="l43.16" class="difflineplus">+</span>
<a href="#l43.17"></a><span id="l43.17" class="difflineplus">+.autocomplete-history-dropmarker {</span>
<a href="#l43.18"></a><span id="l43.18" class="difflineplus">+  display: none;</span>
<a href="#l43.19"></a><span id="l43.19" class="difflineplus">+}</span>
<a href="#l43.20"></a><span id="l43.20" class="difflineplus">+</span>
<a href="#l43.21"></a><span id="l43.21" class="difflineplus">+.autocomplete-history-dropmarker[enablehistory=&quot;true&quot;] {</span>
<a href="#l43.22"></a><span id="l43.22" class="difflineplus">+  display: -moz-box;</span>
<a href="#l43.23"></a><span id="l43.23" class="difflineplus">+  -moz-binding: url(&quot;chrome://global/content/bindings/autocomplete.xml#history-dropmarker&quot;);</span>
<a href="#l43.24"></a><span id="l43.24" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/mail/themes/pinstripe/jar.mn</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/mail/themes/pinstripe/jar.mn</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -28,16 +28,17 @@ classic.jar:</span>
<a href="#l44.4"></a><span id="l44.4">   skin/classic/messenger/folderMenus.css                         (mail/folderMenus.css)</span>
<a href="#l44.5"></a><span id="l44.5">   skin/classic/messenger/folderPane.css                          (mail/folderPane.css)</span>
<a href="#l44.6"></a><span id="l44.6">   skin/classic/messenger/subscribe.css                           (mail/subscribe.css)</span>
<a href="#l44.7"></a><span id="l44.7">   skin/classic/messenger/virtualFolderListDialog.css             (mail/virtualFolderListDialog.css)</span>
<a href="#l44.8"></a><span id="l44.8">   skin/classic/messenger/searchDialog.css                        (mail/searchDialog.css)</span>
<a href="#l44.9"></a><span id="l44.9">   skin/classic/messenger/filterDialog.css                        (mail/filterDialog.css)</span>
<a href="#l44.10"></a><span id="l44.10">   skin/classic/messenger/tabmail.css                             (mail/tabmail.css)</span>
<a href="#l44.11"></a><span id="l44.11">   skin/classic/messenger/editContactOverlay.css                  (mail/editContactOverlay.css)</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineplus">+  skin/classic/messenger/quickFilterBar.css                      (mail/quickFilterBar.css)</span>
<a href="#l44.13"></a><span id="l44.13">   skin/classic/messenger/starred48.png                           (mail/starred48.png)</span>
<a href="#l44.14"></a><span id="l44.14">   skin/classic/messenger/starIcons.png                           (mail/starIcons.png)</span>
<a href="#l44.15"></a><span id="l44.15">   skin/classic/messenger/activity/activity.css                   (mail/activity/activity.css)</span>
<a href="#l44.16"></a><span id="l44.16">   skin/classic/messenger/activity/buttons.png                    (mail/activity/buttons.png)  </span>
<a href="#l44.17"></a><span id="l44.17">   skin/classic/messenger/activity/defaultProcessIcon.png         (mail/activity/defaultProcessIcon.png)</span>
<a href="#l44.18"></a><span id="l44.18">   skin/classic/messenger/activity/defaultEventIcon.png           (mail/activity/defaultEventIcon.png)</span>
<a href="#l44.19"></a><span id="l44.19">   skin/classic/messenger/activity/defaultWarningIcon.png         (mail/activity/defaultWarningIcon.png)</span>
<a href="#l44.20"></a><span id="l44.20">   skin/classic/messenger/activity/undoIcon.png                   (mail/activity/undoIcon.png)</span>
<a href="#l44.21"></a><span id="l44.21" class="difflineat">@@ -212,16 +213,20 @@ classic.jar:</span>
<a href="#l44.22"></a><span id="l44.22">   skin/classic/messenger/icons/zoomout-hover.png                 (mail/icons/zoomout-hover.png)</span>
<a href="#l44.23"></a><span id="l44.23">   skin/classic/messenger/icons/timeline.png                      (mail/icons/timeline.png)</span>
<a href="#l44.24"></a><span id="l44.24">   skin/classic/messenger/icons/timeline-inverted.png             (mail/icons/timeline-inverted.png)</span>
<a href="#l44.25"></a><span id="l44.25">   skin/classic/messenger/icons/empty-search-results.png          (mail/icons/empty-search-results.png)</span>
<a href="#l44.26"></a><span id="l44.26">   skin/classic/messenger/icons/symbolic-forward.png              (mail/icons/symbolic-forward.png)</span>
<a href="#l44.27"></a><span id="l44.27">   skin/classic/messenger/icons/symbolic-reply.png                (mail/icons/symbolic-reply.png)</span>
<a href="#l44.28"></a><span id="l44.28">   skin/classic/messenger/icons/symbolic-replyall.png             (mail/icons/symbolic-replyall.png)</span>
<a href="#l44.29"></a><span id="l44.29">   skin/classic/messenger/icons/symbolic-replylist.png            (mail/icons/symbolic-replylist.png)</span>
<a href="#l44.30"></a><span id="l44.30" class="difflineplus">+  skin/classic/messenger/icons/black_pin.png                     (mail/icons/black_pin.png)</span>
<a href="#l44.31"></a><span id="l44.31" class="difflineplus">+  skin/classic/messenger/icons/filter.png                        (mail/icons/filter.png)</span>
<a href="#l44.32"></a><span id="l44.32" class="difflineplus">+  skin/classic/messenger/icons/red_pin.png                       (mail/icons/red_pin.png)</span>
<a href="#l44.33"></a><span id="l44.33" class="difflineplus">+  skin/classic/messenger/icons/tag1616.png                       (mail/icons/tag1616.png)</span>
<a href="#l44.34"></a><span id="l44.34">   skin/classic/messenger/tabs/alltabs-box-bkgnd-icon.png              (mail/tabs/alltabs-box-bkgnd-icon.png)</span>
<a href="#l44.35"></a><span id="l44.35">   skin/classic/messenger/tabs/alltabs-box-overflow-bkgnd-animate.png  (mail/tabs/alltabs-box-overflow-bkgnd-animate.png)</span>
<a href="#l44.36"></a><span id="l44.36">   skin/classic/messenger/tabs/newtab.png                              (mail/tabs/newtab.png)</span>
<a href="#l44.37"></a><span id="l44.37">   skin/classic/messenger/tabs/tab-arrow-end.png                       (mail/tabs/tab-arrow-end.png)</span>
<a href="#l44.38"></a><span id="l44.38">   skin/classic/messenger/tabs/tab-arrow-start.png                     (mail/tabs/tab-arrow-start.png)</span>
<a href="#l44.39"></a><span id="l44.39">   skin/classic/messenger/tabs/tab-bkgnd.png                           (mail/tabs/tab-bkgnd.png)</span>
<a href="#l44.40"></a><span id="l44.40">   skin/classic/messenger/tabs/tabDragIndicator.png                    (mail/tabs/tabDragIndicator.png)</span>
<a href="#l44.41"></a><span id="l44.41">   skin/classic/messenger/tabs/tabbrowser-tabs-bkgnd.png               (mail/tabs/tabbrowser-tabs-bkgnd.png)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1">new file mode 100644</span>
<a href="#l45.2"></a><span id="l45.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..fe73f1ce1539637ccac2555c503e2636f1054a25</span>
<a href="#l45.3"></a><span id="l45.3">GIT binary patch
literal 688
zc$@*S0#E&amp;kP)&lt;h;3K|Lk000e1NJLTq000mG000mO1^@s6AM^iV0000PbVXQnQ*UN;
zcVTj606}DLVr3vnZDD6+Qe|Oed2z{QJOBU!Qb|NXRCwB4Q#*?jQ4~HinIw~BAP*62
z0xp3C8;Le4Vj8Wor3e8*-9{`d76ff9`~|YIot@aY2)fHQvXzCqjVqR$CdOz|BoLAi
z^M1_ueV1IBc;Im7p2zo{#~q_sEQ)EGvRp1@u~_ij!2N&lt;@7~cefQzny%_DQSNlG$vg
zay-uyQ&amp;xgN8^)bbDD)BMG440SC$8%%FfB}`SgQ|uUd3XuN8xZ-#^bRJ27{YOIMI~_
z0s&amp;QlAB188IS9vYG#Y&amp;vkH^KfZC%mQ-x`Uut^pum3#&gt;a}H^~BK8I49{ybb@&gt;d_LEJ
zYo`_qh9`O;{eEA1y`CBn?AHPQ1~Ko0!5~p8(9h8GH2@@j1&gt;+`|?CEssAvsA0nbF?G
zR4VnDm9Z*-|Agxv^z&lt;J9^ci}52etsduK?gR?lzN&lt;ERje=1+uz!yS)M5T~v3&lt;R#-J#
z;8eaVG|M_ez$TcVCzDBW97iSBYBedB%N*z*#O&amp;*2HAH&gt;kr1@Zm!{H%%7Os=KZ!{Xx
z?RLrTV!(T-@C!iHTB(+vDw9{JE=~_@Mzh(JN~I$Ce4f=ArBdl6oldKlsPil^Dkk5G
zeq&amp;(20C&gt;4tt#WvM#2gd~h5KmfLn4v5iufPg6!T0@n~z05PiPzM?1Fs``#J6pu$}E(
zF835bp?bak35k}@Q!^mif3gSX9r(8KeaIMW&lt;7Fn3DWUvSr_(vsEtvX8(Npz3)g$Pc
z2B)1r8fI_}AeT_h3)&amp;2nrkvSqHiR&lt;@jX=3S2WN~neA8w_gN((B9n9nww)OU}00RKQ
Wdx3ldApk`H0000&lt;MNUMnLSTZAM=vx0</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1">new file mode 100644</span>
<a href="#l46.2"></a><span id="l46.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..7ed2d204bd64aecb67948c374d66f0ee035bdc48</span>
<a href="#l46.3"></a><span id="l46.3">GIT binary patch
literal 426
zc$@*M0agBqP)&lt;h;3K|Lk000e1NJLTq000sI000aK1^@s6ZxZdi0000PbVXQnQ*UN;
zcVTj606}DLVr3vnZDD6+Qe|Oed2z{QJOBUzOi4sRRCwBqlCes}KoEv^_YMRJ&lt;N&lt;_$
zK7dKULQoK*SXjo!Lh%WF0E+{!I7LwrJ3+xte2HM8mL`oHC|(*-u1sN}NY*bJBpkU*
z7JmMjoy?#4Cy`of;kxc5d@QA$7eai42Kgm&lt;I}F1QQR7J4wx{5G@I+$^fmdRO_&gt;{N{
zuORkSCDa5R@CcS@(E0rfQ)c21U&lt;({o2`S#_fld@fx&gt;!K;9l8Lkb*w4yiG_ZtZz-Rl
zamR6FrBJqP8tk$nwK=FiIPEZNSMWYNnJ5;&gt;m!UPpPU=`|@?Z&lt;GY2q#x&amp;WL;5&amp;62N!
z9{Fvp&amp;!7KC4dP9(0Zj15{Q@Ee+{W5YvB~#+9mlayN{KX0g=JZPLS+Z&gt;ZD=?D7&gt;kJA
z73-eo=_E;nX__Jk0;xt!dw{?VJO&amp;O2i&amp;?W_7{B~)ZP;OFGtfEMW1{O(JNgk|0PtLo
UX_aH9bpQYW07*qoM6N&lt;$f-20h&lt;NyEw</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1">new file mode 100644</span>
<a href="#l47.2"></a><span id="l47.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..431f0902cf0420d2f261915d7371a402b92f6e75</span>
<a href="#l47.3"></a><span id="l47.3">GIT binary patch
literal 900
zc$@)*1AF|5P)&lt;h;3K|Lk000e1NJLTq000mG000mO1^@s6AM^iV0000PbVXQnQ*UN;
zcVTj606}DLVr3vnZDD6+Qe|Oed2z{QJOBU#CP_p=RCwA&lt;Q%i3XR}}u{&amp;b2*$h7j9{
z@uN+IDhNVIh)1DF5fUsAVZlSJ3PgyC6;-9KSeGENL9mLDKth5Q`~XxIu%c?kLnKr&lt;
zMNv%TD0bX9fpP5d+&lt;9EiwN2A=b&gt;_^R*FEPuXEccb5Y&amp;JGNy`p-zIMWd%q_sbYXR$I
zflZt$&lt;S=^nEQ+sRVeaDs0=f=KdXE1{4v_Ya6%3wO6(ab__N4{wHfO-5bP9z%djQvk
zijtkvrEUW0Cw+}QvWAj}&gt;){BNR#&amp;l9`!^ek7)a-H*n8|4l_3Dn2bczRI$_-eGAea`
z-%6$quMPC0Moz6*42DE3(U%B&gt;VsQt;p&lt;ue5Q=61S%I^It4X5vmRxEzJo`|F7OEiT*
zI21y}Fiy9HSk32iH^C{=bL$l0stUeRC&amp;4;!rsfFL8Vy(kBxlsLra`!FIx{$Ub+ZvZ
zf|WV}9WW7zJRticoiSVQ`EfE$md(aWwcXBa+LG0|VeAvGgKsliur(29m@V#yPjwED
zV5QMGI#(_i2&amp;2g$*E?!H5Banu@f?m5401Lq9P#j*T&lt;*KAh5^jH1E?|#rt$aeEM6=w
z;&amp;Zc=W&lt;3BEF`*uSL#;Jk*L#^vr6voB1W+mg=4YV457VZJr~iC_*=)`0z)jX0pRT0V
zn&lt;&gt;+D1uqKu{2RlzUD!6qKoW0+jXN~T{&amp;cD_oXMVxj|?yPq+`8NavBigeF=&lt;zTI&lt;$y
z`LczzH52*5=68!_{9dg&gt;J9rR(Rjculb3dL+?%MT-Y`4J_i0a}5mAL)D_Zthz*dkKt
z=}I(;XXP?Nj{9-jZ1K{eu`#n+D*d`XH+RKdUWTYtI?To&lt;CNQ{tbR)skl&lt;oW8Z+{lw
zzZ9&lt;bgnB*s%iHODJ9q3jkQo{(mFMTLyS9Bus&lt;rk!@Z!u26b{?)zapllo-Z(Vl&gt;RaP
zv+viHE}Bff4~N4))ERrcRH;19X0yAQrd6~X1c#4})%+?$G#0h8YHL#y7tnwHJkV-&amp;
z?9FELn&amp;)|iXf%3NyG3BAITSDb6r_L%ahNzpele0!rK5MHGl&amp;B|Z4c*M8y_F{bX_lg
a5nurK-Csp&gt;kAjc@0000&lt;MNUMnLSTZ&amp;u${dC</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1">new file mode 100644</span>
<a href="#l48.2"></a><span id="l48.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..4950ed6661a71ebd2684d81ecde66e3a524a2c35</span>
<a href="#l48.3"></a><span id="l48.3">GIT binary patch
literal 826
zc$@(`1I7G_P)&lt;h;3K|Lk000e1NJLTq000mG000mO1^@s6AM^iV0000PbVXQnQ*UN;
zcVTj606}DLVr3vnZDD6+Qe|Oed2z{QJOBU!+(|@1RCwBiQ(0&gt;hQ561WGLt&lt;MjaFJj
zp+N-S)QAf%D42&amp;X6p?6aTdRUUKwk`QPl7+d7xxDj)Vfqm5v*cSk=kHm^+g4(MSZZC
zrJ7kYGnwnX(?+TyJ#e_^o^!sl-pk#-a~I%wVNOK4DoNpHhY$b+gq}=N742ERP}phP
zwx;Vk6h($yR-kDrDwPTZ+pY?+m~&lt;(TSl%8Cg&lt;W8cIF5s1=q*D-!@b`oCU#Jjfxn2C
zq{x+3iIttA*XKs8Rvij5psE_prqJR%Shsdf&gt;%3U3&amp;oV9lKLPxHZ%T?r;Wz}DO#j5e
zg9jdd{``e_y&amp;?tkuq+#bC}Pvb4NY}*^KO}@75pOr&amp;7@C&gt;1n=IxANlxUZ2y&lt;9Ux`RT
ztObteAo5j2!T}_c$=3S%1vgF86n_WMHH~J1+xxCv9W95C92rlnSixJC&lt;pu~**LyF2
zBKy7siC&amp;tUnp+wg8txetGcZ+wu7T!pqs8Nm+@_7|J%LaVx^9548o2trgi}v#oP3~T
z=xqT(zkpO~d(+}Y3vbX$0z7euI~Z1hMyn}KPSOFY5Mbi^3mKPlJm$y3fG&gt;;_{VHC4
zm_#VxLr&gt;4{ws&lt;_A;a`uAJ}b*ITN*T)m97;5k;mPffopFBL?t#e2UUx1$THkn(azwd
zTN@w$&lt;n?5;*}hV#l-RO)%Mw8l=)fG@&amp;;7u;VTWdxz_aBW6%Zwl&lt;84u_S~?$w&lt;sg0N
z(7@R&lt;r?+{i-OS~3nL@F+CYjvY==1p?s|H5KRM?yd%eDcnfTOKZtX@_J)v%FHrw1=y
zIG&gt;_edFDz(d-v^ol+PE5p~&gt;WFZj5X`mUWrQhE^ub#(bDB{zH-7J$nYef6o(D`AMFP
zd~}(~Ovh}@2eVM5tGoL#11NIYWhOJ-Y+&amp;{n_*y%ion3?U7m|FTNSI7@;b|Ywv&gt;#Uk
z)lTmWb|}wnZ|}IqY`wiVy6E|XGJC=n&lt;;wKWw0;RN03?}maj!Kp^Z)&lt;=07*qoM6N&lt;$
Ef)ogT^8f$&lt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1">new file mode 100644</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineminus">--- /dev/null</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineplus">+++ b/mail/themes/pinstripe/mail/quickFilterBar.css</span>
<a href="#l49.4"></a><span id="l49.4" class="difflineat">@@ -0,0 +1,206 @@</span>
<a href="#l49.5"></a><span id="l49.5" class="difflineplus">+@import url(&quot;chrome://messenger/content/quickFilterBar.css&quot;);</span>
<a href="#l49.6"></a><span id="l49.6" class="difflineplus">+</span>
<a href="#l49.7"></a><span id="l49.7" class="difflineplus">+/* :::: Filter Tab Bar Button :::: */</span>
<a href="#l49.8"></a><span id="l49.8" class="difflineplus">+</span>
<a href="#l49.9"></a><span id="l49.9" class="difflineplus">+#qfb-show-filter-bar {</span>
<a href="#l49.10"></a><span id="l49.10" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/filter.png&quot;);</span>
<a href="#l49.11"></a><span id="l49.11" class="difflineplus">+  -moz-border-start: 2px solid;</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineplus">+  -moz-border-end: none;</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineplus">+  -moz-border-left-colors: rgba(0,0,0,0.25) rgba(255,255,255,0.15);</span>
<a href="#l49.14"></a><span id="l49.14" class="difflineplus">+  -moz-border-right-colors: rgba(0,0,0,0.25) rgba(255,255,255,0.15);</span>
<a href="#l49.15"></a><span id="l49.15" class="difflineplus">+  margin: 0;</span>
<a href="#l49.16"></a><span id="l49.16" class="difflineplus">+  padding: 0 4px;</span>
<a href="#l49.17"></a><span id="l49.17" class="difflineplus">+}</span>
<a href="#l49.18"></a><span id="l49.18" class="difflineplus">+</span>
<a href="#l49.19"></a><span id="l49.19" class="difflineplus">+#qfb-show-filter-bar:hover {</span>
<a href="#l49.20"></a><span id="l49.20" class="difflineplus">+  background-color: rgba(0,0,0,0.10);</span>
<a href="#l49.21"></a><span id="l49.21" class="difflineplus">+}</span>
<a href="#l49.22"></a><span id="l49.22" class="difflineplus">+</span>
<a href="#l49.23"></a><span id="l49.23" class="difflineplus">+#qfb-show-filter-bar:hover:active,</span>
<a href="#l49.24"></a><span id="l49.24" class="difflineplus">+#qfb-show-filter-bar[checked] {</span>
<a href="#l49.25"></a><span id="l49.25" class="difflineplus">+  background-color: rgba(0,0,0,0.20);</span>
<a href="#l49.26"></a><span id="l49.26" class="difflineplus">+}</span>
<a href="#l49.27"></a><span id="l49.27" class="difflineplus">+</span>
<a href="#l49.28"></a><span id="l49.28" class="difflineplus">+#qfb-show-filter-bar &gt; .toolbarbutton-icon {</span>
<a href="#l49.29"></a><span id="l49.29" class="difflineplus">+  padding: 0 3px;</span>
<a href="#l49.30"></a><span id="l49.30" class="difflineplus">+}</span>
<a href="#l49.31"></a><span id="l49.31" class="difflineplus">+</span>
<a href="#l49.32"></a><span id="l49.32" class="difflineplus">+#qfb-show-filter-bar &gt; .toolbarbutton-text {</span>
<a href="#l49.33"></a><span id="l49.33" class="difflineplus">+  display: none;</span>
<a href="#l49.34"></a><span id="l49.34" class="difflineplus">+}</span>
<a href="#l49.35"></a><span id="l49.35" class="difflineplus">+</span>
<a href="#l49.36"></a><span id="l49.36" class="difflineplus">+/* :::: Filter Bar :::: */</span>
<a href="#l49.37"></a><span id="l49.37" class="difflineplus">+</span>
<a href="#l49.38"></a><span id="l49.38" class="difflineplus">+#quick-filter-bar {</span>
<a href="#l49.39"></a><span id="l49.39" class="difflineplus">+  height: 25px;</span>
<a href="#l49.40"></a><span id="l49.40" class="difflineplus">+}</span>
<a href="#l49.41"></a><span id="l49.41" class="difflineplus">+</span>
<a href="#l49.42"></a><span id="l49.42" class="difflineplus">+#quick-filter-bar-main-bar {</span>
<a href="#l49.43"></a><span id="l49.43" class="difflineplus">+  background: -moz-linear-gradient(top, #eaeaea, #d1d1d1);</span>
<a href="#l49.44"></a><span id="l49.44" class="difflineplus">+  border-bottom: 1px solid #bebebe;</span>
<a href="#l49.45"></a><span id="l49.45" class="difflineplus">+}</span>
<a href="#l49.46"></a><span id="l49.46" class="difflineplus">+</span>
<a href="#l49.47"></a><span id="l49.47" class="difflineplus">+#quick-filter-bar-expando {</span>
<a href="#l49.48"></a><span id="l49.48" class="difflineplus">+  border-top: 1px solid #f9faf9;</span>
<a href="#l49.49"></a><span id="l49.49" class="difflineplus">+  background: #eaeaea;</span>
<a href="#l49.50"></a><span id="l49.50" class="difflineplus">+}</span>
<a href="#l49.51"></a><span id="l49.51" class="difflineplus">+</span>
<a href="#l49.52"></a><span id="l49.52" class="difflineplus">+#quick-filter-bar[filterActive=&quot;matches&quot;] {</span>
<a href="#l49.53"></a><span id="l49.53" class="difflineplus">+}</span>
<a href="#l49.54"></a><span id="l49.54" class="difflineplus">+</span>
<a href="#l49.55"></a><span id="l49.55" class="difflineplus">+#threadTree[filterActive=&quot;matches&quot;] {</span>
<a href="#l49.56"></a><span id="l49.56" class="difflineplus">+  background: -moz-repeating-linear-gradient(top, #ecf3fe 0, #ecf3fe 18px, white 18px, white 36px);</span>
<a href="#l49.57"></a><span id="l49.57" class="difflineplus">+}</span>
<a href="#l49.58"></a><span id="l49.58" class="difflineplus">+</span>
<a href="#l49.59"></a><span id="l49.59" class="difflineplus">+#quick-filter-bar[filterActive=&quot;nomatches&quot;] {</span>
<a href="#l49.60"></a><span id="l49.60" class="difflineplus">+  background: -moz-linear-gradient(top, #ffcccc, #fd929d);</span>
<a href="#l49.61"></a><span id="l49.61" class="difflineplus">+}</span>
<a href="#l49.62"></a><span id="l49.62" class="difflineplus">+</span>
<a href="#l49.63"></a><span id="l49.63" class="difflineplus">+#threadTree[filterActive=&quot;nomatches&quot;] {</span>
<a href="#l49.64"></a><span id="l49.64" class="difflineplus">+  background: -moz-repeating-linear-gradient(top, #fff0f4, #fff0f4 18px, white 18px, white 36px);</span>
<a href="#l49.65"></a><span id="l49.65" class="difflineplus">+}</span>
<a href="#l49.66"></a><span id="l49.66" class="difflineplus">+</span>
<a href="#l49.67"></a><span id="l49.67" class="difflineplus">+#qfb-filter-label {</span>
<a href="#l49.68"></a><span id="l49.68" class="difflineplus">+  color: #6b6b6b;</span>
<a href="#l49.69"></a><span id="l49.69" class="difflineplus">+  font-weight: bold;</span>
<a href="#l49.70"></a><span id="l49.70" class="difflineplus">+}</span>
<a href="#l49.71"></a><span id="l49.71" class="difflineplus">+</span>
<a href="#l49.72"></a><span id="l49.72" class="difflineplus">+/* :::: Filter Buttons :::: */</span>
<a href="#l49.73"></a><span id="l49.73" class="difflineplus">+</span>
<a href="#l49.74"></a><span id="l49.74" class="difflineplus">+#qfb-unread,</span>
<a href="#l49.75"></a><span id="l49.75" class="difflineplus">+#qfb-starred,</span>
<a href="#l49.76"></a><span id="l49.76" class="difflineplus">+#qfb-inaddrbook,</span>
<a href="#l49.77"></a><span id="l49.77" class="difflineplus">+#qfb-tags,</span>
<a href="#l49.78"></a><span id="l49.78" class="difflineplus">+#qfb-attachment {</span>
<a href="#l49.79"></a><span id="l49.79" class="difflineplus">+  color: #2b2b2b;</span>
<a href="#l49.80"></a><span id="l49.80" class="difflineplus">+}</span>
<a href="#l49.81"></a><span id="l49.81" class="difflineplus">+</span>
<a href="#l49.82"></a><span id="l49.82" class="difflineplus">+#qfb-unread,</span>
<a href="#l49.83"></a><span id="l49.83" class="difflineplus">+#qfb-starred,</span>
<a href="#l49.84"></a><span id="l49.84" class="difflineplus">+#qfb-inaddrbook,</span>
<a href="#l49.85"></a><span id="l49.85" class="difflineplus">+#qfb-tags,</span>
<a href="#l49.86"></a><span id="l49.86" class="difflineplus">+#qfb-attachment,</span>
<a href="#l49.87"></a><span id="l49.87" class="difflineplus">+#quick-filter-bar-expando toolbarbutton {</span>
<a href="#l49.88"></a><span id="l49.88" class="difflineplus">+  margin-top: 3pt;</span>
<a href="#l49.89"></a><span id="l49.89" class="difflineplus">+  margin-bottom: 3pt;</span>
<a href="#l49.90"></a><span id="l49.90" class="difflineplus">+  text-shadow: #e8e8e8 0 1px;</span>
<a href="#l49.91"></a><span id="l49.91" class="difflineplus">+  height: 17px;</span>
<a href="#l49.92"></a><span id="l49.92" class="difflineplus">+  font-weight: bold;</span>
<a href="#l49.93"></a><span id="l49.93" class="difflineplus">+  padding: 1px 7px;</span>
<a href="#l49.94"></a><span id="l49.94" class="difflineplus">+  -moz-border-radius: 10px;</span>
<a href="#l49.95"></a><span id="l49.95" class="difflineplus">+  border: 1px inset transparent;</span>
<a href="#l49.96"></a><span id="l49.96" class="difflineplus">+}</span>
<a href="#l49.97"></a><span id="l49.97" class="difflineplus">+</span>
<a href="#l49.98"></a><span id="l49.98" class="difflineplus">+#quick-filter-bar toolbarbutton[checked=&quot;true&quot;],</span>
<a href="#l49.99"></a><span id="l49.99" class="difflineplus">+#quick-filter-bar toolbarbutton[checked=&quot;true&quot;]:hover {</span>
<a href="#l49.100"></a><span id="l49.100" class="difflineplus">+  background: -moz-linear-gradient(top, #888 0px, #888 1px, #939393 1px, #8c8c8c 16px, #8e8e8e 16px, #8e8e8e 17px);</span>
<a href="#l49.101"></a><span id="l49.101" class="difflineplus">+  border-bottom-color: rgba(231, 231, 231, 0.85);</span>
<a href="#l49.102"></a><span id="l49.102" class="difflineplus">+  border-top-color: rgba(53, 53, 53, 0.4);</span>
<a href="#l49.103"></a><span id="l49.103" class="difflineplus">+  -moz-box-shadow: inset 0 0 1px #888;</span>
<a href="#l49.104"></a><span id="l49.104" class="difflineplus">+}</span>
<a href="#l49.105"></a><span id="l49.105" class="difflineplus">+</span>
<a href="#l49.106"></a><span id="l49.106" class="difflineplus">+#quick-filter-bar toolbarbutton:active,</span>
<a href="#l49.107"></a><span id="l49.107" class="difflineplus">+#quick-filter-bar toolbarbutton[checked=&quot;true&quot;]:active,</span>
<a href="#l49.108"></a><span id="l49.108" class="difflineplus">+#quick-filter-bar toolbarbutton:active:hover {</span>
<a href="#l49.109"></a><span id="l49.109" class="difflineplus">+  background: -moz-linear-gradient(top, #686868 0px, #686868 1px, #737373 1px, #6d6d6d 16px, #717171 16px, #717171 17px);</span>
<a href="#l49.110"></a><span id="l49.110" class="difflineplus">+  border-bottom-color: rgba(231, 231, 231, 0.85);</span>
<a href="#l49.111"></a><span id="l49.111" class="difflineplus">+  border-top-color: rgba(53, 53, 53, 0.75);</span>
<a href="#l49.112"></a><span id="l49.112" class="difflineplus">+  border-left-color: rgba(53, 53, 53, 0.5);</span>
<a href="#l49.113"></a><span id="l49.113" class="difflineplus">+  border-right-color: rgba(53, 53, 53, 0.5);</span>
<a href="#l49.114"></a><span id="l49.114" class="difflineplus">+}</span>
<a href="#l49.115"></a><span id="l49.115" class="difflineplus">+</span>
<a href="#l49.116"></a><span id="l49.116" class="difflineplus">+#quick-filter-bar toolbarbutton:hover {</span>
<a href="#l49.117"></a><span id="l49.117" class="difflineplus">+  background: -moz-linear-gradient(top, #959595, #8b8b8b);</span>
<a href="#l49.118"></a><span id="l49.118" class="difflineplus">+  border-style: solid;</span>
<a href="#l49.119"></a><span id="l49.119" class="difflineplus">+  border-bottom-color: transparent;</span>
<a href="#l49.120"></a><span id="l49.120" class="difflineplus">+  border-top-color: #959595;</span>
<a href="#l49.121"></a><span id="l49.121" class="difflineplus">+}</span>
<a href="#l49.122"></a><span id="l49.122" class="difflineplus">+</span>
<a href="#l49.123"></a><span id="l49.123" class="difflineplus">+#quick-filter-bar toolbarbutton &gt; .toolbarbutton-icon,</span>
<a href="#l49.124"></a><span id="l49.124" class="difflineplus">+#quick-filter-bar toolbarbutton &gt; .toolbarbutton-text {</span>
<a href="#l49.125"></a><span id="l49.125" class="difflineplus">+  padding: 0;</span>
<a href="#l49.126"></a><span id="l49.126" class="difflineplus">+  margin: 0;</span>
<a href="#l49.127"></a><span id="l49.127" class="difflineplus">+}</span>
<a href="#l49.128"></a><span id="l49.128" class="difflineplus">+</span>
<a href="#l49.129"></a><span id="l49.129" class="difflineplus">+#quick-filter-bar toolbarbutton[checked=&quot;true&quot;] &gt; .toolbarbutton-text,</span>
<a href="#l49.130"></a><span id="l49.130" class="difflineplus">+#quick-filter-bar toolbarbutton:hover &gt; .toolbarbutton-text {</span>
<a href="#l49.131"></a><span id="l49.131" class="difflineplus">+  color: #fff;</span>
<a href="#l49.132"></a><span id="l49.132" class="difflineplus">+  text-shadow: #535353 0 1px;</span>
<a href="#l49.133"></a><span id="l49.133" class="difflineplus">+}</span>
<a href="#l49.134"></a><span id="l49.134" class="difflineplus">+</span>
<a href="#l49.135"></a><span id="l49.135" class="difflineplus">+#quick-filter-bar #qfb-sticky,</span>
<a href="#l49.136"></a><span id="l49.136" class="difflineplus">+#quick-filter-bar #qfb-sticky[checked] {</span>
<a href="#l49.137"></a><span id="l49.137" class="difflineplus">+  background: none;</span>
<a href="#l49.138"></a><span id="l49.138" class="difflineplus">+  border-width: 0;</span>
<a href="#l49.139"></a><span id="l49.139" class="difflineplus">+  -moz-border-image: none;</span>
<a href="#l49.140"></a><span id="l49.140" class="difflineplus">+}</span>
<a href="#l49.141"></a><span id="l49.141" class="difflineplus">+</span>
<a href="#l49.142"></a><span id="l49.142" class="difflineplus">+#qfb-sticky {</span>
<a href="#l49.143"></a><span id="l49.143" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/black_pin.png&quot;);</span>
<a href="#l49.144"></a><span id="l49.144" class="difflineplus">+}</span>
<a href="#l49.145"></a><span id="l49.145" class="difflineplus">+</span>
<a href="#l49.146"></a><span id="l49.146" class="difflineplus">+#qfb-sticky[checked] {</span>
<a href="#l49.147"></a><span id="l49.147" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/red_pin.png&quot;);</span>
<a href="#l49.148"></a><span id="l49.148" class="difflineplus">+}</span>
<a href="#l49.149"></a><span id="l49.149" class="difflineplus">+</span>
<a href="#l49.150"></a><span id="l49.150" class="difflineplus">+/* we use both IDs so we are more precise than the other # toolbarbutton rules */</span>
<a href="#l49.151"></a><span id="l49.151" class="difflineplus">+#quick-filter-bar #qfb-sticky:hover {</span>
<a href="#l49.152"></a><span id="l49.152" class="difflineplus">+  text-shadow: none;</span>
<a href="#l49.153"></a><span id="l49.153" class="difflineplus">+  background: none;</span>
<a href="#l49.154"></a><span id="l49.154" class="difflineplus">+  border: 1px solid transparent;</span>
<a href="#l49.155"></a><span id="l49.155" class="difflineplus">+  -moz-border-radius: 0;</span>
<a href="#l49.156"></a><span id="l49.156" class="difflineplus">+  border-width: 0;</span>
<a href="#l49.157"></a><span id="l49.157" class="difflineplus">+}</span>
<a href="#l49.158"></a><span id="l49.158" class="difflineplus">+</span>
<a href="#l49.159"></a><span id="l49.159" class="difflineplus">+#qfb-unread {</span>
<a href="#l49.160"></a><span id="l49.160" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/readcol.png&quot;);</span>
<a href="#l49.161"></a><span id="l49.161" class="difflineplus">+}</span>
<a href="#l49.162"></a><span id="l49.162" class="difflineplus">+</span>
<a href="#l49.163"></a><span id="l49.163" class="difflineplus">+#qfb-unread &gt; .toolbarbutton-icon {</span>
<a href="#l49.164"></a><span id="l49.164" class="difflineplus">+  /* 9x9 icon so pad with (2 * 2px) border */</span>
<a href="#l49.165"></a><span id="l49.165" class="difflineplus">+  border: 2px solid transparent;</span>
<a href="#l49.166"></a><span id="l49.166" class="difflineplus">+}</span>
<a href="#l49.167"></a><span id="l49.167" class="difflineplus">+</span>
<a href="#l49.168"></a><span id="l49.168" class="difflineplus">+#qfb-unread[checked] {</span>
<a href="#l49.169"></a><span id="l49.169" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/unreadmail.png&quot;);</span>
<a href="#l49.170"></a><span id="l49.170" class="difflineplus">+}</span>
<a href="#l49.171"></a><span id="l49.171" class="difflineplus">+</span>
<a href="#l49.172"></a><span id="l49.172" class="difflineplus">+#qfb-unread[checked] &gt; .toolbarbutton-icon {</span>
<a href="#l49.173"></a><span id="l49.173" class="difflineplus">+  /* 13x13 icon */</span>
<a href="#l49.174"></a><span id="l49.174" class="difflineplus">+  border: none;</span>
<a href="#l49.175"></a><span id="l49.175" class="difflineplus">+}</span>
<a href="#l49.176"></a><span id="l49.176" class="difflineplus">+</span>
<a href="#l49.177"></a><span id="l49.177" class="difflineplus">+#qfb-starred {</span>
<a href="#l49.178"></a><span id="l49.178" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/flagcol.png&quot;);</span>
<a href="#l49.179"></a><span id="l49.179" class="difflineplus">+}</span>
<a href="#l49.180"></a><span id="l49.180" class="difflineplus">+</span>
<a href="#l49.181"></a><span id="l49.181" class="difflineplus">+#qfb-starred[checked] {</span>
<a href="#l49.182"></a><span id="l49.182" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/flaggedmail.png&quot;);</span>
<a href="#l49.183"></a><span id="l49.183" class="difflineplus">+}</span>
<a href="#l49.184"></a><span id="l49.184" class="difflineplus">+</span>
<a href="#l49.185"></a><span id="l49.185" class="difflineplus">+#qfb-inaddrbook {</span>
<a href="#l49.186"></a><span id="l49.186" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/addressbook/icons/abcard.png&quot;);</span>
<a href="#l49.187"></a><span id="l49.187" class="difflineplus">+}</span>
<a href="#l49.188"></a><span id="l49.188" class="difflineplus">+</span>
<a href="#l49.189"></a><span id="l49.189" class="difflineplus">+#qfb-tags {</span>
<a href="#l49.190"></a><span id="l49.190" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/tag1616.png&quot;);</span>
<a href="#l49.191"></a><span id="l49.191" class="difflineplus">+}</span>
<a href="#l49.192"></a><span id="l49.192" class="difflineplus">+</span>
<a href="#l49.193"></a><span id="l49.193" class="difflineplus">+#qfb-tags[disabled] {</span>
<a href="#l49.194"></a><span id="l49.194" class="difflineplus">+  -moz-image-region: rect(48px, 384px, 72px, 360px) !important;</span>
<a href="#l49.195"></a><span id="l49.195" class="difflineplus">+}</span>
<a href="#l49.196"></a><span id="l49.196" class="difflineplus">+</span>
<a href="#l49.197"></a><span id="l49.197" class="difflineplus">+#qfb-attachment {</span>
<a href="#l49.198"></a><span id="l49.198" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/attachment.png&quot;);</span>
<a href="#l49.199"></a><span id="l49.199" class="difflineplus">+}</span>
<a href="#l49.200"></a><span id="l49.200" class="difflineplus">+</span>
<a href="#l49.201"></a><span id="l49.201" class="difflineplus">+#quick-filter-bar[filterActive=&quot;matches&quot;] #qfb-results-label {</span>
<a href="#l49.202"></a><span id="l49.202" class="difflineplus">+  color: green;</span>
<a href="#l49.203"></a><span id="l49.203" class="difflineplus">+}</span>
<a href="#l49.204"></a><span id="l49.204" class="difflineplus">+</span>
<a href="#l49.205"></a><span id="l49.205" class="difflineplus">+#quick-filter-bar[filterActive=&quot;nomatches&quot;] #qfb-results-label {</span>
<a href="#l49.206"></a><span id="l49.206" class="difflineplus">+  color: #f66;</span>
<a href="#l49.207"></a><span id="l49.207" class="difflineplus">+}</span>
<a href="#l49.208"></a><span id="l49.208" class="difflineplus">+</span>
<a href="#l49.209"></a><span id="l49.209" class="difflineplus">+#qfb-qs-textbox {</span>
<a href="#l49.210"></a><span id="l49.210" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/mail/themes/qute/jar.mn</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/mail/themes/qute/jar.mn</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -73,16 +73,17 @@ classic.jar:</span>
<a href="#l50.4"></a><span id="l50.4">   skin/classic/messenger/dialogs.css                          (mail/dialogs.css)</span>
<a href="#l50.5"></a><span id="l50.5">   skin/classic/messenger/multimessageview.css                 (mail/multimessageview.css)</span>
<a href="#l50.6"></a><span id="l50.6">   skin/classic/messenger/glodaFacetView.css                   (mail/glodaFacetView.css)</span>
<a href="#l50.7"></a><span id="l50.7">   skin/classic/messenger/icons/exclude.png                    (mail/icons/exclude.png)</span>
<a href="#l50.8"></a><span id="l50.8">   skin/classic/messenger/icons/exclude-selected.png           (mail/icons/exclude-selected.png)</span>
<a href="#l50.9"></a><span id="l50.9">   skin/classic/messenger/newmailalert.css                     (mail/newmailalert.css)</span>
<a href="#l50.10"></a><span id="l50.10">   skin/classic/messenger/tabmail.css                          (mail/tabmail.css)</span>
<a href="#l50.11"></a><span id="l50.11">   skin/classic/messenger/editContactOverlay.css               (mail/editContactOverlay.css)</span>
<a href="#l50.12"></a><span id="l50.12" class="difflineplus">+  skin/classic/messenger/quickFilterBar.css                   (mail/quickFilterBar.css)</span>
<a href="#l50.13"></a><span id="l50.13">   skin/classic/messenger/starred48.png                        (mail/starred48.png)</span>
<a href="#l50.14"></a><span id="l50.14">   skin/classic/messenger/contactStarred.png                   (mail/contactStarred.png)</span>
<a href="#l50.15"></a><span id="l50.15">   skin/classic/messenger/starContact.png                      (mail/starContact.png)</span>
<a href="#l50.16"></a><span id="l50.16">   skin/classic/messenger/activity/activity.css                   (mail/activity/activity.css)</span>
<a href="#l50.17"></a><span id="l50.17">   skin/classic/messenger/activity/buttons.png                    (mail/activity/buttons.png)</span>
<a href="#l50.18"></a><span id="l50.18">   skin/classic/messenger/activity/defaultProcessIcon.png         (mail/activity/defaultProcessIcon.png)</span>
<a href="#l50.19"></a><span id="l50.19">   skin/classic/messenger/activity/defaultEventIcon.png           (mail/activity/defaultEventIcon.png)</span>
<a href="#l50.20"></a><span id="l50.20">   skin/classic/messenger/activity/defaultWarningIcon.png         (mail/activity/defaultWarningIcon.png)</span>
<a href="#l50.21"></a><span id="l50.21" class="difflineat">@@ -233,16 +234,19 @@ classic.jar:</span>
<a href="#l50.22"></a><span id="l50.22">   skin/classic/messenger/icons/arrow/arrow-right-dim.png      (mail/icons/arrow/arrow-right-dim.png)</span>
<a href="#l50.23"></a><span id="l50.23">   skin/classic/messenger/icons/arrow/arrow-up-dim.png         (mail/icons/arrow/arrow-up-dim.png)</span>
<a href="#l50.24"></a><span id="l50.24">   skin/classic/messenger/icons/arrow/arrow-down-dim.png       (mail/icons/arrow/arrow-down-dim.png)</span>
<a href="#l50.25"></a><span id="l50.25">   skin/classic/messenger/icons/timeline.png                   (mail/icons/timeline.png)</span>
<a href="#l50.26"></a><span id="l50.26">   skin/classic/messenger/icons/timeline-inverted.png          (mail/icons/timeline-inverted.png)</span>
<a href="#l50.27"></a><span id="l50.27">   skin/classic/messenger/icons/empty-search-results.png       (mail/icons/empty-search-results.png)</span>
<a href="#l50.28"></a><span id="l50.28">   skin/classic/messenger/icons/arrow/foldercycler-arrow-left.png        (mail/icons/arrow/foldercycler-arrow-left.png)</span>
<a href="#l50.29"></a><span id="l50.29">   skin/classic/messenger/icons/arrow/foldercycler-arrow-right.png       (mail/icons/arrow/foldercycler-arrow-right.png)</span>
<a href="#l50.30"></a><span id="l50.30" class="difflineplus">+  skin/classic/messenger/icons/filter.png                     (mail/icons/filter.png)</span>
<a href="#l50.31"></a><span id="l50.31" class="difflineplus">+  skin/classic/messenger/icons/xp-pin-grey.png                (mail/icons/xp-pin-grey.png)</span>
<a href="#l50.32"></a><span id="l50.32" class="difflineplus">+  skin/classic/messenger/icons/xp-pin-red.png                 (mail/icons/xp-pin-red.png)</span>
<a href="#l50.33"></a><span id="l50.33">   skin/classic/messenger/tagbg.png                            (mail/tagbg.png)</span>
<a href="#l50.34"></a><span id="l50.34"> % skin messenger-newsblog classic/1.0 %skin/classic/messenger-newsblog/ os=WINNT osversion&lt;6</span>
<a href="#l50.35"></a><span id="l50.35"> % skin messenger-newsblog classic/1.0 %skin/classic/messenger-newsblog/ os!=WINNT</span>
<a href="#l50.36"></a><span id="l50.36">   skin/classic/messenger-newsblog/feed-subscriptions.css      (mail/newsblog/feed-subscriptions.css)</span>
<a href="#l50.37"></a><span id="l50.37">   skin/classic/messenger-newsblog/icons/rss-feed.png          (mail/newsblog/rss-feed.png)</span>
<a href="#l50.38"></a><span id="l50.38">   skin/classic/messenger-newsblog/icons/server-rss.png        (mail/newsblog/server-rss.png)</span>
<a href="#l50.39"></a><span id="l50.39"> #ifdef XP_WIN</span>
<a href="#l50.40"></a><span id="l50.40"> % skin communicator classic/1.0 %skin/classic/aero/communicator/ os=WINNT osversion&gt;=6</span>
<a href="#l50.41"></a><span id="l50.41" class="difflineat">@@ -299,16 +303,17 @@ classic.jar:</span>
<a href="#l50.42"></a><span id="l50.42">   skin/classic/aero/messenger/glodaFacetView.css                   (mail/glodaFacetView.css)</span>
<a href="#l50.43"></a><span id="l50.43">   skin/classic/aero/messenger/icons/exclude.png                    (mail/icons/exclude.png)</span>
<a href="#l50.44"></a><span id="l50.44">   skin/classic/aero/messenger/icons/exclude-selected.png           (mail/icons/exclude-selected.png)</span>
<a href="#l50.45"></a><span id="l50.45">   skin/classic/aero/messenger/icons/zoomout.png                    (mail/icons/zoomout.png)</span>
<a href="#l50.46"></a><span id="l50.46">   skin/classic/aero/messenger/icons/zoomout-hover.png              (mail/icons/zoomout-hover.png)</span>
<a href="#l50.47"></a><span id="l50.47">   skin/classic/aero/messenger/newmailalert.css                     (mail/newmailalert.css)</span>
<a href="#l50.48"></a><span id="l50.48">   skin/classic/aero/messenger/tabmail.css                          (mail/tabmail.css)</span>
<a href="#l50.49"></a><span id="l50.49">   skin/classic/aero/messenger/editContactOverlay.css               (mail/editContactOverlay.css)</span>
<a href="#l50.50"></a><span id="l50.50" class="difflineplus">+  skin/classic/aero/messenger/quickFilterBar.css                   (mail/quickFilterBar.css)</span>
<a href="#l50.51"></a><span id="l50.51">   skin/classic/aero/messenger/starred48.png                        (mail/starred48.png)</span>
<a href="#l50.52"></a><span id="l50.52">   skin/classic/aero/messenger/contactStarred.png                   (mail/contactStarred.png)</span>
<a href="#l50.53"></a><span id="l50.53">   skin/classic/aero/messenger/starContact.png                      (mail/starContact.png)</span>
<a href="#l50.54"></a><span id="l50.54">   skin/classic/aero/messenger/activity/activity.css                   (mail/activity/activity.css)</span>
<a href="#l50.55"></a><span id="l50.55">   skin/classic/aero/messenger/activity/buttons.png                    (mail/activity/buttons.png)</span>
<a href="#l50.56"></a><span id="l50.56">   skin/classic/aero/messenger/activity/defaultProcessIcon.png         (mail/activity/defaultProcessIcon-aero.png)</span>
<a href="#l50.57"></a><span id="l50.57">   skin/classic/aero/messenger/activity/defaultEventIcon.png           (mail/activity/defaultEventIcon.png)</span>
<a href="#l50.58"></a><span id="l50.58">   skin/classic/aero/messenger/activity/defaultWarningIcon.png         (mail/activity/defaultWarningIcon-aero.png)</span>
<a href="#l50.59"></a><span id="l50.59" class="difflineat">@@ -458,15 +463,18 @@ classic.jar:</span>
<a href="#l50.60"></a><span id="l50.60">   skin/classic/aero/messenger/icons/arrow/arrow-up.png             (mail/icons/arrow/arrow-up.png)</span>
<a href="#l50.61"></a><span id="l50.61">   skin/classic/aero/messenger/icons/arrow/arrow-down.png           (mail/icons/arrow/arrow-down.png)</span>
<a href="#l50.62"></a><span id="l50.62">   skin/classic/aero/messenger/icons/arrow/arrow-left-dim.png       (mail/icons/arrow/arrow-left-dim.png)</span>
<a href="#l50.63"></a><span id="l50.63">   skin/classic/aero/messenger/icons/arrow/arrow-right-dim.png      (mail/icons/arrow/arrow-right-dim.png)</span>
<a href="#l50.64"></a><span id="l50.64">   skin/classic/aero/messenger/icons/arrow/arrow-up-dim.png         (mail/icons/arrow/arrow-up-dim.png)</span>
<a href="#l50.65"></a><span id="l50.65">   skin/classic/aero/messenger/icons/arrow/arrow-down-dim.png       (mail/icons/arrow/arrow-down-dim.png)</span>
<a href="#l50.66"></a><span id="l50.66">   skin/classic/aero/messenger/icons/arrow/foldercycler-arrow-left.png        (mail/icons/arrow/foldercycler-arrow-left.png)</span>
<a href="#l50.67"></a><span id="l50.67">   skin/classic/aero/messenger/icons/arrow/foldercycler-arrow-right.png       (mail/icons/arrow/foldercycler-arrow-right.png)</span>
<a href="#l50.68"></a><span id="l50.68" class="difflineplus">+  skin/classic/aero/messenger/icons/filter.png                     (mail/icons/filter.png)</span>
<a href="#l50.69"></a><span id="l50.69" class="difflineplus">+  skin/classic/aero/messenger/icons/xp-pin-grey.png                (mail/icons/xp-pin-grey.png)</span>
<a href="#l50.70"></a><span id="l50.70" class="difflineplus">+  skin/classic/aero/messenger/icons/xp-pin-red.png                 (mail/icons/xp-pin-red.png)</span>
<a href="#l50.71"></a><span id="l50.71">   skin/classic/aero/messenger/tagbg.png                            (mail/tagbg.png)</span>
<a href="#l50.72"></a><span id="l50.72"> % skin messenger-newsblog classic/1.0 %skin/classic/aero/messenger-newsblog/ os=WINNT osversion&gt;=6</span>
<a href="#l50.73"></a><span id="l50.73">   skin/classic/aero/messenger-newsblog/feed-subscriptions.css      (mail/newsblog/feed-subscriptions.css)</span>
<a href="#l50.74"></a><span id="l50.74">   skin/classic/aero/messenger-newsblog/icons/rss-feed.png          (mail/newsblog/rss-feed-aero.png)</span>
<a href="#l50.75"></a><span id="l50.75">   skin/classic/aero/messenger-newsblog/icons/server-rss.png        (mail/newsblog/server-rss-aero.png)</span>
<a href="#l50.76"></a><span id="l50.76"> </span>
<a href="#l50.77"></a><span id="l50.77"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1">new file mode 100644</span>
<a href="#l51.2"></a><span id="l51.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..7ed2d204bd64aecb67948c374d66f0ee035bdc48</span>
<a href="#l51.3"></a><span id="l51.3">GIT binary patch
literal 426
zc$@*M0agBqP)&lt;h;3K|Lk000e1NJLTq000sI000aK1^@s6ZxZdi0000PbVXQnQ*UN;
zcVTj606}DLVr3vnZDD6+Qe|Oed2z{QJOBUzOi4sRRCwBqlCes}KoEv^_YMRJ&lt;N&lt;_$
zK7dKULQoK*SXjo!Lh%WF0E+{!I7LwrJ3+xte2HM8mL`oHC|(*-u1sN}NY*bJBpkU*
z7JmMjoy?#4Cy`of;kxc5d@QA$7eai42Kgm&lt;I}F1QQR7J4wx{5G@I+$^fmdRO_&gt;{N{
zuORkSCDa5R@CcS@(E0rfQ)c21U&lt;({o2`S#_fld@fx&gt;!K;9l8Lkb*w4yiG_ZtZz-Rl
zamR6FrBJqP8tk$nwK=FiIPEZNSMWYNnJ5;&gt;m!UPpPU=`|@?Z&lt;GY2q#x&amp;WL;5&amp;62N!
z9{Fvp&amp;!7KC4dP9(0Zj15{Q@Ee+{W5YvB~#+9mlayN{KX0g=JZPLS+Z&gt;ZD=?D7&gt;kJA
z73-eo=_E;nX__Jk0;xt!dw{?VJO&amp;O2i&amp;?W_7{B~)ZP;OFGtfEMW1{O(JNgk|0PtLo
UX_aH9bpQYW07*qoM6N&lt;$f-20h&lt;NyEw</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1">new file mode 100644</span>
<a href="#l52.2"></a><span id="l52.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..4210219c707ca22f7f3abe88e55f3016957fa3b5</span>
<a href="#l52.3"></a><span id="l52.3">GIT binary patch
literal 659
zc$@)~0&amp;M+&gt;P)&lt;h;3K|Lk000e1NJLTq000mG000mO1^@s6AM^iV0000PbVXQnQ*UN;
zcVTj606}DLVr3vnZDD6+Qe|Oed2z{QJOBU!HAzH4RCwB)QcH+ZVH7@IA27a~2EkEj
z#6{Rff^ieL@v%z~f?NcGOU1pL*+q+xfgnK$+PP6$DrgwF$y7|m2P%e&amp;6M&gt;J$d|~Fj
z-p(Bm9Fb&lt;256(T8!+##%cMiaQh|un#vEc@=b^|h*?2*Z2dLflcxxrxY-E=zr4!4Cy
zqdAR4BJt&amp;N`4{oWZnvLdn0uRCmRhYoO{deJX#{qq&gt;-9SAa5&amp;!Flz7Dv$JGV`fpfFj
zZ0z^@5Rb&lt;}B9Q=2(W_Rgy~$*&lt;!e&gt;h~YPSFfjj&amp;iO&amp;uuoF89PHVnFOs?3p$;S(c&gt;ve
zlE;lkqk{gjR4S#5#o|Ybq9)g-a5|l5*!fqXP@qz&amp;6v@!&amp;cDr;gm!k)R0X-g%X)M6_
zA6~EboWtQ9Zd0IJt=1(z9$@m&lt;#bWUj^&gt;~Ph9Hmmp(17`T4%iij!=ZS+UQ43UXl%7w
z4K@@2IaXq^SRH@KL?WSMu~&gt;4K%Vor3z|ay11c0JKCX&lt;13xy)?oVq1d^NalkHwMwN@
z5(&lt;Sz92w9&lt;C=`NnwE{&lt;n_dkTg;n&amp;+55PLR5jYgy2C&lt;BPaVraM9SIG+bF|gTetS3C$
ze!RCptycTe&gt;-8E)4YJuRNJQfIoleJZFc_Y=-R_qJK|Hv22fLWfW*5z7bBr1s&lt;n#G3
zp7bkRUlPS!;mS&gt;THz&amp;BUZ_Lg8@5l%)mn%mv@cDe37*DU)KlA(jpR87^8`pUNcY#W!
tGI%_mw+e;gG29h=KL3Qr&lt;B9$WFaX&gt;qD1&amp;c2Ef4?z002ovPDHLkV1nHrEs+2K</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1">new file mode 100644</span>
<a href="#l53.2"></a><span id="l53.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..a487949ca7e7f9033807ff5517778fc4edb154da</span>
<a href="#l53.3"></a><span id="l53.3">GIT binary patch
literal 792
zc$@(k1LypSP)&lt;h;3K|Lk000e1NJLTq000mG000mO1^@s6AM^iV00001b5ch_0Itp)
z=&gt;Px#24YJ`L;(K){{a7&gt;y{D4^000SaNLh0L01FcU01FcV0GgZ_00007bV*G`2igM|
z5-2M}Kd`+300NjvL_t(I%YBmDP7`4ih1dW8Gi_m7C@l$CryL3iMh%iwBLp!R^vVF2
zya5m3D-h%1LauxS6EBT-CU{IRL{v-&gt;42R00M`_E@X**00GusOxf|9Pgy_5ZAue}!o
zfa&amp;RJ9E$*0oOjrOQ?~65hWg?s3yU!bqQOu){dhE)e5zR1B(eGk&gt;Etjc8ktBW?hmHZ
z!!4XMQK?kkbal&lt;kMA^CkVhj?|jj4G2!L3YYn1sN7xeRWaE}Jo4Zvz1USHj`mvEAL-
z@oe^HjR@~cC7`VhlG|PRDMY#;#DPuZAR^8gtFV7J@D~c&gt;qnXSIIL9Z$KvOV?i-7=2
z#o~oju{g8Y(h_w^l9{j7wtkuBED&gt;$8lK{66H6hDI{qV5a;q&amp;2YAb^6dBPs;$bai!1
z=z51x6c{}rV=kWPoXckKS(3EQk1g~K4JB7xF86nrE0$4|^&gt;gKNa8H&amp;U=iA!gUs{5^
zybQrO^u4THT3u`3^teA%oX&amp;MlbaX_bc*^U2nDF_W%(9$^n&amp;z1b1jhW42(Y#Ws48|+
zdx(8o!D?^!J3~&gt;vaN9opMoyIEmW3*SM0@*&amp;oAWW`azIeULZb(-BpIr=IkFt;d;(CC
zofV`b5Nz9y9V$u{{r%X1gpC6o`vd*hpSbIgn&gt;-G(th18{01SXxt-eiry)oV0jIEqz
zQ)9z|U-0MMp-@l%rOS_m5ZCP^3jzSb;qYGoW2g~nX~S?GZ11#gd6XYt`+8@za`~BA
zC^V_6dd=x{4&amp;-vV2oa_K0{{SLtg2P3i`z=$&gt;pj2krOo*w2MYOoeqPhGtg5QF0W|2k
z{_#w}5u^qoGGHvni2n3AHx0x1tZ7=JwY7E9G|iM$FXzXDr?M{u48wR4jYeZc6#oqp
W3pDkIWX&lt;&amp;e0000&lt;MNUMnLSTY6C}h&lt;D</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1">new file mode 100644</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineminus">--- /dev/null</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineplus">+++ b/mail/themes/qute/mail/quickFilterBar.css</span>
<a href="#l54.4"></a><span id="l54.4" class="difflineat">@@ -0,0 +1,169 @@</span>
<a href="#l54.5"></a><span id="l54.5" class="difflineplus">+@import url(&quot;chrome://messenger/content/quickFilterBar.css&quot;);</span>
<a href="#l54.6"></a><span id="l54.6" class="difflineplus">+</span>
<a href="#l54.7"></a><span id="l54.7" class="difflineplus">+/* :::: Filter Tab Bar Button :::: */</span>
<a href="#l54.8"></a><span id="l54.8" class="difflineplus">+</span>
<a href="#l54.9"></a><span id="l54.9" class="difflineplus">+#qfb-show-filter-bar {</span>
<a href="#l54.10"></a><span id="l54.10" class="difflineplus">+  -moz-appearance: none;</span>
<a href="#l54.11"></a><span id="l54.11" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/filter.png&quot;);</span>
<a href="#l54.12"></a><span id="l54.12" class="difflineplus">+  background: -moz-linear-gradient(top, #e3e3e3 0px, #e3e3e3 9px, #dedede 9px, #dedede 10px, #d9d9d9 10px, #e5e5e5 100%);</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineplus">+  border-right: 2px solid;</span>
<a href="#l54.14"></a><span id="l54.14" class="difflineplus">+  border-top: 2px solid;</span>
<a href="#l54.15"></a><span id="l54.15" class="difflineplus">+  border-left: 2px solid;</span>
<a href="#l54.16"></a><span id="l54.16" class="difflineplus">+  -moz-border-top-colors: threedshadow #f2f2f2;</span>
<a href="#l54.17"></a><span id="l54.17" class="difflineplus">+  -moz-border-left-colors: threedshadow #f2f2f2;</span>
<a href="#l54.18"></a><span id="l54.18" class="difflineplus">+  -moz-border-right-colors: threedshadow #f2f2f2;</span>
<a href="#l54.19"></a><span id="l54.19" class="difflineplus">+  border-bottom: none;</span>
<a href="#l54.20"></a><span id="l54.20" class="difflineplus">+  -moz-border-radius: 4px 4px 0pt 0pt;</span>
<a href="#l54.21"></a><span id="l54.21" class="difflineplus">+  margin: 2px 2px 3px 0;</span>
<a href="#l54.22"></a><span id="l54.22" class="difflineplus">+  padding: 0 !important;</span>
<a href="#l54.23"></a><span id="l54.23" class="difflineplus">+  -moz-padding-start: 4px !important;</span>
<a href="#l54.24"></a><span id="l54.24" class="difflineplus">+  -moz-padding-end: 4px !important;</span>
<a href="#l54.25"></a><span id="l54.25" class="difflineplus">+}</span>
<a href="#l54.26"></a><span id="l54.26" class="difflineplus">+</span>
<a href="#l54.27"></a><span id="l54.27" class="difflineplus">+#qfb-show-filter-bar:hover {</span>
<a href="#l54.28"></a><span id="l54.28" class="difflineplus">+  background: -moz-linear-gradient(top, #f6f6f6 0px, #ededed 9px, #e4e4e4 9px, #e4e4e4 10px, #d6d6d6 10px, #e4e4e4 100%);</span>
<a href="#l54.29"></a><span id="l54.29" class="difflineplus">+}</span>
<a href="#l54.30"></a><span id="l54.30" class="difflineplus">+</span>
<a href="#l54.31"></a><span id="l54.31" class="difflineplus">+#qfb-show-filter-bar:hover:active,</span>
<a href="#l54.32"></a><span id="l54.32" class="difflineplus">+#qfb-show-filter-bar[checked],</span>
<a href="#l54.33"></a><span id="l54.33" class="difflineplus">+#qfb-show-filter-bar[checked]:hover {</span>
<a href="#l54.34"></a><span id="l54.34" class="difflineplus">+  -moz-border-top-colors: ThreeDDarkShadow #bdbdbd;</span>
<a href="#l54.35"></a><span id="l54.35" class="difflineplus">+  -moz-border-left-colors: ThreeDDarkShadow #bdbdbd;</span>
<a href="#l54.36"></a><span id="l54.36" class="difflineplus">+  -moz-border-right-colors: ThreeDDarkShadow #bdbdbd;</span>
<a href="#l54.37"></a><span id="l54.37" class="difflineplus">+  background: #cbcbcb;</span>
<a href="#l54.38"></a><span id="l54.38" class="difflineplus">+  padding: 0 !important;</span>
<a href="#l54.39"></a><span id="l54.39" class="difflineplus">+  -moz-padding-start: 4px !important;</span>
<a href="#l54.40"></a><span id="l54.40" class="difflineplus">+  -moz-padding-end: 4px !important;</span>
<a href="#l54.41"></a><span id="l54.41" class="difflineplus">+}</span>
<a href="#l54.42"></a><span id="l54.42" class="difflineplus">+</span>
<a href="#l54.43"></a><span id="l54.43" class="difflineplus">+#qfb-show-filter-bar &gt; .toolbarbutton-icon {</span>
<a href="#l54.44"></a><span id="l54.44" class="difflineplus">+  padding: 0 3px;</span>
<a href="#l54.45"></a><span id="l54.45" class="difflineplus">+}</span>
<a href="#l54.46"></a><span id="l54.46" class="difflineplus">+</span>
<a href="#l54.47"></a><span id="l54.47" class="difflineplus">+#qfb-show-filter-bar &gt; .toolbarbutton-text {</span>
<a href="#l54.48"></a><span id="l54.48" class="difflineplus">+  display: none;</span>
<a href="#l54.49"></a><span id="l54.49" class="difflineplus">+}</span>
<a href="#l54.50"></a><span id="l54.50" class="difflineplus">+</span>
<a href="#l54.51"></a><span id="l54.51" class="difflineplus">+/* :::: Filter Bar :::: */</span>
<a href="#l54.52"></a><span id="l54.52" class="difflineplus">+</span>
<a href="#l54.53"></a><span id="l54.53" class="difflineplus">+#quick-filter-bar-main-bar {</span>
<a href="#l54.54"></a><span id="l54.54" class="difflineplus">+  background: -moz-linear-gradient(top, #f2f7fd 0, #e9f2fc 12px, #e3eefb 12px, #e3eefb 100%);</span>
<a href="#l54.55"></a><span id="l54.55" class="difflineplus">+  border-left: 2px solid;</span>
<a href="#l54.56"></a><span id="l54.56" class="difflineplus">+  -moz-border-left-colors: #9196a2 #fff;</span>
<a href="#l54.57"></a><span id="l54.57" class="difflineplus">+  border-top: 1px solid #fff;</span>
<a href="#l54.58"></a><span id="l54.58" class="difflineplus">+  border-bottom: 2px solid;</span>
<a href="#l54.59"></a><span id="l54.59" class="difflineplus">+  -moz-border-bottom-colors: #9196a2 #fff;</span>
<a href="#l54.60"></a><span id="l54.60" class="difflineplus">+}</span>
<a href="#l54.61"></a><span id="l54.61" class="difflineplus">+</span>
<a href="#l54.62"></a><span id="l54.62" class="difflineplus">+#quick-filter-bar-expando {</span>
<a href="#l54.63"></a><span id="l54.63" class="difflineplus">+  border-left: 2px solid;</span>
<a href="#l54.64"></a><span id="l54.64" class="difflineplus">+  -moz-border-left-colors: #9196a2 #fff;</span>
<a href="#l54.65"></a><span id="l54.65" class="difflineplus">+  background: #f2f6fb;  </span>
<a href="#l54.66"></a><span id="l54.66" class="difflineplus">+}</span>
<a href="#l54.67"></a><span id="l54.67" class="difflineplus">+</span>
<a href="#l54.68"></a><span id="l54.68" class="difflineplus">+#quick-filter-bar-tab-bar,</span>
<a href="#l54.69"></a><span id="l54.69" class="difflineplus">+#quick-filter-bar-filter-text-bar {</span>
<a href="#l54.70"></a><span id="l54.70" class="difflineplus">+  border-top: 1px solid #fff;</span>
<a href="#l54.71"></a><span id="l54.71" class="difflineplus">+  border-bottom: 2px solid;</span>
<a href="#l54.72"></a><span id="l54.72" class="difflineplus">+  -moz-border-bottom-colors: #9196a2 #fff;</span>
<a href="#l54.73"></a><span id="l54.73" class="difflineplus">+}</span>
<a href="#l54.74"></a><span id="l54.74" class="difflineplus">+</span>
<a href="#l54.75"></a><span id="l54.75" class="difflineplus">+#quick-filter-bar[filterActive=&quot;searching&quot;] {</span>
<a href="#l54.76"></a><span id="l54.76" class="difflineplus">+  </span>
<a href="#l54.77"></a><span id="l54.77" class="difflineplus">+}</span>
<a href="#l54.78"></a><span id="l54.78" class="difflineplus">+#threadTree[filterActive=&quot;searching&quot;] {</span>
<a href="#l54.79"></a><span id="l54.79" class="difflineplus">+  background-color: #ffffcc;</span>
<a href="#l54.80"></a><span id="l54.80" class="difflineplus">+}</span>
<a href="#l54.81"></a><span id="l54.81" class="difflineplus">+</span>
<a href="#l54.82"></a><span id="l54.82" class="difflineplus">+#quick-filter-bar[filterActive=&quot;matches&quot;] {</span>
<a href="#l54.83"></a><span id="l54.83" class="difflineplus">+  </span>
<a href="#l54.84"></a><span id="l54.84" class="difflineplus">+}</span>
<a href="#l54.85"></a><span id="l54.85" class="difflineplus">+#threadTree[filterActive=&quot;matches&quot;] {</span>
<a href="#l54.86"></a><span id="l54.86" class="difflineplus">+  background-color: #f2f9fc;</span>
<a href="#l54.87"></a><span id="l54.87" class="difflineplus">+}</span>
<a href="#l54.88"></a><span id="l54.88" class="difflineplus">+</span>
<a href="#l54.89"></a><span id="l54.89" class="difflineplus">+#quick-filter-bar[filterActive=&quot;nomatches&quot;] {</span>
<a href="#l54.90"></a><span id="l54.90" class="difflineplus">+  </span>
<a href="#l54.91"></a><span id="l54.91" class="difflineplus">+}</span>
<a href="#l54.92"></a><span id="l54.92" class="difflineplus">+#threadTree[filterActive=&quot;nomatches&quot;] {</span>
<a href="#l54.93"></a><span id="l54.93" class="difflineplus">+  background: -moz-repeating-linear-gradient(top left -45deg, #fff0f4, #fff0f4 5px, white 5px, white 10px);</span>
<a href="#l54.94"></a><span id="l54.94" class="difflineplus">+}</span>
<a href="#l54.95"></a><span id="l54.95" class="difflineplus">+</span>
<a href="#l54.96"></a><span id="l54.96" class="difflineplus">+/* :::: Filter Buttons :::: */</span>
<a href="#l54.97"></a><span id="l54.97" class="difflineplus">+</span>
<a href="#l54.98"></a><span id="l54.98" class="difflineplus">+#quick-filter-bar-main-bar toolbarbutton {</span>
<a href="#l54.99"></a><span id="l54.99" class="difflineplus">+  -moz-margin-start: 1px;</span>
<a href="#l54.100"></a><span id="l54.100" class="difflineplus">+  -moz-margin-end: 1px;</span>
<a href="#l54.101"></a><span id="l54.101" class="difflineplus">+}</span>
<a href="#l54.102"></a><span id="l54.102" class="difflineplus">+</span>
<a href="#l54.103"></a><span id="l54.103" class="difflineplus">+/* keep that hideous outline focus ring from showing on the checked buttons */</span>
<a href="#l54.104"></a><span id="l54.104" class="difflineplus">+#quick-filter-bar-main-bar toolbarbutton:focus {</span>
<a href="#l54.105"></a><span id="l54.105" class="difflineplus">+  outline: none;</span>
<a href="#l54.106"></a><span id="l54.106" class="difflineplus">+}</span>
<a href="#l54.107"></a><span id="l54.107" class="difflineplus">+</span>
<a href="#l54.108"></a><span id="l54.108" class="difflineplus">+#qfb-filter-label {</span>
<a href="#l54.109"></a><span id="l54.109" class="difflineplus">+  color: GrayText;</span>
<a href="#l54.110"></a><span id="l54.110" class="difflineplus">+}</span>
<a href="#l54.111"></a><span id="l54.111" class="difflineplus">+</span>
<a href="#l54.112"></a><span id="l54.112" class="difflineplus">+#qfb-sticky {</span>
<a href="#l54.113"></a><span id="l54.113" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/xp-pin-grey.png&quot;);</span>
<a href="#l54.114"></a><span id="l54.114" class="difflineplus">+}</span>
<a href="#l54.115"></a><span id="l54.115" class="difflineplus">+</span>
<a href="#l54.116"></a><span id="l54.116" class="difflineplus">+#qfb-sticky[checked] {</span>
<a href="#l54.117"></a><span id="l54.117" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/xp-pin-red.png&quot;);</span>
<a href="#l54.118"></a><span id="l54.118" class="difflineplus">+}</span>
<a href="#l54.119"></a><span id="l54.119" class="difflineplus">+</span>
<a href="#l54.120"></a><span id="l54.120" class="difflineplus">+#qfb-unread {</span>
<a href="#l54.121"></a><span id="l54.121" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/readmail.png&quot;);</span>
<a href="#l54.122"></a><span id="l54.122" class="difflineplus">+}</span>
<a href="#l54.123"></a><span id="l54.123" class="difflineplus">+</span>
<a href="#l54.124"></a><span id="l54.124" class="difflineplus">+#qfb-unread[checked] {</span>
<a href="#l54.125"></a><span id="l54.125" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/unreadmail.png&quot;);</span>
<a href="#l54.126"></a><span id="l54.126" class="difflineplus">+}</span>
<a href="#l54.127"></a><span id="l54.127" class="difflineplus">+</span>
<a href="#l54.128"></a><span id="l54.128" class="difflineplus">+#qfb-starred {</span>
<a href="#l54.129"></a><span id="l54.129" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/flag-empty.png&quot;);</span>
<a href="#l54.130"></a><span id="l54.130" class="difflineplus">+}</span>
<a href="#l54.131"></a><span id="l54.131" class="difflineplus">+</span>
<a href="#l54.132"></a><span id="l54.132" class="difflineplus">+#qfb-starred[checked] {</span>
<a href="#l54.133"></a><span id="l54.133" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/flag-col.png&quot;);</span>
<a href="#l54.134"></a><span id="l54.134" class="difflineplus">+}</span>
<a href="#l54.135"></a><span id="l54.135" class="difflineplus">+</span>
<a href="#l54.136"></a><span id="l54.136" class="difflineplus">+.qfb-starred-nostar {</span>
<a href="#l54.137"></a><span id="l54.137" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/starContact.png&quot;);</span>
<a href="#l54.138"></a><span id="l54.138" class="difflineplus">+  -moz-image-region:rect(0px 32px 16px 16px);</span>
<a href="#l54.139"></a><span id="l54.139" class="difflineplus">+}</span>
<a href="#l54.140"></a><span id="l54.140" class="difflineplus">+</span>
<a href="#l54.141"></a><span id="l54.141" class="difflineplus">+#qfb-inaddrbook {</span>
<a href="#l54.142"></a><span id="l54.142" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/addressbook/icons/abcard.png&quot;);</span>
<a href="#l54.143"></a><span id="l54.143" class="difflineplus">+}</span>
<a href="#l54.144"></a><span id="l54.144" class="difflineplus">+</span>
<a href="#l54.145"></a><span id="l54.145" class="difflineplus">+#qfb-tags {</span>
<a href="#l54.146"></a><span id="l54.146" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/mail-toolbar-small.png&quot;);</span>
<a href="#l54.147"></a><span id="l54.147" class="difflineplus">+  -moz-image-region: rect(0px 256px 16px 240px);</span>
<a href="#l54.148"></a><span id="l54.148" class="difflineplus">+}</span>
<a href="#l54.149"></a><span id="l54.149" class="difflineplus">+</span>
<a href="#l54.150"></a><span id="l54.150" class="difflineplus">+#qfb-tags[disabled] {</span>
<a href="#l54.151"></a><span id="l54.151" class="difflineplus">+  -moz-image-region: rect(48px, 384px, 72px, 360px) !important;</span>
<a href="#l54.152"></a><span id="l54.152" class="difflineplus">+}</span>
<a href="#l54.153"></a><span id="l54.153" class="difflineplus">+</span>
<a href="#l54.154"></a><span id="l54.154" class="difflineplus">+#qfb-attachment {</span>
<a href="#l54.155"></a><span id="l54.155" class="difflineplus">+  list-style-image: url(&quot;chrome://messenger/skin/icons/attachment-col.png&quot;);</span>
<a href="#l54.156"></a><span id="l54.156" class="difflineplus">+}</span>
<a href="#l54.157"></a><span id="l54.157" class="difflineplus">+</span>
<a href="#l54.158"></a><span id="l54.158" class="difflineplus">+#quick-filter-bar[filterActive=&quot;matches&quot;] #qfb-results-label {</span>
<a href="#l54.159"></a><span id="l54.159" class="difflineplus">+  color: green;</span>
<a href="#l54.160"></a><span id="l54.160" class="difflineplus">+}</span>
<a href="#l54.161"></a><span id="l54.161" class="difflineplus">+</span>
<a href="#l54.162"></a><span id="l54.162" class="difflineplus">+#quick-filter-bar[filterActive=&quot;nomatches&quot;] #qfb-results-label {</span>
<a href="#l54.163"></a><span id="l54.163" class="difflineplus">+  color: #f66;</span>
<a href="#l54.164"></a><span id="l54.164" class="difflineplus">+}</span>
<a href="#l54.165"></a><span id="l54.165" class="difflineplus">+</span>
<a href="#l54.166"></a><span id="l54.166" class="difflineplus">+#quick-filter-bar-expando toolbarbutton,</span>
<a href="#l54.167"></a><span id="l54.167" class="difflineplus">+#quick-filter-bar-expando toolbarbutton[checked] {</span>
<a href="#l54.168"></a><span id="l54.168" class="difflineplus">+  -moz-padding-end: 6px !important;</span>
<a href="#l54.169"></a><span id="l54.169" class="difflineplus">+  padding-top: 1px;</span>
<a href="#l54.170"></a><span id="l54.170" class="difflineplus">+  padding-bottom: 1px;</span>
<a href="#l54.171"></a><span id="l54.171" class="difflineplus">+  -moz-margin-start: 1px;</span>
<a href="#l54.172"></a><span id="l54.172" class="difflineplus">+  -moz-margin-end: 1px;</span>
<a href="#l54.173"></a><span id="l54.173" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgDBView.idl</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgDBView.idl</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineat">@@ -241,17 +241,17 @@ interface nsMsgNavigationType</span>
<a href="#l55.4"></a><span id="l55.4">   const nsMsgNavigationTypeValue previousFlagged = 19;</span>
<a href="#l55.5"></a><span id="l55.5">   const nsMsgNavigationTypeValue firstNew = 20;</span>
<a href="#l55.6"></a><span id="l55.6">   const nsMsgNavigationTypeValue editUndo = 21;</span>
<a href="#l55.7"></a><span id="l55.7">   const nsMsgNavigationTypeValue editRedo = 22;</span>
<a href="#l55.8"></a><span id="l55.8">   const nsMsgNavigationTypeValue toggleSubthreadKilled = 23;</span>
<a href="#l55.9"></a><span id="l55.9"> };</span>
<a href="#l55.10"></a><span id="l55.10"> </span>
<a href="#l55.11"></a><span id="l55.11"> </span>
<a href="#l55.12"></a><span id="l55.12" class="difflineminus">-[scriptable, uuid(7b6f1f8f-f27a-409b-955b-ab40d46194e1)]</span>
<a href="#l55.13"></a><span id="l55.13" class="difflineplus">+[scriptable, uuid(73b3c502-ac7b-4c3f-9265-8804f7ac11fe)]</span>
<a href="#l55.14"></a><span id="l55.14"> interface nsIMsgDBView : nsISupports</span>
<a href="#l55.15"></a><span id="l55.15"> {</span>
<a href="#l55.16"></a><span id="l55.16">   void open(in nsIMsgFolder folder, in nsMsgViewSortTypeValue sortType, in nsMsgViewSortOrderValue sortOrder, in nsMsgViewFlagsTypeValue viewFlags, out long count);</span>
<a href="#l55.17"></a><span id="l55.17">   void openWithHdrs(in nsISimpleEnumerator aHeaders, in nsMsgViewSortTypeValue aSortType, </span>
<a href="#l55.18"></a><span id="l55.18">                       in nsMsgViewSortOrderValue aSortOrder, </span>
<a href="#l55.19"></a><span id="l55.19">                       in nsMsgViewFlagsTypeValue aViewFlags, out long aCount);</span>
<a href="#l55.20"></a><span id="l55.20">   void close();</span>
<a href="#l55.21"></a><span id="l55.21"> </span>
<a href="#l55.22"></a><span id="l55.22" class="difflineat">@@ -364,16 +364,22 @@ interface nsIMsgDBView : nsISupports</span>
<a href="#l55.23"></a><span id="l55.23">    *  &quot;mail.operate_on_msgs_in_collapsed_threads&quot; preference is enabled, then</span>
<a href="#l55.24"></a><span id="l55.24">    *  any collapsed thread roots that are selected will also conceptually have</span>
<a href="#l55.25"></a><span id="l55.25">    *  all of the messages in that thread selected.</span>
<a href="#l55.26"></a><span id="l55.26">    */</span>
<a href="#l55.27"></a><span id="l55.27">   readonly attribute unsigned long numSelected;</span>
<a href="#l55.28"></a><span id="l55.28">   readonly attribute nsMsgViewIndex msgToSelectAfterDelete; </span>
<a href="#l55.29"></a><span id="l55.29">   readonly attribute nsMsgViewIndex currentlyDisplayedMessage; </span>
<a href="#l55.30"></a><span id="l55.30"> </span>
<a href="#l55.31"></a><span id="l55.31" class="difflineplus">+  /**</span>
<a href="#l55.32"></a><span id="l55.32" class="difflineplus">+   * Number of messages in view, including messages in collapsed threads.</span>
<a href="#l55.33"></a><span id="l55.33" class="difflineplus">+   * Not currently implemented for threads with unread or watched threads</span>
<a href="#l55.34"></a><span id="l55.34" class="difflineplus">+   * with unread.</span>
<a href="#l55.35"></a><span id="l55.35" class="difflineplus">+   */</span>
<a href="#l55.36"></a><span id="l55.36" class="difflineplus">+  readonly attribute long numMsgsInView;</span>
<a href="#l55.37"></a><span id="l55.37">   // used by &quot;go to folder&quot; feature</span>
<a href="#l55.38"></a><span id="l55.38">   // and &quot;remember last selected message&quot; feature</span>
<a href="#l55.39"></a><span id="l55.39">   // if key is not found, we don't select.</span>
<a href="#l55.40"></a><span id="l55.40">   void selectMsgByKey(in nsMsgKey key);</span>
<a href="#l55.41"></a><span id="l55.41"> </span>
<a href="#l55.42"></a><span id="l55.42">   void selectFolderMsgByKey(in nsIMsgFolder aFolder, in nsMsgKey aKey);</span>
<a href="#l55.43"></a><span id="l55.43">   // we'll suppress displaying messages if the message pane is collapsed</span>
<a href="#l55.44"></a><span id="l55.44">   attribute boolean suppressMsgDisplay;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1" class="difflineminus">--- a/mailnews/base/search/public/nsIMsgSearchSession.idl</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineplus">+++ b/mailnews/base/search/public/nsIMsgSearchSession.idl</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineat">@@ -47,101 +47,125 @@ interface nsIMsgHdr;</span>
<a href="#l56.4"></a><span id="l56.4"> interface nsIMsgDatabase;</span>
<a href="#l56.5"></a><span id="l56.5"> </span>
<a href="#l56.6"></a><span id="l56.6"> //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l56.7"></a><span id="l56.7"> // The Msg Search Session is an interface designed to make constructing</span>
<a href="#l56.8"></a><span id="l56.8"> // searches easier. Clients typically build up search terms, and then run</span>
<a href="#l56.9"></a><span id="l56.9"> // the search</span>
<a href="#l56.10"></a><span id="l56.10"> //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l56.11"></a><span id="l56.11"> </span>
<a href="#l56.12"></a><span id="l56.12" class="difflineminus">-[scriptable, uuid(a819050a-0302-11d3-a50a-0060b0fc04b7)]</span>
<a href="#l56.13"></a><span id="l56.13" class="difflineplus">+[scriptable, uuid(86c508e5-bf38-44d5-9af9-87a84754321f)]</span>
<a href="#l56.14"></a><span id="l56.14"> interface nsIMsgSearchSession :  nsISupports {</span>
<a href="#l56.15"></a><span id="l56.15"> </span>
<a href="#l56.16"></a><span id="l56.16"> /**</span>
<a href="#l56.17"></a><span id="l56.17">  * add a search term to the search session</span>
<a href="#l56.18"></a><span id="l56.18">  *</span>
<a href="#l56.19"></a><span id="l56.19">  * @param   attrib        search attribute (e.g. nsMsgSearchAttrib::Subject)</span>
<a href="#l56.20"></a><span id="l56.20">  * @param   op            search operator (e.g. nsMsgSearchOp::Contains)</span>
<a href="#l56.21"></a><span id="l56.21">  * @param   value         search value (e.g. &quot;Dogbert&quot;, see nsIMsgSearchValue)</span>
<a href="#l56.22"></a><span id="l56.22">  * @param   BooleanAND    set to true if associated boolean operator is AND</span>
<a href="#l56.23"></a><span id="l56.23">  * @param   customString  if attrib &gt; nsMsgSearchAttrib::OtherHeader,</span>
<a href="#l56.24"></a><span id="l56.24">  *                            a user defined arbitrary header</span>
<a href="#l56.25"></a><span id="l56.25">  *                        if attrib == nsMsgSearchAttrib::Custom, the custom id</span>
<a href="#l56.26"></a><span id="l56.26">  *                        otherwise ignored</span>
<a href="#l56.27"></a><span id="l56.27">  */</span>
<a href="#l56.28"></a><span id="l56.28" class="difflineminus">-    void addSearchTerm(in nsMsgSearchAttribValue attrib,</span>
<a href="#l56.29"></a><span id="l56.29" class="difflineminus">-                       in nsMsgSearchOpValue op,</span>
<a href="#l56.30"></a><span id="l56.30" class="difflineminus">-                       in nsIMsgSearchValue value,</span>
<a href="#l56.31"></a><span id="l56.31" class="difflineminus">-                       in boolean BooleanAND,</span>
<a href="#l56.32"></a><span id="l56.32" class="difflineminus">-                       in string customString);</span>
<a href="#l56.33"></a><span id="l56.33" class="difflineplus">+  void addSearchTerm(in nsMsgSearchAttribValue attrib,</span>
<a href="#l56.34"></a><span id="l56.34" class="difflineplus">+                     in nsMsgSearchOpValue op,</span>
<a href="#l56.35"></a><span id="l56.35" class="difflineplus">+                     in nsIMsgSearchValue value,</span>
<a href="#l56.36"></a><span id="l56.36" class="difflineplus">+                     in boolean BooleanAND,</span>
<a href="#l56.37"></a><span id="l56.37" class="difflineplus">+                     in string customString);</span>
<a href="#l56.38"></a><span id="l56.38"> </span>
<a href="#l56.39"></a><span id="l56.39" class="difflineminus">-    readonly attribute nsISupportsArray searchTerms;</span>
<a href="#l56.40"></a><span id="l56.40" class="difflineplus">+  readonly attribute nsISupportsArray searchTerms;</span>
<a href="#l56.41"></a><span id="l56.41"> </span>
<a href="#l56.42"></a><span id="l56.42">   nsIMsgSearchTerm createTerm ();</span>
<a href="#l56.43"></a><span id="l56.43" class="difflineminus">-    void appendTerm(in nsIMsgSearchTerm term);</span>
<a href="#l56.44"></a><span id="l56.44" class="difflineplus">+  void appendTerm(in nsIMsgSearchTerm term);</span>
<a href="#l56.45"></a><span id="l56.45" class="difflineplus">+</span>
<a href="#l56.46"></a><span id="l56.46" class="difflineplus">+  /**</span>
<a href="#l56.47"></a><span id="l56.47" class="difflineplus">+   * @name Search notification flags</span>
<a href="#l56.48"></a><span id="l56.48" class="difflineplus">+   * These flags determine which notifications will be sent.</span>
<a href="#l56.49"></a><span id="l56.49" class="difflineplus">+   * @{</span>
<a href="#l56.50"></a><span id="l56.50" class="difflineplus">+   */</span>
<a href="#l56.51"></a><span id="l56.51" class="difflineplus">+  /// search started notification</span>
<a href="#l56.52"></a><span id="l56.52" class="difflineplus">+  const long onNewSearch = 0x1;</span>
<a href="#l56.53"></a><span id="l56.53" class="difflineplus">+</span>
<a href="#l56.54"></a><span id="l56.54" class="difflineplus">+  /// search finished notification</span>
<a href="#l56.55"></a><span id="l56.55" class="difflineplus">+  const long onSearchDone = 0x2;</span>
<a href="#l56.56"></a><span id="l56.56"> </span>
<a href="#l56.57"></a><span id="l56.57" class="difflineminus">-  void registerListener (in nsIMsgSearchNotify listener);</span>
<a href="#l56.58"></a><span id="l56.58" class="difflineplus">+  /// search hit notification</span>
<a href="#l56.59"></a><span id="l56.59" class="difflineplus">+  const long onSearchHit = 0x4;</span>
<a href="#l56.60"></a><span id="l56.60" class="difflineplus">+</span>
<a href="#l56.61"></a><span id="l56.61" class="difflineplus">+  const long allNotifications = 0x7;</span>
<a href="#l56.62"></a><span id="l56.62" class="difflineplus">+  /** @} */</span>
<a href="#l56.63"></a><span id="l56.63" class="difflineplus">+</span>
<a href="#l56.64"></a><span id="l56.64" class="difflineplus">+  /**</span>
<a href="#l56.65"></a><span id="l56.65" class="difflineplus">+   * Add a listener to get notified of search starts, stops, and hits.</span>
<a href="#l56.66"></a><span id="l56.66" class="difflineplus">+   *</span>
<a href="#l56.67"></a><span id="l56.67" class="difflineplus">+   * @param aListener listener</span>
<a href="#l56.68"></a><span id="l56.68" class="difflineplus">+   * @param aNotifyFlags which notifications to send. Defaults to all</span>
<a href="#l56.69"></a><span id="l56.69" class="difflineplus">+   */</span>
<a href="#l56.70"></a><span id="l56.70" class="difflineplus">+  void registerListener (in nsIMsgSearchNotify aListener,</span>
<a href="#l56.71"></a><span id="l56.71" class="difflineplus">+                         [optional] in long aNotifyFlags);</span>
<a href="#l56.72"></a><span id="l56.72">   void unregisterListener (in nsIMsgSearchNotify listener);</span>
<a href="#l56.73"></a><span id="l56.73"> </span>
<a href="#l56.74"></a><span id="l56.74" class="difflineminus">-    readonly attribute unsigned long numSearchTerms;</span>
<a href="#l56.75"></a><span id="l56.75" class="difflineplus">+  readonly attribute unsigned long numSearchTerms;</span>
<a href="#l56.76"></a><span id="l56.76"> </span>
<a href="#l56.77"></a><span id="l56.77">   readonly attribute nsIMsgSearchAdapter runningAdapter;</span>
<a href="#l56.78"></a><span id="l56.78"> </span>
<a href="#l56.79"></a><span id="l56.79" class="difflineminus">-    void getNthSearchTerm(in long whichTerm,</span>
<a href="#l56.80"></a><span id="l56.80" class="difflineminus">-                          in nsMsgSearchAttribValue attrib,</span>
<a href="#l56.81"></a><span id="l56.81" class="difflineminus">-                          in nsMsgSearchOpValue op,</span>
<a href="#l56.82"></a><span id="l56.82" class="difflineminus">-                          in nsIMsgSearchValue value); // wrong, should be out</span>
<a href="#l56.83"></a><span id="l56.83" class="difflineplus">+  void getNthSearchTerm(in long whichTerm,</span>
<a href="#l56.84"></a><span id="l56.84" class="difflineplus">+                        in nsMsgSearchAttribValue attrib,</span>
<a href="#l56.85"></a><span id="l56.85" class="difflineplus">+                        in nsMsgSearchOpValue op,</span>
<a href="#l56.86"></a><span id="l56.86" class="difflineplus">+                        in nsIMsgSearchValue value); // wrong, should be out</span>
<a href="#l56.87"></a><span id="l56.87"> </span>
<a href="#l56.88"></a><span id="l56.88" class="difflineminus">-    long countSearchScopes();</span>
<a href="#l56.89"></a><span id="l56.89" class="difflineplus">+  long countSearchScopes();</span>
<a href="#l56.90"></a><span id="l56.90"> </span>
<a href="#l56.91"></a><span id="l56.91" class="difflineminus">-    void getNthSearchScope(in long which,out nsMsgSearchScopeValue scopeId, out nsIMsgFolder folder);</span>
<a href="#l56.92"></a><span id="l56.92" class="difflineplus">+  void getNthSearchScope(in long which,out nsMsgSearchScopeValue scopeId, out nsIMsgFolder folder);</span>
<a href="#l56.93"></a><span id="l56.93"> </span>
<a href="#l56.94"></a><span id="l56.94">   /* add a scope (e.g. a mail folder) to the search */</span>
<a href="#l56.95"></a><span id="l56.95" class="difflineminus">-    void addScopeTerm(in nsMsgSearchScopeValue scope,</span>
<a href="#l56.96"></a><span id="l56.96" class="difflineminus">-                      in nsIMsgFolder folder);</span>
<a href="#l56.97"></a><span id="l56.97" class="difflineplus">+  void addScopeTerm(in nsMsgSearchScopeValue scope,</span>
<a href="#l56.98"></a><span id="l56.98" class="difflineplus">+                    in nsIMsgFolder folder);</span>
<a href="#l56.99"></a><span id="l56.99"> </span>
<a href="#l56.100"></a><span id="l56.100" class="difflineminus">-    void addDirectoryScopeTerm(in nsMsgSearchScopeValue scope);</span>
<a href="#l56.101"></a><span id="l56.101" class="difflineplus">+  void addDirectoryScopeTerm(in nsMsgSearchScopeValue scope);</span>
<a href="#l56.102"></a><span id="l56.102"> </span>
<a href="#l56.103"></a><span id="l56.103" class="difflineminus">-    void clearScopes();</span>
<a href="#l56.104"></a><span id="l56.104" class="difflineplus">+  void clearScopes();</span>
<a href="#l56.105"></a><span id="l56.105"> </span>
<a href="#l56.106"></a><span id="l56.106" class="difflineminus">-    /* Call this function everytime the scope changes! It informs the FE if</span>
<a href="#l56.107"></a><span id="l56.107" class="difflineminus">-       the current scope support custom header use. FEs should not display the</span>
<a href="#l56.108"></a><span id="l56.108" class="difflineminus">-       custom header dialog if custom headers are not supported */</span>
<a href="#l56.109"></a><span id="l56.109" class="difflineminus">-    [noscript] boolean ScopeUsesCustomHeaders(in nsMsgSearchScopeValue scope,</span>
<a href="#l56.110"></a><span id="l56.110" class="difflineminus">-                                   /* could be a folder or server based on scope */</span>
<a href="#l56.111"></a><span id="l56.111" class="difflineminus">-                                   in voidPtr selection,</span>
<a href="#l56.112"></a><span id="l56.112" class="difflineminus">-                                   in boolean forFilters);</span>
<a href="#l56.113"></a><span id="l56.113" class="difflineplus">+  /* Call this function everytime the scope changes! It informs the FE if</span>
<a href="#l56.114"></a><span id="l56.114" class="difflineplus">+     the current scope support custom header use. FEs should not display the</span>
<a href="#l56.115"></a><span id="l56.115" class="difflineplus">+     custom header dialog if custom headers are not supported */</span>
<a href="#l56.116"></a><span id="l56.116" class="difflineplus">+  [noscript] boolean ScopeUsesCustomHeaders(in nsMsgSearchScopeValue scope,</span>
<a href="#l56.117"></a><span id="l56.117" class="difflineplus">+                                 /* could be a folder or server based on scope */</span>
<a href="#l56.118"></a><span id="l56.118" class="difflineplus">+                                 in voidPtr selection,</span>
<a href="#l56.119"></a><span id="l56.119" class="difflineplus">+                                 in boolean forFilters);</span>
<a href="#l56.120"></a><span id="l56.120"> </span>
<a href="#l56.121"></a><span id="l56.121" class="difflineminus">-    /* use this to determine if your attribute is a string attrib */</span>
<a href="#l56.122"></a><span id="l56.122" class="difflineminus">-    boolean IsStringAttribute(in nsMsgSearchAttribValue attrib);</span>
<a href="#l56.123"></a><span id="l56.123" class="difflineplus">+  /* use this to determine if your attribute is a string attrib */</span>
<a href="#l56.124"></a><span id="l56.124" class="difflineplus">+  boolean IsStringAttribute(in nsMsgSearchAttribValue attrib);</span>
<a href="#l56.125"></a><span id="l56.125"> </span>
<a href="#l56.126"></a><span id="l56.126" class="difflineminus">-    /* add all scopes of a given type to the search */</span>
<a href="#l56.127"></a><span id="l56.127" class="difflineminus">-    void AddAllScopes(in nsMsgSearchScopeValue attrib);</span>
<a href="#l56.128"></a><span id="l56.128" class="difflineplus">+  /* add all scopes of a given type to the search */</span>
<a href="#l56.129"></a><span id="l56.129" class="difflineplus">+  void AddAllScopes(in nsMsgSearchScopeValue attrib);</span>
<a href="#l56.130"></a><span id="l56.130"> </span>
<a href="#l56.131"></a><span id="l56.131" class="difflineminus">-    void search(in nsIMsgWindow aWindow);</span>
<a href="#l56.132"></a><span id="l56.132" class="difflineminus">-    void interruptSearch();</span>
<a href="#l56.133"></a><span id="l56.133" class="difflineplus">+  void search(in nsIMsgWindow aWindow);</span>
<a href="#l56.134"></a><span id="l56.134" class="difflineplus">+  void interruptSearch();</span>
<a href="#l56.135"></a><span id="l56.135"> </span>
<a href="#l56.136"></a><span id="l56.136">   // these two methods are used when the search session is using</span>
<a href="#l56.137"></a><span id="l56.137">   // a timer to do local search, and the search adapter needs</span>
<a href="#l56.138"></a><span id="l56.138">   // to run a url (e.g., to reparse a local folder) and wants to</span>
<a href="#l56.139"></a><span id="l56.139">   // pause the timer while running the url. This will fail if the</span>
<a href="#l56.140"></a><span id="l56.140">   // current adapter is not using a timer.</span>
<a href="#l56.141"></a><span id="l56.141" class="difflineminus">-    void pauseSearch();</span>
<a href="#l56.142"></a><span id="l56.142" class="difflineplus">+  void pauseSearch();</span>
<a href="#l56.143"></a><span id="l56.143">   void resumeSearch();</span>
<a href="#l56.144"></a><span id="l56.144"> </span>
<a href="#l56.145"></a><span id="l56.145" class="difflineminus">-    [noscript] readonly attribute voidPtr searchParam;</span>
<a href="#l56.146"></a><span id="l56.146" class="difflineminus">-    readonly attribute nsMsgSearchType searchType;</span>
<a href="#l56.147"></a><span id="l56.147" class="difflineplus">+  [noscript] readonly attribute voidPtr searchParam;</span>
<a href="#l56.148"></a><span id="l56.148" class="difflineplus">+  readonly attribute nsMsgSearchType searchType;</span>
<a href="#l56.149"></a><span id="l56.149"> </span>
<a href="#l56.150"></a><span id="l56.150" class="difflineminus">-    [noscript] nsMsgSearchType SetSearchParam(in nsMsgSearchType type,</span>
<a href="#l56.151"></a><span id="l56.151" class="difflineminus">-                                              in voidPtr param);</span>
<a href="#l56.152"></a><span id="l56.152" class="difflineplus">+  [noscript] nsMsgSearchType SetSearchParam(in nsMsgSearchType type,</span>
<a href="#l56.153"></a><span id="l56.153" class="difflineplus">+                                            in voidPtr param);</span>
<a href="#l56.154"></a><span id="l56.154"> </span>
<a href="#l56.155"></a><span id="l56.155">   [noscript] void AddResultElement(in nsMsgResultElement element);</span>
<a href="#l56.156"></a><span id="l56.156">   boolean MatchHdr(in nsIMsgDBHdr aMsgHdr, in nsIMsgDatabase aDatabase);</span>
<a href="#l56.157"></a><span id="l56.157"> </span>
<a href="#l56.158"></a><span id="l56.158">   void addSearchHit(in nsIMsgDBHdr header, in nsIMsgFolder folder);</span>
<a href="#l56.159"></a><span id="l56.159"> </span>
<a href="#l56.160"></a><span id="l56.160" class="difflineminus">-    readonly attribute long numResults;</span>
<a href="#l56.161"></a><span id="l56.161" class="difflineplus">+  readonly attribute long numResults;</span>
<a href="#l56.162"></a><span id="l56.162">   attribute nsIMsgWindow window;</span>
<a href="#l56.163"></a><span id="l56.163"> </span>
<a href="#l56.164"></a><span id="l56.164" class="difflineminus">-    /* these longs are all actually of type nsMsgSearchBooleanOp */</span>
<a href="#l56.165"></a><span id="l56.165" class="difflineminus">-    const long BooleanOR=0;</span>
<a href="#l56.166"></a><span id="l56.166" class="difflineminus">-    const long BooleanAND=1;</span>
<a href="#l56.167"></a><span id="l56.167" class="difflineplus">+  /* these longs are all actually of type nsMsgSearchBooleanOp */</span>
<a href="#l56.168"></a><span id="l56.168" class="difflineplus">+  const long BooleanOR=0;</span>
<a href="#l56.169"></a><span id="l56.169" class="difflineplus">+  const long BooleanAND=1;</span>
<a href="#l56.170"></a><span id="l56.170"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilterService.cpp</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilterService.cpp</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -367,17 +367,18 @@ nsresult nsMsgFilterAfterTheFact::RunNex</span>
<a href="#l57.4"></a><span id="l57.4">   for (PRUint32 termIndex = 0; termIndex &lt; termCount; termIndex++)</span>
<a href="#l57.5"></a><span id="l57.5">   {</span>
<a href="#l57.6"></a><span id="l57.6">     nsCOMPtr &lt;nsIMsgSearchTerm&gt; term;</span>
<a href="#l57.7"></a><span id="l57.7">     rv = searchTerms-&gt;QueryElementAt(termIndex, NS_GET_IID(nsIMsgSearchTerm), getter_AddRefs(term));</span>
<a href="#l57.8"></a><span id="l57.8">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l57.9"></a><span id="l57.9">     rv = m_searchSession-&gt;AppendTerm(term);</span>
<a href="#l57.10"></a><span id="l57.10">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l57.11"></a><span id="l57.11">   }</span>
<a href="#l57.12"></a><span id="l57.12" class="difflineminus">-  m_searchSession-&gt;RegisterListener(this);</span>
<a href="#l57.13"></a><span id="l57.13" class="difflineplus">+  m_searchSession-&gt;RegisterListener(this,</span>
<a href="#l57.14"></a><span id="l57.14" class="difflineplus">+                                    nsIMsgSearchSession::allNotifications);</span>
<a href="#l57.15"></a><span id="l57.15"> </span>
<a href="#l57.16"></a><span id="l57.16">   rv = m_searchSession-&gt;AddScopeTerm(searchScope, m_curFolder);</span>
<a href="#l57.17"></a><span id="l57.17">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l57.18"></a><span id="l57.18">   m_nextAction = 0;</span>
<a href="#l57.19"></a><span id="l57.19">   // it's possible that this error handling will need to be rearranged when mscott lands the UI for</span>
<a href="#l57.20"></a><span id="l57.20">   // doing filters based on sender in PAB, because we can't do that for IMAP. I believe appending the</span>
<a href="#l57.21"></a><span id="l57.21">   // search term will fail, or the Search itself will fail synchronously. In that case, we'll</span>
<a href="#l57.22"></a><span id="l57.22">   // have to ignore the filter, I believe. Ultimately, we'd like to re-work the search backend</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchSession.cpp</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchSession.cpp</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineat">@@ -128,28 +128,43 @@ nsMsgSearchSession::CreateTerm(nsIMsgSea</span>
<a href="#l58.4"></a><span id="l58.4">     NS_ENSURE_TRUE(term, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l58.5"></a><span id="l58.5"> </span>
<a href="#l58.6"></a><span id="l58.6">     *aResult = static_cast&lt;nsIMsgSearchTerm*&gt;(term);</span>
<a href="#l58.7"></a><span id="l58.7">     NS_ADDREF(*aResult);</span>
<a href="#l58.8"></a><span id="l58.8">     return NS_OK;</span>
<a href="#l58.9"></a><span id="l58.9"> }</span>
<a href="#l58.10"></a><span id="l58.10"> </span>
<a href="#l58.11"></a><span id="l58.11"> /* void RegisterListener (in nsIMsgSearchNotify listener); */</span>
<a href="#l58.12"></a><span id="l58.12" class="difflineminus">-NS_IMETHODIMP nsMsgSearchSession::RegisterListener(nsIMsgSearchNotify *aListener)</span>
<a href="#l58.13"></a><span id="l58.13" class="difflineplus">+NS_IMETHODIMP nsMsgSearchSession::RegisterListener(nsIMsgSearchNotify *aListener,</span>
<a href="#l58.14"></a><span id="l58.14" class="difflineplus">+                                                   PRInt32 aNotifyFlags)</span>
<a href="#l58.15"></a><span id="l58.15"> {</span>
<a href="#l58.16"></a><span id="l58.16">   NS_ENSURE_ARG_POINTER(aListener);</span>
<a href="#l58.17"></a><span id="l58.17">   m_listenerList.AppendElement(aListener);</span>
<a href="#l58.18"></a><span id="l58.18" class="difflineplus">+  m_listenerFlagList.AppendElement(aNotifyFlags);</span>
<a href="#l58.19"></a><span id="l58.19">   return NS_OK;</span>
<a href="#l58.20"></a><span id="l58.20"> }</span>
<a href="#l58.21"></a><span id="l58.21"> </span>
<a href="#l58.22"></a><span id="l58.22"> /* void UnregisterListener (in nsIMsgSearchNotify listener); */</span>
<a href="#l58.23"></a><span id="l58.23"> NS_IMETHODIMP nsMsgSearchSession::UnregisterListener(nsIMsgSearchNotify *aListener)</span>
<a href="#l58.24"></a><span id="l58.24"> {</span>
<a href="#l58.25"></a><span id="l58.25">   NS_ENSURE_ARG_POINTER(aListener);</span>
<a href="#l58.26"></a><span id="l58.26" class="difflineminus">-  m_listenerList.RemoveElement(aListener);</span>
<a href="#l58.27"></a><span id="l58.27" class="difflineplus">+  PRInt32 listenerIndex = m_listenerList.IndexOf(aListener);</span>
<a href="#l58.28"></a><span id="l58.28" class="difflineplus">+  if (listenerIndex != -1)</span>
<a href="#l58.29"></a><span id="l58.29" class="difflineplus">+  {</span>
<a href="#l58.30"></a><span id="l58.30" class="difflineplus">+    m_listenerList.RemoveElementAt(listenerIndex);</span>
<a href="#l58.31"></a><span id="l58.31" class="difflineplus">+    m_listenerFlagList.RemoveElementAt(listenerIndex);</span>
<a href="#l58.32"></a><span id="l58.32" class="difflineplus">+</span>
<a href="#l58.33"></a><span id="l58.33" class="difflineplus">+    // Adjust our iterator if it is active.</span>
<a href="#l58.34"></a><span id="l58.34" class="difflineplus">+    // Removal of something at a higher index than the iterator does not affect</span>
<a href="#l58.35"></a><span id="l58.35" class="difflineplus">+    // it; we only care if the the index we were pointing at gets shifted down,</span>
<a href="#l58.36"></a><span id="l58.36" class="difflineplus">+    // in which case we also want to shift down.</span>
<a href="#l58.37"></a><span id="l58.37" class="difflineplus">+    if (m_iListener != -1 &amp;&amp; listenerIndex &lt;= m_iListener)</span>
<a href="#l58.38"></a><span id="l58.38" class="difflineplus">+      m_iListener--;</span>
<a href="#l58.39"></a><span id="l58.39" class="difflineplus">+  }</span>
<a href="#l58.40"></a><span id="l58.40" class="difflineplus">+</span>
<a href="#l58.41"></a><span id="l58.41">   return NS_OK;</span>
<a href="#l58.42"></a><span id="l58.42"> }</span>
<a href="#l58.43"></a><span id="l58.43"> </span>
<a href="#l58.44"></a><span id="l58.44"> /* readonly attribute long numSearchTerms; */</span>
<a href="#l58.45"></a><span id="l58.45"> NS_IMETHODIMP nsMsgSearchSession::GetNumSearchTerms(PRUint32 *aNumSearchTerms)</span>
<a href="#l58.46"></a><span id="l58.46"> {</span>
<a href="#l58.47"></a><span id="l58.47">   NS_ENSURE_ARG(aNumSearchTerms);</span>
<a href="#l58.48"></a><span id="l58.48">   return m_termList-&gt;Count(aNumSearchTerms);</span>
<a href="#l58.49"></a><span id="l58.49" class="difflineat">@@ -253,23 +268,26 @@ nsMsgSearchSession::AddAllScopes(nsMsgSe</span>
<a href="#l58.50"></a><span id="l58.50"> }</span>
<a href="#l58.51"></a><span id="l58.51"> </span>
<a href="#l58.52"></a><span id="l58.52"> /* void Search (); */</span>
<a href="#l58.53"></a><span id="l58.53"> NS_IMETHODIMP nsMsgSearchSession::Search(nsIMsgWindow *aWindow)</span>
<a href="#l58.54"></a><span id="l58.54"> {</span>
<a href="#l58.55"></a><span id="l58.55">   nsresult rv = Initialize();</span>
<a href="#l58.56"></a><span id="l58.56">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l58.57"></a><span id="l58.57"> </span>
<a href="#l58.58"></a><span id="l58.58" class="difflineminus">-  nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgSearchNotify&gt; &gt;::ForwardIterator iter(m_listenerList);</span>
<a href="#l58.59"></a><span id="l58.59">   nsCOMPtr&lt;nsIMsgSearchNotify&gt; listener;</span>
<a href="#l58.60"></a><span id="l58.60" class="difflineminus">-  while (iter.HasMore())</span>
<a href="#l58.61"></a><span id="l58.61" class="difflineplus">+  m_iListener = 0;</span>
<a href="#l58.62"></a><span id="l58.62" class="difflineplus">+  while (m_iListener != -1 &amp;&amp; m_iListener &lt; m_listenerList.Length())</span>
<a href="#l58.63"></a><span id="l58.63">   {</span>
<a href="#l58.64"></a><span id="l58.64" class="difflineminus">-    listener = iter.GetNext();</span>
<a href="#l58.65"></a><span id="l58.65" class="difflineminus">-    listener-&gt;OnNewSearch();</span>
<a href="#l58.66"></a><span id="l58.66" class="difflineplus">+    listener = m_listenerList[m_iListener];</span>
<a href="#l58.67"></a><span id="l58.67" class="difflineplus">+    PRInt32 listenerFlags = m_listenerFlagList[m_iListener++];</span>
<a href="#l58.68"></a><span id="l58.68" class="difflineplus">+    if (!listenerFlags || (listenerFlags &amp; nsIMsgSearchSession::onNewSearch))</span>
<a href="#l58.69"></a><span id="l58.69" class="difflineplus">+      listener-&gt;OnNewSearch();</span>
<a href="#l58.70"></a><span id="l58.70">   }</span>
<a href="#l58.71"></a><span id="l58.71" class="difflineplus">+  m_iListener = -1;</span>
<a href="#l58.72"></a><span id="l58.72"> </span>
<a href="#l58.73"></a><span id="l58.73">   m_msgWindowWeak = do_GetWeakReference(aWindow);</span>
<a href="#l58.74"></a><span id="l58.74"> </span>
<a href="#l58.75"></a><span id="l58.75">   return BeginSearching();</span>
<a href="#l58.76"></a><span id="l58.76"> }</span>
<a href="#l58.77"></a><span id="l58.77"> </span>
<a href="#l58.78"></a><span id="l58.78"> /* void InterruptSearch (); */</span>
<a href="#l58.79"></a><span id="l58.79"> NS_IMETHODIMP nsMsgSearchSession::InterruptSearch()</span>
<a href="#l58.80"></a><span id="l58.80" class="difflineat">@@ -568,40 +586,45 @@ NS_IMETHODIMP nsMsgSearchSession::GetRun</span>
<a href="#l58.81"></a><span id="l58.81">   }</span>
<a href="#l58.82"></a><span id="l58.82">   *aSearchAdapter = nsnull;</span>
<a href="#l58.83"></a><span id="l58.83">   return NS_OK;</span>
<a href="#l58.84"></a><span id="l58.84"> }</span>
<a href="#l58.85"></a><span id="l58.85"> </span>
<a href="#l58.86"></a><span id="l58.86"> NS_IMETHODIMP nsMsgSearchSession::AddSearchHit(nsIMsgDBHdr *aHeader,</span>
<a href="#l58.87"></a><span id="l58.87">                                                nsIMsgFolder *aFolder)</span>
<a href="#l58.88"></a><span id="l58.88"> {</span>
<a href="#l58.89"></a><span id="l58.89" class="difflineminus">-  nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgSearchNotify&gt; &gt;::ForwardIterator iter(m_listenerList);</span>
<a href="#l58.90"></a><span id="l58.90">   nsCOMPtr&lt;nsIMsgSearchNotify&gt; listener;</span>
<a href="#l58.91"></a><span id="l58.91" class="difflineminus">-  while (iter.HasMore())</span>
<a href="#l58.92"></a><span id="l58.92" class="difflineplus">+  m_iListener = 0;</span>
<a href="#l58.93"></a><span id="l58.93" class="difflineplus">+  while (m_iListener != -1 &amp;&amp; m_iListener &lt; m_listenerList.Length())</span>
<a href="#l58.94"></a><span id="l58.94">   {</span>
<a href="#l58.95"></a><span id="l58.95" class="difflineminus">-    listener = iter.GetNext();</span>
<a href="#l58.96"></a><span id="l58.96" class="difflineminus">-    listener-&gt;OnSearchHit(aHeader, aFolder);</span>
<a href="#l58.97"></a><span id="l58.97" class="difflineplus">+    listener = m_listenerList[m_iListener];</span>
<a href="#l58.98"></a><span id="l58.98" class="difflineplus">+    PRInt32 listenerFlags = m_listenerFlagList[m_iListener++];</span>
<a href="#l58.99"></a><span id="l58.99" class="difflineplus">+    if (!listenerFlags || (listenerFlags &amp; nsIMsgSearchSession::onSearchHit))</span>
<a href="#l58.100"></a><span id="l58.100" class="difflineplus">+      listener-&gt;OnSearchHit(aHeader, aFolder);</span>
<a href="#l58.101"></a><span id="l58.101">   }</span>
<a href="#l58.102"></a><span id="l58.102" class="difflineplus">+  m_iListener = -1;</span>
<a href="#l58.103"></a><span id="l58.103">   return NS_OK;</span>
<a href="#l58.104"></a><span id="l58.104"> }</span>
<a href="#l58.105"></a><span id="l58.105"> </span>
<a href="#l58.106"></a><span id="l58.106"> nsresult nsMsgSearchSession::NotifyListenersDone(nsresult aStatus)</span>
<a href="#l58.107"></a><span id="l58.107"> {</span>
<a href="#l58.108"></a><span id="l58.108">   // need to stabilize &quot;this&quot; in case one of the listeners releases the last</span>
<a href="#l58.109"></a><span id="l58.109">   // reference to us.</span>
<a href="#l58.110"></a><span id="l58.110">   nsRefPtr &lt;nsIMsgSearchSession&gt; kungFuDeathGrip(this);</span>
<a href="#l58.111"></a><span id="l58.111"> </span>
<a href="#l58.112"></a><span id="l58.112" class="difflineminus">-  nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgSearchNotify&gt; &gt;::ForwardIterator iter(m_listenerList);</span>
<a href="#l58.113"></a><span id="l58.113">   nsCOMPtr&lt;nsIMsgSearchNotify&gt; listener;</span>
<a href="#l58.114"></a><span id="l58.114" class="difflineminus">-</span>
<a href="#l58.115"></a><span id="l58.115" class="difflineminus">-  while (iter.HasMore())</span>
<a href="#l58.116"></a><span id="l58.116" class="difflineplus">+  m_iListener = 0;</span>
<a href="#l58.117"></a><span id="l58.117" class="difflineplus">+  while (m_iListener != -1 &amp;&amp; m_iListener &lt; m_listenerList.Length())</span>
<a href="#l58.118"></a><span id="l58.118">   {</span>
<a href="#l58.119"></a><span id="l58.119" class="difflineminus">-    listener = iter.GetNext();</span>
<a href="#l58.120"></a><span id="l58.120" class="difflineminus">-    listener-&gt;OnSearchDone(aStatus);</span>
<a href="#l58.121"></a><span id="l58.121" class="difflineplus">+    listener = m_listenerList[m_iListener];</span>
<a href="#l58.122"></a><span id="l58.122" class="difflineplus">+    PRInt32 listenerFlags = m_listenerFlagList[m_iListener++];</span>
<a href="#l58.123"></a><span id="l58.123" class="difflineplus">+    if (!listenerFlags || (listenerFlags &amp; nsIMsgSearchSession::onSearchDone))</span>
<a href="#l58.124"></a><span id="l58.124" class="difflineplus">+      listener-&gt;OnSearchDone(aStatus);</span>
<a href="#l58.125"></a><span id="l58.125">   }</span>
<a href="#l58.126"></a><span id="l58.126" class="difflineplus">+  m_iListener = -1;</span>
<a href="#l58.127"></a><span id="l58.127">   return NS_OK;</span>
<a href="#l58.128"></a><span id="l58.128"> }</span>
<a href="#l58.129"></a><span id="l58.129"> </span>
<a href="#l58.130"></a><span id="l58.130"> </span>
<a href="#l58.131"></a><span id="l58.131"> NS_IMETHODIMP nsMsgSearchSession::AddResultElement (nsMsgResultElement *element)</span>
<a href="#l58.132"></a><span id="l58.132"> {</span>
<a href="#l58.133"></a><span id="l58.133">   NS_ASSERTION(element, &quot;no null elements&quot;);</span>
<a href="#l58.134"></a><span id="l58.134"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchSession.h</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchSession.h</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineat">@@ -77,17 +77,36 @@ protected:</span>
<a href="#l59.4"></a><span id="l59.4">   nsresult SearchWOUrls ();</span>
<a href="#l59.5"></a><span id="l59.5">   nsresult GetNextUrl();</span>
<a href="#l59.6"></a><span id="l59.6">   nsresult NotifyListenersDone(nsresult status);</span>
<a href="#l59.7"></a><span id="l59.7">   void EnableFolderNotifications(PRBool aEnable);</span>
<a href="#l59.8"></a><span id="l59.8">   void ReleaseFolderDBRef();</span>
<a href="#l59.9"></a><span id="l59.9"> </span>
<a href="#l59.10"></a><span id="l59.10">   nsMsgSearchScopeTermArray m_scopeList;</span>
<a href="#l59.11"></a><span id="l59.11">   nsCOMPtr &lt;nsISupportsArray&gt; m_termList;</span>
<a href="#l59.12"></a><span id="l59.12" class="difflineminus">-  nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgSearchNotify&gt; &gt; m_listenerList;</span>
<a href="#l59.13"></a><span id="l59.13" class="difflineplus">+</span>
<a href="#l59.14"></a><span id="l59.14" class="difflineplus">+  nsTArray&lt;nsCOMPtr&lt;nsIMsgSearchNotify&gt; &gt; m_listenerList;</span>
<a href="#l59.15"></a><span id="l59.15" class="difflineplus">+  nsTArray&lt;PRInt32&gt; m_listenerFlagList;</span>
<a href="#l59.16"></a><span id="l59.16" class="difflineplus">+  /**</span>
<a href="#l59.17"></a><span id="l59.17" class="difflineplus">+   * Iterator index for m_listenerList/m_listenerFlagList.  We used to use an</span>
<a href="#l59.18"></a><span id="l59.18" class="difflineplus">+   * nsTObserverArray for m_listenerList but its auto-adjusting iterator was</span>
<a href="#l59.19"></a><span id="l59.19" class="difflineplus">+   * not helping us keep our m_listenerFlagList iterator correct.</span>
<a href="#l59.20"></a><span id="l59.20" class="difflineplus">+   *</span>
<a href="#l59.21"></a><span id="l59.21" class="difflineplus">+   * We are making the simplifying assumption that our notifications are</span>
<a href="#l59.22"></a><span id="l59.22" class="difflineplus">+   * non-reentrant.  In the exceptional case that it turns out they are</span>
<a href="#l59.23"></a><span id="l59.23" class="difflineplus">+   * reentrant, we assume that this is the result of canceling a search while</span>
<a href="#l59.24"></a><span id="l59.24" class="difflineplus">+   * the session is active and initiating a new one.  In that case, we assume</span>
<a href="#l59.25"></a><span id="l59.25" class="difflineplus">+   * the outer iteration can safely be abandoned.</span>
<a href="#l59.26"></a><span id="l59.26" class="difflineplus">+   *</span>
<a href="#l59.27"></a><span id="l59.27" class="difflineplus">+   * This value is defined to be the index of the next listener we will process.</span>
<a href="#l59.28"></a><span id="l59.28" class="difflineplus">+   * This allows us to use the sentinel value of -1 to convey that no iteration</span>
<a href="#l59.29"></a><span id="l59.29" class="difflineplus">+   * is in progress (and the iteration process to abort if the value transitions</span>
<a href="#l59.30"></a><span id="l59.30" class="difflineplus">+   * to -1, which we always set on conclusion of our loop).</span>
<a href="#l59.31"></a><span id="l59.31" class="difflineplus">+   */</span>
<a href="#l59.32"></a><span id="l59.32" class="difflineplus">+  PRInt32 m_iListener;</span>
<a href="#l59.33"></a><span id="l59.33"> </span>
<a href="#l59.34"></a><span id="l59.34">   nsMsgResultArray m_resultList;</span>
<a href="#l59.35"></a><span id="l59.35"> </span>
<a href="#l59.36"></a><span id="l59.36">   void DestroyTermList ();</span>
<a href="#l59.37"></a><span id="l59.37">   void DestroyScopeList ();</span>
<a href="#l59.38"></a><span id="l59.38">   void DestroyResultList ();</span>
<a href="#l59.39"></a><span id="l59.39"> </span>
<a href="#l59.40"></a><span id="l59.40">   static void TimerCallback(nsITimer *aTimer, void *aClosure);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1" class="difflineminus">--- a/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineat">@@ -6754,16 +6754,22 @@ nsMsgDBView::GetNumSelected(PRUint32 *aN</span>
<a href="#l60.4"></a><span id="l60.4">       ExpansionDelta(selection[i], &amp;collapsedCount);</span>
<a href="#l60.5"></a><span id="l60.5">       numSelectedIncludingCollapsed += collapsedCount;</span>
<a href="#l60.6"></a><span id="l60.6">     }</span>
<a href="#l60.7"></a><span id="l60.7">   }</span>
<a href="#l60.8"></a><span id="l60.8">   *aNumSelected = numSelectedIncludingCollapsed;</span>
<a href="#l60.9"></a><span id="l60.9">   return rv;</span>
<a href="#l60.10"></a><span id="l60.10"> }</span>
<a href="#l60.11"></a><span id="l60.11"> </span>
<a href="#l60.12"></a><span id="l60.12" class="difflineplus">+NS_IMETHODIMP nsMsgDBView::GetNumMsgsInView(PRInt32 *aNumMsgs)</span>
<a href="#l60.13"></a><span id="l60.13" class="difflineplus">+{</span>
<a href="#l60.14"></a><span id="l60.14" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aNumMsgs);</span>
<a href="#l60.15"></a><span id="l60.15" class="difflineplus">+  return (m_folder) ? m_folder-&gt;GetTotalMessages(PR_FALSE, aNumMsgs) :</span>
<a href="#l60.16"></a><span id="l60.16" class="difflineplus">+                    NS_ERROR_FAILURE;</span>
<a href="#l60.17"></a><span id="l60.17" class="difflineplus">+}</span>
<a href="#l60.18"></a><span id="l60.18"> /**</span>
<a href="#l60.19"></a><span id="l60.19">  * @note For the IMAP delete model, this applies to both deleting and </span>
<a href="#l60.20"></a><span id="l60.20">  *       undeleting a message.</span>
<a href="#l60.21"></a><span id="l60.21">  */</span>
<a href="#l60.22"></a><span id="l60.22"> NS_IMETHODIMP</span>
<a href="#l60.23"></a><span id="l60.23"> nsMsgDBView::GetMsgToSelectAfterDelete(nsMsgViewIndex *msgToSelectAfterDelete)</span>
<a href="#l60.24"></a><span id="l60.24"> {</span>
<a href="#l60.25"></a><span id="l60.25">   NS_ENSURE_ARG_POINTER(msgToSelectAfterDelete);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1" class="difflineminus">--- a/mailnews/base/src/nsMsgPurgeService.cpp</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgPurgeService.cpp</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineat">@@ -391,17 +391,18 @@ nsresult nsMsgPurgeService::PerformPurge</span>
<a href="#l61.4"></a><span id="l61.4">   return rv;</span>
<a href="#l61.5"></a><span id="l61.5"> }</span>
<a href="#l61.6"></a><span id="l61.6"> </span>
<a href="#l61.7"></a><span id="l61.7"> nsresult nsMsgPurgeService::SearchFolderToPurge(nsIMsgFolder *folder, PRInt32 purgeInterval)</span>
<a href="#l61.8"></a><span id="l61.8"> {</span>
<a href="#l61.9"></a><span id="l61.9">   nsresult rv;</span>
<a href="#l61.10"></a><span id="l61.10">   mSearchSession = do_CreateInstance(NS_MSGSEARCHSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l61.11"></a><span id="l61.11">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l61.12"></a><span id="l61.12" class="difflineminus">-  mSearchSession-&gt;RegisterListener(this);</span>
<a href="#l61.13"></a><span id="l61.13" class="difflineplus">+  mSearchSession-&gt;RegisterListener(this,</span>
<a href="#l61.14"></a><span id="l61.14" class="difflineplus">+                                   nsIMsgSearchSession::allNotifications);</span>
<a href="#l61.15"></a><span id="l61.15"> </span>
<a href="#l61.16"></a><span id="l61.16">   // update the time we attempted to purge this folder</span>
<a href="#l61.17"></a><span id="l61.17">   char dateBuf[100];</span>
<a href="#l61.18"></a><span id="l61.18">   dateBuf[0] = '\0';</span>
<a href="#l61.19"></a><span id="l61.19">   PRExplodedTime exploded;</span>
<a href="#l61.20"></a><span id="l61.20">   PR_ExplodeTime(PR_Now(), PR_LocalTimeParameters, &amp;exploded);</span>
<a href="#l61.21"></a><span id="l61.21">   PR_FormatTimeUSEnglish(dateBuf, sizeof(dateBuf), &quot;%a %b %d %H:%M:%S %Y&quot;, &amp;exploded);</span>
<a href="#l61.22"></a><span id="l61.22">   folder-&gt;SetStringProperty(&quot;curJunkFolderLastPurgeTime&quot;, nsDependentCString(dateBuf));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1" class="difflineminus">--- a/mailnews/base/src/nsMsgQuickSearchDBView.cpp</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgQuickSearchDBView.cpp</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineat">@@ -51,18 +51,17 @@</span>
<a href="#l62.4"></a><span id="l62.4"> </span>
<a href="#l62.5"></a><span id="l62.5"> nsMsgQuickSearchDBView::nsMsgQuickSearchDBView()</span>
<a href="#l62.6"></a><span id="l62.6"> {</span>
<a href="#l62.7"></a><span id="l62.7">   m_usingCachedHits = PR_FALSE;</span>
<a href="#l62.8"></a><span id="l62.8">   m_cacheEmpty = PR_TRUE;</span>
<a href="#l62.9"></a><span id="l62.9"> }</span>
<a href="#l62.10"></a><span id="l62.10"> </span>
<a href="#l62.11"></a><span id="l62.11"> nsMsgQuickSearchDBView::~nsMsgQuickSearchDBView()</span>
<a href="#l62.12"></a><span id="l62.12" class="difflineminus">-{	</span>
<a href="#l62.13"></a><span id="l62.13" class="difflineminus">- /* destructor code */</span>
<a href="#l62.14"></a><span id="l62.14" class="difflineplus">+{</span>
<a href="#l62.15"></a><span id="l62.15"> }</span>
<a href="#l62.16"></a><span id="l62.16"> </span>
<a href="#l62.17"></a><span id="l62.17"> NS_IMPL_ISUPPORTS_INHERITED2(nsMsgQuickSearchDBView, nsMsgDBView, nsIMsgDBView, nsIMsgSearchNotify)</span>
<a href="#l62.18"></a><span id="l62.18"> </span>
<a href="#l62.19"></a><span id="l62.19"> NS_IMETHODIMP nsMsgQuickSearchDBView::Open(nsIMsgFolder *folder, nsMsgViewSortTypeValue sortType, nsMsgViewSortOrderValue sortOrder, nsMsgViewFlagsTypeValue viewFlags, PRInt32 *pCount)</span>
<a href="#l62.20"></a><span id="l62.20"> {</span>
<a href="#l62.21"></a><span id="l62.21">   nsresult rv = nsMsgDBView::Open(folder, sortType, sortOrder, viewFlags, pCount);</span>
<a href="#l62.22"></a><span id="l62.22">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l62.23"></a><span id="l62.23" class="difflineat">@@ -89,16 +88,30 @@ nsMsgQuickSearchDBView::CloneDBView(nsIM</span>
<a href="#l62.24"></a><span id="l62.24"> </span>
<a href="#l62.25"></a><span id="l62.25">   nsresult rv = CopyDBView(newMsgDBView, aMessengerInstance, aMsgWindow, aCmdUpdater);</span>
<a href="#l62.26"></a><span id="l62.26">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l62.27"></a><span id="l62.27"> </span>
<a href="#l62.28"></a><span id="l62.28">   NS_IF_ADDREF(*_retval = newMsgDBView);</span>
<a href="#l62.29"></a><span id="l62.29">   return NS_OK;</span>
<a href="#l62.30"></a><span id="l62.30"> }</span>
<a href="#l62.31"></a><span id="l62.31"> </span>
<a href="#l62.32"></a><span id="l62.32" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l62.33"></a><span id="l62.33" class="difflineplus">+nsMsgQuickSearchDBView::CopyDBView(nsMsgDBView *aNewMsgDBView,</span>
<a href="#l62.34"></a><span id="l62.34" class="difflineplus">+                                   nsIMessenger *aMessengerInstance,</span>
<a href="#l62.35"></a><span id="l62.35" class="difflineplus">+                                   nsIMsgWindow *aMsgWindow,</span>
<a href="#l62.36"></a><span id="l62.36" class="difflineplus">+                                   nsIMsgDBViewCommandUpdater *aCmdUpdater)</span>
<a href="#l62.37"></a><span id="l62.37" class="difflineplus">+{</span>
<a href="#l62.38"></a><span id="l62.38" class="difflineplus">+  nsMsgThreadedDBView::CopyDBView(aNewMsgDBView, aMessengerInstance, aMsgWindow, aCmdUpdater);</span>
<a href="#l62.39"></a><span id="l62.39" class="difflineplus">+  nsMsgQuickSearchDBView* newMsgDBView = (nsMsgQuickSearchDBView *) aNewMsgDBView;</span>
<a href="#l62.40"></a><span id="l62.40" class="difflineplus">+</span>
<a href="#l62.41"></a><span id="l62.41" class="difflineplus">+  // now copy all of our private member data</span>
<a href="#l62.42"></a><span id="l62.42" class="difflineplus">+  newMsgDBView-&gt;m_origKeys = m_origKeys;</span>
<a href="#l62.43"></a><span id="l62.43" class="difflineplus">+  return NS_OK;</span>
<a href="#l62.44"></a><span id="l62.44" class="difflineplus">+}</span>
<a href="#l62.45"></a><span id="l62.45" class="difflineplus">+</span>
<a href="#l62.46"></a><span id="l62.46"> nsresult nsMsgQuickSearchDBView::DeleteMessages(nsIMsgWindow *window, nsMsgViewIndex *indices, PRInt32 numIndices, PRBool deleteStorage)</span>
<a href="#l62.47"></a><span id="l62.47"> {</span>
<a href="#l62.48"></a><span id="l62.48">   for (nsMsgViewIndex i = 0; i &lt; (nsMsgViewIndex) numIndices; i++) </span>
<a href="#l62.49"></a><span id="l62.49">   {</span>
<a href="#l62.50"></a><span id="l62.50">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr; </span>
<a href="#l62.51"></a><span id="l62.51">     (void) GetMsgHdrForViewIndex(indices[i],getter_AddRefs(msgHdr));</span>
<a href="#l62.52"></a><span id="l62.52">     if (msgHdr)</span>
<a href="#l62.53"></a><span id="l62.53">       RememberDeletedMsgHdr(msgHdr);</span>
<a href="#l62.54"></a><span id="l62.54" class="difflineat">@@ -187,17 +200,19 @@ nsresult nsMsgQuickSearchDBView::OnNewHe</span>
<a href="#l62.55"></a><span id="l62.55">   return NS_OK;</span>
<a href="#l62.56"></a><span id="l62.56"> }</span>
<a href="#l62.57"></a><span id="l62.57"> </span>
<a href="#l62.58"></a><span id="l62.58"> NS_IMETHODIMP nsMsgQuickSearchDBView::OnHdrFlagsChanged(nsIMsgDBHdr *aHdrChanged, PRUint32 aOldFlags, </span>
<a href="#l62.59"></a><span id="l62.59">                                        PRUint32 aNewFlags, nsIDBChangeListener *aInstigator)</span>
<a href="#l62.60"></a><span id="l62.60"> {</span>
<a href="#l62.61"></a><span id="l62.61">   nsresult rv = nsMsgGroupView::OnHdrFlagsChanged(aHdrChanged, aOldFlags, aNewFlags, aInstigator);</span>
<a href="#l62.62"></a><span id="l62.62"> </span>
<a href="#l62.63"></a><span id="l62.63" class="difflineminus">-  if (m_viewFolder &amp;&amp; (aOldFlags &amp; nsMsgMessageFlags::Read) != (aNewFlags &amp; nsMsgMessageFlags::Read))</span>
<a href="#l62.64"></a><span id="l62.64" class="difflineplus">+  if (m_viewFolder &amp;&amp;</span>
<a href="#l62.65"></a><span id="l62.65" class="difflineplus">+      (m_viewFolder != m_folder) &amp;&amp;</span>
<a href="#l62.66"></a><span id="l62.66" class="difflineplus">+      (aOldFlags &amp; nsMsgMessageFlags::Read) != (aNewFlags &amp; nsMsgMessageFlags::Read))</span>
<a href="#l62.67"></a><span id="l62.67">   {</span>
<a href="#l62.68"></a><span id="l62.68">     // if we're displaying a single folder virtual folder for an imap folder,</span>
<a href="#l62.69"></a><span id="l62.69">     // the search criteria might be on message body, and we might not have the</span>
<a href="#l62.70"></a><span id="l62.70">     // message body offline, in which case we can't tell if the message </span>
<a href="#l62.71"></a><span id="l62.71">     // matched or not. But if the unread flag changed, we need to update the</span>
<a href="#l62.72"></a><span id="l62.72">     // unread counts. Normally, VirtualFolderChangeListener::OnHdrFlagsChanged will</span>
<a href="#l62.73"></a><span id="l62.73">     // handle this, but it won't work for body criteria when we don't have the</span>
<a href="#l62.74"></a><span id="l62.74">     // body offline.</span>
<a href="#l62.75"></a><span id="l62.75" class="difflineat">@@ -313,17 +328,20 @@ nsMsgQuickSearchDBView::OnSearchHit(nsIM</span>
<a href="#l62.76"></a><span id="l62.76">     return AddHdr(aMsgHdr); </span>
<a href="#l62.77"></a><span id="l62.77">   else</span>
<a href="#l62.78"></a><span id="l62.78">     return NS_OK;</span>
<a href="#l62.79"></a><span id="l62.79"> }</span>
<a href="#l62.80"></a><span id="l62.80"> </span>
<a href="#l62.81"></a><span id="l62.81"> NS_IMETHODIMP</span>
<a href="#l62.82"></a><span id="l62.82"> nsMsgQuickSearchDBView::OnSearchDone(nsresult status)</span>
<a href="#l62.83"></a><span id="l62.83"> {</span>
<a href="#l62.84"></a><span id="l62.84" class="difflineminus">-  if (m_viewFolder)</span>
<a href="#l62.85"></a><span id="l62.85" class="difflineplus">+  // We're a single-folder virtual folder if viewFolder != folder, and that is</span>
<a href="#l62.86"></a><span id="l62.86" class="difflineplus">+  // the only case in which we want to be messing about with a results cache</span>
<a href="#l62.87"></a><span id="l62.87" class="difflineplus">+  // or unread counts.</span>
<a href="#l62.88"></a><span id="l62.88" class="difflineplus">+  if (m_viewFolder &amp;&amp; m_viewFolder != m_folder)</span>
<a href="#l62.89"></a><span id="l62.89">   {</span>
<a href="#l62.90"></a><span id="l62.90">     nsTArray&lt;nsMsgKey&gt; keyArray;</span>
<a href="#l62.91"></a><span id="l62.91">     nsCString searchUri;</span>
<a href="#l62.92"></a><span id="l62.92">     m_viewFolder-&gt;GetURI(searchUri);</span>
<a href="#l62.93"></a><span id="l62.93">     PRUint32 count = m_hdrHits.Count();</span>
<a href="#l62.94"></a><span id="l62.94">     // build up message keys.</span>
<a href="#l62.95"></a><span id="l62.95">     PRUint32 i;</span>
<a href="#l62.96"></a><span id="l62.96">     for (i = 0; i &lt; count; i++)</span>
<a href="#l62.97"></a><span id="l62.97" class="difflineat">@@ -344,23 +362,41 @@ nsMsgQuickSearchDBView::OnSearchDone(nsr</span>
<a href="#l62.98"></a><span id="l62.98">       for (i = 0; i &lt; numBadHits; i++)</span>
<a href="#l62.99"></a><span id="l62.99">       {</span>
<a href="#l62.100"></a><span id="l62.100">         m_db-&gt;GetMsgHdrForKey(staleHits[i], getter_AddRefs(hdrDeleted));</span>
<a href="#l62.101"></a><span id="l62.101">         if (hdrDeleted)</span>
<a href="#l62.102"></a><span id="l62.102">           OnHdrDeleted(hdrDeleted, nsMsgKey_None, 0, this);</span>
<a href="#l62.103"></a><span id="l62.103">       }</span>
<a href="#l62.104"></a><span id="l62.104">       delete [] staleHits;</span>
<a href="#l62.105"></a><span id="l62.105">     }</span>
<a href="#l62.106"></a><span id="l62.106" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDatabase&gt; virtDatabase;</span>
<a href="#l62.107"></a><span id="l62.107" class="difflineplus">+    nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l62.108"></a><span id="l62.108" class="difflineplus">+    nsresult rv = m_viewFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(dbFolderInfo), getter_AddRefs(virtDatabase));</span>
<a href="#l62.109"></a><span id="l62.109" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l62.110"></a><span id="l62.110" class="difflineplus">+    PRUint32 numUnread = 0;</span>
<a href="#l62.111"></a><span id="l62.111" class="difflineplus">+    PRUint32 numTotal = m_origKeys.Length();</span>
<a href="#l62.112"></a><span id="l62.112" class="difflineplus">+</span>
<a href="#l62.113"></a><span id="l62.113" class="difflineplus">+    for (i = 0; i &lt; m_origKeys.Length(); i++)</span>
<a href="#l62.114"></a><span id="l62.114" class="difflineplus">+    {</span>
<a href="#l62.115"></a><span id="l62.115" class="difflineplus">+      PRBool isRead;</span>
<a href="#l62.116"></a><span id="l62.116" class="difflineplus">+      m_db-&gt;IsRead(m_origKeys[i], &amp;isRead);</span>
<a href="#l62.117"></a><span id="l62.117" class="difflineplus">+      if (!isRead)</span>
<a href="#l62.118"></a><span id="l62.118" class="difflineplus">+        numUnread++;</span>
<a href="#l62.119"></a><span id="l62.119" class="difflineplus">+    }</span>
<a href="#l62.120"></a><span id="l62.120" class="difflineplus">+    dbFolderInfo-&gt;SetNumUnreadMessages(numUnread);</span>
<a href="#l62.121"></a><span id="l62.121" class="difflineplus">+    dbFolderInfo-&gt;SetNumMessages(numTotal);</span>
<a href="#l62.122"></a><span id="l62.122" class="difflineplus">+    m_viewFolder-&gt;UpdateSummaryTotals(true); // force update from db.</span>
<a href="#l62.123"></a><span id="l62.123" class="difflineplus">+    virtDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l62.124"></a><span id="l62.124">   }</span>
<a href="#l62.125"></a><span id="l62.125">   if (m_sortType != nsMsgViewSortType::byThread)//we do not find levels for the results.</span>
<a href="#l62.126"></a><span id="l62.126">   {</span>
<a href="#l62.127"></a><span id="l62.127">     m_sortValid = PR_FALSE;       //sort the results </span>
<a href="#l62.128"></a><span id="l62.128">     Sort(m_sortType, m_sortOrder);</span>
<a href="#l62.129"></a><span id="l62.129">   }</span>
<a href="#l62.130"></a><span id="l62.130" class="difflineminus">-  if (m_viewFolder)</span>
<a href="#l62.131"></a><span id="l62.131" class="difflineplus">+  if (m_viewFolder &amp;&amp; (m_viewFolder != m_folder))</span>
<a href="#l62.132"></a><span id="l62.132">     SetMRUTimeForFolder(m_viewFolder);</span>
<a href="#l62.133"></a><span id="l62.133"> </span>
<a href="#l62.134"></a><span id="l62.134">   return NS_OK;</span>
<a href="#l62.135"></a><span id="l62.135"> }</span>
<a href="#l62.136"></a><span id="l62.136"> </span>
<a href="#l62.137"></a><span id="l62.137"> </span>
<a href="#l62.138"></a><span id="l62.138"> NS_IMETHODIMP</span>
<a href="#l62.139"></a><span id="l62.139"> nsMsgQuickSearchDBView::OnNewSearch()</span>
<a href="#l62.140"></a><span id="l62.140" class="difflineat">@@ -832,8 +868,31 @@ NS_IMETHODIMP nsMsgQuickSearchDBView::Se</span>
<a href="#l62.141"></a><span id="l62.141">   return rv;</span>
<a href="#l62.142"></a><span id="l62.142"> }</span>
<a href="#l62.143"></a><span id="l62.143"> </span>
<a href="#l62.144"></a><span id="l62.144"> nsresult </span>
<a href="#l62.145"></a><span id="l62.145"> nsMsgQuickSearchDBView::GetMessageEnumerator(nsISimpleEnumerator **enumerator)</span>
<a href="#l62.146"></a><span id="l62.146"> {</span>
<a href="#l62.147"></a><span id="l62.147">   return GetViewEnumerator(enumerator);</span>
<a href="#l62.148"></a><span id="l62.148"> }</span>
<a href="#l62.149"></a><span id="l62.149" class="difflineplus">+</span>
<a href="#l62.150"></a><span id="l62.150" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l62.151"></a><span id="l62.151" class="difflineplus">+nsMsgQuickSearchDBView::OnHdrDeleted(nsIMsgDBHdr *aHdrDeleted,</span>
<a href="#l62.152"></a><span id="l62.152" class="difflineplus">+                                     nsMsgKey aParentKey,</span>
<a href="#l62.153"></a><span id="l62.153" class="difflineplus">+                                     PRInt32 aFlags,</span>
<a href="#l62.154"></a><span id="l62.154" class="difflineplus">+                                     nsIDBChangeListener *aInstigator)</span>
<a href="#l62.155"></a><span id="l62.155" class="difflineplus">+{</span>
<a href="#l62.156"></a><span id="l62.156" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aHdrDeleted);</span>
<a href="#l62.157"></a><span id="l62.157" class="difflineplus">+  nsMsgKey msgKey;</span>
<a href="#l62.158"></a><span id="l62.158" class="difflineplus">+  aHdrDeleted-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l62.159"></a><span id="l62.159" class="difflineplus">+  PRInt32 keyIndex = m_origKeys.BinaryIndexOf(msgKey);</span>
<a href="#l62.160"></a><span id="l62.160" class="difflineplus">+  if (keyIndex != -1)</span>
<a href="#l62.161"></a><span id="l62.161" class="difflineplus">+    m_origKeys.RemoveElementAt(keyIndex);</span>
<a href="#l62.162"></a><span id="l62.162" class="difflineplus">+  return nsMsgThreadedDBView::OnHdrDeleted(aHdrDeleted, aParentKey, aFlags,</span>
<a href="#l62.163"></a><span id="l62.163" class="difflineplus">+                                           aInstigator);</span>
<a href="#l62.164"></a><span id="l62.164" class="difflineplus">+}</span>
<a href="#l62.165"></a><span id="l62.165" class="difflineplus">+</span>
<a href="#l62.166"></a><span id="l62.166" class="difflineplus">+NS_IMETHODIMP nsMsgQuickSearchDBView::GetNumMsgsInView(PRInt32 *aNumMsgs)</span>
<a href="#l62.167"></a><span id="l62.167" class="difflineplus">+{</span>
<a href="#l62.168"></a><span id="l62.168" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aNumMsgs);</span>
<a href="#l62.169"></a><span id="l62.169" class="difflineplus">+  *aNumMsgs = m_origKeys.Length();</span>
<a href="#l62.170"></a><span id="l62.170" class="difflineplus">+  return NS_OK;</span>
<a href="#l62.171"></a><span id="l62.171" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1" class="difflineminus">--- a/mailnews/base/src/nsMsgQuickSearchDBView.h</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgQuickSearchDBView.h</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineat">@@ -63,25 +63,32 @@ public:</span>
<a href="#l63.4"></a><span id="l63.4">                           nsMsgViewSortTypeValue aSortType, </span>
<a href="#l63.5"></a><span id="l63.5">                           nsMsgViewSortOrderValue aSortOrder, </span>
<a href="#l63.6"></a><span id="l63.6">                           nsMsgViewFlagsTypeValue aViewFlags, </span>
<a href="#l63.7"></a><span id="l63.7">                           PRInt32 *aCount);</span>
<a href="#l63.8"></a><span id="l63.8">   NS_IMETHOD CloneDBView(nsIMessenger *aMessengerInstance,</span>
<a href="#l63.9"></a><span id="l63.9">                          nsIMsgWindow *aMsgWindow,</span>
<a href="#l63.10"></a><span id="l63.10">                          nsIMsgDBViewCommandUpdater *aCommandUpdater,</span>
<a href="#l63.11"></a><span id="l63.11">                          nsIMsgDBView **_retval);</span>
<a href="#l63.12"></a><span id="l63.12" class="difflineplus">+  NS_IMETHOD CopyDBView(nsMsgDBView *aNewMsgDBView,</span>
<a href="#l63.13"></a><span id="l63.13" class="difflineplus">+                        nsIMessenger *aMessengerInstance,</span>
<a href="#l63.14"></a><span id="l63.14" class="difflineplus">+                        nsIMsgWindow *aMsgWindow,</span>
<a href="#l63.15"></a><span id="l63.15" class="difflineplus">+                        nsIMsgDBViewCommandUpdater *aCmdUpdater);</span>
<a href="#l63.16"></a><span id="l63.16">   NS_IMETHOD DoCommand(nsMsgViewCommandTypeValue aCommand);</span>
<a href="#l63.17"></a><span id="l63.17">   NS_IMETHOD GetViewType(nsMsgViewTypeValue *aViewType);</span>
<a href="#l63.18"></a><span id="l63.18">   NS_IMETHOD SetViewFlags(nsMsgViewFlagsTypeValue aViewFlags);</span>
<a href="#l63.19"></a><span id="l63.19">   NS_IMETHOD SetSearchSession(nsIMsgSearchSession *aSearchSession);</span>
<a href="#l63.20"></a><span id="l63.20">   NS_IMETHOD GetSearchSession(nsIMsgSearchSession* *aSearchSession);</span>
<a href="#l63.21"></a><span id="l63.21">   NS_IMETHOD OnHdrFlagsChanged(nsIMsgDBHdr *aHdrChanged, PRUint32 aOldFlags, </span>
<a href="#l63.22"></a><span id="l63.22">                          PRUint32 aNewFlags, nsIDBChangeListener *aInstigator);</span>
<a href="#l63.23"></a><span id="l63.23">   NS_IMETHOD OnHdrPropertyChanged(nsIMsgDBHdr *aHdrToChange, PRBool aPreChange, PRUint32 *aStatus, </span>
<a href="#l63.24"></a><span id="l63.24">                                  nsIDBChangeListener * aInstigator);</span>
<a href="#l63.25"></a><span id="l63.25" class="difflineplus">+  NS_IMETHOD OnHdrDeleted(nsIMsgDBHdr *aHdrDeleted, nsMsgKey aParentKey,</span>
<a href="#l63.26"></a><span id="l63.26" class="difflineplus">+                          PRInt32 aFlags, nsIDBChangeListener *aInstigator);</span>
<a href="#l63.27"></a><span id="l63.27" class="difflineplus">+  NS_IMETHOD GetNumMsgsInView(PRInt32 *aNumMsgs);</span>
<a href="#l63.28"></a><span id="l63.28"> </span>
<a href="#l63.29"></a><span id="l63.29"> protected:</span>
<a href="#l63.30"></a><span id="l63.30">   nsWeakPtr m_searchSession;</span>
<a href="#l63.31"></a><span id="l63.31">   nsTArray&lt;nsMsgKey&gt; m_origKeys;</span>
<a href="#l63.32"></a><span id="l63.32">   PRBool    m_usingCachedHits;</span>
<a href="#l63.33"></a><span id="l63.33">   PRBool    m_cacheEmpty;</span>
<a href="#l63.34"></a><span id="l63.34">   nsCOMArray &lt;nsIMsgDBHdr&gt; m_hdrHits;</span>
<a href="#l63.35"></a><span id="l63.35">   virtual nsresult AddHdr(nsIMsgDBHdr *msgHdr, nsMsgViewIndex *resultIndex = nsnull);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1" class="difflineminus">--- a/mailnews/base/src/nsMsgSearchDBView.cpp</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgSearchDBView.cpp</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineat">@@ -1433,17 +1433,17 @@ nsresult nsMsgSearchDBView::GetThreadCon</span>
<a href="#l64.4"></a><span id="l64.4"> </span>
<a href="#l64.5"></a><span id="l64.5">   // if not threaded, use the real thread. </span>
<a href="#l64.6"></a><span id="l64.6">   nsCOMPtr&lt;nsIMsgDatabase&gt; msgDB;</span>
<a href="#l64.7"></a><span id="l64.7">   nsresult rv = GetDBForHeader(msgHdr, getter_AddRefs(msgDB));</span>
<a href="#l64.8"></a><span id="l64.8">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l64.9"></a><span id="l64.9">   return msgDB-&gt;GetThreadContainingMsgHdr(msgHdr, pThread);</span>
<a href="#l64.10"></a><span id="l64.10"> }</span>
<a href="#l64.11"></a><span id="l64.11"> </span>
<a href="#l64.12"></a><span id="l64.12" class="difflineminus">-nsresult </span>
<a href="#l64.13"></a><span id="l64.13" class="difflineplus">+nsresult</span>
<a href="#l64.14"></a><span id="l64.14"> nsMsgSearchDBView::ListIdsInThread(nsIMsgThread *threadHdr, </span>
<a href="#l64.15"></a><span id="l64.15">                                    nsMsgViewIndex startOfThreadViewIndex, </span>
<a href="#l64.16"></a><span id="l64.16">                                    PRUint32 *pNumListed)</span>
<a href="#l64.17"></a><span id="l64.17"> {</span>
<a href="#l64.18"></a><span id="l64.18">   NS_ENSURE_ARG(threadHdr);</span>
<a href="#l64.19"></a><span id="l64.19">   // these children ids should be in thread order.</span>
<a href="#l64.20"></a><span id="l64.20">   PRUint32 i;</span>
<a href="#l64.21"></a><span id="l64.21">   nsMsgViewIndex viewIndex = startOfThreadViewIndex + 1;</span>
<a href="#l64.22"></a><span id="l64.22" class="difflineat">@@ -1481,8 +1481,15 @@ nsMsgSearchDBView::ListIdsInThread(nsIMs</span>
<a href="#l64.23"></a><span id="l64.23">                   level);</span>
<a href="#l64.24"></a><span id="l64.24">       (*pNumListed)++;</span>
<a href="#l64.25"></a><span id="l64.25">       viewIndex++;</span>
<a href="#l64.26"></a><span id="l64.26">     }</span>
<a href="#l64.27"></a><span id="l64.27">   }</span>
<a href="#l64.28"></a><span id="l64.28">   return NS_OK;</span>
<a href="#l64.29"></a><span id="l64.29"> }</span>
<a href="#l64.30"></a><span id="l64.30"> </span>
<a href="#l64.31"></a><span id="l64.31" class="difflineplus">+NS_IMETHODIMP nsMsgSearchDBView::GetNumMsgsInView(PRInt32 *aNumMsgs)</span>
<a href="#l64.32"></a><span id="l64.32" class="difflineplus">+{</span>
<a href="#l64.33"></a><span id="l64.33" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aNumMsgs);</span>
<a href="#l64.34"></a><span id="l64.34" class="difflineplus">+  *aNumMsgs = m_hdrsTable.Count();</span>
<a href="#l64.35"></a><span id="l64.35" class="difflineplus">+  return NS_OK;</span>
<a href="#l64.36"></a><span id="l64.36" class="difflineplus">+}</span>
<a href="#l64.37"></a><span id="l64.37" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1" class="difflineminus">--- a/mailnews/base/src/nsMsgSearchDBView.h</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgSearchDBView.h</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineat">@@ -80,16 +80,17 @@ public:</span>
<a href="#l65.4"></a><span id="l65.4">                           nsMsgViewSortTypeValue aSortType,</span>
<a href="#l65.5"></a><span id="l65.5">                           nsMsgViewSortOrderValue aSortOrder, </span>
<a href="#l65.6"></a><span id="l65.6">                           nsMsgViewFlagsTypeValue aViewFlags,</span>
<a href="#l65.7"></a><span id="l65.7">                           PRInt32 *aCount);</span>
<a href="#l65.8"></a><span id="l65.8">   NS_IMETHOD OnHdrDeleted(nsIMsgDBHdr *aHdrDeleted, nsMsgKey aParentKey, </span>
<a href="#l65.9"></a><span id="l65.9">                           PRInt32 aFlags, nsIDBChangeListener *aInstigator);</span>
<a href="#l65.10"></a><span id="l65.10">   NS_IMETHOD OnHdrFlagsChanged(nsIMsgDBHdr *aHdrChanged, PRUint32 aOldFlags,</span>
<a href="#l65.11"></a><span id="l65.11">                                PRUint32 aNewFlags, nsIDBChangeListener *aInstigator);</span>
<a href="#l65.12"></a><span id="l65.12" class="difflineplus">+  NS_IMETHODIMP GetNumMsgsInView(PRInt32 *aNumMsgs);</span>
<a href="#l65.13"></a><span id="l65.13">   // override to get location</span>
<a href="#l65.14"></a><span id="l65.14">   NS_IMETHOD GetCellText(PRInt32 aRow, nsITreeColumn* aCol, nsAString&amp; aValue);</span>
<a href="#l65.15"></a><span id="l65.15">   virtual nsresult GetMsgHdrForViewIndex(nsMsgViewIndex index, nsIMsgDBHdr **msgHdr);</span>
<a href="#l65.16"></a><span id="l65.16">   virtual nsresult OnNewHeader(nsIMsgDBHdr *newHdr, nsMsgKey parentKey, PRBool ensureListed);</span>
<a href="#l65.17"></a><span id="l65.17">   NS_IMETHOD GetFolderForViewIndex(nsMsgViewIndex index, nsIMsgFolder **folder);</span>
<a href="#l65.18"></a><span id="l65.18"> </span>
<a href="#l65.19"></a><span id="l65.19">   NS_IMETHOD OnAnnouncerGoingAway(nsIDBChangeAnnouncer *instigator);</span>
<a href="#l65.20"></a><span id="l65.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1" class="difflineminus">--- a/mailnews/base/src/nsMsgSpecialViews.cpp</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgSpecialViews.cpp</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineat">@@ -52,17 +52,17 @@ NS_IMETHODIMP nsMsgThreadsWithUnreadDBVi</span>
<a href="#l66.4"></a><span id="l66.4"> {</span>
<a href="#l66.5"></a><span id="l66.5">     NS_ENSURE_ARG_POINTER(aViewType);</span>
<a href="#l66.6"></a><span id="l66.6">     *aViewType = nsMsgViewType::eShowThreadsWithUnread;</span>
<a href="#l66.7"></a><span id="l66.7">     return NS_OK;</span>
<a href="#l66.8"></a><span id="l66.8"> }</span>
<a href="#l66.9"></a><span id="l66.9"> </span>
<a href="#l66.10"></a><span id="l66.10"> PRBool nsMsgThreadsWithUnreadDBView::WantsThisThread(nsIMsgThread *threadHdr)</span>
<a href="#l66.11"></a><span id="l66.11"> {</span>
<a href="#l66.12"></a><span id="l66.12" class="difflineminus">-	if (threadHdr)</span>
<a href="#l66.13"></a><span id="l66.13" class="difflineplus">+  if (threadHdr)</span>
<a href="#l66.14"></a><span id="l66.14">   {</span>
<a href="#l66.15"></a><span id="l66.15">     PRUint32 numNewChildren;</span>
<a href="#l66.16"></a><span id="l66.16"> </span>
<a href="#l66.17"></a><span id="l66.17">     threadHdr-&gt;GetNumUnreadChildren(&amp;numNewChildren);</span>
<a href="#l66.18"></a><span id="l66.18">     if (numNewChildren &gt; 0) </span>
<a href="#l66.19"></a><span id="l66.19">       return PR_TRUE;</span>
<a href="#l66.20"></a><span id="l66.20">   }</span>
<a href="#l66.21"></a><span id="l66.21">   return PR_FALSE;</span>
<a href="#l66.22"></a><span id="l66.22" class="difflineat">@@ -104,16 +104,21 @@ nsMsgThreadsWithUnreadDBView::CloneDBVie</span>
<a href="#l66.23"></a><span id="l66.23"> </span>
<a href="#l66.24"></a><span id="l66.24">   nsresult rv = CopyDBView(newMsgDBView, aMessengerInstance, aMsgWindow, aCmdUpdater);</span>
<a href="#l66.25"></a><span id="l66.25">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l66.26"></a><span id="l66.26"> </span>
<a href="#l66.27"></a><span id="l66.27">   NS_IF_ADDREF(*_retval = newMsgDBView);</span>
<a href="#l66.28"></a><span id="l66.28">   return NS_OK;</span>
<a href="#l66.29"></a><span id="l66.29"> }</span>
<a href="#l66.30"></a><span id="l66.30"> </span>
<a href="#l66.31"></a><span id="l66.31" class="difflineplus">+NS_IMETHODIMP nsMsgThreadsWithUnreadDBView::GetNumMsgsInView(PRInt32 *aNumMsgs)</span>
<a href="#l66.32"></a><span id="l66.32" class="difflineplus">+{</span>
<a href="#l66.33"></a><span id="l66.33" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l66.34"></a><span id="l66.34" class="difflineplus">+}</span>
<a href="#l66.35"></a><span id="l66.35" class="difflineplus">+</span>
<a href="#l66.36"></a><span id="l66.36"> NS_IMETHODIMP nsMsgWatchedThreadsWithUnreadDBView::GetViewType(nsMsgViewTypeValue *aViewType)</span>
<a href="#l66.37"></a><span id="l66.37"> {</span>
<a href="#l66.38"></a><span id="l66.38">     NS_ENSURE_ARG_POINTER(aViewType);</span>
<a href="#l66.39"></a><span id="l66.39">     *aViewType = nsMsgViewType::eShowWatchedThreadsWithUnread;</span>
<a href="#l66.40"></a><span id="l66.40">     return NS_OK;</span>
<a href="#l66.41"></a><span id="l66.41"> }</span>
<a href="#l66.42"></a><span id="l66.42"> </span>
<a href="#l66.43"></a><span id="l66.43"> PRBool nsMsgWatchedThreadsWithUnreadDBView::WantsThisThread(nsIMsgThread *threadHdr)</span>
<a href="#l66.44"></a><span id="l66.44" class="difflineat">@@ -170,8 +175,14 @@ nsMsgWatchedThreadsWithUnreadDBView::Clo</span>
<a href="#l66.45"></a><span id="l66.45">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l66.46"></a><span id="l66.46"> </span>
<a href="#l66.47"></a><span id="l66.47">   nsresult rv = CopyDBView(newMsgDBView, aMessengerInstance, aMsgWindow, aCmdUpdater);</span>
<a href="#l66.48"></a><span id="l66.48">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l66.49"></a><span id="l66.49"> </span>
<a href="#l66.50"></a><span id="l66.50">   NS_IF_ADDREF(*_retval = newMsgDBView);</span>
<a href="#l66.51"></a><span id="l66.51">   return NS_OK;</span>
<a href="#l66.52"></a><span id="l66.52"> }</span>
<a href="#l66.53"></a><span id="l66.53" class="difflineplus">+</span>
<a href="#l66.54"></a><span id="l66.54" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l66.55"></a><span id="l66.55" class="difflineplus">+nsMsgWatchedThreadsWithUnreadDBView::GetNumMsgsInView(PRInt32 *aNumMsgs)</span>
<a href="#l66.56"></a><span id="l66.56" class="difflineplus">+{</span>
<a href="#l66.57"></a><span id="l66.57" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l66.58"></a><span id="l66.58" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1" class="difflineminus">--- a/mailnews/base/src/nsMsgSpecialViews.h</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgSpecialViews.h</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineat">@@ -38,35 +38,37 @@</span>
<a href="#l67.4"></a><span id="l67.4"> #ifndef _nsMsgSpecialViews_H_</span>
<a href="#l67.5"></a><span id="l67.5"> #define _nsMsgSpecialViews_H_</span>
<a href="#l67.6"></a><span id="l67.6"> </span>
<a href="#l67.7"></a><span id="l67.7"> #include &quot;nsMsgThreadedDBView.h&quot;</span>
<a href="#l67.8"></a><span id="l67.8"> </span>
<a href="#l67.9"></a><span id="l67.9"> class nsMsgThreadsWithUnreadDBView : public nsMsgThreadedDBView</span>
<a href="#l67.10"></a><span id="l67.10"> {</span>
<a href="#l67.11"></a><span id="l67.11"> public:</span>
<a href="#l67.12"></a><span id="l67.12" class="difflineminus">-	nsMsgThreadsWithUnreadDBView();</span>
<a href="#l67.13"></a><span id="l67.13" class="difflineminus">-	virtual ~nsMsgThreadsWithUnreadDBView();</span>
<a href="#l67.14"></a><span id="l67.14" class="difflineminus">-	virtual const char * GetViewName(void) {return &quot;ThreadsWithUnreadView&quot;; }</span>
<a href="#l67.15"></a><span id="l67.15" class="difflineminus">-    NS_IMETHOD CloneDBView(nsIMessenger *aMessengerInstance, nsIMsgWindow *aMsgWindow, nsIMsgDBViewCommandUpdater *aCommandUpdater, nsIMsgDBView **_retval);</span>
<a href="#l67.16"></a><span id="l67.16" class="difflineminus">-    NS_IMETHOD GetViewType(nsMsgViewTypeValue *aViewType);</span>
<a href="#l67.17"></a><span id="l67.17" class="difflineplus">+  nsMsgThreadsWithUnreadDBView();</span>
<a href="#l67.18"></a><span id="l67.18" class="difflineplus">+  virtual ~nsMsgThreadsWithUnreadDBView();</span>
<a href="#l67.19"></a><span id="l67.19" class="difflineplus">+  virtual const char * GetViewName(void) {return &quot;ThreadsWithUnreadView&quot;; }</span>
<a href="#l67.20"></a><span id="l67.20" class="difflineplus">+  NS_IMETHOD CloneDBView(nsIMessenger *aMessengerInstance, nsIMsgWindow *aMsgWindow, nsIMsgDBViewCommandUpdater *aCommandUpdater, nsIMsgDBView **_retval);</span>
<a href="#l67.21"></a><span id="l67.21" class="difflineplus">+  NS_IMETHOD GetViewType(nsMsgViewTypeValue *aViewType);</span>
<a href="#l67.22"></a><span id="l67.22" class="difflineplus">+  NS_IMETHOD GetNumMsgsInView(PRInt32 *aNumMsgs);</span>
<a href="#l67.23"></a><span id="l67.23"> </span>
<a href="#l67.24"></a><span id="l67.24" class="difflineminus">-	virtual PRBool		WantsThisThread(nsIMsgThread *threadHdr);</span>
<a href="#l67.25"></a><span id="l67.25" class="difflineplus">+virtual PRBool WantsThisThread(nsIMsgThread *threadHdr);</span>
<a href="#l67.26"></a><span id="l67.26"> protected:</span>
<a href="#l67.27"></a><span id="l67.27">   virtual nsresult AddMsgToThreadNotInView(nsIMsgThread *threadHdr, nsIMsgDBHdr *msgHdr, PRBool ensureListed);</span>
<a href="#l67.28"></a><span id="l67.28"> </span>
<a href="#l67.29"></a><span id="l67.29"> };</span>
<a href="#l67.30"></a><span id="l67.30"> </span>
<a href="#l67.31"></a><span id="l67.31"> class nsMsgWatchedThreadsWithUnreadDBView : public nsMsgThreadedDBView</span>
<a href="#l67.32"></a><span id="l67.32"> {</span>
<a href="#l67.33"></a><span id="l67.33"> public:</span>
<a href="#l67.34"></a><span id="l67.34" class="difflineminus">-    NS_IMETHOD GetViewType(nsMsgViewTypeValue *aViewType);</span>
<a href="#l67.35"></a><span id="l67.35" class="difflineminus">-    NS_IMETHOD CloneDBView(nsIMessenger *aMessengerInstance, nsIMsgWindow *aMsgWindow, nsIMsgDBViewCommandUpdater *aCommandUpdater, nsIMsgDBView **_retval);</span>
<a href="#l67.36"></a><span id="l67.36" class="difflineminus">-	virtual const char * GetViewName(void) {return &quot;WatchedThreadsWithUnreadView&quot;; }</span>
<a href="#l67.37"></a><span id="l67.37" class="difflineminus">-	virtual PRBool		WantsThisThread(nsIMsgThread *threadHdr);</span>
<a href="#l67.38"></a><span id="l67.38" class="difflineplus">+  NS_IMETHOD GetViewType(nsMsgViewTypeValue *aViewType);</span>
<a href="#l67.39"></a><span id="l67.39" class="difflineplus">+  NS_IMETHOD CloneDBView(nsIMessenger *aMessengerInstance, nsIMsgWindow *aMsgWindow, nsIMsgDBViewCommandUpdater *aCommandUpdater, nsIMsgDBView **_retval);</span>
<a href="#l67.40"></a><span id="l67.40" class="difflineplus">+  NS_IMETHOD GetNumMsgsInView(PRInt32 *aNumMsgs);</span>
<a href="#l67.41"></a><span id="l67.41" class="difflineplus">+  virtual const char * GetViewName(void) {return &quot;WatchedThreadsWithUnreadView&quot;; }</span>
<a href="#l67.42"></a><span id="l67.42" class="difflineplus">+  virtual PRBool WantsThisThread(nsIMsgThread *threadHdr);</span>
<a href="#l67.43"></a><span id="l67.43"> protected:</span>
<a href="#l67.44"></a><span id="l67.44">   virtual nsresult AddMsgToThreadNotInView(nsIMsgThread *threadHdr, nsIMsgDBHdr *msgHdr, PRBool ensureListed);</span>
<a href="#l67.45"></a><span id="l67.45"> </span>
<a href="#l67.46"></a><span id="l67.46"> };</span>
<a href="#l67.47"></a><span id="l67.47"> #ifdef DOING_CACHELESS_VIEW</span>
<a href="#l67.48"></a><span id="l67.48"> // This view will initially be used for cacheless IMAP.</span>
<a href="#l67.49"></a><span id="l67.49"> class nsMsgCachelessView : public nsMsgDBView</span>
<a href="#l67.50"></a><span id="l67.50"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l68.1"></a><span id="l68.1" class="difflineminus">--- a/mailnews/base/util/errUtils.js</span>
<a href="#l68.2"></a><span id="l68.2" class="difflineplus">+++ b/mailnews/base/util/errUtils.js</span>
<a href="#l68.3"></a><span id="l68.3" class="difflineat">@@ -35,17 +35,18 @@</span>
<a href="#l68.4"></a><span id="l68.4">  *</span>
<a href="#l68.5"></a><span id="l68.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l68.6"></a><span id="l68.6"> </span>
<a href="#l68.7"></a><span id="l68.7"> /**</span>
<a href="#l68.8"></a><span id="l68.8">  * This file contains helper methods for debugging -- things like logging</span>
<a href="#l68.9"></a><span id="l68.9">  * exception objects, dumping DOM nodes, Events, and generic object dumps.</span>
<a href="#l68.10"></a><span id="l68.10">  */</span>
<a href="#l68.11"></a><span id="l68.11"> </span>
<a href="#l68.12"></a><span id="l68.12" class="difflineminus">-const EXPORTED_SYMBOLS = [&quot;logObject&quot;, &quot;logException&quot;, &quot;logElement&quot;, &quot;logEvent&quot;];</span>
<a href="#l68.13"></a><span id="l68.13" class="difflineplus">+const EXPORTED_SYMBOLS = [&quot;logObject&quot;, &quot;logException&quot;, &quot;logElement&quot;, &quot;logEvent&quot;,</span>
<a href="#l68.14"></a><span id="l68.14" class="difflineplus">+                          &quot;errorWithDebug&quot;];</span>
<a href="#l68.15"></a><span id="l68.15"> </span>
<a href="#l68.16"></a><span id="l68.16"> /**</span>
<a href="#l68.17"></a><span id="l68.17">  * Report on an object to stdout.</span>
<a href="#l68.18"></a><span id="l68.18">  * @param aObj  the object to be dumped</span>
<a href="#l68.19"></a><span id="l68.19">  * @param aName the name of the object, for informational purposes</span>
<a href="#l68.20"></a><span id="l68.20">  */</span>
<a href="#l68.21"></a><span id="l68.21"> function logObject(aObj, aName) {</span>
<a href="#l68.22"></a><span id="l68.22">   dump(&quot;Dumping Object: &quot; + aName + &quot;\n&quot;);</span>
<a href="#l68.23"></a><span id="l68.23" class="difflineat">@@ -76,16 +77,34 @@ function logElement(aElement) {</span>
<a href="#l68.24"></a><span id="l68.24"> /**</span>
<a href="#l68.25"></a><span id="l68.25">  * Log an DOM event to stdout.</span>
<a href="#l68.26"></a><span id="l68.26">  * @param aEvent the DOM event object to dump</span>
<a href="#l68.27"></a><span id="l68.27">  */</span>
<a href="#l68.28"></a><span id="l68.28"> function logEvent(aEvent) {</span>
<a href="#l68.29"></a><span id="l68.29">   stringifier.dumpEvent(aEvent);</span>
<a href="#l68.30"></a><span id="l68.30"> }</span>
<a href="#l68.31"></a><span id="l68.31"> </span>
<a href="#l68.32"></a><span id="l68.32" class="difflineplus">+/**</span>
<a href="#l68.33"></a><span id="l68.33" class="difflineplus">+ * Dump the current stack and return an Error suitable for throwing.  We return</span>
<a href="#l68.34"></a><span id="l68.34" class="difflineplus">+ *  the new Error so that your code can use a &quot;throw&quot; statement which makes it</span>
<a href="#l68.35"></a><span id="l68.35" class="difflineplus">+ *  obvious to syntactic analysis that there is an exit occuring at that point.</span>
<a href="#l68.36"></a><span id="l68.36" class="difflineplus">+ *</span>
<a href="#l68.37"></a><span id="l68.37" class="difflineplus">+ * Example:</span>
<a href="#l68.38"></a><span id="l68.38" class="difflineplus">+ *   throw errorWithDebug(&quot;I did not expect this!&quot;);</span>
<a href="#l68.39"></a><span id="l68.39" class="difflineplus">+ *</span>
<a href="#l68.40"></a><span id="l68.40" class="difflineplus">+ * @param aString The message payload for the exception.</span>
<a href="#l68.41"></a><span id="l68.41" class="difflineplus">+ */</span>
<a href="#l68.42"></a><span id="l68.42" class="difflineplus">+function errorWithDebug(aString) {</span>
<a href="#l68.43"></a><span id="l68.43" class="difflineplus">+  dump(&quot;PROBLEM: &quot; + aString + &quot;\n&quot;);</span>
<a href="#l68.44"></a><span id="l68.44" class="difflineplus">+  dump(&quot;CURRENT STACK (and throwing):\n&quot;);</span>
<a href="#l68.45"></a><span id="l68.45" class="difflineplus">+  // skip this frame.</span>
<a href="#l68.46"></a><span id="l68.46" class="difflineplus">+  dump(stringifier.getStack(1));</span>
<a href="#l68.47"></a><span id="l68.47" class="difflineplus">+  return new Error(aString);</span>
<a href="#l68.48"></a><span id="l68.48" class="difflineplus">+}</span>
<a href="#l68.49"></a><span id="l68.49" class="difflineplus">+</span>
<a href="#l68.50"></a><span id="l68.50"> function Stringifier() {};</span>
<a href="#l68.51"></a><span id="l68.51"> </span>
<a href="#l68.52"></a><span id="l68.52"> Stringifier.prototype = {</span>
<a href="#l68.53"></a><span id="l68.53">   dumpObj: function (o, name) {</span>
<a href="#l68.54"></a><span id="l68.54">     this._reset();</span>
<a href="#l68.55"></a><span id="l68.55">     this._append(this.objectTreeAsString(o, true, true, 0));</span>
<a href="#l68.56"></a><span id="l68.56">     dump(this._asString());</span>
<a href="#l68.57"></a><span id="l68.57">   },</span>
<a href="#l68.58"></a><span id="l68.58" class="difflineat">@@ -307,11 +326,11 @@ Stringifier.prototype = {</span>
<a href="#l68.59"></a><span id="l68.59">                 ];</span>
<a href="#l68.60"></a><span id="l68.60">     for (let i in names) {</span>
<a href="#l68.61"></a><span id="l68.61">       if (names[i] in event)</span>
<a href="#l68.62"></a><span id="l68.62">         this._append(names[i] + &quot;: &quot; + event[names[i]] + &quot;\n&quot;);</span>
<a href="#l68.63"></a><span id="l68.63">     }</span>
<a href="#l68.64"></a><span id="l68.64">     this._append(&quot;-------------------------------------\n&quot;);</span>
<a href="#l68.65"></a><span id="l68.65">     return this._asString();</span>
<a href="#l68.66"></a><span id="l68.66">   }</span>
<a href="#l68.67"></a><span id="l68.67" class="difflineminus">-}</span>
<a href="#l68.68"></a><span id="l68.68" class="difflineplus">+};</span>
<a href="#l68.69"></a><span id="l68.69"> </span>
<a href="#l68.70"></a><span id="l68.70"> var stringifier = new Stringifier();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l69.1"></a><span id="l69.1" class="difflineminus">--- a/mailnews/db/gloda/components/glautocomp.js</span>
<a href="#l69.2"></a><span id="l69.2" class="difflineplus">+++ b/mailnews/db/gloda/components/glautocomp.js</span>
<a href="#l69.3"></a><span id="l69.3" class="difflineat">@@ -94,45 +94,54 @@ ResultRowMulti.prototype = {</span>
<a href="#l69.4"></a><span id="l69.4">     }</span>
<a href="#l69.5"></a><span id="l69.5">   },</span>
<a href="#l69.6"></a><span id="l69.6">   onItemsModified: function(aItems) {</span>
<a href="#l69.7"></a><span id="l69.7">   },</span>
<a href="#l69.8"></a><span id="l69.8">   onItemsRemoved: function(aItems) {</span>
<a href="#l69.9"></a><span id="l69.9">   },</span>
<a href="#l69.10"></a><span id="l69.10">   onQueryCompleted: function() {</span>
<a href="#l69.11"></a><span id="l69.11">   }</span>
<a href="#l69.12"></a><span id="l69.12" class="difflineminus">-}</span>
<a href="#l69.13"></a><span id="l69.13" class="difflineplus">+};</span>
<a href="#l69.14"></a><span id="l69.14"> </span>
<a href="#l69.15"></a><span id="l69.15"> function nsAutoCompleteGlodaResult(aListener, aCompleter, aString) {</span>
<a href="#l69.16"></a><span id="l69.16">   this.listener = aListener;</span>
<a href="#l69.17"></a><span id="l69.17">   this.completer = aCompleter;</span>
<a href="#l69.18"></a><span id="l69.18">   this.searchString = aString;</span>
<a href="#l69.19"></a><span id="l69.19">   this._results = [];</span>
<a href="#l69.20"></a><span id="l69.20">   this._pendingCount = 0;</span>
<a href="#l69.21"></a><span id="l69.21">   this._problem = false;</span>
<a href="#l69.22"></a><span id="l69.22" class="difflineplus">+  // Track whether we have reported anything to the complete controller so</span>
<a href="#l69.23"></a><span id="l69.23" class="difflineplus">+  //  that we know not to send notifications to it during calls to addRows</span>
<a href="#l69.24"></a><span id="l69.24" class="difflineplus">+  //  prior to that point.</span>
<a href="#l69.25"></a><span id="l69.25" class="difflineplus">+  this._initiallyReported = false;</span>
<a href="#l69.26"></a><span id="l69.26"> </span>
<a href="#l69.27"></a><span id="l69.27">   this.wrappedJSObject = this;</span>
<a href="#l69.28"></a><span id="l69.28"> }</span>
<a href="#l69.29"></a><span id="l69.29"> nsAutoCompleteGlodaResult.prototype = {</span>
<a href="#l69.30"></a><span id="l69.30">   getObjectAt: function(aIndex) {</span>
<a href="#l69.31"></a><span id="l69.31">     return this._results[aIndex];</span>
<a href="#l69.32"></a><span id="l69.32">   },</span>
<a href="#l69.33"></a><span id="l69.33">   markPending: function ACGR_markPending(aCompleter) {</span>
<a href="#l69.34"></a><span id="l69.34">     this._pendingCount++;</span>
<a href="#l69.35"></a><span id="l69.35">   },</span>
<a href="#l69.36"></a><span id="l69.36">   markCompleted: function ACGR_markCompleted(aCompleter) {</span>
<a href="#l69.37"></a><span id="l69.37">     if (--this._pendingCount == 0) {</span>
<a href="#l69.38"></a><span id="l69.38">       this.listener.onSearchResult(this.completer, this);</span>
<a href="#l69.39"></a><span id="l69.39">     }</span>
<a href="#l69.40"></a><span id="l69.40">   },</span>
<a href="#l69.41"></a><span id="l69.41" class="difflineplus">+  announceYourself: function ACGR_announceYourself() {</span>
<a href="#l69.42"></a><span id="l69.42" class="difflineplus">+    this._initiallyReported = true;</span>
<a href="#l69.43"></a><span id="l69.43" class="difflineplus">+    this.listener.onSearchResult(this.completer, this);</span>
<a href="#l69.44"></a><span id="l69.44" class="difflineplus">+  },</span>
<a href="#l69.45"></a><span id="l69.45">   addRows: function ACGR_addRows(aRows) {</span>
<a href="#l69.46"></a><span id="l69.46">     if (!aRows.length)</span>
<a href="#l69.47"></a><span id="l69.47">       return;</span>
<a href="#l69.48"></a><span id="l69.48">     this._results.push.apply(this._results, aRows);</span>
<a href="#l69.49"></a><span id="l69.49" class="difflineminus">-    this.listener.onSearchResult(this.completer, this);</span>
<a href="#l69.50"></a><span id="l69.50" class="difflineplus">+    if (this._initiallyReported)</span>
<a href="#l69.51"></a><span id="l69.51" class="difflineplus">+      this.listener.onSearchResult(this.completer, this);</span>
<a href="#l69.52"></a><span id="l69.52">   },</span>
<a href="#l69.53"></a><span id="l69.53">   // ==== nsIAutoCompleteResult</span>
<a href="#l69.54"></a><span id="l69.54">   searchString: null,</span>
<a href="#l69.55"></a><span id="l69.55">   get searchResult() {</span>
<a href="#l69.56"></a><span id="l69.56">     if (this._problem)</span>
<a href="#l69.57"></a><span id="l69.57">       return Ci.nsIAutoCompleteResult.RESULT_FAILURE;</span>
<a href="#l69.58"></a><span id="l69.58">     if (this._results.length)</span>
<a href="#l69.59"></a><span id="l69.59">       return (!this._pendingCount) ? Ci.nsIAutoCompleteResult.RESULT_SUCCESS</span>
<a href="#l69.60"></a><span id="l69.60" class="difflineat">@@ -374,17 +383,17 @@ ContactTagCompleter.prototype = {</span>
<a href="#l69.61"></a><span id="l69.61">   complete: function ContactTagCompleter_complete(aResult, aString) {</span>
<a href="#l69.62"></a><span id="l69.62">     // now is not the best time to do this; have onFreeTagAdded use a timer.</span>
<a href="#l69.63"></a><span id="l69.63">     if (this._suffixTreeDirty)</span>
<a href="#l69.64"></a><span id="l69.64">       this._buildSuffixTree();</span>
<a href="#l69.65"></a><span id="l69.65"> </span>
<a href="#l69.66"></a><span id="l69.66">     if (aString.length &lt; 2)</span>
<a href="#l69.67"></a><span id="l69.67">       return false; // no async mechanism that will add new rows</span>
<a href="#l69.68"></a><span id="l69.68"> </span>
<a href="#l69.69"></a><span id="l69.69" class="difflineminus">-    tags = this._suffixTree.findMatches(aString.toLowerCase());</span>
<a href="#l69.70"></a><span id="l69.70" class="difflineplus">+    let tags = this._suffixTree.findMatches(aString.toLowerCase());</span>
<a href="#l69.71"></a><span id="l69.71">     let rows = [];</span>
<a href="#l69.72"></a><span id="l69.72">     for each (let [iTag, tag] in Iterator(tags)) {</span>
<a href="#l69.73"></a><span id="l69.73">       let query = Gloda.newQuery(Gloda.NOUN_CONTACT);</span>
<a href="#l69.74"></a><span id="l69.74">       query.freeTags(tag);</span>
<a href="#l69.75"></a><span id="l69.75">       let resRow = new ResultRowMulti(Gloda.NOUN_CONTACT, &quot;tag&quot;, tag.name,</span>
<a href="#l69.76"></a><span id="l69.76">                                       query);</span>
<a href="#l69.77"></a><span id="l69.77">       rows.push(resRow);</span>
<a href="#l69.78"></a><span id="l69.78">     }</span>
<a href="#l69.79"></a><span id="l69.79" class="difflineat">@@ -411,17 +420,17 @@ MessageTagCompleter.prototype = {</span>
<a href="#l69.80"></a><span id="l69.80">     }</span>
<a href="#l69.81"></a><span id="l69.81">     this._suffixTree = new MultiSuffixTree(tagNames, tags);</span>
<a href="#l69.82"></a><span id="l69.82">     this._suffixTreeDirty = false;</span>
<a href="#l69.83"></a><span id="l69.83">   },</span>
<a href="#l69.84"></a><span id="l69.84">   complete: function MessageTagCompleter_complete(aResult, aString) {</span>
<a href="#l69.85"></a><span id="l69.85">     if (aString.length &lt; 2)</span>
<a href="#l69.86"></a><span id="l69.86">       return false;</span>
<a href="#l69.87"></a><span id="l69.87"> </span>
<a href="#l69.88"></a><span id="l69.88" class="difflineminus">-    tags = this._suffixTree.findMatches(aString.toLowerCase());</span>
<a href="#l69.89"></a><span id="l69.89" class="difflineplus">+    let tags = this._suffixTree.findMatches(aString.toLowerCase());</span>
<a href="#l69.90"></a><span id="l69.90">     let rows = [];</span>
<a href="#l69.91"></a><span id="l69.91">     for each (let [, tag] in Iterator(tags)) {</span>
<a href="#l69.92"></a><span id="l69.92">       let resRow = new ResultRowSingle(tag, &quot;tag&quot;, tag.tag, TagNoun.id);</span>
<a href="#l69.93"></a><span id="l69.93">       rows.push(resRow);</span>
<a href="#l69.94"></a><span id="l69.94">     }</span>
<a href="#l69.95"></a><span id="l69.95">     aResult.addRows(rows);</span>
<a href="#l69.96"></a><span id="l69.96"> </span>
<a href="#l69.97"></a><span id="l69.97">     return false; // no async mechanism that will add new rows</span>
<a href="#l69.98"></a><span id="l69.98" class="difflineat">@@ -537,17 +546,17 @@ nsAutoCompleteGloda.prototype = {</span>
<a href="#l69.99"></a><span id="l69.99">             result.markPending(completer);</span>
<a href="#l69.100"></a><span id="l69.100">         }</span>
<a href="#l69.101"></a><span id="l69.101">       //} else {</span>
<a href="#l69.102"></a><span id="l69.102">       //   It'd be nice to do autocomplete in the quicksearch modes based</span>
<a href="#l69.103"></a><span id="l69.103">       //   on the specific values for that mode in the current view.</span>
<a href="#l69.104"></a><span id="l69.104">       //   But we don't do that yet.</span>
<a href="#l69.105"></a><span id="l69.105">       }</span>
<a href="#l69.106"></a><span id="l69.106"> </span>
<a href="#l69.107"></a><span id="l69.107" class="difflineminus">-      aListener.onSearchResult(this, result);</span>
<a href="#l69.108"></a><span id="l69.108" class="difflineplus">+      result.announceYourself();</span>
<a href="#l69.109"></a><span id="l69.109">     } catch (e) {</span>
<a href="#l69.110"></a><span id="l69.110">       logException(e);</span>
<a href="#l69.111"></a><span id="l69.111">     }</span>
<a href="#l69.112"></a><span id="l69.112">   },</span>
<a href="#l69.113"></a><span id="l69.113"> </span>
<a href="#l69.114"></a><span id="l69.114">   stopSearch: function() {</span>
<a href="#l69.115"></a><span id="l69.115">   }</span>
<a href="#l69.116"></a><span id="l69.116"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l70.1"></a><span id="l70.1" class="difflineminus">--- a/mailnews/news/src/nsNewsDownloader.cpp</span>
<a href="#l70.2"></a><span id="l70.2" class="difflineplus">+++ b/mailnews/news/src/nsNewsDownloader.cpp</span>
<a href="#l70.3"></a><span id="l70.3" class="difflineat">@@ -524,17 +524,18 @@ nsresult DownloadMatchingNewsArticlesToN</span>
<a href="#l70.4"></a><span id="l70.4">   m_newsDB = newsDB;</span>
<a href="#l70.5"></a><span id="l70.5">   m_searchSession = searchSession;</span>
<a href="#l70.6"></a><span id="l70.6"> </span>
<a href="#l70.7"></a><span id="l70.7">   m_keysToDownload.Clear();</span>
<a href="#l70.8"></a><span id="l70.8">   nsresult rv;</span>
<a href="#l70.9"></a><span id="l70.9">   NS_ENSURE_ARG(searchSession);</span>
<a href="#l70.10"></a><span id="l70.10">   NS_ENSURE_ARG(folder);</span>
<a href="#l70.11"></a><span id="l70.11"> </span>
<a href="#l70.12"></a><span id="l70.12" class="difflineminus">-  searchSession-&gt;RegisterListener(this);</span>
<a href="#l70.13"></a><span id="l70.13" class="difflineplus">+  searchSession-&gt;RegisterListener(this,</span>
<a href="#l70.14"></a><span id="l70.14" class="difflineplus">+                                  nsIMsgSearchSession::allNotifications);</span>
<a href="#l70.15"></a><span id="l70.15">   rv = searchSession-&gt;AddScopeTerm(nsMsgSearchScope::localNews, folder);</span>
<a href="#l70.16"></a><span id="l70.16">   return searchSession-&gt;Search(m_window);</span>
<a href="#l70.17"></a><span id="l70.17"> }</span>
<a href="#l70.18"></a><span id="l70.18"> </span>
<a href="#l70.19"></a><span id="l70.19"> nsresult nsMsgDownloadAllNewsgroups::ProcessNextGroup()</span>
<a href="#l70.20"></a><span id="l70.20"> {</span>
<a href="#l70.21"></a><span id="l70.21">   nsresult rv = NS_OK;</span>
<a href="#l70.22"></a><span id="l70.22">   PRBool done = PR_FALSE;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

