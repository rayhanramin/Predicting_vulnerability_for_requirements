<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26406:0532fb6e8fa386c644c2ffc1c043f857a4458a1b</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 0532fb6e8fa386c644c2ffc1c043f857a4458a1b" />
<meta property="og:url" content="/comm-central/rev/0532fb6e8fa386c644c2ffc1c043f857a4458a1b" />
<meta property="og:description" content="Bug 1463266 - Fix comments in mimetext.cpp. rs=comment-only DONTBUILD" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 0532fb6e8fa386c644c2ffc1c043f857a4458a1b 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/0532fb6e8fa386c644c2ffc1c043f857a4458a1b">shortlog</a> |
<a href="/comm-central/log/0532fb6e8fa386c644c2ffc1c043f857a4458a1b">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/0532fb6e8fa386c644c2ffc1c043f857a4458a1b">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/0532fb6e8fa386c644c2ffc1c043f857a4458a1b">files</a> |
changeset |
<a href="/comm-central/raw-rev/0532fb6e8fa386c644c2ffc1c043f857a4458a1b">raw</a>  | <a href="/comm-central/archive/0532fb6e8fa386c644c2ffc1c043f857a4458a1b.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1463266">Bug 1463266</a> - Fix comments in mimetext.cpp. rs=comment-only DONTBUILD
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 23 Apr 2019 10:00:33 +0200</td></tr>

<tr>
 <td>changeset 26406</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/0532fb6e8fa386c644c2ffc1c043f857a4458a1b">0532fb6e8fa386c644c2ffc1c043f857a4458a1b</a></td>
</tr>



<tr>
<td>parent 26405</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/3bdcf6d1a44527cdef3f0d953e0ce722d8f73c6c">3bdcf6d1a44527cdef3f0d953e0ce722d8f73c6c</a>
</td>
</tr>

<tr>
<td>child 26407</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/dac8ee26189f9494d62072228905eac8b21661ce">dac8ee26189f9494d62072228905eac8b21661ce</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=0532fb6e8fa386c644c2ffc1c043f857a4458a1b">15825</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 23 Apr 2019 08:03:28 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@0532fb6e8fa3 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0532fb6e8fa386c644c2ffc1c043f857a4458a1b">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0532fb6e8fa386c644c2ffc1c043f857a4458a1b&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0532fb6e8fa386c644c2ffc1c043f857a4458a1b&newProject=comm-central&newRevision=3bdcf6d1a44527cdef3f0d953e0ce722d8f73c6c&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0532fb6e8fa386c644c2ffc1c043f857a4458a1b&newProject=comm-central&newRevision=3bdcf6d1a44527cdef3f0d953e0ce722d8f73c6c&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0532fb6e8fa386c644c2ffc1c043f857a4458a1b&newProject=comm-central&newRevision=3bdcf6d1a44527cdef3f0d953e0ce722d8f73c6c&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28comment-only%29&revcount=50">comment-only</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1463266">1463266</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1463266">Bug 1463266</a> - Fix comments in mimetext.cpp. rs=comment-only DONTBUILD</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0532fb6e8fa386c644c2ffc1c043f857a4458a1b/mailnews/mime/src/mimetext.cpp">mailnews/mime/src/mimetext.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0532fb6e8fa386c644c2ffc1c043f857a4458a1b/mailnews/mime/src/mimetext.cpp">file</a> |
<a href="/comm-central/annotate/0532fb6e8fa386c644c2ffc1c043f857a4458a1b/mailnews/mime/src/mimetext.cpp">annotate</a> |
<a href="/comm-central/diff/0532fb6e8fa386c644c2ffc1c043f857a4458a1b/mailnews/mime/src/mimetext.cpp">diff</a> |
<a href="/comm-central/comparison/0532fb6e8fa386c644c2ffc1c043f857a4458a1b/mailnews/mime/src/mimetext.cpp">comparison</a> |
<a href="/comm-central/log/0532fb6e8fa386c644c2ffc1c043f857a4458a1b/mailnews/mime/src/mimetext.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/mime/src/mimetext.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/mime/src/mimetext.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -55,33 +55,32 @@ MimeInlineTextClassInitialize(MimeInline</span>
<a href="#l1.4"></a><span id="l1.4">   clazz-&gt;initialize_charset    =  MimeInlineText_initializeCharset;</span>
<a href="#l1.5"></a><span id="l1.5">   lclass-&gt;parse_decoded_buffer = MimeInlineText_parse_decoded_buffer;</span>
<a href="#l1.6"></a><span id="l1.6">   return 0;</span>
<a href="#l1.7"></a><span id="l1.7"> }</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> static int</span>
<a href="#l1.10"></a><span id="l1.10"> MimeInlineText_initialize (MimeObject *obj)</span>
<a href="#l1.11"></a><span id="l1.11"> {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  /* This is an abstract class; it shouldn't be directly instantiated. */</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+  // This is an abstract class; it shouldn't be directly instantiated.</span>
<a href="#l1.14"></a><span id="l1.14">   PR_ASSERT(obj-&gt;clazz != (MimeObjectClass *) &amp;mimeInlineTextClass);</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16">   ((MimeInlineText *) obj)-&gt;initializeCharset = false;</span>
<a href="#l1.17"></a><span id="l1.17">   ((MimeInlineText *) obj)-&gt;needUpdateMsgWinCharset = false;</span>
<a href="#l1.18"></a><span id="l1.18">   return ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;initialize(obj);</span>
<a href="#l1.19"></a><span id="l1.19"> }</span>
<a href="#l1.20"></a><span id="l1.20"> </span>
<a href="#l1.21"></a><span id="l1.21"> static int MimeInlineText_initializeCharset(MimeObject *obj)</span>
<a href="#l1.22"></a><span id="l1.22"> {</span>
<a href="#l1.23"></a><span id="l1.23">   MimeInlineText  *text = (MimeInlineText *) obj;</span>
<a href="#l1.24"></a><span id="l1.24"> </span>
<a href="#l1.25"></a><span id="l1.25">   text-&gt;inputAutodetect = false;</span>
<a href="#l1.26"></a><span id="l1.26">   text-&gt;charsetOverridable = false;</span>
<a href="#l1.27"></a><span id="l1.27"> </span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-  /* Figure out an appropriate charset for this object.</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-  */</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+  // Figure out an appropriate charset for this object.</span>
<a href="#l1.31"></a><span id="l1.31">   if (!text-&gt;charset &amp;&amp; obj-&gt;headers)</span>
<a href="#l1.32"></a><span id="l1.32">   {</span>
<a href="#l1.33"></a><span id="l1.33">     if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;override_charset)</span>
<a href="#l1.34"></a><span id="l1.34">     {</span>
<a href="#l1.35"></a><span id="l1.35">       text-&gt;charset = strdup(obj-&gt;options-&gt;default_charset);</span>
<a href="#l1.36"></a><span id="l1.36">     }</span>
<a href="#l1.37"></a><span id="l1.37">     else</span>
<a href="#l1.38"></a><span id="l1.38">     {</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineat">@@ -90,48 +89,46 @@ static int MimeInlineText_initializeChar</span>
<a href="#l1.40"></a><span id="l1.40">       if (ct)</span>
<a href="#l1.41"></a><span id="l1.41">       {</span>
<a href="#l1.42"></a><span id="l1.42">         text-&gt;charset = MimeHeaders_get_parameter (ct, &quot;charset&quot;, NULL, NULL);</span>
<a href="#l1.43"></a><span id="l1.43">         PR_Free(ct);</span>
<a href="#l1.44"></a><span id="l1.44">       }</span>
<a href="#l1.45"></a><span id="l1.45"> </span>
<a href="#l1.46"></a><span id="l1.46">       if (!text-&gt;charset)</span>
<a href="#l1.47"></a><span id="l1.47">       {</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-        /* If we didn't find &quot;Content-Type: ...; charset=XX&quot; then look</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-           for &quot;X-Sun-Charset: XX&quot; instead.  (Maybe this should be done</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-           in MimeSunAttachmentClass, but it's harder there than here.)</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-         */</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+        // If we didn't find &quot;Content-Type: ...; charset=XX&quot;, then look</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+        // for &quot;X-Sun-Charset: XX&quot; instead. (Maybe this should be done</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+        // in MimeSunAttachmentClass, but it's harder there than here.)</span>
<a href="#l1.55"></a><span id="l1.55">         text-&gt;charset = MimeHeaders_get (obj-&gt;headers,</span>
<a href="#l1.56"></a><span id="l1.56">                                           HEADER_X_SUN_CHARSET,</span>
<a href="#l1.57"></a><span id="l1.57">                                           false, false);</span>
<a href="#l1.58"></a><span id="l1.58">       }</span>
<a href="#l1.59"></a><span id="l1.59"> </span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-      /* iMIP entities without an explicit charset parameter default to</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-       US-ASCII (RFC 2447, section 2.4). However, Microsoft Outlook generates</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-       UTF-8 but omits the charset parameter.</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-       When no charset is defined by the container (e.g. iMIP), iCalendar</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-       files default to UTF-8 (RFC 2445, section 4.1.4).</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineminus">-       */</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+      // iMIP entities without an explicit charset parameter default to</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+      // US-ASCII (RFC 2447, section 2.4). However, Microsoft Outlook generates</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+      // UTF-8 but omits the charset parameter.</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+      // When no charset is defined by the container (e.g. iMIP), iCalendar</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+      // files default to UTF-8 (RFC 2445, section 4.1.4).</span>
<a href="#l1.71"></a><span id="l1.71">       if (!text-&gt;charset &amp;&amp;</span>
<a href="#l1.72"></a><span id="l1.72">           obj-&gt;content_type &amp;&amp;</span>
<a href="#l1.73"></a><span id="l1.73">           !PL_strcasecmp(obj-&gt;content_type, TEXT_CALENDAR))</span>
<a href="#l1.74"></a><span id="l1.74">         text-&gt;charset = strdup(&quot;UTF-8&quot;);</span>
<a href="#l1.75"></a><span id="l1.75"> </span>
<a href="#l1.76"></a><span id="l1.76">       if (!text-&gt;charset)</span>
<a href="#l1.77"></a><span id="l1.77">       {</span>
<a href="#l1.78"></a><span id="l1.78">         nsresult res;</span>
<a href="#l1.79"></a><span id="l1.79"> </span>
<a href="#l1.80"></a><span id="l1.80">         text-&gt;charsetOverridable = true;</span>
<a href="#l1.81"></a><span id="l1.81"> </span>
<a href="#l1.82"></a><span id="l1.82">         nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;res));</span>
<a href="#l1.83"></a><span id="l1.83">         if (NS_SUCCEEDED(res))</span>
<a href="#l1.84"></a><span id="l1.84">         {</span>
<a href="#l1.85"></a><span id="l1.85">           nsCOMPtr&lt;nsIPrefLocalizedString&gt; str;</span>
<a href="#l1.86"></a><span id="l1.86">           if (NS_SUCCEEDED(prefBranch-&gt;GetComplexValue(&quot;intl.charset.detector&quot;, NS_GET_IID(nsIPrefLocalizedString), getter_AddRefs(str)))) {</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineminus">-            //only if we can get autodetector name correctly, do we set this to true</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+            // Only if we can get autodetector name correctly, do we set this to true.</span>
<a href="#l1.89"></a><span id="l1.89">             text-&gt;inputAutodetect = true;</span>
<a href="#l1.90"></a><span id="l1.90">           }</span>
<a href="#l1.91"></a><span id="l1.91">         }</span>
<a href="#l1.92"></a><span id="l1.92"> </span>
<a href="#l1.93"></a><span id="l1.93">         if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;default_charset)</span>
<a href="#l1.94"></a><span id="l1.94">           text-&gt;charset = strdup(obj-&gt;options-&gt;default_charset);</span>
<a href="#l1.95"></a><span id="l1.95">         else</span>
<a href="#l1.96"></a><span id="l1.96">         {</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineat">@@ -145,17 +142,17 @@ static int MimeInlineText_initializeChar</span>
<a href="#l1.98"></a><span id="l1.98">             text-&gt;charset = strdup(&quot;&quot;);</span>
<a href="#l1.99"></a><span id="l1.99">         }</span>
<a href="#l1.100"></a><span id="l1.100">       }</span>
<a href="#l1.101"></a><span id="l1.101">     }</span>
<a href="#l1.102"></a><span id="l1.102">   }</span>
<a href="#l1.103"></a><span id="l1.103"> </span>
<a href="#l1.104"></a><span id="l1.104">   if (text-&gt;inputAutodetect)</span>
<a href="#l1.105"></a><span id="l1.105">   {</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineminus">-    //we need to prepare lineDam for charset detection</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+    // We need to prepare lineDam for charset detection.</span>
<a href="#l1.108"></a><span id="l1.108">     text-&gt;lineDamBuffer = (char*)PR_Malloc(DAM_MAX_BUFFER_SIZE);</span>
<a href="#l1.109"></a><span id="l1.109">     text-&gt;lineDamPtrs = (char**)PR_Malloc(DAM_MAX_LINES*sizeof(char*));</span>
<a href="#l1.110"></a><span id="l1.110">     text-&gt;curDamOffset = 0;</span>
<a href="#l1.111"></a><span id="l1.111">     text-&gt;lastLineInDam = 0;</span>
<a href="#l1.112"></a><span id="l1.112">     if (!text-&gt;lineDamBuffer || !text-&gt;lineDamPtrs)</span>
<a href="#l1.113"></a><span id="l1.113">     {</span>
<a href="#l1.114"></a><span id="l1.114">       text-&gt;inputAutodetect = false;</span>
<a href="#l1.115"></a><span id="l1.115">       PR_FREEIF(text-&gt;lineDamBuffer);</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineat">@@ -173,17 +170,17 @@ MimeInlineText_finalize (MimeObject *obj</span>
<a href="#l1.117"></a><span id="l1.117"> {</span>
<a href="#l1.118"></a><span id="l1.118">   MimeInlineText *text = (MimeInlineText *) obj;</span>
<a href="#l1.119"></a><span id="l1.119"> </span>
<a href="#l1.120"></a><span id="l1.120">   obj-&gt;clazz-&gt;parse_eof (obj, false);</span>
<a href="#l1.121"></a><span id="l1.121">   obj-&gt;clazz-&gt;parse_end (obj, false);</span>
<a href="#l1.122"></a><span id="l1.122"> </span>
<a href="#l1.123"></a><span id="l1.123">   PR_FREEIF(text-&gt;charset);</span>
<a href="#l1.124"></a><span id="l1.124"> </span>
<a href="#l1.125"></a><span id="l1.125" class="difflineminus">-  /* Should have been freed by parse_eof, but just in case... */</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+  // Should have been freed by parse_eof, but just in case...</span>
<a href="#l1.127"></a><span id="l1.127">   PR_ASSERT(!text-&gt;cbuffer);</span>
<a href="#l1.128"></a><span id="l1.128">   PR_FREEIF (text-&gt;cbuffer);</span>
<a href="#l1.129"></a><span id="l1.129"> </span>
<a href="#l1.130"></a><span id="l1.130">   if (text-&gt;inputAutodetect) {</span>
<a href="#l1.131"></a><span id="l1.131">     PR_FREEIF(text-&gt;lineDamBuffer);</span>
<a href="#l1.132"></a><span id="l1.132">     PR_FREEIF(text-&gt;lineDamPtrs);</span>
<a href="#l1.133"></a><span id="l1.133">     text-&gt;inputAutodetect = false;</span>
<a href="#l1.134"></a><span id="l1.134">   }</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineat">@@ -197,28 +194,27 @@ MimeInlineText_parse_eof (MimeObject *ob</span>
<a href="#l1.136"></a><span id="l1.136"> {</span>
<a href="#l1.137"></a><span id="l1.137">   int status;</span>
<a href="#l1.138"></a><span id="l1.138"> </span>
<a href="#l1.139"></a><span id="l1.139">   if (obj-&gt;closed_p) return 0;</span>
<a href="#l1.140"></a><span id="l1.140">   NS_ASSERTION(!obj-&gt;parsed_p, &quot;obj already parsed&quot;);</span>
<a href="#l1.141"></a><span id="l1.141"> </span>
<a href="#l1.142"></a><span id="l1.142">   MimeInlineText *text = (MimeInlineText *) obj;</span>
<a href="#l1.143"></a><span id="l1.143"> </span>
<a href="#l1.144"></a><span id="l1.144" class="difflineminus">-  /* Flush any buffered data from the MimeLeaf's decoder */</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineplus">+  // Flush any buffered data from the MimeLeaf's decoder.</span>
<a href="#l1.146"></a><span id="l1.146">   status = ((MimeLeafClass*)&amp;MIME_SUPERCLASS)-&gt;close_decoder(obj);</span>
<a href="#l1.147"></a><span id="l1.147">   if (status &lt; 0) return status;</span>
<a href="#l1.148"></a><span id="l1.148"> </span>
<a href="#l1.149"></a><span id="l1.149" class="difflineminus">-  /* If there is still data in the ibuffer, that means that the last</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineminus">-   line of this part didn't end in a newline; so push it out anyway</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineminus">-   (this means that the parse_line method will be called with a string</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineminus">-   with no trailing newline, which isn't the usual case).  We do this</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineminus">-   here, rather than in MimeObject_parse_eof, because MimeObject isn't</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineminus">-   aware of the rotating-and-converting / charset detection we need to</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineminus">-   do first.</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineminus">-  */</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineplus">+  // If there is still data in the ibuffer, that means that the last</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+  // line of this part didn't end in a newline; so push it out anyway</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+  // (this means that the parse_line method will be called with a string</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+  // with no trailing newline, which isn't the usual case). We do this</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+  // here, rather than in MimeObject_parse_eof, because MimeObject isn't</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineplus">+  // aware of the rotating-and-converting / charset detection we need to</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineplus">+  // do first.</span>
<a href="#l1.164"></a><span id="l1.164">   if (!abort_p &amp;&amp; obj-&gt;ibuffer_fp &gt; 0)</span>
<a href="#l1.165"></a><span id="l1.165">   {</span>
<a href="#l1.166"></a><span id="l1.166">     status = MimeInlineText_rotate_convert_and_parse_line (obj-&gt;ibuffer,</span>
<a href="#l1.167"></a><span id="l1.167">                                                            obj-&gt;ibuffer_fp,</span>
<a href="#l1.168"></a><span id="l1.168">                                                            obj);</span>
<a href="#l1.169"></a><span id="l1.169">     obj-&gt;ibuffer_fp = 0;</span>
<a href="#l1.170"></a><span id="l1.170">     if (status &lt; 0)</span>
<a href="#l1.171"></a><span id="l1.171">     {</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineat">@@ -244,27 +240,26 @@ MimeInlineText_parse_end (MimeObject *ob</span>
<a href="#l1.173"></a><span id="l1.173">   MimeInlineText *text = (MimeInlineText *) obj;</span>
<a href="#l1.174"></a><span id="l1.174"> </span>
<a href="#l1.175"></a><span id="l1.175">   if (obj-&gt;parsed_p)</span>
<a href="#l1.176"></a><span id="l1.176">   {</span>
<a href="#l1.177"></a><span id="l1.177">     PR_ASSERT(obj-&gt;closed_p);</span>
<a href="#l1.178"></a><span id="l1.178">     return 0;</span>
<a href="#l1.179"></a><span id="l1.179">   }</span>
<a href="#l1.180"></a><span id="l1.180"> </span>
<a href="#l1.181"></a><span id="l1.181" class="difflineminus">-  /* We won't be needing this buffer any more; nuke it. */</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineplus">+  // We won't be needing this buffer any more; nuke it.</span>
<a href="#l1.183"></a><span id="l1.183">   PR_FREEIF(text-&gt;cbuffer);</span>
<a href="#l1.184"></a><span id="l1.184">   text-&gt;cbuffer_size = 0;</span>
<a href="#l1.185"></a><span id="l1.185"> </span>
<a href="#l1.186"></a><span id="l1.186">   return ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_end (obj, abort_p);</span>
<a href="#l1.187"></a><span id="l1.187"> }</span>
<a href="#l1.188"></a><span id="l1.188"> </span>
<a href="#l1.189"></a><span id="l1.189"> </span>
<a href="#l1.190"></a><span id="l1.190" class="difflineminus">-/* This maps A-M to N-Z and N-Z to A-M.  All other characters are left alone.</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineminus">-   (Comments in GNUS imply that for Japanese, one should rotate by 47?)</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineminus">- */</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineplus">+// This maps A-M to N-Z and N-Z to A-M. All other characters are left alone.</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineplus">+// (Comments in GNUS imply that for Japanese, one should rotate by 47?)</span>
<a href="#l1.195"></a><span id="l1.195"> static const unsigned char MimeInlineText_rot13_table[256] = {</span>
<a href="#l1.196"></a><span id="l1.196">   0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20,</span>
<a href="#l1.197"></a><span id="l1.197">   21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39,</span>
<a href="#l1.198"></a><span id="l1.198">   40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58,</span>
<a href="#l1.199"></a><span id="l1.199">   59, 60, 61, 62, 63, 64, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90,</span>
<a href="#l1.200"></a><span id="l1.200">   65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 91, 92, 93, 94, 95, 96,</span>
<a href="#l1.201"></a><span id="l1.201">   110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 97, 98,</span>
<a href="#l1.202"></a><span id="l1.202">   99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 123, 124, 125, 126,</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineat">@@ -296,29 +291,28 @@ MimeInlineText_rot13_line (MimeObject *o</span>
<a href="#l1.204"></a><span id="l1.204"> </span>
<a href="#l1.205"></a><span id="l1.205"> </span>
<a href="#l1.206"></a><span id="l1.206"> static int</span>
<a href="#l1.207"></a><span id="l1.207"> MimeInlineText_parse_decoded_buffer (const char *buf, int32_t size, MimeObject *obj)</span>
<a href="#l1.208"></a><span id="l1.208"> {</span>
<a href="#l1.209"></a><span id="l1.209">   PR_ASSERT(!obj-&gt;closed_p);</span>
<a href="#l1.210"></a><span id="l1.210">   if (obj-&gt;closed_p) return -1;</span>
<a href="#l1.211"></a><span id="l1.211"> </span>
<a href="#l1.212"></a><span id="l1.212" class="difflineminus">-  /* MimeLeaf takes care of this. */</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineplus">+  // MimeLeaf takes care of this.</span>
<a href="#l1.214"></a><span id="l1.214">   PR_ASSERT(obj-&gt;output_p &amp;&amp; obj-&gt;options &amp;&amp; obj-&gt;options-&gt;output_fn);</span>
<a href="#l1.215"></a><span id="l1.215">   if (!obj-&gt;options) return -1;</span>
<a href="#l1.216"></a><span id="l1.216"> </span>
<a href="#l1.217"></a><span id="l1.217" class="difflineminus">-  /* If we're supposed to write this object, but aren't supposed to convert</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineminus">-   it to HTML, simply pass it through unaltered. */</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineplus">+  // If we're supposed to write this object, but aren't supposed to convert</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineplus">+  // it to HTML, simply pass it through unaltered.</span>
<a href="#l1.221"></a><span id="l1.221">   if (!obj-&gt;options-&gt;write_html_p &amp;&amp; obj-&gt;options-&gt;format_out != nsMimeOutput::nsMimeMessageAttach)</span>
<a href="#l1.222"></a><span id="l1.222">   return MimeObject_write(obj, buf, size, true);</span>
<a href="#l1.223"></a><span id="l1.223"> </span>
<a href="#l1.224"></a><span id="l1.224" class="difflineminus">-  /* This is just like the parse_decoded_buffer method we inherit from the</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineminus">-   MimeLeaf class, except that we line-buffer to our own wrapper on the</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineminus">-   `parse_line' method instead of calling the `parse_line' method directly.</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineminus">-   */</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineplus">+  // This is just like the parse_decoded_buffer method we inherit from the</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineplus">+  // MimeLeaf class, except that we line-buffer to our own wrapper on the</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineplus">+  // `parse_line` method instead of calling the `parse_line` method directly.</span>
<a href="#l1.231"></a><span id="l1.231">   return mime_LineBuffer (buf, size,</span>
<a href="#l1.232"></a><span id="l1.232">              &amp;obj-&gt;ibuffer, &amp;obj-&gt;ibuffer_size, &amp;obj-&gt;ibuffer_fp,</span>
<a href="#l1.233"></a><span id="l1.233">              true,</span>
<a href="#l1.234"></a><span id="l1.234">              ((int (*) (char *, int32_t, void *))</span>
<a href="#l1.235"></a><span id="l1.235">               /* This cast is to turn void into MimeObject */</span>
<a href="#l1.236"></a><span id="l1.236">               MimeInlineText_rotate_convert_and_parse_line),</span>
<a href="#l1.237"></a><span id="l1.237">              obj);</span>
<a href="#l1.238"></a><span id="l1.238"> }</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineat">@@ -333,31 +327,31 @@ MimeInlineText_parse_decoded_buffer (con</span>
<a href="#l1.240"></a><span id="l1.240"> static int</span>
<a href="#l1.241"></a><span id="l1.241"> MimeInlineText_convert_and_parse_line(char *line, int32_t length, MimeObject *obj)</span>
<a href="#l1.242"></a><span id="l1.242"> {</span>
<a href="#l1.243"></a><span id="l1.243">   int status;</span>
<a href="#l1.244"></a><span id="l1.244">   nsAutoCString converted;</span>
<a href="#l1.245"></a><span id="l1.245"> </span>
<a href="#l1.246"></a><span id="l1.246">   MimeInlineText *text = (MimeInlineText *) obj;</span>
<a href="#l1.247"></a><span id="l1.247"> </span>
<a href="#l1.248"></a><span id="l1.248" class="difflineminus">-  //in case of charset autodetection, charset can be override by meta charset</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineplus">+  // In case of charset autodetection, charset can be overridden by meta charset.</span>
<a href="#l1.250"></a><span id="l1.250">   if (text-&gt;charsetOverridable) {</span>
<a href="#l1.251"></a><span id="l1.251">     if (mime_typep(obj, (MimeObjectClass *) &amp;mimeInlineTextHTMLClass))</span>
<a href="#l1.252"></a><span id="l1.252">     {</span>
<a href="#l1.253"></a><span id="l1.253">       MimeInlineTextHTML  *textHTML = (MimeInlineTextHTML *) obj;</span>
<a href="#l1.254"></a><span id="l1.254">       if (textHTML-&gt;charset &amp;&amp;</span>
<a href="#l1.255"></a><span id="l1.255">           *textHTML-&gt;charset &amp;&amp;</span>
<a href="#l1.256"></a><span id="l1.256">           strcmp(textHTML-&gt;charset, text-&gt;charset))</span>
<a href="#l1.257"></a><span id="l1.257">       {</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineminus">-        //if meta tag specified charset is different from our detected result, use meta charset.</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineminus">-        //but we don't want to redo previous lines</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineplus">+        // If meta tag specified charset is different from our detected result, use meta charset,</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineplus">+        // but we don't want to redo previous lines.</span>
<a href="#l1.262"></a><span id="l1.262">         PR_FREEIF(text-&gt;charset);</span>
<a href="#l1.263"></a><span id="l1.263">         text-&gt;charset = strdup(textHTML-&gt;charset);</span>
<a href="#l1.264"></a><span id="l1.264"> </span>
<a href="#l1.265"></a><span id="l1.265" class="difflineminus">-        //update MsgWindow charset if we are instructed to do so</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineplus">+        // Update MsgWindow charset if we are instructed to do so.</span>
<a href="#l1.267"></a><span id="l1.267">         if (text-&gt;needUpdateMsgWinCharset &amp;&amp; *text-&gt;charset)</span>
<a href="#l1.268"></a><span id="l1.268">           SetMailCharacterSetToMsgWindow(obj, text-&gt;charset);</span>
<a href="#l1.269"></a><span id="l1.269">       }</span>
<a href="#l1.270"></a><span id="l1.270">     }</span>
<a href="#l1.271"></a><span id="l1.271">   }</span>
<a href="#l1.272"></a><span id="l1.272"> </span>
<a href="#l1.273"></a><span id="l1.273">   status = obj-&gt;options-&gt;charset_conversion_fn(line, length,</span>
<a href="#l1.274"></a><span id="l1.274">                        text-&gt;charset,</span>
<a href="#l1.275"></a><span id="l1.275" class="difflineat">@@ -365,55 +359,55 @@ MimeInlineText_convert_and_parse_line(ch</span>
<a href="#l1.276"></a><span id="l1.276">                        obj-&gt;options-&gt;stream_closure);</span>
<a href="#l1.277"></a><span id="l1.277"> </span>
<a href="#l1.278"></a><span id="l1.278">   if (status == 0)</span>
<a href="#l1.279"></a><span id="l1.279">   {</span>
<a href="#l1.280"></a><span id="l1.280">     line = (char *) converted.get();</span>
<a href="#l1.281"></a><span id="l1.281">     length = converted.Length();</span>
<a href="#l1.282"></a><span id="l1.282">   }</span>
<a href="#l1.283"></a><span id="l1.283"> </span>
<a href="#l1.284"></a><span id="l1.284" class="difflineminus">-  /* Now that the line has been converted, call the subclass's parse_line</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineminus">-   method with the decoded data. */</span>
<a href="#l1.286"></a><span id="l1.286" class="difflineplus">+  // Now that the line has been converted, call the subclass's parse_line</span>
<a href="#l1.287"></a><span id="l1.287" class="difflineplus">+  // method with the decoded data.</span>
<a href="#l1.288"></a><span id="l1.288">   status = obj-&gt;clazz-&gt;parse_line(line, length, obj);</span>
<a href="#l1.289"></a><span id="l1.289"> </span>
<a href="#l1.290"></a><span id="l1.290">   return status;</span>
<a href="#l1.291"></a><span id="l1.291"> }</span>
<a href="#l1.292"></a><span id="l1.292"> </span>
<a href="#l1.293"></a><span id="l1.293" class="difflineminus">-//In this function call, all buffered lines in lineDam will be sent to charset detector</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineplus">+// In this function call, all buffered lines in lineDam will be sent to charset detector</span>
<a href="#l1.295"></a><span id="l1.295"> // and a charset will be used to parse all those line and following lines in this mime obj.</span>
<a href="#l1.296"></a><span id="l1.296"> static int</span>
<a href="#l1.297"></a><span id="l1.297"> MimeInlineText_open_dam(char *line, int32_t length, MimeObject *obj)</span>
<a href="#l1.298"></a><span id="l1.298"> {</span>
<a href="#l1.299"></a><span id="l1.299">   MimeInlineText *text = (MimeInlineText *) obj;</span>
<a href="#l1.300"></a><span id="l1.300">   nsAutoCString detectedCharset;</span>
<a href="#l1.301"></a><span id="l1.301">   nsresult res = NS_OK;</span>
<a href="#l1.302"></a><span id="l1.302">   int status = 0;</span>
<a href="#l1.303"></a><span id="l1.303">   int32_t i;</span>
<a href="#l1.304"></a><span id="l1.304"> </span>
<a href="#l1.305"></a><span id="l1.305">   if (text-&gt;curDamOffset &lt;= 0) {</span>
<a href="#l1.306"></a><span id="l1.306" class="difflineminus">-    //there is nothing in dam, use current line for detection</span>
<a href="#l1.307"></a><span id="l1.307" class="difflineplus">+    // There is nothing in dam, use current line for detection.</span>
<a href="#l1.308"></a><span id="l1.308">     if (length &gt; 0) {</span>
<a href="#l1.309"></a><span id="l1.309">       res = MIME_detect_charset(line, length, detectedCharset);</span>
<a href="#l1.310"></a><span id="l1.310">     }</span>
<a href="#l1.311"></a><span id="l1.311">   } else {</span>
<a href="#l1.312"></a><span id="l1.312" class="difflineminus">-    //we have stuff in dam, use the one</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineplus">+    // We have stuff in dam, use the one.</span>
<a href="#l1.314"></a><span id="l1.314">     res = MIME_detect_charset(text-&gt;lineDamBuffer, text-&gt;curDamOffset, detectedCharset);</span>
<a href="#l1.315"></a><span id="l1.315">   }</span>
<a href="#l1.316"></a><span id="l1.316"> </span>
<a href="#l1.317"></a><span id="l1.317" class="difflineminus">-  //set the charset for this obj</span>
<a href="#l1.318"></a><span id="l1.318" class="difflineplus">+  // Set the charset for this object.</span>
<a href="#l1.319"></a><span id="l1.319">   if (NS_SUCCEEDED(res) &amp;&amp; !detectedCharset.IsEmpty()) {</span>
<a href="#l1.320"></a><span id="l1.320">     PR_FREEIF(text-&gt;charset);</span>
<a href="#l1.321"></a><span id="l1.321">     text-&gt;charset = ToNewCString(detectedCharset);</span>
<a href="#l1.322"></a><span id="l1.322"> </span>
<a href="#l1.323"></a><span id="l1.323" class="difflineminus">-    //update MsgWindow charset if we are instructed to do so</span>
<a href="#l1.324"></a><span id="l1.324" class="difflineplus">+    // Update MsgWindow charset if we are instructed to do so.</span>
<a href="#l1.325"></a><span id="l1.325">     if (text-&gt;needUpdateMsgWinCharset &amp;&amp; text-&gt;charset)</span>
<a href="#l1.326"></a><span id="l1.326">       SetMailCharacterSetToMsgWindow(obj, text-&gt;charset);</span>
<a href="#l1.327"></a><span id="l1.327">   }</span>
<a href="#l1.328"></a><span id="l1.328"> </span>
<a href="#l1.329"></a><span id="l1.329" class="difflineminus">-  //process dam and line using the charset</span>
<a href="#l1.330"></a><span id="l1.330" class="difflineplus">+  // Process dam and line using the charset.</span>
<a href="#l1.331"></a><span id="l1.331">   if (text-&gt;curDamOffset) {</span>
<a href="#l1.332"></a><span id="l1.332">     for (i = 0; i &lt; text-&gt;lastLineInDam-1; i++)</span>
<a href="#l1.333"></a><span id="l1.333">     {</span>
<a href="#l1.334"></a><span id="l1.334">       status = MimeInlineText_convert_and_parse_line(</span>
<a href="#l1.335"></a><span id="l1.335">                 text-&gt;lineDamPtrs[i],</span>
<a href="#l1.336"></a><span id="l1.336">                 text-&gt;lineDamPtrs[i+1] - text-&gt;lineDamPtrs[i],</span>
<a href="#l1.337"></a><span id="l1.337">                 obj  );</span>
<a href="#l1.338"></a><span id="l1.338">     }</span>
<a href="#l1.339"></a><span id="l1.339" class="difflineat">@@ -441,62 +435,61 @@ MimeInlineText_rotate_convert_and_parse_</span>
<a href="#l1.340"></a><span id="l1.340">                        MimeObject *obj)</span>
<a href="#l1.341"></a><span id="l1.341"> {</span>
<a href="#l1.342"></a><span id="l1.342">   int status = 0;</span>
<a href="#l1.343"></a><span id="l1.343">   MimeInlineTextClass *textc = (MimeInlineTextClass *) obj-&gt;clazz;</span>
<a href="#l1.344"></a><span id="l1.344"> </span>
<a href="#l1.345"></a><span id="l1.345">   PR_ASSERT(!obj-&gt;closed_p);</span>
<a href="#l1.346"></a><span id="l1.346">   if (obj-&gt;closed_p) return -1;</span>
<a href="#l1.347"></a><span id="l1.347"> </span>
<a href="#l1.348"></a><span id="l1.348" class="difflineminus">-  /* Rotate the line, if desired (this happens on the raw data, before any</span>
<a href="#l1.349"></a><span id="l1.349" class="difflineminus">-   charset conversion.) */</span>
<a href="#l1.350"></a><span id="l1.350" class="difflineplus">+  // Rotate the line, if desired (this happens on the raw data, before any</span>
<a href="#l1.351"></a><span id="l1.351" class="difflineplus">+  // charset conversion).</span>
<a href="#l1.352"></a><span id="l1.352">   if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;rot13_p)</span>
<a href="#l1.353"></a><span id="l1.353">   {</span>
<a href="#l1.354"></a><span id="l1.354">     status = textc-&gt;rot13_line(obj, line, length);</span>
<a href="#l1.355"></a><span id="l1.355">     if (status &lt; 0) return status;</span>
<a href="#l1.356"></a><span id="l1.356">   }</span>
<a href="#l1.357"></a><span id="l1.357"> </span>
<a href="#l1.358"></a><span id="l1.358">   // Now convert to the canonical charset, if desired.</span>
<a href="#l1.359"></a><span id="l1.359" class="difflineminus">-  //</span>
<a href="#l1.360"></a><span id="l1.360">   bool    doConvert = true;</span>
<a href="#l1.361"></a><span id="l1.361">   // Don't convert vCard data</span>
<a href="#l1.362"></a><span id="l1.362">   if ( ( (obj-&gt;content_type) &amp;&amp; (!PL_strcasecmp(obj-&gt;content_type, TEXT_VCARD)) ) ||</span>
<a href="#l1.363"></a><span id="l1.363">        (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageSaveAs)</span>
<a href="#l1.364"></a><span id="l1.364">        || obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageAttach)</span>
<a href="#l1.365"></a><span id="l1.365">     doConvert = false;</span>
<a href="#l1.366"></a><span id="l1.366"> </span>
<a href="#l1.367"></a><span id="l1.367" class="difflineminus">-  // Only convert if the user prefs is false</span>
<a href="#l1.368"></a><span id="l1.368" class="difflineplus">+  // Only convert if the user prefs is false.</span>
<a href="#l1.369"></a><span id="l1.369">   if ( (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;charset_conversion_fn) &amp;&amp;</span>
<a href="#l1.370"></a><span id="l1.370">        (!obj-&gt;options-&gt;force_user_charset) &amp;&amp;</span>
<a href="#l1.371"></a><span id="l1.371">        (doConvert)</span>
<a href="#l1.372"></a><span id="l1.372">      )</span>
<a href="#l1.373"></a><span id="l1.373">   {</span>
<a href="#l1.374"></a><span id="l1.374">     MimeInlineText  *text = (MimeInlineText *) obj;</span>
<a href="#l1.375"></a><span id="l1.375"> </span>
<a href="#l1.376"></a><span id="l1.376">     if (!text-&gt;initializeCharset)</span>
<a href="#l1.377"></a><span id="l1.377">     {</span>
<a href="#l1.378"></a><span id="l1.378">       MimeInlineText_initializeCharset(obj);</span>
<a href="#l1.379"></a><span id="l1.379" class="difflineminus">-      //update MsgWindow charset if we are instructed to do so</span>
<a href="#l1.380"></a><span id="l1.380" class="difflineplus">+      // Update MsgWindow charset if we are instructed to do so.</span>
<a href="#l1.381"></a><span id="l1.381">       if (text-&gt;needUpdateMsgWinCharset &amp;&amp; *text-&gt;charset)</span>
<a href="#l1.382"></a><span id="l1.382">         SetMailCharacterSetToMsgWindow(obj, text-&gt;charset);</span>
<a href="#l1.383"></a><span id="l1.383">     }</span>
<a href="#l1.384"></a><span id="l1.384"> </span>
<a href="#l1.385"></a><span id="l1.385" class="difflineminus">-    //if autodetect is on, push line to dam</span>
<a href="#l1.386"></a><span id="l1.386" class="difflineplus">+    // If autodetect is on, push line to dam.</span>
<a href="#l1.387"></a><span id="l1.387">     if (text-&gt;inputAutodetect)</span>
<a href="#l1.388"></a><span id="l1.388">     {</span>
<a href="#l1.389"></a><span id="l1.389" class="difflineminus">-      //see if we reach the lineDam buffer limit, if so, there is no need to keep buffering</span>
<a href="#l1.390"></a><span id="l1.390" class="difflineplus">+      // See if we reach the lineDam buffer limit, if so, there is no need to keep buffering.</span>
<a href="#l1.391"></a><span id="l1.391">       if (text-&gt;lastLineInDam &gt;= DAM_MAX_LINES ||</span>
<a href="#l1.392"></a><span id="l1.392">           DAM_MAX_BUFFER_SIZE - text-&gt;curDamOffset &lt;= length) {</span>
<a href="#l1.393"></a><span id="l1.393" class="difflineminus">-        //we let open dam process this line as well as thing that already in Dam</span>
<a href="#l1.394"></a><span id="l1.394" class="difflineminus">-        //In case there is nothing in dam because this line is too big, we need to</span>
<a href="#l1.395"></a><span id="l1.395" class="difflineminus">-        //perform autodetect on this line</span>
<a href="#l1.396"></a><span id="l1.396" class="difflineplus">+        // We let open dam process this line as well as thing that already in Dam.</span>
<a href="#l1.397"></a><span id="l1.397" class="difflineplus">+        // In case there is nothing in dam because this line is too big, we need to</span>
<a href="#l1.398"></a><span id="l1.398" class="difflineplus">+        // perform autodetect on this line.</span>
<a href="#l1.399"></a><span id="l1.399">         status = MimeInlineText_open_dam(line, length, obj);</span>
<a href="#l1.400"></a><span id="l1.400">       }</span>
<a href="#l1.401"></a><span id="l1.401">       else {</span>
<a href="#l1.402"></a><span id="l1.402" class="difflineminus">-        //buffering current line</span>
<a href="#l1.403"></a><span id="l1.403" class="difflineplus">+        // Buffering current line.</span>
<a href="#l1.404"></a><span id="l1.404">         text-&gt;lineDamPtrs[text-&gt;lastLineInDam] = text-&gt;lineDamBuffer + text-&gt;curDamOffset;</span>
<a href="#l1.405"></a><span id="l1.405">         memcpy(text-&gt;lineDamPtrs[text-&gt;lastLineInDam], line, length);</span>
<a href="#l1.406"></a><span id="l1.406">         text-&gt;lastLineInDam++;</span>
<a href="#l1.407"></a><span id="l1.407">         text-&gt;curDamOffset += length;</span>
<a href="#l1.408"></a><span id="l1.408">       }</span>
<a href="#l1.409"></a><span id="l1.409">     }</span>
<a href="#l1.410"></a><span id="l1.410">     else</span>
<a href="#l1.411"></a><span id="l1.411">       status = MimeInlineText_convert_and_parse_line(line, length, obj);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

