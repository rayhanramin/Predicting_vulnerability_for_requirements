<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 11493:a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb" />
<meta property="og:url" content="/comm-central/rev/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb" />
<meta property="og:description" content="Bug 80855 - Fix hostnameIsIllegal() to be more robust and sanitize values. Merge IP checking implementations in phishingDetector.js (Suite+TB). r=IanN, r=Neil, r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb">shortlog</a> |
<a href="/comm-central/log/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb">files</a> |
changeset |
<a href="/comm-central/raw-rev/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb">raw</a>  | <a href="/comm-central/archive/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=80855">Bug 80855</a> - Fix hostnameIsIllegal() to be more robust and sanitize values. Merge IP checking implementations in phishingDetector.js (Suite+TB). r=IanN, r=Neil, r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#97;&#99;&#101;&#109;&#97;&#110;&#32;&#60;&#97;&#99;&#101;&#108;&#105;&#115;&#116;&#115;&#64;&#97;&#116;&#108;&#97;&#115;&#46;&#115;&#107;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 11 Nov 2012 17:12:52 -0500</td></tr>

<tr>
 <td>changeset 11493</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb">a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb</a></td>
</tr>



<tr>
<td>parent 11492</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/84289543844fe601cf6dd6c89d78a30c83640946">84289543844fe601cf6dd6c89d78a30c83640946</a>
</td>
</tr>

<tr>
<td>child 11494</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/6e69635f3db8f3af27f04edbd0d5fc96f7b46439">6e69635f3db8f3af27f04edbd0d5fc96f7b46439</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb">8590</a></td></tr>
<tr><td>push user</td><td>ryanvm@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Sun, 11 Nov 2012 22:13:07 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a7b5def15d8c [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb&newProject=comm-central&newRevision=a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb&newProject=comm-central&newRevision=a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb&newProject=comm-central&newRevision=a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28IanN%29&revcount=50">IanN</a>, <a href="/comm-central/log?rev=reviewer%28Neil%29&revcount=50">Neil</a>, <a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=80855">80855</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=80855">Bug 80855</a> - Fix hostnameIsIllegal() to be more robust and sanitize values. Merge IP checking implementations in phishingDetector.js (Suite+TB). r=IanN, r=Neil, r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mail/base/content/phishingDetector.js">mail/base/content/phishingDetector.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mail/base/content/phishingDetector.js">file</a> |
<a href="/comm-central/annotate/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mail/base/content/phishingDetector.js">annotate</a> |
<a href="/comm-central/diff/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mail/base/content/phishingDetector.js">diff</a> |
<a href="/comm-central/comparison/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mail/base/content/phishingDetector.js">comparison</a> |
<a href="/comm-central/log/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mail/base/content/phishingDetector.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/AccountManager.js">mailnews/base/prefs/content/AccountManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/AccountManager.js">file</a> |
<a href="/comm-central/annotate/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/AccountManager.js">annotate</a> |
<a href="/comm-central/diff/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/AccountManager.js">diff</a> |
<a href="/comm-central/comparison/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/AccountManager.js">comparison</a> |
<a href="/comm-central/log/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/AccountManager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/SmtpServerEdit.js">mailnews/base/prefs/content/SmtpServerEdit.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/SmtpServerEdit.js">file</a> |
<a href="/comm-central/annotate/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/SmtpServerEdit.js">annotate</a> |
<a href="/comm-central/diff/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/SmtpServerEdit.js">diff</a> |
<a href="/comm-central/comparison/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/SmtpServerEdit.js">comparison</a> |
<a href="/comm-central/log/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/SmtpServerEdit.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/amUtils.js">mailnews/base/prefs/content/amUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/amUtils.js">file</a> |
<a href="/comm-central/annotate/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/amUtils.js">annotate</a> |
<a href="/comm-central/diff/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/amUtils.js">diff</a> |
<a href="/comm-central/comparison/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/amUtils.js">comparison</a> |
<a href="/comm-central/log/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/amUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/aw-identity.js">mailnews/base/prefs/content/aw-identity.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/aw-identity.js">file</a> |
<a href="/comm-central/annotate/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/aw-identity.js">annotate</a> |
<a href="/comm-central/diff/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/aw-identity.js">diff</a> |
<a href="/comm-central/comparison/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/aw-identity.js">comparison</a> |
<a href="/comm-central/log/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/aw-identity.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/aw-incoming.js">mailnews/base/prefs/content/aw-incoming.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/aw-incoming.js">file</a> |
<a href="/comm-central/annotate/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/aw-incoming.js">annotate</a> |
<a href="/comm-central/diff/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/aw-incoming.js">diff</a> |
<a href="/comm-central/comparison/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/aw-incoming.js">comparison</a> |
<a href="/comm-central/log/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/aw-incoming.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/aw-outgoing.js">mailnews/base/prefs/content/aw-outgoing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/aw-outgoing.js">file</a> |
<a href="/comm-central/annotate/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/aw-outgoing.js">annotate</a> |
<a href="/comm-central/diff/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/aw-outgoing.js">diff</a> |
<a href="/comm-central/comparison/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/aw-outgoing.js">comparison</a> |
<a href="/comm-central/log/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/aw-outgoing.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/smtpEditOverlay.js">mailnews/base/prefs/content/smtpEditOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/smtpEditOverlay.js">file</a> |
<a href="/comm-central/annotate/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/smtpEditOverlay.js">annotate</a> |
<a href="/comm-central/diff/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/smtpEditOverlay.js">diff</a> |
<a href="/comm-central/comparison/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/smtpEditOverlay.js">comparison</a> |
<a href="/comm-central/log/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/prefs/content/smtpEditOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/util/Makefile.in">mailnews/base/util/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/util/Makefile.in">file</a> |
<a href="/comm-central/annotate/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/util/Makefile.in">annotate</a> |
<a href="/comm-central/diff/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/util/Makefile.in">diff</a> |
<a href="/comm-central/comparison/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/util/Makefile.in">comparison</a> |
<a href="/comm-central/log/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/util/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/util/hostnameUtils.jsm">mailnews/base/util/hostnameUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/util/hostnameUtils.jsm">file</a> |
<a href="/comm-central/annotate/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/util/hostnameUtils.jsm">annotate</a> |
<a href="/comm-central/diff/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/util/hostnameUtils.jsm">diff</a> |
<a href="/comm-central/comparison/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/util/hostnameUtils.jsm">comparison</a> |
<a href="/comm-central/log/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/mailnews/base/util/hostnameUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/suite/mailnews/phishingDetector.js">suite/mailnews/phishingDetector.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/suite/mailnews/phishingDetector.js">file</a> |
<a href="/comm-central/annotate/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/suite/mailnews/phishingDetector.js">annotate</a> |
<a href="/comm-central/diff/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/suite/mailnews/phishingDetector.js">diff</a> |
<a href="/comm-central/comparison/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/suite/mailnews/phishingDetector.js">comparison</a> |
<a href="/comm-central/log/a7b5def15d8ca1ba6e3c044402d5885bf72ea9bb/suite/mailnews/phishingDetector.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/phishingDetector.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/phishingDetector.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -24,16 +24,18 @@ var gPhishingDetector = {</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5">   /**</span>
<a href="#l1.6"></a><span id="l1.6">    * initialize the phishing warden. </span>
<a href="#l1.7"></a><span id="l1.7">    * initialize the black and white list url tables. </span>
<a href="#l1.8"></a><span id="l1.8">    * update the local tables if necessary</span>
<a href="#l1.9"></a><span id="l1.9">    */</span>
<a href="#l1.10"></a><span id="l1.10">   init: function() </span>
<a href="#l1.11"></a><span id="l1.11">   {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+    Components.utils.import(&quot;resource:///modules/hostnameUtils.jsm&quot;, this);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+</span>
<a href="#l1.14"></a><span id="l1.14">     try {</span>
<a href="#l1.15"></a><span id="l1.15">       // set up the anti phishing service</span>
<a href="#l1.16"></a><span id="l1.16">       var appContext = Components.classes[&quot;@mozilla.org/phishingprotection/application;1&quot;]</span>
<a href="#l1.17"></a><span id="l1.17">                          .getService().wrappedJSObject;</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19">       this.mPhishingWarden  = new appContext.PROT_PhishingWarden();</span>
<a href="#l1.20"></a><span id="l1.20"> </span>
<a href="#l1.21"></a><span id="l1.21">       // Register tables</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -133,19 +135,19 @@ var gPhishingDetector = {</span>
<a href="#l1.23"></a><span id="l1.23">       if (aLinkText)</span>
<a href="#l1.24"></a><span id="l1.24">         aLinkText = aLinkText.replace(/^&lt;(.+)&gt;$|^&quot;(.+)&quot;$/, &quot;$1$2&quot;);</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26">       var failsStaticTests = false;</span>
<a href="#l1.27"></a><span id="l1.27">       if (aLinkText != aUrl)</span>
<a href="#l1.28"></a><span id="l1.28">       {</span>
<a href="#l1.29"></a><span id="l1.29">         if (this.mCheckForIPAddresses)</span>
<a href="#l1.30"></a><span id="l1.30">         {</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-          var unobscuredHostNameValue = this.hostNameIsIPAddress(hrefURL.host);</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+          let unobscuredHostNameValue = this.isLegalIPAddress(hrefURL.host, true);</span>
<a href="#l1.33"></a><span id="l1.33">           if (unobscuredHostNameValue)</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-            failsStaticTests = !this.isLocalIPAddress(unobscuredHostNameValue);</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+            failsStaticTests = !this.isLegalLocalIPAddress(unobscuredHostNameValue);</span>
<a href="#l1.36"></a><span id="l1.36">         }</span>
<a href="#l1.37"></a><span id="l1.37"> </span>
<a href="#l1.38"></a><span id="l1.38">         if (!failsStaticTests &amp;&amp; this.mCheckForMismatchedHosts)</span>
<a href="#l1.39"></a><span id="l1.39">         {</span>
<a href="#l1.40"></a><span id="l1.40">           failsStaticTests = (aLinkText &amp;&amp;</span>
<a href="#l1.41"></a><span id="l1.41">             this.misMatchedHostWithLinkText(hrefURL, aLinkText, linkTextURL))</span>
<a href="#l1.42"></a><span id="l1.42">         }</span>
<a href="#l1.43"></a><span id="l1.43">       }</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineat">@@ -233,200 +235,16 @@ var gPhishingDetector = {</span>
<a href="#l1.45"></a><span id="l1.45">          return !(aHrefURL.host.replace(/^www\./, &quot;&quot;) == aLinkTextURL.value.host.replace(/^www\./, &quot;&quot;));</span>
<a href="#l1.46"></a><span id="l1.46">        }</span>
<a href="#l1.47"></a><span id="l1.47">     }</span>
<a href="#l1.48"></a><span id="l1.48"> </span>
<a href="#l1.49"></a><span id="l1.49">     return false;</span>
<a href="#l1.50"></a><span id="l1.50">   },</span>
<a href="#l1.51"></a><span id="l1.51"> </span>
<a href="#l1.52"></a><span id="l1.52">   /**</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-   * Helper method to determine if aHostName is an IP address.</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-   * @return the unobscured host name (if there is one)</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-   */</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-  hostNameIsIPAddress: function(aHostName)</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-  {</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-    return this.isIPv4HostName(aHostName) || this.isIPv6HostName(aHostName);</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-  },</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-  /**</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-   * Check if a host name is an IPv4 host name.</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-   * @return Unobscured host name if aHostName is an IPv4 address.</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-   *         Returns false if it's not.</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineminus">-   */</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-  isIPv4HostName: function(aHostName)</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-  {</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-    // Scammers frequently obscure the IP address by encoding each component as</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-    // octal, hex or in some cases a mix match of each. The IP address could</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineminus">-    // also be represented as a DWORD.</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineminus">-</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineminus">-    // Break the IP address down into individual components.</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">-    var ipComponents = aHostName.split(&quot;.&quot;);</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineminus">-</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineminus">-    if (ipComponents.length == 4)</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineminus">-    {</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">-      for (var i = 0; i &lt; ipComponents.length; i++)</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-      {</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-        // By leaving the radix parameter blank, we can handle IP addresses</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-        // where one component is hex, another is octal, etc.</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-        ipComponents[i] = parseInt(ipComponents[i]);</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineminus">-      }</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineminus">-    }</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">-    else</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineminus">-    {</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-      // Convert to a binary to test for possible DWORD.</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineminus">-      var binaryDword = parseInt(aHostName).toString(2);</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-      if (isNaN(binaryDword))</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineminus">-        return false;</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineminus">-</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineminus">-      // convert the dword into its component IP parts.</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineminus">-      ipComponents = new Array;</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineminus">-      ipComponents[0] = (aHostName &gt;&gt; 24) &amp; 255;</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineminus">-      ipComponents[1] = (aHostName &gt;&gt; 16) &amp; 255;</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineminus">-      ipComponents[2] = (aHostName &gt;&gt;  8) &amp; 255;</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineminus">-      ipComponents[3] = (aHostName &amp; 255);</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineminus">-    }</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineminus">-</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineminus">-    // Make sure each part of the IP address is in fact a number, and that</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineminus">-    // each part isn't larger than 255.</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">-    for (var i = 0; i &lt; ipComponents.length; i++)</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineminus">-    {</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineminus">-      // If any part of the IP address is not a number, or longer than 255,</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineminus">-      // then we can safely return.</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineminus">-      if (isNaN(ipComponents[i]) || ipComponents[i] &gt; 255)</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineminus">-        return false;</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineminus">-    }</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineminus">-</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineminus">-    var hostName = ipComponents.join(&quot;.&quot;);</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineminus">-    // Treat 0.0.0.0 as an invalid IPv4 address.</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineminus">-    return (hostName != &quot;0.0.0.0&quot;) ? hostName : false;</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineminus">-  },</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineminus">-</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineminus">-  /**</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineminus">-   * Check if the given host name is an IPv6 address.</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineminus">-   * @return the full IPv6 address if aHostName is an IPv6 address.</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineminus">-   */</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineminus">-  isIPv6HostName: function(aHostName) {</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineminus">-    // Break the IP address down into individual components.</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineminus">-    var ipComponents = aHostName.split(&quot;:&quot;);</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineminus">-</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineminus">-    // Make sure there are at least 3 components.</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineminus">-    if (ipComponents.length &lt; 3)</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineminus">-      return false;</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineminus">-</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineminus">-    // Take care if the last part is written in decimal using dots as separators.</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineminus">-    var lastPart = ipComponents[ipComponents.length - 1];</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineminus">-    if (lastPart)</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineminus">-    {</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineminus">-      var lastPartComponents = lastPart.split(&quot;.&quot;);</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineminus">-      if (lastPartComponents.length == 4)</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineminus">-      {</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineminus">-        // Make sure each part is a number and not larger then 0xff.</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineminus">-        for (var i = 0; i &lt; lastPartComponents.length; i++)</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineminus">-        {</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineminus">-          lastPartComponents[i] = parseInt(lastPartComponents[i]);</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineminus">-          if (isNaN(lastPartComponents[i]) || lastPartComponents[i] &gt; 0xff)</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-            return false;</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineminus">-        }</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineminus">-</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineminus">-        // Convert it into standard IPv6 components.</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineminus">-        ipComponents[ipComponents.length - 1] =</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineminus">-          ((lastPartComponents[0] &lt;&lt; 8) | lastPartComponents[1]).toString(16);</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineminus">-        ipComponents[ipComponents.length] =</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineminus">-          ((lastPartComponents[2] &lt;&lt; 8) | lastPartComponents[3]).toString(16);</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineminus">-      }</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineminus">-    }</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineminus">-</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineminus">-    // Make sure that there is only one empty component.</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineminus">-    var emptyIndex;</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineminus">-    for (var i = 1; i &lt; ipComponents.length - 1; i++)</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineminus">-    {</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineminus">-      if (ipComponents[i] == &quot;&quot;)</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineminus">-      {</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineminus">-        // If we already found an empty component return false.</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineminus">-        if (emptyIndex)</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineminus">-          return false;</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineminus">-</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineminus">-        emptyIndex = i;</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineminus">-      }</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineminus">-    }</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineminus">-</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineminus">-    // If we found an empty component, extend it.</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineminus">-    if (emptyIndex)</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineminus">-    {</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineminus">-      ipComponents[emptyIndex] = 0;</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineminus">-</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineminus">-      // Add components so we have a total of 8.</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineminus">-      for (var count = ipComponents.length; count &lt; 8; count++)</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineminus">-        ipComponents.splice(emptyIndex, 0, 0);</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineminus">-    }</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineminus">-</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineminus">-    // Make sure there are 8 components.</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineminus">-    if (ipComponents.length != 8)</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineminus">-      return false;</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineminus">-</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineminus">-    // Format all components to 4 character hex value.</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineminus">-    for (var i = 0; i &lt; ipComponents.length; i++)</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineminus">-    {</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineminus">-      if (ipComponents[i] == &quot;&quot;)</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineminus">-        ipComponents[i] = 0;</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineminus">-      // Make sure the component is a number and it isn't larger then 0xffff.</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineminus">-      ipComponents[i] = parseInt(ipComponents[i], 16);</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineminus">-      if (isNaN(ipComponents[i]) || ipComponents[i] &gt; 0xffff)</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineminus">-        return false;</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineminus">-</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineminus">-      // Pad the component with 0:s.</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-      ipComponents[i] = (&quot;0000&quot;+ ipComponents[i].toString(16)).substr(-4);</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineminus">-    }</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineminus">-</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineminus">-    var hostName = ipComponents.join(&quot;:&quot;);</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineminus">-    // Treat 0000:0000:0000:0000:0000:0000:0000:0000 as an invalid IPv6 address.</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineminus">-    return (hostName != &quot;0000:0000:0000:0000:0000:0000:0000:0000&quot;) ?</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineminus">-              hostName : false;</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineminus">-  },</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineminus">-</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineminus">-  /**</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineminus">-   * Check if the given host name is a local IP address.</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineminus">-   * @return true if unobscuredHostName is a local IP address.</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineminus">-   */</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineminus">-  isLocalIPAddress: function(unobscuredHostNameValue)</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineminus">-  {</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineminus">-    var ipComponents = unobscuredHostNameValue.split(&quot;.&quot;);</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineminus">-    if (ipComponents.length == 4)</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineminus">-    {</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineminus">-       // Check if it's a local IPv4 address.</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineminus">-      return ipComponents[0] == 10 ||</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineminus">-            ipComponents[0] == 127 || // loopback address</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineminus">-            (ipComponents[0] == 192 &amp;&amp; ipComponents[1] == 168) ||</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineminus">-            (ipComponents[0] == 169 &amp;&amp; ipComponents[1] == 254) ||</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineminus">-            (ipComponents[0] == 172 &amp;&amp; ipComponents[1] &gt;= 16 &amp;&amp; ipComponents[1] &lt; 32);</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineminus">-    }</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineminus">-</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineminus">-    // IPv6 address?</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineminus">-    ipComponents = unobscuredHostNameValue.split(&quot;:&quot;);</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineminus">-    if (ipComponents.length == 8)</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineminus">-    {</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineminus">-      // ::1/128 - localhost</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineminus">-      if (ipComponents[0] == &quot;0000&quot; &amp;&amp; ipComponents[1] == &quot;0000&quot; &amp;&amp;</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineminus">-          ipComponents[2] == &quot;0000&quot; &amp;&amp; ipComponents[3] == &quot;0000&quot; &amp;&amp;</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineminus">-          ipComponents[4] == &quot;0000&quot; &amp;&amp; ipComponents[5] == &quot;0000&quot; &amp;&amp;</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineminus">-          ipComponents[6] == &quot;0000&quot; &amp;&amp; ipComponents[7] == &quot;0001&quot;)</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineminus">-        return true;</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineminus">-</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineminus">-      // fe80::/10 - link local addresses</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineminus">-      if (ipComponents[0] == &quot;fe80&quot;)</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineminus">-        return true;</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineminus">-</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineminus">-      // TODO: also detect fc00::/7 - unique local addresses</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineminus">-</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineminus">-      return false;</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineminus">-    }</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineminus">-    return false;</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineminus">-  },</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineminus">-</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineminus">-  /** </span>
<a href="#l1.237"></a><span id="l1.237">    * If the current message has been identified as an email scam, prompts the user with a warning</span>
<a href="#l1.238"></a><span id="l1.238">    * before allowing the link click to be processed. The warning prompt includes the unobscured host name</span>
<a href="#l1.239"></a><span id="l1.239">    * of the http(s) url the user clicked on.</span>
<a href="#l1.240"></a><span id="l1.240">    *</span>
<a href="#l1.241"></a><span id="l1.241">    * @param aUrl the url </span>
<a href="#l1.242"></a><span id="l1.242">    * @return true if the link should be allowed to load</span>
<a href="#l1.243"></a><span id="l1.243">    */</span>
<a href="#l1.244"></a><span id="l1.244">   warnOnSuspiciousLinkClick: function(aUrl)</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineat">@@ -442,17 +260,17 @@ var gPhishingDetector = {</span>
<a href="#l1.246"></a><span id="l1.246">     try {</span>
<a href="#l1.247"></a><span id="l1.247">       hrefURL = ioService.newURI(aUrl, null, null);</span>
<a href="#l1.248"></a><span id="l1.248">     } catch(ex) { return false; }</span>
<a href="#l1.249"></a><span id="l1.249"> </span>
<a href="#l1.250"></a><span id="l1.250">     // only prompt for http and https urls</span>
<a href="#l1.251"></a><span id="l1.251">     if (hrefURL.schemeIs('http') || hrefURL.schemeIs('https'))</span>
<a href="#l1.252"></a><span id="l1.252">     {</span>
<a href="#l1.253"></a><span id="l1.253">       // unobscure the host name in case it's an encoded ip address..</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineminus">-      var unobscuredHostNameValue = this.hostNameIsIPAddress(hrefURL.host)</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineplus">+      let unobscuredHostNameValue = this.isLegalIPAddress(hrefURL.host, true)</span>
<a href="#l1.256"></a><span id="l1.256">         || hrefURL.host;</span>
<a href="#l1.257"></a><span id="l1.257"> </span>
<a href="#l1.258"></a><span id="l1.258">       var brandShortName = document.getElementById(&quot;bundle_brand&quot;)</span>
<a href="#l1.259"></a><span id="l1.259">                                    .getString(&quot;brandShortName&quot;);</span>
<a href="#l1.260"></a><span id="l1.260">       var bundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l1.261"></a><span id="l1.261">       var titleMsg = bundle.getString(&quot;confirmPhishingTitle&quot;);</span>
<a href="#l1.262"></a><span id="l1.262">       var dialogMsg = bundle.getFormattedString(&quot;confirmPhishingUrl&quot;, </span>
<a href="#l1.263"></a><span id="l1.263">                         [brandShortName, unobscuredHostNameValue], 2);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/prefs/content/AccountManager.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/prefs/content/AccountManager.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -25,17 +25,16 @@</span>
<a href="#l2.4"></a><span id="l2.4">  *   on values set in the previous step.</span>
<a href="#l2.5"></a><span id="l2.5">  */</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> Components.utils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l2.8"></a><span id="l2.8"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l2.9"></a><span id="l2.9"> Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l2.10"></a><span id="l2.10"> Components.utils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-var gSmtpHostNameIsIllegal = false;</span>
<a href="#l2.13"></a><span id="l2.13"> // If Local directory has changed the app needs to restart. Once this is set</span>
<a href="#l2.14"></a><span id="l2.14"> // a restart will be attempted at each attempt to close the Account manager with OK.</span>
<a href="#l2.15"></a><span id="l2.15"> var gRestartNeeded = false;</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> // This is a hash-map for every account we've touched in the pane. Each entry</span>
<a href="#l2.18"></a><span id="l2.18"> // has additional maps of attribute-value pairs that we're going to want to save</span>
<a href="#l2.19"></a><span id="l2.19"> // when the user hits OK.</span>
<a href="#l2.20"></a><span id="l2.20"> var accountArray;</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineat">@@ -203,21 +202,16 @@ function replaceWithDefaultSmtpServer(de</span>
<a href="#l2.22"></a><span id="l2.22">  *                   were already done elsewhere and proceed directly to saving</span>
<a href="#l2.23"></a><span id="l2.23">  *                   the data.</span>
<a href="#l2.24"></a><span id="l2.24">  */</span>
<a href="#l2.25"></a><span id="l2.25"> function onAccept(aDoChecks) {</span>
<a href="#l2.26"></a><span id="l2.26">   if (aDoChecks) {</span>
<a href="#l2.27"></a><span id="l2.27">     // Check if user/host have been modified correctly.</span>
<a href="#l2.28"></a><span id="l2.28">     if (!checkUserServerChanges(true))</span>
<a href="#l2.29"></a><span id="l2.29">       return false;</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-    if (gSmtpHostNameIsIllegal) {</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-      gSmtpHostNameIsIllegal = false;</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-      return false;</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-    }</span>
<a href="#l2.35"></a><span id="l2.35">   }</span>
<a href="#l2.36"></a><span id="l2.36"> </span>
<a href="#l2.37"></a><span id="l2.37">   if (!onSave())</span>
<a href="#l2.38"></a><span id="l2.38">     return false;</span>
<a href="#l2.39"></a><span id="l2.39"> </span>
<a href="#l2.40"></a><span id="l2.40">   // hack hack - save the prefs file NOW in case we crash</span>
<a href="#l2.41"></a><span id="l2.41">   Services.prefs.savePrefFile(null);</span>
<a href="#l2.42"></a><span id="l2.42"> </span>
<a href="#l2.43"></a><span id="l2.43" class="difflineat">@@ -330,28 +324,16 @@ function checkDirectoryIsUsable(aLocalPa</span>
<a href="#l2.44"></a><span id="l2.44">  * Also check if the Local Directory path was changed.</span>
<a href="#l2.45"></a><span id="l2.45">  *</span>
<a href="#l2.46"></a><span id="l2.46">  * @param showAlert  show and alert if a problem with the host / user name is found</span>
<a href="#l2.47"></a><span id="l2.47">  */</span>
<a href="#l2.48"></a><span id="l2.48"> function checkUserServerChanges(showAlert) {</span>
<a href="#l2.49"></a><span id="l2.49">   const prefBundle = document.getElementById(&quot;bundle_prefs&quot;);</span>
<a href="#l2.50"></a><span id="l2.50">   const alertTitle = prefBundle.getString(&quot;prefPanel-server&quot;);</span>
<a href="#l2.51"></a><span id="l2.51">   var alertText = null;</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-  if (MailServices.smtp.defaultServer) {</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-    try {</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-      var smtpHostName = top.frames[&quot;contentFrame&quot;]</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-                            .document.getElementById(&quot;smtp.hostname&quot;);</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-      if (smtpHostName &amp;&amp; hostnameIsIllegal(smtpHostName.value)) {</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-        alertText = prefBundle.getString(&quot;enterValidHostname&quot;);</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-        Services.prompt.alert(window, alertTitle, alertText);</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-        gSmtpHostNameIsIllegal = true;</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-      }</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-    }</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-    catch (ex) {}</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-  }</span>
<a href="#l2.64"></a><span id="l2.64"> </span>
<a href="#l2.65"></a><span id="l2.65">   var accountValues = getValueArrayFor(currentAccount);</span>
<a href="#l2.66"></a><span id="l2.66">   if (!accountValues)</span>
<a href="#l2.67"></a><span id="l2.67">     return true;</span>
<a href="#l2.68"></a><span id="l2.68"> </span>
<a href="#l2.69"></a><span id="l2.69">   var pageElements = getPageFormElements();</span>
<a href="#l2.70"></a><span id="l2.70">   if (!pageElements)</span>
<a href="#l2.71"></a><span id="l2.71">     return true;</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineat">@@ -855,22 +837,16 @@ function onAccountTreeSelect(pageId, acc</span>
<a href="#l2.73"></a><span id="l2.73">   if (document.getElementById(&quot;contentFrame&quot;).contentDocument.getElementById(&quot;server.localPath&quot;)) {</span>
<a href="#l2.74"></a><span id="l2.74">     // Check if user/host names have been changed or the Local Directory is invalid.</span>
<a href="#l2.75"></a><span id="l2.75">     if (!checkUserServerChanges(false)) {</span>
<a href="#l2.76"></a><span id="l2.76">       changeView = true;</span>
<a href="#l2.77"></a><span id="l2.77">       account = currentAccount;</span>
<a href="#l2.78"></a><span id="l2.78">       pageId = currentPageId;</span>
<a href="#l2.79"></a><span id="l2.79">     }</span>
<a href="#l2.80"></a><span id="l2.80"> </span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-    if (gSmtpHostNameIsIllegal) {</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-      gSmtpHostNameIsIllegal = false;</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-      selectServer(currentAccount.incomingServer, currentPageId);</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-      return true;</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-    }</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-</span>
<a href="#l2.87"></a><span id="l2.87">     if (gRestartNeeded)</span>
<a href="#l2.88"></a><span id="l2.88">       onAccept(false);</span>
<a href="#l2.89"></a><span id="l2.89">   }</span>
<a href="#l2.90"></a><span id="l2.90">   // save the previous page</span>
<a href="#l2.91"></a><span id="l2.91">   savePage(currentAccount);</span>
<a href="#l2.92"></a><span id="l2.92"> </span>
<a href="#l2.93"></a><span id="l2.93">   let changeAccount = (account != currentAccount);</span>
<a href="#l2.94"></a><span id="l2.94"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/prefs/content/SmtpServerEdit.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/prefs/content/SmtpServerEdit.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,27 +1,28 @@</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineminus">-/* -*- Mode: Java; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l3.6"></a><span id="l3.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.7"></a><span id="l3.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.8"></a><span id="l3.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+Components.utils.import(&quot;resource:///modules/hostnameUtils.jsm&quot;);</span>
<a href="#l3.11"></a><span id="l3.11"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l3.12"></a><span id="l3.12"> Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l3.13"></a><span id="l3.13"> </span>
<a href="#l3.14"></a><span id="l3.14"> let gSmtpServer;</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16"> function onLoad(event)</span>
<a href="#l3.17"></a><span id="l3.17"> {</span>
<a href="#l3.18"></a><span id="l3.18">   gSmtpServer = window.arguments[0].server;</span>
<a href="#l3.19"></a><span id="l3.19">   initSmtpSettings(gSmtpServer);</span>
<a href="#l3.20"></a><span id="l3.20"> }</span>
<a href="#l3.21"></a><span id="l3.21"> </span>
<a href="#l3.22"></a><span id="l3.22"> function onAccept()</span>
<a href="#l3.23"></a><span id="l3.23"> {</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-  if (hostnameIsIllegal(gSmtpHostname.value)) {</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+  if (!isLegalHostNameOrIP(cleanUpHostname(gSmtpHostname.value))) {</span>
<a href="#l3.26"></a><span id="l3.26">     let prefsBundle = document.getElementById(&quot;bundle_prefs&quot;);</span>
<a href="#l3.27"></a><span id="l3.27">     let brandBundle = document.getElementById(&quot;bundle_brand&quot;);</span>
<a href="#l3.28"></a><span id="l3.28">     let alertTitle = brandBundle.getString(&quot;brandShortName&quot;);</span>
<a href="#l3.29"></a><span id="l3.29">     let alertMsg = prefsBundle.getString(&quot;enterValidServerName&quot;);</span>
<a href="#l3.30"></a><span id="l3.30">     Services.prompt.alert(window, alertTitle, alertMsg);</span>
<a href="#l3.31"></a><span id="l3.31"> </span>
<a href="#l3.32"></a><span id="l3.32">     window.arguments[0].result = false;</span>
<a href="#l3.33"></a><span id="l3.33">     return false;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/prefs/content/amUtils.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/prefs/content/amUtils.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l4.5"></a><span id="l4.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.6"></a><span id="l4.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.7"></a><span id="l4.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+Components.utils.import(&quot;resource:///modules/hostnameUtils.jsm&quot;);</span>
<a href="#l4.10"></a><span id="l4.10"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.11"></a><span id="l4.11"> Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l4.12"></a><span id="l4.12"> </span>
<a href="#l4.13"></a><span id="l4.13"> function BrowseForLocalFolders()</span>
<a href="#l4.14"></a><span id="l4.14"> {</span>
<a href="#l4.15"></a><span id="l4.15">   const nsIFilePicker = Components.interfaces.nsIFilePicker;</span>
<a href="#l4.16"></a><span id="l4.16">   const nsILocalFile = Components.interfaces.nsILocalFile;</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18" class="difflineat">@@ -33,35 +34,16 @@ function BrowseForLocalFolders()</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20">   // Check if the folder can be used for mail storage.</span>
<a href="#l4.21"></a><span id="l4.21">   if (!top.checkDirectoryIsUsable(selectedFolder))</span>
<a href="#l4.22"></a><span id="l4.22">     return;</span>
<a href="#l4.23"></a><span id="l4.23"> </span>
<a href="#l4.24"></a><span id="l4.24">   currentFolderTextBox.value = selectedFolder.path;</span>
<a href="#l4.25"></a><span id="l4.25"> }</span>
<a href="#l4.26"></a><span id="l4.26"> </span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-function hostnameIsIllegal(hostname)</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-{</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-  // XXX TODO do a complete check.</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-  // this only checks for illegal characters in the hostname</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-  // but hostnames like &quot;....&quot; and &quot;_&quot; and &quot;.111&quot; will get by</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-  // my test.  </span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-  var validChars = hostname.match(/[A-Za-z0-9.-]/g);</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-  if (!validChars || (validChars.length != hostname.length)) {</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-    return true;</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-  }</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-  return false;</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-}</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-function trim(string)</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-{</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-  return string.trim();</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-}</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-</span>
<a href="#l4.46"></a><span id="l4.46"> /**</span>
<a href="#l4.47"></a><span id="l4.47">  * Return server/folder name formatted with server name if needed.</span>
<a href="#l4.48"></a><span id="l4.48">  *</span>
<a href="#l4.49"></a><span id="l4.49">  * @param aTargetFolder  nsIMsgFolder to format name for</span>
<a href="#l4.50"></a><span id="l4.50">  *                       If target.isServer then only its name is returned.</span>
<a href="#l4.51"></a><span id="l4.51">  *                       Otherwise return the name as &quot;&lt;foldername&gt; on &lt;servername&gt;&quot;.</span>
<a href="#l4.52"></a><span id="l4.52">  */</span>
<a href="#l4.53"></a><span id="l4.53"> function prettyFolderName(aTargetFolder)</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineat">@@ -143,8 +125,20 @@ function openPrefsFromAccountManager(aTB</span>
<a href="#l4.55"></a><span id="l4.55"> </span>
<a href="#l4.56"></a><span id="l4.56">   // If openOptionsDialog() exists, we are in Thunderbird.</span>
<a href="#l4.57"></a><span id="l4.57">   if (typeof win.openOptionsDialog == &quot;function&quot;)</span>
<a href="#l4.58"></a><span id="l4.58">     win.openOptionsDialog(aTBPaneId, aTBTabId, aTBOtherArgs);</span>
<a href="#l4.59"></a><span id="l4.59">   // If goPreferences() exists, we are in Seamonkey.</span>
<a href="#l4.60"></a><span id="l4.60">   if (typeof win.goPreferences == &quot;function&quot;)</span>
<a href="#l4.61"></a><span id="l4.61">     win.goPreferences(aSMPaneId);</span>
<a href="#l4.62"></a><span id="l4.62"> }</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+/**</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+ * Clean up the hostname or IP.</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+ *</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+ * @param aHostName  The hostname or IP string to clean up.</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+ */</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+function cleanUpHostname(aHostName)</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+{</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+  // TODO: Bug 235312: if UTF8 string was input, convert to punycode using convertUTF8toACE()</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+  // but bug 563172 needs resolving first.</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+  return aHostName.trim();</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/prefs/content/aw-identity.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/prefs/content/aw-identity.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -5,17 +5,17 @@</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5"> var gCurrentDomain;</span>
<a href="#l5.6"></a><span id="l5.6"> var gPrefsBundle;</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> function identityPageValidate()</span>
<a href="#l5.9"></a><span id="l5.9"> {</span>
<a href="#l5.10"></a><span id="l5.10">   var canAdvance = false;</span>
<a href="#l5.11"></a><span id="l5.11">   var name = document.getElementById(&quot;fullName&quot;).value;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  var email = trim(document.getElementById(&quot;email&quot;).value);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  let email = document.getElementById(&quot;email&quot;).value.trim();</span>
<a href="#l5.14"></a><span id="l5.14"> </span>
<a href="#l5.15"></a><span id="l5.15">   if (name &amp;&amp; email) {</span>
<a href="#l5.16"></a><span id="l5.16">     canAdvance = gCurrentDomain ? emailNameIsLegal(email) : emailNameAndDomainAreLegal(email);</span>
<a href="#l5.17"></a><span id="l5.17"> </span>
<a href="#l5.18"></a><span id="l5.18">     if (gCurrentDomain &amp;&amp; canAdvance) {</span>
<a href="#l5.19"></a><span id="l5.19">       // For prefilled ISP data we must check if the account already exists as</span>
<a href="#l5.20"></a><span id="l5.20">       // there is no second chance. The email is the username since the user</span>
<a href="#l5.21"></a><span id="l5.21">       // fills in [______]@example.com.</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -31,17 +31,17 @@ function identityPageValidate()</span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24">   document.documentElement.canAdvance = canAdvance;</span>
<a href="#l5.25"></a><span id="l5.25"> }</span>
<a href="#l5.26"></a><span id="l5.26"> </span>
<a href="#l5.27"></a><span id="l5.27"> function identityPageUnload()</span>
<a href="#l5.28"></a><span id="l5.28"> {</span>
<a href="#l5.29"></a><span id="l5.29">   var pageData = parent.GetPageData();</span>
<a href="#l5.30"></a><span id="l5.30">   var name = document.getElementById(&quot;fullName&quot;).value;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-  var email = trim(document.getElementById(&quot;email&quot;).value);</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+  let email = document.getElementById(&quot;email&quot;).value.trim();</span>
<a href="#l5.33"></a><span id="l5.33">   setPageData(pageData, &quot;identity&quot;, &quot;fullName&quot;, name);</span>
<a href="#l5.34"></a><span id="l5.34">   setPageData(pageData, &quot;identity&quot;, &quot;email&quot;, email);</span>
<a href="#l5.35"></a><span id="l5.35"> </span>
<a href="#l5.36"></a><span id="l5.36">   return true;</span>
<a href="#l5.37"></a><span id="l5.37"> }</span>
<a href="#l5.38"></a><span id="l5.38"> </span>
<a href="#l5.39"></a><span id="l5.39"> // This is for the case when the code appends the domain  </span>
<a href="#l5.40"></a><span id="l5.40"> // unnecessarily.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/prefs/content/aw-incoming.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/prefs/content/aw-incoming.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,42 +1,35 @@</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l6.6"></a><span id="l6.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.7"></a><span id="l6.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.8"></a><span id="l6.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+Components.utils.import(&quot;resource:///modules/hostnameUtils.jsm&quot;);</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+</span>
<a href="#l6.12"></a><span id="l6.12"> var gOnMailServersPage;</span>
<a href="#l6.13"></a><span id="l6.13"> var gOnNewsServerPage;</span>
<a href="#l6.14"></a><span id="l6.14"> var gHideIncoming;</span>
<a href="#l6.15"></a><span id="l6.15"> var gProtocolInfo = null;</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-function hostnameIsIllegal(hostname)</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-{</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-  // XXX TODO do a complete check.</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-  // this only checks for illegal characters in the hostname</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-  // but hostnames like &quot;....&quot; and &quot;_&quot; and &quot;.111&quot; will get by</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-  // my test.  </span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-  hostname = trim(hostname);</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-  return !hostname || /[^A-Za-z0-9.-]/.test(hostname);</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-}</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-</span>
<a href="#l6.27"></a><span id="l6.27"> function incomingPageValidate()</span>
<a href="#l6.28"></a><span id="l6.28"> {</span>
<a href="#l6.29"></a><span id="l6.29">   var canAdvance = true;</span>
<a href="#l6.30"></a><span id="l6.30"> </span>
<a href="#l6.31"></a><span id="l6.31">   if (gOnMailServersPage) {</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-    var incomingServerName = document.getElementById(&quot;incomingServer&quot;).value;</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-    if (!gHideIncoming &amp;&amp; hostnameIsIllegal(incomingServerName))</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+    let incomingServerName = document.getElementById(&quot;incomingServer&quot;).value;</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+    if (!gHideIncoming &amp;&amp; !isLegalHostNameOrIP(cleanUpHostname(incomingServerName)))</span>
<a href="#l6.36"></a><span id="l6.36">       canAdvance = false;</span>
<a href="#l6.37"></a><span id="l6.37">   }</span>
<a href="#l6.38"></a><span id="l6.38">   if (gOnNewsServerPage) {</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-    var newsServerName = document.getElementById(&quot;newsServer&quot;).value;</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-    if (hostnameIsIllegal(newsServerName))</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+    let newsServerName = document.getElementById(&quot;newsServer&quot;).value;</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+    if (!isLegalHostNameOrIP(cleanUpHostname(newsServerName)))</span>
<a href="#l6.43"></a><span id="l6.43">       canAdvance = false;</span>
<a href="#l6.44"></a><span id="l6.44">   }</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+</span>
<a href="#l6.46"></a><span id="l6.46">   if (canAdvance) {</span>
<a href="#l6.47"></a><span id="l6.47">     var pageData = parent.GetPageData();</span>
<a href="#l6.48"></a><span id="l6.48">     var serverType = parent.getCurrentServerType(pageData);</span>
<a href="#l6.49"></a><span id="l6.49">     var hostName;</span>
<a href="#l6.50"></a><span id="l6.50">     if (gOnMailServersPage)</span>
<a href="#l6.51"></a><span id="l6.51">       hostName = incomingServerName;</span>
<a href="#l6.52"></a><span id="l6.52">     else if (gOnNewsServerPage)</span>
<a href="#l6.53"></a><span id="l6.53">       hostName = newsServerName;</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineat">@@ -54,26 +47,26 @@ function incomingPageUnload()</span>
<a href="#l6.55"></a><span id="l6.55"> {</span>
<a href="#l6.56"></a><span id="l6.56">   var pageData = parent.GetPageData();</span>
<a href="#l6.57"></a><span id="l6.57"> </span>
<a href="#l6.58"></a><span id="l6.58">   if (gOnMailServersPage) {</span>
<a href="#l6.59"></a><span id="l6.59">     // If we have hidden the incoming server dialogs, we don't want</span>
<a href="#l6.60"></a><span id="l6.60">     // to set the server to an empty value here</span>
<a href="#l6.61"></a><span id="l6.61">     if (!gHideIncoming) {</span>
<a href="#l6.62"></a><span id="l6.62">       var incomingServerName = document.getElementById(&quot;incomingServer&quot;);</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-      setPageData(pageData, &quot;server&quot;, &quot;hostname&quot;, trim(incomingServerName.value));</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+      setPageData(pageData, &quot;server&quot;, &quot;hostname&quot;, cleanUpHostname(incomingServerName.value));</span>
<a href="#l6.65"></a><span id="l6.65">     }</span>
<a href="#l6.66"></a><span id="l6.66">     var serverport = document.getElementById(&quot;serverPort&quot;).value;</span>
<a href="#l6.67"></a><span id="l6.67">     setPageData(pageData, &quot;server&quot;, &quot;port&quot;, serverport);</span>
<a href="#l6.68"></a><span id="l6.68">     var username = document.getElementById(&quot;username&quot;).value;</span>
<a href="#l6.69"></a><span id="l6.69">     setPageData(pageData, &quot;login&quot;, &quot;username&quot;, username);</span>
<a href="#l6.70"></a><span id="l6.70">   }</span>
<a href="#l6.71"></a><span id="l6.71">   else if (gOnNewsServerPage) {</span>
<a href="#l6.72"></a><span id="l6.72">     var newsServerName = document.getElementById(&quot;newsServer&quot;);</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-    setPageData(pageData, &quot;newsserver&quot;, &quot;hostname&quot;, trim(newsServerName.value));</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+    setPageData(pageData, &quot;newsserver&quot;, &quot;hostname&quot;, cleanUpHostname(newsServerName.value));</span>
<a href="#l6.75"></a><span id="l6.75">   }</span>
<a href="#l6.76"></a><span id="l6.76"> </span>
<a href="#l6.77"></a><span id="l6.77">   return true;</span>
<a href="#l6.78"></a><span id="l6.78"> }</span>
<a href="#l6.79"></a><span id="l6.79"> </span>
<a href="#l6.80"></a><span id="l6.80"> function incomingPageInit() {</span>
<a href="#l6.81"></a><span id="l6.81">   gOnMailServersPage = (document.documentElement.currentPage.id == &quot;incomingpage&quot;);</span>
<a href="#l6.82"></a><span id="l6.82">   gOnNewsServerPage = (document.documentElement.currentPage.id == &quot;newsserver&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/prefs/content/aw-outgoing.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/prefs/content/aw-outgoing.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,32 +1,34 @@</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineminus">-/* -*- Mode: Java; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l7.6"></a><span id="l7.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.7"></a><span id="l7.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.8"></a><span id="l7.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.9"></a><span id="l7.9"> </span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+Components.utils.import(&quot;resource:///modules/hostnameUtils.jsm&quot;);</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+</span>
<a href="#l7.12"></a><span id="l7.12"> var gProtocolInfo = null;</span>
<a href="#l7.13"></a><span id="l7.13"> var gPrefsBundle;</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15"> function outgoingPageValidate() {</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-  var canAdvance = true;</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+  let canAdvance = true;</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-  var smtpserver = document.getElementById(&quot;smtphostname&quot;).value;</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-  var usingDefaultSMTP = document.getElementById(&quot;noSmtp&quot;).hidden;</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-  if (!usingDefaultSMTP &amp;&amp; hostnameIsIllegal(smtpserver))</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+  let smtpServer = document.getElementById(&quot;smtphostname&quot;).value;</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+  let usingDefaultSMTP = document.getElementById(&quot;noSmtp&quot;).hidden;</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+  if (!usingDefaultSMTP &amp;&amp; !isLegalHostNameOrIP(cleanUpHostname(smtpServer));</span>
<a href="#l7.25"></a><span id="l7.25">     canAdvance = false;</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27">   document.documentElement.canAdvance = canAdvance;</span>
<a href="#l7.28"></a><span id="l7.28"> }</span>
<a href="#l7.29"></a><span id="l7.29"> </span>
<a href="#l7.30"></a><span id="l7.30"> function outgoingPageUnload() {</span>
<a href="#l7.31"></a><span id="l7.31">   var pageData = parent.GetPageData();</span>
<a href="#l7.32"></a><span id="l7.32">   var username = document.getElementById(&quot;username&quot;).value;</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-  var smtpserver = document.getElementById(&quot;smtphostname&quot;);</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-  setPageData(pageData, &quot;server&quot;, &quot;smtphostname&quot;, trim(smtpserver.value));</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+  let smtpserver = document.getElementById(&quot;smtphostname&quot;).value;</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+  setPageData(pageData, &quot;server&quot;, &quot;smtphostname&quot;, cleanUpHostname(smtpserver));</span>
<a href="#l7.37"></a><span id="l7.37"> </span>
<a href="#l7.38"></a><span id="l7.38">   // If SMTP username box is blank it is because the</span>
<a href="#l7.39"></a><span id="l7.39">   // incoming and outgoing server names were the same,</span>
<a href="#l7.40"></a><span id="l7.40">   // so set to be same as incoming username</span>
<a href="#l7.41"></a><span id="l7.41">   var smtpusername = document.getElementById(&quot;smtpusername&quot;).value || username;</span>
<a href="#l7.42"></a><span id="l7.42"> </span>
<a href="#l7.43"></a><span id="l7.43">   setPageData(pageData, &quot;login&quot;, &quot;smtpusername&quot;, smtpusername);</span>
<a href="#l7.44"></a><span id="l7.44"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/prefs/content/smtpEditOverlay.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/prefs/content/smtpEditOverlay.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -114,17 +114,17 @@ function disableIfLocked(prefstrArray)</span>
<a href="#l8.4"></a><span id="l8.4">     if (smtpPrefBranch.prefIsLocked(prefstring))</span>
<a href="#l8.5"></a><span id="l8.5">       prefstrArray[prefstring].disabled = true;</span>
<a href="#l8.6"></a><span id="l8.6"> }</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8"> function saveSmtpSettings(server)</span>
<a href="#l8.9"></a><span id="l8.9"> {</span>
<a href="#l8.10"></a><span id="l8.10">     //dump(&quot;Saving to &quot; + server + &quot;\n&quot;);</span>
<a href="#l8.11"></a><span id="l8.11">     if (server) {</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-        server.hostname = gSmtpHostname.value;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+        server.hostname = cleanUpHostname(gSmtpHostname.value);</span>
<a href="#l8.14"></a><span id="l8.14">         server.description = gSmtpDescription.value;</span>
<a href="#l8.15"></a><span id="l8.15">         server.port = gSmtpPort.value;</span>
<a href="#l8.16"></a><span id="l8.16">         server.authMethod = gSmtpAuthMethod.value;</span>
<a href="#l8.17"></a><span id="l8.17">         server.username = gSmtpUsername.value;</span>
<a href="#l8.18"></a><span id="l8.18">         server.socketType = gSmtpSocketType.value;</span>
<a href="#l8.19"></a><span id="l8.19">     }</span>
<a href="#l8.20"></a><span id="l8.20"> }</span>
<a href="#l8.21"></a><span id="l8.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/util/Makefile.in</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/util/Makefile.in</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -63,16 +63,17 @@ EXTRA_JS_MODULES = \</span>
<a href="#l9.4"></a><span id="l9.4"> 		jsTreeSelection.js \</span>
<a href="#l9.5"></a><span id="l9.5"> 		traceHelper.js \</span>
<a href="#l9.6"></a><span id="l9.6"> 		StringBundle.js \</span>
<a href="#l9.7"></a><span id="l9.7"> 		templateUtils.js \</span>
<a href="#l9.8"></a><span id="l9.8"> 		IOUtils.js \</span>
<a href="#l9.9"></a><span id="l9.9"> 		mailnewsMigrator.js \</span>
<a href="#l9.10"></a><span id="l9.10"> 		mailServices.js \</span>
<a href="#l9.11"></a><span id="l9.11"> 		msgDBCacheManager.js \</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+		hostnameUtils.jsm \</span>
<a href="#l9.13"></a><span id="l9.13"> 		$(NULL)</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15"> # we don't want the shared lib, but we want to force the creation of a static lib.</span>
<a href="#l9.16"></a><span id="l9.16"> FORCE_STATIC_LIB = 1</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18"> DEFINES		+= -D_IMPL_NS_MSG_BASE</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20"> ifeq ($(OS_ARCH),WINNT)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- /dev/null</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ b/mailnews/base/util/hostnameUtils.jsm</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -0,0 +1,292 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+ * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+/**</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+ * Generic shared utility code for checking of IP and hostname</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+ * validity.</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+ */</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+const EXPORTED_SYMBOLS = [ &quot;isLegalHostNameOrIP&quot;,</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+                           &quot;isLegalHostName&quot;,</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+                           &quot;isLegalIPv4Address&quot;,</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+                           &quot;isLegalIPv6Address&quot;,</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+                           &quot;isLegalIPAddress&quot;,</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+                           &quot;isLegalLocalIPAddress&quot; ];</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+/**</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+ * Check if aHostName is an IP address or a valid hostname.</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+ *</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+ * @param aHostName                The string to check for validity.</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+ * @param aAllowExtendedIPFormats  Allow hex/octal formats in addition to decimal.</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+ * @return  Unobscured host name if aHostName is valid.</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+ *          Returns null if it's not.</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+ */</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+function isLegalHostNameOrIP(aHostName, aAllowExtendedIPFormats)</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+{</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+  /*</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+   RFC 1123:</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+   Whenever a user inputs the identity of an Internet host, it SHOULD</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+   be possible to enter either (1) a host domain name or (2) an IP</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+   address in dotted-decimal (&quot;#.#.#.#&quot;) form.  The host SHOULD check</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+   the string syntactically for a dotted-decimal number before</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+   looking it up in the Domain Name System.</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+  */</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+  return isLegalIPAddress(aHostName, aAllowExtendedIPFormats) ||</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+         isLegalHostName(aHostName);</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+}</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+/**</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+ * Check if aHostName is a valid hostname.</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+ *</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+ * @return  The host name if it is valid.</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+ *          Returns null if it's not.</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+ */</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+function isLegalHostName(aHostName)</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+{</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+  /*</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+   RFC 952:</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+   A &quot;name&quot; (Net, Host, Gateway, or Domain name) is a text string up</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+   to 24 characters drawn from the alphabet (A-Z), digits (0-9), minus</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+   sign (-), and period (.).  Note that periods are only allowed when</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+   they serve to delimit components of &quot;domain style names&quot;. (See</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+   RFC-921, &quot;Domain Name System Implementation Schedule&quot;, for</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+   background).  No blank or space characters are permitted as part of a</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+   name. No distinction is made between upper and lower case.  The first</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+   character must be an alpha character.  The last character must not be</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+   a minus sign or period.</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+   RFC 1123:</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+   The syntax of a legal Internet host name was specified in RFC-952</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+   [DNS:4].  One aspect of host name syntax is hereby changed: the</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+   restriction on the first character is relaxed to allow either a</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+   letter or a digit.  Host software MUST support this more liberal</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+   syntax.</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+   Host software MUST handle host names of up to 63 characters and</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+   SHOULD handle host names of up to 255 characters.</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+  */</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+  const hostPattern = /^(([a-z0-9]|[a-z0-9][a-z0-9\-]{0,61}[a-z0-9])\.)*([a-z0-9]|[a-z0-9][a-z0-9\-]{0,61}[a-z0-9])$/i;</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+  return ((aHostName.length &lt;= 255) &amp;&amp; hostPattern.test(aHostName)) ? aHostName : null;</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+}</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+/**</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+ * Check if aHostName is an IPv4 address.</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+ *</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+ * @param aHostName                The string to check for validity.</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+ * @param aAllowExtendedIPFormats  If false, only IPv4 addresses in decimal format</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+ *                                 will be accepted, no hex/octal formats.</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+ * @return  Unobscured canonicalized address if aHostName is an IPv4 address.</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+ *          Returns null if it's not.</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+ */</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+function isLegalIPv4Address(aHostName, aAllowExtendedIPFormats)</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+{</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+  // Scammers frequently obscure the IP address by encoding each component as</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+  // octal, hex or in some cases a mix match of each. The IP address could</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+  // also be represented as a DWORD.</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineplus">+  // Break the IP address down into individual components.</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineplus">+  let ipComponents = aHostName.split(&quot;.&quot;);</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineplus">+</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineplus">+  if (ipComponents.length == 4)</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineplus">+  {</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+    for (let i = 0; i &lt; ipComponents.length; i++)</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+    {</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+      // is the component decimal?</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+      if (/^(0|([1-9][0-9]{0,2}))$/.test(ipComponents[i])) {</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+        ipComponents[i] = parseInt(ipComponents[i], 10);</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+      } else if (aAllowExtendedIPFormats) {</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineplus">+        // is the component octal?</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineplus">+        if (/^(0[0-7]{1,3})$/.test(ipComponents[i]))</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+          ipComponents[i] = parseInt(ipComponents[i], 8);</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineplus">+        // is the component hex?</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineplus">+        else if (/^(0x[0-9a-f]{1,2})$/.test(ipComponents[i]))</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+          ipComponents[i] = parseInt(ipComponents[i], 16);</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineplus">+        else</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+          return null;</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+      } else {</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineplus">+        return null;</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineplus">+      }</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineplus">+    }</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineplus">+  }</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineplus">+  else if (aAllowExtendedIPFormats)</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineplus">+  {</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineplus">+    // Convert to a binary to test for possible DWORD.</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineplus">+    let binaryDword = parseInt(aHostName).toString(2);</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineplus">+    if (isNaN(binaryDword))</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineplus">+      return null;</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineplus">+</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineplus">+    // convert the dword into its component IP parts.</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineplus">+    ipComponents = new Array;</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineplus">+    ipComponents[0] = (aHostName &gt;&gt; 24) &amp; 255;</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineplus">+    ipComponents[1] = (aHostName &gt;&gt; 16) &amp; 255;</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineplus">+    ipComponents[2] = (aHostName &gt;&gt;  8) &amp; 255;</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineplus">+    ipComponents[3] = (aHostName &amp; 255);</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineplus">+  }</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineplus">+  else {</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineplus">+    return null;</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+  }</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineplus">+  // Make sure each part of the IP address is in fact a number, and that</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineplus">+  // each part isn't larger than 255.</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineplus">+  for (let i = 0; i &lt; ipComponents.length; i++)</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+  {</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+    // If any part of the IP address is not a number, or longer than 255,</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineplus">+    // then we can safely return.</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineplus">+    if (isNaN(ipComponents[i]) || ipComponents[i] &gt; 255)</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineplus">+      return null;</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineplus">+  }</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineplus">+</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineplus">+  let hostName = ipComponents.join(&quot;.&quot;);</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineplus">+  // Treat 0.0.0.0 as an invalid IPv4 address.</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineplus">+  return (hostName != &quot;0.0.0.0&quot;) ? hostName : null;</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineplus">+}</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineplus">+</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineplus">+/**</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineplus">+ * Check if aHostName is an IPv6 address.</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineplus">+ *</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineplus">+ * @param aHostName  The string to check for validity.</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineplus">+ * @return  Unobscured canonicalized address if aHostName is an IPv6 address.</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineplus">+ *          Returns null if it's not.</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineplus">+ */</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineplus">+function isLegalIPv6Address(aHostName)</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineplus">+{</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineplus">+  // Break the IP address down into individual components.</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineplus">+  let ipComponents = aHostName.toLowerCase().split(&quot;:&quot;);</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineplus">+</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineplus">+  // Make sure there are at least 3 components.</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineplus">+  if (ipComponents.length &lt; 3)</span>
<a href="#l10.166"></a><span id="l10.166" class="difflineplus">+    return null;</span>
<a href="#l10.167"></a><span id="l10.167" class="difflineplus">+</span>
<a href="#l10.168"></a><span id="l10.168" class="difflineplus">+  let ipLength = ipComponents.length - 1;</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineplus">+</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineplus">+  // Take care if the last part is written in decimal using dots as separators.</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineplus">+  let lastPart = isLegalIPv4Address(ipComponents[ipLength], false);</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineplus">+  if (lastPart)</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineplus">+  {</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineplus">+    let lastPartComponents = lastPart.split(&quot;.&quot;);</span>
<a href="#l10.175"></a><span id="l10.175" class="difflineplus">+    // Convert it into standard IPv6 components.</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineplus">+    ipComponents[ipLength] =</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineplus">+      ((lastPartComponents[0] &lt;&lt; 8) | lastPartComponents[1]).toString(16);</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineplus">+    ipComponents[ipLength + 1] =</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineplus">+      ((lastPartComponents[2] &lt;&lt; 8) | lastPartComponents[3]).toString(16);</span>
<a href="#l10.180"></a><span id="l10.180" class="difflineplus">+  }</span>
<a href="#l10.181"></a><span id="l10.181" class="difflineplus">+</span>
<a href="#l10.182"></a><span id="l10.182" class="difflineplus">+  // Make sure that there is only one empty component.</span>
<a href="#l10.183"></a><span id="l10.183" class="difflineplus">+  let emptyIndex;</span>
<a href="#l10.184"></a><span id="l10.184" class="difflineplus">+  for (let i = 1; i &lt; ipComponents.length - 1; i++)</span>
<a href="#l10.185"></a><span id="l10.185" class="difflineplus">+  {</span>
<a href="#l10.186"></a><span id="l10.186" class="difflineplus">+    if (ipComponents[i] == &quot;&quot;)</span>
<a href="#l10.187"></a><span id="l10.187" class="difflineplus">+    {</span>
<a href="#l10.188"></a><span id="l10.188" class="difflineplus">+      // If we already found an empty component return null.</span>
<a href="#l10.189"></a><span id="l10.189" class="difflineplus">+      if (emptyIndex)</span>
<a href="#l10.190"></a><span id="l10.190" class="difflineplus">+        return null;</span>
<a href="#l10.191"></a><span id="l10.191" class="difflineplus">+</span>
<a href="#l10.192"></a><span id="l10.192" class="difflineplus">+      emptyIndex = i;</span>
<a href="#l10.193"></a><span id="l10.193" class="difflineplus">+    }</span>
<a href="#l10.194"></a><span id="l10.194" class="difflineplus">+  }</span>
<a href="#l10.195"></a><span id="l10.195" class="difflineplus">+</span>
<a href="#l10.196"></a><span id="l10.196" class="difflineplus">+  // If we found an empty component, extend it.</span>
<a href="#l10.197"></a><span id="l10.197" class="difflineplus">+  if (emptyIndex)</span>
<a href="#l10.198"></a><span id="l10.198" class="difflineplus">+  {</span>
<a href="#l10.199"></a><span id="l10.199" class="difflineplus">+    ipComponents[emptyIndex] = 0;</span>
<a href="#l10.200"></a><span id="l10.200" class="difflineplus">+</span>
<a href="#l10.201"></a><span id="l10.201" class="difflineplus">+    // Add components so we have a total of 8.</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineplus">+    for (let count = ipComponents.length; count &lt; 8; count++)</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineplus">+      ipComponents.splice(emptyIndex, 0, 0);</span>
<a href="#l10.204"></a><span id="l10.204" class="difflineplus">+  }</span>
<a href="#l10.205"></a><span id="l10.205" class="difflineplus">+</span>
<a href="#l10.206"></a><span id="l10.206" class="difflineplus">+  // Make sure there are 8 components.</span>
<a href="#l10.207"></a><span id="l10.207" class="difflineplus">+  if (ipComponents.length != 8)</span>
<a href="#l10.208"></a><span id="l10.208" class="difflineplus">+    return null;</span>
<a href="#l10.209"></a><span id="l10.209" class="difflineplus">+</span>
<a href="#l10.210"></a><span id="l10.210" class="difflineplus">+  // Format all components to 4 character hex value.</span>
<a href="#l10.211"></a><span id="l10.211" class="difflineplus">+  for (let i = 0; i &lt; ipComponents.length; i++)</span>
<a href="#l10.212"></a><span id="l10.212" class="difflineplus">+  {</span>
<a href="#l10.213"></a><span id="l10.213" class="difflineplus">+    if (ipComponents[i] == &quot;&quot;)</span>
<a href="#l10.214"></a><span id="l10.214" class="difflineplus">+      ipComponents[i] = 0;</span>
<a href="#l10.215"></a><span id="l10.215" class="difflineplus">+</span>
<a href="#l10.216"></a><span id="l10.216" class="difflineplus">+    // Make sure the component is a number and it isn't larger then 0xffff.</span>
<a href="#l10.217"></a><span id="l10.217" class="difflineplus">+    if (/^[0-9a-f]{1,4}$/.test(ipComponents[i])) {</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineplus">+      ipComponents[i] = parseInt(ipComponents[i], 16);</span>
<a href="#l10.219"></a><span id="l10.219" class="difflineplus">+      if (isNaN(ipComponents[i]) || ipComponents[i] &gt; 0xffff)</span>
<a href="#l10.220"></a><span id="l10.220" class="difflineplus">+        return null;</span>
<a href="#l10.221"></a><span id="l10.221" class="difflineplus">+    }</span>
<a href="#l10.222"></a><span id="l10.222" class="difflineplus">+    else {</span>
<a href="#l10.223"></a><span id="l10.223" class="difflineplus">+      return null;</span>
<a href="#l10.224"></a><span id="l10.224" class="difflineplus">+    }</span>
<a href="#l10.225"></a><span id="l10.225" class="difflineplus">+</span>
<a href="#l10.226"></a><span id="l10.226" class="difflineplus">+    // Pad the component with 0:s.</span>
<a href="#l10.227"></a><span id="l10.227" class="difflineplus">+    ipComponents[i] = (&quot;0000&quot; + ipComponents[i].toString(16)).substr(-4);</span>
<a href="#l10.228"></a><span id="l10.228" class="difflineplus">+  }</span>
<a href="#l10.229"></a><span id="l10.229" class="difflineplus">+</span>
<a href="#l10.230"></a><span id="l10.230" class="difflineplus">+  // TODO: support Zone indices in Link-local addresses? Currently they are rejected.</span>
<a href="#l10.231"></a><span id="l10.231" class="difflineplus">+  // http://en.wikipedia.org/wiki/IPv6_address#Link-local_addresses_and_zone_indices</span>
<a href="#l10.232"></a><span id="l10.232" class="difflineplus">+</span>
<a href="#l10.233"></a><span id="l10.233" class="difflineplus">+  let hostName = ipComponents.join(&quot;:&quot;);</span>
<a href="#l10.234"></a><span id="l10.234" class="difflineplus">+  // Treat 0000:0000:0000:0000:0000:0000:0000:0000 as an invalid IPv6 address.</span>
<a href="#l10.235"></a><span id="l10.235" class="difflineplus">+  return (hostName != &quot;0000:0000:0000:0000:0000:0000:0000:0000&quot;) ?</span>
<a href="#l10.236"></a><span id="l10.236" class="difflineplus">+          hostName : null;</span>
<a href="#l10.237"></a><span id="l10.237" class="difflineplus">+}</span>
<a href="#l10.238"></a><span id="l10.238" class="difflineplus">+</span>
<a href="#l10.239"></a><span id="l10.239" class="difflineplus">+/**</span>
<a href="#l10.240"></a><span id="l10.240" class="difflineplus">+ * Check if aHostName is an IP address.</span>
<a href="#l10.241"></a><span id="l10.241" class="difflineplus">+ *</span>
<a href="#l10.242"></a><span id="l10.242" class="difflineplus">+ * @param aHostName                The string to check for validity.</span>
<a href="#l10.243"></a><span id="l10.243" class="difflineplus">+ * @param aAllowExtendedIPFormats  Allow hex/octal formats in addition to decimal.</span>
<a href="#l10.244"></a><span id="l10.244" class="difflineplus">+ * @return  Unobscured canonicalized IPv4 or IPv6 address if it is valid,</span>
<a href="#l10.245"></a><span id="l10.245" class="difflineplus">+ *          otherwise null.</span>
<a href="#l10.246"></a><span id="l10.246" class="difflineplus">+ */</span>
<a href="#l10.247"></a><span id="l10.247" class="difflineplus">+function isLegalIPAddress(aHostName, aAllowExtendedIPFormats)</span>
<a href="#l10.248"></a><span id="l10.248" class="difflineplus">+{</span>
<a href="#l10.249"></a><span id="l10.249" class="difflineplus">+  return isLegalIPv4Address(aHostName, aAllowExtendedIPFormats) ||</span>
<a href="#l10.250"></a><span id="l10.250" class="difflineplus">+         isLegalIPv6Address(aHostName, aAllowExtendedIPFormats);</span>
<a href="#l10.251"></a><span id="l10.251" class="difflineplus">+}</span>
<a href="#l10.252"></a><span id="l10.252" class="difflineplus">+</span>
<a href="#l10.253"></a><span id="l10.253" class="difflineplus">+/**</span>
<a href="#l10.254"></a><span id="l10.254" class="difflineplus">+ * Check if aIPAddress is a local IP address.</span>
<a href="#l10.255"></a><span id="l10.255" class="difflineplus">+ *</span>
<a href="#l10.256"></a><span id="l10.256" class="difflineplus">+ * @param aIPAddress  A valid IP address literal in canonical (unobscured) form.</span>
<a href="#l10.257"></a><span id="l10.257" class="difflineplus">+ * @return            True if it is a local IPv4 or IPv6 address, otherwise false.</span>
<a href="#l10.258"></a><span id="l10.258" class="difflineplus">+ */</span>
<a href="#l10.259"></a><span id="l10.259" class="difflineplus">+function isLegalLocalIPAddress(aIPAddress)</span>
<a href="#l10.260"></a><span id="l10.260" class="difflineplus">+{</span>
<a href="#l10.261"></a><span id="l10.261" class="difflineplus">+  // IPv4 address?</span>
<a href="#l10.262"></a><span id="l10.262" class="difflineplus">+  let ipComponents = aIPAddress.split(&quot;.&quot;);</span>
<a href="#l10.263"></a><span id="l10.263" class="difflineplus">+  if (ipComponents.length == 4)</span>
<a href="#l10.264"></a><span id="l10.264" class="difflineplus">+  {</span>
<a href="#l10.265"></a><span id="l10.265" class="difflineplus">+     // Check if it's a local IPv4 address.</span>
<a href="#l10.266"></a><span id="l10.266" class="difflineplus">+    return ipComponents[0] == 10 ||</span>
<a href="#l10.267"></a><span id="l10.267" class="difflineplus">+           ipComponents[0] == 127 || // loopback address</span>
<a href="#l10.268"></a><span id="l10.268" class="difflineplus">+          (ipComponents[0] == 192 &amp;&amp; ipComponents[1] == 168) ||</span>
<a href="#l10.269"></a><span id="l10.269" class="difflineplus">+          (ipComponents[0] == 169 &amp;&amp; ipComponents[1] == 254) ||</span>
<a href="#l10.270"></a><span id="l10.270" class="difflineplus">+          (ipComponents[0] == 172 &amp;&amp; ipComponents[1] &gt;= 16 &amp;&amp; ipComponents[1] &lt; 32);</span>
<a href="#l10.271"></a><span id="l10.271" class="difflineplus">+  }</span>
<a href="#l10.272"></a><span id="l10.272" class="difflineplus">+</span>
<a href="#l10.273"></a><span id="l10.273" class="difflineplus">+  // IPv6 address?</span>
<a href="#l10.274"></a><span id="l10.274" class="difflineplus">+  ipComponents = aIPAddress.split(&quot;:&quot;);</span>
<a href="#l10.275"></a><span id="l10.275" class="difflineplus">+  if (ipComponents.length == 8)</span>
<a href="#l10.276"></a><span id="l10.276" class="difflineplus">+  {</span>
<a href="#l10.277"></a><span id="l10.277" class="difflineplus">+    // ::1/128 - localhost</span>
<a href="#l10.278"></a><span id="l10.278" class="difflineplus">+    if (ipComponents[0] == &quot;0000&quot; &amp;&amp; ipComponents[1] == &quot;0000&quot; &amp;&amp;</span>
<a href="#l10.279"></a><span id="l10.279" class="difflineplus">+        ipComponents[2] == &quot;0000&quot; &amp;&amp; ipComponents[3] == &quot;0000&quot; &amp;&amp;</span>
<a href="#l10.280"></a><span id="l10.280" class="difflineplus">+        ipComponents[4] == &quot;0000&quot; &amp;&amp; ipComponents[5] == &quot;0000&quot; &amp;&amp;</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineplus">+        ipComponents[6] == &quot;0000&quot; &amp;&amp; ipComponents[7] == &quot;0001&quot;)</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineplus">+      return true;</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineplus">+</span>
<a href="#l10.284"></a><span id="l10.284" class="difflineplus">+    // fe80::/10 - link local addresses</span>
<a href="#l10.285"></a><span id="l10.285" class="difflineplus">+    if (ipComponents[0] == &quot;fe80&quot;)</span>
<a href="#l10.286"></a><span id="l10.286" class="difflineplus">+      return true;</span>
<a href="#l10.287"></a><span id="l10.287" class="difflineplus">+</span>
<a href="#l10.288"></a><span id="l10.288" class="difflineplus">+    // fc00::/7 - unique local addresses</span>
<a href="#l10.289"></a><span id="l10.289" class="difflineplus">+    if (ipComponents[0].substr(0,2) == &quot;fc&quot; || // usage has not been defined yet</span>
<a href="#l10.290"></a><span id="l10.290" class="difflineplus">+        ipComponents[0].substr(0,2) == &quot;fd&quot;)</span>
<a href="#l10.291"></a><span id="l10.291" class="difflineplus">+      return true;</span>
<a href="#l10.292"></a><span id="l10.292" class="difflineplus">+</span>
<a href="#l10.293"></a><span id="l10.293" class="difflineplus">+    return false;</span>
<a href="#l10.294"></a><span id="l10.294" class="difflineplus">+  }</span>
<a href="#l10.295"></a><span id="l10.295" class="difflineplus">+  return false;</span>
<a href="#l10.296"></a><span id="l10.296" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/suite/mailnews/phishingDetector.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/suite/mailnews/phishingDetector.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -2,16 +2,18 @@</span>
<a href="#l11.4"></a><span id="l11.4">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.5"></a><span id="l11.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.6"></a><span id="l11.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8"> // Dependencies:</span>
<a href="#l11.9"></a><span id="l11.9"> // gPrefBranch, gBrandBundle, gMessengerBundle should already be defined</span>
<a href="#l11.10"></a><span id="l11.10"> // gatherTextUnder from utilityOverlay.js</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/hostnameUtils.jsm&quot;);</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+</span>
<a href="#l11.14"></a><span id="l11.14"> const kPhishingNotSuspicious = 0;</span>
<a href="#l11.15"></a><span id="l11.15"> const kPhishingWithIPAddress = 1;</span>
<a href="#l11.16"></a><span id="l11.16"> const kPhishingWithMismatchedHosts = 2;</span>
<a href="#l11.17"></a><span id="l11.17"> </span>
<a href="#l11.18"></a><span id="l11.18"> //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l11.19"></a><span id="l11.19"> // isEmailScam --&gt; examines the message currently loaded in the message pane</span>
<a href="#l11.20"></a><span id="l11.20"> //                 and returns true if we think that message is an e-mail scam.</span>
<a href="#l11.21"></a><span id="l11.21"> //                 Assumes the message has been completely loaded in the message pane (i.e. OnMsgParsed has fired)</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineat">@@ -88,18 +90,18 @@ function isPhishingURL(aLinkNode, aSilen</span>
<a href="#l11.23"></a><span id="l11.23">   var isPhishingURL = false;</span>
<a href="#l11.24"></a><span id="l11.24"> </span>
<a href="#l11.25"></a><span id="l11.25">   var hrefURL = Services.io.newURI(href, null, null);</span>
<a href="#l11.26"></a><span id="l11.26">   </span>
<a href="#l11.27"></a><span id="l11.27">   // only check for phishing urls if the url is an http or https link.</span>
<a href="#l11.28"></a><span id="l11.28">   // this prevents us from flagging imap and other internally handled urls</span>
<a href="#l11.29"></a><span id="l11.29">   if (hrefURL.schemeIs('http') || hrefURL.schemeIs('https'))</span>
<a href="#l11.30"></a><span id="l11.30">   {</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-    var ipAddress = hostNameIsIPAddress(hrefURL.host);</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-    if (ipAddress &amp;&amp; !isLocalIPAddress(ipAddress))</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+    let ipAddress = isLegalIPAddress(hrefURL.host, true);</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+    if (ipAddress &amp;&amp; !isLegalLocalIPAddress(ipAddress))</span>
<a href="#l11.35"></a><span id="l11.35">       phishingType = kPhishingWithIPAddress;</span>
<a href="#l11.36"></a><span id="l11.36">     else if (misMatchedHostWithLinkText(aLinkNode, hrefURL, linkTextURL))</span>
<a href="#l11.37"></a><span id="l11.37">       phishingType = kPhishingWithMismatchedHosts;</span>
<a href="#l11.38"></a><span id="l11.38"> </span>
<a href="#l11.39"></a><span id="l11.39">     isPhishingURL = phishingType != kPhishingNotSuspicious;</span>
<a href="#l11.40"></a><span id="l11.40"> </span>
<a href="#l11.41"></a><span id="l11.41">     if (!aSilentMode &amp;&amp; isPhishingURL) // allow the user to override the decision</span>
<a href="#l11.42"></a><span id="l11.42">       isPhishingURL = confirmSuspiciousURL(phishingType, hrefURL.host);</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineat">@@ -131,74 +133,16 @@ function misMatchedHostWithLinkText(aLin</span>
<a href="#l11.44"></a><span id="l11.44">        // compare hosts, but ignore possible www. prefix</span>
<a href="#l11.45"></a><span id="l11.45">        return !(aHrefURL.host.replace(/^www\./, &quot;&quot;) == aLinkTextURL.value.host.replace(/^www\./, &quot;&quot;));</span>
<a href="#l11.46"></a><span id="l11.46">      }</span>
<a href="#l11.47"></a><span id="l11.47">   }</span>
<a href="#l11.48"></a><span id="l11.48"> </span>
<a href="#l11.49"></a><span id="l11.49">   return false;</span>
<a href="#l11.50"></a><span id="l11.50"> }</span>
<a href="#l11.51"></a><span id="l11.51"> </span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-// returns the unobscured host (if there is one), otherwise null</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-function hostNameIsIPAddress(aHostName)</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-{</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-  // TODO: Add Support for IPv6</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-  var index;</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-  // scammers frequently obscure the IP address by encoding each component as octal, hex</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-  // or in some cases a mix match of each. The IP address could also be represented as a DWORD.</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-  // break the IP address down into individual components.</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-  var ipComponents = aHostName.split(&quot;.&quot;);</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineminus">-</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-  // if we didn't find at least 4 parts to our IP address it either isn't a numerical IP</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-  // or it is encoded as a dword</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineminus">-  if (ipComponents.length &lt; 4)</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-  {</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-    // Convert to a binary to test for possible DWORD.</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-    var binaryDword = parseInt(aHostName).toString(2);</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-    if (isNaN(binaryDword))</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineminus">-      return null;</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineminus">-</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-    // convert the dword into its component IP parts.</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-    ipComponents =</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineminus">-    [</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-      (aHostName &gt;&gt; 24) &amp; 255,</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineminus">-      (aHostName &gt;&gt; 16) &amp; 255,</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineminus">-      (aHostName &gt;&gt;  8) &amp; 255,</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineminus">-      (aHostName &amp; 255)</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineminus">-    ];</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineminus">-  }</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineminus">-  else</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineminus">-  {</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineminus">-    for (index = 0; index &lt; ipComponents.length; ++index)</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineminus">-    {</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineminus">-      // by leaving the radix parameter blank, we can handle IP addresses</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineminus">-      // where one component is hex, another is octal, etc.</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineminus">-      ipComponents[index] = parseInt(ipComponents[index]);</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineminus">-    }</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineminus">-  }</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineminus">-</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineminus">-  // make sure each part of the IP address is in fact a number</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineminus">-  for (index = 0; index &lt; ipComponents.length; ++index)</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineminus">-    if (isNaN(ipComponents[index])) // if any part of the IP address is not a number, then we can safely return</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineminus">-      return null;</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineminus">-</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineminus">-  // only return unobscured host name if we are looking at an IPv4 host name</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineminus">-  var hostName = ipComponents.join(&quot;.&quot;);</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineminus">-  return isIPv4HostName(hostName) ? hostName : null;</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineminus">-}</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineminus">-</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-function isIPv4HostName(aHostName)</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-{</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineminus">-  var ipv4HostRegExp = new RegExp(/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/);  // IPv4</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineminus">-  // treat 0.0.0.0 as an invalid IP address</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineminus">-  return ipv4HostRegExp.test(aHostName) &amp;&amp; aHostName != '0.0.0.0';</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineminus">-}</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineminus">-</span>
<a href="#l11.110"></a><span id="l11.110"> // returns true if the user confirms the URL is a scam</span>
<a href="#l11.111"></a><span id="l11.111"> function confirmSuspiciousURL(aPhishingType, aSuspiciousHostName)</span>
<a href="#l11.112"></a><span id="l11.112"> {</span>
<a href="#l11.113"></a><span id="l11.113">   var brandShortName = gBrandBundle.getString(&quot;brandShortName&quot;);</span>
<a href="#l11.114"></a><span id="l11.114">   var titleMsg = gMessengerBundle.getString(&quot;confirmPhishingTitle&quot;);</span>
<a href="#l11.115"></a><span id="l11.115">   var dialogMsg;</span>
<a href="#l11.116"></a><span id="l11.116"> </span>
<a href="#l11.117"></a><span id="l11.117">   switch (aPhishingType)</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineat">@@ -210,19 +154,8 @@ function confirmSuspiciousURL(aPhishingT</span>
<a href="#l11.119"></a><span id="l11.119">     default:</span>
<a href="#l11.120"></a><span id="l11.120">       return false;</span>
<a href="#l11.121"></a><span id="l11.121">   }</span>
<a href="#l11.122"></a><span id="l11.122"> </span>
<a href="#l11.123"></a><span id="l11.123">   var buttons = Services.prompt.STD_YES_NO_BUTTONS +</span>
<a href="#l11.124"></a><span id="l11.124">                 Services.prompt.BUTTON_POS_1_DEFAULT;</span>
<a href="#l11.125"></a><span id="l11.125">   return Services.prompt.confirmEx(window, titleMsg, dialogMsg, buttons, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, {}); /* the yes button is in position 0 */</span>
<a href="#l11.126"></a><span id="l11.126"> }</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineminus">-</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineminus">-// returns true if the IP address is a local address.</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineminus">-function isLocalIPAddress(unobscuredHostName)</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineminus">-{</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineminus">-  var ipComponents = unobscuredHostName.split(&quot;.&quot;);</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineminus">-</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineminus">-  return ipComponents[0] == 10 ||</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineminus">-         (ipComponents[0] == 192 &amp;&amp; ipComponents[1] == 168) ||</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineminus">-         (ipComponents[0] == 169 &amp;&amp; ipComponents[1] == 254) ||</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineminus">-         (ipComponents[0] == 172 &amp;&amp; ipComponents[1] &gt;= 16 &amp;&amp; ipComponents[1] &lt; 32);</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineminus">-}</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

