<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 2548:db857c5e58e8625e6f3afb4ee8503b6e5e3715ab</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ db857c5e58e8625e6f3afb4ee8503b6e5e3715ab" />
<meta property="og:url" content="/comm-central/rev/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab" />
<meta property="og:description" content="Bug 490972 Switch parts of nsIImapUrl to ACString to save string copies/allocations. r/sr=bienvenu" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / db857c5e58e8625e6f3afb4ee8503b6e5e3715ab 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab">shortlog</a> |
<a href="/comm-central/log/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab">files</a> |
changeset |
<a href="/comm-central/raw-rev/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab">raw</a>  | <a href="/comm-central/archive/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=490972">Bug 490972</a> Switch parts of nsIImapUrl to ACString to save string copies/allocations. r/sr=bienvenu
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#97;&#114;&#107;&#32;&#66;&#97;&#110;&#110;&#101;&#114;&#32;&#60;&#98;&#117;&#103;&#122;&#105;&#108;&#108;&#97;&#64;&#115;&#116;&#97;&#110;&#100;&#97;&#114;&#100;&#56;&#46;&#112;&#108;&#117;&#115;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 04 May 2009 19:13:27 +0100</td></tr>

<tr>
 <td>changeset 2548</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab">db857c5e58e8625e6f3afb4ee8503b6e5e3715ab</a></td>
</tr>



<tr>
<td>parent 2547</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/91b50be6114a98499f8c39445e7cb027151b70fb">91b50be6114a98499f8c39445e7cb027151b70fb</a>
</td>
</tr>

<tr>
<td>child 2549</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2580d4920e207ab45bec9f24c36233eecc8b9b9c">2580d4920e207ab45bec9f24c36233eecc8b9b9c</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=db857c5e58e8625e6f3afb4ee8503b6e5e3715ab">2077</a></td></tr>
<tr><td>push user</td><td>bugzilla@standard8.plus.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 04 May 2009 18:14:34 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@db857c5e58e8 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=db857c5e58e8625e6f3afb4ee8503b6e5e3715ab">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=db857c5e58e8625e6f3afb4ee8503b6e5e3715ab&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=db857c5e58e8625e6f3afb4ee8503b6e5e3715ab&newProject=comm-central&newRevision=91b50be6114a98499f8c39445e7cb027151b70fb&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=db857c5e58e8625e6f3afb4ee8503b6e5e3715ab&newProject=comm-central&newRevision=91b50be6114a98499f8c39445e7cb027151b70fb&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=db857c5e58e8625e6f3afb4ee8503b6e5e3715ab&newProject=comm-central&newRevision=91b50be6114a98499f8c39445e7cb027151b70fb&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=490972">490972</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=490972">Bug 490972</a> Switch parts of nsIImapUrl to ACString to save string copies/allocations. r/sr=bienvenu</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/public/nsIImapUrl.idl">mailnews/imap/public/nsIImapUrl.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/public/nsIImapUrl.idl">file</a> |
<a href="/comm-central/annotate/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/public/nsIImapUrl.idl">annotate</a> |
<a href="/comm-central/diff/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/public/nsIImapUrl.idl">diff</a> |
<a href="/comm-central/comparison/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/public/nsIImapUrl.idl">comparison</a> |
<a href="/comm-central/log/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/public/nsIImapUrl.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/src/nsImapProtocol.cpp">mailnews/imap/src/nsImapProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/src/nsImapProtocol.cpp">file</a> |
<a href="/comm-central/annotate/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/src/nsImapProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/src/nsImapProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/src/nsImapProtocol.cpp">comparison</a> |
<a href="/comm-central/log/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/src/nsImapProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/src/nsImapServerResponseParser.cpp">mailnews/imap/src/nsImapServerResponseParser.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/src/nsImapServerResponseParser.cpp">file</a> |
<a href="/comm-central/annotate/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/src/nsImapServerResponseParser.cpp">annotate</a> |
<a href="/comm-central/diff/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/src/nsImapServerResponseParser.cpp">diff</a> |
<a href="/comm-central/comparison/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/src/nsImapServerResponseParser.cpp">comparison</a> |
<a href="/comm-central/log/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/src/nsImapServerResponseParser.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/src/nsImapService.cpp">mailnews/imap/src/nsImapService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/src/nsImapService.cpp">file</a> |
<a href="/comm-central/annotate/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/src/nsImapService.cpp">annotate</a> |
<a href="/comm-central/diff/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/src/nsImapService.cpp">diff</a> |
<a href="/comm-central/comparison/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/src/nsImapService.cpp">comparison</a> |
<a href="/comm-central/log/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/src/nsImapService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/src/nsImapUrl.cpp">mailnews/imap/src/nsImapUrl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/src/nsImapUrl.cpp">file</a> |
<a href="/comm-central/annotate/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/src/nsImapUrl.cpp">annotate</a> |
<a href="/comm-central/diff/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/src/nsImapUrl.cpp">diff</a> |
<a href="/comm-central/comparison/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/src/nsImapUrl.cpp">comparison</a> |
<a href="/comm-central/log/db857c5e58e8625e6f3afb4ee8503b6e5e3715ab/mailnews/imap/src/nsImapUrl.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/imap/public/nsIImapUrl.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/imap/public/nsIImapUrl.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -55,47 +55,47 @@ typedef long nsImapContentModifiedType;</span>
<a href="#l1.4"></a><span id="l1.4"> interface nsImapContentModifiedTypes</span>
<a href="#l1.5"></a><span id="l1.5"> {</span>
<a href="#l1.6"></a><span id="l1.6">   const long IMAP_CONTENT_NOT_MODIFIED = 0;</span>
<a href="#l1.7"></a><span id="l1.7">   const long IMAP_CONTENT_MODIFIED_VIEW_INLINE = 1;</span>
<a href="#l1.8"></a><span id="l1.8">   const long IMAP_CONTENT_MODIFIED_VIEW_AS_LINKS = 2;</span>
<a href="#l1.9"></a><span id="l1.9">   const long IMAP_CONTENT_FORCE_CONTENT_NOT_MODIFIED = 3;</span>
<a href="#l1.10"></a><span id="l1.10"> } ;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-[scriptable, uuid(c9e4e0ab-f48b-4bba-b9a2-e889cbec364f)]</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+[scriptable, uuid(5ea7ce41-9392-488f-a7ad-343cba15b3e4)]</span>
<a href="#l1.14"></a><span id="l1.14"> interface nsIImapUrl : nsISupports</span>
<a href="#l1.15"></a><span id="l1.15"> {</span>
<a href="#l1.16"></a><span id="l1.16">   ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.17"></a><span id="l1.17">   // Getters and Setters for the imap specific event sinks to bind to to the url</span>
<a href="#l1.18"></a><span id="l1.18">   ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.19"></a><span id="l1.19">   attribute nsIImapMailFolderSink imapMailFolderSink;</span>
<a href="#l1.20"></a><span id="l1.20">   attribute nsIImapMessageSink imapMessageSink;</span>
<a href="#l1.21"></a><span id="l1.21">   attribute nsIImapServerSink imapServerSink;</span>
<a href="#l1.22"></a><span id="l1.22"> </span>
<a href="#l1.23"></a><span id="l1.23">   ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.24"></a><span id="l1.24">   // Getters and Setters for the imap url state</span>
<a href="#l1.25"></a><span id="l1.25">   ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.26"></a><span id="l1.26">   attribute nsImapAction imapAction;</span>
<a href="#l1.27"></a><span id="l1.27">   readonly attribute nsImapState requiredImapState;</span>
<a href="#l1.28"></a><span id="l1.28">   readonly attribute string imapPartToFetch;</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-  readonly attribute string customAttributeToFetch;</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-  attribute string customAttributeResult;</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-  readonly attribute string command;</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-  attribute string customCommandResult;</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-  readonly attribute string customAddFlags;</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-  readonly attribute string customSubtractFlags;</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+  readonly attribute ACString customAttributeToFetch;</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+  attribute ACString customAttributeResult;</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+  readonly attribute ACString command;</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+  attribute ACString customCommandResult;</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+  readonly attribute ACString customAddFlags;</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+  readonly attribute ACString customSubtractFlags;</span>
<a href="#l1.41"></a><span id="l1.41">   void allocateCanonicalPath(in string aServerPath, in char aOnlineDelimiter, out string aAllocatedPath);</span>
<a href="#l1.42"></a><span id="l1.42">   void allocateServerPath(in string aCanonicalPath, in char aOnlineDelimiter, out string aAllocatedPath);</span>
<a href="#l1.43"></a><span id="l1.43">   string createServerSourceFolderPathString();</span>
<a href="#l1.44"></a><span id="l1.44">   string createCanonicalSourceFolderPathString();</span>
<a href="#l1.45"></a><span id="l1.45">   string createServerDestinationFolderPathString();</span>
<a href="#l1.46"></a><span id="l1.46"> </span>
<a href="#l1.47"></a><span id="l1.47">   string addOnlineDirectoryIfNecessary(in string onlineMailboxName);</span>
<a href="#l1.48"></a><span id="l1.48">   void createSearchCriteriaString (out string aResult);</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-  void createListOfMessageIdsString (out string aResult);</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+  readonly attribute ACString listOfMessageIds;</span>
<a href="#l1.51"></a><span id="l1.51"> </span>
<a href="#l1.52"></a><span id="l1.52">   boolean messageIdsAreUids();</span>
<a href="#l1.53"></a><span id="l1.53">   readonly attribute imapMessageFlagsType msgFlags; // kAddMsgFlags or kSubtractMsgFlags only</span>
<a href="#l1.54"></a><span id="l1.54"> </span>
<a href="#l1.55"></a><span id="l1.55">   readonly attribute long numBytesToFetch;</span>
<a href="#l1.56"></a><span id="l1.56">   attribute char onlineSubDirSeparator;</span>
<a href="#l1.57"></a><span id="l1.57">   attribute boolean allowContentChange;</span>
<a href="#l1.58"></a><span id="l1.58">   attribute boolean mimePartSelectorDetected;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -4204,17 +4204,17 @@ nsImapMailFolder::OnlineCopyCompleted(ns</span>
<a href="#l2.4"></a><span id="l2.4">     rv = aProtocol-&gt;GetRunningImapURL(getter_AddRefs(imapUrl));</span>
<a href="#l2.5"></a><span id="l2.5">     if (NS_FAILED(rv) || !imapUrl) return NS_ERROR_FAILURE;</span>
<a href="#l2.6"></a><span id="l2.6">     nsImapAction action;</span>
<a href="#l2.7"></a><span id="l2.7">     rv = imapUrl-&gt;GetImapAction(&amp;action);</span>
<a href="#l2.8"></a><span id="l2.8">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.9"></a><span id="l2.9">     if (action != nsIImapUrl::nsImapOnlineToOfflineMove)</span>
<a href="#l2.10"></a><span id="l2.10">       return NS_ERROR_FAILURE; // don't assert here...</span>
<a href="#l2.11"></a><span id="l2.11">     nsCString messageIds;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    rv = imapUrl-&gt;CreateListOfMessageIdsString(getter_Copies(messageIds));</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    rv = imapUrl-&gt;GetListOfMessageIds(messageIds);</span>
<a href="#l2.14"></a><span id="l2.14">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.15"></a><span id="l2.15">     nsCOMPtr&lt;nsIImapService&gt; imapService =  do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l2.16"></a><span id="l2.16">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l2.17"></a><span id="l2.17">     return imapService-&gt;AddMessageFlags(m_thread, this, nsnull, nsnull,</span>
<a href="#l2.18"></a><span id="l2.18">                                       messageIds,</span>
<a href="#l2.19"></a><span id="l2.19">                                       kImapMsgDeletedFlag,</span>
<a href="#l2.20"></a><span id="l2.20">                                       PR_TRUE);</span>
<a href="#l2.21"></a><span id="l2.21">   }</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -4791,25 +4791,21 @@ nsImapMailFolder::OnStopRunningUrl(nsIUR</span>
<a href="#l2.23"></a><span id="l2.23">           //we need to subtract the delete flag in db only in case when we show deleted msgs</span>
<a href="#l2.24"></a><span id="l2.24">           if (flags &amp; kImapMsgDeletedFlag &amp;&amp; ShowDeletedMessages())</span>
<a href="#l2.25"></a><span id="l2.25">           {</span>
<a href="#l2.26"></a><span id="l2.26">             nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l2.27"></a><span id="l2.27">             rv = GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l2.28"></a><span id="l2.28">             if (NS_SUCCEEDED(rv) &amp;&amp; db)</span>
<a href="#l2.29"></a><span id="l2.29">             {</span>
<a href="#l2.30"></a><span id="l2.30">               nsTArray&lt;nsMsgKey&gt; keyArray;</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-              char *keyString;</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-              imapUrl-&gt;CreateListOfMessageIdsString(&amp;keyString);</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-              if (keyString)</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-              {</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-                ParseUidString(keyString, keyArray);</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-                MarkMessagesImapDeleted(&amp;keyArray, PR_FALSE, db);</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-                db-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-                NS_Free(keyString);</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-              }</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+              nsCString keyString;</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+              imapUrl-&gt;GetListOfMessageIds(keyString);</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+              ParseUidString(keyString.get(), keyArray);</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+              MarkMessagesImapDeleted(&amp;keyArray, PR_FALSE, db);</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+              db-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l2.45"></a><span id="l2.45">             }</span>
<a href="#l2.46"></a><span id="l2.46">           }</span>
<a href="#l2.47"></a><span id="l2.47">         }</span>
<a href="#l2.48"></a><span id="l2.48">         break;</span>
<a href="#l2.49"></a><span id="l2.49">       case nsIImapUrl::nsImapAddMsgFlags:</span>
<a href="#l2.50"></a><span id="l2.50">         {</span>
<a href="#l2.51"></a><span id="l2.51">           imapMessageFlagsType flags = 0;</span>
<a href="#l2.52"></a><span id="l2.52">           imapUrl-&gt;GetMsgFlags(&amp;flags);</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineat">@@ -4818,42 +4814,38 @@ nsImapMailFolder::OnStopRunningUrl(nsIUR</span>
<a href="#l2.54"></a><span id="l2.54">             // we need to delete headers from db only when we don't show deleted msgs</span>
<a href="#l2.55"></a><span id="l2.55">             if (!ShowDeletedMessages())</span>
<a href="#l2.56"></a><span id="l2.56">             {</span>
<a href="#l2.57"></a><span id="l2.57">               nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l2.58"></a><span id="l2.58">               rv = GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l2.59"></a><span id="l2.59">               if (NS_SUCCEEDED(rv) &amp;&amp; db)</span>
<a href="#l2.60"></a><span id="l2.60">               {</span>
<a href="#l2.61"></a><span id="l2.61">                 nsTArray&lt;nsMsgKey&gt; keyArray;</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-                char *keyString = nsnull;</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-                imapUrl-&gt;CreateListOfMessageIdsString(&amp;keyString);</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-                if (keyString)</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-                {</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-                  ParseUidString(keyString, keyArray);</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+                nsCString keyString;</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+                imapUrl-&gt;GetListOfMessageIds(keyString);</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+                ParseUidString(keyString.get(), keyArray);</span>
<a href="#l2.70"></a><span id="l2.70">                   </span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-                  // Notify listeners of delete.</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-                  if (notifier)</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-                  {</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-                    nsCOMPtr&lt;nsIMutableArray&gt; msgHdrs(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-                    MsgGetHeadersFromKeys(db, keyArray, msgHdrs);</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-                    // XXX Currently, the DeleteMessages below gets executed twice on deletes.</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-                    // Once in DeleteMessages, once here. The second time, it silently fails</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-                    // to delete. This is why we're also checking whether the array is empty.</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-                    PRUint32 numHdrs;</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-                    msgHdrs-&gt;GetLength(&amp;numHdrs);</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-                    if (numHdrs)</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-                      notifier-&gt;NotifyMsgsDeleted(msgHdrs);</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-                  }</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-                  db-&gt;DeleteMessages(&amp;keyArray, nsnull);</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-                  db-&gt;SetSummaryValid(PR_TRUE);</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-                  db-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-                  NS_Free(keyString);</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+                // Notify listeners of delete.</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+                if (notifier)</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+                {</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+                  nsCOMPtr&lt;nsIMutableArray&gt; msgHdrs(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+                  MsgGetHeadersFromKeys(db, keyArray, msgHdrs);</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+                  // XXX Currently, the DeleteMessages below gets executed twice on deletes.</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+                  // Once in DeleteMessages, once here. The second time, it silently fails</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+                  // to delete. This is why we're also checking whether the array is empty.</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+                  PRUint32 numHdrs;</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+                  msgHdrs-&gt;GetLength(&amp;numHdrs);</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineplus">+                  if (numHdrs)</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+                    notifier-&gt;NotifyMsgsDeleted(msgHdrs);</span>
<a href="#l2.103"></a><span id="l2.103">                 }</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+                db-&gt;DeleteMessages(&amp;keyArray, nsnull);</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+                db-&gt;SetSummaryValid(PR_TRUE);</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineplus">+                db-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l2.108"></a><span id="l2.108">               }</span>
<a href="#l2.109"></a><span id="l2.109">             }</span>
<a href="#l2.110"></a><span id="l2.110">           }</span>
<a href="#l2.111"></a><span id="l2.111">         }</span>
<a href="#l2.112"></a><span id="l2.112">         break;</span>
<a href="#l2.113"></a><span id="l2.113">       case nsIImapUrl::nsImapAppendMsgFromFile:</span>
<a href="#l2.114"></a><span id="l2.114">       case nsIImapUrl::nsImapAppendDraftFromFile:</span>
<a href="#l2.115"></a><span id="l2.115">           if (m_copyState)</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineat">@@ -5054,17 +5046,17 @@ nsImapMailFolder::SetCopyResponseUid(con</span>
<a href="#l2.117"></a><span id="l2.117">         do_QueryInterface(copyState, &amp;rv);</span>
<a href="#l2.118"></a><span id="l2.118">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.119"></a><span id="l2.119">     if (mailCopyState-&gt;m_undoMsgTxn)</span>
<a href="#l2.120"></a><span id="l2.120">       rv = mailCopyState-&gt;m_undoMsgTxn-&gt;QueryInterface(NS_GET_IID(nsImapMoveCopyMsgTxn), getter_AddRefs(msgTxn));</span>
<a href="#l2.121"></a><span id="l2.121">   }</span>
<a href="#l2.122"></a><span id="l2.122">   else if (aUrl &amp;&amp; m_pendingOfflineMoves.Count())</span>
<a href="#l2.123"></a><span id="l2.123">   {</span>
<a href="#l2.124"></a><span id="l2.124">     nsCString urlSourceMsgIds, undoTxnSourceMsgIds;</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineminus">-    aUrl-&gt;CreateListOfMessageIdsString(getter_Copies(urlSourceMsgIds));</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+    aUrl-&gt;GetListOfMessageIds(urlSourceMsgIds);</span>
<a href="#l2.127"></a><span id="l2.127">     nsCOMPtr &lt;nsITransaction&gt; firstTransaction = m_pendingOfflineMoves[0];</span>
<a href="#l2.128"></a><span id="l2.128">     nsRefPtr&lt;nsImapMoveCopyMsgTxn&gt; imapUndo;</span>
<a href="#l2.129"></a><span id="l2.129">     firstTransaction-&gt;QueryInterface(NS_GET_IID(nsImapMoveCopyMsgTxn), getter_AddRefs(imapUndo));</span>
<a href="#l2.130"></a><span id="l2.130">     if (imapUndo)</span>
<a href="#l2.131"></a><span id="l2.131">     {</span>
<a href="#l2.132"></a><span id="l2.132">       imapUndo-&gt;GetSrcMsgIds(undoTxnSourceMsgIds);</span>
<a href="#l2.133"></a><span id="l2.133">       if (undoTxnSourceMsgIds.Equals(urlSourceMsgIds))</span>
<a href="#l2.134"></a><span id="l2.134">         msgTxn = imapUndo;</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineat">@@ -6844,17 +6836,16 @@ nsImapMailFolder::CopyMessages(nsIMsgFol</span>
<a href="#l2.136"></a><span id="l2.136">     return rv;</span>
<a href="#l2.137"></a><span id="l2.137">   }</span>
<a href="#l2.138"></a><span id="l2.138">   else </span>
<a href="#l2.139"></a><span id="l2.139">   {</span>
<a href="#l2.140"></a><span id="l2.140">     nsCAutoString messageIds;</span>
<a href="#l2.141"></a><span id="l2.141">     nsTArray&lt;nsMsgKey&gt; srcKeyArray;</span>
<a href="#l2.142"></a><span id="l2.142">     nsCOMPtr&lt;nsIUrlListener&gt; urlListener;</span>
<a href="#l2.143"></a><span id="l2.143">     nsCOMPtr&lt;nsISupports&gt; copySupport;</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineminus">-    PRUint32 count = 0; // needs to be inited before goto</span>
<a href="#l2.145"></a><span id="l2.145">     </span>
<a href="#l2.146"></a><span id="l2.146">     if (WeAreOffline())</span>
<a href="#l2.147"></a><span id="l2.147">       return CopyMessagesOffline(srcFolder, messages, isMove, msgWindow, listener);</span>
<a href="#l2.148"></a><span id="l2.148">     </span>
<a href="#l2.149"></a><span id="l2.149">     nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l2.150"></a><span id="l2.150">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l2.151"></a><span id="l2.151">     </span>
<a href="#l2.152"></a><span id="l2.152">     SetPendingAttributes(messages, isMove);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -886,17 +886,17 @@ nsresult nsImapProtocol::SetupWithUrl(ns</span>
<a href="#l3.4"></a><span id="l3.4">             m_imapAction == nsIImapUrl::nsImapAppendDraftFromFile)</span>
<a href="#l3.5"></a><span id="l3.5">         {</span>
<a href="#l3.6"></a><span id="l3.6">           readWriteTimeout = 20;</span>
<a href="#l3.7"></a><span id="l3.7">         }</span>
<a href="#l3.8"></a><span id="l3.8">         else if (m_imapAction == nsIImapUrl::nsImapOnlineMove ||</span>
<a href="#l3.9"></a><span id="l3.9">                  m_imapAction == nsIImapUrl::nsImapOnlineCopy)</span>
<a href="#l3.10"></a><span id="l3.10">         {</span>
<a href="#l3.11"></a><span id="l3.11">           nsCString messageIdString;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-          m_runningUrl-&gt;CreateListOfMessageIdsString(getter_Copies(messageIdString));</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+          m_runningUrl-&gt;GetListOfMessageIds(messageIdString);</span>
<a href="#l3.14"></a><span id="l3.14">           PRUint32 copyCount = CountMessagesInIdString(messageIdString.get());</span>
<a href="#l3.15"></a><span id="l3.15">           // If we're move/copying a large number of messages,</span>
<a href="#l3.16"></a><span id="l3.16">           // which should be rare, increase the timeout based on number </span>
<a href="#l3.17"></a><span id="l3.17">           // of messages. 40 messages per second should be sufficiently slow.</span>
<a href="#l3.18"></a><span id="l3.18">           if (copyCount &gt; 2400) // 40 * 60, 60 is default read write timeout</span>
<a href="#l3.19"></a><span id="l3.19">             readWriteTimeout = PR_MAX(readWriteTimeout, copyCount/40);</span>
<a href="#l3.20"></a><span id="l3.20">         }</span>
<a href="#l3.21"></a><span id="l3.21">       }</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -2343,17 +2343,17 @@ void nsImapProtocol::ProcessSelectedStat</span>
<a href="#l3.23"></a><span id="l3.23">         break;</span>
<a href="#l3.24"></a><span id="l3.24">       case nsIImapUrl::nsImapSaveMessageToDisk:</span>
<a href="#l3.25"></a><span id="l3.25">       case nsIImapUrl::nsImapMsgFetch:</span>
<a href="#l3.26"></a><span id="l3.26">       case nsIImapUrl::nsImapMsgFetchPeek:</span>
<a href="#l3.27"></a><span id="l3.27">       case nsIImapUrl::nsImapMsgDownloadForOffline:</span>
<a href="#l3.28"></a><span id="l3.28">       case nsIImapUrl::nsImapMsgPreview:</span>
<a href="#l3.29"></a><span id="l3.29">         {</span>
<a href="#l3.30"></a><span id="l3.30">           nsCString messageIdString;</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-          m_runningUrl-&gt;CreateListOfMessageIdsString(getter_Copies(messageIdString));</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+          m_runningUrl-&gt;GetListOfMessageIds(messageIdString);</span>
<a href="#l3.33"></a><span id="l3.33">           // we don't want to send the flags back in a group</span>
<a href="#l3.34"></a><span id="l3.34">           // GetServerStateParser().ResetFlagInfo(0);</span>
<a href="#l3.35"></a><span id="l3.35">           if (HandlingMultipleMessages(messageIdString) || m_imapAction == nsIImapUrl::nsImapMsgDownloadForOffline</span>
<a href="#l3.36"></a><span id="l3.36">              || m_imapAction == nsIImapUrl::nsImapMsgPreview)</span>
<a href="#l3.37"></a><span id="l3.37">           {</span>
<a href="#l3.38"></a><span id="l3.38">             // multiple messages, fetch them all</span>
<a href="#l3.39"></a><span id="l3.39">             SetProgressString(IMAP_FOLDER_RECEIVING_MESSAGE_OF);</span>
<a href="#l3.40"></a><span id="l3.40"> </span>
<a href="#l3.41"></a><span id="l3.41" class="difflineat">@@ -2518,17 +2518,17 @@ void nsImapProtocol::ProcessSelectedStat</span>
<a href="#l3.42"></a><span id="l3.42">         // note fall through to next cases.</span>
<a href="#l3.43"></a><span id="l3.43">       case nsIImapUrl::nsImapSelectFolder:</span>
<a href="#l3.44"></a><span id="l3.44">       case nsIImapUrl::nsImapSelectNoopFolder:</span>
<a href="#l3.45"></a><span id="l3.45">         ProcessMailboxUpdate(PR_TRUE);</span>
<a href="#l3.46"></a><span id="l3.46">         break;</span>
<a href="#l3.47"></a><span id="l3.47">       case nsIImapUrl::nsImapMsgHeader:</span>
<a href="#l3.48"></a><span id="l3.48">         {</span>
<a href="#l3.49"></a><span id="l3.49">           nsCString messageIds;</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-          m_runningUrl-&gt;CreateListOfMessageIdsString(getter_Copies(messageIds));</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+          m_runningUrl-&gt;GetListOfMessageIds(messageIds);</span>
<a href="#l3.52"></a><span id="l3.52"> </span>
<a href="#l3.53"></a><span id="l3.53">           // we don't want to send the flags back in a group</span>
<a href="#l3.54"></a><span id="l3.54">           //        GetServerStateParser().ResetFlagInfo(0);</span>
<a href="#l3.55"></a><span id="l3.55">           FetchMessage(messageIds,</span>
<a href="#l3.56"></a><span id="l3.56">             kHeadersRFC822andUid);</span>
<a href="#l3.57"></a><span id="l3.57">           // if we explicitly ask for headers, as opposed to getting them as a result</span>
<a href="#l3.58"></a><span id="l3.58">           // of selecting the folder, or biff, send the headerFetchCompleted notification</span>
<a href="#l3.59"></a><span id="l3.59">           // to flush out the header cache.</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineat">@@ -2543,45 +2543,45 @@ void nsImapProtocol::ProcessSelectedStat</span>
<a href="#l3.61"></a><span id="l3.61">           // drop the results on the floor for now</span>
<a href="#l3.62"></a><span id="l3.62">         }</span>
<a href="#l3.63"></a><span id="l3.63">         break;</span>
<a href="#l3.64"></a><span id="l3.64">       case nsIImapUrl::nsImapUserDefinedMsgCommand:</span>
<a href="#l3.65"></a><span id="l3.65">         {</span>
<a href="#l3.66"></a><span id="l3.66">           nsCString messageIdString;</span>
<a href="#l3.67"></a><span id="l3.67">           nsCString command;</span>
<a href="#l3.68"></a><span id="l3.68">           </span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-          m_runningUrl-&gt;GetCommand(getter_Copies(command));</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-          m_runningUrl-&gt;CreateListOfMessageIdsString(getter_Copies(messageIdString));</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+          m_runningUrl-&gt;GetCommand(command);</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+          m_runningUrl-&gt;GetListOfMessageIds(messageIdString);</span>
<a href="#l3.73"></a><span id="l3.73">           IssueUserDefinedMsgCommand(command.get(), messageIdString.get());</span>
<a href="#l3.74"></a><span id="l3.74">         }</span>
<a href="#l3.75"></a><span id="l3.75">         break;</span>
<a href="#l3.76"></a><span id="l3.76">       case nsIImapUrl::nsImapUserDefinedFetchAttribute:</span>
<a href="#l3.77"></a><span id="l3.77">         {</span>
<a href="#l3.78"></a><span id="l3.78">           nsCString messageIdString;</span>
<a href="#l3.79"></a><span id="l3.79">           nsCString attribute;</span>
<a href="#l3.80"></a><span id="l3.80">           </span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-          m_runningUrl-&gt;GetCustomAttributeToFetch(getter_Copies(attribute));</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-          m_runningUrl-&gt;CreateListOfMessageIdsString(getter_Copies(messageIdString));</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+          m_runningUrl-&gt;GetCustomAttributeToFetch(attribute);</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+          m_runningUrl-&gt;GetListOfMessageIds(messageIdString);</span>
<a href="#l3.85"></a><span id="l3.85">           FetchMsgAttribute(messageIdString, attribute);</span>
<a href="#l3.86"></a><span id="l3.86">         }</span>
<a href="#l3.87"></a><span id="l3.87">         break;</span>
<a href="#l3.88"></a><span id="l3.88">       case nsIImapUrl::nsImapMsgStoreCustomKeywords:</span>
<a href="#l3.89"></a><span id="l3.89">         {</span>
<a href="#l3.90"></a><span id="l3.90">           // if the server doesn't support user defined flags, don't try to set them.</span>
<a href="#l3.91"></a><span id="l3.91">           PRUint16 userFlags;</span>
<a href="#l3.92"></a><span id="l3.92">           GetSupportedUserFlags(&amp;userFlags);</span>
<a href="#l3.93"></a><span id="l3.93">           if (! (userFlags &amp; kImapMsgSupportUserFlag))</span>
<a href="#l3.94"></a><span id="l3.94">             break;</span>
<a href="#l3.95"></a><span id="l3.95">           nsCString messageIdString;</span>
<a href="#l3.96"></a><span id="l3.96">           nsCString addFlags;</span>
<a href="#l3.97"></a><span id="l3.97">           nsCString subtractFlags;</span>
<a href="#l3.98"></a><span id="l3.98">           </span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-          m_runningUrl-&gt;CreateListOfMessageIdsString(getter_Copies(messageIdString));</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-          m_runningUrl-&gt;GetCustomAddFlags(getter_Copies(addFlags));</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-          m_runningUrl-&gt;GetCustomSubtractFlags(getter_Copies(subtractFlags));</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+          m_runningUrl-&gt;GetListOfMessageIds(messageIdString);</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+          m_runningUrl-&gt;GetCustomAddFlags(addFlags);</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+          m_runningUrl-&gt;GetCustomSubtractFlags(subtractFlags);</span>
<a href="#l3.105"></a><span id="l3.105">           if (!addFlags.IsEmpty())</span>
<a href="#l3.106"></a><span id="l3.106">           {</span>
<a href="#l3.107"></a><span id="l3.107">             nsCAutoString storeString(&quot;+FLAGS (&quot;);</span>
<a href="#l3.108"></a><span id="l3.108">             storeString.Append(addFlags);</span>
<a href="#l3.109"></a><span id="l3.109">             storeString.Append(&quot;)&quot;);</span>
<a href="#l3.110"></a><span id="l3.110">             Store(messageIdString, storeString.get(), PR_TRUE);</span>
<a href="#l3.111"></a><span id="l3.111">           }</span>
<a href="#l3.112"></a><span id="l3.112">           if (!subtractFlags.IsEmpty())</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineat">@@ -2591,17 +2591,17 @@ void nsImapProtocol::ProcessSelectedStat</span>
<a href="#l3.114"></a><span id="l3.114">             storeString.Append(&quot;)&quot;);</span>
<a href="#l3.115"></a><span id="l3.115">             Store(messageIdString, storeString.get(), PR_TRUE);</span>
<a href="#l3.116"></a><span id="l3.116">           }</span>
<a href="#l3.117"></a><span id="l3.117">         }</span>
<a href="#l3.118"></a><span id="l3.118">         break;</span>
<a href="#l3.119"></a><span id="l3.119">       case nsIImapUrl::nsImapDeleteMsg:</span>
<a href="#l3.120"></a><span id="l3.120">         {</span>
<a href="#l3.121"></a><span id="l3.121">           nsCString messageIdString;</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineminus">-          m_runningUrl-&gt;CreateListOfMessageIdsString(getter_Copies(messageIdString));</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+          m_runningUrl-&gt;GetListOfMessageIds(messageIdString);</span>
<a href="#l3.124"></a><span id="l3.124">           </span>
<a href="#l3.125"></a><span id="l3.125">           ProgressEventFunctionUsingId (HandlingMultipleMessages(messageIdString) ? </span>
<a href="#l3.126"></a><span id="l3.126">                                       IMAP_DELETING_MESSAGES :IMAP_DELETING_MESSAGE);</span>
<a href="#l3.127"></a><span id="l3.127">           </span>
<a href="#l3.128"></a><span id="l3.128">           Store(messageIdString, &quot;+FLAGS (\\Deleted)&quot;,  bMessageIdsAreUids);</span>
<a href="#l3.129"></a><span id="l3.129"> </span>
<a href="#l3.130"></a><span id="l3.130">           if (GetServerStateParser().LastCommandSuccessful())</span>
<a href="#l3.131"></a><span id="l3.131">           {</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineat">@@ -2667,50 +2667,50 @@ void nsImapProtocol::ProcessSelectedStat</span>
<a href="#l3.133"></a><span id="l3.133">       case nsIImapUrl::nsImapAppendDraftFromFile:</span>
<a href="#l3.134"></a><span id="l3.134">         {</span>
<a href="#l3.135"></a><span id="l3.135">           OnAppendMsgFromFile();</span>
<a href="#l3.136"></a><span id="l3.136">         }</span>
<a href="#l3.137"></a><span id="l3.137">         break;</span>
<a href="#l3.138"></a><span id="l3.138">       case nsIImapUrl::nsImapAddMsgFlags:</span>
<a href="#l3.139"></a><span id="l3.139">         {</span>
<a href="#l3.140"></a><span id="l3.140">           nsCString messageIdString;</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-          m_runningUrl-&gt;CreateListOfMessageIdsString(getter_Copies(messageIdString));</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+          m_runningUrl-&gt;GetListOfMessageIds(messageIdString);</span>
<a href="#l3.143"></a><span id="l3.143"> </span>
<a href="#l3.144"></a><span id="l3.144">           ProcessStoreFlags(messageIdString, bMessageIdsAreUids,</span>
<a href="#l3.145"></a><span id="l3.145">             msgFlags, PR_TRUE);</span>
<a href="#l3.146"></a><span id="l3.146">         }</span>
<a href="#l3.147"></a><span id="l3.147">         break;</span>
<a href="#l3.148"></a><span id="l3.148">       case nsIImapUrl::nsImapSubtractMsgFlags:</span>
<a href="#l3.149"></a><span id="l3.149">         {</span>
<a href="#l3.150"></a><span id="l3.150">           nsCString messageIdString;</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineminus">-          m_runningUrl-&gt;CreateListOfMessageIdsString(getter_Copies(messageIdString));</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+          m_runningUrl-&gt;GetListOfMessageIds(messageIdString);</span>
<a href="#l3.153"></a><span id="l3.153"> </span>
<a href="#l3.154"></a><span id="l3.154">           ProcessStoreFlags(messageIdString, bMessageIdsAreUids,</span>
<a href="#l3.155"></a><span id="l3.155">             msgFlags, PR_FALSE);</span>
<a href="#l3.156"></a><span id="l3.156">         }</span>
<a href="#l3.157"></a><span id="l3.157">         break;</span>
<a href="#l3.158"></a><span id="l3.158">       case nsIImapUrl::nsImapSetMsgFlags:</span>
<a href="#l3.159"></a><span id="l3.159">         {</span>
<a href="#l3.160"></a><span id="l3.160">           nsCString messageIdString;</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">-          m_runningUrl-&gt;CreateListOfMessageIdsString(getter_Copies(messageIdString));</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineplus">+          m_runningUrl-&gt;GetListOfMessageIds(messageIdString);</span>
<a href="#l3.163"></a><span id="l3.163"> </span>
<a href="#l3.164"></a><span id="l3.164">           ProcessStoreFlags(messageIdString, bMessageIdsAreUids,</span>
<a href="#l3.165"></a><span id="l3.165">             msgFlags, PR_TRUE);</span>
<a href="#l3.166"></a><span id="l3.166">           ProcessStoreFlags(messageIdString, bMessageIdsAreUids,</span>
<a href="#l3.167"></a><span id="l3.167">             ~msgFlags, PR_FALSE);</span>
<a href="#l3.168"></a><span id="l3.168">         }</span>
<a href="#l3.169"></a><span id="l3.169">         break;</span>
<a href="#l3.170"></a><span id="l3.170">       case nsIImapUrl::nsImapBiff:</span>
<a href="#l3.171"></a><span id="l3.171">         PeriodicBiff();</span>
<a href="#l3.172"></a><span id="l3.172">         break;</span>
<a href="#l3.173"></a><span id="l3.173">       case nsIImapUrl::nsImapOnlineCopy:</span>
<a href="#l3.174"></a><span id="l3.174">       case nsIImapUrl::nsImapOnlineMove:</span>
<a href="#l3.175"></a><span id="l3.175">         {</span>
<a href="#l3.176"></a><span id="l3.176">           nsCString messageIdString;</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineminus">-          m_runningUrl-&gt;CreateListOfMessageIdsString(getter_Copies(messageIdString));</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+          m_runningUrl-&gt;GetListOfMessageIds(messageIdString);</span>
<a href="#l3.179"></a><span id="l3.179">           char *destinationMailbox = OnCreateServerDestinationFolderPathString();</span>
<a href="#l3.180"></a><span id="l3.180"> </span>
<a href="#l3.181"></a><span id="l3.181">           if (destinationMailbox)</span>
<a href="#l3.182"></a><span id="l3.182">           {</span>
<a href="#l3.183"></a><span id="l3.183">             if (m_imapAction == nsIImapUrl::nsImapOnlineMove)</span>
<a href="#l3.184"></a><span id="l3.184">             {</span>
<a href="#l3.185"></a><span id="l3.185">               if (HandlingMultipleMessages(messageIdString))</span>
<a href="#l3.186"></a><span id="l3.186">                 ProgressEventFunctionUsingIdWithString (IMAP_MOVING_MESSAGES_TO, destinationMailbox);</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineat">@@ -2758,17 +2758,17 @@ void nsImapProtocol::ProcessSelectedStat</span>
<a href="#l3.188"></a><span id="l3.188">           else</span>
<a href="#l3.189"></a><span id="l3.189">             HandleMemoryFailure();</span>
<a href="#l3.190"></a><span id="l3.190">         }</span>
<a href="#l3.191"></a><span id="l3.191">         break;</span>
<a href="#l3.192"></a><span id="l3.192">       case nsIImapUrl::nsImapOnlineToOfflineCopy:</span>
<a href="#l3.193"></a><span id="l3.193">       case nsIImapUrl::nsImapOnlineToOfflineMove:</span>
<a href="#l3.194"></a><span id="l3.194">         {</span>
<a href="#l3.195"></a><span id="l3.195">           nsCString messageIdString;</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineminus">-          nsresult rv = m_runningUrl-&gt;CreateListOfMessageIdsString(getter_Copies(messageIdString));</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineplus">+          nsresult rv = m_runningUrl-&gt;GetListOfMessageIds(messageIdString);</span>
<a href="#l3.198"></a><span id="l3.198">           if (NS_SUCCEEDED(rv))</span>
<a href="#l3.199"></a><span id="l3.199">           {</span>
<a href="#l3.200"></a><span id="l3.200">             SetProgressString(IMAP_FOLDER_RECEIVING_MESSAGE_OF);</span>
<a href="#l3.201"></a><span id="l3.201">             m_progressIndex = 0;</span>
<a href="#l3.202"></a><span id="l3.202">             m_progressCount = CountMessagesInIdString(messageIdString.get());</span>
<a href="#l3.203"></a><span id="l3.203">             </span>
<a href="#l3.204"></a><span id="l3.204">             FetchMessage(messageIdString, kEveryThingRFC822Peek);</span>
<a href="#l3.205"></a><span id="l3.205"> </span>
<a href="#l3.206"></a><span id="l3.206" class="difflineat">@@ -3848,17 +3848,17 @@ void nsImapProtocol::ProcessMailboxUpdat</span>
<a href="#l3.207"></a><span id="l3.207">   if (!DeathSignalReceived() &amp;&amp; GetServerStateParser().NumberOfMessages())</span>
<a href="#l3.208"></a><span id="l3.208">   {</span>
<a href="#l3.209"></a><span id="l3.209">     if (handlePossibleUndo)</span>
<a href="#l3.210"></a><span id="l3.210">     {</span>
<a href="#l3.211"></a><span id="l3.211">       // undo any delete flags we may have asked to</span>
<a href="#l3.212"></a><span id="l3.212">       nsCString undoIdsStr;</span>
<a href="#l3.213"></a><span id="l3.213">       nsCAutoString undoIds;</span>
<a href="#l3.214"></a><span id="l3.214"> </span>
<a href="#l3.215"></a><span id="l3.215" class="difflineminus">-      GetCurrentUrl()-&gt;CreateListOfMessageIdsString(getter_Copies(undoIdsStr));</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+      GetCurrentUrl()-&gt;GetListOfMessageIds(undoIdsStr);</span>
<a href="#l3.217"></a><span id="l3.217">       undoIds.Assign(undoIdsStr);</span>
<a href="#l3.218"></a><span id="l3.218">       if (!undoIds.IsEmpty())</span>
<a href="#l3.219"></a><span id="l3.219">       {</span>
<a href="#l3.220"></a><span id="l3.220">         char firstChar = (char) undoIds.CharAt(0);</span>
<a href="#l3.221"></a><span id="l3.221">         undoIds.Cut(0, 1);  // remove first character</span>
<a href="#l3.222"></a><span id="l3.222">         // if this string started with a '-', then this is an undo of a delete</span>
<a href="#l3.223"></a><span id="l3.223">         // if its a '+' its a redo</span>
<a href="#l3.224"></a><span id="l3.224">         if (firstChar == '-')</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineat">@@ -5730,17 +5730,17 @@ void nsImapProtocol::UploadMessageFromFi</span>
<a href="#l3.226"></a><span id="l3.226">             m_imapMailFolderSink-&gt;SetAppendMsgUid(newKey, m_runningUrl);</span>
<a href="#l3.227"></a><span id="l3.227"> </span>
<a href="#l3.228"></a><span id="l3.228">           // Courier imap server seems to have problems with recently</span>
<a href="#l3.229"></a><span id="l3.229">           // appended messages. Noop seems to clear its confusion.</span>
<a href="#l3.230"></a><span id="l3.230">           if (FolderIsSelected(mailboxName))</span>
<a href="#l3.231"></a><span id="l3.231">               Noop();</span>
<a href="#l3.232"></a><span id="l3.232"> </span>
<a href="#l3.233"></a><span id="l3.233">           nsCString oldMsgId;</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineminus">-          rv = m_runningUrl-&gt;CreateListOfMessageIdsString(getter_Copies(oldMsgId));</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineplus">+          rv = m_runningUrl-&gt;GetListOfMessageIds(oldMsgId);</span>
<a href="#l3.236"></a><span id="l3.236">           if (NS_SUCCEEDED(rv) &amp;&amp; !oldMsgId.IsEmpty())</span>
<a href="#l3.237"></a><span id="l3.237">           {</span>
<a href="#l3.238"></a><span id="l3.238">             PRBool idsAreUids = PR_TRUE;</span>
<a href="#l3.239"></a><span id="l3.239">             m_runningUrl-&gt;MessageIdsAreUids(&amp;idsAreUids);</span>
<a href="#l3.240"></a><span id="l3.240">             Store(oldMsgId, &quot;+FLAGS (\\Deleted)&quot;, idsAreUids);</span>
<a href="#l3.241"></a><span id="l3.241">             UidExpunge(oldMsgId);</span>
<a href="#l3.242"></a><span id="l3.242">           }</span>
<a href="#l3.243"></a><span id="l3.243">         }</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineat">@@ -8581,17 +8581,17 @@ PRBool nsImapMockChannel::ReadFromLocalC</span>
<a href="#l3.245"></a><span id="l3.245">   PRBool useLocalCache = PR_FALSE;</span>
<a href="#l3.246"></a><span id="l3.246">   mailnewsUrl-&gt;GetMsgIsInLocalCache(&amp;useLocalCache);</span>
<a href="#l3.247"></a><span id="l3.247">   if (useLocalCache)</span>
<a href="#l3.248"></a><span id="l3.248">   {</span>
<a href="#l3.249"></a><span id="l3.249">     nsCAutoString messageIdString;</span>
<a href="#l3.250"></a><span id="l3.250"> </span>
<a href="#l3.251"></a><span id="l3.251">     SetupPartExtractorListener(imapUrl, m_channelListener);</span>
<a href="#l3.252"></a><span id="l3.252"> </span>
<a href="#l3.253"></a><span id="l3.253" class="difflineminus">-    imapUrl-&gt;CreateListOfMessageIdsString(getter_Copies(messageIdString));</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineplus">+    imapUrl-&gt;GetListOfMessageIds(messageIdString);</span>
<a href="#l3.255"></a><span id="l3.255">     nsCOMPtr &lt;nsIMsgFolder&gt; folder;</span>
<a href="#l3.256"></a><span id="l3.256">     rv = mailnewsUrl-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l3.257"></a><span id="l3.257">     if (folder &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l3.258"></a><span id="l3.258">     {</span>
<a href="#l3.259"></a><span id="l3.259">       // we want to create a file channel and read the msg from there.</span>
<a href="#l3.260"></a><span id="l3.260">       nsCOMPtr&lt;nsIInputStream&gt; fileStream;</span>
<a href="#l3.261"></a><span id="l3.261">       nsMsgKey msgKey = atoi(messageIdString.get());</span>
<a href="#l3.262"></a><span id="l3.262">       PRUint32 size, offset;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/imap/src/nsImapServerResponseParser.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapServerResponseParser.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -716,27 +716,27 @@ void nsImapServerResponseParser::respons</span>
<a href="#l4.4"></a><span id="l4.4">       else if (!PL_strcasecmp(fNextToken, &quot;XMAILBOXINFO&quot;))</span>
<a href="#l4.5"></a><span id="l4.5">         xmailboxinfo_data();</span>
<a href="#l4.6"></a><span id="l4.6">       else if (!PL_strcasecmp(fNextToken, &quot;XAOL-OPTION&quot;))</span>
<a href="#l4.7"></a><span id="l4.7">         skip_to_CRLF();</span>
<a href="#l4.8"></a><span id="l4.8">       else </span>
<a href="#l4.9"></a><span id="l4.9">       {</span>
<a href="#l4.10"></a><span id="l4.10">         // check if custom command</span>
<a href="#l4.11"></a><span id="l4.11">         nsCAutoString customCommand;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-        fServerConnection.GetCurrentUrl()-&gt;GetCommand(getter_Copies(customCommand));</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+        fServerConnection.GetCurrentUrl()-&gt;GetCommand(customCommand);</span>
<a href="#l4.14"></a><span id="l4.14">         if (customCommand.Equals(fNextToken))</span>
<a href="#l4.15"></a><span id="l4.15">         {</span>
<a href="#l4.16"></a><span id="l4.16">           nsCAutoString customCommandResponse;</span>
<a href="#l4.17"></a><span id="l4.17">           while (Connected() &amp;&amp; !fAtEndOfLine)</span>
<a href="#l4.18"></a><span id="l4.18">           {</span>
<a href="#l4.19"></a><span id="l4.19">             AdvanceToNextToken();</span>
<a href="#l4.20"></a><span id="l4.20">             customCommandResponse.Append(fNextToken);</span>
<a href="#l4.21"></a><span id="l4.21">             customCommandResponse.Append(&quot; &quot;);</span>
<a href="#l4.22"></a><span id="l4.22">           }</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-          fServerConnection.GetCurrentUrl()-&gt;SetCustomCommandResult(customCommandResponse.get());</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+          fServerConnection.GetCurrentUrl()-&gt;SetCustomCommandResult(customCommandResponse);</span>
<a href="#l4.25"></a><span id="l4.25">         }</span>
<a href="#l4.26"></a><span id="l4.26">         else</span>
<a href="#l4.27"></a><span id="l4.27">           SetSyntaxError(PR_TRUE);</span>
<a href="#l4.28"></a><span id="l4.28">       }</span>
<a href="#l4.29"></a><span id="l4.29">       break;</span>
<a href="#l4.30"></a><span id="l4.30">     case 'Q':</span>
<a href="#l4.31"></a><span id="l4.31">       if (!PL_strcasecmp(fNextToken, &quot;QUOTAROOT&quot;)  || !PL_strcasecmp(fNextToken, &quot;QUOTA&quot;))</span>
<a href="#l4.32"></a><span id="l4.32">         quota_data();</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineat">@@ -1327,25 +1327,25 @@ void nsImapServerResponseParser::msg_fet</span>
<a href="#l4.34"></a><span id="l4.34">       }</span>
<a href="#l4.35"></a><span id="l4.35">       else</span>
<a href="#l4.36"></a><span id="l4.36">       {</span>
<a href="#l4.37"></a><span id="l4.37">         nsImapAction imapAction; </span>
<a href="#l4.38"></a><span id="l4.38">         if (!fServerConnection.GetCurrentUrl())</span>
<a href="#l4.39"></a><span id="l4.39">           return;</span>
<a href="#l4.40"></a><span id="l4.40">         fServerConnection.GetCurrentUrl()-&gt;GetImapAction(&amp;imapAction);</span>
<a href="#l4.41"></a><span id="l4.41">         nsCAutoString userDefinedFetchAttribute;</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-        fServerConnection.GetCurrentUrl()-&gt;GetCustomAttributeToFetch(getter_Copies(userDefinedFetchAttribute));</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+        fServerConnection.GetCurrentUrl()-&gt;GetCustomAttributeToFetch(userDefinedFetchAttribute);</span>
<a href="#l4.44"></a><span id="l4.44">         if (imapAction == nsIImapUrl::nsImapUserDefinedFetchAttribute &amp;&amp; !strcmp(userDefinedFetchAttribute.get(), fNextToken))</span>
<a href="#l4.45"></a><span id="l4.45">         {</span>
<a href="#l4.46"></a><span id="l4.46">           AdvanceToNextToken();</span>
<a href="#l4.47"></a><span id="l4.47">           char *fetchResult = CreateParenGroup();</span>
<a href="#l4.48"></a><span id="l4.48">           // look through the tokens until we find the closing ')'</span>
<a href="#l4.49"></a><span id="l4.49">           // we can have a result like the following:</span>
<a href="#l4.50"></a><span id="l4.50">           // ((A B) (C D) (E F))</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-          fServerConnection.GetCurrentUrl()-&gt;SetCustomAttributeResult(fetchResult);</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+          fServerConnection.GetCurrentUrl()-&gt;SetCustomAttributeResult(nsDependentCString(fetchResult));</span>
<a href="#l4.53"></a><span id="l4.53">           PR_Free(fetchResult);</span>
<a href="#l4.54"></a><span id="l4.54">           break;</span>
<a href="#l4.55"></a><span id="l4.55">         }</span>
<a href="#l4.56"></a><span id="l4.56">         else</span>
<a href="#l4.57"></a><span id="l4.57">           SetSyntaxError(PR_TRUE);</span>
<a href="#l4.58"></a><span id="l4.58">       }</span>
<a href="#l4.59"></a><span id="l4.59">       </span>
<a href="#l4.60"></a><span id="l4.60">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -2592,17 +2592,17 @@ NS_IMETHODIMP nsImapService::NewURI(cons</span>
<a href="#l5.4"></a><span id="l5.4">         nsCOMPtr&lt;nsIImapMessageSink&gt; msgSink = do_QueryInterface(folder);</span>
<a href="#l5.5"></a><span id="l5.5">         rv = aImapUrl-&gt;SetImapMessageSink(msgSink);</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7">         nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder = do_QueryInterface(folder);</span>
<a href="#l5.8"></a><span id="l5.8">         rv = SetImapUrlSink(msgFolder, aImapUrl);	</span>
<a href="#l5.9"></a><span id="l5.9">         nsCAutoString msgKey;</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11">          nsCString messageIdString;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-         aImapUrl-&gt;CreateListOfMessageIdsString(getter_Copies(messageIdString));</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+         aImapUrl-&gt;GetListOfMessageIds(messageIdString);</span>
<a href="#l5.14"></a><span id="l5.14">          if (!messageIdString.IsEmpty())</span>
<a href="#l5.15"></a><span id="l5.15">         {</span>
<a href="#l5.16"></a><span id="l5.16">           PRBool useLocalCache = PR_FALSE;</span>
<a href="#l5.17"></a><span id="l5.17">           msgFolder-&gt;HasMsgOffline(atoi(messageIdString.get()), &amp;useLocalCache);  </span>
<a href="#l5.18"></a><span id="l5.18">           mailnewsUrl-&gt;SetMsgIsInLocalCache(useLocalCache);</span>
<a href="#l5.19"></a><span id="l5.19">         }</span>
<a href="#l5.20"></a><span id="l5.20">       }</span>
<a href="#l5.21"></a><span id="l5.21">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/imap/src/nsImapUrl.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapUrl.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,9 +1,9 @@</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l6.6"></a><span id="l6.6"> /* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l6.7"></a><span id="l6.7">  * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l6.8"></a><span id="l6.8">  *</span>
<a href="#l6.9"></a><span id="l6.9">  * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l6.10"></a><span id="l6.10">  * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l6.11"></a><span id="l6.11">  * the License. You may obtain a copy of the License at</span>
<a href="#l6.12"></a><span id="l6.12">  * http://www.mozilla.org/MPL/</span>
<a href="#l6.13"></a><span id="l6.13">  *</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineat">@@ -276,21 +276,20 @@ NS_IMETHODIMP nsImapUrl::CreateSearchCri</span>
<a href="#l6.15"></a><span id="l6.15">   // o.t. add lock protection..</span>
<a href="#l6.16"></a><span id="l6.16">   if (nsnull == aResult || !m_searchCriteriaString)</span>
<a href="#l6.17"></a><span id="l6.17">     return  NS_ERROR_NULL_POINTER;</span>
<a href="#l6.18"></a><span id="l6.18">   *aResult = strdup(m_searchCriteriaString);</span>
<a href="#l6.19"></a><span id="l6.19">   return NS_OK;</span>
<a href="#l6.20"></a><span id="l6.20"> }</span>
<a href="#l6.21"></a><span id="l6.21"> </span>
<a href="#l6.22"></a><span id="l6.22"> // this method gets called from the UI thread and the imap thread</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-NS_IMETHODIMP nsImapUrl::CreateListOfMessageIdsString(char ** aResult)</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetListOfMessageIds(nsACString &amp;aResult)</span>
<a href="#l6.25"></a><span id="l6.25"> {</span>
<a href="#l6.26"></a><span id="l6.26">   nsAutoCMonitor mon(this);</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">-  nsCAutoString newStr;</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">-  if (nsnull == aResult || !m_listOfMessageIds)</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+  if (!m_listOfMessageIds)</span>
<a href="#l6.30"></a><span id="l6.30">     return  NS_ERROR_NULL_POINTER;</span>
<a href="#l6.31"></a><span id="l6.31"> </span>
<a href="#l6.32"></a><span id="l6.32">   PRInt32 bytesToCopy = strlen(m_listOfMessageIds);</span>
<a href="#l6.33"></a><span id="l6.33"> </span>
<a href="#l6.34"></a><span id="l6.34">   // mime may have glommed a &quot;&amp;part=&quot; for a part download</span>
<a href="#l6.35"></a><span id="l6.35">   // we return the entire message and let mime extract</span>
<a href="#l6.36"></a><span id="l6.36">   // the part. Pop and news work this way also.</span>
<a href="#l6.37"></a><span id="l6.37">   // this algorithm truncates the &quot;&amp;part&quot; string.</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineat">@@ -301,74 +300,67 @@ NS_IMETHODIMP nsImapUrl::CreateListOfMes</span>
<a href="#l6.39"></a><span id="l6.39">     bytesToCopy = currentChar - m_listOfMessageIds;</span>
<a href="#l6.40"></a><span id="l6.40"> </span>
<a href="#l6.41"></a><span id="l6.41">   // we should also strip off anything after &quot;/;section=&quot;</span>
<a href="#l6.42"></a><span id="l6.42">   // since that can specify an IMAP MIME part</span>
<a href="#l6.43"></a><span id="l6.43">   char *wherePart = PL_strstr(m_listOfMessageIds, &quot;/;section=&quot;);</span>
<a href="#l6.44"></a><span id="l6.44">   if (wherePart)</span>
<a href="#l6.45"></a><span id="l6.45">     bytesToCopy = PR_MIN(bytesToCopy, wherePart - m_listOfMessageIds);</span>
<a href="#l6.46"></a><span id="l6.46"> </span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-  newStr.Assign(m_listOfMessageIds, bytesToCopy);</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-  *aResult = ToNewCString(newStr);</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+  aResult.Assign(m_listOfMessageIds, bytesToCopy);</span>
<a href="#l6.50"></a><span id="l6.50">   return NS_OK;</span>
<a href="#l6.51"></a><span id="l6.51"> }</span>
<a href="#l6.52"></a><span id="l6.52"> </span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetCommand(char **result)</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetCommand(nsACString &amp;result)</span>
<a href="#l6.55"></a><span id="l6.55"> {</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-  NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-  *result = strdup(m_command.get());</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-  return (*result) ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+  result = m_command;</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.61"></a><span id="l6.61"> }</span>
<a href="#l6.62"></a><span id="l6.62"> </span>
<a href="#l6.63"></a><span id="l6.63"> </span>
<a href="#l6.64"></a><span id="l6.64" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetCustomAttributeToFetch(char **result)</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetCustomAttributeToFetch(nsACString &amp;result)</span>
<a href="#l6.66"></a><span id="l6.66"> {</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-  NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineminus">-  *result = ToNewCString(m_msgFetchAttribute);</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineminus">-  return (*result) ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+  result = m_msgFetchAttribute;</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.72"></a><span id="l6.72"> }</span>
<a href="#l6.73"></a><span id="l6.73"> </span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetCustomAttributeResult(char **result)</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetCustomAttributeResult(nsACString &amp;result)</span>
<a href="#l6.76"></a><span id="l6.76"> {</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">-  NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-  *result = ToNewCString(m_customAttributeResult);</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-  return (*result) ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+  result = m_customAttributeResult;</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.82"></a><span id="l6.82"> }</span>
<a href="#l6.83"></a><span id="l6.83"> </span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-NS_IMETHODIMP nsImapUrl::SetCustomAttributeResult(const char *result)</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+NS_IMETHODIMP nsImapUrl::SetCustomAttributeResult(const nsACString &amp;result)</span>
<a href="#l6.86"></a><span id="l6.86"> {</span>
<a href="#l6.87"></a><span id="l6.87">   m_customAttributeResult = result;</span>
<a href="#l6.88"></a><span id="l6.88">   return NS_OK;</span>
<a href="#l6.89"></a><span id="l6.89"> }</span>
<a href="#l6.90"></a><span id="l6.90"> </span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetCustomCommandResult(char **result)</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetCustomCommandResult(nsACString &amp;result)</span>
<a href="#l6.93"></a><span id="l6.93"> {</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-  NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineminus">-  *result = strdup(m_customCommandResult.get());</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineminus">-  return (*result) ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+  result = m_customCommandResult;</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.99"></a><span id="l6.99"> }</span>
<a href="#l6.100"></a><span id="l6.100"> </span>
<a href="#l6.101"></a><span id="l6.101" class="difflineminus">-NS_IMETHODIMP nsImapUrl::SetCustomCommandResult(const char *result)</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+NS_IMETHODIMP nsImapUrl::SetCustomCommandResult(const nsACString &amp;result)</span>
<a href="#l6.103"></a><span id="l6.103"> {</span>
<a href="#l6.104"></a><span id="l6.104">   m_customCommandResult = result;</span>
<a href="#l6.105"></a><span id="l6.105">   return NS_OK;</span>
<a href="#l6.106"></a><span id="l6.106"> }</span>
<a href="#l6.107"></a><span id="l6.107"> </span>
<a href="#l6.108"></a><span id="l6.108" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetCustomAddFlags(char **aResult)</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetCustomAddFlags(nsACString &amp;aResult)</span>
<a href="#l6.110"></a><span id="l6.110"> {</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineminus">-  *aResult = ToNewCString(m_customAddFlags);</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineminus">-  return (*aResult) ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+  aResult = m_customAddFlags;</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.116"></a><span id="l6.116"> }</span>
<a href="#l6.117"></a><span id="l6.117"> </span>
<a href="#l6.118"></a><span id="l6.118" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetCustomSubtractFlags(char **aResult)</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetCustomSubtractFlags(nsACString &amp;aResult)</span>
<a href="#l6.120"></a><span id="l6.120"> {</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-  *aResult = ToNewCString(m_customSubtractFlags);</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">-  return (*aResult) ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+  aResult = m_customSubtractFlags;</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.126"></a><span id="l6.126"> }</span>
<a href="#l6.127"></a><span id="l6.127"> </span>
<a href="#l6.128"></a><span id="l6.128"> </span>
<a href="#l6.129"></a><span id="l6.129"> NS_IMETHODIMP nsImapUrl::GetImapPartToFetch(char **result)</span>
<a href="#l6.130"></a><span id="l6.130"> {</span>
<a href="#l6.131"></a><span id="l6.131">   //  here's the old code....</span>
<a href="#l6.132"></a><span id="l6.132"> </span>
<a href="#l6.133"></a><span id="l6.133">   // unforunately an imap part can have the form: /;section= OR</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

