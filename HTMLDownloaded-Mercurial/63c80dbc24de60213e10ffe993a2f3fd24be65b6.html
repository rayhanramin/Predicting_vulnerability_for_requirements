<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 28467:63c80dbc24de60213e10ffe993a2f3fd24be65b6</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 63c80dbc24de60213e10ffe993a2f3fd24be65b6" />
<meta property="og:url" content="/comm-central/rev/63c80dbc24de60213e10ffe993a2f3fd24be65b6" />
<meta property="og:description" content="Bug 1606284 - Remove the Mork address book provider; r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 63c80dbc24de60213e10ffe993a2f3fd24be65b6 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/63c80dbc24de60213e10ffe993a2f3fd24be65b6">shortlog</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/63c80dbc24de60213e10ffe993a2f3fd24be65b6">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/63c80dbc24de60213e10ffe993a2f3fd24be65b6">files</a> |
changeset |
<a href="/comm-central/raw-rev/63c80dbc24de60213e10ffe993a2f3fd24be65b6">raw</a>  | <a href="/comm-central/archive/63c80dbc24de60213e10ffe993a2f3fd24be65b6.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1606284">Bug 1606284</a> - Remove the Mork address book provider; r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 12 Dec 2019 17:30:11 +1300</td></tr>

<tr>
 <td>changeset 28467</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/63c80dbc24de60213e10ffe993a2f3fd24be65b6">63c80dbc24de60213e10ffe993a2f3fd24be65b6</a></td>
</tr>



<tr>
<td>parent 28466</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/233d0ff4e443d96ddeb1c518bd4bb3404de698e9">233d0ff4e443d96ddeb1c518bd4bb3404de698e9</a>
</td>
</tr>

<tr>
<td>child 28468</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/20abf751b302882b21564283e628455764d044a1">20abf751b302882b21564283e628455764d044a1</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=63c80dbc24de60213e10ffe993a2f3fd24be65b6">16859</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Tue, 31 Dec 2019 10:27:23 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@4ac150bcbb59 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4ac150bcbb59400b3655dbaef3f2394614a25445">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4ac150bcbb59400b3655dbaef3f2394614a25445&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4ac150bcbb59400b3655dbaef3f2394614a25445&newProject=comm-central&newRevision=4893499305615273d93717274762db7801ea733b&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4ac150bcbb59400b3655dbaef3f2394614a25445&newProject=comm-central&newRevision=4893499305615273d93717274762db7801ea733b&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4ac150bcbb59400b3655dbaef3f2394614a25445&newProject=comm-central&newRevision=4893499305615273d93717274762db7801ea733b&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1606284">1606284</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1606284">Bug 1606284</a> - Remove the Mork address book provider; r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mail/base/modules/MailMigrator.jsm">mail/base/modules/MailMigrator.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mail/base/modules/MailMigrator.jsm">file</a> |
<a href="/comm-central/annotate/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mail/base/modules/MailMigrator.jsm">annotate</a> |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mail/base/modules/MailMigrator.jsm">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mail/base/modules/MailMigrator.jsm">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mail/base/modules/MailMigrator.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mail/components/addrbook/content/abTrees.js">mail/components/addrbook/content/abTrees.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mail/components/addrbook/content/abTrees.js">file</a> |
<a href="/comm-central/annotate/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mail/components/addrbook/content/abTrees.js">annotate</a> |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mail/components/addrbook/content/abTrees.js">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mail/components/addrbook/content/abTrees.js">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mail/components/addrbook/content/abTrees.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mail/components/extensions/test/xpcshell/test_ext_addressBook.js">mail/components/extensions/test/xpcshell/test_ext_addressBook.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mail/components/extensions/test/xpcshell/test_ext_addressBook.js">file</a> |
<a href="/comm-central/annotate/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mail/components/extensions/test/xpcshell/test_ext_addressBook.js">annotate</a> |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mail/components/extensions/test/xpcshell/test_ext_addressBook.js">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mail/components/extensions/test/xpcshell/test_ext_addressBook.js">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mail/components/extensions/test/xpcshell/test_ext_addressBook.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/public/moz.build">mailnews/addrbook/public/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/public/moz.build">file</a> |
<a href="/comm-central/annotate/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/public/moz.build">annotate</a> |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/public/moz.build">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/public/moz.build">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/public/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/public/nsAbBaseCID.h">mailnews/addrbook/public/nsAbBaseCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/public/nsAbBaseCID.h">file</a> |
<a href="/comm-central/annotate/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/public/nsAbBaseCID.h">annotate</a> |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/public/nsAbBaseCID.h">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/public/nsAbBaseCID.h">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/public/nsAbBaseCID.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/public/nsIAbDirectory.idl">mailnews/addrbook/public/nsIAbDirectory.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/public/nsIAbDirectory.idl">file</a> |
<a href="/comm-central/annotate/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/public/nsIAbDirectory.idl">annotate</a> |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/public/nsIAbDirectory.idl">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/public/nsIAbDirectory.idl">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/public/nsIAbDirectory.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/public/nsIAbMDBDirectory.idl">mailnews/addrbook/public/nsIAbMDBDirectory.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/public/nsIAbMDBDirectory.idl">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/public/nsIAbMDBDirectory.idl">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/public/nsIAbMDBDirectory.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/public/nsIAddrDatabase.idl">mailnews/addrbook/public/nsIAddrDatabase.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/public/nsIAddrDatabase.idl">file</a> |
<a href="/comm-central/annotate/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/public/nsIAddrDatabase.idl">annotate</a> |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/public/nsIAddrDatabase.idl">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/public/nsIAddrDatabase.idl">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/public/nsIAddrDatabase.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/moz.build">mailnews/addrbook/src/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/moz.build">file</a> |
<a href="/comm-central/annotate/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/moz.build">annotate</a> |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/moz.build">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/moz.build">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbBSDirectory.cpp">mailnews/addrbook/src/nsAbBSDirectory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbBSDirectory.cpp">file</a> |
<a href="/comm-central/annotate/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbBSDirectory.cpp">annotate</a> |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbBSDirectory.cpp">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbBSDirectory.cpp">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbBSDirectory.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">file</a> |
<a href="/comm-central/annotate/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">annotate</a> |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">mailnews/addrbook/src/nsAbLDAPDirectory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">file</a> |
<a href="/comm-central/annotate/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">annotate</a> |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbLDAPDirectory.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">mailnews/addrbook/src/nsAbLDAPReplicationData.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">file</a> |
<a href="/comm-central/annotate/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">annotate</a> |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBCard.cpp">mailnews/addrbook/src/nsAbMDBCard.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBCard.cpp">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBCard.cpp">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBCard.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBCard.h">mailnews/addrbook/src/nsAbMDBCard.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBCard.h">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBCard.h">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBCard.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBDirFactory.cpp">mailnews/addrbook/src/nsAbMDBDirFactory.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBDirFactory.cpp">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBDirFactory.cpp">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBDirFactory.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBDirFactory.h">mailnews/addrbook/src/nsAbMDBDirFactory.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBDirFactory.h">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBDirFactory.h">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBDirFactory.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">mailnews/addrbook/src/nsAbMDBDirProperty.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBDirProperty.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBDirProperty.h">mailnews/addrbook/src/nsAbMDBDirProperty.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBDirProperty.h">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBDirProperty.h">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBDirProperty.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBDirectory.cpp">mailnews/addrbook/src/nsAbMDBDirectory.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBDirectory.cpp">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBDirectory.cpp">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBDirectory.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBDirectory.h">mailnews/addrbook/src/nsAbMDBDirectory.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBDirectory.h">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBDirectory.h">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAbMDBDirectory.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAddrDatabase.cpp">mailnews/addrbook/src/nsAddrDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAddrDatabase.cpp">file</a> |
<a href="/comm-central/annotate/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAddrDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAddrDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAddrDatabase.cpp">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAddrDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAddrDatabase.h">mailnews/addrbook/src/nsAddrDatabase.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAddrDatabase.h">file</a> |
<a href="/comm-central/annotate/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAddrDatabase.h">annotate</a> |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAddrDatabase.h">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAddrDatabase.h">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsAddrDatabase.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsDirPrefs.cpp">mailnews/addrbook/src/nsDirPrefs.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsDirPrefs.cpp">file</a> |
<a href="/comm-central/annotate/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsDirPrefs.cpp">annotate</a> |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsDirPrefs.cpp">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsDirPrefs.cpp">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsDirPrefs.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsDirPrefs.h">mailnews/addrbook/src/nsDirPrefs.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsDirPrefs.h">file</a> |
<a href="/comm-central/annotate/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsDirPrefs.h">annotate</a> |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsDirPrefs.h">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsDirPrefs.h">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/src/nsDirPrefs.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/moz.build">mailnews/addrbook/test/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/moz.build">file</a> |
<a href="/comm-central/annotate/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/moz.build">annotate</a> |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/moz.build">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/moz.build">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/head.js">mailnews/addrbook/test/unit/head.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/head.js">file</a> |
<a href="/comm-central/annotate/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/head.js">annotate</a> |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/head.js">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/head.js">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/head.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/head_addrbook.js">mailnews/addrbook/test/unit/head_addrbook.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/head_addrbook.js">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/head_addrbook.js">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/head_addrbook.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/head_jsaddrbook.js">mailnews/addrbook/test/unit/head_jsaddrbook.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/head_jsaddrbook.js">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/head_jsaddrbook.js">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/head_jsaddrbook.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/test_db_enumerator.js">mailnews/addrbook/test/unit/test_db_enumerator.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/test_db_enumerator.js">file</a> |
<a href="/comm-central/annotate/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/test_db_enumerator.js">annotate</a> |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/test_db_enumerator.js">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/test_db_enumerator.js">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/test_db_enumerator.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/test_jsaddrbook.js">mailnews/addrbook/test/unit/test_jsaddrbook.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/test_jsaddrbook.js">file</a> |
<a href="/comm-central/annotate/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/test_jsaddrbook.js">annotate</a> |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/test_jsaddrbook.js">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/test_jsaddrbook.js">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/test_jsaddrbook.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/test_uid.js">mailnews/addrbook/test/unit/test_uid.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/test_uid.js">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/test_uid.js">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/test_uid.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/test_uuid.js">mailnews/addrbook/test/unit/test_uuid.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/test_uuid.js">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/test_uuid.js">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/test_uuid.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/xpcshell-jsaddrbook.ini">mailnews/addrbook/test/unit/xpcshell-jsaddrbook.ini</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/xpcshell-jsaddrbook.ini">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/xpcshell-jsaddrbook.ini">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/xpcshell-jsaddrbook.ini">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/xpcshell-mdbaddrbook.ini">mailnews/addrbook/test/unit/xpcshell-mdbaddrbook.ini</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/xpcshell-mdbaddrbook.ini">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/xpcshell-mdbaddrbook.ini">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/xpcshell-mdbaddrbook.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/xpcshell.ini">mailnews/addrbook/test/unit/xpcshell.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/xpcshell.ini">file</a> |
<a href="/comm-central/annotate/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/xpcshell.ini">annotate</a> |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/xpcshell.ini">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/xpcshell.ini">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/addrbook/test/unit/xpcshell.ini">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/build/nsMailModule.cpp">mailnews/build/nsMailModule.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/build/nsMailModule.cpp">file</a> |
<a href="/comm-central/annotate/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/build/nsMailModule.cpp">annotate</a> |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/build/nsMailModule.cpp">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/build/nsMailModule.cpp">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/build/nsMailModule.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/compose/src/nsMsgCompose.cpp">mailnews/compose/src/nsMsgCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/compose/src/nsMsgCompose.cpp">file</a> |
<a href="/comm-central/annotate/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/compose/src/nsMsgCompose.cpp">annotate</a> |
<a href="/comm-central/diff/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/compose/src/nsMsgCompose.cpp">diff</a> |
<a href="/comm-central/comparison/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/compose/src/nsMsgCompose.cpp">comparison</a> |
<a href="/comm-central/log/63c80dbc24de60213e10ffe993a2f3fd24be65b6/mailnews/compose/src/nsMsgCompose.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/modules/MailMigrator.jsm</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/modules/MailMigrator.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -730,18 +730,18 @@ var MailMigrator = {</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5">       let database = Cc[</span>
<a href="#l1.6"></a><span id="l1.6">         &quot;@mozilla.org/addressbook/carddatabase;1&quot;</span>
<a href="#l1.7"></a><span id="l1.7">       ].createInstance(Ci.nsIAddrDatabase);</span>
<a href="#l1.8"></a><span id="l1.8">       database.dbPath = oldFile;</span>
<a href="#l1.9"></a><span id="l1.9">       database.openMDB(oldFile, false);</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11">       let directory = Cc[</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-        &quot;@mozilla.org/addressbook/directory;1?type=moz-abmdbdirectory&quot;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-      ].createInstance(Ci.nsIAbMDBDirectory);</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+        &quot;@mozilla.org/addressbook/directoryproperty;1&quot;</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+      ].createInstance(Ci.nsIAbDirectory);</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17">       let cardMap = new Map();</span>
<a href="#l1.18"></a><span id="l1.18">       for (let card of database.enumerateCards(directory)) {</span>
<a href="#l1.19"></a><span id="l1.19">         if (!card.isMailList) {</span>
<a href="#l1.20"></a><span id="l1.20">           cardMap.set(card.localId, card);</span>
<a href="#l1.21"></a><span id="l1.21">         }</span>
<a href="#l1.22"></a><span id="l1.22">       }</span>
<a href="#l1.23"></a><span id="l1.23">       if (cardMap.size &gt; 0) {</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineat">@@ -753,18 +753,20 @@ var MailMigrator = {</span>
<a href="#l1.25"></a><span id="l1.25">               &quot;@mozilla.org/addressbook/directoryproperty;1&quot;</span>
<a href="#l1.26"></a><span id="l1.26">             ].createInstance(Ci.nsIAbDirectory);</span>
<a href="#l1.27"></a><span id="l1.27">             mailList.isMailList = true;</span>
<a href="#l1.28"></a><span id="l1.28">             mailList.dirName = card.displayName;</span>
<a href="#l1.29"></a><span id="l1.29">             mailList.listNickName = card.getProperty(&quot;NickName&quot;, &quot;&quot;);</span>
<a href="#l1.30"></a><span id="l1.30">             mailList.description = card.getProperty(&quot;Notes&quot;, &quot;&quot;);</span>
<a href="#l1.31"></a><span id="l1.31">             mailList = newBook.addMailList(mailList);</span>
<a href="#l1.32"></a><span id="l1.32"> </span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-            directory.dbRowID = card.localId;</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-            for (let listCard of database.enumerateListAddresses(directory)) {</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+            for (let listCard of database.enumerateListAddresses(</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+              directory,</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+              card.localId</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+            )) {</span>
<a href="#l1.39"></a><span id="l1.39">               listCard.QueryInterface(Ci.nsIAbCard);</span>
<a href="#l1.40"></a><span id="l1.40">               if (cardMap.has(listCard.localId)) {</span>
<a href="#l1.41"></a><span id="l1.41">                 mailList.addCard(cardMap.get(listCard.localId));</span>
<a href="#l1.42"></a><span id="l1.42">               }</span>
<a href="#l1.43"></a><span id="l1.43">             }</span>
<a href="#l1.44"></a><span id="l1.44">           }</span>
<a href="#l1.45"></a><span id="l1.45">         }</span>
<a href="#l1.46"></a><span id="l1.46">       }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/addrbook/content/abTrees.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/addrbook/content/abTrees.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -14,41 +14,29 @@ var { Services } = ChromeUtils.import(&quot;r</span>
<a href="#l2.4"></a><span id="l2.4"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l2.5"></a><span id="l2.5">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l2.6"></a><span id="l2.6"> );</span>
<a href="#l2.7"></a><span id="l2.7"> var { IOUtils } = ChromeUtils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> const DIRTYPE_JS = 101;</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11"> // Tree Sort helper methods.</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-var AB_ORDER = [</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-  &quot;aab&quot;,</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-  &quot;pab&quot;,</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-  &quot;mork&quot;,</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-  &quot;js&quot;,</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-  &quot;ldap&quot;,</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-  &quot;mapi+other&quot;,</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-  &quot;anyab&quot;,</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-  &quot;cab&quot;,</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-];</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+var AB_ORDER = [&quot;aab&quot;, &quot;pab&quot;, &quot;js&quot;, &quot;ldap&quot;, &quot;mapi+other&quot;, &quot;anyab&quot;, &quot;cab&quot;];</span>
<a href="#l2.23"></a><span id="l2.23"> </span>
<a href="#l2.24"></a><span id="l2.24"> function getDirectoryValue(aDir, aKey) {</span>
<a href="#l2.25"></a><span id="l2.25">   if (aKey == &quot;ab_type&quot;) {</span>
<a href="#l2.26"></a><span id="l2.26">     if (aDir._directory.URI == kAllDirectoryRoot + &quot;?&quot;) {</span>
<a href="#l2.27"></a><span id="l2.27">       return &quot;aab&quot;;</span>
<a href="#l2.28"></a><span id="l2.28">     }</span>
<a href="#l2.29"></a><span id="l2.29">     if (aDir._directory.URI == kPersonalAddressbookURI) {</span>
<a href="#l2.30"></a><span id="l2.30">       return &quot;pab&quot;;</span>
<a href="#l2.31"></a><span id="l2.31">     }</span>
<a href="#l2.32"></a><span id="l2.32">     if (aDir._directory.URI == kCollectedAddressbookURI) {</span>
<a href="#l2.33"></a><span id="l2.33">       return &quot;cab&quot;;</span>
<a href="#l2.34"></a><span id="l2.34">     }</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-    if (aDir._directory instanceof Ci.nsIAbMDBDirectory) {</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-      return &quot;mork&quot;;</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-    }</span>
<a href="#l2.38"></a><span id="l2.38">     if (aDir._directory.dirType == DIRTYPE_JS) {</span>
<a href="#l2.39"></a><span id="l2.39">       return &quot;js&quot;;</span>
<a href="#l2.40"></a><span id="l2.40">     }</span>
<a href="#l2.41"></a><span id="l2.41">     if (aDir._directory instanceof Ci.nsIAbLDAPDirectory) {</span>
<a href="#l2.42"></a><span id="l2.42">       return &quot;ldap&quot;;</span>
<a href="#l2.43"></a><span id="l2.43">     }</span>
<a href="#l2.44"></a><span id="l2.44"> </span>
<a href="#l2.45"></a><span id="l2.45">     // If there is any other AB type.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/extensions/test/xpcshell/test_ext_addressBook.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/extensions/test/xpcshell/test_ext_addressBook.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -608,21 +608,21 @@ add_task(async function test_addressBook</span>
<a href="#l3.4"></a><span id="l3.4">       return null;</span>
<a href="#l3.5"></a><span id="l3.5">     }</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7">     let parent = MailServices.ab.directories</span>
<a href="#l3.8"></a><span id="l3.8">       .getNext()</span>
<a href="#l3.9"></a><span id="l3.9">       .QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l3.10"></a><span id="l3.10">     switch (action) {</span>
<a href="#l3.11"></a><span id="l3.11">       case &quot;createAddressBook&quot;: {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-        const kPABDirectory = 2; // defined in nsDirPrefs.h</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+        const kJSDirectory = 101; // defined in nsDirPrefs.h</span>
<a href="#l3.14"></a><span id="l3.14">         let dirPrefId = MailServices.ab.newAddressBook(</span>
<a href="#l3.15"></a><span id="l3.15">           &quot;external add&quot;,</span>
<a href="#l3.16"></a><span id="l3.16">           &quot;&quot;,</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-          kPABDirectory</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+          kJSDirectory</span>
<a href="#l3.19"></a><span id="l3.19">         );</span>
<a href="#l3.20"></a><span id="l3.20">         let book = MailServices.ab.getDirectoryFromId(dirPrefId);</span>
<a href="#l3.21"></a><span id="l3.21">         extension.sendMessage(book.UID, dirPrefId);</span>
<a href="#l3.22"></a><span id="l3.22">         return;</span>
<a href="#l3.23"></a><span id="l3.23">       }</span>
<a href="#l3.24"></a><span id="l3.24">       case &quot;updateAddressBook&quot;: {</span>
<a href="#l3.25"></a><span id="l3.25">         let book = MailServices.ab.getDirectoryFromId(args[0]);</span>
<a href="#l3.26"></a><span id="l3.26">         book.dirName = &quot;external edit&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/addrbook/public/moz.build</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/addrbook/public/moz.build</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -13,17 +13,16 @@ XPIDL_SOURCES += [</span>
<a href="#l4.4"></a><span id="l4.4">     'nsIAbDirectoryQueryProxy.idl',</span>
<a href="#l4.5"></a><span id="l4.5">     'nsIAbDirFactory.idl',</span>
<a href="#l4.6"></a><span id="l4.6">     'nsIAbDirFactoryService.idl',</span>
<a href="#l4.7"></a><span id="l4.7">     'nsIAbDirSearchListener.idl',</span>
<a href="#l4.8"></a><span id="l4.8">     'nsIAbLDAPAttributeMap.idl',</span>
<a href="#l4.9"></a><span id="l4.9">     'nsIAbLDIFService.idl',</span>
<a href="#l4.10"></a><span id="l4.10">     'nsIAbListener.idl',</span>
<a href="#l4.11"></a><span id="l4.11">     'nsIAbManager.idl',</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    'nsIAbMDBDirectory.idl',</span>
<a href="#l4.13"></a><span id="l4.13">     'nsIAbView.idl',</span>
<a href="#l4.14"></a><span id="l4.14">     'nsIAddbookUrl.idl',</span>
<a href="#l4.15"></a><span id="l4.15">     'nsIAddrDatabase.idl',</span>
<a href="#l4.16"></a><span id="l4.16">     'nsIAddrDBAnnouncer.idl',</span>
<a href="#l4.17"></a><span id="l4.17">     'nsIAddrDBListener.idl',</span>
<a href="#l4.18"></a><span id="l4.18">     'nsIMsgVCardService.idl',</span>
<a href="#l4.19"></a><span id="l4.19"> ]</span>
<a href="#l4.20"></a><span id="l4.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/addrbook/public/nsAbBaseCID.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsAbBaseCID.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -150,56 +150,16 @@</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5"> #define NS_ABDIRFACTORYSERVICE_CID                   \</span>
<a href="#l5.6"></a><span id="l5.6">   {                                                  \</span>
<a href="#l5.7"></a><span id="l5.7">     0xF8B212F2, 0x742B, 0x4A48, {                    \</span>
<a href="#l5.8"></a><span id="l5.8">       0xB7, 0xA0, 0x4C, 0x44, 0xD4, 0xDD, 0xB1, 0x21 \</span>
<a href="#l5.9"></a><span id="l5.9">     }                                                \</span>
<a href="#l5.10"></a><span id="l5.10">   }</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-//</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-// mdb directory factory</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-//</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-#define NS_ABMDBDIRECTORY &quot;moz-abmdbdirectory&quot;</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-#define NS_ABMDBDIRFACTORY_CONTRACTID \</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-  NS_AB_DIRECTORY_FACTORY_CONTRACTID_PREFIX NS_ABMDBDIRECTORY</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-#define NS_ABMDBDIRFACTORY_CID                       \</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-  {                                                  \</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-    0xE1CB9C8A, 0x722D, 0x43E4, {                    \</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-      0x9D, 0x7B, 0x7C, 0xCA, 0xE4, 0xB0, 0x33, 0x8A \</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-    }                                                \</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-  }</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-//</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-// nsAbMDBDirectory</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-//</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-#define NS_ABMDBDIRECTORY_CONTRACTID \</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-  NS_AB_DIRECTORY_TYPE_CONTRACTID_PREFIX NS_ABMDBDIRECTORY</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-#define NS_ABMDBDIRECTORY_CID                        \</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-  {                                                  \</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-    0xe618f894, 0x1dd1, 0x11b2, {                    \</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-      0x88, 0x9c, 0x9a, 0xae, 0xfa, 0xa9, 0x0d, 0xde \</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-    }                                                \</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-  }</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-//</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-// nsAbMDBCard</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-//</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-#define NS_ABMDBCARD_CONTRACTID &quot;@mozilla.org/addressbook/moz-abmdbcard;1&quot;</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-#define NS_ABMDBCARD_CID                             \</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-  {                                                  \</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-    0xf578a5d2, 0x1dd1, 0x11b2, {                    \</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-      0x88, 0x41, 0xf4, 0x5c, 0xc5, 0xe7, 0x65, 0xf8 \</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-    }                                                \</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-  }</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">-</span>
<a href="#l5.52"></a><span id="l5.52"> #ifdef XP_WIN</span>
<a href="#l5.53"></a><span id="l5.53"> //</span>
<a href="#l5.54"></a><span id="l5.54"> // nsAbOutlookDirectory</span>
<a href="#l5.55"></a><span id="l5.55"> //</span>
<a href="#l5.56"></a><span id="l5.56"> #  define NS_ABOUTLOOKDIRECTORY_CONTRACTID \</span>
<a href="#l5.57"></a><span id="l5.57">     NS_AB_DIRECTORY_TYPE_CONTRACTID_PREFIX &quot;moz-aboutlookdirectory&quot;</span>
<a href="#l5.58"></a><span id="l5.58"> </span>
<a href="#l5.59"></a><span id="l5.59"> #  define NS_ABOUTLOOKDIRECTORY_CID                    \</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/addrbook/public/nsIAbDirectory.idl</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsIAbDirectory.idl</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -21,18 +21,16 @@ interface nsISimpleEnumerator;</span>
<a href="#l6.4"></a><span id="l6.4"> #define kPersonalAddressbookUri    &quot;jsaddrbook://abook.sqlite&quot;</span>
<a href="#l6.5"></a><span id="l6.5"> #define kCollectedAddressbook      &quot;history.sqlite&quot;</span>
<a href="#l6.6"></a><span id="l6.6"> #define kCollectedAddressbookUri   &quot;jsaddrbook://history.sqlite&quot;</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8"> #define kABFileName_PreviousSuffix &quot;.na2&quot; /* final v2 address book format */</span>
<a href="#l6.9"></a><span id="l6.9"> #define kABFileName_PreviousSuffixLen 4</span>
<a href="#l6.10"></a><span id="l6.10"> #define kABFileName_CurrentSuffix  &quot;.mab&quot; /* v3 address book extension */</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-#define kMDBAddressBook            &quot;abook.mab&quot;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-</span>
<a href="#l6.14"></a><span id="l6.14"> #define kJSDirectoryRoot           &quot;jsaddrbook://&quot;</span>
<a href="#l6.15"></a><span id="l6.15"> #define kJSAddressBook             &quot;abook.sqlite&quot;</span>
<a href="#l6.16"></a><span id="l6.16"> %}</span>
<a href="#l6.17"></a><span id="l6.17"> </span>
<a href="#l6.18"></a><span id="l6.18"> /**</span>
<a href="#l6.19"></a><span id="l6.19">  * A top-level address book directory.</span>
<a href="#l6.20"></a><span id="l6.20">  *</span>
<a href="#l6.21"></a><span id="l6.21">  * Please note that in order to be properly instantiated by nsIAbManager, every</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">deleted file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- a/mailnews/addrbook/public/nsIAbMDBDirectory.idl</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ /dev/null</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -1,71 +0,0 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineminus">-</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineminus">-</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-interface nsIFile;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-interface nsIAbDirectory;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-interface nsIAbCard;</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-interface nsIAddrDatabase;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-%{C++</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-#define kMDBDirectoryRoot          &quot;moz-abmdbdirectory://&quot;</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-#define kMDBDirectoryRootLen       21</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-%}</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-[scriptable, uuid(744072be-1ba0-46bc-af24-46e22567a2ea)]</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-interface nsIAbMDBDirectory : nsISupports {</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-  // Creates a directory component from the</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-  // uriName, adds it to its children and returns</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-  // the component</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-  nsIAbDirectory addDirectory(in string uriName);</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-  /**</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-   * Supplies a nsIFile point to the database file for this directory</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-   *</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-   * @exception NS_ERROR_NOT_INITIALIZED If there is no filename preference</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-   *                                     present or it is empty</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-   */</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-  readonly attribute nsIFile databaseFile;</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-  /**</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-   * Supplies a nsIAddrDatabase that uses the databaseFile. See also</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-   * databaseFile for possible exceptions.</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-   */</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-  readonly attribute nsIAddrDatabase database;</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-  // Mail list specific</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-  //</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-  // Removes all elements from the addressLists</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-  // property</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-  [noscript] void removeElementsFromAddressList();</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-  // Specific to a directory which stores mail lists</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-  //</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-  // Adds a directory to the addressLists attribute</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-  void addMailListToDirectory(in nsIAbDirectory mailList);</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-  // Specific to a directory which is a mail list</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-  //</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-  // Copies mail list properties from the srcList</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineminus">-  void copyDBMailList(in nsIAbMDBDirectory srcListDB);</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-  // Adds a card to the addressList attribute</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-  void addAddressToList(in nsIAbCard card);</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-  // Removes items from the addressLists member</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-  void removeEmailAddressAt(in unsigned long aIndex);</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-  attribute unsigned long dbRowID;</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-  // Empty implementation, called by the data base</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-  [noscript] void notifyDirItemAdded(in nsISupports item);</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-  [noscript] void clearDatabase();</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/addrbook/public/nsIAddrDatabase.idl</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsIAddrDatabase.idl</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -117,17 +117,18 @@ interface nsIAddrDatabase : nsIAddrDBAnn</span>
<a href="#l8.4"></a><span id="l8.4">   nsISimpleEnumerator enumerateCards(in nsIAbDirectory directory);</span>
<a href="#l8.5"></a><span id="l8.5"> </span>
<a href="#l8.6"></a><span id="l8.6">   /**</span>
<a href="#l8.7"></a><span id="l8.7">    * Enumerate the cards associated with the mailing lists in the directory.</span>
<a href="#l8.8"></a><span id="l8.8">    *</span>
<a href="#l8.9"></a><span id="l8.9">    * @param directory the directory of which to enumerate the cards.</span>
<a href="#l8.10"></a><span id="l8.10">    * @return an enumerator.</span>
<a href="#l8.11"></a><span id="l8.11">    */</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  nsISimpleEnumerator enumerateListAddresses(in nsIAbDirectory directory);</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+  nsISimpleEnumerator enumerateListAddresses(in nsIAbDirectory directory,</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+                                             in unsigned long listRowID);</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16">   void getMailingListsFromDB(in nsIAbDirectory parentDir);</span>
<a href="#l8.17"></a><span id="l8.17"> </span>
<a href="#l8.18"></a><span id="l8.18">   /**</span>
<a href="#l8.19"></a><span id="l8.19">    * Delete a card from the database.</span>
<a href="#l8.20"></a><span id="l8.20">    *</span>
<a href="#l8.21"></a><span id="l8.21">    * @param     aCard          the card to be deleted.</span>
<a href="#l8.22"></a><span id="l8.22">    * @param     aNotify        if set to true, all the listeners of the</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/addrbook/src/moz.build</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/addrbook/src/moz.build</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -16,20 +16,16 @@ SOURCES += [</span>
<a href="#l9.4"></a><span id="l9.4">     'nsAbCardProperty.cpp',</span>
<a href="#l9.5"></a><span id="l9.5">     'nsAbContentHandler.cpp',</span>
<a href="#l9.6"></a><span id="l9.6">     'nsAbDirectoryQuery.cpp',</span>
<a href="#l9.7"></a><span id="l9.7">     'nsAbDirectoryQueryProxy.cpp',</span>
<a href="#l9.8"></a><span id="l9.8">     'nsAbDirFactoryService.cpp',</span>
<a href="#l9.9"></a><span id="l9.9">     'nsAbDirProperty.cpp',</span>
<a href="#l9.10"></a><span id="l9.10">     'nsAbLDIFService.cpp',</span>
<a href="#l9.11"></a><span id="l9.11">     'nsAbManager.cpp',</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-    'nsAbMDBCard.cpp',</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-    'nsAbMDBDirectory.cpp',</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-    'nsAbMDBDirFactory.cpp',</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-    'nsAbMDBDirProperty.cpp',</span>
<a href="#l9.16"></a><span id="l9.16">     'nsAbQueryStringToExpression.cpp',</span>
<a href="#l9.17"></a><span id="l9.17">     'nsAbView.cpp',</span>
<a href="#l9.18"></a><span id="l9.18">     'nsAddbookProtocolHandler.cpp',</span>
<a href="#l9.19"></a><span id="l9.19">     'nsAddbookUrl.cpp',</span>
<a href="#l9.20"></a><span id="l9.20">     'nsAddrDatabase.cpp',</span>
<a href="#l9.21"></a><span id="l9.21">     'nsDirPrefs.cpp',</span>
<a href="#l9.22"></a><span id="l9.22">     'nsMsgVCardService.cpp',</span>
<a href="#l9.23"></a><span id="l9.23">     'nsVCard.cpp',</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbBSDirectory.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbBSDirectory.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -4,20 +4,19 @@</span>
<a href="#l10.4"></a><span id="l10.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6"> #include &quot;nsAbBSDirectory.h&quot;</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8"> #include &quot;nsDirPrefs.h&quot;</span>
<a href="#l10.9"></a><span id="l10.9"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l10.10"></a><span id="l10.10"> #include &quot;nsAddrDatabase.h&quot;</span>
<a href="#l10.11"></a><span id="l10.11"> #include &quot;nsIAbManager.h&quot;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-#include &quot;nsIAbMDBDirectory.h&quot;</span>
<a href="#l10.13"></a><span id="l10.13"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l10.14"></a><span id="l10.14"> #include &quot;nsAbDirFactoryService.h&quot;</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-#include &quot;nsAbMDBDirFactory.h&quot;</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+#include &quot;nsIAbDirFactory.h&quot;</span>
<a href="#l10.17"></a><span id="l10.17"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19"> #include &quot;nsCRTGlue.h&quot;</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21"> nsAbBSDirectory::nsAbBSDirectory() : mInitialized(false), mServers(13) {}</span>
<a href="#l10.22"></a><span id="l10.22"> </span>
<a href="#l10.23"></a><span id="l10.23"> nsAbBSDirectory::~nsAbBSDirectory() {}</span>
<a href="#l10.24"></a><span id="l10.24"> </span>
<a href="#l10.25"></a><span id="l10.25" class="difflineat">@@ -114,31 +113,16 @@ nsresult nsAbBSDirectory::EnsureInitiali</span>
<a href="#l10.26"></a><span id="l10.26">     if (((fileNameLen &gt; kABFileName_PreviousSuffixLen) &amp;&amp;</span>
<a href="#l10.27"></a><span id="l10.27">          strcmp(server-&gt;fileName + fileNameLen - kABFileName_PreviousSuffixLen,</span>
<a href="#l10.28"></a><span id="l10.28">                 kABFileName_PreviousSuffix) == 0) &amp;&amp;</span>
<a href="#l10.29"></a><span id="l10.29">         (server-&gt;dirType == PABDirectory))</span>
<a href="#l10.30"></a><span id="l10.30">       continue;</span>
<a href="#l10.31"></a><span id="l10.31"> </span>
<a href="#l10.32"></a><span id="l10.32">     // Set the uri property</span>
<a href="#l10.33"></a><span id="l10.33">     nsAutoCString URI(server-&gt;uri);</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-    // This is in case the uri is never set</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-    // in the nsDirPref.cpp code.</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-    if (!server-&gt;uri) {</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-      URI = NS_LITERAL_CSTRING(kMDBDirectoryRoot);</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-      URI += nsDependentCString(server-&gt;fileName);</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-    }</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-    /*</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-     * Check that we are not converting from a</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-     * a 4.x address book file e.g. pab.na2</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-     * check if the URI ends with &quot;.na2&quot;</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-     */</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-    if (StringEndsWith(URI, NS_LITERAL_CSTRING(kABFileName_PreviousSuffix)))</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-      URI.Replace(kMDBDirectoryRootLen, URI.Length() - kMDBDirectoryRootLen,</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-                  server-&gt;fileName);</span>
<a href="#l10.49"></a><span id="l10.49"> </span>
<a href="#l10.50"></a><span id="l10.50">     // Create the directories</span>
<a href="#l10.51"></a><span id="l10.51">     rv = CreateDirectoriesFromFactory(URI, server, false /* notify */);</span>
<a href="#l10.52"></a><span id="l10.52"> </span>
<a href="#l10.53"></a><span id="l10.53">     // If we failed, this could be because something has set a pref for us</span>
<a href="#l10.54"></a><span id="l10.54">     // which is now broke (e.g. no factory present). So just ignore this one</span>
<a href="#l10.55"></a><span id="l10.55">     // and move on.</span>
<a href="#l10.56"></a><span id="l10.56">     if (NS_FAILED(rv))</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineat">@@ -176,43 +160,35 @@ NS_IMETHODIMP nsAbBSDirectory::CreateNew</span>
<a href="#l10.58"></a><span id="l10.58">    * is more general.</span>
<a href="#l10.59"></a><span id="l10.59">    *</span>
<a href="#l10.60"></a><span id="l10.60">    */</span>
<a href="#l10.61"></a><span id="l10.61">   DIR_Server *server = nullptr;</span>
<a href="#l10.62"></a><span id="l10.62">   rv = DIR_AddNewAddressBook(aDirName, EmptyCString(), URI,</span>
<a href="#l10.63"></a><span id="l10.63">                              (DirectoryType)aType, aPrefName, &amp;server);</span>
<a href="#l10.64"></a><span id="l10.64">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.65"></a><span id="l10.65"> </span>
<a href="#l10.66"></a><span id="l10.66" class="difflineminus">-  if (aType == PABDirectory) {</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineminus">-    // Add the URI property</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineminus">-    URI.AssignLiteral(kMDBDirectoryRoot);</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-    URI.Append(nsDependentCString(server-&gt;fileName));</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineminus">-  } else if (aType == JSDirectory) {</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+  if (aType == JSDirectory) {</span>
<a href="#l10.72"></a><span id="l10.72">     URI.AssignLiteral(kJSDirectoryRoot);</span>
<a href="#l10.73"></a><span id="l10.73">     URI.Append(nsDependentCString(server-&gt;fileName));</span>
<a href="#l10.74"></a><span id="l10.74">   }</span>
<a href="#l10.75"></a><span id="l10.75"> </span>
<a href="#l10.76"></a><span id="l10.76">   aResult.Assign(server-&gt;prefName);</span>
<a href="#l10.77"></a><span id="l10.77"> </span>
<a href="#l10.78"></a><span id="l10.78">   rv = CreateDirectoriesFromFactory(URI, server, true /* notify */);</span>
<a href="#l10.79"></a><span id="l10.79">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.80"></a><span id="l10.80">   return rv;</span>
<a href="#l10.81"></a><span id="l10.81"> }</span>
<a href="#l10.82"></a><span id="l10.82"> </span>
<a href="#l10.83"></a><span id="l10.83"> NS_IMETHODIMP nsAbBSDirectory::CreateDirectoryByURI(</span>
<a href="#l10.84"></a><span id="l10.84">     const nsAString &amp;aDisplayName, const nsACString &amp;aURI) {</span>
<a href="#l10.85"></a><span id="l10.85">   nsresult rv = EnsureInitialized();</span>
<a href="#l10.86"></a><span id="l10.86">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.87"></a><span id="l10.87"> </span>
<a href="#l10.88"></a><span id="l10.88" class="difflineminus">-  nsCString fileName;</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineminus">-  if (StringBeginsWith(aURI, NS_LITERAL_CSTRING(kMDBDirectoryRoot)))</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineminus">-    fileName = Substring(aURI, kMDBDirectoryRootLen);</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineminus">-</span>
<a href="#l10.92"></a><span id="l10.92">   DIR_Server *server = nullptr;</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineminus">-  rv = DIR_AddNewAddressBook(aDisplayName, fileName, aURI, PABDirectory,</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+  rv = DIR_AddNewAddressBook(aDisplayName, EmptyCString(), aURI, PABDirectory,</span>
<a href="#l10.95"></a><span id="l10.95">                              EmptyCString(), &amp;server);</span>
<a href="#l10.96"></a><span id="l10.96">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.97"></a><span id="l10.97"> </span>
<a href="#l10.98"></a><span id="l10.98">   rv = CreateDirectoriesFromFactory(aURI, server, true /* notify */);</span>
<a href="#l10.99"></a><span id="l10.99">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.100"></a><span id="l10.100">   return rv;</span>
<a href="#l10.101"></a><span id="l10.101"> }</span>
<a href="#l10.102"></a><span id="l10.102"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -5,17 +5,16 @@</span>
<a href="#l11.4"></a><span id="l11.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6"> #include &quot;nsAbLDAPChangeLogData.h&quot;</span>
<a href="#l11.7"></a><span id="l11.7"> #include &quot;nsAbLDAPChangeLogQuery.h&quot;</span>
<a href="#l11.8"></a><span id="l11.8"> #include &quot;nsILDAPMessage.h&quot;</span>
<a href="#l11.9"></a><span id="l11.9"> #include &quot;nsIAddrBookSession.h&quot;</span>
<a href="#l11.10"></a><span id="l11.10"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l11.11"></a><span id="l11.11"> #include &quot;nsAbUtils.h&quot;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-#include &quot;nsAbMDBCard.h&quot;</span>
<a href="#l11.13"></a><span id="l11.13"> #include &quot;nsAbLDAPCard.h&quot;</span>
<a href="#l11.14"></a><span id="l11.14"> #include &quot;nsIAuthPrompt.h&quot;</span>
<a href="#l11.15"></a><span id="l11.15"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l11.16"></a><span id="l11.16"> #include &quot;nsIWindowWatcher.h&quot;</span>
<a href="#l11.17"></a><span id="l11.17"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l11.18"></a><span id="l11.18"> #include &quot;plstr.h&quot;</span>
<a href="#l11.19"></a><span id="l11.19"> #include &quot;nsILDAPErrors.h&quot;</span>
<a href="#l11.20"></a><span id="l11.20"> #include &quot;prmem.h&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirectory.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPDirectory.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -11,17 +11,16 @@</span>
<a href="#l12.4"></a><span id="l12.4"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l12.5"></a><span id="l12.5"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l12.6"></a><span id="l12.6"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l12.7"></a><span id="l12.7"> #include &quot;nsIIOService.h&quot;</span>
<a href="#l12.8"></a><span id="l12.8"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l12.9"></a><span id="l12.9"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l12.10"></a><span id="l12.10"> #include &quot;nsEnumeratorUtils.h&quot;</span>
<a href="#l12.11"></a><span id="l12.11"> #include &quot;nsIAbLDAPAttributeMap.h&quot;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-#include &quot;nsIAbMDBDirectory.h&quot;</span>
<a href="#l12.13"></a><span id="l12.13"> #include &quot;nsIAbManager.h&quot;</span>
<a href="#l12.14"></a><span id="l12.14"> #include &quot;nsIAddrDatabase.h&quot;</span>
<a href="#l12.15"></a><span id="l12.15"> #include &quot;nsILDAPURL.h&quot;</span>
<a href="#l12.16"></a><span id="l12.16"> #include &quot;nsILDAPConnection.h&quot;</span>
<a href="#l12.17"></a><span id="l12.17"> #include &quot;nsAppDirectoryServiceDefs.h&quot;</span>
<a href="#l12.18"></a><span id="l12.18"> #include &quot;nsDirectoryServiceUtils.h&quot;</span>
<a href="#l12.19"></a><span id="l12.19"> #include &quot;nsIFile.h&quot;</span>
<a href="#l12.20"></a><span id="l12.20"> #include &quot;nsILDAPModification.h&quot;</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineat">@@ -110,17 +109,17 @@ NS_IMETHODIMP nsAbLDAPDirectory::GetChil</span>
<a href="#l12.22"></a><span id="l12.22">     nsCString fileName;</span>
<a href="#l12.23"></a><span id="l12.23">     rv = GetReplicationFileName(fileName);</span>
<a href="#l12.24"></a><span id="l12.24">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.25"></a><span id="l12.25"> </span>
<a href="#l12.26"></a><span id="l12.26">     // if there is no fileName, bail out now.</span>
<a href="#l12.27"></a><span id="l12.27">     if (fileName.IsEmpty()) return NS_OK;</span>
<a href="#l12.28"></a><span id="l12.28"> </span>
<a href="#l12.29"></a><span id="l12.29">     // perform the same query, but on the local directory</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-    nsAutoCString localDirectoryURI(NS_LITERAL_CSTRING(kMDBDirectoryRoot));</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+    nsAutoCString localDirectoryURI(NS_LITERAL_CSTRING(kJSDirectoryRoot));</span>
<a href="#l12.32"></a><span id="l12.32">     localDirectoryURI.Append(fileName);</span>
<a href="#l12.33"></a><span id="l12.33">     if (mIsQueryURI) {</span>
<a href="#l12.34"></a><span id="l12.34">       localDirectoryURI.Append('?');</span>
<a href="#l12.35"></a><span id="l12.35">       localDirectoryURI.Append(mQueryString);</span>
<a href="#l12.36"></a><span id="l12.36">     }</span>
<a href="#l12.37"></a><span id="l12.37"> </span>
<a href="#l12.38"></a><span id="l12.38">     nsCOMPtr&lt;nsIAbManager&gt; abManager(</span>
<a href="#l12.39"></a><span id="l12.39">         do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -209,17 +209,18 @@ nsresult nsAbLDAPProcessReplicationData:</span>
<a href="#l13.4"></a><span id="l13.4">   // take care of entries returned by LDAP Connection thread after Abort.</span>
<a href="#l13.5"></a><span id="l13.5">   if (!mReplicationDB || !mDBOpen) return NS_ERROR_FAILURE;</span>
<a href="#l13.6"></a><span id="l13.6"> </span>
<a href="#l13.7"></a><span id="l13.7">   nsresult rv = NS_OK;</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9">   // Although we would may naturally create an nsIAbLDAPCard here, we don't</span>
<a href="#l13.10"></a><span id="l13.10">   // need to as we are writing this straight to the database, so just create</span>
<a href="#l13.11"></a><span id="l13.11">   // the database version instead.</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-  nsCOMPtr&lt;nsIAbCard&gt; newCard(do_CreateInstance(NS_ABMDBCARD_CONTRACTID, &amp;rv));</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+  nsCOMPtr&lt;nsIAbCard&gt; newCard(</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+      do_CreateInstance(NS_ABCARDPROPERTY_CONTRACTID, &amp;rv));</span>
<a href="#l13.15"></a><span id="l13.15">   if (NS_FAILED(rv)) {</span>
<a href="#l13.16"></a><span id="l13.16">     Abort();</span>
<a href="#l13.17"></a><span id="l13.17">     return rv;</span>
<a href="#l13.18"></a><span id="l13.18">   }</span>
<a href="#l13.19"></a><span id="l13.19"> </span>
<a href="#l13.20"></a><span id="l13.20">   rv = mAttrMap-&gt;SetCardPropertiesFromLDAPMessage(aMessage, newCard);</span>
<a href="#l13.21"></a><span id="l13.21">   if (NS_FAILED(rv)) {</span>
<a href="#l13.22"></a><span id="l13.22">     NS_WARNING(</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">deleted file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBCard.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ /dev/null</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -1,49 +0,0 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineminus">-</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineminus">-#include &quot;nsAbMDBCard.h&quot;</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineminus">-</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-nsAbMDBCard::nsAbMDBCard(void) {}</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-nsAbMDBCard::~nsAbMDBCard(void) {}</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED0(nsAbMDBCard, nsAbCardProperty)</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-NS_IMETHODIMP nsAbMDBCard::Equals(nsIAbCard *card, bool *result) {</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-  NS_ENSURE_ARG_POINTER(card);</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-  NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-  if (this == card) {</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-    *result = true;</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-    return NS_OK;</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineminus">-  }</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">-  // If we have the same directory, we will equal the other card merely given</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-  // the row IDs. If not, we are never equal. But we are dumb in that we don't</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-  // know who our directory is, which may change in the future. For now,</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-  // however, the only known users of this method are for locating us in a list</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-  // of cards, most commonly mailing lists; a warning on the IDL has also</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-  // notified consumers that this method is not generally safe to use. In this</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-  // respect, it is safe to assume that the directory portion is satisfied when</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-  // making this call.</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">-  // However, if we make the wrong assumption, one of two things will happen.</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineminus">-  // If the other directory is a local address book, we could return a spurious</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineminus">-  // true result. If not, then DbRowID should be unset and we can definitively</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">-  // return false.</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-  uint32_t row;</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-  nsresult rv = card-&gt;GetPropertyAsUint32(&quot;DbRowID&quot;, &amp;row);</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-  if (NS_FAILED(rv)) {</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-    *result = false;</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineminus">-    return NS_OK;</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">-  }</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-  uint32_t ourRow;</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-  rv = GetPropertyAsUint32(&quot;DbRowID&quot;, &amp;ourRow);</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineminus">-  *result = (row == ourRow);</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineminus">-  return NS_OK;</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">deleted file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBCard.h</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ /dev/null</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -1,25 +0,0 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineminus">-</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineminus">-#ifndef nsAbMDBCard_h__</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineminus">-#define nsAbMDBCard_h__</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-#include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-#include &quot;nsAbCardProperty.h&quot;</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">-</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-class nsAbMDBCard : public nsAbCardProperty {</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">- public:</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-  NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineminus">-</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineminus">-  nsAbMDBCard(void);</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineminus">-</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">-  NS_IMETHOD Equals(nsIAbCard *card, bool *result) override;</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineminus">-</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineminus">- private:</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineminus">-  virtual ~nsAbMDBCard();</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineminus">-};</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineminus">-</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineminus">-#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">deleted file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBDirFactory.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ /dev/null</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -1,106 +0,0 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineminus">-</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineminus">-#include &quot;nsAbMDBDirFactory.h&quot;</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineminus">-#include &quot;nsAbUtils.h&quot;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-#include &quot;nsIFile.h&quot;</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-#include &quot;nsIAbManager.h&quot;</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineminus">-#include &quot;nsIAbMDBDirectory.h&quot;</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineminus">-#include &quot;nsAbMDBDirFactory.h&quot;</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-#include &quot;nsIAddrDatabase.h&quot;</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">-#include &quot;nsEnumeratorUtils.h&quot;</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineminus">-#include &quot;nsIMutableArray.h&quot;</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineminus">-#include &quot;nsArrayUtils.h&quot;</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineminus">-#include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineminus">-</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineminus">-NS_IMPL_ISUPPORTS(nsAbMDBDirFactory, nsIAbDirFactory)</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineminus">-</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineminus">-nsAbMDBDirFactory::nsAbMDBDirFactory() {}</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineminus">-</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineminus">-nsAbMDBDirFactory::~nsAbMDBDirFactory() {}</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineminus">-</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirFactory::GetDirectories(const nsAString &amp;aDirName,</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-                                                const nsACString &amp;aURI,</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-                                                const nsACString &amp;aPrefName,</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-                                                nsISimpleEnumerator **_retval) {</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineminus">-</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineminus">-  nsresult rv;</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineminus">-</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">-      do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineminus">-</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineminus">-  rv = abManager-&gt;GetDirectory(aURI, getter_AddRefs(directory));</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineminus">-</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineminus">-  rv = directory-&gt;SetDirPrefId(aPrefName);</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineminus">-</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; dbPath;</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineminus">-  rv = abManager-&gt;GetUserProfileDirectory(getter_AddRefs(dbPath));</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineminus">-</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineminus">-  nsCOMPtr&lt;nsIAddrDatabase&gt; listDatabase;</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineminus">-  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineminus">-    nsAutoCString fileName;</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineminus">-</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineminus">-    if (StringBeginsWith(aURI, NS_LITERAL_CSTRING(kMDBDirectoryRoot)))</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineminus">-      fileName = Substring(aURI, kMDBDirectoryRootLen,</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineminus">-                           aURI.Length() - kMDBDirectoryRootLen);</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineminus">-</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineminus">-    rv = dbPath-&gt;AppendNative(fileName);</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineminus">-</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineminus">-    nsCOMPtr&lt;nsIAddrDatabase&gt; addrDBFactory =</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineminus">-        do_GetService(NS_ADDRDATABASE_CONTRACTID, &amp;rv);</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineminus">-</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineminus">-    rv = addrDBFactory-&gt;Open(dbPath, true, true, getter_AddRefs(listDatabase));</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineminus">-  }</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineminus">-</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineminus">-  rv = listDatabase-&gt;GetMailingListsFromDB(directory);</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineminus">-</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineminus">-  return NS_NewSingletonEnumerator(_retval, directory);</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineminus">-}</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineminus">-</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineminus">-/* void deleteDirectory (in nsIAbDirectory directory); */</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirFactory::DeleteDirectory(nsIAbDirectory *directory) {</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineminus">-  if (!directory) return NS_ERROR_NULL_POINTER;</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineminus">-</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineminus">-</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; pAddressLists;</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineminus">-  rv = directory-&gt;GetAddressLists(getter_AddRefs(pAddressLists));</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineminus">-</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineminus">-  uint32_t total;</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineminus">-  rv = pAddressLists-&gt;GetLength(&amp;total);</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineminus">-</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineminus">-  for (uint32_t i = 0; i &lt; total; i++) {</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineminus">-    nsCOMPtr&lt;nsIAbDirectory&gt; listDir(do_QueryElementAt(pAddressLists, i, &amp;rv));</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineminus">-    if (NS_FAILED(rv)) break;</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineminus">-</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineminus">-    nsCOMPtr&lt;nsIAbMDBDirectory&gt; dblistDir(do_QueryInterface(listDir, &amp;rv));</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineminus">-    if (NS_FAILED(rv)) break;</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineminus">-</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineminus">-    rv = directory-&gt;DeleteDirectory(listDir);</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineminus">-    if (NS_FAILED(rv)) break;</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineminus">-</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineminus">-    rv = dblistDir-&gt;RemoveElementsFromAddressList();</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineminus">-    if (NS_FAILED(rv)) break;</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineminus">-  }</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineminus">-  pAddressLists-&gt;Clear();</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineminus">-</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineminus">-  nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbdirectory(do_QueryInterface(directory, &amp;rv));</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineminus">-</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineminus">-  return dbdirectory-&gt;ClearDatabase();</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">deleted file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBDirFactory.h</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ /dev/null</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -1,22 +0,0 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineminus">-</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineminus">-#ifndef nsAbMDBDirFactory_h__</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineminus">-#define nsAbMDBDirFactory_h__</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-#include &quot;nsIAbDirFactory.h&quot;</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-class nsAbMDBDirFactory : public nsIAbDirFactory {</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">- public:</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-  NS_DECL_ISUPPORTS</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineminus">-  NS_DECL_NSIABDIRFACTORY</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">-  nsAbMDBDirFactory();</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineminus">-</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">- private:</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineminus">-  virtual ~nsAbMDBDirFactory();</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineminus">-};</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineminus">-</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineminus">-#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">deleted file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBDirProperty.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineplus">+++ /dev/null</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineat">@@ -1,121 +0,0 @@</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.7"></a><span id="l18.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.8"></a><span id="l18.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineminus">-</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineminus">-#include &quot;nsAbMDBDirProperty.h&quot;</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-#include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-#include &quot;nsAddrDatabase.h&quot;</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">-#include &quot;nsIAbCard.h&quot;</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineminus">-#include &quot;nsArrayUtils.h&quot;</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineminus">-#include &quot;mdb.h&quot;</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineminus">-#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineminus">-#include &quot;nsIWeakReference.h&quot;</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineminus">-</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineminus">-nsAbMDBDirProperty::nsAbMDBDirProperty(void) : nsAbDirProperty() {</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineminus">-  m_dbRowID = 0;</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineminus">-}</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineminus">-</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineminus">-nsAbMDBDirProperty::~nsAbMDBDirProperty(void) {}</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineminus">-</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED(nsAbMDBDirProperty, nsAbDirProperty, nsIAbDirectory,</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineminus">-                            nsISupportsWeakReference, nsIAbMDBDirectory)</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineminus">-</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineminus">-// nsIAbMDBDirectory attributes</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirProperty::GetDbRowID(uint32_t *aDbRowID) {</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineminus">-  *aDbRowID = m_dbRowID;</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineminus">-  return NS_OK;</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineminus">-}</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineminus">-</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirProperty::SetDbRowID(uint32_t aDbRowID) {</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineminus">-  m_dbRowID = aDbRowID;</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineminus">-  return NS_OK;</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineminus">-}</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineminus">-</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineminus">-// nsIAbMDBDirectory methods</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineminus">-</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineminus">-/* add mailing list to the parent directory */</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirProperty::AddMailListToDirectory(</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineminus">-    nsIAbDirectory *mailList) {</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineminus">-  if (!m_AddressList) {</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineminus">-    nsresult rv;</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineminus">-    m_AddressList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineminus">-  }</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineminus">-</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineminus">-  uint32_t position;</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineminus">-  if (NS_FAILED(m_AddressList-&gt;IndexOf(0, mailList, &amp;position)))</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineminus">-    m_AddressList-&gt;AppendElement(mailList);</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineminus">-</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineminus">-  return NS_OK;</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineminus">-}</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineminus">-</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineminus">-/* add addresses to the mailing list */</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirProperty::AddAddressToList(nsIAbCard *card) {</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineminus">-  if (!m_AddressList) {</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineminus">-    nsresult rv;</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineminus">-    m_AddressList = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineminus">-  }</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineminus">-</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineminus">-  uint32_t position;</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineminus">-  if (NS_FAILED(m_AddressList-&gt;IndexOf(0, card, &amp;position)))</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineminus">-    m_AddressList-&gt;AppendElement(card);</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineminus">-</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineminus">-  return NS_OK;</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineminus">-}</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineminus">-</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirProperty::CopyDBMailList(nsIAbMDBDirectory *srcListDB) {</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineminus">-  nsresult err = NS_OK;</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; srcList(do_QueryInterface(srcListDB));</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineminus">-  if (NS_FAILED(err)) return NS_ERROR_NULL_POINTER;</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineminus">-</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineminus">-  CopyMailList(srcList);</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineminus">-</span>
<a href="#l18.84"></a><span id="l18.84" class="difflineminus">-  uint32_t rowID;</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineminus">-  srcListDB-&gt;GetDbRowID(&amp;rowID);</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineminus">-  SetDbRowID(rowID);</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineminus">-</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineminus">-  return NS_OK;</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineminus">-}</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineminus">-</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineminus">-// nsIAbMDBDirectory NOT IMPLEMENTED methods</span>
<a href="#l18.92"></a><span id="l18.92" class="difflineminus">-</span>
<a href="#l18.93"></a><span id="l18.93" class="difflineminus">-/* nsIAbDirectory addDirectory (in string uriName); */</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirProperty::AddDirectory(const char *uriName,</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineminus">-                                               nsIAbDirectory **_retval) {</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l18.97"></a><span id="l18.97" class="difflineminus">-}</span>
<a href="#l18.98"></a><span id="l18.98" class="difflineminus">-</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineminus">-/* [noscript] void removeElementsFromAddressList (); */</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirProperty::RemoveElementsFromAddressList() {</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineminus">-}</span>
<a href="#l18.103"></a><span id="l18.103" class="difflineminus">-</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineminus">-/* void removeEmailAddressAt (in unsigned long aIndex); */</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirProperty::RemoveEmailAddressAt(uint32_t aIndex) {</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l18.107"></a><span id="l18.107" class="difflineminus">-}</span>
<a href="#l18.108"></a><span id="l18.108" class="difflineminus">-</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineminus">-/* [noscript] void notifyDirItemAdded (in nsISupports item); */</span>
<a href="#l18.110"></a><span id="l18.110" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirProperty::NotifyDirItemAdded(nsISupports *item) {</span>
<a href="#l18.111"></a><span id="l18.111" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l18.112"></a><span id="l18.112" class="difflineminus">-}</span>
<a href="#l18.113"></a><span id="l18.113" class="difflineminus">-</span>
<a href="#l18.114"></a><span id="l18.114" class="difflineminus">-/* [noscript] void clearDatabase (); */</span>
<a href="#l18.115"></a><span id="l18.115" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirProperty::ClearDatabase() {</span>
<a href="#l18.116"></a><span id="l18.116" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineminus">-}</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineminus">-</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirProperty::GetDatabaseFile(nsIFile **aResult) {</span>
<a href="#l18.120"></a><span id="l18.120" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineminus">-}</span>
<a href="#l18.122"></a><span id="l18.122" class="difflineminus">-</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirProperty::GetDatabase(nsIAddrDatabase **aResult) {</span>
<a href="#l18.124"></a><span id="l18.124" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l18.125"></a><span id="l18.125" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1">deleted file mode 100644</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBDirProperty.h</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineplus">+++ /dev/null</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineat">@@ -1,36 +0,0 @@</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l19.6"></a><span id="l19.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l19.7"></a><span id="l19.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l19.8"></a><span id="l19.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineminus">-</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineminus">-/********************************************************************************************************</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineminus">-</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-   Interface for representing Address Book Directory</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-*********************************************************************************************************/</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">-</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineminus">-#ifndef nsAbMDBDirProperty_h__</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineminus">-#define nsAbMDBDirProperty_h__</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineminus">-</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineminus">-#include &quot;nsIAbMDBDirectory.h&quot;</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineminus">-#include &quot;nsAbDirProperty.h&quot;</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineminus">-</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineminus">-/*</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineminus">- * Address Book Directory</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineminus">- */</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineminus">-</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineminus">-class nsAbMDBDirProperty : public nsIAbMDBDirectory, public nsAbDirProperty {</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineminus">- public:</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineminus">-  nsAbMDBDirProperty(void);</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineminus">-</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-  NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-  NS_DECL_NSIABMDBDIRECTORY</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineminus">-</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineminus">- protected:</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineminus">-  virtual ~nsAbMDBDirProperty();</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineminus">-</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineminus">-  uint32_t m_dbRowID;</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineminus">-};</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineminus">-</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineminus">-#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1">deleted file mode 100644</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBDirectory.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineplus">+++ /dev/null</span>
<a href="#l20.4"></a><span id="l20.4" class="difflineat">@@ -1,1045 +0,0 @@</span>
<a href="#l20.5"></a><span id="l20.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l20.6"></a><span id="l20.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.7"></a><span id="l20.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.8"></a><span id="l20.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.9"></a><span id="l20.9" class="difflineminus">-</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineminus">-#include &quot;nsAbMDBDirectory.h&quot;</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-#include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-#include &quot;nsAddrDatabase.h&quot;</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">-#include &quot;nsIAbManager.h&quot;</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineminus">-#include &quot;nsNetCID.h&quot;</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-#include &quot;nsAbDirectoryQuery.h&quot;</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-#include &quot;nsIAbDirectoryQueryProxy.h&quot;</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-#include &quot;nsAbQueryStringToExpression.h&quot;</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineminus">-#include &quot;nsIMutableArray.h&quot;</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineminus">-#include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineminus">-#include &quot;nsEnumeratorUtils.h&quot;</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineminus">-#include &quot;mdb.h&quot;</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineminus">-#include &quot;prprf.h&quot;</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineminus">-#include &quot;nsIPrefService.h&quot;</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineminus">-#include &quot;nsAppDirectoryServiceDefs.h&quot;</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineminus">-#include &quot;nsDirectoryServiceUtils.h&quot;</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineminus">-#include &quot;nsIFile.h&quot;</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineminus">-#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-#include &quot;nsMemory.h&quot;</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-#include &quot;nsArrayUtils.h&quot;</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineminus">-#include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-#include &quot;mozilla/DebugOnly.h&quot;</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineminus">-#include &quot;nsIObserverService.h&quot;</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineminus">-#include &quot;mozilla/Services.h&quot;</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineminus">-nsAbMDBDirectory::nsAbMDBDirectory(void)</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineminus">-    : nsAbMDBDirProperty(), mPerformingQuery(false) {}</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineminus">-</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineminus">-nsAbMDBDirectory::~nsAbMDBDirectory(void) {</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineminus">-  if (mDatabase) {</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineminus">-    mDatabase-&gt;RemoveListener(this);</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineminus">-  }</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineminus">-}</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineminus">-</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED(nsAbMDBDirectory, nsAbMDBDirProperty,</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineminus">-                            nsIAbDirSearchListener, nsIAddrDBListener)</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineminus">-</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::Init(const char *aUri) {</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineminus">-  // We need to ensure  that the m_DirPrefId is initialized properly</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineminus">-  nsDependentCString uri(aUri);</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineminus">-</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineminus">-  // Find the first ? (of the search params) if there is one.</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineminus">-  // We know we can start at the end of the moz-abmdbdirectory:// because</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineminus">-  // that's the URI we should have been passed.</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineminus">-  int32_t searchCharLocation = uri.FindChar('?', kMDBDirectoryRootLen);</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineminus">-  nsAutoCString URINoQuery;</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineminus">-  if (searchCharLocation != kNotFound) {</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineminus">-    URINoQuery = Substring(uri, 0, searchCharLocation);</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineminus">-  } else {</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineminus">-    URINoQuery.Assign(uri);</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineminus">-  }</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineminus">-</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineminus">-  // In the non-query part of the URI, check if we are a mailinglist</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineminus">-  if (URINoQuery.Find(&quot;MailList&quot;) != kNotFound) m_IsMailList = true;</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineminus">-</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineminus">-  // Mailing lists don't have their own prefs.</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineminus">-  if (m_DirPrefId.IsEmpty() &amp;&amp; !m_IsMailList) {</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineminus">-    nsAutoCString filename;</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineminus">-</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineminus">-    // Extract the filename from the uri.</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineminus">-    filename = Substring(URINoQuery, kMDBDirectoryRootLen);</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineminus">-</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineminus">-    // Get the pref servers and the address book directory branch</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineminus">-    nsresult rv;</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineminus">-    nsCOMPtr&lt;nsIPrefService&gt; prefService(</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineminus">-        do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineminus">-</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch;</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineminus">-    rv = prefService-&gt;GetBranch(PREF_LDAP_SERVER_TREE_NAME &quot;.&quot;,</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineminus">-                                getter_AddRefs(prefBranch));</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineminus">-</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineminus">-    nsTArray&lt;nsCString&gt; childArray;</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineminus">-    int32_t dotOffset;</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineminus">-    nsCString childValue;</span>
<a href="#l20.88"></a><span id="l20.88" class="difflineminus">-</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineminus">-    rv = prefBranch-&gt;GetChildList(&quot;&quot;, childArray);</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineminus">-</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineminus">-    for (auto &amp;child : childArray) {</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineminus">-      if (StringEndsWith(child, NS_LITERAL_CSTRING(&quot;.filename&quot;))) {</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineminus">-        if (NS_SUCCEEDED(prefBranch-&gt;GetCharPref(child.get(), childValue))) {</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineminus">-          if (childValue == filename) {</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineminus">-            dotOffset = child.RFindChar('.');</span>
<a href="#l20.97"></a><span id="l20.97" class="difflineminus">-            if (dotOffset != -1) {</span>
<a href="#l20.98"></a><span id="l20.98" class="difflineminus">-              nsAutoCString prefName(StringHead(child, dotOffset));</span>
<a href="#l20.99"></a><span id="l20.99" class="difflineminus">-              m_DirPrefId.AssignLiteral(PREF_LDAP_SERVER_TREE_NAME &quot;.&quot;);</span>
<a href="#l20.100"></a><span id="l20.100" class="difflineminus">-              m_DirPrefId.Append(prefName);</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineminus">-            }</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineminus">-          }</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineminus">-        }</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineminus">-      }</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineminus">-    }</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineminus">-</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineminus">-    NS_ASSERTION(!m_DirPrefId.IsEmpty(),</span>
<a href="#l20.108"></a><span id="l20.108" class="difflineminus">-                 &quot;Error, Could not set m_DirPrefId in nsAbMDBDirectory::Init&quot;);</span>
<a href="#l20.109"></a><span id="l20.109" class="difflineminus">-  }</span>
<a href="#l20.110"></a><span id="l20.110" class="difflineminus">-</span>
<a href="#l20.111"></a><span id="l20.111" class="difflineminus">-  return nsAbDirProperty::Init(aUri);</span>
<a href="#l20.112"></a><span id="l20.112" class="difflineminus">-}</span>
<a href="#l20.113"></a><span id="l20.113" class="difflineminus">-</span>
<a href="#l20.114"></a><span id="l20.114" class="difflineminus">-////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l20.115"></a><span id="l20.115" class="difflineminus">-</span>
<a href="#l20.116"></a><span id="l20.116" class="difflineminus">-nsresult nsAbMDBDirectory::RemoveCardFromAddressList(nsIAbCard *card) {</span>
<a href="#l20.117"></a><span id="l20.117" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l20.118"></a><span id="l20.118" class="difflineminus">-  uint32_t listTotal;</span>
<a href="#l20.119"></a><span id="l20.119" class="difflineminus">-  int32_t i, j;</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineminus">-</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineminus">-  // These checks ensure we don't run into null pointers</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineminus">-  // as we did when we caused bug 280463.</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineminus">-  if (!mDatabase) {</span>
<a href="#l20.124"></a><span id="l20.124" class="difflineminus">-    rv = GetAbDatabase();</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineminus">-  }</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineminus">-</span>
<a href="#l20.128"></a><span id="l20.128" class="difflineminus">-  if (!m_AddressList) {</span>
<a href="#l20.129"></a><span id="l20.129" class="difflineminus">-    rv = mDatabase-&gt;GetMailingListsFromDB(this);</span>
<a href="#l20.130"></a><span id="l20.130" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.131"></a><span id="l20.131" class="difflineminus">-</span>
<a href="#l20.132"></a><span id="l20.132" class="difflineminus">-    // If the previous call didn't gives us an m_AddressList (and succeeded)</span>
<a href="#l20.133"></a><span id="l20.133" class="difflineminus">-    // then we haven't got any mailing lists to try and remove the card from.</span>
<a href="#l20.134"></a><span id="l20.134" class="difflineminus">-    // So just return without doing anything</span>
<a href="#l20.135"></a><span id="l20.135" class="difflineminus">-    if (!m_AddressList) return NS_OK;</span>
<a href="#l20.136"></a><span id="l20.136" class="difflineminus">-  }</span>
<a href="#l20.137"></a><span id="l20.137" class="difflineminus">-</span>
<a href="#l20.138"></a><span id="l20.138" class="difflineminus">-  rv = m_AddressList-&gt;GetLength(&amp;listTotal);</span>
<a href="#l20.139"></a><span id="l20.139" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.140"></a><span id="l20.140" class="difflineminus">-</span>
<a href="#l20.141"></a><span id="l20.141" class="difflineminus">-  for (i = listTotal - 1; i &gt;= 0; i--) {</span>
<a href="#l20.142"></a><span id="l20.142" class="difflineminus">-    nsCOMPtr&lt;nsIAbDirectory&gt; listDir(do_QueryElementAt(m_AddressList, i, &amp;rv));</span>
<a href="#l20.143"></a><span id="l20.143" class="difflineminus">-    if (listDir) {</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineminus">-      // First remove the instance in the database</span>
<a href="#l20.145"></a><span id="l20.145" class="difflineminus">-      mDatabase-&gt;DeleteCardFromMailList(listDir, card, false);</span>
<a href="#l20.146"></a><span id="l20.146" class="difflineminus">-</span>
<a href="#l20.147"></a><span id="l20.147" class="difflineminus">-      // Now remove the instance in any lists we hold.</span>
<a href="#l20.148"></a><span id="l20.148" class="difflineminus">-      nsCOMPtr&lt;nsIMutableArray&gt; pAddressLists;</span>
<a href="#l20.149"></a><span id="l20.149" class="difflineminus">-      listDir-&gt;GetAddressLists(getter_AddRefs(pAddressLists));</span>
<a href="#l20.150"></a><span id="l20.150" class="difflineminus">-      if (pAddressLists) {</span>
<a href="#l20.151"></a><span id="l20.151" class="difflineminus">-        uint32_t total;</span>
<a href="#l20.152"></a><span id="l20.152" class="difflineminus">-        rv = pAddressLists-&gt;GetLength(&amp;total);</span>
<a href="#l20.153"></a><span id="l20.153" class="difflineminus">-        for (j = total - 1; j &gt;= 0; j--) {</span>
<a href="#l20.154"></a><span id="l20.154" class="difflineminus">-          nsCOMPtr&lt;nsIAbCard&gt; cardInList(</span>
<a href="#l20.155"></a><span id="l20.155" class="difflineminus">-              do_QueryElementAt(pAddressLists, j, &amp;rv));</span>
<a href="#l20.156"></a><span id="l20.156" class="difflineminus">-          bool equals;</span>
<a href="#l20.157"></a><span id="l20.157" class="difflineminus">-          rv = cardInList-&gt;Equals(card, &amp;equals);  // should we checking email?</span>
<a href="#l20.158"></a><span id="l20.158" class="difflineminus">-          if (NS_SUCCEEDED(rv) &amp;&amp; equals) pAddressLists-&gt;RemoveElementAt(j);</span>
<a href="#l20.159"></a><span id="l20.159" class="difflineminus">-        }</span>
<a href="#l20.160"></a><span id="l20.160" class="difflineminus">-      }</span>
<a href="#l20.161"></a><span id="l20.161" class="difflineminus">-    }</span>
<a href="#l20.162"></a><span id="l20.162" class="difflineminus">-  }</span>
<a href="#l20.163"></a><span id="l20.163" class="difflineminus">-  return NS_OK;</span>
<a href="#l20.164"></a><span id="l20.164" class="difflineminus">-}</span>
<a href="#l20.165"></a><span id="l20.165" class="difflineminus">-</span>
<a href="#l20.166"></a><span id="l20.166" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::DeleteDirectory(nsIAbDirectory *directory) {</span>
<a href="#l20.167"></a><span id="l20.167" class="difflineminus">-  NS_ENSURE_ARG_POINTER(directory);</span>
<a href="#l20.168"></a><span id="l20.168" class="difflineminus">-</span>
<a href="#l20.169"></a><span id="l20.169" class="difflineminus">-  nsCOMPtr&lt;nsIAddrDatabase&gt; database;</span>
<a href="#l20.170"></a><span id="l20.170" class="difflineminus">-  nsresult rv = GetDatabase(getter_AddRefs(database));</span>
<a href="#l20.171"></a><span id="l20.171" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.172"></a><span id="l20.172" class="difflineminus">-</span>
<a href="#l20.173"></a><span id="l20.173" class="difflineminus">-  rv = database-&gt;DeleteMailList(directory, this);</span>
<a href="#l20.174"></a><span id="l20.174" class="difflineminus">-</span>
<a href="#l20.175"></a><span id="l20.175" class="difflineminus">-  if (NS_SUCCEEDED(rv)) database-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l20.176"></a><span id="l20.176" class="difflineminus">-</span>
<a href="#l20.177"></a><span id="l20.177" class="difflineminus">-  uint32_t dirIndex;</span>
<a href="#l20.178"></a><span id="l20.178" class="difflineminus">-  if (m_AddressList &amp;&amp;</span>
<a href="#l20.179"></a><span id="l20.179" class="difflineminus">-      NS_SUCCEEDED(m_AddressList-&gt;IndexOf(0, directory, &amp;dirIndex)))</span>
<a href="#l20.180"></a><span id="l20.180" class="difflineminus">-    m_AddressList-&gt;RemoveElementAt(dirIndex);</span>
<a href="#l20.181"></a><span id="l20.181" class="difflineminus">-  // XXX Cast from bool to nsresult</span>
<a href="#l20.182"></a><span id="l20.182" class="difflineminus">-  rv = static_cast&lt;nsresult&gt;(mSubDirectories.RemoveObject(directory));</span>
<a href="#l20.183"></a><span id="l20.183" class="difflineminus">-</span>
<a href="#l20.184"></a><span id="l20.184" class="difflineminus">-  NotifyItemDeleted(directory);</span>
<a href="#l20.185"></a><span id="l20.185" class="difflineminus">-  return rv;</span>
<a href="#l20.186"></a><span id="l20.186" class="difflineminus">-}</span>
<a href="#l20.187"></a><span id="l20.187" class="difflineminus">-</span>
<a href="#l20.188"></a><span id="l20.188" class="difflineminus">-nsresult nsAbMDBDirectory::NotifyItemChanged(nsISupports *item) {</span>
<a href="#l20.189"></a><span id="l20.189" class="difflineminus">-  nsresult rv;</span>
<a href="#l20.190"></a><span id="l20.190" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l20.191"></a><span id="l20.191" class="difflineminus">-      do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l20.192"></a><span id="l20.192" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.193"></a><span id="l20.193" class="difflineminus">-</span>
<a href="#l20.194"></a><span id="l20.194" class="difflineminus">-  rv = abManager-&gt;NotifyItemPropertyChanged(item, nullptr, EmptyString(),</span>
<a href="#l20.195"></a><span id="l20.195" class="difflineminus">-                                            EmptyString());</span>
<a href="#l20.196"></a><span id="l20.196" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.197"></a><span id="l20.197" class="difflineminus">-  return rv;</span>
<a href="#l20.198"></a><span id="l20.198" class="difflineminus">-}</span>
<a href="#l20.199"></a><span id="l20.199" class="difflineminus">-</span>
<a href="#l20.200"></a><span id="l20.200" class="difflineminus">-nsresult nsAbMDBDirectory::NotifyPropertyChanged(nsIAbDirectory *list,</span>
<a href="#l20.201"></a><span id="l20.201" class="difflineminus">-                                                 const char *property,</span>
<a href="#l20.202"></a><span id="l20.202" class="difflineminus">-                                                 const nsAString &amp;oldValue,</span>
<a href="#l20.203"></a><span id="l20.203" class="difflineminus">-                                                 const nsAString &amp;newValue) {</span>
<a href="#l20.204"></a><span id="l20.204" class="difflineminus">-  nsresult rv;</span>
<a href="#l20.205"></a><span id="l20.205" class="difflineminus">-  nsCOMPtr&lt;nsISupports&gt; supports = do_QueryInterface(list, &amp;rv);</span>
<a href="#l20.206"></a><span id="l20.206" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.207"></a><span id="l20.207" class="difflineminus">-</span>
<a href="#l20.208"></a><span id="l20.208" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l20.209"></a><span id="l20.209" class="difflineminus">-      do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l20.210"></a><span id="l20.210" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.211"></a><span id="l20.211" class="difflineminus">-</span>
<a href="#l20.212"></a><span id="l20.212" class="difflineminus">-  rv = abManager-&gt;NotifyItemPropertyChanged(supports, property, oldValue,</span>
<a href="#l20.213"></a><span id="l20.213" class="difflineminus">-                                            newValue);</span>
<a href="#l20.214"></a><span id="l20.214" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.215"></a><span id="l20.215" class="difflineminus">-  return rv;</span>
<a href="#l20.216"></a><span id="l20.216" class="difflineminus">-}</span>
<a href="#l20.217"></a><span id="l20.217" class="difflineminus">-</span>
<a href="#l20.218"></a><span id="l20.218" class="difflineminus">-nsresult nsAbMDBDirectory::NotifyItemAdded(nsISupports *item) {</span>
<a href="#l20.219"></a><span id="l20.219" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l20.220"></a><span id="l20.220" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l20.221"></a><span id="l20.221" class="difflineminus">-      do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l20.222"></a><span id="l20.222" class="difflineminus">-  if (NS_SUCCEEDED(rv)) abManager-&gt;NotifyDirectoryItemAdded(this, item);</span>
<a href="#l20.223"></a><span id="l20.223" class="difflineminus">-  return NS_OK;</span>
<a href="#l20.224"></a><span id="l20.224" class="difflineminus">-}</span>
<a href="#l20.225"></a><span id="l20.225" class="difflineminus">-</span>
<a href="#l20.226"></a><span id="l20.226" class="difflineminus">-nsresult nsAbMDBDirectory::NotifyItemDeleted(nsISupports *item) {</span>
<a href="#l20.227"></a><span id="l20.227" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l20.228"></a><span id="l20.228" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l20.229"></a><span id="l20.229" class="difflineminus">-      do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l20.230"></a><span id="l20.230" class="difflineminus">-  if (NS_SUCCEEDED(rv)) abManager-&gt;NotifyDirectoryItemDeleted(this, item);</span>
<a href="#l20.231"></a><span id="l20.231" class="difflineminus">-</span>
<a href="#l20.232"></a><span id="l20.232" class="difflineminus">-  return NS_OK;</span>
<a href="#l20.233"></a><span id="l20.233" class="difflineminus">-}</span>
<a href="#l20.234"></a><span id="l20.234" class="difflineminus">-</span>
<a href="#l20.235"></a><span id="l20.235" class="difflineminus">-// nsIAbMDBDirectory methods</span>
<a href="#l20.236"></a><span id="l20.236" class="difflineminus">-</span>
<a href="#l20.237"></a><span id="l20.237" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::ClearDatabase() {</span>
<a href="#l20.238"></a><span id="l20.238" class="difflineminus">-  if (mIsQueryURI) return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l20.239"></a><span id="l20.239" class="difflineminus">-</span>
<a href="#l20.240"></a><span id="l20.240" class="difflineminus">-  if (mDatabase) {</span>
<a href="#l20.241"></a><span id="l20.241" class="difflineminus">-    mDatabase-&gt;RemoveListener(this);</span>
<a href="#l20.242"></a><span id="l20.242" class="difflineminus">-    mDatabase = nullptr;</span>
<a href="#l20.243"></a><span id="l20.243" class="difflineminus">-  }</span>
<a href="#l20.244"></a><span id="l20.244" class="difflineminus">-  return NS_OK;</span>
<a href="#l20.245"></a><span id="l20.245" class="difflineminus">-}</span>
<a href="#l20.246"></a><span id="l20.246" class="difflineminus">-</span>
<a href="#l20.247"></a><span id="l20.247" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::RemoveElementsFromAddressList() {</span>
<a href="#l20.248"></a><span id="l20.248" class="difflineminus">-  if (mIsQueryURI) return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l20.249"></a><span id="l20.249" class="difflineminus">-</span>
<a href="#l20.250"></a><span id="l20.250" class="difflineminus">-  if (m_AddressList) {</span>
<a href="#l20.251"></a><span id="l20.251" class="difflineminus">-    uint32_t count;</span>
<a href="#l20.252"></a><span id="l20.252" class="difflineminus">-    mozilla::DebugOnly&lt;nsresult&gt; rv = m_AddressList-&gt;GetLength(&amp;count);</span>
<a href="#l20.253"></a><span id="l20.253" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Count failed&quot;);</span>
<a href="#l20.254"></a><span id="l20.254" class="difflineminus">-    int32_t i;</span>
<a href="#l20.255"></a><span id="l20.255" class="difflineminus">-    for (i = count - 1; i &gt;= 0; i--) m_AddressList-&gt;RemoveElementAt(i);</span>
<a href="#l20.256"></a><span id="l20.256" class="difflineminus">-  }</span>
<a href="#l20.257"></a><span id="l20.257" class="difflineminus">-  m_AddressList = nullptr;</span>
<a href="#l20.258"></a><span id="l20.258" class="difflineminus">-  return NS_OK;</span>
<a href="#l20.259"></a><span id="l20.259" class="difflineminus">-}</span>
<a href="#l20.260"></a><span id="l20.260" class="difflineminus">-</span>
<a href="#l20.261"></a><span id="l20.261" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::RemoveEmailAddressAt(uint32_t aIndex) {</span>
<a href="#l20.262"></a><span id="l20.262" class="difflineminus">-  if (mIsQueryURI) return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l20.263"></a><span id="l20.263" class="difflineminus">-</span>
<a href="#l20.264"></a><span id="l20.264" class="difflineminus">-  if (m_AddressList) {</span>
<a href="#l20.265"></a><span id="l20.265" class="difflineminus">-    return m_AddressList-&gt;RemoveElementAt(aIndex);</span>
<a href="#l20.266"></a><span id="l20.266" class="difflineminus">-  } else</span>
<a href="#l20.267"></a><span id="l20.267" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l20.268"></a><span id="l20.268" class="difflineminus">-}</span>
<a href="#l20.269"></a><span id="l20.269" class="difflineminus">-</span>
<a href="#l20.270"></a><span id="l20.270" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::AddDirectory(const char *uriName,</span>
<a href="#l20.271"></a><span id="l20.271" class="difflineminus">-                                             nsIAbDirectory **childDir) {</span>
<a href="#l20.272"></a><span id="l20.272" class="difflineminus">-  if (mIsQueryURI) return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l20.273"></a><span id="l20.273" class="difflineminus">-</span>
<a href="#l20.274"></a><span id="l20.274" class="difflineminus">-  if (!childDir || !uriName) return NS_ERROR_NULL_POINTER;</span>
<a href="#l20.275"></a><span id="l20.275" class="difflineminus">-</span>
<a href="#l20.276"></a><span id="l20.276" class="difflineminus">-  if (mURI.IsEmpty()) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l20.277"></a><span id="l20.277" class="difflineminus">-</span>
<a href="#l20.278"></a><span id="l20.278" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l20.279"></a><span id="l20.279" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l20.280"></a><span id="l20.280" class="difflineminus">-      do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l20.281"></a><span id="l20.281" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.282"></a><span id="l20.282" class="difflineminus">-</span>
<a href="#l20.283"></a><span id="l20.283" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l20.284"></a><span id="l20.284" class="difflineminus">-  rv = abManager-&gt;GetDirectory(nsDependentCString(uriName),</span>
<a href="#l20.285"></a><span id="l20.285" class="difflineminus">-                               getter_AddRefs(directory));</span>
<a href="#l20.286"></a><span id="l20.286" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.287"></a><span id="l20.287" class="difflineminus">-</span>
<a href="#l20.288"></a><span id="l20.288" class="difflineminus">-  if (mSubDirectories.IndexOf(directory) == -1)</span>
<a href="#l20.289"></a><span id="l20.289" class="difflineminus">-    mSubDirectories.AppendObject(directory);</span>
<a href="#l20.290"></a><span id="l20.290" class="difflineminus">-  directory.forget(childDir);</span>
<a href="#l20.291"></a><span id="l20.291" class="difflineminus">-  return rv;</span>
<a href="#l20.292"></a><span id="l20.292" class="difflineminus">-}</span>
<a href="#l20.293"></a><span id="l20.293" class="difflineminus">-</span>
<a href="#l20.294"></a><span id="l20.294" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::GetDatabaseFile(nsIFile **aResult) {</span>
<a href="#l20.295"></a><span id="l20.295" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l20.296"></a><span id="l20.296" class="difflineminus">-</span>
<a href="#l20.297"></a><span id="l20.297" class="difflineminus">-  nsCString fileName;</span>
<a href="#l20.298"></a><span id="l20.298" class="difflineminus">-  nsresult rv = GetStringValue(&quot;filename&quot;, EmptyCString(), fileName);</span>
<a href="#l20.299"></a><span id="l20.299" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.300"></a><span id="l20.300" class="difflineminus">-</span>
<a href="#l20.301"></a><span id="l20.301" class="difflineminus">-  if (fileName.IsEmpty()) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l20.302"></a><span id="l20.302" class="difflineminus">-</span>
<a href="#l20.303"></a><span id="l20.303" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; dbFile;</span>
<a href="#l20.304"></a><span id="l20.304" class="difflineminus">-  rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR,</span>
<a href="#l20.305"></a><span id="l20.305" class="difflineminus">-                              getter_AddRefs(dbFile));</span>
<a href="#l20.306"></a><span id="l20.306" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.307"></a><span id="l20.307" class="difflineminus">-</span>
<a href="#l20.308"></a><span id="l20.308" class="difflineminus">-  rv = dbFile-&gt;AppendNative(fileName);</span>
<a href="#l20.309"></a><span id="l20.309" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.310"></a><span id="l20.310" class="difflineminus">-</span>
<a href="#l20.311"></a><span id="l20.311" class="difflineminus">-  dbFile.forget(aResult);</span>
<a href="#l20.312"></a><span id="l20.312" class="difflineminus">-</span>
<a href="#l20.313"></a><span id="l20.313" class="difflineminus">-  return NS_OK;</span>
<a href="#l20.314"></a><span id="l20.314" class="difflineminus">-}</span>
<a href="#l20.315"></a><span id="l20.315" class="difflineminus">-</span>
<a href="#l20.316"></a><span id="l20.316" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::GetDatabase(nsIAddrDatabase **aResult) {</span>
<a href="#l20.317"></a><span id="l20.317" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l20.318"></a><span id="l20.318" class="difflineminus">-</span>
<a href="#l20.319"></a><span id="l20.319" class="difflineminus">-  nsresult rv;</span>
<a href="#l20.320"></a><span id="l20.320" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; databaseFile;</span>
<a href="#l20.321"></a><span id="l20.321" class="difflineminus">-  rv = GetDatabaseFile(getter_AddRefs(databaseFile));</span>
<a href="#l20.322"></a><span id="l20.322" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.323"></a><span id="l20.323" class="difflineminus">-</span>
<a href="#l20.324"></a><span id="l20.324" class="difflineminus">-  nsCOMPtr&lt;nsIAddrDatabase&gt; addrDBFactory =</span>
<a href="#l20.325"></a><span id="l20.325" class="difflineminus">-      do_GetService(NS_ADDRDATABASE_CONTRACTID, &amp;rv);</span>
<a href="#l20.326"></a><span id="l20.326" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.327"></a><span id="l20.327" class="difflineminus">-</span>
<a href="#l20.328"></a><span id="l20.328" class="difflineminus">-  return addrDBFactory-&gt;Open(databaseFile, false /* no create */, true,</span>
<a href="#l20.329"></a><span id="l20.329" class="difflineminus">-                             aResult);</span>
<a href="#l20.330"></a><span id="l20.330" class="difflineminus">-}</span>
<a href="#l20.331"></a><span id="l20.331" class="difflineminus">-</span>
<a href="#l20.332"></a><span id="l20.332" class="difflineminus">-// nsIAbDirectory methods</span>
<a href="#l20.333"></a><span id="l20.333" class="difflineminus">-</span>
<a href="#l20.334"></a><span id="l20.334" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::GetURI(nsACString &amp;aURI) {</span>
<a href="#l20.335"></a><span id="l20.335" class="difflineminus">-  if (mURI.IsEmpty()) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l20.336"></a><span id="l20.336" class="difflineminus">-</span>
<a href="#l20.337"></a><span id="l20.337" class="difflineminus">-  aURI = mURI;</span>
<a href="#l20.338"></a><span id="l20.338" class="difflineminus">-  return NS_OK;</span>
<a href="#l20.339"></a><span id="l20.339" class="difflineminus">-}</span>
<a href="#l20.340"></a><span id="l20.340" class="difflineminus">-</span>
<a href="#l20.341"></a><span id="l20.341" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::GetChildNodes(nsISimpleEnumerator **aResult) {</span>
<a href="#l20.342"></a><span id="l20.342" class="difflineminus">-  if (mIsQueryURI) return NS_NewEmptyEnumerator(aResult);</span>
<a href="#l20.343"></a><span id="l20.343" class="difflineminus">-</span>
<a href="#l20.344"></a><span id="l20.344" class="difflineminus">-  return NS_NewArrayEnumerator(aResult, mSubDirectories,</span>
<a href="#l20.345"></a><span id="l20.345" class="difflineminus">-                               NS_GET_IID(nsIAbDirectory));</span>
<a href="#l20.346"></a><span id="l20.346" class="difflineminus">-}</span>
<a href="#l20.347"></a><span id="l20.347" class="difflineminus">-</span>
<a href="#l20.348"></a><span id="l20.348" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::GetChildCards(nsISimpleEnumerator **result) {</span>
<a href="#l20.349"></a><span id="l20.349" class="difflineminus">-  nsresult rv;</span>
<a href="#l20.350"></a><span id="l20.350" class="difflineminus">-</span>
<a href="#l20.351"></a><span id="l20.351" class="difflineminus">-  if (mIsQueryURI) {</span>
<a href="#l20.352"></a><span id="l20.352" class="difflineminus">-    rv = StartSearch();</span>
<a href="#l20.353"></a><span id="l20.353" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.354"></a><span id="l20.354" class="difflineminus">-</span>
<a href="#l20.355"></a><span id="l20.355" class="difflineminus">-    // TODO</span>
<a href="#l20.356"></a><span id="l20.356" class="difflineminus">-    // Search is synchronous so need to return</span>
<a href="#l20.357"></a><span id="l20.357" class="difflineminus">-    // results after search is complete</span>
<a href="#l20.358"></a><span id="l20.358" class="difflineminus">-    nsCOMPtr&lt;nsIMutableArray&gt; array(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l20.359"></a><span id="l20.359" class="difflineminus">-    for (auto iter = mSearchCache.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l20.360"></a><span id="l20.360" class="difflineminus">-      array-&gt;AppendElement(iter.Data());</span>
<a href="#l20.361"></a><span id="l20.361" class="difflineminus">-    }</span>
<a href="#l20.362"></a><span id="l20.362" class="difflineminus">-    return NS_NewArrayEnumerator(result, array, NS_GET_IID(nsIAbCard));</span>
<a href="#l20.363"></a><span id="l20.363" class="difflineminus">-  }</span>
<a href="#l20.364"></a><span id="l20.364" class="difflineminus">-</span>
<a href="#l20.365"></a><span id="l20.365" class="difflineminus">-  rv = GetAbDatabase();</span>
<a href="#l20.366"></a><span id="l20.366" class="difflineminus">-</span>
<a href="#l20.367"></a><span id="l20.367" class="difflineminus">-  if (NS_FAILED(rv) || !mDatabase) return rv;</span>
<a href="#l20.368"></a><span id="l20.368" class="difflineminus">-</span>
<a href="#l20.369"></a><span id="l20.369" class="difflineminus">-  return m_IsMailList ? mDatabase-&gt;EnumerateListAddresses(this, result)</span>
<a href="#l20.370"></a><span id="l20.370" class="difflineminus">-                      : mDatabase-&gt;EnumerateCards(this, result);</span>
<a href="#l20.371"></a><span id="l20.371" class="difflineminus">-}</span>
<a href="#l20.372"></a><span id="l20.372" class="difflineminus">-</span>
<a href="#l20.373"></a><span id="l20.373" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::GetIsQuery(bool *aResult) {</span>
<a href="#l20.374"></a><span id="l20.374" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l20.375"></a><span id="l20.375" class="difflineminus">-  *aResult = mIsQueryURI;</span>
<a href="#l20.376"></a><span id="l20.376" class="difflineminus">-  return NS_OK;</span>
<a href="#l20.377"></a><span id="l20.377" class="difflineminus">-}</span>
<a href="#l20.378"></a><span id="l20.378" class="difflineminus">-</span>
<a href="#l20.379"></a><span id="l20.379" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::DeleteCards(nsIArray *aCards) {</span>
<a href="#l20.380"></a><span id="l20.380" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aCards);</span>
<a href="#l20.381"></a><span id="l20.381" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l20.382"></a><span id="l20.382" class="difflineminus">-</span>
<a href="#l20.383"></a><span id="l20.383" class="difflineminus">-  if (!mDatabase) {</span>
<a href="#l20.384"></a><span id="l20.384" class="difflineminus">-    rv = GetAbDatabase();</span>
<a href="#l20.385"></a><span id="l20.385" class="difflineminus">-    if (NS_FAILED(rv) || !mDatabase) return rv;</span>
<a href="#l20.386"></a><span id="l20.386" class="difflineminus">-  }</span>
<a href="#l20.387"></a><span id="l20.387" class="difflineminus">-</span>
<a href="#l20.388"></a><span id="l20.388" class="difflineminus">-  if (mIsQueryURI) {</span>
<a href="#l20.389"></a><span id="l20.389" class="difflineminus">-    // if this is a query, delete the cards from the directory (without the</span>
<a href="#l20.390"></a><span id="l20.390" class="difflineminus">-    // query) before we do the delete, make this directory (which represents the</span>
<a href="#l20.391"></a><span id="l20.391" class="difflineminus">-    // search) a listener on the database, so that it will get notified when the</span>
<a href="#l20.392"></a><span id="l20.392" class="difflineminus">-    // cards are deleted after delete, remove this query as a listener.</span>
<a href="#l20.393"></a><span id="l20.393" class="difflineminus">-    nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l20.394"></a><span id="l20.394" class="difflineminus">-        do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l20.395"></a><span id="l20.395" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.396"></a><span id="l20.396" class="difflineminus">-</span>
<a href="#l20.397"></a><span id="l20.397" class="difflineminus">-    nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l20.398"></a><span id="l20.398" class="difflineminus">-    rv = abManager-&gt;GetDirectory(mURINoQuery, getter_AddRefs(directory));</span>
<a href="#l20.399"></a><span id="l20.399" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.400"></a><span id="l20.400" class="difflineminus">-</span>
<a href="#l20.401"></a><span id="l20.401" class="difflineminus">-    rv = directory-&gt;DeleteCards(aCards);</span>
<a href="#l20.402"></a><span id="l20.402" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.403"></a><span id="l20.403" class="difflineminus">-</span>
<a href="#l20.404"></a><span id="l20.404" class="difflineminus">-    return rv;</span>
<a href="#l20.405"></a><span id="l20.405" class="difflineminus">-  }</span>
<a href="#l20.406"></a><span id="l20.406" class="difflineminus">-</span>
<a href="#l20.407"></a><span id="l20.407" class="difflineminus">-  uint32_t cardCount;</span>
<a href="#l20.408"></a><span id="l20.408" class="difflineminus">-  uint32_t i;</span>
<a href="#l20.409"></a><span id="l20.409" class="difflineminus">-  rv = aCards-&gt;GetLength(&amp;cardCount);</span>
<a href="#l20.410"></a><span id="l20.410" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.411"></a><span id="l20.411" class="difflineminus">-  for (i = 0; i &lt; cardCount; i++) {</span>
<a href="#l20.412"></a><span id="l20.412" class="difflineminus">-    nsCOMPtr&lt;nsIAbCard&gt; card(do_QueryElementAt(aCards, i, &amp;rv));</span>
<a href="#l20.413"></a><span id="l20.413" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.414"></a><span id="l20.414" class="difflineminus">-</span>
<a href="#l20.415"></a><span id="l20.415" class="difflineminus">-    if (card) {</span>
<a href="#l20.416"></a><span id="l20.416" class="difflineminus">-      uint32_t rowID;</span>
<a href="#l20.417"></a><span id="l20.417" class="difflineminus">-      rv = card-&gt;GetPropertyAsUint32(&quot;DbRowID&quot;, &amp;rowID);</span>
<a href="#l20.418"></a><span id="l20.418" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.419"></a><span id="l20.419" class="difflineminus">-</span>
<a href="#l20.420"></a><span id="l20.420" class="difflineminus">-      if (m_IsMailList) {</span>
<a href="#l20.421"></a><span id="l20.421" class="difflineminus">-        mDatabase-&gt;DeleteCardFromMailList(this, card, true);</span>
<a href="#l20.422"></a><span id="l20.422" class="difflineminus">-</span>
<a href="#l20.423"></a><span id="l20.423" class="difflineminus">-        uint32_t cardTotal = 0;</span>
<a href="#l20.424"></a><span id="l20.424" class="difflineminus">-        int32_t i;</span>
<a href="#l20.425"></a><span id="l20.425" class="difflineminus">-        if (m_AddressList) rv = m_AddressList-&gt;GetLength(&amp;cardTotal);</span>
<a href="#l20.426"></a><span id="l20.426" class="difflineminus">-        for (i = cardTotal - 1; i &gt;= 0; i--) {</span>
<a href="#l20.427"></a><span id="l20.427" class="difflineminus">-          nsCOMPtr&lt;nsIAbCard&gt; arrayCard(</span>
<a href="#l20.428"></a><span id="l20.428" class="difflineminus">-              do_QueryElementAt(m_AddressList, i, &amp;rv));</span>
<a href="#l20.429"></a><span id="l20.429" class="difflineminus">-          if (arrayCard) {</span>
<a href="#l20.430"></a><span id="l20.430" class="difflineminus">-            // No card can have a row ID of 0</span>
<a href="#l20.431"></a><span id="l20.431" class="difflineminus">-            uint32_t arrayRowID = 0;</span>
<a href="#l20.432"></a><span id="l20.432" class="difflineminus">-            arrayCard-&gt;GetPropertyAsUint32(&quot;DbRowID&quot;, &amp;arrayRowID);</span>
<a href="#l20.433"></a><span id="l20.433" class="difflineminus">-            if (rowID == arrayRowID) m_AddressList-&gt;RemoveElementAt(i);</span>
<a href="#l20.434"></a><span id="l20.434" class="difflineminus">-          }</span>
<a href="#l20.435"></a><span id="l20.435" class="difflineminus">-        }</span>
<a href="#l20.436"></a><span id="l20.436" class="difflineminus">-      } else {</span>
<a href="#l20.437"></a><span id="l20.437" class="difflineminus">-        mDatabase-&gt;DeleteCard(card, true, this);</span>
<a href="#l20.438"></a><span id="l20.438" class="difflineminus">-        bool bIsMailList = false;</span>
<a href="#l20.439"></a><span id="l20.439" class="difflineminus">-        card-&gt;GetIsMailList(&amp;bIsMailList);</span>
<a href="#l20.440"></a><span id="l20.440" class="difflineminus">-        if (bIsMailList) {</span>
<a href="#l20.441"></a><span id="l20.441" class="difflineminus">-          // to do, get mailing list dir side uri and notify nsIAbManager to</span>
<a href="#l20.442"></a><span id="l20.442" class="difflineminus">-          // remove it</span>
<a href="#l20.443"></a><span id="l20.443" class="difflineminus">-          nsAutoCString listUri(mURI);</span>
<a href="#l20.444"></a><span id="l20.444" class="difflineminus">-          listUri.AppendLiteral(&quot;/MailList&quot;);</span>
<a href="#l20.445"></a><span id="l20.445" class="difflineminus">-          listUri.AppendInt(rowID);</span>
<a href="#l20.446"></a><span id="l20.446" class="difflineminus">-          if (!listUri.IsEmpty()) {</span>
<a href="#l20.447"></a><span id="l20.447" class="difflineminus">-            nsresult rv = NS_OK;</span>
<a href="#l20.448"></a><span id="l20.448" class="difflineminus">-</span>
<a href="#l20.449"></a><span id="l20.449" class="difflineminus">-            nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l20.450"></a><span id="l20.450" class="difflineminus">-                do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l20.451"></a><span id="l20.451" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.452"></a><span id="l20.452" class="difflineminus">-</span>
<a href="#l20.453"></a><span id="l20.453" class="difflineminus">-            nsCOMPtr&lt;nsIAbDirectory&gt; listDir;</span>
<a href="#l20.454"></a><span id="l20.454" class="difflineminus">-            rv = abManager-&gt;GetDirectory(listUri, getter_AddRefs(listDir));</span>
<a href="#l20.455"></a><span id="l20.455" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.456"></a><span id="l20.456" class="difflineminus">-</span>
<a href="#l20.457"></a><span id="l20.457" class="difflineminus">-            uint32_t dirIndex;</span>
<a href="#l20.458"></a><span id="l20.458" class="difflineminus">-            if (m_AddressList &amp;&amp;</span>
<a href="#l20.459"></a><span id="l20.459" class="difflineminus">-                NS_SUCCEEDED(m_AddressList-&gt;IndexOf(0, listDir, &amp;dirIndex)))</span>
<a href="#l20.460"></a><span id="l20.460" class="difflineminus">-              m_AddressList-&gt;RemoveElementAt(dirIndex);</span>
<a href="#l20.461"></a><span id="l20.461" class="difflineminus">-</span>
<a href="#l20.462"></a><span id="l20.462" class="difflineminus">-            mSubDirectories.RemoveObject(listDir);</span>
<a href="#l20.463"></a><span id="l20.463" class="difflineminus">-</span>
<a href="#l20.464"></a><span id="l20.464" class="difflineminus">-            if (listDir) NotifyItemDeleted(listDir);</span>
<a href="#l20.465"></a><span id="l20.465" class="difflineminus">-          }</span>
<a href="#l20.466"></a><span id="l20.466" class="difflineminus">-        } else {</span>
<a href="#l20.467"></a><span id="l20.467" class="difflineminus">-          rv = RemoveCardFromAddressList(card);</span>
<a href="#l20.468"></a><span id="l20.468" class="difflineminus">-          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.469"></a><span id="l20.469" class="difflineminus">-        }</span>
<a href="#l20.470"></a><span id="l20.470" class="difflineminus">-      }</span>
<a href="#l20.471"></a><span id="l20.471" class="difflineminus">-    }</span>
<a href="#l20.472"></a><span id="l20.472" class="difflineminus">-  }</span>
<a href="#l20.473"></a><span id="l20.473" class="difflineminus">-  mDatabase-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l20.474"></a><span id="l20.474" class="difflineminus">-  return rv;</span>
<a href="#l20.475"></a><span id="l20.475" class="difflineminus">-}</span>
<a href="#l20.476"></a><span id="l20.476" class="difflineminus">-</span>
<a href="#l20.477"></a><span id="l20.477" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::HasCard(nsIAbCard *cards, bool *hasCard) {</span>
<a href="#l20.478"></a><span id="l20.478" class="difflineminus">-  if (!hasCard) return NS_ERROR_NULL_POINTER;</span>
<a href="#l20.479"></a><span id="l20.479" class="difflineminus">-</span>
<a href="#l20.480"></a><span id="l20.480" class="difflineminus">-  if (mIsQueryURI) {</span>
<a href="#l20.481"></a><span id="l20.481" class="difflineminus">-    *hasCard = mSearchCache.Get(cards, nullptr);</span>
<a href="#l20.482"></a><span id="l20.482" class="difflineminus">-    return NS_OK;</span>
<a href="#l20.483"></a><span id="l20.483" class="difflineminus">-  }</span>
<a href="#l20.484"></a><span id="l20.484" class="difflineminus">-</span>
<a href="#l20.485"></a><span id="l20.485" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l20.486"></a><span id="l20.486" class="difflineminus">-  if (!mDatabase) rv = GetAbDatabase();</span>
<a href="#l20.487"></a><span id="l20.487" class="difflineminus">-</span>
<a href="#l20.488"></a><span id="l20.488" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; mDatabase) {</span>
<a href="#l20.489"></a><span id="l20.489" class="difflineminus">-    if (NS_SUCCEEDED(rv)) rv = mDatabase-&gt;ContainsCard(cards, hasCard);</span>
<a href="#l20.490"></a><span id="l20.490" class="difflineminus">-  }</span>
<a href="#l20.491"></a><span id="l20.491" class="difflineminus">-  return rv;</span>
<a href="#l20.492"></a><span id="l20.492" class="difflineminus">-}</span>
<a href="#l20.493"></a><span id="l20.493" class="difflineminus">-</span>
<a href="#l20.494"></a><span id="l20.494" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::HasDirectory(nsIAbDirectory *dir,</span>
<a href="#l20.495"></a><span id="l20.495" class="difflineminus">-                                             bool *hasDir) {</span>
<a href="#l20.496"></a><span id="l20.496" class="difflineminus">-  if (!hasDir) return NS_ERROR_NULL_POINTER;</span>
<a href="#l20.497"></a><span id="l20.497" class="difflineminus">-</span>
<a href="#l20.498"></a><span id="l20.498" class="difflineminus">-  nsresult rv;</span>
<a href="#l20.499"></a><span id="l20.499" class="difflineminus">-</span>
<a href="#l20.500"></a><span id="l20.500" class="difflineminus">-  nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbdir(do_QueryInterface(dir, &amp;rv));</span>
<a href="#l20.501"></a><span id="l20.501" class="difflineminus">-  mozilla::Unused &lt;&lt; dbdir;</span>
<a href="#l20.502"></a><span id="l20.502" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.503"></a><span id="l20.503" class="difflineminus">-</span>
<a href="#l20.504"></a><span id="l20.504" class="difflineminus">-  bool bIsMailingList = false;</span>
<a href="#l20.505"></a><span id="l20.505" class="difflineminus">-  dir-&gt;GetIsMailList(&amp;bIsMailingList);</span>
<a href="#l20.506"></a><span id="l20.506" class="difflineminus">-  if (bIsMailingList) {</span>
<a href="#l20.507"></a><span id="l20.507" class="difflineminus">-    nsCOMPtr&lt;nsIAddrDatabase&gt; database;</span>
<a href="#l20.508"></a><span id="l20.508" class="difflineminus">-    rv = GetDatabase(getter_AddRefs(database));</span>
<a href="#l20.509"></a><span id="l20.509" class="difflineminus">-</span>
<a href="#l20.510"></a><span id="l20.510" class="difflineminus">-    if (NS_SUCCEEDED(rv)) rv = database-&gt;ContainsMailList(dir, hasDir);</span>
<a href="#l20.511"></a><span id="l20.511" class="difflineminus">-  }</span>
<a href="#l20.512"></a><span id="l20.512" class="difflineminus">-</span>
<a href="#l20.513"></a><span id="l20.513" class="difflineminus">-  return rv;</span>
<a href="#l20.514"></a><span id="l20.514" class="difflineminus">-}</span>
<a href="#l20.515"></a><span id="l20.515" class="difflineminus">-</span>
<a href="#l20.516"></a><span id="l20.516" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::HasMailListWithName(const char16_t *aName,</span>
<a href="#l20.517"></a><span id="l20.517" class="difflineminus">-                                                    bool *aHasList) {</span>
<a href="#l20.518"></a><span id="l20.518" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aHasList);</span>
<a href="#l20.519"></a><span id="l20.519" class="difflineminus">-</span>
<a href="#l20.520"></a><span id="l20.520" class="difflineminus">-  nsCOMPtr&lt;nsIAddrDatabase&gt; database;</span>
<a href="#l20.521"></a><span id="l20.521" class="difflineminus">-  nsresult rv = GetDatabase(getter_AddRefs(database));</span>
<a href="#l20.522"></a><span id="l20.522" class="difflineminus">-  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l20.523"></a><span id="l20.523" class="difflineminus">-    rv = database-&gt;FindMailListbyUnicodeName(aName, aHasList);</span>
<a href="#l20.524"></a><span id="l20.524" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; *aHasList) return NS_OK;</span>
<a href="#l20.525"></a><span id="l20.525" class="difflineminus">-  }</span>
<a href="#l20.526"></a><span id="l20.526" class="difflineminus">-</span>
<a href="#l20.527"></a><span id="l20.527" class="difflineminus">-  return rv;</span>
<a href="#l20.528"></a><span id="l20.528" class="difflineminus">-}</span>
<a href="#l20.529"></a><span id="l20.529" class="difflineminus">-</span>
<a href="#l20.530"></a><span id="l20.530" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::AddMailList(nsIAbDirectory *list,</span>
<a href="#l20.531"></a><span id="l20.531" class="difflineminus">-                                            nsIAbDirectory **addedList) {</span>
<a href="#l20.532"></a><span id="l20.532" class="difflineminus">-  NS_ENSURE_ARG_POINTER(addedList);</span>
<a href="#l20.533"></a><span id="l20.533" class="difflineminus">-</span>
<a href="#l20.534"></a><span id="l20.534" class="difflineminus">-  if (mIsQueryURI) return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l20.535"></a><span id="l20.535" class="difflineminus">-</span>
<a href="#l20.536"></a><span id="l20.536" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l20.537"></a><span id="l20.537" class="difflineminus">-  if (!mDatabase) rv = GetAbDatabase();</span>
<a href="#l20.538"></a><span id="l20.538" class="difflineminus">-</span>
<a href="#l20.539"></a><span id="l20.539" class="difflineminus">-  if (NS_FAILED(rv) || !mDatabase) return NS_ERROR_FAILURE;</span>
<a href="#l20.540"></a><span id="l20.540" class="difflineminus">-</span>
<a href="#l20.541"></a><span id="l20.541" class="difflineminus">-  nsCOMPtr&lt;nsIAbMDBDirectory&gt; dblist(do_QueryInterface(list, &amp;rv));</span>
<a href="#l20.542"></a><span id="l20.542" class="difflineminus">-  if (NS_FAILED(rv)) {</span>
<a href="#l20.543"></a><span id="l20.543" class="difflineminus">-    nsCOMPtr&lt;nsIAbDirectory&gt; newlist(new nsAbMDBDirProperty);</span>
<a href="#l20.544"></a><span id="l20.544" class="difflineminus">-    if (!newlist) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l20.545"></a><span id="l20.545" class="difflineminus">-</span>
<a href="#l20.546"></a><span id="l20.546" class="difflineminus">-    rv = newlist-&gt;CopyMailList(list);</span>
<a href="#l20.547"></a><span id="l20.547" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.548"></a><span id="l20.548" class="difflineminus">-</span>
<a href="#l20.549"></a><span id="l20.549" class="difflineminus">-    dblist = do_QueryInterface(newlist, &amp;rv);</span>
<a href="#l20.550"></a><span id="l20.550" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.551"></a><span id="l20.551" class="difflineminus">-</span>
<a href="#l20.552"></a><span id="l20.552" class="difflineminus">-    mDatabase-&gt;CreateMailListAndAddToDB(newlist, true, this);</span>
<a href="#l20.553"></a><span id="l20.553" class="difflineminus">-  } else</span>
<a href="#l20.554"></a><span id="l20.554" class="difflineminus">-    mDatabase-&gt;CreateMailListAndAddToDB(list, true, this);</span>
<a href="#l20.555"></a><span id="l20.555" class="difflineminus">-</span>
<a href="#l20.556"></a><span id="l20.556" class="difflineminus">-  mDatabase-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l20.557"></a><span id="l20.557" class="difflineminus">-</span>
<a href="#l20.558"></a><span id="l20.558" class="difflineminus">-  uint32_t dbRowID;</span>
<a href="#l20.559"></a><span id="l20.559" class="difflineminus">-  dblist-&gt;GetDbRowID(&amp;dbRowID);</span>
<a href="#l20.560"></a><span id="l20.560" class="difflineminus">-</span>
<a href="#l20.561"></a><span id="l20.561" class="difflineminus">-  nsAutoCString listUri(mURI);</span>
<a href="#l20.562"></a><span id="l20.562" class="difflineminus">-  listUri.AppendLiteral(&quot;/MailList&quot;);</span>
<a href="#l20.563"></a><span id="l20.563" class="difflineminus">-  listUri.AppendInt(dbRowID);</span>
<a href="#l20.564"></a><span id="l20.564" class="difflineminus">-</span>
<a href="#l20.565"></a><span id="l20.565" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; newList;</span>
<a href="#l20.566"></a><span id="l20.566" class="difflineminus">-  rv = AddDirectory(listUri.get(), getter_AddRefs(newList));</span>
<a href="#l20.567"></a><span id="l20.567" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; newList) {</span>
<a href="#l20.568"></a><span id="l20.568" class="difflineminus">-    nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbnewList(do_QueryInterface(newList, &amp;rv));</span>
<a href="#l20.569"></a><span id="l20.569" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.570"></a><span id="l20.570" class="difflineminus">-</span>
<a href="#l20.571"></a><span id="l20.571" class="difflineminus">-    dbnewList-&gt;CopyDBMailList(dblist);</span>
<a href="#l20.572"></a><span id="l20.572" class="difflineminus">-    AddMailListToDirectory(newList);</span>
<a href="#l20.573"></a><span id="l20.573" class="difflineminus">-    NotifyItemAdded(newList);</span>
<a href="#l20.574"></a><span id="l20.574" class="difflineminus">-  }</span>
<a href="#l20.575"></a><span id="l20.575" class="difflineminus">-</span>
<a href="#l20.576"></a><span id="l20.576" class="difflineminus">-  newList.forget(addedList);</span>
<a href="#l20.577"></a><span id="l20.577" class="difflineminus">-  return rv;</span>
<a href="#l20.578"></a><span id="l20.578" class="difflineminus">-}</span>
<a href="#l20.579"></a><span id="l20.579" class="difflineminus">-</span>
<a href="#l20.580"></a><span id="l20.580" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::AddCard(nsIAbCard *card,</span>
<a href="#l20.581"></a><span id="l20.581" class="difflineminus">-                                        nsIAbCard **addedCard) {</span>
<a href="#l20.582"></a><span id="l20.582" class="difflineminus">-  if (mIsQueryURI) return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l20.583"></a><span id="l20.583" class="difflineminus">-</span>
<a href="#l20.584"></a><span id="l20.584" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l20.585"></a><span id="l20.585" class="difflineminus">-  if (!mDatabase) rv = GetAbDatabase();</span>
<a href="#l20.586"></a><span id="l20.586" class="difflineminus">-</span>
<a href="#l20.587"></a><span id="l20.587" class="difflineminus">-  if (NS_FAILED(rv) || !mDatabase) return NS_ERROR_FAILURE;</span>
<a href="#l20.588"></a><span id="l20.588" class="difflineminus">-</span>
<a href="#l20.589"></a><span id="l20.589" class="difflineminus">-  if (m_IsMailList) {</span>
<a href="#l20.590"></a><span id="l20.590" class="difflineminus">-    rv = mDatabase-&gt;CreateNewListCardAndAddToDB(this, m_dbRowID, card,</span>
<a href="#l20.591"></a><span id="l20.591" class="difflineminus">-                                                true /* notify */);</span>
<a href="#l20.592"></a><span id="l20.592" class="difflineminus">-  } else {</span>
<a href="#l20.593"></a><span id="l20.593" class="difflineminus">-    rv = mDatabase-&gt;CreateNewCardAndAddToDB(card, true, this);</span>
<a href="#l20.594"></a><span id="l20.594" class="difflineminus">-    nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l20.595"></a><span id="l20.595" class="difflineminus">-        mozilla::services::GetObserverService();</span>
<a href="#l20.596"></a><span id="l20.596" class="difflineminus">-    if (observerService) {</span>
<a href="#l20.597"></a><span id="l20.597" class="difflineminus">-      nsAutoCString thisUID;</span>
<a href="#l20.598"></a><span id="l20.598" class="difflineminus">-      this-&gt;GetUID(thisUID);</span>
<a href="#l20.599"></a><span id="l20.599" class="difflineminus">-      observerService-&gt;NotifyObservers(card, &quot;addrbook-contact-created&quot;,</span>
<a href="#l20.600"></a><span id="l20.600" class="difflineminus">-                                       NS_ConvertUTF8toUTF16(thisUID).get());</span>
<a href="#l20.601"></a><span id="l20.601" class="difflineminus">-    }</span>
<a href="#l20.602"></a><span id="l20.602" class="difflineminus">-  }</span>
<a href="#l20.603"></a><span id="l20.603" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.604"></a><span id="l20.604" class="difflineminus">-</span>
<a href="#l20.605"></a><span id="l20.605" class="difflineminus">-  mDatabase-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l20.606"></a><span id="l20.606" class="difflineminus">-</span>
<a href="#l20.607"></a><span id="l20.607" class="difflineminus">-  NS_IF_ADDREF(*addedCard = card);</span>
<a href="#l20.608"></a><span id="l20.608" class="difflineminus">-  return NS_OK;</span>
<a href="#l20.609"></a><span id="l20.609" class="difflineminus">-}</span>
<a href="#l20.610"></a><span id="l20.610" class="difflineminus">-</span>
<a href="#l20.611"></a><span id="l20.611" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::ModifyCard(nsIAbCard *aModifiedCard) {</span>
<a href="#l20.612"></a><span id="l20.612" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aModifiedCard);</span>
<a href="#l20.613"></a><span id="l20.613" class="difflineminus">-</span>
<a href="#l20.614"></a><span id="l20.614" class="difflineminus">-  nsresult rv;</span>
<a href="#l20.615"></a><span id="l20.615" class="difflineminus">-  if (!mDatabase) {</span>
<a href="#l20.616"></a><span id="l20.616" class="difflineminus">-    rv = GetAbDatabase();</span>
<a href="#l20.617"></a><span id="l20.617" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.618"></a><span id="l20.618" class="difflineminus">-  }</span>
<a href="#l20.619"></a><span id="l20.619" class="difflineminus">-</span>
<a href="#l20.620"></a><span id="l20.620" class="difflineminus">-  rv = mDatabase-&gt;EditCard(aModifiedCard, true, this);</span>
<a href="#l20.621"></a><span id="l20.621" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.622"></a><span id="l20.622" class="difflineminus">-</span>
<a href="#l20.623"></a><span id="l20.623" class="difflineminus">-  // If it's a mailing list's card, ensure the related nsIAbDirectory has the</span>
<a href="#l20.624"></a><span id="l20.624" class="difflineminus">-  // same UID.</span>
<a href="#l20.625"></a><span id="l20.625" class="difflineminus">-  bool isMailList;</span>
<a href="#l20.626"></a><span id="l20.626" class="difflineminus">-  rv = aModifiedCard-&gt;GetIsMailList(&amp;isMailList);</span>
<a href="#l20.627"></a><span id="l20.627" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.628"></a><span id="l20.628" class="difflineminus">-  if (isMailList) {</span>
<a href="#l20.629"></a><span id="l20.629" class="difflineminus">-    nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l20.630"></a><span id="l20.630" class="difflineminus">-        do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l20.631"></a><span id="l20.631" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.632"></a><span id="l20.632" class="difflineminus">-</span>
<a href="#l20.633"></a><span id="l20.633" class="difflineminus">-    nsAutoCString uri;</span>
<a href="#l20.634"></a><span id="l20.634" class="difflineminus">-    rv = aModifiedCard-&gt;GetMailListURI(getter_Copies(uri));</span>
<a href="#l20.635"></a><span id="l20.635" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.636"></a><span id="l20.636" class="difflineminus">-</span>
<a href="#l20.637"></a><span id="l20.637" class="difflineminus">-    nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l20.638"></a><span id="l20.638" class="difflineminus">-    rv = abManager-&gt;GetDirectory(uri, getter_AddRefs(directory));</span>
<a href="#l20.639"></a><span id="l20.639" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.640"></a><span id="l20.640" class="difflineminus">-</span>
<a href="#l20.641"></a><span id="l20.641" class="difflineminus">-    nsAutoCString uid;</span>
<a href="#l20.642"></a><span id="l20.642" class="difflineminus">-    rv = aModifiedCard-&gt;GetUID(uid);</span>
<a href="#l20.643"></a><span id="l20.643" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.644"></a><span id="l20.644" class="difflineminus">-</span>
<a href="#l20.645"></a><span id="l20.645" class="difflineminus">-    rv = directory-&gt;SetUID(uid);</span>
<a href="#l20.646"></a><span id="l20.646" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.647"></a><span id="l20.647" class="difflineminus">-  }</span>
<a href="#l20.648"></a><span id="l20.648" class="difflineminus">-</span>
<a href="#l20.649"></a><span id="l20.649" class="difflineminus">-  nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l20.650"></a><span id="l20.650" class="difflineminus">-      mozilla::services::GetObserverService();</span>
<a href="#l20.651"></a><span id="l20.651" class="difflineminus">-  if (observerService) {</span>
<a href="#l20.652"></a><span id="l20.652" class="difflineminus">-    nsAutoCString thisUID;</span>
<a href="#l20.653"></a><span id="l20.653" class="difflineminus">-    this-&gt;GetUID(thisUID);</span>
<a href="#l20.654"></a><span id="l20.654" class="difflineminus">-    observerService-&gt;NotifyObservers(aModifiedCard, &quot;addrbook-contact-updated&quot;,</span>
<a href="#l20.655"></a><span id="l20.655" class="difflineminus">-                                     NS_ConvertUTF8toUTF16(thisUID).get());</span>
<a href="#l20.656"></a><span id="l20.656" class="difflineminus">-  }</span>
<a href="#l20.657"></a><span id="l20.657" class="difflineminus">-</span>
<a href="#l20.658"></a><span id="l20.658" class="difflineminus">-  return mDatabase-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l20.659"></a><span id="l20.659" class="difflineminus">-}</span>
<a href="#l20.660"></a><span id="l20.660" class="difflineminus">-</span>
<a href="#l20.661"></a><span id="l20.661" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::DropCard(nsIAbCard *aCard,</span>
<a href="#l20.662"></a><span id="l20.662" class="difflineminus">-                                         bool needToCopyCard) {</span>
<a href="#l20.663"></a><span id="l20.663" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aCard);</span>
<a href="#l20.664"></a><span id="l20.664" class="difflineminus">-</span>
<a href="#l20.665"></a><span id="l20.665" class="difflineminus">-  if (mIsQueryURI) return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l20.666"></a><span id="l20.666" class="difflineminus">-</span>
<a href="#l20.667"></a><span id="l20.667" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l20.668"></a><span id="l20.668" class="difflineminus">-</span>
<a href="#l20.669"></a><span id="l20.669" class="difflineminus">-  if (!mDatabase) rv = GetAbDatabase();</span>
<a href="#l20.670"></a><span id="l20.670" class="difflineminus">-</span>
<a href="#l20.671"></a><span id="l20.671" class="difflineminus">-  if (NS_FAILED(rv) || !mDatabase) return NS_ERROR_FAILURE;</span>
<a href="#l20.672"></a><span id="l20.672" class="difflineminus">-</span>
<a href="#l20.673"></a><span id="l20.673" class="difflineminus">-  nsCOMPtr&lt;nsIAbCard&gt; newCard;</span>
<a href="#l20.674"></a><span id="l20.674" class="difflineminus">-</span>
<a href="#l20.675"></a><span id="l20.675" class="difflineminus">-  if (needToCopyCard) {</span>
<a href="#l20.676"></a><span id="l20.676" class="difflineminus">-    newCard = do_CreateInstance(NS_ABMDBCARD_CONTRACTID, &amp;rv);</span>
<a href="#l20.677"></a><span id="l20.677" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.678"></a><span id="l20.678" class="difflineminus">-</span>
<a href="#l20.679"></a><span id="l20.679" class="difflineminus">-    rv = newCard-&gt;Copy(aCard);</span>
<a href="#l20.680"></a><span id="l20.680" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.681"></a><span id="l20.681" class="difflineminus">-  } else {</span>
<a href="#l20.682"></a><span id="l20.682" class="difflineminus">-    newCard = aCard;</span>
<a href="#l20.683"></a><span id="l20.683" class="difflineminus">-  }</span>
<a href="#l20.684"></a><span id="l20.684" class="difflineminus">-</span>
<a href="#l20.685"></a><span id="l20.685" class="difflineminus">-  if (m_IsMailList) {</span>
<a href="#l20.686"></a><span id="l20.686" class="difflineminus">-    if (needToCopyCard) {</span>
<a href="#l20.687"></a><span id="l20.687" class="difflineminus">-      nsCOMPtr&lt;nsIMdbRow&gt; cardRow;</span>
<a href="#l20.688"></a><span id="l20.688" class="difflineminus">-      // if card doesn't exist in db, add the card to the directory that</span>
<a href="#l20.689"></a><span id="l20.689" class="difflineminus">-      // contains the mailing list.</span>
<a href="#l20.690"></a><span id="l20.690" class="difflineminus">-      mDatabase-&gt;FindRowByCard(newCard, getter_AddRefs(cardRow));</span>
<a href="#l20.691"></a><span id="l20.691" class="difflineminus">-      if (!cardRow)</span>
<a href="#l20.692"></a><span id="l20.692" class="difflineminus">-        mDatabase-&gt;CreateNewCardAndAddToDB(newCard, true /* notify */, this);</span>
<a href="#l20.693"></a><span id="l20.693" class="difflineminus">-      else</span>
<a href="#l20.694"></a><span id="l20.694" class="difflineminus">-        mDatabase-&gt;InitCardFromRow(newCard, cardRow);</span>
<a href="#l20.695"></a><span id="l20.695" class="difflineminus">-    }</span>
<a href="#l20.696"></a><span id="l20.696" class="difflineminus">-    // since we didn't copy the card, we don't have to notify that it was</span>
<a href="#l20.697"></a><span id="l20.697" class="difflineminus">-    // inserted</span>
<a href="#l20.698"></a><span id="l20.698" class="difflineminus">-    mDatabase-&gt;CreateNewListCardAndAddToDB(this, m_dbRowID, newCard,</span>
<a href="#l20.699"></a><span id="l20.699" class="difflineminus">-                                           false /* notify */);</span>
<a href="#l20.700"></a><span id="l20.700" class="difflineminus">-    nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l20.701"></a><span id="l20.701" class="difflineminus">-        mozilla::services::GetObserverService();</span>
<a href="#l20.702"></a><span id="l20.702" class="difflineminus">-    if (observerService) {</span>
<a href="#l20.703"></a><span id="l20.703" class="difflineminus">-      nsAutoCString thisUID;</span>
<a href="#l20.704"></a><span id="l20.704" class="difflineminus">-      this-&gt;GetUID(thisUID);</span>
<a href="#l20.705"></a><span id="l20.705" class="difflineminus">-      observerService-&gt;NotifyObservers(newCard, &quot;addrbook-list-member-added&quot;,</span>
<a href="#l20.706"></a><span id="l20.706" class="difflineminus">-                                       NS_ConvertUTF8toUTF16(thisUID).get());</span>
<a href="#l20.707"></a><span id="l20.707" class="difflineminus">-    }</span>
<a href="#l20.708"></a><span id="l20.708" class="difflineminus">-  } else {</span>
<a href="#l20.709"></a><span id="l20.709" class="difflineminus">-    mDatabase-&gt;CreateNewCardAndAddToDB(newCard, true /* notify */, this);</span>
<a href="#l20.710"></a><span id="l20.710" class="difflineminus">-    nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l20.711"></a><span id="l20.711" class="difflineminus">-        mozilla::services::GetObserverService();</span>
<a href="#l20.712"></a><span id="l20.712" class="difflineminus">-    if (observerService) {</span>
<a href="#l20.713"></a><span id="l20.713" class="difflineminus">-      nsAutoCString thisUID;</span>
<a href="#l20.714"></a><span id="l20.714" class="difflineminus">-      this-&gt;GetUID(thisUID);</span>
<a href="#l20.715"></a><span id="l20.715" class="difflineminus">-      observerService-&gt;NotifyObservers(newCard, &quot;addrbook-contact-created&quot;,</span>
<a href="#l20.716"></a><span id="l20.716" class="difflineminus">-                                       NS_ConvertUTF8toUTF16(thisUID).get());</span>
<a href="#l20.717"></a><span id="l20.717" class="difflineminus">-    }</span>
<a href="#l20.718"></a><span id="l20.718" class="difflineminus">-  }</span>
<a href="#l20.719"></a><span id="l20.719" class="difflineminus">-  mDatabase-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l20.720"></a><span id="l20.720" class="difflineminus">-  return NS_OK;</span>
<a href="#l20.721"></a><span id="l20.721" class="difflineminus">-}</span>
<a href="#l20.722"></a><span id="l20.722" class="difflineminus">-</span>
<a href="#l20.723"></a><span id="l20.723" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::EditMailListToDatabase(nsIAbCard *listCard) {</span>
<a href="#l20.724"></a><span id="l20.724" class="difflineminus">-  if (mIsQueryURI) return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l20.725"></a><span id="l20.725" class="difflineminus">-</span>
<a href="#l20.726"></a><span id="l20.726" class="difflineminus">-  if (!m_IsMailList) return NS_ERROR_UNEXPECTED;</span>
<a href="#l20.727"></a><span id="l20.727" class="difflineminus">-</span>
<a href="#l20.728"></a><span id="l20.728" class="difflineminus">-  nsresult rv = GetAbDatabase();</span>
<a href="#l20.729"></a><span id="l20.729" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.730"></a><span id="l20.730" class="difflineminus">-</span>
<a href="#l20.731"></a><span id="l20.731" class="difflineminus">-  mDatabase-&gt;EditMailList(this, listCard, true);</span>
<a href="#l20.732"></a><span id="l20.732" class="difflineminus">-  mDatabase-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l20.733"></a><span id="l20.733" class="difflineminus">-</span>
<a href="#l20.734"></a><span id="l20.734" class="difflineminus">-  return NS_OK;</span>
<a href="#l20.735"></a><span id="l20.735" class="difflineminus">-}</span>
<a href="#l20.736"></a><span id="l20.736" class="difflineminus">-</span>
<a href="#l20.737"></a><span id="l20.737" class="difflineminus">-static bool ContainsDirectory(nsIAbDirectory *parent,</span>
<a href="#l20.738"></a><span id="l20.738" class="difflineminus">-                              nsIAbDirectory *directory) {</span>
<a href="#l20.739"></a><span id="l20.739" class="difflineminus">-  // If parent is a maillist, 'addressLists' contains AbCards.</span>
<a href="#l20.740"></a><span id="l20.740" class="difflineminus">-  bool bIsMailList = false;</span>
<a href="#l20.741"></a><span id="l20.741" class="difflineminus">-  nsresult rv = parent-&gt;GetIsMailList(&amp;bIsMailList);</span>
<a href="#l20.742"></a><span id="l20.742" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l20.743"></a><span id="l20.743" class="difflineminus">-</span>
<a href="#l20.744"></a><span id="l20.744" class="difflineminus">-  if (bIsMailList) return false;</span>
<a href="#l20.745"></a><span id="l20.745" class="difflineminus">-</span>
<a href="#l20.746"></a><span id="l20.746" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; pAddressLists;</span>
<a href="#l20.747"></a><span id="l20.747" class="difflineminus">-  parent-&gt;GetAddressLists(getter_AddRefs(pAddressLists));</span>
<a href="#l20.748"></a><span id="l20.748" class="difflineminus">-  if (pAddressLists) {</span>
<a href="#l20.749"></a><span id="l20.749" class="difflineminus">-    uint32_t total;</span>
<a href="#l20.750"></a><span id="l20.750" class="difflineminus">-    rv = pAddressLists-&gt;GetLength(&amp;total);</span>
<a href="#l20.751"></a><span id="l20.751" class="difflineminus">-    for (uint32_t i = 0; i &lt; total; ++i) {</span>
<a href="#l20.752"></a><span id="l20.752" class="difflineminus">-      nsCOMPtr&lt;nsIAbDirectory&gt; pList(do_QueryElementAt(pAddressLists, i, &amp;rv));</span>
<a href="#l20.753"></a><span id="l20.753" class="difflineminus">-</span>
<a href="#l20.754"></a><span id="l20.754" class="difflineminus">-      if (directory == pList) return true;</span>
<a href="#l20.755"></a><span id="l20.755" class="difflineminus">-    }</span>
<a href="#l20.756"></a><span id="l20.756" class="difflineminus">-  }</span>
<a href="#l20.757"></a><span id="l20.757" class="difflineminus">-</span>
<a href="#l20.758"></a><span id="l20.758" class="difflineminus">-  return false;</span>
<a href="#l20.759"></a><span id="l20.759" class="difflineminus">-}</span>
<a href="#l20.760"></a><span id="l20.760" class="difflineminus">-</span>
<a href="#l20.761"></a><span id="l20.761" class="difflineminus">-// nsIAddrDBListener methods</span>
<a href="#l20.762"></a><span id="l20.762" class="difflineminus">-</span>
<a href="#l20.763"></a><span id="l20.763" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::OnCardAttribChange(uint32_t abCode) {</span>
<a href="#l20.764"></a><span id="l20.764" class="difflineminus">-  return NS_OK;</span>
<a href="#l20.765"></a><span id="l20.765" class="difflineminus">-}</span>
<a href="#l20.766"></a><span id="l20.766" class="difflineminus">-</span>
<a href="#l20.767"></a><span id="l20.767" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::OnCardEntryChange(uint32_t aAbCode,</span>
<a href="#l20.768"></a><span id="l20.768" class="difflineminus">-                                                  nsIAbCard *aCard,</span>
<a href="#l20.769"></a><span id="l20.769" class="difflineminus">-                                                  nsIAbDirectory *aParent) {</span>
<a href="#l20.770"></a><span id="l20.770" class="difflineminus">-  // Don't notify AbManager unless we have the parent</span>
<a href="#l20.771"></a><span id="l20.771" class="difflineminus">-  if (!aParent) return NS_OK;</span>
<a href="#l20.772"></a><span id="l20.772" class="difflineminus">-</span>
<a href="#l20.773"></a><span id="l20.773" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aCard);</span>
<a href="#l20.774"></a><span id="l20.774" class="difflineminus">-  nsCOMPtr&lt;nsISupports&gt; cardSupports(do_QueryInterface(aCard));</span>
<a href="#l20.775"></a><span id="l20.775" class="difflineminus">-  nsresult rv;</span>
<a href="#l20.776"></a><span id="l20.776" class="difflineminus">-</span>
<a href="#l20.777"></a><span id="l20.777" class="difflineminus">-  // Notify when</span>
<a href="#l20.778"></a><span id="l20.778" class="difflineminus">-  // - any operation is done to a card belonging to this</span>
<a href="#l20.779"></a><span id="l20.779" class="difflineminus">-  //        =&gt; if &lt;this&gt; is &lt;aParent&gt;, or</span>
<a href="#l20.780"></a><span id="l20.780" class="difflineminus">-  // - a card belonging to a directory which is parent of this is deleted</span>
<a href="#l20.781"></a><span id="l20.781" class="difflineminus">-  //        =&gt; if aAbCode is AB_NotifyDeleted &amp;&amp; &lt;this&gt; is child of &lt;aParent&gt;,</span>
<a href="#l20.782"></a><span id="l20.782" class="difflineminus">-  //        or</span>
<a href="#l20.783"></a><span id="l20.783" class="difflineminus">-  // - a card belonging to a directory which is child of this is added/modified</span>
<a href="#l20.784"></a><span id="l20.784" class="difflineminus">-  //        =&gt; if aAbCode is !AB_NotifyDeleted &amp;&amp; &lt;this&gt; is parent of &lt;aParent&gt;</span>
<a href="#l20.785"></a><span id="l20.785" class="difflineminus">-</span>
<a href="#l20.786"></a><span id="l20.786" class="difflineminus">-  if (aParent != this) {</span>
<a href="#l20.787"></a><span id="l20.787" class="difflineminus">-    bool isChild = false;</span>
<a href="#l20.788"></a><span id="l20.788" class="difflineminus">-    if (aAbCode != AB_NotifyDeleted)</span>
<a href="#l20.789"></a><span id="l20.789" class="difflineminus">-      isChild = ContainsDirectory(this, aParent);</span>
<a href="#l20.790"></a><span id="l20.790" class="difflineminus">-    else</span>
<a href="#l20.791"></a><span id="l20.791" class="difflineminus">-      isChild = ContainsDirectory(aParent, this);</span>
<a href="#l20.792"></a><span id="l20.792" class="difflineminus">-</span>
<a href="#l20.793"></a><span id="l20.793" class="difflineminus">-    if (!isChild) return NS_OK;</span>
<a href="#l20.794"></a><span id="l20.794" class="difflineminus">-  }</span>
<a href="#l20.795"></a><span id="l20.795" class="difflineminus">-</span>
<a href="#l20.796"></a><span id="l20.796" class="difflineminus">-  switch (aAbCode) {</span>
<a href="#l20.797"></a><span id="l20.797" class="difflineminus">-    case AB_NotifyInserted:</span>
<a href="#l20.798"></a><span id="l20.798" class="difflineminus">-      rv = NotifyItemAdded(cardSupports);</span>
<a href="#l20.799"></a><span id="l20.799" class="difflineminus">-      break;</span>
<a href="#l20.800"></a><span id="l20.800" class="difflineminus">-    case AB_NotifyDeleted:</span>
<a href="#l20.801"></a><span id="l20.801" class="difflineminus">-      rv = NotifyItemDeleted(cardSupports);</span>
<a href="#l20.802"></a><span id="l20.802" class="difflineminus">-      break;</span>
<a href="#l20.803"></a><span id="l20.803" class="difflineminus">-    case AB_NotifyPropertyChanged:</span>
<a href="#l20.804"></a><span id="l20.804" class="difflineminus">-      rv = NotifyItemChanged(cardSupports);</span>
<a href="#l20.805"></a><span id="l20.805" class="difflineminus">-      break;</span>
<a href="#l20.806"></a><span id="l20.806" class="difflineminus">-    default:</span>
<a href="#l20.807"></a><span id="l20.807" class="difflineminus">-      rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l20.808"></a><span id="l20.808" class="difflineminus">-      break;</span>
<a href="#l20.809"></a><span id="l20.809" class="difflineminus">-  }</span>
<a href="#l20.810"></a><span id="l20.810" class="difflineminus">-</span>
<a href="#l20.811"></a><span id="l20.811" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.812"></a><span id="l20.812" class="difflineminus">-  return rv;</span>
<a href="#l20.813"></a><span id="l20.813" class="difflineminus">-}</span>
<a href="#l20.814"></a><span id="l20.814" class="difflineminus">-</span>
<a href="#l20.815"></a><span id="l20.815" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::OnListEntryChange(uint32_t abCode,</span>
<a href="#l20.816"></a><span id="l20.816" class="difflineminus">-                                                  nsIAbDirectory *list) {</span>
<a href="#l20.817"></a><span id="l20.817" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l20.818"></a><span id="l20.818" class="difflineminus">-</span>
<a href="#l20.819"></a><span id="l20.819" class="difflineminus">-  if (abCode == AB_NotifyPropertyChanged &amp;&amp; list) {</span>
<a href="#l20.820"></a><span id="l20.820" class="difflineminus">-    bool bIsMailList = false;</span>
<a href="#l20.821"></a><span id="l20.821" class="difflineminus">-    rv = list-&gt;GetIsMailList(&amp;bIsMailList);</span>
<a href="#l20.822"></a><span id="l20.822" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.823"></a><span id="l20.823" class="difflineminus">-</span>
<a href="#l20.824"></a><span id="l20.824" class="difflineminus">-    nsCOMPtr&lt;nsIAbMDBDirectory&gt; dblist(do_QueryInterface(list, &amp;rv));</span>
<a href="#l20.825"></a><span id="l20.825" class="difflineminus">-    mozilla::Unused &lt;&lt; dblist;</span>
<a href="#l20.826"></a><span id="l20.826" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.827"></a><span id="l20.827" class="difflineminus">-</span>
<a href="#l20.828"></a><span id="l20.828" class="difflineminus">-    if (bIsMailList) {</span>
<a href="#l20.829"></a><span id="l20.829" class="difflineminus">-      nsString listName;</span>
<a href="#l20.830"></a><span id="l20.830" class="difflineminus">-      rv = list-&gt;GetDirName(listName);</span>
<a href="#l20.831"></a><span id="l20.831" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.832"></a><span id="l20.832" class="difflineminus">-</span>
<a href="#l20.833"></a><span id="l20.833" class="difflineminus">-      rv = NotifyPropertyChanged(list, &quot;DirName&quot;, EmptyString(), listName);</span>
<a href="#l20.834"></a><span id="l20.834" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.835"></a><span id="l20.835" class="difflineminus">-    }</span>
<a href="#l20.836"></a><span id="l20.836" class="difflineminus">-  }</span>
<a href="#l20.837"></a><span id="l20.837" class="difflineminus">-  return rv;</span>
<a href="#l20.838"></a><span id="l20.838" class="difflineminus">-}</span>
<a href="#l20.839"></a><span id="l20.839" class="difflineminus">-</span>
<a href="#l20.840"></a><span id="l20.840" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::OnAnnouncerGoingAway() {</span>
<a href="#l20.841"></a><span id="l20.841" class="difflineminus">-  if (mDatabase) mDatabase-&gt;RemoveListener(this);</span>
<a href="#l20.842"></a><span id="l20.842" class="difflineminus">-  return NS_OK;</span>
<a href="#l20.843"></a><span id="l20.843" class="difflineminus">-}</span>
<a href="#l20.844"></a><span id="l20.844" class="difflineminus">-</span>
<a href="#l20.845"></a><span id="l20.845" class="difflineminus">-nsresult nsAbMDBDirectory::StartSearch() {</span>
<a href="#l20.846"></a><span id="l20.846" class="difflineminus">-  if (!mIsQueryURI) return NS_ERROR_FAILURE;</span>
<a href="#l20.847"></a><span id="l20.847" class="difflineminus">-</span>
<a href="#l20.848"></a><span id="l20.848" class="difflineminus">-  nsresult rv;</span>
<a href="#l20.849"></a><span id="l20.849" class="difflineminus">-</span>
<a href="#l20.850"></a><span id="l20.850" class="difflineminus">-  mPerformingQuery = true;</span>
<a href="#l20.851"></a><span id="l20.851" class="difflineminus">-  mSearchCache.Clear();</span>
<a href="#l20.852"></a><span id="l20.852" class="difflineminus">-</span>
<a href="#l20.853"></a><span id="l20.853" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectoryQueryArguments&gt; arguments =</span>
<a href="#l20.854"></a><span id="l20.854" class="difflineminus">-      do_CreateInstance(NS_ABDIRECTORYQUERYARGUMENTS_CONTRACTID, &amp;rv);</span>
<a href="#l20.855"></a><span id="l20.855" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.856"></a><span id="l20.856" class="difflineminus">-</span>
<a href="#l20.857"></a><span id="l20.857" class="difflineminus">-  nsCOMPtr&lt;nsIAbBooleanExpression&gt; expression;</span>
<a href="#l20.858"></a><span id="l20.858" class="difflineminus">-  rv = nsAbQueryStringToExpression::Convert(mQueryString,</span>
<a href="#l20.859"></a><span id="l20.859" class="difflineminus">-                                            getter_AddRefs(expression));</span>
<a href="#l20.860"></a><span id="l20.860" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.861"></a><span id="l20.861" class="difflineminus">-</span>
<a href="#l20.862"></a><span id="l20.862" class="difflineminus">-  rv = arguments-&gt;SetExpression(expression);</span>
<a href="#l20.863"></a><span id="l20.863" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.864"></a><span id="l20.864" class="difflineminus">-</span>
<a href="#l20.865"></a><span id="l20.865" class="difflineminus">-  // don't search the subdirectories</span>
<a href="#l20.866"></a><span id="l20.866" class="difflineminus">-  // if the current directory is a mailing list, it won't have any</span>
<a href="#l20.867"></a><span id="l20.867" class="difflineminus">-  // subdirectories if the current directory is a addressbook, searching both it</span>
<a href="#l20.868"></a><span id="l20.868" class="difflineminus">-  // and the subdirectories (the mailing lists), will yield duplicate results</span>
<a href="#l20.869"></a><span id="l20.869" class="difflineminus">-  // because every entry in a mailing list will be an entry in the parent</span>
<a href="#l20.870"></a><span id="l20.870" class="difflineminus">-  // addressbook</span>
<a href="#l20.871"></a><span id="l20.871" class="difflineminus">-  rv = arguments-&gt;SetQuerySubDirectories(false);</span>
<a href="#l20.872"></a><span id="l20.872" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.873"></a><span id="l20.873" class="difflineminus">-</span>
<a href="#l20.874"></a><span id="l20.874" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l20.875"></a><span id="l20.875" class="difflineminus">-      do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l20.876"></a><span id="l20.876" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.877"></a><span id="l20.877" class="difflineminus">-</span>
<a href="#l20.878"></a><span id="l20.878" class="difflineminus">-  // Get the directory without the query</span>
<a href="#l20.879"></a><span id="l20.879" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l20.880"></a><span id="l20.880" class="difflineminus">-  rv = abManager-&gt;GetDirectory(mURINoQuery, getter_AddRefs(directory));</span>
<a href="#l20.881"></a><span id="l20.881" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.882"></a><span id="l20.882" class="difflineminus">-</span>
<a href="#l20.883"></a><span id="l20.883" class="difflineminus">-  // Bug 280232 - something was causing continuous loops in searching. Add a</span>
<a href="#l20.884"></a><span id="l20.884" class="difflineminus">-  // check here for the directory to search not being a query uri as well in</span>
<a href="#l20.885"></a><span id="l20.885" class="difflineminus">-  // the hopes that will at least break us out of the continuous loop even if</span>
<a href="#l20.886"></a><span id="l20.886" class="difflineminus">-  // we don't know how we got into it.</span>
<a href="#l20.887"></a><span id="l20.887" class="difflineminus">-  bool isQuery;</span>
<a href="#l20.888"></a><span id="l20.888" class="difflineminus">-  rv = directory-&gt;GetIsQuery(&amp;isQuery);</span>
<a href="#l20.889"></a><span id="l20.889" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.890"></a><span id="l20.890" class="difflineminus">-</span>
<a href="#l20.891"></a><span id="l20.891" class="difflineminus">-  if (isQuery) {</span>
<a href="#l20.892"></a><span id="l20.892" class="difflineminus">-    NS_ERROR(&quot;Attempting to search a directory within a search&quot;);</span>
<a href="#l20.893"></a><span id="l20.893" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l20.894"></a><span id="l20.894" class="difflineminus">-  }</span>
<a href="#l20.895"></a><span id="l20.895" class="difflineminus">-</span>
<a href="#l20.896"></a><span id="l20.896" class="difflineminus">-  // Initiate the proxy query with the no query directory</span>
<a href="#l20.897"></a><span id="l20.897" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectoryQueryProxy&gt; queryProxy =</span>
<a href="#l20.898"></a><span id="l20.898" class="difflineminus">-      do_CreateInstance(NS_ABDIRECTORYQUERYPROXY_CONTRACTID, &amp;rv);</span>
<a href="#l20.899"></a><span id="l20.899" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.900"></a><span id="l20.900" class="difflineminus">-</span>
<a href="#l20.901"></a><span id="l20.901" class="difflineminus">-  rv = queryProxy-&gt;Initiate();</span>
<a href="#l20.902"></a><span id="l20.902" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.903"></a><span id="l20.903" class="difflineminus">-</span>
<a href="#l20.904"></a><span id="l20.904" class="difflineminus">-  rv = queryProxy-&gt;DoQuery(directory, arguments, this, -1, 0, &amp;mContext);</span>
<a href="#l20.905"></a><span id="l20.905" class="difflineminus">-  return NS_OK;</span>
<a href="#l20.906"></a><span id="l20.906" class="difflineminus">-}</span>
<a href="#l20.907"></a><span id="l20.907" class="difflineminus">-</span>
<a href="#l20.908"></a><span id="l20.908" class="difflineminus">-// nsAbDirSearchListenerContext methods</span>
<a href="#l20.909"></a><span id="l20.909" class="difflineminus">-</span>
<a href="#l20.910"></a><span id="l20.910" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::OnSearchFinished(int32_t aResult,</span>
<a href="#l20.911"></a><span id="l20.911" class="difflineminus">-                                                 const nsAString &amp;aErrorMsg) {</span>
<a href="#l20.912"></a><span id="l20.912" class="difflineminus">-  mPerformingQuery = false;</span>
<a href="#l20.913"></a><span id="l20.913" class="difflineminus">-  return NS_OK;</span>
<a href="#l20.914"></a><span id="l20.914" class="difflineminus">-}</span>
<a href="#l20.915"></a><span id="l20.915" class="difflineminus">-</span>
<a href="#l20.916"></a><span id="l20.916" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::OnSearchFoundCard(nsIAbCard *card) {</span>
<a href="#l20.917"></a><span id="l20.917" class="difflineminus">-  mSearchCache.Put(card, card);</span>
<a href="#l20.918"></a><span id="l20.918" class="difflineminus">-</span>
<a href="#l20.919"></a><span id="l20.919" class="difflineminus">-  // TODO</span>
<a href="#l20.920"></a><span id="l20.920" class="difflineminus">-  // Search is synchronous so asserting on the</span>
<a href="#l20.921"></a><span id="l20.921" class="difflineminus">-  // datasource will not work since the getChildCards</span>
<a href="#l20.922"></a><span id="l20.922" class="difflineminus">-  // method will not have returned with results.</span>
<a href="#l20.923"></a><span id="l20.923" class="difflineminus">-  // NotifyItemAdded (card);</span>
<a href="#l20.924"></a><span id="l20.924" class="difflineminus">-  return NS_OK;</span>
<a href="#l20.925"></a><span id="l20.925" class="difflineminus">-}</span>
<a href="#l20.926"></a><span id="l20.926" class="difflineminus">-</span>
<a href="#l20.927"></a><span id="l20.927" class="difflineminus">-nsresult nsAbMDBDirectory::GetAbDatabase() {</span>
<a href="#l20.928"></a><span id="l20.928" class="difflineminus">-  if (mURI.IsEmpty()) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l20.929"></a><span id="l20.929" class="difflineminus">-</span>
<a href="#l20.930"></a><span id="l20.930" class="difflineminus">-  if (mDatabase) return NS_OK;</span>
<a href="#l20.931"></a><span id="l20.931" class="difflineminus">-</span>
<a href="#l20.932"></a><span id="l20.932" class="difflineminus">-  nsresult rv;</span>
<a href="#l20.933"></a><span id="l20.933" class="difflineminus">-</span>
<a href="#l20.934"></a><span id="l20.934" class="difflineminus">-  if (m_IsMailList) {</span>
<a href="#l20.935"></a><span id="l20.935" class="difflineminus">-    // Get the database of the parent directory.</span>
<a href="#l20.936"></a><span id="l20.936" class="difflineminus">-    nsAutoCString parentURI(mURINoQuery);</span>
<a href="#l20.937"></a><span id="l20.937" class="difflineminus">-</span>
<a href="#l20.938"></a><span id="l20.938" class="difflineminus">-    int32_t pos = parentURI.RFindChar('/');</span>
<a href="#l20.939"></a><span id="l20.939" class="difflineminus">-</span>
<a href="#l20.940"></a><span id="l20.940" class="difflineminus">-    // If we didn't find a / something really bad has happened</span>
<a href="#l20.941"></a><span id="l20.941" class="difflineminus">-    if (pos == -1) return NS_ERROR_FAILURE;</span>
<a href="#l20.942"></a><span id="l20.942" class="difflineminus">-</span>
<a href="#l20.943"></a><span id="l20.943" class="difflineminus">-    parentURI = StringHead(parentURI, pos);</span>
<a href="#l20.944"></a><span id="l20.944" class="difflineminus">-</span>
<a href="#l20.945"></a><span id="l20.945" class="difflineminus">-    nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l20.946"></a><span id="l20.946" class="difflineminus">-        do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l20.947"></a><span id="l20.947" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.948"></a><span id="l20.948" class="difflineminus">-</span>
<a href="#l20.949"></a><span id="l20.949" class="difflineminus">-    nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l20.950"></a><span id="l20.950" class="difflineminus">-    rv = abManager-&gt;GetDirectory(parentURI, getter_AddRefs(directory));</span>
<a href="#l20.951"></a><span id="l20.951" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.952"></a><span id="l20.952" class="difflineminus">-</span>
<a href="#l20.953"></a><span id="l20.953" class="difflineminus">-    nsCOMPtr&lt;nsIAbMDBDirectory&gt; mdbDir(do_QueryInterface(directory, &amp;rv));</span>
<a href="#l20.954"></a><span id="l20.954" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.955"></a><span id="l20.955" class="difflineminus">-</span>
<a href="#l20.956"></a><span id="l20.956" class="difflineminus">-    rv = mdbDir-&gt;GetDatabase(getter_AddRefs(mDatabase));</span>
<a href="#l20.957"></a><span id="l20.957" class="difflineminus">-  } else</span>
<a href="#l20.958"></a><span id="l20.958" class="difflineminus">-    rv = GetDatabase(getter_AddRefs(mDatabase));</span>
<a href="#l20.959"></a><span id="l20.959" class="difflineminus">-</span>
<a href="#l20.960"></a><span id="l20.960" class="difflineminus">-  if (NS_SUCCEEDED(rv)) rv = mDatabase-&gt;AddListener(this);</span>
<a href="#l20.961"></a><span id="l20.961" class="difflineminus">-</span>
<a href="#l20.962"></a><span id="l20.962" class="difflineminus">-  return rv;</span>
<a href="#l20.963"></a><span id="l20.963" class="difflineminus">-}</span>
<a href="#l20.964"></a><span id="l20.964" class="difflineminus">-</span>
<a href="#l20.965"></a><span id="l20.965" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::CardForEmailAddress(</span>
<a href="#l20.966"></a><span id="l20.966" class="difflineminus">-    const nsACString &amp;aEmailAddress, nsIAbCard **aAbCard) {</span>
<a href="#l20.967"></a><span id="l20.967" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aAbCard);</span>
<a href="#l20.968"></a><span id="l20.968" class="difflineminus">-</span>
<a href="#l20.969"></a><span id="l20.969" class="difflineminus">-  *aAbCard = nullptr;</span>
<a href="#l20.970"></a><span id="l20.970" class="difflineminus">-</span>
<a href="#l20.971"></a><span id="l20.971" class="difflineminus">-  // Ensure that if we've not been given an email address we never match</span>
<a href="#l20.972"></a><span id="l20.972" class="difflineminus">-  // so that we don't fail out unnecessarily and we don't match a blank email</span>
<a href="#l20.973"></a><span id="l20.973" class="difflineminus">-  // address against random cards that the user hasn't supplied an email for.</span>
<a href="#l20.974"></a><span id="l20.974" class="difflineminus">-  if (aEmailAddress.IsEmpty()) return NS_OK;</span>
<a href="#l20.975"></a><span id="l20.975" class="difflineminus">-</span>
<a href="#l20.976"></a><span id="l20.976" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l20.977"></a><span id="l20.977" class="difflineminus">-  if (!mDatabase) rv = GetAbDatabase();</span>
<a href="#l20.978"></a><span id="l20.978" class="difflineminus">-  if (rv == NS_ERROR_FILE_NOT_FOUND) {</span>
<a href="#l20.979"></a><span id="l20.979" class="difflineminus">-    // If file wasn't found, the card cannot exist.</span>
<a href="#l20.980"></a><span id="l20.980" class="difflineminus">-    return NS_OK;</span>
<a href="#l20.981"></a><span id="l20.981" class="difflineminus">-  }</span>
<a href="#l20.982"></a><span id="l20.982" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.983"></a><span id="l20.983" class="difflineminus">-</span>
<a href="#l20.984"></a><span id="l20.984" class="difflineminus">-  // Convert Email to lower case in UTF-16 format. This correctly lower-cases</span>
<a href="#l20.985"></a><span id="l20.985" class="difflineminus">-  // it and doing this change means that we can use a hash lookup in the</span>
<a href="#l20.986"></a><span id="l20.986" class="difflineminus">-  // database rather than searching and comparing each line individually.</span>
<a href="#l20.987"></a><span id="l20.987" class="difflineminus">-  NS_ConvertUTF8toUTF16 lowerEmail(aEmailAddress);</span>
<a href="#l20.988"></a><span id="l20.988" class="difflineminus">-  ToLowerCase(lowerEmail);</span>
<a href="#l20.989"></a><span id="l20.989" class="difflineminus">-</span>
<a href="#l20.990"></a><span id="l20.990" class="difflineminus">-  // If lower email is empty, something went wrong somewhere, e.g. the</span>
<a href="#l20.991"></a><span id="l20.991" class="difflineminus">-  // conversion. Hence, don't go looking for a card with no email address.</span>
<a href="#l20.992"></a><span id="l20.992" class="difflineminus">-  // Something is wrong.</span>
<a href="#l20.993"></a><span id="l20.993" class="difflineminus">-  if (lowerEmail.IsEmpty()) return NS_ERROR_FAILURE;</span>
<a href="#l20.994"></a><span id="l20.994" class="difflineminus">-</span>
<a href="#l20.995"></a><span id="l20.995" class="difflineminus">-  mDatabase-&gt;GetCardFromAttribute(this, kLowerPriEmailColumn,</span>
<a href="#l20.996"></a><span id="l20.996" class="difflineminus">-                                  NS_ConvertUTF16toUTF8(lowerEmail), false,</span>
<a href="#l20.997"></a><span id="l20.997" class="difflineminus">-                                  aAbCard);</span>
<a href="#l20.998"></a><span id="l20.998" class="difflineminus">-  if (!*aAbCard) {</span>
<a href="#l20.999"></a><span id="l20.999" class="difflineminus">-    mDatabase-&gt;GetCardFromAttribute(this, kLower2ndEmailColumn,</span>
<a href="#l20.1000"></a><span id="l20.1000" class="difflineminus">-                                    NS_ConvertUTF16toUTF8(lowerEmail), false,</span>
<a href="#l20.1001"></a><span id="l20.1001" class="difflineminus">-                                    aAbCard);</span>
<a href="#l20.1002"></a><span id="l20.1002" class="difflineminus">-  }</span>
<a href="#l20.1003"></a><span id="l20.1003" class="difflineminus">-  return NS_OK;</span>
<a href="#l20.1004"></a><span id="l20.1004" class="difflineminus">-}</span>
<a href="#l20.1005"></a><span id="l20.1005" class="difflineminus">-</span>
<a href="#l20.1006"></a><span id="l20.1006" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::GetCardFromProperty(const char *aProperty,</span>
<a href="#l20.1007"></a><span id="l20.1007" class="difflineminus">-                                                    const nsACString &amp;aValue,</span>
<a href="#l20.1008"></a><span id="l20.1008" class="difflineminus">-                                                    bool caseSensitive,</span>
<a href="#l20.1009"></a><span id="l20.1009" class="difflineminus">-                                                    nsIAbCard **result) {</span>
<a href="#l20.1010"></a><span id="l20.1010" class="difflineminus">-  NS_ENSURE_ARG(aProperty);</span>
<a href="#l20.1011"></a><span id="l20.1011" class="difflineminus">-  NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l20.1012"></a><span id="l20.1012" class="difflineminus">-</span>
<a href="#l20.1013"></a><span id="l20.1013" class="difflineminus">-  *result = nullptr;</span>
<a href="#l20.1014"></a><span id="l20.1014" class="difflineminus">-</span>
<a href="#l20.1015"></a><span id="l20.1015" class="difflineminus">-  // If the value is empty, don't match.</span>
<a href="#l20.1016"></a><span id="l20.1016" class="difflineminus">-  if (aValue.IsEmpty()) return NS_OK;</span>
<a href="#l20.1017"></a><span id="l20.1017" class="difflineminus">-</span>
<a href="#l20.1018"></a><span id="l20.1018" class="difflineminus">-  nsresult rv;</span>
<a href="#l20.1019"></a><span id="l20.1019" class="difflineminus">-  if (!mDatabase) {</span>
<a href="#l20.1020"></a><span id="l20.1020" class="difflineminus">-    rv = GetAbDatabase();</span>
<a href="#l20.1021"></a><span id="l20.1021" class="difflineminus">-    // We can't find the database file, so we can't find the card at all.</span>
<a href="#l20.1022"></a><span id="l20.1022" class="difflineminus">-    if (rv == NS_ERROR_FILE_NOT_FOUND) return NS_OK;</span>
<a href="#l20.1023"></a><span id="l20.1023" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.1024"></a><span id="l20.1024" class="difflineminus">-  }</span>
<a href="#l20.1025"></a><span id="l20.1025" class="difflineminus">-</span>
<a href="#l20.1026"></a><span id="l20.1026" class="difflineminus">-  // nsIAddrDatabase has aCaseInsensitive as its parameter</span>
<a href="#l20.1027"></a><span id="l20.1027" class="difflineminus">-  return mDatabase-&gt;GetCardFromAttribute(this, aProperty, aValue,</span>
<a href="#l20.1028"></a><span id="l20.1028" class="difflineminus">-                                         !caseSensitive, result);</span>
<a href="#l20.1029"></a><span id="l20.1029" class="difflineminus">-}</span>
<a href="#l20.1030"></a><span id="l20.1030" class="difflineminus">-</span>
<a href="#l20.1031"></a><span id="l20.1031" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirectory::GetCardsFromProperty(</span>
<a href="#l20.1032"></a><span id="l20.1032" class="difflineminus">-    const char *aProperty, const nsACString &amp;aValue, bool caseSensitive,</span>
<a href="#l20.1033"></a><span id="l20.1033" class="difflineminus">-    nsISimpleEnumerator **result) {</span>
<a href="#l20.1034"></a><span id="l20.1034" class="difflineminus">-  NS_ENSURE_ARG(aProperty);</span>
<a href="#l20.1035"></a><span id="l20.1035" class="difflineminus">-  NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l20.1036"></a><span id="l20.1036" class="difflineminus">-</span>
<a href="#l20.1037"></a><span id="l20.1037" class="difflineminus">-  *result = nullptr;</span>
<a href="#l20.1038"></a><span id="l20.1038" class="difflineminus">-</span>
<a href="#l20.1039"></a><span id="l20.1039" class="difflineminus">-  if (aValue.IsEmpty()) return NS_OK;</span>
<a href="#l20.1040"></a><span id="l20.1040" class="difflineminus">-</span>
<a href="#l20.1041"></a><span id="l20.1041" class="difflineminus">-  if (!mDatabase) {</span>
<a href="#l20.1042"></a><span id="l20.1042" class="difflineminus">-    nsresult rv = GetAbDatabase();</span>
<a href="#l20.1043"></a><span id="l20.1043" class="difflineminus">-    if (rv == NS_ERROR_FILE_NOT_FOUND) return NS_OK;</span>
<a href="#l20.1044"></a><span id="l20.1044" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.1045"></a><span id="l20.1045" class="difflineminus">-  }</span>
<a href="#l20.1046"></a><span id="l20.1046" class="difflineminus">-</span>
<a href="#l20.1047"></a><span id="l20.1047" class="difflineminus">-  return mDatabase-&gt;GetCardsFromAttribute(this, aProperty, aValue,</span>
<a href="#l20.1048"></a><span id="l20.1048" class="difflineminus">-                                          !caseSensitive, result);</span>
<a href="#l20.1049"></a><span id="l20.1049" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1">deleted file mode 100644</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBDirectory.h</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineplus">+++ /dev/null</span>
<a href="#l21.4"></a><span id="l21.4" class="difflineat">@@ -1,106 +0,0 @@</span>
<a href="#l21.5"></a><span id="l21.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l21.6"></a><span id="l21.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l21.7"></a><span id="l21.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l21.8"></a><span id="l21.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l21.9"></a><span id="l21.9" class="difflineminus">-</span>
<a href="#l21.10"></a><span id="l21.10" class="difflineminus">-/********************************************************************************************************</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineminus">-</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-   Interface for representing Address Book Directory</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-*********************************************************************************************************/</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-#ifndef nsAbMDBDirectory_h__</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineminus">-#define nsAbMDBDirectory_h__</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineminus">-</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineminus">-#include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineminus">-#include &quot;nsAbMDBDirProperty.h&quot;</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineminus">-#include &quot;nsIAbCard.h&quot;</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineminus">-#include &quot;nsCOMArray.h&quot;</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineminus">-#include &quot;nsDirPrefs.h&quot;</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineminus">-#include &quot;nsIAbDirSearchListener.h&quot;</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineminus">-#include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineminus">-#include &quot;nsIAddrDBListener.h&quot;</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineminus">-</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineminus">-/*</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineminus">- * Address Book Directory</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">- */</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineminus">-class nsAbMDBDirectory</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineminus">-    : public nsAbMDBDirProperty,  // nsIAbDirectory, nsIAbMDBDirectory</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineminus">-      public nsIAbDirSearchListener,</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineminus">-      public nsIAddrDBListener {</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineminus">- public:</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineminus">-  nsAbMDBDirectory(void);</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineminus">-</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineminus">-  NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineminus">-  NS_DECL_NSIADDRDBLISTENER</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineminus">-</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineminus">-  // Override nsAbMDBDirProperty::Init</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineminus">-  NS_IMETHOD Init(const char *aUri) override;</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineminus">-</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineminus">-  // nsIAbMDBDirectory methods</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineminus">-  NS_IMETHOD GetURI(nsACString &amp;aURI) override;</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineminus">-  NS_IMETHOD ClearDatabase() override;</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineminus">-  NS_IMETHOD NotifyDirItemAdded(nsISupports *item) override {</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineminus">-    return NotifyItemAdded(item);</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineminus">-  }</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineminus">-  NS_IMETHOD RemoveElementsFromAddressList() override;</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineminus">-  NS_IMETHOD RemoveEmailAddressAt(uint32_t aIndex) override;</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineminus">-  NS_IMETHOD AddDirectory(const char *uriName,</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineminus">-                          nsIAbDirectory **childDir) override;</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineminus">-  NS_IMETHOD GetDatabaseFile(nsIFile **aResult) override;</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineminus">-  NS_IMETHOD GetDatabase(nsIAddrDatabase **aResult) override;</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineminus">-</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineminus">-  // nsIAbDirectory methods:</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineminus">-  NS_IMETHOD GetChildNodes(nsISimpleEnumerator **result) override;</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineminus">-  NS_IMETHOD GetChildCards(nsISimpleEnumerator **result) override;</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineminus">-  NS_IMETHOD GetIsQuery(bool *aResult) override;</span>
<a href="#l21.63"></a><span id="l21.63" class="difflineminus">-  NS_IMETHOD DeleteDirectory(nsIAbDirectory *directory) override;</span>
<a href="#l21.64"></a><span id="l21.64" class="difflineminus">-  NS_IMETHOD DeleteCards(nsIArray *cards) override;</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineminus">-  NS_IMETHOD HasCard(nsIAbCard *cards, bool *hasCard) override;</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineminus">-  NS_IMETHOD HasDirectory(nsIAbDirectory *dir, bool *hasDir) override;</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineminus">-  NS_IMETHOD HasMailListWithName(const char16_t *aName,</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineminus">-                                 bool *aHasList) override;</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineminus">-  NS_IMETHOD AddMailList(nsIAbDirectory *list,</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineminus">-                         nsIAbDirectory **addedList) override;</span>
<a href="#l21.71"></a><span id="l21.71" class="difflineminus">-  NS_IMETHOD AddCard(nsIAbCard *card, nsIAbCard **addedCard) override;</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineminus">-  NS_IMETHOD ModifyCard(nsIAbCard *aModifiedCard) override;</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineminus">-  NS_IMETHOD DropCard(nsIAbCard *card, bool needToCopyCard) override;</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineminus">-  NS_IMETHOD EditMailListToDatabase(nsIAbCard *listCard) override;</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineminus">-  NS_IMETHOD CardForEmailAddress(const nsACString &amp;aEmailAddress,</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineminus">-                                 nsIAbCard **aAbCard) override;</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineminus">-  NS_IMETHOD GetCardFromProperty(const char *aProperty,</span>
<a href="#l21.78"></a><span id="l21.78" class="difflineminus">-                                 const nsACString &amp;aValue, bool caseSensitive,</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineminus">-                                 nsIAbCard **result) override;</span>
<a href="#l21.80"></a><span id="l21.80" class="difflineminus">-  NS_IMETHOD GetCardsFromProperty(const char *aProperty,</span>
<a href="#l21.81"></a><span id="l21.81" class="difflineminus">-                                  const nsACString &amp;aValue, bool caseSensitive,</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineminus">-                                  nsISimpleEnumerator **result) override;</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineminus">-</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineminus">-  // nsIAbDirSearchListener methods</span>
<a href="#l21.85"></a><span id="l21.85" class="difflineminus">-  NS_DECL_NSIABDIRSEARCHLISTENER</span>
<a href="#l21.86"></a><span id="l21.86" class="difflineminus">-</span>
<a href="#l21.87"></a><span id="l21.87" class="difflineminus">- protected:</span>
<a href="#l21.88"></a><span id="l21.88" class="difflineminus">-  virtual ~nsAbMDBDirectory();</span>
<a href="#l21.89"></a><span id="l21.89" class="difflineminus">-  nsresult NotifyPropertyChanged(nsIAbDirectory *list, const char *property,</span>
<a href="#l21.90"></a><span id="l21.90" class="difflineminus">-                                 const nsAString &amp;oldValue,</span>
<a href="#l21.91"></a><span id="l21.91" class="difflineminus">-                                 const nsAString &amp;newValue);</span>
<a href="#l21.92"></a><span id="l21.92" class="difflineminus">-  nsresult NotifyItemAdded(nsISupports *item);</span>
<a href="#l21.93"></a><span id="l21.93" class="difflineminus">-  nsresult NotifyItemDeleted(nsISupports *item);</span>
<a href="#l21.94"></a><span id="l21.94" class="difflineminus">-  nsresult NotifyItemChanged(nsISupports *item);</span>
<a href="#l21.95"></a><span id="l21.95" class="difflineminus">-  nsresult RemoveCardFromAddressList(nsIAbCard *card);</span>
<a href="#l21.96"></a><span id="l21.96" class="difflineminus">-</span>
<a href="#l21.97"></a><span id="l21.97" class="difflineminus">-  nsresult StartSearch();</span>
<a href="#l21.98"></a><span id="l21.98" class="difflineminus">-</span>
<a href="#l21.99"></a><span id="l21.99" class="difflineminus">-  nsresult GetAbDatabase();</span>
<a href="#l21.100"></a><span id="l21.100" class="difflineminus">-  nsCOMPtr&lt;nsIAddrDatabase&gt; mDatabase;</span>
<a href="#l21.101"></a><span id="l21.101" class="difflineminus">-</span>
<a href="#l21.102"></a><span id="l21.102" class="difflineminus">-  nsCOMArray&lt;nsIAbDirectory&gt; mSubDirectories;</span>
<a href="#l21.103"></a><span id="l21.103" class="difflineminus">-</span>
<a href="#l21.104"></a><span id="l21.104" class="difflineminus">-  int32_t mContext;</span>
<a href="#l21.105"></a><span id="l21.105" class="difflineminus">-  bool mPerformingQuery;</span>
<a href="#l21.106"></a><span id="l21.106" class="difflineminus">-</span>
<a href="#l21.107"></a><span id="l21.107" class="difflineminus">-  nsInterfaceHashtable&lt;nsISupportsHashKey, nsIAbCard&gt; mSearchCache;</span>
<a href="#l21.108"></a><span id="l21.108" class="difflineminus">-};</span>
<a href="#l21.109"></a><span id="l21.109" class="difflineminus">-</span>
<a href="#l21.110"></a><span id="l21.110" class="difflineminus">-#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAddrDatabase.cpp</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAddrDatabase.cpp</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -5,17 +5,16 @@</span>
<a href="#l22.4"></a><span id="l22.4"> </span>
<a href="#l22.5"></a><span id="l22.5"> // this file implements the nsAddrDatabase interface using the MDB Interface.</span>
<a href="#l22.6"></a><span id="l22.6"> </span>
<a href="#l22.7"></a><span id="l22.7"> #include &quot;nsAddrDatabase.h&quot;</span>
<a href="#l22.8"></a><span id="l22.8"> #include &quot;nsString.h&quot;</span>
<a href="#l22.9"></a><span id="l22.9"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l22.10"></a><span id="l22.10"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l22.11"></a><span id="l22.11"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-#include &quot;nsIAbMDBDirectory.h&quot;</span>
<a href="#l22.13"></a><span id="l22.13"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l22.14"></a><span id="l22.14"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l22.15"></a><span id="l22.15"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l22.16"></a><span id="l22.16"> #include &quot;nsMorkCID.h&quot;</span>
<a href="#l22.17"></a><span id="l22.17"> #include &quot;nsIMdbFactoryFactory.h&quot;</span>
<a href="#l22.18"></a><span id="l22.18"> #include &quot;prprf.h&quot;</span>
<a href="#l22.19"></a><span id="l22.19"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l22.20"></a><span id="l22.20"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineat">@@ -1292,88 +1291,17 @@ NS_IMETHODIMP nsAddrDatabase::AddListCar</span>
<a href="#l22.22"></a><span id="l22.22">   }</span>
<a href="#l22.23"></a><span id="l22.23"> </span>
<a href="#l22.24"></a><span id="l22.24">   return NS_OK;</span>
<a href="#l22.25"></a><span id="l22.25"> }</span>
<a href="#l22.26"></a><span id="l22.26"> </span>
<a href="#l22.27"></a><span id="l22.27"> nsresult nsAddrDatabase::AddListAttributeColumnsToRow(nsIAbDirectory *list,</span>
<a href="#l22.28"></a><span id="l22.28">                                                       nsIMdbRow *listRow,</span>
<a href="#l22.29"></a><span id="l22.29">                                                       nsIAbDirectory *aParent) {</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineminus">-  nsresult err = NS_OK;</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-  if ((!list &amp;&amp; !listRow) || !m_mdbEnv) return NS_ERROR_NULL_POINTER;</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineminus">-  mdbOid rowOid, tableOid;</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineminus">-  m_mdbPabTable-&gt;GetOid(m_mdbEnv, &amp;tableOid);</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineminus">-  listRow-&gt;GetOid(m_mdbEnv, &amp;rowOid);</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineminus">-</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineminus">-  nsCOMPtr&lt;nsIAbMDBDirectory&gt; dblist(do_QueryInterface(list, &amp;err));</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineminus">-  if (NS_SUCCEEDED(err)) dblist-&gt;SetDbRowID(rowOid.mOid_Id);</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineminus">-</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineminus">-  // add the row to the singleton table.</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineminus">-  if (NS_SUCCEEDED(err) &amp;&amp; listRow) {</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineminus">-    nsAutoCString acStr;</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineminus">-    list-&gt;GetUID(acStr);</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineminus">-    AddUID(listRow, acStr.get());</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineminus">-</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineminus">-    nsString unicodeStr;</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineminus">-</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineminus">-    list-&gt;GetDirName(unicodeStr);</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineminus">-    if (!unicodeStr.IsEmpty())</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineminus">-      AddUnicodeToColumn(listRow, m_ListNameColumnToken,</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineminus">-                         m_LowerListNameColumnToken, unicodeStr.get());</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineminus">-</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineminus">-    list-&gt;GetListNickName(unicodeStr);</span>
<a href="#l22.55"></a><span id="l22.55" class="difflineminus">-    AddListNickName(listRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l22.56"></a><span id="l22.56" class="difflineminus">-</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineminus">-    list-&gt;GetDescription(unicodeStr);</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineminus">-    AddListDescription(listRow, NS_ConvertUTF16toUTF8(unicodeStr).get());</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineminus">-</span>
<a href="#l22.60"></a><span id="l22.60" class="difflineminus">-    // XXX todo, this code has problems if you manually enter duplicate emails.</span>
<a href="#l22.61"></a><span id="l22.61" class="difflineminus">-    nsCOMPtr&lt;nsIMutableArray&gt; pAddressLists;</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineminus">-    list-&gt;GetAddressLists(getter_AddRefs(pAddressLists));</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineminus">-</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineminus">-    uint32_t count;</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineminus">-    pAddressLists-&gt;GetLength(&amp;count);</span>
<a href="#l22.66"></a><span id="l22.66" class="difflineminus">-</span>
<a href="#l22.67"></a><span id="l22.67" class="difflineminus">-    nsAutoString email;</span>
<a href="#l22.68"></a><span id="l22.68" class="difflineminus">-    uint32_t i, total;</span>
<a href="#l22.69"></a><span id="l22.69" class="difflineminus">-    total = 0;</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineminus">-    for (i = 0; i &lt; count; i++) {</span>
<a href="#l22.71"></a><span id="l22.71" class="difflineminus">-      nsCOMPtr&lt;nsIAbCard&gt; pCard(do_QueryElementAt(pAddressLists, i, &amp;err));</span>
<a href="#l22.72"></a><span id="l22.72" class="difflineminus">-</span>
<a href="#l22.73"></a><span id="l22.73" class="difflineminus">-      if (NS_FAILED(err)) continue;</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineminus">-</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineminus">-      pCard-&gt;GetPrimaryEmail(email);</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineminus">-      if (!email.IsEmpty()) total++;</span>
<a href="#l22.77"></a><span id="l22.77" class="difflineminus">-    }</span>
<a href="#l22.78"></a><span id="l22.78" class="difflineminus">-    SetListAddressTotal(listRow, total);</span>
<a href="#l22.79"></a><span id="l22.79" class="difflineminus">-</span>
<a href="#l22.80"></a><span id="l22.80" class="difflineminus">-    uint32_t pos;</span>
<a href="#l22.81"></a><span id="l22.81" class="difflineminus">-    for (i = 0; i &lt; count; i++) {</span>
<a href="#l22.82"></a><span id="l22.82" class="difflineminus">-      nsCOMPtr&lt;nsIAbCard&gt; pCard(do_QueryElementAt(pAddressLists, i, &amp;err));</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineminus">-</span>
<a href="#l22.84"></a><span id="l22.84" class="difflineminus">-      if (NS_FAILED(err)) continue;</span>
<a href="#l22.85"></a><span id="l22.85" class="difflineminus">-</span>
<a href="#l22.86"></a><span id="l22.86" class="difflineminus">-      bool listHasCard = false;</span>
<a href="#l22.87"></a><span id="l22.87" class="difflineminus">-      err = list-&gt;HasCard(pCard, &amp;listHasCard);</span>
<a href="#l22.88"></a><span id="l22.88" class="difflineminus">-</span>
<a href="#l22.89"></a><span id="l22.89" class="difflineminus">-      // start from 1</span>
<a href="#l22.90"></a><span id="l22.90" class="difflineminus">-      pos = i + 1;</span>
<a href="#l22.91"></a><span id="l22.91" class="difflineminus">-      pCard-&gt;GetPrimaryEmail(email);</span>
<a href="#l22.92"></a><span id="l22.92" class="difflineminus">-      if (!email.IsEmpty()) {</span>
<a href="#l22.93"></a><span id="l22.93" class="difflineminus">-        nsCOMPtr&lt;nsIAbCard&gt; pNewCard;</span>
<a href="#l22.94"></a><span id="l22.94" class="difflineminus">-        err = AddListCardColumnsToRow(pCard, listRow, pos,</span>
<a href="#l22.95"></a><span id="l22.95" class="difflineminus">-                                      getter_AddRefs(pNewCard), listHasCard,</span>
<a href="#l22.96"></a><span id="l22.96" class="difflineminus">-                                      list, aParent);</span>
<a href="#l22.97"></a><span id="l22.97" class="difflineminus">-        if (pNewCard) pAddressLists-&gt;ReplaceElementAt(pNewCard, i);</span>
<a href="#l22.98"></a><span id="l22.98" class="difflineminus">-      }</span>
<a href="#l22.99"></a><span id="l22.99" class="difflineminus">-    }</span>
<a href="#l22.100"></a><span id="l22.100" class="difflineminus">-  }</span>
<a href="#l22.101"></a><span id="l22.101" class="difflineminus">-  return NS_OK;</span>
<a href="#l22.102"></a><span id="l22.102" class="difflineplus">+  return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l22.103"></a><span id="l22.103"> }</span>
<a href="#l22.104"></a><span id="l22.104"> </span>
<a href="#l22.105"></a><span id="l22.105"> uint32_t nsAddrDatabase::GetListAddressTotal(nsIMdbRow *listRow) {</span>
<a href="#l22.106"></a><span id="l22.106">   uint32_t count = 0;</span>
<a href="#l22.107"></a><span id="l22.107">   GetIntColumn(listRow, m_ListTotalColumnToken, &amp;count, 0);</span>
<a href="#l22.108"></a><span id="l22.108">   return count;</span>
<a href="#l22.109"></a><span id="l22.109"> }</span>
<a href="#l22.110"></a><span id="l22.110"> </span>
<a href="#l22.111"></a><span id="l22.111" class="difflineat">@@ -1585,59 +1513,17 @@ nsresult nsAddrDatabase::DeleteCardFromL</span>
<a href="#l22.112"></a><span id="l22.112">   }</span>
<a href="#l22.113"></a><span id="l22.113"> </span>
<a href="#l22.114"></a><span id="l22.114">   return NS_OK;</span>
<a href="#l22.115"></a><span id="l22.115"> }</span>
<a href="#l22.116"></a><span id="l22.116"> </span>
<a href="#l22.117"></a><span id="l22.117"> NS_IMETHODIMP nsAddrDatabase::DeleteCardFromMailList(nsIAbDirectory *mailList,</span>
<a href="#l22.118"></a><span id="l22.118">                                                      nsIAbCard *card,</span>
<a href="#l22.119"></a><span id="l22.119">                                                      bool aNotify) {</span>
<a href="#l22.120"></a><span id="l22.120" class="difflineminus">-  if (!card || !m_mdbPabTable || !m_mdbStore || !m_mdbEnv)</span>
<a href="#l22.121"></a><span id="l22.121" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l22.122"></a><span id="l22.122" class="difflineminus">-</span>
<a href="#l22.123"></a><span id="l22.123" class="difflineminus">-  nsresult err = NS_OK;</span>
<a href="#l22.124"></a><span id="l22.124" class="difflineminus">-</span>
<a href="#l22.125"></a><span id="l22.125" class="difflineminus">-  // get the right row</span>
<a href="#l22.126"></a><span id="l22.126" class="difflineminus">-  nsIMdbRow *pListRow = nullptr;</span>
<a href="#l22.127"></a><span id="l22.127" class="difflineminus">-  mdbOid listRowOid;</span>
<a href="#l22.128"></a><span id="l22.128" class="difflineminus">-  listRowOid.mOid_Scope = m_ListRowScopeToken;</span>
<a href="#l22.129"></a><span id="l22.129" class="difflineminus">-</span>
<a href="#l22.130"></a><span id="l22.130" class="difflineminus">-  nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbmailList(do_QueryInterface(mailList, &amp;err));</span>
<a href="#l22.131"></a><span id="l22.131" class="difflineminus">-  NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l22.132"></a><span id="l22.132" class="difflineminus">-</span>
<a href="#l22.133"></a><span id="l22.133" class="difflineminus">-  dbmailList-&gt;GetDbRowID((uint32_t *)&amp;listRowOid.mOid_Id);</span>
<a href="#l22.134"></a><span id="l22.134" class="difflineminus">-</span>
<a href="#l22.135"></a><span id="l22.135" class="difflineminus">-  err = m_mdbStore-&gt;GetRow(m_mdbEnv, &amp;listRowOid, &amp;pListRow);</span>
<a href="#l22.136"></a><span id="l22.136" class="difflineminus">-  NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l22.137"></a><span id="l22.137" class="difflineminus">-  if (!pListRow) return NS_OK;</span>
<a href="#l22.138"></a><span id="l22.138" class="difflineminus">-</span>
<a href="#l22.139"></a><span id="l22.139" class="difflineminus">-  uint32_t cardRowID;</span>
<a href="#l22.140"></a><span id="l22.140" class="difflineminus">-</span>
<a href="#l22.141"></a><span id="l22.141" class="difflineminus">-  err = card-&gt;GetPropertyAsUint32(kRowIDProperty, &amp;cardRowID);</span>
<a href="#l22.142"></a><span id="l22.142" class="difflineminus">-  if (NS_FAILED(err)) return NS_ERROR_NULL_POINTER;</span>
<a href="#l22.143"></a><span id="l22.143" class="difflineminus">-</span>
<a href="#l22.144"></a><span id="l22.144" class="difflineminus">-  bool cardFound = false;</span>
<a href="#l22.145"></a><span id="l22.145" class="difflineminus">-  err = DeleteCardFromListRow(pListRow, cardRowID, &amp;cardFound);</span>
<a href="#l22.146"></a><span id="l22.146" class="difflineminus">-  if (NS_SUCCEEDED(err) &amp;&amp; aNotify) {</span>
<a href="#l22.147"></a><span id="l22.147" class="difflineminus">-    NotifyCardEntryChange(AB_NotifyDeleted, card, mailList);</span>
<a href="#l22.148"></a><span id="l22.148" class="difflineminus">-    // Notify the addrbook-list-member-removed observer if the card was found</span>
<a href="#l22.149"></a><span id="l22.149" class="difflineminus">-    // and removed.</span>
<a href="#l22.150"></a><span id="l22.150" class="difflineminus">-    if (cardFound) {</span>
<a href="#l22.151"></a><span id="l22.151" class="difflineminus">-      nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l22.152"></a><span id="l22.152" class="difflineminus">-          mozilla::services::GetObserverService();</span>
<a href="#l22.153"></a><span id="l22.153" class="difflineminus">-      if (observerService) {</span>
<a href="#l22.154"></a><span id="l22.154" class="difflineminus">-        nsAutoCString listUID;</span>
<a href="#l22.155"></a><span id="l22.155" class="difflineminus">-        mailList-&gt;GetUID(listUID);</span>
<a href="#l22.156"></a><span id="l22.156" class="difflineminus">-        observerService-&gt;NotifyObservers(card, &quot;addrbook-list-member-removed&quot;,</span>
<a href="#l22.157"></a><span id="l22.157" class="difflineminus">-                                         NS_ConvertUTF8toUTF16(listUID).get());</span>
<a href="#l22.158"></a><span id="l22.158" class="difflineminus">-      }</span>
<a href="#l22.159"></a><span id="l22.159" class="difflineminus">-    }</span>
<a href="#l22.160"></a><span id="l22.160" class="difflineminus">-  }</span>
<a href="#l22.161"></a><span id="l22.161" class="difflineminus">-  NS_RELEASE(pListRow);</span>
<a href="#l22.162"></a><span id="l22.162" class="difflineminus">-  return NS_OK;</span>
<a href="#l22.163"></a><span id="l22.163" class="difflineplus">+  return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l22.164"></a><span id="l22.164"> }</span>
<a href="#l22.165"></a><span id="l22.165"> </span>
<a href="#l22.166"></a><span id="l22.166"> NS_IMETHODIMP nsAddrDatabase::SetCardValue(nsIAbCard *card, const char *name,</span>
<a href="#l22.167"></a><span id="l22.167">                                            const char16_t *value, bool notify) {</span>
<a href="#l22.168"></a><span id="l22.168">   NS_ENSURE_ARG_POINTER(card);</span>
<a href="#l22.169"></a><span id="l22.169">   NS_ENSURE_ARG_POINTER(name);</span>
<a href="#l22.170"></a><span id="l22.170">   NS_ENSURE_ARG_POINTER(value);</span>
<a href="#l22.171"></a><span id="l22.171">   if (!m_mdbStore || !m_mdbEnv) return NS_ERROR_NULL_POINTER;</span>
<a href="#l22.172"></a><span id="l22.172" class="difflineat">@@ -1763,107 +1649,27 @@ NS_IMETHODIMP nsAddrDatabase::ContainsCa</span>
<a href="#l22.173"></a><span id="l22.173">     *hasCard = hasOid;</span>
<a href="#l22.174"></a><span id="l22.174">   }</span>
<a href="#l22.175"></a><span id="l22.175"> </span>
<a href="#l22.176"></a><span id="l22.176">   return err;</span>
<a href="#l22.177"></a><span id="l22.177"> }</span>
<a href="#l22.178"></a><span id="l22.178"> </span>
<a href="#l22.179"></a><span id="l22.179"> NS_IMETHODIMP nsAddrDatabase::DeleteMailList(nsIAbDirectory *aMailList,</span>
<a href="#l22.180"></a><span id="l22.180">                                              nsIAbDirectory *aParent) {</span>
<a href="#l22.181"></a><span id="l22.181" class="difflineminus">-  if (!aMailList || !m_mdbPabTable || !m_mdbStore || !m_mdbEnv)</span>
<a href="#l22.182"></a><span id="l22.182" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l22.183"></a><span id="l22.183" class="difflineminus">-</span>
<a href="#l22.184"></a><span id="l22.184" class="difflineminus">-  nsresult err = NS_OK;</span>
<a href="#l22.185"></a><span id="l22.185" class="difflineminus">-</span>
<a href="#l22.186"></a><span id="l22.186" class="difflineminus">-  // get the row</span>
<a href="#l22.187"></a><span id="l22.187" class="difflineminus">-  nsCOMPtr&lt;nsIMdbRow&gt; pListRow;</span>
<a href="#l22.188"></a><span id="l22.188" class="difflineminus">-  mdbOid rowOid;</span>
<a href="#l22.189"></a><span id="l22.189" class="difflineminus">-  rowOid.mOid_Scope = m_ListRowScopeToken;</span>
<a href="#l22.190"></a><span id="l22.190" class="difflineminus">-</span>
<a href="#l22.191"></a><span id="l22.191" class="difflineminus">-  nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbmailList(do_QueryInterface(aMailList, &amp;err));</span>
<a href="#l22.192"></a><span id="l22.192" class="difflineminus">-  NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l22.193"></a><span id="l22.193" class="difflineminus">-  dbmailList-&gt;GetDbRowID((uint32_t *)&amp;rowOid.mOid_Id);</span>
<a href="#l22.194"></a><span id="l22.194" class="difflineminus">-</span>
<a href="#l22.195"></a><span id="l22.195" class="difflineminus">-  err = m_mdbStore-&gt;GetRow(m_mdbEnv, &amp;rowOid, getter_AddRefs(pListRow));</span>
<a href="#l22.196"></a><span id="l22.196" class="difflineminus">-  NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l22.197"></a><span id="l22.197" class="difflineminus">-</span>
<a href="#l22.198"></a><span id="l22.198" class="difflineminus">-  if (!pListRow) return NS_OK;</span>
<a href="#l22.199"></a><span id="l22.199" class="difflineminus">-</span>
<a href="#l22.200"></a><span id="l22.200" class="difflineminus">-  nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l22.201"></a><span id="l22.201" class="difflineminus">-  err = CreateABListCard(pListRow, getter_AddRefs(card));</span>
<a href="#l22.202"></a><span id="l22.202" class="difflineminus">-  NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l22.203"></a><span id="l22.203" class="difflineminus">-</span>
<a href="#l22.204"></a><span id="l22.204" class="difflineminus">-  err = DeleteRow(m_mdbPabTable, pListRow);</span>
<a href="#l22.205"></a><span id="l22.205" class="difflineminus">-</span>
<a href="#l22.206"></a><span id="l22.206" class="difflineminus">-  if (NS_SUCCEEDED(err) &amp;&amp; aParent)</span>
<a href="#l22.207"></a><span id="l22.207" class="difflineminus">-    NotifyCardEntryChange(AB_NotifyDeleted, card, aParent);</span>
<a href="#l22.208"></a><span id="l22.208" class="difflineminus">-</span>
<a href="#l22.209"></a><span id="l22.209" class="difflineminus">-  return err;</span>
<a href="#l22.210"></a><span id="l22.210" class="difflineplus">+  return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l22.211"></a><span id="l22.211"> }</span>
<a href="#l22.212"></a><span id="l22.212"> </span>
<a href="#l22.213"></a><span id="l22.213"> NS_IMETHODIMP nsAddrDatabase::EditMailList(nsIAbDirectory *mailList,</span>
<a href="#l22.214"></a><span id="l22.214">                                            nsIAbCard *listCard, bool notify) {</span>
<a href="#l22.215"></a><span id="l22.215" class="difflineminus">-  if (!mailList || !m_mdbPabTable || !m_mdbStore || !m_mdbEnv)</span>
<a href="#l22.216"></a><span id="l22.216" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l22.217"></a><span id="l22.217" class="difflineminus">-</span>
<a href="#l22.218"></a><span id="l22.218" class="difflineminus">-  nsresult err = NS_OK;</span>
<a href="#l22.219"></a><span id="l22.219" class="difflineminus">-</span>
<a href="#l22.220"></a><span id="l22.220" class="difflineminus">-  nsIMdbRow *pListRow = nullptr;</span>
<a href="#l22.221"></a><span id="l22.221" class="difflineminus">-  mdbOid rowOid;</span>
<a href="#l22.222"></a><span id="l22.222" class="difflineminus">-  rowOid.mOid_Scope = m_ListRowScopeToken;</span>
<a href="#l22.223"></a><span id="l22.223" class="difflineminus">-</span>
<a href="#l22.224"></a><span id="l22.224" class="difflineminus">-  nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbmailList(do_QueryInterface(mailList, &amp;err));</span>
<a href="#l22.225"></a><span id="l22.225" class="difflineminus">-  NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l22.226"></a><span id="l22.226" class="difflineminus">-  dbmailList-&gt;GetDbRowID((uint32_t *)&amp;rowOid.mOid_Id);</span>
<a href="#l22.227"></a><span id="l22.227" class="difflineminus">-</span>
<a href="#l22.228"></a><span id="l22.228" class="difflineminus">-  err = m_mdbStore-&gt;GetRow(m_mdbEnv, &amp;rowOid, &amp;pListRow);</span>
<a href="#l22.229"></a><span id="l22.229" class="difflineminus">-  NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l22.230"></a><span id="l22.230" class="difflineminus">-</span>
<a href="#l22.231"></a><span id="l22.231" class="difflineminus">-  if (!pListRow) return NS_OK;</span>
<a href="#l22.232"></a><span id="l22.232" class="difflineminus">-</span>
<a href="#l22.233"></a><span id="l22.233" class="difflineminus">-  err = AddListAttributeColumnsToRow(mailList, pListRow, mailList);</span>
<a href="#l22.234"></a><span id="l22.234" class="difflineminus">-  NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l22.235"></a><span id="l22.235" class="difflineminus">-</span>
<a href="#l22.236"></a><span id="l22.236" class="difflineminus">-  if (notify) {</span>
<a href="#l22.237"></a><span id="l22.237" class="difflineminus">-    NotifyListEntryChange(AB_NotifyPropertyChanged, mailList);</span>
<a href="#l22.238"></a><span id="l22.238" class="difflineminus">-</span>
<a href="#l22.239"></a><span id="l22.239" class="difflineminus">-    if (listCard) {</span>
<a href="#l22.240"></a><span id="l22.240" class="difflineminus">-      NotifyCardEntryChange(AB_NotifyPropertyChanged, listCard, mailList);</span>
<a href="#l22.241"></a><span id="l22.241" class="difflineminus">-    }</span>
<a href="#l22.242"></a><span id="l22.242" class="difflineminus">-</span>
<a href="#l22.243"></a><span id="l22.243" class="difflineminus">-    nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l22.244"></a><span id="l22.244" class="difflineminus">-        mozilla::services::GetObserverService();</span>
<a href="#l22.245"></a><span id="l22.245" class="difflineminus">-    if (observerService) {</span>
<a href="#l22.246"></a><span id="l22.246" class="difflineminus">-      observerService-&gt;NotifyObservers(mailList, &quot;addrbook-list-updated&quot;,</span>
<a href="#l22.247"></a><span id="l22.247" class="difflineminus">-                                       nullptr);</span>
<a href="#l22.248"></a><span id="l22.248" class="difflineminus">-    }</span>
<a href="#l22.249"></a><span id="l22.249" class="difflineminus">-  }</span>
<a href="#l22.250"></a><span id="l22.250" class="difflineminus">-</span>
<a href="#l22.251"></a><span id="l22.251" class="difflineminus">-  NS_RELEASE(pListRow);</span>
<a href="#l22.252"></a><span id="l22.252" class="difflineminus">-  return NS_OK;</span>
<a href="#l22.253"></a><span id="l22.253" class="difflineplus">+  return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l22.254"></a><span id="l22.254"> }</span>
<a href="#l22.255"></a><span id="l22.255"> </span>
<a href="#l22.256"></a><span id="l22.256"> NS_IMETHODIMP nsAddrDatabase::ContainsMailList(nsIAbDirectory *mailList,</span>
<a href="#l22.257"></a><span id="l22.257">                                                bool *hasList) {</span>
<a href="#l22.258"></a><span id="l22.258" class="difflineminus">-  if (!mailList || !m_mdbPabTable || !m_mdbEnv) return NS_ERROR_NULL_POINTER;</span>
<a href="#l22.259"></a><span id="l22.259" class="difflineminus">-</span>
<a href="#l22.260"></a><span id="l22.260" class="difflineminus">-  nsresult err = NS_OK;</span>
<a href="#l22.261"></a><span id="l22.261" class="difflineminus">-  mdb_bool hasOid;</span>
<a href="#l22.262"></a><span id="l22.262" class="difflineminus">-  mdbOid rowOid;</span>
<a href="#l22.263"></a><span id="l22.263" class="difflineminus">-</span>
<a href="#l22.264"></a><span id="l22.264" class="difflineminus">-  rowOid.mOid_Scope = m_ListRowScopeToken;</span>
<a href="#l22.265"></a><span id="l22.265" class="difflineminus">-</span>
<a href="#l22.266"></a><span id="l22.266" class="difflineminus">-  nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbmailList(do_QueryInterface(mailList, &amp;err));</span>
<a href="#l22.267"></a><span id="l22.267" class="difflineminus">-  NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l22.268"></a><span id="l22.268" class="difflineminus">-  dbmailList-&gt;GetDbRowID((uint32_t *)&amp;rowOid.mOid_Id);</span>
<a href="#l22.269"></a><span id="l22.269" class="difflineminus">-</span>
<a href="#l22.270"></a><span id="l22.270" class="difflineminus">-  err = m_mdbPabTable-&gt;HasOid(m_mdbEnv, &amp;rowOid, &amp;hasOid);</span>
<a href="#l22.271"></a><span id="l22.271" class="difflineminus">-  if (NS_SUCCEEDED(err)) *hasList = hasOid;</span>
<a href="#l22.272"></a><span id="l22.272" class="difflineminus">-</span>
<a href="#l22.273"></a><span id="l22.273" class="difflineminus">-  return (NS_SUCCEEDED(err)) ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l22.274"></a><span id="l22.274" class="difflineplus">+  return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l22.275"></a><span id="l22.275"> }</span>
<a href="#l22.276"></a><span id="l22.276"> </span>
<a href="#l22.277"></a><span id="l22.277"> NS_IMETHODIMP nsAddrDatabase::GetNewRow(nsIMdbRow **newRow) {</span>
<a href="#l22.278"></a><span id="l22.278">   if (!m_mdbStore || !newRow || !m_mdbEnv) return NS_ERROR_NULL_POINTER;</span>
<a href="#l22.279"></a><span id="l22.279"> </span>
<a href="#l22.280"></a><span id="l22.280">   return m_mdbStore-&gt;NewRow(m_mdbEnv, m_CardRowScopeToken, newRow);</span>
<a href="#l22.281"></a><span id="l22.281"> }</span>
<a href="#l22.282"></a><span id="l22.282"> </span>
<a href="#l22.283"></a><span id="l22.283" class="difflineat">@@ -2205,67 +2011,17 @@ nsresult nsAddrDatabase::GetListCardFrom</span>
<a href="#l22.284"></a><span id="l22.284">   uint32_t key = 0;</span>
<a href="#l22.285"></a><span id="l22.285">   err = GetIntColumn(listRow, m_RecordKeyColumnToken, &amp;key, 0);</span>
<a href="#l22.286"></a><span id="l22.286">   if (NS_SUCCEEDED(err)) listCard-&gt;SetPropertyAsUint32(kRecordKeyColumn, key);</span>
<a href="#l22.287"></a><span id="l22.287">   return err;</span>
<a href="#l22.288"></a><span id="l22.288"> }</span>
<a href="#l22.289"></a><span id="l22.289"> </span>
<a href="#l22.290"></a><span id="l22.290"> nsresult nsAddrDatabase::GetListFromDB(nsIAbDirectory *newList,</span>
<a href="#l22.291"></a><span id="l22.291">                                        nsIMdbRow *listRow) {</span>
<a href="#l22.292"></a><span id="l22.292" class="difflineminus">-  nsresult err = NS_OK;</span>
<a href="#l22.293"></a><span id="l22.293" class="difflineminus">-  if (!newList || !listRow || !m_mdbStore || !m_mdbEnv)</span>
<a href="#l22.294"></a><span id="l22.294" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l22.295"></a><span id="l22.295" class="difflineminus">-</span>
<a href="#l22.296"></a><span id="l22.296" class="difflineminus">-  nsAutoString tempString;</span>
<a href="#l22.297"></a><span id="l22.297" class="difflineminus">-</span>
<a href="#l22.298"></a><span id="l22.298" class="difflineminus">-  err = GetStringColumn(listRow, m_UIDColumnToken, tempString);</span>
<a href="#l22.299"></a><span id="l22.299" class="difflineminus">-  if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty()) {</span>
<a href="#l22.300"></a><span id="l22.300" class="difflineminus">-    newList-&gt;SetUID(NS_ConvertUTF16toUTF8(tempString));</span>
<a href="#l22.301"></a><span id="l22.301" class="difflineminus">-  }</span>
<a href="#l22.302"></a><span id="l22.302" class="difflineminus">-  err = GetStringColumn(listRow, m_ListNameColumnToken, tempString);</span>
<a href="#l22.303"></a><span id="l22.303" class="difflineminus">-  if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty()) {</span>
<a href="#l22.304"></a><span id="l22.304" class="difflineminus">-    newList-&gt;SetDirName(tempString);</span>
<a href="#l22.305"></a><span id="l22.305" class="difflineminus">-  }</span>
<a href="#l22.306"></a><span id="l22.306" class="difflineminus">-  err = GetStringColumn(listRow, m_ListNickNameColumnToken, tempString);</span>
<a href="#l22.307"></a><span id="l22.307" class="difflineminus">-  if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty()) {</span>
<a href="#l22.308"></a><span id="l22.308" class="difflineminus">-    newList-&gt;SetListNickName(tempString);</span>
<a href="#l22.309"></a><span id="l22.309" class="difflineminus">-  }</span>
<a href="#l22.310"></a><span id="l22.310" class="difflineminus">-  err = GetStringColumn(listRow, m_ListDescriptionColumnToken, tempString);</span>
<a href="#l22.311"></a><span id="l22.311" class="difflineminus">-  if (NS_SUCCEEDED(err) &amp;&amp; !tempString.IsEmpty()) {</span>
<a href="#l22.312"></a><span id="l22.312" class="difflineminus">-    newList-&gt;SetDescription(tempString);</span>
<a href="#l22.313"></a><span id="l22.313" class="difflineminus">-  }</span>
<a href="#l22.314"></a><span id="l22.314" class="difflineminus">-</span>
<a href="#l22.315"></a><span id="l22.315" class="difflineminus">-  nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbnewList(do_QueryInterface(newList, &amp;err));</span>
<a href="#l22.316"></a><span id="l22.316" class="difflineminus">-  NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l22.317"></a><span id="l22.317" class="difflineminus">-</span>
<a href="#l22.318"></a><span id="l22.318" class="difflineminus">-  uint32_t totalAddress = GetListAddressTotal(listRow);</span>
<a href="#l22.319"></a><span id="l22.319" class="difflineminus">-  uint32_t pos;</span>
<a href="#l22.320"></a><span id="l22.320" class="difflineminus">-  for (pos = 1; pos &lt;= totalAddress; ++pos) {</span>
<a href="#l22.321"></a><span id="l22.321" class="difflineminus">-    mdb_token listAddressColumnToken;</span>
<a href="#l22.322"></a><span id="l22.322" class="difflineminus">-    mdb_id rowID;</span>
<a href="#l22.323"></a><span id="l22.323" class="difflineminus">-</span>
<a href="#l22.324"></a><span id="l22.324" class="difflineminus">-    char columnStr[COLUMN_STR_MAX];</span>
<a href="#l22.325"></a><span id="l22.325" class="difflineminus">-    PR_snprintf(columnStr, COLUMN_STR_MAX, kMailListAddressFormat, pos);</span>
<a href="#l22.326"></a><span id="l22.326" class="difflineminus">-    m_mdbStore-&gt;StringToToken(m_mdbEnv, columnStr, &amp;listAddressColumnToken);</span>
<a href="#l22.327"></a><span id="l22.327" class="difflineminus">-</span>
<a href="#l22.328"></a><span id="l22.328" class="difflineminus">-    nsCOMPtr&lt;nsIMdbRow&gt; cardRow;</span>
<a href="#l22.329"></a><span id="l22.329" class="difflineminus">-    err = GetIntColumn(listRow, listAddressColumnToken, (uint32_t *)&amp;rowID, 0);</span>
<a href="#l22.330"></a><span id="l22.330" class="difflineminus">-    NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l22.331"></a><span id="l22.331" class="difflineminus">-    err = GetCardRowByRowID(rowID, getter_AddRefs(cardRow));</span>
<a href="#l22.332"></a><span id="l22.332" class="difflineminus">-    NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l22.333"></a><span id="l22.333" class="difflineminus">-</span>
<a href="#l22.334"></a><span id="l22.334" class="difflineminus">-    if (cardRow) {</span>
<a href="#l22.335"></a><span id="l22.335" class="difflineminus">-      nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l22.336"></a><span id="l22.336" class="difflineminus">-      err = CreateABCard(cardRow, 0, getter_AddRefs(card));</span>
<a href="#l22.337"></a><span id="l22.337" class="difflineminus">-</span>
<a href="#l22.338"></a><span id="l22.338" class="difflineminus">-      if (NS_SUCCEEDED(err)) dbnewList-&gt;AddAddressToList(card);</span>
<a href="#l22.339"></a><span id="l22.339" class="difflineminus">-    }</span>
<a href="#l22.340"></a><span id="l22.340" class="difflineminus">-  }</span>
<a href="#l22.341"></a><span id="l22.341" class="difflineminus">-</span>
<a href="#l22.342"></a><span id="l22.342" class="difflineminus">-  return err;</span>
<a href="#l22.343"></a><span id="l22.343" class="difflineplus">+  return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l22.344"></a><span id="l22.344"> }</span>
<a href="#l22.345"></a><span id="l22.345"> </span>
<a href="#l22.346"></a><span id="l22.346"> class nsAddrDBEnumerator : public nsSimpleEnumerator, public nsIAddrDBListener {</span>
<a href="#l22.347"></a><span id="l22.347">  public:</span>
<a href="#l22.348"></a><span id="l22.348">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l22.349"></a><span id="l22.349"> </span>
<a href="#l22.350"></a><span id="l22.350">   const nsID &amp;DefaultInterface() override { return NS_GET_IID(nsIAbCard); }</span>
<a href="#l22.351"></a><span id="l22.351"> </span>
<a href="#l22.352"></a><span id="l22.352" class="difflineat">@@ -2533,46 +2289,38 @@ NS_IMETHODIMP nsAddrDatabase::GetMailing</span>
<a href="#l22.353"></a><span id="l22.353">     } else</span>
<a href="#l22.354"></a><span id="l22.354">       done = true;</span>
<a href="#l22.355"></a><span id="l22.355">   }</span>
<a href="#l22.356"></a><span id="l22.356">   NS_IF_RELEASE(rowCursor);</span>
<a href="#l22.357"></a><span id="l22.357">   return NS_OK;</span>
<a href="#l22.358"></a><span id="l22.358"> }</span>
<a href="#l22.359"></a><span id="l22.359"> </span>
<a href="#l22.360"></a><span id="l22.360"> NS_IMETHODIMP nsAddrDatabase::EnumerateListAddresses(</span>
<a href="#l22.361"></a><span id="l22.361" class="difflineminus">-    nsIAbDirectory *directory, nsISimpleEnumerator **result) {</span>
<a href="#l22.362"></a><span id="l22.362" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l22.363"></a><span id="l22.363" class="difflineminus">-  mdb_id rowID;</span>
<a href="#l22.364"></a><span id="l22.364" class="difflineminus">-</span>
<a href="#l22.365"></a><span id="l22.365" class="difflineminus">-  nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbdirectory(do_QueryInterface(directory, &amp;rv));</span>
<a href="#l22.366"></a><span id="l22.366" class="difflineminus">-</span>
<a href="#l22.367"></a><span id="l22.367" class="difflineminus">-  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l22.368"></a><span id="l22.368" class="difflineminus">-    dbdirectory-&gt;GetDbRowID((uint32_t *)&amp;rowID);</span>
<a href="#l22.369"></a><span id="l22.369" class="difflineminus">-</span>
<a href="#l22.370"></a><span id="l22.370" class="difflineminus">-    NS_ADDREF(*result = new nsListAddressEnumerator(this, rowID));</span>
<a href="#l22.371"></a><span id="l22.371" class="difflineminus">-    m_dbDirectory = do_GetWeakReference(directory);</span>
<a href="#l22.372"></a><span id="l22.372" class="difflineminus">-  }</span>
<a href="#l22.373"></a><span id="l22.373" class="difflineminus">-  return rv;</span>
<a href="#l22.374"></a><span id="l22.374" class="difflineplus">+    nsIAbDirectory *directory, uint32_t listRowID,</span>
<a href="#l22.375"></a><span id="l22.375" class="difflineplus">+    nsISimpleEnumerator **result) {</span>
<a href="#l22.376"></a><span id="l22.376" class="difflineplus">+  NS_ADDREF(*result = new nsListAddressEnumerator(this, listRowID));</span>
<a href="#l22.377"></a><span id="l22.377" class="difflineplus">+  m_dbDirectory = do_GetWeakReference(directory);</span>
<a href="#l22.378"></a><span id="l22.378" class="difflineplus">+  return NS_OK;</span>
<a href="#l22.379"></a><span id="l22.379"> }</span>
<a href="#l22.380"></a><span id="l22.380"> </span>
<a href="#l22.381"></a><span id="l22.381"> nsresult nsAddrDatabase::CreateCardFromDeletedCardsTable(nsIMdbRow *cardRow,</span>
<a href="#l22.382"></a><span id="l22.382">                                                          mdb_id listRowID,</span>
<a href="#l22.383"></a><span id="l22.383">                                                          nsIAbCard **result) {</span>
<a href="#l22.384"></a><span id="l22.384">   if (!cardRow || !m_mdbEnv || !result) return NS_ERROR_NULL_POINTER;</span>
<a href="#l22.385"></a><span id="l22.385"> </span>
<a href="#l22.386"></a><span id="l22.386">   nsresult rv = NS_OK;</span>
<a href="#l22.387"></a><span id="l22.387"> </span>
<a href="#l22.388"></a><span id="l22.388">   mdbOid outOid;</span>
<a href="#l22.389"></a><span id="l22.389">   mdb_id rowID = 0;</span>
<a href="#l22.390"></a><span id="l22.390"> </span>
<a href="#l22.391"></a><span id="l22.391">   if (NS_SUCCEEDED(cardRow-&gt;GetOid(m_mdbEnv, &amp;outOid))) rowID = outOid.mOid_Id;</span>
<a href="#l22.392"></a><span id="l22.392"> </span>
<a href="#l22.393"></a><span id="l22.393">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l22.394"></a><span id="l22.394">     nsCOMPtr&lt;nsIAbCard&gt; personCard;</span>
<a href="#l22.395"></a><span id="l22.395" class="difflineminus">-    personCard = do_CreateInstance(NS_ABMDBCARD_CONTRACTID, &amp;rv);</span>
<a href="#l22.396"></a><span id="l22.396" class="difflineplus">+    personCard = do_CreateInstance(NS_ABCARDPROPERTY_CONTRACTID, &amp;rv);</span>
<a href="#l22.397"></a><span id="l22.397">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.398"></a><span id="l22.398"> </span>
<a href="#l22.399"></a><span id="l22.399">     InitCardFromRow(personCard, cardRow);</span>
<a href="#l22.400"></a><span id="l22.400">     personCard-&gt;SetPropertyAsUint32(kRowIDProperty, rowID);</span>
<a href="#l22.401"></a><span id="l22.401"> </span>
<a href="#l22.402"></a><span id="l22.402">     personCard.forget(result);</span>
<a href="#l22.403"></a><span id="l22.403">   }</span>
<a href="#l22.404"></a><span id="l22.404"> </span>
<a href="#l22.405"></a><span id="l22.405" class="difflineat">@@ -2587,17 +2335,17 @@ nsresult nsAddrDatabase::CreateCard(nsIM</span>
<a href="#l22.406"></a><span id="l22.406"> </span>
<a href="#l22.407"></a><span id="l22.407">   mdbOid outOid;</span>
<a href="#l22.408"></a><span id="l22.408">   mdb_id rowID = 0;</span>
<a href="#l22.409"></a><span id="l22.409"> </span>
<a href="#l22.410"></a><span id="l22.410">   if (NS_SUCCEEDED(cardRow-&gt;GetOid(m_mdbEnv, &amp;outOid))) rowID = outOid.mOid_Id;</span>
<a href="#l22.411"></a><span id="l22.411"> </span>
<a href="#l22.412"></a><span id="l22.412">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l22.413"></a><span id="l22.413">     nsCOMPtr&lt;nsIAbCard&gt; personCard;</span>
<a href="#l22.414"></a><span id="l22.414" class="difflineminus">-    personCard = do_CreateInstance(NS_ABMDBCARD_CONTRACTID, &amp;rv);</span>
<a href="#l22.415"></a><span id="l22.415" class="difflineplus">+    personCard = do_CreateInstance(NS_ABCARDPROPERTY_CONTRACTID, &amp;rv);</span>
<a href="#l22.416"></a><span id="l22.416">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.417"></a><span id="l22.417"> </span>
<a href="#l22.418"></a><span id="l22.418">     InitCardFromRow(personCard, cardRow);</span>
<a href="#l22.419"></a><span id="l22.419">     personCard-&gt;SetPropertyAsUint32(kRowIDProperty, rowID);</span>
<a href="#l22.420"></a><span id="l22.420"> </span>
<a href="#l22.421"></a><span id="l22.421">     nsAutoCString id;</span>
<a href="#l22.422"></a><span id="l22.422">     id.AppendInt(rowID);</span>
<a href="#l22.423"></a><span id="l22.423">     personCard-&gt;SetLocalId(id);</span>
<a href="#l22.424"></a><span id="l22.424" class="difflineat">@@ -2630,104 +2378,48 @@ nsresult nsAddrDatabase::CreateABListCar</span>
<a href="#l22.425"></a><span id="l22.425"> </span>
<a href="#l22.426"></a><span id="l22.426">   if (NS_SUCCEEDED(listRow-&gt;GetOid(m_mdbEnv, &amp;outOid))) rowID = outOid.mOid_Id;</span>
<a href="#l22.427"></a><span id="l22.427"> </span>
<a href="#l22.428"></a><span id="l22.428">   char *listURI = nullptr;</span>
<a href="#l22.429"></a><span id="l22.429"> </span>
<a href="#l22.430"></a><span id="l22.430">   nsAutoString fileName;</span>
<a href="#l22.431"></a><span id="l22.431">   rv = m_dbName-&gt;GetLeafName(fileName);</span>
<a href="#l22.432"></a><span id="l22.432">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.433"></a><span id="l22.433" class="difflineminus">-  listURI = PR_smprintf(&quot;%s%s/MailList%ld&quot;, kMDBDirectoryRoot,</span>
<a href="#l22.434"></a><span id="l22.434" class="difflineminus">-                        NS_ConvertUTF16toUTF8(fileName).get(), rowID);</span>
<a href="#l22.435"></a><span id="l22.435" class="difflineplus">+  listURI = PR_smprintf(&quot;MailList%ld&quot;, rowID);</span>
<a href="#l22.436"></a><span id="l22.436"> </span>
<a href="#l22.437"></a><span id="l22.437">   nsCOMPtr&lt;nsIAbCard&gt; personCard;</span>
<a href="#l22.438"></a><span id="l22.438" class="difflineminus">-  nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbm_dbDirectory(</span>
<a href="#l22.439"></a><span id="l22.439" class="difflineminus">-      do_QueryReferent(m_dbDirectory, &amp;rv));</span>
<a href="#l22.440"></a><span id="l22.440" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; dbm_dbDirectory) {</span>
<a href="#l22.441"></a><span id="l22.441" class="difflineminus">-    personCard = do_CreateInstance(NS_ABMDBCARD_CONTRACTID, &amp;rv);</span>
<a href="#l22.442"></a><span id="l22.442" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.443"></a><span id="l22.443" class="difflineminus">-</span>
<a href="#l22.444"></a><span id="l22.444" class="difflineminus">-    if (personCard) {</span>
<a href="#l22.445"></a><span id="l22.445" class="difflineminus">-      GetListCardFromDB(personCard, listRow);</span>
<a href="#l22.446"></a><span id="l22.446" class="difflineminus">-</span>
<a href="#l22.447"></a><span id="l22.447" class="difflineminus">-      personCard-&gt;SetPropertyAsUint32(kRowIDProperty, rowID);</span>
<a href="#l22.448"></a><span id="l22.448" class="difflineminus">-      personCard-&gt;SetIsMailList(true);</span>
<a href="#l22.449"></a><span id="l22.449" class="difflineminus">-      personCard-&gt;SetMailListURI(listURI);</span>
<a href="#l22.450"></a><span id="l22.450" class="difflineminus">-</span>
<a href="#l22.451"></a><span id="l22.451" class="difflineminus">-      nsAutoCString id;</span>
<a href="#l22.452"></a><span id="l22.452" class="difflineminus">-      id.AppendInt(rowID);</span>
<a href="#l22.453"></a><span id="l22.453" class="difflineminus">-      personCard-&gt;SetLocalId(id);</span>
<a href="#l22.454"></a><span id="l22.454" class="difflineminus">-</span>
<a href="#l22.455"></a><span id="l22.455" class="difflineminus">-      nsCOMPtr&lt;nsIAbDirectory&gt; abDir(do_QueryReferent(m_dbDirectory));</span>
<a href="#l22.456"></a><span id="l22.456" class="difflineminus">-      if (abDir) abDir-&gt;GetUuid(id);</span>
<a href="#l22.457"></a><span id="l22.457" class="difflineminus">-      personCard-&gt;SetDirectoryId(id);</span>
<a href="#l22.458"></a><span id="l22.458" class="difflineminus">-    }</span>
<a href="#l22.459"></a><span id="l22.459" class="difflineminus">-</span>
<a href="#l22.460"></a><span id="l22.460" class="difflineminus">-    personCard.forget(result);</span>
<a href="#l22.461"></a><span id="l22.461" class="difflineplus">+  personCard = do_CreateInstance(NS_ABCARDPROPERTY_CONTRACTID, &amp;rv);</span>
<a href="#l22.462"></a><span id="l22.462" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.463"></a><span id="l22.463" class="difflineplus">+</span>
<a href="#l22.464"></a><span id="l22.464" class="difflineplus">+  if (personCard) {</span>
<a href="#l22.465"></a><span id="l22.465" class="difflineplus">+    GetListCardFromDB(personCard, listRow);</span>
<a href="#l22.466"></a><span id="l22.466" class="difflineplus">+</span>
<a href="#l22.467"></a><span id="l22.467" class="difflineplus">+    personCard-&gt;SetPropertyAsUint32(kRowIDProperty, rowID);</span>
<a href="#l22.468"></a><span id="l22.468" class="difflineplus">+    personCard-&gt;SetIsMailList(true);</span>
<a href="#l22.469"></a><span id="l22.469" class="difflineplus">+    personCard-&gt;SetMailListURI(listURI);</span>
<a href="#l22.470"></a><span id="l22.470" class="difflineplus">+</span>
<a href="#l22.471"></a><span id="l22.471" class="difflineplus">+    nsAutoCString id;</span>
<a href="#l22.472"></a><span id="l22.472" class="difflineplus">+    id.AppendInt(rowID);</span>
<a href="#l22.473"></a><span id="l22.473" class="difflineplus">+    personCard-&gt;SetLocalId(id);</span>
<a href="#l22.474"></a><span id="l22.474" class="difflineplus">+</span>
<a href="#l22.475"></a><span id="l22.475" class="difflineplus">+    nsCOMPtr&lt;nsIAbDirectory&gt; abDir(do_QueryReferent(m_dbDirectory));</span>
<a href="#l22.476"></a><span id="l22.476" class="difflineplus">+    if (abDir) abDir-&gt;GetUuid(id);</span>
<a href="#l22.477"></a><span id="l22.477" class="difflineplus">+    personCard-&gt;SetDirectoryId(id);</span>
<a href="#l22.478"></a><span id="l22.478">   }</span>
<a href="#l22.479"></a><span id="l22.479" class="difflineplus">+</span>
<a href="#l22.480"></a><span id="l22.480" class="difflineplus">+  personCard.forget(result);</span>
<a href="#l22.481"></a><span id="l22.481">   if (listURI) PR_smprintf_free(listURI);</span>
<a href="#l22.482"></a><span id="l22.482"> </span>
<a href="#l22.483"></a><span id="l22.483">   return rv;</span>
<a href="#l22.484"></a><span id="l22.484"> }</span>
<a href="#l22.485"></a><span id="l22.485"> </span>
<a href="#l22.486"></a><span id="l22.486"> /* create a sub directory for mailing list in the address book left pane */</span>
<a href="#l22.487"></a><span id="l22.487"> nsresult nsAddrDatabase::CreateABList(nsIMdbRow *listRow,</span>
<a href="#l22.488"></a><span id="l22.488">                                       nsIAbDirectory **result) {</span>
<a href="#l22.489"></a><span id="l22.489" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l22.490"></a><span id="l22.490" class="difflineminus">-</span>
<a href="#l22.491"></a><span id="l22.491" class="difflineminus">-  if (!listRow || !m_mdbEnv || !result) return NS_ERROR_NULL_POINTER;</span>
<a href="#l22.492"></a><span id="l22.492" class="difflineminus">-</span>
<a href="#l22.493"></a><span id="l22.493" class="difflineminus">-  mdbOid outOid;</span>
<a href="#l22.494"></a><span id="l22.494" class="difflineminus">-  mdb_id rowID = 0;</span>
<a href="#l22.495"></a><span id="l22.495" class="difflineminus">-</span>
<a href="#l22.496"></a><span id="l22.496" class="difflineminus">-  if (NS_SUCCEEDED(listRow-&gt;GetOid(m_mdbEnv, &amp;outOid))) rowID = outOid.mOid_Id;</span>
<a href="#l22.497"></a><span id="l22.497" class="difflineminus">-</span>
<a href="#l22.498"></a><span id="l22.498" class="difflineminus">-  char *listURI = nullptr;</span>
<a href="#l22.499"></a><span id="l22.499" class="difflineminus">-</span>
<a href="#l22.500"></a><span id="l22.500" class="difflineminus">-  nsAutoString fileName;</span>
<a href="#l22.501"></a><span id="l22.501" class="difflineminus">-  m_dbName-&gt;GetLeafName(fileName);</span>
<a href="#l22.502"></a><span id="l22.502" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.503"></a><span id="l22.503" class="difflineminus">-</span>
<a href="#l22.504"></a><span id="l22.504" class="difflineminus">-  listURI = PR_smprintf(&quot;%s%s/MailList%ld&quot;, kMDBDirectoryRoot,</span>
<a href="#l22.505"></a><span id="l22.505" class="difflineminus">-                        NS_ConvertUTF16toUTF8(fileName).get(), rowID);</span>
<a href="#l22.506"></a><span id="l22.506" class="difflineminus">-</span>
<a href="#l22.507"></a><span id="l22.507" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; mailList;</span>
<a href="#l22.508"></a><span id="l22.508" class="difflineminus">-  nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbm_dbDirectory(</span>
<a href="#l22.509"></a><span id="l22.509" class="difflineminus">-      do_QueryReferent(m_dbDirectory, &amp;rv));</span>
<a href="#l22.510"></a><span id="l22.510" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; dbm_dbDirectory) {</span>
<a href="#l22.511"></a><span id="l22.511" class="difflineminus">-    rv = dbm_dbDirectory-&gt;AddDirectory(listURI, getter_AddRefs(mailList));</span>
<a href="#l22.512"></a><span id="l22.512" class="difflineminus">-</span>
<a href="#l22.513"></a><span id="l22.513" class="difflineminus">-    nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbmailList(do_QueryInterface(mailList, &amp;rv));</span>
<a href="#l22.514"></a><span id="l22.514" class="difflineminus">-</span>
<a href="#l22.515"></a><span id="l22.515" class="difflineminus">-    if (mailList) {</span>
<a href="#l22.516"></a><span id="l22.516" class="difflineminus">-      // if we are using turbo, and we &quot;exit&quot; and restart with the same profile</span>
<a href="#l22.517"></a><span id="l22.517" class="difflineminus">-      // the current mailing list will still be in memory, so when we do</span>
<a href="#l22.518"></a><span id="l22.518" class="difflineminus">-      // GetResource() and QI, we'll get it again.</span>
<a href="#l22.519"></a><span id="l22.519" class="difflineminus">-      // in that scenario, the mailList that we pass in will already be</span>
<a href="#l22.520"></a><span id="l22.520" class="difflineminus">-      // be a mailing list, with a valid row and all the entries</span>
<a href="#l22.521"></a><span id="l22.521" class="difflineminus">-      // in that scenario, we can skip GetListFromDB(), which would have</span>
<a href="#l22.522"></a><span id="l22.522" class="difflineminus">-      // have added all the cards to the list again.</span>
<a href="#l22.523"></a><span id="l22.523" class="difflineminus">-      // see bug #134743</span>
<a href="#l22.524"></a><span id="l22.524" class="difflineminus">-      mdb_id existingID;</span>
<a href="#l22.525"></a><span id="l22.525" class="difflineminus">-      dbmailList-&gt;GetDbRowID(&amp;existingID);</span>
<a href="#l22.526"></a><span id="l22.526" class="difflineminus">-      if (existingID != rowID) {</span>
<a href="#l22.527"></a><span id="l22.527" class="difflineminus">-        // Ensure IsMailList is set up first.</span>
<a href="#l22.528"></a><span id="l22.528" class="difflineminus">-        mailList-&gt;SetIsMailList(true);</span>
<a href="#l22.529"></a><span id="l22.529" class="difflineminus">-        GetListFromDB(mailList, listRow);</span>
<a href="#l22.530"></a><span id="l22.530" class="difflineminus">-        dbmailList-&gt;SetDbRowID(rowID);</span>
<a href="#l22.531"></a><span id="l22.531" class="difflineminus">-      }</span>
<a href="#l22.532"></a><span id="l22.532" class="difflineminus">-</span>
<a href="#l22.533"></a><span id="l22.533" class="difflineminus">-      dbm_dbDirectory-&gt;AddMailListToDirectory(mailList);</span>
<a href="#l22.534"></a><span id="l22.534" class="difflineminus">-      mailList.forget(result);</span>
<a href="#l22.535"></a><span id="l22.535" class="difflineminus">-    }</span>
<a href="#l22.536"></a><span id="l22.536" class="difflineminus">-  }</span>
<a href="#l22.537"></a><span id="l22.537" class="difflineminus">-</span>
<a href="#l22.538"></a><span id="l22.538" class="difflineminus">-  if (listURI) PR_smprintf_free(listURI);</span>
<a href="#l22.539"></a><span id="l22.539" class="difflineminus">-</span>
<a href="#l22.540"></a><span id="l22.540" class="difflineminus">-  return rv;</span>
<a href="#l22.541"></a><span id="l22.541" class="difflineplus">+  return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l22.542"></a><span id="l22.542"> }</span>
<a href="#l22.543"></a><span id="l22.543"> </span>
<a href="#l22.544"></a><span id="l22.544"> nsresult nsAddrDatabase::GetCardRowByRowID(mdb_id rowID, nsIMdbRow **dbRow) {</span>
<a href="#l22.545"></a><span id="l22.545">   if (!m_mdbStore || !m_mdbEnv) return NS_ERROR_NULL_POINTER;</span>
<a href="#l22.546"></a><span id="l22.546"> </span>
<a href="#l22.547"></a><span id="l22.547">   mdbOid rowOid;</span>
<a href="#l22.548"></a><span id="l22.548">   rowOid.mOid_Scope = m_CardRowScopeToken;</span>
<a href="#l22.549"></a><span id="l22.549">   rowOid.mOid_Id = rowID;</span>
<a href="#l22.550"></a><span id="l22.550" class="difflineat">@@ -2801,44 +2493,17 @@ NS_IMETHODIMP nsAddrDatabase::GetCardsFr</span>
<a href="#l22.551"></a><span id="l22.551">     } else</span>
<a href="#l22.552"></a><span id="l22.552">       done = true;</span>
<a href="#l22.553"></a><span id="l22.553">   } while (!done);</span>
<a href="#l22.554"></a><span id="l22.554"> </span>
<a href="#l22.555"></a><span id="l22.555">   return NS_NewArrayEnumerator(cards, list, NS_GET_IID(nsIAbCard));</span>
<a href="#l22.556"></a><span id="l22.556"> }</span>
<a href="#l22.557"></a><span id="l22.557"> </span>
<a href="#l22.558"></a><span id="l22.558"> NS_IMETHODIMP nsAddrDatabase::AddListDirNode(nsIMdbRow *listRow) {</span>
<a href="#l22.559"></a><span id="l22.559" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l22.560"></a><span id="l22.560" class="difflineminus">-</span>
<a href="#l22.561"></a><span id="l22.561" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l22.562"></a><span id="l22.562" class="difflineminus">-</span>
<a href="#l22.563"></a><span id="l22.563" class="difflineminus">-  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l22.564"></a><span id="l22.564" class="difflineminus">-    nsAutoString parentURI;</span>
<a href="#l22.565"></a><span id="l22.565" class="difflineminus">-    rv = m_dbName-&gt;GetLeafName(parentURI);</span>
<a href="#l22.566"></a><span id="l22.566" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.567"></a><span id="l22.567" class="difflineminus">-</span>
<a href="#l22.568"></a><span id="l22.568" class="difflineminus">-    parentURI.Replace(0, 0, NS_LITERAL_STRING(kMDBDirectoryRoot));</span>
<a href="#l22.569"></a><span id="l22.569" class="difflineminus">-</span>
<a href="#l22.570"></a><span id="l22.570" class="difflineminus">-    nsCOMPtr&lt;nsIAbDirectory&gt; parentDir;</span>
<a href="#l22.571"></a><span id="l22.571" class="difflineminus">-    rv = abManager-&gt;GetDirectory(NS_ConvertUTF16toUTF8(parentURI),</span>
<a href="#l22.572"></a><span id="l22.572" class="difflineminus">-                                 getter_AddRefs(parentDir));</span>
<a href="#l22.573"></a><span id="l22.573" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.574"></a><span id="l22.574" class="difflineminus">-</span>
<a href="#l22.575"></a><span id="l22.575" class="difflineminus">-    if (parentDir) {</span>
<a href="#l22.576"></a><span id="l22.576" class="difflineminus">-      m_dbDirectory = do_GetWeakReference(parentDir);</span>
<a href="#l22.577"></a><span id="l22.577" class="difflineminus">-      nsCOMPtr&lt;nsIAbDirectory&gt; mailList;</span>
<a href="#l22.578"></a><span id="l22.578" class="difflineminus">-      rv = CreateABList(listRow, getter_AddRefs(mailList));</span>
<a href="#l22.579"></a><span id="l22.579" class="difflineminus">-      if (mailList) {</span>
<a href="#l22.580"></a><span id="l22.580" class="difflineminus">-        nsCOMPtr&lt;nsIAbMDBDirectory&gt; dbparentDir(</span>
<a href="#l22.581"></a><span id="l22.581" class="difflineminus">-            do_QueryInterface(parentDir, &amp;rv));</span>
<a href="#l22.582"></a><span id="l22.582" class="difflineminus">-        if (NS_SUCCEEDED(rv)) dbparentDir-&gt;NotifyDirItemAdded(mailList);</span>
<a href="#l22.583"></a><span id="l22.583" class="difflineminus">-      }</span>
<a href="#l22.584"></a><span id="l22.584" class="difflineminus">-    }</span>
<a href="#l22.585"></a><span id="l22.585" class="difflineminus">-  }</span>
<a href="#l22.586"></a><span id="l22.586" class="difflineminus">-  return rv;</span>
<a href="#l22.587"></a><span id="l22.587" class="difflineplus">+  return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l22.588"></a><span id="l22.588"> }</span>
<a href="#l22.589"></a><span id="l22.589"> </span>
<a href="#l22.590"></a><span id="l22.590"> NS_IMETHODIMP nsAddrDatabase::FindMailListbyUnicodeName(</span>
<a href="#l22.591"></a><span id="l22.591">     const char16_t *listName, bool *exist) {</span>
<a href="#l22.592"></a><span id="l22.592">   nsAutoString unicodeString(listName);</span>
<a href="#l22.593"></a><span id="l22.593">   ToLowerCase(unicodeString);</span>
<a href="#l22.594"></a><span id="l22.594"> </span>
<a href="#l22.595"></a><span id="l22.595">   nsCOMPtr&lt;nsIMdbRow&gt; listRow;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAddrDatabase.h</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAddrDatabase.h</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -47,16 +47,17 @@ class nsAddrDatabase : public nsIAddrDat</span>
<a href="#l23.4"></a><span id="l23.4">                                          uint32_t listRowID, nsIAbCard *newCard,</span>
<a href="#l23.5"></a><span id="l23.5">                                          bool notify) override;</span>
<a href="#l23.6"></a><span id="l23.6">   NS_IMETHOD CreateMailListAndAddToDB(nsIAbDirectory *newList, bool notify,</span>
<a href="#l23.7"></a><span id="l23.7">                                       nsIAbDirectory *parent) override;</span>
<a href="#l23.8"></a><span id="l23.8">   NS_IMETHOD EnumerateCards(nsIAbDirectory *directory,</span>
<a href="#l23.9"></a><span id="l23.9">                             nsISimpleEnumerator **result) override;</span>
<a href="#l23.10"></a><span id="l23.10">   NS_IMETHOD GetMailingListsFromDB(nsIAbDirectory *parentDir) override;</span>
<a href="#l23.11"></a><span id="l23.11">   NS_IMETHOD EnumerateListAddresses(nsIAbDirectory *directory,</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+                                    uint32_t listRowID,</span>
<a href="#l23.13"></a><span id="l23.13">                                     nsISimpleEnumerator **result) override;</span>
<a href="#l23.14"></a><span id="l23.14">   NS_IMETHOD DeleteCard(nsIAbCard *newCard, bool notify,</span>
<a href="#l23.15"></a><span id="l23.15">                         nsIAbDirectory *parent) override;</span>
<a href="#l23.16"></a><span id="l23.16">   NS_IMETHOD EditCard(nsIAbCard *card, bool notify,</span>
<a href="#l23.17"></a><span id="l23.17">                       nsIAbDirectory *parent) override;</span>
<a href="#l23.18"></a><span id="l23.18">   NS_IMETHOD ContainsCard(nsIAbCard *card, bool *hasCard) override;</span>
<a href="#l23.19"></a><span id="l23.19">   NS_IMETHOD DeleteMailList(nsIAbDirectory *aMailList,</span>
<a href="#l23.20"></a><span id="l23.20">                             nsIAbDirectory *aParent) override;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/addrbook/src/nsDirPrefs.cpp</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsDirPrefs.cpp</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -13,17 +13,16 @@</span>
<a href="#l24.4"></a><span id="l24.4"> #include &quot;nsTArray.h&quot;</span>
<a href="#l24.5"></a><span id="l24.5"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l24.6"></a><span id="l24.6"> #include &quot;nsMemory.h&quot;</span>
<a href="#l24.7"></a><span id="l24.7"> #include &quot;nsIAddrDatabase.h&quot;</span>
<a href="#l24.8"></a><span id="l24.8"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l24.9"></a><span id="l24.9"> #include &quot;nsIAbManager.h&quot;</span>
<a href="#l24.10"></a><span id="l24.10"> #include &quot;nsIFile.h&quot;</span>
<a href="#l24.11"></a><span id="l24.11"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-#include &quot;nsIAbMDBDirectory.h&quot;</span>
<a href="#l24.13"></a><span id="l24.13"> #if defined(MOZ_LDAP_XPCOM)</span>
<a href="#l24.14"></a><span id="l24.14"> #  include &quot;nsIAbLDAPDirectory.h&quot;</span>
<a href="#l24.15"></a><span id="l24.15"> #endif</span>
<a href="#l24.16"></a><span id="l24.16"> #include &quot;prmem.h&quot;</span>
<a href="#l24.17"></a><span id="l24.17"> #include &quot;prprf.h&quot;</span>
<a href="#l24.18"></a><span id="l24.18"> #include &quot;plstr.h&quot;</span>
<a href="#l24.19"></a><span id="l24.19"> #include &quot;nsQuickSort.h&quot;</span>
<a href="#l24.20"></a><span id="l24.20"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineat">@@ -256,18 +255,16 @@ nsresult DIR_AddNewAddressBook(const nsA</span>
<a href="#l24.22"></a><span id="l24.22">   if (!dir_ServerList) DIR_GetDirServers();</span>
<a href="#l24.23"></a><span id="l24.23">   if (dir_ServerList) {</span>
<a href="#l24.24"></a><span id="l24.24">     server-&gt;description = ToNewCString(NS_ConvertUTF16toUTF8(dirName));</span>
<a href="#l24.25"></a><span id="l24.25">     server-&gt;position =</span>
<a href="#l24.26"></a><span id="l24.26">         kDefaultPosition;  // don't set position so alphabetic sort will happen.</span>
<a href="#l24.27"></a><span id="l24.27"> </span>
<a href="#l24.28"></a><span id="l24.28">     if (!fileName.IsEmpty())</span>
<a href="#l24.29"></a><span id="l24.29">       server-&gt;fileName = ToNewCString(fileName);</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineminus">-    else if (dirType == PABDirectory)</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineminus">-      DIR_SetFileName(&amp;server-&gt;fileName, kMDBAddressBook);</span>
<a href="#l24.32"></a><span id="l24.32">     else if (dirType == LDAPDirectory)</span>
<a href="#l24.33"></a><span id="l24.33">       DIR_SetFileName(&amp;server-&gt;fileName, kMainLdapAddressBook);</span>
<a href="#l24.34"></a><span id="l24.34">     else if (dirType == JSDirectory)</span>
<a href="#l24.35"></a><span id="l24.35">       DIR_SetFileName(&amp;server-&gt;fileName, kJSAddressBook);</span>
<a href="#l24.36"></a><span id="l24.36"> </span>
<a href="#l24.37"></a><span id="l24.37">     if (dirType != PABDirectory) {</span>
<a href="#l24.38"></a><span id="l24.38">       if (!uri.IsEmpty()) server-&gt;uri = ToNewCString(uri);</span>
<a href="#l24.39"></a><span id="l24.39">     }</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineat">@@ -932,19 +929,17 @@ void DIR_SetServerFileName(DIR_Server *s</span>
<a href="#l24.41"></a><span id="l24.41">           PR_Free(tempName);</span>
<a href="#l24.42"></a><span id="l24.42">         }</span>
<a href="#l24.43"></a><span id="l24.43">       }</span>
<a href="#l24.44"></a><span id="l24.44">     }</span>
<a href="#l24.45"></a><span id="l24.45"> </span>
<a href="#l24.46"></a><span id="l24.46">     if (!server-&gt;fileName || !*server-&gt;fileName) /* when all else has failed,</span>
<a href="#l24.47"></a><span id="l24.47">                                                     generate a default name */</span>
<a href="#l24.48"></a><span id="l24.48">     {</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineminus">-      if (server-&gt;dirType == PABDirectory) {</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineminus">-        DIR_SetFileName(&amp;(server-&gt;fileName), kMDBAddressBook);</span>
<a href="#l24.51"></a><span id="l24.51" class="difflineminus">-      } else if (server-&gt;dirType == LDAPDirectory) {</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineplus">+      if (server-&gt;dirType == LDAPDirectory) {</span>
<a href="#l24.53"></a><span id="l24.53">         DIR_SetFileName(</span>
<a href="#l24.54"></a><span id="l24.54">             &amp;(server-&gt;fileName),</span>
<a href="#l24.55"></a><span id="l24.55">             kMainLdapAddressBook); /* generates file name with an ldap prefix */</span>
<a href="#l24.56"></a><span id="l24.56">       } else {</span>
<a href="#l24.57"></a><span id="l24.57">         DIR_SetFileName(&amp;(server-&gt;fileName), kPersonalAddressbook);</span>
<a href="#l24.58"></a><span id="l24.58">       }</span>
<a href="#l24.59"></a><span id="l24.59">     }</span>
<a href="#l24.60"></a><span id="l24.60">   }</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineat">@@ -1034,18 +1029,16 @@ static void DIR_GetPrefsForOneServer(DIR</span>
<a href="#l24.62"></a><span id="l24.62">   if (!server-&gt;fileName || !*(server-&gt;fileName)) DIR_SetServerFileName(server);</span>
<a href="#l24.63"></a><span id="l24.63">   if (server-&gt;fileName &amp;&amp; *server-&gt;fileName) DIR_ConvertServerFileName(server);</span>
<a href="#l24.64"></a><span id="l24.64"> </span>
<a href="#l24.65"></a><span id="l24.65">   // the string &quot;s&quot; is the default uri ( &lt;scheme&gt; + &quot;://&quot; + &lt;filename&gt; )</span>
<a href="#l24.66"></a><span id="l24.66">   nsCString s;</span>
<a href="#l24.67"></a><span id="l24.67">   switch (server-&gt;dirType) {</span>
<a href="#l24.68"></a><span id="l24.68">     case PABDirectory:</span>
<a href="#l24.69"></a><span id="l24.69">     case MAPIDirectory:</span>
<a href="#l24.70"></a><span id="l24.70" class="difflineminus">-      s = kMDBDirectoryRoot;</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineminus">-      break;</span>
<a href="#l24.72"></a><span id="l24.72">     case JSDirectory:</span>
<a href="#l24.73"></a><span id="l24.73">       s = kJSDirectoryRoot;</span>
<a href="#l24.74"></a><span id="l24.74">       break;</span>
<a href="#l24.75"></a><span id="l24.75">     default:</span>
<a href="#l24.76"></a><span id="l24.76"> #if defined(MOZ_LDAP_XPCOM)</span>
<a href="#l24.77"></a><span id="l24.77">       s = kLDAPDirectoryRoot;</span>
<a href="#l24.78"></a><span id="l24.78"> #else</span>
<a href="#l24.79"></a><span id="l24.79">       // Fallback to the all directory root in the non-ldap enabled case.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/addrbook/src/nsDirPrefs.h</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsDirPrefs.h</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -14,17 +14,17 @@</span>
<a href="#l25.4"></a><span id="l25.4"> //</span>
<a href="#l25.5"></a><span id="l25.5"> </span>
<a href="#l25.6"></a><span id="l25.6"> #define kPreviousListVersion 2</span>
<a href="#l25.7"></a><span id="l25.7"> #define kCurrentListVersion 3</span>
<a href="#l25.8"></a><span id="l25.8"> #define PREF_LDAP_GLOBAL_TREE_NAME &quot;ldap_2&quot;</span>
<a href="#l25.9"></a><span id="l25.9"> #define PREF_LDAP_VERSION_NAME &quot;ldap_2.version&quot;</span>
<a href="#l25.10"></a><span id="l25.10"> #define PREF_LDAP_SERVER_TREE_NAME &quot;ldap_2.servers&quot;</span>
<a href="#l25.11"></a><span id="l25.11"> </span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-#define kMainLdapAddressBook &quot;ldap.mab&quot; /* v3 main ldap address book file */</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+#define kMainLdapAddressBook &quot;ldap.sqlite&quot;  // v3 main ldap address book file</span>
<a href="#l25.14"></a><span id="l25.14"> </span>
<a href="#l25.15"></a><span id="l25.15"> /* DIR_Server.dirType */</span>
<a href="#l25.16"></a><span id="l25.16"> typedef enum {</span>
<a href="#l25.17"></a><span id="l25.17">   LDAPDirectory,</span>
<a href="#l25.18"></a><span id="l25.18">   HTMLDirectory,</span>
<a href="#l25.19"></a><span id="l25.19">   PABDirectory,</span>
<a href="#l25.20"></a><span id="l25.20">   MAPIDirectory,</span>
<a href="#l25.21"></a><span id="l25.21">   JSDirectory = 101,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/addrbook/test/moz.build</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/addrbook/test/moz.build</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -1,13 +1,12 @@</span>
<a href="#l26.4"></a><span id="l26.4"> # vim: set filetype=python:</span>
<a href="#l26.5"></a><span id="l26.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l26.6"></a><span id="l26.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l26.7"></a><span id="l26.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l26.8"></a><span id="l26.8"> </span>
<a href="#l26.9"></a><span id="l26.9"> XPCSHELL_TESTS_MANIFESTS += [</span>
<a href="#l26.10"></a><span id="l26.10" class="difflineminus">-    'unit/xpcshell-jsaddrbook.ini',</span>
<a href="#l26.11"></a><span id="l26.11" class="difflineminus">-    'unit/xpcshell-mdbaddrbook.ini',</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineplus">+    'unit/xpcshell.ini',</span>
<a href="#l26.13"></a><span id="l26.13"> ]</span>
<a href="#l26.14"></a><span id="l26.14"> </span>
<a href="#l26.15"></a><span id="l26.15"> BROWSER_CHROME_MANIFESTS += [</span>
<a href="#l26.16"></a><span id="l26.16">     'browser/browser.ini',</span>
<a href="#l26.17"></a><span id="l26.17"> ]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1">rename from mailnews/addrbook/test/unit/head_jsaddrbook.js</span>
<a href="#l27.2"></a><span id="l27.2">rename to mailnews/addrbook/test/unit/head.js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1">deleted file mode 100644</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineminus">--- a/mailnews/addrbook/test/unit/head_addrbook.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineplus">+++ /dev/null</span>
<a href="#l28.4"></a><span id="l28.4" class="difflineat">@@ -1,66 +0,0 @@</span>
<a href="#l28.5"></a><span id="l28.5" class="difflineminus">-var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l28.6"></a><span id="l28.6" class="difflineminus">-var { MailServices } = ChromeUtils.import(</span>
<a href="#l28.7"></a><span id="l28.7" class="difflineminus">-  &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l28.8"></a><span id="l28.8" class="difflineminus">-);</span>
<a href="#l28.9"></a><span id="l28.9" class="difflineminus">-var { XPCOMUtils } = ChromeUtils.import(</span>
<a href="#l28.10"></a><span id="l28.10" class="difflineminus">-  &quot;resource://gre/modules/XPCOMUtils.jsm&quot;</span>
<a href="#l28.11"></a><span id="l28.11" class="difflineminus">-);</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-var CC = Components.Constructor;</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineminus">-</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineminus">-Services.prefs.setIntPref(&quot;ldap_2.servers.history.dirType&quot;, 2);</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineminus">-Services.prefs.setStringPref(&quot;ldap_2.servers.history.filename&quot;, &quot;history.mab&quot;);</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineminus">-Services.prefs.setIntPref(&quot;ldap_2.servers.pab.dirType&quot;, 2);</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineminus">-Services.prefs.setStringPref(&quot;ldap_2.servers.pab.filename&quot;, &quot;abook.mab&quot;);</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineminus">-Services.prefs.setStringPref(</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineminus">-  &quot;mail.collect_addressbook&quot;,</span>
<a href="#l28.21"></a><span id="l28.21" class="difflineminus">-  &quot;moz-abmdbdirectory://history.mab&quot;</span>
<a href="#l28.22"></a><span id="l28.22" class="difflineminus">-);</span>
<a href="#l28.23"></a><span id="l28.23" class="difflineminus">-Services.prefs.setStringPref(</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineminus">-  &quot;mail.server.default.whiteListAbURI&quot;,</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineminus">-  &quot;moz-abmdbdirectory://abook.mab&quot;</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineminus">-);</span>
<a href="#l28.27"></a><span id="l28.27" class="difflineminus">-</span>
<a href="#l28.28"></a><span id="l28.28" class="difflineminus">-// Ensure the profile directory is set up</span>
<a href="#l28.29"></a><span id="l28.29" class="difflineminus">-do_get_profile();</span>
<a href="#l28.30"></a><span id="l28.30" class="difflineminus">-</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineminus">-// Personal Address Book configuration items.</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineminus">-var kPABData = {</span>
<a href="#l28.33"></a><span id="l28.33" class="difflineminus">-  URI: &quot;moz-abmdbdirectory://abook.mab&quot;,</span>
<a href="#l28.34"></a><span id="l28.34" class="difflineminus">-  fileName: &quot;abook.mab&quot;,</span>
<a href="#l28.35"></a><span id="l28.35" class="difflineminus">-  dirName: &quot;Personal Address Book&quot;,</span>
<a href="#l28.36"></a><span id="l28.36" class="difflineminus">-  dirType: 2,</span>
<a href="#l28.37"></a><span id="l28.37" class="difflineminus">-  dirPrefID: &quot;ldap_2.servers.pab&quot;,</span>
<a href="#l28.38"></a><span id="l28.38" class="difflineminus">-  readOnly: false,</span>
<a href="#l28.39"></a><span id="l28.39" class="difflineminus">-  position: 1,</span>
<a href="#l28.40"></a><span id="l28.40" class="difflineminus">-};</span>
<a href="#l28.41"></a><span id="l28.41" class="difflineminus">-</span>
<a href="#l28.42"></a><span id="l28.42" class="difflineminus">-// Collected Address Book configuration items.</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineminus">-var kCABData = {</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineminus">-  URI: &quot;moz-abmdbdirectory://history.mab&quot;,</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineminus">-  fileName: &quot;history.mab&quot;,</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineminus">-  dirName: &quot;Collected Addresses&quot;,</span>
<a href="#l28.47"></a><span id="l28.47" class="difflineminus">-  dirType: 2,</span>
<a href="#l28.48"></a><span id="l28.48" class="difflineminus">-  dirPrefID: &quot;ldap_2.servers.history&quot;,</span>
<a href="#l28.49"></a><span id="l28.49" class="difflineminus">-  readOnly: false,</span>
<a href="#l28.50"></a><span id="l28.50" class="difflineminus">-  position: 2,</span>
<a href="#l28.51"></a><span id="l28.51" class="difflineminus">-};</span>
<a href="#l28.52"></a><span id="l28.52" class="difflineminus">-</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineminus">-// Windows (Outlook Express) Address Book deactivation. (Bug 448859)</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineminus">-Services.prefs.deleteBranch(&quot;ldap_2.servers.oe.&quot;);</span>
<a href="#l28.55"></a><span id="l28.55" class="difflineminus">-</span>
<a href="#l28.56"></a><span id="l28.56" class="difflineminus">-// OSX Address Book deactivation (Bug 955842)</span>
<a href="#l28.57"></a><span id="l28.57" class="difflineminus">-Services.prefs.deleteBranch(&quot;ldap_2.servers.osx.&quot;);</span>
<a href="#l28.58"></a><span id="l28.58" class="difflineminus">-</span>
<a href="#l28.59"></a><span id="l28.59" class="difflineminus">-// This currently applies to all address books of local type.</span>
<a href="#l28.60"></a><span id="l28.60" class="difflineminus">-var kNormalPropertiesURI =</span>
<a href="#l28.61"></a><span id="l28.61" class="difflineminus">-  &quot;chrome://messenger/content/addressbook/abAddressBookNameDialog.xhtml&quot;;</span>
<a href="#l28.62"></a><span id="l28.62" class="difflineminus">-</span>
<a href="#l28.63"></a><span id="l28.63" class="difflineminus">-function loadABFile(source, dest) {</span>
<a href="#l28.64"></a><span id="l28.64" class="difflineminus">-  let testAB = do_get_file(`${source}.mab`);</span>
<a href="#l28.65"></a><span id="l28.65" class="difflineminus">-  testAB.copyTo(do_get_profile(), dest);</span>
<a href="#l28.66"></a><span id="l28.66" class="difflineminus">-}</span>
<a href="#l28.67"></a><span id="l28.67" class="difflineminus">-</span>
<a href="#l28.68"></a><span id="l28.68" class="difflineminus">-registerCleanupFunction(function() {</span>
<a href="#l28.69"></a><span id="l28.69" class="difflineminus">-  load(&quot;../../../resources/mailShutdown.js&quot;);</span>
<a href="#l28.70"></a><span id="l28.70" class="difflineminus">-});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_db_enumerator.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_db_enumerator.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -11,17 +11,17 @@ var card_properties = {</span>
<a href="#l29.4"></a><span id="l29.4"> };</span>
<a href="#l29.5"></a><span id="l29.5"> var max_addressbooks = 10;</span>
<a href="#l29.6"></a><span id="l29.6"> </span>
<a href="#l29.7"></a><span id="l29.7"> function bug_537815_fixture_setup() {</span>
<a href="#l29.8"></a><span id="l29.8">   let i, key;</span>
<a href="#l29.9"></a><span id="l29.9"> </span>
<a href="#l29.10"></a><span id="l29.10">   for (i = 1; i &lt;= max_addressbooks; i++) {</span>
<a href="#l29.11"></a><span id="l29.11">     let ab_name = ab_prefix + i;</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-    MailServices.ab.newAddressBook(ab_name, &quot;&quot;, 2);</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+    MailServices.ab.newAddressBook(ab_name, &quot;&quot;, 101);</span>
<a href="#l29.14"></a><span id="l29.14">     dump(&quot;created: &quot; + ab_name + &quot;\n&quot;);</span>
<a href="#l29.15"></a><span id="l29.15"> </span>
<a href="#l29.16"></a><span id="l29.16">     for (var j = 1; j &lt; 2; j++) {</span>
<a href="#l29.17"></a><span id="l29.17">       let enm_dirs = MailServices.ab.directories;</span>
<a href="#l29.18"></a><span id="l29.18">       while (enm_dirs.hasMoreElements()) {</span>
<a href="#l29.19"></a><span id="l29.19">         let elem = enm_dirs.getNext().QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l29.20"></a><span id="l29.20">         let uri = elem.URI;</span>
<a href="#l29.21"></a><span id="l29.21">         let dir = MailServices.ab.getDirectory(uri);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_jsaddrbook.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_jsaddrbook.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -1,17 +1,17 @@</span>
<a href="#l30.4"></a><span id="l30.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l30.5"></a><span id="l30.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l30.6"></a><span id="l30.6">  * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l30.7"></a><span id="l30.7"> </span>
<a href="#l30.8"></a><span id="l30.8"> &quot;use strict&quot;;</span>
<a href="#l30.9"></a><span id="l30.9"> </span>
<a href="#l30.10"></a><span id="l30.10" class="difflineminus">-var DIR_TYPE = kPABData.dirType;</span>
<a href="#l30.11"></a><span id="l30.11" class="difflineminus">-var FILE_NAME = DIR_TYPE == 101 ? &quot;abook-1.sqlite&quot; : &quot;abook-1.mab&quot;;</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-var SCHEME = DIR_TYPE == 101 ? &quot;jsaddrbook&quot; : &quot;moz-abmdbdirectory&quot;;</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+var DIR_TYPE = 101;</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineplus">+var FILE_NAME = &quot;abook-1.sqlite&quot;;</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineplus">+var SCHEME = &quot;jsaddrbook&quot;;</span>
<a href="#l30.16"></a><span id="l30.16"> </span>
<a href="#l30.17"></a><span id="l30.17"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l30.18"></a><span id="l30.18">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l30.19"></a><span id="l30.19"> );</span>
<a href="#l30.20"></a><span id="l30.20"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l30.21"></a><span id="l30.21"> var { setTimeout } = ChromeUtils.import(&quot;resource://gre/modules/Timer.jsm&quot;);</span>
<a href="#l30.22"></a><span id="l30.22"> </span>
<a href="#l30.23"></a><span id="l30.23"> var book, contact, list, listCard;</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineat">@@ -354,35 +354,53 @@ add_task(async function deleteContact() </span>
<a href="#l30.25"></a><span id="l30.25">   observer.checkEvents([&quot;onItemRemoved&quot;, book, contact]);</span>
<a href="#l30.26"></a><span id="l30.26"> </span>
<a href="#l30.27"></a><span id="l30.27">   // Check enumerations.</span>
<a href="#l30.28"></a><span id="l30.28">   equal(Array.from(book.addressLists.enumerate()).length, 0);</span>
<a href="#l30.29"></a><span id="l30.29">   equal(Array.from(book.childNodes).length, 0);</span>
<a href="#l30.30"></a><span id="l30.30">   equal(Array.from(book.childCards).length, 0);</span>
<a href="#l30.31"></a><span id="l30.31"> });</span>
<a href="#l30.32"></a><span id="l30.32"> </span>
<a href="#l30.33"></a><span id="l30.33" class="difflineplus">+// Tests that the UID on a new contact can be set.</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineplus">+add_task(async function createContactWithUID() {</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineplus">+  let contactWithUID = Cc[</span>
<a href="#l30.36"></a><span id="l30.36" class="difflineplus">+    &quot;@mozilla.org/addressbook/cardproperty;1&quot;</span>
<a href="#l30.37"></a><span id="l30.37" class="difflineplus">+  ].createInstance(Ci.nsIAbCard);</span>
<a href="#l30.38"></a><span id="l30.38" class="difflineplus">+  contactWithUID.UID = &quot;I'm a UID!&quot;;</span>
<a href="#l30.39"></a><span id="l30.39" class="difflineplus">+  contactWithUID = book.addCard(contactWithUID);</span>
<a href="#l30.40"></a><span id="l30.40" class="difflineplus">+  equal(&quot;I'm a UID!&quot;, contactWithUID.UID, &quot;New contact has the UID we set&quot;);</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineplus">+</span>
<a href="#l30.42"></a><span id="l30.42" class="difflineplus">+  Assert.throws(() =&gt; {</span>
<a href="#l30.43"></a><span id="l30.43" class="difflineplus">+    // Set the UID after it already exists.</span>
<a href="#l30.44"></a><span id="l30.44" class="difflineplus">+    contactWithUID.UID = &quot;This should not be possible&quot;;</span>
<a href="#l30.45"></a><span id="l30.45" class="difflineplus">+  }, /NS_ERROR_FAILURE/);</span>
<a href="#l30.46"></a><span id="l30.46" class="difflineplus">+</span>
<a href="#l30.47"></a><span id="l30.47" class="difflineplus">+  // Setting the UID to it's existing value should not fail.</span>
<a href="#l30.48"></a><span id="l30.48" class="difflineplus">+  contactWithUID.UID = contactWithUID.UID; // eslint-disable-line no-self-assign</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineplus">+</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineplus">+  let cardArray = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l30.51"></a><span id="l30.51" class="difflineplus">+  cardArray.appendElement(contactWithUID);</span>
<a href="#l30.52"></a><span id="l30.52" class="difflineplus">+  book.deleteCards(cardArray);</span>
<a href="#l30.53"></a><span id="l30.53" class="difflineplus">+  observer.events.length = 0;</span>
<a href="#l30.54"></a><span id="l30.54" class="difflineplus">+});</span>
<a href="#l30.55"></a><span id="l30.55" class="difflineplus">+</span>
<a href="#l30.56"></a><span id="l30.56"> add_task(async function deleteAddressBook() {</span>
<a href="#l30.57"></a><span id="l30.57">   MailServices.ab.deleteAddressBook(book.URI);</span>
<a href="#l30.58"></a><span id="l30.58">   // Wait for files to close.</span>
<a href="#l30.59"></a><span id="l30.59">   // eslint-disable-next-line mozilla/no-arbitrary-setTimeout</span>
<a href="#l30.60"></a><span id="l30.60">   await new Promise(resolve =&gt; setTimeout(resolve, 2000));</span>
<a href="#l30.61"></a><span id="l30.61"> </span>
<a href="#l30.62"></a><span id="l30.62">   observer.checkEvents([&quot;onItemRemoved&quot;, undefined, book]);</span>
<a href="#l30.63"></a><span id="l30.63">   ok(!Services.prefs.prefHasUserValue(&quot;ldap_2.servers.newbook.dirType&quot;));</span>
<a href="#l30.64"></a><span id="l30.64">   ok(!Services.prefs.prefHasUserValue(&quot;ldap_2.servers.newbook.description&quot;));</span>
<a href="#l30.65"></a><span id="l30.65">   ok(!Services.prefs.prefHasUserValue(&quot;ldap_2.servers.newbook.filename&quot;));</span>
<a href="#l30.66"></a><span id="l30.66">   ok(!Services.prefs.prefHasUserValue(&quot;ldap_2.servers.newbook.uid&quot;));</span>
<a href="#l30.67"></a><span id="l30.67">   let dbFile = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l30.68"></a><span id="l30.68">   dbFile.append(FILE_NAME);</span>
<a href="#l30.69"></a><span id="l30.69">   ok(!dbFile.exists());</span>
<a href="#l30.70"></a><span id="l30.70">   equal([...MailServices.ab.directories].length, 2);</span>
<a href="#l30.71"></a><span id="l30.71" class="difflineminus">-  if (DIR_TYPE == 101) {</span>
<a href="#l30.72"></a><span id="l30.72" class="difflineminus">-    throws(</span>
<a href="#l30.73"></a><span id="l30.73" class="difflineminus">-      () =&gt; MailServices.ab.getDirectory(`${SCHEME}://${FILE_NAME}`),</span>
<a href="#l30.74"></a><span id="l30.74" class="difflineminus">-      /.*/</span>
<a href="#l30.75"></a><span id="l30.75" class="difflineminus">-    );</span>
<a href="#l30.76"></a><span id="l30.76" class="difflineminus">-  }</span>
<a href="#l30.77"></a><span id="l30.77" class="difflineplus">+  throws(() =&gt; MailServices.ab.getDirectory(`${SCHEME}://${FILE_NAME}`), /.*/);</span>
<a href="#l30.78"></a><span id="l30.78"> });</span>
<a href="#l30.79"></a><span id="l30.79"> </span>
<a href="#l30.80"></a><span id="l30.80"> add_task(async function cleanUp() {</span>
<a href="#l30.81"></a><span id="l30.81">   observer.checkEvents();</span>
<a href="#l30.82"></a><span id="l30.82">   observer.cleanUp();</span>
<a href="#l30.83"></a><span id="l30.83"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1">deleted file mode 100644</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_uid.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineplus">+++ /dev/null</span>
<a href="#l31.4"></a><span id="l31.4" class="difflineat">@@ -1,180 +0,0 @@</span>
<a href="#l31.5"></a><span id="l31.5" class="difflineminus">-/*</span>
<a href="#l31.6"></a><span id="l31.6" class="difflineminus">- * Test to check that pre-existing cards are given a UID,</span>
<a href="#l31.7"></a><span id="l31.7" class="difflineminus">- * and that the UID remains the same after a shutdown.</span>
<a href="#l31.8"></a><span id="l31.8" class="difflineminus">- */</span>
<a href="#l31.9"></a><span id="l31.9" class="difflineminus">-Cu.importGlobalProperties([&quot;fetch&quot;]);</span>
<a href="#l31.10"></a><span id="l31.10" class="difflineminus">-</span>
<a href="#l31.11"></a><span id="l31.11" class="difflineminus">-var profD = do_get_profile();</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineminus">-// Tests that directories have UIDs.</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineminus">-add_test(function directoryUID() {</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineminus">-  newAddressBookFile();</span>
<a href="#l31.16"></a><span id="l31.16" class="difflineminus">-</span>
<a href="#l31.17"></a><span id="l31.17" class="difflineminus">-  for (let book of MailServices.ab.directories) {</span>
<a href="#l31.18"></a><span id="l31.18" class="difflineminus">-    equal(36, book.UID.length, &quot;Existing directory has a UID&quot;);</span>
<a href="#l31.19"></a><span id="l31.19" class="difflineminus">-  }</span>
<a href="#l31.20"></a><span id="l31.20" class="difflineminus">-</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineminus">-  let dirName = MailServices.ab.newAddressBook(&quot;test&quot;, &quot;&quot;, kPABData.dirType);</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineminus">-  let directory = MailServices.ab.getDirectoryFromId(dirName);</span>
<a href="#l31.23"></a><span id="l31.23" class="difflineminus">-  equal(36, directory.UID.length, &quot;New directory has a UID&quot;);</span>
<a href="#l31.24"></a><span id="l31.24" class="difflineminus">-</span>
<a href="#l31.25"></a><span id="l31.25" class="difflineminus">-  run_next_test();</span>
<a href="#l31.26"></a><span id="l31.26" class="difflineminus">-});</span>
<a href="#l31.27"></a><span id="l31.27" class="difflineminus">-</span>
<a href="#l31.28"></a><span id="l31.28" class="difflineminus">-// Tests that an existing contact has a UID generated, and that that UID is</span>
<a href="#l31.29"></a><span id="l31.29" class="difflineminus">-// saved to the database so that the same UID is used next time.</span>
<a href="#l31.30"></a><span id="l31.30" class="difflineminus">-add_task(async function existingContactUID() {</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineminus">-  let book = newAddressBookFile();</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineminus">-</span>
<a href="#l31.33"></a><span id="l31.33" class="difflineminus">-  let card = [...book.childCards].find(c =&gt; !c.isMailList);</span>
<a href="#l31.34"></a><span id="l31.34" class="difflineminus">-  equal(36, card.UID.length, &quot;Existing contact has a UID&quot;);</span>
<a href="#l31.35"></a><span id="l31.35" class="difflineminus">-</span>
<a href="#l31.36"></a><span id="l31.36" class="difflineminus">-  let existingUID = card.UID;</span>
<a href="#l31.37"></a><span id="l31.37" class="difflineminus">-  card = [...book.childCards].find(c =&gt; !c.isMailList);</span>
<a href="#l31.38"></a><span id="l31.38" class="difflineminus">-  equal(existingUID, card.UID, &quot;New reference to contact has the same UID&quot;);</span>
<a href="#l31.39"></a><span id="l31.39" class="difflineminus">-</span>
<a href="#l31.40"></a><span id="l31.40" class="difflineminus">-  await checkFileForUID(card.UID, book.fileName);</span>
<a href="#l31.41"></a><span id="l31.41" class="difflineminus">-});</span>
<a href="#l31.42"></a><span id="l31.42" class="difflineminus">-</span>
<a href="#l31.43"></a><span id="l31.43" class="difflineminus">-// Tests that new contacts have UIDs.</span>
<a href="#l31.44"></a><span id="l31.44" class="difflineminus">-add_task(async function newContactUID() {</span>
<a href="#l31.45"></a><span id="l31.45" class="difflineminus">-  let book = newAddressBookFile();</span>
<a href="#l31.46"></a><span id="l31.46" class="difflineminus">-</span>
<a href="#l31.47"></a><span id="l31.47" class="difflineminus">-  let contact = Cc[&quot;@mozilla.org/addressbook/cardproperty;1&quot;].createInstance(</span>
<a href="#l31.48"></a><span id="l31.48" class="difflineminus">-    Ci.nsIAbCard</span>
<a href="#l31.49"></a><span id="l31.49" class="difflineminus">-  );</span>
<a href="#l31.50"></a><span id="l31.50" class="difflineminus">-  let newContact = book.addCard(contact);</span>
<a href="#l31.51"></a><span id="l31.51" class="difflineminus">-  equal(36, newContact.UID.length, &quot;New contact has a UID&quot;);</span>
<a href="#l31.52"></a><span id="l31.52" class="difflineminus">-</span>
<a href="#l31.53"></a><span id="l31.53" class="difflineminus">-  await checkFileForUID(newContact.UID, book.fileName);</span>
<a href="#l31.54"></a><span id="l31.54" class="difflineminus">-</span>
<a href="#l31.55"></a><span id="l31.55" class="difflineminus">-  Assert.throws(() =&gt; {</span>
<a href="#l31.56"></a><span id="l31.56" class="difflineminus">-    // Set the UID after it already exists.</span>
<a href="#l31.57"></a><span id="l31.57" class="difflineminus">-    newContact.UID = &quot;This should not be possible&quot;;</span>
<a href="#l31.58"></a><span id="l31.58" class="difflineminus">-  }, /NS_ERROR_FAILURE/);</span>
<a href="#l31.59"></a><span id="l31.59" class="difflineminus">-</span>
<a href="#l31.60"></a><span id="l31.60" class="difflineminus">-  // Setting the UID to it's existing value should not fail.</span>
<a href="#l31.61"></a><span id="l31.61" class="difflineminus">-  newContact.UID = newContact.UID; // eslint-disable-line no-self-assign</span>
<a href="#l31.62"></a><span id="l31.62" class="difflineminus">-});</span>
<a href="#l31.63"></a><span id="l31.63" class="difflineminus">-</span>
<a href="#l31.64"></a><span id="l31.64" class="difflineminus">-// Tests that the UID on a new contact can be set.</span>
<a href="#l31.65"></a><span id="l31.65" class="difflineminus">-add_task(async function newContactWithUID() {</span>
<a href="#l31.66"></a><span id="l31.66" class="difflineminus">-  let book = newAddressBookFile();</span>
<a href="#l31.67"></a><span id="l31.67" class="difflineminus">-</span>
<a href="#l31.68"></a><span id="l31.68" class="difflineminus">-  let contact = Cc[&quot;@mozilla.org/addressbook/cardproperty;1&quot;].createInstance(</span>
<a href="#l31.69"></a><span id="l31.69" class="difflineminus">-    Ci.nsIAbCard</span>
<a href="#l31.70"></a><span id="l31.70" class="difflineminus">-  );</span>
<a href="#l31.71"></a><span id="l31.71" class="difflineminus">-  contact.UID = &quot;I'm a UID!&quot;;</span>
<a href="#l31.72"></a><span id="l31.72" class="difflineminus">-  let newContact = book.addCard(contact);</span>
<a href="#l31.73"></a><span id="l31.73" class="difflineminus">-  equal(&quot;I'm a UID!&quot;, newContact.UID, &quot;New contact has the UID we set&quot;);</span>
<a href="#l31.74"></a><span id="l31.74" class="difflineminus">-</span>
<a href="#l31.75"></a><span id="l31.75" class="difflineminus">-  await checkFileForUID(newContact.UID, book.fileName);</span>
<a href="#l31.76"></a><span id="l31.76" class="difflineminus">-</span>
<a href="#l31.77"></a><span id="l31.77" class="difflineminus">-  Assert.throws(() =&gt; {</span>
<a href="#l31.78"></a><span id="l31.78" class="difflineminus">-    // Set the UID after it already exists.</span>
<a href="#l31.79"></a><span id="l31.79" class="difflineminus">-    newContact.UID = &quot;This should not be possible&quot;;</span>
<a href="#l31.80"></a><span id="l31.80" class="difflineminus">-  }, /NS_ERROR_FAILURE/);</span>
<a href="#l31.81"></a><span id="l31.81" class="difflineminus">-</span>
<a href="#l31.82"></a><span id="l31.82" class="difflineminus">-  // Setting the UID to it's existing value should not fail.</span>
<a href="#l31.83"></a><span id="l31.83" class="difflineminus">-  newContact.UID = newContact.UID; // eslint-disable-line no-self-assign</span>
<a href="#l31.84"></a><span id="l31.84" class="difflineminus">-});</span>
<a href="#l31.85"></a><span id="l31.85" class="difflineminus">-</span>
<a href="#l31.86"></a><span id="l31.86" class="difflineminus">-// Tests that existing lists have UIDs. Reference the nsIAbCard first.</span>
<a href="#l31.87"></a><span id="l31.87" class="difflineminus">-add_task(async function existingListUID1() {</span>
<a href="#l31.88"></a><span id="l31.88" class="difflineminus">-  let book = newAddressBookFile();</span>
<a href="#l31.89"></a><span id="l31.89" class="difflineminus">-</span>
<a href="#l31.90"></a><span id="l31.90" class="difflineminus">-  let card = [...book.childCards].find(c =&gt; c.isMailList);</span>
<a href="#l31.91"></a><span id="l31.91" class="difflineminus">-  equal(36, card.UID.length, &quot;Existing list's card has a UID&quot;);</span>
<a href="#l31.92"></a><span id="l31.92" class="difflineminus">-</span>
<a href="#l31.93"></a><span id="l31.93" class="difflineminus">-  let directory = MailServices.ab.getDirectory(card.mailListURI);</span>
<a href="#l31.94"></a><span id="l31.94" class="difflineminus">-  equal(36, directory.UID.length, &quot;Existing list's directory has a UID&quot;);</span>
<a href="#l31.95"></a><span id="l31.95" class="difflineminus">-</span>
<a href="#l31.96"></a><span id="l31.96" class="difflineminus">-  equal(</span>
<a href="#l31.97"></a><span id="l31.97" class="difflineminus">-    card.UID,</span>
<a href="#l31.98"></a><span id="l31.98" class="difflineminus">-    directory.UID,</span>
<a href="#l31.99"></a><span id="l31.99" class="difflineminus">-    &quot;Existing list's card and directory UIDs match&quot;</span>
<a href="#l31.100"></a><span id="l31.100" class="difflineminus">-  );</span>
<a href="#l31.101"></a><span id="l31.101" class="difflineminus">-</span>
<a href="#l31.102"></a><span id="l31.102" class="difflineminus">-  await checkFileForUID(card.UID, book.fileName);</span>
<a href="#l31.103"></a><span id="l31.103" class="difflineminus">-});</span>
<a href="#l31.104"></a><span id="l31.104" class="difflineminus">-</span>
<a href="#l31.105"></a><span id="l31.105" class="difflineminus">-// Tests that existing lists have UIDs. Reference the nsIAbDirectory first.</span>
<a href="#l31.106"></a><span id="l31.106" class="difflineminus">-add_task(async function existingListUID2() {</span>
<a href="#l31.107"></a><span id="l31.107" class="difflineminus">-  let book = newAddressBookFile();</span>
<a href="#l31.108"></a><span id="l31.108" class="difflineminus">-</span>
<a href="#l31.109"></a><span id="l31.109" class="difflineminus">-  let directory = MailServices.ab.getDirectory(`${book.URI}/MailList1`);</span>
<a href="#l31.110"></a><span id="l31.110" class="difflineminus">-  equal(36, directory.UID.length, &quot;Existing list's directory has a UID&quot;);</span>
<a href="#l31.111"></a><span id="l31.111" class="difflineminus">-</span>
<a href="#l31.112"></a><span id="l31.112" class="difflineminus">-  let card = [...book.childCards].find(c =&gt; c.isMailList);</span>
<a href="#l31.113"></a><span id="l31.113" class="difflineminus">-  equal(36, card.UID.length, &quot;Existing list's card has a UID&quot;);</span>
<a href="#l31.114"></a><span id="l31.114" class="difflineminus">-</span>
<a href="#l31.115"></a><span id="l31.115" class="difflineminus">-  equal(</span>
<a href="#l31.116"></a><span id="l31.116" class="difflineminus">-    card.UID,</span>
<a href="#l31.117"></a><span id="l31.117" class="difflineminus">-    directory.UID,</span>
<a href="#l31.118"></a><span id="l31.118" class="difflineminus">-    &quot;Existing list's card and directory UIDs match&quot;</span>
<a href="#l31.119"></a><span id="l31.119" class="difflineminus">-  );</span>
<a href="#l31.120"></a><span id="l31.120" class="difflineminus">-</span>
<a href="#l31.121"></a><span id="l31.121" class="difflineminus">-  await checkFileForUID(card.UID, book.fileName);</span>
<a href="#l31.122"></a><span id="l31.122" class="difflineminus">-});</span>
<a href="#l31.123"></a><span id="l31.123" class="difflineminus">-</span>
<a href="#l31.124"></a><span id="l31.124" class="difflineminus">-// Tests that new lists have UIDs.</span>
<a href="#l31.125"></a><span id="l31.125" class="difflineminus">-add_task(async function newListUID() {</span>
<a href="#l31.126"></a><span id="l31.126" class="difflineminus">-  let book = newAddressBookFile();</span>
<a href="#l31.127"></a><span id="l31.127" class="difflineminus">-</span>
<a href="#l31.128"></a><span id="l31.128" class="difflineminus">-  let list = Cc[&quot;@mozilla.org/addressbook/directoryproperty;1&quot;].createInstance(</span>
<a href="#l31.129"></a><span id="l31.129" class="difflineminus">-    Ci.nsIAbDirectory</span>
<a href="#l31.130"></a><span id="l31.130" class="difflineminus">-  );</span>
<a href="#l31.131"></a><span id="l31.131" class="difflineminus">-  list = book.addMailList(list);</span>
<a href="#l31.132"></a><span id="l31.132" class="difflineminus">-</span>
<a href="#l31.133"></a><span id="l31.133" class="difflineminus">-  equal(36, list.UID.length, &quot;New list's directory has a UID&quot;);</span>
<a href="#l31.134"></a><span id="l31.134" class="difflineminus">-  equal(</span>
<a href="#l31.135"></a><span id="l31.135" class="difflineminus">-    list.UID,</span>
<a href="#l31.136"></a><span id="l31.136" class="difflineminus">-    MailServices.ab.getDirectory(list.URI).UID,</span>
<a href="#l31.137"></a><span id="l31.137" class="difflineminus">-    &quot;New reference to list's directory has the same UID&quot;</span>
<a href="#l31.138"></a><span id="l31.138" class="difflineminus">-  );</span>
<a href="#l31.139"></a><span id="l31.139" class="difflineminus">-</span>
<a href="#l31.140"></a><span id="l31.140" class="difflineminus">-  let bookCards = [...book.childNodes];</span>
<a href="#l31.141"></a><span id="l31.141" class="difflineminus">-  ok(</span>
<a href="#l31.142"></a><span id="l31.142" class="difflineminus">-    !!bookCards.find(</span>
<a href="#l31.143"></a><span id="l31.143" class="difflineminus">-      c =&gt; c.UID == list.UID,</span>
<a href="#l31.144"></a><span id="l31.144" class="difflineminus">-      &quot;New reference to list has the same UID&quot;</span>
<a href="#l31.145"></a><span id="l31.145" class="difflineminus">-    )</span>
<a href="#l31.146"></a><span id="l31.146" class="difflineminus">-  );</span>
<a href="#l31.147"></a><span id="l31.147" class="difflineminus">-</span>
<a href="#l31.148"></a><span id="l31.148" class="difflineminus">-  await checkFileForUID(list.UID, book.fileName);</span>
<a href="#l31.149"></a><span id="l31.149" class="difflineminus">-});</span>
<a href="#l31.150"></a><span id="l31.150" class="difflineminus">-</span>
<a href="#l31.151"></a><span id="l31.151" class="difflineminus">-// 3 seems to be the lowest number that works here. I don't know why.</span>
<a href="#l31.152"></a><span id="l31.152" class="difflineminus">-var count = 3;</span>
<a href="#l31.153"></a><span id="l31.153" class="difflineminus">-function newAddressBookFile() {</span>
<a href="#l31.154"></a><span id="l31.154" class="difflineminus">-  MailServices.ab.newAddressBook(</span>
<a href="#l31.155"></a><span id="l31.155" class="difflineminus">-    `book${count}`,</span>
<a href="#l31.156"></a><span id="l31.156" class="difflineminus">-    `moz-abmdbdirectory://abook-${count}.mab`,</span>
<a href="#l31.157"></a><span id="l31.157" class="difflineminus">-    2</span>
<a href="#l31.158"></a><span id="l31.158" class="difflineminus">-  );</span>
<a href="#l31.159"></a><span id="l31.159" class="difflineminus">-</span>
<a href="#l31.160"></a><span id="l31.160" class="difflineminus">-  let testAB = do_get_file(&quot;data/existing.mab&quot;);</span>
<a href="#l31.161"></a><span id="l31.161" class="difflineminus">-  testAB.copyTo(profD, `abook-${count}.mab`);</span>
<a href="#l31.162"></a><span id="l31.162" class="difflineminus">-</span>
<a href="#l31.163"></a><span id="l31.163" class="difflineminus">-  Services.prefs.setCharPref(</span>
<a href="#l31.164"></a><span id="l31.164" class="difflineminus">-    `ldap_2.servers.book${count}.filename`,</span>
<a href="#l31.165"></a><span id="l31.165" class="difflineminus">-    `abook-${count}.mab`</span>
<a href="#l31.166"></a><span id="l31.166" class="difflineminus">-  );</span>
<a href="#l31.167"></a><span id="l31.167" class="difflineminus">-</span>
<a href="#l31.168"></a><span id="l31.168" class="difflineminus">-  let book = MailServices.ab.getDirectory(</span>
<a href="#l31.169"></a><span id="l31.169" class="difflineminus">-    `moz-abmdbdirectory://abook-${count}.mab`</span>
<a href="#l31.170"></a><span id="l31.170" class="difflineminus">-  );</span>
<a href="#l31.171"></a><span id="l31.171" class="difflineminus">-  equal(2, [...book.childCards].length);</span>
<a href="#l31.172"></a><span id="l31.172" class="difflineminus">-</span>
<a href="#l31.173"></a><span id="l31.173" class="difflineminus">-  count++;</span>
<a href="#l31.174"></a><span id="l31.174" class="difflineminus">-  return book;</span>
<a href="#l31.175"></a><span id="l31.175" class="difflineminus">-}</span>
<a href="#l31.176"></a><span id="l31.176" class="difflineminus">-</span>
<a href="#l31.177"></a><span id="l31.177" class="difflineminus">-async function checkFileForUID(needle, bookFileName) {</span>
<a href="#l31.178"></a><span id="l31.178" class="difflineminus">-  let abFile = profD.clone();</span>
<a href="#l31.179"></a><span id="l31.179" class="difflineminus">-  abFile.append(bookFileName);</span>
<a href="#l31.180"></a><span id="l31.180" class="difflineminus">-  let response = await fetch(Services.io.newFileURI(abFile).spec);</span>
<a href="#l31.181"></a><span id="l31.181" class="difflineminus">-  let text = await response.text();</span>
<a href="#l31.182"></a><span id="l31.182" class="difflineminus">-</span>
<a href="#l31.183"></a><span id="l31.183" class="difflineminus">-  ok(text.includes(needle), &quot;UID has been saved to file&quot;);</span>
<a href="#l31.184"></a><span id="l31.184" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1">deleted file mode 100644</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_uuid.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineplus">+++ /dev/null</span>
<a href="#l32.4"></a><span id="l32.4" class="difflineat">@@ -1,123 +0,0 @@</span>
<a href="#l32.5"></a><span id="l32.5" class="difflineminus">-/* This file is testing that the UUID semantics of cards and directories match</span>
<a href="#l32.6"></a><span id="l32.6" class="difflineminus">- * the guarantees of their documented requirements.</span>
<a href="#l32.7"></a><span id="l32.7" class="difflineminus">- */</span>
<a href="#l32.8"></a><span id="l32.8" class="difflineminus">-</span>
<a href="#l32.9"></a><span id="l32.9" class="difflineminus">-/**</span>
<a href="#l32.10"></a><span id="l32.10" class="difflineminus">- * Checks that the directory follows the contract for UUIDs.</span>
<a href="#l32.11"></a><span id="l32.11" class="difflineminus">- *</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">- * If the directory is modifiable, it will be modified, although the net effect</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">- * will not change the state if the code works properly.</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineminus">- */</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineminus">-function check_directory(directory) {</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineminus">-  var prefId = directory.dirPrefId + &quot;&amp;&quot; + directory.dirName;</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineminus">-</span>
<a href="#l32.18"></a><span id="l32.18" class="difflineminus">-  var testModification = !directory.readOnly;</span>
<a href="#l32.19"></a><span id="l32.19" class="difflineminus">-  dump(&quot;Testing &quot; + prefId);</span>
<a href="#l32.20"></a><span id="l32.20" class="difflineminus">-  if (testModification) {</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineminus">-    dump(&quot; (with modifications)&quot;);</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineminus">-  }</span>
<a href="#l32.23"></a><span id="l32.23" class="difflineminus">-  dump(&quot;...\n&quot;);</span>
<a href="#l32.24"></a><span id="l32.24" class="difflineminus">-</span>
<a href="#l32.25"></a><span id="l32.25" class="difflineminus">-  // Question 1: Is the UUID the preference ID?</span>
<a href="#l32.26"></a><span id="l32.26" class="difflineminus">-  Assert.equal(prefId, directory.uuid);</span>
<a href="#l32.27"></a><span id="l32.27" class="difflineminus">-</span>
<a href="#l32.28"></a><span id="l32.28" class="difflineminus">-  // Now we need to run through the cards, checking that each card meets the</span>
<a href="#l32.29"></a><span id="l32.29" class="difflineminus">-  // requirements.</span>
<a href="#l32.30"></a><span id="l32.30" class="difflineminus">-  var seenIds = [],</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineminus">-    cards = [];</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineminus">-  var enumerator = directory.childCards;</span>
<a href="#l32.33"></a><span id="l32.33" class="difflineminus">-  while (enumerator.hasMoreElements()) {</span>
<a href="#l32.34"></a><span id="l32.34" class="difflineminus">-    let card = enumerator.getNext().QueryInterface(Ci.nsIAbCard);</span>
<a href="#l32.35"></a><span id="l32.35" class="difflineminus">-    cards.push(card);</span>
<a href="#l32.36"></a><span id="l32.36" class="difflineminus">-</span>
<a href="#l32.37"></a><span id="l32.37" class="difflineminus">-    // Question 2.1: Is the directory ID correct?</span>
<a href="#l32.38"></a><span id="l32.38" class="difflineminus">-    Assert.equal(prefId, card.directoryId);</span>
<a href="#l32.39"></a><span id="l32.39" class="difflineminus">-</span>
<a href="#l32.40"></a><span id="l32.40" class="difflineminus">-    // Question 2.2: Is the local ID unique and valid?</span>
<a href="#l32.41"></a><span id="l32.41" class="difflineminus">-    Assert.notEqual(card.localId, &quot;&quot;);</span>
<a href="#l32.42"></a><span id="l32.42" class="difflineminus">-    Assert.equal(seenIds.indexOf(card.localId), -1);</span>
<a href="#l32.43"></a><span id="l32.43" class="difflineminus">-    seenIds.push(card.localId);</span>
<a href="#l32.44"></a><span id="l32.44" class="difflineminus">-</span>
<a href="#l32.45"></a><span id="l32.45" class="difflineminus">-    // Question 2.3: Is the format equal to generateUUID?</span>
<a href="#l32.46"></a><span id="l32.46" class="difflineminus">-    Assert.equal(card.uuid, MailServices.ab.generateUUID(prefId, card.localId));</span>
<a href="#l32.47"></a><span id="l32.47" class="difflineminus">-  }</span>
<a href="#l32.48"></a><span id="l32.48" class="difflineminus">-</span>
<a href="#l32.49"></a><span id="l32.49" class="difflineminus">-  // Question 3: Do cards returned via searches return UUIDs correctly?</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineminus">-  var uri = directory.URI;</span>
<a href="#l32.51"></a><span id="l32.51" class="difflineminus">-  uri += &quot;?(or(DisplayName,=,a)(DisplayName,!=,a))&quot;;</span>
<a href="#l32.52"></a><span id="l32.52" class="difflineminus">-  let search = MailServices.ab.getDirectory(uri);</span>
<a href="#l32.53"></a><span id="l32.53" class="difflineminus">-</span>
<a href="#l32.54"></a><span id="l32.54" class="difflineminus">-  enumerator = search.childCards;</span>
<a href="#l32.55"></a><span id="l32.55" class="difflineminus">-  while (enumerator.hasMoreElements()) {</span>
<a href="#l32.56"></a><span id="l32.56" class="difflineminus">-    let card = enumerator.getNext().QueryInterface(Ci.nsIAbCard);</span>
<a href="#l32.57"></a><span id="l32.57" class="difflineminus">-</span>
<a href="#l32.58"></a><span id="l32.58" class="difflineminus">-    // Question 3.1: Is the directory ID correct?</span>
<a href="#l32.59"></a><span id="l32.59" class="difflineminus">-    Assert.equal(prefId, card.directoryId);</span>
<a href="#l32.60"></a><span id="l32.60" class="difflineminus">-</span>
<a href="#l32.61"></a><span id="l32.61" class="difflineminus">-    // Question 3.2: Is the local ID valid?</span>
<a href="#l32.62"></a><span id="l32.62" class="difflineminus">-    Assert.notEqual(card.localId, &quot;&quot;);</span>
<a href="#l32.63"></a><span id="l32.63" class="difflineminus">-</span>
<a href="#l32.64"></a><span id="l32.64" class="difflineminus">-    // Question 3.3: Is the format equal to generateUUID?</span>
<a href="#l32.65"></a><span id="l32.65" class="difflineminus">-    Assert.equal(card.uuid, MailServices.ab.generateUUID(prefId, card.localId));</span>
<a href="#l32.66"></a><span id="l32.66" class="difflineminus">-  }</span>
<a href="#l32.67"></a><span id="l32.67" class="difflineminus">-</span>
<a href="#l32.68"></a><span id="l32.68" class="difflineminus">-  // The remaining tests deal with modification of address books.</span>
<a href="#l32.69"></a><span id="l32.69" class="difflineminus">-  if (!testModification) {</span>
<a href="#l32.70"></a><span id="l32.70" class="difflineminus">-    return;</span>
<a href="#l32.71"></a><span id="l32.71" class="difflineminus">-  }</span>
<a href="#l32.72"></a><span id="l32.72" class="difflineminus">-</span>
<a href="#l32.73"></a><span id="l32.73" class="difflineminus">-  // Question 4: Does adding a new card properly set the UUID?</span>
<a href="#l32.74"></a><span id="l32.74" class="difflineminus">-  var newCard = Cc[&quot;@mozilla.org/addressbook/cardproperty;1&quot;].createInstance(</span>
<a href="#l32.75"></a><span id="l32.75" class="difflineminus">-    Ci.nsIAbCard</span>
<a href="#l32.76"></a><span id="l32.76" class="difflineminus">-  );</span>
<a href="#l32.77"></a><span id="l32.77" class="difflineminus">-  newCard.displayName = &quot;Test User&quot;;</span>
<a href="#l32.78"></a><span id="l32.78" class="difflineminus">-  newCard.primaryEmail = &quot;user1@test.invalid&quot;;</span>
<a href="#l32.79"></a><span id="l32.79" class="difflineminus">-  newCard.firstName = &quot;Test&quot;;</span>
<a href="#l32.80"></a><span id="l32.80" class="difflineminus">-  newCard.lastName = &quot;User&quot;;</span>
<a href="#l32.81"></a><span id="l32.81" class="difflineminus">-</span>
<a href="#l32.82"></a><span id="l32.82" class="difflineminus">-  newCard = directory.addCard(newCard);</span>
<a href="#l32.83"></a><span id="l32.83" class="difflineminus">-  Assert.equal(newCard.directoryId, prefId);</span>
<a href="#l32.84"></a><span id="l32.84" class="difflineminus">-  Assert.notEqual(newCard.localId, &quot;&quot;);</span>
<a href="#l32.85"></a><span id="l32.85" class="difflineminus">-  Assert.equal(seenIds.indexOf(newCard.localId), -1);</span>
<a href="#l32.86"></a><span id="l32.86" class="difflineminus">-</span>
<a href="#l32.87"></a><span id="l32.87" class="difflineminus">-  // Remove the new card to be stable!</span>
<a href="#l32.88"></a><span id="l32.88" class="difflineminus">-  var array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l32.89"></a><span id="l32.89" class="difflineminus">-  array.appendElement(newCard);</span>
<a href="#l32.90"></a><span id="l32.90" class="difflineminus">-  directory.deleteCards(array);</span>
<a href="#l32.91"></a><span id="l32.91" class="difflineminus">-</span>
<a href="#l32.92"></a><span id="l32.92" class="difflineminus">-  // We need to iterate over the array of cards to avoid any problems if someone</span>
<a href="#l32.93"></a><span id="l32.93" class="difflineminus">-  // makes the childCards enumerator reflect changes to directory...</span>
<a href="#l32.94"></a><span id="l32.94" class="difflineminus">-  for (let card of cards) {</span>
<a href="#l32.95"></a><span id="l32.95" class="difflineminus">-    // Question 5.1: Does deleting a card properly set the uids?</span>
<a href="#l32.96"></a><span id="l32.96" class="difflineminus">-    var localId = card.localId;</span>
<a href="#l32.97"></a><span id="l32.97" class="difflineminus">-    array.clear();</span>
<a href="#l32.98"></a><span id="l32.98" class="difflineminus">-    array.appendElement(card);</span>
<a href="#l32.99"></a><span id="l32.99" class="difflineminus">-    directory.deleteCards(array);</span>
<a href="#l32.100"></a><span id="l32.100" class="difflineminus">-    Assert.equal(card.directoryId, &quot;&quot;);</span>
<a href="#l32.101"></a><span id="l32.101" class="difflineminus">-    Assert.equal(card.localId, localId);</span>
<a href="#l32.102"></a><span id="l32.102" class="difflineminus">-</span>
<a href="#l32.103"></a><span id="l32.103" class="difflineminus">-    // Question 5.2: Does readding a card try to best-fit the uid?</span>
<a href="#l32.104"></a><span id="l32.104" class="difflineminus">-    card = directory.addCard(card);</span>
<a href="#l32.105"></a><span id="l32.105" class="difflineminus">-    Assert.equal(card.directoryId, prefId);</span>
<a href="#l32.106"></a><span id="l32.106" class="difflineminus">-    Assert.equal(card.localId, localId);</span>
<a href="#l32.107"></a><span id="l32.107" class="difflineminus">-  }</span>
<a href="#l32.108"></a><span id="l32.108" class="difflineminus">-}</span>
<a href="#l32.109"></a><span id="l32.109" class="difflineminus">-</span>
<a href="#l32.110"></a><span id="l32.110" class="difflineminus">-function run_test() {</span>
<a href="#l32.111"></a><span id="l32.111" class="difflineminus">-  loadABFile(&quot;data/cardForEmail&quot;, kPABData.fileName);</span>
<a href="#l32.112"></a><span id="l32.112" class="difflineminus">-</span>
<a href="#l32.113"></a><span id="l32.113" class="difflineminus">-  // Step 1: What is the ID of an empty card?</span>
<a href="#l32.114"></a><span id="l32.114" class="difflineminus">-  var newCard = Cc[&quot;@mozilla.org/addressbook/cardproperty;1&quot;].createInstance(</span>
<a href="#l32.115"></a><span id="l32.115" class="difflineminus">-    Ci.nsIAbCard</span>
<a href="#l32.116"></a><span id="l32.116" class="difflineminus">-  );</span>
<a href="#l32.117"></a><span id="l32.117" class="difflineminus">-  Assert.equal(newCard.uuid, &quot;&quot;);</span>
<a href="#l32.118"></a><span id="l32.118" class="difflineminus">-  Assert.equal(newCard.directoryId, &quot;&quot;);</span>
<a href="#l32.119"></a><span id="l32.119" class="difflineminus">-  Assert.equal(newCard.localId, &quot;&quot;);</span>
<a href="#l32.120"></a><span id="l32.120" class="difflineminus">-</span>
<a href="#l32.121"></a><span id="l32.121" class="difflineminus">-  // Step 2: Check the directories</span>
<a href="#l32.122"></a><span id="l32.122" class="difflineminus">-  let dirs = MailServices.ab.directories;</span>
<a href="#l32.123"></a><span id="l32.123" class="difflineminus">-  while (dirs.hasMoreElements()) {</span>
<a href="#l32.124"></a><span id="l32.124" class="difflineminus">-    let directory = dirs.getNext().QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l32.125"></a><span id="l32.125" class="difflineminus">-    check_directory(directory);</span>
<a href="#l32.126"></a><span id="l32.126" class="difflineminus">-  }</span>
<a href="#l32.127"></a><span id="l32.127" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1">deleted file mode 100644</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineminus">--- a/mailnews/addrbook/test/unit/xpcshell-jsaddrbook.ini</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineplus">+++ /dev/null</span>
<a href="#l33.4"></a><span id="l33.4" class="difflineat">@@ -1,23 +0,0 @@</span>
<a href="#l33.5"></a><span id="l33.5" class="difflineminus">-[DEFAULT]</span>
<a href="#l33.6"></a><span id="l33.6" class="difflineminus">-dupe-manifest =</span>
<a href="#l33.7"></a><span id="l33.7" class="difflineminus">-head = head_jsaddrbook.js</span>
<a href="#l33.8"></a><span id="l33.8" class="difflineminus">-tail =</span>
<a href="#l33.9"></a><span id="l33.9" class="difflineminus">-support-files = data/*</span>
<a href="#l33.10"></a><span id="l33.10" class="difflineminus">-tags = jsaddrbook</span>
<a href="#l33.11"></a><span id="l33.11" class="difflineminus">-</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-[include:xpcshell.ini]</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineminus">-[test_jsaddrbook_inner.js]</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineminus">-[test_migration1.js]</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineminus">-head = head_migration.js</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineminus">-[test_migration2.js]</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineminus">-head = head_migration.js</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineminus">-[test_migration3.js]</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineminus">-head = head_migration.js</span>
<a href="#l33.20"></a><span id="l33.20" class="difflineminus">-[test_migration4.js]</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineminus">-head = head_migration.js</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineminus">-[test_migration5.js]</span>
<a href="#l33.23"></a><span id="l33.23" class="difflineminus">-head = head_migration.js</span>
<a href="#l33.24"></a><span id="l33.24" class="difflineminus">-[test_migration6.js]</span>
<a href="#l33.25"></a><span id="l33.25" class="difflineminus">-head = head_migration.js</span>
<a href="#l33.26"></a><span id="l33.26" class="difflineminus">-[test_migration7.js]</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineminus">-head = head_migration.js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1">deleted file mode 100644</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineminus">--- a/mailnews/addrbook/test/unit/xpcshell-mdbaddrbook.ini</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineplus">+++ /dev/null</span>
<a href="#l34.4"></a><span id="l34.4" class="difflineat">@@ -1,13 +0,0 @@</span>
<a href="#l34.5"></a><span id="l34.5" class="difflineminus">-[DEFAULT]</span>
<a href="#l34.6"></a><span id="l34.6" class="difflineminus">-dupe-manifest =</span>
<a href="#l34.7"></a><span id="l34.7" class="difflineminus">-head = head_addrbook.js</span>
<a href="#l34.8"></a><span id="l34.8" class="difflineminus">-tail =</span>
<a href="#l34.9"></a><span id="l34.9" class="difflineminus">-support-files = data/*</span>
<a href="#l34.10"></a><span id="l34.10" class="difflineminus">-tags = mdbaddrbook</span>
<a href="#l34.11"></a><span id="l34.11" class="difflineminus">-</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-# These are the tests that do not pass or should not pass when using the</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineminus">-# JS directory provider.</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineminus">-</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineminus">-[test_uuid.js]</span>
<a href="#l34.16"></a><span id="l34.16" class="difflineminus">-</span>
<a href="#l34.17"></a><span id="l34.17" class="difflineminus">-[include:xpcshell.ini]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/xpcshell.ini</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/xpcshell.ini</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -1,29 +1,48 @@</span>
<a href="#l35.4"></a><span id="l35.4" class="difflineplus">+[DEFAULT]</span>
<a href="#l35.5"></a><span id="l35.5" class="difflineplus">+head = head.js</span>
<a href="#l35.6"></a><span id="l35.6" class="difflineplus">+support-files = data/*</span>
<a href="#l35.7"></a><span id="l35.7" class="difflineplus">+</span>
<a href="#l35.8"></a><span id="l35.8"> [test_basic_nsIAbCard.js]</span>
<a href="#l35.9"></a><span id="l35.9"> [test_basic_nsIAbDirectory.js]</span>
<a href="#l35.10"></a><span id="l35.10"> [test_bug387403.js]</span>
<a href="#l35.11"></a><span id="l35.11"> [test_bug448165.js]</span>
<a href="#l35.12"></a><span id="l35.12"> [test_bug534822.js]</span>
<a href="#l35.13"></a><span id="l35.13"> [test_bug1522453.js]</span>
<a href="#l35.14"></a><span id="l35.14"> [test_cardForEmail.js]</span>
<a href="#l35.15"></a><span id="l35.15"> [test_collection.js]</span>
<a href="#l35.16"></a><span id="l35.16"> [test_collection_2.js]</span>
<a href="#l35.17"></a><span id="l35.17"> [test_db_enumerator.js]</span>
<a href="#l35.18"></a><span id="l35.18"> [test_jsaddrbook.js]</span>
<a href="#l35.19"></a><span id="l35.19" class="difflineplus">+[test_jsaddrbook_inner.js]</span>
<a href="#l35.20"></a><span id="l35.20"> [test_ldap1.js]</span>
<a href="#l35.21"></a><span id="l35.21"> [test_ldap2.js]</span>
<a href="#l35.22"></a><span id="l35.22"> [test_ldapOffline.js]</span>
<a href="#l35.23"></a><span id="l35.23" class="difflineplus">+fail-if = true</span>
<a href="#l35.24"></a><span id="l35.24"> [test_mailList1.js]</span>
<a href="#l35.25"></a><span id="l35.25" class="difflineplus">+[test_migration1.js]</span>
<a href="#l35.26"></a><span id="l35.26" class="difflineplus">+head = head_migration.js</span>
<a href="#l35.27"></a><span id="l35.27" class="difflineplus">+[test_migration2.js]</span>
<a href="#l35.28"></a><span id="l35.28" class="difflineplus">+head = head_migration.js</span>
<a href="#l35.29"></a><span id="l35.29" class="difflineplus">+[test_migration3.js]</span>
<a href="#l35.30"></a><span id="l35.30" class="difflineplus">+head = head_migration.js</span>
<a href="#l35.31"></a><span id="l35.31" class="difflineplus">+[test_migration4.js]</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineplus">+head = head_migration.js</span>
<a href="#l35.33"></a><span id="l35.33" class="difflineplus">+[test_migration5.js]</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineplus">+head = head_migration.js</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineplus">+[test_migration6.js]</span>
<a href="#l35.36"></a><span id="l35.36" class="difflineplus">+head = head_migration.js</span>
<a href="#l35.37"></a><span id="l35.37" class="difflineplus">+[test_migration7.js]</span>
<a href="#l35.38"></a><span id="l35.38" class="difflineplus">+head = head_migration.js</span>
<a href="#l35.39"></a><span id="l35.39"> [test_notifications.js]</span>
<a href="#l35.40"></a><span id="l35.40"> [test_nsAbAutoCompleteMyDomain.js]</span>
<a href="#l35.41"></a><span id="l35.41"> [test_nsAbAutoCompleteSearch1.js]</span>
<a href="#l35.42"></a><span id="l35.42"> [test_nsAbAutoCompleteSearch2.js]</span>
<a href="#l35.43"></a><span id="l35.43"> [test_nsAbAutoCompleteSearch3.js]</span>
<a href="#l35.44"></a><span id="l35.44"> [test_nsAbAutoCompleteSearch4.js]</span>
<a href="#l35.45"></a><span id="l35.45"> [test_nsAbAutoCompleteSearch5.js]</span>
<a href="#l35.46"></a><span id="l35.46"> [test_nsAbAutoCompleteSearch6.js]</span>
<a href="#l35.47"></a><span id="l35.47"> [test_nsAbAutoCompleteSearch7.js]</span>
<a href="#l35.48"></a><span id="l35.48"> [test_nsAbManager1.js]</span>
<a href="#l35.49"></a><span id="l35.49"> [test_nsAbManager2.js]</span>
<a href="#l35.50"></a><span id="l35.50"> [test_nsAbManager3.js]</span>
<a href="#l35.51"></a><span id="l35.51"> [test_nsIAbCard.js]</span>
<a href="#l35.52"></a><span id="l35.52" class="difflineminus">-[test_uid.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/build/nsMailModule.cpp</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/build/nsMailModule.cpp</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -107,20 +107,17 @@</span>
<a href="#l36.4"></a><span id="l36.4"> #include &quot;nsStopwatch.h&quot;</span>
<a href="#l36.5"></a><span id="l36.5"> #include &quot;MailNewsDLF.h&quot;</span>
<a href="#l36.6"></a><span id="l36.6"> </span>
<a href="#l36.7"></a><span id="l36.7"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l36.8"></a><span id="l36.8"> // addrbook includes</span>
<a href="#l36.9"></a><span id="l36.9"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l36.10"></a><span id="l36.10"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l36.11"></a><span id="l36.11"> #include &quot;nsAbBSDirectory.h&quot;</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-#include &quot;nsAbMDBDirectory.h&quot;</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineminus">-#include &quot;nsAbMDBCard.h&quot;</span>
<a href="#l36.14"></a><span id="l36.14"> #include &quot;nsAbDirFactoryService.h&quot;</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineminus">-#include &quot;nsAbMDBDirFactory.h&quot;</span>
<a href="#l36.16"></a><span id="l36.16"> #include &quot;nsAddrDatabase.h&quot;</span>
<a href="#l36.17"></a><span id="l36.17"> #include &quot;nsAbManager.h&quot;</span>
<a href="#l36.18"></a><span id="l36.18"> #include &quot;nsAbContentHandler.h&quot;</span>
<a href="#l36.19"></a><span id="l36.19"> #include &quot;nsAbDirProperty.h&quot;</span>
<a href="#l36.20"></a><span id="l36.20"> #include &quot;nsAbAddressCollector.h&quot;</span>
<a href="#l36.21"></a><span id="l36.21"> #include &quot;nsAddbookProtocolHandler.h&quot;</span>
<a href="#l36.22"></a><span id="l36.22"> #include &quot;nsAddbookUrl.h&quot;</span>
<a href="#l36.23"></a><span id="l36.23"> </span>
<a href="#l36.24"></a><span id="l36.24" class="difflineat">@@ -437,23 +434,20 @@ NS_DEFINE_NAMED_CID(NS_MAILNEWSDLF_CID);</span>
<a href="#l36.25"></a><span id="l36.25"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l36.26"></a><span id="l36.26"> // addrbook factories</span>
<a href="#l36.27"></a><span id="l36.27"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l36.28"></a><span id="l36.28"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsAbManager, Init)</span>
<a href="#l36.29"></a><span id="l36.29"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbContentHandler)</span>
<a href="#l36.30"></a><span id="l36.30"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbDirProperty)</span>
<a href="#l36.31"></a><span id="l36.31"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbCardProperty)</span>
<a href="#l36.32"></a><span id="l36.32"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbBSDirectory)</span>
<a href="#l36.33"></a><span id="l36.33" class="difflineminus">-NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbMDBDirectory)</span>
<a href="#l36.34"></a><span id="l36.34" class="difflineminus">-NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbMDBCard)</span>
<a href="#l36.35"></a><span id="l36.35"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAddrDatabase)</span>
<a href="#l36.36"></a><span id="l36.36"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsAbAddressCollector, Init)</span>
<a href="#l36.37"></a><span id="l36.37"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAddbookUrl)</span>
<a href="#l36.38"></a><span id="l36.38"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbDirFactoryService)</span>
<a href="#l36.39"></a><span id="l36.39" class="difflineminus">-NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbMDBDirFactory)</span>
<a href="#l36.40"></a><span id="l36.40"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAddbookProtocolHandler)</span>
<a href="#l36.41"></a><span id="l36.41"> </span>
<a href="#l36.42"></a><span id="l36.42"> #if defined(MOZ_MAPI_SUPPORT)</span>
<a href="#l36.43"></a><span id="l36.43"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbOutlookDirectory)</span>
<a href="#l36.44"></a><span id="l36.44"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbOutlookDirFactory)</span>
<a href="#l36.45"></a><span id="l36.45"> #endif</span>
<a href="#l36.46"></a><span id="l36.46"> </span>
<a href="#l36.47"></a><span id="l36.47"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbDirectoryQueryArguments)</span>
<a href="#l36.48"></a><span id="l36.48" class="difflineat">@@ -482,27 +476,24 @@ NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDIFS</span>
<a href="#l36.49"></a><span id="l36.49"> #ifdef XP_MACOSX</span>
<a href="#l36.50"></a><span id="l36.50"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbOSXDirectory)</span>
<a href="#l36.51"></a><span id="l36.51"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbOSXCard)</span>
<a href="#l36.52"></a><span id="l36.52"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbOSXDirFactory)</span>
<a href="#l36.53"></a><span id="l36.53"> #endif</span>
<a href="#l36.54"></a><span id="l36.54"> </span>
<a href="#l36.55"></a><span id="l36.55"> NS_DEFINE_NAMED_CID(NS_ABMANAGER_CID);</span>
<a href="#l36.56"></a><span id="l36.56"> NS_DEFINE_NAMED_CID(NS_ABDIRECTORY_CID);</span>
<a href="#l36.57"></a><span id="l36.57" class="difflineminus">-NS_DEFINE_NAMED_CID(NS_ABMDBDIRECTORY_CID);</span>
<a href="#l36.58"></a><span id="l36.58" class="difflineminus">-NS_DEFINE_NAMED_CID(NS_ABMDBCARD_CID);</span>
<a href="#l36.59"></a><span id="l36.59"> NS_DEFINE_NAMED_CID(NS_ADDRDATABASE_CID);</span>
<a href="#l36.60"></a><span id="l36.60"> NS_DEFINE_NAMED_CID(NS_ABCARDPROPERTY_CID);</span>
<a href="#l36.61"></a><span id="l36.61"> NS_DEFINE_NAMED_CID(NS_ABDIRPROPERTY_CID);</span>
<a href="#l36.62"></a><span id="l36.62"> NS_DEFINE_NAMED_CID(NS_ABADDRESSCOLLECTOR_CID);</span>
<a href="#l36.63"></a><span id="l36.63"> NS_DEFINE_NAMED_CID(NS_ADDBOOKURL_CID);</span>
<a href="#l36.64"></a><span id="l36.64"> NS_DEFINE_NAMED_CID(NS_ADDBOOK_HANDLER_CID);</span>
<a href="#l36.65"></a><span id="l36.65"> NS_DEFINE_NAMED_CID(NS_ABCONTENTHANDLER_CID);</span>
<a href="#l36.66"></a><span id="l36.66"> NS_DEFINE_NAMED_CID(NS_ABDIRFACTORYSERVICE_CID);</span>
<a href="#l36.67"></a><span id="l36.67" class="difflineminus">-NS_DEFINE_NAMED_CID(NS_ABMDBDIRFACTORY_CID);</span>
<a href="#l36.68"></a><span id="l36.68"> NS_DEFINE_NAMED_CID(NS_ABDIRECTORYQUERYARGUMENTS_CID);</span>
<a href="#l36.69"></a><span id="l36.69"> NS_DEFINE_NAMED_CID(NS_BOOLEANCONDITIONSTRING_CID);</span>
<a href="#l36.70"></a><span id="l36.70"> NS_DEFINE_NAMED_CID(NS_BOOLEANEXPRESSION_CID);</span>
<a href="#l36.71"></a><span id="l36.71"> #if defined(MOZ_MAPI_SUPPORT)</span>
<a href="#l36.72"></a><span id="l36.72"> NS_DEFINE_NAMED_CID(NS_ABOUTLOOKDIRECTORY_CID);</span>
<a href="#l36.73"></a><span id="l36.73"> NS_DEFINE_NAMED_CID(NS_ABOUTLOOKDIRFACTORY_CID);</span>
<a href="#l36.74"></a><span id="l36.74"> #endif</span>
<a href="#l36.75"></a><span id="l36.75"> </span>
<a href="#l36.76"></a><span id="l36.76" class="difflineat">@@ -903,29 +894,26 @@ const mozilla::Module::CIDEntry kMailNew</span>
<a href="#l36.77"></a><span id="l36.77">     {&amp;kNS_MSGCONTENTPOLICY_CID, false, NULL, nsMsgContentPolicyConstructor},</span>
<a href="#l36.78"></a><span id="l36.78">     {&amp;kNS_MSGSHUTDOWNSERVICE_CID, false, NULL, nsMsgShutdownServiceConstructor},</span>
<a href="#l36.79"></a><span id="l36.79">     {&amp;kMAILDIRPROVIDER_CID, false, NULL, nsMailDirProviderConstructor},</span>
<a href="#l36.80"></a><span id="l36.80">     {&amp;kNS_STOPWATCH_CID, false, NULL, nsStopwatchConstructor},</span>
<a href="#l36.81"></a><span id="l36.81">     {&amp;kNS_MAILNEWSDLF_CID, false, NULL, MailNewsDLFConstructor},</span>
<a href="#l36.82"></a><span id="l36.82">     // Address Book Entries</span>
<a href="#l36.83"></a><span id="l36.83">     {&amp;kNS_ABMANAGER_CID, false, NULL, nsAbManagerConstructor},</span>
<a href="#l36.84"></a><span id="l36.84">     {&amp;kNS_ABDIRECTORY_CID, false, NULL, nsAbBSDirectoryConstructor},</span>
<a href="#l36.85"></a><span id="l36.85" class="difflineminus">-    {&amp;kNS_ABMDBDIRECTORY_CID, false, NULL, nsAbMDBDirectoryConstructor},</span>
<a href="#l36.86"></a><span id="l36.86" class="difflineminus">-    {&amp;kNS_ABMDBCARD_CID, false, NULL, nsAbMDBCardConstructor},</span>
<a href="#l36.87"></a><span id="l36.87">     {&amp;kNS_ADDRDATABASE_CID, false, NULL, nsAddrDatabaseConstructor},</span>
<a href="#l36.88"></a><span id="l36.88">     {&amp;kNS_ABCARDPROPERTY_CID, false, NULL, nsAbCardPropertyConstructor},</span>
<a href="#l36.89"></a><span id="l36.89">     {&amp;kNS_ABDIRPROPERTY_CID, false, NULL, nsAbDirPropertyConstructor},</span>
<a href="#l36.90"></a><span id="l36.90">     {&amp;kNS_ABADDRESSCOLLECTOR_CID, false, NULL, nsAbAddressCollectorConstructor},</span>
<a href="#l36.91"></a><span id="l36.91">     {&amp;kNS_ADDBOOKURL_CID, false, NULL, nsAddbookUrlConstructor},</span>
<a href="#l36.92"></a><span id="l36.92">     {&amp;kNS_ADDBOOK_HANDLER_CID, false, NULL,</span>
<a href="#l36.93"></a><span id="l36.93">      nsAddbookProtocolHandlerConstructor},</span>
<a href="#l36.94"></a><span id="l36.94">     {&amp;kNS_ABCONTENTHANDLER_CID, false, NULL, nsAbContentHandlerConstructor},</span>
<a href="#l36.95"></a><span id="l36.95">     {&amp;kNS_ABDIRFACTORYSERVICE_CID, false, NULL,</span>
<a href="#l36.96"></a><span id="l36.96">      nsAbDirFactoryServiceConstructor},</span>
<a href="#l36.97"></a><span id="l36.97" class="difflineminus">-    {&amp;kNS_ABMDBDIRFACTORY_CID, false, NULL, nsAbMDBDirFactoryConstructor},</span>
<a href="#l36.98"></a><span id="l36.98"> #if defined(MOZ_MAPI_SUPPORT)</span>
<a href="#l36.99"></a><span id="l36.99">     {&amp;kNS_ABOUTLOOKDIRECTORY_CID, false, NULL, nsAbOutlookDirectoryConstructor},</span>
<a href="#l36.100"></a><span id="l36.100">     {&amp;kNS_ABOUTLOOKDIRFACTORY_CID, false, NULL,</span>
<a href="#l36.101"></a><span id="l36.101">      nsAbOutlookDirFactoryConstructor},</span>
<a href="#l36.102"></a><span id="l36.102"> #endif</span>
<a href="#l36.103"></a><span id="l36.103">     {&amp;kNS_ABDIRECTORYQUERYARGUMENTS_CID, false, NULL,</span>
<a href="#l36.104"></a><span id="l36.104">      nsAbDirectoryQueryArgumentsConstructor},</span>
<a href="#l36.105"></a><span id="l36.105">     {&amp;kNS_BOOLEANCONDITIONSTRING_CID, false, NULL,</span>
<a href="#l36.106"></a><span id="l36.106" class="difflineat">@@ -1148,30 +1136,27 @@ const mozilla::Module::ContractIDEntry k</span>
<a href="#l36.107"></a><span id="l36.107">     {NS_MSGSHUTDOWNSERVICE_CONTRACTID, &amp;kNS_MSGSHUTDOWNSERVICE_CID},</span>
<a href="#l36.108"></a><span id="l36.108">     {NS_MAILDIRPROVIDER_CONTRACTID, &amp;kMAILDIRPROVIDER_CID},</span>
<a href="#l36.109"></a><span id="l36.109">     {NS_STOPWATCH_CONTRACTID, &amp;kNS_STOPWATCH_CID},</span>
<a href="#l36.110"></a><span id="l36.110">     {NS_MAILNEWSDLF_CONTRACTID, &amp;kNS_MAILNEWSDLF_CID},</span>
<a href="#l36.111"></a><span id="l36.111">     // Address Book Entries</span>
<a href="#l36.112"></a><span id="l36.112">     {NS_ABMANAGER_CONTRACTID, &amp;kNS_ABMANAGER_CID},</span>
<a href="#l36.113"></a><span id="l36.113">     {NS_ABMANAGERSTARTUPHANDLER_CONTRACTID, &amp;kNS_ABMANAGER_CID},</span>
<a href="#l36.114"></a><span id="l36.114">     {NS_ABDIRECTORY_CONTRACTID, &amp;kNS_ABDIRECTORY_CID},</span>
<a href="#l36.115"></a><span id="l36.115" class="difflineminus">-    {NS_ABMDBDIRECTORY_CONTRACTID, &amp;kNS_ABMDBDIRECTORY_CID},</span>
<a href="#l36.116"></a><span id="l36.116" class="difflineminus">-    {NS_ABMDBCARD_CONTRACTID, &amp;kNS_ABMDBCARD_CID},</span>
<a href="#l36.117"></a><span id="l36.117">     {NS_ADDRDATABASE_CONTRACTID, &amp;kNS_ADDRDATABASE_CID},</span>
<a href="#l36.118"></a><span id="l36.118">     {NS_ABCARDPROPERTY_CONTRACTID, &amp;kNS_ABCARDPROPERTY_CID},</span>
<a href="#l36.119"></a><span id="l36.119">     {NS_ABDIRPROPERTY_CONTRACTID, &amp;kNS_ABDIRPROPERTY_CID},</span>
<a href="#l36.120"></a><span id="l36.120">     {NS_ABADDRESSCOLLECTOR_CONTRACTID, &amp;kNS_ABADDRESSCOLLECTOR_CID},</span>
<a href="#l36.121"></a><span id="l36.121">     {NS_ADDBOOKURL_CONTRACTID, &amp;kNS_ADDBOOKURL_CID},</span>
<a href="#l36.122"></a><span id="l36.122">     {NS_NETWORK_PROTOCOL_CONTRACTID_PREFIX &quot;addbook&quot;, &amp;kNS_ADDBOOK_HANDLER_CID},</span>
<a href="#l36.123"></a><span id="l36.123">     {NS_CONTENT_HANDLER_CONTRACTID_PREFIX &quot;application/x-addvcard&quot;,</span>
<a href="#l36.124"></a><span id="l36.124">      &amp;kNS_ABCONTENTHANDLER_CID},</span>
<a href="#l36.125"></a><span id="l36.125">     {NS_CONTENT_HANDLER_CONTRACTID_PREFIX &quot;text/x-vcard&quot;,</span>
<a href="#l36.126"></a><span id="l36.126">      &amp;kNS_ABCONTENTHANDLER_CID},</span>
<a href="#l36.127"></a><span id="l36.127">     {NS_ABDIRFACTORYSERVICE_CONTRACTID, &amp;kNS_ABDIRFACTORYSERVICE_CID},</span>
<a href="#l36.128"></a><span id="l36.128" class="difflineminus">-    {NS_ABMDBDIRFACTORY_CONTRACTID, &amp;kNS_ABMDBDIRFACTORY_CID},</span>
<a href="#l36.129"></a><span id="l36.129"> #if defined(MOZ_MAPI_SUPPORT)</span>
<a href="#l36.130"></a><span id="l36.130">     {NS_ABOUTLOOKDIRECTORY_CONTRACTID, &amp;kNS_ABOUTLOOKDIRECTORY_CID},</span>
<a href="#l36.131"></a><span id="l36.131">     {NS_ABOUTLOOKDIRFACTORY_CONTRACTID, &amp;kNS_ABOUTLOOKDIRFACTORY_CID},</span>
<a href="#l36.132"></a><span id="l36.132"> #endif</span>
<a href="#l36.133"></a><span id="l36.133">     {NS_ABDIRECTORYQUERYARGUMENTS_CONTRACTID,</span>
<a href="#l36.134"></a><span id="l36.134">      &amp;kNS_ABDIRECTORYQUERYARGUMENTS_CID},</span>
<a href="#l36.135"></a><span id="l36.135">     {NS_BOOLEANCONDITIONSTRING_CONTRACTID, &amp;kNS_BOOLEANCONDITIONSTRING_CID},</span>
<a href="#l36.136"></a><span id="l36.136">     {NS_BOOLEANEXPRESSION_CONTRACTID, &amp;kNS_BOOLEANEXPRESSION_CID},</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -24,17 +24,16 @@</span>
<a href="#l37.4"></a><span id="l37.4"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l37.5"></a><span id="l37.5"> #include &quot;nsIPlaintextEditor.h&quot;</span>
<a href="#l37.6"></a><span id="l37.6"> #include &quot;nsIHTMLEditor.h&quot;</span>
<a href="#l37.7"></a><span id="l37.7"> #include &quot;nsIEditor.h&quot;</span>
<a href="#l37.8"></a><span id="l37.8"> #include &quot;plstr.h&quot;</span>
<a href="#l37.9"></a><span id="l37.9"> #include &quot;prmem.h&quot;</span>
<a href="#l37.10"></a><span id="l37.10"> #include &quot;nsIDocShell.h&quot;</span>
<a href="#l37.11"></a><span id="l37.11"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-#include &quot;nsIAbMDBDirectory.h&quot;</span>
<a href="#l37.13"></a><span id="l37.13"> #include &quot;nsCExternalHandlerService.h&quot;</span>
<a href="#l37.14"></a><span id="l37.14"> #include &quot;nsIMIMEService.h&quot;</span>
<a href="#l37.15"></a><span id="l37.15"> #include &quot;nsIDocShellTreeItem.h&quot;</span>
<a href="#l37.16"></a><span id="l37.16"> #include &quot;nsIDocShellTreeOwner.h&quot;</span>
<a href="#l37.17"></a><span id="l37.17"> #include &quot;nsIWindowMediator.h&quot;</span>
<a href="#l37.18"></a><span id="l37.18"> #include &quot;nsIURL.h&quot;</span>
<a href="#l37.19"></a><span id="l37.19"> #include &quot;nsIMsgMailSession.h&quot;</span>
<a href="#l37.20"></a><span id="l37.20"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l37.21"></a><span id="l37.21" class="difflineat">@@ -4419,19 +4418,17 @@ nsresult nsMsgCompose::AttachmentPrettyN</span>
<a href="#l37.22"></a><span id="l37.22">  *</span>
<a href="#l37.23"></a><span id="l37.23">  * @param aDirUri               directory URI</span>
<a href="#l37.24"></a><span id="l37.24">  * @param allDirectoriesArray   retrieved directories and sub-directories</span>
<a href="#l37.25"></a><span id="l37.25">  * @param allMailListArray      retrieved maillists</span>
<a href="#l37.26"></a><span id="l37.26">  */</span>
<a href="#l37.27"></a><span id="l37.27"> nsresult nsMsgCompose::GetABDirAndMailLists(</span>
<a href="#l37.28"></a><span id="l37.28">     const nsACString &amp;aDirUri, nsCOMArray&lt;nsIAbDirectory&gt; &amp;aDirArray,</span>
<a href="#l37.29"></a><span id="l37.29">     nsTArray&lt;nsMsgMailList&gt; &amp;aMailListArray) {</span>
<a href="#l37.30"></a><span id="l37.30" class="difflineminus">-  static bool collectedAddressbookFound;</span>
<a href="#l37.31"></a><span id="l37.31" class="difflineminus">-  if (aDirUri.EqualsLiteral(kMDBDirectoryRoot))</span>
<a href="#l37.32"></a><span id="l37.32" class="difflineminus">-    collectedAddressbookFound = false;</span>
<a href="#l37.33"></a><span id="l37.33" class="difflineplus">+  static bool collectedAddressbookFound = false;</span>
<a href="#l37.34"></a><span id="l37.34"> </span>
<a href="#l37.35"></a><span id="l37.35">   nsresult rv;</span>
<a href="#l37.36"></a><span id="l37.36">   nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l37.37"></a><span id="l37.37">       do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l37.38"></a><span id="l37.38">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.39"></a><span id="l37.39"> </span>
<a href="#l37.40"></a><span id="l37.40">   nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l37.41"></a><span id="l37.41">   rv = abManager-&gt;GetDirectory(aDirUri, getter_AddRefs(directory));</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

