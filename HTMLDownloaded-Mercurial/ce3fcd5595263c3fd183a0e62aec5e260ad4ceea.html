<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 9851:ce3fcd5595263c3fd183a0e62aec5e260ad4ceea</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ ce3fcd5595263c3fd183a0e62aec5e260ad4ceea" />
<meta property="og:url" content="/comm-central/rev/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea" />
<meta property="og:description" content="Bug 738726 - Add more error checking to feeds to prevent restarts: 1. Add try catch to last throwable ios.newUri code remaining. 2. Workaround for bug 737966 regression. Fix up xhr parsing. 3. Force an msgDatabase reparse and continue feed processing, if not available. 4. Better logging. 5. Save untold downloading/parsing by fixing broken saving of Last-Modified timestamp. r=dbienvenu" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / ce3fcd5595263c3fd183a0e62aec5e260ad4ceea 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea">shortlog</a> |
<a href="/comm-central/log/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea">files</a> |
changeset |
<a href="/comm-central/raw-rev/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea">raw</a>  | <a href="/comm-central/archive/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=738726">Bug 738726</a> - Add more error checking to feeds to prevent restarts: 1. Add try catch to last throwable ios.newUri code remaining. 2. Workaround for <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=737966">bug 737966</a> regression. Fix up xhr parsing. 3. Force an msgDatabase reparse and continue feed processing, if not available. 4. Better logging. 5. Save untold downloading/parsing by fixing broken saving of Last-Modified timestamp. r=dbienvenu
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#97;&#108;&#116;&#97;&#56;&#56;&#32;&#60;&#97;&#108;&#116;&#97;&#56;&#56;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 06 Apr 2012 11:00:07 -0600</td></tr>

<tr>
 <td>changeset 9851</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea">ce3fcd5595263c3fd183a0e62aec5e260ad4ceea</a></td>
</tr>



<tr>
<td>parent 9850</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/617beb66dc157d3251723fb86cbb396852ec11e4">617beb66dc157d3251723fb86cbb396852ec11e4</a>
</td>
</tr>

<tr>
<td>child 9852</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6">01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=ce3fcd5595263c3fd183a0e62aec5e260ad4ceea">7503</a></td></tr>
<tr><td>push user</td><td>ryanvm@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 06 Apr 2012 18:20:53 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@ce3fcd559526 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=ce3fcd5595263c3fd183a0e62aec5e260ad4ceea">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=ce3fcd5595263c3fd183a0e62aec5e260ad4ceea&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ce3fcd5595263c3fd183a0e62aec5e260ad4ceea&newProject=comm-central&newRevision=ce3fcd5595263c3fd183a0e62aec5e260ad4ceea&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ce3fcd5595263c3fd183a0e62aec5e260ad4ceea&newProject=comm-central&newRevision=ce3fcd5595263c3fd183a0e62aec5e260ad4ceea&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ce3fcd5595263c3fd183a0e62aec5e260ad4ceea&newProject=comm-central&newRevision=ce3fcd5595263c3fd183a0e62aec5e260ad4ceea&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28dbienvenu%29&revcount=50">dbienvenu</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=738726">738726</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=737966">737966</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=738726">Bug 738726</a> - Add more error checking to feeds to prevent restarts: 1. Add try catch to last throwable ios.newUri code remaining. 2. Workaround for <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=737966">bug 737966</a> regression. Fix up xhr parsing. 3. Force an msgDatabase reparse and continue feed processing, if not available. 4. Better logging. 5. Save untold downloading/parsing by fixing broken saving of Last-Modified timestamp. r=dbienvenu</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea/mailnews/extensions/newsblog/content/Feed.js">mailnews/extensions/newsblog/content/Feed.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea/mailnews/extensions/newsblog/content/Feed.js">file</a> |
<a href="/comm-central/annotate/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea/mailnews/extensions/newsblog/content/Feed.js">annotate</a> |
<a href="/comm-central/diff/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea/mailnews/extensions/newsblog/content/Feed.js">diff</a> |
<a href="/comm-central/comparison/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea/mailnews/extensions/newsblog/content/Feed.js">comparison</a> |
<a href="/comm-central/log/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea/mailnews/extensions/newsblog/content/Feed.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea/mailnews/extensions/newsblog/content/feed-parser.js">mailnews/extensions/newsblog/content/feed-parser.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea/mailnews/extensions/newsblog/content/feed-parser.js">file</a> |
<a href="/comm-central/annotate/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea/mailnews/extensions/newsblog/content/feed-parser.js">annotate</a> |
<a href="/comm-central/diff/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea/mailnews/extensions/newsblog/content/feed-parser.js">diff</a> |
<a href="/comm-central/comparison/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea/mailnews/extensions/newsblog/content/feed-parser.js">comparison</a> |
<a href="/comm-central/log/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea/mailnews/extensions/newsblog/content/feed-parser.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea/mailnews/extensions/newsblog/content/utils.js">mailnews/extensions/newsblog/content/utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea/mailnews/extensions/newsblog/content/utils.js">file</a> |
<a href="/comm-central/annotate/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea/mailnews/extensions/newsblog/content/utils.js">annotate</a> |
<a href="/comm-central/diff/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea/mailnews/extensions/newsblog/content/utils.js">diff</a> |
<a href="/comm-central/comparison/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea/mailnews/extensions/newsblog/content/utils.js">comparison</a> |
<a href="/comm-central/log/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea/mailnews/extensions/newsblog/content/utils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea/mailnews/extensions/newsblog/js/newsblog.js">mailnews/extensions/newsblog/js/newsblog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea/mailnews/extensions/newsblog/js/newsblog.js">file</a> |
<a href="/comm-central/annotate/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea/mailnews/extensions/newsblog/js/newsblog.js">annotate</a> |
<a href="/comm-central/diff/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea/mailnews/extensions/newsblog/js/newsblog.js">diff</a> |
<a href="/comm-central/comparison/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea/mailnews/extensions/newsblog/js/newsblog.js">comparison</a> |
<a href="/comm-central/log/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea/mailnews/extensions/newsblog/js/newsblog.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/Feed.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/Feed.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -66,21 +66,26 @@ var FeedCache =</span>
<a href="#l1.4"></a><span id="l1.4">   {</span>
<a href="#l1.5"></a><span id="l1.5">     var index = this.normalizeHost(aUrl);</span>
<a href="#l1.6"></a><span id="l1.6">     if (index in this.mFeeds)</span>
<a href="#l1.7"></a><span id="l1.7">       delete this.mFeeds[index];</span>
<a href="#l1.8"></a><span id="l1.8">   },</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10">   normalizeHost: function (aUrl)</span>
<a href="#l1.11"></a><span id="l1.11">   {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    var ioService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;].</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-                    getService(Components.interfaces.nsIIOService);</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-    var normalizedUrl = ioService.newURI(aUrl, null, null);</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-    normalizedUrl.host = normalizedUrl.host.toLowerCase();</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-    return normalizedUrl.spec;</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+    try</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+    {</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+      let normalizedUrl = Services.io.newURI(aUrl, null, null);</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+      normalizedUrl.host = normalizedUrl.host.toLowerCase();</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+      return normalizedUrl.spec</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+    }</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+    catch (ex)</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+    {</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+      return aUrl;</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+    }</span>
<a href="#l1.27"></a><span id="l1.27">   }</span>
<a href="#l1.28"></a><span id="l1.28"> };</span>
<a href="#l1.29"></a><span id="l1.29"> </span>
<a href="#l1.30"></a><span id="l1.30"> function Feed(aResource, aRSSServer) </span>
<a href="#l1.31"></a><span id="l1.31"> {</span>
<a href="#l1.32"></a><span id="l1.32">   this.resource = aResource.QueryInterface(Components.interfaces.nsIRDFResource);</span>
<a href="#l1.33"></a><span id="l1.33">   this.server = aRSSServer;</span>
<a href="#l1.34"></a><span id="l1.34"> }</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineat">@@ -168,16 +173,18 @@ Feed.prototype =</span>
<a href="#l1.36"></a><span id="l1.36">                    .createInstance(Components.interfaces.nsIXMLHttpRequest);</span>
<a href="#l1.37"></a><span id="l1.37">     this.request.onprogress = this.onProgress; // must be set before calling .open</span>
<a href="#l1.38"></a><span id="l1.38">     this.request.open(&quot;GET&quot;, this.url, true);</span>
<a href="#l1.39"></a><span id="l1.39"> </span>
<a href="#l1.40"></a><span id="l1.40">     var lastModified = this.lastModified;</span>
<a href="#l1.41"></a><span id="l1.41">     if (lastModified)</span>
<a href="#l1.42"></a><span id="l1.42">       this.request.setRequestHeader(&quot;If-Modified-Since&quot;, lastModified);</span>
<a href="#l1.43"></a><span id="l1.43"> </span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+    // Only order what you're going to eat...</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+    this.request.responseType = &quot;document&quot;;</span>
<a href="#l1.46"></a><span id="l1.46">     this.request.overrideMimeType(&quot;text/xml&quot;);</span>
<a href="#l1.47"></a><span id="l1.47">     this.request.onload = this.onDownloaded;</span>
<a href="#l1.48"></a><span id="l1.48">     this.request.onerror = this.onDownloadError;</span>
<a href="#l1.49"></a><span id="l1.49">     FeedCache.putFeed(this);</span>
<a href="#l1.50"></a><span id="l1.50">     this.request.send(null);</span>
<a href="#l1.51"></a><span id="l1.51">   }, </span>
<a href="#l1.52"></a><span id="l1.52"> </span>
<a href="#l1.53"></a><span id="l1.53">   onDownloaded: function(aEvent) </span>
<a href="#l1.54"></a><span id="l1.54" class="difflineat">@@ -189,23 +196,25 @@ Feed.prototype =</span>
<a href="#l1.55"></a><span id="l1.55">     {</span>
<a href="#l1.56"></a><span id="l1.56">       Feed.prototype.onDownloadError(aEvent);</span>
<a href="#l1.57"></a><span id="l1.57">       return;</span>
<a href="#l1.58"></a><span id="l1.58">     }</span>
<a href="#l1.59"></a><span id="l1.59">     var feed = FeedCache.getFeed(url);</span>
<a href="#l1.60"></a><span id="l1.60">     if (!feed)</span>
<a href="#l1.61"></a><span id="l1.61">       throw(&quot;error after downloading &quot; + url + &quot;: couldn't retrieve feed from request&quot;);</span>
<a href="#l1.62"></a><span id="l1.62"> </span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-    // if the request has a Last-Modified header on it, then go ahead and remember</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-    // that as a property on the feed so we can use it when making future requests.    </span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+    // If the server sends a Last-Modified header, store the property on the</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+    // feed so we can use it when making future requests, to avoid downloading</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+    // and parsing feeds that have not changed.</span>
<a href="#l1.68"></a><span id="l1.68">     var lastModifiedHeader = request.getResponseHeader('Last-Modified');</span>
<a href="#l1.69"></a><span id="l1.69">     if (lastModifiedHeader)</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineminus">-      this.lastModified = lastModifiedHeader;</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+      feed.lastModified = lastModifiedHeader;</span>
<a href="#l1.72"></a><span id="l1.72"> </span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">-    feed.parse(); // parse will asynchronously call the download callback when it is done</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+    // The download callback is called asynchronously when parse() is done.</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+    feed.parse();</span>
<a href="#l1.76"></a><span id="l1.76">   }, </span>
<a href="#l1.77"></a><span id="l1.77">   </span>
<a href="#l1.78"></a><span id="l1.78">   onProgress: function(aEvent) </span>
<a href="#l1.79"></a><span id="l1.79">   {</span>
<a href="#l1.80"></a><span id="l1.80">     var request = aEvent.target;</span>
<a href="#l1.81"></a><span id="l1.81">     var url = request.channel.originalURI.spec;</span>
<a href="#l1.82"></a><span id="l1.82">     var feed = FeedCache.getFeed(url);</span>
<a href="#l1.83"></a><span id="l1.83"> </span>
<a href="#l1.84"></a><span id="l1.84" class="difflineat">@@ -215,34 +224,36 @@ Feed.prototype =</span>
<a href="#l1.85"></a><span id="l1.85"> </span>
<a href="#l1.86"></a><span id="l1.86">   onDownloadError: function(aEvent) </span>
<a href="#l1.87"></a><span id="l1.87">   {</span>
<a href="#l1.88"></a><span id="l1.88">     var request = aEvent.target;</span>
<a href="#l1.89"></a><span id="l1.89">     var url = request.channel.originalURI.spec;</span>
<a href="#l1.90"></a><span id="l1.90">     var feed = FeedCache.getFeed(url);</span>
<a href="#l1.91"></a><span id="l1.91">     if (feed.downloadCallback) </span>
<a href="#l1.92"></a><span id="l1.92">     {</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineminus">-      // if the http status code is a 304, then the feed has not been modified since we last downloaded it.</span>
<a href="#l1.94"></a><span id="l1.94">       var error = kNewsBlogRequestFailure;</span>
<a href="#l1.95"></a><span id="l1.95">       try</span>
<a href="#l1.96"></a><span id="l1.96">       {</span>
<a href="#l1.97"></a><span id="l1.97">         if (request.status == 304)</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+          // If the http status code is 304, the feed has not been modified</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+          // since we last downloaded it and does not need to be parsed.</span>
<a href="#l1.100"></a><span id="l1.100">           error = kNewsBlogNoNewItems;</span>
<a href="#l1.101"></a><span id="l1.101">       } catch (ex) {}</span>
<a href="#l1.102"></a><span id="l1.102">       feed.downloadCallback.downloaded(feed, error);</span>
<a href="#l1.103"></a><span id="l1.103">     }</span>
<a href="#l1.104"></a><span id="l1.104">     </span>
<a href="#l1.105"></a><span id="l1.105">     FeedCache.removeFeed(url);</span>
<a href="#l1.106"></a><span id="l1.106">   },</span>
<a href="#l1.107"></a><span id="l1.107"> </span>
<a href="#l1.108"></a><span id="l1.108">   onParseError: function(aFeed) </span>
<a href="#l1.109"></a><span id="l1.109">   {</span>
<a href="#l1.110"></a><span id="l1.110">     if (aFeed)</span>
<a href="#l1.111"></a><span id="l1.111">     {</span>
<a href="#l1.112"></a><span id="l1.112">       aFeed.mInvalidFeed = true;</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+      aFeed.lastModified = &quot;&quot;;</span>
<a href="#l1.114"></a><span id="l1.114"> </span>
<a href="#l1.115"></a><span id="l1.115">       if (aFeed.downloadCallback)</span>
<a href="#l1.116"></a><span id="l1.116">         aFeed.downloadCallback.downloaded(aFeed, kNewsBlogInvalidFeed);</span>
<a href="#l1.117"></a><span id="l1.117"> </span>
<a href="#l1.118"></a><span id="l1.118">       FeedCache.removeFeed(aFeed.url);</span>
<a href="#l1.119"></a><span id="l1.119">     }</span>
<a href="#l1.120"></a><span id="l1.120">   },</span>
<a href="#l1.121"></a><span id="l1.121"> </span>
<a href="#l1.122"></a><span id="l1.122" class="difflineat">@@ -348,31 +359,21 @@ Feed.prototype =</span>
<a href="#l1.123"></a><span id="l1.123">     if (old_link)</span>
<a href="#l1.124"></a><span id="l1.124">       ds.Change(this.resource, RSS_LINK, old_link, aNewLink);</span>
<a href="#l1.125"></a><span id="l1.125">     else</span>
<a href="#l1.126"></a><span id="l1.126">       ds.Assert(this.resource, RSS_LINK, aNewLink, true);</span>
<a href="#l1.127"></a><span id="l1.127">   },</span>
<a href="#l1.128"></a><span id="l1.128"> </span>
<a href="#l1.129"></a><span id="l1.129">   parse: function() </span>
<a href="#l1.130"></a><span id="l1.130">   {</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineminus">-    // Figures out what description language (RSS, Atom) and version this feed</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineminus">-    // is using and calls a language/version-specific feed parser.</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineminus">-</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineminus">-    debug(&quot;parsing feed &quot; + this.url);</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineminus">-</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineminus">-    if (!this.request.responseText) </span>
<a href="#l1.137"></a><span id="l1.137" class="difflineminus">-    {</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-      this.onParseError(this);</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineminus">-      return;</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineminus">-    }</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineminus">-      </span>
<a href="#l1.142"></a><span id="l1.142" class="difflineminus">-    // create a feed parser which will parse the feed for us</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+    // Create a feed parser which will parse the feed.</span>
<a href="#l1.144"></a><span id="l1.144">     var parser = new FeedParser();</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineminus">-    this.itemsToStore = parser.parseFeed(this, this.request.responseText, this.request.responseXML, this.request.channel.URI);</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineminus">-  </span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+    this.itemsToStore = parser.parseFeed(this,</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+                                         this.request.responseXML,</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+                                         this.request.channel.URI);</span>
<a href="#l1.150"></a><span id="l1.150">     if (this.mInvalidFeed)</span>
<a href="#l1.151"></a><span id="l1.151">     {</span>
<a href="#l1.152"></a><span id="l1.152">       this.request = null;</span>
<a href="#l1.153"></a><span id="l1.153">       this.mInvalidFeed = false;</span>
<a href="#l1.154"></a><span id="l1.154">       return;</span>
<a href="#l1.155"></a><span id="l1.155">     }</span>
<a href="#l1.156"></a><span id="l1.156"> </span>
<a href="#l1.157"></a><span id="l1.157">     // storeNextItem will iterate through the parsed items, storing each one.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/feed-parser.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/feed-parser.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -44,21 +44,23 @@ var gIOService = Components.classes[&quot;@mo</span>
<a href="#l2.4"></a><span id="l2.4"> function FeedParser() </span>
<a href="#l2.5"></a><span id="l2.5"> {}</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> FeedParser.prototype = </span>
<a href="#l2.8"></a><span id="l2.8"> {</span>
<a href="#l2.9"></a><span id="l2.9">   // parseFeed returns an array of parsed items ready for processing</span>
<a href="#l2.10"></a><span id="l2.10">   // it is currently a synchronous operation. If there was an error parsing the feed, </span>
<a href="#l2.11"></a><span id="l2.11">   // parseFeed returns an empty feed in addition to calling aFeed.onParseError</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  parseFeed: function (aFeed, aSource, aDOM, aBaseURI)</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  parseFeed: function (aFeed, aDOM, aBaseURI)</span>
<a href="#l2.14"></a><span id="l2.14">   {</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-    if (!aSource || !(aDOM instanceof Components.interfaces.nsIDOMXMLDocument))</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+    if (!(aDOM instanceof Components.interfaces.nsIDOMXMLDocument) ||</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+        aDOM.documentElement.getElementsByTagNameNS(&quot;http://www.mozilla.org/newlayout/xml/parsererror.xml&quot;, &quot;parsererror&quot;)[0])</span>
<a href="#l2.18"></a><span id="l2.18">     {</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-      aFeed.onParseError(aFeed);   </span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+      // No xml doc or gecko caught a basic parsing error.</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+      aFeed.onParseError(aFeed);</span>
<a href="#l2.22"></a><span id="l2.22">       return new Array();</span>
<a href="#l2.23"></a><span id="l2.23">     }</span>
<a href="#l2.24"></a><span id="l2.24">     else if((aDOM.documentElement.namespaceURI == &quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;)</span>
<a href="#l2.25"></a><span id="l2.25">             &amp;&amp; (aDOM.documentElement.getElementsByTagNameNS(&quot;http://purl.org/rss/1.0/&quot;, &quot;channel&quot;)[0]))</span>
<a href="#l2.26"></a><span id="l2.26">     {</span>
<a href="#l2.27"></a><span id="l2.27">       debug(aFeed.url + &quot; is an RSS 1.x (RDF-based) feed&quot;);</span>
<a href="#l2.28"></a><span id="l2.28">       // aSource can be misencoded (XMLHttpRequest converts to UTF-8 by default), </span>
<a href="#l2.29"></a><span id="l2.29">       // but the DOM is almost always right because it uses the hints in the XML file.</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineat">@@ -73,17 +75,17 @@ FeedParser.prototype =</span>
<a href="#l2.31"></a><span id="l2.31">       debug(aFeed.url + &quot; is an Atom 0.3 feed&quot;);</span>
<a href="#l2.32"></a><span id="l2.32">       return this.parseAsAtom(aFeed, aDOM);</span>
<a href="#l2.33"></a><span id="l2.33">     }</span>
<a href="#l2.34"></a><span id="l2.34">     else if (aDOM.documentElement.namespaceURI == ATOM_IETF_NS)</span>
<a href="#l2.35"></a><span id="l2.35">     {</span>
<a href="#l2.36"></a><span id="l2.36">       debug(aFeed.url + &quot; is an IETF Atom feed&quot;);</span>
<a href="#l2.37"></a><span id="l2.37">       return this.parseAsAtomIETF(aFeed, aDOM);</span>
<a href="#l2.38"></a><span id="l2.38">     }</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-    else if (aSource.search(/&quot;http:\/\/my\.netscape\.com\/rdf\/simple\/0\.9\/&quot;/) != -1)</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+    else if (aDOM.documentElement.getElementsByTagNameNS(&quot;http://my.netscape.com/rdf/simple/0.9/&quot;, &quot;channel&quot;)[0])</span>
<a href="#l2.41"></a><span id="l2.41">     {</span>
<a href="#l2.42"></a><span id="l2.42">       debug(aFeed.url + &quot; is an 0.90 feed&quot;);</span>
<a href="#l2.43"></a><span id="l2.43">       return this.parseAsRSS2(aFeed, aDOM);</span>
<a href="#l2.44"></a><span id="l2.44">     }</span>
<a href="#l2.45"></a><span id="l2.45">     // XXX Explicitly check for RSS 2.0 instead of letting it be handled by the</span>
<a href="#l2.46"></a><span id="l2.46">     // default behavior (who knows, we may change the default at some point).</span>
<a href="#l2.47"></a><span id="l2.47">     else </span>
<a href="#l2.48"></a><span id="l2.48">     {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/utils.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/utils.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -203,18 +203,19 @@ var FeedUtils = {</span>
<a href="#l3.4"></a><span id="l3.4">         }</span>
<a href="#l3.5"></a><span id="l3.5">       }</span>
<a href="#l3.6"></a><span id="l3.6">     },</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8">     downloaded: function(feed, aErrorCode)</span>
<a href="#l3.9"></a><span id="l3.9">     {</span>
<a href="#l3.10"></a><span id="l3.10">       FeedUtils.log.debug(&quot;downloaded: &quot;+</span>
<a href="#l3.11"></a><span id="l3.11">                           (this.mSubscribeMode ? &quot;Subscribe &quot; : &quot;Update &quot;) +</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-                          &quot;feed:errorCode - &quot; +</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-                          feed.name+&quot; : &quot;+aErrorCode);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+                          &quot;errorCode:feed:folder - &quot; +</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+                          aErrorCode+&quot; : &quot;+feed.name+&quot; : &quot;+</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+                          (feed.folder ? feed.folder.filePath.path : &quot;null&quot;));</span>
<a href="#l3.17"></a><span id="l3.17">       if (this.mSubscribeMode)</span>
<a href="#l3.18"></a><span id="l3.18">       {</span>
<a href="#l3.19"></a><span id="l3.19">         if (aErrorCode == FeedUtils.kNewsBlogSuccess)</span>
<a href="#l3.20"></a><span id="l3.20">         {</span>
<a href="#l3.21"></a><span id="l3.21">           // If we get here we should always have a folder by now, either in</span>
<a href="#l3.22"></a><span id="l3.22">           // feed.folder or FeedItems created the folder for us.</span>
<a href="#l3.23"></a><span id="l3.23">           updateFolderFeedUrl(feed.folder, feed.url, false);</span>
<a href="#l3.24"></a><span id="l3.24"> </span>
<a href="#l3.25"></a><span id="l3.25" class="difflineat">@@ -243,29 +244,43 @@ var FeedUtils = {</span>
<a href="#l3.26"></a><span id="l3.26">         }</span>
<a href="#l3.27"></a><span id="l3.27">       }</span>
<a href="#l3.28"></a><span id="l3.28"> </span>
<a href="#l3.29"></a><span id="l3.29">       if (feed.folder &amp;&amp; aErrorCode != FeedUtils.kNewsBlogFeedIsBusy)</span>
<a href="#l3.30"></a><span id="l3.30">         // Free msgDatabase after new mail biff is set; if busy let the next</span>
<a href="#l3.31"></a><span id="l3.31">         // result do the freeing.  Otherwise new messages won't be indicated.</span>
<a href="#l3.32"></a><span id="l3.32">         feed.folder.msgDatabase = null;</span>
<a href="#l3.33"></a><span id="l3.33"> </span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+      let message = &quot;&quot;;</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+      switch (aErrorCode) {</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+        case FeedUtils.kNewsBlogSuccess:</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+        case FeedUtils.kNewsBlogFeedIsBusy:</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+          break;</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+        case FeedUtils.kNewsBlogNoNewItems:</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+          message = feed.url+&quot;. &quot; +</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+                    FeedUtils.strings.GetStringFromName(</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+                      &quot;newsblog-noNewArticlesForFeed&quot;);</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+          break;</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+        case FeedUtils.kNewsBlogInvalidFeed:</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+          message = FeedUtils.strings.formatStringFromName(</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+                      &quot;newsblog-feedNotValid&quot;, [feed.url], 1);</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+          break;</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+        case FeedUtils.kNewsBlogRequestFailure:</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+          message = FeedUtils.strings.formatStringFromName(</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+                      &quot;newsblog-networkError&quot;, [feed.url], 1);</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+          break;</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+      }</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+      if (message)</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+        FeedUtils.log.info(&quot;downloaded: &quot;+</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+                           (this.mSubscribeMode ? &quot;Subscribe &quot; : &quot;Update &quot;) +</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+                           message);</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+</span>
<a href="#l3.58"></a><span id="l3.58">       if (this.mStatusFeedback)</span>
<a href="#l3.59"></a><span id="l3.59">       {</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-        if (aErrorCode == FeedUtils.kNewsBlogNoNewItems)</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-          this.mStatusFeedback.showStatusString(</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-            FeedUtils.strings.GetStringFromName(&quot;newsblog-noNewArticlesForFeed&quot;));</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-        else if (aErrorCode == FeedUtils.kNewsBlogInvalidFeed)</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-          this.mStatusFeedback.showStatusString(</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-            FeedUtils.strings.formatStringFromName(&quot;newsblog-feedNotValid&quot;,</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-                                                   [feed.url], 1));</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-        else if (aErrorCode == FeedUtils.kNewsBlogRequestFailure)</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-          this.mStatusFeedback.showStatusString(</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-            FeedUtils.strings.formatStringFromName(&quot;newsblog-networkError&quot;,</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-                                                   [feed.url], 1));</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+        this.mStatusFeedback.showStatusString(message);</span>
<a href="#l3.72"></a><span id="l3.72">         this.mStatusFeedback.stopMeteors();</span>
<a href="#l3.73"></a><span id="l3.73">       }</span>
<a href="#l3.74"></a><span id="l3.74"> </span>
<a href="#l3.75"></a><span id="l3.75">       if (!--this.mNumPendingFeedDownloads)</span>
<a href="#l3.76"></a><span id="l3.76">       {</span>
<a href="#l3.77"></a><span id="l3.77">         this.mFeeds = {};</span>
<a href="#l3.78"></a><span id="l3.78">         this.mSubscribeMode = false;</span>
<a href="#l3.79"></a><span id="l3.79"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/extensions/newsblog/js/newsblog.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/js/newsblog.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -72,46 +72,59 @@ var nsNewsBlogFeedDownloader =</span>
<a href="#l4.4"></a><span id="l4.4">     // Add the base folder; it does not get added by ListDescendents.</span>
<a href="#l4.5"></a><span id="l4.5">     allFolders.AppendElement(aFolder);</span>
<a href="#l4.6"></a><span id="l4.6">     aFolder.ListDescendents(allFolders);</span>
<a href="#l4.7"></a><span id="l4.7">     let numFolders = allFolders.Count();</span>
<a href="#l4.8"></a><span id="l4.8">     let trashFolder =</span>
<a href="#l4.9"></a><span id="l4.9">         aFolder.rootFolder.getFolderWithFlags(Ci.nsMsgFolderFlags.Trash);</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11">     function feeder() {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+      let folder;</span>
<a href="#l4.13"></a><span id="l4.13">       for (let i = 0; i &lt; numFolders; i++) {</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-        let folder = allFolders.GetElementAt(i).QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+        folder = allFolders.GetElementAt(i).QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l4.16"></a><span id="l4.16">         FeedUtils.log.debug(&quot;downloadFeed: START x/# foldername:uri - &quot;+</span>
<a href="#l4.17"></a><span id="l4.17">                             (i+1)+&quot;/&quot;+ numFolders+&quot; &quot;+</span>
<a href="#l4.18"></a><span id="l4.18">                             folder.name+&quot;:&quot;+folder.URI);</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+        // Ensure msgDatabase for the folder is open for new message processing.</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+        let msgDb;</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+        try {</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+          msgDb = folder.msgDatabase;</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+        }</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+        catch (ex) {}</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+        if (!msgDb) {</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+          // Force a reparse.  After the async reparse the folder will be ready</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+          // for the next cycle; don't bother with a listener.  Continue with</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+          // the next folder, as attempting to add a message to a folder with</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+          // an unavailable msgDatabase will throw later.</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+          FeedUtils.log.debug(&quot;downloadFeed: rebuild msgDatabase for &quot;+</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+                              folder.name+&quot; - &quot;+folder.filePath.path);</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+          try</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+          {</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+            // Ignore error returns.</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+            folder.QueryInterface(Ci.nsIMsgLocalMailFolder).</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+                   getDatabaseWithReparse(null, null);</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+          }</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+          catch (ex) {}</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+          continue;</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+        }</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+</span>
<a href="#l4.43"></a><span id="l4.43">         let feedUrlArray = getFeedUrlsInFolder(folder);</span>
<a href="#l4.44"></a><span id="l4.44">         // Continue if there are no feedUrls for the folder in the feeds</span>
<a href="#l4.45"></a><span id="l4.45">         // database.  All folders in Trash are now unsubscribed, so perhaps</span>
<a href="#l4.46"></a><span id="l4.46">         // we may not want to check that here each biff each folder.</span>
<a href="#l4.47"></a><span id="l4.47">         if (!feedUrlArray ||</span>
<a href="#l4.48"></a><span id="l4.48">             (aFolder.isServer &amp;&amp; trashFolder &amp;&amp; trashFolder.isAncestorOf(folder)))</span>
<a href="#l4.49"></a><span id="l4.49">           continue;</span>
<a href="#l4.50"></a><span id="l4.50"> </span>
<a href="#l4.51"></a><span id="l4.51">         FeedUtils.log.debug(&quot;downloadFeed: CONTINUE foldername:urlArray - &quot;+</span>
<a href="#l4.52"></a><span id="l4.52">                             folder.name+&quot;:&quot;+feedUrlArray);</span>
<a href="#l4.53"></a><span id="l4.53"> </span>
<a href="#l4.54"></a><span id="l4.54">         FeedUtils.progressNotifier.init(aMsgWindow, false);</span>
<a href="#l4.55"></a><span id="l4.55"> </span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-        // Ensure msgDatabase for the folder is open for new message processing.</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-        let msgDb;</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineminus">-        try {</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-          msgDb = aFolder.msgDatabase;</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-        }</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-        catch (ex) {}</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineminus">-        if (!msgDb) {</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineminus">-          // Forcing a reparse with listener here is the last resort.  This is</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineminus">-          // not implemented; it is currently not done and may be unnecessary</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineminus">-          // given other msgDatabase sync fixes.</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-        }</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-</span>
<a href="#l4.68"></a><span id="l4.68">         // We need to kick off a download for each feed.</span>
<a href="#l4.69"></a><span id="l4.69">         let id, feed;</span>
<a href="#l4.70"></a><span id="l4.70">         for (let url in feedUrlArray)</span>
<a href="#l4.71"></a><span id="l4.71">         {</span>
<a href="#l4.72"></a><span id="l4.72">           if (feedUrlArray[url])</span>
<a href="#l4.73"></a><span id="l4.73">           {</span>
<a href="#l4.74"></a><span id="l4.74">             id = rdf.GetResource(feedUrlArray[url]);</span>
<a href="#l4.75"></a><span id="l4.75">             feed = new Feed(id, folder.server);</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineat">@@ -122,34 +135,48 @@ var nsNewsBlogFeedDownloader =</span>
<a href="#l4.77"></a><span id="l4.77">             FeedUtils.log.debug(&quot;downloadFeed: DOWNLOAD feed url - &quot;+</span>
<a href="#l4.78"></a><span id="l4.78">                                 feedUrlArray[url]);</span>
<a href="#l4.79"></a><span id="l4.79">           }</span>
<a href="#l4.80"></a><span id="l4.80"> </span>
<a href="#l4.81"></a><span id="l4.81">           Services.tm.mainThread.dispatch(function() {</span>
<a href="#l4.82"></a><span id="l4.82">             try {</span>
<a href="#l4.83"></a><span id="l4.83">               getFeed.next();</span>
<a href="#l4.84"></a><span id="l4.84">             }</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineminus">-            catch (ex if ex instanceof StopIteration) {</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineminus">-              // Finished with all feeds in base folder and its subfolders.</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineminus">-              FeedUtils.log.debug(&quot;downloadFeed: StopIteration&quot;);</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+            catch (ex) {</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+              if (ex instanceof StopIteration)</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+                // Finished with all feeds in base folder and its subfolders.</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+                FeedUtils.log.debug(&quot;downloadFeed: Finished with folder - &quot;+</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+                                    aFolder.name);</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+              else</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+              {</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+                FeedUtils.log.error(&quot;downloadFeed: error - &quot; + ex);</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+                FeedUtils.progressNotifier.downloaded({name: folder.name}, 0);</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+              }</span>
<a href="#l4.98"></a><span id="l4.98">             }</span>
<a href="#l4.99"></a><span id="l4.99">           }, Ci.nsIThread.DISPATCH_NORMAL);</span>
<a href="#l4.100"></a><span id="l4.100"> </span>
<a href="#l4.101"></a><span id="l4.101">           yield;</span>
<a href="#l4.102"></a><span id="l4.102">         }</span>
<a href="#l4.103"></a><span id="l4.103">       }</span>
<a href="#l4.104"></a><span id="l4.104">     }</span>
<a href="#l4.105"></a><span id="l4.105"> </span>
<a href="#l4.106"></a><span id="l4.106">     let getFeed = feeder();</span>
<a href="#l4.107"></a><span id="l4.107">     try {</span>
<a href="#l4.108"></a><span id="l4.108">       getFeed.next();</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineminus">-    } </span>
<a href="#l4.110"></a><span id="l4.110" class="difflineminus">-    catch (ex if ex instanceof StopIteration) {</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineminus">-      // Nothing to do.</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineminus">-      FeedUtils.log.debug(&quot;downloadFeed: Nothing to do&quot;);</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+    }</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+    catch (ex) {</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+      if (ex instanceof StopIteration)</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+        // Nothing to do.</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+        FeedUtils.log.debug(&quot;downloadFeed: Nothing to do in folder - &quot;+</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+                            aFolder.name);</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+      else</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+      {</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+        FeedUtils.log.error(&quot;downloadFeed: error - &quot; + ex);</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+        FeedUtils.progressNotifier.downloaded({name: aFolder.name}, 0);</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+      }</span>
<a href="#l4.124"></a><span id="l4.124">     }</span>
<a href="#l4.125"></a><span id="l4.125">   },</span>
<a href="#l4.126"></a><span id="l4.126"> </span>
<a href="#l4.127"></a><span id="l4.127">   subscribeToFeed: function(aUrl, aFolder, aMsgWindow)</span>
<a href="#l4.128"></a><span id="l4.128">   {</span>
<a href="#l4.129"></a><span id="l4.129">     if (!gExternalScriptsLoaded)</span>
<a href="#l4.130"></a><span id="l4.130">       loadScripts();</span>
<a href="#l4.131"></a><span id="l4.131"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

