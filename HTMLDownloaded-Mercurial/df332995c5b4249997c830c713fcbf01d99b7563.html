<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 11703:df332995c5b4249997c830c713fcbf01d99b7563</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ df332995c5b4249997c830c713fcbf01d99b7563" />
<meta property="og:url" content="/comm-central/rev/df332995c5b4249997c830c713fcbf01d99b7563" />
<meta property="og:description" content="Bug 795152 - Switch to Services.jsm: What's left: message views. r=squib" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / df332995c5b4249997c830c713fcbf01d99b7563 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/df332995c5b4249997c830c713fcbf01d99b7563">shortlog</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/df332995c5b4249997c830c713fcbf01d99b7563">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563">files</a> |
changeset |
<a href="/comm-central/raw-rev/df332995c5b4249997c830c713fcbf01d99b7563">raw</a>  | <a href="/comm-central/archive/df332995c5b4249997c830c713fcbf01d99b7563.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=795152">Bug 795152</a> - Switch to Services.jsm: What's left: message views. r=squib
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#83;&#101;&#98;&#97;&#115;&#116;&#105;&#97;&#110;&#32;&#72;&#101;&#110;&#103;&#115;&#116;&#32;&#60;&#97;&#114;&#99;&#104;&#97;&#101;&#111;&#112;&#116;&#101;&#114;&#121;&#120;&#64;&#99;&#111;&#111;&#108;&#101;&#45;&#102;&#105;&#108;&#101;&#115;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 14 Dec 2012 17:48:35 +0100</td></tr>

<tr>
 <td>changeset 11703</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/df332995c5b4249997c830c713fcbf01d99b7563">df332995c5b4249997c830c713fcbf01d99b7563</a></td>
</tr>



<tr>
<td>parent 11702</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4379140e4ffc8578ab682619493561765e02f230">4379140e4ffc8578ab682619493561765e02f230</a>
</td>
</tr>

<tr>
<td>child 11704</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/880f9d2706e0df4950efb5b352b021a3b1241149">880f9d2706e0df4950efb5b352b021a3b1241149</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=df332995c5b4249997c830c713fcbf01d99b7563">8716</a></td></tr>
<tr><td>push user</td><td>ryanvm@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 17 Dec 2012 00:04:04 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a6e24ded8c28 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a6e24ded8c28130c9659f47a74bc193478e756af">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a6e24ded8c28130c9659f47a74bc193478e756af&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a6e24ded8c28130c9659f47a74bc193478e756af&newProject=comm-central&newRevision=79a73f336716eb9b780cbe4627d9f6fc981b48f9&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a6e24ded8c28130c9659f47a74bc193478e756af&newProject=comm-central&newRevision=79a73f336716eb9b780cbe4627d9f6fc981b48f9&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a6e24ded8c28130c9659f47a74bc193478e756af&newProject=comm-central&newRevision=79a73f336716eb9b780cbe4627d9f6fc981b48f9&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28squib%29&revcount=50">squib</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=795152">795152</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=795152">Bug 795152</a> - Switch to Services.jsm: What's left: message views. r=squib</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/aboutDialog.js">mail/base/content/aboutDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/aboutDialog.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/aboutDialog.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/aboutDialog.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/aboutDialog.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/aboutDialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/commandglue.js">mail/base/content/commandglue.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/commandglue.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/commandglue.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/commandglue.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/commandglue.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/commandglue.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/contentAreaClick.js">mail/base/content/contentAreaClick.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/contentAreaClick.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/contentAreaClick.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/contentAreaClick.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/contentAreaClick.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/contentAreaClick.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/editContactOverlay.js">mail/base/content/editContactOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/editContactOverlay.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/editContactOverlay.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/editContactOverlay.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/editContactOverlay.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/editContactOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/folderDisplay.js">mail/base/content/folderDisplay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/folderDisplay.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/folderDisplay.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/folderDisplay.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/folderDisplay.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/folderDisplay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/folderPane.js">mail/base/content/folderPane.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/folderPane.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/folderPane.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/folderPane.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/folderPane.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/folderPane.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mail-offline.js">mail/base/content/mail-offline.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mail-offline.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mail-offline.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mail-offline.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mail-offline.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mail-offline.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mail3PaneWindowCommands.js">mail/base/content/mail3PaneWindowCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mail3PaneWindowCommands.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mail3PaneWindowCommands.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mail3PaneWindowCommands.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mail3PaneWindowCommands.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mail3PaneWindowCommands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mailContextMenus.js">mail/base/content/mailContextMenus.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mailContextMenus.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mailContextMenus.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mailContextMenus.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mailContextMenus.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mailContextMenus.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mailTabs.js">mail/base/content/mailTabs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mailTabs.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mailTabs.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mailTabs.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mailTabs.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mailTabs.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mailWidgets.xml">mail/base/content/mailWidgets.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mailWidgets.xml">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mailWidgets.xml">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mailWidgets.xml">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mailWidgets.xml">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mailWidgets.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mailWindow.js">mail/base/content/mailWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mailWindow.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mailWindow.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mailWindow.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mailWindow.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mailWindow.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mailWindowOverlay.js">mail/base/content/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/mailWindowOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/messageDisplay.js">mail/base/content/messageDisplay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/messageDisplay.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/messageDisplay.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/messageDisplay.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/messageDisplay.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/messageDisplay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/messageWindow.js">mail/base/content/messageWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/messageWindow.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/messageWindow.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/messageWindow.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/messageWindow.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/messageWindow.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/msgHdrViewOverlay.js">mail/base/content/msgHdrViewOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/msgHdrViewOverlay.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/msgHdrViewOverlay.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/msgHdrViewOverlay.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/msgHdrViewOverlay.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/msgHdrViewOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/msgMail3PaneWindow.js">mail/base/content/msgMail3PaneWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/msgMail3PaneWindow.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/msgMail3PaneWindow.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/msgMail3PaneWindow.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/msgMail3PaneWindow.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/msgMail3PaneWindow.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/msgViewNavigation.js">mail/base/content/msgViewNavigation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/msgViewNavigation.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/msgViewNavigation.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/msgViewNavigation.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/msgViewNavigation.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/msgViewNavigation.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/newTagDialog.js">mail/base/content/newTagDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/newTagDialog.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/newTagDialog.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/newTagDialog.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/newTagDialog.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/newTagDialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/newmailalert.js">mail/base/content/newmailalert.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/newmailalert.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/newmailalert.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/newmailalert.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/newmailalert.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/newmailalert.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/nsContextMenu.js">mail/base/content/nsContextMenu.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/nsContextMenu.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/nsContextMenu.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/nsContextMenu.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/nsContextMenu.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/nsContextMenu.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/phishingDetector.js">mail/base/content/phishingDetector.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/phishingDetector.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/phishingDetector.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/phishingDetector.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/phishingDetector.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/phishingDetector.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/plugins.js">mail/base/content/plugins.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/plugins.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/plugins.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/plugins.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/plugins.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/plugins.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/safeMode.js">mail/base/content/safeMode.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/safeMode.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/safeMode.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/safeMode.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/safeMode.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/safeMode.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/search.xml">mail/base/content/search.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/search.xml">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/search.xml">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/search.xml">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/search.xml">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/search.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/specialTabs.js">mail/base/content/specialTabs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/specialTabs.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/specialTabs.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/specialTabs.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/specialTabs.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/specialTabs.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/tabmail.xml">mail/base/content/tabmail.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/tabmail.xml">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/tabmail.xml">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/tabmail.xml">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/tabmail.xml">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/tabmail.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/threadPane.js">mail/base/content/threadPane.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/threadPane.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/threadPane.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/threadPane.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/threadPane.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/threadPane.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/threadPaneColumnPicker.xml">mail/base/content/threadPaneColumnPicker.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/threadPaneColumnPicker.xml">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/threadPaneColumnPicker.xml">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/threadPaneColumnPicker.xml">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/threadPaneColumnPicker.xml">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/threadPaneColumnPicker.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/utilityOverlay.js">mail/base/content/utilityOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/utilityOverlay.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/utilityOverlay.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/utilityOverlay.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/utilityOverlay.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/base/content/utilityOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/components/about-support/content/export.js">mail/components/about-support/content/export.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/components/about-support/content/export.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/components/about-support/content/export.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/components/about-support/content/export.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/components/about-support/content/export.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/components/about-support/content/export.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/components/about-support/content/gfx.js">mail/components/about-support/content/gfx.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/components/about-support/content/gfx.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/components/about-support/content/gfx.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/components/about-support/content/gfx.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/components/about-support/content/gfx.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/components/about-support/content/gfx.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/components/about-support/content/prefs.js">mail/components/about-support/content/prefs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/components/about-support/content/prefs.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/components/about-support/content/prefs.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/components/about-support/content/prefs.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/components/about-support/content/prefs.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/components/about-support/content/prefs.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/extensions/mailviews/content/mailViewList.js">mail/extensions/mailviews/content/mailViewList.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mail/extensions/mailviews/content/mailViewList.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mail/extensions/mailviews/content/mailViewList.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mail/extensions/mailviews/content/mailViewList.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mail/extensions/mailviews/content/mailViewList.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mail/extensions/mailviews/content/mailViewList.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mailnews/base/content/junkCommands.js">mailnews/base/content/junkCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/df332995c5b4249997c830c713fcbf01d99b7563/mailnews/base/content/junkCommands.js">file</a> |
<a href="/comm-central/annotate/df332995c5b4249997c830c713fcbf01d99b7563/mailnews/base/content/junkCommands.js">annotate</a> |
<a href="/comm-central/diff/df332995c5b4249997c830c713fcbf01d99b7563/mailnews/base/content/junkCommands.js">diff</a> |
<a href="/comm-central/comparison/df332995c5b4249997c830c713fcbf01d99b7563/mailnews/base/content/junkCommands.js">comparison</a> |
<a href="/comm-central/log/df332995c5b4249997c830c713fcbf01d99b7563/mailnews/base/content/junkCommands.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/aboutDialog.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/aboutDialog.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -56,19 +56,17 @@ function init(aEvent)</span>
<a href="#l1.4"></a><span id="l1.4"> }</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> // This function is used to open about: tabs. The caller should ensure the url</span>
<a href="#l1.7"></a><span id="l1.7"> // is only an about: url.</span>
<a href="#l1.8"></a><span id="l1.8"> function openAboutTab(url)</span>
<a href="#l1.9"></a><span id="l1.9"> {</span>
<a href="#l1.10"></a><span id="l1.10">   let tabmail;</span>
<a href="#l1.11"></a><span id="l1.11">   // Check existing windows</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  let mailWindow = Components.classes[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-                             .getService(Components.interfaces.nsIWindowMediator)</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-                             .getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+  let mailWindow = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l1.16"></a><span id="l1.16">   if (mailWindow) {</span>
<a href="#l1.17"></a><span id="l1.17">     mailWindow.focus();</span>
<a href="#l1.18"></a><span id="l1.18">     mailWindow.document.getElementById(&quot;tabmail&quot;)</span>
<a href="#l1.19"></a><span id="l1.19">               .openTab(&quot;contentTab&quot;, {contentPage: url,</span>
<a href="#l1.20"></a><span id="l1.20">                                       clickHandler: &quot;specialTabs.aboutClickHandler(event);&quot;});</span>
<a href="#l1.21"></a><span id="l1.21">     return;</span>
<a href="#l1.22"></a><span id="l1.22">   }</span>
<a href="#l1.23"></a><span id="l1.23"> </span>
<a href="#l1.24"></a><span id="l1.24" class="difflineat">@@ -286,20 +284,18 @@ appUpdater.prototype =</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26">       // If already in safe mode restart in safe mode (bug 327119)</span>
<a href="#l1.27"></a><span id="l1.27">       if (Services.appinfo.inSafeMode) {</span>
<a href="#l1.28"></a><span id="l1.28">         let env = Components.classes[&quot;@mozilla.org/process/environment;1&quot;].</span>
<a href="#l1.29"></a><span id="l1.29">                   getService(Components.interfaces.nsIEnvironment);</span>
<a href="#l1.30"></a><span id="l1.30">         env.set(&quot;MOZ_SAFE_MODE_RESTART&quot;, &quot;1&quot;);</span>
<a href="#l1.31"></a><span id="l1.31">       }</span>
<a href="#l1.32"></a><span id="l1.32"> </span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-      Components.classes[&quot;@mozilla.org/toolkit/app-startup;1&quot;].</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-      getService(Components.interfaces.nsIAppStartup).</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-      quit(Components.interfaces.nsIAppStartup.eAttemptQuit |</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-           Components.interfaces.nsIAppStartup.eRestart);</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+      Services.startup.quit(Components.interfaces.nsIAppStartup.eAttemptQuit |</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+                            Components.interfaces.nsIAppStartup.eRestart);</span>
<a href="#l1.39"></a><span id="l1.39">       return;</span>
<a href="#l1.40"></a><span id="l1.40">     }</span>
<a href="#l1.41"></a><span id="l1.41"> </span>
<a href="#l1.42"></a><span id="l1.42">     const URI_UPDATE_PROMPT_DIALOG = &quot;chrome://mozapps/content/update/updates.xul&quot;;</span>
<a href="#l1.43"></a><span id="l1.43">     // Thunderbird no longer displays a license for updates and the licenseURL check</span>
<a href="#l1.44"></a><span id="l1.44">     // is just in case a distibution does.</span>
<a href="#l1.45"></a><span id="l1.45">     if (this.update &amp;&amp; (this.update.billboardURL || this.update.licenseURL ||</span>
<a href="#l1.46"></a><span id="l1.46">         this.addons.length != 0)) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/commandglue.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/commandglue.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -2,31 +2,31 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.5"></a><span id="l2.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> /*</span>
<a href="#l2.8"></a><span id="l2.8">  * Command-specific code. This stuff should be called by the widgets</span>
<a href="#l2.9"></a><span id="l2.9">  */</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11"> Components.utils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l2.13"></a><span id="l2.13"> </span>
<a href="#l2.14"></a><span id="l2.14"> function UpdateMailToolbar(caller)</span>
<a href="#l2.15"></a><span id="l2.15"> {</span>
<a href="#l2.16"></a><span id="l2.16">   // If we have a transient selection, we shouldn't update the toolbar. We'll</span>
<a href="#l2.17"></a><span id="l2.17">   // update it once we've restored the original selection.</span>
<a href="#l2.18"></a><span id="l2.18">   if (&quot;gRightMouseButtonSavedSelection&quot; in window &amp;&amp;</span>
<a href="#l2.19"></a><span id="l2.19">       gRightMouseButtonSavedSelection)</span>
<a href="#l2.20"></a><span id="l2.20">     return;</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22">   //dump(&quot;XXX update mail-toolbar &quot; + caller + &quot;\n&quot;);</span>
<a href="#l2.23"></a><span id="l2.23">   document.commandDispatcher.updateCommands('mail-toolbar');</span>
<a href="#l2.24"></a><span id="l2.24"> </span>
<a href="#l2.25"></a><span id="l2.25">   // hook for extra toolbar items</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-  var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;].getService(Components.interfaces.nsIObserverService);</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-  observerService.notifyObservers(window, &quot;mail:updateToolbarItems&quot;, null);</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+  Services.obs.notifyObservers(window, &quot;mail:updateToolbarItems&quot;, null);</span>
<a href="#l2.29"></a><span id="l2.29"> }</span>
<a href="#l2.30"></a><span id="l2.30"> </span>
<a href="#l2.31"></a><span id="l2.31"> function isNewsURI(uri)</span>
<a href="#l2.32"></a><span id="l2.32"> {</span>
<a href="#l2.33"></a><span id="l2.33">     if (!uri || uri[0] != 'n') {</span>
<a href="#l2.34"></a><span id="l2.34">         return false;</span>
<a href="#l2.35"></a><span id="l2.35">     }</span>
<a href="#l2.36"></a><span id="l2.36">     else {</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineat">@@ -136,19 +136,19 @@ function UpdateStatusQuota(folder)</span>
<a href="#l2.38"></a><span id="l2.38">   // get element references and prefs</span>
<a href="#l2.39"></a><span id="l2.39">   if (typeof(gQuotaUICache) != &quot;object&quot;)</span>
<a href="#l2.40"></a><span id="l2.40">   {</span>
<a href="#l2.41"></a><span id="l2.41">     gQuotaUICache = new Object();</span>
<a href="#l2.42"></a><span id="l2.42">     gQuotaUICache.meter = document.getElementById(&quot;quotaMeter&quot;);</span>
<a href="#l2.43"></a><span id="l2.43">     gQuotaUICache.panel = document.getElementById(&quot;quotaPanel&quot;);</span>
<a href="#l2.44"></a><span id="l2.44">     gQuotaUICache.label = document.getElementById(&quot;quotaLabel&quot;);</span>
<a href="#l2.45"></a><span id="l2.45">     const kBranch = &quot;mail.quota.mainwindow_threshold.&quot;;</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-    gQuotaUICache.showTreshold = gPrefBranch.getIntPref(kBranch + &quot;show&quot;);</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-    gQuotaUICache.warningTreshold = gPrefBranch.getIntPref(kBranch + &quot;warning&quot;);</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-    gQuotaUICache.criticalTreshold = gPrefBranch.getIntPref(kBranch + &quot;critical&quot;);</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+    gQuotaUICache.showTreshold = Services.prefs.getIntPref(kBranch + &quot;show&quot;);</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+    gQuotaUICache.warningTreshold = Services.prefs.getIntPref(kBranch + &quot;warning&quot;);</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+    gQuotaUICache.criticalTreshold = Services.prefs.getIntPref(kBranch + &quot;critical&quot;);</span>
<a href="#l2.52"></a><span id="l2.52">   }</span>
<a href="#l2.53"></a><span id="l2.53"> </span>
<a href="#l2.54"></a><span id="l2.54">   var valid = {value: null};</span>
<a href="#l2.55"></a><span id="l2.55">   var used = {value: null};</span>
<a href="#l2.56"></a><span id="l2.56">   var max = {value: null};</span>
<a href="#l2.57"></a><span id="l2.57">   try {</span>
<a href="#l2.58"></a><span id="l2.58">     // get data from backend</span>
<a href="#l2.59"></a><span id="l2.59">     folder.getQuota(valid, used, max);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/contentAreaClick.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/contentAreaClick.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -5,16 +5,19 @@</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5">   /**</span>
<a href="#l3.6"></a><span id="l3.6">    * Extract the href from the link click event.</span>
<a href="#l3.7"></a><span id="l3.7">    * We look for HTMLAnchorElement, HTMLAreaElement, HTMLLinkElement,</span>
<a href="#l3.8"></a><span id="l3.8">    * HTMLInputElement.form.action, and nested anchor tags.</span>
<a href="#l3.9"></a><span id="l3.9">    *</span>
<a href="#l3.10"></a><span id="l3.10">    * @return href for the url being clicked</span>
<a href="#l3.11"></a><span id="l3.11">    */</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+</span>
<a href="#l3.15"></a><span id="l3.15">   function hRefForClickEvent(aEvent, aDontCheckInputElement)</span>
<a href="#l3.16"></a><span id="l3.16">   {</span>
<a href="#l3.17"></a><span id="l3.17">     var href;</span>
<a href="#l3.18"></a><span id="l3.18">     var isKeyCommand = (aEvent.type == &quot;command&quot;);</span>
<a href="#l3.19"></a><span id="l3.19">     var target =</span>
<a href="#l3.20"></a><span id="l3.20">       isKeyCommand ? document.commandDispatcher.focusedElement : aEvent.target;</span>
<a href="#l3.21"></a><span id="l3.21"> </span>
<a href="#l3.22"></a><span id="l3.22">     if (target instanceof HTMLAnchorElement ||</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineat">@@ -138,16 +141,14 @@ function contentAreaClick(aEvent)</span>
<a href="#l3.24"></a><span id="l3.24">  * service settings.</span>
<a href="#l3.25"></a><span id="l3.25">  *</span>
<a href="#l3.26"></a><span id="l3.26">  * @param url  A url string or an nsIURI containing the url to open.</span>
<a href="#l3.27"></a><span id="l3.27">  */</span>
<a href="#l3.28"></a><span id="l3.28"> function openLinkExternally(url)</span>
<a href="#l3.29"></a><span id="l3.29"> {</span>
<a href="#l3.30"></a><span id="l3.30">   let uri = url;</span>
<a href="#l3.31"></a><span id="l3.31">   if (!(uri instanceof Components.interfaces.nsIURI))</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-    uri = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-                    .getService(Components.interfaces.nsIIOService)</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-                    .newURI(url, null, null);</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+    uri = Services.io.newURI(url, null, null);</span>
<a href="#l3.36"></a><span id="l3.36"> </span>
<a href="#l3.37"></a><span id="l3.37">   Components.classes[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;]</span>
<a href="#l3.38"></a><span id="l3.38">             .getService(Components.interfaces.nsIExternalProtocolService)</span>
<a href="#l3.39"></a><span id="l3.39">             .loadUrl(uri);</span>
<a href="#l3.40"></a><span id="l3.40"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/base/content/editContactOverlay.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/base/content/editContactOverlay.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,13 +1,15 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l4.5"></a><span id="l4.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.6"></a><span id="l4.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.7"></a><span id="l4.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+</span>
<a href="#l4.11"></a><span id="l4.11"> var editContactInlineUI = {</span>
<a href="#l4.12"></a><span id="l4.12">   _overlayLoaded: false,</span>
<a href="#l4.13"></a><span id="l4.13">   _overlayLoading: false,</span>
<a href="#l4.14"></a><span id="l4.14">   _cardDetails: null,</span>
<a href="#l4.15"></a><span id="l4.15">   _writeable: true,</span>
<a href="#l4.16"></a><span id="l4.16">   _blockedCommands: [&quot;cmd_close&quot;],</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18">   _blockCommands: function () {</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineat">@@ -180,21 +182,19 @@ var editContactInlineUI = {</span>
<a href="#l4.20"></a><span id="l4.20">   deleteContact: function() {</span>
<a href="#l4.21"></a><span id="l4.21">     if (this._cardDetails.book.readOnly)</span>
<a href="#l4.22"></a><span id="l4.22">       return; /* double check we can delete this */</span>
<a href="#l4.23"></a><span id="l4.23"> </span>
<a href="#l4.24"></a><span id="l4.24">     /* hide before the dialog or the panel takes the first click */</span>
<a href="#l4.25"></a><span id="l4.25">     this.panel.hidePopup();</span>
<a href="#l4.26"></a><span id="l4.26"> </span>
<a href="#l4.27"></a><span id="l4.27">     var bundle = document.getElementById(&quot;bundle_editContact&quot;);</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-    if (!Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-                  .getService(Components.interfaces.nsIPromptService)</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-                  .confirm(window,</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-                            bundle.getString(&quot;deleteContactTitle&quot;),</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-                            bundle.getString(&quot;deleteContactMessage&quot;)))</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+    if (!Services.prompt.confirm(window,</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+                                 bundle.getString(&quot;deleteContactTitle&quot;),</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+                                 bundle.getString(&quot;deleteContactMessage&quot;)))</span>
<a href="#l4.36"></a><span id="l4.36">       return;  /* XXX would be nice to bring the popup back up here */</span>
<a href="#l4.37"></a><span id="l4.37"> </span>
<a href="#l4.38"></a><span id="l4.38">     let cardArray = Components.classes[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l4.39"></a><span id="l4.39">                               .createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l4.40"></a><span id="l4.40">     cardArray.appendElement(this._cardDetails.card, false);</span>
<a href="#l4.41"></a><span id="l4.41"> </span>
<a href="#l4.42"></a><span id="l4.42">     Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l4.43"></a><span id="l4.43">               .getService(Components.interfaces.nsIAbManager)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/base/content/folderDisplay.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/base/content/folderDisplay.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,14 +1,15 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.5"></a><span id="l5.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.6"></a><span id="l5.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> Components.utils.import(&quot;resource:///modules/dbViewWrapper.js&quot;);</span>
<a href="#l5.9"></a><span id="l5.9"> Components.utils.import(&quot;resource:///modules/jsTreeSelection.js&quot;);</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12"> var gFolderDisplay = null;</span>
<a href="#l5.13"></a><span id="l5.13"> var gMessageDisplay = null;</span>
<a href="#l5.14"></a><span id="l5.14"> </span>
<a href="#l5.15"></a><span id="l5.15"> var nsMsgFolderFlags = Components.interfaces.nsMsgFolderFlags;</span>
<a href="#l5.16"></a><span id="l5.16"> </span>
<a href="#l5.17"></a><span id="l5.17"> /**</span>
<a href="#l5.18"></a><span id="l5.18">  * Maintains a list of listeners for all FolderDisplayWidget instances in this</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineat">@@ -203,17 +204,17 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l5.20"></a><span id="l5.20">   /**</span>
<a href="#l5.21"></a><span id="l5.21">    * @return true if the selection should be summarized for this folder. This</span>
<a href="#l5.22"></a><span id="l5.22">    *     is based on the mail.operate_on_msgs_in_collapsed_threads pref and</span>
<a href="#l5.23"></a><span id="l5.23">    *     if we are in a newsgroup folder. XXX When bug 478167 is fixed, this</span>
<a href="#l5.24"></a><span id="l5.24">    *     should be limited to being disabled for newsgroups that are not stored</span>
<a href="#l5.25"></a><span id="l5.25">    *     offline.</span>
<a href="#l5.26"></a><span id="l5.26">    */</span>
<a href="#l5.27"></a><span id="l5.27">   get summarizeSelectionInFolder() {</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-    return gPrefBranch.getBoolPref(&quot;mail.operate_on_msgs_in_collapsed_threads&quot;) &amp;&amp;</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+    return Services.prefs.getBoolPref(&quot;mail.operate_on_msgs_in_collapsed_threads&quot;) &amp;&amp;</span>
<a href="#l5.30"></a><span id="l5.30">       !(this.displayedFolder instanceof Components.interfaces.nsIMsgNewsFolder);</span>
<a href="#l5.31"></a><span id="l5.31">   },</span>
<a href="#l5.32"></a><span id="l5.32"> </span>
<a href="#l5.33"></a><span id="l5.33">   /**</span>
<a href="#l5.34"></a><span id="l5.34">    * @return the nsITreeSelection object for our tree view.  This exists for</span>
<a href="#l5.35"></a><span id="l5.35">    *     the benefit of message tabs that haven't been switched to yet.</span>
<a href="#l5.36"></a><span id="l5.36">    *     We provide a fake tree selection in those cases.</span>
<a href="#l5.37"></a><span id="l5.37">    * @protected</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineat">@@ -785,33 +786,33 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l5.39"></a><span id="l5.39">    *  can occur.</span>
<a href="#l5.40"></a><span id="l5.40">    *</span>
<a href="#l5.41"></a><span id="l5.41">    * @return true if the folder should be shown immediately, false if we should</span>
<a href="#l5.42"></a><span id="l5.42">    *     wait for updateFolder to complete.</span>
<a href="#l5.43"></a><span id="l5.43">    */</span>
<a href="#l5.44"></a><span id="l5.44">   get shouldDeferMessageDisplayUntilAfterServerConnect() {</span>
<a href="#l5.45"></a><span id="l5.45">     let passwordPromptRequired = false;</span>
<a href="#l5.46"></a><span id="l5.46"> </span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-    if (gPrefBranch.getBoolPref(&quot;mail.password_protect_local_cache&quot;))</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+    if (Services.prefs.getBoolPref(&quot;mail.password_protect_local_cache&quot;))</span>
<a href="#l5.49"></a><span id="l5.49">       passwordPromptRequired =</span>
<a href="#l5.50"></a><span id="l5.50">         this.view.displayedFolder.server.passwordPromptRequired;</span>
<a href="#l5.51"></a><span id="l5.51"> </span>
<a href="#l5.52"></a><span id="l5.52">     return passwordPromptRequired;</span>
<a href="#l5.53"></a><span id="l5.53">   },</span>
<a href="#l5.54"></a><span id="l5.54"> </span>
<a href="#l5.55"></a><span id="l5.55">   /**</span>
<a href="#l5.56"></a><span id="l5.56">    * Let the viewWrapper know if it should mark the messages read when leaving</span>
<a href="#l5.57"></a><span id="l5.57">    *  the provided folder.</span>
<a href="#l5.58"></a><span id="l5.58">    *</span>
<a href="#l5.59"></a><span id="l5.59">    * @return true if the preference is set for the folder's server type.</span>
<a href="#l5.60"></a><span id="l5.60">    */</span>
<a href="#l5.61"></a><span id="l5.61">   shouldMarkMessagesReadOnLeavingFolder:</span>
<a href="#l5.62"></a><span id="l5.62">     function FolderDisplayWidget_crazyMarkOnReadChecker (aMsgFolder) {</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineminus">-      return gPrefBranch.getBoolPref(&quot;mailnews.mark_message_read.&quot; +</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">-                                     aMsgFolder.server.type);</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+      return Services.prefs.getBoolPref(&quot;mailnews.mark_message_read.&quot; +</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+                                        aMsgFolder.server.type);</span>
<a href="#l5.67"></a><span id="l5.67">   },</span>
<a href="#l5.68"></a><span id="l5.68"> </span>
<a href="#l5.69"></a><span id="l5.69">   /**</span>
<a href="#l5.70"></a><span id="l5.70">    * The view wrapper tells us when it starts loading a folder, and we set the</span>
<a href="#l5.71"></a><span id="l5.71">    *  cursor busy.  Setting the cursor busy on a per-tab basis is us being</span>
<a href="#l5.72"></a><span id="l5.72">    *  nice to the future. Loading a folder is a blocking operation that is going</span>
<a href="#l5.73"></a><span id="l5.73">    *  to make us unresponsive and accordingly make it very hard for the user to</span>
<a href="#l5.74"></a><span id="l5.74">    *  change tabs.</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineat">@@ -870,26 +871,22 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l5.76"></a><span id="l5.76"> </span>
<a href="#l5.77"></a><span id="l5.77">     // this creates a new selection object for the view.</span>
<a href="#l5.78"></a><span id="l5.78">     if (this.treeBox)</span>
<a href="#l5.79"></a><span id="l5.79">       this.treeBox.view = this.view.dbView;</span>
<a href="#l5.80"></a><span id="l5.80"> </span>
<a href="#l5.81"></a><span id="l5.81">     FolderDisplayListenerManager._fireListeners(&quot;onActiveCreatedView&quot;,</span>
<a href="#l5.82"></a><span id="l5.82">                                                 [this]);</span>
<a href="#l5.83"></a><span id="l5.83"> </span>
<a href="#l5.84"></a><span id="l5.84" class="difflineminus">-    let ObserverService =</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineminus">-      Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineminus">-                .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l5.87"></a><span id="l5.87">     // The data payload used to be viewType + &quot;:&quot; + viewFlags.  We no longer</span>
<a href="#l5.88"></a><span id="l5.88">     //  do this because we already have the implied contract that gDBView is</span>
<a href="#l5.89"></a><span id="l5.89">     //  valid at the time we generate the notification.  In such a case, you</span>
<a href="#l5.90"></a><span id="l5.90">     //  can easily get that information from the gDBView.  (The documentation</span>
<a href="#l5.91"></a><span id="l5.91">     //  on creating a custom column assumes gDBView.)</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineminus">-    ObserverService.notifyObservers(this.displayedFolder,</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineminus">-                                    &quot;MsgCreateDBView&quot;, &quot;&quot;);</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+    Services.obs.notifyObservers(this.displayedFolder, &quot;MsgCreateDBView&quot;, &quot;&quot;);</span>
<a href="#l5.95"></a><span id="l5.95">   },</span>
<a href="#l5.96"></a><span id="l5.96"> </span>
<a href="#l5.97"></a><span id="l5.97">   /**</span>
<a href="#l5.98"></a><span id="l5.98">    * If our view is being destroyed and it is coming back, we want to save the</span>
<a href="#l5.99"></a><span id="l5.99">    *  current selection so we can restore it when the view comes back.</span>
<a href="#l5.100"></a><span id="l5.100">    */</span>
<a href="#l5.101"></a><span id="l5.101">   onDestroyingView: function FolderDisplayWidget_onDestroyingView(</span>
<a href="#l5.102"></a><span id="l5.102">       aFolderIsComingBack) {</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineat">@@ -1051,26 +1048,26 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l5.104"></a><span id="l5.104">     //   first selected message and get out</span>
<a href="#l5.105"></a><span id="l5.105">     if (this.view.dbView.numSelected &gt; 0) {</span>
<a href="#l5.106"></a><span id="l5.106">       this.ensureRowIsVisible(this.view.dbView.viewIndexForFirstSelectedMsg);</span>
<a href="#l5.107"></a><span id="l5.107">       return;</span>
<a href="#l5.108"></a><span id="l5.108">     }</span>
<a href="#l5.109"></a><span id="l5.109"> </span>
<a href="#l5.110"></a><span id="l5.110">     // - new messages</span>
<a href="#l5.111"></a><span id="l5.111">     // if configured to scroll to new messages, try that</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineminus">-    if (gPrefBranch.getBoolPref(&quot;mailnews.scroll_to_new_message&quot;) &amp;&amp;</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+    if (Services.prefs.getBoolPref(&quot;mailnews.scroll_to_new_message&quot;) &amp;&amp;</span>
<a href="#l5.114"></a><span id="l5.114">         this.navigate(nsMsgNavigationType.firstNew, /* select */ false))</span>
<a href="#l5.115"></a><span id="l5.115">       return;</span>
<a href="#l5.116"></a><span id="l5.116"> </span>
<a href="#l5.117"></a><span id="l5.117">     // - last selected message</span>
<a href="#l5.118"></a><span id="l5.118">     // if configured to load the last selected message (this is currently more</span>
<a href="#l5.119"></a><span id="l5.119">     //  persistent than our saveSelection/restoreSelection stuff), and the view</span>
<a href="#l5.120"></a><span id="l5.120">     //  is backed by a single underlying folder (the only way having just a</span>
<a href="#l5.121"></a><span id="l5.121">     //  message key works out), try that</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineminus">-    if (gPrefBranch.getBoolPref(&quot;mailnews.remember_selected_message&quot;) &amp;&amp;</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+    if (Services.prefs.getBoolPref(&quot;mailnews.remember_selected_message&quot;) &amp;&amp;</span>
<a href="#l5.124"></a><span id="l5.124">         this.view.isSingleFolder) {</span>
<a href="#l5.125"></a><span id="l5.125">       // use the displayed folder; nsMsgDBView goes to the effort to save the</span>
<a href="#l5.126"></a><span id="l5.126">       //  state to the viewFolder, so this is the correct course of action.</span>
<a href="#l5.127"></a><span id="l5.127">       let lastLoadedMessageKey = this.view.displayedFolder.lastMessageLoaded;</span>
<a href="#l5.128"></a><span id="l5.128">       if (lastLoadedMessageKey != nsMsgKey_None) {</span>
<a href="#l5.129"></a><span id="l5.129">         this.view.dbView.selectMsgByKey(lastLoadedMessageKey);</span>
<a href="#l5.130"></a><span id="l5.130">         // The message key may not be present in the view for a variety of</span>
<a href="#l5.131"></a><span id="l5.131">         //  reasons.  Beyond message deletion, it simply may not match the</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineat">@@ -1648,18 +1645,18 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l5.133"></a><span id="l5.133">    *  central page.</span>
<a href="#l5.134"></a><span id="l5.134">    */</span>
<a href="#l5.135"></a><span id="l5.135">   _showAccountCentral: function FolderDisplayWidget__showAccountCentral() {</span>
<a href="#l5.136"></a><span id="l5.136">     var accountBox = document.getElementById(&quot;accountCentralBox&quot;);</span>
<a href="#l5.137"></a><span id="l5.137">     document.getElementById(&quot;displayDeck&quot;).selectedPanel = accountBox;</span>
<a href="#l5.138"></a><span id="l5.138">     var prefName = &quot;mailnews.account_central_page.url&quot;;</span>
<a href="#l5.139"></a><span id="l5.139">     // oh yeah, 'pref' is a global all right.</span>
<a href="#l5.140"></a><span id="l5.140">     var acctCentralPage =</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineminus">-      pref.getComplexValue(prefName,</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineminus">-                           Components.interfaces.nsIPrefLocalizedString).data;</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+      Services.prefs.getComplexValue(prefName,</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+                                     Components.interfaces.nsIPrefLocalizedString).data;</span>
<a href="#l5.145"></a><span id="l5.145">     window.frames[&quot;accountCentralPane&quot;].location.href = acctCentralPage;</span>
<a href="#l5.146"></a><span id="l5.146">   },</span>
<a href="#l5.147"></a><span id="l5.147"> </span>
<a href="#l5.148"></a><span id="l5.148">   /**</span>
<a href="#l5.149"></a><span id="l5.149">    * Call this when the tab using us is being hidden.</span>
<a href="#l5.150"></a><span id="l5.150">    */</span>
<a href="#l5.151"></a><span id="l5.151">   makeInactive: function FolderDisplayWidget_makeInactive() {</span>
<a href="#l5.152"></a><span id="l5.152">     // - things to do before we mark ourselves inactive (because they depend on</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/base/content/folderPane.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/base/content/folderPane.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,15 +1,16 @@</span>
<a href="#l6.4"></a><span id="l6.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.5"></a><span id="l6.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.6"></a><span id="l6.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8"> Components.utils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l6.9"></a><span id="l6.9"> Components.utils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l6.10"></a><span id="l6.10"> Components.utils.import(&quot;resource:///modules/MailUtils.js&quot;);</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.12"></a><span id="l6.12"> </span>
<a href="#l6.13"></a><span id="l6.13"> const kDefaultMode = &quot;all&quot;;</span>
<a href="#l6.14"></a><span id="l6.14"> </span>
<a href="#l6.15"></a><span id="l6.15"> var nsMsgFolderFlags = Components.interfaces.nsMsgFolderFlags;</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17"> /**</span>
<a href="#l6.18"></a><span id="l6.18">  * This file contains the controls and functions for the folder pane.</span>
<a href="#l6.19"></a><span id="l6.19">  * The following definitions will be useful to know:</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineat">@@ -114,21 +115,19 @@ let gFolderTreeView = {</span>
<a href="#l6.21"></a><span id="l6.21">       document.getElementById(&quot;folderpane_splitter&quot;).collapsed = false;</span>
<a href="#l6.22"></a><span id="l6.22">     if (document.getElementById(&quot;folderPaneBox&quot;))</span>
<a href="#l6.23"></a><span id="l6.23">       document.getElementById(&quot;folderPaneBox&quot;).collapsed = false;</span>
<a href="#l6.24"></a><span id="l6.24"> </span>
<a href="#l6.25"></a><span id="l6.25">     try {</span>
<a href="#l6.26"></a><span id="l6.26">       // Normally our tree takes care of keeping the last selected by itself.</span>
<a href="#l6.27"></a><span id="l6.27">       // However older versions of TB stored this in a preference, which we need</span>
<a href="#l6.28"></a><span id="l6.28">       // to migrate</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-      let prefB = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-                     .getService(Ci.nsIPrefBranch);</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-      let modeIndex = prefB.getIntPref(&quot;mail.ui.folderpane.view&quot;);</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+      let modeIndex = Services.prefs.getIntPref(&quot;mail.ui.folderpane.view&quot;);</span>
<a href="#l6.33"></a><span id="l6.33">       this._mode = this._modeNames[modeIndex];</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-      prefB.deleteBranch(&quot;mail.ui.folderpane&quot;);</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+      Services.prefs.deleteBranch(&quot;mail.ui.folderpane&quot;);</span>
<a href="#l6.36"></a><span id="l6.36">     } catch(ex) {</span>
<a href="#l6.37"></a><span id="l6.37">       // This is ok.  If we've already migrated we'll end up here</span>
<a href="#l6.38"></a><span id="l6.38">     }</span>
<a href="#l6.39"></a><span id="l6.39"> </span>
<a href="#l6.40"></a><span id="l6.40">     if (document.getElementById('folderpane-title')) {</span>
<a href="#l6.41"></a><span id="l6.41">       let string;</span>
<a href="#l6.42"></a><span id="l6.42">         if (this.mode in this._modeDisplayNames)</span>
<a href="#l6.43"></a><span id="l6.43">           string = this._modeDisplayNames[this.mode];</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineat">@@ -136,18 +135,17 @@ let gFolderTreeView = {</span>
<a href="#l6.45"></a><span id="l6.45">           let key = &quot;folderPaneModeHeader_&quot; + this.mode;</span>
<a href="#l6.46"></a><span id="l6.46">           string = document.getElementById(&quot;bundle_messenger&quot;).getString(key);</span>
<a href="#l6.47"></a><span id="l6.47">         }</span>
<a href="#l6.48"></a><span id="l6.48">       document.getElementById('folderpane-title').value = string;</span>
<a href="#l6.49"></a><span id="l6.49">     }</span>
<a href="#l6.50"></a><span id="l6.50"> </span>
<a href="#l6.51"></a><span id="l6.51">     if (aJSONFile) {</span>
<a href="#l6.52"></a><span id="l6.52">       // Parse our persistent-open-state json file</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-      let file = Cc[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-                    .getService(Ci.nsIProperties).get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+      let file = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l6.56"></a><span id="l6.56">       file.append(aJSONFile);</span>
<a href="#l6.57"></a><span id="l6.57"> </span>
<a href="#l6.58"></a><span id="l6.58">       if (file.exists()) {</span>
<a href="#l6.59"></a><span id="l6.59">         let data = &quot;&quot;;</span>
<a href="#l6.60"></a><span id="l6.60">         let fstream = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l6.61"></a><span id="l6.61">                          .createInstance(Ci.nsIFileInputStream);</span>
<a href="#l6.62"></a><span id="l6.62">         let sstream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l6.63"></a><span id="l6.63">                          .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineat">@@ -191,18 +189,17 @@ let gFolderTreeView = {</span>
<a href="#l6.65"></a><span id="l6.65">     // Remove our listener</span>
<a href="#l6.66"></a><span id="l6.66">     let session = Cc[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l6.67"></a><span id="l6.67">                      .getService(Ci.nsIMsgMailSession);</span>
<a href="#l6.68"></a><span id="l6.68">     session.RemoveFolderListener(this);</span>
<a href="#l6.69"></a><span id="l6.69"> </span>
<a href="#l6.70"></a><span id="l6.70">     if (aJSONFile) {</span>
<a href="#l6.71"></a><span id="l6.71">       // Write out our json file...</span>
<a href="#l6.72"></a><span id="l6.72">       let data = JSON.stringify(this._persistOpenMap);</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-      let file = Cc[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-                    .getService(Ci.nsIProperties).get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+      let file = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l6.76"></a><span id="l6.76">       file.append(aJSONFile);</span>
<a href="#l6.77"></a><span id="l6.77">       let foStream = Cc[&quot;@mozilla.org/network/safe-file-output-stream;1&quot;]</span>
<a href="#l6.78"></a><span id="l6.78">                         .createInstance(Ci.nsIFileOutputStream);</span>
<a href="#l6.79"></a><span id="l6.79"> </span>
<a href="#l6.80"></a><span id="l6.80">       foStream.init(file, 0x02 | 0x08 | 0x20, parseInt(&quot;0666&quot;, 8), 0);</span>
<a href="#l6.81"></a><span id="l6.81">       // safe-file-output-stream appears to throw an error if it doesn't write everything at once</span>
<a href="#l6.82"></a><span id="l6.82">       // so we won't worry about looping to deal with partial writes</span>
<a href="#l6.83"></a><span id="l6.83">       foStream.write(data, data.length);</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineat">@@ -646,18 +643,17 @@ let gFolderTreeView = {</span>
<a href="#l6.85"></a><span id="l6.85">       let sourceFolder;</span>
<a href="#l6.86"></a><span id="l6.86">       let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l6.87"></a><span id="l6.87">       for (let i = 0; i &lt; count; i++) {</span>
<a href="#l6.88"></a><span id="l6.88">         let msgHdr = messenger.msgHdrFromURI(dt.mozGetDataAt(&quot;text/x-moz-message&quot;, i));</span>
<a href="#l6.89"></a><span id="l6.89">         if (!i)</span>
<a href="#l6.90"></a><span id="l6.90">           sourceFolder = msgHdr.folder;</span>
<a href="#l6.91"></a><span id="l6.91">         array.appendElement(msgHdr, false);</span>
<a href="#l6.92"></a><span id="l6.92">       }</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-      let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-                          .getService(Ci.nsIPrefService).getBranch(&quot;mail.&quot;);</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+      let prefBranch = Services.prefs.getBranch(&quot;mail.&quot;);</span>
<a href="#l6.96"></a><span id="l6.96">       let isMove = Cc[&quot;@mozilla.org/widget/dragservice;1&quot;]</span>
<a href="#l6.97"></a><span id="l6.97">                       .getService(Ci.nsIDragService).getCurrentSession()</span>
<a href="#l6.98"></a><span id="l6.98">                       .dragAction == Ci.nsIDragService.DRAGDROP_ACTION_MOVE;</span>
<a href="#l6.99"></a><span id="l6.99">       if (!sourceFolder.canDeleteMessages)</span>
<a href="#l6.100"></a><span id="l6.100">         isMove = false;</span>
<a href="#l6.101"></a><span id="l6.101"> </span>
<a href="#l6.102"></a><span id="l6.102">       prefBranch.setCharPref(&quot;last_msg_movecopy_target_uri&quot;, targetFolder.URI);</span>
<a href="#l6.103"></a><span id="l6.103">       prefBranch.setBoolPref(&quot;last_msg_movecopy_was_move&quot;, isMove);</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineat">@@ -1146,19 +1142,17 @@ let gFolderTreeView = {</span>
<a href="#l6.105"></a><span id="l6.105">    * Completely discards the current tree and rebuilds it based on current</span>
<a href="#l6.106"></a><span id="l6.106">    * settings</span>
<a href="#l6.107"></a><span id="l6.107">    */</span>
<a href="#l6.108"></a><span id="l6.108">   _rebuild: function ftv__rebuild() {</span>
<a href="#l6.109"></a><span id="l6.109">     let newRowMap;</span>
<a href="#l6.110"></a><span id="l6.110">     try {</span>
<a href="#l6.111"></a><span id="l6.111">       newRowMap = this._modes[this.mode].generateMap(this);</span>
<a href="#l6.112"></a><span id="l6.112">     } catch(ex) {</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineminus">-      Components.classes[&quot;@mozilla.org/consoleservice;1&quot;]</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineminus">-                .getService(Components.interfaces.nsIConsoleService)</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-                .logStringMessage(&quot;generator &quot; + this.mode + &quot; failed with exception: &quot; + ex);</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+      Services.console.logStringMessage(&quot;generator &quot; + this.mode + &quot; failed with exception: &quot; + ex);</span>
<a href="#l6.117"></a><span id="l6.117">       this.mode = &quot;all&quot;;</span>
<a href="#l6.118"></a><span id="l6.118">       newRowMap = this._modes[this.mode].generateMap(this);</span>
<a href="#l6.119"></a><span id="l6.119">     }</span>
<a href="#l6.120"></a><span id="l6.120">     let selectedFolders = this.getSelectedFolders();</span>
<a href="#l6.121"></a><span id="l6.121">     if (this.selection)</span>
<a href="#l6.122"></a><span id="l6.122">       this.selection.clearSelection();</span>
<a href="#l6.123"></a><span id="l6.123">     // There's a chance the call to the map generator altered this._rowMap, so</span>
<a href="#l6.124"></a><span id="l6.124">     // evaluate oldCount after calling it rather than before</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineat">@@ -1941,34 +1935,31 @@ ftvItem.prototype = {</span>
<a href="#l6.126"></a><span id="l6.126">     if (smartFolderName) {</span>
<a href="#l6.127"></a><span id="l6.127">       aProps.AppendElement(Components.classes[&quot;@mozilla.org/atom-service;1&quot;]</span>
<a href="#l6.128"></a><span id="l6.128">                          .getService(Components.interfaces.nsIAtomService)</span>
<a href="#l6.129"></a><span id="l6.129">                          .getAtom(&quot;specialFolder-&quot;+smartFolderName.replace(' ','')));</span>
<a href="#l6.130"></a><span id="l6.130">     }</span>
<a href="#l6.131"></a><span id="l6.131">   },</span>
<a href="#l6.132"></a><span id="l6.132"> </span>
<a href="#l6.133"></a><span id="l6.133">   command: function fti_command() {</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineminus">-    let pref = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineminus">-                         .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineminus">-    if (!pref.getBoolPref(&quot;mailnews.reuse_thread_window2&quot;))</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineplus">+    if (!Services.prefs.getBoolPref(&quot;mailnews.reuse_thread_window2&quot;))</span>
<a href="#l6.138"></a><span id="l6.138">       MsgOpenNewWindowForFolder(this._folder.URI, -1 /* key */);</span>
<a href="#l6.139"></a><span id="l6.139">   },</span>
<a href="#l6.140"></a><span id="l6.140"> </span>
<a href="#l6.141"></a><span id="l6.141">   _children: null,</span>
<a href="#l6.142"></a><span id="l6.142">   get children() {</span>
<a href="#l6.143"></a><span id="l6.143">     const Ci = Components.interfaces;</span>
<a href="#l6.144"></a><span id="l6.144">     // We're caching our child list to save perf.</span>
<a href="#l6.145"></a><span id="l6.145">     if (!this._children) {</span>
<a href="#l6.146"></a><span id="l6.146">       let iter;</span>
<a href="#l6.147"></a><span id="l6.147">       try {</span>
<a href="#l6.148"></a><span id="l6.148">         iter = fixIterator(this._folder.subFolders, Ci.nsIMsgFolder);</span>
<a href="#l6.149"></a><span id="l6.149">       } catch (ex) {</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineminus">-        Components.classes[&quot;@mozilla.org/consoleservice;1&quot;].getService(Ci.nsIConsoleService)</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineminus">-          .logStringMessage(&quot;Discovering children for &quot; + this._folder.URI + &quot; failed with &quot; +</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineminus">-                            &quot;exception: &quot; + ex);</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+        Services.console.logStringMessage(&quot;Discovering children for &quot; + this._folder.URI +</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+                                          &quot; failed with &quot; + &quot;exception: &quot; + ex);</span>
<a href="#l6.155"></a><span id="l6.155">         iter = [];</span>
<a href="#l6.156"></a><span id="l6.156">       }</span>
<a href="#l6.157"></a><span id="l6.157">       this._children = [new ftvItem(f) for each (f in iter)];</span>
<a href="#l6.158"></a><span id="l6.158"> </span>
<a href="#l6.159"></a><span id="l6.159">       sortFolderItems(this._children);</span>
<a href="#l6.160"></a><span id="l6.160">       // Each child is a level one below us</span>
<a href="#l6.161"></a><span id="l6.161">       for each (let child in this._children) {</span>
<a href="#l6.162"></a><span id="l6.162">         child._level = this._level + 1;</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineat">@@ -2147,20 +2138,19 @@ let gFolderTreeController = {</span>
<a href="#l6.164"></a><span id="l6.164">     if (!canDelete)</span>
<a href="#l6.165"></a><span id="l6.165">       throw new Error(&quot;Can't delete folder: &quot; + folder.name);</span>
<a href="#l6.166"></a><span id="l6.166"> </span>
<a href="#l6.167"></a><span id="l6.167">     if (folder.flags &amp; nsMsgFolderFlags.Virtual) {</span>
<a href="#l6.168"></a><span id="l6.168">       let confirmation = document.getElementById(&quot;bundle_messenger&quot;)</span>
<a href="#l6.169"></a><span id="l6.169">                                  .getString(&quot;confirmSavedSearchDeleteMessage&quot;);</span>
<a href="#l6.170"></a><span id="l6.170">       let title = document.getElementById(&quot;bundle_messenger&quot;)</span>
<a href="#l6.171"></a><span id="l6.171">                           .getString(&quot;confirmSavedSearchTitle&quot;);</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-      let IPS = Components.interfaces.nsIPromptService;</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineminus">-      if (Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineminus">-            .getService(IPS)</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineminus">-            .confirmEx(window, title, confirmation, IPS.STD_YES_NO_BUTTONS + IPS.BUTTON_POS_1_DEFAULT,</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineplus">+      if (Servics.prompts</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineplus">+            .confirmEx(window, title, confirmation,</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineplus">+                       Services.prompt.STD_YES_NO_BUTTONS + Services.prompt.BUTTON_POS_1_DEFAULT,</span>
<a href="#l6.179"></a><span id="l6.179">                        &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, {}) != 0) /* the yes button is in position 0 */</span>
<a href="#l6.180"></a><span id="l6.180">         return;</span>
<a href="#l6.181"></a><span id="l6.181">     }</span>
<a href="#l6.182"></a><span id="l6.182"> </span>
<a href="#l6.183"></a><span id="l6.183">     let array = toXPCOMArray([folder], Ci.nsIMutableArray);</span>
<a href="#l6.184"></a><span id="l6.184">     folder.parent.deleteSubFolders(array, msgWindow);</span>
<a href="#l6.185"></a><span id="l6.185">   },</span>
<a href="#l6.186"></a><span id="l6.186"> </span>
<a href="#l6.187"></a><span id="l6.187" class="difflineat">@@ -2306,35 +2296,31 @@ let gFolderTreeController = {</span>
<a href="#l6.188"></a><span id="l6.188">    *</span>
<a href="#l6.189"></a><span id="l6.189">    * @param aCommand - the command to prompt for</span>
<a href="#l6.190"></a><span id="l6.190">    */</span>
<a href="#l6.191"></a><span id="l6.191">   _checkConfirmationPrompt: function ftc_confirm(aCommand) {</span>
<a href="#l6.192"></a><span id="l6.192">     const Cc = Components.classes;</span>
<a href="#l6.193"></a><span id="l6.193">     const Ci = Components.interfaces;</span>
<a href="#l6.194"></a><span id="l6.194">     let showPrompt = true;</span>
<a href="#l6.195"></a><span id="l6.195">     try {</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineminus">-      let pref = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineminus">-                    .getService(Ci.nsIPrefBranch);</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineminus">-      showPrompt = !pref.getBoolPref(&quot;mail.&quot; + aCommand + &quot;.dontAskAgain&quot;);</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineplus">+      showPrompt = !Services.prefs.getBoolPref(&quot;mail.&quot; + aCommand + &quot;.dontAskAgain&quot;);</span>
<a href="#l6.200"></a><span id="l6.200">     } catch (ex) {}</span>
<a href="#l6.201"></a><span id="l6.201"> </span>
<a href="#l6.202"></a><span id="l6.202">     if (showPrompt) {</span>
<a href="#l6.203"></a><span id="l6.203">       let checkbox = {value:false};</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineminus">-      let promptService = Cc[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineminus">-                             .getService(Ci.nsIPromptService);</span>
<a href="#l6.206"></a><span id="l6.206">       let bundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineminus">-      let ok = promptService.confirmEx(window,</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineminus">-                                       bundle.getString(aCommand + &quot;Title&quot;),</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineminus">-                                       bundle.getString(aCommand + &quot;Message&quot;),</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineminus">-                                       promptService.STD_YES_NO_BUTTONS,</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineminus">-                                       null, null, null,</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineminus">-                                       bundle.getString(aCommand + &quot;DontAsk&quot;),</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineminus">-                                       checkbox) == 0;</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineplus">+      let ok = Services.prompt.confirmEx(window,</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineplus">+                                         bundle.getString(aCommand + &quot;Title&quot;),</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineplus">+                                         bundle.getString(aCommand + &quot;Message&quot;),</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineplus">+                                         Services.prompt.STD_YES_NO_BUTTONS,</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineplus">+                                         null, null, null,</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineplus">+                                         bundle.getString(aCommand + &quot;DontAsk&quot;),</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineplus">+                                         checkbox) == 0;</span>
<a href="#l6.221"></a><span id="l6.221">       if (checkbox.value)</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineminus">-        pref.setBoolPref(&quot;mail.&quot; + aCommand + &quot;.dontAskAgain&quot;, true);</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineplus">+        Services.prefs.setBoolPref(&quot;mail.&quot; + aCommand + &quot;.dontAskAgain&quot;, true);</span>
<a href="#l6.224"></a><span id="l6.224">       if (!ok)</span>
<a href="#l6.225"></a><span id="l6.225">         return false;</span>
<a href="#l6.226"></a><span id="l6.226">     }</span>
<a href="#l6.227"></a><span id="l6.227">     return true;</span>
<a href="#l6.228"></a><span id="l6.228">   },</span>
<a href="#l6.229"></a><span id="l6.229"> </span>
<a href="#l6.230"></a><span id="l6.230">   get _tree() {</span>
<a href="#l6.231"></a><span id="l6.231">     let tree = document.getElementById(&quot;folderTree&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/base/content/mail-offline.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/base/content/mail-offline.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -43,24 +43,24 @@ var MailOfflineMgr = {</span>
<a href="#l7.4"></a><span id="l7.4">   {</span>
<a href="#l7.5"></a><span id="l7.5">     // the offline manager(goOnline and synchronizeForOffline) actually does the dirty work of</span>
<a href="#l7.6"></a><span id="l7.6">     // changing the offline state with the networking service.</span>
<a href="#l7.7"></a><span id="l7.7">     if (!this.isOnline())</span>
<a href="#l7.8"></a><span id="l7.8">     {</span>
<a href="#l7.9"></a><span id="l7.9">       // We do the go online stuff in our listener for the online state change.</span>
<a href="#l7.10"></a><span id="l7.10">       Services.io.offline = false;</span>
<a href="#l7.11"></a><span id="l7.11">       // resume managing offline status now that we are going back online.</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-      Services.io.manageOfflineStatus = gPrefBranch.getBoolPref(&quot;offline.autoDetect&quot;);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+      Services.io.manageOfflineStatus = Services.prefs.getBoolPref(&quot;offline.autoDetect&quot;);</span>
<a href="#l7.14"></a><span id="l7.14">     }</span>
<a href="#l7.15"></a><span id="l7.15">     else // going offline</span>
<a href="#l7.16"></a><span id="l7.16">     {</span>
<a href="#l7.17"></a><span id="l7.17">       // Stop automatic management of the offline status since the user has</span>
<a href="#l7.18"></a><span id="l7.18">       // decided to go offline.</span>
<a href="#l7.19"></a><span id="l7.19">       Services.io.manageOfflineStatus = false;</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-      var prefDownloadMessages = gPrefBranch.getIntPref(&quot;offline.download.download_messages&quot;);</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+      var prefDownloadMessages = Services.prefs.getIntPref(&quot;offline.download.download_messages&quot;);</span>
<a href="#l7.22"></a><span id="l7.22">       // 0 == Ask, 1 == Always Download, 2 == Never Download</span>
<a href="#l7.23"></a><span id="l7.23">       var downloadForOfflineUse = (prefDownloadMessages == 0 &amp;&amp; this.confirmDownloadMessagesForOfflineUse())</span>
<a href="#l7.24"></a><span id="l7.24">                                   || prefDownloadMessages == 1;</span>
<a href="#l7.25"></a><span id="l7.25">       this.offlineManager.synchronizeForOffline(downloadForOfflineUse, downloadForOfflineUse, false, true, msgWindow);</span>
<a href="#l7.26"></a><span id="l7.26">     }</span>
<a href="#l7.27"></a><span id="l7.27">   },</span>
<a href="#l7.28"></a><span id="l7.28"> </span>
<a href="#l7.29"></a><span id="l7.29">   observe: function (aSubject, aTopic, aState)</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineat">@@ -121,29 +121,29 @@ var MailOfflineMgr = {</span>
<a href="#l7.31"></a><span id="l7.31">       this.offlineBundle.getString('sendMessagesNow'),</span>
<a href="#l7.32"></a><span id="l7.32">       this.offlineBundle.getString('processMessagesLater'),</span>
<a href="#l7.33"></a><span id="l7.33">       null,</span>
<a href="#l7.34"></a><span id="l7.34">       this.offlineBundle.getString('sendMessagesCheckboxLabel1'),</span>
<a href="#l7.35"></a><span id="l7.35">       alwaysAsk) == 0 ? true : false;</span>
<a href="#l7.36"></a><span id="l7.36"> </span>
<a href="#l7.37"></a><span id="l7.37">     // if the user changed the ask me setting then update the global pref based on their yes / no answer</span>
<a href="#l7.38"></a><span id="l7.38">     if (!alwaysAsk.value)</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-      gPrefBranch.setIntPref(&quot;offline.send.unsent_messages&quot;, sendUnsentMessages ? 1 : 2);</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+      Services.prefs.setIntPref(&quot;offline.send.unsent_messages&quot;, sendUnsentMessages ? 1 : 2);</span>
<a href="#l7.41"></a><span id="l7.41"> </span>
<a href="#l7.42"></a><span id="l7.42">     return sendUnsentMessages;</span>
<a href="#l7.43"></a><span id="l7.43">   },</span>
<a href="#l7.44"></a><span id="l7.44"> </span>
<a href="#l7.45"></a><span id="l7.45">   /**</span>
<a href="#l7.46"></a><span id="l7.46">    * Should we send unsent messages? Based on the value of</span>
<a href="#l7.47"></a><span id="l7.47">    * offline.send.unsent_messages, this method may prompt the user.</span>
<a href="#l7.48"></a><span id="l7.48">    * @return true if we should send unsent messages</span>
<a href="#l7.49"></a><span id="l7.49">    */</span>
<a href="#l7.50"></a><span id="l7.50">   shouldSendUnsentMessages: function()</span>
<a href="#l7.51"></a><span id="l7.51">   {</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-    var sendUnsentWhenGoingOnlinePref = gPrefBranch.getIntPref(&quot;offline.send.unsent_messages&quot;);</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+    var sendUnsentWhenGoingOnlinePref = Services.prefs.getIntPref(&quot;offline.send.unsent_messages&quot;);</span>
<a href="#l7.54"></a><span id="l7.54">     if(sendUnsentWhenGoingOnlinePref == 2) // never send</span>
<a href="#l7.55"></a><span id="l7.55">       return false;</span>
<a href="#l7.56"></a><span id="l7.56"> </span>
<a href="#l7.57"></a><span id="l7.57">     // if we we have unsent messages, then honor the offline.send.unsent_messages pref.</span>
<a href="#l7.58"></a><span id="l7.58">     else if (this.haveUnsentMessages())</span>
<a href="#l7.59"></a><span id="l7.59">     {</span>
<a href="#l7.60"></a><span id="l7.60">       if ((sendUnsentWhenGoingOnlinePref == 0 &amp;&amp; this.confirmSendUnsentMessages())</span>
<a href="#l7.61"></a><span id="l7.61">            || sendUnsentWhenGoingOnlinePref == 1)</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineat">@@ -169,17 +169,17 @@ var MailOfflineMgr = {</span>
<a href="#l7.63"></a><span id="l7.63">       this.offlineBundle.getString('downloadMessagesNow'),</span>
<a href="#l7.64"></a><span id="l7.64">       this.offlineBundle.getString('processMessagesLater'),</span>
<a href="#l7.65"></a><span id="l7.65">       null,</span>
<a href="#l7.66"></a><span id="l7.66">       this.offlineBundle.getString('downloadMessagesCheckboxLabel1'),</span>
<a href="#l7.67"></a><span id="l7.67">       alwaysAsk) == 0 ? true : false;</span>
<a href="#l7.68"></a><span id="l7.68"> </span>
<a href="#l7.69"></a><span id="l7.69">     // if the user changed the ask me setting then update the global pref based on their yes / no answer</span>
<a href="#l7.70"></a><span id="l7.70">     if (!alwaysAsk.value)</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-      gPrefBranch.setIntPref(&quot;offline.download.download_messages&quot;, downloadMessages ? 1 : 2);</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+      Services.prefs.setIntPref(&quot;offline.download.download_messages&quot;, downloadMessages ? 1 : 2);</span>
<a href="#l7.73"></a><span id="l7.73">     return downloadMessages;</span>
<a href="#l7.74"></a><span id="l7.74">   },</span>
<a href="#l7.75"></a><span id="l7.75"> </span>
<a href="#l7.76"></a><span id="l7.76">   /** </span>
<a href="#l7.77"></a><span id="l7.77">    *  Get New Mail When Offline</span>
<a href="#l7.78"></a><span id="l7.78">    *  Prompts the user about going online in order to download new messages. </span>
<a href="#l7.79"></a><span id="l7.79">    *  Based on the response, will move us back to online mode.</span>
<a href="#l7.80"></a><span id="l7.80">    *</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineat">@@ -220,17 +220,17 @@ var MailOfflineMgr = {</span>
<a href="#l7.82"></a><span id="l7.82">   /**</span>
<a href="#l7.83"></a><span id="l7.83">    * private helper method called whenever we detect a change to the offline state</span>
<a href="#l7.84"></a><span id="l7.84">    */ </span>
<a href="#l7.85"></a><span id="l7.85">   mailOfflineStateChanged: function (aGoingOffline)</span>
<a href="#l7.86"></a><span id="l7.86">   {</span>
<a href="#l7.87"></a><span id="l7.87">     this.updateOfflineUI(aGoingOffline);</span>
<a href="#l7.88"></a><span id="l7.88">     if (!aGoingOffline)</span>
<a href="#l7.89"></a><span id="l7.89">     {</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-      let prefSendUnsentMessages = gPrefBranch.getIntPref(&quot;offline.send.unsent_messages&quot;);</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+      let prefSendUnsentMessages = Services.prefs.getIntPref(&quot;offline.send.unsent_messages&quot;);</span>
<a href="#l7.92"></a><span id="l7.92">       // 0 == Ask, 1 == Always Send, 2 == Never Send</span>
<a href="#l7.93"></a><span id="l7.93">       let sendUnsentMessages = (prefSendUnsentMessages == 0 &amp;&amp;</span>
<a href="#l7.94"></a><span id="l7.94">                                 this.haveUnsentMessages() &amp;&amp;</span>
<a href="#l7.95"></a><span id="l7.95">                                 this.confirmSendUnsentMessages()) ||</span>
<a href="#l7.96"></a><span id="l7.96">                                prefSendUnsentMessages == 1;</span>
<a href="#l7.97"></a><span id="l7.97">       this.offlineManager.goOnline(sendUnsentMessages, true, msgWindow);</span>
<a href="#l7.98"></a><span id="l7.98">     }</span>
<a href="#l7.99"></a><span id="l7.99">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/base/content/mail3PaneWindowCommands.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/base/content/mail3PaneWindowCommands.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -3,16 +3,17 @@</span>
<a href="#l8.4"></a><span id="l8.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.5"></a><span id="l8.5"> </span>
<a href="#l8.6"></a><span id="l8.6"> /**</span>
<a href="#l8.7"></a><span id="l8.7">  * Functionality for the main application window (aka the 3pane) usually</span>
<a href="#l8.8"></a><span id="l8.8">  * consisting of folder pane, thread pane and message pane.</span>
<a href="#l8.9"></a><span id="l8.9">  */</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11"> Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.13"></a><span id="l8.13"> </span>
<a href="#l8.14"></a><span id="l8.14"> // Controller object for folder pane</span>
<a href="#l8.15"></a><span id="l8.15"> var FolderPaneController =</span>
<a href="#l8.16"></a><span id="l8.16"> {</span>
<a href="#l8.17"></a><span id="l8.17">   supportsCommand: function(command)</span>
<a href="#l8.18"></a><span id="l8.18">   {</span>
<a href="#l8.19"></a><span id="l8.19">     switch ( command )</span>
<a href="#l8.20"></a><span id="l8.20">     {</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineat">@@ -533,23 +534,23 @@ var DefaultController =</span>
<a href="#l8.22"></a><span id="l8.22">         return (IsFolderSelected() &amp;&amp; MailOfflineMgr.isOnline() &amp;&amp; GetNumSelectedMessages() &gt; 0);</span>
<a href="#l8.23"></a><span id="l8.23">       case &quot;cmd_synchronizeOffline&quot;:</span>
<a href="#l8.24"></a><span id="l8.24">         return MailOfflineMgr.isOnline();</span>
<a href="#l8.25"></a><span id="l8.25">       case &quot;cmd_settingsOffline&quot;:</span>
<a href="#l8.26"></a><span id="l8.26">         return IsAccountOfflineEnabled();</span>
<a href="#l8.27"></a><span id="l8.27">       case &quot;cmd_moveToFolderAgain&quot;:</span>
<a href="#l8.28"></a><span id="l8.28">         // Disable &quot;Move to &lt;folder&gt; Again&quot; for news and other read only</span>
<a href="#l8.29"></a><span id="l8.29">         // folders since we can't really move messages from there - only copy.</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-        if (pref.getBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;))</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+        if (Services.prefs.getBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;))</span>
<a href="#l8.32"></a><span id="l8.32">         {</span>
<a href="#l8.33"></a><span id="l8.33">           let loadedFolder = gFolderTreeView.getSelectedFolders()[0];</span>
<a href="#l8.34"></a><span id="l8.34">           if (loadedFolder &amp;&amp; !loadedFolder.canDeleteMessages)</span>
<a href="#l8.35"></a><span id="l8.35">             return false;</span>
<a href="#l8.36"></a><span id="l8.36">         }</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-        let targetURI = pref.getCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;);</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+        let targetURI = Services.prefs.getCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;);</span>
<a href="#l8.39"></a><span id="l8.39">         if (!targetURI)</span>
<a href="#l8.40"></a><span id="l8.40">           return false;</span>
<a href="#l8.41"></a><span id="l8.41">         let targetFolder = MailUtils.getFolderForURI(targetURI);</span>
<a href="#l8.42"></a><span id="l8.42">         // If parent is null, folder doesn't exist.</span>
<a href="#l8.43"></a><span id="l8.43">         return targetFolder &amp;&amp; targetFolder.parent &amp;&amp;</span>
<a href="#l8.44"></a><span id="l8.44">                GetNumSelectedMessages() &gt; 0;</span>
<a href="#l8.45"></a><span id="l8.45">       case &quot;cmd_fullZoomReduce&quot;:</span>
<a href="#l8.46"></a><span id="l8.46">       case &quot;cmd_fullZoomEnlarge&quot;:</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineat">@@ -894,18 +895,18 @@ var DefaultController =</span>
<a href="#l8.48"></a><span id="l8.48">           break;</span>
<a href="#l8.49"></a><span id="l8.49">       case &quot;cmd_synchronizeOffline&quot;:</span>
<a href="#l8.50"></a><span id="l8.50">           MsgSynchronizeOffline();</span>
<a href="#l8.51"></a><span id="l8.51">           break;</span>
<a href="#l8.52"></a><span id="l8.52">       case &quot;cmd_settingsOffline&quot;:</span>
<a href="#l8.53"></a><span id="l8.53">           MailOfflineMgr.openOfflineAccountSettings();</span>
<a href="#l8.54"></a><span id="l8.54">           break;</span>
<a href="#l8.55"></a><span id="l8.55">       case &quot;cmd_moveToFolderAgain&quot;:</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-          var folderId = pref.getCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;);</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-          if (pref.getBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;))</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+          var folderId = Services.prefs.getCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;);</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+          if (Services.prefs.getBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;))</span>
<a href="#l8.60"></a><span id="l8.60">             MsgMoveMessage(GetMsgFolderFromUri(folderId));</span>
<a href="#l8.61"></a><span id="l8.61">           else</span>
<a href="#l8.62"></a><span id="l8.62">             MsgCopyMessage(GetMsgFolderFromUri(folderId));</span>
<a href="#l8.63"></a><span id="l8.63">           break;</span>
<a href="#l8.64"></a><span id="l8.64">       case &quot;cmd_selectAll&quot;:</span>
<a href="#l8.65"></a><span id="l8.65">         // XXX If the message pane is selected but the tab focused, this ends</span>
<a href="#l8.66"></a><span id="l8.66">         // closing the message tab. See bug 502834.</span>
<a href="#l8.67"></a><span id="l8.67">         if (aTab.mode.name == &quot;message&quot;)</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineat">@@ -950,17 +951,17 @@ var DefaultController =</span>
<a href="#l8.69"></a><span id="l8.69">     }</span>
<a href="#l8.70"></a><span id="l8.70">   }</span>
<a href="#l8.71"></a><span id="l8.71"> };</span>
<a href="#l8.72"></a><span id="l8.72"> </span>
<a href="#l8.73"></a><span id="l8.73"> function CloseTabOrWindow()</span>
<a href="#l8.74"></a><span id="l8.74"> {</span>
<a href="#l8.75"></a><span id="l8.75">   let tabmail = document.getElementById('tabmail');</span>
<a href="#l8.76"></a><span id="l8.76">   if (tabmail.tabInfo.length == 1) {</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-    if (pref.getBoolPref(&quot;mail.tabs.closeWindowWithLastTab&quot;))</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+    if (Services.prefs.getBoolPref(&quot;mail.tabs.closeWindowWithLastTab&quot;))</span>
<a href="#l8.79"></a><span id="l8.79">       window.close();</span>
<a href="#l8.80"></a><span id="l8.80">   }</span>
<a href="#l8.81"></a><span id="l8.81">   else {</span>
<a href="#l8.82"></a><span id="l8.82">     tabmail.removeCurrentTab();</span>
<a href="#l8.83"></a><span id="l8.83">   }</span>
<a href="#l8.84"></a><span id="l8.84"> }</span>
<a href="#l8.85"></a><span id="l8.85"> </span>
<a href="#l8.86"></a><span id="l8.86"> function GetNumSelectedMessages()</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/base/content/mailContextMenus.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/base/content/mailContextMenus.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.5"></a><span id="l9.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.6"></a><span id="l9.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8"> Components.utils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l9.10"></a><span id="l9.10"> Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12"> const mailtolength = 7;</span>
<a href="#l9.13"></a><span id="l9.13"> </span>
<a href="#l9.14"></a><span id="l9.14"> /**</span>
<a href="#l9.15"></a><span id="l9.15">  * Function to change the highlighted row back to the row that is currently</span>
<a href="#l9.16"></a><span id="l9.16">  * outline/dotted without loading the contents of either rows. This is</span>
<a href="#l9.17"></a><span id="l9.17">  * triggered when the context menu for a given row is hidden/closed</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineat">@@ -108,18 +109,18 @@ function GetMessageIdFromNode(messageIdN</span>
<a href="#l9.19"></a><span id="l9.19"> /**</span>
<a href="#l9.20"></a><span id="l9.20">  * Take the message id from the messageIdNode and use the url defined in the</span>
<a href="#l9.21"></a><span id="l9.21">  * hidden pref &quot;mailnews.messageid_browser.url&quot; to open it in a browser window</span>
<a href="#l9.22"></a><span id="l9.22">  * (%mid is replaced by the message id).</span>
<a href="#l9.23"></a><span id="l9.23">  * @param messageId the message id to open</span>
<a href="#l9.24"></a><span id="l9.24">  */</span>
<a href="#l9.25"></a><span id="l9.25"> function OpenBrowserWithMessageId(messageId)</span>
<a href="#l9.26"></a><span id="l9.26"> {</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-  var browserURL = pref.getComplexValue(&quot;mailnews.messageid_browser.url&quot;,</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-                                        Components.interfaces.nsIPrefLocalizedString).data;</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+  var browserURL = Services.prefs.getComplexValue(&quot;mailnews.messageid_browser.url&quot;,</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+                                                  Components.interfaces.nsIPrefLocalizedString).data;</span>
<a href="#l9.31"></a><span id="l9.31">   browserURL = browserURL.replace(/%mid/, messageId);</span>
<a href="#l9.32"></a><span id="l9.32">   try</span>
<a href="#l9.33"></a><span id="l9.33">   {</span>
<a href="#l9.34"></a><span id="l9.34">     messenger.launchExternalURL(browserURL);</span>
<a href="#l9.35"></a><span id="l9.35">   }</span>
<a href="#l9.36"></a><span id="l9.36">   catch (ex)</span>
<a href="#l9.37"></a><span id="l9.37">   {</span>
<a href="#l9.38"></a><span id="l9.38">     Components.utils.reportError(&quot;Failed to open message-id in browser; &quot; +</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineat">@@ -163,28 +164,26 @@ function OpenMessageForMessageId(message</span>
<a href="#l9.40"></a><span id="l9.40">       }</span>
<a href="#l9.41"></a><span id="l9.41">     }</span>
<a href="#l9.42"></a><span id="l9.42">   }</span>
<a href="#l9.43"></a><span id="l9.43">   window.setCursor(&quot;auto&quot;);</span>
<a href="#l9.44"></a><span id="l9.44"> </span>
<a href="#l9.45"></a><span id="l9.45">   // if message id was found open corresponding message</span>
<a href="#l9.46"></a><span id="l9.46">   // else show error message</span>
<a href="#l9.47"></a><span id="l9.47">   if (messageHeader)</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-    OpenMessageByHeader(messageHeader, pref.getBoolPref(&quot;mailnews.messageid.openInNewWindow&quot;));</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+    OpenMessageByHeader(messageHeader, Services.prefs.getBoolPref(&quot;mailnews.messageid.openInNewWindow&quot;));</span>
<a href="#l9.50"></a><span id="l9.50">   else</span>
<a href="#l9.51"></a><span id="l9.51">   {</span>
<a href="#l9.52"></a><span id="l9.52">     var messageIdStr = &quot;&lt;&quot; + messageId + &quot;&gt;&quot;;</span>
<a href="#l9.53"></a><span id="l9.53">     var bundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l9.54"></a><span id="l9.54">     var errorTitle = bundle.getString(&quot;errorOpenMessageForMessageIdTitle&quot;);</span>
<a href="#l9.55"></a><span id="l9.55">     var errorMessage = bundle.getFormattedString(&quot;errorOpenMessageForMessageIdMessage&quot;,</span>
<a href="#l9.56"></a><span id="l9.56">                                                  [messageIdStr]);</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-    var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineminus">-                                  .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l9.59"></a><span id="l9.59"> </span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-    promptService.alert(window, errorTitle, errorMessage);</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+    Services.prompt.alert(window, errorTitle, errorMessage);</span>
<a href="#l9.62"></a><span id="l9.62">   }</span>
<a href="#l9.63"></a><span id="l9.63"> }</span>
<a href="#l9.64"></a><span id="l9.64"> </span>
<a href="#l9.65"></a><span id="l9.65"> function OpenMessageByHeader(messageHeader, openInNewWindow)</span>
<a href="#l9.66"></a><span id="l9.66"> {</span>
<a href="#l9.67"></a><span id="l9.67">   var folder    = messageHeader.folder;</span>
<a href="#l9.68"></a><span id="l9.68">   var folderURI = folder.URI;</span>
<a href="#l9.69"></a><span id="l9.69"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/base/content/mailTabs.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/base/content/mailTabs.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1,14 +1,15 @@</span>
<a href="#l10.4"></a><span id="l10.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.5"></a><span id="l10.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.6"></a><span id="l10.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8"> Components.utils.import(&quot;resource:///modules/MsgHdrSyntheticView.js&quot;);</span>
<a href="#l10.9"></a><span id="l10.9"> Components.utils.import(&quot;resource:///modules/errUtils.js&quot;);</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12"> /**</span>
<a href="#l10.13"></a><span id="l10.13">  * Displays message &quot;folder&quot;s, mail &quot;message&quot;s, and &quot;glodaList&quot; results.  The</span>
<a href="#l10.14"></a><span id="l10.14">  *  commonality is that they all use the &quot;mailContent&quot; panel's folder tree,</span>
<a href="#l10.15"></a><span id="l10.15">  *  thread tree, and message pane objects.  This happens for historical reasons,</span>
<a href="#l10.16"></a><span id="l10.16">  *  likely involving the fact that prior to the introduction of this</span>
<a href="#l10.17"></a><span id="l10.17">  *  abstraction, everything was always stored in global objects.  For the 3.0</span>
<a href="#l10.18"></a><span id="l10.18">  *  release cycle we considered avoiding this 'multiplexed' style of operation</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineat">@@ -566,17 +567,17 @@ let mailTabType = {</span>
<a href="#l10.20"></a><span id="l10.20">    *     - message: The message pane.</span>
<a href="#l10.21"></a><span id="l10.21">    */</span>
<a href="#l10.22"></a><span id="l10.22">   _setPaneStates: function mailTabType_setPaneStates(aLegalStates,</span>
<a href="#l10.23"></a><span id="l10.23">                                                      aVisibleStates) {</span>
<a href="#l10.24"></a><span id="l10.24">     // The display deck hosts both the thread pane and account central.</span>
<a href="#l10.25"></a><span id="l10.25">     let displayDeckLegal = aLegalStates.thread ||</span>
<a href="#l10.26"></a><span id="l10.26">                            aLegalStates.accountCentral;</span>
<a href="#l10.27"></a><span id="l10.27"> </span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-    let layout = pref.getIntPref(&quot;mail.pane_config.dynamic&quot;);</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+    let layout = Services.prefs.getIntPref(&quot;mail.pane_config.dynamic&quot;);</span>
<a href="#l10.30"></a><span id="l10.30">     if (layout == kWidePaneConfig)</span>
<a href="#l10.31"></a><span id="l10.31">     {</span>
<a href="#l10.32"></a><span id="l10.32">       // in the &quot;wide&quot; configuration, the #messengerBox is left holding the</span>
<a href="#l10.33"></a><span id="l10.33">       //  folder pane and thread pane, and the message pane has migrated to be</span>
<a href="#l10.34"></a><span id="l10.34">       //  its sibling (under #mailContent).</span>
<a href="#l10.35"></a><span id="l10.35">       // Accordingly, if both the folder and thread panes are illegal, we</span>
<a href="#l10.36"></a><span id="l10.36">       //  want to collapse the #messengerBox and make sure the #messagepanebox</span>
<a href="#l10.37"></a><span id="l10.37">       //  fills up the screen.  (For example, when in &quot;message&quot; mode.)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/base/content/mailWidgets.xml</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/base/content/mailWidgets.xml</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1553,40 +1553,36 @@</span>
<a href="#l11.4"></a><span id="l11.4">   &lt;/binding&gt;</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6">   &lt;!-- searchattribute - Subject, Sender, To, CC, etc. --&gt;</span>
<a href="#l11.7"></a><span id="l11.7">   &lt;binding id=&quot;searchattribute&quot; name=&quot;searchAttribute&quot;</span>
<a href="#l11.8"></a><span id="l11.8">            extends=&quot;chrome://messenger/content/mailWidgets.xml#search-menulist-abstract&quot;&gt;</span>
<a href="#l11.9"></a><span id="l11.9">     &lt;implementation&gt;</span>
<a href="#l11.10"></a><span id="l11.10">       &lt;field name=&quot;stringBundle&quot;&gt;</span>
<a href="#l11.11"></a><span id="l11.11">         &lt;![CDATA[</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-          Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-                    .getService(Components.interfaces.nsIStringBundleService)</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-                    .createBundle(&quot;chrome://messenger/locale/search-attributes.properties&quot;)</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+          this.Services.strings.createBundle(&quot;chrome://messenger/locale/search-attributes.properties&quot;)</span>
<a href="#l11.16"></a><span id="l11.16">         ]]&gt;</span>
<a href="#l11.17"></a><span id="l11.17">       &lt;/field&gt;</span>
<a href="#l11.18"></a><span id="l11.18">       &lt;property name=&quot;valueLabel&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l11.19"></a><span id="l11.19">         &lt;getter&gt;</span>
<a href="#l11.20"></a><span id="l11.20">           &lt;![CDATA[</span>
<a href="#l11.21"></a><span id="l11.21">             if (isNaN(this.value)) // is this a custom term?</span>
<a href="#l11.22"></a><span id="l11.22">             {</span>
<a href="#l11.23"></a><span id="l11.23">               let customTerm = this.filterService.getCustomTerm(this.value);</span>
<a href="#l11.24"></a><span id="l11.24">               if (customTerm)</span>
<a href="#l11.25"></a><span id="l11.25">                 return customTerm.name;</span>
<a href="#l11.26"></a><span id="l11.26">               else</span>
<a href="#l11.27"></a><span id="l11.27">               {</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-                let consoleService = Components.classes[&quot;@mozilla.org/consoleservice;1&quot;]</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-                    .getService(Components.interfaces.nsIConsoleService);</span>
<a href="#l11.30"></a><span id="l11.30">                 let scriptError = Components.classes[&quot;@mozilla.org/scripterror;1&quot;]</span>
<a href="#l11.31"></a><span id="l11.31">                     .createInstance(Components.interfaces.nsIScriptError);</span>
<a href="#l11.32"></a><span id="l11.32">                 scriptError.init(&quot;Missing custom search term &quot; + this.value,</span>
<a href="#l11.33"></a><span id="l11.33">                     null, null, 0, 0,</span>
<a href="#l11.34"></a><span id="l11.34">                     Components.interfaces.nsIScriptError.errorFlag,</span>
<a href="#l11.35"></a><span id="l11.35">                     &quot;component javascript&quot;);</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-                consoleService.logMessage(scriptError);</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+                this.Services.console.logMessage(scriptError);</span>
<a href="#l11.38"></a><span id="l11.38">                 return this.stringBundle.GetStringFromName(&quot;MissingCustomTerm&quot;);</span>
<a href="#l11.39"></a><span id="l11.39">               }</span>
<a href="#l11.40"></a><span id="l11.40">             }</span>
<a href="#l11.41"></a><span id="l11.41">             return this.stringBundle.GetStringFromName(</span>
<a href="#l11.42"></a><span id="l11.42">               this.validityManager.getAttributeProperty(parseInt(this.value)));</span>
<a href="#l11.43"></a><span id="l11.43">           ]]&gt;</span>
<a href="#l11.44"></a><span id="l11.44">         &lt;/getter&gt;</span>
<a href="#l11.45"></a><span id="l11.45">       &lt;/property&gt;</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineat">@@ -1614,19 +1610,17 @@</span>
<a href="#l11.47"></a><span id="l11.47">       &lt;property name=&quot;valueStrings&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l11.48"></a><span id="l11.48">         &lt;getter&gt;</span>
<a href="#l11.49"></a><span id="l11.49">           &lt;![CDATA[</span>
<a href="#l11.50"></a><span id="l11.50">             let strings = new Array;</span>
<a href="#l11.51"></a><span id="l11.51">             let ids = this.valueIds;</span>
<a href="#l11.52"></a><span id="l11.52">             let hdrsArray = null;</span>
<a href="#l11.53"></a><span id="l11.53">             try</span>
<a href="#l11.54"></a><span id="l11.54">             {</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-              let hdrs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-                                   .getService(Components.interfaces.nsIPrefBranch)</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-                                   .getCharPref(&quot;mailnews.customHeaders&quot;);</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+              let hdrs = this.Services.prefs.getCharPref(&quot;mailnews.customHeaders&quot;);</span>
<a href="#l11.59"></a><span id="l11.59">               hdrs = hdrs.replace(/\s+/g, &quot;&quot;);  //remove white spaces before splitting</span>
<a href="#l11.60"></a><span id="l11.60">               hdrsArray = hdrs.match(/[^:]+/g);</span>
<a href="#l11.61"></a><span id="l11.61">             }</span>
<a href="#l11.62"></a><span id="l11.62">             catch(ex)</span>
<a href="#l11.63"></a><span id="l11.63">             {</span>
<a href="#l11.64"></a><span id="l11.64">             }</span>
<a href="#l11.65"></a><span id="l11.65"> </span>
<a href="#l11.66"></a><span id="l11.66">             let j = 0;</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineat">@@ -1647,32 +1641,31 @@</span>
<a href="#l11.68"></a><span id="l11.68">                                this.validityManager.getAttributeProperty(ids[i]));</span>
<a href="#l11.69"></a><span id="l11.69">             }</span>
<a href="#l11.70"></a><span id="l11.70">             return strings;</span>
<a href="#l11.71"></a><span id="l11.71">           ]]&gt;</span>
<a href="#l11.72"></a><span id="l11.72">         &lt;/getter&gt;</span>
<a href="#l11.73"></a><span id="l11.73">       &lt;/property&gt;</span>
<a href="#l11.74"></a><span id="l11.74">       &lt;constructor&gt;</span>
<a href="#l11.75"></a><span id="l11.75">       &lt;![CDATA[</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+        Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;, this);</span>
<a href="#l11.77"></a><span id="l11.77">         initializeTermFromId(this.id);</span>
<a href="#l11.78"></a><span id="l11.78">       ]]&gt;</span>
<a href="#l11.79"></a><span id="l11.79">       &lt;/constructor&gt;</span>
<a href="#l11.80"></a><span id="l11.80">     &lt;/implementation&gt;</span>
<a href="#l11.81"></a><span id="l11.81">   &lt;/binding&gt;</span>
<a href="#l11.82"></a><span id="l11.82"> </span>
<a href="#l11.83"></a><span id="l11.83">   &lt;!-- searchoperator - Contains, Is Less than, etc --&gt;</span>
<a href="#l11.84"></a><span id="l11.84">   &lt;binding id=&quot;searchoperator&quot; name=&quot;searchOperator&quot;</span>
<a href="#l11.85"></a><span id="l11.85">            extends=&quot;chrome://messenger/content/mailWidgets.xml#search-menulist-abstract&quot;&gt;</span>
<a href="#l11.86"></a><span id="l11.86">     &lt;implementation&gt;</span>
<a href="#l11.87"></a><span id="l11.87">       &lt;field name=&quot;searchAttribute&quot;&gt;Components.interfaces.nsMsgSearchAttrib.Default&lt;/field&gt;</span>
<a href="#l11.88"></a><span id="l11.88">       &lt;field name=&quot;stringBundle&quot;&gt;</span>
<a href="#l11.89"></a><span id="l11.89">         &lt;![CDATA[</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineminus">-          Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineminus">-                    .getService(Components.interfaces.nsIStringBundleService)</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineminus">-                    .createBundle(&quot;chrome://messenger/locale/search-operators.properties&quot;)</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+          this.Services.strings.createBundle(&quot;chrome://messenger/locale/search-operators.properties&quot;)</span>
<a href="#l11.94"></a><span id="l11.94">         ]]&gt;</span>
<a href="#l11.95"></a><span id="l11.95">       &lt;/field&gt;</span>
<a href="#l11.96"></a><span id="l11.96">       &lt;property name=&quot;valueLabel&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l11.97"></a><span id="l11.97">         &lt;getter&gt;</span>
<a href="#l11.98"></a><span id="l11.98">           &lt;![CDATA[</span>
<a href="#l11.99"></a><span id="l11.99">             return this.stringBundle.GetStringFromName(this.value);</span>
<a href="#l11.100"></a><span id="l11.100">           ]]&gt;</span>
<a href="#l11.101"></a><span id="l11.101">         &lt;/getter&gt;</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineat">@@ -1724,16 +1717,21 @@</span>
<a href="#l11.103"></a><span id="l11.103">           ]]&gt;</span>
<a href="#l11.104"></a><span id="l11.104">         &lt;/setter&gt;</span>
<a href="#l11.105"></a><span id="l11.105">         &lt;getter&gt;</span>
<a href="#l11.106"></a><span id="l11.106">           &lt;![CDATA[</span>
<a href="#l11.107"></a><span id="l11.107">             return this.searchAttribute;</span>
<a href="#l11.108"></a><span id="l11.108">           ]]&gt;</span>
<a href="#l11.109"></a><span id="l11.109">         &lt;/getter&gt;</span>
<a href="#l11.110"></a><span id="l11.110">       &lt;/property&gt;</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineplus">+      &lt;constructor&gt;</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineplus">+        &lt;![CDATA[</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;, this);</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+        ]]&gt;</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineplus">+      &lt;/constructor&gt;</span>
<a href="#l11.116"></a><span id="l11.116">     &lt;/implementation&gt;</span>
<a href="#l11.117"></a><span id="l11.117">   &lt;/binding&gt;</span>
<a href="#l11.118"></a><span id="l11.118"> </span>
<a href="#l11.119"></a><span id="l11.119">   &lt;!-- searchvalue - a widget which dynamically changes its user interface</span>
<a href="#l11.120"></a><span id="l11.120">        depending on what type of data it's supposed to be showing</span>
<a href="#l11.121"></a><span id="l11.121">        currently handles arbitrary text entry, and menulists for</span>
<a href="#l11.122"></a><span id="l11.122">        priority, status, junk status, tags, hasAttachment status,</span>
<a href="#l11.123"></a><span id="l11.123">        and addressbook</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineat">@@ -2141,20 +2139,20 @@</span>
<a href="#l11.125"></a><span id="l11.125">         &lt;body&gt;</span>
<a href="#l11.126"></a><span id="l11.126">           &lt;![CDATA[</span>
<a href="#l11.127"></a><span id="l11.127">             this.fillStringsForChildren(menulist.firstChild, bundle);</span>
<a href="#l11.128"></a><span id="l11.128">           ]]&gt;</span>
<a href="#l11.129"></a><span id="l11.129">         &lt;/body&gt;</span>
<a href="#l11.130"></a><span id="l11.130">       &lt;/method&gt;</span>
<a href="#l11.131"></a><span id="l11.131">       &lt;constructor&gt;</span>
<a href="#l11.132"></a><span id="l11.132">       &lt;![CDATA[</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineplus">+        Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;, this);</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineplus">+</span>
<a href="#l11.135"></a><span id="l11.135">         // initialize strings</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineminus">-        var bundle = Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineminus">-                       .getService(Components.interfaces.nsIStringBundleService)</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineminus">-                       .createBundle(&quot;chrome://messenger/locale/messenger.properties&quot;);</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineplus">+        var bundle = this.Services.strings.createBundle(&quot;chrome://messenger/locale/messenger.properties&quot;);</span>
<a href="#l11.140"></a><span id="l11.140"> </span>
<a href="#l11.141"></a><span id="l11.141">         // intialize the priority picker</span>
<a href="#l11.142"></a><span id="l11.142">         this.initialize(document.getAnonymousNodes(this)[1], bundle);</span>
<a href="#l11.143"></a><span id="l11.143"> </span>
<a href="#l11.144"></a><span id="l11.144">         // initialize the status picker</span>
<a href="#l11.145"></a><span id="l11.145">         this.initialize(document.getAnonymousNodes(this)[2], bundle);</span>
<a href="#l11.146"></a><span id="l11.146"> </span>
<a href="#l11.147"></a><span id="l11.147">         // initialize the date picker</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineat">@@ -2455,24 +2453,23 @@</span>
<a href="#l11.149"></a><span id="l11.149">       &lt;property name=&quot;hasMessages&quot; readonly=&quot;true&quot; onget=&quot;return document.getAnonymousNodes(this)[0].hasChildNodes();&quot;/&gt;</span>
<a href="#l11.150"></a><span id="l11.150">       &lt;method name=&quot;parseFolder&quot;&gt;</span>
<a href="#l11.151"></a><span id="l11.151">         &lt;parameter name=&quot;aFolder&quot;/&gt;</span>
<a href="#l11.152"></a><span id="l11.152">         &lt;parameter name=&quot;aUrlListener&quot;/&gt;</span>
<a href="#l11.153"></a><span id="l11.153">         &lt;parameter name=&quot;aOutAsync&quot;/&gt;</span>
<a href="#l11.154"></a><span id="l11.154">         &lt;body&gt;</span>
<a href="#l11.155"></a><span id="l11.155">           &lt;![CDATA[</span>
<a href="#l11.156"></a><span id="l11.156">             // skip servers, Trash, Junk folders and newsgroups</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineplus">+</span>
<a href="#l11.158"></a><span id="l11.158">             if (!aFolder || aFolder.isServer ||</span>
<a href="#l11.159"></a><span id="l11.159">                 aFolder.getFlag(Components.interfaces.nsMsgFolderFlags.Junk) ||</span>
<a href="#l11.160"></a><span id="l11.160">                 aFolder.getFlag(Components.interfaces.nsMsgFolderFlags.Trash) ||</span>
<a href="#l11.161"></a><span id="l11.161">                 (aFolder.server instanceof Components.interfaces.nsINntpIncomingServer))</span>
<a href="#l11.162"></a><span id="l11.162">               return false;</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineminus">-            var pref = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineminus">-                                 .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineminus">-            var showPreviewText = pref.getBoolPref(&quot;mail.biff.alert.show_preview&quot;);</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineplus">+            var showPreviewText = this.Services.prefs.getBoolPref(&quot;mail.biff.alert.show_preview&quot;);</span>
<a href="#l11.167"></a><span id="l11.167">             var folderArray = new Array;</span>
<a href="#l11.168"></a><span id="l11.168">             if (aFolder.flags &amp; Components.interfaces.nsMsgFolderFlags.Virtual)</span>
<a href="#l11.169"></a><span id="l11.169">             {</span>
<a href="#l11.170"></a><span id="l11.170">               var dbFolderInfo = aFolder.msgDatabase.dBFolderInfo;</span>
<a href="#l11.171"></a><span id="l11.171">               var srchFolderUri = dbFolderInfo.getCharProperty(&quot;searchFolderUri&quot;);</span>
<a href="#l11.172"></a><span id="l11.172">               var srchFolderUriArray = srchFolderUri.split('|');</span>
<a href="#l11.173"></a><span id="l11.173">               var foldersAdded = 0;</span>
<a href="#l11.174"></a><span id="l11.174">               var RDF = Components.classes['@mozilla.org/rdf/rdf-service;1']</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineat">@@ -2609,16 +2606,21 @@</span>
<a href="#l11.176"></a><span id="l11.176">         &lt;body&gt;</span>
<a href="#l11.177"></a><span id="l11.177">           &lt;![CDATA[</span>
<a href="#l11.178"></a><span id="l11.178">             var containingBox = document.getAnonymousNodes(this)[0];</span>
<a href="#l11.179"></a><span id="l11.179">             while (containingBox.hasChildNodes())</span>
<a href="#l11.180"></a><span id="l11.180">               containingBox.removeChild(containingBox.lastChild);</span>
<a href="#l11.181"></a><span id="l11.181">           ]]&gt;</span>
<a href="#l11.182"></a><span id="l11.182">         &lt;/body&gt;</span>
<a href="#l11.183"></a><span id="l11.183">       &lt;/method&gt;</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineplus">+      &lt;constructor&gt;</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineplus">+        &lt;![CDATA[</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;, this);</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineplus">+        ]]&gt;</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineplus">+      &lt;/constructor&gt;</span>
<a href="#l11.189"></a><span id="l11.189">     &lt;/implementation&gt;</span>
<a href="#l11.190"></a><span id="l11.190">   &lt;/binding&gt;</span>
<a href="#l11.191"></a><span id="l11.191"> </span>
<a href="#l11.192"></a><span id="l11.192">   &lt;binding id=&quot;folderSummary-location&quot;&gt;</span>
<a href="#l11.193"></a><span id="l11.193">     &lt;content&gt;</span>
<a href="#l11.194"></a><span id="l11.194">       &lt;xul:hbox&gt;</span>
<a href="#l11.195"></a><span id="l11.195">         &lt;xul:label anonid=&quot;location&quot; xbl:inherits=&quot;value=location&quot;/&gt;</span>
<a href="#l11.196"></a><span id="l11.196">       &lt;/xul:hbox&gt;</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineat">@@ -2635,22 +2637,22 @@</span>
<a href="#l11.198"></a><span id="l11.198">         &lt;/xul:hbox&gt;</span>
<a href="#l11.199"></a><span id="l11.199">         &lt;xul:description anonid=&quot;preview&quot; class=&quot;folderSummary-message-row folderSummary-previewText&quot; xbl:inherits=&quot;value=previewText&quot; crop=&quot;right&quot;&gt;&lt;/xul:description&gt;</span>
<a href="#l11.200"></a><span id="l11.200">       &lt;/xul:vbox&gt;</span>
<a href="#l11.201"></a><span id="l11.201">     &lt;/content&gt;</span>
<a href="#l11.202"></a><span id="l11.202">     &lt;implementation&gt;</span>
<a href="#l11.203"></a><span id="l11.203">       &lt;constructor&gt;</span>
<a href="#l11.204"></a><span id="l11.204">         &lt;![CDATA[</span>
<a href="#l11.205"></a><span id="l11.205">           Components.utils.import(&quot;resource:///modules/MailUtils.js&quot;);</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineminus">-          var pref = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineminus">-                               .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineminus">-          if (!pref.getBoolPref(&quot;mail.biff.alert.show_preview&quot;))</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;, this);</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineplus">+</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineplus">+          if (!this.Services.prefs.getBoolPref(&quot;mail.biff.alert.show_preview&quot;))</span>
<a href="#l11.212"></a><span id="l11.212">             document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;preview&quot;).hidden = true;</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineminus">-          var hideSubject = !pref.getBoolPref(&quot;mail.biff.alert.show_subject&quot;);</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineminus">-          var hideSender = !pref.getBoolPref(&quot;mail.biff.alert.show_sender&quot;);</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineplus">+          var hideSubject = !this.Services.prefs.getBoolPref(&quot;mail.biff.alert.show_subject&quot;);</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineplus">+          var hideSender = !this.Services.prefs.getBoolPref(&quot;mail.biff.alert.show_sender&quot;);</span>
<a href="#l11.217"></a><span id="l11.217">           if (hideSubject)</span>
<a href="#l11.218"></a><span id="l11.218">             document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;subject&quot;).hidden = true;</span>
<a href="#l11.219"></a><span id="l11.219">           if (hideSender)</span>
<a href="#l11.220"></a><span id="l11.220">             document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;sender&quot;).hidden = true;</span>
<a href="#l11.221"></a><span id="l11.221">           if (hideSubject &amp;&amp; hideSender)</span>
<a href="#l11.222"></a><span id="l11.222">             document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;spring&quot;).hidden = true;</span>
<a href="#l11.223"></a><span id="l11.223">         ]]&gt;</span>
<a href="#l11.224"></a><span id="l11.224">       &lt;/constructor&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/base/content/mailWindow.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/base/content/mailWindow.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1,23 +1,23 @@</span>
<a href="#l12.4"></a><span id="l12.4"> /** ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l12.5"></a><span id="l12.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.6"></a><span id="l12.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.7"></a><span id="l12.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9"> Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l12.10"></a><span id="l12.10"> Components.utils.import(&quot;resource:///modules/appIdleManager.js&quot;);</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l12.12"></a><span id="l12.12"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l12.13"></a><span id="l12.13"> Components.utils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l12.14"></a><span id="l12.14"> Components.utils.import(&quot;resource:///modules/gloda/public.js&quot;);</span>
<a href="#l12.15"></a><span id="l12.15"> Components.utils.import(&quot;resource:///modules/glodaWebSearch.js&quot;);</span>
<a href="#l12.16"></a><span id="l12.16"> </span>
<a href="#l12.17"></a><span id="l12.17"> //This file stores variables common to mail windows</span>
<a href="#l12.18"></a><span id="l12.18"> var messenger;</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-var pref;</span>
<a href="#l12.20"></a><span id="l12.20"> var statusFeedback;</span>
<a href="#l12.21"></a><span id="l12.21"> var msgWindow;</span>
<a href="#l12.22"></a><span id="l12.22"> </span>
<a href="#l12.23"></a><span id="l12.23"> var accountManager;</span>
<a href="#l12.24"></a><span id="l12.24"> </span>
<a href="#l12.25"></a><span id="l12.25"> var gContextMenu;</span>
<a href="#l12.26"></a><span id="l12.26"> var gMailWindowLog = Log4Moz.getConfiguredLogger(&quot;mailWindow&quot;, Log4Moz.Level.Debug, Log4Moz.Level.Debug, Log4Moz.Level.Debug);</span>
<a href="#l12.27"></a><span id="l12.27"> </span>
<a href="#l12.28"></a><span id="l12.28" class="difflineat">@@ -56,19 +56,16 @@ function OnMailWindowUnload()</span>
<a href="#l12.29"></a><span id="l12.29"> }</span>
<a href="#l12.30"></a><span id="l12.30"> </span>
<a href="#l12.31"></a><span id="l12.31"> function CreateMailWindowGlobals()</span>
<a href="#l12.32"></a><span id="l12.32"> {</span>
<a href="#l12.33"></a><span id="l12.33">   // get the messenger instance</span>
<a href="#l12.34"></a><span id="l12.34">   messenger = Components.classes[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l12.35"></a><span id="l12.35">                         .createInstance(Components.interfaces.nsIMessenger);</span>
<a href="#l12.36"></a><span id="l12.36"> </span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-  pref = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineminus">-          .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineminus">-</span>
<a href="#l12.40"></a><span id="l12.40">   window.addEventListener(&quot;blur&quot;, appIdleManager.onBlur, false);</span>
<a href="#l12.41"></a><span id="l12.41">   window.addEventListener(&quot;focus&quot;, appIdleManager.onFocus, false);</span>
<a href="#l12.42"></a><span id="l12.42"> </span>
<a href="#l12.43"></a><span id="l12.43">   //Create windows status feedback</span>
<a href="#l12.44"></a><span id="l12.44">   // set the JS implementation of status feedback before creating the c++ one..</span>
<a href="#l12.45"></a><span id="l12.45">   window.MsgStatusFeedback = new nsMsgStatusFeedback();</span>
<a href="#l12.46"></a><span id="l12.46">   // double register the status feedback object as the xul browser window implementation</span>
<a href="#l12.47"></a><span id="l12.47">   window.QueryInterface(Components.interfaces.nsIInterfaceRequestor)</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineat">@@ -434,19 +431,17 @@ nsMsgWindowCommands.prototype =</span>
<a href="#l12.49"></a><span id="l12.49"> function loadStartPage(aForce)</span>
<a href="#l12.50"></a><span id="l12.50"> {</span>
<a href="#l12.51"></a><span id="l12.51">   // If the preference isn't enabled, then don't load anything.</span>
<a href="#l12.52"></a><span id="l12.52">   if (!aForce &amp;&amp;</span>
<a href="#l12.53"></a><span id="l12.53">       !Application.prefs.getValue(&quot;mailnews.start_page.enabled&quot;, false))</span>
<a href="#l12.54"></a><span id="l12.54">     return;</span>
<a href="#l12.55"></a><span id="l12.55"> </span>
<a href="#l12.56"></a><span id="l12.56">   gMessageNotificationBar.clearMsgNotifications();</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineminus">-  let startpage = Components.classes[&quot;@mozilla.org/toolkit/URLFormatterService;1&quot;]</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineminus">-                            .getService(Components.interfaces.nsIURLFormatter)</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineminus">-                            .formatURLPref(&quot;mailnews.start_page.url&quot;);</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+  let startpage = Services.urlFormatter.formatURLPref(&quot;mailnews.start_page.url&quot;);</span>
<a href="#l12.61"></a><span id="l12.61">   if (startpage)</span>
<a href="#l12.62"></a><span id="l12.62">   {</span>
<a href="#l12.63"></a><span id="l12.63">     try {</span>
<a href="#l12.64"></a><span id="l12.64">       let urifixup = Components.classes[&quot;@mozilla.org/docshell/urifixup;1&quot;]</span>
<a href="#l12.65"></a><span id="l12.65">                                .getService(Components.interfaces.nsIURIFixup);</span>
<a href="#l12.66"></a><span id="l12.66"> </span>
<a href="#l12.67"></a><span id="l12.67">       let uri = urifixup.createFixupURI(startpage, 0);</span>
<a href="#l12.68"></a><span id="l12.68">       GetMessagePaneFrame().location.href = uri.spec;</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineat">@@ -661,20 +656,17 @@ nsBrowserAccess.prototype = {</span>
<a href="#l12.70"></a><span id="l12.70"> </span>
<a href="#l12.71"></a><span id="l12.71">     newWindow = newTab.browser.docShell</span>
<a href="#l12.72"></a><span id="l12.72">                       .QueryInterface(Components.interfaces.nsIInterfaceRequestor)</span>
<a href="#l12.73"></a><span id="l12.73">                       .getInterface(Components.interfaces.nsIDOMWindow);</span>
<a href="#l12.74"></a><span id="l12.74">     try {</span>
<a href="#l12.75"></a><span id="l12.75">       if (aURI) {</span>
<a href="#l12.76"></a><span id="l12.76">         if (aOpener) {</span>
<a href="#l12.77"></a><span id="l12.77">           let location = aOpener.location;</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineminus">-          let referrer =</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineminus">-            Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineminus">-                      .getService(Components.interfaces.nsIIOService)</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineminus">-                      .newURI(location, null, null);</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+          let referrer = Services.io.newURI(location, null, null);</span>
<a href="#l12.83"></a><span id="l12.83">         }</span>
<a href="#l12.84"></a><span id="l12.84">         newWindow.QueryInterface(Components.interfaces.nsIInterfaceRequestor)</span>
<a href="#l12.85"></a><span id="l12.85">                  .getInterface(Components.interfaces.nsIWebNavigation)</span>
<a href="#l12.86"></a><span id="l12.86">                  .loadURI(aURI.spec, loadflags, referrer, null, null);</span>
<a href="#l12.87"></a><span id="l12.87">       }</span>
<a href="#l12.88"></a><span id="l12.88">       if (needToFocusWin || (!loadInBackground &amp;&amp; isExternal))</span>
<a href="#l12.89"></a><span id="l12.89">         newWindow.focus();</span>
<a href="#l12.90"></a><span id="l12.90">     } catch(e) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -1,14 +1,15 @@</span>
<a href="#l13.4"></a><span id="l13.4"> /* -*- indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l13.5"></a><span id="l13.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.6"></a><span id="l13.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.7"></a><span id="l13.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9"> Components.utils.import(&quot;resource:///modules/gloda/dbview.js&quot;);</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12"> const ADDR_DB_LARGE_COMMIT       = 1;</span>
<a href="#l13.13"></a><span id="l13.13"> </span>
<a href="#l13.14"></a><span id="l13.14"> const kClassicMailLayout = 0;</span>
<a href="#l13.15"></a><span id="l13.15"> const kWideMailLayout = 1;</span>
<a href="#l13.16"></a><span id="l13.16"> const kVerticalMailLayout = 2;</span>
<a href="#l13.17"></a><span id="l13.17"> const kMailLayoutCommandMap =</span>
<a href="#l13.18"></a><span id="l13.18"> {</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineat">@@ -27,20 +28,18 @@ const kAllowRemoteContent = 2;</span>
<a href="#l13.20"></a><span id="l13.20"> </span>
<a href="#l13.21"></a><span id="l13.21"> const kMsgNotificationPhishingBar = 1;</span>
<a href="#l13.22"></a><span id="l13.22"> const kMsgNotificationJunkBar = 2;</span>
<a href="#l13.23"></a><span id="l13.23"> const kMsgNotificationRemoteImages = 3;</span>
<a href="#l13.24"></a><span id="l13.24"> const kMsgNotificationMDN = 4;</span>
<a href="#l13.25"></a><span id="l13.25"> </span>
<a href="#l13.26"></a><span id="l13.26"> Components.utils.import(&quot;resource:///modules/MailUtils.js&quot;);</span>
<a href="#l13.27"></a><span id="l13.27"> Components.utils.import(&quot;resource:///modules/MailConsts.js&quot;);</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineminus">-var gPrefBranch = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-                            .getService(Components.interfaces.nsIPrefService)</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-                            .getBranch(null);</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+</span>
<a href="#l13.34"></a><span id="l13.34"> var gCopyService = Components.classes[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l13.35"></a><span id="l13.35">                      .getService(Components.interfaces.nsIMsgCopyService);</span>
<a href="#l13.36"></a><span id="l13.36"> </span>
<a href="#l13.37"></a><span id="l13.37"> // Timer to mark read, if the user has configured the app to mark a message as</span>
<a href="#l13.38"></a><span id="l13.38"> // read if it is viewed for more than n seconds.</span>
<a href="#l13.39"></a><span id="l13.39"> var gMarkViewedMessageAsReadTimer = null;</span>
<a href="#l13.40"></a><span id="l13.40"> </span>
<a href="#l13.41"></a><span id="l13.41"> // the user preference,</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineat">@@ -52,28 +51,28 @@ var gDisallow_classes_no_html = 1;</span>
<a href="#l13.43"></a><span id="l13.43"> // Disable the new account menu item if the account preference is locked.</span>
<a href="#l13.44"></a><span id="l13.44"> // The other affected areas are the account central, the account manager</span>
<a href="#l13.45"></a><span id="l13.45"> // dialog, and the account provisioner window.</span>
<a href="#l13.46"></a><span id="l13.46"> function menu_new_init()</span>
<a href="#l13.47"></a><span id="l13.47"> {</span>
<a href="#l13.48"></a><span id="l13.48">   // If the account provisioner is pref'd off, we shouldn't display the menu</span>
<a href="#l13.49"></a><span id="l13.49">   // item.</span>
<a href="#l13.50"></a><span id="l13.50">   ShowMenuItem(&quot;newCreateEmailAccountMenuItem&quot;,</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineminus">-               gPrefBranch.getBoolPref(&quot;mail.provider.enabled&quot;));</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+               Services.prefs.getBoolPref(&quot;mail.provider.enabled&quot;));</span>
<a href="#l13.53"></a><span id="l13.53"> </span>
<a href="#l13.54"></a><span id="l13.54">   // If we don't have a gFolderDisplay, just get out of here and leave the menu</span>
<a href="#l13.55"></a><span id="l13.55">   // as it is.</span>
<a href="#l13.56"></a><span id="l13.56">   if (!gFolderDisplay)</span>
<a href="#l13.57"></a><span id="l13.57">     return;</span>
<a href="#l13.58"></a><span id="l13.58"> </span>
<a href="#l13.59"></a><span id="l13.59">   let folder = gFolderDisplay.displayedFolder;</span>
<a href="#l13.60"></a><span id="l13.60">   if (!folder)</span>
<a href="#l13.61"></a><span id="l13.61">     return;</span>
<a href="#l13.62"></a><span id="l13.62"> </span>
<a href="#l13.63"></a><span id="l13.63" class="difflineminus">-  if (gPrefBranch.prefIsLocked(&quot;mail.disable_new_account_addition&quot;))</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+  if (Services.prefs.prefIsLocked(&quot;mail.disable_new_account_addition&quot;))</span>
<a href="#l13.65"></a><span id="l13.65">     document.getElementById(&quot;newAccountMenuItem&quot;).setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l13.66"></a><span id="l13.66"> </span>
<a href="#l13.67"></a><span id="l13.67">   const nsMsgFolderFlags = Components.interfaces.nsMsgFolderFlags;</span>
<a href="#l13.68"></a><span id="l13.68">   var isInbox = folder.isSpecialFolder(nsMsgFolderFlags.Inbox);</span>
<a href="#l13.69"></a><span id="l13.69">   var showNew = folder.canCreateSubfolders ||</span>
<a href="#l13.70"></a><span id="l13.70">                 (isInbox &amp;&amp; !(folder.flags &amp; nsMsgFolderFlags.Virtual));</span>
<a href="#l13.71"></a><span id="l13.71">   ShowMenuItem(&quot;menu_newFolder&quot;, showNew);</span>
<a href="#l13.72"></a><span id="l13.72">   ShowMenuItem(&quot;menu_newVirtualFolder&quot;, showNew);</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineat">@@ -221,26 +220,26 @@ function view_init()</span>
<a href="#l13.74"></a><span id="l13.74">                             &quot;bodyFeedPerFolderPref&quot;];</span>
<a href="#l13.75"></a><span id="l13.75">   let checked = FeedMessageHandler.onSelectPref;</span>
<a href="#l13.76"></a><span id="l13.76">   for each (let [index, id] in Iterator(viewRssMenuItemIds)) {</span>
<a href="#l13.77"></a><span id="l13.77">     document.getElementById(id)</span>
<a href="#l13.78"></a><span id="l13.78">             .setAttribute(&quot;checked&quot;, index == checked);</span>
<a href="#l13.79"></a><span id="l13.79">   }</span>
<a href="#l13.80"></a><span id="l13.80"> </span>
<a href="#l13.81"></a><span id="l13.81">   // Initialize the View Attachment Inline menu</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineminus">-  var viewAttachmentInline = pref.getBoolPref(&quot;mail.inline_attachments&quot;);</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+  var viewAttachmentInline = Services.prefs.getBoolPref(&quot;mail.inline_attachments&quot;);</span>
<a href="#l13.84"></a><span id="l13.84">   document.getElementById(&quot;viewAttachmentsInlineMenuitem&quot;)</span>
<a href="#l13.85"></a><span id="l13.85">           .setAttribute(&quot;checked&quot;, viewAttachmentInline);</span>
<a href="#l13.86"></a><span id="l13.86"> </span>
<a href="#l13.87"></a><span id="l13.87">   document.commandDispatcher.updateCommands('create-menu-view');</span>
<a href="#l13.88"></a><span id="l13.88"> }</span>
<a href="#l13.89"></a><span id="l13.89"> </span>
<a href="#l13.90"></a><span id="l13.90"> function InitViewLayoutStyleMenu(event)</span>
<a href="#l13.91"></a><span id="l13.91"> {</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineminus">-  var paneConfig = pref.getIntPref(&quot;mail.pane_config.dynamic&quot;);</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineplus">+  var paneConfig = Services.prefs.getIntPref(&quot;mail.pane_config.dynamic&quot;);</span>
<a href="#l13.94"></a><span id="l13.94">   var layoutStyleMenuitem = event.target.childNodes[paneConfig];</span>
<a href="#l13.95"></a><span id="l13.95">   if (layoutStyleMenuitem)</span>
<a href="#l13.96"></a><span id="l13.96">     layoutStyleMenuitem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l13.97"></a><span id="l13.97"> }</span>
<a href="#l13.98"></a><span id="l13.98"> </span>
<a href="#l13.99"></a><span id="l13.99"> /**</span>
<a href="#l13.100"></a><span id="l13.100">  * Initialize (check) appropriate folder mode under the View | Folder menu.</span>
<a href="#l13.101"></a><span id="l13.101">  */</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineat">@@ -528,34 +527,34 @@ function InitAppMessageMenu()</span>
<a href="#l13.103"></a><span id="l13.103">  * Initializes the menu item aMenuItem to show either &quot;Move&quot; or &quot;Copy&quot; to</span>
<a href="#l13.104"></a><span id="l13.104">  * folder again, based on the value of mail.last_msg_movecopy_target_uri.</span>
<a href="#l13.105"></a><span id="l13.105">  * The menu item label and accesskey are adjusted to include the folder name.</span>
<a href="#l13.106"></a><span id="l13.106">  *</span>
<a href="#l13.107"></a><span id="l13.107">  * @param aMenuItem the menu item to adjust</span>
<a href="#l13.108"></a><span id="l13.108">  */</span>
<a href="#l13.109"></a><span id="l13.109"> function initMoveToFolderAgainMenu(aMenuItem)</span>
<a href="#l13.110"></a><span id="l13.110"> {</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineminus">-  var lastFolderURI = pref.getCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;);</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineminus">-  var isMove = pref.getBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;);</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineplus">+  var lastFolderURI = Services.prefs.getCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;);</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineplus">+  var isMove = Services.prefs.getBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;);</span>
<a href="#l13.115"></a><span id="l13.115">   if (lastFolderURI)</span>
<a href="#l13.116"></a><span id="l13.116">   {</span>
<a href="#l13.117"></a><span id="l13.117">     var destMsgFolder = GetMsgFolderFromUri(lastFolderURI);</span>
<a href="#l13.118"></a><span id="l13.118">     var bundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l13.119"></a><span id="l13.119">     var stringName = isMove ? &quot;moveToFolderAgain&quot; : &quot;copyToFolderAgain&quot;;</span>
<a href="#l13.120"></a><span id="l13.120">     aMenuItem.label = bundle.getFormattedString(stringName,</span>
<a href="#l13.121"></a><span id="l13.121">                                                 [destMsgFolder.prettyName], 1);</span>
<a href="#l13.122"></a><span id="l13.122">     // This gives us moveToFolderAgainAccessKey and copyToFolderAgainAccessKey.</span>
<a href="#l13.123"></a><span id="l13.123">     aMenuItem.accesskey = bundle.getString(stringName + &quot;AccessKey&quot;);</span>
<a href="#l13.124"></a><span id="l13.124">   }</span>
<a href="#l13.125"></a><span id="l13.125"> }</span>
<a href="#l13.126"></a><span id="l13.126"> </span>
<a href="#l13.127"></a><span id="l13.127"> function InitViewHeadersMenu()</span>
<a href="#l13.128"></a><span id="l13.128"> {</span>
<a href="#l13.129"></a><span id="l13.129">   const dt = Components.interfaces.nsMimeHeaderDisplayTypes;</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineminus">-  var headerchoice = pref.getIntPref(&quot;mail.show_headers&quot;);</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineplus">+  var headerchoice = Services.prefs.getIntPref(&quot;mail.show_headers&quot;);</span>
<a href="#l13.132"></a><span id="l13.132">   document.getElementById(&quot;cmd_viewAllHeader&quot;)</span>
<a href="#l13.133"></a><span id="l13.133">           .setAttribute(&quot;checked&quot;, headerchoice == dt.AllHeaders);</span>
<a href="#l13.134"></a><span id="l13.134">   document.getElementById(&quot;cmd_viewNormalHeader&quot;)</span>
<a href="#l13.135"></a><span id="l13.135">           .setAttribute(&quot;checked&quot;, headerchoice == dt.NormalHeaders);</span>
<a href="#l13.136"></a><span id="l13.136">   document.commandDispatcher.updateCommands(&quot;create-menu-mark&quot;);</span>
<a href="#l13.137"></a><span id="l13.137"> }</span>
<a href="#l13.138"></a><span id="l13.138"> </span>
<a href="#l13.139"></a><span id="l13.139"> /**</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineat">@@ -580,25 +579,25 @@ function InitViewBodyMenu()</span>
<a href="#l13.141"></a><span id="l13.141">                       &quot;bodyAsPlaintext&quot;,</span>
<a href="#l13.142"></a><span id="l13.142">                       &quot;bodyAllParts&quot;];</span>
<a href="#l13.143"></a><span id="l13.143">   const rssIDs = [&quot;bodyFeedSummaryAllowHTML&quot;,</span>
<a href="#l13.144"></a><span id="l13.144">                   &quot;bodyFeedSummarySanitized&quot;,</span>
<a href="#l13.145"></a><span id="l13.145">                   &quot;bodyFeedSummaryAsPlaintext&quot;];</span>
<a href="#l13.146"></a><span id="l13.146">   var menuIDs = isFeed ? rssIDs : defaultIDs;</span>
<a href="#l13.147"></a><span id="l13.147">   try</span>
<a href="#l13.148"></a><span id="l13.148">   {</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineminus">-    prefer_plaintext = pref.getBoolPref(&quot;mailnews.display.prefer_plaintext&quot;);</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineminus">-    html_as = pref.getIntPref(&quot;mailnews.display.html_as&quot;);</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineminus">-    disallow_classes = pref.getIntPref(&quot;mailnews.display.disallow_mime_handlers&quot;);</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineplus">+    prefer_plaintext = Services.prefs.getBoolPref(&quot;mailnews.display.prefer_plaintext&quot;);</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineplus">+    html_as = Services.prefs.getIntPref(&quot;mailnews.display.html_as&quot;);</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineplus">+    disallow_classes = Services.prefs.getIntPref(&quot;mailnews.display.disallow_mime_handlers&quot;);</span>
<a href="#l13.155"></a><span id="l13.155"> </span>
<a href="#l13.156"></a><span id="l13.156">     // Separate render prefs not implemented for feeds, bug 458606.  Show the</span>
<a href="#l13.157"></a><span id="l13.157">     // checked item for feeds as for the regular pref.</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineminus">-    //  prefer_plaintext = pref.getBoolPref(&quot;rss.display.prefer_plaintext&quot;);</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineminus">-    //  html_as = pref.getIntPref(&quot;rss.display.html_as&quot;);</span>
<a href="#l13.160"></a><span id="l13.160" class="difflineminus">-    //  disallow_classes = pref.getIntPref(&quot;rss.display.disallow_mime_handlers&quot;);</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineplus">+    //  prefer_plaintext = Services.prefs.getBoolPref(&quot;rss.display.prefer_plaintext&quot;);</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineplus">+    //  html_as = Services.prefs.getIntPref(&quot;rss.display.html_as&quot;);</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineplus">+    //  disallow_classes = Services.prefs.getIntPref(&quot;rss.display.disallow_mime_handlers&quot;);</span>
<a href="#l13.164"></a><span id="l13.164"> </span>
<a href="#l13.165"></a><span id="l13.165">     if (disallow_classes &gt; 0)</span>
<a href="#l13.166"></a><span id="l13.166">       gDisallow_classes_no_html = disallow_classes;</span>
<a href="#l13.167"></a><span id="l13.167">     // else gDisallow_classes_no_html keeps its inital value (see top)</span>
<a href="#l13.168"></a><span id="l13.168">   }</span>
<a href="#l13.169"></a><span id="l13.169">   catch (ex)</span>
<a href="#l13.170"></a><span id="l13.170">   {</span>
<a href="#l13.171"></a><span id="l13.171">     dump(&quot;failed to get the body plaintext vs. HTML prefs\n&quot;);</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineat">@@ -606,17 +605,17 @@ function InitViewBodyMenu()</span>
<a href="#l13.173"></a><span id="l13.173"> </span>
<a href="#l13.174"></a><span id="l13.174">   var AllowHTML_menuitem = document.getElementById(menuIDs[0]);</span>
<a href="#l13.175"></a><span id="l13.175">   var Sanitized_menuitem = document.getElementById(menuIDs[1]);</span>
<a href="#l13.176"></a><span id="l13.176">   var AsPlaintext_menuitem = document.getElementById(menuIDs[2]);</span>
<a href="#l13.177"></a><span id="l13.177">   var AllBodyParts_menuitem = menuIDs[3] ? document.getElementById(menuIDs[3])</span>
<a href="#l13.178"></a><span id="l13.178">         : null;</span>
<a href="#l13.179"></a><span id="l13.179"> </span>
<a href="#l13.180"></a><span id="l13.180">   document.getElementById(&quot;bodyAllParts&quot;).hidden = </span>
<a href="#l13.181"></a><span id="l13.181" class="difflineminus">-    ! pref.getBoolPref(&quot;mailnews.display.show_all_body_parts_menu&quot;);</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineplus">+    ! Services.prefs.getBoolPref(&quot;mailnews.display.show_all_body_parts_menu&quot;);</span>
<a href="#l13.183"></a><span id="l13.183"> </span>
<a href="#l13.184"></a><span id="l13.184">   if (!prefer_plaintext &amp;&amp; !html_as &amp;&amp; !disallow_classes &amp;&amp;</span>
<a href="#l13.185"></a><span id="l13.185">       AllowHTML_menuitem)</span>
<a href="#l13.186"></a><span id="l13.186">     AllowHTML_menuitem.setAttribute(&quot;checked&quot;, true);</span>
<a href="#l13.187"></a><span id="l13.187">   else if (!prefer_plaintext &amp;&amp; html_as == 3 &amp;&amp; disallow_classes &gt; 0 &amp;&amp;</span>
<a href="#l13.188"></a><span id="l13.188">       Sanitized_menuitem)</span>
<a href="#l13.189"></a><span id="l13.189">     Sanitized_menuitem.setAttribute(&quot;checked&quot;, true);</span>
<a href="#l13.190"></a><span id="l13.190">   else if (prefer_plaintext &amp;&amp; html_as == 1 &amp;&amp; disallow_classes &gt; 0 &amp;&amp;</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineat">@@ -646,37 +645,37 @@ function InitAppmenuViewBodyMenu()</span>
<a href="#l13.192"></a><span id="l13.192">                        &quot;appmenu_bodyAsPlaintext&quot;,</span>
<a href="#l13.193"></a><span id="l13.193">                        &quot;appmenu_bodyAllParts&quot;];</span>
<a href="#l13.194"></a><span id="l13.194">   const kRssIDs = [&quot;appmenu_bodyFeedSummaryAllowHTML&quot;,</span>
<a href="#l13.195"></a><span id="l13.195">                    &quot;appmenu_bodyFeedSummarySanitized&quot;,</span>
<a href="#l13.196"></a><span id="l13.196">                    &quot;appmenu_bodyFeedSummaryAsPlaintext&quot;];</span>
<a href="#l13.197"></a><span id="l13.197">   let menuIDs = isFeed ? kRssIDs : kDefaultIDs;</span>
<a href="#l13.198"></a><span id="l13.198">   // Get prefs</span>
<a href="#l13.199"></a><span id="l13.199">   if (isFeed) {</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineminus">-    prefer_plaintext = pref.getBoolPref(&quot;rss.display.prefer_plaintext&quot;);</span>
<a href="#l13.201"></a><span id="l13.201" class="difflineminus">-    html_as = pref.getIntPref(&quot;rss.display.html_as&quot;);</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineminus">-    disallow_classes = pref.getIntPref(&quot;rss.display.disallow_mime_handlers&quot;);</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineplus">+    prefer_plaintext = Services.prefs.getBoolPref(&quot;rss.display.prefer_plaintext&quot;);</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineplus">+    html_as = Services.prefs.getIntPref(&quot;rss.display.html_as&quot;);</span>
<a href="#l13.205"></a><span id="l13.205" class="difflineplus">+    disallow_classes = Services.prefs.getIntPref(&quot;rss.display.disallow_mime_handlers&quot;);</span>
<a href="#l13.206"></a><span id="l13.206">   } else {</span>
<a href="#l13.207"></a><span id="l13.207" class="difflineminus">-    prefer_plaintext = pref.getBoolPref(&quot;mailnews.display.prefer_plaintext&quot;);</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineminus">-    html_as = pref.getIntPref(&quot;mailnews.display.html_as&quot;);</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineminus">-    disallow_classes = pref.getIntPref(&quot;mailnews.display.disallow_mime_handlers&quot;);</span>
<a href="#l13.210"></a><span id="l13.210" class="difflineplus">+    prefer_plaintext = Services.prefs.getBoolPref(&quot;mailnews.display.prefer_plaintext&quot;);</span>
<a href="#l13.211"></a><span id="l13.211" class="difflineplus">+    html_as = Services.prefs.getIntPref(&quot;mailnews.display.html_as&quot;);</span>
<a href="#l13.212"></a><span id="l13.212" class="difflineplus">+    disallow_classes = Services.prefs.getIntPref(&quot;mailnews.display.disallow_mime_handlers&quot;);</span>
<a href="#l13.213"></a><span id="l13.213">   }</span>
<a href="#l13.214"></a><span id="l13.214"> </span>
<a href="#l13.215"></a><span id="l13.215">   if (disallow_classes &gt; 0)</span>
<a href="#l13.216"></a><span id="l13.216">     gDisallow_classes_no_html = disallow_classes;</span>
<a href="#l13.217"></a><span id="l13.217">   // else gDisallow_classes_no_html keeps its inital value (see top)</span>
<a href="#l13.218"></a><span id="l13.218"> </span>
<a href="#l13.219"></a><span id="l13.219">   let AllowHTML_menuitem = document.getElementById(menuIDs[0]);</span>
<a href="#l13.220"></a><span id="l13.220">   let Sanitized_menuitem = document.getElementById(menuIDs[1]);</span>
<a href="#l13.221"></a><span id="l13.221">   let AsPlaintext_menuitem = document.getElementById(menuIDs[2]);</span>
<a href="#l13.222"></a><span id="l13.222">   let AllBodyParts_menuitem = menuIDs[3] ? document.getElementById(menuIDs[3])</span>
<a href="#l13.223"></a><span id="l13.223">                                          : null;</span>
<a href="#l13.224"></a><span id="l13.224"> </span>
<a href="#l13.225"></a><span id="l13.225">   document.getElementById(&quot;appmenu_bodyAllParts&quot;).hidden =</span>
<a href="#l13.226"></a><span id="l13.226" class="difflineminus">-    !pref.getBoolPref(&quot;mailnews.display.show_all_body_parts_menu&quot;);</span>
<a href="#l13.227"></a><span id="l13.227" class="difflineplus">+    !Services.prefs.getBoolPref(&quot;mailnews.display.show_all_body_parts_menu&quot;);</span>
<a href="#l13.228"></a><span id="l13.228"> </span>
<a href="#l13.229"></a><span id="l13.229">   if (!prefer_plaintext &amp;&amp; !html_as &amp;&amp; !disallow_classes &amp;&amp;</span>
<a href="#l13.230"></a><span id="l13.230">       AllowHTML_menuitem)</span>
<a href="#l13.231"></a><span id="l13.231">     AllowHTML_menuitem.setAttribute(&quot;checked&quot;, true);</span>
<a href="#l13.232"></a><span id="l13.232">   else if (!prefer_plaintext &amp;&amp; html_as == 3 &amp;&amp; disallow_classes &gt; 0 &amp;&amp;</span>
<a href="#l13.233"></a><span id="l13.233">            Sanitized_menuitem)</span>
<a href="#l13.234"></a><span id="l13.234">     Sanitized_menuitem.setAttribute(&quot;checked&quot;, true);</span>
<a href="#l13.235"></a><span id="l13.235">   else if (prefer_plaintext &amp;&amp; html_as == 1 &amp;&amp; disallow_classes &gt; 0 &amp;&amp;</span>
<a href="#l13.236"></a><span id="l13.236" class="difflineat">@@ -1492,30 +1491,30 @@ function MsgCopyMessage(aDestFolder)</span>
<a href="#l13.237"></a><span id="l13.237">                                                             .nsIFileURL).file;</span>
<a href="#l13.238"></a><span id="l13.238">     MailServices.copy.CopyFileMessage(file, aDestFolder, null, false,</span>
<a href="#l13.239"></a><span id="l13.239">                                       Components.interfaces.nsMsgMessageFlags.Read,</span>
<a href="#l13.240"></a><span id="l13.240">                                       &quot;&quot;, null, msgWindow);</span>
<a href="#l13.241"></a><span id="l13.241">   }</span>
<a href="#l13.242"></a><span id="l13.242">   else</span>
<a href="#l13.243"></a><span id="l13.243">     gDBView.doCommandWithFolder(nsMsgViewCommandType.copyMessages, aDestFolder);</span>
<a href="#l13.244"></a><span id="l13.244"> </span>
<a href="#l13.245"></a><span id="l13.245" class="difflineminus">-  pref.setCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;, aDestFolder.URI);</span>
<a href="#l13.246"></a><span id="l13.246" class="difflineminus">-  pref.setBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;, false);</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineplus">+  Services.prefs.setCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;, aDestFolder.URI);</span>
<a href="#l13.248"></a><span id="l13.248" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;, false);</span>
<a href="#l13.249"></a><span id="l13.249"> }</span>
<a href="#l13.250"></a><span id="l13.250"> </span>
<a href="#l13.251"></a><span id="l13.251"> /**</span>
<a href="#l13.252"></a><span id="l13.252">  * Moves the selected messages to the destination folder</span>
<a href="#l13.253"></a><span id="l13.253">  * @param aDestFolder  the destination folder</span>
<a href="#l13.254"></a><span id="l13.254">  */</span>
<a href="#l13.255"></a><span id="l13.255"> function MsgMoveMessage(aDestFolder)</span>
<a href="#l13.256"></a><span id="l13.256"> {</span>
<a href="#l13.257"></a><span id="l13.257">   gFolderDisplay.hintAboutToDeleteMessages();</span>
<a href="#l13.258"></a><span id="l13.258">   gDBView.doCommandWithFolder(nsMsgViewCommandType.moveMessages, aDestFolder);</span>
<a href="#l13.259"></a><span id="l13.259" class="difflineminus">-  pref.setCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;, aDestFolder.URI);</span>
<a href="#l13.260"></a><span id="l13.260" class="difflineminus">-  pref.setBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;, true);</span>
<a href="#l13.261"></a><span id="l13.261" class="difflineplus">+  Services.prefs.setCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;, aDestFolder.URI);</span>
<a href="#l13.262"></a><span id="l13.262" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;, true);</span>
<a href="#l13.263"></a><span id="l13.263"> }</span>
<a href="#l13.264"></a><span id="l13.264"> </span>
<a href="#l13.265"></a><span id="l13.265"> /**</span>
<a href="#l13.266"></a><span id="l13.266">  * Calls the ComposeMessage function with the desired type, and proper default</span>
<a href="#l13.267"></a><span id="l13.267">  * based on the event that fired it.</span>
<a href="#l13.268"></a><span id="l13.268">  *</span>
<a href="#l13.269"></a><span id="l13.269">  * @param aCompType  the nsIMsgCompType to pass to the function</span>
<a href="#l13.270"></a><span id="l13.270">  * @param aEvent (optional) the event that triggered the call</span>
<a href="#l13.271"></a><span id="l13.271" class="difflineat">@@ -1826,17 +1825,17 @@ function MsgArchiveSelectedMessages(even</span>
<a href="#l13.272"></a><span id="l13.272">   let batchMover = new BatchMessageMover();</span>
<a href="#l13.273"></a><span id="l13.273">   batchMover.archiveMessages(gFolderDisplay.selectedMessages);</span>
<a href="#l13.274"></a><span id="l13.274"> }</span>
<a href="#l13.275"></a><span id="l13.275"> </span>
<a href="#l13.276"></a><span id="l13.276"> function MsgForwardMessage(event)</span>
<a href="#l13.277"></a><span id="l13.277"> {</span>
<a href="#l13.278"></a><span id="l13.278">   var forwardType = 0;</span>
<a href="#l13.279"></a><span id="l13.279">   try {</span>
<a href="#l13.280"></a><span id="l13.280" class="difflineminus">-    forwardType = gPrefBranch.getIntPref(&quot;mail.forward_message_mode&quot;);</span>
<a href="#l13.281"></a><span id="l13.281" class="difflineplus">+    forwardType = Services.prefs.getIntPref(&quot;mail.forward_message_mode&quot;);</span>
<a href="#l13.282"></a><span id="l13.282">   }</span>
<a href="#l13.283"></a><span id="l13.283">   catch (ex) {</span>
<a href="#l13.284"></a><span id="l13.284">     dump(&quot;failed to retrieve pref mail.forward_message_mode&quot;);</span>
<a href="#l13.285"></a><span id="l13.285">   }</span>
<a href="#l13.286"></a><span id="l13.286"> </span>
<a href="#l13.287"></a><span id="l13.287">   // mail.forward_message_mode could be 1, if the user migrated from 4.x</span>
<a href="#l13.288"></a><span id="l13.288">   // 1 (forward as quoted) is obsolete, so we treat is as forward inline</span>
<a href="#l13.289"></a><span id="l13.289">   // since that is more like forward as quoted then forward as attachment</span>
<a href="#l13.290"></a><span id="l13.290" class="difflineat">@@ -1966,19 +1965,17 @@ function MsgSubscribe()</span>
<a href="#l13.291"></a><span id="l13.291"> function ConfirmUnsubscribe(folders)</span>
<a href="#l13.292"></a><span id="l13.292"> {</span>
<a href="#l13.293"></a><span id="l13.293">   var bundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l13.294"></a><span id="l13.294">   var titleMsg = bundle.getString(&quot;confirmUnsubscribeTitle&quot;);</span>
<a href="#l13.295"></a><span id="l13.295">   var dialogMsg = (folders.length == 1) ?</span>
<a href="#l13.296"></a><span id="l13.296">     bundle.getFormattedString(&quot;confirmUnsubscribeText&quot;, [folders[0].name], 1) :</span>
<a href="#l13.297"></a><span id="l13.297">     bundle.getString(&quot;confirmUnsubscribeManyText&quot;);</span>
<a href="#l13.298"></a><span id="l13.298"> </span>
<a href="#l13.299"></a><span id="l13.299" class="difflineminus">-  var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l13.300"></a><span id="l13.300" class="difflineminus">-                                .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l13.301"></a><span id="l13.301" class="difflineminus">-  return promptService.confirm(window, titleMsg, dialogMsg);</span>
<a href="#l13.302"></a><span id="l13.302" class="difflineplus">+  return Services.prompt.confirm(window, titleMsg, dialogMsg);</span>
<a href="#l13.303"></a><span id="l13.303"> }</span>
<a href="#l13.304"></a><span id="l13.304"> </span>
<a href="#l13.305"></a><span id="l13.305"> /**</span>
<a href="#l13.306"></a><span id="l13.306">  * Unsubscribe from selected or passed in newsgroup/s.</span>
<a href="#l13.307"></a><span id="l13.307">  * @param newsgroups (optional param) the newsgroup folders to unsubscribe from</span>
<a href="#l13.308"></a><span id="l13.308">  */</span>
<a href="#l13.309"></a><span id="l13.309"> function MsgUnsubscribe(newsgroups)</span>
<a href="#l13.310"></a><span id="l13.310"> {</span>
<a href="#l13.311"></a><span id="l13.311" class="difflineat">@@ -2358,87 +2355,87 @@ function MsgApplyFiltersToSelection()</span>
<a href="#l13.312"></a><span id="l13.312">                                             Components.interfaces.nsIMutableArray),</span>
<a href="#l13.313"></a><span id="l13.313">                                gFolderDisplay.displayedFolder,</span>
<a href="#l13.314"></a><span id="l13.314">                                msgWindow);</span>
<a href="#l13.315"></a><span id="l13.315">   }</span>
<a href="#l13.316"></a><span id="l13.316"> }</span>
<a href="#l13.317"></a><span id="l13.317"> </span>
<a href="#l13.318"></a><span id="l13.318"> function ChangeMailLayout(newLayout)</span>
<a href="#l13.319"></a><span id="l13.319"> {</span>
<a href="#l13.320"></a><span id="l13.320" class="difflineminus">-  gPrefBranch.setIntPref(&quot;mail.pane_config.dynamic&quot;, newLayout);</span>
<a href="#l13.321"></a><span id="l13.321" class="difflineplus">+  Services.prefs.setIntPref(&quot;mail.pane_config.dynamic&quot;, newLayout);</span>
<a href="#l13.322"></a><span id="l13.322"> }</span>
<a href="#l13.323"></a><span id="l13.323"> </span>
<a href="#l13.324"></a><span id="l13.324"> function ChangeMailLayoutForCommand(aCommand)</span>
<a href="#l13.325"></a><span id="l13.325"> {</span>
<a href="#l13.326"></a><span id="l13.326">   ChangeMailLayout(kMailLayoutCommandMap[aCommand]);</span>
<a href="#l13.327"></a><span id="l13.327"> }</span>
<a href="#l13.328"></a><span id="l13.328"> </span>
<a href="#l13.329"></a><span id="l13.329"> function MsgViewAllHeaders()</span>
<a href="#l13.330"></a><span id="l13.330"> {</span>
<a href="#l13.331"></a><span id="l13.331">   const mode = Components.interfaces.nsMimeHeaderDisplayTypes.AllHeaders;</span>
<a href="#l13.332"></a><span id="l13.332" class="difflineminus">-  gPrefBranch.setIntPref(&quot;mail.show_headers&quot;, mode); // 2</span>
<a href="#l13.333"></a><span id="l13.333" class="difflineplus">+  Services.prefs.setIntPref(&quot;mail.show_headers&quot;, mode); // 2</span>
<a href="#l13.334"></a><span id="l13.334">   AdjustHeaderView(mode);</span>
<a href="#l13.335"></a><span id="l13.335">   ReloadMessage();</span>
<a href="#l13.336"></a><span id="l13.336"> }</span>
<a href="#l13.337"></a><span id="l13.337"> </span>
<a href="#l13.338"></a><span id="l13.338"> function MsgViewNormalHeaders()</span>
<a href="#l13.339"></a><span id="l13.339"> {</span>
<a href="#l13.340"></a><span id="l13.340">   const mode = Components.interfaces.nsMimeHeaderDisplayTypes.NormalHeaders;</span>
<a href="#l13.341"></a><span id="l13.341" class="difflineminus">-  gPrefBranch.setIntPref(&quot;mail.show_headers&quot;, mode); // 1</span>
<a href="#l13.342"></a><span id="l13.342" class="difflineplus">+  Services.prefs.setIntPref(&quot;mail.show_headers&quot;, mode); // 1</span>
<a href="#l13.343"></a><span id="l13.343">   AdjustHeaderView(mode);</span>
<a href="#l13.344"></a><span id="l13.344">   ReloadMessage();</span>
<a href="#l13.345"></a><span id="l13.345"> }</span>
<a href="#l13.346"></a><span id="l13.346"> </span>
<a href="#l13.347"></a><span id="l13.347"> function MsgBodyAllowHTML()</span>
<a href="#l13.348"></a><span id="l13.348"> {</span>
<a href="#l13.349"></a><span id="l13.349" class="difflineminus">-  gPrefBranch.setBoolPref(&quot;mailnews.display.prefer_plaintext&quot;, false);</span>
<a href="#l13.350"></a><span id="l13.350" class="difflineminus">-  gPrefBranch.setIntPref(&quot;mailnews.display.html_as&quot;, 0);</span>
<a href="#l13.351"></a><span id="l13.351" class="difflineminus">-  gPrefBranch.setIntPref(&quot;mailnews.display.disallow_mime_handlers&quot;, 0);</span>
<a href="#l13.352"></a><span id="l13.352" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mailnews.display.prefer_plaintext&quot;, false);</span>
<a href="#l13.353"></a><span id="l13.353" class="difflineplus">+  Services.prefs.setIntPref(&quot;mailnews.display.html_as&quot;, 0);</span>
<a href="#l13.354"></a><span id="l13.354" class="difflineplus">+  Services.prefs.setIntPref(&quot;mailnews.display.disallow_mime_handlers&quot;, 0);</span>
<a href="#l13.355"></a><span id="l13.355">   ReloadMessage();</span>
<a href="#l13.356"></a><span id="l13.356"> }</span>
<a href="#l13.357"></a><span id="l13.357"> </span>
<a href="#l13.358"></a><span id="l13.358"> function MsgBodySanitized()</span>
<a href="#l13.359"></a><span id="l13.359"> {</span>
<a href="#l13.360"></a><span id="l13.360" class="difflineminus">-  gPrefBranch.setBoolPref(&quot;mailnews.display.prefer_plaintext&quot;, false);</span>
<a href="#l13.361"></a><span id="l13.361" class="difflineminus">-  gPrefBranch.setIntPref(&quot;mailnews.display.html_as&quot;, 3);</span>
<a href="#l13.362"></a><span id="l13.362" class="difflineminus">-  gPrefBranch.setIntPref(&quot;mailnews.display.disallow_mime_handlers&quot;,</span>
<a href="#l13.363"></a><span id="l13.363" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mailnews.display.prefer_plaintext&quot;, false);</span>
<a href="#l13.364"></a><span id="l13.364" class="difflineplus">+  Services.prefs.setIntPref(&quot;mailnews.display.html_as&quot;, 3);</span>
<a href="#l13.365"></a><span id="l13.365" class="difflineplus">+  Services.prefs.setIntPref(&quot;mailnews.display.disallow_mime_handlers&quot;,</span>
<a href="#l13.366"></a><span id="l13.366">                          gDisallow_classes_no_html);</span>
<a href="#l13.367"></a><span id="l13.367">   ReloadMessage();</span>
<a href="#l13.368"></a><span id="l13.368"> }</span>
<a href="#l13.369"></a><span id="l13.369"> </span>
<a href="#l13.370"></a><span id="l13.370"> function MsgBodyAsPlaintext()</span>
<a href="#l13.371"></a><span id="l13.371"> {</span>
<a href="#l13.372"></a><span id="l13.372" class="difflineminus">-  gPrefBranch.setBoolPref(&quot;mailnews.display.prefer_plaintext&quot;, true);</span>
<a href="#l13.373"></a><span id="l13.373" class="difflineminus">-  gPrefBranch.setIntPref(&quot;mailnews.display.html_as&quot;, 1);</span>
<a href="#l13.374"></a><span id="l13.374" class="difflineminus">-  gPrefBranch.setIntPref(&quot;mailnews.display.disallow_mime_handlers&quot;,</span>
<a href="#l13.375"></a><span id="l13.375" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mailnews.display.prefer_plaintext&quot;, true);</span>
<a href="#l13.376"></a><span id="l13.376" class="difflineplus">+  Services.prefs.setIntPref(&quot;mailnews.display.html_as&quot;, 1);</span>
<a href="#l13.377"></a><span id="l13.377" class="difflineplus">+  Services.prefs.setIntPref(&quot;mailnews.display.disallow_mime_handlers&quot;,</span>
<a href="#l13.378"></a><span id="l13.378">                          gDisallow_classes_no_html);</span>
<a href="#l13.379"></a><span id="l13.379">   ReloadMessage();</span>
<a href="#l13.380"></a><span id="l13.380"> }</span>
<a href="#l13.381"></a><span id="l13.381"> </span>
<a href="#l13.382"></a><span id="l13.382"> function MsgBodyAllParts()</span>
<a href="#l13.383"></a><span id="l13.383"> {</span>
<a href="#l13.384"></a><span id="l13.384" class="difflineminus">-  gPrefBranch.setBoolPref(&quot;mailnews.display.prefer_plaintext&quot;, false);</span>
<a href="#l13.385"></a><span id="l13.385" class="difflineminus">-  gPrefBranch.setIntPref(&quot;mailnews.display.html_as&quot;, 4);</span>
<a href="#l13.386"></a><span id="l13.386" class="difflineminus">-  gPrefBranch.setIntPref(&quot;mailnews.display.disallow_mime_handlers&quot;, 0);</span>
<a href="#l13.387"></a><span id="l13.387" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mailnews.display.prefer_plaintext&quot;, false);</span>
<a href="#l13.388"></a><span id="l13.388" class="difflineplus">+  Services.prefs.setIntPref(&quot;mailnews.display.html_as&quot;, 4);</span>
<a href="#l13.389"></a><span id="l13.389" class="difflineplus">+  Services.prefs.setIntPref(&quot;mailnews.display.disallow_mime_handlers&quot;, 0);</span>
<a href="#l13.390"></a><span id="l13.390">   ReloadMessage();</span>
<a href="#l13.391"></a><span id="l13.391"> }</span>
<a href="#l13.392"></a><span id="l13.392"> </span>
<a href="#l13.393"></a><span id="l13.393"> function MsgFeedBodyRenderPrefs(plaintext, html, mime)</span>
<a href="#l13.394"></a><span id="l13.394"> {</span>
<a href="#l13.395"></a><span id="l13.395" class="difflineminus">-  gPrefBranch.setBoolPref(&quot;rss.display.prefer_plaintext&quot;, plaintext);</span>
<a href="#l13.396"></a><span id="l13.396" class="difflineminus">-  gPrefBranch.setIntPref(&quot;rss.display.html_as&quot;, html);</span>
<a href="#l13.397"></a><span id="l13.397" class="difflineminus">-  gPrefBranch.setIntPref(&quot;rss.display.disallow_mime_handlers&quot;, mime);</span>
<a href="#l13.398"></a><span id="l13.398" class="difflineplus">+  Services.prefs.setBoolPref(&quot;rss.display.prefer_plaintext&quot;, plaintext);</span>
<a href="#l13.399"></a><span id="l13.399" class="difflineplus">+  Services.prefs.setIntPref(&quot;rss.display.html_as&quot;, html);</span>
<a href="#l13.400"></a><span id="l13.400" class="difflineplus">+  Services.prefs.setIntPref(&quot;rss.display.disallow_mime_handlers&quot;, mime);</span>
<a href="#l13.401"></a><span id="l13.401">   // Reload only if showing rss summary; menuitem hidden if web page..</span>
<a href="#l13.402"></a><span id="l13.402">   ReloadMessage();</span>
<a href="#l13.403"></a><span id="l13.403"> }</span>
<a href="#l13.404"></a><span id="l13.404"> </span>
<a href="#l13.405"></a><span id="l13.405"> function ToggleInlineAttachment(target)</span>
<a href="#l13.406"></a><span id="l13.406"> {</span>
<a href="#l13.407"></a><span id="l13.407" class="difflineminus">-  var viewAttachmentInline = !pref.getBoolPref(&quot;mail.inline_attachments&quot;);</span>
<a href="#l13.408"></a><span id="l13.408" class="difflineminus">-  pref.setBoolPref(&quot;mail.inline_attachments&quot;, viewAttachmentInline)</span>
<a href="#l13.409"></a><span id="l13.409" class="difflineplus">+  var viewAttachmentInline = !Services.prefs.getBoolPref(&quot;mail.inline_attachments&quot;);</span>
<a href="#l13.410"></a><span id="l13.410" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.inline_attachments&quot;, viewAttachmentInline)</span>
<a href="#l13.411"></a><span id="l13.411">   target.setAttribute(&quot;checked&quot;, viewAttachmentInline ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l13.412"></a><span id="l13.412">   ReloadMessage();</span>
<a href="#l13.413"></a><span id="l13.413"> }</span>
<a href="#l13.414"></a><span id="l13.414"> </span>
<a href="#l13.415"></a><span id="l13.415"> function PrintEnginePrintInternal(doPrintPreview, msgType)</span>
<a href="#l13.416"></a><span id="l13.416"> {</span>
<a href="#l13.417"></a><span id="l13.417">   var messageList = gFolderDisplay.selectedMessageUris;</span>
<a href="#l13.418"></a><span id="l13.418">   if (!messageList) {</span>
<a href="#l13.419"></a><span id="l13.419" class="difflineat">@@ -2539,24 +2536,24 @@ function SpaceHit(event)</span>
<a href="#l13.420"></a><span id="l13.420">   // the nested iframe.</span>
<a href="#l13.421"></a><span id="l13.421">   if (contentWindow == window.content &amp;&amp; rssiframe)</span>
<a href="#l13.422"></a><span id="l13.422">     contentWindow = rssiframe.contentWindow;</span>
<a href="#l13.423"></a><span id="l13.423"> </span>
<a href="#l13.424"></a><span id="l13.424">   if (event &amp;&amp; event.shiftKey) {</span>
<a href="#l13.425"></a><span id="l13.425">     // if at the start of the message, go to the previous one</span>
<a href="#l13.426"></a><span id="l13.426">     if (contentWindow.scrollY &gt; 0)</span>
<a href="#l13.427"></a><span id="l13.427">       contentWindow.scrollByPages(-1);</span>
<a href="#l13.428"></a><span id="l13.428" class="difflineminus">-    else if (pref.getBoolPref(&quot;mail.advance_on_spacebar&quot;))</span>
<a href="#l13.429"></a><span id="l13.429" class="difflineplus">+    else if (Services.prefs.getBoolPref(&quot;mail.advance_on_spacebar&quot;))</span>
<a href="#l13.430"></a><span id="l13.430">       goDoCommand(&quot;cmd_previousUnreadMsg&quot;);</span>
<a href="#l13.431"></a><span id="l13.431">   }</span>
<a href="#l13.432"></a><span id="l13.432">   else {</span>
<a href="#l13.433"></a><span id="l13.433">     // if at the end of the message, go to the next one</span>
<a href="#l13.434"></a><span id="l13.434">     if (contentWindow.scrollY &lt; contentWindow.scrollMaxY)</span>
<a href="#l13.435"></a><span id="l13.435">       contentWindow.scrollByPages(1);</span>
<a href="#l13.436"></a><span id="l13.436" class="difflineminus">-    else if (pref.getBoolPref(&quot;mail.advance_on_spacebar&quot;))</span>
<a href="#l13.437"></a><span id="l13.437" class="difflineplus">+    else if (Services.prefs.getBoolPref(&quot;mail.advance_on_spacebar&quot;))</span>
<a href="#l13.438"></a><span id="l13.438">       goDoCommand(&quot;cmd_nextUnreadMsg&quot;);</span>
<a href="#l13.439"></a><span id="l13.439">   }</span>
<a href="#l13.440"></a><span id="l13.440"> }</span>
<a href="#l13.441"></a><span id="l13.441"> </span>
<a href="#l13.442"></a><span id="l13.442"> function IsAccountOfflineEnabled()</span>
<a href="#l13.443"></a><span id="l13.443"> {</span>
<a href="#l13.444"></a><span id="l13.444">   var selectedFolders = GetSelectedMsgFolders();</span>
<a href="#l13.445"></a><span id="l13.445"> </span>
<a href="#l13.446"></a><span id="l13.446" class="difflineat">@@ -2804,17 +2801,17 @@ function HandleJunkStatusChanged(folder)</span>
<a href="#l13.447"></a><span id="l13.447">   gMessageNotificationBar.setJunkMsg(msgHdr);</span>
<a href="#l13.448"></a><span id="l13.448"> </span>
<a href="#l13.449"></a><span id="l13.449">   // Only reload message if junk bar display state has changed.</span>
<a href="#l13.450"></a><span id="l13.450">   if (msgHdr &amp;&amp; junkBarWasDisplayed != gMessageNotificationBar.isFlagSet(kMsgNotificationJunkBar))</span>
<a href="#l13.451"></a><span id="l13.451">   {</span>
<a href="#l13.452"></a><span id="l13.452">     // We may be forcing junk mail to be rendered with sanitized html.</span>
<a href="#l13.453"></a><span id="l13.453">     // In that scenario, we want to reload the message if the status has just</span>
<a href="#l13.454"></a><span id="l13.454">     // changed to not junk.</span>
<a href="#l13.455"></a><span id="l13.455" class="difflineminus">-    var sanitizeJunkMail = gPrefBranch.getBoolPref(&quot;mail.spam.display.sanitize&quot;);</span>
<a href="#l13.456"></a><span id="l13.456" class="difflineplus">+    var sanitizeJunkMail = Services.prefs.getBoolPref(&quot;mail.spam.display.sanitize&quot;);</span>
<a href="#l13.457"></a><span id="l13.457"> </span>
<a href="#l13.458"></a><span id="l13.458">     // Only bother doing this if we are modifying the html for junk mail....</span>
<a href="#l13.459"></a><span id="l13.459">     if (sanitizeJunkMail)</span>
<a href="#l13.460"></a><span id="l13.460">     {</span>
<a href="#l13.461"></a><span id="l13.461">       let junkScore = msgHdr.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l13.462"></a><span id="l13.462">       let isJunk = (junkScore == Components.interfaces.nsIJunkMailPlugin.IS_SPAM_SCORE);</span>
<a href="#l13.463"></a><span id="l13.463"> </span>
<a href="#l13.464"></a><span id="l13.464">       // If the current row  isn't going to change, reload to show sanitized or</span>
<a href="#l13.465"></a><span id="l13.465" class="difflineat">@@ -3098,19 +3095,17 @@ function OnMsgParsed(aUrl)</span>
<a href="#l13.466"></a><span id="l13.466">   // a scam already.</span>
<a href="#l13.467"></a><span id="l13.467">   var msgHdr = gMessageDisplay.displayedMessage;</span>
<a href="#l13.468"></a><span id="l13.468">   if (msgHdr &amp;&amp; !msgHdr.getUint32Property(&quot;notAPhishMessage&quot;))</span>
<a href="#l13.469"></a><span id="l13.469">     gPhishingDetector.analyzeMsgForPhishingURLs(aUrl);</span>
<a href="#l13.470"></a><span id="l13.470"> </span>
<a href="#l13.471"></a><span id="l13.471">   // notify anyone (e.g., extensions) who's interested in when a message is loaded.</span>
<a href="#l13.472"></a><span id="l13.472">   let selectedMessageUris = gFolderDisplay.selectedMessageUris;</span>
<a href="#l13.473"></a><span id="l13.473">   let msgURI = selectedMessageUris ? selectedMessageUris[0] : null;</span>
<a href="#l13.474"></a><span id="l13.474" class="difflineminus">-  var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l13.475"></a><span id="l13.475" class="difflineminus">-                                  .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l13.476"></a><span id="l13.476" class="difflineminus">-  observerService.notifyObservers(msgWindow.msgHeaderSink, &quot;MsgMsgDisplayed&quot;, msgURI);</span>
<a href="#l13.477"></a><span id="l13.477" class="difflineplus">+  Services.obs.notifyObservers(msgWindow.msgHeaderSink, &quot;MsgMsgDisplayed&quot;, msgURI);</span>
<a href="#l13.478"></a><span id="l13.478"> </span>
<a href="#l13.479"></a><span id="l13.479">   // scale any overflowing images</span>
<a href="#l13.480"></a><span id="l13.480">   let doc = document.getElementById(&quot;messagepane&quot;).contentDocument;</span>
<a href="#l13.481"></a><span id="l13.481">   let imgs = doc.images;</span>
<a href="#l13.482"></a><span id="l13.482">   for (let i = 0; i &lt; imgs.length; i++)</span>
<a href="#l13.483"></a><span id="l13.483">   {</span>
<a href="#l13.484"></a><span id="l13.484">     let img = imgs[i];</span>
<a href="#l13.485"></a><span id="l13.485">     if (img.className == &quot;moz-attached-image&quot; &amp;&amp; img.naturalWidth &gt; doc.body.clientWidth)</span>
<a href="#l13.486"></a><span id="l13.486" class="difflineat">@@ -3131,31 +3126,31 @@ function OnMsgLoaded(aUrl)</span>
<a href="#l13.487"></a><span id="l13.487">   var msgHdr = gMessageDisplay.displayedMessage;</span>
<a href="#l13.488"></a><span id="l13.488"> </span>
<a href="#l13.489"></a><span id="l13.489">   var wintype = document.documentElement.getAttribute('windowtype');</span>
<a href="#l13.490"></a><span id="l13.490"> </span>
<a href="#l13.491"></a><span id="l13.491">   gMessageNotificationBar.setJunkMsg(msgHdr);</span>
<a href="#l13.492"></a><span id="l13.492"> </span>
<a href="#l13.493"></a><span id="l13.493">   goUpdateCommand('button_delete');</span>
<a href="#l13.494"></a><span id="l13.494"> </span>
<a href="#l13.495"></a><span id="l13.495" class="difflineminus">-  var markReadAutoMode = gPrefBranch.getBoolPref(&quot;mailnews.mark_message_read.auto&quot;);</span>
<a href="#l13.496"></a><span id="l13.496" class="difflineplus">+  var markReadAutoMode = Services.prefs.getBoolPref(&quot;mailnews.mark_message_read.auto&quot;);</span>
<a href="#l13.497"></a><span id="l13.497"> </span>
<a href="#l13.498"></a><span id="l13.498">   // We just finished loading a message. If messages are to be marked as read</span>
<a href="#l13.499"></a><span id="l13.499">   // automatically, set a timer to mark the message is read after n seconds</span>
<a href="#l13.500"></a><span id="l13.500">   // where n can be configured by the user.</span>
<a href="#l13.501"></a><span id="l13.501">   if (msgHdr &amp;&amp; !msgHdr.isRead &amp;&amp; markReadAutoMode)</span>
<a href="#l13.502"></a><span id="l13.502">   {</span>
<a href="#l13.503"></a><span id="l13.503" class="difflineminus">-    let markReadOnADelay = gPrefBranch.getBoolPref(&quot;mailnews.mark_message_read.delay&quot;);</span>
<a href="#l13.504"></a><span id="l13.504" class="difflineplus">+    let markReadOnADelay = Services.prefs.getBoolPref(&quot;mailnews.mark_message_read.delay&quot;);</span>
<a href="#l13.505"></a><span id="l13.505"> </span>
<a href="#l13.506"></a><span id="l13.506">     // Only use the timer if viewing using the 3-pane preview pane and the</span>
<a href="#l13.507"></a><span id="l13.507">     // user has set the pref.</span>
<a href="#l13.508"></a><span id="l13.508">     if (markReadOnADelay &amp;&amp; wintype == &quot;mail:3pane&quot;) // 3-pane window</span>
<a href="#l13.509"></a><span id="l13.509">     {</span>
<a href="#l13.510"></a><span id="l13.510">       ClearPendingReadTimer();</span>
<a href="#l13.511"></a><span id="l13.511" class="difflineminus">-      let markReadDelayTime = gPrefBranch.getIntPref(&quot;mailnews.mark_message_read.delay.interval&quot;);</span>
<a href="#l13.512"></a><span id="l13.512" class="difflineplus">+      let markReadDelayTime = Services.prefs.getIntPref(&quot;mailnews.mark_message_read.delay.interval&quot;);</span>
<a href="#l13.513"></a><span id="l13.513">       if (markReadDelayTime == 0)</span>
<a href="#l13.514"></a><span id="l13.514">         MarkMessageAsRead(msgHdr);</span>
<a href="#l13.515"></a><span id="l13.515">       else</span>
<a href="#l13.516"></a><span id="l13.516">         gMarkViewedMessageAsReadTimer = setTimeout(MarkMessageAsRead,</span>
<a href="#l13.517"></a><span id="l13.517">                                                    markReadDelayTime * 1000,</span>
<a href="#l13.518"></a><span id="l13.518">                                                    msgHdr);</span>
<a href="#l13.519"></a><span id="l13.519">     }</span>
<a href="#l13.520"></a><span id="l13.520">     else // standalone msg window</span>
<a href="#l13.521"></a><span id="l13.521" class="difflineat">@@ -3282,29 +3277,29 @@ function MsgSearchMessages(aFolder)</span>
<a href="#l13.522"></a><span id="l13.522">   window.openDialog(&quot;chrome://messenger/content/SearchDialog.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l13.523"></a><span id="l13.523">                     &quot;chrome,resizable,status,centerscreen,dialog=no&quot;,</span>
<a href="#l13.524"></a><span id="l13.524">                     { folder: aFolder || gFolderDisplay.displayedFolder });</span>
<a href="#l13.525"></a><span id="l13.525"> }</span>
<a href="#l13.526"></a><span id="l13.526"> </span>
<a href="#l13.527"></a><span id="l13.527"> function MsgJunkMailInfo(aCheckFirstUse)</span>
<a href="#l13.528"></a><span id="l13.528"> {</span>
<a href="#l13.529"></a><span id="l13.529">   if (aCheckFirstUse) {</span>
<a href="#l13.530"></a><span id="l13.530" class="difflineminus">-    if (!pref.getBoolPref(&quot;mailnews.ui.junk.firstuse&quot;))</span>
<a href="#l13.531"></a><span id="l13.531" class="difflineplus">+    if (!Services.prefs.getBoolPref(&quot;mailnews.ui.junk.firstuse&quot;))</span>
<a href="#l13.532"></a><span id="l13.532">       return;</span>
<a href="#l13.533"></a><span id="l13.533" class="difflineminus">-    pref.setBoolPref(&quot;mailnews.ui.junk.firstuse&quot;, false);</span>
<a href="#l13.534"></a><span id="l13.534" class="difflineplus">+    Services.prefs.setBoolPref(&quot;mailnews.ui.junk.firstuse&quot;, false);</span>
<a href="#l13.535"></a><span id="l13.535"> </span>
<a href="#l13.536"></a><span id="l13.536">     // check to see if this is an existing profile where the user has started using</span>
<a href="#l13.537"></a><span id="l13.537">     // the junk mail feature already</span>
<a href="#l13.538"></a><span id="l13.538">     var junkmailPlugin = Components.classes[&quot;@mozilla.org/messenger/filter-plugin;1?name=bayesianfilter&quot;]</span>
<a href="#l13.539"></a><span id="l13.539">                                    .getService(Components.interfaces.nsIJunkMailPlugin);</span>
<a href="#l13.540"></a><span id="l13.540">     if (junkmailPlugin.userHasClassified)</span>
<a href="#l13.541"></a><span id="l13.541">       return;</span>
<a href="#l13.542"></a><span id="l13.542">   }</span>
<a href="#l13.543"></a><span id="l13.543"> </span>
<a href="#l13.544"></a><span id="l13.544" class="difflineminus">-  var desiredWindow = GetWindowByWindowType(&quot;mailnews:junkmailinfo&quot;);</span>
<a href="#l13.545"></a><span id="l13.545" class="difflineplus">+  var desiredWindow = Services.wm.getMostRecentWindow(&quot;mailnews:junkmailinfo&quot;);</span>
<a href="#l13.546"></a><span id="l13.546"> </span>
<a href="#l13.547"></a><span id="l13.547">   if (desiredWindow)</span>
<a href="#l13.548"></a><span id="l13.548">     desiredWindow.focus();</span>
<a href="#l13.549"></a><span id="l13.549">   else</span>
<a href="#l13.550"></a><span id="l13.550">     window.openDialog(&quot;chrome://messenger/content/junkMailInfo.xul&quot;,</span>
<a href="#l13.551"></a><span id="l13.551">                       &quot;mailnews:junkmailinfo&quot;,</span>
<a href="#l13.552"></a><span id="l13.552">                       &quot;centerscreen,resizeable=no,titlebar,chrome,modal&quot;, null);</span>
<a href="#l13.553"></a><span id="l13.553"> }</span>
<a href="#l13.554"></a><span id="l13.554" class="difflineat">@@ -3315,26 +3310,19 @@ function MsgSearchAddresses()</span>
<a href="#l13.555"></a><span id="l13.555">   OpenOrFocusWindow(args, &quot;mailnews:absearch&quot;, &quot;chrome://messenger/content/ABSearchDialog.xul&quot;);</span>
<a href="#l13.556"></a><span id="l13.556"> }</span>
<a href="#l13.557"></a><span id="l13.557"> </span>
<a href="#l13.558"></a><span id="l13.558"> function MsgFilterList(args)</span>
<a href="#l13.559"></a><span id="l13.559"> {</span>
<a href="#l13.560"></a><span id="l13.560">   OpenOrFocusWindow(args, &quot;mailnews:filterlist&quot;, &quot;chrome://messenger/content/FilterListDialog.xul&quot;);</span>
<a href="#l13.561"></a><span id="l13.561"> }</span>
<a href="#l13.562"></a><span id="l13.562"> </span>
<a href="#l13.563"></a><span id="l13.563" class="difflineminus">-function GetWindowByWindowType(windowType)</span>
<a href="#l13.564"></a><span id="l13.564" class="difflineminus">-{</span>
<a href="#l13.565"></a><span id="l13.565" class="difflineminus">-  var windowManager = Components.classes['@mozilla.org/appshell/window-mediator;1']</span>
<a href="#l13.566"></a><span id="l13.566" class="difflineminus">-                                .getService(Components.interfaces.nsIWindowMediator);</span>
<a href="#l13.567"></a><span id="l13.567" class="difflineminus">-  return windowManager.getMostRecentWindow(windowType);</span>
<a href="#l13.568"></a><span id="l13.568" class="difflineminus">-}</span>
<a href="#l13.569"></a><span id="l13.569" class="difflineminus">-</span>
<a href="#l13.570"></a><span id="l13.570"> function OpenOrFocusWindow(args, windowType, chromeURL)</span>
<a href="#l13.571"></a><span id="l13.571"> {</span>
<a href="#l13.572"></a><span id="l13.572" class="difflineminus">-  var desiredWindow = GetWindowByWindowType(windowType);</span>
<a href="#l13.573"></a><span id="l13.573" class="difflineplus">+  var desiredWindow = Services.wm.getMostRecentWindow(windowType);</span>
<a href="#l13.574"></a><span id="l13.574"> </span>
<a href="#l13.575"></a><span id="l13.575">   if (desiredWindow) {</span>
<a href="#l13.576"></a><span id="l13.576">     desiredWindow.focus();</span>
<a href="#l13.577"></a><span id="l13.577">     if (&quot;refresh&quot; in args &amp;&amp; args.refresh)</span>
<a href="#l13.578"></a><span id="l13.578">       desiredWindow.refresh();</span>
<a href="#l13.579"></a><span id="l13.579">   }</span>
<a href="#l13.580"></a><span id="l13.580">   else</span>
<a href="#l13.581"></a><span id="l13.581">     window.openDialog(chromeURL, &quot;&quot;, &quot;chrome,resizable,status,centerscreen,dialog=no&quot;, args);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/base/content/messageDisplay.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/base/content/messageDisplay.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -532,17 +532,17 @@ MessageTabDisplayWidget.prototype = {</span>
<a href="#l14.4"></a><span id="l14.4">       // No summaries in a message tab</span>
<a href="#l14.5"></a><span id="l14.5">       this.singleMessageDisplay = true;</span>
<a href="#l14.6"></a><span id="l14.6">       return false;</span>
<a href="#l14.7"></a><span id="l14.7">     }</span>
<a href="#l14.8"></a><span id="l14.8">   },</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10">   onMessagesRemoved: function MessageTabDisplayWidget_onMessagesRemoved() {</span>
<a href="#l14.11"></a><span id="l14.11">     if (this.folderDisplay.treeSelection.count == 0 &amp;&amp;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-        pref.getBoolPref(&quot;mail.close_message_window.on_delete&quot;)) {</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+        Services.prefs.getBoolPref(&quot;mail.close_message_window.on_delete&quot;)) {</span>
<a href="#l14.14"></a><span id="l14.14">       document.getElementById(&quot;tabmail&quot;).closeTab(this.folderDisplay._tabInfo,</span>
<a href="#l14.15"></a><span id="l14.15">                                                   true);</span>
<a href="#l14.16"></a><span id="l14.16">       return true;</span>
<a href="#l14.17"></a><span id="l14.17">     }</span>
<a href="#l14.18"></a><span id="l14.18">     return false;</span>
<a href="#l14.19"></a><span id="l14.19">   },</span>
<a href="#l14.20"></a><span id="l14.20"> </span>
<a href="#l14.21"></a><span id="l14.21">   /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/base/content/messageWindow.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/base/content/messageWindow.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1,16 +1,17 @@</span>
<a href="#l15.4"></a><span id="l15.4"> /** ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l15.5"></a><span id="l15.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.6"></a><span id="l15.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.7"></a><span id="l15.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9"> /* This is where functions related to the standalone message window are kept */</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11"> Components.utils.import(&quot;resource:///modules/jsTreeSelection.js&quot;);</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l15.13"></a><span id="l15.13"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l15.14"></a><span id="l15.14"> Components.utils.import(&quot;resource:///modules/MsgHdrSyntheticView.js&quot;);</span>
<a href="#l15.15"></a><span id="l15.15"> </span>
<a href="#l15.16"></a><span id="l15.16"> // from MailNewsTypes.h</span>
<a href="#l15.17"></a><span id="l15.17"> const nsMsgKey_None = 0xFFFFFFFF;</span>
<a href="#l15.18"></a><span id="l15.18"> const nsMsgViewIndex_None = 0xFFFFFFFF;</span>
<a href="#l15.19"></a><span id="l15.19"> </span>
<a href="#l15.20"></a><span id="l15.20"> /* globals for a particular window */</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineat">@@ -252,17 +253,17 @@ StandaloneMessageDisplayWidget.prototype</span>
<a href="#l15.22"></a><span id="l15.22">       return true;</span>
<a href="#l15.23"></a><span id="l15.23">     }</span>
<a href="#l15.24"></a><span id="l15.24">     return false;</span>
<a href="#l15.25"></a><span id="l15.25">   },</span>
<a href="#l15.26"></a><span id="l15.26"> </span>
<a href="#l15.27"></a><span id="l15.27">   onMessagesRemoved:</span>
<a href="#l15.28"></a><span id="l15.28">       function StandaloneMessageDisplayWidget_onMessagesRemoved() {</span>
<a href="#l15.29"></a><span id="l15.29">     if (this.folderDisplay.treeSelection.count == 0 &amp;&amp;</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineminus">-        pref.getBoolPref(&quot;mail.close_message_window.on_delete&quot;)) {</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+        Services.prefs.getBoolPref(&quot;mail.close_message_window.on_delete&quot;)) {</span>
<a href="#l15.32"></a><span id="l15.32">       window.close();</span>
<a href="#l15.33"></a><span id="l15.33">       return true;</span>
<a href="#l15.34"></a><span id="l15.34">     }</span>
<a href="#l15.35"></a><span id="l15.35">   },</span>
<a href="#l15.36"></a><span id="l15.36"> };</span>
<a href="#l15.37"></a><span id="l15.37"> </span>
<a href="#l15.38"></a><span id="l15.38"> var messagepaneObserver = {</span>
<a href="#l15.39"></a><span id="l15.39"> </span>
<a href="#l15.40"></a><span id="l15.40" class="difflineat">@@ -306,18 +307,17 @@ var messagepaneObserver = {</span>
<a href="#l15.41"></a><span id="l15.41">     flavourSet.appendFlavour(&quot;text/x-moz-message&quot;);</span>
<a href="#l15.42"></a><span id="l15.42">     return flavourSet;</span>
<a href="#l15.43"></a><span id="l15.43">   }</span>
<a href="#l15.44"></a><span id="l15.44"> };</span>
<a href="#l15.45"></a><span id="l15.45"> </span>
<a href="#l15.46"></a><span id="l15.46"> function UpdateStatusMessageCounts()</span>
<a href="#l15.47"></a><span id="l15.47"> {</span>
<a href="#l15.48"></a><span id="l15.48">   // hook for extra toolbar items</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineminus">-  var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;].getService(Components.interfaces.nsIObserverService);</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">-  observerService.notifyObservers(window, &quot;mail:updateStandAloneMessageCounts&quot;, &quot;&quot;);</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+  Services.obs.notifyObservers(window, &quot;mail:updateStandAloneMessageCounts&quot;, &quot;&quot;);</span>
<a href="#l15.52"></a><span id="l15.52"> }</span>
<a href="#l15.53"></a><span id="l15.53"> </span>
<a href="#l15.54"></a><span id="l15.54"> // we won't show the window until the onload() handler is finished</span>
<a href="#l15.55"></a><span id="l15.55"> // so we do this trick (suggested by hyatt / blaker)</span>
<a href="#l15.56"></a><span id="l15.56"> function OnLoadMessageWindow()</span>
<a href="#l15.57"></a><span id="l15.57"> {</span>
<a href="#l15.58"></a><span id="l15.58">   // Set a sane starting width/height for all resolutions on new profiles.</span>
<a href="#l15.59"></a><span id="l15.59">   // Do this before the window loads.</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineat">@@ -982,20 +982,20 @@ var MessageWindowController =</span>
<a href="#l15.61"></a><span id="l15.61">         if (!loadedFolder)</span>
<a href="#l15.62"></a><span id="l15.62">           return false;</span>
<a href="#l15.63"></a><span id="l15.63">         return loadedFolder.server.canSearchMessages;</span>
<a href="#l15.64"></a><span id="l15.64">       case &quot;cmd_undo&quot;:</span>
<a href="#l15.65"></a><span id="l15.65">       case &quot;cmd_redo&quot;:</span>
<a href="#l15.66"></a><span id="l15.66">         return SetupUndoRedoCommand(command);</span>
<a href="#l15.67"></a><span id="l15.67">       case &quot;cmd_moveToFolderAgain&quot;:</span>
<a href="#l15.68"></a><span id="l15.68">         loadedFolder = gFolderDisplay.displayedFolder;</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineminus">-        if (!loadedFolder || (pref.getBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;) &amp;&amp;</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+        if (!loadedFolder || (Services.prefs.getBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;) &amp;&amp;</span>
<a href="#l15.71"></a><span id="l15.71">             !loadedFolder.canDeleteMessages))</span>
<a href="#l15.72"></a><span id="l15.72">           return false;</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineminus">-        let targetURI = pref.getCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;);</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineplus">+        let targetURI = Services.prefs.getCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;);</span>
<a href="#l15.75"></a><span id="l15.75">         if (!targetURI)</span>
<a href="#l15.76"></a><span id="l15.76">           return false;</span>
<a href="#l15.77"></a><span id="l15.77">         let targetFolder = MailUtils.getFolderForURI(targetURI);</span>
<a href="#l15.78"></a><span id="l15.78">         // If parent is null, folder doesn't exist.</span>
<a href="#l15.79"></a><span id="l15.79">         return targetFolder &amp;&amp; targetFolder.parent;</span>
<a href="#l15.80"></a><span id="l15.80">       case &quot;cmd_applyFilters&quot;:</span>
<a href="#l15.81"></a><span id="l15.81">       case &quot;cmd_runJunkControls&quot;:</span>
<a href="#l15.82"></a><span id="l15.82">       case &quot;cmd_deleteJunk&quot;:</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineat">@@ -1058,18 +1058,18 @@ var MessageWindowController =</span>
<a href="#l15.84"></a><span id="l15.84">         break;</span>
<a href="#l15.85"></a><span id="l15.85">       case &quot;cmd_forwardAttachment&quot;:</span>
<a href="#l15.86"></a><span id="l15.86">         MsgForwardAsAttachment(null);</span>
<a href="#l15.87"></a><span id="l15.87">         break;</span>
<a href="#l15.88"></a><span id="l15.88">       case &quot;cmd_editAsNew&quot;:</span>
<a href="#l15.89"></a><span id="l15.89">         MsgEditMessageAsNew();</span>
<a href="#l15.90"></a><span id="l15.90">         break;</span>
<a href="#l15.91"></a><span id="l15.91">       case &quot;cmd_moveToFolderAgain&quot;:</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineminus">-        var folderId = pref.getCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;);</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineminus">-        if (pref.getBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;))</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineplus">+        var folderId = Services.prefs.getCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;);</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineplus">+        if (Services.prefs.getBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;))</span>
<a href="#l15.96"></a><span id="l15.96">           MsgMoveMessage(GetMsgFolderFromUri(folderId));</span>
<a href="#l15.97"></a><span id="l15.97">         else</span>
<a href="#l15.98"></a><span id="l15.98">           MsgCopyMessage(GetMsgFolderFromUri(folderId));</span>
<a href="#l15.99"></a><span id="l15.99">         break;</span>
<a href="#l15.100"></a><span id="l15.100">       case &quot;cmd_createFilterFromPopup&quot;:</span>
<a href="#l15.101"></a><span id="l15.101">         break;// This does nothing because the createfilter is invoked from the popupnode oncommand.</span>
<a href="#l15.102"></a><span id="l15.102">       case &quot;cmd_createFilterFromMenu&quot;:</span>
<a href="#l15.103"></a><span id="l15.103">         MsgCreateFilter();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/base/content/msgHdrViewOverlay.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/base/content/msgHdrViewOverlay.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -212,23 +212,23 @@ function initializeHeaderViewTables()</span>
<a href="#l16.4"></a><span id="l16.4"> function OnLoadMsgHeaderPane()</span>
<a href="#l16.5"></a><span id="l16.5"> {</span>
<a href="#l16.6"></a><span id="l16.6">   // HACK...force our XBL bindings file to be load before we try to create our</span>
<a href="#l16.7"></a><span id="l16.7">   // first xbl widget.... otherwise we have problems.</span>
<a href="#l16.8"></a><span id="l16.8">   document.loadBindingDocument(&quot;chrome://messenger/content/mailWidgets.xml&quot;);</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10">   // Load any preferences that at are global with regards to</span>
<a href="#l16.11"></a><span id="l16.11">   // displaying a message...</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-  gMinNumberOfHeaders = pref.getIntPref(&quot;mailnews.headers.minNumHeaders&quot;);</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-  gShowCondensedEmailAddresses = pref.getBoolPref(&quot;mail.showCondensedAddresses&quot;);</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-  gHeadersShowReferences = pref.getBoolPref(&quot;mailnews.headers.showReferences&quot;);</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+  gMinNumberOfHeaders = Services.prefs.getIntPref(&quot;mailnews.headers.minNumHeaders&quot;);</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+  gShowCondensedEmailAddresses = Services.prefs.getBoolPref(&quot;mail.showCondensedAddresses&quot;);</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+  gHeadersShowReferences = Services.prefs.getBoolPref(&quot;mailnews.headers.showReferences&quot;);</span>
<a href="#l16.18"></a><span id="l16.18"> </span>
<a href="#l16.19"></a><span id="l16.19">   // listen to the</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineminus">-  pref.addObserver(&quot;mail.showCondensedAddresses&quot;, MsgHdrViewObserver, false);</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineminus">-  pref.addObserver(&quot;mailnews.headers.showReferences&quot;, MsgHdrViewObserver, false);</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+  Services.prefs.addObserver(&quot;mail.showCondensedAddresses&quot;, MsgHdrViewObserver, false);</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+  Services.prefs.addObserver(&quot;mailnews.headers.showReferences&quot;, MsgHdrViewObserver, false);</span>
<a href="#l16.24"></a><span id="l16.24"> </span>
<a href="#l16.25"></a><span id="l16.25">   initializeHeaderViewTables();</span>
<a href="#l16.26"></a><span id="l16.26"> </span>
<a href="#l16.27"></a><span id="l16.27">   // Add an address book listener so we can update the header view when things</span>
<a href="#l16.28"></a><span id="l16.28">   // change.</span>
<a href="#l16.29"></a><span id="l16.29">   MailServices.ab.addAddressBookListener(AddressBookListener,</span>
<a href="#l16.30"></a><span id="l16.30">                                          Components.interfaces.nsIAbListener.all);</span>
<a href="#l16.31"></a><span id="l16.31"> </span>
<a href="#l16.32"></a><span id="l16.32" class="difflineat">@@ -328,18 +328,18 @@ function initToolbarMenu() {</span>
<a href="#l16.33"></a><span id="l16.33">   let mode = document.getElementById(&quot;header-view-toolbar&quot;)</span>
<a href="#l16.34"></a><span id="l16.34">                      .getAttribute(&quot;mode&quot;);</span>
<a href="#l16.35"></a><span id="l16.35"> </span>
<a href="#l16.36"></a><span id="l16.36">   return;</span>
<a href="#l16.37"></a><span id="l16.37"> }</span>
<a href="#l16.38"></a><span id="l16.38"> </span>
<a href="#l16.39"></a><span id="l16.39"> function OnUnloadMsgHeaderPane()</span>
<a href="#l16.40"></a><span id="l16.40"> {</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineminus">-  pref.removeObserver(&quot;mail.showCondensedAddresses&quot;, MsgHdrViewObserver);</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineminus">-  pref.removeObserver(&quot;mailnews.headers.showReferences&quot;, MsgHdrViewObserver);</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+  Services.prefs.removeObserver(&quot;mail.showCondensedAddresses&quot;, MsgHdrViewObserver);</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+  Services.prefs.removeObserver(&quot;mailnews.headers.showReferences&quot;, MsgHdrViewObserver);</span>
<a href="#l16.45"></a><span id="l16.45"> </span>
<a href="#l16.46"></a><span id="l16.46">   MailServices.ab.removeAddressBookListener(AddressBookListener);</span>
<a href="#l16.47"></a><span id="l16.47"> </span>
<a href="#l16.48"></a><span id="l16.48">   // dispatch an event letting any listeners know that we have unloaded</span>
<a href="#l16.49"></a><span id="l16.49">   // the message pane</span>
<a href="#l16.50"></a><span id="l16.50">   var event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l16.51"></a><span id="l16.51">   event.initEvent(&quot;messagepane-unloaded&quot;, false, true);</span>
<a href="#l16.52"></a><span id="l16.52">   var headerViewElement = document.getElementById(&quot;msgHeaderView&quot;);</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineat">@@ -349,22 +349,22 @@ function OnUnloadMsgHeaderPane()</span>
<a href="#l16.54"></a><span id="l16.54"> const MsgHdrViewObserver =</span>
<a href="#l16.55"></a><span id="l16.55"> {</span>
<a href="#l16.56"></a><span id="l16.56">   observe: function(subject, topic, prefName)</span>
<a href="#l16.57"></a><span id="l16.57">   {</span>
<a href="#l16.58"></a><span id="l16.58">     // verify that we're changing the mail pane config pref</span>
<a href="#l16.59"></a><span id="l16.59">     if (topic == &quot;nsPref:changed&quot;) {</span>
<a href="#l16.60"></a><span id="l16.60">       if (prefName == &quot;mail.showCondensedAddresses&quot;) {</span>
<a href="#l16.61"></a><span id="l16.61">         gShowCondensedEmailAddresses =</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineminus">-          pref.getBoolPref(&quot;mail.showCondensedAddresses&quot;);</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineplus">+          Services.prefs.getBoolPref(&quot;mail.showCondensedAddresses&quot;);</span>
<a href="#l16.64"></a><span id="l16.64">         ReloadMessage();</span>
<a href="#l16.65"></a><span id="l16.65">       }</span>
<a href="#l16.66"></a><span id="l16.66">       else if (prefName == &quot;mailnews.headers.showReferences&quot;) {</span>
<a href="#l16.67"></a><span id="l16.67">         gHeadersShowReferences =</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineminus">-          pref.getBoolPref(&quot;mailnews.headers.showReferences&quot;);</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+          Services.prefs.getBoolPref(&quot;mailnews.headers.showReferences&quot;);</span>
<a href="#l16.70"></a><span id="l16.70">         ReloadMessage();</span>
<a href="#l16.71"></a><span id="l16.71">       }</span>
<a href="#l16.72"></a><span id="l16.72">     }</span>
<a href="#l16.73"></a><span id="l16.73">   }</span>
<a href="#l16.74"></a><span id="l16.74"> };</span>
<a href="#l16.75"></a><span id="l16.75"> </span>
<a href="#l16.76"></a><span id="l16.76"> var AddressBookListener =</span>
<a href="#l16.77"></a><span id="l16.77"> {</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineat">@@ -407,17 +407,17 @@ function OnAddressBookDataChanged(aActio</span>
<a href="#l16.79"></a><span id="l16.79"> var messageHeaderSink = {</span>
<a href="#l16.80"></a><span id="l16.80">     QueryInterface: XPCOMUtils.generateQI(</span>
<a href="#l16.81"></a><span id="l16.81">       [Components.interfaces.nsIMsgHeaderSink]),</span>
<a href="#l16.82"></a><span id="l16.82">     onStartHeaders: function()</span>
<a href="#l16.83"></a><span id="l16.83">     {</span>
<a href="#l16.84"></a><span id="l16.84">       this.mSaveHdr = null;</span>
<a href="#l16.85"></a><span id="l16.85">       // Every time we start to redisplay a message, check the view all headers</span>
<a href="#l16.86"></a><span id="l16.86">       // pref...</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineminus">-      var showAllHeadersPref = pref.getIntPref(&quot;mail.show_headers&quot;);</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineplus">+      var showAllHeadersPref = Services.prefs.getIntPref(&quot;mail.show_headers&quot;);</span>
<a href="#l16.89"></a><span id="l16.89">       if (showAllHeadersPref == 2) {</span>
<a href="#l16.90"></a><span id="l16.90">         gViewAllHeaders = true;</span>
<a href="#l16.91"></a><span id="l16.91">       } else {</span>
<a href="#l16.92"></a><span id="l16.92">         if (gViewAllHeaders) {</span>
<a href="#l16.93"></a><span id="l16.93">           // If we currently are in view all header mode, rebuild our header</span>
<a href="#l16.94"></a><span id="l16.94">           // view so we remove most of the header data.</span>
<a href="#l16.95"></a><span id="l16.95">           hideHeaderView(gExpandedHeaderView);</span>
<a href="#l16.96"></a><span id="l16.96">           RemoveNewHeaderViews(gExpandedHeaderView);</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineat">@@ -571,18 +571,18 @@ var messageHeaderSink = {</span>
<a href="#l16.98"></a><span id="l16.98">       this.skipAttachment = true;</span>
<a href="#l16.99"></a><span id="l16.99"> </span>
<a href="#l16.100"></a><span id="l16.100">       // Don't show vcards as external attachments in the UI. libmime already</span>
<a href="#l16.101"></a><span id="l16.101">       // renders them inline.</span>
<a href="#l16.102"></a><span id="l16.102">       if (!this.mSaveHdr)</span>
<a href="#l16.103"></a><span id="l16.103">         this.mSaveHdr = messenger.messageServiceFromURI(uri)</span>
<a href="#l16.104"></a><span id="l16.104">                                  .messageURIToMsgHdr(uri);</span>
<a href="#l16.105"></a><span id="l16.105">       if (contentType == &quot;text/x-vcard&quot;) {</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineminus">-        var inlineAttachments = pref.getBoolPref(&quot;mail.inline_attachments&quot;);</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineminus">-        var displayHtmlAs = pref.getIntPref(&quot;mailnews.display.html_as&quot;);</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineplus">+        var inlineAttachments = Services.prefs.getBoolPref(&quot;mail.inline_attachments&quot;);</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineplus">+        var displayHtmlAs = Services.prefs.getIntPref(&quot;mailnews.display.html_as&quot;);</span>
<a href="#l16.110"></a><span id="l16.110">         if (inlineAttachments &amp;&amp; !displayHtmlAs)</span>
<a href="#l16.111"></a><span id="l16.111">           return;</span>
<a href="#l16.112"></a><span id="l16.112">       }</span>
<a href="#l16.113"></a><span id="l16.113"> </span>
<a href="#l16.114"></a><span id="l16.114">       var size = null;</span>
<a href="#l16.115"></a><span id="l16.115">       if (isExternalAttachment &amp;&amp; /^file:/.test(url)) {</span>
<a href="#l16.116"></a><span id="l16.116">         let fileHandler = Services.io.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l16.117"></a><span id="l16.117">           .QueryInterface(Components.interfaces.nsIFileProtocolHandler);</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineat">@@ -911,17 +911,17 @@ function updateExpandedView()</span>
<a href="#l16.119"></a><span id="l16.119">   // grids are the same size so that they don't look weird.</span>
<a href="#l16.120"></a><span id="l16.120">   syncGridColumnWidths();</span>
<a href="#l16.121"></a><span id="l16.121"> </span>
<a href="#l16.122"></a><span id="l16.122">   UpdateJunkButton();</span>
<a href="#l16.123"></a><span id="l16.123">   UpdateReplyButtons();</span>
<a href="#l16.124"></a><span id="l16.124">   displayAttachmentsForExpandedView();</span>
<a href="#l16.125"></a><span id="l16.125"> </span>
<a href="#l16.126"></a><span id="l16.126">   try {</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineminus">-    AdjustHeaderView(pref.getIntPref(&quot;mail.show_headers&quot;));</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineplus">+    AdjustHeaderView(Services.prefs.getIntPref(&quot;mail.show_headers&quot;));</span>
<a href="#l16.129"></a><span id="l16.129">   } catch (e) { logException(e); }</span>
<a href="#l16.130"></a><span id="l16.130"> }</span>
<a href="#l16.131"></a><span id="l16.131"> </span>
<a href="#l16.132"></a><span id="l16.132"> /**</span>
<a href="#l16.133"></a><span id="l16.133">  * Ensure that the name columns in both grids are the same size, since the only</span>
<a href="#l16.134"></a><span id="l16.134">  * reason that we're using two grids at all is to workaround the XUL box</span>
<a href="#l16.135"></a><span id="l16.135">  * model's inability to float elements.</span>
<a href="#l16.136"></a><span id="l16.136">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -9,16 +9,17 @@ Components.utils.import(&quot;resource:///mod</span>
<a href="#l17.4"></a><span id="l17.4"> Components.utils.import(&quot;resource:///modules/MailConsts.js&quot;);</span>
<a href="#l17.5"></a><span id="l17.5"> Components.utils.import(&quot;resource:///modules/errUtils.js&quot;);</span>
<a href="#l17.6"></a><span id="l17.6"> Components.utils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l17.7"></a><span id="l17.7"> Components.utils.import(&quot;resource:///modules/mailnewsMigrator.js&quot;);</span>
<a href="#l17.8"></a><span id="l17.8"> Components.utils.import(&quot;resource:///modules/sessionStoreManager.js&quot;);</span>
<a href="#l17.9"></a><span id="l17.9"> Components.utils.import(&quot;resource:///modules/summaryFrameManager.js&quot;);</span>
<a href="#l17.10"></a><span id="l17.10"> Components.utils.import(&quot;resource:///modules/mailInstrumentation.js&quot;);</span>
<a href="#l17.11"></a><span id="l17.11"> Components.utils.import(&quot;resource:///modules/msgDBCacheManager.js&quot;);</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l17.13"></a><span id="l17.13"> </span>
<a href="#l17.14"></a><span id="l17.14"> /* This is where functions related to the 3 pane window are kept */</span>
<a href="#l17.15"></a><span id="l17.15"> </span>
<a href="#l17.16"></a><span id="l17.16"> // from MailNewsTypes.h</span>
<a href="#l17.17"></a><span id="l17.17"> const nsMsgKey_None = 0xFFFFFFFF;</span>
<a href="#l17.18"></a><span id="l17.18"> const nsMsgViewIndex_None = 0xFFFFFFFF;</span>
<a href="#l17.19"></a><span id="l17.19"> const kMailCheckOncePrefName = &quot;mail.startup.enabledMailCheckOnce&quot;;</span>
<a href="#l17.20"></a><span id="l17.20"> </span>
<a href="#l17.21"></a><span id="l17.21" class="difflineat">@@ -161,17 +162,17 @@ var gThreePaneIncomingServerListener = {</span>
<a href="#l17.22"></a><span id="l17.22">       }</span>
<a href="#l17.23"></a><span id="l17.23">     }</span>
<a href="#l17.24"></a><span id="l17.24"> }</span>
<a href="#l17.25"></a><span id="l17.25"> </span>
<a href="#l17.26"></a><span id="l17.26"> // aMsgWindowInitialized: false if we are calling from the onload handler, otherwise true</span>
<a href="#l17.27"></a><span id="l17.27"> function UpdateMailPaneConfig(aMsgWindowInitialized) {</span>
<a href="#l17.28"></a><span id="l17.28">   const dynamicIds = [&quot;messagesBox&quot;, &quot;mailContent&quot;, &quot;threadPaneBox&quot;];</span>
<a href="#l17.29"></a><span id="l17.29">   const layouts = [&quot;standard&quot;, &quot;wide&quot;, &quot;vertical&quot;];</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineminus">-  var layoutView = gPrefBranch.getIntPref(&quot;mail.pane_config.dynamic&quot;);</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+  var layoutView = Services.prefs.getIntPref(&quot;mail.pane_config.dynamic&quot;);</span>
<a href="#l17.32"></a><span id="l17.32">   // Ensure valid value; hard fail if not.</span>
<a href="#l17.33"></a><span id="l17.33">   layoutView = dynamicIds[layoutView] ? layoutView : kStandardPaneConfig;</span>
<a href="#l17.34"></a><span id="l17.34">   var desiredId = dynamicIds[layoutView];</span>
<a href="#l17.35"></a><span id="l17.35">   document.getElementById(&quot;mailContent&quot;)</span>
<a href="#l17.36"></a><span id="l17.36">           .setAttribute(&quot;layout&quot;, layouts[layoutView]);</span>
<a href="#l17.37"></a><span id="l17.37">   var messagePaneBoxWrapper = GetMessagePaneWrapper();</span>
<a href="#l17.38"></a><span id="l17.38">   if (messagePaneBoxWrapper.parentNode.id != desiredId) {</span>
<a href="#l17.39"></a><span id="l17.39">     ClearAttachmentList();</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineat">@@ -270,20 +271,20 @@ const MailPrefObserver = {</span>
<a href="#l17.41"></a><span id="l17.41">       if (prefName == &quot;mail.pane_config.dynamic&quot;)</span>
<a href="#l17.42"></a><span id="l17.42">         UpdateMailPaneConfig(true);</span>
<a href="#l17.43"></a><span id="l17.43">       else if (prefName == &quot;mail.showCondensedAddresses&quot;)</span>
<a href="#l17.44"></a><span id="l17.44">       {</span>
<a href="#l17.45"></a><span id="l17.45">         var currentDisplayNameVersion;</span>
<a href="#l17.46"></a><span id="l17.46">         var threadTree = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l17.47"></a><span id="l17.47"> </span>
<a href="#l17.48"></a><span id="l17.48">         currentDisplayNameVersion =</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineminus">-            gPrefBranch.getIntPref(&quot;mail.displayname.version&quot;);</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+            Services.prefs.getIntPref(&quot;mail.displayname.version&quot;);</span>
<a href="#l17.51"></a><span id="l17.51"> </span>
<a href="#l17.52"></a><span id="l17.52" class="difflineminus">-        gPrefBranch.setIntPref(&quot;mail.displayname.version&quot;,</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineminus">-                               ++currentDisplayNameVersion);</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineplus">+        Services.prefs.setIntPref(&quot;mail.displayname.version&quot;,</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineplus">+                                  ++currentDisplayNameVersion);</span>
<a href="#l17.56"></a><span id="l17.56"> </span>
<a href="#l17.57"></a><span id="l17.57">         //refresh the thread pane</span>
<a href="#l17.58"></a><span id="l17.58">         threadTree.treeBoxObject.invalid();</span>
<a href="#l17.59"></a><span id="l17.59">       }</span>
<a href="#l17.60"></a><span id="l17.60">     }</span>
<a href="#l17.61"></a><span id="l17.61">   }</span>
<a href="#l17.62"></a><span id="l17.62"> };</span>
<a href="#l17.63"></a><span id="l17.63"> </span>
<a href="#l17.64"></a><span id="l17.64" class="difflineat">@@ -303,17 +304,17 @@ function AutoConfigWizard(okCallback)</span>
<a href="#l17.65"></a><span id="l17.65">   if (suppressDialogs) {</span>
<a href="#l17.66"></a><span id="l17.66">     // Looks like we were in the middle of filling out an account form. We</span>
<a href="#l17.67"></a><span id="l17.67">     // won't display the dialogs in that case.</span>
<a href="#l17.68"></a><span id="l17.68">     Services.prefs.clearUserPref(&quot;mail.provider.suppress_dialog_on_startup&quot;);</span>
<a href="#l17.69"></a><span id="l17.69">     okCallback();</span>
<a href="#l17.70"></a><span id="l17.70">     return;</span>
<a href="#l17.71"></a><span id="l17.71">   }</span>
<a href="#l17.72"></a><span id="l17.72"> </span>
<a href="#l17.73"></a><span id="l17.73" class="difflineminus">-  if (gPrefBranch.getBoolPref(&quot;mail.provider.enabled&quot;)) {</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+  if (Services.prefs.getBoolPref(&quot;mail.provider.enabled&quot;)) {</span>
<a href="#l17.75"></a><span id="l17.75">     Services.obs.addObserver({</span>
<a href="#l17.76"></a><span id="l17.76">       observe: function(aSubject, aTopic, aData) {</span>
<a href="#l17.77"></a><span id="l17.77">         if (aTopic == &quot;mail-tabs-session-restored&quot; &amp;&amp; aSubject === window) {</span>
<a href="#l17.78"></a><span id="l17.78">           // We're done here, unregister this observer.</span>
<a href="#l17.79"></a><span id="l17.79">           Services.obs.removeObserver(this, &quot;mail-tabs-session-restored&quot;);</span>
<a href="#l17.80"></a><span id="l17.80">           NewMailAccountProvisioner(msgWindow, { okCallback: null });</span>
<a href="#l17.81"></a><span id="l17.81">         }</span>
<a href="#l17.82"></a><span id="l17.82">       }</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineat">@@ -350,19 +351,19 @@ function OnLoadMessenger()</span>
<a href="#l17.84"></a><span id="l17.84"> </span>
<a href="#l17.85"></a><span id="l17.85">     document.documentElement.setAttribute(&quot;width&quot;, defaultWidth);</span>
<a href="#l17.86"></a><span id="l17.86">     document.documentElement.setAttribute(&quot;height&quot;, defaultHeight);</span>
<a href="#l17.87"></a><span id="l17.87">     // Make sure we're safe at the left/top edge of screen</span>
<a href="#l17.88"></a><span id="l17.88">     document.documentElement.setAttribute(&quot;screenX&quot;, screen.availLeft);</span>
<a href="#l17.89"></a><span id="l17.89">     document.documentElement.setAttribute(&quot;screenY&quot;, screen.availTop);</span>
<a href="#l17.90"></a><span id="l17.90">   }</span>
<a href="#l17.91"></a><span id="l17.91"> </span>
<a href="#l17.92"></a><span id="l17.92" class="difflineminus">-  gPrefBranch.addObserver(&quot;mail.pane_config.dynamic&quot;, MailPrefObserver, false);</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineminus">-  gPrefBranch.addObserver(&quot;mail.showCondensedAddresses&quot;, MailPrefObserver,</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineminus">-                          false);</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineplus">+  Services.prefs.addObserver(&quot;mail.pane_config.dynamic&quot;, MailPrefObserver, false);</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineplus">+  Services.prefs.addObserver(&quot;mail.showCondensedAddresses&quot;, MailPrefObserver,</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineplus">+                             false);</span>
<a href="#l17.98"></a><span id="l17.98"> </span>
<a href="#l17.99"></a><span id="l17.99">   MailOfflineMgr.init();</span>
<a href="#l17.100"></a><span id="l17.100">   CreateMailWindowGlobals();</span>
<a href="#l17.101"></a><span id="l17.101">   GetMessagePaneWrapper().collapsed = true;</span>
<a href="#l17.102"></a><span id="l17.102">   msgDBCacheManager.init();</span>
<a href="#l17.103"></a><span id="l17.103"> </span>
<a href="#l17.104"></a><span id="l17.104">   // This needs to be before we throw up the account wizard on first run.</span>
<a href="#l17.105"></a><span id="l17.105">   try {</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineat">@@ -473,18 +474,16 @@ function LoadPostAccountWizard()</span>
<a href="#l17.107"></a><span id="l17.107">         arg0 = arg0.wrappedJSObject;</span>
<a href="#l17.108"></a><span id="l17.108">       startMsgHdr = (&quot;msgHdr&quot; in arg0) ? arg0.msgHdr : null;</span>
<a href="#l17.109"></a><span id="l17.109">     }</span>
<a href="#l17.110"></a><span id="l17.110">   }</span>
<a href="#l17.111"></a><span id="l17.111"> </span>
<a href="#l17.112"></a><span id="l17.112">   function completeStartup() {</span>
<a href="#l17.113"></a><span id="l17.113">     // Check whether we need to show the default client dialog</span>
<a href="#l17.114"></a><span id="l17.114">     // First, check the shell service</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineminus">-    let obs = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineminus">-                        .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l17.117"></a><span id="l17.117">     var nsIShellService = Components.interfaces.nsIShellService;</span>
<a href="#l17.118"></a><span id="l17.118">     if (nsIShellService) {</span>
<a href="#l17.119"></a><span id="l17.119">       var shellService;</span>
<a href="#l17.120"></a><span id="l17.120">       var defaultAccount;</span>
<a href="#l17.121"></a><span id="l17.121">       try {</span>
<a href="#l17.122"></a><span id="l17.122">         shellService = Components.classes[&quot;@mozilla.org/mail/shell-service;1&quot;].getService(nsIShellService);</span>
<a href="#l17.123"></a><span id="l17.123">         defaultAccount = accountManager.defaultAccount;</span>
<a href="#l17.124"></a><span id="l17.124">       } catch (ex) {}</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineat">@@ -504,21 +503,21 @@ function LoadPostAccountWizard()</span>
<a href="#l17.126"></a><span id="l17.126">            &amp;&amp; !shellService.isDefaultClient(true, nsIShellService.MAIL)) ||</span>
<a href="#l17.127"></a><span id="l17.127">         (SearchIntegration &amp;&amp; !SearchIntegration.osVersionTooLow &amp;&amp;</span>
<a href="#l17.128"></a><span id="l17.128">          !SearchIntegration.osComponentsNotRunning &amp;&amp; !SearchIntegration.firstRunDone)) {</span>
<a href="#l17.129"></a><span id="l17.129">         window.openDialog(&quot;chrome://messenger/content/systemIntegrationDialog.xul&quot;,</span>
<a href="#l17.130"></a><span id="l17.130">                           &quot;SystemIntegration&quot;, &quot;modal,centerscreen,chrome,resizable=no&quot;);</span>
<a href="#l17.131"></a><span id="l17.131">         // On windows, there seems to be a delay between setting TB as the</span>
<a href="#l17.132"></a><span id="l17.132">         // default client, and the isDefaultClient check succeeding.</span>
<a href="#l17.133"></a><span id="l17.133">         if (shellService.isDefaultClient(true, nsIShellService.MAIL))</span>
<a href="#l17.134"></a><span id="l17.134" class="difflineminus">-          obs.notifyObservers(window, &quot;mail:setAsDefault&quot;, null);</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineplus">+          Services.obs.notifyObservers(window, &quot;mail:setAsDefault&quot;, null);</span>
<a href="#l17.136"></a><span id="l17.136">       }</span>
<a href="#l17.137"></a><span id="l17.137">     }</span>
<a href="#l17.138"></a><span id="l17.138">     // All core modal dialogs are done, the user can now interact with the 3-pane window</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineminus">-    obs.notifyObservers(window, &quot;mail-startup-done&quot;, null);</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineplus">+    Services.obs.notifyObservers(window, &quot;mail-startup-done&quot;, null);</span>
<a href="#l17.141"></a><span id="l17.141">   }</span>
<a href="#l17.142"></a><span id="l17.142"> </span>
<a href="#l17.143"></a><span id="l17.143">   setTimeout(completeStartup, 0);</span>
<a href="#l17.144"></a><span id="l17.144"> </span>
<a href="#l17.145"></a><span id="l17.145">   // FIX ME - later we will be able to use onload from the overlay</span>
<a href="#l17.146"></a><span id="l17.146">   OnLoadMsgHeaderPane();</span>
<a href="#l17.147"></a><span id="l17.147"> </span>
<a href="#l17.148"></a><span id="l17.148">   //Set focus to the Thread Pane the first time the window is opened.</span>
<a href="#l17.149"></a><span id="l17.149" class="difflineat">@@ -569,40 +568,37 @@ function HandleAppCommandEvent(evt)</span>
<a href="#l17.150"></a><span id="l17.150">   }</span>
<a href="#l17.151"></a><span id="l17.151"> }</span>
<a href="#l17.152"></a><span id="l17.152"> </span>
<a href="#l17.153"></a><span id="l17.153"> /**</span>
<a href="#l17.154"></a><span id="l17.154">  * Look for another 3-pane window.</span>
<a href="#l17.155"></a><span id="l17.155">  */</span>
<a href="#l17.156"></a><span id="l17.156"> function FindOther3PaneWindow()</span>
<a href="#l17.157"></a><span id="l17.157"> {</span>
<a href="#l17.158"></a><span id="l17.158" class="difflineminus">-  let windowMediator =</span>
<a href="#l17.159"></a><span id="l17.159" class="difflineminus">-    Components.classes[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l17.160"></a><span id="l17.160" class="difflineminus">-        .getService(Components.interfaces.nsIWindowMediator);</span>
<a href="#l17.161"></a><span id="l17.161">   // XXX We'd like to use getZOrderDOMWindowEnumerator here, but it doesn't work</span>
<a href="#l17.162"></a><span id="l17.162">   // on Linux</span>
<a href="#l17.163"></a><span id="l17.163" class="difflineminus">-  let enumerator = windowMediator.getEnumerator(&quot;mail:3pane&quot;);</span>
<a href="#l17.164"></a><span id="l17.164" class="difflineplus">+  let enumerator = Services.wm.getEnumerator(&quot;mail:3pane&quot;);</span>
<a href="#l17.165"></a><span id="l17.165">   while (enumerator.hasMoreElements()) {</span>
<a href="#l17.166"></a><span id="l17.166">     let win = enumerator.getNext();</span>
<a href="#l17.167"></a><span id="l17.167">     if (win != window)</span>
<a href="#l17.168"></a><span id="l17.168">       return win;</span>
<a href="#l17.169"></a><span id="l17.169">   }</span>
<a href="#l17.170"></a><span id="l17.170">   return null;</span>
<a href="#l17.171"></a><span id="l17.171"> }</span>
<a href="#l17.172"></a><span id="l17.172"> </span>
<a href="#l17.173"></a><span id="l17.173"> /**</span>
<a href="#l17.174"></a><span id="l17.174">  * Called by messenger.xul:onunload, the 3-pane window inside of tabs window.</span>
<a href="#l17.175"></a><span id="l17.175">  *  It's being unloaded!  Right now!</span>
<a href="#l17.176"></a><span id="l17.176">  */</span>
<a href="#l17.177"></a><span id="l17.177"> function OnUnloadMessenger()</span>
<a href="#l17.178"></a><span id="l17.178"> {</span>
<a href="#l17.179"></a><span id="l17.179">   Services.obs.notifyObservers(window, &quot;mail-unloading-messenger&quot;, null);</span>
<a href="#l17.180"></a><span id="l17.180">   accountManager.removeIncomingServerListener(gThreePaneIncomingServerListener);</span>
<a href="#l17.181"></a><span id="l17.181" class="difflineminus">-  gPrefBranch.removeObserver(&quot;mail.pane_config.dynamic&quot;, MailPrefObserver);</span>
<a href="#l17.182"></a><span id="l17.182" class="difflineminus">-  gPrefBranch.removeObserver(&quot;mail.showCondensedAddresses&quot;, MailPrefObserver);</span>
<a href="#l17.183"></a><span id="l17.183" class="difflineplus">+  Services.prefs.removeObserver(&quot;mail.pane_config.dynamic&quot;, MailPrefObserver);</span>
<a href="#l17.184"></a><span id="l17.184" class="difflineplus">+  Services.prefs.removeObserver(&quot;mail.showCondensedAddresses&quot;, MailPrefObserver);</span>
<a href="#l17.185"></a><span id="l17.185"> </span>
<a href="#l17.186"></a><span id="l17.186">   sessionStoreManager.unloadingWindow(window);</span>
<a href="#l17.187"></a><span id="l17.187"> </span>
<a href="#l17.188"></a><span id="l17.188">   TabsInTitlebar.uninit();</span>
<a href="#l17.189"></a><span id="l17.189"> </span>
<a href="#l17.190"></a><span id="l17.190">   let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l17.191"></a><span id="l17.191">   tabmail._teardown();</span>
<a href="#l17.192"></a><span id="l17.192"> </span>
<a href="#l17.193"></a><span id="l17.193" class="difflineat">@@ -773,19 +769,19 @@ function loadStartFolder(initialUri)</span>
<a href="#l17.194"></a><span id="l17.194">             defaultServer = defaultAccount.incomingServer;</span>
<a href="#l17.195"></a><span id="l17.195">             var rootMsgFolder = defaultServer.rootMsgFolder;</span>
<a href="#l17.196"></a><span id="l17.196"> </span>
<a href="#l17.197"></a><span id="l17.197">             startFolder = rootMsgFolder;</span>
<a href="#l17.198"></a><span id="l17.198"> </span>
<a href="#l17.199"></a><span id="l17.199">             // Enable check new mail once by turning checkmail pref 'on' to bring</span>
<a href="#l17.200"></a><span id="l17.200">             // all users to one plane. This allows all users to go to Inbox. User can</span>
<a href="#l17.201"></a><span id="l17.201">             // always go to server settings panel and turn off &quot;Check for new mail at startup&quot;</span>
<a href="#l17.202"></a><span id="l17.202" class="difflineminus">-            if (!gPrefBranch.getBoolPref(kMailCheckOncePrefName))</span>
<a href="#l17.203"></a><span id="l17.203" class="difflineplus">+            if (!Services.prefs.getBoolPref(kMailCheckOncePrefName))</span>
<a href="#l17.204"></a><span id="l17.204">             {</span>
<a href="#l17.205"></a><span id="l17.205" class="difflineminus">-                gPrefBranch.setBoolPref(kMailCheckOncePrefName, true);</span>
<a href="#l17.206"></a><span id="l17.206" class="difflineplus">+                Services.prefs.setBoolPref(kMailCheckOncePrefName, true);</span>
<a href="#l17.207"></a><span id="l17.207">                 defaultServer.loginAtStartUp = true;</span>
<a href="#l17.208"></a><span id="l17.208">             }</span>
<a href="#l17.209"></a><span id="l17.209"> </span>
<a href="#l17.210"></a><span id="l17.210">             // Get the user pref to see if the login at startup is enabled for default account</span>
<a href="#l17.211"></a><span id="l17.211">             isLoginAtStartUpEnabled = defaultServer.loginAtStartUp;</span>
<a href="#l17.212"></a><span id="l17.212"> </span>
<a href="#l17.213"></a><span id="l17.213">             // Get Inbox only if login at startup is enabled.</span>
<a href="#l17.214"></a><span id="l17.214">             if (isLoginAtStartUpEnabled)</span>
<a href="#l17.215"></a><span id="l17.215" class="difflineat">@@ -839,22 +835,22 @@ function loadStartFolder(initialUri)</span>
<a href="#l17.216"></a><span id="l17.216">     MsgGetMessagesForAllServers(defaultServer);</span>
<a href="#l17.217"></a><span id="l17.217"> </span>
<a href="#l17.218"></a><span id="l17.218">     if (MailOfflineMgr.isOnline()) {</span>
<a href="#l17.219"></a><span id="l17.219">       // Check if we shut down offline, and restarted online, in which case</span>
<a href="#l17.220"></a><span id="l17.220">       // we may have offline events to playback. Since this is not a pref</span>
<a href="#l17.221"></a><span id="l17.221">       // the user should set, it's not in mailnews.js, so we need a try catch.</span>
<a href="#l17.222"></a><span id="l17.222">       let playbackOfflineEvents = false;</span>
<a href="#l17.223"></a><span id="l17.223">       try {</span>
<a href="#l17.224"></a><span id="l17.224" class="difflineminus">-        playbackOfflineEvents = gPrefBranch.getBoolPref(&quot;mailnews.playback_offline&quot;);</span>
<a href="#l17.225"></a><span id="l17.225" class="difflineplus">+        playbackOfflineEvents = Services.prefs.getBoolPref(&quot;mailnews.playback_offline&quot;);</span>
<a href="#l17.226"></a><span id="l17.226">       }</span>
<a href="#l17.227"></a><span id="l17.227">       catch(ex) {}</span>
<a href="#l17.228"></a><span id="l17.228">       if (playbackOfflineEvents)</span>
<a href="#l17.229"></a><span id="l17.229">       {</span>
<a href="#l17.230"></a><span id="l17.230" class="difflineminus">-        gPrefBranch.setBoolPref(&quot;mailnews.playback_offline&quot;, false);</span>
<a href="#l17.231"></a><span id="l17.231" class="difflineplus">+        Services.prefs.setBoolPref(&quot;mailnews.playback_offline&quot;, false);</span>
<a href="#l17.232"></a><span id="l17.232">         MailOfflineMgr.offlineManager.goOnline(false, true, msgWindow);</span>
<a href="#l17.233"></a><span id="l17.233">       }</span>
<a href="#l17.234"></a><span id="l17.234"> </span>
<a href="#l17.235"></a><span id="l17.235">       // If appropriate, send unsent messages. This may end up prompting the user,</span>
<a href="#l17.236"></a><span id="l17.236">       // so we need to get it out of the flow of the normal load sequence.</span>
<a href="#l17.237"></a><span id="l17.237">       setTimeout(function checkUnsent() {</span>
<a href="#l17.238"></a><span id="l17.238">         if (MailOfflineMgr.shouldSendUnsentMessages())</span>
<a href="#l17.239"></a><span id="l17.239">           SendUnsentMessages();</span>
<a href="#l17.240"></a><span id="l17.240" class="difflineat">@@ -908,20 +904,20 @@ function UnloadPanes()</span>
<a href="#l17.241"></a><span id="l17.241">  * This used to do things related to updating the visible columns and reordering</span>
<a href="#l17.242"></a><span id="l17.242">  * them, but that is now handled by FolderDisplayWidget.</span>
<a href="#l17.243"></a><span id="l17.243">  */</span>
<a href="#l17.244"></a><span id="l17.244"> function UpgradeProfileAndBeUglyAboutIt()</span>
<a href="#l17.245"></a><span id="l17.245"> {</span>
<a href="#l17.246"></a><span id="l17.246">   var threadPaneUIVersion;</span>
<a href="#l17.247"></a><span id="l17.247"> </span>
<a href="#l17.248"></a><span id="l17.248">   try {</span>
<a href="#l17.249"></a><span id="l17.249" class="difflineminus">-    threadPaneUIVersion = gPrefBranch.getIntPref(&quot;mailnews.ui.threadpane.version&quot;);</span>
<a href="#l17.250"></a><span id="l17.250" class="difflineplus">+    threadPaneUIVersion = Services.prefs.getIntPref(&quot;mailnews.ui.threadpane.version&quot;);</span>
<a href="#l17.251"></a><span id="l17.251">     if (threadPaneUIVersion &lt; 7)</span>
<a href="#l17.252"></a><span id="l17.252">     {</span>
<a href="#l17.253"></a><span id="l17.253" class="difflineminus">-      gPrefBranch.setIntPref(&quot;mailnews.ui.threadpane.version&quot;, 7);</span>
<a href="#l17.254"></a><span id="l17.254" class="difflineplus">+      Services.prefs.setIntPref(&quot;mailnews.ui.threadpane.version&quot;, 7);</span>
<a href="#l17.255"></a><span id="l17.255">     } // version 7 upgrades</span>
<a href="#l17.256"></a><span id="l17.256">   }</span>
<a href="#l17.257"></a><span id="l17.257">   catch (ex) {</span>
<a href="#l17.258"></a><span id="l17.258">     Components.utils.reportError(ex);</span>
<a href="#l17.259"></a><span id="l17.259">   }</span>
<a href="#l17.260"></a><span id="l17.260"> }</span>
<a href="#l17.261"></a><span id="l17.261"> </span>
<a href="#l17.262"></a><span id="l17.262"> function OnLoadThreadPane()</span>
<a href="#l17.263"></a><span id="l17.263" class="difflineat">@@ -1099,17 +1095,17 @@ function TreeOnMouseDown(event)</span>
<a href="#l17.264"></a><span id="l17.264">       // We want a single selection if this is a middle-click (button 1)</span>
<a href="#l17.265"></a><span id="l17.265">       ChangeSelectionWithoutContentLoad(event, event.target.parentNode,</span>
<a href="#l17.266"></a><span id="l17.266">                                         event.button == 1);</span>
<a href="#l17.267"></a><span id="l17.267">     }</span>
<a href="#l17.268"></a><span id="l17.268"> }</span>
<a href="#l17.269"></a><span id="l17.269"> </span>
<a href="#l17.270"></a><span id="l17.270"> function FolderPaneContextMenuNewTab(event)</span>
<a href="#l17.271"></a><span id="l17.271"> {</span>
<a href="#l17.272"></a><span id="l17.272" class="difflineminus">-  var bgLoad = gPrefBranch.getBoolPref(&quot;mail.tabs.loadInBackground&quot;);</span>
<a href="#l17.273"></a><span id="l17.273" class="difflineplus">+  var bgLoad = Services.prefs.getBoolPref(&quot;mail.tabs.loadInBackground&quot;);</span>
<a href="#l17.274"></a><span id="l17.274">   if (event.shiftKey)</span>
<a href="#l17.275"></a><span id="l17.275">     bgLoad = !bgLoad;</span>
<a href="#l17.276"></a><span id="l17.276">   MsgOpenNewTabForFolder(bgLoad);</span>
<a href="#l17.277"></a><span id="l17.277"> }</span>
<a href="#l17.278"></a><span id="l17.278"> </span>
<a href="#l17.279"></a><span id="l17.279"> function FolderPaneOnClick(event)</span>
<a href="#l17.280"></a><span id="l17.280"> {</span>
<a href="#l17.281"></a><span id="l17.281">   var folderTree = document.getElementById(&quot;folderTree&quot;);</span>
<a href="#l17.282"></a><span id="l17.282" class="difflineat">@@ -1140,17 +1136,17 @@ function FolderPaneOnClick(event)</span>
<a href="#l17.283"></a><span id="l17.283">     }</span>
<a href="#l17.284"></a><span id="l17.284">   }</span>
<a href="#l17.285"></a><span id="l17.285"> }</span>
<a href="#l17.286"></a><span id="l17.286"> </span>
<a href="#l17.287"></a><span id="l17.287"> function OpenMessageInNewTab(event)</span>
<a href="#l17.288"></a><span id="l17.288"> {</span>
<a href="#l17.289"></a><span id="l17.289">   if (!gFolderDisplay.selectedMessage)</span>
<a href="#l17.290"></a><span id="l17.290">     return;</span>
<a href="#l17.291"></a><span id="l17.291" class="difflineminus">-  var bgLoad = gPrefBranch.getBoolPref(&quot;mail.tabs.loadInBackground&quot;);</span>
<a href="#l17.292"></a><span id="l17.292" class="difflineplus">+  var bgLoad = Services.prefs.getBoolPref(&quot;mail.tabs.loadInBackground&quot;);</span>
<a href="#l17.293"></a><span id="l17.293">   if (event.shiftKey)</span>
<a href="#l17.294"></a><span id="l17.294">     bgLoad = !bgLoad;</span>
<a href="#l17.295"></a><span id="l17.295"> </span>
<a href="#l17.296"></a><span id="l17.296">   document.getElementById(&quot;tabmail&quot;).openTab(&quot;message&quot;,</span>
<a href="#l17.297"></a><span id="l17.297">       {msgHdr: gFolderDisplay.selectedMessage,</span>
<a href="#l17.298"></a><span id="l17.298">        viewWrapperToClone: gFolderDisplay.view,</span>
<a href="#l17.299"></a><span id="l17.299">        background: bgLoad});</span>
<a href="#l17.300"></a><span id="l17.300"> }</span>
<a href="#l17.301"></a><span id="l17.301" class="difflineat">@@ -1183,126 +1179,134 @@ function ReloadMessage()</span>
<a href="#l17.302"></a><span id="l17.302">   gFolderDisplay.view.dbView.reloadMessage();</span>
<a href="#l17.303"></a><span id="l17.303"> }</span>
<a href="#l17.304"></a><span id="l17.304"> </span>
<a href="#l17.305"></a><span id="l17.305"> // Some of the per account junk mail settings have been</span>
<a href="#l17.306"></a><span id="l17.306"> // converted to global prefs. Let's try to migrate some</span>
<a href="#l17.307"></a><span id="l17.307"> // of those settings from the default account.</span>
<a href="#l17.308"></a><span id="l17.308"> function MigrateJunkMailSettings()</span>
<a href="#l17.309"></a><span id="l17.309"> {</span>
<a href="#l17.310"></a><span id="l17.310" class="difflineminus">-  var junkMailSettingsVersion = gPrefBranch.getIntPref(&quot;mail.spam.version&quot;);</span>
<a href="#l17.311"></a><span id="l17.311" class="difflineplus">+  var junkMailSettingsVersion = Services.prefs.getIntPref(&quot;mail.spam.version&quot;);</span>
<a href="#l17.312"></a><span id="l17.312">   if (!junkMailSettingsVersion)</span>
<a href="#l17.313"></a><span id="l17.313">   {</span>
<a href="#l17.314"></a><span id="l17.314">     // Get the default account, check to see if we have values for our</span>
<a href="#l17.315"></a><span id="l17.315">     // globally migrated prefs.</span>
<a href="#l17.316"></a><span id="l17.316">     var defaultAccount;</span>
<a href="#l17.317"></a><span id="l17.317">     try {</span>
<a href="#l17.318"></a><span id="l17.318">       defaultAccount = accountManager.defaultAccount;</span>
<a href="#l17.319"></a><span id="l17.319">     } catch (ex) {}</span>
<a href="#l17.320"></a><span id="l17.320">     if (defaultAccount &amp;&amp; defaultAccount.incomingServer)</span>
<a href="#l17.321"></a><span id="l17.321">     {</span>
<a href="#l17.322"></a><span id="l17.322">       // we only care about</span>
<a href="#l17.323"></a><span id="l17.323">       var prefix = &quot;mail.server.&quot; + defaultAccount.incomingServer.key + &quot;.&quot;;</span>
<a href="#l17.324"></a><span id="l17.324" class="difflineminus">-      if (gPrefBranch.prefHasUserValue(prefix + &quot;manualMark&quot;))</span>
<a href="#l17.325"></a><span id="l17.325" class="difflineminus">-        gPrefBranch.setBoolPref(&quot;mail.spam.manualMark&quot;, pref.getBoolPref(prefix + &quot;manualMark&quot;));</span>
<a href="#l17.326"></a><span id="l17.326" class="difflineminus">-      if (gPrefBranch.prefHasUserValue(prefix + &quot;manualMarkMode&quot;))</span>
<a href="#l17.327"></a><span id="l17.327" class="difflineminus">-        gPrefBranch.setIntPref(&quot;mail.spam.manualMarkMode&quot;, pref.getIntPref(prefix + &quot;manualMarkMode&quot;));</span>
<a href="#l17.328"></a><span id="l17.328" class="difflineminus">-      if (gPrefBranch.prefHasUserValue(prefix + &quot;spamLoggingEnabled&quot;))</span>
<a href="#l17.329"></a><span id="l17.329" class="difflineminus">-        gPrefBranch.setBoolPref(&quot;mail.spam.logging.enabled&quot;, pref.getBoolPref(prefix + &quot;spamLoggingEnabled&quot;));</span>
<a href="#l17.330"></a><span id="l17.330" class="difflineminus">-      if (gPrefBranch.prefHasUserValue(prefix + &quot;markAsReadOnSpam&quot;))</span>
<a href="#l17.331"></a><span id="l17.331" class="difflineminus">-        gPrefBranch.setBoolPref(&quot;mail.spam.markAsReadOnSpam&quot;, pref.getBoolPref(prefix + &quot;markAsReadOnSpam&quot;));</span>
<a href="#l17.332"></a><span id="l17.332" class="difflineplus">+      if (Services.prefs.prefHasUserValue(prefix + &quot;manualMark&quot;))</span>
<a href="#l17.333"></a><span id="l17.333" class="difflineplus">+      {</span>
<a href="#l17.334"></a><span id="l17.334" class="difflineplus">+        Services.prefs.setBoolPref(&quot;mail.spam.manualMark&quot;,</span>
<a href="#l17.335"></a><span id="l17.335" class="difflineplus">+          Services.prefs.getBoolPref(prefix + &quot;manualMark&quot;));</span>
<a href="#l17.336"></a><span id="l17.336" class="difflineplus">+      }</span>
<a href="#l17.337"></a><span id="l17.337" class="difflineplus">+      if (Services.prefs.prefHasUserValue(prefix + &quot;manualMarkMode&quot;))</span>
<a href="#l17.338"></a><span id="l17.338" class="difflineplus">+      {</span>
<a href="#l17.339"></a><span id="l17.339" class="difflineplus">+        Services.prefs.setIntPref(&quot;mail.spam.manualMarkMode&quot;,</span>
<a href="#l17.340"></a><span id="l17.340" class="difflineplus">+          Services.prefs.getIntPref(prefix + &quot;manualMarkMode&quot;));</span>
<a href="#l17.341"></a><span id="l17.341" class="difflineplus">+      }</span>
<a href="#l17.342"></a><span id="l17.342" class="difflineplus">+      if (Services.prefs.prefHasUserValue(prefix + &quot;spamLoggingEnabled&quot;))</span>
<a href="#l17.343"></a><span id="l17.343" class="difflineplus">+      {</span>
<a href="#l17.344"></a><span id="l17.344" class="difflineplus">+        Services.prefs.setBoolPref(&quot;mail.spam.logging.enabled&quot;,</span>
<a href="#l17.345"></a><span id="l17.345" class="difflineplus">+          Services.prefs.getBoolPref(prefix + &quot;spamLoggingEnabled&quot;));</span>
<a href="#l17.346"></a><span id="l17.346" class="difflineplus">+      }</span>
<a href="#l17.347"></a><span id="l17.347" class="difflineplus">+      if (Services.prefs.prefHasUserValue(prefix + &quot;markAsReadOnSpam&quot;))</span>
<a href="#l17.348"></a><span id="l17.348" class="difflineplus">+      {</span>
<a href="#l17.349"></a><span id="l17.349" class="difflineplus">+        Services.prefs.setBoolPref(&quot;mail.spam.markAsReadOnSpam&quot;,</span>
<a href="#l17.350"></a><span id="l17.350" class="difflineplus">+          Services.prefs.getBoolPref(prefix + &quot;markAsReadOnSpam&quot;));</span>
<a href="#l17.351"></a><span id="l17.351" class="difflineplus">+      }</span>
<a href="#l17.352"></a><span id="l17.352">     }</span>
<a href="#l17.353"></a><span id="l17.353">     // bump the version so we don't bother doing this again.</span>
<a href="#l17.354"></a><span id="l17.354" class="difflineminus">-    gPrefBranch.setIntPref(&quot;mail.spam.version&quot;, 1);</span>
<a href="#l17.355"></a><span id="l17.355" class="difflineplus">+    Services.prefs.setIntPref(&quot;mail.spam.version&quot;, 1);</span>
<a href="#l17.356"></a><span id="l17.356">   }</span>
<a href="#l17.357"></a><span id="l17.357"> }</span>
<a href="#l17.358"></a><span id="l17.358"> </span>
<a href="#l17.359"></a><span id="l17.359"> // The first time a user runs a build that supports folder views, pre-populate the favorite folders list</span>
<a href="#l17.360"></a><span id="l17.360"> // with the existing INBOX folders.</span>
<a href="#l17.361"></a><span id="l17.361"> function MigrateFolderViews()</span>
<a href="#l17.362"></a><span id="l17.362"> {</span>
<a href="#l17.363"></a><span id="l17.363" class="difflineminus">-  var folderViewsVersion = gPrefBranch.getIntPref(&quot;mail.folder.views.version&quot;);</span>
<a href="#l17.364"></a><span id="l17.364" class="difflineplus">+  var folderViewsVersion = Services.prefs.getIntPref(&quot;mail.folder.views.version&quot;);</span>
<a href="#l17.365"></a><span id="l17.365">   if (!folderViewsVersion)</span>
<a href="#l17.366"></a><span id="l17.366">   {</span>
<a href="#l17.367"></a><span id="l17.367">      var servers = accountManager.allServers;</span>
<a href="#l17.368"></a><span id="l17.368">      var server;</span>
<a href="#l17.369"></a><span id="l17.369">      var inbox;</span>
<a href="#l17.370"></a><span id="l17.370">      for (var index = 0; index &lt; servers.length; index++)</span>
<a href="#l17.371"></a><span id="l17.371">      {</span>
<a href="#l17.372"></a><span id="l17.372">        server = servers.queryElementAt(index, Components.interfaces.nsIMsgIncomingServer);</span>
<a href="#l17.373"></a><span id="l17.373">        if (server)</span>
<a href="#l17.374"></a><span id="l17.374">        {</span>
<a href="#l17.375"></a><span id="l17.375">          inbox = GetInboxFolder(server);</span>
<a href="#l17.376"></a><span id="l17.376">          if (inbox)</span>
<a href="#l17.377"></a><span id="l17.377">            inbox.setFlag(Components.interfaces.nsMsgFolderFlags.Favorite);</span>
<a href="#l17.378"></a><span id="l17.378">        }</span>
<a href="#l17.379"></a><span id="l17.379">      }</span>
<a href="#l17.380"></a><span id="l17.380" class="difflineminus">-    gPrefBranch.setIntPref(&quot;mail.folder.views.version&quot;, 1);</span>
<a href="#l17.381"></a><span id="l17.381" class="difflineplus">+    Services.prefs.setIntPref(&quot;mail.folder.views.version&quot;, 1);</span>
<a href="#l17.382"></a><span id="l17.382">   }</span>
<a href="#l17.383"></a><span id="l17.383"> }</span>
<a href="#l17.384"></a><span id="l17.384"> </span>
<a href="#l17.385"></a><span id="l17.385"> // Thunderbird has been storing old attachment download meta data in downloads.rdf</span>
<a href="#l17.386"></a><span id="l17.386"> // even though there was no way to show or clean up this data. Now that we are using</span>
<a href="#l17.387"></a><span id="l17.387"> // the new download manager in toolkit, we don't want to present this old data.</span>
<a href="#l17.388"></a><span id="l17.388"> // To migrate to the new download manager, remove downloads.rdf.</span>
<a href="#l17.389"></a><span id="l17.389"> function MigrateAttachmentDownloadStore()</span>
<a href="#l17.390"></a><span id="l17.390"> {</span>
<a href="#l17.391"></a><span id="l17.391" class="difflineminus">-  var attachmentStoreVersion = gPrefBranch.getIntPref(&quot;mail.attachment.store.version&quot;);</span>
<a href="#l17.392"></a><span id="l17.392" class="difflineplus">+  var attachmentStoreVersion = Services.prefs.getIntPref(&quot;mail.attachment.store.version&quot;);</span>
<a href="#l17.393"></a><span id="l17.393">   if (!attachmentStoreVersion)</span>
<a href="#l17.394"></a><span id="l17.394">   {</span>
<a href="#l17.395"></a><span id="l17.395" class="difflineminus">-    var dirService = Components.classes[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l17.396"></a><span id="l17.396" class="difflineminus">-                     .getService(Components.interfaces.nsIProperties);</span>
<a href="#l17.397"></a><span id="l17.397" class="difflineminus">-    var downloadsFile = dirService.get(&quot;DLoads&quot;, Components.interfaces.nsIFile);</span>
<a href="#l17.398"></a><span id="l17.398" class="difflineplus">+    var downloadsFile = Services.dirsvc.get(&quot;DLoads&quot;, Components.interfaces.nsIFile);</span>
<a href="#l17.399"></a><span id="l17.399">     if (downloadsFile &amp;&amp; downloadsFile.exists())</span>
<a href="#l17.400"></a><span id="l17.400">       downloadsFile.remove(false);</span>
<a href="#l17.401"></a><span id="l17.401"> </span>
<a href="#l17.402"></a><span id="l17.402">     // bump the version so we don't bother doing this again.</span>
<a href="#l17.403"></a><span id="l17.403" class="difflineminus">-    gPrefBranch.setIntPref(&quot;mail.attachment.store.version&quot;, 1);</span>
<a href="#l17.404"></a><span id="l17.404" class="difflineplus">+    Services.prefs.setIntPref(&quot;mail.attachment.store.version&quot;, 1);</span>
<a href="#l17.405"></a><span id="l17.405">   }</span>
<a href="#l17.406"></a><span id="l17.406"> }</span>
<a href="#l17.407"></a><span id="l17.407"> </span>
<a href="#l17.408"></a><span id="l17.408"> // Do a one-time migration of the old mailnews.reuse_message_window pref to the</span>
<a href="#l17.409"></a><span id="l17.409"> // newer mail.openMessageBehavior. This does the migration only if the old pref</span>
<a href="#l17.410"></a><span id="l17.410"> // is defined.</span>
<a href="#l17.411"></a><span id="l17.411"> function MigrateOpenMessageBehavior()</span>
<a href="#l17.412"></a><span id="l17.412"> {</span>
<a href="#l17.413"></a><span id="l17.413" class="difflineminus">-  let openMessageBehaviorVersion = gPrefBranch.getIntPref(</span>
<a href="#l17.414"></a><span id="l17.414" class="difflineplus">+  let openMessageBehaviorVersion = Services.prefs.getIntPref(</span>
<a href="#l17.415"></a><span id="l17.415">                                      &quot;mail.openMessageBehavior.version&quot;);</span>
<a href="#l17.416"></a><span id="l17.416">   if (!openMessageBehaviorVersion)</span>
<a href="#l17.417"></a><span id="l17.417">   {</span>
<a href="#l17.418"></a><span id="l17.418">     let reuseMessageWindow;</span>
<a href="#l17.419"></a><span id="l17.419">     try {</span>
<a href="#l17.420"></a><span id="l17.420" class="difflineminus">-      reuseMessageWindow = gPrefBranch.getBoolPref(</span>
<a href="#l17.421"></a><span id="l17.421" class="difflineplus">+      reuseMessageWindow = Services.prefs.getBoolPref(</span>
<a href="#l17.422"></a><span id="l17.422">                              &quot;mailnews.reuse_message_window&quot;);</span>
<a href="#l17.423"></a><span id="l17.423">     }</span>
<a href="#l17.424"></a><span id="l17.424">     catch (e) {}</span>
<a href="#l17.425"></a><span id="l17.425"> </span>
<a href="#l17.426"></a><span id="l17.426">     // Don't touch this if it isn't defined</span>
<a href="#l17.427"></a><span id="l17.427">     if (reuseMessageWindow === true)</span>
<a href="#l17.428"></a><span id="l17.428" class="difflineminus">-      gPrefBranch.setIntPref(&quot;mail.openMessageBehavior&quot;,</span>
<a href="#l17.429"></a><span id="l17.429" class="difflineplus">+      Services.prefs.setIntPref(&quot;mail.openMessageBehavior&quot;,</span>
<a href="#l17.430"></a><span id="l17.430">           MailConsts.OpenMessageBehavior.EXISTING_WINDOW);</span>
<a href="#l17.431"></a><span id="l17.431">     else if (reuseMessageWindow === false)</span>
<a href="#l17.432"></a><span id="l17.432" class="difflineminus">-      gPrefBranch.setIntPref(&quot;mail.openMessageBehavior&quot;,</span>
<a href="#l17.433"></a><span id="l17.433" class="difflineplus">+      Services.prefs.setIntPref(&quot;mail.openMessageBehavior&quot;,</span>
<a href="#l17.434"></a><span id="l17.434">           MailConsts.OpenMessageBehavior.NEW_TAB);</span>
<a href="#l17.435"></a><span id="l17.435"> </span>
<a href="#l17.436"></a><span id="l17.436" class="difflineminus">-    gPrefBranch.setIntPref(&quot;mail.openMessageBehavior.version&quot;, 1);</span>
<a href="#l17.437"></a><span id="l17.437" class="difflineplus">+    Services.prefs.setIntPref(&quot;mail.openMessageBehavior.version&quot;, 1);</span>
<a href="#l17.438"></a><span id="l17.438">   }</span>
<a href="#l17.439"></a><span id="l17.439"> }</span>
<a href="#l17.440"></a><span id="l17.440"> </span>
<a href="#l17.441"></a><span id="l17.441"> function ThreadPaneOnDragStart(aEvent) {</span>
<a href="#l17.442"></a><span id="l17.442">   if (aEvent.originalTarget.localName != &quot;treechildren&quot;)</span>
<a href="#l17.443"></a><span id="l17.443">     return;</span>
<a href="#l17.444"></a><span id="l17.444"> </span>
<a href="#l17.445"></a><span id="l17.445">   let messages = gFolderDisplay.selectedMessageUris;</span>
<a href="#l17.446"></a><span id="l17.446">   if (!messages)</span>
<a href="#l17.447"></a><span id="l17.447">     return;</span>
<a href="#l17.448"></a><span id="l17.448"> </span>
<a href="#l17.449"></a><span id="l17.449">   gFolderDisplay.hintAboutToDeleteMessages();</span>
<a href="#l17.450"></a><span id="l17.450" class="difflineminus">-  let ios = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l17.451"></a><span id="l17.451" class="difflineminus">-                      .getService(Components.interfaces.nsIIOService);</span>
<a href="#l17.452"></a><span id="l17.452">   let fileNames = [];</span>
<a href="#l17.453"></a><span id="l17.453">   let msgUrls = {};</span>
<a href="#l17.454"></a><span id="l17.454"> </span>
<a href="#l17.455"></a><span id="l17.455">   // dragging multiple messages to desktop does not</span>
<a href="#l17.456"></a><span id="l17.456">   // currently work, pending core fixes for</span>
<a href="#l17.457"></a><span id="l17.457">   // multiple-drop-on-desktop support. (bug 513464)</span>
<a href="#l17.458"></a><span id="l17.458">   for (let i in messages) {</span>
<a href="#l17.459"></a><span id="l17.459">     messenger.messageServiceFromURI(messages[i])</span>
<a href="#l17.460"></a><span id="l17.460" class="difflineat">@@ -1539,21 +1543,18 @@ var LightWeightThemeWebInstaller = {</span>
<a href="#l17.461"></a><span id="l17.461">     this._previewWindow.removeEventListener(&quot;pagehide&quot;, this, true);</span>
<a href="#l17.462"></a><span id="l17.462">     this._previewWindow = null;</span>
<a href="#l17.463"></a><span id="l17.463">     document.getElementById('tabmail').unregisterTabMonitor(this);</span>
<a href="#l17.464"></a><span id="l17.464"> </span>
<a href="#l17.465"></a><span id="l17.465">     this._manager.resetPreview();</span>
<a href="#l17.466"></a><span id="l17.466">   },</span>
<a href="#l17.467"></a><span id="l17.467"> </span>
<a href="#l17.468"></a><span id="l17.468">   _isAllowed: function (node) {</span>
<a href="#l17.469"></a><span id="l17.469" class="difflineminus">-    let pm = Components.classes[&quot;@mozilla.org/permissionmanager;1&quot;]</span>
<a href="#l17.470"></a><span id="l17.470" class="difflineminus">-      .getService(Components.interfaces.nsIPermissionManager);</span>
<a href="#l17.471"></a><span id="l17.471" class="difflineminus">-</span>
<a href="#l17.472"></a><span id="l17.472">     let uri = node.ownerDocument.documentURIObject;</span>
<a href="#l17.473"></a><span id="l17.473" class="difflineminus">-    return pm.testPermission(uri, &quot;install&quot;) == pm.ALLOW_ACTION;</span>
<a href="#l17.474"></a><span id="l17.474" class="difflineplus">+    return Services.perms.testPermission(uri, &quot;install&quot;) == Services.perms.ALLOW_ACTION;</span>
<a href="#l17.475"></a><span id="l17.475">   },</span>
<a href="#l17.476"></a><span id="l17.476"> </span>
<a href="#l17.477"></a><span id="l17.477">   _getNotificationBox: function () {</span>
<a href="#l17.478"></a><span id="l17.478">     // Try and get the notification box for the selected tab.</span>
<a href="#l17.479"></a><span id="l17.479">     let browser = document.getElementById('tabmail').getBrowserForSelectedTab();</span>
<a href="#l17.480"></a><span id="l17.480">     // The messagepane doesn't have a notification bar yet.</span>
<a href="#l17.481"></a><span id="l17.481">     if (browser &amp;&amp; browser.parentNode.tagName == &quot;notificationbox&quot;)</span>
<a href="#l17.482"></a><span id="l17.482">       return browser.parentNode;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mail/base/content/msgViewNavigation.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mail/base/content/msgViewNavigation.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1,16 +1,17 @@</span>
<a href="#l18.4"></a><span id="l18.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l18.5"></a><span id="l18.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.6"></a><span id="l18.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.7"></a><span id="l18.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.8"></a><span id="l18.8"> </span>
<a href="#l18.9"></a><span id="l18.9"> /*  This file contains the js functions necessary to implement view navigation within the 3 pane. */</span>
<a href="#l18.10"></a><span id="l18.10"> </span>
<a href="#l18.11"></a><span id="l18.11"> Components.utils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l18.13"></a><span id="l18.13"> </span>
<a href="#l18.14"></a><span id="l18.14"> function GetSubFoldersInFolderPaneOrder(folder)</span>
<a href="#l18.15"></a><span id="l18.15"> {</span>
<a href="#l18.16"></a><span id="l18.16">   var subFolders = folder.subFolders;</span>
<a href="#l18.17"></a><span id="l18.17">   var msgFolders = Array();</span>
<a href="#l18.18"></a><span id="l18.18"> </span>
<a href="#l18.19"></a><span id="l18.19">   // get all the subfolders</span>
<a href="#l18.20"></a><span id="l18.20">   while (subFolders.hasMoreElements()) {</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineat">@@ -133,38 +134,36 @@ function CrossFolderNavigation(type)</span>
<a href="#l18.22"></a><span id="l18.22">       type != nsMsgNavigationType.nextUnreadThread &amp;&amp;</span>
<a href="#l18.23"></a><span id="l18.23">       type != nsMsgNavigationType.forward &amp;&amp;</span>
<a href="#l18.24"></a><span id="l18.24">       type != nsMsgNavigationType.back)</span>
<a href="#l18.25"></a><span id="l18.25">     return;</span>
<a href="#l18.26"></a><span id="l18.26"> </span>
<a href="#l18.27"></a><span id="l18.27">   if (type == nsMsgNavigationType.nextUnreadMessage ||</span>
<a href="#l18.28"></a><span id="l18.28">       type == nsMsgNavigationType.nextUnreadThread)</span>
<a href="#l18.29"></a><span id="l18.29">   {</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineminus">-    var nextMode = pref.getIntPref(&quot;mailnews.nav_crosses_folders&quot;);</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+    var nextMode = Services.prefs.getIntPref(&quot;mailnews.nav_crosses_folders&quot;);</span>
<a href="#l18.32"></a><span id="l18.32">     // 0: &quot;next&quot; goes to the next folder, without prompting</span>
<a href="#l18.33"></a><span id="l18.33">     // 1: &quot;next&quot; goes to the next folder, and prompts (the default)</span>
<a href="#l18.34"></a><span id="l18.34">     // 2: &quot;next&quot; does nothing when there are no unread messages</span>
<a href="#l18.35"></a><span id="l18.35"> </span>
<a href="#l18.36"></a><span id="l18.36">     // not crossing folders, don't find next</span>
<a href="#l18.37"></a><span id="l18.37">     if (nextMode == 2)</span>
<a href="#l18.38"></a><span id="l18.38">       return;</span>
<a href="#l18.39"></a><span id="l18.39"> </span>
<a href="#l18.40"></a><span id="l18.40">     var folder = FindNextFolder();</span>
<a href="#l18.41"></a><span id="l18.41">     if (folder &amp;&amp; (gDBView.msgFolder.URI != folder.URI)) </span>
<a href="#l18.42"></a><span id="l18.42">     {</span>
<a href="#l18.43"></a><span id="l18.43">       if (nextMode == 1)</span>
<a href="#l18.44"></a><span id="l18.44">       {</span>
<a href="#l18.45"></a><span id="l18.45">         let promptText = document.getElementById(&quot;bundle_messenger&quot;)</span>
<a href="#l18.46"></a><span id="l18.46">                                  .getFormattedString(&quot;advanceNextPrompt&quot;,</span>
<a href="#l18.47"></a><span id="l18.47">                                                      [folder.name], 1);</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineminus">-        let promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineminus">-                                      .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineminus">-        if (promptService.confirmEx(window, null, promptText,</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineminus">-                                    promptService.STD_YES_NO_BUTTONS,</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineminus">-                                    null, null, null, null, {}))</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineplus">+        if (Services.prompt.confirmEx(window, null, promptText,</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineplus">+                                      Services.prompt.STD_YES_NO_BUTTONS,</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineplus">+                                      null, null, null, null, {}))</span>
<a href="#l18.56"></a><span id="l18.56">           return;</span>
<a href="#l18.57"></a><span id="l18.57">       }</span>
<a href="#l18.58"></a><span id="l18.58">       gFolderDisplay.pushNavigation(type, true);</span>
<a href="#l18.59"></a><span id="l18.59">       SelectFolder(folder.URI);</span>
<a href="#l18.60"></a><span id="l18.60">     }</span>
<a href="#l18.61"></a><span id="l18.61">   }</span>
<a href="#l18.62"></a><span id="l18.62">   else</span>
<a href="#l18.63"></a><span id="l18.63">   {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mail/base/content/newTagDialog.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mail/base/content/newTagDialog.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -1,14 +1,16 @@</span>
<a href="#l19.4"></a><span id="l19.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l19.5"></a><span id="l19.5">  *</span>
<a href="#l19.6"></a><span id="l19.6">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l19.7"></a><span id="l19.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l19.8"></a><span id="l19.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l19.9"></a><span id="l19.9"> </span>
<a href="#l19.10"></a><span id="l19.10" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineplus">+</span>
<a href="#l19.12"></a><span id="l19.12"> var dialog;</span>
<a href="#l19.13"></a><span id="l19.13"> </span>
<a href="#l19.14"></a><span id="l19.14"> /**</span>
<a href="#l19.15"></a><span id="l19.15">  * Pass in keyToEdit as a window argument to turn this dialog into an edit</span>
<a href="#l19.16"></a><span id="l19.16">  * tag dialog.</span>
<a href="#l19.17"></a><span id="l19.17">  */</span>
<a href="#l19.18"></a><span id="l19.18"> function onLoad()</span>
<a href="#l19.19"></a><span id="l19.19"> {</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineat">@@ -97,17 +99,15 @@ function onOKNewTag()</span>
<a href="#l19.21"></a><span id="l19.21"> /**</span>
<a href="#l19.22"></a><span id="l19.22">  * Alerts the user that they are trying to create a tag with a name that</span>
<a href="#l19.23"></a><span id="l19.23">  * already exists.</span>
<a href="#l19.24"></a><span id="l19.24">  */</span>
<a href="#l19.25"></a><span id="l19.25"> function alertForExistingTag()</span>
<a href="#l19.26"></a><span id="l19.26"> {</span>
<a href="#l19.27"></a><span id="l19.27">   var messengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l19.28"></a><span id="l19.28">   var alertText = messengerBundle.getString(&quot;tagExists&quot;);</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineminus">-  var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineminus">-                                .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-  promptService.alert(window, document.title, alertText);</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+  Services.prompt.alert(window, document.title, alertText);</span>
<a href="#l19.33"></a><span id="l19.33"> }</span>
<a href="#l19.34"></a><span id="l19.34"> </span>
<a href="#l19.35"></a><span id="l19.35"> function doEnabling()</span>
<a href="#l19.36"></a><span id="l19.36"> {</span>
<a href="#l19.37"></a><span id="l19.37">   dialog.OKButton.disabled = !dialog.nameField.value;</span>
<a href="#l19.38"></a><span id="l19.38"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mail/base/content/newmailalert.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mail/base/content/newmailalert.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -1,12 +1,14 @@</span>
<a href="#l20.4"></a><span id="l20.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.5"></a><span id="l20.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.6"></a><span id="l20.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.7"></a><span id="l20.7"> </span>
<a href="#l20.8"></a><span id="l20.8" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l20.9"></a><span id="l20.9" class="difflineplus">+</span>
<a href="#l20.10"></a><span id="l20.10"> const HORIZONTAL = 1;</span>
<a href="#l20.11"></a><span id="l20.11"> const LEFT = 2;</span>
<a href="#l20.12"></a><span id="l20.12"> const TOP = 4;</span>
<a href="#l20.13"></a><span id="l20.13"> </span>
<a href="#l20.14"></a><span id="l20.14"> var gSlideTime = 50;</span>
<a href="#l20.15"></a><span id="l20.15"> var gNumNewMsgsToShowInAlert = 4; // the more messages we show in the alert, the larger it will be</span>
<a href="#l20.16"></a><span id="l20.16"> var gOpenTime = 3000; // total time the alert should stay up once we are done animating.</span>
<a href="#l20.17"></a><span id="l20.17"> var gAlertListener = null;</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineat">@@ -90,19 +92,18 @@ urlListener.prototype = {</span>
<a href="#l20.19"></a><span id="l20.19"> }</span>
<a href="#l20.20"></a><span id="l20.20"> </span>
<a href="#l20.21"></a><span id="l20.21"> function onAlertLoad()</span>
<a href="#l20.22"></a><span id="l20.22"> {</span>
<a href="#l20.23"></a><span id="l20.23">   prefillAlertInfo();</span>
<a href="#l20.24"></a><span id="l20.24">   // read out our initial settings from prefs.</span>
<a href="#l20.25"></a><span id="l20.25">   try </span>
<a href="#l20.26"></a><span id="l20.26">   {</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineminus">-    var prefBranch = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;].getService(Components.interfaces.nsIPrefService).getBranch(null);</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineminus">-    gSlideTime = prefBranch.getIntPref(&quot;alerts.slideIncrementTime&quot;);</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineminus">-    gOpenTime = prefBranch.getIntPref(&quot;alerts.totalOpenTime&quot;);</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineplus">+    gSlideTime = Services.prefs.getIntPref(&quot;alerts.slideIncrementTime&quot;);</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+    gOpenTime = Services.prefs.getIntPref(&quot;alerts.totalOpenTime&quot;);</span>
<a href="#l20.32"></a><span id="l20.32">   } catch (ex) {}</span>
<a href="#l20.33"></a><span id="l20.33">   </span>
<a href="#l20.34"></a><span id="l20.34">   // bogus call to make sure the window is moved offscreen until we are ready for it.</span>
<a href="#l20.35"></a><span id="l20.35">   resizeAlert(true);</span>
<a href="#l20.36"></a><span id="l20.36"> </span>
<a href="#l20.37"></a><span id="l20.37">   // if we aren't waiting to fetch preview text, then go ahead and </span>
<a href="#l20.38"></a><span id="l20.38">   // start showing the alert.</span>
<a href="#l20.39"></a><span id="l20.39">   if (!gPendingPreviewFetchRequests)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mail/base/content/nsContextMenu.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mail/base/content/nsContextMenu.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -1,14 +1,15 @@</span>
<a href="#l21.4"></a><span id="l21.4"> /** ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l21.5"></a><span id="l21.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l21.6"></a><span id="l21.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l21.7"></a><span id="l21.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l21.8"></a><span id="l21.8"> </span>
<a href="#l21.9"></a><span id="l21.9"> Components.utils.import(&quot;resource://gre/modules/InlineSpellChecker.jsm&quot;);</span>
<a href="#l21.10"></a><span id="l21.10" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l21.11"></a><span id="l21.11"> Components.utils.import(&quot;resource:///modules/MailUtils.js&quot;);</span>
<a href="#l21.12"></a><span id="l21.12"> </span>
<a href="#l21.13"></a><span id="l21.13"> XPCOMUtils.defineLazyGetter(this, &quot;PageMenu&quot;, function() {</span>
<a href="#l21.14"></a><span id="l21.14">   let tmp = {};</span>
<a href="#l21.15"></a><span id="l21.15">   Cu.import(&quot;resource://gre/modules/PageMenu.jsm&quot;, tmp);</span>
<a href="#l21.16"></a><span id="l21.16">   return new tmp.PageMenu();</span>
<a href="#l21.17"></a><span id="l21.17"> });</span>
<a href="#l21.18"></a><span id="l21.18"> </span>
<a href="#l21.19"></a><span id="l21.19" class="difflineat">@@ -570,20 +571,18 @@ nsContextMenu.prototype = {</span>
<a href="#l21.20"></a><span id="l21.20">    * may be saved according to the ScriptSecurityManager.</span>
<a href="#l21.21"></a><span id="l21.21">    * @return true if the protocol can be persisted and if the target has</span>
<a href="#l21.22"></a><span id="l21.22">    *         permission to link to the URL, false if not</span>
<a href="#l21.23"></a><span id="l21.23">    */</span>
<a href="#l21.24"></a><span id="l21.24">   isLinkSaveable : function CM_isLinkSaveable() {</span>
<a href="#l21.25"></a><span id="l21.25">     try {</span>
<a href="#l21.26"></a><span id="l21.26">       const nsIScriptSecurityManager =</span>
<a href="#l21.27"></a><span id="l21.27">         Components.interfaces.nsIScriptSecurityManager;</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineminus">-      var secMan = Components.classes[&quot;@mozilla.org/scriptsecuritymanager;1&quot;]</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineminus">-                             .getService(nsIScriptSecurityManager);</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineminus">-      secMan.checkLoadURIWithPrincipal(this.target.nodePrincipal, this.linkURI,</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-                                       nsIScriptSecurityManager.STANDARD);</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+      Services.scriptSecurityManager.checkLoadURIWithPrincipal(this.target.nodePrincipal,</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineplus">+          this.linkURI, nsIScriptSecurityManager.STANDARD);</span>
<a href="#l21.34"></a><span id="l21.34">     } catch (e) {</span>
<a href="#l21.35"></a><span id="l21.35">       // Don't save things we can't link to.</span>
<a href="#l21.36"></a><span id="l21.36">       return false;</span>
<a href="#l21.37"></a><span id="l21.37">     }</span>
<a href="#l21.38"></a><span id="l21.38"> </span>
<a href="#l21.39"></a><span id="l21.39">     // We don't do the Right Thing for news/snews yet, so turn them off</span>
<a href="#l21.40"></a><span id="l21.40">     // until we do.</span>
<a href="#l21.41"></a><span id="l21.41">     return this.linkProtocol &amp;&amp; !(</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineat">@@ -733,20 +732,18 @@ nsContextMenu.prototype = {</span>
<a href="#l21.43"></a><span id="l21.43">     return href;</span>
<a href="#l21.44"></a><span id="l21.44">   },</span>
<a href="#l21.45"></a><span id="l21.45"> </span>
<a href="#l21.46"></a><span id="l21.46">   /**</span>
<a href="#l21.47"></a><span id="l21.47">    * Generate a URI object from the linkURL spec</span>
<a href="#l21.48"></a><span id="l21.48">    * @return an nsIURI if possible, or null if not</span>
<a href="#l21.49"></a><span id="l21.49">    */</span>
<a href="#l21.50"></a><span id="l21.50">   getLinkURI: function CM_getLinkURI() {</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineminus">-    var ioService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineminus">-                              .getService(Components.interfaces.nsIIOService);</span>
<a href="#l21.53"></a><span id="l21.53">     try {</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineminus">-      return ioService.newURI(this.linkURL, null, null);</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineplus">+      return Services.io.newURI(this.linkURL, null, null);</span>
<a href="#l21.56"></a><span id="l21.56">     } catch (ex) {</span>
<a href="#l21.57"></a><span id="l21.57">       // e.g. empty URL string</span>
<a href="#l21.58"></a><span id="l21.58">     }</span>
<a href="#l21.59"></a><span id="l21.59">     return null;</span>
<a href="#l21.60"></a><span id="l21.60">   },</span>
<a href="#l21.61"></a><span id="l21.61"> </span>
<a href="#l21.62"></a><span id="l21.62">   /**</span>
<a href="#l21.63"></a><span id="l21.63">    * Get the scheme for the clicked-on linkURI, if present.</span>
<a href="#l21.64"></a><span id="l21.64" class="difflineat">@@ -815,21 +812,19 @@ nsContextMenu.prototype = {</span>
<a href="#l21.65"></a><span id="l21.65">    * @param  aBase</span>
<a href="#l21.66"></a><span id="l21.66">    *         The URL string to use as the base</span>
<a href="#l21.67"></a><span id="l21.67">    * @param  aUrl</span>
<a href="#l21.68"></a><span id="l21.68">    *         The possibly-relative URL string</span>
<a href="#l21.69"></a><span id="l21.69">    * @return The string absolute URL</span>
<a href="#l21.70"></a><span id="l21.70">    */</span>
<a href="#l21.71"></a><span id="l21.71">   makeURLAbsolute : function CM_makeURLAbsolute(aBase, aUrl) {</span>
<a href="#l21.72"></a><span id="l21.72">     // Construct nsIURL.</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineminus">-    var ioService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineminus">-                              .getService(Components.interfaces.nsIIOService);</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineminus">-    var baseURI  = ioService.newURI(aBase, null, null);</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineplus">+    var baseURI  = Services.io.newURI(aBase, null, null);</span>
<a href="#l21.77"></a><span id="l21.77"> </span>
<a href="#l21.78"></a><span id="l21.78" class="difflineminus">-    return ioService.newURI(baseURI.resolve(aUrl), null, null).spec;</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineplus">+    return Services.io.newURI(baseURI.resolve(aUrl), null, null).spec;</span>
<a href="#l21.80"></a><span id="l21.80">   },</span>
<a href="#l21.81"></a><span id="l21.81"> </span>
<a href="#l21.82"></a><span id="l21.82">   /**</span>
<a href="#l21.83"></a><span id="l21.83">    * Determine whether a DOM node is a text or password input, or a textarea.</span>
<a href="#l21.84"></a><span id="l21.84">    * @param  aNode</span>
<a href="#l21.85"></a><span id="l21.85">    *         The DOM node to check</span>
<a href="#l21.86"></a><span id="l21.86">    * @return true for textboxes, false for other elements</span>
<a href="#l21.87"></a><span id="l21.87">    */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mail/base/content/phishingDetector.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mail/base/content/phishingDetector.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -1,16 +1,17 @@</span>
<a href="#l22.4"></a><span id="l22.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l22.5"></a><span id="l22.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l22.6"></a><span id="l22.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l22.7"></a><span id="l22.7"> </span>
<a href="#l22.8"></a><span id="l22.8"> // Dependencies:</span>
<a href="#l22.9"></a><span id="l22.9" class="difflineminus">-// gPrefBranch should already be defined</span>
<a href="#l22.10"></a><span id="l22.10"> // gatherTextUnder from utilityOverlay.js</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+</span>
<a href="#l22.14"></a><span id="l22.14"> const kPhishingNotSuspicious = 0;</span>
<a href="#l22.15"></a><span id="l22.15"> const kPhishingWithIPAddress = 1;</span>
<a href="#l22.16"></a><span id="l22.16"> const kPhishingWithMismatchedHosts = 2;</span>
<a href="#l22.17"></a><span id="l22.17"> </span>
<a href="#l22.18"></a><span id="l22.18"> var gPhishingDetector = {</span>
<a href="#l22.19"></a><span id="l22.19">   mCheckForIPAddresses: true,</span>
<a href="#l22.20"></a><span id="l22.20">   mCheckForMismatchedHosts: true,</span>
<a href="#l22.21"></a><span id="l22.21">   mPhishingWarden: null,</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineat">@@ -43,33 +44,33 @@ var gPhishingDetector = {</span>
<a href="#l22.23"></a><span id="l22.23">       // from the provider (need to workout protocol details)</span>
<a href="#l22.24"></a><span id="l22.24">       this.mPhishingWarden.registerWhiteTable(&quot;goog-white-exp&quot;);</span>
<a href="#l22.25"></a><span id="l22.25">       this.mPhishingWarden.registerBlackTable(&quot;goog-phish-sha128&quot;);</span>
<a href="#l22.26"></a><span id="l22.26"> </span>
<a href="#l22.27"></a><span id="l22.27">       // Download/update lists if we're in non-enhanced mode</span>
<a href="#l22.28"></a><span id="l22.28">       this.mPhishingWarden.maybeToggleUpdateChecking();  </span>
<a href="#l22.29"></a><span id="l22.29">     } catch (ex) { dump('unable to create the phishing warden: ' + ex + '\n');}</span>
<a href="#l22.30"></a><span id="l22.30"> </span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-    this.mCheckForIPAddresses = gPrefBranch.getBoolPref(&quot;mail.phishing.detection.ipaddresses&quot;);</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-    this.mCheckForMismatchedHosts = gPrefBranch.getBoolPref(&quot;mail.phishing.detection.mismatched_hosts&quot;);</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineplus">+    this.mCheckForIPAddresses = Services.prefs.getBoolPref(&quot;mail.phishing.detection.ipaddresses&quot;);</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+    this.mCheckForMismatchedHosts = Services.prefs.getBoolPref(&quot;mail.phishing.detection.mismatched_hosts&quot;);</span>
<a href="#l22.35"></a><span id="l22.35">   },</span>
<a href="#l22.36"></a><span id="l22.36"> </span>
<a href="#l22.37"></a><span id="l22.37">   /**</span>
<a href="#l22.38"></a><span id="l22.38">    * Analyzes the urls contained in the currently loaded message in the message pane, looking for</span>
<a href="#l22.39"></a><span id="l22.39">    * phishing URLs.</span>
<a href="#l22.40"></a><span id="l22.40">    * Assumes the message has finished loading in the message pane (i.e. OnMsgParsed has fired).</span>
<a href="#l22.41"></a><span id="l22.41">    * </span>
<a href="#l22.42"></a><span id="l22.42">    * @param aUrl nsIURI for the message being analyzed.</span>
<a href="#l22.43"></a><span id="l22.43">    *</span>
<a href="#l22.44"></a><span id="l22.44">    * @return asynchronously calls gMessageNotificationBar.setPhishingMsg if the message</span>
<a href="#l22.45"></a><span id="l22.45">    *         is identified as a scam.         </span>
<a href="#l22.46"></a><span id="l22.46">    */</span>
<a href="#l22.47"></a><span id="l22.47">   analyzeMsgForPhishingURLs: function (aUrl)</span>
<a href="#l22.48"></a><span id="l22.48">   {</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineminus">-    if (!aUrl || !gPrefBranch.getBoolPref(&quot;mail.phishing.detection.enabled&quot;))</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineplus">+    if (!aUrl || !Services.prefs.getBoolPref(&quot;mail.phishing.detection.enabled&quot;))</span>
<a href="#l22.51"></a><span id="l22.51">       return;</span>
<a href="#l22.52"></a><span id="l22.52"> </span>
<a href="#l22.53"></a><span id="l22.53">     try {</span>
<a href="#l22.54"></a><span id="l22.54">       // nsIMsgMailNewsUrl.folder can throw an NS_ERROR_FAILURE, especially if</span>
<a href="#l22.55"></a><span id="l22.55">       // we are opening an .eml file.</span>
<a href="#l22.56"></a><span id="l22.56">       var folder = aUrl.folder;</span>
<a href="#l22.57"></a><span id="l22.57"> </span>
<a href="#l22.58"></a><span id="l22.58">       // Ignore nntp and RSS messages.</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineat">@@ -111,21 +112,20 @@ var gPhishingDetector = {</span>
<a href="#l22.60"></a><span id="l22.60">    * @return asynchronously calls gMessageNotificationBar.setPhishingMsg if the link node</span>
<a href="#l22.61"></a><span id="l22.61">    *         contains a phishing URL.</span>
<a href="#l22.62"></a><span id="l22.62">    */</span>
<a href="#l22.63"></a><span id="l22.63">   analyzeUrl: function (aUrl, aLinkText)</span>
<a href="#l22.64"></a><span id="l22.64">   {</span>
<a href="#l22.65"></a><span id="l22.65">     if (!aUrl)</span>
<a href="#l22.66"></a><span id="l22.66">       return;</span>
<a href="#l22.67"></a><span id="l22.67"> </span>
<a href="#l22.68"></a><span id="l22.68" class="difflineminus">-    var ioService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;].getService(Components.interfaces.nsIIOService);</span>
<a href="#l22.69"></a><span id="l22.69">     var hrefURL;</span>
<a href="#l22.70"></a><span id="l22.70">     // make sure relative link urls don't make us bail out</span>
<a href="#l22.71"></a><span id="l22.71">     try {</span>
<a href="#l22.72"></a><span id="l22.72" class="difflineminus">-      hrefURL = ioService.newURI(aUrl, null, null);</span>
<a href="#l22.73"></a><span id="l22.73" class="difflineplus">+      hrefURL = Services.io.newURI(aUrl, null, null);</span>
<a href="#l22.74"></a><span id="l22.74">     } catch(ex) { return; }</span>
<a href="#l22.75"></a><span id="l22.75"> </span>
<a href="#l22.76"></a><span id="l22.76">     // only check for phishing urls if the url is an http or https link.</span>
<a href="#l22.77"></a><span id="l22.77">     // this prevents us from flagging imap and other internally handled urls</span>
<a href="#l22.78"></a><span id="l22.78">     if (hrefURL.schemeIs('http') || hrefURL.schemeIs('https'))</span>
<a href="#l22.79"></a><span id="l22.79">     {</span>
<a href="#l22.80"></a><span id="l22.80">       var linkTextURL = {};</span>
<a href="#l22.81"></a><span id="l22.81"> </span>
<a href="#l22.82"></a><span id="l22.82" class="difflineat">@@ -195,19 +195,17 @@ var gPhishingDetector = {</span>
<a href="#l22.83"></a><span id="l22.83">      var appContext = Components.classes[&quot;@mozilla.org/phishingprotection/application;1&quot;]</span>
<a href="#l22.84"></a><span id="l22.84">                        .getService().wrappedJSObject;</span>
<a href="#l22.85"></a><span id="l22.85">      var reportUrl = appContext.getReportPhishingURL();</span>
<a href="#l22.86"></a><span id="l22.86">      if (reportUrl)</span>
<a href="#l22.87"></a><span id="l22.87">      {</span>
<a href="#l22.88"></a><span id="l22.88">        reportUrl += &quot;&amp;url=&quot; + encodeURIComponent(aPhishingURL);</span>
<a href="#l22.89"></a><span id="l22.89">        // now send the url to the default browser</span>
<a href="#l22.90"></a><span id="l22.90"> </span>
<a href="#l22.91"></a><span id="l22.91" class="difflineminus">-       var ioService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l22.92"></a><span id="l22.92" class="difflineminus">-                       .getService(Components.interfaces.nsIIOService);</span>
<a href="#l22.93"></a><span id="l22.93" class="difflineminus">-       var uri = ioService.newURI(reportUrl, null, null);</span>
<a href="#l22.94"></a><span id="l22.94" class="difflineplus">+       var uri = Services.io.newURI(reportUrl, null, null);</span>
<a href="#l22.95"></a><span id="l22.95">        var protocolSvc = Components.classes[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;]</span>
<a href="#l22.96"></a><span id="l22.96">                          .getService(Components.interfaces.nsIExternalProtocolService);</span>
<a href="#l22.97"></a><span id="l22.97">        protocolSvc.loadUrl(uri);</span>
<a href="#l22.98"></a><span id="l22.98">      }</span>
<a href="#l22.99"></a><span id="l22.99">    },   </span>
<a href="#l22.100"></a><span id="l22.100"> </span>
<a href="#l22.101"></a><span id="l22.101">   /**</span>
<a href="#l22.102"></a><span id="l22.102">    * Private helper method to determine if the link node contains a user visible</span>
<a href="#l22.103"></a><span id="l22.103" class="difflineat">@@ -224,18 +222,17 @@ var gPhishingDetector = {</span>
<a href="#l22.104"></a><span id="l22.104">     aLinkNodeText = aLinkNodeText.replace(/ /g, &quot;&quot;);</span>
<a href="#l22.105"></a><span id="l22.105"> </span>
<a href="#l22.106"></a><span id="l22.106">     // only worry about http and https urls</span>
<a href="#l22.107"></a><span id="l22.107">     if (aLinkNodeText)</span>
<a href="#l22.108"></a><span id="l22.108">     {</span>
<a href="#l22.109"></a><span id="l22.109">       // does the link text look like a http url?</span>
<a href="#l22.110"></a><span id="l22.110">        if (aLinkNodeText.search(/(^http:|^https:)/) != -1)</span>
<a href="#l22.111"></a><span id="l22.111">        {</span>
<a href="#l22.112"></a><span id="l22.112" class="difflineminus">-         var ioService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;].getService(Components.interfaces.nsIIOService);</span>
<a href="#l22.113"></a><span id="l22.113" class="difflineminus">-         aLinkTextURL.value = ioService.newURI(aLinkNodeText, null, null);</span>
<a href="#l22.114"></a><span id="l22.114" class="difflineplus">+         aLinkTextURL.value = Services.io.newURI(aLinkNodeText, null, null);</span>
<a href="#l22.115"></a><span id="l22.115">          // compare hosts, but ignore possible www. prefix</span>
<a href="#l22.116"></a><span id="l22.116">          return !(aHrefURL.host.replace(/^www\./, &quot;&quot;) == aLinkTextURL.value.host.replace(/^www\./, &quot;&quot;));</span>
<a href="#l22.117"></a><span id="l22.117">        }</span>
<a href="#l22.118"></a><span id="l22.118">     }</span>
<a href="#l22.119"></a><span id="l22.119"> </span>
<a href="#l22.120"></a><span id="l22.120">     return false;</span>
<a href="#l22.121"></a><span id="l22.121">   },</span>
<a href="#l22.122"></a><span id="l22.122"> </span>
<a href="#l22.123"></a><span id="l22.123" class="difflineat">@@ -248,22 +245,20 @@ var gPhishingDetector = {</span>
<a href="#l22.124"></a><span id="l22.124">    * @return true if the link should be allowed to load</span>
<a href="#l22.125"></a><span id="l22.125">    */</span>
<a href="#l22.126"></a><span id="l22.126">   warnOnSuspiciousLinkClick: function(aUrl)</span>
<a href="#l22.127"></a><span id="l22.127">   {</span>
<a href="#l22.128"></a><span id="l22.128">     // if the loaded message has been flagged as a phishing scam, </span>
<a href="#l22.129"></a><span id="l22.129">     if (!gMessageNotificationBar.isFlagSet(kMsgNotificationPhishingBar))</span>
<a href="#l22.130"></a><span id="l22.130">       return true;</span>
<a href="#l22.131"></a><span id="l22.131"> </span>
<a href="#l22.132"></a><span id="l22.132" class="difflineminus">-    var ioService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l22.133"></a><span id="l22.133" class="difflineminus">-                      .getService(Components.interfaces.nsIIOService);</span>
<a href="#l22.134"></a><span id="l22.134">     var hrefURL;</span>
<a href="#l22.135"></a><span id="l22.135">     // make sure relative link urls don't make us bail out</span>
<a href="#l22.136"></a><span id="l22.136">     try {</span>
<a href="#l22.137"></a><span id="l22.137" class="difflineminus">-      hrefURL = ioService.newURI(aUrl, null, null);</span>
<a href="#l22.138"></a><span id="l22.138" class="difflineplus">+      hrefURL = Services.io.newURI(aUrl, null, null);</span>
<a href="#l22.139"></a><span id="l22.139">     } catch(ex) { return false; }</span>
<a href="#l22.140"></a><span id="l22.140"> </span>
<a href="#l22.141"></a><span id="l22.141">     // only prompt for http and https urls</span>
<a href="#l22.142"></a><span id="l22.142">     if (hrefURL.schemeIs('http') || hrefURL.schemeIs('https'))</span>
<a href="#l22.143"></a><span id="l22.143">     {</span>
<a href="#l22.144"></a><span id="l22.144">       // unobscure the host name in case it's an encoded ip address..</span>
<a href="#l22.145"></a><span id="l22.145">       let unobscuredHostNameValue = this.isLegalIPAddress(hrefURL.host, true)</span>
<a href="#l22.146"></a><span id="l22.146">         || hrefURL.host;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mail/base/content/plugins.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mail/base/content/plugins.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -1,16 +1,18 @@</span>
<a href="#l23.4"></a><span id="l23.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l23.5"></a><span id="l23.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l23.6"></a><span id="l23.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l23.7"></a><span id="l23.7"> </span>
<a href="#l23.8"></a><span id="l23.8"> /* A note to the curious: a large portion of this code was copied over from</span>
<a href="#l23.9"></a><span id="l23.9">  * mozilla/browser/base/content/browser.js</span>
<a href="#l23.10"></a><span id="l23.10">  */</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+</span>
<a href="#l23.14"></a><span id="l23.14"> #ifdef MOZ_CRASHREPORTER</span>
<a href="#l23.15"></a><span id="l23.15"> XPCOMUtils.defineLazyServiceGetter(this, &quot;gCrashReporter&quot;,</span>
<a href="#l23.16"></a><span id="l23.16">                                    &quot;@mozilla.org/xre/app-info;1&quot;,</span>
<a href="#l23.17"></a><span id="l23.17">                                    &quot;nsICrashReporter&quot;);</span>
<a href="#l23.18"></a><span id="l23.18"> #endif</span>
<a href="#l23.19"></a><span id="l23.19"> </span>
<a href="#l23.20"></a><span id="l23.20"> function getPluginInfo(pluginElement)</span>
<a href="#l23.21"></a><span id="l23.21"> {</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineat">@@ -347,18 +349,19 @@ var gPluginHandler = {</span>
<a href="#l23.23"></a><span id="l23.23">       let cancelQuit = Cc[&quot;@mozilla.org/supports-PRBool;1&quot;].</span>
<a href="#l23.24"></a><span id="l23.24">                          createInstance(Ci.nsISupportsPRBool);</span>
<a href="#l23.25"></a><span id="l23.25">       Services.obs.notifyObservers(cancelQuit, &quot;quit-application-requested&quot;, null);</span>
<a href="#l23.26"></a><span id="l23.26"> </span>
<a href="#l23.27"></a><span id="l23.27">       // Something aborted the quit process.</span>
<a href="#l23.28"></a><span id="l23.28">       if (cancelQuit.data)</span>
<a href="#l23.29"></a><span id="l23.29">         return;</span>
<a href="#l23.30"></a><span id="l23.30"> </span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">-      let as = Cc[&quot;@mozilla.org/toolkit/app-startup;1&quot;].getService(Ci.nsIAppStartup);</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineminus">-      as.quit(Ci.nsIAppStartup.eRestarti386 | Ci.nsIAppStartup.eRestart | Ci.nsIAppStartup.eAttemptQuit);</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineplus">+      Services.startup.quit(Ci.nsIAppStartup.eRestarti386 |</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineplus">+                            Ci.nsIAppStartup.eRestart |</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineplus">+                            Ci.nsIAppStartup.eAttemptQuit);</span>
<a href="#l23.36"></a><span id="l23.36">     }</span>
<a href="#l23.37"></a><span id="l23.37"> #endif</span>
<a href="#l23.38"></a><span id="l23.38"> </span>
<a href="#l23.39"></a><span id="l23.39">     let messengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l23.40"></a><span id="l23.40"> </span>
<a href="#l23.41"></a><span id="l23.41">     let notifications = {</span>
<a href="#l23.42"></a><span id="l23.42">       PluginBlocklisted : {</span>
<a href="#l23.43"></a><span id="l23.43">         barID: &quot;blocked-plugins&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mail/base/content/safeMode.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mail/base/content/safeMode.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -1,27 +1,22 @@</span>
<a href="#l24.4"></a><span id="l24.4"> /* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l24.5"></a><span id="l24.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l24.6"></a><span id="l24.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l24.7"></a><span id="l24.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l24.8"></a><span id="l24.8"> </span>
<a href="#l24.9"></a><span id="l24.9"> Components.utils.import(&quot;resource://gre/modules/AddonManager.jsm&quot;);</span>
<a href="#l24.10"></a><span id="l24.10" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12"> function restartApp() {</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-  var appStartup = Components.classes[&quot;@mozilla.org/toolkit/app-startup;1&quot;]</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineminus">-                             .getService(Components.interfaces.nsIAppStartup);</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineminus">-  appStartup.quit(appStartup.eForceQuit | appStartup.eRestart);</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineplus">+  Services.startup.quit(Services.startup.eForceQuit | Services.startup.eRestart);</span>
<a href="#l24.17"></a><span id="l24.17"> }</span>
<a href="#l24.18"></a><span id="l24.18"> </span>
<a href="#l24.19"></a><span id="l24.19"> function deleteLocalstore() {</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineminus">-  const nsIDirectoryServiceContractID = &quot;@mozilla.org/file/directory_service;1&quot;;</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineminus">-  const nsIProperties = Components.interfaces.nsIProperties;</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineminus">-  var directoryService =  Components.classes[nsIDirectoryServiceContractID]</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineminus">-                                    .getService(nsIProperties);</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineminus">-  var localstoreFile = directoryService.get(&quot;LStoreS&quot;, Components.interfaces.nsIFile);</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineplus">+  var localstoreFile = Services.dirsvc.get(&quot;LStoreS&quot;, Components.interfaces.nsIFile);</span>
<a href="#l24.26"></a><span id="l24.26">   if (localstoreFile.exists())</span>
<a href="#l24.27"></a><span id="l24.27">     localstoreFile.remove(false);</span>
<a href="#l24.28"></a><span id="l24.28"> }</span>
<a href="#l24.29"></a><span id="l24.29"> </span>
<a href="#l24.30"></a><span id="l24.30"> function disableAddons() {</span>
<a href="#l24.31"></a><span id="l24.31">   AddonManager.getAllAddons(function(aAddons) {</span>
<a href="#l24.32"></a><span id="l24.32">     aAddons.forEach(function(aAddon) {</span>
<a href="#l24.33"></a><span id="l24.33">       if (aAddon.type == &quot;theme&quot;) {</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineat">@@ -53,19 +48,17 @@ function onOK() {</span>
<a href="#l24.35"></a><span id="l24.35">   } catch(e) {</span>
<a href="#l24.36"></a><span id="l24.36">   }</span>
<a href="#l24.37"></a><span id="l24.37"> </span>
<a href="#l24.38"></a><span id="l24.38">   restartApp();</span>
<a href="#l24.39"></a><span id="l24.39">   return false;</span>
<a href="#l24.40"></a><span id="l24.40"> }</span>
<a href="#l24.41"></a><span id="l24.41"> </span>
<a href="#l24.42"></a><span id="l24.42"> function onCancel() {</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineminus">-  var appStartup = Components.classes[&quot;@mozilla.org/toolkit/app-startup;1&quot;]</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineminus">-                             .getService(Components.interfaces.nsIAppStartup);</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineminus">-  appStartup.quit(appStartup.eForceQuit);</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineplus">+  Services.startup.quit(Services.startup.eForceQuit);</span>
<a href="#l24.47"></a><span id="l24.47"> }</span>
<a href="#l24.48"></a><span id="l24.48"> </span>
<a href="#l24.49"></a><span id="l24.49"> function onLoad() {</span>
<a href="#l24.50"></a><span id="l24.50">   document.getElementById(&quot;tasks&quot;)</span>
<a href="#l24.51"></a><span id="l24.51">           .addEventListener(&quot;CheckboxStateChange&quot;, updateOKButtonState, false);</span>
<a href="#l24.52"></a><span id="l24.52"> }</span>
<a href="#l24.53"></a><span id="l24.53"> </span>
<a href="#l24.54"></a><span id="l24.54"> function updateOKButtonState() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mail/base/content/search.xml</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mail/base/content/search.xml</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -53,73 +53,69 @@</span>
<a href="#l25.4"></a><span id="l25.4">     &lt;/handlers&gt;</span>
<a href="#l25.5"></a><span id="l25.5"> </span>
<a href="#l25.6"></a><span id="l25.6">     &lt;implementation implements=&quot;nsIObserver&quot;&gt;</span>
<a href="#l25.7"></a><span id="l25.7">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l25.8"></a><span id="l25.8">         const Cc = Components.classes;</span>
<a href="#l25.9"></a><span id="l25.9">         const Ci = Components.interfaces;</span>
<a href="#l25.10"></a><span id="l25.10">         const Cu = Components.utils;</span>
<a href="#l25.11"></a><span id="l25.11">         Cu.import(&quot;resource:///modules/errUtils.js&quot;);</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineplus">+        Cu.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+</span>
<a href="#l25.14"></a><span id="l25.14">         try {</span>
<a href="#l25.15"></a><span id="l25.15">           this.setAttribute(</span>
<a href="#l25.16"></a><span id="l25.16">             &quot;placeholder&quot;,</span>
<a href="#l25.17"></a><span id="l25.17">             this.getAttribute(&quot;emptytextbase&quot;)</span>
<a href="#l25.18"></a><span id="l25.18">                  .replace(&quot;#1&quot;, this.getAttribute(</span>
<a href="#l25.19"></a><span id="l25.19">                                   Application.platformIsMac ?</span>
<a href="#l25.20"></a><span id="l25.20">                                   &quot;keyLabelMac&quot; : &quot;keyLabelNonMac&quot;)));</span>
<a href="#l25.21"></a><span id="l25.21"> </span>
<a href="#l25.22"></a><span id="l25.22" class="difflineminus">-          var prefBranch =</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineminus">-              Components.classes['@mozilla.org/preferences-service;1'].</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineminus">-              getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineminus">-          prefBranch.addObserver(&quot;mailnews.database.global.indexer.enabled&quot;,</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineminus">-                                 this._prefObserver, false);</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineplus">+          Services.prefs.addObserver(&quot;mailnews.database.global.indexer.enabled&quot;,</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineplus">+                                     this._prefObserver, false);</span>
<a href="#l25.29"></a><span id="l25.29"> </span>
<a href="#l25.30"></a><span id="l25.30">           this.glodaCompleter =</span>
<a href="#l25.31"></a><span id="l25.31">             Components.classes[&quot;@mozilla.org/autocomplete/search;1?name=gloda&quot;]</span>
<a href="#l25.32"></a><span id="l25.32">                       .getService()</span>
<a href="#l25.33"></a><span id="l25.33">                       .wrappedJSObject;</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineminus">-          var observerSvc = Cc[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineminus">-                            .getService(Ci.nsIObserverService);</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineminus">-          observerSvc.addObserver(this, &quot;autocomplete-did-enter-text&quot;, false);</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineplus">+          Services.obs.addObserver(this, &quot;autocomplete-did-enter-text&quot;, false);</span>
<a href="#l25.38"></a><span id="l25.38"> </span>
<a href="#l25.39"></a><span id="l25.39">           this.glodaEnabled =</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineminus">-            prefBranch.getBoolPref(&quot;mailnews.database.global.indexer.enabled&quot;);</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineplus">+            Services.prefs.getBoolPref(&quot;mailnews.database.global.indexer.enabled&quot;);</span>
<a href="#l25.42"></a><span id="l25.42">           this.collapsed = !this.glodaEnabled;</span>
<a href="#l25.43"></a><span id="l25.43"> </span>
<a href="#l25.44"></a><span id="l25.44">           // make sure we set our emptytext here from the get-go</span>
<a href="#l25.45"></a><span id="l25.45">         if (this.hasAttribute(&quot;placeholder&quot;))</span>
<a href="#l25.46"></a><span id="l25.46">           this.placeholder = this.getAttribute(&quot;placeholder&quot;);</span>
<a href="#l25.47"></a><span id="l25.47">         } catch (e) {</span>
<a href="#l25.48"></a><span id="l25.48">           logException(e, true);</span>
<a href="#l25.49"></a><span id="l25.49">         }</span>
<a href="#l25.50"></a><span id="l25.50">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l25.51"></a><span id="l25.51"> </span>
<a href="#l25.52"></a><span id="l25.52">       &lt;destructor&gt;</span>
<a href="#l25.53"></a><span id="l25.53">         &lt;![CDATA[</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineminus">-          var prefBranch =</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineminus">-              Components.classes['@mozilla.org/preferences-service;1'].</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineminus">-              getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineminus">-          prefBranch.removeObserver(&quot;mailnews.database.global.indexer.enabled&quot;,</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineminus">-                                    this._prefObserver);</span>
<a href="#l25.59"></a><span id="l25.59" class="difflineminus">-          var observerSvc = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l25.60"></a><span id="l25.60" class="difflineminus">-                            .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineminus">-          observerSvc.removeObserver(this, &quot;autocomplete-did-enter-text&quot;);</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l25.63"></a><span id="l25.63" class="difflineplus">+</span>
<a href="#l25.64"></a><span id="l25.64" class="difflineplus">+          Services.prefs.removeObserver(&quot;mailnews.database.global.indexer.enabled&quot;,</span>
<a href="#l25.65"></a><span id="l25.65" class="difflineplus">+                                        this._prefObserver);</span>
<a href="#l25.66"></a><span id="l25.66" class="difflineplus">+          Services.obs.removeObserver(this, &quot;autocomplete-did-enter-text&quot;);</span>
<a href="#l25.67"></a><span id="l25.67">         ]]&gt;</span>
<a href="#l25.68"></a><span id="l25.68">       &lt;/destructor&gt;</span>
<a href="#l25.69"></a><span id="l25.69"> </span>
<a href="#l25.70"></a><span id="l25.70">       &lt;field name=&quot;_prefObserver&quot;&gt;({</span>
<a href="#l25.71"></a><span id="l25.71">         inputSearch: this,</span>
<a href="#l25.72"></a><span id="l25.72">         observe: function(subject, topic, data)</span>
<a href="#l25.73"></a><span id="l25.73">         {</span>
<a href="#l25.74"></a><span id="l25.74" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l25.75"></a><span id="l25.75" class="difflineplus">+</span>
<a href="#l25.76"></a><span id="l25.76">           if (topic == &quot;nsPref:changed&quot;) {</span>
<a href="#l25.77"></a><span id="l25.77">             subject.QueryInterface(Components.interfaces.nsIPrefBranch);</span>
<a href="#l25.78"></a><span id="l25.78">             switch (data) {</span>
<a href="#l25.79"></a><span id="l25.79">             case &quot;mailnews.database.global.indexer.enabled&quot;:</span>
<a href="#l25.80"></a><span id="l25.80">               this.inputSearch.glodaEnabled =</span>
<a href="#l25.81"></a><span id="l25.81" class="difflineminus">-                gPrefBranch.getBoolPref(</span>
<a href="#l25.82"></a><span id="l25.82" class="difflineplus">+                Services.prefs.getBoolPref(</span>
<a href="#l25.83"></a><span id="l25.83">                   &quot;mailnews.database.global.indexer.enabled&quot;);</span>
<a href="#l25.84"></a><span id="l25.84">               this.inputSearch.collapsed = !this.inputSearch.glodaEnabled;</span>
<a href="#l25.85"></a><span id="l25.85">               break;</span>
<a href="#l25.86"></a><span id="l25.86">             }</span>
<a href="#l25.87"></a><span id="l25.87">           }</span>
<a href="#l25.88"></a><span id="l25.88">         },</span>
<a href="#l25.89"></a><span id="l25.89"> </span>
<a href="#l25.90"></a><span id="l25.90">         QueryInterface: function(aIID)</span>
<a href="#l25.91"></a><span id="l25.91" class="difflineat">@@ -219,16 +215,18 @@</span>
<a href="#l25.92"></a><span id="l25.92">         } catch (e) {</span>
<a href="#l25.93"></a><span id="l25.93">           logException(e);</span>
<a href="#l25.94"></a><span id="l25.94">         }</span>
<a href="#l25.95"></a><span id="l25.95">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.96"></a><span id="l25.96">       &lt;/method&gt;</span>
<a href="#l25.97"></a><span id="l25.97"> </span>
<a href="#l25.98"></a><span id="l25.98">       &lt;method name=&quot;doSearch&quot;&gt;</span>
<a href="#l25.99"></a><span id="l25.99">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.100"></a><span id="l25.100" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l25.101"></a><span id="l25.101" class="difflineplus">+</span>
<a href="#l25.102"></a><span id="l25.102">           try {</span>
<a href="#l25.103"></a><span id="l25.103">             if (this.value) {</span>
<a href="#l25.104"></a><span id="l25.104">               let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l25.105"></a><span id="l25.105">               // If the current tab is a gloda search tab, reset the value</span>
<a href="#l25.106"></a><span id="l25.106">               //  to the initial search value.  Otherwise, clear it.  This</span>
<a href="#l25.107"></a><span id="l25.107">               //  is the value that 3is going to be saved with the current</span>
<a href="#l25.108"></a><span id="l25.108">               //  tab when we switch back to it next.</span>
<a href="#l25.109"></a><span id="l25.109">               let searchString = this.value;</span>
<a href="#l25.110"></a><span id="l25.110" class="difflineat">@@ -239,20 +237,17 @@</span>
<a href="#l25.111"></a><span id="l25.111">                 // bit hard right now, so doing the cheap thing and closing</span>
<a href="#l25.112"></a><span id="l25.112">                 // this tab and starting over</span>
<a href="#l25.113"></a><span id="l25.113">                 tabmail.closeTab();</span>
<a href="#l25.114"></a><span id="l25.114">               }</span>
<a href="#l25.115"></a><span id="l25.115">               this.value = ''; // clear our value, to avoid persistence</span>
<a href="#l25.116"></a><span id="l25.116">               let args = {</span>
<a href="#l25.117"></a><span id="l25.117">                 searcher: new GlodaMsgSearcher(null, searchString)</span>
<a href="#l25.118"></a><span id="l25.118">               };</span>
<a href="#l25.119"></a><span id="l25.119" class="difflineminus">-              let prefBranch =</span>
<a href="#l25.120"></a><span id="l25.120" class="difflineminus">-                Components.classes['@mozilla.org/preferences-service;1'].</span>
<a href="#l25.121"></a><span id="l25.121" class="difflineminus">-                getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l25.122"></a><span id="l25.122" class="difflineminus">-              if (prefBranch.getBoolPref(&quot;mail.chat.enabled&quot;)) {</span>
<a href="#l25.123"></a><span id="l25.123" class="difflineplus">+              if (Services.prefs.getBoolPref(&quot;mail.chat.enabled&quot;)) {</span>
<a href="#l25.124"></a><span id="l25.124">                 if (!(&quot;GlodaIMSearcher&quot; in window))</span>
<a href="#l25.125"></a><span id="l25.125">                   Cu.import(&quot;resource:///modules/search_im.js&quot;);</span>
<a href="#l25.126"></a><span id="l25.126">                 args.IMSearcher = new GlodaIMSearcher(null, searchString);</span>
<a href="#l25.127"></a><span id="l25.127">               }</span>
<a href="#l25.128"></a><span id="l25.128">               tabmail.openTab(&quot;glodaFacet&quot;, args);</span>
<a href="#l25.129"></a><span id="l25.129">             }</span>
<a href="#l25.130"></a><span id="l25.130">           } catch (e) {</span>
<a href="#l25.131"></a><span id="l25.131">             logException(e);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mail/base/content/specialTabs.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mail/base/content/specialTabs.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -190,22 +190,19 @@ const DOMLinkHandler = {</span>
<a href="#l26.4"></a><span id="l26.4">         /^about:blocked\?/,</span>
<a href="#l26.5"></a><span id="l26.5">         /^about:certerror\?/,</span>
<a href="#l26.6"></a><span id="l26.6">         /^about:home$/</span>
<a href="#l26.7"></a><span id="l26.7">       ].some(function (re) { re.test(targetDoc.documentURI); });</span>
<a href="#l26.8"></a><span id="l26.8"> </span>
<a href="#l26.9"></a><span id="l26.9">       if (!isAllowedPage || !uri.schemeIs(&quot;chrome&quot;)) {</span>
<a href="#l26.10"></a><span id="l26.10">         // Be extra paraniod and just make sure we're not going to load</span>
<a href="#l26.11"></a><span id="l26.11">         // something we shouldn't. Firefox does this, so we're doing the same.</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-        let ssm = Components.classes[&quot;@mozilla.org/scriptsecuritymanager;1&quot;]</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-          .getService(Components.interfaces.nsIScriptSecurityManager);</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineminus">-</span>
<a href="#l26.15"></a><span id="l26.15">           try {</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineminus">-            ssm.checkLoadURIWithPrincipal(targetDoc.nodePrincipal, uri,</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineminus">-                                          Components.interfaces.nsIScriptSecurityManager.DISALLOW_SCRIPT);</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineplus">+            Services.scriptSecurityManager.checkLoadURIWithPrincipal(targetDoc.nodePrincipal, uri,</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineplus">+                                           Components.interfaces.nsIScriptSecurityManager.DISALLOW_SCRIPT);</span>
<a href="#l26.20"></a><span id="l26.20">           }</span>
<a href="#l26.21"></a><span id="l26.21">           catch (ex) {</span>
<a href="#l26.22"></a><span id="l26.22">             return;</span>
<a href="#l26.23"></a><span id="l26.23">           }</span>
<a href="#l26.24"></a><span id="l26.24">       }</span>
<a href="#l26.25"></a><span id="l26.25"> </span>
<a href="#l26.26"></a><span id="l26.26">       const nsIContentPolicy = Components.interfaces.nsIContentPolicy;</span>
<a href="#l26.27"></a><span id="l26.27"> </span>
<a href="#l26.28"></a><span id="l26.28" class="difflineat">@@ -485,25 +482,22 @@ var specialTabs = {</span>
<a href="#l26.29"></a><span id="l26.29">     } catch(ex) {</span>
<a href="#l26.30"></a><span id="l26.30">       Components.utils.reportError(&quot;Places database may be locked: &quot; + ex);</span>
<a href="#l26.31"></a><span id="l26.31">     }</span>
<a href="#l26.32"></a><span id="l26.32"> </span>
<a href="#l26.33"></a><span id="l26.33">     Services.obs.addObserver(specialTabs, &quot;mail-startup-done&quot;, false);</span>
<a href="#l26.34"></a><span id="l26.34"> </span>
<a href="#l26.35"></a><span id="l26.35">     let tabmail = document.getElementById('tabmail');</span>
<a href="#l26.36"></a><span id="l26.36"> </span>
<a href="#l26.37"></a><span id="l26.37" class="difflineminus">-    var prefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineminus">-                          .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l26.39"></a><span id="l26.39" class="difflineminus">-</span>
<a href="#l26.40"></a><span id="l26.40">     tabmail.registerTabType(this.contentTabType);</span>
<a href="#l26.41"></a><span id="l26.41">     tabmail.registerTabType(this.chromeTabType);</span>
<a href="#l26.42"></a><span id="l26.42"> </span>
<a href="#l26.43"></a><span id="l26.43">     // If we've upgraded (note: always get these values so that we set</span>
<a href="#l26.44"></a><span id="l26.44">     // the mstone preference for the new version):</span>
<a href="#l26.45"></a><span id="l26.45" class="difflineminus">-    let [fromVer, toVer] = this.getApplicationUpgradeVersions(prefs);</span>
<a href="#l26.46"></a><span id="l26.46" class="difflineplus">+    let [fromVer, toVer] = this.getApplicationUpgradeVersions();</span>
<a href="#l26.47"></a><span id="l26.47"> </span>
<a href="#l26.48"></a><span id="l26.48">     // Although this might not be really necessary because of the version checks, we'll</span>
<a href="#l26.49"></a><span id="l26.49">     // check this pref anyway and clear it so that we are consistent with what Firefox</span>
<a href="#l26.50"></a><span id="l26.50">     // actually does. It will help developers switching between branches without updating.</span>
<a href="#l26.51"></a><span id="l26.51">     if (Services.prefs.prefHasUserValue(&quot;app.update.postupdate&quot;)) {</span>
<a href="#l26.52"></a><span id="l26.52">       // Only show what's new tab if this is actually an upgraded version,</span>
<a href="#l26.53"></a><span id="l26.53">       // not just a new installation/profile (and don't show if the major version</span>
<a href="#l26.54"></a><span id="l26.54">       // hasn't changed).</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineat">@@ -511,20 +505,20 @@ var specialTabs = {</span>
<a href="#l26.56"></a><span id="l26.56">           // showWhatsNewPage checks the details of the update manager before</span>
<a href="#l26.57"></a><span id="l26.57">           // showing the page.</span>
<a href="#l26.58"></a><span id="l26.58">           this.showWhatsNewPage();</span>
<a href="#l26.59"></a><span id="l26.59">       }</span>
<a href="#l26.60"></a><span id="l26.60">       Services.prefs.clearUserPref(&quot;app.update.postupdate&quot;);</span>
<a href="#l26.61"></a><span id="l26.61">     }</span>
<a href="#l26.62"></a><span id="l26.62"> </span>
<a href="#l26.63"></a><span id="l26.63">     // Show the about rights notification if we need to.</span>
<a href="#l26.64"></a><span id="l26.64" class="difflineminus">-    if (this.shouldShowAboutRightsNotification(prefs))</span>
<a href="#l26.65"></a><span id="l26.65" class="difflineminus">-      this.showAboutRightsNotification(prefs);</span>
<a href="#l26.66"></a><span id="l26.66" class="difflineminus">-    else if (this.shouldShowTelemetryNotification(prefs))</span>
<a href="#l26.67"></a><span id="l26.67" class="difflineminus">-      this.showTelemetryNotification(prefs);</span>
<a href="#l26.68"></a><span id="l26.68" class="difflineplus">+    if (this.shouldShowAboutRightsNotification())</span>
<a href="#l26.69"></a><span id="l26.69" class="difflineplus">+      this.showAboutRightsNotification();</span>
<a href="#l26.70"></a><span id="l26.70" class="difflineplus">+    else if (this.shouldShowTelemetryNotification())</span>
<a href="#l26.71"></a><span id="l26.71" class="difflineplus">+      this.showTelemetryNotification();</span>
<a href="#l26.72"></a><span id="l26.72">   },</span>
<a href="#l26.73"></a><span id="l26.73"> </span>
<a href="#l26.74"></a><span id="l26.74">   /**</span>
<a href="#l26.75"></a><span id="l26.75">    * A tab to show content pages.</span>
<a href="#l26.76"></a><span id="l26.76">    */</span>
<a href="#l26.77"></a><span id="l26.77">   contentTabType: {</span>
<a href="#l26.78"></a><span id="l26.78">     __proto__: contentTabBaseType,</span>
<a href="#l26.79"></a><span id="l26.79">     name: &quot;contentTab&quot;,</span>
<a href="#l26.80"></a><span id="l26.80" class="difflineat">@@ -689,31 +683,31 @@ var specialTabs = {</span>
<a href="#l26.81"></a><span id="l26.81">   },</span>
<a href="#l26.82"></a><span id="l26.82"> </span>
<a href="#l26.83"></a><span id="l26.83">   /**</span>
<a href="#l26.84"></a><span id="l26.84">    * In the case of an upgrade, returns the version we're upgrading</span>
<a href="#l26.85"></a><span id="l26.85">    * from, as well as the current version.  In the case of a fresh profile,</span>
<a href="#l26.86"></a><span id="l26.86">    * or the pref being set to ignore - return null and the current version.</span>
<a href="#l26.87"></a><span id="l26.87">    * In either case, updates the pref with the latest version.</span>
<a href="#l26.88"></a><span id="l26.88">    */</span>
<a href="#l26.89"></a><span id="l26.89" class="difflineminus">-  getApplicationUpgradeVersions: function(prefs) {</span>
<a href="#l26.90"></a><span id="l26.90" class="difflineplus">+  getApplicationUpgradeVersions: function() {</span>
<a href="#l26.91"></a><span id="l26.91">     let savedAppVersion = null;</span>
<a href="#l26.92"></a><span id="l26.92">     let prefstring = &quot;mailnews.start_page_override.mstone&quot;;</span>
<a href="#l26.93"></a><span id="l26.93"> </span>
<a href="#l26.94"></a><span id="l26.94">     try {</span>
<a href="#l26.95"></a><span id="l26.95" class="difflineminus">-      savedAppVersion = prefs.getCharPref(prefstring);</span>
<a href="#l26.96"></a><span id="l26.96" class="difflineplus">+      savedAppVersion = Services.prefs.getCharPref(prefstring);</span>
<a href="#l26.97"></a><span id="l26.97">     } catch (ex) {}</span>
<a href="#l26.98"></a><span id="l26.98"> </span>
<a href="#l26.99"></a><span id="l26.99">     let currentApplicationVersion = Application.version;</span>
<a href="#l26.100"></a><span id="l26.100"> </span>
<a href="#l26.101"></a><span id="l26.101">     if (savedAppVersion == &quot;ignore&quot;)</span>
<a href="#l26.102"></a><span id="l26.102">       return [null, this.splitVersion(currentApplicationVersion)];</span>
<a href="#l26.103"></a><span id="l26.103"> </span>
<a href="#l26.104"></a><span id="l26.104">     if (savedAppVersion != currentApplicationVersion)</span>
<a href="#l26.105"></a><span id="l26.105" class="difflineminus">-      prefs.setCharPref(prefstring, currentApplicationVersion);</span>
<a href="#l26.106"></a><span id="l26.106" class="difflineplus">+      Services.prefs.setCharPref(prefstring, currentApplicationVersion);</span>
<a href="#l26.107"></a><span id="l26.107"> </span>
<a href="#l26.108"></a><span id="l26.108">     return [this.splitVersion(savedAppVersion), this.splitVersion(currentApplicationVersion)];</span>
<a href="#l26.109"></a><span id="l26.109">   },</span>
<a href="#l26.110"></a><span id="l26.110"> </span>
<a href="#l26.111"></a><span id="l26.111">   /**</span>
<a href="#l26.112"></a><span id="l26.112">    * Shows the what's new page in a content tab.</span>
<a href="#l26.113"></a><span id="l26.113">    */</span>
<a href="#l26.114"></a><span id="l26.114">   showWhatsNewPage: function onShowWhatsNewPage() {</span>
<a href="#l26.115"></a><span id="l26.115" class="difflineat">@@ -737,56 +731,57 @@ var specialTabs = {</span>
<a href="#l26.116"></a><span id="l26.116">   },</span>
<a href="#l26.117"></a><span id="l26.117"> </span>
<a href="#l26.118"></a><span id="l26.118">   /**</span>
<a href="#l26.119"></a><span id="l26.119">    * Looks at the existing prefs and determines if we should suggest the user</span>
<a href="#l26.120"></a><span id="l26.120">    * enables telemetry or not.</span>
<a href="#l26.121"></a><span id="l26.121">    *</span>
<a href="#l26.122"></a><span id="l26.122">    * This is controlled by the pref toolkit.telemetry.prompted</span>
<a href="#l26.123"></a><span id="l26.123">    */</span>
<a href="#l26.124"></a><span id="l26.124" class="difflineminus">-  shouldShowTelemetryNotification: function(prefs) {</span>
<a href="#l26.125"></a><span id="l26.125" class="difflineplus">+  shouldShowTelemetryNotification: function() {</span>
<a href="#l26.126"></a><span id="l26.126">     // toolkit has decided that the pref should have no default value</span>
<a href="#l26.127"></a><span id="l26.127">     try {</span>
<a href="#l26.128"></a><span id="l26.128" class="difflineminus">-      if (prefs.getBoolPref(kTelemetryPrompted) || prefs.getBoolPref(kTelemetryEnabled))</span>
<a href="#l26.129"></a><span id="l26.129" class="difflineplus">+      if (Services.prefs.getBoolPref(kTelemetryPrompted) ||</span>
<a href="#l26.130"></a><span id="l26.130" class="difflineplus">+          Services.prefs.getBoolPref(kTelemetryEnabled))</span>
<a href="#l26.131"></a><span id="l26.131">         return false;</span>
<a href="#l26.132"></a><span id="l26.132">     } catch (e) { }</span>
<a href="#l26.133"></a><span id="l26.133">     return true;</span>
<a href="#l26.134"></a><span id="l26.134">   },</span>
<a href="#l26.135"></a><span id="l26.135"> </span>
<a href="#l26.136"></a><span id="l26.136" class="difflineminus">-  showTelemetryNotification: function(prefs) {</span>
<a href="#l26.137"></a><span id="l26.137" class="difflineplus">+  showTelemetryNotification: function() {</span>
<a href="#l26.138"></a><span id="l26.138">     var notifyBox = document.getElementById(&quot;mail-notification-box&quot;);</span>
<a href="#l26.139"></a><span id="l26.139"> </span>
<a href="#l26.140"></a><span id="l26.140">     var brandBundle =</span>
<a href="#l26.141"></a><span id="l26.141">       new StringBundle(&quot;chrome://branding/locale/brand.properties&quot;);</span>
<a href="#l26.142"></a><span id="l26.142">     var telemetryBundle =</span>
<a href="#l26.143"></a><span id="l26.143">       new StringBundle(&quot;chrome://messenger/locale/telemetry.properties&quot;);</span>
<a href="#l26.144"></a><span id="l26.144"> </span>
<a href="#l26.145"></a><span id="l26.145">     var productName = brandBundle.get(&quot;brandFullName&quot;);</span>
<a href="#l26.146"></a><span id="l26.146" class="difflineminus">-    var serverOwner = prefs.getCharPref(kTelemetryServerOwner);</span>
<a href="#l26.147"></a><span id="l26.147" class="difflineplus">+    var serverOwner = Services.prefs.getCharPref(kTelemetryServerOwner);</span>
<a href="#l26.148"></a><span id="l26.148">     var telemetryText = telemetryBundle.get(&quot;telemetryText&quot;, [productName, serverOwner]);</span>
<a href="#l26.149"></a><span id="l26.149"> </span>
<a href="#l26.150"></a><span id="l26.150">     var buttons = [</span>
<a href="#l26.151"></a><span id="l26.151">       {</span>
<a href="#l26.152"></a><span id="l26.152">         label:     telemetryBundle.get(&quot;telemetryYesButtonLabel&quot;),</span>
<a href="#l26.153"></a><span id="l26.153">         accessKey: telemetryBundle.get(&quot;telemetryYesButtonAccessKey&quot;),</span>
<a href="#l26.154"></a><span id="l26.154">         popup:     null,</span>
<a href="#l26.155"></a><span id="l26.155">         callback:  function(aNotificationBar, aButton) {</span>
<a href="#l26.156"></a><span id="l26.156" class="difflineminus">-          prefs.setBoolPref(kTelemetryEnabled, true);</span>
<a href="#l26.157"></a><span id="l26.157" class="difflineplus">+          Services.prefs.setBoolPref(kTelemetryEnabled, true);</span>
<a href="#l26.158"></a><span id="l26.158">         }</span>
<a href="#l26.159"></a><span id="l26.159">       },</span>
<a href="#l26.160"></a><span id="l26.160">       {</span>
<a href="#l26.161"></a><span id="l26.161">         label:     telemetryBundle.get(&quot;telemetryNoButtonLabel&quot;),</span>
<a href="#l26.162"></a><span id="l26.162">         accessKey: telemetryBundle.get(&quot;telemetryNoButtonAccessKey&quot;),</span>
<a href="#l26.163"></a><span id="l26.163">         popup:     null,</span>
<a href="#l26.164"></a><span id="l26.164">         callback:  function(aNotificationBar, aButton) {}</span>
<a href="#l26.165"></a><span id="l26.165">       }</span>
<a href="#l26.166"></a><span id="l26.166">     ];</span>
<a href="#l26.167"></a><span id="l26.167"> </span>
<a href="#l26.168"></a><span id="l26.168">     // Set pref to indicate we've shown the notification.</span>
<a href="#l26.169"></a><span id="l26.169" class="difflineminus">-    prefs.setBoolPref(kTelemetryPrompted, true);</span>
<a href="#l26.170"></a><span id="l26.170" class="difflineplus">+    Services.prefs.setBoolPref(kTelemetryPrompted, true);</span>
<a href="#l26.171"></a><span id="l26.171"> </span>
<a href="#l26.172"></a><span id="l26.172">     var notification = notifyBox.appendNotification(telemetryText, &quot;telemetry&quot;, null, notifyBox.PRIORITY_INFO_LOW, buttons);</span>
<a href="#l26.173"></a><span id="l26.173">     notification.persistence = 3; // arbitrary number, just so bar sticks around for a bit</span>
<a href="#l26.174"></a><span id="l26.174"> </span>
<a href="#l26.175"></a><span id="l26.175">     let XULNS = &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;;</span>
<a href="#l26.176"></a><span id="l26.176">     let link = notification.ownerDocument.createElementNS(XULNS, &quot;label&quot;);</span>
<a href="#l26.177"></a><span id="l26.177">     link.className = &quot;text-link telemetry-text-link&quot;;</span>
<a href="#l26.178"></a><span id="l26.178">     link.setAttribute(&quot;value&quot;, telemetryBundle.get(&quot;telemetryLinkLabel&quot;));</span>
<a href="#l26.179"></a><span id="l26.179" class="difflineat">@@ -813,34 +808,31 @@ var specialTabs = {</span>
<a href="#l26.180"></a><span id="l26.180">    *     If this pref is set to true, never show the about:rights notification.</span>
<a href="#l26.181"></a><span id="l26.181">    *     If the pref doesn't exist, then we fallback to checking</span>
<a href="#l26.182"></a><span id="l26.182">    *     mail.rights.version.</span>
<a href="#l26.183"></a><span id="l26.183">    *</span>
<a href="#l26.184"></a><span id="l26.184">    *   mail.rights.version</span>
<a href="#l26.185"></a><span id="l26.185">    *     If this pref isn't set or the value is less than the current version</span>
<a href="#l26.186"></a><span id="l26.186">    *     then we show the about:rights notification.</span>
<a href="#l26.187"></a><span id="l26.187">    */</span>
<a href="#l26.188"></a><span id="l26.188" class="difflineminus">-  shouldShowAboutRightsNotification: function(prefs) {</span>
<a href="#l26.189"></a><span id="l26.189" class="difflineplus">+  shouldShowAboutRightsNotification: function() {</span>
<a href="#l26.190"></a><span id="l26.190">     try {</span>
<a href="#l26.191"></a><span id="l26.191" class="difflineminus">-      return !prefs.getBoolPref(&quot;mail.rights.override&quot;);</span>
<a href="#l26.192"></a><span id="l26.192" class="difflineplus">+      return !Services.prefs.getBoolPref(&quot;mail.rights.override&quot;);</span>
<a href="#l26.193"></a><span id="l26.193">     } catch (e) { }</span>
<a href="#l26.194"></a><span id="l26.194"> </span>
<a href="#l26.195"></a><span id="l26.195" class="difflineminus">-    return prefs.getIntPref(&quot;mail.rights.version&quot;) &lt; this._kAboutRightsVersion;</span>
<a href="#l26.196"></a><span id="l26.196" class="difflineplus">+    return Services.prefs.getIntPref(&quot;mail.rights.version&quot;) &lt; this._kAboutRightsVersion;</span>
<a href="#l26.197"></a><span id="l26.197">   },</span>
<a href="#l26.198"></a><span id="l26.198"> </span>
<a href="#l26.199"></a><span id="l26.199" class="difflineminus">-  showAboutRightsNotification: function(prefs) {</span>
<a href="#l26.200"></a><span id="l26.200" class="difflineplus">+  showAboutRightsNotification: function() {</span>
<a href="#l26.201"></a><span id="l26.201">     var notifyBox = document.getElementById(&quot;mail-notification-box&quot;);</span>
<a href="#l26.202"></a><span id="l26.202"> </span>
<a href="#l26.203"></a><span id="l26.203" class="difflineminus">-    var stringBundle =</span>
<a href="#l26.204"></a><span id="l26.204" class="difflineminus">-      Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l26.205"></a><span id="l26.205" class="difflineminus">-                .getService(Components.interfaces.nsIStringBundleService);</span>
<a href="#l26.206"></a><span id="l26.206">     var brandBundle =</span>
<a href="#l26.207"></a><span id="l26.207" class="difflineminus">-      stringBundle.createBundle(&quot;chrome://branding/locale/brand.properties&quot;);</span>
<a href="#l26.208"></a><span id="l26.208" class="difflineplus">+      Services.strings.createBundle(&quot;chrome://branding/locale/brand.properties&quot;);</span>
<a href="#l26.209"></a><span id="l26.209">     var rightsBundle =</span>
<a href="#l26.210"></a><span id="l26.210" class="difflineminus">-      stringBundle.createBundle(&quot;chrome://messenger/locale/aboutRights.properties&quot;);</span>
<a href="#l26.211"></a><span id="l26.211" class="difflineplus">+      Services.strings.createBundle(&quot;chrome://messenger/locale/aboutRights.properties&quot;);</span>
<a href="#l26.212"></a><span id="l26.212"> </span>
<a href="#l26.213"></a><span id="l26.213">     var productName = brandBundle.GetStringFromName(&quot;brandFullName&quot;);</span>
<a href="#l26.214"></a><span id="l26.214">     var notifyRightsText = rightsBundle.formatStringFromName(&quot;notifyRightsText&quot;,</span>
<a href="#l26.215"></a><span id="l26.215">                                                              [productName], 1);</span>
<a href="#l26.216"></a><span id="l26.216"> </span>
<a href="#l26.217"></a><span id="l26.217">     var buttons = [</span>
<a href="#l26.218"></a><span id="l26.218">       {</span>
<a href="#l26.219"></a><span id="l26.219">         label: rightsBundle.GetStringFromName(&quot;buttonLabel&quot;),</span>
<a href="#l26.220"></a><span id="l26.220" class="difflineat">@@ -857,17 +849,17 @@ var specialTabs = {</span>
<a href="#l26.221"></a><span id="l26.221"> </span>
<a href="#l26.222"></a><span id="l26.222">     var box = notifyBox.appendNotification(notifyRightsText, &quot;about-rights&quot;,</span>
<a href="#l26.223"></a><span id="l26.223">                                            null, notifyBox.PRIORITY_INFO_LOW,</span>
<a href="#l26.224"></a><span id="l26.224">                                            buttons);</span>
<a href="#l26.225"></a><span id="l26.225">     // arbitrary number, just so bar sticks around for a bit</span>
<a href="#l26.226"></a><span id="l26.226">     box.persistence = 3;</span>
<a href="#l26.227"></a><span id="l26.227"> </span>
<a href="#l26.228"></a><span id="l26.228">     // Set the pref to say we've displayed the notification.</span>
<a href="#l26.229"></a><span id="l26.229" class="difflineminus">-    prefs.setIntPref(&quot;mail.rights.version&quot;, this._kAboutRightsVersion);</span>
<a href="#l26.230"></a><span id="l26.230" class="difflineplus">+    Services.prefs.setIntPref(&quot;mail.rights.version&quot;, this._kAboutRightsVersion);</span>
<a href="#l26.231"></a><span id="l26.231">   },</span>
<a href="#l26.232"></a><span id="l26.232"> </span>
<a href="#l26.233"></a><span id="l26.233">   /**</span>
<a href="#l26.234"></a><span id="l26.234">    * Handles links when displaying about: pages. Anything that is an about:</span>
<a href="#l26.235"></a><span id="l26.235">    * link can be loaded internally, other links are redirected to an external</span>
<a href="#l26.236"></a><span id="l26.236">    * browser.</span>
<a href="#l26.237"></a><span id="l26.237">    */</span>
<a href="#l26.238"></a><span id="l26.238">   aboutClickHandler: function aboutClickHandler(aEvent) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mail/base/content/tabmail.xml</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mail/base/content/tabmail.xml</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -33,61 +33,61 @@</span>
<a href="#l27.4"></a><span id="l27.4">     - From a javascript perspective, there are three types of code that we</span>
<a href="#l27.5"></a><span id="l27.5">     -  expect to interact with:</span>
<a href="#l27.6"></a><span id="l27.6">     - 1) Code that wants to open new tabs.</span>
<a href="#l27.7"></a><span id="l27.7">     - 2) Code that wants to contribute one or more varieties of tabs.</span>
<a href="#l27.8"></a><span id="l27.8">     - 3) Code that wants to monitor to know when the active tab changes.</span>
<a href="#l27.9"></a><span id="l27.9">     -</span>
<a href="#l27.10"></a><span id="l27.10">     - Consumer code should use the following methods:</span>
<a href="#l27.11"></a><span id="l27.11">     - * openTab(aTabModeName, aArgs)</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-    -     Open a tab of the given &quot;mode&quot;, passing the provided arguments as an </span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-    -     object. The tab type author should tell you the modes they implement </span>
<a href="#l27.14"></a><span id="l27.14" class="difflineplus">+    -     Open a tab of the given &quot;mode&quot;, passing the provided arguments as an</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineplus">+    -     object. The tab type author should tell you the modes they implement</span>
<a href="#l27.16"></a><span id="l27.16">     -     and the required/optional arguments.</span>
<a href="#l27.17"></a><span id="l27.17">     -</span>
<a href="#l27.18"></a><span id="l27.18">     -     Each tab type can define the set of arguments that it expects, but</span>
<a href="#l27.19"></a><span id="l27.19">     -     there are also a few common ones that all should obey, including:</span>
<a href="#l27.20"></a><span id="l27.20">     -</span>
<a href="#l27.21"></a><span id="l27.21">     -     * &quot;background&quot;: if this is true, the tab will be loaded in the</span>
<a href="#l27.22"></a><span id="l27.22">     -       background.</span>
<a href="#l27.23"></a><span id="l27.23">     -     * &quot;disregardOpener&quot;: if this is true, then the tab opener will not</span>
<a href="#l27.24"></a><span id="l27.24">     -       be switched to automatically by tabmail if the new tab is immediately</span>
<a href="#l27.25"></a><span id="l27.25">     -       closed.</span>
<a href="#l27.26"></a><span id="l27.26">     -</span>
<a href="#l27.27"></a><span id="l27.27" class="difflineminus">-    - * closeTab(aOptionalTabIndexInfoOrTabNode,aNoUndo): </span>
<a href="#l27.28"></a><span id="l27.28" class="difflineminus">-    -     If no argument is provided, the current tab is closed. The first </span>
<a href="#l27.29"></a><span id="l27.29" class="difflineplus">+    - * closeTab(aOptionalTabIndexInfoOrTabNode,aNoUndo):</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineplus">+    -     If no argument is provided, the current tab is closed. The first</span>
<a href="#l27.31"></a><span id="l27.31">     -     argument specifies a specific tab to be closed. It can be a tab index,</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineminus">-    -     a tab info object, or a tab's DOM element. In case the second </span>
<a href="#l27.33"></a><span id="l27.33" class="difflineplus">+    -     a tab info object, or a tab's DOM element. In case the second</span>
<a href="#l27.34"></a><span id="l27.34">     -     argument is true, the closed tab can't be restored by calling</span>
<a href="#l27.35"></a><span id="l27.35" class="difflineminus">-    -     undoCloseTab(). </span>
<a href="#l27.36"></a><span id="l27.36" class="difflineminus">-    -     Please note, some tabs cannot be closed. Trying to close such tab, </span>
<a href="#l27.37"></a><span id="l27.37" class="difflineplus">+    -     undoCloseTab().</span>
<a href="#l27.38"></a><span id="l27.38" class="difflineplus">+    -     Please note, some tabs cannot be closed. Trying to close such tab,</span>
<a href="#l27.39"></a><span id="l27.39">     -     willd fail silently.</span>
<a href="#l27.40"></a><span id="l27.40" class="difflineminus">-    - * undoCloseTab(): </span>
<a href="#l27.41"></a><span id="l27.41" class="difflineminus">-    -     Restores the most recent tab closed by the user. </span>
<a href="#l27.42"></a><span id="l27.42" class="difflineminus">-    - * switchToTab(aTabIndexInfoOrTabNode): </span>
<a href="#l27.43"></a><span id="l27.43" class="difflineminus">-    -     Switch to the tab by providing a tab index, tab info object, or tab </span>
<a href="#l27.44"></a><span id="l27.44" class="difflineminus">-    -     node (tabmail-tab bound element.) You can also just poke at </span>
<a href="#l27.45"></a><span id="l27.45" class="difflineplus">+    - * undoCloseTab():</span>
<a href="#l27.46"></a><span id="l27.46" class="difflineplus">+    -     Restores the most recent tab closed by the user.</span>
<a href="#l27.47"></a><span id="l27.47" class="difflineplus">+    - * switchToTab(aTabIndexInfoOrTabNode):</span>
<a href="#l27.48"></a><span id="l27.48" class="difflineplus">+    -     Switch to the tab by providing a tab index, tab info object, or tab</span>
<a href="#l27.49"></a><span id="l27.49" class="difflineplus">+    -     node (tabmail-tab bound element.) You can also just poke at</span>
<a href="#l27.50"></a><span id="l27.50">     -     tabmail.tabContainer and its selectedIndex and selectedItem</span>
<a href="#l27.51"></a><span id="l27.51">     -     properties.</span>
<a href="#l27.52"></a><span id="l27.52">     - * setTabIcon(aTabNodeorInfo, aIcon): Sets the tab icon to the specified</span>
<a href="#l27.53"></a><span id="l27.53">     -     url or removes the icon if no url is specified. Note that this may</span>
<a href="#l27.54"></a><span id="l27.54">     -     overrride css provided images.</span>
<a href="#l27.55"></a><span id="l27.55">     - * replaceTabWithWindow(aTab):</span>
<a href="#l27.56"></a><span id="l27.56" class="difflineminus">-    -     Detaches a tab from this tabbar to new window. The argument &quot;aTab&quot; is </span>
<a href="#l27.57"></a><span id="l27.57" class="difflineminus">-    -     required and can be a tab index, a tab info object or a tabs's </span>
<a href="#l27.58"></a><span id="l27.58" class="difflineplus">+    -     Detaches a tab from this tabbar to new window. The argument &quot;aTab&quot; is</span>
<a href="#l27.59"></a><span id="l27.59" class="difflineplus">+    -     required and can be a tab index, a tab info object or a tabs's</span>
<a href="#l27.60"></a><span id="l27.60">     -     DOM element. Calling this method works only for tabs implementing</span>
<a href="#l27.61"></a><span id="l27.61">     -     session restore.</span>
<a href="#l27.62"></a><span id="l27.62">     - * moveTabTo(aTab,aIndex):</span>
<a href="#l27.63"></a><span id="l27.63">     -     moves the given tab to the given Index. The first argument can be</span>
<a href="#l27.64"></a><span id="l27.64">     -     a tab index, a tab info object or a tab's DOM element. The second</span>
<a href="#l27.65"></a><span id="l27.65">     -     argument specifies the tabs new absolute position within the tabbar.</span>
<a href="#l27.66"></a><span id="l27.66" class="difflineminus">-    - </span>
<a href="#l27.67"></a><span id="l27.67" class="difflineplus">+    -</span>
<a href="#l27.68"></a><span id="l27.68">     - Less-friendly consumer methods:</span>
<a href="#l27.69"></a><span id="l27.69">     - * persistTab(tab):</span>
<a href="#l27.70"></a><span id="l27.70" class="difflineminus">-    -     serializes a tab into an object, by passing  a tab info object as </span>
<a href="#l27.71"></a><span id="l27.71" class="difflineminus">-    -     argument. It is used for session restore and moving tabs between </span>
<a href="#l27.72"></a><span id="l27.72" class="difflineplus">+    -     serializes a tab into an object, by passing  a tab info object as</span>
<a href="#l27.73"></a><span id="l27.73" class="difflineplus">+    -     argument. It is used for session restore and moving tabs between</span>
<a href="#l27.74"></a><span id="l27.74">     -     windows. Returns null in case persist failes.</span>
<a href="#l27.75"></a><span id="l27.75">     - * removeCurrentTab():</span>
<a href="#l27.76"></a><span id="l27.76">     -     Close the current tab.</span>
<a href="#l27.77"></a><span id="l27.77">     - * removeTabByNode(aTabElement):</span>
<a href="#l27.78"></a><span id="l27.78">     -     Close the tab whose tabmail-tab bound element is passed in.</span>
<a href="#l27.79"></a><span id="l27.79">     - Changing the currently displayed tab is accomplished by changing</span>
<a href="#l27.80"></a><span id="l27.80">     -  tabmail.tabContainer's selectedIndex or selectedItem property.</span>
<a href="#l27.81"></a><span id="l27.81">     -</span>
<a href="#l27.82"></a><span id="l27.82" class="difflineat">@@ -137,17 +137,17 @@</span>
<a href="#l27.83"></a><span id="l27.83">     - * modes: An object whose attributes are mode names (which are</span>
<a href="#l27.84"></a><span id="l27.84">     -     automatically propagated to a 'name' attribute for debugging) and</span>
<a href="#l27.85"></a><span id="l27.85">     -     values are objects with the following attributes...</span>
<a href="#l27.86"></a><span id="l27.86">     - * any of the openTab/closeTab/saveTabState/showTab/onTitleChanged</span>
<a href="#l27.87"></a><span id="l27.87">     -     functions as described on the mode definitions.  These will only be</span>
<a href="#l27.88"></a><span id="l27.88">     -     called if the mode does not provide the functions.  Note that because</span>
<a href="#l27.89"></a><span id="l27.89">     -     the 'this' variable passed to the functions will always reference the</span>
<a href="#l27.90"></a><span id="l27.90">     -     tab type definition (rather than the mode definition), the mode</span>
<a href="#l27.91"></a><span id="l27.91" class="difflineminus">-    -     functions can defer to the tab type functions by calling </span>
<a href="#l27.92"></a><span id="l27.92" class="difflineplus">+    -     functions can defer to the tab type functions by calling</span>
<a href="#l27.93"></a><span id="l27.93">     -     this.functionName().  (This should prove convenient.)</span>
<a href="#l27.94"></a><span id="l27.94">     - Mode definition attributes:</span>
<a href="#l27.95"></a><span id="l27.95">     - * type: The &quot;type&quot; attribute to set on the displayed tab for CSS purposes.</span>
<a href="#l27.96"></a><span id="l27.96">     -     Generally, this would be the same as the mode name, but you can do as</span>
<a href="#l27.97"></a><span id="l27.97">     -     you please.</span>
<a href="#l27.98"></a><span id="l27.98">     - * isDefault: This should only be present and should be true for the tab</span>
<a href="#l27.99"></a><span id="l27.99">     -     mode that is the tab displayed automatically on startup.</span>
<a href="#l27.100"></a><span id="l27.100">     - * maxTabs: The maximum number of this mode that can be opened at a time.</span>
<a href="#l27.101"></a><span id="l27.101" class="difflineat">@@ -334,17 +334,17 @@</span>
<a href="#l27.102"></a><span id="l27.102">           ]]&gt;</span>
<a href="#l27.103"></a><span id="l27.103">         &lt;/body&gt;</span>
<a href="#l27.104"></a><span id="l27.104">       &lt;/method&gt;</span>
<a href="#l27.105"></a><span id="l27.105">       &lt;method name=&quot;registerTabType&quot;&gt;</span>
<a href="#l27.106"></a><span id="l27.106">         &lt;parameter name=&quot;aTabType&quot;/&gt;</span>
<a href="#l27.107"></a><span id="l27.107">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l27.108"></a><span id="l27.108">           if (aTabType.name in this.tabTypes)</span>
<a href="#l27.109"></a><span id="l27.109">             return;</span>
<a href="#l27.110"></a><span id="l27.110" class="difflineminus">-        </span>
<a href="#l27.111"></a><span id="l27.111" class="difflineplus">+</span>
<a href="#l27.112"></a><span id="l27.112">           this.tabTypes[aTabType.name] = aTabType;</span>
<a href="#l27.113"></a><span id="l27.113">           for (let [modeName, modeDetails] in Iterator(aTabType.modes)) {</span>
<a href="#l27.114"></a><span id="l27.114">             modeDetails.name = modeName;</span>
<a href="#l27.115"></a><span id="l27.115">             modeDetails.tabType = aTabType;</span>
<a href="#l27.116"></a><span id="l27.116">             modeDetails.tabs = [];</span>
<a href="#l27.117"></a><span id="l27.117">             this.tabModes[modeName] = modeDetails;</span>
<a href="#l27.118"></a><span id="l27.118">             if (modeDetails.isDefault)</span>
<a href="#l27.119"></a><span id="l27.119">               this.defaultTabMode = modeDetails;</span>
<a href="#l27.120"></a><span id="l27.120" class="difflineat">@@ -560,21 +560,21 @@</span>
<a href="#l27.121"></a><span id="l27.121">               tabMonitor.onTabRestored(tab,</span>
<a href="#l27.122"></a><span id="l27.122">                                        restoreState.ext[tabMonitor.monitorName],</span>
<a href="#l27.123"></a><span id="l27.123">                                        false);</span>
<a href="#l27.124"></a><span id="l27.124">             else if (&quot;onTabOpened&quot; in tabMonitor)</span>
<a href="#l27.125"></a><span id="l27.125">               tabMonitor.onTabOpened(tab, false, oldTab);</span>
<a href="#l27.126"></a><span id="l27.126">             if (!background)</span>
<a href="#l27.127"></a><span id="l27.127">               tabMonitor.onTabSwitched(tab, oldTab);</span>
<a href="#l27.128"></a><span id="l27.128">           }</span>
<a href="#l27.129"></a><span id="l27.129" class="difflineminus">-          </span>
<a href="#l27.130"></a><span id="l27.130" class="difflineplus">+</span>
<a href="#l27.131"></a><span id="l27.131">           // clear _mostRecentTabInfo; we only needed it during the call to</span>
<a href="#l27.132"></a><span id="l27.132">           //  openTab.</span>
<a href="#l27.133"></a><span id="l27.133">           this._mostRecentTabInfo = null;</span>
<a href="#l27.134"></a><span id="l27.134" class="difflineminus">-          </span>
<a href="#l27.135"></a><span id="l27.135" class="difflineplus">+</span>
<a href="#l27.136"></a><span id="l27.136">           t.setAttribute(&quot;label&quot;, tab.title);</span>
<a href="#l27.137"></a><span id="l27.137"> </span>
<a href="#l27.138"></a><span id="l27.138">           if (!background)</span>
<a href="#l27.139"></a><span id="l27.139">             this.setDocumentTitle(tab);</span>
<a href="#l27.140"></a><span id="l27.140"> </span>
<a href="#l27.141"></a><span id="l27.141">           // for styling purposes, apply the type to the tab...</span>
<a href="#l27.142"></a><span id="l27.142">           t.setAttribute('type', tab.mode.type);</span>
<a href="#l27.143"></a><span id="l27.143"> </span>
<a href="#l27.144"></a><span id="l27.144" class="difflineat">@@ -649,45 +649,45 @@</span>
<a href="#l27.145"></a><span id="l27.145">             return aTabMode.tabs[0];</span>
<a href="#l27.146"></a><span id="l27.146">           else</span>
<a href="#l27.147"></a><span id="l27.147">             return null;</span>
<a href="#l27.148"></a><span id="l27.148">         ]]&gt;&lt;/body&gt;</span>
<a href="#l27.149"></a><span id="l27.149">       &lt;/method&gt;</span>
<a href="#l27.150"></a><span id="l27.150">       &lt;method name=&quot;undoCloseTab&quot;&gt;</span>
<a href="#l27.151"></a><span id="l27.151">         &lt;parameter name=&quot;aIdx&quot;/&gt;</span>
<a href="#l27.152"></a><span id="l27.152">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l27.153"></a><span id="l27.153" class="difflineminus">-            </span>
<a href="#l27.154"></a><span id="l27.154" class="difflineplus">+</span>
<a href="#l27.155"></a><span id="l27.155">           if (!this.recentlyClosedTabs.length)</span>
<a href="#l27.156"></a><span id="l27.156">             return;</span>
<a href="#l27.157"></a><span id="l27.157" class="difflineminus">-        </span>
<a href="#l27.158"></a><span id="l27.158" class="difflineplus">+</span>
<a href="#l27.159"></a><span id="l27.159">           if (aIdx &gt;= this.recentlyClosedTabs.length)</span>
<a href="#l27.160"></a><span id="l27.160">             aIdx = this.recentlyClosedTabs.length-1;</span>
<a href="#l27.161"></a><span id="l27.161"> </span>
<a href="#l27.162"></a><span id="l27.162" class="difflineminus">-          // splice always returns an array </span>
<a href="#l27.163"></a><span id="l27.163" class="difflineplus">+          // splice always returns an array</span>
<a href="#l27.164"></a><span id="l27.164">           let history = (this.recentlyClosedTabs.splice(aIdx,1))[0];</span>
<a href="#l27.165"></a><span id="l27.165" class="difflineminus">-          </span>
<a href="#l27.166"></a><span id="l27.166" class="difflineplus">+</span>
<a href="#l27.167"></a><span id="l27.167">           if (!history.tab)</span>
<a href="#l27.168"></a><span id="l27.168">             return;</span>
<a href="#l27.169"></a><span id="l27.169"> </span>
<a href="#l27.170"></a><span id="l27.170">           if (!this.restoreTab(JSON.parse(history.tab)))</span>
<a href="#l27.171"></a><span id="l27.171">             return;</span>
<a href="#l27.172"></a><span id="l27.172" class="difflineminus">-          </span>
<a href="#l27.173"></a><span id="l27.173" class="difflineminus">-          let idx = Math.min(history.idx,this.tabInfo.length);          </span>
<a href="#l27.174"></a><span id="l27.174" class="difflineplus">+</span>
<a href="#l27.175"></a><span id="l27.175" class="difflineplus">+          let idx = Math.min(history.idx,this.tabInfo.length);</span>
<a href="#l27.176"></a><span id="l27.176">           let tab = this.tabContainer.childNodes[this.tabInfo.length - 1];</span>
<a href="#l27.177"></a><span id="l27.177">           this.moveTabTo(tab, idx);</span>
<a href="#l27.178"></a><span id="l27.178" class="difflineminus">-          </span>
<a href="#l27.179"></a><span id="l27.179" class="difflineplus">+</span>
<a href="#l27.180"></a><span id="l27.180">           this.switchToTab(tab);</span>
<a href="#l27.181"></a><span id="l27.181" class="difflineminus">-          </span>
<a href="#l27.182"></a><span id="l27.182" class="difflineplus">+</span>
<a href="#l27.183"></a><span id="l27.183">         ]]&gt;&lt;/body&gt;</span>
<a href="#l27.184"></a><span id="l27.184">       &lt;/method&gt;</span>
<a href="#l27.185"></a><span id="l27.185">       &lt;method name=&quot;closeTab&quot;&gt;</span>
<a href="#l27.186"></a><span id="l27.186">         &lt;parameter name=&quot;aOptTabIndexNodeOrInfo&quot;/&gt;</span>
<a href="#l27.187"></a><span id="l27.187">         &lt;parameter name=&quot;aNoUndo&quot; /&gt;</span>
<a href="#l27.188"></a><span id="l27.188">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l27.189"></a><span id="l27.189" class="difflineminus">-        </span>
<a href="#l27.190"></a><span id="l27.190" class="difflineplus">+</span>
<a href="#l27.191"></a><span id="l27.191">             let [iTab, tab, tabNode] =</span>
<a href="#l27.192"></a><span id="l27.192">               this._getTabContextForTabbyThing(aOptTabIndexNodeOrInfo, true);</span>
<a href="#l27.193"></a><span id="l27.193"> </span>
<a href="#l27.194"></a><span id="l27.194">             if (!tab.canClose)</span>
<a href="#l27.195"></a><span id="l27.195">               return;</span>
<a href="#l27.196"></a><span id="l27.196"> </span>
<a href="#l27.197"></a><span id="l27.197">             // Give the tab type a chance to make its own decisions about</span>
<a href="#l27.198"></a><span id="l27.198">             // whether its tabs can be closed or not. For instance, contentTabs</span>
<a href="#l27.199"></a><span id="l27.199" class="difflineat">@@ -707,17 +707,17 @@</span>
<a href="#l27.200"></a><span id="l27.200">               // Allow user to undo accidentially closed tabs</span>
<a href="#l27.201"></a><span id="l27.201">               let session = this.persistTab(tab);</span>
<a href="#l27.202"></a><span id="l27.202"> </span>
<a href="#l27.203"></a><span id="l27.203">               if (session) {</span>
<a href="#l27.204"></a><span id="l27.204">                 this.recentlyClosedTabs.unshift(</span>
<a href="#l27.205"></a><span id="l27.205">                   { tab: JSON.stringify(session), idx: iTab, title: tab.title });</span>
<a href="#l27.206"></a><span id="l27.206"> </span>
<a href="#l27.207"></a><span id="l27.207">                 if (this.recentlyClosedTabs.length &gt; 10)</span>
<a href="#l27.208"></a><span id="l27.208" class="difflineminus">-                  this.recentlyClosedTabs.pop();    </span>
<a href="#l27.209"></a><span id="l27.209" class="difflineplus">+                  this.recentlyClosedTabs.pop();</span>
<a href="#l27.210"></a><span id="l27.210">               }</span>
<a href="#l27.211"></a><span id="l27.211">             }</span>
<a href="#l27.212"></a><span id="l27.212"> </span>
<a href="#l27.213"></a><span id="l27.213">             let closeFunc = tab.mode.closeTab || tab.mode.tabType.closeTab;</span>
<a href="#l27.214"></a><span id="l27.214">             closeFunc.call(tab.mode.tabType, tab);</span>
<a href="#l27.215"></a><span id="l27.215"> </span>
<a href="#l27.216"></a><span id="l27.216">             this.tabInfo.splice(iTab, 1);</span>
<a href="#l27.217"></a><span id="l27.217">             tab.mode.tabs.splice(tab.mode.tabs.indexOf(tab), 1);</span>
<a href="#l27.218"></a><span id="l27.218" class="difflineat">@@ -787,146 +787,146 @@</span>
<a href="#l27.219"></a><span id="l27.219">       &lt;method name=&quot;replaceTabWithWindow&quot;&gt;</span>
<a href="#l27.220"></a><span id="l27.220">         &lt;parameter name=&quot;aTab&quot;/&gt;</span>
<a href="#l27.221"></a><span id="l27.221">         &lt;body&gt;</span>
<a href="#l27.222"></a><span id="l27.222">           &lt;![CDATA[</span>
<a href="#l27.223"></a><span id="l27.223">             if (this.tabInfo.length &lt;= 1)</span>
<a href="#l27.224"></a><span id="l27.224">               return null;</span>
<a href="#l27.225"></a><span id="l27.225"> </span>
<a href="#l27.226"></a><span id="l27.226">             let tab = this._getTabContextForTabbyThing(aTab, false)[1];</span>
<a href="#l27.227"></a><span id="l27.227" class="difflineminus">-                                                         </span>
<a href="#l27.228"></a><span id="l27.228" class="difflineplus">+</span>
<a href="#l27.229"></a><span id="l27.229">             if (!tab.canClose)</span>
<a href="#l27.230"></a><span id="l27.230">               return null;</span>
<a href="#l27.231"></a><span id="l27.231" class="difflineminus">-            </span>
<a href="#l27.232"></a><span id="l27.232" class="difflineplus">+</span>
<a href="#l27.233"></a><span id="l27.233">             // We use Json and session restore transfer the tab to the new window.</span>
<a href="#l27.234"></a><span id="l27.234">             tab = this.persistTab(tab);</span>
<a href="#l27.235"></a><span id="l27.235">             if (!tab)</span>
<a href="#l27.236"></a><span id="l27.236">               return null;</span>
<a href="#l27.237"></a><span id="l27.237" class="difflineminus">-        </span>
<a href="#l27.238"></a><span id="l27.238" class="difflineminus">-            // Converting to JSON and back again creates clean javascript </span>
<a href="#l27.239"></a><span id="l27.239" class="difflineplus">+</span>
<a href="#l27.240"></a><span id="l27.240" class="difflineplus">+            // Converting to JSON and back again creates clean javascript</span>
<a href="#l27.241"></a><span id="l27.241">             // object with absolutely no references to our current window.</span>
<a href="#l27.242"></a><span id="l27.242" class="difflineminus">-            let tab = JSON.parse(JSON.stringify(tab));            </span>
<a href="#l27.243"></a><span id="l27.243" class="difflineminus">-            </span>
<a href="#l27.244"></a><span id="l27.244" class="difflineplus">+            let tab = JSON.parse(JSON.stringify(tab));</span>
<a href="#l27.245"></a><span id="l27.245" class="difflineplus">+</span>
<a href="#l27.246"></a><span id="l27.246">             this.closeTab(aTab,true);</span>
<a href="#l27.247"></a><span id="l27.247" class="difflineminus">-                      </span>
<a href="#l27.248"></a><span id="l27.248" class="difflineplus">+</span>
<a href="#l27.249"></a><span id="l27.249">             return window.openDialog(&quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l27.250"></a><span id="l27.250" class="difflineminus">-               &quot;chrome,dialog=no,all&quot;, null,  </span>
<a href="#l27.251"></a><span id="l27.251" class="difflineplus">+               &quot;chrome,dialog=no,all&quot;, null,</span>
<a href="#l27.252"></a><span id="l27.252">                { action : &quot;restore&quot;, tabs: [tab] } ).focus();</span>
<a href="#l27.253"></a><span id="l27.253">           ]]&gt;</span>
<a href="#l27.254"></a><span id="l27.254">         &lt;/body&gt;</span>
<a href="#l27.255"></a><span id="l27.255" class="difflineminus">-      &lt;/method&gt;      </span>
<a href="#l27.256"></a><span id="l27.256" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l27.257"></a><span id="l27.257">       &lt;method name=&quot;moveTabTo&quot;&gt;</span>
<a href="#l27.258"></a><span id="l27.258">         &lt;parameter name=&quot;aTab&quot;/&gt;</span>
<a href="#l27.259"></a><span id="l27.259">         &lt;parameter name=&quot;aIndex&quot;/&gt;</span>
<a href="#l27.260"></a><span id="l27.260">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l27.261"></a><span id="l27.261" class="difflineminus">-          </span>
<a href="#l27.262"></a><span id="l27.262" class="difflineplus">+</span>
<a href="#l27.263"></a><span id="l27.263">           if ((!aTab) || (aTab.tagName != &quot;tab&quot;))</span>
<a href="#l27.264"></a><span id="l27.264">             return -1;</span>
<a href="#l27.265"></a><span id="l27.265"> </span>
<a href="#l27.266"></a><span id="l27.266">           let oldIdx = this.tabContainer.getIndexOfItem(aTab);</span>
<a href="#l27.267"></a><span id="l27.267">           if (oldIdx &lt; 0)</span>
<a href="#l27.268"></a><span id="l27.268">             return -1;</span>
<a href="#l27.269"></a><span id="l27.269" class="difflineminus">-          </span>
<a href="#l27.270"></a><span id="l27.270" class="difflineplus">+</span>
<a href="#l27.271"></a><span id="l27.271">           if (oldIdx == aIndex)</span>
<a href="#l27.272"></a><span id="l27.272">             return -1;</span>
<a href="#l27.273"></a><span id="l27.273" class="difflineminus">-            </span>
<a href="#l27.274"></a><span id="l27.274" class="difflineplus">+</span>
<a href="#l27.275"></a><span id="l27.275">           // Cache the old tabInfo</span>
<a href="#l27.276"></a><span id="l27.276" class="difflineminus">-          let tab = this.tabInfo[oldIdx];          </span>
<a href="#l27.277"></a><span id="l27.277" class="difflineminus">-          </span>
<a href="#l27.278"></a><span id="l27.278" class="difflineplus">+          let tab = this.tabInfo[oldIdx]</span>
<a href="#l27.279"></a><span id="l27.279" class="difflineplus">+</span>
<a href="#l27.280"></a><span id="l27.280">           if (!tab)</span>
<a href="#l27.281"></a><span id="l27.281">             return -1;</span>
<a href="#l27.282"></a><span id="l27.282" class="difflineminus">-                     </span>
<a href="#l27.283"></a><span id="l27.283" class="difflineplus">+</span>
<a href="#l27.284"></a><span id="l27.284">           // remove the entries form tabInfo, tabMode and the tabContainer</span>
<a href="#l27.285"></a><span id="l27.285">           this.tabInfo.splice(oldIdx, 1);</span>
<a href="#l27.286"></a><span id="l27.286">           tab.mode.tabs.splice(tab.mode.tabs.indexOf(tab), 1);</span>
<a href="#l27.287"></a><span id="l27.287">           this.tabContainer.removeChild(aTab);</span>
<a href="#l27.288"></a><span id="l27.288" class="difflineminus">-          </span>
<a href="#l27.289"></a><span id="l27.289" class="difflineplus">+</span>
<a href="#l27.290"></a><span id="l27.290"> </span>
<a href="#l27.291"></a><span id="l27.291">           // as we removed items, we might need to update indices</span>
<a href="#l27.292"></a><span id="l27.292">           if (oldIdx &lt; aIndex)</span>
<a href="#l27.293"></a><span id="l27.293">             aIndex --;</span>
<a href="#l27.294"></a><span id="l27.294" class="difflineminus">-                       </span>
<a href="#l27.295"></a><span id="l27.295" class="difflineplus">+</span>
<a href="#l27.296"></a><span id="l27.296">           // Read it into tabInfo and the tabContainer</span>
<a href="#l27.297"></a><span id="l27.297">           this.tabInfo.splice(aIndex, 0, tab);</span>
<a href="#l27.298"></a><span id="l27.298">           this.tabContainer.insertBefore(aTab, this.tabContainer.childNodes[aIndex]);</span>
<a href="#l27.299"></a><span id="l27.299" class="difflineminus">-          </span>
<a href="#l27.300"></a><span id="l27.300" class="difflineplus">+</span>
<a href="#l27.301"></a><span id="l27.301">           // Now it's getting a bit ugly, as tabModes stores redundant</span>
<a href="#l27.302"></a><span id="l27.302">           // information we need to get it in sync with tabInfo.</span>
<a href="#l27.303"></a><span id="l27.303" class="difflineminus">-          //              </span>
<a href="#l27.304"></a><span id="l27.304" class="difflineminus">-          // As tabModes.tabs is a subset of tabInfo, every tab can be mapped </span>
<a href="#l27.305"></a><span id="l27.305" class="difflineminus">-          // to a tabInfo index. So we check for each tab in tabModes if it is </span>
<a href="#l27.306"></a><span id="l27.306" class="difflineminus">-          // directly in front of our moved tab. We do this by looking up the </span>
<a href="#l27.307"></a><span id="l27.307" class="difflineplus">+          //</span>
<a href="#l27.308"></a><span id="l27.308" class="difflineplus">+          // As tabModes.tabs is a subset of tabInfo, every tab can be mapped</span>
<a href="#l27.309"></a><span id="l27.309" class="difflineplus">+          // to a tabInfo index. So we check for each tab in tabModes if it is</span>
<a href="#l27.310"></a><span id="l27.310" class="difflineplus">+          // directly in front of our moved tab. We do this by looking up the</span>
<a href="#l27.311"></a><span id="l27.311">           // index in tabInfo and compare it with the moved tab's index. If we</span>
<a href="#l27.312"></a><span id="l27.312">           // found our tab, we insert the moved tab directly behind into tabModes</span>
<a href="#l27.313"></a><span id="l27.313" class="difflineminus">-          </span>
<a href="#l27.314"></a><span id="l27.314" class="difflineminus">-          // In case find no tab we simply append it </span>
<a href="#l27.315"></a><span id="l27.315" class="difflineplus">+</span>
<a href="#l27.316"></a><span id="l27.316" class="difflineplus">+          // In case find no tab we simply append it</span>
<a href="#l27.317"></a><span id="l27.317">           let modeIdx = tab.mode.tabs.length+1;</span>
<a href="#l27.318"></a><span id="l27.318" class="difflineminus">-          </span>
<a href="#l27.319"></a><span id="l27.319" class="difflineplus">+</span>
<a href="#l27.320"></a><span id="l27.320">           for (let i = 0; i &lt; tab.mode.tabs.length; i++) {</span>
<a href="#l27.321"></a><span id="l27.321" class="difflineminus">-                    </span>
<a href="#l27.322"></a><span id="l27.322" class="difflineplus">+</span>
<a href="#l27.323"></a><span id="l27.323">             if (this.tabInfo.indexOf(tab.mode.tabs[i]) &lt; aIndex)</span>
<a href="#l27.324"></a><span id="l27.324">               continue;</span>
<a href="#l27.325"></a><span id="l27.325" class="difflineminus">-              </span>
<a href="#l27.326"></a><span id="l27.326" class="difflineplus">+</span>
<a href="#l27.327"></a><span id="l27.327">             modeIdx = i;</span>
<a href="#l27.328"></a><span id="l27.328">             break;</span>
<a href="#l27.329"></a><span id="l27.329">           }</span>
<a href="#l27.330"></a><span id="l27.330" class="difflineminus">-                            </span>
<a href="#l27.331"></a><span id="l27.331" class="difflineminus">-          tab.mode.tabs.splice(modeIdx, 0, tab);          </span>
<a href="#l27.332"></a><span id="l27.332" class="difflineminus">-          </span>
<a href="#l27.333"></a><span id="l27.333" class="difflineplus">+</span>
<a href="#l27.334"></a><span id="l27.334" class="difflineplus">+          tab.mode.tabs.splice(modeIdx, 0, tab);</span>
<a href="#l27.335"></a><span id="l27.335" class="difflineplus">+</span>
<a href="#l27.336"></a><span id="l27.336">           return aIndex;</span>
<a href="#l27.337"></a><span id="l27.337">          ]]&gt;</span>
<a href="#l27.338"></a><span id="l27.338">          &lt;/body&gt;</span>
<a href="#l27.339"></a><span id="l27.339">        &lt;/method&gt;</span>
<a href="#l27.340"></a><span id="l27.340">        &lt;method name=&quot;persistTab&quot;&gt;</span>
<a href="#l27.341"></a><span id="l27.341" class="difflineminus">-         &lt;parameter name=&quot;tab&quot;/&gt;        </span>
<a href="#l27.342"></a><span id="l27.342" class="difflineminus">-         &lt;body&gt;&lt;![CDATA[              </span>
<a href="#l27.343"></a><span id="l27.343" class="difflineplus">+         &lt;parameter name=&quot;tab&quot;/&gt;</span>
<a href="#l27.344"></a><span id="l27.344" class="difflineplus">+         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l27.345"></a><span id="l27.345">            /* Returns null in case persist fails */</span>
<a href="#l27.346"></a><span id="l27.346" class="difflineminus">-           </span>
<a href="#l27.347"></a><span id="l27.347" class="difflineplus">+</span>
<a href="#l27.348"></a><span id="l27.348">            let persistFunc = tab.mode.persistTab || tab.mode.tabType.persistTab;</span>
<a href="#l27.349"></a><span id="l27.349" class="difflineminus">-        </span>
<a href="#l27.350"></a><span id="l27.350" class="difflineplus">+</span>
<a href="#l27.351"></a><span id="l27.351">            // if we can't restore the tab we can't move it</span>
<a href="#l27.352"></a><span id="l27.352">            if (!persistFunc)</span>
<a href="#l27.353"></a><span id="l27.353" class="difflineminus">-             return null; </span>
<a href="#l27.354"></a><span id="l27.354" class="difflineminus">-                 </span>
<a href="#l27.355"></a><span id="l27.355" class="difflineplus">+             return null;</span>
<a href="#l27.356"></a><span id="l27.356" class="difflineplus">+</span>
<a href="#l27.357"></a><span id="l27.357">            //  If there is a non-null tab-state, then persisting succeeded and</span>
<a href="#l27.358"></a><span id="l27.358">            //  we should store it.  We store the tab's persisted state in its</span>
<a href="#l27.359"></a><span id="l27.359">            //  own distinct object rather than mixing things up in a dictionary</span>
<a href="#l27.360"></a><span id="l27.360">            //  to avoid bugs and because we may eventually let extensions store</span>
<a href="#l27.361"></a><span id="l27.361">            //  per-tab information in the persisted state.</span>
<a href="#l27.362"></a><span id="l27.362" class="difflineminus">-           </span>
<a href="#l27.363"></a><span id="l27.363" class="difflineplus">+</span>
<a href="#l27.364"></a><span id="l27.364">            let tabState;</span>
<a href="#l27.365"></a><span id="l27.365">            // Wrap this in an exception handler so that if the persistence</span>
<a href="#l27.366"></a><span id="l27.366">            // logic fails, things like tab closure still run to completion.</span>
<a href="#l27.367"></a><span id="l27.367">            try {</span>
<a href="#l27.368"></a><span id="l27.368">              tabState = persistFunc.call(tab.mode.tabType, tab);</span>
<a href="#l27.369"></a><span id="l27.369">            }</span>
<a href="#l27.370"></a><span id="l27.370">            catch(ex) {</span>
<a href="#l27.371"></a><span id="l27.371">              // Report this so that our unit testing framework sees this</span>
<a href="#l27.372"></a><span id="l27.372">              // error and (extension) developers likewise can see when their</span>
<a href="#l27.373"></a><span id="l27.373">              // extensions are ill-behaved.</span>
<a href="#l27.374"></a><span id="l27.374">              Components.utils.reportError(ex);</span>
<a href="#l27.375"></a><span id="l27.375">            }</span>
<a href="#l27.376"></a><span id="l27.376"> </span>
<a href="#l27.377"></a><span id="l27.377">            if (!tabState)</span>
<a href="#l27.378"></a><span id="l27.378">              return null;</span>
<a href="#l27.379"></a><span id="l27.379" class="difflineminus">-             </span>
<a href="#l27.380"></a><span id="l27.380" class="difflineplus">+</span>
<a href="#l27.381"></a><span id="l27.381">            let ext = {};</span>
<a href="#l27.382"></a><span id="l27.382"> </span>
<a href="#l27.383"></a><span id="l27.383">            for each (let [i, tabMonitor] in Iterator(this.tabMonitors)) {</span>
<a href="#l27.384"></a><span id="l27.384">              if (&quot;onTabPersist&quot; in tabMonitor) {</span>
<a href="#l27.385"></a><span id="l27.385">                let monState = tabMonitor.onTabPersist(tab);</span>
<a href="#l27.386"></a><span id="l27.386">                if (monState !== null)</span>
<a href="#l27.387"></a><span id="l27.387">                  ext[tabMonitor.monitorName] = monState;</span>
<a href="#l27.388"></a><span id="l27.388">              }</span>
<a href="#l27.389"></a><span id="l27.389">            }</span>
<a href="#l27.390"></a><span id="l27.390" class="difflineminus">-           </span>
<a href="#l27.391"></a><span id="l27.391" class="difflineminus">-           return {mode: tab.mode.name, state: tabState, ext: ext}           </span>
<a href="#l27.392"></a><span id="l27.392" class="difflineplus">+</span>
<a href="#l27.393"></a><span id="l27.393" class="difflineplus">+           return {mode: tab.mode.name, state: tabState, ext: ext}</span>
<a href="#l27.394"></a><span id="l27.394">         ]]&gt;&lt;/body&gt;</span>
<a href="#l27.395"></a><span id="l27.395">       &lt;/method&gt;</span>
<a href="#l27.396"></a><span id="l27.396" class="difflineminus">-      </span>
<a href="#l27.397"></a><span id="l27.397" class="difflineplus">+</span>
<a href="#l27.398"></a><span id="l27.398">       &lt;method name=&quot;persistTabs&quot;&gt;</span>
<a href="#l27.399"></a><span id="l27.399">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l27.400"></a><span id="l27.400">           /**</span>
<a href="#l27.401"></a><span id="l27.401">            * Persist the state of all tab modes implementing persistTab methods</span>
<a href="#l27.402"></a><span id="l27.402">            *  to a JSON-serializable object representation and return it.  Call</span>
<a href="#l27.403"></a><span id="l27.403">            *  restoreTabs with the result to restore the tab state.</span>
<a href="#l27.404"></a><span id="l27.404">            * Calling this method should have no side effects; tabs will not be</span>
<a href="#l27.405"></a><span id="l27.405">            *  closed, displays will not change, etc.  This means the method is</span>
<a href="#l27.406"></a><span id="l27.406" class="difflineat">@@ -936,103 +936,103 @@</span>
<a href="#l27.407"></a><span id="l27.407">            * @return {Object} The persisted tab states.</span>
<a href="#l27.408"></a><span id="l27.408">            */</span>
<a href="#l27.409"></a><span id="l27.409">           let state = {</span>
<a href="#l27.410"></a><span id="l27.410">             // Explicitly specify a revision so we don't wish we had later.</span>
<a href="#l27.411"></a><span id="l27.411">             rev: 0,</span>
<a href="#l27.412"></a><span id="l27.412">             // If our currently selected tab gets persisted, we will update this</span>
<a href="#l27.413"></a><span id="l27.413">             selectedIndex: null,</span>
<a href="#l27.414"></a><span id="l27.414">           };</span>
<a href="#l27.415"></a><span id="l27.415" class="difflineminus">-          </span>
<a href="#l27.416"></a><span id="l27.416" class="difflineplus">+</span>
<a href="#l27.417"></a><span id="l27.417">           let tabs = state.tabs = [];</span>
<a href="#l27.418"></a><span id="l27.418"> </span>
<a href="#l27.419"></a><span id="l27.419">           for each (let [iTab, tab] in Iterator(this.tabInfo)) {</span>
<a href="#l27.420"></a><span id="l27.420" class="difflineminus">-          </span>
<a href="#l27.421"></a><span id="l27.421" class="difflineplus">+</span>
<a href="#l27.422"></a><span id="l27.422">             let persistTab = this.persistTab(tab);</span>
<a href="#l27.423"></a><span id="l27.423" class="difflineminus">-            </span>
<a href="#l27.424"></a><span id="l27.424" class="difflineplus">+</span>
<a href="#l27.425"></a><span id="l27.425">             if (!persistTab)</span>
<a href="#l27.426"></a><span id="l27.426">               continue;</span>
<a href="#l27.427"></a><span id="l27.427" class="difflineminus">-            </span>
<a href="#l27.428"></a><span id="l27.428" class="difflineplus">+</span>
<a href="#l27.429"></a><span id="l27.429">             tabs.push(persistTab);</span>
<a href="#l27.430"></a><span id="l27.430" class="difflineminus">-            </span>
<a href="#l27.431"></a><span id="l27.431" class="difflineplus">+</span>
<a href="#l27.432"></a><span id="l27.432">             // Mark this persisted tab as selected</span>
<a href="#l27.433"></a><span id="l27.433">             if (iTab == this.tabContainer.selectedIndex)</span>
<a href="#l27.434"></a><span id="l27.434">               state.selectedIndex = tabs.length - 1;</span>
<a href="#l27.435"></a><span id="l27.435">           }</span>
<a href="#l27.436"></a><span id="l27.436"> </span>
<a href="#l27.437"></a><span id="l27.437">           return state;</span>
<a href="#l27.438"></a><span id="l27.438">         ]]&gt;&lt;/body&gt;</span>
<a href="#l27.439"></a><span id="l27.439" class="difflineminus">-      &lt;/method&gt;      </span>
<a href="#l27.440"></a><span id="l27.440" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l27.441"></a><span id="l27.441">       &lt;method name=&quot;restoreTab&quot;&gt;</span>
<a href="#l27.442"></a><span id="l27.442">         &lt;parameter name=&quot;aState&quot;/&gt;</span>
<a href="#l27.443"></a><span id="l27.443">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l27.444"></a><span id="l27.444" class="difflineminus">-                    </span>
<a href="#l27.445"></a><span id="l27.445" class="difflineminus">-          // if we no longer know about the mode, we can't restore the tab        </span>
<a href="#l27.446"></a><span id="l27.446" class="difflineminus">-          let mode = this.tabModes[aState.mode];        </span>
<a href="#l27.447"></a><span id="l27.447" class="difflineplus">+</span>
<a href="#l27.448"></a><span id="l27.448" class="difflineplus">+          // if we no longer know about the mode, we can't restore the tab</span>
<a href="#l27.449"></a><span id="l27.449" class="difflineplus">+          let mode = this.tabModes[aState.mode];</span>
<a href="#l27.450"></a><span id="l27.450">           if (!mode)</span>
<a href="#l27.451"></a><span id="l27.451">             return false;</span>
<a href="#l27.452"></a><span id="l27.452" class="difflineminus">-          </span>
<a href="#l27.453"></a><span id="l27.453" class="difflineplus">+</span>
<a href="#l27.454"></a><span id="l27.454">           let restoreFunc = mode.restoreTab || mode.tabType.restoreTab;</span>
<a href="#l27.455"></a><span id="l27.455" class="difflineminus">-        </span>
<a href="#l27.456"></a><span id="l27.456" class="difflineplus">+</span>
<a href="#l27.457"></a><span id="l27.457">           if (!restoreFunc)</span>
<a href="#l27.458"></a><span id="l27.458">             return false;</span>
<a href="#l27.459"></a><span id="l27.459" class="difflineminus">-            </span>
<a href="#l27.460"></a><span id="l27.460" class="difflineplus">+</span>
<a href="#l27.461"></a><span id="l27.461">           // normalize the state to have an ext attribute if it does not.</span>
<a href="#l27.462"></a><span id="l27.462">           if (!(&quot;ext&quot; in aState))</span>
<a href="#l27.463"></a><span id="l27.463">             aState.ext = {};</span>
<a href="#l27.464"></a><span id="l27.464" class="difflineminus">-            </span>
<a href="#l27.465"></a><span id="l27.465" class="difflineminus">-          this._restoringTabState = aState;  </span>
<a href="#l27.466"></a><span id="l27.466" class="difflineplus">+</span>
<a href="#l27.467"></a><span id="l27.467" class="difflineplus">+          this._restoringTabState = aState;</span>
<a href="#l27.468"></a><span id="l27.468">           restoreFunc.call(mode.tabType, this, aState.state);</span>
<a href="#l27.469"></a><span id="l27.469">           this._restoringTabState = null;</span>
<a href="#l27.470"></a><span id="l27.470" class="difflineminus">-          </span>
<a href="#l27.471"></a><span id="l27.471" class="difflineplus">+</span>
<a href="#l27.472"></a><span id="l27.472">           return true;</span>
<a href="#l27.473"></a><span id="l27.473" class="difflineminus">-          </span>
<a href="#l27.474"></a><span id="l27.474" class="difflineplus">+</span>
<a href="#l27.475"></a><span id="l27.475">         ]]&gt;&lt;/body&gt;</span>
<a href="#l27.476"></a><span id="l27.476" class="difflineminus">-      &lt;/method&gt;          </span>
<a href="#l27.477"></a><span id="l27.477" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l27.478"></a><span id="l27.478">       &lt;method name=&quot;restoreTabs&quot;&gt;</span>
<a href="#l27.479"></a><span id="l27.479">         &lt;parameter name=&quot;aPersistedState&quot;/&gt;</span>
<a href="#l27.480"></a><span id="l27.480">         &lt;parameter name=&quot;aDontRestoreFirstTab&quot;/&gt;</span>
<a href="#l27.481"></a><span id="l27.481">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l27.482"></a><span id="l27.482">           /**</span>
<a href="#l27.483"></a><span id="l27.483">            * Attempts to restore tabs persisted from a prior call to</span>
<a href="#l27.484"></a><span id="l27.484">            *  |persistTabs|.  This is currently a synchronous operation, but in</span>
<a href="#l27.485"></a><span id="l27.485">            *  the future this may kick off an asynchronous mechanism to restore</span>
<a href="#l27.486"></a><span id="l27.486">            *  the tabs one-by-one.</span>
<a href="#l27.487"></a><span id="l27.487">            */</span>
<a href="#l27.488"></a><span id="l27.488">           let tabs = aPersistedState.tabs;</span>
<a href="#l27.489"></a><span id="l27.489">           let indexToSelect = null;</span>
<a href="#l27.490"></a><span id="l27.490">           for each (let [iTab, tabState] in Iterator(tabs)) {</span>
<a href="#l27.491"></a><span id="l27.491" class="difflineminus">-          </span>
<a href="#l27.492"></a><span id="l27.492" class="difflineplus">+</span>
<a href="#l27.493"></a><span id="l27.493">             if (tabState.state.firstTab &amp;&amp; aDontRestoreFirstTab)</span>
<a href="#l27.494"></a><span id="l27.494">               tabState.state.dontRestoreFirstTab = aDontRestoreFirstTab;</span>
<a href="#l27.495"></a><span id="l27.495" class="difflineminus">-          </span>
<a href="#l27.496"></a><span id="l27.496" class="difflineplus">+</span>
<a href="#l27.497"></a><span id="l27.497">             if (!this.restoreTab(tabState))</span>
<a href="#l27.498"></a><span id="l27.498">               continue;</span>
<a href="#l27.499"></a><span id="l27.499"> </span>
<a href="#l27.500"></a><span id="l27.500">             // If this persisted tab was the selected one, then mark the newest</span>
<a href="#l27.501"></a><span id="l27.501">             //  tab as the guy to select.</span>
<a href="#l27.502"></a><span id="l27.502">             if (iTab == aPersistedState.selectedIndex)</span>
<a href="#l27.503"></a><span id="l27.503">               indexToSelect = this.tabInfo.length - 1;</span>
<a href="#l27.504"></a><span id="l27.504">           }</span>
<a href="#l27.505"></a><span id="l27.505" class="difflineminus">-          </span>
<a href="#l27.506"></a><span id="l27.506" class="difflineplus">+</span>
<a href="#l27.507"></a><span id="l27.507">           if (indexToSelect != null &amp;&amp; !aDontRestoreFirstTab)</span>
<a href="#l27.508"></a><span id="l27.508">             this.tabContainer.selectedIndex = indexToSelect;</span>
<a href="#l27.509"></a><span id="l27.509">           else</span>
<a href="#l27.510"></a><span id="l27.510">             this.tabContainer.selectedIndex = 0;</span>
<a href="#l27.511"></a><span id="l27.511">         ]]&gt;&lt;/body&gt;</span>
<a href="#l27.512"></a><span id="l27.512">       &lt;/method&gt;</span>
<a href="#l27.513"></a><span id="l27.513"> </span>
<a href="#l27.514"></a><span id="l27.514">       &lt;!-- Called when the window is being unloaded, this calls the close</span>
<a href="#l27.515"></a><span id="l27.515">            function for every tab. --&gt;</span>
<a href="#l27.516"></a><span id="l27.516">       &lt;method name=&quot;_teardown&quot;&gt;</span>
<a href="#l27.517"></a><span id="l27.517">         &lt;body&gt;</span>
<a href="#l27.518"></a><span id="l27.518">           &lt;![CDATA[</span>
<a href="#l27.519"></a><span id="l27.519">             for (var i = 0; i &lt; this.tabInfo.length; i++) {</span>
<a href="#l27.520"></a><span id="l27.520">               let tab = this.tabInfo[i];</span>
<a href="#l27.521"></a><span id="l27.521" class="difflineminus">-              </span>
<a href="#l27.522"></a><span id="l27.522" class="difflineplus">+</span>
<a href="#l27.523"></a><span id="l27.523">               let tabCloseFunc = tab.mode.closeTab || tab.mode.tabType.closeTab;</span>
<a href="#l27.524"></a><span id="l27.524">               tabCloseFunc.call(tab.mode.tabType, tab);</span>
<a href="#l27.525"></a><span id="l27.525">             }</span>
<a href="#l27.526"></a><span id="l27.526">           ]]&gt;</span>
<a href="#l27.527"></a><span id="l27.527">         &lt;/body&gt;</span>
<a href="#l27.528"></a><span id="l27.528">       &lt;/method&gt;</span>
<a href="#l27.529"></a><span id="l27.529"> </span>
<a href="#l27.530"></a><span id="l27.530">       &lt;property name=&quot;selectedTab&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l27.531"></a><span id="l27.531" class="difflineat">@@ -1099,17 +1099,17 @@</span>
<a href="#l27.532"></a><span id="l27.532">       &lt;!--  UpdateCurrentTab - called in response to changing the current tab --&gt;</span>
<a href="#l27.533"></a><span id="l27.533">       &lt;method name=&quot;updateCurrentTab&quot;&gt;</span>
<a href="#l27.534"></a><span id="l27.534">         &lt;body&gt;</span>
<a href="#l27.535"></a><span id="l27.535">           &lt;![CDATA[</span>
<a href="#l27.536"></a><span id="l27.536">             if (this.currentTabInfo != this.tabInfo[this.tabContainer.selectedIndex])</span>
<a href="#l27.537"></a><span id="l27.537">             {</span>
<a href="#l27.538"></a><span id="l27.538">               if (this.currentTabInfo)</span>
<a href="#l27.539"></a><span id="l27.539">                 this.saveCurrentTabState();</span>
<a href="#l27.540"></a><span id="l27.540" class="difflineminus">-              </span>
<a href="#l27.541"></a><span id="l27.541" class="difflineplus">+</span>
<a href="#l27.542"></a><span id="l27.542">               let oldTab = this.currentTabInfo;</span>
<a href="#l27.543"></a><span id="l27.543">               let tab = this.currentTabInfo =</span>
<a href="#l27.544"></a><span id="l27.544">                 this.tabInfo[this.tabContainer.selectedIndex];</span>
<a href="#l27.545"></a><span id="l27.545"> </span>
<a href="#l27.546"></a><span id="l27.546">               this.panelContainer.selectedPanel = tab.panel ||</span>
<a href="#l27.547"></a><span id="l27.547">                                                   tab.mode.tabType.panel;</span>
<a href="#l27.548"></a><span id="l27.548"> </span>
<a href="#l27.549"></a><span id="l27.549">               let showTabFunc = tab.mode.showTab || tab.mode.tabType.showTab;</span>
<a href="#l27.550"></a><span id="l27.550" class="difflineat">@@ -1142,17 +1142,17 @@</span>
<a href="#l27.551"></a><span id="l27.551">         &lt;/body&gt;</span>
<a href="#l27.552"></a><span id="l27.552">       &lt;/method&gt;</span>
<a href="#l27.553"></a><span id="l27.553">       &lt;method name=&quot;saveCurrentTabState&quot;&gt;</span>
<a href="#l27.554"></a><span id="l27.554">         &lt;body&gt;</span>
<a href="#l27.555"></a><span id="l27.555">           &lt;![CDATA[</span>
<a href="#l27.556"></a><span id="l27.556">             if (!this.currentTabInfo)</span>
<a href="#l27.557"></a><span id="l27.557">               this.currentTabInfo = this.tabInfo[0];</span>
<a href="#l27.558"></a><span id="l27.558">             let tab = this.currentTabInfo;</span>
<a href="#l27.559"></a><span id="l27.559" class="difflineminus">-            </span>
<a href="#l27.560"></a><span id="l27.560" class="difflineplus">+</span>
<a href="#l27.561"></a><span id="l27.561">             // save the old tab state before we change the current tab</span>
<a href="#l27.562"></a><span id="l27.562">             let saveTabFunc = tab.mode.saveTabState ||</span>
<a href="#l27.563"></a><span id="l27.563">                               tab.mode.tabType.saveTabState;</span>
<a href="#l27.564"></a><span id="l27.564">             saveTabFunc.call(tab.mode.tabType, tab);</span>
<a href="#l27.565"></a><span id="l27.565">           ]]&gt;</span>
<a href="#l27.566"></a><span id="l27.566">         &lt;/body&gt;</span>
<a href="#l27.567"></a><span id="l27.567">       &lt;/method&gt;</span>
<a href="#l27.568"></a><span id="l27.568">       &lt;method name=&quot;onTabClick&quot;&gt;</span>
<a href="#l27.569"></a><span id="l27.569" class="difflineat">@@ -1551,19 +1551,19 @@</span>
<a href="#l27.570"></a><span id="l27.570">                          anonid=&quot;scrollbutton-up&quot;</span>
<a href="#l27.571"></a><span id="l27.571">                          onmousedown=&quot;_startScroll(-1);&quot;</span>
<a href="#l27.572"></a><span id="l27.572">                          onmouseup=&quot;_stopScroll();&quot;</span>
<a href="#l27.573"></a><span id="l27.573">                          onmouseout=&quot;_stopScroll();&quot;/&gt;</span>
<a href="#l27.574"></a><span id="l27.574">       &lt;xul:scrollbox xbl:inherits=&quot;orient,align,pack,dir&quot; flex=&quot;1&quot; anonid=&quot;scrollbox&quot;&gt;</span>
<a href="#l27.575"></a><span id="l27.575">         &lt;children/&gt;</span>
<a href="#l27.576"></a><span id="l27.576">       &lt;/xul:scrollbox&gt;</span>
<a href="#l27.577"></a><span id="l27.577">       &lt;xul:stack align=&quot;center&quot; pack=&quot;end&quot; class=&quot;scrollbutton-down-stack&quot;&gt;</span>
<a href="#l27.578"></a><span id="l27.578" class="difflineminus">-        &lt;xul:hbox flex=&quot;1&quot; class=&quot;scrollbutton-down-box&quot; </span>
<a href="#l27.579"></a><span id="l27.579" class="difflineplus">+        &lt;xul:hbox flex=&quot;1&quot; class=&quot;scrollbutton-down-box&quot;</span>
<a href="#l27.580"></a><span id="l27.580">                            collapsed=&quot;true&quot; anonid=&quot;down-box&quot;/&gt;</span>
<a href="#l27.581"></a><span id="l27.581" class="difflineminus">-        &lt;xul:hbox flex=&quot;1&quot; class=&quot;scrollbutton-down-box-animate&quot; </span>
<a href="#l27.582"></a><span id="l27.582" class="difflineplus">+        &lt;xul:hbox flex=&quot;1&quot; class=&quot;scrollbutton-down-box-animate&quot;</span>
<a href="#l27.583"></a><span id="l27.583">                            collapsed=&quot;true&quot; anonid=&quot;down-box-animate&quot;/&gt;</span>
<a href="#l27.584"></a><span id="l27.584">         &lt;xul:toolbarbutton class=&quot;scrollbutton-down&quot; collapsed=&quot;true&quot;</span>
<a href="#l27.585"></a><span id="l27.585">                            xbl:inherits=&quot;orient&quot;</span>
<a href="#l27.586"></a><span id="l27.586">                            anonid=&quot;scrollbutton-down&quot;</span>
<a href="#l27.587"></a><span id="l27.587">                            onmousedown=&quot;_startScroll(1);&quot;</span>
<a href="#l27.588"></a><span id="l27.588">                            onmouseup=&quot;_stopScroll();&quot;</span>
<a href="#l27.589"></a><span id="l27.589">                            onmouseout=&quot;_stopScroll();&quot;/&gt;</span>
<a href="#l27.590"></a><span id="l27.590">       &lt;/xul:stack&gt;</span>
<a href="#l27.591"></a><span id="l27.591" class="difflineat">@@ -1606,18 +1606,18 @@</span>
<a href="#l27.592"></a><span id="l27.592">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l27.593"></a><span id="l27.593"> </span>
<a href="#l27.594"></a><span id="l27.594">       &lt;handler event=&quot;UpdatedScrollButtonsDisabledState&quot;&gt;&lt;![CDATA[</span>
<a href="#l27.595"></a><span id="l27.595">         // filter underflow events which were dispatched on nested scrollboxes</span>
<a href="#l27.596"></a><span id="l27.596">         if (event.target != this)</span>
<a href="#l27.597"></a><span id="l27.597">           return;</span>
<a href="#l27.598"></a><span id="l27.598"> </span>
<a href="#l27.599"></a><span id="l27.599">         // fix for bug #352353</span>
<a href="#l27.600"></a><span id="l27.600" class="difflineminus">-        // unlike the scrollup button on the tab strip (which is a </span>
<a href="#l27.601"></a><span id="l27.601" class="difflineminus">-        // simple toolbarbutton) the scrolldown button is </span>
<a href="#l27.602"></a><span id="l27.602" class="difflineplus">+        // unlike the scrollup button on the tab strip (which is a</span>
<a href="#l27.603"></a><span id="l27.603" class="difflineplus">+        // simple toolbarbutton) the scrolldown button is</span>
<a href="#l27.604"></a><span id="l27.604">         // a more complicated stack of boxes and a toolbarbutton</span>
<a href="#l27.605"></a><span id="l27.605">         // so that we can animate when a tab is opened offscreen.</span>
<a href="#l27.606"></a><span id="l27.606">         // in order to style the box with the actual background image</span>
<a href="#l27.607"></a><span id="l27.607">         // we need to manually set the disable state to match the</span>
<a href="#l27.608"></a><span id="l27.608">         // disable state of the toolbarbutton.</span>
<a href="#l27.609"></a><span id="l27.609">         this._scrollButtonDownBox</span>
<a href="#l27.610"></a><span id="l27.610">             .setAttribute(&quot;disabled&quot;, this._scrollButtonDown.disabled);</span>
<a href="#l27.611"></a><span id="l27.611">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l27.612"></a><span id="l27.612" class="difflineat">@@ -1657,68 +1657,65 @@</span>
<a href="#l27.613"></a><span id="l27.613">           &lt;xul:spacer class=&quot;tabs-bottom-spacer&quot;/&gt;</span>
<a href="#l27.614"></a><span id="l27.614">         &lt;/xul:vbox&gt;</span>
<a href="#l27.615"></a><span id="l27.615">       &lt;/xul:stack&gt;</span>
<a href="#l27.616"></a><span id="l27.616">     &lt;/content&gt;</span>
<a href="#l27.617"></a><span id="l27.617"> </span>
<a href="#l27.618"></a><span id="l27.618">     &lt;implementation implements=&quot;nsITimerCallback, nsIDOMEventListener&quot;&gt;</span>
<a href="#l27.619"></a><span id="l27.619">       &lt;constructor&gt;</span>
<a href="#l27.620"></a><span id="l27.620">         &lt;![CDATA[</span>
<a href="#l27.621"></a><span id="l27.621" class="difflineminus">-          var pb2 =</span>
<a href="#l27.622"></a><span id="l27.622" class="difflineminus">-              Components.classes['@mozilla.org/preferences-service;1'].</span>
<a href="#l27.623"></a><span id="l27.623" class="difflineminus">-              getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l27.624"></a><span id="l27.624" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l27.625"></a><span id="l27.625"> </span>
<a href="#l27.626"></a><span id="l27.626">           try {</span>
<a href="#l27.627"></a><span id="l27.627" class="difflineminus">-            this.mTabMinWidth = pb2.getIntPref(&quot;mail.tabs.tabMinWidth&quot;);</span>
<a href="#l27.628"></a><span id="l27.628" class="difflineplus">+            this.mTabMinWidth = Services.prefs.getIntPref(&quot;mail.tabs.tabMinWidth&quot;);</span>
<a href="#l27.629"></a><span id="l27.629">           } catch (e) {</span>
<a href="#l27.630"></a><span id="l27.630">           }</span>
<a href="#l27.631"></a><span id="l27.631">           try {</span>
<a href="#l27.632"></a><span id="l27.632" class="difflineminus">-            this.mTabMaxWidth = pb2.getIntPref(&quot;mail.tabs.tabMaxWidth&quot;);</span>
<a href="#l27.633"></a><span id="l27.633" class="difflineplus">+            this.mTabMaxWidth = Services.prefs.getIntPref(&quot;mail.tabs.tabMaxWidth&quot;);</span>
<a href="#l27.634"></a><span id="l27.634">           } catch (e) {</span>
<a href="#l27.635"></a><span id="l27.635">           }</span>
<a href="#l27.636"></a><span id="l27.636">           try {</span>
<a href="#l27.637"></a><span id="l27.637" class="difflineminus">-            this.mTabClipWidth = pb2.getIntPref(&quot;mail.tabs.tabClipWidth&quot;);</span>
<a href="#l27.638"></a><span id="l27.638" class="difflineplus">+            this.mTabClipWidth = Services.prefs.getIntPref(&quot;mail.tabs.tabClipWidth&quot;);</span>
<a href="#l27.639"></a><span id="l27.639">           } catch (e) {</span>
<a href="#l27.640"></a><span id="l27.640">           }</span>
<a href="#l27.641"></a><span id="l27.641">           try {</span>
<a href="#l27.642"></a><span id="l27.642" class="difflineminus">-            this.mCloseButtons = pb2.getIntPref(&quot;mail.tabs.closeButtons&quot;);</span>
<a href="#l27.643"></a><span id="l27.643" class="difflineplus">+            this.mCloseButtons = Services.prefs.getIntPref(&quot;mail.tabs.closeButtons&quot;);</span>
<a href="#l27.644"></a><span id="l27.644">           } catch (e) {</span>
<a href="#l27.645"></a><span id="l27.645">           }</span>
<a href="#l27.646"></a><span id="l27.646">           try {</span>
<a href="#l27.647"></a><span id="l27.647" class="difflineminus">-            this.mAutoHide = pb2.getBoolPref(&quot;mail.tabs.autoHide&quot;);</span>
<a href="#l27.648"></a><span id="l27.648" class="difflineplus">+            this.mAutoHide = Services.prefs.getBoolPref(&quot;mail.tabs.autoHide&quot;);</span>
<a href="#l27.649"></a><span id="l27.649">           } catch (e) {</span>
<a href="#l27.650"></a><span id="l27.650">           }</span>
<a href="#l27.651"></a><span id="l27.651"> </span>
<a href="#l27.652"></a><span id="l27.652">           if (this.mAutoHide)</span>
<a href="#l27.653"></a><span id="l27.653">             this.mCollapseToolbar.collapsed = true;</span>
<a href="#l27.654"></a><span id="l27.654"> </span>
<a href="#l27.655"></a><span id="l27.655">           this.firstChild.minWidth = this.mTabMinWidth;</span>
<a href="#l27.656"></a><span id="l27.656">           this.firstChild.maxWidth = this.mTabMaxWidth;</span>
<a href="#l27.657"></a><span id="l27.657">           this.adjustTabstrip();</span>
<a href="#l27.658"></a><span id="l27.658"> </span>
<a href="#l27.659"></a><span id="l27.659" class="difflineminus">-          pb2.addObserver(&quot;mail.tabs.&quot;, this._prefObserver, false);</span>
<a href="#l27.660"></a><span id="l27.660" class="difflineplus">+          Services.prefs.addObserver(&quot;mail.tabs.&quot;, this._prefObserver, false);</span>
<a href="#l27.661"></a><span id="l27.661"> </span>
<a href="#l27.662"></a><span id="l27.662">           window.addEventListener(&quot;resize&quot;, this, false);</span>
<a href="#l27.663"></a><span id="l27.663"> </span>
<a href="#l27.664"></a><span id="l27.664">           // Listen to overflow/underflow events on the tabstrip,</span>
<a href="#l27.665"></a><span id="l27.665">           // we cannot put these as xbl handlers on the entire binding because</span>
<a href="#l27.666"></a><span id="l27.666">           // they would also get called for the all-tabs popup scrollbox.</span>
<a href="#l27.667"></a><span id="l27.667">           // Also, we can't rely on event.target becuase these are all</span>
<a href="#l27.668"></a><span id="l27.668">           // anonymous nodes.</span>
<a href="#l27.669"></a><span id="l27.669">           this.mTabstrip.addEventListener(&quot;overflow&quot;, this, false);</span>
<a href="#l27.670"></a><span id="l27.670">           this.mTabstrip.addEventListener(&quot;underflow&quot;, this, false);</span>
<a href="#l27.671"></a><span id="l27.671">         ]]&gt;</span>
<a href="#l27.672"></a><span id="l27.672">       &lt;/constructor&gt;</span>
<a href="#l27.673"></a><span id="l27.673"> </span>
<a href="#l27.674"></a><span id="l27.674">       &lt;destructor&gt;</span>
<a href="#l27.675"></a><span id="l27.675">         &lt;![CDATA[</span>
<a href="#l27.676"></a><span id="l27.676" class="difflineminus">-          var pb2 =</span>
<a href="#l27.677"></a><span id="l27.677" class="difflineminus">-              Components.classes['@mozilla.org/preferences-service;1'].</span>
<a href="#l27.678"></a><span id="l27.678" class="difflineminus">-              getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l27.679"></a><span id="l27.679" class="difflineminus">-          pb2.removeObserver(&quot;mail.tabs.&quot;, this._prefObserver);</span>
<a href="#l27.680"></a><span id="l27.680" class="difflineplus">+          Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l27.681"></a><span id="l27.681" class="difflineplus">+</span>
<a href="#l27.682"></a><span id="l27.682" class="difflineplus">+          Services.prefs.removeObserver(&quot;mail.tabs.&quot;, this._prefObserver);</span>
<a href="#l27.683"></a><span id="l27.683"> </span>
<a href="#l27.684"></a><span id="l27.684">           // Release timer to avoid reference cycles.</span>
<a href="#l27.685"></a><span id="l27.685">           if (this._animateTimer) {</span>
<a href="#l27.686"></a><span id="l27.686">             this._animateTimer.cancel();</span>
<a href="#l27.687"></a><span id="l27.687">             this._animateTimer = null;</span>
<a href="#l27.688"></a><span id="l27.688">           }</span>
<a href="#l27.689"></a><span id="l27.689"> </span>
<a href="#l27.690"></a><span id="l27.690">           this.mTabstrip.removeEventListener(&quot;overflow&quot;, this, false);</span>
<a href="#l27.691"></a><span id="l27.691" class="difflineat">@@ -1765,36 +1762,36 @@</span>
<a href="#l27.692"></a><span id="l27.692">               this.tabbox.adjustTabstrip();</span>
<a href="#l27.693"></a><span id="l27.693">               break;</span>
<a href="#l27.694"></a><span id="l27.694">             case &quot;mail.tabs.autoHide&quot;:</span>
<a href="#l27.695"></a><span id="l27.695">               this.tabbox.mAutoHide = subject.getBoolPref(&quot;mail.tabs.autoHide&quot;);</span>
<a href="#l27.696"></a><span id="l27.696">               break;</span>
<a href="#l27.697"></a><span id="l27.697">             }</span>
<a href="#l27.698"></a><span id="l27.698">           }</span>
<a href="#l27.699"></a><span id="l27.699">         },</span>
<a href="#l27.700"></a><span id="l27.700" class="difflineminus">-  </span>
<a href="#l27.701"></a><span id="l27.701" class="difflineplus">+</span>
<a href="#l27.702"></a><span id="l27.702">         QueryInterface: function(aIID)</span>
<a href="#l27.703"></a><span id="l27.703">         {</span>
<a href="#l27.704"></a><span id="l27.704">           if (aIID.equals(Components.interfaces.nsIObserver) ||</span>
<a href="#l27.705"></a><span id="l27.705">               aIID.equals(Components.interfaces.nsISupports))</span>
<a href="#l27.706"></a><span id="l27.706">             return this;</span>
<a href="#l27.707"></a><span id="l27.707">           throw Components.results.NS_NOINTERFACE;</span>
<a href="#l27.708"></a><span id="l27.708">         }</span>
<a href="#l27.709"></a><span id="l27.709">         });</span>
<a href="#l27.710"></a><span id="l27.710">       &lt;/field&gt;</span>
<a href="#l27.711"></a><span id="l27.711" class="difflineminus">-      </span>
<a href="#l27.712"></a><span id="l27.712" class="difflineplus">+</span>
<a href="#l27.713"></a><span id="l27.713">       &lt;field name=&quot;_tabDropIndicator&quot;&gt;</span>
<a href="#l27.714"></a><span id="l27.714">         document.getAnonymousElementByAttribute(</span>
<a href="#l27.715"></a><span id="l27.715">             this,</span>
<a href="#l27.716"></a><span id="l27.716">             &quot;anonid&quot;, &quot;tab-drop-indicator&quot;);</span>
<a href="#l27.717"></a><span id="l27.717">       &lt;/field&gt;</span>
<a href="#l27.718"></a><span id="l27.718" class="difflineminus">-      </span>
<a href="#l27.719"></a><span id="l27.719" class="difflineplus">+</span>
<a href="#l27.720"></a><span id="l27.720">       &lt;field name=&quot;_dragOverDelay&quot;&gt;350&lt;/field&gt;</span>
<a href="#l27.721"></a><span id="l27.721">       &lt;field name=&quot;_dragTime&quot;&gt;0&lt;/field&gt;</span>
<a href="#l27.722"></a><span id="l27.722" class="difflineminus">-      </span>
<a href="#l27.723"></a><span id="l27.723" class="difflineplus">+</span>
<a href="#l27.724"></a><span id="l27.724">       &lt;field name=&quot;mTabMinWidth&quot;&gt;100&lt;/field&gt;</span>
<a href="#l27.725"></a><span id="l27.725">       &lt;field name=&quot;mTabMaxWidth&quot;&gt;250&lt;/field&gt;</span>
<a href="#l27.726"></a><span id="l27.726">       &lt;field name=&quot;mTabClipWidth&quot;&gt;140&lt;/field&gt;</span>
<a href="#l27.727"></a><span id="l27.727">       &lt;field name=&quot;mCloseButtons&quot;&gt;1&lt;/field&gt;</span>
<a href="#l27.728"></a><span id="l27.728">       &lt;field name=&quot;_mAutoHide&quot;&gt;false&lt;/field&gt;</span>
<a href="#l27.729"></a><span id="l27.729"> </span>
<a href="#l27.730"></a><span id="l27.730">       &lt;property name=&quot;mAutoHide&quot; onget=&quot;return this._mAutoHide;&quot;&gt;</span>
<a href="#l27.731"></a><span id="l27.731">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l27.732"></a><span id="l27.732" class="difflineat">@@ -1830,31 +1827,17 @@</span>
<a href="#l27.733"></a><span id="l27.733">           case 2:</span>
<a href="#l27.734"></a><span id="l27.734">           case 3:</span>
<a href="#l27.735"></a><span id="l27.735">             this.setAttribute(&quot;closebuttons&quot;, &quot;noclose&quot;);</span>
<a href="#l27.736"></a><span id="l27.736">             break;</span>
<a href="#l27.737"></a><span id="l27.737">           }</span>
<a href="#l27.738"></a><span id="l27.738">           this.mTabstripClosebutton.collapsed = this.mCloseButtons != 3;</span>
<a href="#l27.739"></a><span id="l27.739">         ]]&gt;&lt;/body&gt;</span>
<a href="#l27.740"></a><span id="l27.740">       &lt;/method&gt;</span>
<a href="#l27.741"></a><span id="l27.741" class="difflineminus">-        </span>
<a href="#l27.742"></a><span id="l27.742" class="difflineminus">-      &lt;field name=&quot;_mPrefs&quot;&gt;null&lt;/field&gt;</span>
<a href="#l27.743"></a><span id="l27.743" class="difflineminus">-      &lt;property name=&quot;mPrefs&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l27.744"></a><span id="l27.744" class="difflineminus">-        &lt;getter&gt;</span>
<a href="#l27.745"></a><span id="l27.745" class="difflineminus">-        &lt;![CDATA[</span>
<a href="#l27.746"></a><span id="l27.746" class="difflineminus">-          if (!this._mPrefs) {</span>
<a href="#l27.747"></a><span id="l27.747" class="difflineminus">-            this._mPrefs =</span>
<a href="#l27.748"></a><span id="l27.748" class="difflineminus">-              Components.classes['@mozilla.org/preferences-service;1'].</span>
<a href="#l27.749"></a><span id="l27.749" class="difflineminus">-              getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l27.750"></a><span id="l27.750" class="difflineminus">-          }</span>
<a href="#l27.751"></a><span id="l27.751" class="difflineminus">-          return this._mPrefs;</span>
<a href="#l27.752"></a><span id="l27.752" class="difflineminus">-        ]]&gt;</span>
<a href="#l27.753"></a><span id="l27.753" class="difflineminus">-        &lt;/getter&gt;</span>
<a href="#l27.754"></a><span id="l27.754" class="difflineminus">-      &lt;/property&gt;</span>
<a href="#l27.755"></a><span id="l27.755" class="difflineminus">-        </span>
<a href="#l27.756"></a><span id="l27.756" class="difflineplus">+</span>
<a href="#l27.757"></a><span id="l27.757">       &lt;method name=&quot;_handleTabSelect&quot;&gt;</span>
<a href="#l27.758"></a><span id="l27.758">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l27.759"></a><span id="l27.759">           this.mTabstrip.ensureElementIsVisible(this.selectedItem);</span>
<a href="#l27.760"></a><span id="l27.760">         ]]&gt;&lt;/body&gt;</span>
<a href="#l27.761"></a><span id="l27.761">       &lt;/method&gt;</span>
<a href="#l27.762"></a><span id="l27.762"> </span>
<a href="#l27.763"></a><span id="l27.763">       &lt;method name=&quot;handleEvent&quot;&gt;</span>
<a href="#l27.764"></a><span id="l27.764">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l27.765"></a><span id="l27.765" class="difflineat">@@ -1882,17 +1865,17 @@</span>
<a href="#l27.766"></a><span id="l27.766">         ]]&gt;&lt;/body&gt;</span>
<a href="#l27.767"></a><span id="l27.767">       &lt;/method&gt;</span>
<a href="#l27.768"></a><span id="l27.768"> </span>
<a href="#l27.769"></a><span id="l27.769">       &lt;field name=&quot;mAllTabsPopup&quot;&gt;</span>
<a href="#l27.770"></a><span id="l27.770">         this.mAllTabsButton.menu;</span>
<a href="#l27.771"></a><span id="l27.771">       &lt;/field&gt;</span>
<a href="#l27.772"></a><span id="l27.772"> </span>
<a href="#l27.773"></a><span id="l27.773">       &lt;field name=&quot;mAllTabsBoxAnimate&quot;&gt;</span>
<a href="#l27.774"></a><span id="l27.774" class="difflineminus">-        document.getAnonymousElementByAttribute(this, </span>
<a href="#l27.775"></a><span id="l27.775" class="difflineplus">+        document.getAnonymousElementByAttribute(this,</span>
<a href="#l27.776"></a><span id="l27.776">                                                 &quot;anonid&quot;,</span>
<a href="#l27.777"></a><span id="l27.777">                                                 &quot;alltabs-box-animate&quot;);</span>
<a href="#l27.778"></a><span id="l27.778">       &lt;/field&gt;</span>
<a href="#l27.779"></a><span id="l27.779"> </span>
<a href="#l27.780"></a><span id="l27.780">       &lt;field name=&quot;mDownBoxAnimate&quot;&gt;</span>
<a href="#l27.781"></a><span id="l27.781">         this.mTabstrip._scrollButtonDownBoxAnimate;</span>
<a href="#l27.782"></a><span id="l27.782">       &lt;/field&gt;</span>
<a href="#l27.783"></a><span id="l27.783"> </span>
<a href="#l27.784"></a><span id="l27.784" class="difflineat">@@ -1919,177 +1902,177 @@</span>
<a href="#l27.785"></a><span id="l27.785">               this._animateTimer.cancel();</span>
<a href="#l27.786"></a><span id="l27.786"> </span>
<a href="#l27.787"></a><span id="l27.787">             this._animateStep = -1;</span>
<a href="#l27.788"></a><span id="l27.788">             this.mAllTabsBoxAnimate.style.opacity = 0.0;</span>
<a href="#l27.789"></a><span id="l27.789">             this.mDownBoxAnimate.style.opacity = 0.0;</span>
<a href="#l27.790"></a><span id="l27.790">           }</span>
<a href="#l27.791"></a><span id="l27.791">         ]]&gt;&lt;/body&gt;</span>
<a href="#l27.792"></a><span id="l27.792">       &lt;/method&gt;</span>
<a href="#l27.793"></a><span id="l27.793" class="difflineminus">-      </span>
<a href="#l27.794"></a><span id="l27.794" class="difflineplus">+</span>
<a href="#l27.795"></a><span id="l27.795">       &lt;method name=&quot;_notifyBackgroundTab&quot;&gt;</span>
<a href="#l27.796"></a><span id="l27.796">         &lt;parameter name=&quot;aTab&quot;/&gt;</span>
<a href="#l27.797"></a><span id="l27.797">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l27.798"></a><span id="l27.798">           var tsbo = this.mTabstrip.scrollBoxObject;</span>
<a href="#l27.799"></a><span id="l27.799">           var tsboStart = tsbo.screenX;</span>
<a href="#l27.800"></a><span id="l27.800">           var tsboEnd = tsboStart + tsbo.width;</span>
<a href="#l27.801"></a><span id="l27.801"> </span>
<a href="#l27.802"></a><span id="l27.802">           var ctbo = aTab.boxObject;</span>
<a href="#l27.803"></a><span id="l27.803">           var ctboStart = ctbo.screenX;</span>
<a href="#l27.804"></a><span id="l27.804">           var ctboEnd = ctboStart + ctbo.width;</span>
<a href="#l27.805"></a><span id="l27.805"> </span>
<a href="#l27.806"></a><span id="l27.806">           // only start the flash timer if the new tab (which was loaded in</span>
<a href="#l27.807"></a><span id="l27.807">           // the background) is not completely visible</span>
<a href="#l27.808"></a><span id="l27.808">           if (tsboStart &gt; ctboStart || ctboEnd &gt; tsboEnd) {</span>
<a href="#l27.809"></a><span id="l27.809">             this._animateStep = 0;</span>
<a href="#l27.810"></a><span id="l27.810"> </span>
<a href="#l27.811"></a><span id="l27.811" class="difflineminus">-            if (!this._animateTimer) </span>
<a href="#l27.812"></a><span id="l27.812" class="difflineplus">+            if (!this._animateTimer)</span>
<a href="#l27.813"></a><span id="l27.813">               this._animateTimer =</span>
<a href="#l27.814"></a><span id="l27.814">                 Components.classes[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l27.815"></a><span id="l27.815">                           .createInstance(Components.interfaces.nsITimer);</span>
<a href="#l27.816"></a><span id="l27.816">             else</span>
<a href="#l27.817"></a><span id="l27.817">                this._animateTimer.cancel();</span>
<a href="#l27.818"></a><span id="l27.818"> </span>
<a href="#l27.819"></a><span id="l27.819">             this._animateTimer.initWithCallback(this,</span>
<a href="#l27.820"></a><span id="l27.820">                          this._animateDelay,</span>
<a href="#l27.821"></a><span id="l27.821">                          Components.interfaces.nsITimer.TYPE_REPEATING_SLACK);</span>
<a href="#l27.822"></a><span id="l27.822">           }</span>
<a href="#l27.823"></a><span id="l27.823">         ]]&gt;&lt;/body&gt;</span>
<a href="#l27.824"></a><span id="l27.824">       &lt;/method&gt;</span>
<a href="#l27.825"></a><span id="l27.825" class="difflineminus">-      </span>
<a href="#l27.826"></a><span id="l27.826" class="difflineplus">+</span>
<a href="#l27.827"></a><span id="l27.827">       &lt;method name=&quot;notify&quot;&gt;</span>
<a href="#l27.828"></a><span id="l27.828">         &lt;parameter name=&quot;aTimer&quot;/&gt;</span>
<a href="#l27.829"></a><span id="l27.829">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l27.830"></a><span id="l27.830">           if (!document)</span>
<a href="#l27.831"></a><span id="l27.831">             aTimer.cancel();</span>
<a href="#l27.832"></a><span id="l27.832"> </span>
<a href="#l27.833"></a><span id="l27.833">           var percent = this._animatePercents[this._animateStep];</span>
<a href="#l27.834"></a><span id="l27.834">           this.mAllTabsBoxAnimate.style.opacity = percent;</span>
<a href="#l27.835"></a><span id="l27.835">           this.mDownBoxAnimate.style.opacity = percent;</span>
<a href="#l27.836"></a><span id="l27.836"> </span>
<a href="#l27.837"></a><span id="l27.837">           if (this._animateStep &lt; (this._animatePercents.length - 1))</span>
<a href="#l27.838"></a><span id="l27.838">             this._animateStep++;</span>
<a href="#l27.839"></a><span id="l27.839">           else</span>
<a href="#l27.840"></a><span id="l27.840">             this._stopAnimation();</span>
<a href="#l27.841"></a><span id="l27.841">         ]]&gt;&lt;/body&gt;</span>
<a href="#l27.842"></a><span id="l27.842">       &lt;/method&gt;</span>
<a href="#l27.843"></a><span id="l27.843" class="difflineminus">-      </span>
<a href="#l27.844"></a><span id="l27.844" class="difflineplus">+</span>
<a href="#l27.845"></a><span id="l27.845">       &lt;method name=&quot;_getDragTargetTab&quot;&gt;</span>
<a href="#l27.846"></a><span id="l27.846">         &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l27.847"></a><span id="l27.847" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[     </span>
<a href="#l27.848"></a><span id="l27.848" class="difflineminus">-                                   </span>
<a href="#l27.849"></a><span id="l27.849" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l27.850"></a><span id="l27.850" class="difflineplus">+</span>
<a href="#l27.851"></a><span id="l27.851">           if (event.target.localName != &quot;tab&quot;)</span>
<a href="#l27.852"></a><span id="l27.852">             return null;</span>
<a href="#l27.853"></a><span id="l27.853" class="difflineminus">-                      </span>
<a href="#l27.854"></a><span id="l27.854" class="difflineplus">+</span>
<a href="#l27.855"></a><span id="l27.855">           let tab = event.target;</span>
<a href="#l27.856"></a><span id="l27.856" class="difflineminus">-          </span>
<a href="#l27.857"></a><span id="l27.857" class="difflineminus">-          if ((event.type != &quot;drop&quot;) &amp;&amp; (event.type != &quot;dragover&quot;)) </span>
<a href="#l27.858"></a><span id="l27.858" class="difflineplus">+</span>
<a href="#l27.859"></a><span id="l27.859" class="difflineplus">+          if ((event.type != &quot;drop&quot;) &amp;&amp; (event.type != &quot;dragover&quot;))</span>
<a href="#l27.860"></a><span id="l27.860">             return tab;</span>
<a href="#l27.861"></a><span id="l27.861" class="difflineminus">-            </span>
<a href="#l27.862"></a><span id="l27.862" class="difflineplus">+</span>
<a href="#l27.863"></a><span id="l27.863">           let boxObject = tab.boxObject;</span>
<a href="#l27.864"></a><span id="l27.864" class="difflineminus">-          </span>
<a href="#l27.865"></a><span id="l27.865" class="difflineplus">+</span>
<a href="#l27.866"></a><span id="l27.866">           if (event.screenX &lt; boxObject.screenX + boxObject.width * .25)</span>
<a href="#l27.867"></a><span id="l27.867">             return null</span>
<a href="#l27.868"></a><span id="l27.868" class="difflineminus">-          </span>
<a href="#l27.869"></a><span id="l27.869" class="difflineplus">+</span>
<a href="#l27.870"></a><span id="l27.870">           if (event.screenX &gt; boxObject.screenX + boxObject.width * .75)</span>
<a href="#l27.871"></a><span id="l27.871">             return null;</span>
<a href="#l27.872"></a><span id="l27.872" class="difflineminus">-           </span>
<a href="#l27.873"></a><span id="l27.873" class="difflineminus">-          return tab; </span>
<a href="#l27.874"></a><span id="l27.874" class="difflineplus">+</span>
<a href="#l27.875"></a><span id="l27.875" class="difflineplus">+          return tab;</span>
<a href="#l27.876"></a><span id="l27.876">         ]]&gt;&lt;/body&gt;</span>
<a href="#l27.877"></a><span id="l27.877">       &lt;/method&gt;</span>
<a href="#l27.878"></a><span id="l27.878" class="difflineminus">-    </span>
<a href="#l27.879"></a><span id="l27.879" class="difflineminus">-      </span>
<a href="#l27.880"></a><span id="l27.880" class="difflineplus">+</span>
<a href="#l27.881"></a><span id="l27.881" class="difflineplus">+</span>
<a href="#l27.882"></a><span id="l27.882">       &lt;method name=&quot;_getDropIndex&quot;&gt;</span>
<a href="#l27.883"></a><span id="l27.883">         &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l27.884"></a><span id="l27.884" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[        </span>
<a href="#l27.885"></a><span id="l27.885" class="difflineminus">-          let tabs = this.childNodes;                   </span>
<a href="#l27.886"></a><span id="l27.886" class="difflineminus">-            </span>
<a href="#l27.887"></a><span id="l27.887" class="difflineminus">-          if (window.getComputedStyle(this, null).direction == &quot;ltr&quot;) {                      </span>
<a href="#l27.888"></a><span id="l27.888" class="difflineminus">-            for (let i = 0; i &lt; tabs.length; i++)              </span>
<a href="#l27.889"></a><span id="l27.889" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l27.890"></a><span id="l27.890" class="difflineplus">+          let tabs = this.childNodes;</span>
<a href="#l27.891"></a><span id="l27.891" class="difflineplus">+</span>
<a href="#l27.892"></a><span id="l27.892" class="difflineplus">+          if (window.getComputedStyle(this, null).direction == &quot;ltr&quot;) {</span>
<a href="#l27.893"></a><span id="l27.893" class="difflineplus">+            for (let i = 0; i &lt; tabs.length; i++)</span>
<a href="#l27.894"></a><span id="l27.894">               if (event.screenX &lt; (tabs[i].boxObject.screenX + (tabs[i].boxObject.width / 2)))</span>
<a href="#l27.895"></a><span id="l27.895">                 return i;</span>
<a href="#l27.896"></a><span id="l27.896">           }</span>
<a href="#l27.897"></a><span id="l27.897">           else  {</span>
<a href="#l27.898"></a><span id="l27.898">             for (let i = 0; i &lt; tabs.length; i++)</span>
<a href="#l27.899"></a><span id="l27.899">               if (event.screenX &gt; (tabs[i].boxObject.screenX + (tabs[i].boxObject.width / 2)))</span>
<a href="#l27.900"></a><span id="l27.900" class="difflineminus">-                return i;         </span>
<a href="#l27.901"></a><span id="l27.901" class="difflineminus">-          }          </span>
<a href="#l27.902"></a><span id="l27.902" class="difflineminus">-         </span>
<a href="#l27.903"></a><span id="l27.903" class="difflineminus">-           return tabs.length;           </span>
<a href="#l27.904"></a><span id="l27.904" class="difflineplus">+                return i;</span>
<a href="#l27.905"></a><span id="l27.905" class="difflineplus">+          }</span>
<a href="#l27.906"></a><span id="l27.906" class="difflineplus">+</span>
<a href="#l27.907"></a><span id="l27.907" class="difflineplus">+           return tabs.length;</span>
<a href="#l27.908"></a><span id="l27.908">         ]]&gt;&lt;/body&gt;</span>
<a href="#l27.909"></a><span id="l27.909" class="difflineminus">-      &lt;/method&gt;        </span>
<a href="#l27.910"></a><span id="l27.910" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l27.911"></a><span id="l27.911">     &lt;/implementation&gt;</span>
<a href="#l27.912"></a><span id="l27.912">     &lt;handlers&gt;</span>
<a href="#l27.913"></a><span id="l27.913">       &lt;handler event=&quot;select&quot;&gt;&lt;![CDATA[</span>
<a href="#l27.914"></a><span id="l27.914">           if (!('updateCurrentTab' in this.tabmail) ||</span>
<a href="#l27.915"></a><span id="l27.915">               event.target.localName != 'tabs')</span>
<a href="#l27.916"></a><span id="l27.916">             return;</span>
<a href="#l27.917"></a><span id="l27.917"> </span>
<a href="#l27.918"></a><span id="l27.918">           this.tabmail.updateCurrentTab();</span>
<a href="#l27.919"></a><span id="l27.919">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l27.920"></a><span id="l27.920">       &lt;handler event=&quot;TabSelect&quot; action=&quot;this._handleTabSelect();&quot;/&gt;</span>
<a href="#l27.921"></a><span id="l27.921" class="difflineminus">-      &lt;handler event=&quot;dragstart&quot;&gt;&lt;![CDATA[          </span>
<a href="#l27.922"></a><span id="l27.922" class="difflineplus">+      &lt;handler event=&quot;dragstart&quot;&gt;&lt;![CDATA[</span>
<a href="#l27.923"></a><span id="l27.923">         let draggedTab = this._getDragTargetTab(event);</span>
<a href="#l27.924"></a><span id="l27.924" class="difflineminus">-        </span>
<a href="#l27.925"></a><span id="l27.925" class="difflineplus">+</span>
<a href="#l27.926"></a><span id="l27.926">         if (!draggedTab)</span>
<a href="#l27.927"></a><span id="l27.927" class="difflineminus">-          return;  </span>
<a href="#l27.928"></a><span id="l27.928" class="difflineplus">+          return;</span>
<a href="#l27.929"></a><span id="l27.929"> </span>
<a href="#l27.930"></a><span id="l27.930">         let tab = this.tabmail.selectedTab;</span>
<a href="#l27.931"></a><span id="l27.931" class="difflineminus">-        </span>
<a href="#l27.932"></a><span id="l27.932" class="difflineplus">+</span>
<a href="#l27.933"></a><span id="l27.933">         if (!tab || !tab.canClose)</span>
<a href="#l27.934"></a><span id="l27.934">           return;</span>
<a href="#l27.935"></a><span id="l27.935"> </span>
<a href="#l27.936"></a><span id="l27.936" class="difflineminus">-                                          </span>
<a href="#l27.937"></a><span id="l27.937" class="difflineplus">+</span>
<a href="#l27.938"></a><span id="l27.938">         let dt = event.dataTransfer;</span>
<a href="#l27.939"></a><span id="l27.939" class="difflineminus">-        </span>
<a href="#l27.940"></a><span id="l27.940" class="difflineplus">+</span>
<a href="#l27.941"></a><span id="l27.941">         // If we drag within the same window, we use the tab directly</span>
<a href="#l27.942"></a><span id="l27.942">         dt.mozSetDataAt(&quot;application/x-moz-tabmail-tab&quot;, draggedTab, 0);</span>
<a href="#l27.943"></a><span id="l27.943" class="difflineminus">-        </span>
<a href="#l27.944"></a><span id="l27.944" class="difflineminus">-        // otherwise we use session restore &amp; JSON to migrate the tab.        </span>
<a href="#l27.945"></a><span id="l27.945" class="difflineplus">+</span>
<a href="#l27.946"></a><span id="l27.946" class="difflineplus">+        // otherwise we use session restore &amp; JSON to migrate the tab.</span>
<a href="#l27.947"></a><span id="l27.947">         let uri = this.tabmail.persistTab(tab);</span>
<a href="#l27.948"></a><span id="l27.948" class="difflineminus">-        </span>
<a href="#l27.949"></a><span id="l27.949" class="difflineplus">+</span>
<a href="#l27.950"></a><span id="l27.950">         // In case the tab implements session restore, we use JSON to convert</span>
<a href="#l27.951"></a><span id="l27.951">         // it into a string</span>
<a href="#l27.952"></a><span id="l27.952" class="difflineminus">-        // </span>
<a href="#l27.953"></a><span id="l27.953" class="difflineminus">-        // If a tab does not support session restore it retuns null. We can't </span>
<a href="#l27.954"></a><span id="l27.954" class="difflineplus">+        //</span>
<a href="#l27.955"></a><span id="l27.955" class="difflineplus">+        // If a tab does not support session restore it retuns null. We can't</span>
<a href="#l27.956"></a><span id="l27.956">         // moved such tabs to a new window. However moving them within the same</span>
<a href="#l27.957"></a><span id="l27.957">         // window works perfectly fine</span>
<a href="#l27.958"></a><span id="l27.958" class="difflineminus">-        </span>
<a href="#l27.959"></a><span id="l27.959" class="difflineplus">+</span>
<a href="#l27.960"></a><span id="l27.960">         if (uri)</span>
<a href="#l27.961"></a><span id="l27.961">           uri = JSON.stringify(uri);</span>
<a href="#l27.962"></a><span id="l27.962" class="difflineminus">-        </span>
<a href="#l27.963"></a><span id="l27.963" class="difflineplus">+</span>
<a href="#l27.964"></a><span id="l27.964">         dt.mozSetDataAt(&quot;application/x-moz-tabmail-json&quot;, uri, 0);</span>
<a href="#l27.965"></a><span id="l27.965"> </span>
<a href="#l27.966"></a><span id="l27.966">         dt.mozCursor = &quot;default&quot;;</span>
<a href="#l27.967"></a><span id="l27.967" class="difflineminus">-            </span>
<a href="#l27.968"></a><span id="l27.968" class="difflineplus">+</span>
<a href="#l27.969"></a><span id="l27.969">         // Create Drag Image</span>
<a href="#l27.970"></a><span id="l27.970">         let panel = document.getElementById(&quot;tabpanelcontainer&quot;);</span>
<a href="#l27.971"></a><span id="l27.971" class="difflineminus">-        </span>
<a href="#l27.972"></a><span id="l27.972" class="difflineminus">-        let thumbnail = document.createElementNS(&quot;http://www.w3.org/1999/xhtml&quot;, &quot;canvas&quot;); </span>
<a href="#l27.973"></a><span id="l27.973" class="difflineplus">+</span>
<a href="#l27.974"></a><span id="l27.974" class="difflineplus">+        let thumbnail = document.createElementNS(&quot;http://www.w3.org/1999/xhtml&quot;, &quot;canvas&quot;);</span>
<a href="#l27.975"></a><span id="l27.975">         thumbnail.width = Math.ceil(screen.availWidth / 5.75);</span>
<a href="#l27.976"></a><span id="l27.976">         thumbnail.height = Math.round(width * 0.5625);</span>
<a href="#l27.977"></a><span id="l27.977" class="difflineminus">-        </span>
<a href="#l27.978"></a><span id="l27.978" class="difflineplus">+</span>
<a href="#l27.979"></a><span id="l27.979">         let snippetWidth = panel.boxObject.width * .6;</span>
<a href="#l27.980"></a><span id="l27.980">         let scale = thumbnail.width / snippetWidth;</span>
<a href="#l27.981"></a><span id="l27.981"> </span>
<a href="#l27.982"></a><span id="l27.982">         let ctx = thumbnail.getContext(&quot;2d&quot;);</span>
<a href="#l27.983"></a><span id="l27.983" class="difflineminus">-    </span>
<a href="#l27.984"></a><span id="l27.984" class="difflineplus">+</span>
<a href="#l27.985"></a><span id="l27.985">         ctx.scale(scale, scale);</span>
<a href="#l27.986"></a><span id="l27.986" class="difflineminus">-          </span>
<a href="#l27.987"></a><span id="l27.987" class="difflineplus">+</span>
<a href="#l27.988"></a><span id="l27.988">         ctx.drawWindow(window,</span>
<a href="#l27.989"></a><span id="l27.989">                 panel.boxObject.screenX - window.mozInnerScreenX,</span>
<a href="#l27.990"></a><span id="l27.990" class="difflineminus">-                panel.boxObject.screenY - window.mozInnerScreenY, </span>
<a href="#l27.991"></a><span id="l27.991" class="difflineplus">+                panel.boxObject.screenY - window.mozInnerScreenY,</span>
<a href="#l27.992"></a><span id="l27.992">                 snippetWidth,</span>
<a href="#l27.993"></a><span id="l27.993">                 snippetWidth * 0.5625,</span>
<a href="#l27.994"></a><span id="l27.994" class="difflineminus">-                &quot;rgb(255,255,255)&quot;); </span>
<a href="#l27.995"></a><span id="l27.995" class="difflineplus">+                &quot;rgb(255,255,255)&quot;);</span>
<a href="#l27.996"></a><span id="l27.996"> </span>
<a href="#l27.997"></a><span id="l27.997">         var dt = event.dataTransfer;</span>
<a href="#l27.998"></a><span id="l27.998" class="difflineminus">-        dt.setDragImage(thumbnail, 0, 0);        </span>
<a href="#l27.999"></a><span id="l27.999" class="difflineminus">-                </span>
<a href="#l27.1000"></a><span id="l27.1000" class="difflineminus">-        event.stopPropagation();        </span>
<a href="#l27.1001"></a><span id="l27.1001" class="difflineplus">+        dt.setDragImage(thumbnail, 0, 0);</span>
<a href="#l27.1002"></a><span id="l27.1002" class="difflineplus">+</span>
<a href="#l27.1003"></a><span id="l27.1003" class="difflineplus">+        event.stopPropagation();</span>
<a href="#l27.1004"></a><span id="l27.1004">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l27.1005"></a><span id="l27.1005">       &lt;handler event=&quot;dragover&quot;&gt;&lt;![CDATA[</span>
<a href="#l27.1006"></a><span id="l27.1006">         let dt = event.dataTransfer;</span>
<a href="#l27.1007"></a><span id="l27.1007"> </span>
<a href="#l27.1008"></a><span id="l27.1008">         if (dt.mozItemCount == 0)</span>
<a href="#l27.1009"></a><span id="l27.1009">           return;</span>
<a href="#l27.1010"></a><span id="l27.1010"> </span>
<a href="#l27.1011"></a><span id="l27.1011">         if (dt.mozGetDataAt(&quot;text/toolbarwrapper-id/messengerWindow&quot;, 0)</span>
<a href="#l27.1012"></a><span id="l27.1012" class="difflineat">@@ -2108,143 +2091,143 @@</span>
<a href="#l27.1013"></a><span id="l27.1013">           else</span>
<a href="#l27.1014"></a><span id="l27.1014">             this.mToolbar.dispatchEvent(evt);</span>
<a href="#l27.1015"></a><span id="l27.1015"> </span>
<a href="#l27.1016"></a><span id="l27.1016">           return;</span>
<a href="#l27.1017"></a><span id="l27.1017">         }</span>
<a href="#l27.1018"></a><span id="l27.1018"> </span>
<a href="#l27.1019"></a><span id="l27.1019">         // Bug 516247:</span>
<a href="#l27.1020"></a><span id="l27.1020">         // incase the user is dragging something else than a tab, and</span>
<a href="#l27.1021"></a><span id="l27.1021" class="difflineminus">-        // keeps hovering over a tab, we assume he wants to switch to this tab. </span>
<a href="#l27.1022"></a><span id="l27.1022" class="difflineplus">+        // keeps hovering over a tab, we assume he wants to switch to this tab.</span>
<a href="#l27.1023"></a><span id="l27.1023">         if ((dt.mozTypesAt(0)[0] != &quot;application/x-moz-tabmail-tab&quot;)</span>
<a href="#l27.1024"></a><span id="l27.1024">             &amp;&amp; (dt.mozTypesAt(0)[1] != &quot;application/x-moz-tabmail-json&quot;))  {</span>
<a href="#l27.1025"></a><span id="l27.1025" class="difflineminus">-          </span>
<a href="#l27.1026"></a><span id="l27.1026" class="difflineminus">-          let tab = this._getDragTargetTab(event); </span>
<a href="#l27.1027"></a><span id="l27.1027" class="difflineminus">-         </span>
<a href="#l27.1028"></a><span id="l27.1028" class="difflineplus">+</span>
<a href="#l27.1029"></a><span id="l27.1029" class="difflineplus">+          let tab = this._getDragTargetTab(event);</span>
<a href="#l27.1030"></a><span id="l27.1030" class="difflineplus">+</span>
<a href="#l27.1031"></a><span id="l27.1031">           if (!tab)</span>
<a href="#l27.1032"></a><span id="l27.1032">             return;</span>
<a href="#l27.1033"></a><span id="l27.1033" class="difflineminus">-          </span>
<a href="#l27.1034"></a><span id="l27.1034" class="difflineplus">+</span>
<a href="#l27.1035"></a><span id="l27.1035">           event.preventDefault();</span>
<a href="#l27.1036"></a><span id="l27.1036" class="difflineminus">-          event.stopPropagation();          </span>
<a href="#l27.1037"></a><span id="l27.1037" class="difflineminus">-          </span>
<a href="#l27.1038"></a><span id="l27.1038" class="difflineplus">+          event.stopPropagation();</span>
<a href="#l27.1039"></a><span id="l27.1039" class="difflineplus">+</span>
<a href="#l27.1040"></a><span id="l27.1040">           if (!this._dragTime) {</span>
<a href="#l27.1041"></a><span id="l27.1041">             this._dragTime = Date.now();</span>
<a href="#l27.1042"></a><span id="l27.1042">             return;</span>
<a href="#l27.1043"></a><span id="l27.1043">           }</span>
<a href="#l27.1044"></a><span id="l27.1044" class="difflineminus">-          </span>
<a href="#l27.1045"></a><span id="l27.1045" class="difflineplus">+</span>
<a href="#l27.1046"></a><span id="l27.1046">           if (Date.now() &lt;= this._dragTime + this._dragOverDelay)</span>
<a href="#l27.1047"></a><span id="l27.1047">             return;</span>
<a href="#l27.1048"></a><span id="l27.1048" class="difflineminus">-          </span>
<a href="#l27.1049"></a><span id="l27.1049" class="difflineplus">+</span>
<a href="#l27.1050"></a><span id="l27.1050">           if (this.tabmail.tabContainer.selectedItem == tab)</span>
<a href="#l27.1051"></a><span id="l27.1051">             return;</span>
<a href="#l27.1052"></a><span id="l27.1052" class="difflineminus">-             </span>
<a href="#l27.1053"></a><span id="l27.1053" class="difflineminus">-          this.tabmail.tabContainer.selectedItem = tab;         </span>
<a href="#l27.1054"></a><span id="l27.1054" class="difflineminus">-          </span>
<a href="#l27.1055"></a><span id="l27.1055" class="difflineplus">+</span>
<a href="#l27.1056"></a><span id="l27.1056" class="difflineplus">+          this.tabmail.tabContainer.selectedItem = tab;</span>
<a href="#l27.1057"></a><span id="l27.1057" class="difflineplus">+</span>
<a href="#l27.1058"></a><span id="l27.1058">           return;</span>
<a href="#l27.1059"></a><span id="l27.1059">         }</span>
<a href="#l27.1060"></a><span id="l27.1060" class="difflineminus">-                            </span>
<a href="#l27.1061"></a><span id="l27.1061" class="difflineminus">-        // as some tabs do not support session restore they can't be </span>
<a href="#l27.1062"></a><span id="l27.1062" class="difflineminus">-        // moved to a different or new window. We should not show </span>
<a href="#l27.1063"></a><span id="l27.1063" class="difflineplus">+</span>
<a href="#l27.1064"></a><span id="l27.1064" class="difflineplus">+        // as some tabs do not support session restore they can't be</span>
<a href="#l27.1065"></a><span id="l27.1065" class="difflineplus">+        // moved to a different or new window. We should not show</span>
<a href="#l27.1066"></a><span id="l27.1066">         // a dropmarker in such a case</span>
<a href="#l27.1067"></a><span id="l27.1067">         if (!dt.mozGetDataAt(&quot;application/x-moz-tabmail-json&quot;, 0)) {</span>
<a href="#l27.1068"></a><span id="l27.1068" class="difflineminus">-        </span>
<a href="#l27.1069"></a><span id="l27.1069" class="difflineplus">+</span>
<a href="#l27.1070"></a><span id="l27.1070">           let draggedTab = dt.mozGetDataAt(&quot;application/x-moz-tabmail-tab&quot;, 0);</span>
<a href="#l27.1071"></a><span id="l27.1071" class="difflineminus">-           </span>
<a href="#l27.1072"></a><span id="l27.1072" class="difflineplus">+</span>
<a href="#l27.1073"></a><span id="l27.1073">           if (!draggedTab)</span>
<a href="#l27.1074"></a><span id="l27.1074">             return;</span>
<a href="#l27.1075"></a><span id="l27.1075" class="difflineminus">-          </span>
<a href="#l27.1076"></a><span id="l27.1076" class="difflineplus">+</span>
<a href="#l27.1077"></a><span id="l27.1077">           if (this.tabmail.tabContainer.getIndexOfItem(draggedTab) == -1)</span>
<a href="#l27.1078"></a><span id="l27.1078">             return;</span>
<a href="#l27.1079"></a><span id="l27.1079">         }</span>
<a href="#l27.1080"></a><span id="l27.1080"> </span>
<a href="#l27.1081"></a><span id="l27.1081">         dt.effectAllowed = &quot;copyMove&quot;;</span>
<a href="#l27.1082"></a><span id="l27.1082"> </span>
<a href="#l27.1083"></a><span id="l27.1083">         event.preventDefault();</span>
<a href="#l27.1084"></a><span id="l27.1084">         event.stopPropagation();</span>
<a href="#l27.1085"></a><span id="l27.1085" class="difflineminus">-                </span>
<a href="#l27.1086"></a><span id="l27.1086" class="difflineminus">-        let ltr = (window.getComputedStyle(this, null).direction == &quot;ltr&quot;);        </span>
<a href="#l27.1087"></a><span id="l27.1087" class="difflineplus">+</span>
<a href="#l27.1088"></a><span id="l27.1088" class="difflineplus">+        let ltr = (window.getComputedStyle(this, null).direction == &quot;ltr&quot;);</span>
<a href="#l27.1089"></a><span id="l27.1089">         let ind = this._tabDropIndicator;</span>
<a href="#l27.1090"></a><span id="l27.1090" class="difflineminus">-        </span>
<a href="#l27.1091"></a><span id="l27.1091" class="difflineplus">+</span>
<a href="#l27.1092"></a><span id="l27.1092">         // Let's scroll</span>
<a href="#l27.1093"></a><span id="l27.1093">         if (this.hasAttribute(&quot;overflow&quot;)) {</span>
<a href="#l27.1094"></a><span id="l27.1094" class="difflineminus">-                 </span>
<a href="#l27.1095"></a><span id="l27.1095" class="difflineplus">+</span>
<a href="#l27.1096"></a><span id="l27.1096">           let target = event.originalTarget.getAttribute(&quot;anonid&quot;);</span>
<a href="#l27.1097"></a><span id="l27.1097" class="difflineminus">-                    </span>
<a href="#l27.1098"></a><span id="l27.1098" class="difflineplus">+</span>
<a href="#l27.1099"></a><span id="l27.1099">           let pixelsToScroll = 0;</span>
<a href="#l27.1100"></a><span id="l27.1100" class="difflineminus">-          </span>
<a href="#l27.1101"></a><span id="l27.1101" class="difflineplus">+</span>
<a href="#l27.1102"></a><span id="l27.1102">           if (target == &quot;scrollbutton-up&quot;)</span>
<a href="#l27.1103"></a><span id="l27.1103">             pixelsToScroll = this.mTabstrip.scrollIncrement;</span>
<a href="#l27.1104"></a><span id="l27.1104" class="difflineminus">-            </span>
<a href="#l27.1105"></a><span id="l27.1105" class="difflineplus">+</span>
<a href="#l27.1106"></a><span id="l27.1106">           if (target == &quot;scrollbutton-down&quot;)</span>
<a href="#l27.1107"></a><span id="l27.1107">             pixelsToScroll = this.mTabstrip.scrollIncrement * -1;</span>
<a href="#l27.1108"></a><span id="l27.1108" class="difflineminus">-            </span>
<a href="#l27.1109"></a><span id="l27.1109" class="difflineplus">+</span>
<a href="#l27.1110"></a><span id="l27.1110">           if (ltr)</span>
<a href="#l27.1111"></a><span id="l27.1111">             pixelsToScroll = pixelsToScroll * -1;</span>
<a href="#l27.1112"></a><span id="l27.1112" class="difflineminus">-          </span>
<a href="#l27.1113"></a><span id="l27.1113" class="difflineplus">+</span>
<a href="#l27.1114"></a><span id="l27.1114">           if (pixelsToScroll) {</span>
<a href="#l27.1115"></a><span id="l27.1115">             // Hide Indicator while Scrolling</span>
<a href="#l27.1116"></a><span id="l27.1116">             ind.collapsed = true;</span>
<a href="#l27.1117"></a><span id="l27.1117" class="difflineminus">-            this.mTabstrip.scrollByPixels(pixelsToScroll);            </span>
<a href="#l27.1118"></a><span id="l27.1118" class="difflineplus">+            this.mTabstrip.scrollByPixels(pixelsToScroll);</span>
<a href="#l27.1119"></a><span id="l27.1119">             return;</span>
<a href="#l27.1120"></a><span id="l27.1120">           }</span>
<a href="#l27.1121"></a><span id="l27.1121">         }</span>
<a href="#l27.1122"></a><span id="l27.1122" class="difflineminus">-                                 </span>
<a href="#l27.1123"></a><span id="l27.1123" class="difflineplus">+</span>
<a href="#l27.1124"></a><span id="l27.1124">         let newIndex = this._getDropIndex(event);</span>
<a href="#l27.1125"></a><span id="l27.1125" class="difflineminus">-        </span>
<a href="#l27.1126"></a><span id="l27.1126" class="difflineminus">-        // fix the DropIndex in case it points to tab that can't be closed        </span>
<a href="#l27.1127"></a><span id="l27.1127" class="difflineplus">+</span>
<a href="#l27.1128"></a><span id="l27.1128" class="difflineplus">+        // fix the DropIndex in case it points to tab that can't be closed</span>
<a href="#l27.1129"></a><span id="l27.1129">         let tabInfo = this.tabmail.tabInfo;</span>
<a href="#l27.1130"></a><span id="l27.1130" class="difflineminus">-                </span>
<a href="#l27.1131"></a><span id="l27.1131" class="difflineplus">+</span>
<a href="#l27.1132"></a><span id="l27.1132">         while ((newIndex &lt; tabInfo.length) &amp;&amp; !(tabInfo[newIndex].canClose))</span>
<a href="#l27.1133"></a><span id="l27.1133" class="difflineminus">-          newIndex++;  </span>
<a href="#l27.1134"></a><span id="l27.1134" class="difflineminus">-                </span>
<a href="#l27.1135"></a><span id="l27.1135" class="difflineminus">-                  </span>
<a href="#l27.1136"></a><span id="l27.1136" class="difflineplus">+          newIndex++;</span>
<a href="#l27.1137"></a><span id="l27.1137" class="difflineplus">+</span>
<a href="#l27.1138"></a><span id="l27.1138" class="difflineplus">+</span>
<a href="#l27.1139"></a><span id="l27.1139">         var scrollRect = this.mTabstrip.scrollClientRect;</span>
<a href="#l27.1140"></a><span id="l27.1140">         var rect = this.getBoundingClientRect();</span>
<a href="#l27.1141"></a><span id="l27.1141">         var minMargin = scrollRect.left - rect.left;</span>
<a href="#l27.1142"></a><span id="l27.1142">         var maxMargin = Math.min(minMargin + scrollRect.width,scrollRect.right);</span>
<a href="#l27.1143"></a><span id="l27.1143" class="difflineminus">-         </span>
<a href="#l27.1144"></a><span id="l27.1144" class="difflineplus">+</span>
<a href="#l27.1145"></a><span id="l27.1145">         if (!ltr)</span>
<a href="#l27.1146"></a><span id="l27.1146">           [minMargin, maxMargin] = [this.clientWidth - maxMargin, this.clientWidth - minMargin];</span>
<a href="#l27.1147"></a><span id="l27.1147" class="difflineminus">-           </span>
<a href="#l27.1148"></a><span id="l27.1148" class="difflineplus">+</span>
<a href="#l27.1149"></a><span id="l27.1149">         var newMargin;</span>
<a href="#l27.1150"></a><span id="l27.1150" class="difflineminus">-         </span>
<a href="#l27.1151"></a><span id="l27.1151" class="difflineplus">+</span>
<a href="#l27.1152"></a><span id="l27.1152">         if (newIndex == this.childNodes.length) {</span>
<a href="#l27.1153"></a><span id="l27.1153" class="difflineminus">-                 </span>
<a href="#l27.1154"></a><span id="l27.1154" class="difflineplus">+</span>
<a href="#l27.1155"></a><span id="l27.1155">           let tabRect = this.childNodes[newIndex-1].getBoundingClientRect();</span>
<a href="#l27.1156"></a><span id="l27.1156" class="difflineminus">-                   </span>
<a href="#l27.1157"></a><span id="l27.1157" class="difflineplus">+</span>
<a href="#l27.1158"></a><span id="l27.1158">           if (ltr)</span>
<a href="#l27.1159"></a><span id="l27.1159">             newMargin = tabRect.right - rect.left;</span>
<a href="#l27.1160"></a><span id="l27.1160">           else</span>
<a href="#l27.1161"></a><span id="l27.1161">             newMargin = rect.right - tabRect.left;</span>
<a href="#l27.1162"></a><span id="l27.1162">         }</span>
<a href="#l27.1163"></a><span id="l27.1163">         else  {</span>
<a href="#l27.1164"></a><span id="l27.1164" class="difflineminus">-        </span>
<a href="#l27.1165"></a><span id="l27.1165" class="difflineplus">+</span>
<a href="#l27.1166"></a><span id="l27.1166">           let tabRect = this.childNodes[newIndex].getBoundingClientRect();</span>
<a href="#l27.1167"></a><span id="l27.1167"> </span>
<a href="#l27.1168"></a><span id="l27.1168">           if (ltr)</span>
<a href="#l27.1169"></a><span id="l27.1169">             newMargin = tabRect.left - rect.left;</span>
<a href="#l27.1170"></a><span id="l27.1170">           else</span>
<a href="#l27.1171"></a><span id="l27.1171">             newMargin = rect.right - tabRect.right;</span>
<a href="#l27.1172"></a><span id="l27.1172">         }</span>
<a href="#l27.1173"></a><span id="l27.1173" class="difflineminus">-                         </span>
<a href="#l27.1174"></a><span id="l27.1174" class="difflineplus">+</span>
<a href="#l27.1175"></a><span id="l27.1175">         ind.collapsed = false;</span>
<a href="#l27.1176"></a><span id="l27.1176" class="difflineminus">- </span>
<a href="#l27.1177"></a><span id="l27.1177" class="difflineplus">+</span>
<a href="#l27.1178"></a><span id="l27.1178">         newMargin += ind.clientWidth / 2;</span>
<a href="#l27.1179"></a><span id="l27.1179">         if (!ltr)</span>
<a href="#l27.1180"></a><span id="l27.1180">           newMargin *= -1;</span>
<a href="#l27.1181"></a><span id="l27.1181" class="difflineminus">- </span>
<a href="#l27.1182"></a><span id="l27.1182" class="difflineplus">+</span>
<a href="#l27.1183"></a><span id="l27.1183">         ind.style.MozTransform = &quot;translate(&quot; + Math.round(newMargin) + &quot;px)&quot;;</span>
<a href="#l27.1184"></a><span id="l27.1184">         ind.style.MozMarginStart = (-ind.clientWidth) + &quot;px&quot;;</span>
<a href="#l27.1185"></a><span id="l27.1185">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l27.1186"></a><span id="l27.1186">       &lt;handler event=&quot;drop&quot;&gt;&lt;![CDATA[</span>
<a href="#l27.1187"></a><span id="l27.1187">         let dt = event.dataTransfer;</span>
<a href="#l27.1188"></a><span id="l27.1188" class="difflineminus">-    </span>
<a href="#l27.1189"></a><span id="l27.1189" class="difflineplus">+</span>
<a href="#l27.1190"></a><span id="l27.1190">         if (dt.mozItemCount != 1)</span>
<a href="#l27.1191"></a><span id="l27.1191">           return;</span>
<a href="#l27.1192"></a><span id="l27.1192" class="difflineminus">-        </span>
<a href="#l27.1193"></a><span id="l27.1193" class="difflineplus">+</span>
<a href="#l27.1194"></a><span id="l27.1194"> </span>
<a href="#l27.1195"></a><span id="l27.1195">         /* If we're dragging a toolbar button, let's prepend the tabs toolbar</span>
<a href="#l27.1196"></a><span id="l27.1196">          * with that button, and then bail out.</span>
<a href="#l27.1197"></a><span id="l27.1197">          */</span>
<a href="#l27.1198"></a><span id="l27.1198">         let buttonId = dt.mozGetDataAt(&quot;text/toolbarwrapper-id/messengerWindow&quot;, 0);</span>
<a href="#l27.1199"></a><span id="l27.1199"> </span>
<a href="#l27.1200"></a><span id="l27.1200">         if (buttonId != null) {</span>
<a href="#l27.1201"></a><span id="l27.1201">           event.preventDefault();</span>
<a href="#l27.1202"></a><span id="l27.1202" class="difflineat">@@ -2260,111 +2243,111 @@</span>
<a href="#l27.1203"></a><span id="l27.1203">           else</span>
<a href="#l27.1204"></a><span id="l27.1204">             this.mToolbar.dispatchEvent(evt);</span>
<a href="#l27.1205"></a><span id="l27.1205"> </span>
<a href="#l27.1206"></a><span id="l27.1206">           return;</span>
<a href="#l27.1207"></a><span id="l27.1207">         }</span>
<a href="#l27.1208"></a><span id="l27.1208"> </span>
<a href="#l27.1209"></a><span id="l27.1209"> </span>
<a href="#l27.1210"></a><span id="l27.1210">         let draggedTab = dt.mozGetDataAt(&quot;application/x-moz-tabmail-tab&quot;,0);</span>
<a href="#l27.1211"></a><span id="l27.1211" class="difflineminus">-        </span>
<a href="#l27.1212"></a><span id="l27.1212" class="difflineplus">+</span>
<a href="#l27.1213"></a><span id="l27.1213">         if (!draggedTab)</span>
<a href="#l27.1214"></a><span id="l27.1214">           return;</span>
<a href="#l27.1215"></a><span id="l27.1215" class="difflineminus">-        </span>
<a href="#l27.1216"></a><span id="l27.1216" class="difflineplus">+</span>
<a href="#l27.1217"></a><span id="l27.1217">         event.stopPropagation();        </span>
<a href="#l27.1218"></a><span id="l27.1218">         this._tabDropIndicator.collapsed = true;</span>
<a href="#l27.1219"></a><span id="l27.1219"> </span>
<a href="#l27.1220"></a><span id="l27.1220">         // Is the tab one of our children?</span>
<a href="#l27.1221"></a><span id="l27.1221">         if (this.tabmail.tabContainer.getIndexOfItem(draggedTab) == -1) {</span>
<a href="#l27.1222"></a><span id="l27.1222">         </span>
<a href="#l27.1223"></a><span id="l27.1223">           // It's a tab from an other window, so we have to trigger session</span>
<a href="#l27.1224"></a><span id="l27.1224">           // restore to get our tab</span>
<a href="#l27.1225"></a><span id="l27.1225"> </span>
<a href="#l27.1226"></a><span id="l27.1226" class="difflineminus">-          let tabmail2 = draggedTab.ownerDocument.getElementById(&quot;tabmail&quot;);        </span>
<a href="#l27.1227"></a><span id="l27.1227" class="difflineplus">+          let tabmail2 = draggedTab.ownerDocument.getElementById(&quot;tabmail&quot;);</span>
<a href="#l27.1228"></a><span id="l27.1228">           if (!tabmail2)</span>
<a href="#l27.1229"></a><span id="l27.1229">             return;</span>
<a href="#l27.1230"></a><span id="l27.1230" class="difflineminus">-          </span>
<a href="#l27.1231"></a><span id="l27.1231" class="difflineminus">-          let draggedJson = dt.mozGetDataAt(&quot;application/x-moz-tabmail-json&quot;, 0);                        </span>
<a href="#l27.1232"></a><span id="l27.1232" class="difflineplus">+</span>
<a href="#l27.1233"></a><span id="l27.1233" class="difflineplus">+          let draggedJson = dt.mozGetDataAt(&quot;application/x-moz-tabmail-json&quot;, 0);</span>
<a href="#l27.1234"></a><span id="l27.1234">           if (!draggedJson)</span>
<a href="#l27.1235"></a><span id="l27.1235">             return;</span>
<a href="#l27.1236"></a><span id="l27.1236" class="difflineminus">-        </span>
<a href="#l27.1237"></a><span id="l27.1237" class="difflineplus">+</span>
<a href="#l27.1238"></a><span id="l27.1238">           draggedJson = JSON.parse(draggedJson);</span>
<a href="#l27.1239"></a><span id="l27.1239" class="difflineminus">-          </span>
<a href="#l27.1240"></a><span id="l27.1240" class="difflineplus">+</span>
<a href="#l27.1241"></a><span id="l27.1241">           // Some tab exist only once, so we have to gamble a bit. We close </span>
<a href="#l27.1242"></a><span id="l27.1242">           // the tab and try to reopen it. If something fails the tab is gone.</span>
<a href="#l27.1243"></a><span id="l27.1243" class="difflineminus">- </span>
<a href="#l27.1244"></a><span id="l27.1244" class="difflineplus">+</span>
<a href="#l27.1245"></a><span id="l27.1245">           tabmail2.closeTab(draggedTab,true);</span>
<a href="#l27.1246"></a><span id="l27.1246" class="difflineminus">-          </span>
<a href="#l27.1247"></a><span id="l27.1247" class="difflineplus">+</span>
<a href="#l27.1248"></a><span id="l27.1248">           if (!this.tabmail.restoreTab(draggedJson))</span>
<a href="#l27.1249"></a><span id="l27.1249">             return;</span>
<a href="#l27.1250"></a><span id="l27.1250" class="difflineminus">-                           </span>
<a href="#l27.1251"></a><span id="l27.1251" class="difflineplus">+</span>
<a href="#l27.1252"></a><span id="l27.1252">           draggedTab = this.tabmail.tabContainer.childNodes[</span>
<a href="#l27.1253"></a><span id="l27.1253">             this.tabmail.tabContainer.childNodes.length - 1];</span>
<a href="#l27.1254"></a><span id="l27.1254">         }</span>
<a href="#l27.1255"></a><span id="l27.1255"> </span>
<a href="#l27.1256"></a><span id="l27.1256">         let idx = this._getDropIndex(event);</span>
<a href="#l27.1257"></a><span id="l27.1257" class="difflineminus">-        </span>
<a href="#l27.1258"></a><span id="l27.1258" class="difflineminus">-        // fix the DropIndex in case it points to tab that can't be closed        </span>
<a href="#l27.1259"></a><span id="l27.1259" class="difflineminus">-        let tabInfo = this.tabmail.tabInfo;                </span>
<a href="#l27.1260"></a><span id="l27.1260" class="difflineplus">+</span>
<a href="#l27.1261"></a><span id="l27.1261" class="difflineplus">+        // fix the DropIndex in case it points to tab that can't be closed</span>
<a href="#l27.1262"></a><span id="l27.1262" class="difflineplus">+        let tabInfo = this.tabmail.tabInfo;</span>
<a href="#l27.1263"></a><span id="l27.1263">         while ((idx &lt; tabInfo.length) &amp;&amp; !(tabInfo[idx].canClose))</span>
<a href="#l27.1264"></a><span id="l27.1264" class="difflineminus">-          idx++;  </span>
<a href="#l27.1265"></a><span id="l27.1265" class="difflineminus">-                            </span>
<a href="#l27.1266"></a><span id="l27.1266" class="difflineplus">+          idx++;</span>
<a href="#l27.1267"></a><span id="l27.1267" class="difflineplus">+</span>
<a href="#l27.1268"></a><span id="l27.1268">         this.tabmail.moveTabTo(draggedTab, idx);</span>
<a href="#l27.1269"></a><span id="l27.1269" class="difflineminus">-                  </span>
<a href="#l27.1270"></a><span id="l27.1270" class="difflineplus">+</span>
<a href="#l27.1271"></a><span id="l27.1271">         this.tabmail.switchToTab(draggedTab);</span>
<a href="#l27.1272"></a><span id="l27.1272" class="difflineminus">-        this.tabmail.updateCurrentTab();          </span>
<a href="#l27.1273"></a><span id="l27.1273" class="difflineplus">+        this.tabmail.updateCurrentTab();</span>
<a href="#l27.1274"></a><span id="l27.1274">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l27.1275"></a><span id="l27.1275" class="difflineminus">-      </span>
<a href="#l27.1276"></a><span id="l27.1276" class="difflineplus">+</span>
<a href="#l27.1277"></a><span id="l27.1277">       &lt;handler event=&quot;dragend&quot;&gt;&lt;![CDATA[</span>
<a href="#l27.1278"></a><span id="l27.1278" class="difflineminus">-            </span>
<a href="#l27.1279"></a><span id="l27.1279" class="difflineplus">+</span>
<a href="#l27.1280"></a><span id="l27.1280">         // Note: while this case is correctly handled here, this event</span>
<a href="#l27.1281"></a><span id="l27.1281">         // isn't dispatched when the tab is moved within the tabstrip,</span>
<a href="#l27.1282"></a><span id="l27.1282">         // see bug 460801.</span>
<a href="#l27.1283"></a><span id="l27.1283"> </span>
<a href="#l27.1284"></a><span id="l27.1284">         // the user pressed ESC to cancel the drag, or the drag succeded</span>
<a href="#l27.1285"></a><span id="l27.1285">         var dt = event.dataTransfer;</span>
<a href="#l27.1286"></a><span id="l27.1286">         if ((dt.mozUserCancelled) || (dt.dropEffect != &quot;none&quot;))</span>
<a href="#l27.1287"></a><span id="l27.1287">           return;</span>
<a href="#l27.1288"></a><span id="l27.1288" class="difflineminus">-          </span>
<a href="#l27.1289"></a><span id="l27.1289" class="difflineplus">+</span>
<a href="#l27.1290"></a><span id="l27.1290">         // Disable detach within the browser toolbox</span>
<a href="#l27.1291"></a><span id="l27.1291">         var eX = event.screenX;</span>
<a href="#l27.1292"></a><span id="l27.1292">         var wX = window.screenX;</span>
<a href="#l27.1293"></a><span id="l27.1293" class="difflineminus">-        </span>
<a href="#l27.1294"></a><span id="l27.1294" class="difflineplus">+</span>
<a href="#l27.1295"></a><span id="l27.1295">         // check if the drop point is horizontally within the window</span>
<a href="#l27.1296"></a><span id="l27.1296">         if (eX &gt; wX &amp;&amp; eX &lt; (wX + window.outerWidth)) {</span>
<a href="#l27.1297"></a><span id="l27.1297" class="difflineminus">-        </span>
<a href="#l27.1298"></a><span id="l27.1298" class="difflineplus">+</span>
<a href="#l27.1299"></a><span id="l27.1299">           let bo = this.mTabstrip.boxObject;</span>
<a href="#l27.1300"></a><span id="l27.1300">           // also avoid detaching if the the tab was dropped too close to</span>
<a href="#l27.1301"></a><span id="l27.1301">           // the tabbar (half a tab)</span>
<a href="#l27.1302"></a><span id="l27.1302">           let endScreenY = bo.screenY + 1.5 * bo.height;</span>
<a href="#l27.1303"></a><span id="l27.1303">           let eY = event.screenY;</span>
<a href="#l27.1304"></a><span id="l27.1304" class="difflineminus">-          </span>
<a href="#l27.1305"></a><span id="l27.1305" class="difflineminus">-          if (eY &lt; endScreenY &amp;&amp; eY &gt; window.screenY)        </span>
<a href="#l27.1306"></a><span id="l27.1306" class="difflineplus">+</span>
<a href="#l27.1307"></a><span id="l27.1307" class="difflineplus">+          if (eY &lt; endScreenY &amp;&amp; eY &gt; window.screenY)</span>
<a href="#l27.1308"></a><span id="l27.1308">             return;</span>
<a href="#l27.1309"></a><span id="l27.1309">         }</span>
<a href="#l27.1310"></a><span id="l27.1310"> </span>
<a href="#l27.1311"></a><span id="l27.1311" class="difflineminus">-        // user wants to deatach tab from window...        </span>
<a href="#l27.1312"></a><span id="l27.1312" class="difflineplus">+        // user wants to deatach tab from window...</span>
<a href="#l27.1313"></a><span id="l27.1313">         if (dt.mozItemCount != 1)</span>
<a href="#l27.1314"></a><span id="l27.1314">           return;</span>
<a href="#l27.1315"></a><span id="l27.1315" class="difflineminus">-        </span>
<a href="#l27.1316"></a><span id="l27.1316" class="difflineplus">+</span>
<a href="#l27.1317"></a><span id="l27.1317">         let draggedTab = dt.mozGetDataAt(&quot;application/x-moz-tabmail-tab&quot;,0);</span>
<a href="#l27.1318"></a><span id="l27.1318" class="difflineminus">-        </span>
<a href="#l27.1319"></a><span id="l27.1319" class="difflineplus">+</span>
<a href="#l27.1320"></a><span id="l27.1320">         if (!draggedTab)</span>
<a href="#l27.1321"></a><span id="l27.1321">           return;</span>
<a href="#l27.1322"></a><span id="l27.1322" class="difflineminus">-        </span>
<a href="#l27.1323"></a><span id="l27.1323" class="difflineminus">-        this.tabmail.replaceTabWithWindow(draggedTab);                    </span>
<a href="#l27.1324"></a><span id="l27.1324" class="difflineminus">-                            </span>
<a href="#l27.1325"></a><span id="l27.1325" class="difflineplus">+</span>
<a href="#l27.1326"></a><span id="l27.1326" class="difflineplus">+        this.tabmail.replaceTabWithWindow(draggedTab);</span>
<a href="#l27.1327"></a><span id="l27.1327" class="difflineplus">+</span>
<a href="#l27.1328"></a><span id="l27.1328">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l27.1329"></a><span id="l27.1329" class="difflineminus">-      </span>
<a href="#l27.1330"></a><span id="l27.1330" class="difflineplus">+</span>
<a href="#l27.1331"></a><span id="l27.1331">       &lt;handler event=&quot;dragexit&quot;&gt;&lt;![CDATA[</span>
<a href="#l27.1332"></a><span id="l27.1332">         this._dragTime = 0;</span>
<a href="#l27.1333"></a><span id="l27.1333" class="difflineminus">-        </span>
<a href="#l27.1334"></a><span id="l27.1334" class="difflineminus">-        this._tabDropIndicator.collapsed = true;                </span>
<a href="#l27.1335"></a><span id="l27.1335" class="difflineplus">+</span>
<a href="#l27.1336"></a><span id="l27.1336" class="difflineplus">+        this._tabDropIndicator.collapsed = true;</span>
<a href="#l27.1337"></a><span id="l27.1337">         event.stopPropagation();</span>
<a href="#l27.1338"></a><span id="l27.1338" class="difflineminus">-        </span>
<a href="#l27.1339"></a><span id="l27.1339" class="difflineplus">+</span>
<a href="#l27.1340"></a><span id="l27.1340">       ]]&gt;&lt;/handler&gt;      </span>
<a href="#l27.1341"></a><span id="l27.1341">     &lt;/handlers&gt;</span>
<a href="#l27.1342"></a><span id="l27.1342">   &lt;/binding&gt;</span>
<a href="#l27.1343"></a><span id="l27.1343"> </span>
<a href="#l27.1344"></a><span id="l27.1344">   &lt;binding id=&quot;tabmail-alltabs-popup&quot;</span>
<a href="#l27.1345"></a><span id="l27.1345">            extends=&quot;chrome://global/content/bindings/popup.xml#popup&quot;&gt;</span>
<a href="#l27.1346"></a><span id="l27.1346">     &lt;implementation implements=&quot;nsIDOMEventListener,nsIMutationObserverCallback&quot;&gt;</span>
<a href="#l27.1347"></a><span id="l27.1347">       &lt;field name=&quot;_xulWindow&quot;&gt;</span>
<a href="#l27.1348"></a><span id="l27.1348" class="difflineat">@@ -2373,17 +2356,17 @@</span>
<a href="#l27.1349"></a><span id="l27.1349">       &lt;field name=&quot;_mutationObserver&quot;&gt;</span>
<a href="#l27.1350"></a><span id="l27.1350">         null</span>
<a href="#l27.1351"></a><span id="l27.1351">       &lt;/field&gt;</span>
<a href="#l27.1352"></a><span id="l27.1352"> </span>
<a href="#l27.1353"></a><span id="l27.1353">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l27.1354"></a><span id="l27.1354">         // We cannot cache the XULBrowserWindow object itself since it might</span>
<a href="#l27.1355"></a><span id="l27.1355">         // be set after this binding is constructed.</span>
<a href="#l27.1356"></a><span id="l27.1356">         try {</span>
<a href="#l27.1357"></a><span id="l27.1357" class="difflineminus">-          this._xulWindow = </span>
<a href="#l27.1358"></a><span id="l27.1358" class="difflineplus">+          this._xulWindow =</span>
<a href="#l27.1359"></a><span id="l27.1359">             window.QueryInterface(Components.interfaces.nsIInterfaceRequestor)</span>
<a href="#l27.1360"></a><span id="l27.1360">                   .getInterface(Components.interfaces.nsIWebNavigation)</span>
<a href="#l27.1361"></a><span id="l27.1361">                   .QueryInterface(Components.interfaces.nsIDocShellTreeItem)</span>
<a href="#l27.1362"></a><span id="l27.1362">                   .treeOwner</span>
<a href="#l27.1363"></a><span id="l27.1363">                   .QueryInterface(Components.interfaces.nsIInterfaceRequestor)</span>
<a href="#l27.1364"></a><span id="l27.1364">                   .getInterface(Components.interfaces.nsIXULWindow);</span>
<a href="#l27.1365"></a><span id="l27.1365">         }</span>
<a href="#l27.1366"></a><span id="l27.1366">         catch(ex) { }</span>
<a href="#l27.1367"></a><span id="l27.1367" class="difflineat">@@ -2450,28 +2433,28 @@</span>
<a href="#l27.1368"></a><span id="l27.1368">           if (tabContainer.getAttribute(&quot;overflow&quot;) != &quot;true&quot;)</span>
<a href="#l27.1369"></a><span id="l27.1369">             return;</span>
<a href="#l27.1370"></a><span id="l27.1370"> </span>
<a href="#l27.1371"></a><span id="l27.1371">           var tabstripBO = tabContainer.mTabstrip.scrollBoxObject;</span>
<a href="#l27.1372"></a><span id="l27.1372">           for (var i = 0; i &lt; this.childNodes.length; i++) {</span>
<a href="#l27.1373"></a><span id="l27.1373">             var curTabBO = this.childNodes[i].tab.boxObject;</span>
<a href="#l27.1374"></a><span id="l27.1374">             if (curTabBO.screenX &gt;= tabstripBO.screenX &amp;&amp;</span>
<a href="#l27.1375"></a><span id="l27.1375">                 curTabBO.screenX + curTabBO.width &lt;= tabstripBO.screenX + tabstripBO.width)</span>
<a href="#l27.1376"></a><span id="l27.1376" class="difflineminus">-              this.childNodes[i].setAttribute(&quot;tabIsVisible&quot;, &quot;true&quot;); </span>
<a href="#l27.1377"></a><span id="l27.1377" class="difflineplus">+              this.childNodes[i].setAttribute(&quot;tabIsVisible&quot;, &quot;true&quot;);</span>
<a href="#l27.1378"></a><span id="l27.1378">             else</span>
<a href="#l27.1379"></a><span id="l27.1379">               this.childNodes[i].removeAttribute(&quot;tabIsVisible&quot;);</span>
<a href="#l27.1380"></a><span id="l27.1380">           }</span>
<a href="#l27.1381"></a><span id="l27.1381">         ]]&gt;&lt;/body&gt;</span>
<a href="#l27.1382"></a><span id="l27.1382">       &lt;/method&gt;</span>
<a href="#l27.1383"></a><span id="l27.1383"> </span>
<a href="#l27.1384"></a><span id="l27.1384">       &lt;method name=&quot;_createTabMenuItem&quot;&gt;</span>
<a href="#l27.1385"></a><span id="l27.1385">         &lt;parameter name=&quot;aTab&quot;/&gt;</span>
<a href="#l27.1386"></a><span id="l27.1386">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l27.1387"></a><span id="l27.1387">           var menuItem = document.createElementNS(</span>
<a href="#l27.1388"></a><span id="l27.1388" class="difflineminus">-            &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;, </span>
<a href="#l27.1389"></a><span id="l27.1389" class="difflineplus">+            &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;,</span>
<a href="#l27.1390"></a><span id="l27.1390">             &quot;menuitem&quot;);</span>
<a href="#l27.1391"></a><span id="l27.1391"> </span>
<a href="#l27.1392"></a><span id="l27.1392">           menuItem.setAttribute(&quot;class&quot;, &quot;menuitem-iconic alltabs-item menuitem-with-favicon&quot;);</span>
<a href="#l27.1393"></a><span id="l27.1393"> </span>
<a href="#l27.1394"></a><span id="l27.1394">           this._setMenuitemAttributes(menuItem, aTab);</span>
<a href="#l27.1395"></a><span id="l27.1395"> </span>
<a href="#l27.1396"></a><span id="l27.1396">           // Keep some attributes of the menuitem in sync with its</span>
<a href="#l27.1397"></a><span id="l27.1397">           // corresponding tab (e.g. the tab label)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mail/base/content/threadPane.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mail/base/content/threadPane.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -95,17 +95,17 @@ function HandleColumnClick(columnID)</span>
<a href="#l28.4"></a><span id="l28.4">         dump(&quot;unsupported sort column: &quot; + columnID + &quot; - no custom handler installed. (Error was: &quot; + err + &quot;)\n&quot;);</span>
<a href="#l28.5"></a><span id="l28.5">         return; // bail out</span>
<a href="#l28.6"></a><span id="l28.6">     }</span>
<a href="#l28.7"></a><span id="l28.7">   }</span>
<a href="#l28.8"></a><span id="l28.8"> </span>
<a href="#l28.9"></a><span id="l28.9">   let viewWrapper = gFolderDisplay.view;</span>
<a href="#l28.10"></a><span id="l28.10">   var simpleColumns = false;</span>
<a href="#l28.11"></a><span id="l28.11">   try {</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-    simpleColumns = !pref.getBoolPref(&quot;mailnews.thread_pane_column_unthreads&quot;);</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+    simpleColumns = !Services.prefs.getBoolPref(&quot;mailnews.thread_pane_column_unthreads&quot;);</span>
<a href="#l28.14"></a><span id="l28.14">   }</span>
<a href="#l28.15"></a><span id="l28.15">   catch (ex) {</span>
<a href="#l28.16"></a><span id="l28.16">   }</span>
<a href="#l28.17"></a><span id="l28.17">   if (sortType == &quot;byThread&quot;) {</span>
<a href="#l28.18"></a><span id="l28.18">     if (simpleColumns)</span>
<a href="#l28.19"></a><span id="l28.19">       MsgToggleThreaded();</span>
<a href="#l28.20"></a><span id="l28.20">     else if (viewWrapper.showThreaded)</span>
<a href="#l28.21"></a><span id="l28.21">       MsgReverseSortThreadPane();</span>
<a href="#l28.22"></a><span id="l28.22" class="difflineat">@@ -276,17 +276,17 @@ function ThreadPaneOnLoad()</span>
<a href="#l28.23"></a><span id="l28.23">   tree.addEventListener(&quot;click&quot;,ThreadPaneOnClick,true);</span>
<a href="#l28.24"></a><span id="l28.24"> </span>
<a href="#l28.25"></a><span id="l28.25">   // The mousedown event listener below should only be added in the thread</span>
<a href="#l28.26"></a><span id="l28.26">   // pane of the mailnews 3pane window, not in the advanced search window.</span>
<a href="#l28.27"></a><span id="l28.27">   if(tree.parentNode.id == &quot;searchResultListBox&quot;)</span>
<a href="#l28.28"></a><span id="l28.28">     return;</span>
<a href="#l28.29"></a><span id="l28.29"> </span>
<a href="#l28.30"></a><span id="l28.30">   tree.addEventListener(&quot;mousedown&quot;,TreeOnMouseDown,true);</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineminus">-  let delay = pref.getIntPref(&quot;mailnews.threadpane_select_delay&quot;);</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineplus">+  let delay = Services.prefs.getIntPref(&quot;mailnews.threadpane_select_delay&quot;);</span>
<a href="#l28.33"></a><span id="l28.33">   document.getElementById(&quot;threadTree&quot;)._selectDelay = delay;</span>
<a href="#l28.34"></a><span id="l28.34"> }</span>
<a href="#l28.35"></a><span id="l28.35"> </span>
<a href="#l28.36"></a><span id="l28.36"> function ThreadPaneSelectionChanged()</span>
<a href="#l28.37"></a><span id="l28.37"> {</span>
<a href="#l28.38"></a><span id="l28.38">   UpdateStatusMessageCounts(gFolderDisplay.displayedFolder);</span>
<a href="#l28.39"></a><span id="l28.39">   GetThreadTree().view.selectionChanged();</span>
<a href="#l28.40"></a><span id="l28.40"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mail/base/content/threadPaneColumnPicker.xml</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mail/base/content/threadPaneColumnPicker.xml</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -93,16 +93,18 @@</span>
<a href="#l29.4"></a><span id="l29.4">               }</span>
<a href="#l29.5"></a><span id="l29.5">             }</span>
<a href="#l29.6"></a><span id="l29.6">           ]]&gt;</span>
<a href="#l29.7"></a><span id="l29.7">         &lt;/body&gt;</span>
<a href="#l29.8"></a><span id="l29.8">       &lt;/method&gt;</span>
<a href="#l29.9"></a><span id="l29.9">     &lt;/implementation&gt;</span>
<a href="#l29.10"></a><span id="l29.10">     &lt;handlers&gt;</span>
<a href="#l29.11"></a><span id="l29.11">       &lt;handler event=&quot;command&quot;&gt;&lt;![CDATA[</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineplus">+        Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+</span>
<a href="#l29.14"></a><span id="l29.14">         // Are they clicking on our header to get us to show the column list?</span>
<a href="#l29.15"></a><span id="l29.15">         if (event.originalTarget == this) {</span>
<a href="#l29.16"></a><span id="l29.16">           var popup = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;,</span>
<a href="#l29.17"></a><span id="l29.17">                                                               &quot;popup&quot;);</span>
<a href="#l29.18"></a><span id="l29.18">           this.buildPopup(popup);</span>
<a href="#l29.19"></a><span id="l29.19">           popup.showPopup(this, -1, -1, &quot;popup&quot;, &quot;bottomright&quot;, &quot;topright&quot;);</span>
<a href="#l29.20"></a><span id="l29.20">           return;</span>
<a href="#l29.21"></a><span id="l29.21">         }</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineat">@@ -146,20 +148,17 @@</span>
<a href="#l29.23"></a><span id="l29.23">           parent = parent.parentNode;</span>
<a href="#l29.24"></a><span id="l29.24">         }</span>
<a href="#l29.25"></a><span id="l29.25">         let useChildren = (parent == yesChildrenPopup);</span>
<a href="#l29.26"></a><span id="l29.26"> </span>
<a href="#l29.27"></a><span id="l29.27">         let bundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l29.28"></a><span id="l29.28">         let stringBase = &quot;threadPane.columnPicker.confirmFolder.&quot; +</span>
<a href="#l29.29"></a><span id="l29.29">           (useChildren ? &quot;withChildren.&quot; : &quot;noChildren.&quot;);</span>
<a href="#l29.30"></a><span id="l29.30"> </span>
<a href="#l29.31"></a><span id="l29.31" class="difflineminus">-        let promptService =</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineminus">-          Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineminus">-                    .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineminus">-        let confirmed = promptService.confirm(null,</span>
<a href="#l29.35"></a><span id="l29.35" class="difflineplus">+        let confirmed = Services.prompt.confirm(null,</span>
<a href="#l29.36"></a><span id="l29.36">           bundle.getString(stringBase + &quot;title&quot;),</span>
<a href="#l29.37"></a><span id="l29.37">           bundle.getFormattedString(stringBase + &quot;message&quot;,</span>
<a href="#l29.38"></a><span id="l29.38">                                     [destFolder.prettiestName]));</span>
<a href="#l29.39"></a><span id="l29.39">         if (!confirmed)</span>
<a href="#l29.40"></a><span id="l29.40">           return;</span>
<a href="#l29.41"></a><span id="l29.41"> </span>
<a href="#l29.42"></a><span id="l29.42">         // Get the current folder's column state.</span>
<a href="#l29.43"></a><span id="l29.43">         let propName = gFolderDisplay.PERSISTED_COLUMN_PROPERTY_NAME;</span>
<a href="#l29.44"></a><span id="l29.44" class="difflineat">@@ -167,21 +166,18 @@</span>
<a href="#l29.45"></a><span id="l29.45">           gFolderDisplay.displayedFolder.msgDatabase.dBFolderInfo;</span>
<a href="#l29.46"></a><span id="l29.46">         let columnStateString = dbFolderInfo.getCharProperty(propName);</span>
<a href="#l29.47"></a><span id="l29.47">         // Now propagate appropriately...</span>
<a href="#l29.48"></a><span id="l29.48">         if (useChildren) {</span>
<a href="#l29.49"></a><span id="l29.49">           // Generate an observer notification when we have finished configuring</span>
<a href="#l29.50"></a><span id="l29.50">           // all folders.  This is currently done for the benefit of our mozmill</span>
<a href="#l29.51"></a><span id="l29.51">           // tests.</span>
<a href="#l29.52"></a><span id="l29.52">           function observerCallback() {</span>
<a href="#l29.53"></a><span id="l29.53" class="difflineminus">-            let obsService =</span>
<a href="#l29.54"></a><span id="l29.54" class="difflineminus">-               Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l29.55"></a><span id="l29.55" class="difflineminus">-                         .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l29.56"></a><span id="l29.56" class="difflineminus">-            obsService.notifyObservers(gFolderDisplay.displayedFolder,</span>
<a href="#l29.57"></a><span id="l29.57" class="difflineminus">-                                       &quot;msg-folder-columns-propagated&quot;, &quot;&quot;);</span>
<a href="#l29.58"></a><span id="l29.58" class="difflineplus">+            Services.obs.notifyObservers(gFolderDisplay.displayedFolder,</span>
<a href="#l29.59"></a><span id="l29.59" class="difflineplus">+                                         &quot;msg-folder-columns-propagated&quot;, &quot;&quot;);</span>
<a href="#l29.60"></a><span id="l29.60">           }</span>
<a href="#l29.61"></a><span id="l29.61">           MailUtils.setStringPropertyOnFolderAndDescendents(propName,</span>
<a href="#l29.62"></a><span id="l29.62">                                                             columnStateString,</span>
<a href="#l29.63"></a><span id="l29.63">                                                             destFolder,</span>
<a href="#l29.64"></a><span id="l29.64">                                                             observerCallback);</span>
<a href="#l29.65"></a><span id="l29.65">         }</span>
<a href="#l29.66"></a><span id="l29.66">         else {</span>
<a href="#l29.67"></a><span id="l29.67">           destFolder.setStringProperty(propName, columnStateString);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mail/base/content/utilityOverlay.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mail/base/content/utilityOverlay.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -169,22 +169,17 @@ function togglePaneSplitter(splitterId)</span>
<a href="#l30.4"></a><span id="l30.4"> function openUILink(url, event)</span>
<a href="#l30.5"></a><span id="l30.5"> {</span>
<a href="#l30.6"></a><span id="l30.6">   if (!event.button)</span>
<a href="#l30.7"></a><span id="l30.7">     messenger.launchExternalURL(url);</span>
<a href="#l30.8"></a><span id="l30.8"> }</span>
<a href="#l30.9"></a><span id="l30.9"> </span>
<a href="#l30.10"></a><span id="l30.10"> function openWhatsNew()</span>
<a href="#l30.11"></a><span id="l30.11"> {</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-  let startpage =</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-    Components.classes[&quot;@mozilla.org/toolkit/URLFormatterService;1&quot;]</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineminus">-              .getService(Components.interfaces.nsIURLFormatter)</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineminus">-              .formatURLPref(&quot;mailnews.start_page.override_url&quot;);</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineminus">-</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineminus">-  openContentTab(startpage);</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineplus">+  openContentTab(Services.urlFormatter.formatURLPref(&quot;mailnews.start_page.override_url&quot;));</span>
<a href="#l30.19"></a><span id="l30.19"> }</span>
<a href="#l30.20"></a><span id="l30.20"> </span>
<a href="#l30.21"></a><span id="l30.21"> /**</span>
<a href="#l30.22"></a><span id="l30.22">  * Open the specified tab type (possibly in a new window)</span>
<a href="#l30.23"></a><span id="l30.23">  *</span>
<a href="#l30.24"></a><span id="l30.24">  * @param tabType the tab type to open (e.g. &quot;contentTab&quot;)</span>
<a href="#l30.25"></a><span id="l30.25">  * @param tabParams the parameters to pass to the tab</span>
<a href="#l30.26"></a><span id="l30.26">  * @param where 'tab' to open in a new tab (default) or 'window' to open in a</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mail/components/about-support/content/export.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mail/components/about-support/content/export.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -51,19 +51,17 @@ function getClipboardTransferable() {</span>
<a href="#l31.4"></a><span id="l31.4">   transferable.setTransferData(&quot;text/unicode&quot;, ssText, dataText.length * 2);</span>
<a href="#l31.5"></a><span id="l31.5"> </span>
<a href="#l31.6"></a><span id="l31.6">   return transferable;</span>
<a href="#l31.7"></a><span id="l31.7"> }</span>
<a href="#l31.8"></a><span id="l31.8"> </span>
<a href="#l31.9"></a><span id="l31.9"> function copyToClipboard() {</span>
<a href="#l31.10"></a><span id="l31.10">   let transferable = getClipboardTransferable();</span>
<a href="#l31.11"></a><span id="l31.11">   // Store the data into the clipboard.</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-  let clipboard = Cc[&quot;@mozilla.org/widget/clipboard;1&quot;]</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineminus">-                    .getService(Ci.nsIClipboard);</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineminus">-  clipboard.setData(transferable, null, clipboard.kGlobalClipboard);</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineplus">+  Services.clipboard.setData(transferable, null, Services.clipboard.kGlobalClipboard);</span>
<a href="#l31.16"></a><span id="l31.16"> }</span>
<a href="#l31.17"></a><span id="l31.17"> </span>
<a href="#l31.18"></a><span id="l31.18"> function sendViaEmail() {</span>
<a href="#l31.19"></a><span id="l31.19">   // Get the HTML representation for the important part of the page.</span>
<a href="#l31.20"></a><span id="l31.20">   let hidePrivateData = !document.getElementById(&quot;check-show-private-data&quot;).checked;</span>
<a href="#l31.21"></a><span id="l31.21">   let contentsDiv = createCleanedUpContents(hidePrivateData);</span>
<a href="#l31.22"></a><span id="l31.22">   let dataHtml = contentsDiv.innerHTML;</span>
<a href="#l31.23"></a><span id="l31.23">   // The editor considers whitespace to be significant, so replace all</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mail/components/about-support/content/gfx.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mail/components/about-support/content/gfx.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -1,12 +1,14 @@</span>
<a href="#l32.4"></a><span id="l32.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l32.5"></a><span id="l32.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l32.6"></a><span id="l32.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l32.7"></a><span id="l32.7"> </span>
<a href="#l32.8"></a><span id="l32.8" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l32.9"></a><span id="l32.9" class="difflineplus">+</span>
<a href="#l32.10"></a><span id="l32.10"> function populateGraphicsSection() {</span>
<a href="#l32.11"></a><span id="l32.11">   function createHeader(name)</span>
<a href="#l32.12"></a><span id="l32.12">   {</span>
<a href="#l32.13"></a><span id="l32.13">     let elem = createElement(&quot;th&quot;, name);</span>
<a href="#l32.14"></a><span id="l32.14">     elem.className = &quot;column&quot;;</span>
<a href="#l32.15"></a><span id="l32.15">     return elem;</span>
<a href="#l32.16"></a><span id="l32.16">   }</span>
<a href="#l32.17"></a><span id="l32.17"> </span>
<a href="#l32.18"></a><span id="l32.18" class="difflineat">@@ -100,19 +102,17 @@ function populateGraphicsSection() {</span>
<a href="#l32.19"></a><span id="l32.19">     pushInfoRow(trGraphics, &quot;adapterVendorID2&quot;, gfxInfo.adapterVendorID2);</span>
<a href="#l32.20"></a><span id="l32.20">     pushInfoRow(trGraphics, &quot;adapterDeviceID2&quot;, gfxInfo.adapterDeviceID2);</span>
<a href="#l32.21"></a><span id="l32.21">     pushInfoRow(trGraphics, &quot;adapterRAM2&quot;, gfxInfo.adapterRAM2);</span>
<a href="#l32.22"></a><span id="l32.22">     pushInfoRow(trGraphics, &quot;adapterDrivers2&quot;, gfxInfo.adapterDriver2);</span>
<a href="#l32.23"></a><span id="l32.23">     pushInfoRow(trGraphics, &quot;driverVersion2&quot;, gfxInfo.adapterDriverVersion2);</span>
<a href="#l32.24"></a><span id="l32.24">     pushInfoRow(trGraphics, &quot;driverDate2&quot;, gfxInfo.adapterDriverDate2);</span>
<a href="#l32.25"></a><span id="l32.25">     pushInfoRow(trGraphics, &quot;isGPU2Active&quot;, gfxInfo.isGPU2Active);</span>
<a href="#l32.26"></a><span id="l32.26"> </span>
<a href="#l32.27"></a><span id="l32.27" class="difflineminus">-    var version = Cc[&quot;@mozilla.org/system-info;1&quot;]</span>
<a href="#l32.28"></a><span id="l32.28" class="difflineminus">-                  .getService(Ci.nsIPropertyBag2)</span>
<a href="#l32.29"></a><span id="l32.29" class="difflineminus">-                  .getProperty(&quot;version&quot;);</span>
<a href="#l32.30"></a><span id="l32.30" class="difflineplus">+    var version = Services.sysinfo.getProperty(&quot;version&quot;);</span>
<a href="#l32.31"></a><span id="l32.31">     var isWindowsVistaOrHigher = (parseFloat(version) &gt;= 6.0);</span>
<a href="#l32.32"></a><span id="l32.32">     if (isWindowsVistaOrHigher) {</span>
<a href="#l32.33"></a><span id="l32.33">       var d2dEnabled = &quot;false&quot;;</span>
<a href="#l32.34"></a><span id="l32.34">       try {</span>
<a href="#l32.35"></a><span id="l32.35">         d2dEnabled = gfxInfo.D2DEnabled;</span>
<a href="#l32.36"></a><span id="l32.36">       } catch(e) {}</span>
<a href="#l32.37"></a><span id="l32.37">       pushFeatureInfoRow(trGraphics, &quot;direct2DEnabled&quot;, gfxInfo.FEATURE_DIRECT2D, d2dEnabled);</span>
<a href="#l32.38"></a><span id="l32.38"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mail/components/about-support/content/prefs.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mail/components/about-support/content/prefs.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -1,13 +1,12 @@</span>
<a href="#l33.4"></a><span id="l33.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l33.5"></a><span id="l33.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l33.6"></a><span id="l33.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l33.7"></a><span id="l33.7"> </span>
<a href="#l33.8"></a><span id="l33.8" class="difflineminus">-</span>
<a href="#l33.9"></a><span id="l33.9"> const ELLIPSIS = Services.prefs.getComplexValue(&quot;intl.ellipsis&quot;,</span>
<a href="#l33.10"></a><span id="l33.10">                                                 Ci.nsIPrefLocalizedString).data;</span>
<a href="#l33.11"></a><span id="l33.11"> </span>
<a href="#l33.12"></a><span id="l33.12"> // We use a preferences whitelist to make sure we only show preferences that</span>
<a href="#l33.13"></a><span id="l33.13"> // are useful for support and won't compromise the user's privacy.  Note that</span>
<a href="#l33.14"></a><span id="l33.14"> // entries are *prefixes*: for example, &quot;accessibility.&quot; applies to all prefs</span>
<a href="#l33.15"></a><span id="l33.15"> // under the &quot;accessibility.*&quot; branch.</span>
<a href="#l33.16"></a><span id="l33.16"> const PREFS_WHITELIST = [</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mail/extensions/mailviews/content/mailViewList.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mail/extensions/mailviews/content/mailViewList.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l34.4"></a><span id="l34.4"> /* -*- Mode: Java; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l34.5"></a><span id="l34.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l34.6"></a><span id="l34.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l34.7"></a><span id="l34.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l34.8"></a><span id="l34.8"> </span>
<a href="#l34.9"></a><span id="l34.9" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l34.10"></a><span id="l34.10"> </span>
<a href="#l34.11"></a><span id="l34.11"> var gMailListView; </span>
<a href="#l34.12"></a><span id="l34.12"> var gListBox; </span>
<a href="#l34.13"></a><span id="l34.13"> var gEditButton;</span>
<a href="#l34.14"></a><span id="l34.14"> var gDeleteButton;</span>
<a href="#l34.15"></a><span id="l34.15"> </span>
<a href="#l34.16"></a><span id="l34.16"> function mailViewListOnLoad()</span>
<a href="#l34.17"></a><span id="l34.17"> {</span>
<a href="#l34.18"></a><span id="l34.18" class="difflineat">@@ -41,22 +42,19 @@ function refreshListView(aSelectedMailVi</span>
<a href="#l34.19"></a><span id="l34.19"> </span>
<a href="#l34.20"></a><span id="l34.20"> function onNewMailView()</span>
<a href="#l34.21"></a><span id="l34.21"> {</span>
<a href="#l34.22"></a><span id="l34.22">    window.openDialog('chrome://messenger/content/mailViewSetup.xul', &quot;&quot;, 'centerscreen,resizable,modal,titlebar,chrome', {onOkCallback: refreshListView});</span>
<a href="#l34.23"></a><span id="l34.23"> }</span>
<a href="#l34.24"></a><span id="l34.24"> </span>
<a href="#l34.25"></a><span id="l34.25"> function onDeleteMailView()</span>
<a href="#l34.26"></a><span id="l34.26"> {  </span>
<a href="#l34.27"></a><span id="l34.27" class="difflineminus">-  var strBundleService = Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;].</span>
<a href="#l34.28"></a><span id="l34.28" class="difflineminus">-      getService(Components.interfaces.nsIStringBundleService);</span>
<a href="#l34.29"></a><span id="l34.29" class="difflineminus">-  var bundle = strBundleService.createBundle(&quot;chrome://messenger/locale/messenger.properties&quot;);</span>
<a href="#l34.30"></a><span id="l34.30" class="difflineplus">+  var bundle = Services.strings.createBundle(&quot;chrome://messenger/locale/messenger.properties&quot;);</span>
<a href="#l34.31"></a><span id="l34.31"> </span>
<a href="#l34.32"></a><span id="l34.32" class="difflineminus">-  var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;].getService(Components.interfaces.nsIPromptService);</span>
<a href="#l34.33"></a><span id="l34.33" class="difflineminus">-  if (!promptService.confirm(window, bundle.GetStringFromName(&quot;confirmViewDeleteTitle&quot;), bundle.GetStringFromName(&quot;confirmViewDeleteMessage&quot;)))</span>
<a href="#l34.34"></a><span id="l34.34" class="difflineplus">+  if (!Services.prompt.confirm(window, bundle.GetStringFromName(&quot;confirmViewDeleteTitle&quot;), bundle.GetStringFromName(&quot;confirmViewDeleteMessage&quot;)))</span>
<a href="#l34.35"></a><span id="l34.35">     return;</span>
<a href="#l34.36"></a><span id="l34.36"> </span>
<a href="#l34.37"></a><span id="l34.37">   // get the selected index</span>
<a href="#l34.38"></a><span id="l34.38">   var selectedIndex = gListBox.selectedIndex;</span>
<a href="#l34.39"></a><span id="l34.39">   if (selectedIndex &gt;= 0)</span>
<a href="#l34.40"></a><span id="l34.40">   {</span>
<a href="#l34.41"></a><span id="l34.41">     var mailView = gMailListView.getMailViewAt(selectedIndex);</span>
<a href="#l34.42"></a><span id="l34.42">     if (mailView)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/base/content/junkCommands.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/base/content/junkCommands.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -21,16 +21,17 @@</span>
<a href="#l35.4"></a><span id="l35.4">   *   either gMsgFolderSelected or gFolderDisplay</span>
<a href="#l35.5"></a><span id="l35.5">   *   MsgJunkMailInfo(aCheckFirstUse)</span>
<a href="#l35.6"></a><span id="l35.6">   *   SetNextMessageAfterDelete()</span>
<a href="#l35.7"></a><span id="l35.7">   *   pref</span>
<a href="#l35.8"></a><span id="l35.8">   *   msgWindow</span>
<a href="#l35.9"></a><span id="l35.9">   */</span>
<a href="#l35.10"></a><span id="l35.10"> </span>
<a href="#l35.11"></a><span id="l35.11"> Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l35.13"></a><span id="l35.13"> </span>
<a href="#l35.14"></a><span id="l35.14"> /*</span>
<a href="#l35.15"></a><span id="l35.15">  * determineActionsForJunkMsgs</span>
<a href="#l35.16"></a><span id="l35.16">  *</span>
<a href="#l35.17"></a><span id="l35.17">  * Determines the actions that should be carried out on the messages</span>
<a href="#l35.18"></a><span id="l35.18">  * that are being marked as junk</span>
<a href="#l35.19"></a><span id="l35.19">  *</span>
<a href="#l35.20"></a><span id="l35.20">  * @param aFolder</span>
<a href="#l35.21"></a><span id="l35.21" class="difflineat">@@ -351,17 +352,17 @@ function JunkSelectedMessages(setAsJunk)</span>
<a href="#l35.22"></a><span id="l35.22">   MsgJunkMailInfo(true);</span>
<a href="#l35.23"></a><span id="l35.23"> </span>
<a href="#l35.24"></a><span id="l35.24">   // When the user explicitly marks a message as junk, we can mark it as read,</span>
<a href="#l35.25"></a><span id="l35.25">   // too. This is independent of the &quot;markAsReadOnSpam&quot; pref, which applies</span>
<a href="#l35.26"></a><span id="l35.26">   // only to automatically-classified messages.</span>
<a href="#l35.27"></a><span id="l35.27">   // Note that this behaviour should match the one in the back end for marking</span>
<a href="#l35.28"></a><span id="l35.28">   // as junk via clicking the 'junk' column.</span>
<a href="#l35.29"></a><span id="l35.29"> </span>
<a href="#l35.30"></a><span id="l35.30" class="difflineminus">-  if (setAsJunk &amp;&amp; pref.getBoolPref(&quot;mailnews.ui.junk.manualMarkAsJunkMarksRead&quot;))</span>
<a href="#l35.31"></a><span id="l35.31" class="difflineplus">+  if (setAsJunk &amp;&amp; Services.prefs.getBoolPref(&quot;mailnews.ui.junk.manualMarkAsJunkMarksRead&quot;))</span>
<a href="#l35.32"></a><span id="l35.32">     MarkSelectedMessagesRead(true);</span>
<a href="#l35.33"></a><span id="l35.33"> </span>
<a href="#l35.34"></a><span id="l35.34">   gDBView.doCommand(setAsJunk ? nsMsgViewCommandType.junk</span>
<a href="#l35.35"></a><span id="l35.35">                               : nsMsgViewCommandType.unjunk);</span>
<a href="#l35.36"></a><span id="l35.36"> }</span>
<a href="#l35.37"></a><span id="l35.37"> </span>
<a href="#l35.38"></a><span id="l35.38"> /**</span>
<a href="#l35.39"></a><span id="l35.39">  * Delete junk messages in the current folder. This provides the guarantee that</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

