<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29822:130ee8c869501d5c8743ef7c270d6259966be3ce</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 130ee8c869501d5c8743ef7c270d6259966be3ce" />
<meta property="og:url" content="/comm-central/rev/130ee8c869501d5c8743ef7c270d6259966be3ce" />
<meta property="og:description" content="Bug 1643250 - Update composer OpenPGP settings after switching the sender identity. r=mkmelin,PatrickBrunschwig DONTBUILD" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 130ee8c869501d5c8743ef7c270d6259966be3ce 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/130ee8c869501d5c8743ef7c270d6259966be3ce">shortlog</a> |
<a href="/comm-central/log/130ee8c869501d5c8743ef7c270d6259966be3ce">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/130ee8c869501d5c8743ef7c270d6259966be3ce">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/130ee8c869501d5c8743ef7c270d6259966be3ce">files</a> |
changeset |
<a href="/comm-central/raw-rev/130ee8c869501d5c8743ef7c270d6259966be3ce">raw</a>  | <a href="/comm-central/archive/130ee8c869501d5c8743ef7c270d6259966be3ce.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1643250">Bug 1643250</a> - Update composer OpenPGP settings after switching the sender identity. r=mkmelin,PatrickBrunschwig DONTBUILD
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#75;&#97;&#105;&#32;&#69;&#110;&#103;&#101;&#114;&#116;&#32;&#60;&#107;&#97;&#105;&#101;&#64;&#107;&#117;&#105;&#120;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 06 Jun 2020 01:12:28 +0200</td></tr>

<tr>
 <td>changeset 29822</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/130ee8c869501d5c8743ef7c270d6259966be3ce">130ee8c869501d5c8743ef7c270d6259966be3ce</a></td>
</tr>



<tr>
<td>parent 29821</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/82b5fa7bb05fd380d6711e3ddf0977d5343d124c">82b5fa7bb05fd380d6711e3ddf0977d5343d124c</a>
</td>
</tr>

<tr>
<td>child 29823</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f8d95023913a43a93dd4a5f9f81fc6732aca8da8">f8d95023913a43a93dd4a5f9f81fc6732aca8da8</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=130ee8c869501d5c8743ef7c270d6259966be3ce">17548</a></td></tr>
<tr><td>push user</td><td>kaie@kuix.de</td></tr>
<tr><td>push date</td><td class="date age">Tue, 09 Jun 2020 12:19:36 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@130ee8c86950 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=130ee8c869501d5c8743ef7c270d6259966be3ce">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=130ee8c869501d5c8743ef7c270d6259966be3ce&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=130ee8c869501d5c8743ef7c270d6259966be3ce&newProject=comm-central&newRevision=f02863ab01e3073760c259b14d0fe46e5a148b99&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=130ee8c869501d5c8743ef7c270d6259966be3ce&newProject=comm-central&newRevision=f02863ab01e3073760c259b14d0fe46e5a148b99&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=130ee8c869501d5c8743ef7c270d6259966be3ce&newProject=comm-central&newRevision=f02863ab01e3073760c259b14d0fe46e5a148b99&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a>, <a href="/comm-central/log?rev=reviewer%28PatrickBrunschwig%29&revcount=50">PatrickBrunschwig</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1643250">1643250</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1643250">Bug 1643250</a> - Update composer OpenPGP settings after switching the sender identity. r=mkmelin,PatrickBrunschwig DONTBUILD

Differential Revision: <a href="https://phabricator.services.mozilla.com/D78586">https://phabricator.services.mozilla.com/D78586</a></div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/130ee8c869501d5c8743ef7c270d6259966be3ce/mail/components/compose/content/MsgComposeCommands.js">mail/components/compose/content/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/130ee8c869501d5c8743ef7c270d6259966be3ce/mail/components/compose/content/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/130ee8c869501d5c8743ef7c270d6259966be3ce/mail/components/compose/content/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/130ee8c869501d5c8743ef7c270d6259966be3ce/mail/components/compose/content/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/130ee8c869501d5c8743ef7c270d6259966be3ce/mail/components/compose/content/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/130ee8c869501d5c8743ef7c270d6259966be3ce/mail/components/compose/content/MsgComposeCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/130ee8c869501d5c8743ef7c270d6259966be3ce/mail/extensions/openpgp/content/modules/encryption.jsm">mail/extensions/openpgp/content/modules/encryption.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/130ee8c869501d5c8743ef7c270d6259966be3ce/mail/extensions/openpgp/content/modules/encryption.jsm">file</a> |
<a href="/comm-central/annotate/130ee8c869501d5c8743ef7c270d6259966be3ce/mail/extensions/openpgp/content/modules/encryption.jsm">annotate</a> |
<a href="/comm-central/diff/130ee8c869501d5c8743ef7c270d6259966be3ce/mail/extensions/openpgp/content/modules/encryption.jsm">diff</a> |
<a href="/comm-central/comparison/130ee8c869501d5c8743ef7c270d6259966be3ce/mail/extensions/openpgp/content/modules/encryption.jsm">comparison</a> |
<a href="/comm-central/log/130ee8c869501d5c8743ef7c270d6259966be3ce/mail/extensions/openpgp/content/modules/encryption.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/130ee8c869501d5c8743ef7c270d6259966be3ce/mail/extensions/openpgp/content/strings/enigmail.properties">mail/extensions/openpgp/content/strings/enigmail.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/130ee8c869501d5c8743ef7c270d6259966be3ce/mail/extensions/openpgp/content/strings/enigmail.properties">file</a> |
<a href="/comm-central/annotate/130ee8c869501d5c8743ef7c270d6259966be3ce/mail/extensions/openpgp/content/strings/enigmail.properties">annotate</a> |
<a href="/comm-central/diff/130ee8c869501d5c8743ef7c270d6259966be3ce/mail/extensions/openpgp/content/strings/enigmail.properties">diff</a> |
<a href="/comm-central/comparison/130ee8c869501d5c8743ef7c270d6259966be3ce/mail/extensions/openpgp/content/strings/enigmail.properties">comparison</a> |
<a href="/comm-central/log/130ee8c869501d5c8743ef7c270d6259966be3ce/mail/extensions/openpgp/content/strings/enigmail.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/130ee8c869501d5c8743ef7c270d6259966be3ce/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/130ee8c869501d5c8743ef7c270d6259966be3ce/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">file</a> |
<a href="/comm-central/annotate/130ee8c869501d5c8743ef7c270d6259966be3ce/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">annotate</a> |
<a href="/comm-central/diff/130ee8c869501d5c8743ef7c270d6259966be3ce/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">diff</a> |
<a href="/comm-central/comparison/130ee8c869501d5c8743ef7c270d6259966be3ce/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">comparison</a> |
<a href="/comm-central/log/130ee8c869501d5c8743ef7c270d6259966be3ce/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1759,17 +1759,23 @@ function setSecuritySettings(menu_id) {</span>
<a href="#l1.4"></a><span id="l1.4">     if (!isSmimeSigningConfigured()) {</span>
<a href="#l1.5"></a><span id="l1.5">       disableSig = true;</span>
<a href="#l1.6"></a><span id="l1.6">     }</span>
<a href="#l1.7"></a><span id="l1.7">     if (!isSmimeEncryptionConfigured()) {</span>
<a href="#l1.8"></a><span id="l1.8">       disableEnc = true;</span>
<a href="#l1.9"></a><span id="l1.9">     }</span>
<a href="#l1.10"></a><span id="l1.10">   }</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  enc0Item.disabled = disableEnc;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+  // The radio button to disable encryption is always active.</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+  // This is necessary, even if the current identity doesn't have</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+  // e2ee configured. If the user switches the sender identity of an</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+  // email, we might keep encryption enabled, to not surprise the user.</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+  // This means, we must always allow the user to disable encryption.</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+  enc0Item.disabled = false;</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+</span>
<a href="#l1.20"></a><span id="l1.20">   //enc1Item.disabled = disableEnc;</span>
<a href="#l1.21"></a><span id="l1.21">   enc2Item.disabled = disableEnc;</span>
<a href="#l1.22"></a><span id="l1.22"> </span>
<a href="#l1.23"></a><span id="l1.23">   sigItem.disabled = disableSig;</span>
<a href="#l1.24"></a><span id="l1.24"> </span>
<a href="#l1.25"></a><span id="l1.25">   if (MailConstants.MOZ_OPENPGP) {</span>
<a href="#l1.26"></a><span id="l1.26">     let pgpItem = document.getElementById(&quot;encTech_OpenPGP&quot; + menu_id);</span>
<a href="#l1.27"></a><span id="l1.27">     let smimeItem = document.getElementById(&quot;encTech_SMIME&quot; + menu_id);</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineat">@@ -3720,16 +3726,155 @@ function WizCallback(state) {</span>
<a href="#l1.29"></a><span id="l1.29">   if (state) {</span>
<a href="#l1.30"></a><span id="l1.30">     ComposeStartup(null);</span>
<a href="#l1.31"></a><span id="l1.31">   } else {</span>
<a href="#l1.32"></a><span id="l1.32">     // The account wizard is still closing so we can't close just yet</span>
<a href="#l1.33"></a><span id="l1.33">     setTimeout(MsgComposeCloseWindow, 0);</span>
<a href="#l1.34"></a><span id="l1.34">   }</span>
<a href="#l1.35"></a><span id="l1.35"> }</span>
<a href="#l1.36"></a><span id="l1.36"> </span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+function adjustSignEncryptAfterIdentityChanged(prevId, newId) {</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+  let configuredSMIME =</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+    isSmimeSigningConfigured() || isSmimeEncryptionConfigured();</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+  let configuredOpenPGP = false;</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+  if (MailConstants.MOZ_OPENPGP &amp;&amp; BondOpenPGP.allDependenciesLoaded()) {</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+    configuredOpenPGP = isPgpConfigured();</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+  }</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+  if (!prevId) {</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+    gSelectedTechnologyIsPGP = false;</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+    if (configuredOpenPGP) {</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+      if (!configuredSMIME) {</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+        gSelectedTechnologyIsPGP = true;</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+      } else {</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+        // both are configured</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+        let techPref = gCurrentIdentity.getIntAttribute(&quot;e2etechpref&quot;);</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+        gSelectedTechnologyIsPGP = techPref != 1;</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+        // TODO: if !techPref, we might set another flag, and</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+        // decide dynamically which one to use, based on the</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+        // availability of recipient keys etc.</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+      }</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+    }</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+  }</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+  // If the new identity has only one technology configured,</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+  // which is different than the currently selected technology,</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+  // then switch over to that other technology.</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+  // However, if the new account doesn't have any technology</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+  // configured, then it doesn't really matter, so let's keep what's</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+  // currently selected for consistency (in case the user switches</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+  // the identity again).</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+  else if (gSelectedTechnologyIsPGP &amp;&amp; !configuredOpenPGP &amp;&amp; configuredSMIME) {</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+    gSelectedTechnologyIsPGP = false;</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+  } else if (</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+    !gSelectedTechnologyIsPGP &amp;&amp;</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+    !configuredSMIME &amp;&amp;</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+    configuredOpenPGP</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+  ) {</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+    gSelectedTechnologyIsPGP = true;</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+  }</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+  // Not yet implemented</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+  gOptionalEncryption = false;</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+  gOptionalEncryptionInitial = gOptionalEncryption;</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+  if (!prevId) {</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+    if (configuredOpenPGP || configuredSMIME) {</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+      gSendEncrypted = gCurrentIdentity.getIntAttribute(&quot;encryptionpolicy&quot;) &gt; 0;</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+      gSendSigned = gCurrentIdentity.getBoolAttribute(&quot;sign_mail&quot;);</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+    }</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+    gSendEncryptedInitial = gSendEncrypted;</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+    gSendSignedInitial = gSendSigned;</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+    gAttachMyPublicPGPKeyInitial = gAttachMyPublicPGPKey;</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineplus">+</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineplus">+    // automatic changes after this line</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineplus">+    if (gSendSigned &amp;&amp; gSelectedTechnologyIsPGP) {</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineplus">+      gAttachMyPublicPGPKey = true;</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+    }</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+  } else {</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+    // When switching the Sender identity, use the more secure setting</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+    // for encryption and signing, respectively.</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+    // For encryption, the more secure setting is &quot;enabled&quot;.</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineplus">+    // If the user has had encryption enabled for a message initially,</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineplus">+    // then the user might have seen status in the user interface,</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+    // and might &quot;know and assume&quot; that encryption is enabled.</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+    // We should not surprise the user, and switching to a different</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+    // identity should never automatically disable encryption, even</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+    // if the new identity isn't configured for encryption. The user</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+    // should be required to acknowledge that encryption will no longer</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineplus">+    // be used, by deliberately disabling it.</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+    // If encryption isn't enabled yet, but the new identity asks for</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+    // encryption by default, then enable it.</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineplus">+    if (!gSendEncrypted) {</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+      let newDefaultEncrypted =</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+        gCurrentIdentity.getIntAttribute(&quot;encryptionpolicy&quot;) &gt; 0;</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineplus">+      if (newDefaultEncrypted) {</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+        gSendEncrypted = true;</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+        gSendEncryptedInitial = gSendEncrypted;</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+      }</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineplus">+    }</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+    // For signing, the more secure setting is &quot;disabled&quot; (this is from</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineplus">+    // the sender's perspective - don't add a proof of identity unless</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+    // the user requests it).</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineplus">+</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineplus">+    // Automatically disabling signing is also important from the user</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineplus">+    // interface perspective. If no encryption technology is configured,</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineplus">+    // then the user interface checkbox is disabled in the user</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineplus">+    // interface, so keeping it enabled would have the consequence that</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineplus">+    // the user is unable to disable the setting and consequently unable</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineplus">+    // to send the message.</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineplus">+</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineplus">+    if (gSendSigned) {</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+      let newDefaultSigned = gCurrentIdentity.getBoolAttribute(&quot;sign_mail&quot;);</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineplus">+</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineplus">+      if (!newDefaultSigned) {</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+        gSendSigned = false;</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+        gSendSignedInitial = gSendSigned;</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineplus">+        if (!gUserTouchedAttachMyPubKey) {</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineplus">+          gAttachMyPublicPGPKey = false;</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+        }</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+      }</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+    }</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+  }</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineplus">+</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineplus">+  if (gAttachMyPublicPGPKey &amp;&amp; !configuredOpenPGP) {</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineplus">+    gAttachMyPublicPGPKey = false;</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineplus">+  }</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineplus">+</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineplus">+  // automatic changes after this line</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineplus">+  if (</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+    gEncryptedURIService &amp;&amp;</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+    gEncryptedURIService.isEncrypted(gMsgCompose.originalMsgURI)</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+  ) {</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+    gIsRelatedToEncryptedOriginal = true;</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineplus">+  }</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineplus">+</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineplus">+  if (gIsRelatedToEncryptedOriginal) {</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+    gSendEncrypted = true;</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineplus">+  }</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineplus">+</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineplus">+  if (gSMFields &amp;&amp; !gSelectedTechnologyIsPGP) {</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineplus">+    gSMFields.requireEncryptMessage = gSendEncrypted;</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineplus">+    gSMFields.signMessage = gSendSigned;</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineplus">+  }</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineplus">+</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineplus">+  setEncSigStatusUI();</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineplus">+}</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineplus">+</span>
<a href="#l1.176"></a><span id="l1.176"> function ComposeLoad() {</span>
<a href="#l1.177"></a><span id="l1.177">   let otherHeaders = Services.prefs.getCharPref(</span>
<a href="#l1.178"></a><span id="l1.178">     &quot;mail.compose.other.header&quot;,</span>
<a href="#l1.179"></a><span id="l1.179">     &quot;&quot;</span>
<a href="#l1.180"></a><span id="l1.180">   );</span>
<a href="#l1.181"></a><span id="l1.181"> </span>
<a href="#l1.182"></a><span id="l1.182">   AddMessageComposeOfflineQuitObserver();</span>
<a href="#l1.183"></a><span id="l1.183"> </span>
<a href="#l1.184"></a><span id="l1.184" class="difflineat">@@ -3799,74 +3944,17 @@ function ComposeLoad() {</span>
<a href="#l1.185"></a><span id="l1.185">   gMsgCompose.compFields.composeSecure = null;</span>
<a href="#l1.186"></a><span id="l1.186">   gSMFields = Cc[</span>
<a href="#l1.187"></a><span id="l1.187">     &quot;@mozilla.org/messengercompose/composesecure;1&quot;</span>
<a href="#l1.188"></a><span id="l1.188">   ].createInstance(Ci.nsIMsgComposeSecure);</span>
<a href="#l1.189"></a><span id="l1.189">   if (gSMFields) {</span>
<a href="#l1.190"></a><span id="l1.190">     gMsgCompose.compFields.composeSecure = gSMFields;</span>
<a href="#l1.191"></a><span id="l1.191">   }</span>
<a href="#l1.192"></a><span id="l1.192"> </span>
<a href="#l1.193"></a><span id="l1.193" class="difflineminus">-  let configuredSMIME =</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineminus">-    isSmimeSigningConfigured() || isSmimeEncryptionConfigured();</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineminus">-  let configuredOpenPGP = false;</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineminus">-</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineminus">-  if (MailConstants.MOZ_OPENPGP &amp;&amp; BondOpenPGP.allDependenciesLoaded()) {</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineminus">-    configuredOpenPGP = isPgpConfigured();</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineminus">-  }</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineminus">-</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineminus">-  gSelectedTechnologyIsPGP = false;</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineminus">-</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineminus">-  if (configuredOpenPGP) {</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineminus">-    if (!configuredSMIME) {</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineminus">-      gSelectedTechnologyIsPGP = true;</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineminus">-    } else {</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineminus">-      // both are configured</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineminus">-      let techPref = gCurrentIdentity.getIntAttribute(&quot;e2etechpref&quot;);</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineminus">-      gSelectedTechnologyIsPGP = techPref != 1;</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineminus">-</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineminus">-      // TODO: if !techPref, we might set another flag, and</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineminus">-      // decide dynamically which one to use, based on the</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineminus">-      // availability of recipient keys etc.</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineminus">-    }</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineminus">-  }</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineminus">-</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineminus">-  if (configuredOpenPGP || configuredSMIME) {</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineminus">-    gSendEncrypted = gCurrentIdentity.getIntAttribute(&quot;encryptionpolicy&quot;) &gt; 0;</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineminus">-    gOptionalEncryption = false;</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineminus">-    gSendSigned = gCurrentIdentity.getBoolAttribute(&quot;sign_mail&quot;);</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineminus">-  }</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineminus">-</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineminus">-  gSendSignedInitial = gSendSigned;</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineminus">-  gAttachMyPublicPGPKeyInitial = gAttachMyPublicPGPKey;</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineminus">-  gSendEncryptedInitial = gSendEncrypted;</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineminus">-  gOptionalEncryptionInitial = gOptionalEncryption;</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineminus">-</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineminus">-  // automatic changes after this line</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineminus">-</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineminus">-  if (gSendSigned &amp;&amp; gSelectedTechnologyIsPGP) {</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineminus">-    gAttachMyPublicPGPKey = true;</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineminus">-  }</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineminus">-</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineminus">-  if (</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineminus">-    gEncryptedURIService &amp;&amp;</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineminus">-    gEncryptedURIService.isEncrypted(gMsgCompose.originalMsgURI)</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineminus">-  ) {</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineminus">-    gIsRelatedToEncryptedOriginal = true;</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineminus">-  }</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineminus">-</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineminus">-  if (gIsRelatedToEncryptedOriginal) {</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineminus">-    gSendEncrypted = true;</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineminus">-  }</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineminus">-</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineminus">-  if (gSMFields &amp;&amp; !gSelectedTechnologyIsPGP) {</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineminus">-    gSMFields.requireEncryptMessage = gSendEncrypted;</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineminus">-    gSMFields.signMessage = gSendSigned;</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineminus">-  }</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineminus">-</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineminus">-  setEncSigStatusUI();</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineplus">+  adjustSignEncryptAfterIdentityChanged(null, gCurrentIdentity);</span>
<a href="#l1.252"></a><span id="l1.252"> </span>
<a href="#l1.253"></a><span id="l1.253">   ExtensionParent.apiManager.emit(</span>
<a href="#l1.254"></a><span id="l1.254">     &quot;extension-browser-inserted&quot;,</span>
<a href="#l1.255"></a><span id="l1.255">     GetCurrentEditorElement()</span>
<a href="#l1.256"></a><span id="l1.256">   );</span>
<a href="#l1.257"></a><span id="l1.257"> </span>
<a href="#l1.258"></a><span id="l1.258">   setDefaultHeaderMinHeight();</span>
<a href="#l1.259"></a><span id="l1.259"> }</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineat">@@ -7057,16 +7145,18 @@ function LoadIdentity(startup) {</span>
<a href="#l1.261"></a><span id="l1.261">             .filter(</span>
<a href="#l1.262"></a><span id="l1.262">               x =&gt; !toCcBccAddrs.has(...msgCompFields.splitRecipients(x, true))</span>
<a href="#l1.263"></a><span id="l1.263">             )</span>
<a href="#l1.264"></a><span id="l1.264">             .join(&quot;, &quot;);</span>
<a href="#l1.265"></a><span id="l1.265">           awAddRecipients(msgCompFields, &quot;addr_bcc&quot;, newBcc);</span>
<a href="#l1.266"></a><span id="l1.266">         }</span>
<a href="#l1.267"></a><span id="l1.267">       }</span>
<a href="#l1.268"></a><span id="l1.268"> </span>
<a href="#l1.269"></a><span id="l1.269" class="difflineplus">+      adjustSignEncryptAfterIdentityChanged(prevIdentity, gCurrentIdentity);</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineplus">+</span>
<a href="#l1.271"></a><span id="l1.271">       try {</span>
<a href="#l1.272"></a><span id="l1.272">         gMsgCompose.identity = gCurrentIdentity;</span>
<a href="#l1.273"></a><span id="l1.273">       } catch (ex) {</span>
<a href="#l1.274"></a><span id="l1.274">         dump(&quot;### Cannot change the identity: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l1.275"></a><span id="l1.275">       }</span>
<a href="#l1.276"></a><span id="l1.276"> </span>
<a href="#l1.277"></a><span id="l1.277">       let event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l1.278"></a><span id="l1.278">       event.initEvent(&quot;compose-from-changed&quot;, false, true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/encryption.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/encryption.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -355,16 +355,20 @@ var EnigmailEncryption = {</span>
<a href="#l2.4"></a><span id="l2.4">     );</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6">     let keyList = [];</span>
<a href="#l2.7"></a><span id="l2.7">     let ret = {</span>
<a href="#l2.8"></a><span id="l2.8">       keyId: null,</span>
<a href="#l2.9"></a><span id="l2.9">       errorMsg: null,</span>
<a href="#l2.10"></a><span id="l2.10">     };</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+    if (!fromMailAddr) {</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+      return ret;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+    }</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+</span>
<a href="#l2.16"></a><span id="l2.16">     let sign = !!(sendFlags &amp; EnigmailConstants.SEND_SIGNED);</span>
<a href="#l2.17"></a><span id="l2.17">     let encrypt = !!(sendFlags &amp; EnigmailConstants.SEND_ENCRYPTED);</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19">     if (fromMailAddr.search(/^(0x)?[A-Z0-9]+$/) === 0) {</span>
<a href="#l2.20"></a><span id="l2.20">       // key ID specified</span>
<a href="#l2.21"></a><span id="l2.21">       let key = EnigmailKeyRing.getKeyById(fromMailAddr);</span>
<a href="#l2.22"></a><span id="l2.22">       keyList.push(key);</span>
<a href="#l2.23"></a><span id="l2.23">     } else {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/extensions/openpgp/content/strings/enigmail.properties</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/strings/enigmail.properties</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -628,13 +628,13 @@ importSettings.button.abortImport=&amp;Abort</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5"> cannotUseOwnKeyBecause=Unable to send the message, because there is a problem with your personal key. %S</span>
<a href="#l3.6"></a><span id="l3.6"> cannotEncryptBecauseMissing=Unable to send this message with end-to-end encryption, because there are problems with the keys of the following recipients: %S</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11"> fileToBigToImport=This file is too big. Please don't import a large set of keys at once.</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+cannotSendSigBecauseNoOwnKey=Cannot digitally sign this message, because you haven't yet configured end-to-end encryption for &lt;%S&gt;</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+cannotSendEncBecauseNoOwnKey=Cannot send this message encrypted, because you haven't yet configured end-to-end encryption for &lt;%S&gt;</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18"> confirmPermissiveImport=Import failed. The key you are trying to import might be corrupt or use unknown attributes. Would you like to attempt to import the parts that are correct? This might result in the import of incomplete and unusable keys.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailMsgComposeOverlay.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -171,21 +171,16 @@ Enigmail.msg = {</span>
<a href="#l4.4"></a><span id="l4.4">     Enigmail.msg.composeBodyReady = false;</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6">     // Listen to message sending event</span>
<a href="#l4.7"></a><span id="l4.7">     addEventListener(</span>
<a href="#l4.8"></a><span id="l4.8">       &quot;compose-send-message&quot;,</span>
<a href="#l4.9"></a><span id="l4.9">       Enigmail.msg.sendMessageListener.bind(Enigmail.msg),</span>
<a href="#l4.10"></a><span id="l4.10">       true</span>
<a href="#l4.11"></a><span id="l4.11">     );</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    addEventListener(</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-      &quot;compose-from-changed&quot;,</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-      Enigmail.msg.fromChangedListener.bind(Enigmail.msg),</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-      true</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-    );</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18">     // Relabel SMIME button and menu item</span>
<a href="#l4.19"></a><span id="l4.19">     //var smimeButton = document.getElementById(&quot;button-security&quot;);</span>
<a href="#l4.20"></a><span id="l4.20">     //let toolbar = document.getElementById(&quot;composeToolbar2&quot;);</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22">     /*</span>
<a href="#l4.23"></a><span id="l4.23">     if (smimeButton) {</span>
<a href="#l4.24"></a><span id="l4.24">       smimeButton.setAttribute(&quot;label&quot;, &quot;S/MIME&quot;);</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineat">@@ -378,26 +373,16 @@ Enigmail.msg = {</span>
<a href="#l4.26"></a><span id="l4.26"> </span>
<a href="#l4.27"></a><span id="l4.27">   setIdentityDefaults() {</span>
<a href="#l4.28"></a><span id="l4.28">     EnigmailLog.DEBUG(</span>
<a href="#l4.29"></a><span id="l4.29">       &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.setIdentityDefaults\n&quot;</span>
<a href="#l4.30"></a><span id="l4.30">     );</span>
<a href="#l4.31"></a><span id="l4.31"> </span>
<a href="#l4.32"></a><span id="l4.32">     this.identity = getCurrentIdentity();</span>
<a href="#l4.33"></a><span id="l4.33"> </span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-    if (!Enigmail.msg.isEnigmailEnabledForIdentity()) {</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-      // reset status strings in menu to useful defaults</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-      this.statusEncryptedStr = EnigmailLocale.getString(&quot;encryptNo&quot;);</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-      this.statusSignedStr = EnigmailLocale.getString(&quot;signNo&quot;, [&quot;&quot;]);</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-      //this.statusPGPMimeStr = EnigmailLocale.getString(&quot;pgpmimeNormal&quot;);</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-      //this.statusInlinePGPStr = EnigmailLocale.getString(&quot;inlinePGPNormal&quot;);</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-      //this.statusSMimeStr = EnigmailLocale.getString(&quot;smimeNormal&quot;);</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-      this.statusAttachOwnKey = EnigmailLocale.getString(&quot;attachOwnKeyNo&quot;);</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-    }</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-</span>
<a href="#l4.44"></a><span id="l4.44">     // reset default send settings, unless we have changed them already</span>
<a href="#l4.45"></a><span id="l4.45"> </span>
<a href="#l4.46"></a><span id="l4.46">     // instead of sendModeDirty, use gUserTouched*</span>
<a href="#l4.47"></a><span id="l4.47"> </span>
<a href="#l4.48"></a><span id="l4.48">     /*</span>
<a href="#l4.49"></a><span id="l4.49">     if (!this.sendModeDirty) {</span>
<a href="#l4.50"></a><span id="l4.50">       //this.mimePreferOpenPGP = this.identity.getIntAttribute(&quot;mimePreferOpenPGP&quot;);</span>
<a href="#l4.51"></a><span id="l4.51">       //this.processAccountSpecificDefaultOptions();</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineat">@@ -1216,39 +1201,16 @@ Enigmail.msg = {</span>
<a href="#l4.53"></a><span id="l4.53">     } else {</span>
<a href="#l4.54"></a><span id="l4.54">       this.editorInsertText(&quot; &quot;);</span>
<a href="#l4.55"></a><span id="l4.55">     }</span>
<a href="#l4.56"></a><span id="l4.56"> </span>
<a href="#l4.57"></a><span id="l4.57">     this.editorSelectAll();</span>
<a href="#l4.58"></a><span id="l4.58">     this.editorInsertText(text);</span>
<a href="#l4.59"></a><span id="l4.59">   },</span>
<a href="#l4.60"></a><span id="l4.60"> </span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-  goAccountManager() {</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineminus">-    EnigmailLog.DEBUG(</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineminus">-      &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.goAccountManager:\n&quot;</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineminus">-    );</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineminus">-    EnigmailCore.getService(window);</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-    let currentId = null;</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-    let account = null;</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineminus">-    try {</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineminus">-      currentId = getCurrentIdentity();</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineminus">-      account = EnigmailFuncs.getAccountForIdentity(currentId);</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineminus">-    } catch (ex) {}</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineminus">-    window.openDialog(</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineminus">-      &quot;chrome://openpgp/content/ui/editSingleAccount.xhtml&quot;,</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-      &quot;&quot;,</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-      &quot;dialog,modal,centerscreen&quot;,</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-      {</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-        identity: currentId,</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-        account,</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineminus">-      }</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineminus">-    );</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-    this.setIdentityDefaults();</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-  },</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineminus">-</span>
<a href="#l4.84"></a><span id="l4.84">   /**</span>
<a href="#l4.85"></a><span id="l4.85">    * Determine if Enigmail is enabled for the account</span>
<a href="#l4.86"></a><span id="l4.86">    */</span>
<a href="#l4.87"></a><span id="l4.87"> </span>
<a href="#l4.88"></a><span id="l4.88">   wasEnigmailAddOnInstalled() {</span>
<a href="#l4.89"></a><span id="l4.89">     return EnigmailPrefs.getPref(&quot;configuredVersion&quot;) !== &quot;&quot;;</span>
<a href="#l4.90"></a><span id="l4.90">   },</span>
<a href="#l4.91"></a><span id="l4.91"> </span>
<a href="#l4.92"></a><span id="l4.92" class="difflineat">@@ -1914,17 +1876,17 @@ Enigmail.msg = {</span>
<a href="#l4.93"></a><span id="l4.93">           }</span>
<a href="#l4.94"></a><span id="l4.94">       }</span>
<a href="#l4.95"></a><span id="l4.95">     }</span>
<a href="#l4.96"></a><span id="l4.96"> </span>
<a href="#l4.97"></a><span id="l4.97">     return true;</span>
<a href="#l4.98"></a><span id="l4.98">   },</span>
<a href="#l4.99"></a><span id="l4.99">   */</span>
<a href="#l4.100"></a><span id="l4.100"> </span>
<a href="#l4.101"></a><span id="l4.101" class="difflineminus">-  getEncryptionFlags(msgSendType) {</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+  getEncryptionFlags() {</span>
<a href="#l4.103"></a><span id="l4.103">     let f = 0;</span>
<a href="#l4.104"></a><span id="l4.104"> </span>
<a href="#l4.105"></a><span id="l4.105">     console.debug(</span>
<a href="#l4.106"></a><span id="l4.106">       `in getEncryptionFlags, gSendEncrypted=${gSendEncrypted}, gSendSigned=${gSendSigned}`</span>
<a href="#l4.107"></a><span id="l4.107">     );</span>
<a href="#l4.108"></a><span id="l4.108"> </span>
<a href="#l4.109"></a><span id="l4.109">     if (gSendEncrypted) {</span>
<a href="#l4.110"></a><span id="l4.110">       f |= EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineat">@@ -2199,44 +2161,44 @@ Enigmail.msg = {</span>
<a href="#l4.112"></a><span id="l4.112">     EnigmailLog.DEBUG(</span>
<a href="#l4.113"></a><span id="l4.113">       &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.prepareSecurityInfo: securityInfo = &quot; +</span>
<a href="#l4.114"></a><span id="l4.114">         newSecurityInfo +</span>
<a href="#l4.115"></a><span id="l4.115">         &quot;\n&quot;</span>
<a href="#l4.116"></a><span id="l4.116">     );</span>
<a href="#l4.117"></a><span id="l4.117">     return newSecurityInfo;</span>
<a href="#l4.118"></a><span id="l4.118">   },</span>
<a href="#l4.119"></a><span id="l4.119"> </span>
<a href="#l4.120"></a><span id="l4.120" class="difflineminus">-  async encryptMsg(msgSendType) {</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+  async prepareSendMsg(msgSendType) {</span>
<a href="#l4.122"></a><span id="l4.122">     // msgSendType: value from nsIMsgCompDeliverMode</span>
<a href="#l4.123"></a><span id="l4.123">     EnigmailLog.DEBUG(</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineminus">-      &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.encryptMsg: msgSendType=&quot; +</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+      &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.prepareSendMsg: msgSendType=&quot; +</span>
<a href="#l4.126"></a><span id="l4.126">         msgSendType +</span>
<a href="#l4.127"></a><span id="l4.127">         &quot;, gSendSigned=&quot; +</span>
<a href="#l4.128"></a><span id="l4.128">         gSendSigned +</span>
<a href="#l4.129"></a><span id="l4.129">         &quot;, gSendEncrypted=&quot; +</span>
<a href="#l4.130"></a><span id="l4.130">         gSendEncrypted +</span>
<a href="#l4.131"></a><span id="l4.131">         &quot;\n&quot;</span>
<a href="#l4.132"></a><span id="l4.132">     );</span>
<a href="#l4.133"></a><span id="l4.133"> </span>
<a href="#l4.134"></a><span id="l4.134">     const SIGN = EnigmailConstants.SEND_SIGNED;</span>
<a href="#l4.135"></a><span id="l4.135">     const ENCRYPT = EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l4.136"></a><span id="l4.136">     const DeliverMode = Ci.nsIMsgCompDeliverMode;</span>
<a href="#l4.137"></a><span id="l4.137"> </span>
<a href="#l4.138"></a><span id="l4.138">     var ioService = Services.io;</span>
<a href="#l4.139"></a><span id="l4.139">     // EnigSend: Handle both plain and encrypted messages below</span>
<a href="#l4.140"></a><span id="l4.140">     var isOffline = ioService &amp;&amp; ioService.offline;</span>
<a href="#l4.141"></a><span id="l4.141"> </span>
<a href="#l4.142"></a><span id="l4.142" class="difflineminus">-    let sendFlags = this.getEncryptionFlags(msgSendType);</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+    let sendFlags = this.getEncryptionFlags();</span>
<a href="#l4.144"></a><span id="l4.144"> </span>
<a href="#l4.145"></a><span id="l4.145">     switch (msgSendType) {</span>
<a href="#l4.146"></a><span id="l4.146">       case DeliverMode.SaveAsDraft:</span>
<a href="#l4.147"></a><span id="l4.147">       case DeliverMode.SaveAsTemplate:</span>
<a href="#l4.148"></a><span id="l4.148">       case DeliverMode.AutoSaveAsDraft:</span>
<a href="#l4.149"></a><span id="l4.149">         EnigmailLog.DEBUG(</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineminus">-          &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.encryptMsg: detected save draft\n&quot;</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+          &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.prepareSendMsg: detected save draft\n&quot;</span>
<a href="#l4.152"></a><span id="l4.152">         );</span>
<a href="#l4.153"></a><span id="l4.153"> </span>
<a href="#l4.154"></a><span id="l4.154">         // saving drafts is simpler and works differently than the rest of Enigmail.</span>
<a href="#l4.155"></a><span id="l4.155">         // All rules except account-settings are ignored.</span>
<a href="#l4.156"></a><span id="l4.156">         return this.saveDraftMessage();</span>
<a href="#l4.157"></a><span id="l4.157">     }</span>
<a href="#l4.158"></a><span id="l4.158"> </span>
<a href="#l4.159"></a><span id="l4.159">     this.unsetAdditionalHeader(&quot;x-enigmail-draft-status&quot;);</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineat">@@ -2254,29 +2216,40 @@ Enigmail.msg = {</span>
<a href="#l4.161"></a><span id="l4.161">       var bundle = document.getElementById(&quot;bundle_composeMsgs&quot;);</span>
<a href="#l4.162"></a><span id="l4.162">       EnigmailDialog.alert(window, bundle.getString(&quot;12511&quot;));</span>
<a href="#l4.163"></a><span id="l4.163">       return false;</span>
<a href="#l4.164"></a><span id="l4.164">     }</span>
<a href="#l4.165"></a><span id="l4.165"> </span>
<a href="#l4.166"></a><span id="l4.166">     this.identity = getCurrentIdentity();</span>
<a href="#l4.167"></a><span id="l4.167">     let senderKeyId = this.identity.getUnicharAttribute(&quot;openpgp_key_id&quot;);</span>
<a href="#l4.168"></a><span id="l4.168"> </span>
<a href="#l4.169"></a><span id="l4.169" class="difflineminus">-    let senderKeyUsable = EnigmailEncryption.determineOwnKeyUsability(</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineminus">-      sendFlags,</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineminus">-      senderKeyId</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineminus">-    );</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineminus">-    if (senderKeyUsable.errorMsg) {</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineminus">-      let fullAlert = EnigmailLocale.getString(&quot;cannotUseOwnKeyBecause&quot;, [</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineminus">-        senderKeyUsable.errorMsg,</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineminus">-      ]);</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineminus">-</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+    if ((gSendEncrypted || gSendSigned) &amp;&amp; !senderKeyId) {</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+      let msgId = gSendEncrypted</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineplus">+        ? &quot;cannotSendEncBecauseNoOwnKey&quot;</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+        : &quot;cannotSendSigBecauseNoOwnKey&quot;;</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+      let fullAlert = EnigmailLocale.getString(msgId, [this.identity.email]);</span>
<a href="#l4.183"></a><span id="l4.183">       EnigmailDialog.alert(window, fullAlert);</span>
<a href="#l4.184"></a><span id="l4.184">       return false;</span>
<a href="#l4.185"></a><span id="l4.185">     }</span>
<a href="#l4.186"></a><span id="l4.186"> </span>
<a href="#l4.187"></a><span id="l4.187" class="difflineplus">+    if (senderKeyId) {</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+      let senderKeyUsable = EnigmailEncryption.determineOwnKeyUsability(</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+        sendFlags,</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+        senderKeyId</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineplus">+      );</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineplus">+      if (senderKeyUsable.errorMsg) {</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+        let fullAlert = EnigmailLocale.getString(&quot;cannotUseOwnKeyBecause&quot;, [</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineplus">+          senderKeyUsable.errorMsg,</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+        ]);</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineplus">+</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+        EnigmailDialog.alert(window, fullAlert);</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineplus">+        return false;</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineplus">+      }</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineplus">+    }</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineplus">+</span>
<a href="#l4.202"></a><span id="l4.202">     if (gSendEncrypted) {</span>
<a href="#l4.203"></a><span id="l4.203">       let canEncryptDetails = await this.determineSendFlags();</span>
<a href="#l4.204"></a><span id="l4.204">       if (canEncryptDetails.errArray.length != 0) {</span>
<a href="#l4.205"></a><span id="l4.205">         let isFirst = true;</span>
<a href="#l4.206"></a><span id="l4.206">         let allProblems = &quot;&quot;;</span>
<a href="#l4.207"></a><span id="l4.207">         for (let obj of canEncryptDetails.errArray) {</span>
<a href="#l4.208"></a><span id="l4.208">           if (isFirst) {</span>
<a href="#l4.209"></a><span id="l4.209">             isFirst = false;</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineat">@@ -2344,16 +2317,25 @@ Enigmail.msg = {</span>
<a href="#l4.211"></a><span id="l4.211">       /*</span>
<a href="#l4.212"></a><span id="l4.212">       if (!this.checkProtectHeaders(sendFlags)) {</span>
<a href="#l4.213"></a><span id="l4.213">         return false;</span>
<a href="#l4.214"></a><span id="l4.214">       }</span>
<a href="#l4.215"></a><span id="l4.215">       */</span>
<a href="#l4.216"></a><span id="l4.216"> </span>
<a href="#l4.217"></a><span id="l4.217">       // ----------------------- Rewrapping code, taken from function &quot;encryptInline&quot;</span>
<a href="#l4.218"></a><span id="l4.218"> </span>
<a href="#l4.219"></a><span id="l4.219" class="difflineplus">+      if (sendFlags &amp; ENCRYPT &amp;&amp; !usingPGPMime) {</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineplus">+        throw new Error(&quot;Sending encrypted inline not supported!&quot;);</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineplus">+      }</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineplus">+      if (sendFlags &amp; SIGN &amp;&amp; !usingPGPMime &amp;&amp; gMsgCompose.composeHTML) {</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineplus">+        throw new Error(</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineplus">+          &quot;Sending signed inline only supported for plain text composition!&quot;</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineplus">+        );</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineplus">+      }</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineplus">+</span>
<a href="#l4.228"></a><span id="l4.228">       // Check wrapping, if sign only and inline and plaintext</span>
<a href="#l4.229"></a><span id="l4.229">       if (</span>
<a href="#l4.230"></a><span id="l4.230">         sendFlags &amp; SIGN &amp;&amp;</span>
<a href="#l4.231"></a><span id="l4.231">         !(sendFlags &amp; ENCRYPT) &amp;&amp;</span>
<a href="#l4.232"></a><span id="l4.232">         !usingPGPMime &amp;&amp;</span>
<a href="#l4.233"></a><span id="l4.233">         !gMsgCompose.composeHTML</span>
<a href="#l4.234"></a><span id="l4.234">       ) {</span>
<a href="#l4.235"></a><span id="l4.235">         var wrapresultObj = {};</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineat">@@ -2393,17 +2375,17 @@ Enigmail.msg = {</span>
<a href="#l4.237"></a><span id="l4.237">           sendFlags,</span>
<a href="#l4.238"></a><span id="l4.238">           fromAddr: rcpt.fromAddr,</span>
<a href="#l4.239"></a><span id="l4.239">           toAddr: toAddrStr,</span>
<a href="#l4.240"></a><span id="l4.240">           bccAddr: bccAddrStr,</span>
<a href="#l4.241"></a><span id="l4.241">           uiFlags,</span>
<a href="#l4.242"></a><span id="l4.242">           bucketList: document.getElementById(&quot;attachmentBucket&quot;),</span>
<a href="#l4.243"></a><span id="l4.243">         };</span>
<a href="#l4.244"></a><span id="l4.244"> </span>
<a href="#l4.245"></a><span id="l4.245" class="difflineminus">-        if (!this.encryptInline(sendInfo)) {</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineplus">+        if (!this.signInline(sendInfo)) {</span>
<a href="#l4.247"></a><span id="l4.247">           return false;</span>
<a href="#l4.248"></a><span id="l4.248">         }</span>
<a href="#l4.249"></a><span id="l4.249">       }</span>
<a href="#l4.250"></a><span id="l4.250"> </span>
<a href="#l4.251"></a><span id="l4.251">       // update the list of attachments</span>
<a href="#l4.252"></a><span id="l4.252">       Attachments2CompFields(msgCompFields);</span>
<a href="#l4.253"></a><span id="l4.253"> </span>
<a href="#l4.254"></a><span id="l4.254">       if (</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineat">@@ -2422,27 +2404,27 @@ Enigmail.msg = {</span>
<a href="#l4.256"></a><span id="l4.256">           (usingPGPMime &amp;&amp; sendFlags &amp; (ENCRYPT | SIGN)) ||</span>
<a href="#l4.257"></a><span id="l4.257">           (!usingPGPMime &amp;&amp; sendFlags &amp; ENCRYPT)</span>
<a href="#l4.258"></a><span id="l4.258">         ) {</span>
<a href="#l4.259"></a><span id="l4.259">           try {</span>
<a href="#l4.260"></a><span id="l4.260">             // make sure plaintext is not changed to 7bit</span>
<a href="#l4.261"></a><span id="l4.261">             if (typeof msgCompFields.forceMsgEncoding == &quot;boolean&quot;) {</span>
<a href="#l4.262"></a><span id="l4.262">               msgCompFields.forceMsgEncoding = true;</span>
<a href="#l4.263"></a><span id="l4.263">               EnigmailLog.DEBUG(</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineminus">-                &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.encryptMsg: enabled forceMsgEncoding\n&quot;</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineplus">+                &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.prepareSendMsg: enabled forceMsgEncoding\n&quot;</span>
<a href="#l4.266"></a><span id="l4.266">               );</span>
<a href="#l4.267"></a><span id="l4.267">             }</span>
<a href="#l4.268"></a><span id="l4.268">           } catch (ex) {</span>
<a href="#l4.269"></a><span id="l4.269">             console.debug(ex);</span>
<a href="#l4.270"></a><span id="l4.270">           }</span>
<a href="#l4.271"></a><span id="l4.271">         }</span>
<a href="#l4.272"></a><span id="l4.272">       }</span>
<a href="#l4.273"></a><span id="l4.273">     } catch (ex) {</span>
<a href="#l4.274"></a><span id="l4.274">       EnigmailLog.writeException(</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineminus">-        &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.encryptMsg&quot;,</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineplus">+        &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.prepareSendMsg&quot;,</span>
<a href="#l4.277"></a><span id="l4.277">         ex</span>
<a href="#l4.278"></a><span id="l4.278">       );</span>
<a href="#l4.279"></a><span id="l4.279">       return false;</span>
<a href="#l4.280"></a><span id="l4.280">     }</span>
<a href="#l4.281"></a><span id="l4.281"> </span>
<a href="#l4.282"></a><span id="l4.282">     // The encryption process for PGP/MIME messages follows &quot;here&quot;. It's</span>
<a href="#l4.283"></a><span id="l4.283">     // called automatically from nsMsgCompose-&gt;sendMsg().</span>
<a href="#l4.284"></a><span id="l4.284">     // registration for this is done in core.jsm: startup()</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineat">@@ -2488,53 +2470,37 @@ Enigmail.msg = {</span>
<a href="#l4.286"></a><span id="l4.286">         this.displayProtectHeadersStatus();</span>
<a href="#l4.287"></a><span id="l4.287">       }</span>
<a href="#l4.288"></a><span id="l4.288">     }</span>
<a href="#l4.289"></a><span id="l4.289"> </span>
<a href="#l4.290"></a><span id="l4.290">     return true;</span>
<a href="#l4.291"></a><span id="l4.291">   },</span>
<a href="#l4.292"></a><span id="l4.292">   */</span>
<a href="#l4.293"></a><span id="l4.293"> </span>
<a href="#l4.294"></a><span id="l4.294" class="difflineminus">-  encryptInline(sendInfo) {</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineminus">-    // sign/encrypt message using inline-PGP</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineplus">+  signInline(sendInfo) {</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineplus">+    // sign message using inline-PGP</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineplus">+</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineplus">+    if (sendInfo.sendFlags &amp; ENCRYPT) {</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineplus">+      throw new Error(&quot;Encryption not supported in inline messages!&quot;);</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineplus">+    }</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineplus">+    if (gMsgCompose.composeHTML) {</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineplus">+      throw new Error(</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineplus">+        &quot;Signing inline only supported for plain text composition!&quot;</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineplus">+      );</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineplus">+    }</span>
<a href="#l4.307"></a><span id="l4.307"> </span>
<a href="#l4.308"></a><span id="l4.308">     const dce = Ci.nsIDocumentEncoder;</span>
<a href="#l4.309"></a><span id="l4.309">     const SIGN = EnigmailConstants.SEND_SIGNED;</span>
<a href="#l4.310"></a><span id="l4.310">     const ENCRYPT = EnigmailConstants.SEND_ENCRYPTED;</span>
<a href="#l4.311"></a><span id="l4.311"> </span>
<a href="#l4.312"></a><span id="l4.312">     var enigmailSvc = EnigmailCore.getService(window);</span>
<a href="#l4.313"></a><span id="l4.313">     if (!enigmailSvc) {</span>
<a href="#l4.314"></a><span id="l4.314">       return false;</span>
<a href="#l4.315"></a><span id="l4.315">     }</span>
<a href="#l4.316"></a><span id="l4.316"> </span>
<a href="#l4.317"></a><span id="l4.317" class="difflineminus">-    if (gMsgCompose.composeHTML) {</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineminus">-      var errMsg = EnigmailLocale.getString(&quot;hasHTML&quot;);</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineminus">-      EnigmailDialog.alertCount(window, &quot;composeHtmlAlertCount&quot;, errMsg);</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineminus">-    }</span>
<a href="#l4.321"></a><span id="l4.321" class="difflineminus">-</span>
<a href="#l4.322"></a><span id="l4.322" class="difflineminus">-    try {</span>
<a href="#l4.323"></a><span id="l4.323" class="difflineminus">-      var convert = DetermineConvertibility();</span>
<a href="#l4.324"></a><span id="l4.324" class="difflineminus">-      if (convert == Ci.nsIMsgCompConvertible.No) {</span>
<a href="#l4.325"></a><span id="l4.325" class="difflineminus">-        if (</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineminus">-          !EnigmailDialog.confirmDlg(</span>
<a href="#l4.327"></a><span id="l4.327" class="difflineminus">-            window,</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineminus">-            EnigmailLocale.getString(&quot;strippingHTML&quot;),</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineminus">-            EnigmailLocale.getString(&quot;msgCompose.button.sendAnyway&quot;)</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineminus">-          )</span>
<a href="#l4.331"></a><span id="l4.331" class="difflineminus">-        ) {</span>
<a href="#l4.332"></a><span id="l4.332" class="difflineminus">-          return false;</span>
<a href="#l4.333"></a><span id="l4.333" class="difflineminus">-        }</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineminus">-      }</span>
<a href="#l4.335"></a><span id="l4.335" class="difflineminus">-    } catch (ex) {</span>
<a href="#l4.336"></a><span id="l4.336" class="difflineminus">-      EnigmailLog.writeException(</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineminus">-        &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.encryptInline&quot;,</span>
<a href="#l4.338"></a><span id="l4.338" class="difflineminus">-        ex</span>
<a href="#l4.339"></a><span id="l4.339" class="difflineminus">-      );</span>
<a href="#l4.340"></a><span id="l4.340" class="difflineminus">-    }</span>
<a href="#l4.341"></a><span id="l4.341" class="difflineminus">-</span>
<a href="#l4.342"></a><span id="l4.342">     try {</span>
<a href="#l4.343"></a><span id="l4.343">       if (this.getMailPref(&quot;mail.strictly_mime&quot;)) {</span>
<a href="#l4.344"></a><span id="l4.344">         if (</span>
<a href="#l4.345"></a><span id="l4.345">           EnigmailDialog.confirmPref(</span>
<a href="#l4.346"></a><span id="l4.346">             window,</span>
<a href="#l4.347"></a><span id="l4.347">             EnigmailLocale.getString(&quot;quotedPrintableWarn&quot;),</span>
<a href="#l4.348"></a><span id="l4.348">             &quot;quotedPrintableWarn&quot;</span>
<a href="#l4.349"></a><span id="l4.349">           )</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineat">@@ -2547,51 +2513,17 @@ Enigmail.msg = {</span>
<a href="#l4.351"></a><span id="l4.351">     var sendFlowed;</span>
<a href="#l4.352"></a><span id="l4.352">     try {</span>
<a href="#l4.353"></a><span id="l4.353">       sendFlowed = this.getMailPref(&quot;mailnews.send_plaintext_flowed&quot;);</span>
<a href="#l4.354"></a><span id="l4.354">     } catch (ex) {</span>
<a href="#l4.355"></a><span id="l4.355">       sendFlowed = true;</span>
<a href="#l4.356"></a><span id="l4.356">     }</span>
<a href="#l4.357"></a><span id="l4.357">     var encoderFlags = dce.OutputFormatted | dce.OutputLFLineBreak;</span>
<a href="#l4.358"></a><span id="l4.358"> </span>
<a href="#l4.359"></a><span id="l4.359" class="difflineminus">-    var editor = gMsgCompose.editor.QueryInterface(Ci.nsIEditorMailSupport);</span>
<a href="#l4.360"></a><span id="l4.360" class="difflineminus">-    var wrapWidth = 72;</span>
<a href="#l4.361"></a><span id="l4.361" class="difflineminus">-</span>
<a href="#l4.362"></a><span id="l4.362" class="difflineminus">-    if (!(sendInfo.sendFlags &amp; ENCRYPT)) {</span>
<a href="#l4.363"></a><span id="l4.363" class="difflineminus">-      // signed messages only</span>
<a href="#l4.364"></a><span id="l4.364" class="difflineminus">-      if (gMsgCompose.composeHTML) {</span>
<a href="#l4.365"></a><span id="l4.365" class="difflineminus">-        // enforce line wrapping here</span>
<a href="#l4.366"></a><span id="l4.366" class="difflineminus">-        // otherwise the message isn't signed correctly</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineminus">-        try {</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineminus">-          wrapWidth = this.getMailPref(&quot;editor.htmlWrapColumn&quot;);</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineminus">-</span>
<a href="#l4.370"></a><span id="l4.370" class="difflineminus">-          if (wrapWidth &gt; 0 &amp;&amp; wrapWidth &lt; 68 &amp;&amp; gMsgCompose.wrapLength &gt; 0) {</span>
<a href="#l4.371"></a><span id="l4.371" class="difflineminus">-            if (</span>
<a href="#l4.372"></a><span id="l4.372" class="difflineminus">-              EnigmailDialog.confirmDlg(</span>
<a href="#l4.373"></a><span id="l4.373" class="difflineminus">-                window,</span>
<a href="#l4.374"></a><span id="l4.374" class="difflineminus">-                EnigmailLocale.getString(&quot;minimalLineWrapping&quot;, [wrapWidth])</span>
<a href="#l4.375"></a><span id="l4.375" class="difflineminus">-              )</span>
<a href="#l4.376"></a><span id="l4.376" class="difflineminus">-            ) {</span>
<a href="#l4.377"></a><span id="l4.377" class="difflineminus">-              EnigmailPrefs.getPrefRoot().setIntPref(</span>
<a href="#l4.378"></a><span id="l4.378" class="difflineminus">-                &quot;editor.htmlWrapColumn&quot;,</span>
<a href="#l4.379"></a><span id="l4.379" class="difflineminus">-                68</span>
<a href="#l4.380"></a><span id="l4.380" class="difflineminus">-              );</span>
<a href="#l4.381"></a><span id="l4.381" class="difflineminus">-            }</span>
<a href="#l4.382"></a><span id="l4.382" class="difflineminus">-          }</span>
<a href="#l4.383"></a><span id="l4.383" class="difflineminus">-          if (EnigmailPrefs.getPref(&quot;wrapHtmlBeforeSend&quot;)) {</span>
<a href="#l4.384"></a><span id="l4.384" class="difflineminus">-            if (wrapWidth) {</span>
<a href="#l4.385"></a><span id="l4.385" class="difflineminus">-              editor.wrapWidth = wrapWidth - 2; // prepare for the worst case: a 72 char's long line starting with '-'</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineminus">-              editor.rewrap(false);</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineminus">-            }</span>
<a href="#l4.388"></a><span id="l4.388" class="difflineminus">-          }</span>
<a href="#l4.389"></a><span id="l4.389" class="difflineminus">-        } catch (ex) {}</span>
<a href="#l4.390"></a><span id="l4.390" class="difflineminus">-      } else {</span>
<a href="#l4.391"></a><span id="l4.391" class="difflineminus">-        // plaintext: Wrapping code has been moved to superordinate function encryptMsg to enable interactive format switch</span>
<a href="#l4.392"></a><span id="l4.392" class="difflineminus">-      }</span>
<a href="#l4.393"></a><span id="l4.393" class="difflineminus">-    }</span>
<a href="#l4.394"></a><span id="l4.394" class="difflineplus">+    // plaintext: Wrapping code has been moved to superordinate function prepareSendMsg to enable interactive format switch</span>
<a href="#l4.395"></a><span id="l4.395"> </span>
<a href="#l4.396"></a><span id="l4.396">     var exitCodeObj = {};</span>
<a href="#l4.397"></a><span id="l4.397">     var statusFlagsObj = {};</span>
<a href="#l4.398"></a><span id="l4.398">     var errorMsgObj = {};</span>
<a href="#l4.399"></a><span id="l4.399">     var exitCode;</span>
<a href="#l4.400"></a><span id="l4.400"> </span>
<a href="#l4.401"></a><span id="l4.401">     // Get plain text</span>
<a href="#l4.402"></a><span id="l4.402">     // (Do we need to set the nsIDocumentEncoder.* flags?)</span>
<a href="#l4.403"></a><span id="l4.403" class="difflineat">@@ -2600,17 +2532,17 @@ Enigmail.msg = {</span>
<a href="#l4.404"></a><span id="l4.404">       origText = &quot;&quot;;</span>
<a href="#l4.405"></a><span id="l4.405">     }</span>
<a href="#l4.406"></a><span id="l4.406"> </span>
<a href="#l4.407"></a><span id="l4.407">     if (origText.length &gt; 0) {</span>
<a href="#l4.408"></a><span id="l4.408">       // Sign/encrypt body text</span>
<a href="#l4.409"></a><span id="l4.409"> </span>
<a href="#l4.410"></a><span id="l4.410">       var escText = origText; // Copy plain text for possible escaping</span>
<a href="#l4.411"></a><span id="l4.411"> </span>
<a href="#l4.412"></a><span id="l4.412" class="difflineminus">-      if (sendFlowed &amp;&amp; !(sendInfo.sendFlags &amp; ENCRYPT)) {</span>
<a href="#l4.413"></a><span id="l4.413" class="difflineplus">+      if (sendFlowed) {</span>
<a href="#l4.414"></a><span id="l4.414">         // Prevent space stuffing a la RFC 2646 (format=flowed).</span>
<a href="#l4.415"></a><span id="l4.415"> </span>
<a href="#l4.416"></a><span id="l4.416">         //EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: escText[&quot;+encoderFlags+&quot;] = '&quot;+escText+&quot;'\n&quot;);</span>
<a href="#l4.417"></a><span id="l4.417"> </span>
<a href="#l4.418"></a><span id="l4.418">         escText = escText.replace(/^From /gm, &quot;~From &quot;);</span>
<a href="#l4.419"></a><span id="l4.419">         escText = escText.replace(/^&gt;/gm, &quot;|&quot;);</span>
<a href="#l4.420"></a><span id="l4.420">         escText = escText.replace(/^[ \t]+$/gm, &quot;&quot;);</span>
<a href="#l4.421"></a><span id="l4.421">         escText = escText.replace(/^ /gm, &quot;~ &quot;);</span>
<a href="#l4.422"></a><span id="l4.422" class="difflineat">@@ -2624,30 +2556,27 @@ Enigmail.msg = {</span>
<a href="#l4.423"></a><span id="l4.423"> </span>
<a href="#l4.424"></a><span id="l4.424">       // Replace plain text and get it again (to avoid linewrapping problems)</span>
<a href="#l4.425"></a><span id="l4.425">       this.replaceEditorText(escText);</span>
<a href="#l4.426"></a><span id="l4.426"> </span>
<a href="#l4.427"></a><span id="l4.427">       escText = this.editorGetContentAs(&quot;text/plain&quot;, encoderFlags);</span>
<a href="#l4.428"></a><span id="l4.428"> </span>
<a href="#l4.429"></a><span id="l4.429">       //EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: escText[&quot;+encoderFlags+&quot;] = '&quot;+escText+&quot;'\n&quot;);</span>
<a href="#l4.430"></a><span id="l4.430"> </span>
<a href="#l4.431"></a><span id="l4.431" class="difflineminus">-      // Encrypt plaintext</span>
<a href="#l4.432"></a><span id="l4.432">       var charset = this.editorGetCharset();</span>
<a href="#l4.433"></a><span id="l4.433">       EnigmailLog.DEBUG(</span>
<a href="#l4.434"></a><span id="l4.434" class="difflineminus">-        &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.encryptMsg: charset=&quot; +</span>
<a href="#l4.435"></a><span id="l4.435" class="difflineplus">+        &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.signInline: charset=&quot; +</span>
<a href="#l4.436"></a><span id="l4.436">           charset +</span>
<a href="#l4.437"></a><span id="l4.437">           &quot;\n&quot;</span>
<a href="#l4.438"></a><span id="l4.438">       );</span>
<a href="#l4.439"></a><span id="l4.439"> </span>
<a href="#l4.440"></a><span id="l4.440">       // Encode plaintext to charset from unicode</span>
<a href="#l4.441"></a><span id="l4.441" class="difflineminus">-      var plainText =</span>
<a href="#l4.442"></a><span id="l4.442" class="difflineminus">-        sendInfo.sendFlags &amp; ENCRYPT</span>
<a href="#l4.443"></a><span id="l4.443" class="difflineminus">-          ? EnigmailData.convertFromUnicode(origText, charset)</span>
<a href="#l4.444"></a><span id="l4.444" class="difflineminus">-          : EnigmailData.convertFromUnicode(escText, charset);</span>
<a href="#l4.445"></a><span id="l4.445" class="difflineminus">-</span>
<a href="#l4.446"></a><span id="l4.446" class="difflineplus">+      var plainText = EnigmailData.convertFromUnicode(escText, charset);</span>
<a href="#l4.447"></a><span id="l4.447" class="difflineplus">+</span>
<a href="#l4.448"></a><span id="l4.448" class="difflineplus">+      // this will sign, not encrypt</span>
<a href="#l4.449"></a><span id="l4.449">       var cipherText = EnigmailEncryption.encryptMessage(</span>
<a href="#l4.450"></a><span id="l4.450">         window,</span>
<a href="#l4.451"></a><span id="l4.451">         sendInfo.uiFlags,</span>
<a href="#l4.452"></a><span id="l4.452">         plainText,</span>
<a href="#l4.453"></a><span id="l4.453">         sendInfo.fromAddr,</span>
<a href="#l4.454"></a><span id="l4.454">         sendInfo.toAddr,</span>
<a href="#l4.455"></a><span id="l4.455">         sendInfo.bccAddr,</span>
<a href="#l4.456"></a><span id="l4.456">         sendInfo.sendFlags,</span>
<a href="#l4.457"></a><span id="l4.457" class="difflineat">@@ -2657,52 +2586,33 @@ Enigmail.msg = {</span>
<a href="#l4.458"></a><span id="l4.458">       );</span>
<a href="#l4.459"></a><span id="l4.459"> </span>
<a href="#l4.460"></a><span id="l4.460">       exitCode = exitCodeObj.value;</span>
<a href="#l4.461"></a><span id="l4.461"> </span>
<a href="#l4.462"></a><span id="l4.462">       //EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: cipherText = '&quot;+cipherText+&quot;'\n&quot;);</span>
<a href="#l4.463"></a><span id="l4.463">       if (cipherText &amp;&amp; exitCode === 0) {</span>
<a href="#l4.464"></a><span id="l4.464">         // Encryption/signing succeeded; overwrite plaintext</span>
<a href="#l4.465"></a><span id="l4.465"> </span>
<a href="#l4.466"></a><span id="l4.466" class="difflineminus">-        if (gMsgCompose.composeHTML) {</span>
<a href="#l4.467"></a><span id="l4.467" class="difflineminus">-          // workaround for Thunderbird bug (TB adds an extra space in front of the text)</span>
<a href="#l4.468"></a><span id="l4.468" class="difflineminus">-          cipherText = &quot;\n&quot; + cipherText;</span>
<a href="#l4.469"></a><span id="l4.469" class="difflineminus">-        } else {</span>
<a href="#l4.470"></a><span id="l4.470" class="difflineminus">-          cipherText = cipherText.replace(/\r\n/g, &quot;\n&quot;);</span>
<a href="#l4.471"></a><span id="l4.471" class="difflineminus">-        }</span>
<a href="#l4.472"></a><span id="l4.472" class="difflineminus">-</span>
<a href="#l4.473"></a><span id="l4.473" class="difflineminus">-        if (</span>
<a href="#l4.474"></a><span id="l4.474" class="difflineminus">-          sendInfo.sendFlags &amp; ENCRYPT &amp;&amp;</span>
<a href="#l4.475"></a><span id="l4.475" class="difflineminus">-          charset &amp;&amp;</span>
<a href="#l4.476"></a><span id="l4.476" class="difflineminus">-          charset.search(/^us-ascii$/i) !== 0</span>
<a href="#l4.477"></a><span id="l4.477" class="difflineminus">-        ) {</span>
<a href="#l4.478"></a><span id="l4.478" class="difflineminus">-          // Add Charset armor header for encrypted blocks</span>
<a href="#l4.479"></a><span id="l4.479" class="difflineminus">-          cipherText = cipherText.replace(</span>
<a href="#l4.480"></a><span id="l4.480" class="difflineminus">-            /(-----BEGIN PGP MESSAGE----- *)(\r?\n)/,</span>
<a href="#l4.481"></a><span id="l4.481" class="difflineminus">-            &quot;$1$2Charset: &quot; + charset + &quot;$2&quot;</span>
<a href="#l4.482"></a><span id="l4.482" class="difflineminus">-          );</span>
<a href="#l4.483"></a><span id="l4.483" class="difflineminus">-        }</span>
<a href="#l4.484"></a><span id="l4.484" class="difflineplus">+        cipherText = cipherText.replace(/\r\n/g, &quot;\n&quot;);</span>
<a href="#l4.485"></a><span id="l4.485"> </span>
<a href="#l4.486"></a><span id="l4.486">         // Decode ciphertext from charset to unicode and overwrite</span>
<a href="#l4.487"></a><span id="l4.487">         this.replaceEditorText(</span>
<a href="#l4.488"></a><span id="l4.488">           EnigmailData.convertToUnicode(cipherText, charset)</span>
<a href="#l4.489"></a><span id="l4.489">         );</span>
<a href="#l4.490"></a><span id="l4.490" class="difflineminus">-        //this.enableUndoEncryption(true);</span>
<a href="#l4.491"></a><span id="l4.491"> </span>
<a href="#l4.492"></a><span id="l4.492">         // Save original text (for undo)</span>
<a href="#l4.493"></a><span id="l4.493">         this.processed = {</span>
<a href="#l4.494"></a><span id="l4.494">           origText,</span>
<a href="#l4.495"></a><span id="l4.495">           charset,</span>
<a href="#l4.496"></a><span id="l4.496">         };</span>
<a href="#l4.497"></a><span id="l4.497">       } else {</span>
<a href="#l4.498"></a><span id="l4.498">         // Restore original text</span>
<a href="#l4.499"></a><span id="l4.499">         this.replaceEditorText(origText);</span>
<a href="#l4.500"></a><span id="l4.500" class="difflineminus">-        //this.enableUndoEncryption(false);</span>
<a href="#l4.501"></a><span id="l4.501" class="difflineminus">-</span>
<a href="#l4.502"></a><span id="l4.502" class="difflineminus">-        if (sendInfo.sendFlags &amp; (ENCRYPT | SIGN)) {</span>
<a href="#l4.503"></a><span id="l4.503" class="difflineplus">+</span>
<a href="#l4.504"></a><span id="l4.504" class="difflineplus">+        if (sendInfo.sendFlags &amp; SIGN) {</span>
<a href="#l4.505"></a><span id="l4.505">           // Encryption/signing failed</span>
<a href="#l4.506"></a><span id="l4.506"> </span>
<a href="#l4.507"></a><span id="l4.507">           /*if (statusFlagsObj.statusMsg) {</span>
<a href="#l4.508"></a><span id="l4.508">             // check if own key is invalid</span>
<a href="#l4.509"></a><span id="l4.509">             let s = new RegExp(&quot;^(\\[GNUPG:\\] )?INV_(RECP|SGNR) [0-9]+ \\&lt;?&quot; + sendInfo.fromAddr + &quot;\\&gt;?&quot;, &quot;m&quot;);</span>
<a href="#l4.510"></a><span id="l4.510">             if (statusFlagsObj.statusMsg.search(s) &gt;= 0) {</span>
<a href="#l4.511"></a><span id="l4.511">               errorMsgObj.value += &quot;\n\n&quot; + EnigmailLocale.getString(&quot;keyError.resolutionAction&quot;);</span>
<a href="#l4.512"></a><span id="l4.512">             }</span>
<a href="#l4.513"></a><span id="l4.513" class="difflineat">@@ -2893,87 +2803,16 @@ Enigmail.msg = {</span>
<a href="#l4.514"></a><span id="l4.514"> </span>
<a href="#l4.515"></a><span id="l4.515">   getCurrentIncomingServer() {</span>
<a href="#l4.516"></a><span id="l4.516">     let currentAccountKey = getCurrentAccountKey();</span>
<a href="#l4.517"></a><span id="l4.517">     let account = MailServices.accounts.getAccount(currentAccountKey);</span>
<a href="#l4.518"></a><span id="l4.518"> </span>
<a href="#l4.519"></a><span id="l4.519">     return account.incomingServer; /* returns nsIMsgIncomingServer */</span>
<a href="#l4.520"></a><span id="l4.520">   },</span>
<a href="#l4.521"></a><span id="l4.521"> </span>
<a href="#l4.522"></a><span id="l4.522" class="difflineminus">-  fromChangedListener(event) {</span>
<a href="#l4.523"></a><span id="l4.523" class="difflineminus">-    EnigmailLog.DEBUG(</span>
<a href="#l4.524"></a><span id="l4.524" class="difflineminus">-      &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.fromChangedListener\n&quot;</span>
<a href="#l4.525"></a><span id="l4.525" class="difflineminus">-    );</span>
<a href="#l4.526"></a><span id="l4.526" class="difflineminus">-</span>
<a href="#l4.527"></a><span id="l4.527" class="difflineminus">-    /* TODO:</span>
<a href="#l4.528"></a><span id="l4.528" class="difflineminus">-     * reset gSendSigned, gAttachMyPublicPGPKey, gSendEncrypted, gOptionalEncryption</span>
<a href="#l4.529"></a><span id="l4.529" class="difflineminus">-     * to account's default setting, but only if settings haven't been touched</span>
<a href="#l4.530"></a><span id="l4.530" class="difflineminus">-     * by the user in this composer windows, i.e. check</span>
<a href="#l4.531"></a><span id="l4.531" class="difflineminus">-     * gUserTouchedSendEncrypted, gUserTouchedSendSigned, gUserTouchedAttachMyPubKey</span>
<a href="#l4.532"></a><span id="l4.532" class="difflineminus">-     */</span>
<a href="#l4.533"></a><span id="l4.533" class="difflineminus">-</span>
<a href="#l4.534"></a><span id="l4.534" class="difflineminus">-    /*</span>
<a href="#l4.535"></a><span id="l4.535" class="difflineminus">-  if (!gSMFields) {</span>
<a href="#l4.536"></a><span id="l4.536" class="difflineminus">-    return;</span>
<a href="#l4.537"></a><span id="l4.537" class="difflineminus">-  }</span>
<a href="#l4.538"></a><span id="l4.538" class="difflineminus">-</span>
<a href="#l4.539"></a><span id="l4.539" class="difflineminus">-  var encryptionPolicy = gCurrentIdentity.getIntAttribute(&quot;encryptionpolicy&quot;);</span>
<a href="#l4.540"></a><span id="l4.540" class="difflineminus">-  var useEncryption = false;</span>
<a href="#l4.541"></a><span id="l4.541" class="difflineminus">-  if (!gEncryptOptionChanged) {</span>
<a href="#l4.542"></a><span id="l4.542" class="difflineminus">-    // Encryption wasn't manually checked.</span>
<a href="#l4.543"></a><span id="l4.543" class="difflineminus">-    // Set up the encryption policy from the setting of the new identity.</span>
<a href="#l4.544"></a><span id="l4.544" class="difflineminus">-</span>
<a href="#l4.545"></a><span id="l4.545" class="difflineminus">-    useEncryption = encryptionPolicy == kEncryptionPolicy_Always;</span>
<a href="#l4.546"></a><span id="l4.546" class="difflineminus">-  } else if (encryptionPolicy != kEncryptionPolicy_Always) {</span>
<a href="#l4.547"></a><span id="l4.547" class="difflineminus">-    // The encryption policy was manually checked. That means we can get into</span>
<a href="#l4.548"></a><span id="l4.548" class="difflineminus">-    // the situation that the new identity doesn't have a cert to encrypt with.</span>
<a href="#l4.549"></a><span id="l4.549" class="difflineminus">-    // If it doesn't, don't encrypt.</span>
<a href="#l4.550"></a><span id="l4.550" class="difflineminus">-</span>
<a href="#l4.551"></a><span id="l4.551" class="difflineminus">-    // Encrypted (policy unencrypted, manually changed).</span>
<a href="#l4.552"></a><span id="l4.552" class="difflineminus">-    // Make sure we have a cert for encryption.</span>
<a href="#l4.553"></a><span id="l4.553" class="difflineminus">-    useEncryption = !!gCurrentIdentity.getUnicharAttribute(</span>
<a href="#l4.554"></a><span id="l4.554" class="difflineminus">-      &quot;encryption_cert_name&quot;</span>
<a href="#l4.555"></a><span id="l4.555" class="difflineminus">-    );</span>
<a href="#l4.556"></a><span id="l4.556" class="difflineminus">-  }</span>
<a href="#l4.557"></a><span id="l4.557" class="difflineminus">-  gSMFields.requireEncryptMessage = useEncryption;</span>
<a href="#l4.558"></a><span id="l4.558" class="difflineminus">-  if (useEncryption) {</span>
<a href="#l4.559"></a><span id="l4.559" class="difflineminus">-    setEncryptionUI();</span>
<a href="#l4.560"></a><span id="l4.560" class="difflineminus">-  } else {</span>
<a href="#l4.561"></a><span id="l4.561" class="difflineminus">-    setNoEncryptionUI();</span>
<a href="#l4.562"></a><span id="l4.562" class="difflineminus">-  }</span>
<a href="#l4.563"></a><span id="l4.563" class="difflineminus">-</span>
<a href="#l4.564"></a><span id="l4.564" class="difflineminus">-  var signMessage = gCurrentIdentity.getBoolAttribute(&quot;sign_mail&quot;);</span>
<a href="#l4.565"></a><span id="l4.565" class="difflineminus">-  var useSigning = false;</span>
<a href="#l4.566"></a><span id="l4.566" class="difflineminus">-  if (!gSignOptionChanged) {</span>
<a href="#l4.567"></a><span id="l4.567" class="difflineminus">-    // Signing wasn't manually checked.</span>
<a href="#l4.568"></a><span id="l4.568" class="difflineminus">-    // Set up the signing policy from the setting of the new identity.</span>
<a href="#l4.569"></a><span id="l4.569" class="difflineminus">-</span>
<a href="#l4.570"></a><span id="l4.570" class="difflineminus">-    useSigning = signMessage;</span>
<a href="#l4.571"></a><span id="l4.571" class="difflineminus">-  } else if (!signMessage) {</span>
<a href="#l4.572"></a><span id="l4.572" class="difflineminus">-    // The signing policy was manually checked. That means we can get into</span>
<a href="#l4.573"></a><span id="l4.573" class="difflineminus">-    // the situation that the new identity doesn't have a cert to sign with.</span>
<a href="#l4.574"></a><span id="l4.574" class="difflineminus">-    // If it doesn't, don't sign.</span>
<a href="#l4.575"></a><span id="l4.575" class="difflineminus">-</span>
<a href="#l4.576"></a><span id="l4.576" class="difflineminus">-    // Signed (policy unsigned, manually changed).</span>
<a href="#l4.577"></a><span id="l4.577" class="difflineminus">-    // Make sure we have a cert for signing.</span>
<a href="#l4.578"></a><span id="l4.578" class="difflineminus">-    useSigning = !!gCurrentIdentity.getUnicharAttribute(&quot;signing_cert_name&quot;);</span>
<a href="#l4.579"></a><span id="l4.579" class="difflineminus">-  }</span>
<a href="#l4.580"></a><span id="l4.580" class="difflineminus">-  gSMFields.signMessage = useSigning;</span>
<a href="#l4.581"></a><span id="l4.581" class="difflineminus">-  if (useSigning) {</span>
<a href="#l4.582"></a><span id="l4.582" class="difflineminus">-    setSignatureUI();</span>
<a href="#l4.583"></a><span id="l4.583" class="difflineminus">-  } else {</span>
<a href="#l4.584"></a><span id="l4.584" class="difflineminus">-    setNoSignatureUI();</span>
<a href="#l4.585"></a><span id="l4.585" class="difflineminus">-  }</span>
<a href="#l4.586"></a><span id="l4.586" class="difflineminus">-    */</span>
<a href="#l4.587"></a><span id="l4.587" class="difflineminus">-  },</span>
<a href="#l4.588"></a><span id="l4.588" class="difflineminus">-</span>
<a href="#l4.589"></a><span id="l4.589" class="difflineminus">-  /**</span>
<a href="#l4.590"></a><span id="l4.590" class="difflineminus">-   * Perform handling of the compose-send-message' event from TB (or SendLater)</span>
<a href="#l4.591"></a><span id="l4.591" class="difflineminus">-   */</span>
<a href="#l4.592"></a><span id="l4.592" class="difflineminus">-</span>
<a href="#l4.593"></a><span id="l4.593">   /**</span>
<a href="#l4.594"></a><span id="l4.594">    * Handle the 'compose-send-message' event from TB</span>
<a href="#l4.595"></a><span id="l4.595">    */</span>
<a href="#l4.596"></a><span id="l4.596">   sendMessageListener(event) {</span>
<a href="#l4.597"></a><span id="l4.597">     console.debug(&quot;in Enigmail.msg.sendMessageListener&quot;);</span>
<a href="#l4.598"></a><span id="l4.598">     EnigmailLog.DEBUG(</span>
<a href="#l4.599"></a><span id="l4.599">       &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.sendMessageListener\n&quot;</span>
<a href="#l4.600"></a><span id="l4.600">     );</span>
<a href="#l4.601"></a><span id="l4.601" class="difflineat">@@ -2992,17 +2831,17 @@ Enigmail.msg = {</span>
<a href="#l4.602"></a><span id="l4.602">       this.sendProcess = true;</span>
<a href="#l4.603"></a><span id="l4.603">       //let bc = document.getElementById(&quot;enigmail-bc-sendprocess&quot;);</span>
<a href="#l4.604"></a><span id="l4.604"> </span>
<a href="#l4.605"></a><span id="l4.605">       try {</span>
<a href="#l4.606"></a><span id="l4.606">         this.modifyCompFields();</span>
<a href="#l4.607"></a><span id="l4.607">         //bc.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l4.608"></a><span id="l4.608"> </span>
<a href="#l4.609"></a><span id="l4.609">         const cApi = EnigmailCryptoAPI();</span>
<a href="#l4.610"></a><span id="l4.610" class="difflineminus">-        let encryptResult = cApi.sync(this.encryptMsg(sendMsgType));</span>
<a href="#l4.611"></a><span id="l4.611" class="difflineplus">+        let encryptResult = cApi.sync(this.prepareSendMsg(sendMsgType));</span>
<a href="#l4.612"></a><span id="l4.612">         if (!encryptResult) {</span>
<a href="#l4.613"></a><span id="l4.613">           this.resetUpdatedFields();</span>
<a href="#l4.614"></a><span id="l4.614">           event.preventDefault();</span>
<a href="#l4.615"></a><span id="l4.615">           event.stopPropagation();</span>
<a href="#l4.616"></a><span id="l4.616">         }</span>
<a href="#l4.617"></a><span id="l4.617">       } catch (ex) {</span>
<a href="#l4.618"></a><span id="l4.618">         console.debug(ex);</span>
<a href="#l4.619"></a><span id="l4.619">       }</span>
<a href="#l4.620"></a><span id="l4.620" class="difflineat">@@ -3583,17 +3422,16 @@ Enigmail.msg = {</span>
<a href="#l4.621"></a><span id="l4.621">     try {</span>
<a href="#l4.622"></a><span id="l4.622">       EnigmailLog.DEBUG(</span>
<a href="#l4.623"></a><span id="l4.623">         &quot;enigmailMsgComposeOverlay.js: Enigmail.msg.fireSendFlags\n&quot;</span>
<a href="#l4.624"></a><span id="l4.624">       );</span>
<a href="#l4.625"></a><span id="l4.625">       if (!this.determineSendFlagId) {</span>
<a href="#l4.626"></a><span id="l4.626">         this.determineSendFlagId = EnigmailTimer.setTimeout(async () =&gt; {</span>
<a href="#l4.627"></a><span id="l4.627">           try {</span>
<a href="#l4.628"></a><span id="l4.628">             await this.determineSendFlags();</span>
<a href="#l4.629"></a><span id="l4.629" class="difflineminus">-            this.fireSearchKeys();</span>
<a href="#l4.630"></a><span id="l4.630">           } catch (x) {}</span>
<a href="#l4.631"></a><span id="l4.631">           this.determineSendFlagId = null;</span>
<a href="#l4.632"></a><span id="l4.632">         }, 0);</span>
<a href="#l4.633"></a><span id="l4.633">       }</span>
<a href="#l4.634"></a><span id="l4.634">     } catch (ex) {}</span>
<a href="#l4.635"></a><span id="l4.635">   },</span>
<a href="#l4.636"></a><span id="l4.636"> </span>
<a href="#l4.637"></a><span id="l4.637">   /**</span>
<a href="#l4.638"></a><span id="l4.638" class="difflineat">@@ -3606,98 +3444,16 @@ Enigmail.msg = {</span>
<a href="#l4.639"></a><span id="l4.639">       if (r !== subjElem.value) {</span>
<a href="#l4.640"></a><span id="l4.640">         subjElem.value = r;</span>
<a href="#l4.641"></a><span id="l4.641">         if (typeof subjElem.oninput === &quot;function&quot;) {</span>
<a href="#l4.642"></a><span id="l4.642">           subjElem.oninput();</span>
<a href="#l4.643"></a><span id="l4.643">         }</span>
<a href="#l4.644"></a><span id="l4.644">       }</span>
<a href="#l4.645"></a><span id="l4.645">     }</span>
<a href="#l4.646"></a><span id="l4.646">   },</span>
<a href="#l4.647"></a><span id="l4.647" class="difflineminus">-</span>
<a href="#l4.648"></a><span id="l4.648" class="difflineminus">-  fireSearchKeys() {</span>
<a href="#l4.649"></a><span id="l4.649" class="difflineminus">-    if (Enigmail.msg.isEnigmailEnabledForIdentity()) {</span>
<a href="#l4.650"></a><span id="l4.650" class="difflineminus">-      if (this.searchKeysTimeout) {</span>
<a href="#l4.651"></a><span id="l4.651" class="difflineminus">-        return;</span>
<a href="#l4.652"></a><span id="l4.652" class="difflineminus">-      }</span>
<a href="#l4.653"></a><span id="l4.653" class="difflineminus">-</span>
<a href="#l4.654"></a><span id="l4.654" class="difflineminus">-      let self = this;</span>
<a href="#l4.655"></a><span id="l4.655" class="difflineminus">-</span>
<a href="#l4.656"></a><span id="l4.656" class="difflineminus">-      this.searchKeysTimeout = EnigmailTimer.setTimeout(function() {</span>
<a href="#l4.657"></a><span id="l4.657" class="difflineminus">-        self.searchKeysTimeout = null;</span>
<a href="#l4.658"></a><span id="l4.658" class="difflineminus">-        Enigmail.msg.findMissingKeys();</span>
<a href="#l4.659"></a><span id="l4.659" class="difflineminus">-      }, 5000); // 5 Seconds</span>
<a href="#l4.660"></a><span id="l4.660" class="difflineminus">-    }</span>
<a href="#l4.661"></a><span id="l4.661" class="difflineminus">-  },</span>
<a href="#l4.662"></a><span id="l4.662" class="difflineminus">-</span>
<a href="#l4.663"></a><span id="l4.663" class="difflineminus">-  /**</span>
<a href="#l4.664"></a><span id="l4.664" class="difflineminus">-   * Determine if all addressees have a valid key ID; if not, attempt to</span>
<a href="#l4.665"></a><span id="l4.665" class="difflineminus">-   * import them via WKD or Autocrypt.</span>
<a href="#l4.666"></a><span id="l4.666" class="difflineminus">-   */</span>
<a href="#l4.667"></a><span id="l4.667" class="difflineminus">-  async findMissingKeys() {</span>
<a href="#l4.668"></a><span id="l4.668" class="difflineminus">-    /*</span>
<a href="#l4.669"></a><span id="l4.669" class="difflineminus">-    try {</span>
<a href="#l4.670"></a><span id="l4.670" class="difflineminus">-      EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: findMissingKeys()\n&quot;);</span>
<a href="#l4.671"></a><span id="l4.671" class="difflineminus">-</span>
<a href="#l4.672"></a><span id="l4.672" class="difflineminus">-      let missingKeys = this.determineSendFlags();</span>
<a href="#l4.673"></a><span id="l4.673" class="difflineminus">-</span>
<a href="#l4.674"></a><span id="l4.674" class="difflineminus">-      if (&quot;errArray&quot; in missingKeys &amp;&amp; missingKeys.errArray.length &gt; 0) {</span>
<a href="#l4.675"></a><span id="l4.675" class="difflineminus">-        let missingEmails = missingKeys.errArray.map(function(i) {</span>
<a href="#l4.676"></a><span id="l4.676" class="difflineminus">-          return i.addr.toLowerCase().trim();</span>
<a href="#l4.677"></a><span id="l4.677" class="difflineminus">-        });</span>
<a href="#l4.678"></a><span id="l4.678" class="difflineminus">-</span>
<a href="#l4.679"></a><span id="l4.679" class="difflineminus">-        let lookupList = [];</span>
<a href="#l4.680"></a><span id="l4.680" class="difflineminus">-</span>
<a href="#l4.681"></a><span id="l4.681" class="difflineminus">-        // only search for keys not checked before</span>
<a href="#l4.682"></a><span id="l4.682" class="difflineminus">-        for (let k of missingEmails) {</span>
<a href="#l4.683"></a><span id="l4.683" class="difflineminus">-          if (!this.keyLookupDone.includes(k)) {</span>
<a href="#l4.684"></a><span id="l4.684" class="difflineminus">-            lookupList.push(k);</span>
<a href="#l4.685"></a><span id="l4.685" class="difflineminus">-            this.keyLookupDone.push(k);</span>
<a href="#l4.686"></a><span id="l4.686" class="difflineminus">-          }</span>
<a href="#l4.687"></a><span id="l4.687" class="difflineminus">-        }</span>
<a href="#l4.688"></a><span id="l4.688" class="difflineminus">-</span>
<a href="#l4.689"></a><span id="l4.689" class="difflineminus">-        if (lookupList.length &gt; 0) {</span>
<a href="#l4.690"></a><span id="l4.690" class="difflineminus">-          try {</span>
<a href="#l4.691"></a><span id="l4.691" class="difflineminus">-            let foundKeys;</span>
<a href="#l4.692"></a><span id="l4.692" class="difflineminus">-</span>
<a href="#l4.693"></a><span id="l4.693" class="difflineminus">-            if (this.isAutocryptEnabled()) {</span>
<a href="#l4.694"></a><span id="l4.694" class="difflineminus">-              foundKeys = await EnigmailAutocrypt.importAutocryptKeys(lookupList, this.encryptForced === EnigmailConstants.ENIG_ALWAYS);</span>
<a href="#l4.695"></a><span id="l4.695" class="difflineminus">-              EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: findMissingKeys: got &quot; + foundKeys.length + &quot; autocrypt keys\n&quot;);</span>
<a href="#l4.696"></a><span id="l4.696" class="difflineminus">-              if (foundKeys.length &gt; 0) {</span>
<a href="#l4.697"></a><span id="l4.697" class="difflineminus">-                this.determineSendFlags();</span>
<a href="#l4.698"></a><span id="l4.698" class="difflineminus">-              }</span>
<a href="#l4.699"></a><span id="l4.699" class="difflineminus">-            }</span>
<a href="#l4.700"></a><span id="l4.700" class="difflineminus">-</span>
<a href="#l4.701"></a><span id="l4.701" class="difflineminus">-            if (EnigmailPrefs.getPref(&quot;autoWkdLookup&quot;) === 0) {</span>
<a href="#l4.702"></a><span id="l4.702" class="difflineminus">-              return;</span>
<a href="#l4.703"></a><span id="l4.703" class="difflineminus">-            }</span>
<a href="#l4.704"></a><span id="l4.704" class="difflineminus">-</span>
<a href="#l4.705"></a><span id="l4.705" class="difflineminus">-            // old buggy: if autocrypt is disabled, foundKeys is still undefined</span>
<a href="#l4.706"></a><span id="l4.706" class="difflineminus">-            // if (foundKeys.length &gt;= lookupList.length) return;</span>
<a href="#l4.707"></a><span id="l4.707" class="difflineminus">-</span>
<a href="#l4.708"></a><span id="l4.708" class="difflineminus">-            foundKeys = await EnigmailWkdLookup.findKeys(lookupList);</span>
<a href="#l4.709"></a><span id="l4.709" class="difflineminus">-            EnigmailLog.DEBUG(</span>
<a href="#l4.710"></a><span id="l4.710" class="difflineminus">-              &quot;enigmailMsgComposeOverlay.js: findMissingKeys: wkd got &quot; +</span>
<a href="#l4.711"></a><span id="l4.711" class="difflineminus">-                foundKeys +</span>
<a href="#l4.712"></a><span id="l4.712" class="difflineminus">-                &quot;\n&quot;</span>
<a href="#l4.713"></a><span id="l4.713" class="difflineminus">-            );</span>
<a href="#l4.714"></a><span id="l4.714" class="difflineminus">-            if (foundKeys) {</span>
<a href="#l4.715"></a><span id="l4.715" class="difflineminus">-              this.determineSendFlags();</span>
<a href="#l4.716"></a><span id="l4.716" class="difflineminus">-            }</span>
<a href="#l4.717"></a><span id="l4.717" class="difflineminus">-          } catch (err) {</span>
<a href="#l4.718"></a><span id="l4.718" class="difflineminus">-            EnigmailLog.DEBUG(</span>
<a href="#l4.719"></a><span id="l4.719" class="difflineminus">-              &quot;enigmailMsgComposeOverlay.js: findMissingKeys: error &quot; +</span>
<a href="#l4.720"></a><span id="l4.720" class="difflineminus">-                err +</span>
<a href="#l4.721"></a><span id="l4.721" class="difflineminus">-                &quot;\n&quot;</span>
<a href="#l4.722"></a><span id="l4.722" class="difflineminus">-            );</span>
<a href="#l4.723"></a><span id="l4.723" class="difflineminus">-          }</span>
<a href="#l4.724"></a><span id="l4.724" class="difflineminus">-        }</span>
<a href="#l4.725"></a><span id="l4.725" class="difflineminus">-      }</span>
<a href="#l4.726"></a><span id="l4.726" class="difflineminus">-    } catch (ex) {}</span>
<a href="#l4.727"></a><span id="l4.727" class="difflineminus">-    */</span>
<a href="#l4.728"></a><span id="l4.728" class="difflineminus">-  },</span>
<a href="#l4.729"></a><span id="l4.729"> };</span>
<a href="#l4.730"></a><span id="l4.730"> </span>
<a href="#l4.731"></a><span id="l4.731"> Enigmail.composeStateListener = {</span>
<a href="#l4.732"></a><span id="l4.732">   NotifyComposeFieldsReady() {</span>
<a href="#l4.733"></a><span id="l4.733">     // Note: NotifyComposeFieldsReady is only called when a new window is created (i.e. not in case a window object is reused).</span>
<a href="#l4.734"></a><span id="l4.734">     EnigmailLog.DEBUG(</span>
<a href="#l4.735"></a><span id="l4.735">       &quot;enigmailMsgComposeOverlay.js: ECSL.NotifyComposeFieldsReady\n&quot;</span>
<a href="#l4.736"></a><span id="l4.736">     );</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

